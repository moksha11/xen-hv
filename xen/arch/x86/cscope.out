cscope 15 $HOME/xen-hv/xen/arch/x86               0002856327
	@acpi/boot.c

26 
	~<x’/cÚfig.h
>

27 
	~<x’/”ºo.h
>

28 
	~<x’/š™.h
>

29 
	~<x’/aıi.h
>

30 
	~<x’/œq.h
>

31 
	~<x’/dmi.h
>

32 
	~<asm/fixm­.h
>

33 
	~<asm/·ge.h
>

34 
	~<asm/­ic.h
>

35 
	~<asm/io_­ic.h
>

36 
	~<asm/­ic.h
>

37 
	~<asm/io.h
>

38 
	~<asm/mp¥ec.h
>

39 
	~<asm/´oûssÜ.h
>

40 #ifdeà
CONFIG_HPET_TIMER


41 
	~<asm/h³t.h
>

43 
	~<mach_­ic.h
>

44 
	~<mach_mµ¬£.h
>

46 
	gsbf_pÜt
;

47 
	#CONFIG_ACPI_PCI


	)

49 
	#BAD_MADT_ENTRY
(
’Œy
, 
’d
) ( \

50 (!
’Œy
è|| (ëÁry + (*’Œyè> 
’d
 || \

51 ((
aıi_subbË_h—d”
 *)
’Œy
)->
Ëngth
 !ğ(*’Œy))

	)

53 
	#PREFIX
 "ACPI: "

	)

55 #ifdeà
CONFIG_ACPI_PCI


56 
boŞ_t
 
__š™d©a
 
	gaıi_noœq
;

57 
boŞ_t
 
__š™d©a
 
	gaıi_pci_di§bËd
;

59 
boŞ_t
 
__š™d©a
 
	gaıi_noœq
 = 1;

60 
boŞ_t
 
__š™d©a
 
	gaıi_pci_di§bËd
 = 1;

62 
boŞ_t
 
__š™d©a
 
	gaıi_ht
 = 1;

64 
boŞ_t
 
__š™d©a
 
	gaıi_Ïpic
;

65 
boŞ_t
 
__š™d©a
 
	gaıi_ißpic
;

67 
u8
 
aıi_sci_æags
 
	g__š™d©a
;

68 
aıi_sci_ov”ride_gsi
 
	g__š™d©a
;

69 
boŞ_t
 
aıi_sk_tim”_ov”ride
 
	g__š™d©a
;

71 #ifdeà
CONFIG_X86_LOCAL_APIC


72 
u64
 
aıi_Ïpic_addr
 
	g__š™d©a
 = 
APIC_DEFAULT_PHYS_BASE
;

75 
u32
 
	gaıi_smi_cmd
;

76 
u8
 
	gaıi_’abË_v®ue
, 
	gaıi_di§bË_v®ue
;

78 #iâdeà
__HAVE_ARCH_CMPXCHG


79 #w¬nšg 
ACPI
 
u£s
 
CMPXCHG
, 
i486
 
ªd
 
Ï‹r
 
h¬dw¬e


82 
u32
 
	gx86_aıiid_to_­icid
[
MAX_MADT_ENTRIES
] =

83 {[0 ... 
MAX_MADT_ENTRIES
 - 1] = 
BAD_APICID
 };

84 
EXPORT_SYMBOL
(
x86_aıiid_to_­icid
);

94 
aıi_œq_mod–_id
 
	gaıi_œq_mod–
 = 
ACPI_IRQ_MODEL_PIC
;

108 *
	$__aıi_m­_bË
(
phys
, 
size
)

110 
ba£
, 
off£t
, 
m­³d_size
;

111 
idx
;

114 ià((
phys
 + 
size
) <= (1 * 1024 * 1024))

115  
	`__va
(
phys
);

117 
off£t
 = 
phys
 & (
PAGE_SIZE
 - 1);

118 
m­³d_size
 = 
PAGE_SIZE
 - 
off£t
;

119 
	`£t_fixm­
(
FIX_ACPI_END
, 
phys
);

120 
ba£
 = 
	`fix_to_vœt
(
FIX_ACPI_END
);

125 
idx
 = 
FIX_ACPI_END
;

126 
m­³d_size
 < 
size
) {

127 ià(--
idx
 < 
FIX_ACPI_BEGIN
)

128  
NULL
;

129 
phys
 +ğ
PAGE_SIZE
;

130 
	`£t_fixm­
(
idx
, 
phys
);

131 
m­³d_size
 +ğ
PAGE_SIZE
;

134  ((*è
ba£
 + 
off£t
);

135 
	}
}

137 #ifdeà
CONFIG_X86_LOCAL_APIC


138 
__š™
 
	$aıi_·r£_madt
(
aıi_bË_h—d”
 *
bË
)

140 
aıi_bË_madt
 *
madt
;

142 
madt
 = (
aıi_bË_madt
 *)
bË
;

144 ià(
madt
->
add»ss
) {

145 
aıi_Ïpic_addr
 = (
u64
è
madt
->
add»ss
;

147 
	`´štk
(
KERN_DEBUG
 
PREFIX
 "Local APIC‡ddress 0x%08x\n",

148 
madt
->
add»ss
);

151 
	`aıi_madt_Ûm_check
(
madt
->
h—d”
.
Ûm_id
, madt->h—d”.
Ûm_bË_id
);

154 
	}
}

156 
__š™


157 
	$aıi_·r£_x2­ic
(
aıi_subbË_h—d”
 *
h—d”
, cÚ¡ 
’d
)

159 
aıi_bË_x2­ic
 *
´oûssÜ
 = 
NULL
;

161 
´oûssÜ
 = (
aıi_bË_x2­ic
 *)
h—d”
;

163 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

164  -
EINVAL
;

166 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

169 ià(
´oûssÜ
->
æags
.
’abËd
)

170 
x86_aıiid_to_­icid
[
´oûssÜ
->
aıi_uid
] =…roûssÜ->
id
;

179 
	`mp_»gi¡”_Ïpic
(
´oûssÜ
->
id
,

180 
´oûssÜ
->
æags
.
’abËd
);

183 
	}
}

185 
__š™


186 
	$aıi_·r£_Ïpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

188 
aıi_bË_Ïpic
 *
´oûssÜ
 = 
NULL
;

190 
´oûssÜ
 = (
aıi_bË_Ïpic
 *)
h—d”
;

192 ià(
	`BAD_MADT_ENTRY
(
´oûssÜ
, 
’d
))

193  -
EINVAL
;

195 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

198 ià(
´oûssÜ
->
æags
.
’abËd
)

199 
x86_aıiid_to_­icid
[
´oûssÜ
->
aıi_id
] =…roûssÜ->
id
;

208 
	`mp_»gi¡”_Ïpic
(
´oûssÜ
->
id
,

209 
´oûssÜ
->
æags
.
’abËd
);

212 
	}
}

214 
__š™


215 
	$aıi_·r£_Ïpic_addr_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

216 cÚ¡ 
’d
)

218 
aıi_bË_Ïpic_addr_ovr
 *
Ïpic_addr_ovr
 = 
NULL
;

220 
Ïpic_addr_ovr
 = (
aıi_bË_Ïpic_addr_ovr
 *)
h—d”
;

222 ià(
	`BAD_MADT_ENTRY
(
Ïpic_addr_ovr
, 
’d
))

223  -
EINVAL
;

225 
aıi_Ïpic_addr
 = 
Ïpic_addr_ovr
->
add»ss
;

228 
	}
}

230 
__š™


231 
	$aıi_·r£_x2­ic_nmi
(
aıi_subbË_h—d”
 *
h—d”
,

232 cÚ¡ 
’d
)

234 
aıi_bË_x2­ic_nmi
 *
x2­ic_nmi
 = 
NULL
;

236 
x2­ic_nmi
 = (
aıi_bË_x2­ic_nmi
 *)
h—d”
;

238 ià(
	`BAD_MADT_ENTRY
(
x2­ic_nmi
, 
’d
))

239  -
EINVAL
;

241 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

243 ià(
x2­ic_nmi
->
lšt
 != 1)

244 
	`´štk
(
KERN_WARNING
 
PREFIX
 "NMI‚ot connectedo LINT 1!\n");

247 
	}
}

249 
__š™


250 
	$aıi_·r£_Ïpic_nmi
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

252 
aıi_bË_Ïpic_nmi
 *
Ïpic_nmi
 = 
NULL
;

254 
Ïpic_nmi
 = (
aıi_bË_Ïpic_nmi
 *)
h—d”
;

256 ià(
	`BAD_MADT_ENTRY
(
Ïpic_nmi
, 
’d
))

257  -
EINVAL
;

259 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

261 ià(
Ïpic_nmi
->
lšt
 != 1)

262 
	`´štk
(
KERN_WARNING
 
PREFIX
 "NMI‚ot connectedo LINT 1!\n");

265 
	}
}

269 #ià
defšed
(
CONFIG_X86_IO_APIC
)

271 
__š™


272 
	$aıi_·r£_ißpic
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

274 
aıi_bË_ißpic
 *
ißpic
 = 
NULL
;

276 
ißpic
 = (
aıi_bË_ißpic
 *)
h—d”
;

278 ià(
	`BAD_MADT_ENTRY
(
ißpic
, 
’d
))

279  -
EINVAL
;

281 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

283 
	`mp_»gi¡”_ißpic
(
ißpic
->
id
,

284 
ißpic
->
add»ss
, ißpic->
glob®_œq_ba£
);

287 
	}
}

289 
__š™


290 
	$aıi_·r£_št_¤c_ovr
(
aıi_subbË_h—d”
 * 
h—d”
,

291 cÚ¡ 
’d
)

293 
aıi_bË_št_¤c_ovr
 *
št¤c
 = 
NULL
;

295 
št¤c
 = (
aıi_bË_št_¤c_ovr
 *)
h—d”
;

297 ià(
	`BAD_MADT_ENTRY
(
št¤c
, 
’d
))

298  -
EINVAL
;

300 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

302 ià(
aıi_sk_tim”_ov”ride
 &&

303 
št¤c
->
bus_œq
 =ğ0 && iÁ¤c->
glob®_œq
 == 2) {

304 
	`´štk
(
PREFIX
 "BIOS IRQ0…in2 override ignored.\n");

308 
	`mp_ov”ride_Ëgacy_œq
(
št¤c
->
bus_œq
,

309 
št¤c
->
æags
.
pŞ¬™y
,

310 
št¤c
->
æags
.
Œigg”
, iÁ¤c->
glob®_œq
);

313 
	}
}

315 
__š™


316 
	$aıi_·r£_nmi_¤c
(
aıi_subbË_h—d”
 * 
h—d”
, cÚ¡ 
’d
)

318 
aıi_bË_nmi_¤c
 *
nmi_¤c
 = 
NULL
;

320 
nmi_¤c
 = (
aıi_bË_nmi_¤c
 *)
h—d”
;

322 ià(
	`BAD_MADT_ENTRY
(
nmi_¤c
, 
’d
))

323  -
EINVAL
;

325 
	`aıi_bË_´št_madt_’Œy
(
h—d”
);

330 
	}
}

334 
__š™
 
	$aıi_·r£_sbf
(
aıi_bË_h—d”
 *
bË
)

336 
aıi_bË_boÙ
 *
sb
;

338 
sb
 = (
aıi_bË_boÙ
 *)
bË
;

339 ià(!
sb
) {

340 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Unableo map SBF\n");

341  -
ENODEV
;

344 
sbf_pÜt
 = 
sb
->
cmos_šdex
;

347 
	}
}

349 #ifdeà
CONFIG_HPET_TIMER


351 
__š™
 
	$aıi_·r£_h³t
(
aıi_bË_h—d”
 *
bË
)

353 
aıi_bË_h³t
 *
h³t_tbl
 = (aıi_bË_h³ˆ*)
bË
;

355 ià(
h³t_tbl
->
add»ss
.
¥aû_id
 !ğ
ACPI_SPACE_MEM
) {

356 
	`´štk
(
KERN_WARNING
 
PREFIX
 "HPETimers must be†ocated in "

362 
vxtime
.
h³t_add»ss
 = 
h³t_tbl
->
add»ss
.address;

364 
	`´štk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

365 
h³t_tbl
->
id
, 
vxtime
.
h³t_add»ss
);

368 
h³t_add»ss
 = 
h³t_tbl
->
add»ss
.address;

369 
	`´štk
(
KERN_INFO
 
PREFIX
 "HPET id: %#x base: %#lx\n",

370 
h³t_tbl
->
id
, 
h³t_add»ss
);

375 
	}
}

377 
	#aıi_·r£_h³t
 
NULL


	)

380 #ifdeà
CONFIG_ACPI_SLEEP


381 
	#aıi_çdt_cİy_add»ss
(
d¡
, 
¤c
, 
Ën
) do { \

382 ià(
çdt
->
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
) \

383 
aıi_sšfo
.
d¡
##
_blk
 = 
çdt
->
x
##
¤c
##
_block
; \

384 ià(!
aıi_sšfo
.
d¡
##
_blk
.
add»ss
) { \

385 
aıi_sšfo
.
d¡
##
_blk
.
add»ss
 = 
çdt
->
¤c
##
_block
; \

386 
aıi_sšfo
.
d¡
##
_blk
.
¥aû_id
 = 
ACPI_ADR_SPACE_SYSTEM_IO
; \

387 
aıi_sšfo
.
d¡
##
_blk
.
b™_width
 = 
çdt
->
Ën
##
_Ëngth
 << 3; \

388 
aıi_sšfo
.
d¡
##
_blk
.
b™_off£t
 = 0; \

389 
aıi_sšfo
.
d¡
##
_blk
.
acûss_width
 = 0; \

391 } 0)

	)

394 
__š™


395 
	$aıi_çdt_·r£_¦“p_šfo
(
aıi_bË_çdt
 *
çdt
)

397 
aıi_bË_çcs
 *
çcs
 = 
NULL
;

398 
ušt64_t
 
çcs_·
;

400 
	`aıi_çdt_cİy_add»ss
(
pm1a_út
, 
pm1a_cÚŒŞ
, 
pm1_cÚŒŞ
);

401 
	`aıi_çdt_cİy_add»ss
(
pm1b_út
, 
pm1b_cÚŒŞ
, 
pm1_cÚŒŞ
);

402 
	`aıi_çdt_cİy_add»ss
(
pm1a_evt
, 
pm1a_ev’t
, 
pm1_ev’t
);

403 
	`aıi_çdt_cİy_add»ss
(
pm1b_evt
, 
pm1b_ev’t
, 
pm1_ev’t
);

405 
	`´štk
(
KERN_INFO
 
PREFIX


406 "ACPI SLEEP INFO:…m1x_út[%"
PRIx64
",%"PRIx64"], "

407 "pm1x_evt[%"
PRIx64
",%"PRIx64"]\n",

408 
aıi_sšfo
.
pm1a_út_blk
.
add»ss
,

409 
aıi_sšfo
.
pm1b_út_blk
.
add»ss
,

410 
aıi_sšfo
.
pm1a_evt_blk
.
add»ss
,

411 
aıi_sšfo
.
pm1b_evt_blk
.
add»ss
);

414 
çcs_·
 = ((
çdt
->
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
)

415 ? 
çdt
->
Xçcs
 : (
ušt64_t
)çdt->
çcs
);

416 ià(
çdt
->
çcs
 && ((
ušt64_t
)çdt->çc !ğ
çcs_·
)) {

417 
	`´štk
(
KERN_WARNING
 
PREFIX


419 "%08x/%016"
PRIx64
", using 32\n",

420 
çdt
->
çcs
, 
çcs_·
);

421 
çcs_·
 = (
ušt64_t
)
çdt
->
çcs
;

424 
çcs
 = (
aıi_bË_çcs
 *)

425 
	`__aıi_m­_bË
(
çcs_·
, (
aıi_bË_çcs
));

426 ià(!
çcs
)

427 
bad
;

429 ià(
	`¡ºcmp
(
çcs
->
sigÇtu»
, "FACS", 4)) {

430 
	`´štk
(
KERN_ERR
 
PREFIX
 "Invalid FACS signature %.4s\n",

431 
çcs
->
sigÇtu»
);

432 
bad
;

435 ià(
çcs
->
Ëngth
 < 24) {

436 
	`´štk
(
KERN_ERR
 
PREFIX
 "Invalid FACSable†ength: 0x%x",

437 
çcs
->
Ëngth
);

438 
bad
;

441 ià(
çcs
->
Ëngth
 < 64)

442 
	`´štk
(
KERN_WARNING
 
PREFIX


444 
çcs
->
Ëngth
);

446 
aıi_sšfo
.
wakeup_veùÜ
 = 
çcs_·
 +

447 
	`off£tof
(
aıi_bË_çcs
, 
fœmw¬e_wakšg_veùÜ
);

448 
aıi_sšfo
.
veùÜ_width
 = 32;

450 
	`´štk
(
KERN_INFO
 
PREFIX


451 " wakeup_vec[%"
PRIx64
"], vec_size[%x]\n",

452 
aıi_sšfo
.
wakeup_veùÜ
,‡ıi_sšfo.
veùÜ_width
);

454 
bad
:

455 
	`mem£t
(&
aıi_sšfo
, 0, (acpi_sinfo));

456 
	}
}

459 
__š™
 
	$aıi_·r£_çdt
(
aıi_bË_h—d”
 *
bË
)

461 
aıi_bË_çdt
 *
çdt
 = (aıi_bË_çdˆ*)
bË
;

463 #ifdef 
CONFIG_ACPI_INTERPRETER


465 
aıi_çdt
.
sci_št
 = 
çdt
->sci_int;

468 
aıi_çdt
.
»visiÚ
 = 
çdt
->revision;

469 
aıi_çdt
.
fÜû_­ic_physiÿl_de¡š©iÚ_mode
 =

470 
çdt
->
fÜû_­ic_physiÿl_de¡š©iÚ_mode
;

473 #ifdeà
CONFIG_X86_PM_TIMER


475 ià(
çdt
->
h—d”
.
»visiÚ
 >ğ
FADT2_REVISION_ID
) {

477 ià(
çdt
->
xpm_tim”_block
.
¥aû_id
 ==

478 
ACPI_ADR_SPACE_SYSTEM_IO
)

479 
pmtmr_iİÜt
 = 
çdt
->
xpm_tim”_block
.
add»ss
;

485 ià(!
pmtmr_iİÜt
)

486 
pmtmr_iİÜt
 = 
çdt
->
pm_tim”_block
;

489 
pmtmr_iİÜt
 = 
çdt
->
pm_tim”_block
;

491 ià(
pmtmr_iİÜt
)

492 
	`´štk
(
KERN_INFO
 
PREFIX
 "PM-Timer IO Port: %#x\n",

493 
pmtmr_iİÜt
);

496 
aıi_smi_cmd
 = 
çdt
->
smi_commªd
;

497 
aıi_’abË_v®ue
 = 
çdt
->
aıi_’abË
;

498 
aıi_di§bË_v®ue
 = 
çdt
->
aıi_di§bË
;

500 #ifdeà
CONFIG_ACPI_SLEEP


501 
	`aıi_çdt_·r£_¦“p_šfo
(
çdt
);

505 
	}
}

507 #ifdef 
CONFIG_X86_LOCAL_APIC


512 
__š™
 
	$aıi_·r£_madt_Ïpic_’Œ›s
()

514 
couÁ
, 
x2couÁ
;

516 ià(!
ıu_has_­ic
)

517  -
ENODEV
;

524 
couÁ
 =

525 
	`aıi_bË_·r£_madt
(
ACPI_MADT_LAPIC_ADDR_OVR
,

526 
aıi_·r£_Ïpic_addr_ovr
, 0);

527 ià(
couÁ
 < 0) {

528 
	`´štk
(
KERN_ERR
 
PREFIX


530  
couÁ
;

533 
	`mp_»gi¡”_Ïpic_add»ss
(
aıi_Ïpic_addr
);

535 
	`BUILD_BUG_ON
(
MAX_APICS
 !ğ
MAX_LOCAL_APIC
);

536 
couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_LAPIC
, 
aıi_·r£_Ïpic
,

537 
MAX_APICS
);

538 
x2couÁ
 = 
	`aıi_bË_·r£_madt
(
ACPI_MADT_X2APIC
, 
aıi_·r£_x2­ic
,

539 
MAX_APICS
);

540 ià(!
couÁ
 && !
x2couÁ
) {

541 
	`´štk
(
KERN_ERR
 
PREFIX
 "No LAPICƒntries…resent\n");

543  -
ENODEV
;

544 } ià(
couÁ
 < 0 || 
x2couÁ
 < 0) {

545 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPICƒntry\n");

547  
couÁ
;

550 
couÁ
 =

551 
	`aıi_bË_·r£_madt
(
ACPI_MADT_LAPIC_NMI
, 
aıi_·r£_Ïpic_nmi
, 0);

552 
x2couÁ
 =

553 
	`aıi_bË_·r£_madt
(
ACPI_MADT_X2APIC_NMI
,

554 
aıi_·r£_x2­ic_nmi
, 0);

555 ià(
couÁ
 < 0 || 
x2couÁ
 < 0) {

556 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing LAPIC NMIƒntry\n");

558  
couÁ
;

561 
	}
}

564 #ià
defšed
(
CONFIG_X86_IO_APIC
)

569 
__š™
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

571 
couÁ
;

579 ià(
aıi_di§bËd
 || 
aıi_noœq
) {

580  -
ENODEV
;

583 ià(!
ıu_has_­ic
)

584  -
ENODEV
;

589 ià(
sk_ißpic_£tup
) {

590 
	`´štk
(
KERN_INFO
 
PREFIX
 "Skipping IOAPIC…robe "

592  -
ENODEV
;

595 
couÁ
 =

596 
	`aıi_bË_·r£_madt
(
ACPI_MADT_IOAPIC
, 
aıi_·r£_ißpic
,

597 
MAX_IO_APICS
);

598 ià(!
couÁ
) {

599 
	`´štk
(
KERN_ERR
 
PREFIX
 "No IOAPICƒntries…resent\n");

600  -
ENODEV
;

601 } ià(
couÁ
 < 0) {

602 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing IOAPICƒntry\n");

603  
couÁ
;

606 
couÁ
 =

607 
	`aıi_bË_·r£_madt
(
ACPI_MADT_INT_SRC_OVR
, 
aıi_·r£_št_¤c_ovr
,

608 
MAX_IRQ_SOURCES
);

609 ià(
couÁ
 < 0) {

610 
	`´štk
(
KERN_ERR
 
PREFIX


613  
couÁ
;

616 #ifdeà
CONFIG_ACPI_INTERPRETER


621 ià(!
aıi_sci_ov”ride_gsi
)

622 
	`aıi_sci_ißpic_£tup
(
aıi_çdt
.
sci_št
, 0, 0);

626 
	`mp_cÚfig_aıi_Ëgacy_œqs
();

628 
couÁ
 =

629 
	`aıi_bË_·r£_madt
(
ACPI_MADT_NMI_SRC
, 
aıi_·r£_nmi_¤c
,

630 
MAX_IRQ_SOURCES
);

631 ià(
couÁ
 < 0) {

632 
	`´štk
(
KERN_ERR
 
PREFIX
 "Error…arsing NMI SRCƒntry\n");

634  
couÁ
;

638 
	}
}

640 
šlše
 
	$aıi_·r£_madt_ißpic_’Œ›s
()

643 
	}
}

647 
__š™
 
	$aıi_´oûss_madt
()

649 #ifdeà
CONFIG_X86_LOCAL_APIC


650 
”rÜ
;

652 ià(!
	`aıi_bË_·r£
(
ACPI_SIG_MADT
, 
aıi_·r£_madt
)) {

657 
”rÜ
 = 
	`aıi_·r£_madt_Ïpic_’Œ›s
();

658 ià(!
”rÜ
) {

659 
aıi_Ïpic
 = 1;

660 
	`g’”ic_bigsmp_´obe
();

665 
”rÜ
 = 
	`aıi_·r£_madt_ißpic_’Œ›s
();

666 ià(!
”rÜ
) {

667 
aıi_œq_mod–
 = 
ACPI_IRQ_MODEL_IOAPIC
;

668 
	`aıi_œq_b®ªû_£t
(
NULL
);

669 
aıi_ißpic
 = 1;

671 
smp_found_cÚfig
 = 1;

672 
	`şu¡”ed_­ic_check
();

675 ià(
”rÜ
 =ğ-
EINVAL
) {

679 
	`´štk
(
KERN_ERR
 
PREFIX


681 
	`di§bË_aıi
();

686 
	}
}

688 #ifdeà
__i386__


690 
__š™
 
	$di§bË_aıi_œq
(
dmi_sy¡em_id
 *
d
)

692 ià(!
aıi_fÜû
) {

693 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=noirq\n",

694 
d
->
id’t
);

695 
	`aıi_noœq_£t
();

698 
	}
}

700 
__š™
 
	$di§bË_aıi_pci
(
dmi_sy¡em_id
 *
d
)

702 ià(!
aıi_fÜû
) {

703 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of…ci=noacpi\n",

704 
d
->
id’t
);

708 
	}
}

710 
__š™
 
	$dmi_di§bË_aıi
(
dmi_sy¡em_id
 *
d
)

712 ià(!
aıi_fÜû
) {

713 
	`´štk
(
KERN_NOTICE
 "% d‘eùed:‡ı˜off\n", 
d
->
id’t
);

714 
	`di§bË_aıi
();

716 
	`´štk
(
KERN_NOTICE


720 
	}
}

725 
__š™
 
	$fÜû_aıi_ht
(
dmi_sy¡em_id
 *
d
)

727 ià(!
aıi_fÜû
) {

728 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=ht\n",

729 
d
->
id’t
);

730 
	`di§bË_aıi
();

731 
aıi_ht
 = 1;

733 
	`´štk
(
KERN_NOTICE


737 
	}
}

743 
dmi_sy¡em_id
 
__š™d©a
 
	gaıi_dmi_bË
[] = {

748 .
ÿÎback
 = 
dmi_di§bË_aıi
,

749 .
	gid’t
 = "IBM Thinkpad",

750 .
	gm©ches
 = {

751 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

752 
DMI_MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

760 .
	gÿÎback
 = 
fÜû_aıi_ht
,

761 .
	gid’t
 = "FSC Primergy T850",

762 .
	gm©ches
 = {

763 
DMI_MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

764 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

768 .
	gÿÎback
 = 
fÜû_aıi_ht
,

769 .
	gid’t
 = "DELL GX240",

770 .
	gm©ches
 = {

771 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Dell Computer Corporation"),

772 
DMI_MATCH
(
DMI_BOARD_NAME
, "OptiPlex GX240"),

776 .
	gÿÎback
 = 
fÜû_aıi_ht
,

777 .
	gid’t
 = "HP VISUALIZE NT Workstation",

778 .
	gm©ches
 = {

779 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

780 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

784 .
	gÿÎback
 = 
fÜû_aıi_ht
,

785 .
	gid’t
 = "Compaq Workstation W8000",

786 .
	gm©ches
 = {

787 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

788 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

792 .
	gÿÎback
 = 
fÜû_aıi_ht
,

793 .
	gid’t
 = "ASUS P4B266",

794 .
	gm©ches
 = {

795 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

796 
DMI_MATCH
(
DMI_BOARD_NAME
, "P4B266"),

800 .
	gÿÎback
 = 
fÜû_aıi_ht
,

801 .
	gid’t
 = "ASUS P2B-DS",

802 .
	gm©ches
 = {

803 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

804 
DMI_MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

808 .
	gÿÎback
 = 
fÜû_aıi_ht
,

809 .
	gid’t
 = "ASUS CUR-DLS",

810 .
	gm©ches
 = {

811 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

812 
DMI_MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

816 .
	gÿÎback
 = 
fÜû_aıi_ht
,

817 .
	gid’t
 = "ABIT i440BX-W83977",

818 .
	gm©ches
 = {

819 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

820 
DMI_MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

824 .
	gÿÎback
 = 
fÜû_aıi_ht
,

825 .
	gid’t
 = "IBM Bladecenter",

826 .
	gm©ches
 = {

827 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

828 
DMI_MATCH
(
DMI_BOARD_NAME
, "IBMƒServer BladeCenter HS20"),

832 .
	gÿÎback
 = 
fÜû_aıi_ht
,

833 .
	gid’t
 = "IBMƒServer xSeries 360",

834 .
	gm©ches
 = {

835 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

836 
DMI_MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

840 .
	gÿÎback
 = 
fÜû_aıi_ht
,

841 .
	gid’t
 = "IBMƒserver xSeries 330",

842 .
	gm©ches
 = {

843 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

844 
DMI_MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

848 .
	gÿÎback
 = 
fÜû_aıi_ht
,

849 .
	gid’t
 = "IBMƒserver xSeries 440",

850 .
	gm©ches
 = {

851 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

852 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

860 .
	gÿÎback
 = 
di§bË_aıi_œq
,

861 .
	gid’t
 = "ASUS A7V",

862 .
	gm©ches
 = {

863 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

864 
DMI_MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

866 
DMI_MATCH
(
DMI_BIOS_VERSION
,

875 .
	gÿÎback
 = 
di§bË_aıi_pci
,

876 .
	gid’t
 = "ASUS PR-DLS",

877 .
	gm©ches
 = {

878 
DMI_MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

879 
DMI_MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

880 
DMI_MATCH
(
DMI_BIOS_VERSION
,

882 
DMI_MATCH
(
DMI_BIOS_DATE
, "03/21/2003")

886 .
	gÿÎback
 = 
di§bË_aıi_pci
,

887 .
	gid’t
 = "Acer TravelMate 36x Laptop",

888 .
	gm©ches
 = {

889 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Acer"),

890 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

921 
__š™
 
	$aıi_boÙ_bË_š™
()

923 
”rÜ
;

925 #ifdeà
__i386__


926 
	`dmi_check_sy¡em
(
aıi_dmi_bË
);

933 ià(
aıi_di§bËd
 && !
aıi_ht
)

939 
”rÜ
 = 
	`aıi_bË_š™
();

940 ià(
”rÜ
) {

941 
	`di§bË_aıi
();

942  
”rÜ
;

945 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

950 
”rÜ
 = 
	`aıi_bÏckli¡ed
();

951 ià(
”rÜ
) {

952 ià(
aıi_fÜû
) {

953 
	`´štk
(
KERN_WARNING
 
PREFIX
 "acpi=force override\n");

955 
	`´štk
(
KERN_WARNING
 
PREFIX
 "Disabling ACPI support\n");

956 
	`di§bË_aıi
();

957  
”rÜ
;

962 
	}
}

964 
__š™
 
	$aıi_boÙ_š™
()

970 ià(
aıi_di§bËd
 && !
aıi_ht
)

973 
	`aıi_bË_·r£
(
ACPI_SIG_BOOT
, 
aıi_·r£_sbf
);

978 
	`aıi_bË_·r£
(
ACPI_SIG_FADT
, 
aıi_·r£_çdt
);

983 
	`aıi_´oûss_madt
();

985 
	`aıi_bË_·r£
(
ACPI_SIG_HPET
, 
aıi_·r£_h³t
);

987 
	`aıi_dm¬_š™
();

989 
	`aıi_mmcfg_š™
();

991 
	`”¡_š™
();

994 
	}
}

996 
	$aıi_g‘_´oûssÜ_id
(
ıu
)

998 
aıiid
, 
­icid
;

1000 ià((
­icid
 = 
x86_ıu_to_­icid
[
ıu
]è=ğ
BAD_APICID
)

1001  
INVALID_ACPIID
;

1003 
aıiid
 = 0;‡ıiid < 
	`ARRAY_SIZE
(
x86_aıiid_to_­icid
);‡cpiid++)

1004 ià(
x86_aıiid_to_­icid
[
aıiid
] =ğ
­icid
)

1005  
aıiid
;

1007  
INVALID_ACPIID
;

1008 
	}
}

	@acpi/cpu_idle.c

34 
	~<x’/cÚfig.h
>

35 
	~<x’/”ºo.h
>

36 
	~<x’/lib.h
>

37 
	~<x’/ty³s.h
>

38 
	~<x’/aıi.h
>

39 
	~<x’/smp.h
>

40 
	~<x’/gue¡_acûss.h
>

41 
	~<x’/keyhªdËr.h
>

42 
	~<x’/ıuidË.h
>

43 
	~<x’/Œaû.h
>

44 
	~<x’/sched-if.h
>

45 
	~<asm/ÿche.h
>

46 
	~<asm/io.h
>

47 
	~<asm/h³t.h
>

48 
	~<asm/´oûssÜ.h
>

49 
	~<x’/pm¡©.h
>

50 
	~<x’/soáœq.h
>

51 
	~<public/¶©fÜm.h
>

52 
	~<public/sysùl.h
>

53 
	~<aıi/ıuäeq/ıuäeq.h
>

54 
	~<asm/­ic.h
>

58 
	#GET_HW_RES_IN_NS
(
m¤
, 
v®
) \

59 dØ{ 
	`rdm¤l
(
m¤
, 
v®
); v® = 
	`tsc_ticks2ns
(v®); }  0 )

	)

60 
	#GET_PC3_RES
(
v®
è
	`GET_HW_RES_IN_NS
(0x3F8, v®)

	)

61 
	#GET_PC6_RES
(
v®
è
	`GET_HW_RES_IN_NS
(0x3F9, v®)

	)

62 
	#GET_PC7_RES
(
v®
è
	`GET_HW_RES_IN_NS
(0x3FA, v®)

	)

63 
	#GET_CC3_RES
(
v®
è
	`GET_HW_RES_IN_NS
(0x3FC, v®)

	)

64 
	#GET_CC6_RES
(
v®
è
	`GET_HW_RES_IN_NS
(0x3FD, v®)

	)

66 
	$Ïpic_tim”_nİ
(è{ 
	}
}

67 (*
Ïpic_tim”_off
)();

68 (*
Ïpic_tim”_Ú
)();

70 
	$ušt64_t
 (*
g‘_tick
)();

71 
	$ušt64_t
 (*
ticks_–­£d
)(
ušt64_t
 
t1
, ušt64_ˆ
t2
);

72 
	$ušt64_t
 (*
tick_to_ns
)(
ušt64_t
 
ticks
);

73 
	$ušt64_t
 (*
ns_to_tick
)(
ušt64_t
 
ticks
);

75 (*
pm_idË
) ();

76 (*
d—d_idË
) ();

77 
	`m’u_g‘_Œaû_d©a
(
u32
 *
ex³ùed
, u32 *
´ed
);

79 (*
pm_idË_§ve
è(è
__»ad_mo¡ly
;

80 
max_c¡©e
 
__»ad_mo¡ly
 = 
ACPI_PROCESSOR_MAX_POWER
 - 1;

81 
	`š‹g”_·¿m
("max_c¡©e", 
max_c¡©e
);

82 
boŞ_t
 
__»ad_mo¡ly
 
loÿl_­ic_tim”_c2_ok
;

83 
	`boŞ—n_·¿m
("Ïpic_tim”_c2_ok", 
loÿl_­ic_tim”_c2_ok
);

85 
aıi_´oûssÜ_pow”
 *
__»ad_mo¡ly
 
´oûssÜ_pow”s
[
NR_CPUS
];

87 
	shw_»sid’c›s


89 
ušt64_t
 
pc3
;

90 
ušt64_t
 
pc6
;

91 
ušt64_t
 
pc7
;

92 
ušt64_t
 
cc3
;

93 
ušt64_t
 
cc6
;

96 
	$do_g‘_hw_»sid’c›s
(*
¬g
)

98 
ıušfo_x86
 *
c
 = &
cu¼’t_ıu_d©a
;

99 
hw_»sid’c›s
 *
hw_»s
 = (hw_»sid’c› *)
¬g
;

101 iàĞ
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 || c->
x86
 != 6 )

104  
c
->
x86_mod–
 )

114 
	`GET_PC3_RES
(
hw_»s
->
pc3
);

115 
	`GET_PC6_RES
(
hw_»s
->
pc6
);

116 
	`GET_PC7_RES
(
hw_»s
->
pc7
);

117 
	`GET_CC3_RES
(
hw_»s
->
cc3
);

118 
	`GET_CC6_RES
(
hw_»s
->
cc6
);

121 
	}
}

123 
	$g‘_hw_»sid’c›s
(
ušt32_t
 
ıu
, 
hw_»sid’c›s
 *
hw_»s
)

125 iàĞ
	`smp_´oûssÜ_id
(è=ğ
ıu
 )

126 
	`do_g‘_hw_»sid’c›s
((*)
hw_»s
);

128 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
),

129 
do_g‘_hw_»sid’c›s
, (*)
hw_»s
, 1);

130 
	}
}

132 
	$´št_hw_»sid’c›s
(
ušt32_t
 
ıu
)

134 
hw_»sid’c›s
 
hw_»s
 = {0};

136 
	`g‘_hw_»sid’c›s
(
ıu
, &
hw_»s
);

138 
	`´štk
("PC3[%"
PRId64
"] PC6[%"PRId64"] PC7[%"PRId64"]\n",

139 
hw_»s
.
pc3
, hw_»s.
pc6
, hw_»s.
pc7
);

140 
	`´štk
("CC3[%"
PRId64
"] CC6[%"PRId64"]\n",

141 
hw_»s
.
cc3
, hw_»s.
cc6
);

142 
	}
}

144 * 
	gaıi_c¡©e_m‘hod_Çme
[] =

152 
	$´št_aıi_pow”
(
ušt32_t
 
ıu
, 
aıi_´oûssÜ_pow”
 *
pow”
)

154 
ušt32_t
 
i
, 
idË_u§ge
 = 0;

155 
ušt64_t
 
»s
, 
idË_»s
 = 0;

157 
	`´štk
("==ıu%d==\n", 
ıu
);

158 
	`´štk
("active state:\t\tC%d\n",

159 
pow”
->
Ï¡_¡©e
 ?…ow”->Ï¡_¡©e->
idx
 : -1);

160 
	`´štk
("max_c¡©e:\t\tC%d\n", 
max_c¡©e
);

161 
	`´štk
("states:\n");

163  
i
 = 1; i < 
pow”
->
couÁ
; i++ )

165 
»s
 = 
	`tick_to_ns
(
pow”
->
¡©es
[
i
].
time
);

166 
idË_u§ge
 +ğ
pow”
->
¡©es
[
i
].
u§ge
;

167 
idË_»s
 +ğ
»s
;

169 
	`´štk
((
pow”
->
Ï¡_¡©e
 &&…ow”->Ï¡_¡©e->
idx
 =ğ
i
) ?

171 
	`´štk
("C%d:\t", 
i
);

172 
	`´štk
("ty³[C%d] ", 
pow”
->
¡©es
[
i
].
ty³
);

173 
	`´štk
("Ï‹ncy[%03d] ", 
pow”
->
¡©es
[
i
].
Ï‹ncy
);

174 
	`´štk
("u§ge[%08d] ", 
pow”
->
¡©es
[
i
].
u§ge
);

175 
	`´štk
("m‘hod[%5s] ", 
aıi_c¡©e_m‘hod_Çme
[
pow”
->
¡©es
[
i
].
’Œy_m‘hod
]);

176 
	`´štk
("du¿tiÚ[%"
PRId64
"]\n", 
»s
);

178 
	`´štk
(" C0:\tu§ge[%08d] du¿tiÚ[%"
PRId64
"]\n",

179 
idË_u§ge
, 
	`NOW
(è- 
idË_»s
);

181 
	`´št_hw_»sid’c›s
(
ıu
);

182 
	}
}

184 
	$dump_cx
(
key
)

186 
ıu
;

188 
	`´štk
("'%c'…»s£d ->…rštšg ACPI Cx sŒuùu»s\n", 
key
);

189 
	`fÜ_—ch_Úlše_ıu
 ( 
ıu
 )

190 ià(
´oûssÜ_pow”s
[
ıu
])

191 
	`´št_aıi_pow”
(
ıu
, 
´oûssÜ_pow”s
[cpu]);

192 
	}
}

194 
keyhªdËr
 
	gdump_cx_keyhªdËr
 = {

195 .
dŸgno¡ic
 = 1,

196 .
	gu
.
	gâ
 = 
dump_cx
,

197 .
	gdesc
 = "dump ACPI Cx structures"

200 
__š™
 
	$ıu_idË_key_š™
()

202 
	`»gi¡”_keyhªdËr
('c', &
dump_cx_keyhªdËr
);

204 
	}
}

205 
__š™ÿÎ
(
ıu_idË_key_š™
);

207 
ušt64_t
 
	$g‘_¡ime_tick
(è{  (
ušt64_t
)
	`NOW
(); 
	}
}

208 
ušt64_t
 
	$¡ime_ticks_–­£d
(
ušt64_t
 
t1
, ušt64_ˆ
t2
è{ 2 -1; 
	}
}

209 
ušt64_t
 
	$¡ime_tick_to_ns
(
ušt64_t
 
ticks
è{ icks; 
	}
}

210 
ušt64_t
 
	$ns_to_¡ime_tick
(
ušt64_t
 
ns
è{ ‚s; 
	}
}

212 
ušt64_t
 
	$g‘_aıi_pm_tick
(è{  (
ušt64_t
)
	`šl
(
pmtmr_iİÜt
); 
	}
}

213 
ušt64_t
 
	$aıi_pm_ticks_–­£d
(
ušt64_t
 
t1
, ušt64_ˆ
t2
)

215 iàĞ
t2
 >ğ
t1
 )

216  (
t2
 - 
t1
);

217 iàĞ!(
aıi_gbl_FADT
.
æags
 & 
ACPI_FADT_32BIT_TIMER
) )

218  (((0x00FFFFFF - 
t1
è+ 
t2
 + 1) & 0x00FFFFFF);

220  ((0xFFFFFFFF - 
t1
è+ 
t2
 +1);

221 
	}
}

223 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

230 
ıumask_t
 
	gıuidË_mwa™_æags
;

232 
	$ıuidË_wakeup_mwa™
(
ıumask_t
 *
mask
)

234 
ıumask_t
 
rg‘
;

235 
ıu
;

237 
	`ıus_ªd
(
rg‘
, *
mask
, 
ıuidË_mwa™_æags
);

240 
	`fÜ_—ch_ıu_mask
(
ıu
, 
rg‘
)

241 
	`mwa™_wakeup
(
ıu
) = 0;

243 
	`ıus_ªdnÙ
(*
mask
, *mask, 
rg‘
);

244 
	}
}

246 
	$mwa™_idË_w™h_hšts
(
—x
, 
ecx
)

248 
ıu
 = 
	`smp_´oûssÜ_id
();

249 
s_time_t
 
expœes
 = 
	`³r_ıu
(
tim”_d—dlše
, 
ıu
);

251 
	`__mÚ™Ü
((*)&
	`mwa™_wakeup
(
ıu
), 0, 0);

252 
	`smp_mb
();

258 iàĞ
expœes
 > 
	`NOW
() ||ƒxpires == 0 )

260 
	`ıu_£t
(
ıu
, 
ıuidË_mwa™_æags
);

261 
	`__mwa™
(
—x
, 
ecx
);

262 
	`ıu_ş—r
(
ıu
, 
ıuidË_mwa™_æags
);

265 iàĞ
expœes
 <ğ
	`NOW
() &&ƒxpires > 0 )

266 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

267 
	}
}

269 
	$aıi_´oûssÜ_ffh_c¡©e_’‹r
(
aıi_´oûssÜ_cx
 *
cx
)

271 
	`mwa™_idË_w™h_hšts
(
cx
->
add»ss
, 
MWAIT_ECX_INTERRUPT_BREAK
);

272 
	}
}

274 
	$aıi_idË_do_’Œy
(
aıi_´oûssÜ_cx
 *
cx
)

276 
unu£d
;

278  
cx
->
’Œy_m‘hod
 )

280 
ACPI_CSTATE_EM_FFH
:

282 
	`aıi_´oûssÜ_ffh_c¡©e_’‹r
(
cx
);

284 
ACPI_CSTATE_EM_SYSIO
:

286 
	`šb
(
cx
->
add»ss
);

290 
unu£d
 = 
	`šl
(
pmtmr_iİÜt
);

292 
ACPI_CSTATE_EM_HALT
:

293 
	`§ã_h®t
();

294 
	`loÿl_œq_di§bË
();

297 
	}
}

299 
	$aıi_idË_bm_check
()

301 
u32
 
bm_¡©us
 = 0;

303 
	`aıi_g‘_»gi¡”
(
ACPI_BITREG_BUS_MASTER_STATUS
, &
bm_¡©us
);

304 iàĞ
bm_¡©us
 )

305 
	`aıi_£t_»gi¡”
(
ACPI_BITREG_BUS_MASTER_STATUS
, 1);

311  
bm_¡©us
;

312 
	}
}

315 
¥šlock_t
 
	mlock
;

316 
	mcouÁ
;

317 } 
	gc3_ıu_¡©us
 = { .
lock
 = 
SPIN_LOCK_UNLOCKED
 };

319 
šlše
 
	$Œaû_ex™_»asÚ
(
u32
 *
œq_Œaûd
)

321 iàĞ
	`uÆik–y
(
tb_š™_dÚe
) )

323 
i
, 
curb™
;

324 
u32
 
œr_¡©us
[8] = { 0 };

327  
i
 = 0; i < 8; i++ )

328 
œr_¡©us
[
i
] = 
	`­ic_»ad
(
APIC_IRR
 + (i << 4));

329 
i
 = 0;

330 
curb™
 = 
	`fšd_fœ¡_b™
((cÚ¡ *)
œr_¡©us
, 256);

331  
i
 < 4 && 
curb™
 < 256 )

333 
œq_Œaûd
[
i
++] = 
curb™
;

334 
curb™
 = 
	`fšd_Ãxt_b™
((cÚ¡ *)
œr_¡©us
, 256, curbit + 1);

337 
	}
}

343 
	$sched_has_urg’t_vıu
()

345  
	`©omic_»ad
(&
	`this_ıu
(
scheduË_d©a
).
urg’t_couÁ
);

346 
	}
}

356 
boŞ_t
 
	$”¿_c6_eoi_wÜk¬ound
()

358 
boŞ_t
 
fix_Ãeded
 = -1;

360 iàĞ
	`uÆik–y
(
fix_Ãeded
 == -1) )

362 
mod–
 = 
boÙ_ıu_d©a
.
x86_mod–
;

363 
fix_Ãeded
 = (
ıu_has_­ic
 && !
dœeùed_eoi_’abËd
 &&

364 (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) &&

365 (
boÙ_ıu_d©a
.
x86
 == 6) &&

366 ((
mod–
 == 0x1a) || (model == 0x1e) || (model == 0x1f) ||

367 (
mod–
 == 0x25) || (model == 0x2c) || (model == 0x2f)));

370  (
fix_Ãeded
 && 
	`ıu_has_³ndšg_­ic_eoi
());

371 
	}
}

373 
	$aıi_´oûssÜ_idË
()

375 
aıi_´oûssÜ_pow”
 *
pow”
 = 
´oûssÜ_pow”s
[
	`smp_´oûssÜ_id
()];

376 
aıi_´oûssÜ_cx
 *
cx
 = 
NULL
;

377 
Ãxt_¡©e
;

378 
št64_t
 
¦“p_ticks
 = 0;

379 
ušt64_t
 
t1
, 
t2
 = 0;

380 
u32
 
exp
 = 0, 
´ed
 = 0;

381 
u32
 
œq_Œaûd
[4] = { 0 };

383 iàĞ
max_c¡©e
 > 0 && 
pow”
 && !
	`sched_has_urg’t_vıu
() &&

384 (
Ãxt_¡©e
 = 
ıuidË_cu¼’t_gov”nÜ
->
	`£Ëù
(
pow”
)) > 0 )

386 
cx
 = &
pow”
->
¡©es
[
Ãxt_¡©e
];

387 iàĞ
pow”
->
æags
.
bm_check
 && 
	`aıi_idË_bm_check
()

388 && 
cx
->
ty³
 =ğ
ACPI_STATE_C3
 )

389 
cx
 = 
pow”
->
§ã_¡©e
;

390 iàĞ
cx
->
idx
 > 
max_c¡©e
 )

391 
cx
 = &
pow”
->
¡©es
[
max_c¡©e
];

392 
	`m’u_g‘_Œaû_d©a
(&
exp
, &
´ed
);

394 iàĞ!
cx
 )

396 iàĞ
pm_idË_§ve
 )

397 
	`pm_idË_§ve
();

399 
	`§ã_h®t
();

403 
	`ıuäeq_dbs_tim”_su¥’d
();

405 
	`sched_tick_su¥’d
();

407 
	`´oûss_³ndšg_soáœqs
();

413 
	`loÿl_œq_di§bË
();

415 iàĞ!
	`ıu_is_h®bË
(
	`smp_´oûssÜ_id
()) )

417 
	`loÿl_œq_’abË
();

418 
	`sched_tick_»sume
();

419 
	`ıuäeq_dbs_tim”_»sume
();

423 iàĞ(
cx
->
ty³
 =ğ
ACPI_STATE_C3
è&& 
	`”¿_c6_eoi_wÜk¬ound
() )

424 
cx
 = 
pow”
->
§ã_¡©e
;

426 
pow”
->
Ï¡_¡©e
 = 
cx
;

433  
cx
->
ty³
 )

435 
ACPI_STATE_C1
:

436 
ACPI_STATE_C2
:

437 iàĞ
cx
->
ty³
 =ğ
ACPI_STATE_C1
 || 
loÿl_­ic_tim”_c2_ok
 )

440 
t1
 = 
	`g‘_tick
();

442 
	`TRACE_4D
(
TRC_PM_IDLE_ENTRY
, 
cx
->
idx
, 
t1
, 
exp
, 
´ed
);

444 
	`aıi_idË_do_’Œy
(
cx
);

446 
t2
 = 
	`g‘_tick
();

447 
	`Œaû_ex™_»asÚ
(
œq_Œaûd
);

449 
	`TRACE_6D
(
TRC_PM_IDLE_EXIT
, 
cx
->
idx
, 
t2
,

450 
œq_Œaûd
[0], irq_traced[1], irq_traced[2], irq_traced[3]);

452 
	`loÿl_œq_’abË
();

454 
¦“p_ticks
 = 
	`ticks_–­£d
(
t1
, 
t2
);

458 
ACPI_STATE_C3
:

465 
	`Ïpic_tim”_off
();

468 
t1
 = 
	`g‘_tick
();

470 
	`TRACE_4D
(
TRC_PM_IDLE_ENTRY
, 
cx
->
idx
, 
t1
, 
exp
, 
´ed
);

482 iàĞ
pow”
->
æags
.
bm_check
 &&…ow”->æags.
bm_cÚŒŞ
 )

484 
	`¥š_lock
(&
c3_ıu_¡©us
.
lock
);

485 iàĞ++
c3_ıu_¡©us
.
couÁ
 =ğ
	`num_Úlše_ıus
() )

491 
	`aıi_£t_»gi¡”
(
ACPI_BITREG_ARB_DISABLE
, 1);

493 
	`¥š_uÆock
(&
c3_ıu_¡©us
.
lock
);

495 iàĞ!
pow”
->
æags
.
bm_check
 )

498 
	`ACPI_FLUSH_CPU_CACHE
();

502 
	`aıi_idË_do_’Œy
(
cx
);

504 iàĞ
pow”
->
æags
.
bm_check
 &&…ow”->æags.
bm_cÚŒŞ
 )

507 
	`¥š_lock
(&
c3_ıu_¡©us
.
lock
);

508 
	`aıi_£t_»gi¡”
(
ACPI_BITREG_ARB_DISABLE
, 0);

509 
c3_ıu_¡©us
.
couÁ
--;

510 
	`¥š_uÆock
(&
c3_ıu_¡©us
.
lock
);

514 
t2
 = 
	`g‘_tick
();

517 
	`c¡©e_»¡Üe_tsc
();

518 
	`Œaû_ex™_»asÚ
(
œq_Œaûd
);

520 
	`TRACE_6D
(
TRC_PM_IDLE_EXIT
, 
cx
->
idx
, 
t2
,

521 
œq_Œaûd
[0], irq_traced[1], irq_traced[2], irq_traced[3]);

524 
	`loÿl_œq_’abË
();

526 
	`Ïpic_tim”_Ú
();

528 
¦“p_ticks
 = 
	`ticks_–­£d
(
t1
, 
t2
);

533 
	`loÿl_œq_’abË
();

534 
	`sched_tick_»sume
();

535 
	`ıuäeq_dbs_tim”_»sume
();

539 
cx
->
u§ge
++;

540 iàĞ
¦“p_ticks
 > 0 )

542 
pow”
->
Ï¡_»sid’cy
 = 
	`tick_to_ns
(
¦“p_ticks
) / 1000UL;

543 
cx
->
time
 +ğ
¦“p_ticks
;

546 
	`sched_tick_»sume
();

547 
	`ıuäeq_dbs_tim”_»sume
();

549 iàĞ
ıuidË_cu¼’t_gov”nÜ
->
»æeù
 )

550 
ıuidË_cu¼’t_gov”nÜ
->
	`»æeù
(
pow”
);

551 
	}
}

553 
	$aıi_d—d_idË
()

555 
aıi_´oûssÜ_pow”
 *
pow”
;

556 
aıi_´oûssÜ_cx
 *
cx
;

557 *
mwa™_±r
;

559 iàĞ(
pow”
 = 
´oûssÜ_pow”s
[
	`smp_´oûssÜ_id
()]è=ğ
NULL
 )

560 
deçuÉ_h®t
;

562 iàĞ(
cx
 = &
pow”
->
¡©es
[pow”->
couÁ
-1]è=ğ
NULL
 )

563 
deçuÉ_h®t
;

565 
mwa™_±r
 = (*)&
	`mwa™_wakeup
(
	`smp_´oûssÜ_id
());

567 iàĞ
cx
->
’Œy_m‘hod
 =ğ
ACPI_CSTATE_EM_FFH
 )

574 
	`wbšvd
();

587 
	`mb
();

588 
	`şæush
(
mwa™_±r
);

589 
	`__mÚ™Ü
(
mwa™_±r
, 0, 0);

590 
	`mb
();

591 
	`__mwa™
(
cx
->
add»ss
, 0);

595 
deçuÉ_h®t
:

596 
	`wbšvd
();

598 
	`h®t
();

599 
	}
}

601 
	$š™_cx_pmšfo
(
aıi_´oûssÜ_pow”
 *
aıi_pow”
)

603 
i
;

605 
	`mem£t
(
aıi_pow”
, 0, (*acpi_power));

607  
i
 = 0; i < 
ACPI_PROCESSOR_MAX_POWER
; i++ )

608 
aıi_pow”
->
¡©es
[
i
].
idx
 = i;

610 
aıi_pow”
->
¡©es
[
ACPI_STATE_C1
].
ty³
 = ACPI_STATE_C1;

611 
aıi_pow”
->
¡©es
[
ACPI_STATE_C1
].
’Œy_m‘hod
 = 
ACPI_CSTATE_EM_HALT
;

613 
aıi_pow”
->
¡©es
[
ACPI_STATE_C0
].
v®id
 = 1;

614 
aıi_pow”
->
¡©es
[
ACPI_STATE_C1
].
v®id
 = 1;

616 
aıi_pow”
->
couÁ
 = 2;

617 
aıi_pow”
->
§ã_¡©e
 = &aıi_pow”->
¡©es
[
ACPI_STATE_C1
];

620 
	}
}

622 
	#CPUID_MWAIT_LEAF
 (5)

	)

623 
	#CPUID5_ECX_EXTENSIONS_SUPPORTED
 (0x1)

	)

624 
	#CPUID5_ECX_INTERRUPT_BREAK
 (0x2)

	)

626 
	#MWAIT_ECX_INTERRUPT_BREAK
 (0x1)

	)

628 
	#MWAIT_SUBSTATE_MASK
 (0xf)

	)

629 
	#MWAIT_SUBSTATE_SIZE
 (4)

	)

631 
	$aıi_´oûssÜ_ffh_c¡©e_´obe
(
x’_´oûssÜ_cx_t
 *
cx
)

633 
ıušfo_x86
 *
c
 = &
cu¼’t_ıu_d©a
;

634 
—x
, 
ebx
, 
ecx
, 
edx
;

635 
edx_·¹
;

636 
c¡©e_ty³
;

637 
num_c¡©e_subty³
;

639 iàĞ
c
->
ıuid_Ëv–
 < 
CPUID_MWAIT_LEAF
 )

641 
	`´štk
(
XENLOG_INFO
 "MWAIT†eaf‚ot supported by cpuid\n");

642  -
EFAULT
;

645 
	`ıuid
(
CPUID_MWAIT_LEAF
, &
—x
, &
ebx
, &
ecx
, &
edx
);

646 
	`´štk
(
XENLOG_DEBUG
 "cpuid.MWAIT[.eax=%x, .ebx=%x, .ecx=%x, .edx=%x]\n",

647 
—x
, 
ebx
, 
ecx
, 
edx
);

650 
c¡©e_ty³
 = (
cx
->
»g
.
add»ss
 >> 
MWAIT_SUBSTATE_SIZE
) + 1;

651 
edx_·¹
 = 
edx
 >> (
c¡©e_ty³
 * 
MWAIT_SUBSTATE_SIZE
);

652 
num_c¡©e_subty³
 = 
edx_·¹
 & 
MWAIT_SUBSTATE_MASK
;

654 iàĞ
num_c¡©e_subty³
 < (
cx
->
»g
.
add»ss
 & 
MWAIT_SUBSTATE_MASK
) )

655  -
EFAULT
;

658 iàĞ!(
ecx
 & 
CPUID5_ECX_EXTENSIONS_SUPPORTED
) ||

659 !(
ecx
 & 
CPUID5_ECX_INTERRUPT_BREAK
) )

660  -
EFAULT
;

662 
	`´štk
(
XENLOG_INFO
 "MÚ™Ü-Mwa™ wÈbu£dØ’‹¸C-%d s‹\n", 
cx
->
ty³
);

664 
	}
}

676 
	$aıi_´oûssÜ_pow”_š™_bm_check
(
aıi_´oûssÜ_æags
 *
æags
)

678 
ıušfo_x86
 *
c
 = &
cu¼’t_ıu_d©a
;

680 
æags
->
bm_check
 = 0;

681 iàĞ
	`num_Úlše_ıus
() == 1 )

682 
æags
->
bm_check
 = 1;

683 iàĞ
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

690 
æags
->
bm_check
 = 1;

699 iàĞ
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

700 (
c
->
x86
 > 0x6 || (c->x86 =ğ6 && c->
x86_mod–
 >= 14)) )

701 
æags
->
bm_cÚŒŞ
 = 0;

702 
	}
}

704 
	#VENDOR_INTEL
 (1)

	)

705 
	#NATIVE_CSTATE_BEYOND_HALT
 (2)

	)

707 
	$check_cx
(
aıi_´oûssÜ_pow”
 *
pow”
, 
x’_´oûssÜ_cx_t
 *
cx
)

709 
bm_check_æag
 = -1;

710 
bm_cÚŒŞ_æag
 = -1;

712  
cx
->
»g
.
¥aû_id
 )

714 
ACPI_ADR_SPACE_SYSTEM_IO
:

715 iàĞ
cx
->
»g
.
add»ss
 == 0 )

716  -
EINVAL
;

719 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

720 iàĞ
cx
->
»g
.
b™_width
 !ğ
VENDOR_INTEL
 ||

721 
cx
->
»g
.
b™_off£t
 !ğ
NATIVE_CSTATE_BEYOND_HALT
 )

722  -
EINVAL
;

725 iàĞ
	`aıi_´oûssÜ_ffh_c¡©e_´obe
(
cx
) )

726  -
EINVAL
;

730  -
ENODEV
;

733  
cx
->
ty³
 )

735 
ACPI_STATE_C2
:

736 iàĞ
loÿl_­ic_tim”_c2_ok
 )

738 
ACPI_STATE_C3
:

739 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_ARAT
) )

741 
Ïpic_tim”_off
 = 
Ïpic_tim”_nİ
;

742 
Ïpic_tim”_Ú
 = 
Ïpic_tim”_nİ
;

744 iàĞ
	`h³t_brßdÿ¡_is_avaabË
() )

746 
Ïpic_tim”_off
 = 
h³t_brßdÿ¡_’‹r
;

747 
Ïpic_tim”_Ú
 = 
h³t_brßdÿ¡_ex™
;

749 iàĞ
	`p™_brßdÿ¡_is_avaabË
() )

751 
Ïpic_tim”_off
 = 
p™_brßdÿ¡_’‹r
;

752 
Ïpic_tim”_Ú
 = 
p™_brßdÿ¡_ex™
;

756  -
EINVAL
;

760 iàĞ
bm_check_æag
 == -1 )

763 
	`aıi_´oûssÜ_pow”_š™_bm_check
(&(
pow”
->
æags
));

764 
bm_check_æag
 = 
pow”
->
æags
.
bm_check
;

765 
bm_cÚŒŞ_æag
 = 
pow”
->
æags
.
bm_cÚŒŞ
;

769 
pow”
->
æags
.
bm_check
 = 
bm_check_æag
;

770 
pow”
->
æags
.
bm_cÚŒŞ
 = 
bm_cÚŒŞ_æag
;

773 iàĞ
pow”
->
æags
.
bm_check
 )

775 iàĞ!
pow”
->
æags
.
bm_cÚŒŞ
 )

777 iàĞ
pow”
->
æags
.
has_c¡
 != 1 )

780 
	`ACPI_DEBUG_PRINT
((
ACPI_DB_INFO
,

782  -
EINVAL
;

787 
	`ACPI_DEBUG_PRINT
((
ACPI_DB_INFO
,

799 
	`aıi_£t_»gi¡”
(
ACPI_BITREG_BUS_MASTER_RLD
, 1);

807 iàĞ!(
aıi_gbl_FADT
.
æags
 & 
ACPI_FADT_WBINVD
) )

809 
	`ACPI_DEBUG_PRINT
((
ACPI_DB_INFO
,

812  -
EINVAL
;

814 
	`aıi_£t_»gi¡”
(
ACPI_BITREG_BUS_MASTER_RLD
, 0);

821 
	}
}

823 
	gÏ‹ncy_çùÜ
 = 2;

824 
š‹g”_·¿m
("idË_Ï‹ncy_çùÜ", 
Ï‹ncy_çùÜ
);

826 
	$£t_cx
(

827 
aıi_´oûssÜ_pow”
 *
aıi_pow”
,

828 
x’_´oûssÜ_cx_t
 *
x’_cx
)

830 
aıi_´oûssÜ_cx
 *
cx
;

832 iàĞ
	`check_cx
(
aıi_pow”
, 
x’_cx
) != 0 )

835 iàĞ
x’_cx
->
ty³
 =ğ
ACPI_STATE_C1
 )

836 
cx
 = &
aıi_pow”
->
¡©es
[1];

838 
cx
 = &
aıi_pow”
->
¡©es
[aıi_pow”->
couÁ
];

840 iàĞ!
cx
->
v®id
 )

841 
aıi_pow”
->
couÁ
++;

843 
cx
->
v®id
 = 1;

844 
cx
->
ty³
 = 
x’_cx
->type;

845 
cx
->
add»ss
 = 
x’_cx
->
»g
.address;

847  
x’_cx
->
»g
.
¥aû_id
 )

849 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

850 iàĞ
x’_cx
->
»g
.
b™_width
 =ğ
VENDOR_INTEL
 &&

851 
x’_cx
->
»g
.
b™_off£t
 =ğ
NATIVE_CSTATE_BEYOND_HALT
 &&

852 
	`boÙ_ıu_has
(
X86_FEATURE_MWAIT
) )

853 
cx
->
’Œy_m‘hod
 = 
ACPI_CSTATE_EM_FFH
;

855 
cx
->
’Œy_m‘hod
 = 
ACPI_CSTATE_EM_HALT
;

857 
ACPI_ADR_SPACE_SYSTEM_IO
:

858 
cx
->
’Œy_m‘hod
 = 
ACPI_CSTATE_EM_SYSIO
;

861 
cx
->
’Œy_m‘hod
 = 
ACPI_CSTATE_EM_NONE
;

864 
cx
->
Ï‹ncy
 = 
x’_cx
->latency;

865 
cx
->
pow”
 = 
x’_cx
->power;

867 
cx
->
Ï‹ncy_ticks
 = 
	`ns_to_tick
(cx->
Ï‹ncy
 * 1000UL);

868 
cx
->
rg‘_»sid’cy
 = cx->
Ï‹ncy
 * 
Ï‹ncy_çùÜ
;

869 iàĞ
cx
->
ty³
 =ğ
ACPI_STATE_C1
 || cx->ty³ =ğ
ACPI_STATE_C2
 )

870 
aıi_pow”
->
§ã_¡©e
 = 
cx
;

871 
	}
}

873 
	$g‘_ıu_id
(
u8
 
aıi_id
)

875 
i
;

876 
u32
 
­ic_id
;

878 
­ic_id
 = 
x86_aıiid_to_­icid
[
aıi_id
];

879 iàĞ
­ic_id
 =ğ
BAD_APICID
 )

882  
i
 = 0; i < 
NR_CPUS
; i++ )

884 iàĞ
­ic_id
 =ğ
x86_ıu_to_­icid
[
i
] )

885  
i
;

889 
	}
}

891 #ifdeà
DEBUG_PM_CX


892 
	$´št_cx_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_pow”
 *
pow”
)

894 
	`XEN_GUEST_HANDLE
(
x’_´oûssÜ_cx_t
è
¡©es
;

895 
x’_´oûssÜ_cx_t
 
¡©e
;

896 
	`XEN_GUEST_HANDLE
(
x’_´oûssÜ_csd_t
è
csd
;

897 
x’_´oûssÜ_csd_t
 
dp
;

898 
ušt32_t
 
i
;

900 
	`´štk
("ıu%d cx‡ı˜šfo:\n", 
ıu
);

901 
	`´štk
("\tcouÁ = %d\n", 
pow”
->
couÁ
);

902 
	`´štk
("\tflags: bm_cntl[%d], bm_chk[%d], has_cst[%d],\n"

904 
pow”
->
æags
.
bm_cÚŒŞ
,…ow”->æags.
bm_check
,…ow”->æags.
has_c¡
,

905 
pow”
->
æags
.
pow”_£tup_dÚe
,…ow”->æags.
bm_¾d_£t
);

907 
¡©es
 = 
pow”
->states;

909  
i
 = 0; i < 
pow”
->
couÁ
; i++ )

911 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡_off£t
(&
¡©e
, 
¡©es
, 
i
, 1)) )

914 
	`´štk
("\t¡©es[%d]:\n", 
i
);

915 
	`´štk
("\t\Œeg.¥aû_id = 0x%x\n", 
¡©e
.
»g
.
¥aû_id
);

916 
	`´štk
("\t\Œeg.b™_width = 0x%x\n", 
¡©e
.
»g
.
b™_width
);

917 
	`´štk
("\t\Œeg.b™_off£ˆğ0x%x\n", 
¡©e
.
»g
.
b™_off£t
);

918 
	`´štk
("\t\Œeg.acûss_sizğ0x%x\n", 
¡©e
.
»g
.
acûss_size
);

919 
	`´štk
("\t\Œeg.add»s ğ0x%"
PRIx64
"\n", 
¡©e
.
»g
.
add»ss
);

920 
	`´štk
("\t\‰y³ = %d\n", 
¡©e
.
ty³
);

921 
	`´štk
("\t\©’cy = %d\n", 
¡©e
.
Ï‹ncy
);

922 
	`´štk
("\t\ow” = %d\n", 
¡©e
.
pow”
);

924 
csd
 = 
¡©e
.
dp
;

925 
	`´štk
("\t\tdp(@0x%p)\n", 
csd
.
p
);

927 iàĞ
csd
.
p
 !ğ
NULL
 )

929 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡
(&
dp
, 
csd
, 1)) )

931 
	`´štk
("\t\t\tdomaš = %d\n", 
dp
.
domaš
);

932 
	`´štk
("\t\t\tcoÜd_ty³ = %d\n", 
dp
.
coÜd_ty³
);

933 
	`´štk
("\t\t\Šum = %d\n", 
dp
.
num
);

936 
	}
}

938 
	#´št_cx_pmšfo
(
c
, 
p
)

	)

941 
	$£t_cx_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_pow”
 *
pow”
)

943 
	`XEN_GUEST_HANDLE
(
x’_´oûssÜ_cx_t
è
¡©es
;

944 
x’_´oûssÜ_cx_t
 
x’_cx
;

945 
aıi_´oûssÜ_pow”
 *
aıi_pow”
;

946 
ıu_id
, 
i
;

948 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_okay
(
pow”
->
¡©es
,…ow”->
couÁ
)) )

949  -
EFAULT
;

951 
	`´št_cx_pmšfo
(
ıu
, 
pow”
);

954 
ıu_id
 = 
	`g‘_ıu_id
((
u8
)
ıu
);

955 iàĞ
ıu_id
 == -1 )

957 
	`´štk
(
XENLOG_ERR
 "nØıu_id fÜ‡ıi_id %d\n", 
ıu
);

958  -
EFAULT
;

961 iàĞ
ıu_id
 == 0 )

963 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_NONSTOP_TSC
) )

965 
g‘_tick
 = 
g‘_¡ime_tick
;

966 
ticks_–­£d
 = 
¡ime_ticks_–­£d
;

967 
tick_to_ns
 = 
¡ime_tick_to_ns
;

968 
ns_to_tick
 = 
ns_to_¡ime_tick
;

972 
g‘_tick
 = 
g‘_aıi_pm_tick
;

973 
ticks_–­£d
 = 
aıi_pm_ticks_–­£d
;

974 
tick_to_ns
 = 
aıi_pm_tick_to_ns
;

975 
ns_to_tick
 = 
ns_to_aıi_pm_tick
;

979 
aıi_pow”
 = 
´oûssÜ_pow”s
[
ıu_id
];

980 iàĞ!
aıi_pow”
 )

982 
aıi_pow”
 = 
	`xm®loc
(
aıi_´oûssÜ_pow”
);

983 iàĞ!
aıi_pow”
 )

984  -
ENOMEM
;

985 
	`mem£t
(
aıi_pow”
, 0, (*acpi_power));

986 
´oûssÜ_pow”s
[
ıu_id
] = 
aıi_pow”
;

989 
	`š™_cx_pmšfo
(
aıi_pow”
);

991 
aıi_pow”
->
ıu
 = 
ıu_id
;

992 
aıi_pow”
->
æags
.
bm_check
 = 
pow”
->flags.bm_check;

993 
aıi_pow”
->
æags
.
bm_cÚŒŞ
 = 
pow”
->flags.bm_control;

994 
aıi_pow”
->
æags
.
has_c¡
 = 
pow”
->flags.has_cst;

996 
¡©es
 = 
pow”
->states;

998  
i
 = 0; i < 
pow”
->
couÁ
; i++ )

1000 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡_off£t
(&
x’_cx
, 
¡©es
, 
i
, 1)) )

1001  -
EFAULT
;

1003 
	`£t_cx
(
aıi_pow”
, &
x’_cx
);

1006 iàĞ
ıuidË_cu¼’t_gov”nÜ
->
’abË
 &&

1007 
ıuidË_cu¼’t_gov”nÜ
->
	`’abË
(
aıi_pow”
) )

1008  -
EFAULT
;

1014 iàĞ
ıu_id
 =ğ0 && 
pm_idË_§ve
 =ğ
NULL
 )

1016 
pm_idË_§ve
 = 
pm_idË
;

1017 
pm_idË
 = 
aıi_´oûssÜ_idË
;

1020 iàĞ
ıu_id
 == 0 )

1022 
d—d_idË
 = 
aıi_d—d_idË
;

1026 
	}
}

1028 
ušt32_t
 
	$pm¡©_g‘_cx_Ä
(
ušt32_t
 
ıuid
)

1030  
´oûssÜ_pow”s
[
ıuid
] ?…roûssÜ_pow”s[ıuid]->
couÁ
 : 0;

1031 
	}
}

1033 
	$pm¡©_g‘_cx_¡©
(
ušt32_t
 
ıuid
, 
pm_cx_¡©
 *
¡©
)

1035 cÚ¡ 
aıi_´oûssÜ_pow”
 *
pow”
 = 
´oûssÜ_pow”s
[
ıuid
];

1036 
ušt64_t
 
u§ge
, 
»s
, 
idË_u§ge
 = 0, 
idË_»s
 = 0;

1037 
i
;

1038 
hw_»sid’c›s
 
hw_»s
 = {0};

1040 iàĞ
pow”
 =ğ
NULL
 )

1042 
¡©
->
Ï¡
 = 0;

1043 
¡©
->
Ä
 = 0;

1044 
¡©
->
idË_time
 = 0;

1048 
¡©
->
Ï¡
 = 
pow”
->
Ï¡_¡©e
 ?…ow”->Ï¡_¡©e->
idx
 : 0;

1049 
¡©
->
Ä
 = 
pow”
->
couÁ
;

1050 
¡©
->
idË_time
 = 
	`g‘_ıu_idË_time
(
ıuid
);

1052  
i
 = 
pow”
->
couÁ
 - 1; i >= 0; i-- )

1054 iàĞ
i
 != 0 )

1056 
u§ge
 = 
pow”
->
¡©es
[
i
].usage;

1057 
»s
 = 
	`tick_to_ns
(
pow”
->
¡©es
[
i
].
time
);

1058 
idË_u§ge
 +ğ
u§ge
;

1059 
idË_»s
 +ğ
»s
;

1063 
u§ge
 = 
idË_u§ge
;

1064 
»s
 = 
	`NOW
(è- 
idË_»s
;

1066 iàĞ
	`cİy_to_gue¡_off£t
(
¡©
->
Œigg”s
, 
i
, &
u§ge
, 1) ||

1067 
	`cİy_to_gue¡_off£t
(
¡©
->
»sid’c›s
, 
i
, &
»s
, 1) )

1068  -
EFAULT
;

1071 
	`g‘_hw_»sid’c›s
(
ıuid
, &
hw_»s
);

1073 
¡©
->
pc3
 = 
hw_»s
.pc3;

1074 
¡©
->
pc6
 = 
hw_»s
.pc6;

1075 
¡©
->
pc7
 = 
hw_»s
.pc7;

1076 
¡©
->
cc3
 = 
hw_»s
.cc3;

1077 
¡©
->
cc6
 = 
hw_»s
.cc6;

1080 
	}
}

1082 
	$pm¡©_»£t_cx_¡©
(
ušt32_t
 
ıuid
)

1085 
	}
}

1087 
	$ıuidË_di§bË_d“p_c¡©e
()

1089 iàĞ
max_c¡©e
 > 1 )

1091 iàĞ
loÿl_­ic_tim”_c2_ok
 )

1092 
max_c¡©e
 = 2;

1094 
max_c¡©e
 = 1;

1097 
	`mb
();

1099 
	`h³t_di§bË_Ëgacy_brßdÿ¡
();

1100 
	}
}

1102 
boŞ_t
 
	$ıuidË_usšg_d“p_c¡©e
()

1104  
x’_ıuidË
 && 
max_c¡©e
 > (
loÿl_­ic_tim”_c2_ok
 ? 2 : 1);

1105 
	}
}

	@acpi/cpufreq/cpufreq.c

31 
	~<x’/ty³s.h
>

32 
	~<x’/”ºo.h
>

33 
	~<x’/d–ay.h
>

34 
	~<x’/ıumask.h
>

35 
	~<x’/sched.h
>

36 
	~<x’/tim”.h
>

37 
	~<x’/xm®loc.h
>

38 
	~<asm/bug.h
>

39 
	~<asm/m¤.h
>

40 
	~<asm/io.h
>

41 
	~<asm/cÚfig.h
>

42 
	~<asm/´oûssÜ.h
>

43 
	~<asm/³rıu.h
>

44 
	~<asm/ıuã©u».h
>

45 
	~<aıi/aıi.h
>

46 
	~<aıi/ıuäeq/ıuäeq.h
>

49 
	mUNDEFINED_CAPABLE
 = 0,

50 
	mSYSTEM_INTEL_MSR_CAPABLE
,

51 
	mSYSTEM_IO_CAPABLE
,

54 
	#INTEL_MSR_RANGE
 (0xffffuÎ)

	)

55 
	#CPUID_6_ECX_APERFMPERF_CAPABILITY
 (0x1)

	)

57 
aıi_ıuäeq_d©a
 *
	gdrv_d©a
[
NR_CPUS
];

59 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
;

61 
__»ad_mo¡ly
 
	gaıi_p¡©e_¡riù
;

62 
š‹g”_·¿m
("aıi_p¡©e_¡riù", 
aıi_p¡©e_¡riù
);

64 
	$check_e¡_ıu
(
ıuid
)

66 
ıušfo_x86
 *
ıu
 = &
ıu_d©a
[
ıuid
];

68 ià(
ıu
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 ||

69 !
	`ıu_has
(
ıu
, 
X86_FEATURE_EST
))

73 
	}
}

75 
	$exŒaù_io
(
u32
 
v®ue
, 
aıi_ıuäeq_d©a
 *
d©a
)

77 
´oûssÜ_³rfÜmªû
 *
³rf
;

78 
i
;

80 
³rf
 = 
d©a
->
aıi_d©a
;

82 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

83 ià(
v®ue
 =ğ
³rf
->
¡©es
[
i
].
¡©us
)

84  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

87 
	}
}

89 
	$exŒaù_m¤
(
u32
 
m¤
, 
aıi_ıuäeq_d©a
 *
d©a
)

91 
i
;

92 
´oûssÜ_³rfÜmªû
 *
³rf
;

94 
m¤
 &ğ
INTEL_MSR_RANGE
;

95 
³rf
 = 
d©a
->
aıi_d©a
;

97 
i
=0; 
d©a
->
äeq_bË
[i].
äequ’cy
 !ğ
CPUFREQ_TABLE_END
; i++) {

98 ià(
m¤
 =ğ
³rf
->
¡©es
[
d©a
->
äeq_bË
[
i
].
šdex
].
¡©us
)

99  
d©a
->
äeq_bË
[
i
].
äequ’cy
;

101  
d©a
->
äeq_bË
[0].
äequ’cy
;

102 
	}
}

104 
	$exŒaù_äeq
(
u32
 
v®
, 
aıi_ıuäeq_d©a
 *
d©a
)

106 
d©a
->
ıu_ã©u»
) {

107 
SYSTEM_INTEL_MSR_CAPABLE
:

108  
	`exŒaù_m¤
(
v®
, 
d©a
);

109 
SYSTEM_IO_CAPABLE
:

110  
	`exŒaù_io
(
v®
, 
d©a
);

114 
	}
}

116 
	sm¤_addr
 {

117 
u32
 
	m»g
;

120 
	sio_addr
 {

121 
u16
 
	mpÜt
;

122 
u8
 
	mb™_width
;

126 
m¤_addr
 
	mm¤
;

127 
io_addr
 
	mio
;

128 } 
	tdrv_addr_uniÚ
;

130 
	sdrv_cmd
 {

131 
	mty³
;

132 cÚ¡ 
ıumask_t
 *
	mmask
;

133 
drv_addr_uniÚ
 
	maddr
;

134 
u32
 
	mv®
;

137 
	$do_drv_»ad
(*
drvcmd
)

139 
drv_cmd
 *
cmd
;

141 
cmd
 = (
drv_cmd
 *)
drvcmd
;

143 
cmd
->
ty³
) {

144 
SYSTEM_INTEL_MSR_CAPABLE
:

145 
	`rdm¤l
(
cmd
->
addr
.
m¤
.
»g
, cmd->
v®
);

147 
SYSTEM_IO_CAPABLE
:

148 
	`aıi_os_»ad_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

149 &
cmd
->
v®
, (
u32
)cmd->
addr
.
io
.
b™_width
);

154 
	}
}

156 
	$do_drv_wr™e
(*
drvcmd
)

158 
drv_cmd
 *
cmd
;

159 
ušt64_t
 
m¤_cÚ‹Á
;

161 
cmd
 = (
drv_cmd
 *)
drvcmd
;

163 
cmd
->
ty³
) {

164 
SYSTEM_INTEL_MSR_CAPABLE
:

165 
	`rdm¤l
(
cmd
->
addr
.
m¤
.
»g
, 
m¤_cÚ‹Á
);

166 
m¤_cÚ‹Á
 = (m¤_cÚ‹Á & ~
INTEL_MSR_RANGE
)

167 | (
cmd
->
v®
 & 
INTEL_MSR_RANGE
);

168 
	`wrm¤l
(
cmd
->
addr
.
m¤
.
»g
, 
m¤_cÚ‹Á
);

170 
SYSTEM_IO_CAPABLE
:

171 
	`aıi_os_wr™e_pÜt
((
aıi_io_add»ss
)
cmd
->
addr
.
io
.
pÜt
,

172 
cmd
->
v®
, (
u32
)cmd->
addr
.
io
.
b™_width
);

177 
	}
}

179 
	$drv_»ad
(
drv_cmd
 *
cmd
)

181 
cmd
->
v®
 = 0;

183 
	`ASSERT
(
	`ıumask_weight
(
cmd
->
mask
) == 1);

186 ià(
	`lik–y
(
	`ıumask_‹¡_ıu
(
	`smp_´oûssÜ_id
(), 
cmd
->
mask
)))

187 
	`do_drv_»ad
((*)
cmd
);

189 
	`Ú_£Ëùed_ıus
(
cmd
->
mask
, 
do_drv_»ad
, cmd, 1);

190 
	}
}

192 
	$drv_wr™e
(
drv_cmd
 *
cmd
)

194 ià(
	`ıumask_equ®
(
cmd
->
mask
, 
	`ıumask_of
(
	`smp_´oûssÜ_id
())))

195 
	`do_drv_wr™e
((*)
cmd
);

197 
	`Ú_£Ëùed_ıus
(
cmd
->
mask
, 
do_drv_wr™e
, cmd, 1);

198 
	}
}

200 
u32
 
	$g‘_cur_v®
(cÚ¡ 
ıumask_t
 *
mask
)

202 
ıuäeq_pŞicy
 *
pŞicy
;

203 
´oûssÜ_³rfÜmªû
 *
³rf
;

204 
drv_cmd
 
cmd
;

205 
ıu
 = 
	`smp_´oûssÜ_id
();

207 ià(
	`uÆik–y
(
	`ıumask_em±y
(
mask
)))

210 ià(!
	`ıumask_‹¡_ıu
(
ıu
, 
mask
))

211 
ıu
 = 
	`ıumask_fœ¡
(
mask
);

212 ià(
ıu
 >ğ
NR_CPUS
 || !
	`ıu_Úlše
(cpu))

215 
pŞicy
 = 
	`³r_ıu
(
ıuäeq_ıu_pŞicy
, 
ıu
);

216 ià(!
pŞicy
 || !
drv_d©a
[pŞicy->
ıu
])

219 
drv_d©a
[
pŞicy
->
ıu
]->
ıu_ã©u»
) {

220 
SYSTEM_INTEL_MSR_CAPABLE
:

221 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

222 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_STATUS
;

224 
SYSTEM_IO_CAPABLE
:

225 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

226 
³rf
 = 
drv_d©a
[
pŞicy
->
ıu
]->
aıi_d©a
;

227 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

228 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

234 
cmd
.
mask
 = 
	`ıumask_of
(
ıu
);

236 
	`drv_»ad
(&
cmd
);

237  
cmd
.
v®
;

238 
	}
}

240 
	s³rf_·œ
 {

243 
ušt32_t
 
	mlo
;

244 
ušt32_t
 
	mhi
;

245 } 
	m¥l™
;

246 
ušt64_t
 
	mwhŞe
;

247 } 
	m­”f
, 
	mm³rf
;

249 
DEFINE_PER_CPU
(
³rf_·œ
, 
gov_³rf_·œ
);

250 
DEFINE_PER_CPU
(
³rf_·œ
, 
u¤_³rf_·œ
);

252 
	$»ad_m—su»d_³rf_ùrs
(*
_»adš
)

254 
³rf_·œ
 *
»adš
 = 
_»adš
;

256 
	`rdm¤l
(
MSR_IA32_APERF
, 
»adš
->
­”f
.
whŞe
);

257 
	`rdm¤l
(
MSR_IA32_MPERF
, 
»adš
->
m³rf
.
whŞe
);

258 
	}
}

273 
	$g‘_m—su»d_³rf
(
ıu
, 
æag
)

275 
ıuäeq_pŞicy
 *
pŞicy
;

276 
³rf_·œ
 
»adš
, 
cur
, *
§ved
;

277 
³rf_³rûÁ
;

278 
»tv®
;

280 ià(!
	`ıu_Úlše
(
ıu
))

283 
pŞicy
 = 
	`³r_ıu
(
ıuäeq_ıu_pŞicy
, 
ıu
);

284 ià(!
pŞicy
 || !pŞicy->
­”f_m³rf
)

287 
æag
)

289 
GOV_GETAVG
:

291 
§ved
 = &
	`³r_ıu
(
gov_³rf_·œ
, 
ıu
);

294 
USR_GETAVG
:

296 
§ved
 = &
	`³r_ıu
(
u¤_³rf_·œ
, 
ıu
);

303 ià(
ıu
 =ğ
	`smp_´oûssÜ_id
()) {

304 
	`»ad_m—su»d_³rf_ùrs
((*)&
»adš
);

306 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
), 
»ad_m—su»d_³rf_ùrs
,

307 &
»adš
, 1);

310 
cur
.
­”f
.
whŞe
 = 
»adš
.­”f.whŞ- 
§ved
->aperf.whole;

311 
cur
.
m³rf
.
whŞe
 = 
»adš
.m³rf.whŞ- 
§ved
->mperf.whole;

312 
§ved
->
­”f
.
whŞe
 = 
»adš
.aperf.whole;

313 
§ved
->
m³rf
.
whŞe
 = 
»adš
.mperf.whole;

315 #ifdeà
__i386__


321 ià(
	`uÆik–y
(
cur
.
­”f
.
¥l™
.
hi
 || cur.
m³rf
.split.hi)) {

322 
shiá_couÁ
;

323 
ušt32_t
 
h
;

325 
h
 = 
	`max_t
(
ušt32_t
, 
cur
.
­”f
.
¥l™
.
hi
, cur.
m³rf
.split.hi);

326 
shiá_couÁ
 = 
	`æs
(
h
);

328 
cur
.
­”f
.
whŞe
 >>ğ
shiá_couÁ
;

329 
cur
.
m³rf
.
whŞe
 >>ğ
shiá_couÁ
;

332 ià((()(-1è/ 100è< 
cur
.
­”f
.
¥l™
.
lo
) {

333 
shiá_couÁ
 = 7;

334 
cur
.
­”f
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

335 
cur
.
m³rf
.
¥l™
.
lo
 >>ğ
shiá_couÁ
;

338 ià(
cur
.
­”f
.
¥l™
.
lo
 && cur.
m³rf
.split.lo)

339 
³rf_³rûÁ
 = (
cur
.
­”f
.
¥l™
.
lo
 * 100è/ cur.
m³rf
.split.lo;

341 
³rf_³rûÁ
 = 0;

344 ià(
	`uÆik–y
((()(-1è/ 100è< 
cur
.
­”f
.
whŞe
)) {

345 
shiá_couÁ
 = 7;

346 
cur
.
­”f
.
whŞe
 >>ğ
shiá_couÁ
;

347 
cur
.
m³rf
.
whŞe
 >>ğ
shiá_couÁ
;

350 ià(
cur
.
­”f
.
whŞe
 && cur.
m³rf
.whole)

351 
³rf_³rûÁ
 = (
cur
.
­”f
.
whŞe
 * 100è/ cur.
m³rf
.whole;

353 
³rf_³rûÁ
 = 0;

357 
»tv®
 = 
pŞicy
->
ıušfo
.
max_äeq
 * 
³rf_³rûÁ
 / 100;

359  
»tv®
;

360 
	}
}

362 
	$g‘_cur_äeq_Ú_ıu
(
ıu
)

364 
ıuäeq_pŞicy
 *
pŞicy
;

365 
aıi_ıuäeq_d©a
 *
d©a
;

366 
äeq
;

368 ià(!
	`ıu_Úlše
(
ıu
))

371 
pŞicy
 = 
	`³r_ıu
(
ıuäeq_ıu_pŞicy
, 
ıu
);

372 ià(!
pŞicy
)

375 
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

376 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

377 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL))

380 
äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
	`ıumask_of
(
ıu
)), 
d©a
);

381  
äeq
;

382 
	}
}

384 
	$ã©u»_d‘eù
(*
šfo
)

386 
ıuäeq_pŞicy
 *
pŞicy
 = 
šfo
;

387 
—x
, 
ecx
;

389 
ecx
 = 
	`ıuid_ecx
(6);

390 ià(
ecx
 & 
CPUID_6_ECX_APERFMPERF_CAPABILITY
) {

391 
pŞicy
->
­”f_m³rf
 = 1;

392 
aıi_ıuäeq_driv”
.
g‘avg
 = 
g‘_m—su»d_³rf
;

395 
—x
 = 
	`ıuid_—x
(6);

396 ià(
—x
 & 0x2) {

397 
pŞicy
->
turbo
 = 
CPUFREQ_TURBO_ENABLED
;

398 ià(
ıuäeq_v”bo£
)

399 
	`´štk
(
XENLOG_INFO
 "CPU%u: Turbo Mode detected‡ndƒnabled\n",

400 
	`smp_´oûssÜ_id
());

402 
	}
}

404 
	$check_äeqs
(cÚ¡ 
ıumask_t
 *
mask
, 
äeq
,

405 
aıi_ıuäeq_d©a
 *
d©a
)

407 
cur_äeq
;

408 
i
;

410 
i
=0; i<100; i++) {

411 
cur_äeq
 = 
	`exŒaù_äeq
(
	`g‘_cur_v®
(
mask
), 
d©a
);

412 ià(
cur_äeq
 =ğ
äeq
)

414 
	`ud–ay
(10);

417 
	}
}

419 
	$aıi_ıuäeq_rg‘
(
ıuäeq_pŞicy
 *
pŞicy
,

420 
rg‘_äeq
, 
»ÏtiÚ
)

422 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

423 
´oûssÜ_³rfÜmªû
 *
³rf
;

424 
ıuäeq_äeqs
 
äeqs
;

425 
ıumask_t
 
Úlše_pŞicy_ıus
;

426 
drv_cmd
 
cmd
;

427 
Ãxt_¡©e
 = 0;

428 
Ãxt_³rf_¡©e
 = 0;

429 
j
;

430 
»suÉ
 = 0;

432 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

433 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

434  -
ENODEV
;

437 ià(
pŞicy
->
turbo
 =ğ
CPUFREQ_TURBO_DISABLED
)

438 ià(
rg‘_äeq
 > 
pŞicy
->
ıušfo
.
£cÚd_max_äeq
)

439 
rg‘_äeq
 = 
pŞicy
->
ıušfo
.
£cÚd_max_äeq
;

441 
³rf
 = 
d©a
->
aıi_d©a
;

442 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_rg‘
(
pŞicy
,

443 
d©a
->
äeq_bË
,

444 
rg‘_äeq
,

445 
»ÏtiÚ
, &
Ãxt_¡©e
);

446 ià(
	`uÆik–y
(
»suÉ
))

447  -
ENODEV
;

449 
	`ıus_ªd
(
Úlše_pŞicy_ıus
, 
ıu_Úlše_m­
, 
pŞicy
->
ıus
);

451 
Ãxt_³rf_¡©e
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
šdex
;

452 ià(
³rf
->
¡©e
 =ğ
Ãxt_³rf_¡©e
) {

453 ià(
	`uÆik–y
(
pŞicy
->
»sume
))

454 
pŞicy
->
»sume
 = 0;

459 
d©a
->
ıu_ã©u»
) {

460 
SYSTEM_INTEL_MSR_CAPABLE
:

461 
cmd
.
ty³
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

462 
cmd
.
addr
.
m¤
.
»g
 = 
MSR_IA32_PERF_CTL
;

463 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

465 
SYSTEM_IO_CAPABLE
:

466 
cmd
.
ty³
 = 
SYSTEM_IO_CAPABLE
;

467 
cmd
.
addr
.
io
.
pÜt
 = 
³rf
->
cÚŒŞ_»gi¡”
.
add»ss
;

468 
cmd
.
addr
.
io
.
b™_width
 = 
³rf
->
cÚŒŞ_»gi¡”
.bit_width;

469 
cmd
.
v®
 = (
u32
è
³rf
->
¡©es
[
Ãxt_³rf_¡©e
].
cÚŒŞ
;

472  -
ENODEV
;

475 ià(
pŞicy
->
sh¬ed_ty³
 !ğ
CPUFREQ_SHARED_TYPE_ANY
)

476 
cmd
.
mask
 = &
Úlše_pŞicy_ıus
;

478 
cmd
.
mask
 = 
	`ıumask_of
(
pŞicy
->
ıu
);

480 
äeqs
.
Şd
 = 
³rf
->
¡©es
[³rf->
¡©e
].
cÜe_äequ’cy
 * 1000;

481 
äeqs
.
Ãw
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
äequ’cy
;

483 
	`drv_wr™e
(&
cmd
);

485 ià(
aıi_p¡©e_¡riù
 && !
	`check_äeqs
(
cmd
.
mask
, 
äeqs
.
Ãw
, 
d©a
)) {

486 
	`´štk
(
KERN_WARNING
 "Fa¿nsã¸tØÃw f»q %d\n", 
äeqs
.
Ãw
);

487  -
EAGAIN
;

490 
	`fÜ_—ch_ıu_mask
(
j
, 
Úlše_pŞicy_ıus
)

491 
	`ıuäeq_¡©i¡ic_upd©e
(
j
, 
³rf
->
¡©e
, 
Ãxt_³rf_¡©e
);

493 
³rf
->
¡©e
 = 
Ãxt_³rf_¡©e
;

494 
pŞicy
->
cur
 = 
äeqs
.
Ãw
;

496  
»suÉ
;

497 
	}
}

499 
	$aıi_ıuäeq_v”ify
(
ıuäeq_pŞicy
 *
pŞicy
)

501 
aıi_ıuäeq_d©a
 *
d©a
;

502 
´oûssÜ_³rfÜmªû
 *
³rf
;

504 ià(!
pŞicy
 || !(
d©a
 = 
drv_d©a
[pŞicy->
ıu
]) ||

505 !
´oûssÜ_pmšfo
[
pŞicy
->
ıu
])

506  -
EINVAL
;

508 
³rf
 = &
´oûssÜ_pmšfo
[
pŞicy
->
ıu
]->perf;

510 
	`ıuäeq_v”ify_w™hš_lim™s
(
pŞicy
, 0,

511 
³rf
->
¡©es
[³rf->
¶©fÜm_lim™
].
cÜe_äequ’cy
 * 1000);

513  
	`ıuäeq_äequ’cy_bË_v”ify
(
pŞicy
, 
d©a
->
äeq_bË
);

514 
	}
}

517 
	$aıi_ıuäeq_guess_äeq
(
aıi_ıuäeq_d©a
 *
d©a
, 
ıu
)

519 
´oûssÜ_³rfÜmªû
 *
³rf
 = 
d©a
->
aıi_d©a
;

521 ià(
ıu_khz
) {

523 
i
;

524 
äeq
;

525 
äeqn
 = 
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

527 
i
=0; i<(
³rf
->
¡©e_couÁ
-1); i++) {

528 
äeq
 = 
äeqn
;

529 
äeqn
 = 
³rf
->
¡©es
[
i
+1].
cÜe_äequ’cy
 * 1000;

530 ià((2 * 
ıu_khz
è> (
äeqn
 + 
äeq
)) {

531 
³rf
->
¡©e
 = 
i
;

532  
äeq
;

535 
³rf
->
¡©e
 =…”f->
¡©e_couÁ
-1;

536  
äeqn
;

539 
³rf
->
¡©e
 = 0;

540  
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

542 
	}
}

545 
	$aıi_ıuäeq_ıu_š™
(
ıuäeq_pŞicy
 *
pŞicy
)

547 
i
;

548 
v®id_¡©es
 = 0;

549 
ıu
 = 
pŞicy
->cpu;

550 
aıi_ıuäeq_d©a
 *
d©a
;

551 
»suÉ
 = 0;

552 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
pŞicy
->
ıu
];

553 
´oûssÜ_³rfÜmªû
 *
³rf
;

555 
d©a
 = 
	`xm®loc
(
aıi_ıuäeq_d©a
);

556 ià(!
d©a
)

557  -
ENOMEM
;

558 
	`mem£t
(
d©a
, 0, (
aıi_ıuäeq_d©a
));

560 
drv_d©a
[
ıu
] = 
d©a
;

562 
d©a
->
aıi_d©a
 = &
´oûssÜ_pmšfo
[
ıu
]->
³rf
;

564 
³rf
 = 
d©a
->
aıi_d©a
;

565 
pŞicy
->
sh¬ed_ty³
 = 
³rf
->shared_type;

567 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

568 
ACPI_ADR_SPACE_SYSTEM_IO
:

569 ià(
ıuäeq_v”bo£
)

570 
	`´štk
("xen_pminfo: @acpi_cpufreq_cpu_init,"

572 
d©a
->
ıu_ã©u»
 = 
SYSTEM_IO_CAPABLE
;

574 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

575 ià(
ıuäeq_v”bo£
)

576 
	`´štk
("xen_pminfo: @acpi_cpufreq_cpu_init,"

578 ià(!
	`check_e¡_ıu
(
ıu
)) {

579 
»suÉ
 = -
ENODEV
;

580 
”r_uÄeg
;

582 
d©a
->
ıu_ã©u»
 = 
SYSTEM_INTEL_MSR_CAPABLE
;

585 
»suÉ
 = -
ENODEV
;

586 
”r_uÄeg
;

589 
d©a
->
äeq_bË
 = 
	`xm®loc_¬¿y
(
ıuäeq_äequ’cy_bË
,

590 (
³rf
->
¡©e_couÁ
+1));

591 ià(!
d©a
->
äeq_bË
) {

592 
»suÉ
 = -
ENOMEM
;

593 
”r_uÄeg
;

597 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = 0;

598 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

599 ià((
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000) >

600 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
)

601 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 =

602 
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000;

605 
pŞicy
->
gov”nÜ
 = 
ıuäeq_İt_gov”nÜ
 ? : 
CPUFREQ_DEFAULT_GOVERNOR
;

608 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

609 ià(
i
>0 && 
³rf
->
¡©es
[i].
cÜe_äequ’cy
 >=

610 
d©a
->
äeq_bË
[
v®id_¡©es
-1].
äequ’cy
 / 1000)

613 
d©a
->
äeq_bË
[
v®id_¡©es
].
šdex
 = 
i
;

614 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 =

615 
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
 * 1000;

616 
v®id_¡©es
++;

618 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

619 
³rf
->
¡©e
 = 0;

621 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_ıušfo
(
pŞicy
, 
d©a
->
äeq_bË
);

622 ià(
»suÉ
)

623 
”r_äeqä“
;

625 
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
) {

626 
ACPI_ADR_SPACE_SYSTEM_IO
:

628 
pŞicy
->
cur
 = 
	`aıi_ıuäeq_guess_äeq
(
d©a
,…Şicy->
ıu
);

630 
ACPI_ADR_SPACE_FIXED_HARDWARE
:

631 
aıi_ıuäeq_driv”
.
g‘
 = 
g‘_cur_äeq_Ú_ıu
;

632 
pŞicy
->
cur
 = 
	`g‘_cur_äeq_Ú_ıu
(
ıu
);

640 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 && c->
ıuid_Ëv–
 >= 6)

641 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
), 
ã©u»_d‘eù
, 
pŞicy
, 1);

647 
pŞicy
->
»sume
 = 1;

649  
»suÉ
;

651 
”r_äeqä“
:

652 
	`xä“
(
d©a
->
äeq_bË
);

653 
”r_uÄeg
:

654 
	`xä“
(
d©a
);

655 
drv_d©a
[
ıu
] = 
NULL
;

657  
»suÉ
;

658 
	}
}

660 
	$aıi_ıuäeq_ıu_ex™
(
ıuäeq_pŞicy
 *
pŞicy
)

662 
aıi_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

664 ià(
d©a
) {

665 
drv_d©a
[
pŞicy
->
ıu
] = 
NULL
;

666 
	`xä“
(
d©a
->
äeq_bË
);

667 
	`xä“
(
d©a
);

671 
	}
}

673 
ıuäeq_driv”
 
	gaıi_ıuäeq_driv”
 = {

674 .
Çme
 = "acpi-cpufreq",

675 .
	gv”ify
 = 
aıi_ıuäeq_v”ify
,

676 .
	grg‘
 = 
aıi_ıuäeq_rg‘
,

677 .
	gš™
 = 
aıi_ıuäeq_ıu_š™
,

678 .
	gex™
 = 
aıi_ıuäeq_ıu_ex™
,

681 
__š™
 
	$ıuäeq_driv”_š™
()

683 
»t
 = 0;

685 ià((
ıuäeq_cÚŒŞËr
 =ğ
FREQCTL_x’
) &&

686 (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
))

687 
»t
 = 
	`ıuäeq_»gi¡”_driv”
(&
aıi_ıuäeq_driv”
);

688 ià((
ıuäeq_cÚŒŞËr
 =ğ
FREQCTL_x’
) &&

689 (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
))

690 
»t
 = 
	`pow”now_»gi¡”_driv”
();

692  
»t
;

693 
	}
}

694 
__š™ÿÎ
(
ıuäeq_driv”_š™
);

696 
	$ıuäeq_ıu_š™
(
ıuid
)

698 
ıu_couÁ
=0;

699 
»t
;

701 
ıu_couÁ
++;

704 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

705 
»t
 = 
	`ıuäeq_add_ıu
(
ıuid
);

706 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 )

707 
»t
 = 
	`ıuäeq_add_ıu
(
ıuid
);

709 
»t
 = -
EFAULT
;

710  
»t
;

711 
	}
}

	@acpi/cpufreq/powernow.c

25 
	~<x’/ty³s.h
>

26 
	~<x’/”ºo.h
>

27 
	~<x’/d–ay.h
>

28 
	~<x’/ıumask.h
>

29 
	~<x’/tim”.h
>

30 
	~<x’/xm®loc.h
>

31 
	~<asm/bug.h
>

32 
	~<asm/m¤.h
>

33 
	~<asm/io.h
>

34 
	~<asm/cÚfig.h
>

35 
	~<asm/´oûssÜ.h
>

36 
	~<asm/³rıu.h
>

37 
	~<asm/ıuã©u».h
>

38 
	~<aıi/aıi.h
>

39 
	~<aıi/ıuäeq/ıuäeq.h
>

41 
	#CPUID_6_ECX_APERFMPERF_CAPABILITY
 (0x1)

	)

42 
	#CPUID_FREQ_VOLT_CAPABILITIES
 0x80000007

	)

43 
	#CPB_CAPABLE
 0x00000200

	)

44 
	#USE_HW_PSTATE
 0x00000080

	)

45 
	#HW_PSTATE_MASK
 0x00000007

	)

46 
	#HW_PSTATE_VALID_MASK
 0x80000000

	)

47 
	#HW_PSTATE_MAX_MASK
 0x000000f0

	)

48 
	#HW_PSTATE_MAX_SHIFT
 4

	)

49 
	#MSR_PSTATE_DEF_BASE
 0xc0010064

	)

50 
	#MSR_PSTATE_STATUS
 0xc0010063

	)

51 
	#MSR_PSTATE_CTRL
 0xc0010062

	)

52 
	#MSR_PSTATE_CUR_LIMIT
 0xc0010061

	)

53 
	#MSR_HWCR_CPBDIS_MASK
 0x02000000ULL

	)

55 
	spow”now_ıuäeq_d©a
 {

56 
´oûssÜ_³rfÜmªû
 *
	maıi_d©a
;

57 
ıuäeq_äequ’cy_bË
 *
	mäeq_bË
;

58 
	mmax_äeq
;

59 
	m»sume
;

60 
	mıu_ã©u»
;

63 
pow”now_ıuäeq_d©a
 *
	gdrv_d©a
[
NR_CPUS
];

65 
ıuäeq_driv”
 
	gpow”now_ıuäeq_driv”
;

67 
	sdrv_cmd
 {

68 
	mty³
;

69 cÚ¡ 
ıumask_t
 *
	mmask
;

70 
u32
 
	mv®
;

71 
	mturbo
;

74 
	$Œªs™iÚ_p¡©e
(*
drvcmd
)

76 
drv_cmd
 *
cmd
;

77 
cmd
 = (
drv_cmd
 *è
drvcmd
;

79 ià(
cmd
->
turbo
 !ğ
CPUFREQ_TURBO_UNSUPPORTED
) {

80 
ušt64_t
 
m¤_cÚ‹Á
;

81 
	`rdm¤l
(
MSR_K8_HWCR
, 
m¤_cÚ‹Á
);

82 ià(
cmd
->
turbo
 =ğ
CPUFREQ_TURBO_ENABLED
)

83 
m¤_cÚ‹Á
 &ğ~
MSR_HWCR_CPBDIS_MASK
;

85 
m¤_cÚ‹Á
 |ğ
MSR_HWCR_CPBDIS_MASK
;

86 
	`wrm¤l
(
MSR_K8_HWCR
, 
m¤_cÚ‹Á
);

88 
	`wrm¤l
(
MSR_PSTATE_CTRL
, 
cmd
->
v®
);

89 
	}
}

91 
	$pow”now_ıuäeq_rg‘
(
ıuäeq_pŞicy
 *
pŞicy
,

92 
rg‘_äeq
, 
»ÏtiÚ
)

94 
pow”now_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

95 
´oûssÜ_³rfÜmªû
 *
³rf
;

96 
ıuäeq_äeqs
 
äeqs
;

97 
ıumask_t
 
Úlše_pŞicy_ıus
;

98 
drv_cmd
 
cmd
;

99 
Ãxt_¡©e
 = 0;

100 
Ãxt_³rf_¡©e
 = 0;

101 
»suÉ
 = 0;

102 
j
 = 0;

104 ià(
	`uÆik–y
(
d©a
 =ğ
NULL
 ||

105 
d©a
->
aıi_d©a
 =ğ
NULL
 || d©a->
äeq_bË
 == NULL)) {

106  -
ENODEV
;

109 
³rf
 = 
d©a
->
aıi_d©a
;

110 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_rg‘
(
pŞicy
,

111 
d©a
->
äeq_bË
,

112 
rg‘_äeq
,

113 
»ÏtiÚ
, &
Ãxt_¡©e
);

114 ià(
	`uÆik–y
(
»suÉ
))

115  -
ENODEV
;

117 
Úlše_pŞicy_ıus
 = 
pŞicy
->
ıus
;

119 
Ãxt_³rf_¡©e
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
šdex
;

120 ià(
³rf
->
¡©e
 =ğ
Ãxt_³rf_¡©e
) {

121 ià(
	`uÆik–y
(
d©a
->
»sume
))

122 
d©a
->
»sume
 = 0;

127 ià(
pŞicy
->
sh¬ed_ty³
 !ğ
CPUFREQ_SHARED_TYPE_ANY
)

128 
cmd
.
mask
 = &
Úlše_pŞicy_ıus
;

130 
cmd
.
mask
 = 
	`ıumask_of
(
pŞicy
->
ıu
);

132 
äeqs
.
Şd
 = 
³rf
->
¡©es
[³rf->
¡©e
].
cÜe_äequ’cy
 * 1000;

133 
äeqs
.
Ãw
 = 
d©a
->
äeq_bË
[
Ãxt_¡©e
].
äequ’cy
;

135 
cmd
.
v®
 = 
Ãxt_³rf_¡©e
;

136 
cmd
.
turbo
 = 
pŞicy
->turbo;

138 
	`Ú_£Ëùed_ıus
(
cmd
.
mask
, 
Œªs™iÚ_p¡©e
, &cmd, 1);

140 
	`fÜ_—ch_ıu_mask
(
j
, 
Úlše_pŞicy_ıus
)

141 
	`ıuäeq_¡©i¡ic_upd©e
(
j
, 
³rf
->
¡©e
, 
Ãxt_³rf_¡©e
);

143 
³rf
->
¡©e
 = 
Ãxt_³rf_¡©e
;

144 
pŞicy
->
cur
 = 
äeqs
.
Ãw
;

146  
»suÉ
;

147 
	}
}

149 
	$pow”now_ıuäeq_v”ify
(
ıuäeq_pŞicy
 *
pŞicy
)

151 
pow”now_ıuäeq_d©a
 *
d©a
;

152 
´oûssÜ_³rfÜmªû
 *
³rf
;

154 ià(!
pŞicy
 || !(
d©a
 = 
drv_d©a
[pŞicy->
ıu
]) ||

155 !
´oûssÜ_pmšfo
[
pŞicy
->
ıu
])

156  -
EINVAL
;

158 
³rf
 = &
´oûssÜ_pmšfo
[
pŞicy
->
ıu
]->perf;

160 
	`ıuäeq_v”ify_w™hš_lim™s
(
pŞicy
, 0,

161 
³rf
->
¡©es
[³rf->
¶©fÜm_lim™
].
cÜe_äequ’cy
 * 1000);

163  
	`ıuäeq_äequ’cy_bË_v”ify
(
pŞicy
, 
d©a
->
äeq_bË
);

164 
	}
}

166 
	$ã©u»_d‘eù
(*
šfo
)

168 
ıuäeq_pŞicy
 *
pŞicy
 = 
šfo
;

169 
ecx
, 
edx
;

171 
ecx
 = 
	`ıuid_ecx
(6);

172 ià(
ecx
 & 
CPUID_6_ECX_APERFMPERF_CAPABILITY
) {

173 
pŞicy
->
­”f_m³rf
 = 1;

174 
pow”now_ıuäeq_driv”
.
g‘avg
 = 
g‘_m—su»d_³rf
;

177 
edx
 = 
	`ıuid_edx
(
CPUID_FREQ_VOLT_CAPABILITIES
);

178 ià((
edx
 & 
CPB_CAPABLE
) == CPB_CAPABLE) {

179 
pŞicy
->
turbo
 = 
CPUFREQ_TURBO_ENABLED
;

180 ià(
ıuäeq_v”bo£
)

181 
	`´štk
(
XENLOG_INFO


183 
	`smp_´oûssÜ_id
());

185 
	}
}

187 
	$pow”now_ıuäeq_ıu_š™
(
ıuäeq_pŞicy
 *
pŞicy
)

189 
i
;

190 
v®id_¡©es
 = 0;

191 
ıu
 = 
pŞicy
->cpu;

192 
pow”now_ıuäeq_d©a
 *
d©a
;

193 
»suÉ
 = 0;

194 
´oûssÜ_³rfÜmªû
 *
³rf
;

195 
u32
 
max_hw_p¡©e
;

196 
ušt64_t
 
m¤_cÚ‹Á
;

197 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
pŞicy
->
ıu
];

199 
d©a
 = 
	`xm®loc
(
pow”now_ıuäeq_d©a
);

200 ià(!
d©a
)

201  -
ENOMEM
;

202 
	`mem£t
(
d©a
, 0, (
pow”now_ıuäeq_d©a
));

204 
drv_d©a
[
ıu
] = 
d©a
;

206 
d©a
->
aıi_d©a
 = &
´oûssÜ_pmšfo
[
ıu
]->
³rf
;

208 
³rf
 = 
d©a
->
aıi_d©a
;

209 
pŞicy
->
sh¬ed_ty³
 = 
³rf
->shared_type;

215 ià(
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ALL
 ||

216 
pŞicy
->
sh¬ed_ty³
 =ğ
CPUFREQ_SHARED_TYPE_ANY
) {

217 
pŞicy
->
ıus
 = 
³rf
->
sh¬ed_ıu_m­
;

219 
pŞicy
->
ıus
 = 
	`ıumask_of_ıu
(
ıu
);

223 ià(
³rf
->
¡©e_couÁ
 <= 1) {

224 
	`´štk
("No P-States\n");

225 
»suÉ
 = -
ENODEV
;

226 
”r_uÄeg
;

228 
	`rdm¤l
(
MSR_PSTATE_CUR_LIMIT
, 
m¤_cÚ‹Á
);

229 
max_hw_p¡©e
 = (
m¤_cÚ‹Á
 & 
HW_PSTATE_MAX_MASK
è>> 
HW_PSTATE_MAX_SHIFT
;

231 ià(
³rf
->
cÚŒŞ_»gi¡”
.
¥aû_id
 !ğ³rf->
¡©us_»gi¡”
.space_id) {

232 
»suÉ
 = -
ENODEV
;

233 
”r_uÄeg
;

236 
d©a
->
äeq_bË
 = 
	`xm®loc_¬¿y
(
ıuäeq_äequ’cy_bË
,

237 (
³rf
->
¡©e_couÁ
+1));

238 ià(!
d©a
->
äeq_bË
) {

239 
»suÉ
 = -
ENOMEM
;

240 
”r_uÄeg
;

244 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 = 0;

245 
i
=0; i<
³rf
->
¡©e_couÁ
; i++) {

246 ià((
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000) >

247 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
)

248 
pŞicy
->
ıušfo
.
Œªs™iÚ_Ï‹ncy
 =

249 
³rf
->
¡©es
[
i
].
Œªs™iÚ_Ï‹ncy
 * 1000;

252 
pŞicy
->
gov”nÜ
 = 
ıuäeq_İt_gov”nÜ
 ? : 
CPUFREQ_DEFAULT_GOVERNOR
;

254 
d©a
->
max_äeq
 = 
³rf
->
¡©es
[0].
cÜe_äequ’cy
 * 1000;

256 
i
 = 0; i < 
³rf
->
¡©e_couÁ
 && i <ğ
max_hw_p¡©e
; i++) {

257 ià(
i
 > 0 && 
³rf
->
¡©es
[i].
cÜe_äequ’cy
 >=

258 
d©a
->
äeq_bË
[
v®id_¡©es
-1].
äequ’cy
 / 1000)

261 
d©a
->
äeq_bË
[
v®id_¡©es
].
šdex
 = 
³rf
->
¡©es
[
i
].
cÚŒŞ
 & 
HW_PSTATE_MASK
;

262 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 =

263 
³rf
->
¡©es
[
i
].
cÜe_äequ’cy
 * 1000;

264 
v®id_¡©es
++;

266 
d©a
->
äeq_bË
[
v®id_¡©es
].
äequ’cy
 = 
CPUFREQ_TABLE_END
;

267 
³rf
->
¡©e
 = 0;

269 
»suÉ
 = 
	`ıuäeq_äequ’cy_bË_ıušfo
(
pŞicy
, 
d©a
->
äeq_bË
);

270 ià(
»suÉ
)

271 
”r_äeqä“
;

273 ià(
c
->
ıuid_Ëv–
 >= 6)

274 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
), 
ã©u»_d‘eù
, 
pŞicy
, 1);

280 
d©a
->
»sume
 = 1;

282 
pŞicy
->
cur
 = 
d©a
->
äeq_bË
[
i
].
äequ’cy
;

283  
»suÉ
;

285 
”r_äeqä“
:

286 
	`xä“
(
d©a
->
äeq_bË
);

287 
”r_uÄeg
:

288 
	`xä“
(
d©a
);

289 
drv_d©a
[
ıu
] = 
NULL
;

291  
»suÉ
;

292 
	}
}

294 
	$pow”now_ıuäeq_ıu_ex™
(
ıuäeq_pŞicy
 *
pŞicy
)

296 
pow”now_ıuäeq_d©a
 *
d©a
 = 
drv_d©a
[
pŞicy
->
ıu
];

298 ià(
d©a
) {

299 
drv_d©a
[
pŞicy
->
ıu
] = 
NULL
;

300 
	`xä“
(
d©a
->
äeq_bË
);

301 
	`xä“
(
d©a
);

305 
	}
}

307 
ıuäeq_driv”
 
	gpow”now_ıuäeq_driv”
 = {

308 .
v”ify
 = 
pow”now_ıuäeq_v”ify
,

309 .
	grg‘
 = 
pow”now_ıuäeq_rg‘
,

310 .
	gš™
 = 
pow”now_ıuäeq_ıu_š™
,

311 .
	gex™
 = 
pow”now_ıuäeq_ıu_ex™


314 
	$pow”now_»gi¡”_driv”
()

316 
i
, 
»t
 = 0;

318 
	`fÜ_—ch_Úlše_ıu
(
i
) {

319 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
i
];

320 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

321 
»t
 = -
ENODEV
;

324 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

325 
	`ıuid
(
CPUID_FREQ_VOLT_CAPABILITIES
, &
—x
, &
ebx
, &
ecx
, &
edx
);

326 ià((
edx
 & 
USE_HW_PSTATE
) != USE_HW_PSTATE)

327 
»t
 = -
ENODEV
;

329 ià(
»t
)

330  
»t
;

333 
»t
 = 
	`ıuäeq_»gi¡”_driv”
(&
pow”now_ıuäeq_driv”
);

334  
»t
;

335 
	}
}

	@acpi/cpuidle_menu.c

26 
	~<x’/cÚfig.h
>

27 
	~<x’/”ºo.h
>

28 
	~<x’/lib.h
>

29 
	~<x’/ty³s.h
>

30 
	~<x’/aıi.h
>

31 
	~<x’/tim”.h
>

32 
	~<x’/ıuidË.h
>

33 
	~<asm/œq.h
>

35 
	#BUCKETS
 6

	)

36 
	#RESOLUTION
 1024

	)

37 
	#DECAY
 4

	)

38 
	#MAX_INTERESTING
 50000

	)

93 
	s³rf_çùÜ
{

94 
s_time_t
 
	mtime_¡amp
;

95 
s_time_t
 
	mdu¿tiÚ
;

96 
	mœq_couÁ_¡amp
;

97 
	mœq_sum
;

100 
	sm’u_deviû


102 
	mÏ¡_¡©e_idx
;

103 
	mex³ùed_us
;

104 
u64
 
	m´ediùed_us
;

105 
	mm—su»d_us
;

106 
	mex™_us
;

107 
	mbuck‘
;

108 
u64
 
	mcÜ»ùiÚ_çùÜ
[
BUCKETS
];

109 
³rf_çùÜ
 
	mpf
;

112 
DEFINE_PER_CPU
(
m’u_deviû
, 
m’u_deviûs
);

114 
šlše
 
	$which_buck‘
(
du¿tiÚ
)

116 
buck‘
 = 0;

118 ià(
du¿tiÚ
 < 10)

119  
buck‘
;

120 ià(
du¿tiÚ
 < 100)

121  
buck‘
 + 1;

122 ià(
du¿tiÚ
 < 1000)

123  
buck‘
 + 2;

124 ià(
du¿tiÚ
 < 10000)

125  
buck‘
 + 3;

126 ià(
du¿tiÚ
 < 100000)

127  
buck‘
 + 4;

128  
buck‘
 + 5;

129 
	}
}

139 
	#SAMPLING_PERIOD
 5000000

	)

142 
	#IO_MULTIPLIER
 8

	)

144 
šlše
 
s_time_t
 
	$avg_šŒ_š‹rv®_us
()

146 
m’u_deviû
 *
d©a
 = &
	`__g‘_ıu_v¬
(
m’u_deviûs
);

147 
s_time_t
 
du¿tiÚ
, 
now
;

148 
s_time_t
 
avg_š‹rv®
;

149 
œq_sum
;

151 
now
 = 
	`NOW
();

152 
du¿tiÚ
 = (
d©a
->
pf
.du¿tiÚ + (
now
 - d©a->pf.
time_¡amp
)

153 * (
DECAY
 - 1)) / DECAY;

155 
œq_sum
 = (
d©a
->
pf
.œq_sum + (
	`this_ıu
(
œq_couÁ
è- d©a->pf.
œq_couÁ_¡amp
)

156 * (
DECAY
 - 1)) / DECAY;

158 ià(
œq_sum
 == 0)

160 
avg_š‹rv®
 = 1000000;

162 
avg_š‹rv®
 = 
du¿tiÚ
 / 
œq_sum
 / 1000;

164 iàĞ
du¿tiÚ
 >ğ
SAMPLING_PERIOD
){

165 
d©a
->
pf
.
time_¡amp
 = 
now
;

166 
d©a
->
pf
.
du¿tiÚ
 = duration;

167 
d©a
->
pf
.
œq_couÁ_¡amp
ğ
	`this_ıu
(
œq_couÁ
);

168 
d©a
->
pf
.
œq_sum
 = irq_sum;

171  
avg_š‹rv®
;

172 
	}
}

174 
	$g‘_¦“p_Ëngth_us
()

176 
s_time_t
 
us
 = (
	`this_ıu
(
tim”_d—dlše
è- 
	`NOW
()) / 1000;

182  (
us
 >> 32) ? ()-2000 : ()us;

183 
	}
}

185 
	$m’u_£Ëù
(
aıi_´oûssÜ_pow”
 *
pow”
)

187 
m’u_deviû
 *
d©a
 = &
	`__g‘_ıu_v¬
(
m’u_deviûs
);

188 
i
;

189 
s_time_t
 
io_š‹rv®
;

192 
d©a
->
Ï¡_¡©e_idx
 = 
CPUIDLE_DRIVER_STATE_START
;

193 
d©a
->
ex™_us
 = 0;

196 
d©a
->
ex³ùed_us
 = 
	`g‘_¦“p_Ëngth_us
();

198 
d©a
->
buck‘
 = 
	`which_buck‘
(d©a->
ex³ùed_us
);

200 
io_š‹rv®
 = 
	`avg_šŒ_š‹rv®_us
();

206 ià(
d©a
->
cÜ»ùiÚ_çùÜ
[d©a->
buck‘
] == 0)

207 
d©a
->
cÜ»ùiÚ_çùÜ
[d©a->
buck‘
] = 
RESOLUTION
 * 
DECAY
;

210 
d©a
->
´ediùed_us
 = 
	`DIV_ROUND
(

211 
d©a
->
ex³ùed_us
 * d©a->
cÜ»ùiÚ_çùÜ
[d©a->
buck‘
],

212 
RESOLUTION
 * 
DECAY
);

215  
i
 = 
CPUIDLE_DRIVER_STATE_START
 + 1; i < 
pow”
->
couÁ
; i++ )

217 
aıi_´oûssÜ_cx
 *
s
 = &
pow”
->
¡©es
[
i
];

219 ià(
s
->
rg‘_»sid’cy
 > 
d©a
->
´ediùed_us
)

221 ià(
s
->
Ï‹ncy
 * 
IO_MULTIPLIER
 > 
io_š‹rv®
)

224 
d©a
->
ex™_us
 = 
s
->
Ï‹ncy
;

225 
d©a
->
Ï¡_¡©e_idx
 = 
i
;

228  
d©a
->
Ï¡_¡©e_idx
;

229 
	}
}

231 
	$m’u_»æeù
(
aıi_´oûssÜ_pow”
 *
pow”
)

233 
m’u_deviû
 *
d©a
 = &
	`__g‘_ıu_v¬
(
m’u_deviûs
);

234 
Ï¡_idË_us
 = 
pow”
->
Ï¡_»sid’cy
;

235 
m—su»d_us
;

236 
u64
 
Ãw_çùÜ
;

238 
m—su»d_us
 = 
Ï¡_idË_us
;

244 ià(
m—su»d_us
 > 
d©a
->
ex™_us
)

245 
m—su»d_us
 -ğ
d©a
->
ex™_us
;

249 
Ãw_çùÜ
 = 
d©a
->
cÜ»ùiÚ_çùÜ
[d©a->
buck‘
]

250 * (
DECAY
 - 1) / DECAY;

252 ià(
d©a
->
ex³ùed_us
 > 0 && d©a->
m—su»d_us
 < 
MAX_INTERESTING
)

253 
Ãw_çùÜ
 +ğ
RESOLUTION
 * 
m—su»d_us
 / 
d©a
->
ex³ùed_us
;

259 
Ãw_çùÜ
 +ğ
RESOLUTION
;

265 ià(
Ãw_çùÜ
 == 0)

266 
Ãw_çùÜ
 = 1;

268 
d©a
->
cÜ»ùiÚ_çùÜ
[d©a->
buck‘
] = 
Ãw_çùÜ
;

269 
	}
}

271 
	$m’u_’abË_deviû
(
aıi_´oûssÜ_pow”
 *
pow”
)

273 ià(!
	`ıu_Úlše
(
pow”
->
ıu
))

276 
	`mem£t
(&
	`³r_ıu
(
m’u_deviûs
, 
pow”
->
ıu
), 0, (
m’u_deviû
));

279 
	}
}

281 
ıuidË_gov”nÜ
 
	gm’u_gov”nÜ
 =

283 .
Çme
 = "menu",

284 .
	g¿tšg
 = 20,

285 .
	g’abË
 = 
m’u_’abË_deviû
,

286 .
	g£Ëù
 = 
m’u_£Ëù
,

287 .
	g»æeù
 = 
m’u_»æeù
,

290 
ıuidË_gov”nÜ
 *
	gıuidË_cu¼’t_gov”nÜ
 = &
m’u_gov”nÜ
;

291 
	$m’u_g‘_Œaû_d©a
(
u32
 *
ex³ùed
, u32 *
´ed
)

293 
m’u_deviû
 *
d©a
 = &
	`__g‘_ıu_v¬
(
m’u_deviûs
);

294 *
ex³ùed
 = 
d©a
->
ex³ùed_us
;

295 *
´ed
 = 
d©a
->
´ediùed_us
;

296 
	}
}

	@acpi/power.c

13 
	~<x’/cÚfig.h
>

14 
	~<asm/io.h
>

15 
	~<x’/aıi.h
>

16 
	~<x’/”ºo.h
>

17 
	~<x’/ioÿp.h
>

18 
	~<x’/sched.h
>

19 
	~<asm/aıi.h
>

20 
	~<asm/œq.h
>

21 
	~<asm/š™.h
>

22 
	~<x’/¥šlock.h
>

23 
	~<x’/sched.h
>

24 
	~<x’/domaš.h
>

25 
	~<x’/cÚsŞe.h
>

26 
	~<x’/iommu.h
>

27 
	~<x’/ıu.h
>

28 
	~<public/¶©fÜm.h
>

29 
	~<asm/tboÙ.h
>

30 
	~<asm/­ic.h
>

31 
	~<asm/io_­ic.h
>

32 
	~<aıi/ıuäeq/ıuäeq.h
>

34 
ušt32_t
 
	gsy¡em_»£t_couÁ”
 = 1;

36 
__š™d©a
 
	gİt_aıi_¦“p
[20];

37 
¡ršg_·¿m
("aıi_¦“p", 
İt_aıi_¦“p
);

39 
u8
 
	g¦“p_¡©es
[
ACPI_S_STATE_COUNT
];

40 
DEFINE_SPINLOCK
(
pm_lock
);

42 
aıi_¦“p_šfo
 
	gaıi_sšfo
;

44 
do_su¥’d_lowËv–
();

46 
	$deviû_pow”_down
()

48 
	`cÚsŞe_su¥’d
();

50 
	`time_su¥’d
();

52 
	`i8259A_su¥’d
();

54 
	`ißpic_su¥’d
();

56 
	`iommu_su¥’d
();

58 
	`Ïpic_su¥’d
();

61 
	}
}

63 
	$deviû_pow”_up
()

65 
	`Ïpic_»sume
();

67 
	`iommu_»sume
();

69 
	`ißpic_»sume
();

71 
	`i8259A_»sume
();

73 
	`time_»sume
();

75 
	`cÚsŞe_»sume
();

76 
	}
}

78 
	$ä“ze_domašs
()

80 
domaš
 *
d
;

82 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

88 
	`fÜ_—ch_domaš
 ( 
d
 )

89 
	`domaš_·u£
(
d
);

90 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

91 
	}
}

93 
	$thaw_domašs
()

95 
domaš
 *
d
;

97 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

98 
	`fÜ_—ch_domaš
 ( 
d
 )

99 
	`domaš_uÅau£
(
d
);

100 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

101 
	}
}

103 
	$aıi_¦“p_´•¬e
(
u32
 
¡©e
)

105 *
wakeup_veùÜ_va
;

107 iàĞ
¡©e
 !ğ
ACPI_STATE_S3
 )

110 
wakeup_veùÜ_va
 = 
	`__aıi_m­_bË
(

111 
aıi_sšfo
.
wakeup_veùÜ
, (
ušt64_t
));

114 iàĞ
	`tboÙ_š_m—su»d_’v
() )

117 iàĞ
aıi_sšfo
.
veùÜ_width
 == 32 )

118 *(
ušt32_t
 *)
wakeup_veùÜ_va
 = 
	`boÙsym_phys
(
wakeup_¡¬t
);

120 *(
ušt64_t
 *)
wakeup_veùÜ_va
 = 
	`boÙsym_phys
(
wakeup_¡¬t
);

121 
	}
}

123 
	$aıi_¦“p_po¡
(
u32
 
¡©e
è{
	}
}

126 
	$’‹r_¡©e
(
u32
 
¡©e
)

128 
æags
;

129 
”rÜ
;

130 
ü4
;

132 iàĞ(
¡©e
 <ğ
ACPI_STATE_S0
è|| (¡©> 
ACPI_S_STATES_MAX
) )

133  -
EINVAL
;

135 iàĞ!
	`¥š_Œylock
(&
pm_lock
) )

136  -
EBUSY
;

138 
	`´štk
(
XENLOG_INFO
 "P»·ršg sy¡em fÜ ACPI S%d s‹.\n", 
¡©e
);

140 
	`ä“ze_domašs
();

142 
	`aıi_dm¬_»š¡©e
();

144 iàĞ(
”rÜ
 = 
	`di§bË_nÚboÙ_ıus
()) )

145 
’abË_ıu
;

147 
	`ıuäeq_d–_ıu
(0);

149 
	`hvm_ıu_down
();

151 
	`aıi_¦“p_´•¬e
(
¡©e
);

153 
	`cÚsŞe_¡¬t_sync
();

154 
	`´štk
("EÁ”šg ACPI S%d s‹.\n", 
¡©e
);

156 
	`loÿl_œq_§ve
(
æags
);

157 
	`¥š_debug_di§bË
();

159 iàĞ(
”rÜ
 = 
	`deviû_pow”_down
()) )

161 
	`´štk
(
XENLOG_ERR
 "Some devices failedo…ower down.");

162 
dÚe
;

165 
	`ACPI_FLUSH_CPU_CACHE
();

167  
¡©e
 )

169 
ACPI_STATE_S3
:

170 
	`do_su¥’d_lowËv–
();

171 
sy¡em_»£t_couÁ”
++;

172 
”rÜ
 = 
	`tboÙ_s3_»sume
();

174 
ACPI_STATE_S5
:

175 
	`aıi_’‹r_¦“p_¡©e
(
ACPI_STATE_S5
);

178 
”rÜ
 = -
EINVAL
;

183 
ü4
 = 
	`»ad_ü4
();

184 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_MCE
);

185 iàĞ
ıu_has_eãr
 )

186 
	`wr™e_eãr
(
	`»ad_eãr
());

188 
	`deviû_pow”_up
();

190 
	`mcheck_š™
(&
boÙ_ıu_d©a
, 0);

191 
	`wr™e_ü4
(
ü4
);

193 
	`´štk
(
XENLOG_INFO
 "Fšishšg wakeu°äom ACPI S%d s‹.\n", 
¡©e
);

195 iàĞ(
¡©e
 =ğ
ACPI_STATE_S3
è&& 
”rÜ
 )

196 
	`·nic
("MemÜy iÁegr™y wa lo¡ oÀ»sum(%d)\n", 
”rÜ
);

198 
dÚe
:

199 
	`¥š_debug_’abË
();

200 
	`loÿl_œq_»¡Üe
(
æags
);

201 
	`cÚsŞe_’d_sync
();

202 
	`aıi_¦“p_po¡
(
¡©e
);

203 iàĞ
	`hvm_ıu_up
() )

204 
	`BUG
();

206 
’abË_ıu
:

207 
	`ıuäeq_add_ıu
(0);

208 
	`miüocode_»sume_ıu
(0);

209 
	`rcu_b¬r›r
();

210 
	`mŒr_­s_sync_begš
();

211 
	`’abË_nÚboÙ_ıus
();

212 
	`mŒr_­s_sync_’d
();

213 
	`aıi_dm¬_z­
();

214 
	`thaw_domašs
();

215 
	`¥š_uÆock
(&
pm_lock
);

216  
”rÜ
;

217 
	}
}

219 
	$’‹r_¡©e_h–³r
(*
d©a
)

221 
aıi_¦“p_šfo
 *
sšfo
 = (aıi_¦“p_šfØ*)
d©a
;

222  
	`’‹r_¡©e
(
sšfo
->
¦“p_¡©e
);

223 
	}
}

229 
	$aıi_’‹r_¦“p
(
x’pf_’‹r_aıi_¦“p
 *
¦“p
)

231 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
è|| !
aıi_sšfo
.
pm1a_út_blk
.
add»ss
 )

232  -
EPERM
;

235 iàĞ
aıi_sšfo
.
pm1b_út_v®
 &&

236 ((
¦“p
->
pm1a_út_v®
 ^ sË•->
pm1b_út_v®
) &

237 
ACPI_BITMASK_SLEEP_ENABLE
) )

239 
	`gd´štk
(
XENLOG_ERR
, "Mismatched…m1a/pm1b setting.");

240  -
EINVAL
;

243 iàĞ
¦“p
->
æags
 )

244  -
EINVAL
;

246 
aıi_sšfo
.
pm1a_út_v®
 = 
¦“p
->pm1a_cnt_val;

247 
aıi_sšfo
.
pm1b_út_v®
 = 
¦“p
->pm1b_cnt_val;

248 
aıi_sšfo
.
¦“p_¡©e
 = 
¦“p
->sleep_state;

250  
	`cÚtšue_hy³rÿÎ_Ú_ıu
(0, 
’‹r_¡©e_h–³r
, &
aıi_sšfo
);

251 
	}
}

253 
	$aıi_g‘_wake_¡©us
()

255 
ušt32_t
 
v®
;

256 
aıi_¡©us
 
¡©us
;

259 
¡©us
 = 
	`aıi_hw_»gi¡”_»ad
(
ACPI_REGISTER_PM1_STATUS
, &
v®
);

260 iàĞ
	`ACPI_FAILURE
(
¡©us
) )

263 
v®
 &ğ
ACPI_BITMASK_WAKE_STATUS
;

264 
v®
 >>ğ
ACPI_BITPOSITION_WAKE_STATUS
;

265  
v®
;

266 
	}
}

268 
	$tboÙ_¦“p
(
u8
 
¦“p_¡©e
)

270 
ušt32_t
 
shutdown_ty³
;

272 
	#TB_COPY_GAS
(
tbg
, 
g
) \

273 
tbg
.
¥aû_id
 = 
g
.space_id; \

274 
tbg
.
b™_width
 = 
g
.bit_width; \

275 
tbg
.
b™_off£t
 = 
g
.bit_offset; \

276 
tbg
.
acûss_width
 = 
g
.access_width; \

277 
tbg
.
add»ss
 = 
g
.add»ss;

	)

280 
	`TB_COPY_GAS
(
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1a_út_blk
,

281 
aıi_sšfo
.
pm1a_út_blk
);

282 
	`TB_COPY_GAS
(
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1b_út_blk
,

283 
aıi_sšfo
.
pm1b_út_blk
);

284 
	`TB_COPY_GAS
(
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1a_evt_blk
,

285 
aıi_sšfo
.
pm1a_evt_blk
);

286 
	`TB_COPY_GAS
(
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1b_evt_blk
,

287 
aıi_sšfo
.
pm1b_evt_blk
);

288 
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1a_út_v®
 =‡cpi_sinfo.pm1a_cnt_val;

289 
g_tboÙ_sh¬ed
->
aıi_sšfo
.
pm1b_út_v®
 =‡cpi_sinfo.pm1b_cnt_val;

290 
g_tboÙ_sh¬ed
->
aıi_sšfo
.
wakeup_veùÜ
 =‡cpi_sinfo.wakeup_vector;

291 
g_tboÙ_sh¬ed
->
aıi_sšfo
.
veùÜ_width
 =‡cpi_sinfo.vector_width;

292 
g_tboÙ_sh¬ed
->
aıi_sšfo
.
k”Ãl_s3_»sume_veùÜ
 =

293 
	`boÙsym_phys
(
wakeup_¡¬t
);

295  
¦“p_¡©e
 )

297 
ACPI_STATE_S3
:

298 
shutdown_ty³
 = 
TB_SHUTDOWN_S3
;

300 
ACPI_STATE_S4
:

301 
shutdown_ty³
 = 
TB_SHUTDOWN_S4
;

303 
ACPI_STATE_S5
:

304 
shutdown_ty³
 = 
TB_SHUTDOWN_S5
;

310 
	`tboÙ_shutdown
(
shutdown_ty³
);

311 
	}
}

314 
aıi_¡©us
 
asmlškage
 
	$aıi_’‹r_¦“p_¡©e
(
u8
 
¦“p_¡©e
)

316 
aıi_¡©us
 
¡©us
;

318 iàĞ
	`tboÙ_š_m—su»d_’v
() )

320 
	`tboÙ_¦“p
(
¦“p_¡©e
);

321 
	`´štk
(
XENLOG_ERR
 "TBOOT failedƒntering s3 state\n");

322 
	`»tuº_ACPI_STATUS
(
AE_ERROR
);

325 
	`ACPI_FLUSH_CPU_CACHE
();

327 
¡©us
 = 
	`aıi_hw_»gi¡”_wr™e
(
ACPI_REGISTER_PM1A_CONTROL
,

328 
aıi_sšfo
.
pm1a_út_v®
);

329 iàĞ
	`ACPI_FAILURE
(
¡©us
) )

330 
	`»tuº_ACPI_STATUS
(
AE_ERROR
);

332 iàĞ
aıi_sšfo
.
pm1b_út_blk
.
add»ss
 )

334 
¡©us
 = 
	`aıi_hw_»gi¡”_wr™e
(
ACPI_REGISTER_PM1B_CONTROL
,

335 
aıi_sšfo
.
pm1b_út_v®
);

336 iàĞ
	`ACPI_FAILURE
(
¡©us
) )

337 
	`»tuº_ACPI_STATUS
(
AE_ERROR
);

341  !
	`aıi_g‘_wake_¡©us
() )

344 
	`»tuº_ACPI_STATUS
(
AE_OK
);

345 
	}
}

347 
__š™
 
	$aıi_¦“p_š™
()

349 
i
;

350 *
p
 = 
İt_aıi_¦“p
;

352  (
p
 !ğ
NULL
) && (*p != '\0') )

354 iàĞ!
	`¡ºcmp
(
p
, "s3_bios", 7) )

355 
aıi_video_æags
 |= 1;

356 iàĞ!
	`¡ºcmp
(
p
, "s3_mode", 7) )

357 
aıi_video_æags
 |= 2;

358 
p
 = 
	`¡rchr
(p, ',');

359 iàĞ
p
 !ğ
NULL
 )

360 
p
 +ğ
	`¡r¥n
(p, ", \t");

363 
	`´štk
(
XENLOG_INFO
 "ACPI sleep modes:");

364  
i
 = 0; i < 
ACPI_S_STATE_COUNT
; i++ )

366 iàĞ
i
 =ğ
ACPI_STATE_S3
 )

368 
¦“p_¡©es
[
i
] = 1;

369 
	`´štk
(" S%d", 
i
);

372 
¦“p_¡©es
[
i
] = 0;

374 
	`´štk
("\n");

377 
	}
}

378 
__š™ÿÎ
(
aıi_¦“p_š™
);

	@acpi/suspend.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/aıi.h
>

9 
	~<x’/smp.h
>

10 
	~<asm/´oûssÜ.h
>

11 
	~<asm/m¤.h
>

12 
	~<asm/æushb.h
>

13 
	~<asm/hvm/hvm.h
>

14 
	~<asm/hvm/suµÜt.h
>

15 
	~<asm/i387.h
>

16 
	~<x’/hy³rÿÎ.h
>

18 #ià
defšed
(
CONFIG_X86_64
)

19 
	g§ved_l¡¬
, 
	g§ved_c¡¬
;

20 
	g§ved_sy£Á”_e¥
, 
	g§ved_sy£Á”_e
;

21 
	g§ved_fs_ba£
, 
	g§ved_gs_ba£
, 
	g§ved_k”Ãl_gs_ba£
;

22 
ušt16_t
 
	g§ved_£gs
[4];

25 
	$§ve_»¡_´oûssÜ_¡©e
()

27 
	`§ve_š™_åu
(
cu¼’t
);

29 #ià
	`defšed
(
CONFIG_X86_64
)

30 
asm
 volatile (

32 : : "r" (
§ved_£gs
) : "memory" );

33 
	`rdm¤l
(
MSR_FS_BASE
, 
§ved_fs_ba£
);

34 
	`rdm¤l
(
MSR_GS_BASE
, 
§ved_gs_ba£
);

35 
	`rdm¤l
(
MSR_SHADOW_GS_BASE
, 
§ved_k”Ãl_gs_ba£
);

36 
	`rdm¤l
(
MSR_CSTAR
, 
§ved_c¡¬
);

37 
	`rdm¤l
(
MSR_LSTAR
, 
§ved_l¡¬
);

38 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

40 
	`rdm¤l
(
MSR_IA32_SYSENTER_ESP
, 
§ved_sy£Á”_e¥
);

41 
	`rdm¤l
(
MSR_IA32_SYSENTER_EIP
, 
§ved_sy£Á”_e
);

44 
	}
}

47 
	$»¡Üe_»¡_´oûssÜ_¡©e
()

49 
vıu
 *
cu¼
 = 
cu¼’t
;

51 
	`lßd_TR
();

53 #ià
	`defšed
(
CONFIG_X86_64
)

55 
	`wrm¤l
(
MSR_LSTAR
, 
§ved_l¡¬
);

56 
	`wrm¤l
(
MSR_CSTAR
, 
§ved_c¡¬
);

57 
	`wrm¤
(
MSR_STAR
, 0, (
FLAT_RING3_CS32
<<16è| 
__HYPERVISOR_CS
);

58 
	`wrm¤
(
MSR_SYSCALL_MASK
,

59 
X86_EFLAGS_VM
|
X86_EFLAGS_RF
|
X86_EFLAGS_NT
|

60 
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_TF
,

63 
	`wrm¤l
(
MSR_FS_BASE
, 
§ved_fs_ba£
);

64 
	`wrm¤l
(
MSR_GS_BASE
, 
§ved_gs_ba£
);

65 
	`wrm¤l
(
MSR_SHADOW_GS_BASE
, 
§ved_k”Ãl_gs_ba£
);

67 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

70 
	`wrm¤l
(
MSR_IA32_SYSENTER_ESP
, 
§ved_sy£Á”_e¥
);

71 
	`wrm¤l
(
MSR_IA32_SYSENTER_EIP
, 
§ved_sy£Á”_e
);

72 
	`wrm¤
(
MSR_IA32_SYSENTER_CS
, 
__HYPERVISOR_CS
, 0);

75 iàĞ!
	`is_idË_vıu
(
cu¼
) )

77 
asm
 volatile (

79 : : "r" (
§ved_£gs
) : "memory" );

80 
	`do_£t_£gm’t_ba£
(
SEGBASE_GS_USER_SEL
, 
§ved_£gs
[3]);

84 iàĞ
su³rvisÜ_mode_k”Ãl
 && 
ıu_has_£p
 )

85 
	`wrm¤
(
MSR_IA32_SYSENTER_ESP
, &
	`this_ıu
(
š™_tss
).
e¥1
, 0);

89 
	`BUG_ON
(
	`is_hvm_vıu
(
cu¼
));

90 iàĞ!
	`is_idË_vıu
(
cu¼
è&& cu¼->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] )

92 
	`wr™e_debug»g
(0, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0]);

93 
	`wr™e_debug»g
(1, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1]);

94 
	`wr™e_debug»g
(2, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2]);

95 
	`wr™e_debug»g
(3, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3]);

96 
	`wr™e_debug»g
(6, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6]);

97 
	`wr™e_debug»g
(7, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7]);

101 
	`¡ts
();

103 ià(
ıu_has_·t
)

104 
	`wrm¤l
(
MSR_IA32_CR_PAT
, 
ho¡_·t
);

106 
	`mŒr_bp_»¡Üe
();

107 
	}
}

	@apic.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/³rfc.h
>

21 
	~<x’/”ºo.h
>

22 
	~<x’/š™.h
>

23 
	~<x’/mm.h
>

24 
	~<x’/sched.h
>

25 
	~<x’/œq.h
>

26 
	~<x’/d–ay.h
>

27 
	~<x’/smp.h
>

28 
	~<x’/soáœq.h
>

29 
	~<asm/mc146818¹c.h
>

30 
	~<asm/m¤.h
>

31 
	~<asm/©omic.h
>

32 
	~<asm/mp¥ec.h
>

33 
	~<asm/æushb.h
>

34 
	~<asm/h¬dœq.h
>

35 
	~<asm/­ic.h
>

36 
	~<asm/io_­ic.h
>

37 
	~<asm/asm_deâs.h
>

38 
	~<mach_­ic.h
>

39 
	~<io_pÜts.h
>

41 
boŞ_t
 
tdt_’abËd
 
	g__»ad_mo¡ly
;

42 
boŞ_t
 
tdt_’abË
 
	g__š™d©a
 = 1;

43 
boŞ—n_·¿m
("tdt", 
tdt_’abË
);

46 
	maùive
;

48 
	m­ic_id
;

49 
	m­ic_sk´i
;

50 
	m­ic_ldr
;

51 
	m­ic_dä
;

52 
	m­ic_¥iv
;

53 
	m­ic_lv‰
;

54 
	m­ic_lvc
;

55 
	m­ic_lvtcmci
;

56 
	m­ic_lvt0
;

57 
	m­ic_lvt1
;

58 
	m­ic_lv‹¼
;

59 
	m­ic_tmiù
;

60 
	m­ic_tdü
;

61 
	m­ic_thmr
;

62 } 
	g­ic_pm_¡©e
;

67 
’abË_loÿl_­ic
 
	g__š™d©a
 = 0;

72 
	g­ic_v”bos™y
;

74 
boŞ_t
 
__š™d©a
 
	gİt_x2­ic
 = 1;

75 
boŞ—n_·¿m
("x2­ic", 
İt_x2­ic
);

77 
boŞ_t
 
__»ad_mo¡ly
 
	gx2­ic_’abËd
 = 0;

78 
boŞ_t
 
__»ad_mo¡ly
 
	gdœeùed_eoi_’abËd
 = 0;

85 
	$BUILD_SMP_INTERRUPT
(
œq_move_ş—nup_š‹¼u±
,
IRQ_MOVE_CLEANUP_VECTOR
)

86 
	$BUILD_SMP_INTERRUPT
(
ev’t_check_š‹¼u±
,
EVENT_CHECK_VECTOR
)

87 
	$BUILD_SMP_INTERRUPT
(
šv®id©e_š‹¼u±
,
INVALIDATE_TLB_VECTOR
)

88 
	$BUILD_SMP_INTERRUPT
(
ÿÎ_funùiÚ_š‹¼u±
,
CALL_FUNCTION_VECTOR
)

97 
	$BUILD_SMP_INTERRUPT
(
­ic_tim”_š‹¼u±
,
LOCAL_TIMER_VECTOR
)

98 
	$BUILD_SMP_INTERRUPT
(
”rÜ_š‹¼u±
,
ERROR_APIC_VECTOR
)

99 
	$BUILD_SMP_INTERRUPT
(
¥urious_š‹¼u±
,
SPURIOUS_APIC_VECTOR
)

100 
	$BUILD_SMP_INTERRUPT
(
pmu_­ic_š‹¼u±
,
PMU_APIC_VECTOR
)

101 
	$BUILD_SMP_INTERRUPT
(
cmci_š‹¼u±
, 
CMCI_APIC_VECTOR
)

102 #ifdeà
CONFIG_X86_MCE_THERMAL


103 
	$BUILD_SMP_INTERRUPT
(
th”m®_š‹¼u±
,
THERMAL_APIC_VECTOR
)

106 
	$mod”n_­ic
()

108 
lvr
, 
v”siÚ
;

110 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 &&

111 
boÙ_ıu_d©a
.
x86
 >= 0xf)

113 
lvr
 = 
	`­ic_»ad
(
APIC_LVR
);

114 
v”siÚ
 = 
	`GET_APIC_VERSION
(
lvr
);

115  
v”siÚ
 >= 0x14;

116 
	}
}

122 
	$ack_bad_œq
(
œq
)

124 
	`´štk
("uÃx³ùed IRQ¿°© irq %02x\n", 
œq
);

134 ià(
ıu_has_­ic
)

135 
	`ack_APIC_œq
();

136 
	}
}

138 
__š™
 
	$­ic_šŒ_š™
()

140 #ifdeà
CONFIG_SMP


141 
	`smp_šŒ_š™
();

144 
	`£t_šŒ_g©e
(
LOCAL_TIMER_VECTOR
, 
­ic_tim”_š‹¼u±
);

147 
	`£t_šŒ_g©e
(
SPURIOUS_APIC_VECTOR
, 
¥urious_š‹¼u±
);

148 
	`£t_šŒ_g©e
(
ERROR_APIC_VECTOR
, 
”rÜ_š‹¼u±
);

151 
	`£t_šŒ_g©e
(
PMU_APIC_VECTOR
, 
pmu_­ic_š‹¼u±
);

154 
	`£t_šŒ_g©e
(
CMCI_APIC_VECTOR
, 
cmci_š‹¼u±
);

157 #ifdeà
CONFIG_X86_MCE_THERMAL


158 
	`£t_šŒ_g©e
(
THERMAL_APIC_VECTOR
, 
th”m®_š‹¼u±
);

160 
	}
}

163 
boŞ_t
 
__»ad_mo¡ly
 
	gusšg_­ic_tim”
;

165 
boŞ_t
 
__»ad_mo¡ly
 
	g’abËd_vŸ_­icba£
;

167 
	$’abË_NMI_through_LVT0
 (* 
dummy
)

169 
v
, 
v”
;

171 
v”
 = 
	`­ic_»ad
(
APIC_LVR
);

172 
v”
 = 
	`GET_APIC_VERSION
(ver);

173 
v
 = 
APIC_DM_NMI
;

174 ià(!
	`APIC_INTEGRATED
(
v”
))

175 
v
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

176 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v
);

177 
	}
}

179 
	$g‘_physiÿl_brßdÿ¡
()

181 ià(
	`mod”n_­ic
())

185 
	}
}

187 
	$g‘_maxlvt
()

189 
v
, 
v”
, 
maxlvt
;

191 
v
 = 
	`­ic_»ad
(
APIC_LVR
);

192 
v”
 = 
	`GET_APIC_VERSION
(
v
);

194 
maxlvt
 = 
	`APIC_INTEGRATED
(
v”
è? 
	`GET_APIC_MAXLVT
(
v
) : 2;

195  
maxlvt
;

196 
	}
}

198 
	$ş—r_loÿl_APIC
()

200 
maxlvt
;

201 
v
;

203 
maxlvt
 = 
	`g‘_maxlvt
();

206 
	`­ic_wr™e_¬ound
(
APIC_TMICT
, 0);

212 ià(
maxlvt
 >= 3) {

213 
v
 = 
ERROR_APIC_VECTOR
;

214 
	`­ic_wr™e_¬ound
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

220 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

221 
	`­ic_wr™e_¬ound
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

222 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

223 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

224 
v
 = 
	`­ic_»ad
(
APIC_LVT1
);

225 
	`­ic_wr™e_¬ound
(
APIC_LVT1
, 
v
 | 
APIC_LVT_MASKED
);

226 ià(
maxlvt
 >= 4) {

227 
v
 = 
	`­ic_»ad
(
APIC_LVTPC
);

228 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
v
 | 
APIC_LVT_MASKED
);

232 #ifdeà
CONFIG_X86_MCE_THERMAL


233 ià(
maxlvt
 >= 5) {

234 
v
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

235 
	`­ic_wr™e_¬ound
(
APIC_LVTTHMR
, 
v
 | 
APIC_LVT_MASKED
);

239 ià(
maxlvt
 >= 6) {

240 
v
 = 
	`­ic_»ad
(
APIC_CMCI
);

241 
	`­ic_wr™e_¬ound
(
APIC_CMCI
, 
v
 | 
APIC_LVT_MASKED
);

246 
	`­ic_wr™e_¬ound
(
APIC_LVTT
, 
APIC_LVT_MASKED
);

247 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

248 
	`­ic_wr™e_¬ound
(
APIC_LVT1
, 
APIC_LVT_MASKED
);

249 ià(
maxlvt
 >= 3)

250 
	`­ic_wr™e_¬ound
(
APIC_LVTERR
, 
APIC_LVT_MASKED
);

251 ià(
maxlvt
 >= 4)

252 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
APIC_LVT_MASKED
);

254 #ifdeà
CONFIG_X86_MCE_THERMAL


255 ià(
maxlvt
 >= 5)

256 
	`­ic_wr™e_¬ound
(
APIC_LVTTHMR
, 
APIC_LVT_MASKED
);

258 ià(
maxlvt
 >= 6)

259 
	`­ic_wr™e_¬ound
(
APIC_CMCI
, 
APIC_LVT_MASKED
);

261 
v
 = 
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

262 ià(
	`APIC_INTEGRATED
(
v
)) {

263 ià(
maxlvt
 > 3)

264 
	`­ic_wr™e
(
APIC_ESR
, 0);

265 
	`­ic_»ad
(
APIC_ESR
);

267 
	}
}

269 
__š™
 
	$cÚÃù_b¥_APIC
()

271 ià(
pic_mode
) {

275 
	`ş—r_loÿl_APIC
();

280 
	`­ic_´štk
(
APIC_VERBOSE
, "leaving PIC mode, "

282 
	`outb
(0x70, 0x22);

283 
	`outb
(0x01, 0x23);

285 
	`’abË_­ic_mode
();

286 
	}
}

288 
	$discÚÃù_b¥_APIC
(
vœt_wœe_£tup
)

290 ià(
pic_mode
) {

297 
	`­ic_´štk
(
APIC_VERBOSE
, "disabling APIC mode, "

299 
	`outb
(0x70, 0x22);

300 
	`outb
(0x00, 0x23);

304 
v®ue
;

307 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

308 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

309 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

310 
v®ue
 |= 0xf;

311 
	`­ic_wr™e_¬ound
(
APIC_SPIV
, 
v®ue
);

313 ià(!
vœt_wœe_£tup
) {

315 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
);

316 
v®ue
 &ğ~(
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

317 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

318 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
 );

319 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

320 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_EXTINT
);

321 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v®ue
);

325 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_LVT_MASKED
);

329 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT1
);

330 
v®ue
 &= ~(

331 
APIC_MODE_MASK
 | 
APIC_SEND_PENDING
 |

332 
APIC_INPUT_POLARITY
 | 
APIC_LVT_REMOTE_IRR
 |

333 
APIC_LVT_LEVEL_TRIGGER
 | 
APIC_LVT_MASKED
);

334 
v®ue
 |ğ
APIC_LVT_REMOTE_IRR
 | 
APIC_SEND_PENDING
;

335 
v®ue
 = 
	`SET_APIC_DELIVERY_MODE
(v®ue, 
APIC_MODE_NMI
);

336 
	`­ic_wr™e_¬ound
(
APIC_LVT1
, 
v®ue
);

338 
	}
}

340 
	$di§bË_loÿl_APIC
()

342 
	`ş—r_loÿl_APIC
();

348 
	`­ic_wr™e_¬ound
(
APIC_SPIV
,

349 
	`­ic_»ad
(
APIC_SPIV
è& ~
APIC_SPIV_APIC_ENABLED
);

351 ià(
’abËd_vŸ_­icba£
) {

352 
ušt64_t
 
m¤_cÚ‹Á
;

353 
	`rdm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

354 
	`wrm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
 & ~
MSR_IA32_APICBASE_ENABLE
);

356 
	}
}

358 
ißpic_ack_Ãw
;

364 
__š™
 
	$v”ify_loÿl_APIC
()

366 
»g0
, 
»g1
;

371 
»g0
 = 
	`­ic_»ad
(
APIC_LVR
);

372 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g0
);

375 iàĞ!
x2­ic_’abËd
 )

376 
	`­ic_wr™e
(
APIC_LVR
, 
»g0
 ^ 
APIC_LVR_MASK
);

377 
»g1
 = 
	`­ic_»ad
(
APIC_LVR
);

378 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg VERSION: %x\n", 
»g1
);

385 ià(
»g1
 !ğ
»g0
)

391 
»g1
 = 
	`GET_APIC_VERSION
(
»g0
);

392 ià(
»g1
 == 0x00 ||„eg1 == 0xff)

394 
»g1
 = 
	`g‘_maxlvt
();

395 ià(
»g1
 < 0x02 ||„eg1 == 0xff)

403 iàĞ
»g0
 & 
APIC_LVR_DIRECTED_EOI
 )

405 
ißpic_ack_Ãw
 = 0;

406 
dœeùed_eoi_’abËd
 = 1;

407 
	`´štk
("Enabled directed EOI with ioapic_ack_old on!\n");

413 
»g0
 = 
	`­ic_»ad
(
APIC_ID
);

414 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg ID: %x\n", 
»g0
);

421 
»g0
 = 
	`­ic_»ad
(
APIC_LVT0
);

422 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg LVT0: %x\n", 
»g0
);

423 
»g1
 = 
	`­ic_»ad
(
APIC_LVT1
);

424 
	`­ic_´štk
(
APIC_DEBUG
, "G‘tšg LVT1: %x\n", 
»g1
);

427 
	}
}

429 
__š™
 
	$sync_Arb_IDs
()

433 ià(
	`mod”n_­ic
())

438 
	`­ic_wa™_iü_idË
();

440 
	`­ic_´štk
(
APIC_DEBUG
, "Synchronizing Arb IDs.\n");

441 
	`­ic_wr™e_¬ound
(
APIC_ICR
, 
APIC_DEST_ALLINC
 | 
APIC_INT_LEVELTRIG


442 | 
APIC_DM_INIT
);

443 
	}
}

445 
__”rÜ_š_­ic_c
 ();

450 
__š™
 
	$š™_b¥_APIC
()

452 
v®ue
, 
v”
;

458 ià(
smp_found_cÚfig
 || !
ıu_has_­ic
)

461 
v®ue
 = 
	`­ic_»ad
(
APIC_LVR
);

462 
v”
 = 
	`GET_APIC_VERSION
(
v®ue
);

467 
	`ş—r_loÿl_APIC
();

472 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

473 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

474 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

477 ià((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
è&& (boÙ_ıu_d©a.
x86
 == 15))

478 
v®ue
 &ğ~
APIC_SPIV_FOCUS_DISABLED
;

480 
v®ue
 |ğ
APIC_SPIV_FOCUS_DISABLED
;

481 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

482 
	`­ic_wr™e_¬ound
(
APIC_SPIV
, 
v®ue
);

487 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

488 
v®ue
 = 
APIC_DM_NMI
;

489 ià(!
	`APIC_INTEGRATED
(
v”
))

490 
v®ue
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

491 
	`­ic_wr™e_¬ound
(
APIC_LVT1
, 
v®ue
);

492 
	}
}

494 
	$­ic_pm_aùiv©e
()

496 
­ic_pm_¡©e
.
aùive
 = 1;

497 
	}
}

499 
	$__’abË_x2­ic
()

501 
ušt64_t
 
m¤_cÚ‹Á
;

503 
	`rdm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

504 iàĞ!(
m¤_cÚ‹Á
 & 
MSR_IA32_APICBASE_EXTD
) )

506 
m¤_cÚ‹Á
 |ğ
MSR_IA32_APICBASE_ENABLE
 | 
MSR_IA32_APICBASE_EXTD
;

507 
m¤_cÚ‹Á
 = (
ušt32_t
)msr_content;

508 
	`wrm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

510 
	}
}

512 
	$»sume_x2­ic
()

514 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
 = 
NULL
;

516 
	`ASSERT
(
x2­ic_’abËd
);

518 
ißpic_’Œ›s
 = 
	`®loc_ißpic_’Œ›s
();

519 iàĞ!
ißpic_’Œ›s
 )

521 
	`´štk
("Allocate ioapic_entries failed\n");

522 
out
;

525 iàĞ
	`§ve_IO_APIC_£tup
(
ißpic_’Œ›s
) )

527 
	`´štk
("Saving IO-APIC state failed\n");

528 
out
;

531 
	`mask_8259A
();

532 
	`mask_IO_APIC_£tup
(
ißpic_’Œ›s
);

534 
	`iommu_’abË_IR
();

535 
	`__’abË_x2­ic
();

537 
	`»¡Üe_IO_APIC_£tup
(
ißpic_’Œ›s
);

538 
	`unmask_8259A
();

540 
out
:

541 iàĞ
ißpic_’Œ›s
 )

542 
	`ä“_ißpic_’Œ›s
(
ißpic_’Œ›s
);

543 
	}
}

545 
__devš™
 
	$£tup_loÿl_APIC
()

547 
Şdv®ue
, 
v®ue
, 
v”
, 
maxlvt
;

548 
i
, 
j
;

551 ià(
e¤_di§bË
) {

552 
	`­ic_wr™e
(
APIC_ESR
, 0);

553 
	`­ic_wr™e
(
APIC_ESR
, 0);

554 
	`­ic_wr™e
(
APIC_ESR
, 0);

555 
	`­ic_wr™e
(
APIC_ESR
, 0);

558 
v®ue
 = 
	`­ic_»ad
(
APIC_LVR
);

559 
v”
 = 
	`GET_APIC_VERSION
(
v®ue
);

561 ià((
SPURIOUS_APIC_VECTOR
 & 0x0f) != 0x0f)

562 
	`__”rÜ_š_­ic_c
();

567 ià(!
	`­ic_id_»gi¡”ed
())

568 
	`BUG
();

575 
	`š™_­ic_ldr
();

580 
	`­ic_wr™e_¬ound
(
APIC_TASKPRI
, (
FIRST_DYNAMIC_VECTOR
 & 0xF0) - 0x10);

593 
i
 = 
APIC_ISR_NR
 - 1; i >= 0; i--) {

594 
v®ue
 = 
	`­ic_»ad
(
APIC_ISR
 + 
i
*0x10);

595 
j
 = 31; j >= 0; j--) {

596 ià(
v®ue
 & (1<<
j
))

597 
	`ack_APIC_œq
();

604 
v®ue
 = 
	`­ic_»ad
(
APIC_SPIV
);

605 
v®ue
 &ğ~
APIC_VECTOR_MASK
;

609 
v®ue
 |ğ
APIC_SPIV_APIC_ENABLED
;

632 
v®ue
 &ğ~
APIC_SPIV_FOCUS_DISABLED
;

635 
v®ue
 |ğ
APIC_SPIV_FOCUS_DISABLED
;

640 
v®ue
 |ğ
SPURIOUS_APIC_VECTOR
;

645 iàĞ
dœeùed_eoi_’abËd
 )

647 
v®ue
 |ğ
APIC_SPIV_DIRECTED_EOI
;

648 
	`­ic_´štk
(
APIC_VERBOSE
, "Suppress EOI broadcast on CPU#%d\n",

649 
	`smp_´oûssÜ_id
());

652 
	`­ic_wr™e_¬ound
(
APIC_SPIV
, 
v®ue
);

664 
v®ue
 = 
	`­ic_»ad
(
APIC_LVT0
è& 
APIC_LVT_MASKED
;

665 ià(!
	`smp_´oûssÜ_id
(è&& (
pic_mode
 || !
v®ue
)) {

666 
v®ue
 = 
APIC_DM_EXTINT
;

667 
	`­ic_´štk
(
APIC_VERBOSE
, "enabled ExtINT on CPU#%d\n",

668 
	`smp_´oûssÜ_id
());

670 
v®ue
 = 
APIC_DM_EXTINT
 | 
APIC_LVT_MASKED
;

671 
	`­ic_´štk
(
APIC_VERBOSE
, "masked ExtINT on CPU#%d\n",

672 
	`smp_´oûssÜ_id
());

674 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v®ue
);

679 ià(!
	`smp_´oûssÜ_id
())

680 
v®ue
 = 
APIC_DM_NMI
;

682 
v®ue
 = 
APIC_DM_NMI
 | 
APIC_LVT_MASKED
;

683 ià(!
	`APIC_INTEGRATED
(
v”
))

684 
v®ue
 |ğ
APIC_LVT_LEVEL_TRIGGER
;

685 
	`­ic_wr™e_¬ound
(
APIC_LVT1
, 
v®ue
);

687 ià(
	`APIC_INTEGRATED
(
v”
è&& !
e¤_di§bË
) {

688 
maxlvt
 = 
	`g‘_maxlvt
();

689 ià(
maxlvt
 > 3)

690 
	`­ic_wr™e
(
APIC_ESR
, 0);

691 
Şdv®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

693 
v®ue
 = 
ERROR_APIC_VECTOR
;

694 
	`­ic_wr™e_¬ound
(
APIC_LVTERR
, 
v®ue
);

698 ià(
maxlvt
 > 3)

699 
	`­ic_wr™e
(
APIC_ESR
, 0);

700 
v®ue
 = 
	`­ic_»ad
(
APIC_ESR
);

701 ià(
v®ue
 !ğ
Şdv®ue
)

702 
	`­ic_´štk
(
APIC_VERBOSE
, "ESR value beforeƒnabling "

704 
Şdv®ue
, 
v®ue
);

706 ià(
e¤_di§bË
)

713 
	`´štk
("Leaving ESR disabled.\n");

715 
	`´štk
("No ESR for 82489DX.\n");

718 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

719 
	`£tup_­ic_nmi_w©chdog
();

720 
	`­ic_pm_aùiv©e
();

721 
	}
}

723 
	$Ïpic_su¥’d
()

725 
æags
;

726 
maxlvt
 = 
	`g‘_maxlvt
();

727 ià(!
­ic_pm_¡©e
.
aùive
)

730 
­ic_pm_¡©e
.
­ic_id
 = 
	`­ic_»ad
(
APIC_ID
);

731 
­ic_pm_¡©e
.
­ic_sk´i
 = 
	`­ic_»ad
(
APIC_TASKPRI
);

732 
­ic_pm_¡©e
.
­ic_ldr
 = 
	`­ic_»ad
(
APIC_LDR
);

733 
­ic_pm_¡©e
.
­ic_dä
 = 
	`­ic_»ad
(
APIC_DFR
);

734 
­ic_pm_¡©e
.
­ic_¥iv
 = 
	`­ic_»ad
(
APIC_SPIV
);

735 
­ic_pm_¡©e
.
­ic_lv‰
 = 
	`­ic_»ad
(
APIC_LVTT
);

736 
­ic_pm_¡©e
.
­ic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

738 ià(
maxlvt
 >= 6) {

739 
­ic_pm_¡©e
.
­ic_lvtcmci
 = 
	`­ic_»ad
(
APIC_CMCI
);

742 
­ic_pm_¡©e
.
­ic_lvt0
 = 
	`­ic_»ad
(
APIC_LVT0
);

743 
­ic_pm_¡©e
.
­ic_lvt1
 = 
	`­ic_»ad
(
APIC_LVT1
);

744 
­ic_pm_¡©e
.
­ic_lv‹¼
 = 
	`­ic_»ad
(
APIC_LVTERR
);

745 
­ic_pm_¡©e
.
­ic_tmiù
 = 
	`­ic_»ad
(
APIC_TMICT
);

746 
­ic_pm_¡©e
.
­ic_tdü
 = 
	`­ic_»ad
(
APIC_TDCR
);

747 
­ic_pm_¡©e
.
­ic_thmr
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

749 
	`loÿl_œq_§ve
(
æags
);

750 
	`di§bË_loÿl_APIC
();

751 
	`iommu_di§bË_IR
();

752 
	`loÿl_œq_»¡Üe
(
æags
);

754 
	}
}

756 
	$Ïpic_»sume
()

758 
ušt64_t
 
m¤_cÚ‹Á
;

759 
æags
;

760 
maxlvt
;

762 ià(!
­ic_pm_¡©e
.
aùive
)

765 
	`loÿl_œq_§ve
(
æags
);

773 iàĞ!
x2­ic_’abËd
 )

775 
	`rdm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

776 
m¤_cÚ‹Á
 &ğ~
MSR_IA32_APICBASE_BASE
;

777 
	`wrm¤l
(
MSR_IA32_APICBASE
,

778 
m¤_cÚ‹Á
 | 
MSR_IA32_APICBASE_ENABLE
 | 
mp_Ïpic_addr
);

781 
	`»sume_x2­ic
();

783 
	`­ic_wr™e
(
APIC_LVTERR
, 
ERROR_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

784 
	`­ic_wr™e
(
APIC_ID
, 
­ic_pm_¡©e
.
­ic_id
);

785 
	`­ic_wr™e
(
APIC_DFR
, 
­ic_pm_¡©e
.
­ic_dä
);

786 
	`­ic_wr™e
(
APIC_LDR
, 
­ic_pm_¡©e
.
­ic_ldr
);

787 
	`­ic_wr™e
(
APIC_TASKPRI
, 
­ic_pm_¡©e
.
­ic_sk´i
);

788 
	`­ic_wr™e
(
APIC_SPIV
, 
­ic_pm_¡©e
.
­ic_¥iv
);

789 
	`­ic_wr™e
(
APIC_LVT0
, 
­ic_pm_¡©e
.
­ic_lvt0
);

790 
	`­ic_wr™e
(
APIC_LVT1
, 
­ic_pm_¡©e
.
­ic_lvt1
);

791 
	`­ic_wr™e
(
APIC_LVTTHMR
, 
­ic_pm_¡©e
.
­ic_thmr
);

793 
maxlvt
 = 
	`g‘_maxlvt
();

794 ià(
maxlvt
 >= 6) {

795 
	`­ic_wr™e
(
APIC_CMCI
, 
­ic_pm_¡©e
.
­ic_lvtcmci
);

798 
	`­ic_wr™e
(
APIC_LVTPC
, 
­ic_pm_¡©e
.
­ic_lvc
);

799 
	`­ic_wr™e
(
APIC_LVTT
, 
­ic_pm_¡©e
.
­ic_lv‰
);

800 
	`­ic_wr™e
(
APIC_TDCR
, 
­ic_pm_¡©e
.
­ic_tdü
);

801 
	`­ic_wr™e
(
APIC_TMICT
, 
­ic_pm_¡©e
.
­ic_tmiù
);

802 
	`­ic_wr™e
(
APIC_ESR
, 0);

803 
	`­ic_»ad
(
APIC_ESR
);

804 
	`­ic_wr™e
(
APIC_LVTERR
, 
­ic_pm_¡©e
.
­ic_lv‹¼
);

805 
	`­ic_wr™e
(
APIC_ESR
, 0);

806 
	`­ic_»ad
(
APIC_ESR
);

807 
	`loÿl_œq_»¡Üe
(
æags
);

809 
	}
}

819 
	$Ïpic_shutdown
()

821 
æags
;

823 ià(!
ıu_has_­ic
)

826 
	`loÿl_œq_§ve
(
æags
);

827 
	`ş—r_loÿl_APIC
();

829 ià(
’abËd_vŸ_­icba£
)

830 
	`di§bË_loÿl_APIC
();

832 
	`loÿl_œq_»¡Üe
(
æags
);

833 
	}
}

840 
__š™
 
	$Ïpic_di§bË
(*
¡r
)

842 
’abË_loÿl_­ic
 = -1;

843 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_APIC
);

844 
	}
}

845 
cu¡om_·¿m
("nŞ­ic", 
Ïpic_di§bË
);

847 
__š™
 
	$Ïpic_’abË
(*
¡r
)

849 
’abË_loÿl_­ic
 = 1;

850 
	}
}

851 
cu¡om_·¿m
("Ïpic", 
Ïpic_’abË
);

853 
__š™
 
	$­ic_£t_v”bos™y
(*
¡r
)

855 ià(
	`¡rcmp
("debug", 
¡r
) == 0)

856 
­ic_v”bos™y
 = 
APIC_DEBUG
;

857 ià(
	`¡rcmp
("v”bo£", 
¡r
) == 0)

858 
­ic_v”bos™y
 = 
APIC_VERBOSE
;

860 
	`´štk
(
KERN_WARNING
 "APIC Verbosity†evel %s‚ot„ecognised"

861 " u£‡pic_v”bos™y=v”bo£ o¸­ic_v”bos™y=debug", 
¡r
);

862 
	}
}

863 
cu¡om_·¿m
("­ic_v”bos™y", 
­ic_£t_v”bos™y
);

865 
__š™
 
	$d‘eù_š™_APIC
 ()

867 
ušt64_t
 
m¤_cÚ‹Á
;

868 
u32
 
ã©u»s
;

871 ià(
’abË_loÿl_­ic
 < 0)

874 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

875 
X86_VENDOR_AMD
:

876 ià((
boÙ_ıu_d©a
.
x86
 =ğ6 && boÙ_ıu_d©a.
x86_mod–
 > 1) ||

877 (
boÙ_ıu_d©a
.
x86
 >= 0xf && boot_cpu_data.x86 <= 0x17))

879 
no_­ic
;

880 
X86_VENDOR_INTEL
:

881 ià(
boÙ_ıu_d©a
.
x86
 == 6 || boot_cpu_data.x86 == 15 ||

882 (
boÙ_ıu_d©a
.
x86
 =ğ5 && 
ıu_has_­ic
))

884 
no_­ic
;

886 
no_­ic
;

889 ià(!
ıu_has_­ic
) {

894 ià(
’abË_loÿl_­ic
 <= 0) {

895 
	`´štk
("Local APIC disabled by BIOS -- "

905 
	`rdm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

906 ià(!(
m¤_cÚ‹Á
 & 
MSR_IA32_APICBASE_ENABLE
)) {

907 
	`´štk
("Local APIC disabled by BIOS --„eenabling.\n");

908 
m¤_cÚ‹Á
 &ğ~
MSR_IA32_APICBASE_BASE
;

909 
m¤_cÚ‹Á
 |ğ
MSR_IA32_APICBASE_ENABLE
 | 
APIC_DEFAULT_PHYS_BASE
;

910 
	`wrm¤l
(
MSR_IA32_APICBASE
,

911 
m¤_cÚ‹Á
 | 
MSR_IA32_APICBASE_ENABLE


912 | 
APIC_DEFAULT_PHYS_BASE
);

913 
’abËd_vŸ_­icba£
 = 1;

920 
ã©u»s
 = 
	`ıuid_edx
(1);

921 ià(!(
ã©u»s
 & (1 << 
X86_FEATURE_APIC
))) {

922 
	`´štk
("Could‚otƒnable APIC!\n");

926 
	`£t_b™
(
X86_FEATURE_APIC
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

927 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

930 
	`rdm¤l
(
MSR_IA32_APICBASE
, 
m¤_cÚ‹Á
);

931 ià(
m¤_cÚ‹Á
 & 
MSR_IA32_APICBASE_ENABLE
)

932 
mp_Ïpic_addr
 = 
m¤_cÚ‹Á
 & 
MSR_IA32_APICBASE_BASE
;

934 ià(
nmi_w©chdog
 !ğ
NMI_NONE
)

935 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

937 
	`´štk
("Found‡ndƒnabled†ocal APIC!\n");

939 
	`­ic_pm_aùiv©e
();

943 
no_­ic
:

944 
	`´štk
("No†ocal APIC…resent or hardware disabled\n");

946 
	}
}

948 
	$x2­ic_­_£tup
()

950 iàĞ
x2­ic_’abËd
 )

951 
	`__’abË_x2­ic
();

952 
	}
}

954 
__š™
 
	$x2­ic_b¥_£tup
()

956 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
 = 
NULL
;

958 iàĞ!
ıu_has_x2­ic
 )

961 iàĞ!
İt_x2­ic
 )

963 iàĞ!
x2­ic_’abËd
 )

965 
	`´štk
("Notƒnabling x2APIC: disabled by cmdline.\n");

968 
	`´štk
("x2APIC: Alreadyƒnabled by BIOS: Ignoring cmdline disable.\n");

971 iàĞ!
	`iommu_suµÜts_eim
() )

973 iàĞ!
x2­ic_’abËd
 )

975 
	`´štk
("Notƒnabling x2APIC: depends on iommu_supports_eim.\n");

978 
	`·nic
("x2APIC:‡lreadyƒnabled by BIOS, but "

982 iàĞ(
ißpic_’Œ›s
 = 
	`®loc_ißpic_’Œ›s
()è=ğ
NULL
 )

984 
	`´štk
("Allocate ioapic_entries failed\n");

985 
out
;

988 iàĞ
	`§ve_IO_APIC_£tup
(
ißpic_’Œ›s
) )

990 
	`´štk
("Saving IO-APIC state failed\n");

991 
out
;

994 
	`mask_8259A
();

995 
	`mask_IO_APIC_£tup
(
ißpic_’Œ›s
);

997 iàĞ
	`iommu_’abË_IR
() )

999 iàĞ
x2­ic_’abËd
 )

1000 
	`·nic
("Interrupt„emapping could‚ot beƒnabled while "

1003 
	`´štk
("Would‚otƒnable x2APIC dueo interrupt„emapping "

1005 
»¡Üe_out
;

1008 
g’­ic
 = 
	`­ic_x2­ic_´obe
();

1009 
	`´štk
("Sw™chedØAPIC driv” %s.\n", 
g’­ic
->
Çme
);

1011 iàĞ!
x2­ic_’abËd
 )

1013 
x2­ic_’abËd
 = 1;

1014 
	`__’abË_x2­ic
();

1017 
»¡Üe_out
:

1018 
	`»¡Üe_IO_APIC_£tup
(
ißpic_’Œ›s
);

1019 
	`unmask_8259A
();

1021 
out
:

1022 iàĞ
ißpic_’Œ›s
 )

1023 
	`ä“_ißpic_’Œ›s
(
ißpic_’Œ›s
);

1024 
	}
}

1026 
__š™
 
	$š™_­ic_m­pšgs
()

1028 
­ic_phys
;

1030 iàĞ
x2­ic_’abËd
 )

1031 
__Ãxt
;

1037 ià(!
smp_found_cÚfig
 && 
	`d‘eù_š™_APIC
()) {

1038 
­ic_phys
 = 
	`__·
(
	`®loc_x’h—p_·ge
());

1039 
	`ş—r_·ge
(
	`__va
(
­ic_phys
));

1041 
­ic_phys
 = 
mp_Ïpic_addr
;

1043 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
­ic_phys
);

1044 
	`­ic_´štk
(
APIC_VERBOSE
, "m­³d APICØ%08lx (%08lx)\n", 
APIC_BASE
,

1045 
­ic_phys
);

1047 
__Ãxt
:

1052 ià(
boÙ_ıu_physiÿl_­icid
 == -1U)

1053 
boÙ_ıu_physiÿl_­icid
 = 
	`g‘_­ic_id
();

1054 
x86_ıu_to_­icid
[0] = 
	`g‘_­ic_id
();

1055 
ıu_2_logiÿl_­icid
[0] = 
	`g‘_logiÿl_­ic_id
();

1057 
	`š™_ißpic_m­pšgs
();

1058 
	}
}

1074 
u32
 
__»ad_mo¡ly
 
	gbus_sÿË
;

1081 
__š™
 
	$g‘_8254_tim”_couÁ
()

1086 
couÁ
;

1090 
	`outb_p
(0x00, 
PIT_MODE
);

1091 
couÁ
 = 
	`šb_p
(
PIT_CH0
);

1092 
couÁ
 |ğ
	`šb_p
(
PIT_CH0
) << 8;

1096  
couÁ
;

1097 
	}
}

1100 
__š™
 
	$wa™_8254_w¿·round
()

1102 
cu¼_couÁ
, 
´ev_couÁ
;

1104 
cu¼_couÁ
 = 
	`g‘_8254_tim”_couÁ
();

1106 
´ev_couÁ
 = 
cu¼_couÁ
;

1107 
cu¼_couÁ
 = 
	`g‘_8254_tim”_couÁ
();

1110 ià(
´ev_couÁ
 >ğ
cu¼_couÁ
 + 0x100)

1111 
cu¼_couÁ
 = 
	`g‘_8254_tim”_couÁ
();

1113 } 
´ev_couÁ
 >ğ
cu¼_couÁ
);

1114 
	}
}

1120 (*
wa™_tim”_tick
)(è
__š™d©a
 = 
wa™_8254_w¿·round
;

1133 
	#APIC_DIVISOR
 1

	)

1135 
	$__£tup_APIC_LVTT
(
şocks
)

1137 
lv‰_v®ue
, 
tmp_v®ue
, 
v”
;

1139 
v”
 = 
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

1141 
lv‰_v®ue
 = 
LOCAL_TIMER_VECTOR
;

1142 ià(!
	`APIC_INTEGRATED
(
v”
))

1143 
lv‰_v®ue
 |ğ
	`SET_APIC_TIMER_BASE
(
APIC_TIMER_BASE_DIV
);

1145 iàĞ
tdt_’abËd
 )

1147 
lv‰_v®ue
 &ğ(~
APIC_TIMER_MODE_MASK
);

1148 
lv‰_v®ue
 |ğ
APIC_TIMER_MODE_TSC_DEADLINE
;

1151 
	`­ic_wr™e_¬ound
(
APIC_LVTT
, 
lv‰_v®ue
);

1153 
tmp_v®ue
 = 
	`­ic_»ad
(
APIC_TDCR
);

1154 
	`­ic_wr™e_¬ound
(
APIC_TDCR
, (
tmp_v®ue
 | 
APIC_TDR_DIV_1
));

1156 
	`­ic_wr™e_¬ound
(
APIC_TMICT
, 
şocks
/
APIC_DIVISOR
);

1157 
	}
}

1159 
__devš™
 
	$£tup_APIC_tim”
()

1161 
æags
;

1162 
	`loÿl_œq_§ve
(
æags
);

1163 
	`__£tup_APIC_LVTT
(0);

1164 
	`loÿl_œq_»¡Üe
(
æags
);

1165 
	}
}

1180 
__š™
 
	$ÿlib¿‹_APIC_şock
()

1182 
t1
 = 0, 
t2
 = 0;

1183 
‰1
, 
‰2
;

1184 
»suÉ
;

1185 
i
;

1186 
bus_äeq
;

1187 
u32
 
bus_cyşe
;

1188 cÚ¡ 
LOOPS
 = 
HZ
/10;

1190 
	`­ic_´štk
(
APIC_VERBOSE
, "calibrating APICimer ...\n");

1197 
	`__£tup_APIC_LVTT
(1000000000);

1204 
	`wa™_tim”_tick
();

1209 ià(
ıu_has_tsc
)

1210 
	`rdtsşl
(
t1
);

1211 
‰1
 = 
	`­ic_»ad
(
APIC_TMCCT
);

1216 
i
 = 0; i < 
LOOPS
; i++)

1217 
	`wa™_tim”_tick
();

1219 
‰2
 = 
	`­ic_»ad
(
APIC_TMCCT
);

1220 ià(
ıu_has_tsc
)

1221 
	`rdtsşl
(
t2
);

1231 
»suÉ
 = (
‰1
-
‰2
)*
APIC_DIVISOR
/
LOOPS
;

1233 ià(
ıu_has_tsc
)

1234 
	`­ic_´štk
(
APIC_VERBOSE
, "..... CPU clock speed is "

1236 (()(
t2
-
t1
)/
LOOPS
)/(1000000/
HZ
),

1237 (()(
t2
-
t1
)/
LOOPS
)%(1000000/
HZ
));

1239 
	`­ic_´štk
(
APIC_VERBOSE
, "..... host bus clock speed is "

1241 
»suÉ
/(1000000/
HZ
),

1242 
»suÉ
%(1000000/
HZ
));

1245 
bus_äeq
 = 
»suÉ
*
HZ
;

1246 
bus_cyşe
 = (
u32
è(1000000000000LL/
bus_äeq
);

1247 
bus_sÿË
 = (1000*262144)/
bus_cyşe
;

1249 
	`­ic_´štk
(
APIC_VERBOSE
, "..... bus_sÿË = 0x%08X\n", 
bus_sÿË
);

1251 
	`__£tup_APIC_LVTT
(0);

1253  
»suÉ
;

1254 
	}
}

1256 
__š™
 
	$£tup_boÙ_APIC_şock
()

1258 
æags
;

1259 
	`­ic_´štk
(
APIC_VERBOSE
, "Using†ocal APICimer interrupts.\n");

1260 
usšg_­ic_tim”
 = 1;

1262 
	`loÿl_œq_§ve
(
æags
);

1264 
	`ÿlib¿‹_APIC_şock
();

1266 iàĞ
tdt_’abË
 && 
	`boÙ_ıu_has
(
X86_FEATURE_TSC_DEADLINE
) )

1268 
	`´štk
(
KERN_DEBUG
 "TSC deadlineimerƒnabled\n");

1269 
tdt_’abËd
 = 1;

1272 
	`£tup_APIC_tim”
();

1274 
	`loÿl_œq_»¡Üe
(
æags
);

1275 
	}
}

1277 
__devš™
 
	$£tup_£cÚd¬y_APIC_şock
()

1279 
	`£tup_APIC_tim”
();

1280 
	}
}

1282 
	$di§bË_APIC_tim”
()

1284 ià(
usšg_­ic_tim”
) {

1285 
v
;

1288 
	`­ic_wr™e_¬ound
(
APIC_TMICT
, 0);

1290 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

1291 
	`­ic_wr™e_¬ound
(
APIC_LVTT
, 
v
 | 
APIC_LVT_MASKED
);

1293 
	}
}

1295 
	$’abË_APIC_tim”
()

1297 ià(
usšg_­ic_tim”
) {

1298 
v
;

1300 
v
 = 
	`­ic_»ad
(
APIC_LVTT
);

1301 
	`­ic_wr™e_¬ound
(
APIC_LVTT
, 
v
 & ~
APIC_LVT_MASKED
);

1303 
	}
}

1305 #undeà
APIC_DIVISOR


1312 
	$»´og¿m_tim”
(
s_time_t
 
timeout
)

1314 
s_time_t
 
expœe
;

1315 
u32
 
­ic_tmiù
 = 0;

1318 iàĞ!
ıu_has_­ic
 )

1321 iàĞ
tdt_’abËd
 )

1323 
	`wrm¤l
(
MSR_IA32_TSC_DEADLINE
, 
timeout
 ? 
	`¡ime2tsc
(timeout) : 0);

1327 iàĞ
timeout
 && ((
expœe
 =imeouˆ- 
	`NOW
()) > 0) )

1328 
­ic_tmiù
 = 
	`mš_t
(
u64
, (
bus_sÿË
 * 
expœe
è>> 18, 
UINT_MAX
);

1330 
	`­ic_wr™e
(
APIC_TMICT
, ()
­ic_tmiù
);

1332  
­ic_tmiù
 || !
timeout
;

1333 
	}
}

1335 
ç¡ÿÎ
 
	$smp_­ic_tim”_š‹¼u±
(
ıu_u£r_»gs
 * 
»gs
)

1337 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1338 
	`ack_APIC_œq
();

1339 
	`³rfc_šü
(
­ic_tim”
);

1340 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

1341 
	`£t_œq_»gs
(
Şd_»gs
);

1342 
	}
}

1344 
DEFINE_PER_CPU
(
boŞ_t
, 
¡©e_dump_³ndšg
);

1346 
	$smp_£nd_¡©e_dump
(
ıu
)

1349 
	`³r_ıu
(
¡©e_dump_³ndšg
, 
ıu
) = 1;

1350 
	`£nd_IPI_mask
(
	`ıumask_of
(
ıu
), 
SPURIOUS_APIC_VECTOR
);

1351 
	}
}

1356 
ç¡ÿÎ
 
	$smp_¥urious_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

1358 
v
;

1359 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1361 
	`œq_’‹r
();

1368 
v
 = 
	`­ic_»ad
(
APIC_ISR
 + ((
SPURIOUS_APIC_VECTOR
 & ~0x1f) >> 1));

1369 ià(
v
 & (1 << (
SPURIOUS_APIC_VECTOR
 & 0x1f))) {

1370 
	`ack_APIC_œq
();

1371 ià(
	`this_ıu
(
¡©e_dump_³ndšg
)) {

1372 
	`this_ıu
(
¡©e_dump_³ndšg
) = 0;

1373 
	`dump_exec¡©e
(
»gs
);

1374 
out
;

1379 
	`´štk
(
KERN_INFO
 "spurious APIC interrupt on CPU#%d, should "

1380 "Ãv” h­³n.\n", 
	`smp_´oûssÜ_id
());

1382 
out
:

1383 
	`œq_ex™
();

1384 
	`£t_œq_»gs
(
Şd_»gs
);

1385 
	}
}

1391 
ç¡ÿÎ
 
	$smp_”rÜ_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

1393 
v
, 
v1
;

1394 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1396 
	`œq_’‹r
();

1398 
v
 = 
	`­ic_»ad
(
APIC_ESR
);

1399 
	`­ic_wr™e
(
APIC_ESR
, 0);

1400 
v1
 = 
	`­ic_»ad
(
APIC_ESR
);

1401 
	`ack_APIC_œq
();

1413 
	`´štk
 (
KERN_DEBUG
 "APICƒrror on CPU%d: %02lx(%02lx)\n",

1414 
	`smp_´oûssÜ_id
(), 
v
 , 
v1
);

1415 
	`œq_ex™
();

1416 
	`£t_œq_»gs
(
Şd_»gs
);

1417 
	}
}

1423 
ç¡ÿÎ
 
	$smp_pmu_­ic_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

1425 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1426 
	`ack_APIC_œq
();

1427 
	`hvm_do_pmu_š‹¼u±
(
»gs
);

1428 
	`£t_œq_»gs
(
Şd_»gs
);

1429 
	}
}

1435 
__š™
 
	$APIC_š™_unroûssÜ
 ()

1437 ià(
’abË_loÿl_­ic
 < 0)

1438 
	`ş—r_b™
(
X86_FEATURE_APIC
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

1440 ià(!
smp_found_cÚfig
 && !
ıu_has_­ic
) {

1441 
sk_ißpic_£tup
 = 1;

1448 ià(!
ıu_has_­ic
 && 
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])) {

1449 
	`´štk
(
KERN_ERR
 "BIOS bug,†ocal APIC #%d‚ot detected!...\n",

1450 
boÙ_ıu_physiÿl_­icid
);

1451 
	`ş—r_b™
(
X86_FEATURE_APIC
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

1452 
sk_ißpic_£tup
 = 1;

1456 
	`v”ify_loÿl_APIC
();

1458 
	`cÚÃù_b¥_APIC
();

1465 #ifdeà
CONFIG_CRASH_DUMP


1466 
boÙ_ıu_physiÿl_­icid
 = 
	`g‘_­ic_id
();

1468 
phys_ıu_´e£Á_m­
 = 
	`physid_mask_of_physid
(
boÙ_ıu_physiÿl_­icid
);

1470 
	`£tup_loÿl_APIC
();

1472 ià(
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
)

1473 
	`check_nmi_w©chdog
();

1474 #ifdeà
CONFIG_X86_IO_APIC


1475 ià(
smp_found_cÚfig
)

1476 ià(!
sk_ißpic_£tup
 && 
Ä_ißpics
)

1477 
	`£tup_IO_APIC
();

1479 
	`£tup_boÙ_APIC_şock
();

1482 
	}
}

1484 
	$check_fÜ_uÃx³ùed_msi
(
veùÜ
)

1486 
v
 = 
	`­ic_»ad
(
APIC_ISR
 + ((
veùÜ
 & ~0x1f) >> 1));

1487 
	`BUG_ON
(
v
 & (1 << (
veùÜ
 & 0x1f)));

1488 
	}
}

	@bitops.c

2 
	~<x’/b™İs.h
>

3 
	~<x’/lib.h
>

5 
	$__fšd_fœ¡_b™
(

6 cÚ¡ *
addr
, 
size
)

8 
d0
, 
d1
, 
»s
;

10 
asm
 volatile (

12 "„•e; sÿs"
__OS
"\n\t"

14 " bsà-"
	`STR
(
BITS_PER_LONG
/8)"(%2),%0\n\t"

16 "†— -"
	`STR
(
BITS_PER_LONG
/8)"(%2),%2\n\t"

20 : "=&a" (
»s
), "=&c" (
d0
), "=&D" (
d1
)

21 : "1" (
	`BITS_TO_LONGS
(
size
)), "2" (
addr
), "b" (()()addr)

24  
»s
;

25 
	}
}

27 
	$__fšd_Ãxt_b™
(

28 cÚ¡ *
addr
, 
size
, 
off£t
)

30 cÚ¡ *
p
 = 
addr
 + (
off£t
 / 
BITS_PER_LONG
);

31 
£t
, 
b™
 = 
off£t
 & (
BITS_PER_LONG
 - 1);

33 
	`ASSERT
(
off£t
 <ğ
size
);

35 iàĞ
b™
 != 0 )

38 
£t
 = 
	`__sÿnb™
(*
p
 >> 
b™
, 
BITS_PER_LONG
 - bit);

39 iàĞ
£t
 < (
BITS_PER_LONG
 - 
b™
) )

40  (
off£t
 + 
£t
);

41 
off£t
 +ğ
BITS_PER_LONG
 - 
b™
;

42 
p
++;

45 iàĞ
off£t
 >ğ
size
 )

46  
size
;

49 
£t
 = 
	`__fšd_fœ¡_b™
(
p
, 
size
 - 
off£t
);

50  (
off£t
 + 
£t
);

51 
	}
}

53 
	$__fšd_fœ¡_z”o_b™
(

54 cÚ¡ *
addr
, 
size
)

56 
d0
, 
d1
, 
d2
, 
»s
;

58 
asm
 volatile (

61 "„•e; sÿs"
__OS
"\n\t"

63 " xÜ -"
	`STR
(
BITS_PER_LONG
/8)"(%2),%3\n\t"

66 "†— -"
	`STR
(
BITS_PER_LONG
/8)"(%2),%2\n\t"

70 : "=&d" (
»s
), "=&c" (
d0
), "=&D" (
d1
), "=&a" (
d2
)

71 : "1" (
	`BITS_TO_LONGS
(
size
)), "2" (
addr
), "b" (()()addr)

74  
»s
;

75 
	}
}

77 
	$__fšd_Ãxt_z”o_b™
(

78 cÚ¡ *
addr
, 
size
, 
off£t
)

80 cÚ¡ *
p
 = 
addr
 + (
off£t
 / 
BITS_PER_LONG
);

81 
£t
, 
b™
 = 
off£t
 & (
BITS_PER_LONG
 - 1);

83 
	`ASSERT
(
off£t
 <ğ
size
);

85 iàĞ
b™
 != 0 )

88 
£t
 = 
	`__sÿnb™
(~(*
p
 >> 
b™
), 
BITS_PER_LONG
 - bit);

89 iàĞ
£t
 < (
BITS_PER_LONG
 - 
b™
) )

90  (
off£t
 + 
£t
);

91 
off£t
 +ğ
BITS_PER_LONG
 - 
b™
;

92 
p
++;

95 iàĞ
off£t
 >ğ
size
 )

96  
size
;

99 
£t
 = 
	`__fšd_fœ¡_z”o_b™
(
p
, 
size
 - 
off£t
);

100  (
off£t
 + 
£t
);

101 
	}
}

	@boot/mkelf32.c

10 
	~<”ºo.h
>

11 
	~<¡dio.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

14 
	~<sys/ty³s.h
>

15 
	~<sys/¡©.h
>

16 
	~<fú.h
>

17 
	~<uni¡d.h
>

18 
	~<š‰y³s.h
>

20 
	#u8
 
ušt8_t


	)

21 
	#u16
 
ušt16_t


	)

22 
	#u32
 
ušt32_t


	)

23 
	#u64
 
ušt64_t


	)

24 
	#s8
 
št8_t


	)

25 
	#s16
 
št16_t


	)

26 
	#s32
 
št32_t


	)

27 
	#s64
 
št64_t


	)

28 
	~"../../../šşude/x’/–f¡ruùs.h
"

30 
	#DYNAMICALLY_FILLED
 0

	)

31 
	#RAW_OFFSET
 128

	)

33 
Elf32_Ehdr
 
	gout_ehdr
 = {

34 { 
ELFMAG0
, 
ELFMAG1
, 
ELFMAG2
, 
ELFMAG3
,

35 
ELFCLASS32
,

36 
ELFDATA2LSB
,

37 
EV_CURRENT
,

39 
ET_EXEC
,

40 
EM_386
,

41 
EV_CURRENT
,

42 
DYNAMICALLY_FILLED
,

43 (
Elf32_Ehdr
),

44 
DYNAMICALLY_FILLED
,

46 (
Elf32_Ehdr
),

47 (
Elf32_Phdr
),

49 (
Elf32_Shdr
),

54 
Elf32_Phdr
 
	gout_phdr
 = {

55 
PT_LOAD
,

56 
RAW_OFFSET
,

57 
DYNAMICALLY_FILLED
,

58 
DYNAMICALLY_FILLED
,

59 
DYNAMICALLY_FILLED
,

60 
DYNAMICALLY_FILLED
,

61 
PF_R
|
PF_W
|
PF_X
,

65 
u8
 
	gout_sh¡¹ab
[] = "\0.text\0.shstrtab";

67 
Elf32_Shdr
 
	gout_shdr
[] = {

70 
SHT_PROGBITS
,

71 
SHF_WRITE
|
SHF_ALLOC
|
SHF_EXECINSTR
,

72 
DYNAMICALLY_FILLED
,

73 
RAW_OFFSET
,

74 
DYNAMICALLY_FILLED
,

81 
SHT_STRTAB
,

84 
DYNAMICALLY_FILLED
,

85 (
out_sh¡¹ab
),

94 #undeà
sw­16


95 #undeà
sw­32


96 #undeà
sw­64


98 
	#sw­16
(
_v
è((((
u16
)(_v)>>8)&0xff)|(((u16)(_v)&0xff)<<8))

	)

99 
	#sw­32
(
_v
è(((
u32
)
	`sw­16
((
u16
)(_v))<<16)|(u32)sw­16((u32)((_v)>>16)))

	)

100 
	#sw­64
(
_v
è(((
u64
)
	`sw­32
((
u32
)(_v))<<32)|(u64)sw­32((u32)((_v)>>32)))

	)

102 
	gbig_’dŸn
;

104 
	$’dŸÇdju¡_ehdr32
(
Elf32_Ehdr
 *
eh
)

106 iàĞ!
big_’dŸn
 )

108 
eh
->
e_ty³
 = 
	`sw­16
(eh->e_type);

109 
eh
->
e_machše
 = 
	`sw­16
(eh->e_machine);

110 
eh
->
e_v”siÚ
 = 
	`sw­32
(eh->e_version);

111 
eh
->
e_’Œy
 = 
	`sw­32
(eh->e_entry);

112 
eh
->
e_phoff
 = 
	`sw­32
(eh->e_phoff);

113 
eh
->
e_shoff
 = 
	`sw­32
(eh->e_shoff);

114 
eh
->
e_æags
 = 
	`sw­32
(eh->e_flags);

115 
eh
->
e_ehsize
 = 
	`sw­16
(eh->e_ehsize);

116 
eh
->
e_ph’tsize
 = 
	`sw­16
(eh->e_phentsize);

117 
eh
->
e_phnum
 = 
	`sw­16
(eh->e_phnum);

118 
eh
->
e_sh’tsize
 = 
	`sw­16
(eh->e_shentsize);

119 
eh
->
e_shnum
 = 
	`sw­16
(eh->e_shnum);

120 
eh
->
e_sh¡ºdx
 = 
	`sw­16
(eh->e_shstrndx);

121 
	}
}

123 
	$’dŸÇdju¡_ehdr64
(
Elf64_Ehdr
 *
eh
)

125 iàĞ!
big_’dŸn
 )

127 
eh
->
e_ty³
 = 
	`sw­16
(eh->e_type);

128 
eh
->
e_machše
 = 
	`sw­16
(eh->e_machine);

129 
eh
->
e_v”siÚ
 = 
	`sw­32
(eh->e_version);

130 
eh
->
e_’Œy
 = 
	`sw­64
(eh->e_entry);

131 
eh
->
e_phoff
 = 
	`sw­64
(eh->e_phoff);

132 
eh
->
e_shoff
 = 
	`sw­64
(eh->e_shoff);

133 
eh
->
e_æags
 = 
	`sw­32
(eh->e_flags);

134 
eh
->
e_ehsize
 = 
	`sw­16
(eh->e_ehsize);

135 
eh
->
e_ph’tsize
 = 
	`sw­16
(eh->e_phentsize);

136 
eh
->
e_phnum
 = 
	`sw­16
(eh->e_phnum);

137 
eh
->
e_sh’tsize
 = 
	`sw­16
(eh->e_shentsize);

138 
eh
->
e_shnum
 = 
	`sw­16
(eh->e_shnum);

139 
eh
->
e_sh¡ºdx
 = 
	`sw­16
(eh->e_shstrndx);

140 
	}
}

142 
	$’dŸÇdju¡_phdr32
(
Elf32_Phdr
 *
ph
)

144 iàĞ!
big_’dŸn
 )

146 
ph
->
p_ty³
 = 
	`sw­32
(ph->p_type);

147 
ph
->
p_off£t
 = 
	`sw­32
(ph->p_offset);

148 
ph
->
p_vaddr
 = 
	`sw­32
(ph->p_vaddr);

149 
ph
->
p_·ddr
 = 
	`sw­32
(ph->p_paddr);

150 
ph
->
p_fesz
 = 
	`sw­32
(ph->p_filesz);

151 
ph
->
p_memsz
 = 
	`sw­32
(ph->p_memsz);

152 
ph
->
p_æags
 = 
	`sw­32
(ph->p_flags);

153 
ph
->
p_®ign
 = 
	`sw­32
(ph->p_align);

154 
	}
}

156 
	$’dŸÇdju¡_phdr64
(
Elf64_Phdr
 *
ph
)

158 iàĞ!
big_’dŸn
 )

160 
ph
->
p_ty³
 = 
	`sw­32
(ph->p_type);

161 
ph
->
p_æags
 = 
	`sw­32
(ph->p_flags);

162 
ph
->
p_off£t
 = 
	`sw­64
(ph->p_offset);

163 
ph
->
p_vaddr
 = 
	`sw­64
(ph->p_vaddr);

164 
ph
->
p_·ddr
 = 
	`sw­64
(ph->p_paddr);

165 
ph
->
p_fesz
 = 
	`sw­64
(ph->p_filesz);

166 
ph
->
p_memsz
 = 
	`sw­64
(ph->p_memsz);

167 
ph
->
p_®ign
 = 
	`sw­64
(ph->p_align);

168 
	}
}

170 
	$’dŸÇdju¡_shdr32
(
Elf32_Shdr
 *
sh
)

172 iàĞ!
big_’dŸn
 )

174 
sh
->
sh_Çme
 = 
	`sw­32
(sh->sh_name);

175 
sh
->
sh_ty³
 = 
	`sw­32
(sh->sh_type);

176 
sh
->
sh_æags
 = 
	`sw­32
(sh->sh_flags);

177 
sh
->
sh_addr
 = 
	`sw­32
(sh->sh_addr);

178 
sh
->
sh_off£t
 = 
	`sw­32
(sh->sh_offset);

179 
sh
->
sh_size
 = 
	`sw­32
(sh->sh_size);

180 
sh
->
sh_lšk
 = 
	`sw­32
(sh->sh_link);

181 
sh
->
sh_šfo
 = 
	`sw­32
(sh->sh_info);

182 
sh
->
sh_add¿lign
 = 
	`sw­32
(sh->sh_addralign);

183 
sh
->
sh_’tsize
 = 
	`sw­32
(sh->sh_entsize);

184 
	}
}

186 
	$do_wr™e
(
fd
, *
d©a
, 
Ën
)

188 
dÚe
, 
Ëá
 = 
Ën
;

189 *
p
 = 
d©a
;

191  
Ëá
 != 0 )

193 iàĞ(
dÚe
 = 
	`wr™e
(
fd
, 
p
, 
Ëá
)) == -1 )

195 iàĞ
”ºo
 =ğ
EINTR
 )

197 
	`årštf
(
¡d”r
, "Error writing output image: %d (%s).\n",

198 
”ºo
, 
	`¡»¼Ü
(errno));

199 
	`ex™
(1);

202 
Ëá
 -ğ
dÚe
;

203 
p
 +ğ
dÚe
;

205 
	}
}

207 
	$do_»ad
(
fd
, *
d©a
, 
Ën
)

209 
dÚe
, 
Ëá
 = 
Ën
;

210 *
p
 = 
d©a
;

212  
Ëá
 != 0 )

214 iàĞ(
dÚe
 = 
	`»ad
(
fd
, 
p
, 
Ëá
)) == -1 )

216 iàĞ
”ºo
 =ğ
EINTR
 )

218 
	`årštf
(
¡d”r
, "Error„eading input image: %d (%s).\n",

219 
”ºo
, 
	`¡»¼Ü
(errno));

220 
	`ex™
(1);

223 
Ëá
 -ğ
dÚe
;

224 
p
 +ğ
dÚe
;

226 
	}
}

228 
	$maš
(
¬gc
, **
¬gv
)

230 
u64
 
fš®_exec_addr
;

231 
u32
 
lßdba£
, 
d©_siz
, 
mem_siz
;

232 *
šimage
, *
outimage
;

233 
šfd
, 
outfd
;

234 
bufãr
[1024];

235 
by‹s
, 
todo
, 
i
;

237 
Elf32_Ehdr
 
š32_ehdr
;

238 
Elf32_Phdr
 
š32_phdr
;

240 
Elf64_Ehdr
 
š64_ehdr
;

241 
Elf64_Phdr
 
š64_phdr
;

243 iàĞ
¬gc
 != 5 )

245 
	`årštf
(
¡d”r
, "Usage: mkelf32 <in-image> <out-image> "

250 
šimage
 = 
¬gv
[1];

251 
outimage
 = 
¬gv
[2];

252 
lßdba£
 = 
	`¡¹oul
(
¬gv
[3], 
NULL
, 16);

253 
fš®_exec_addr
 = 
	`¡¹ouÎ
(
¬gv
[4], 
NULL
, 16);

255 
šfd
 = 
	`İ’
(
šimage
, 
O_RDONLY
);

256 iàĞ
šfd
 == -1 )

258 
	`årštf
(
¡d”r
, "Failedo open input image '%s': %d (%s).\n",

259 
šimage
, 
”ºo
, 
	`¡»¼Ü
(errno));

263 
	`do_»ad
(
šfd
, &
š32_ehdr
, (in32_ehdr));

264 iàĞ!
	`IS_ELF
(
š32_ehdr
) ||

265 (
š32_ehdr
.
e_id’t
[
EI_DATA
] !ğ
ELFDATA2LSB
) )

267 
	`årštf
(
¡d”r
, "Input image must be‡†ittle-endian Elf image.\n");

271 
big_’dŸn
 = (*(
u16
 *)
š32_ehdr
.
e_id’t
 =ğ((
ELFMAG0
 << 8è| 
ELFMAG1
));

273 
	`’dŸÇdju¡_ehdr32
(&
š32_ehdr
);

274  
š32_ehdr
.
e_id’t
[
EI_CLASS
] )

276 
ELFCLASS32
:

277 iàĞ
š32_ehdr
.
e_ph’tsize
 !ğ(
š32_phdr
) )

279 
	`årštf
(
¡d”r
, "Bad…rogram header size (%d != %d).\n",

280 ()
š32_ehdr
.
e_ph’tsize
, ()(
š32_phdr
));

284 iàĞ
š32_ehdr
.
e_phnum
 != 1 )

286 
	`årštf
(
¡d”r
, "Expect…recisely 1…rogram header; found %d.\n",

287 ()
š32_ehdr
.
e_phnum
);

291 ()
	`l£ek
(
šfd
, 
š32_ehdr
.
e_phoff
, 
SEEK_SET
);

292 
	`do_»ad
(
šfd
, &
š32_phdr
, (in32_phdr));

293 
	`’dŸÇdju¡_phdr32
(&
š32_phdr
);

295 ()
	`l£ek
(
šfd
, 
š32_phdr
.
p_off£t
, 
SEEK_SET
);

296 
d©_siz
 = (
u32
)
š32_phdr
.
p_fesz
;

300 
mem_siz
 = (
u32
)(
fš®_exec_addr
 - 
š32_phdr
.
p_vaddr
);

303 
ELFCLASS64
:

304 ()
	`l£ek
(
šfd
, 0, 
SEEK_SET
);

305 
	`do_»ad
(
šfd
, &
š64_ehdr
, (in64_ehdr));

306 
	`’dŸÇdju¡_ehdr64
(&
š64_ehdr
);

308 iàĞ
š64_ehdr
.
e_ph’tsize
 !ğ(
š64_phdr
) )

310 
	`årštf
(
¡d”r
, "Bad…rogram header size (%d != %d).\n",

311 ()
š64_ehdr
.
e_ph’tsize
, ()(
š64_phdr
));

315 iàĞ
š64_ehdr
.
e_phnum
 != 1 )

317 
	`årštf
(
¡d”r
, "Expect…recisly 1…rogram header; found %d.\n",

318 ()
š64_ehdr
.
e_phnum
);

322 ()
	`l£ek
(
šfd
, 
š64_ehdr
.
e_phoff
, 
SEEK_SET
);

323 
	`do_»ad
(
šfd
, &
š64_phdr
, (in64_phdr));

324 
	`’dŸÇdju¡_phdr64
(&
š64_phdr
);

326 ()
	`l£ek
(
šfd
, 
š64_phdr
.
p_off£t
, 
SEEK_SET
);

327 
d©_siz
 = (
u32
)
š64_phdr
.
p_fesz
;

331 
mem_siz
 = (
u32
)(
fš®_exec_addr
 - 
š64_phdr
.
p_vaddr
);

335 
	`årštf
(
¡d”r
, "Input image must be‡ 32- or 64-bit Elf image.\n");

343 
mem_siz
 +ğ-(
lßdba£
 + mem_siz) & 0xfff;

345 
out_ehdr
.
e_’Œy
 = 
lßdba£
;

346 
out_ehdr
.
e_shoff
 = 
RAW_OFFSET
 + 
d©_siz
;

348 
out_phdr
.
p_vaddr
 = 
lßdba£
;

349 
out_phdr
.
p_·ddr
 = 
lßdba£
;

350 
out_phdr
.
p_fesz
 = 
d©_siz
;

351 
out_phdr
.
p_memsz
 = 
mem_siz
;

353 
out_shdr
[1].
sh_addr
 = 
lßdba£
;

354 
out_shdr
[1].
sh_size
 = 
d©_siz
;

355 
out_shdr
[2].
sh_off£t
 = 
RAW_OFFSET
 + 
d©_siz
 + (out_shdr);

357 
outfd
 = 
	`İ’
(
outimage
, 
O_WRONLY
|
O_CREAT
|
O_TRUNC
, 0775);

358 iàĞ
outfd
 == -1 )

360 
	`årštf
(
¡d”r
, "Failedo open output image '%s': %d (%s).\n",

361 
outimage
, 
”ºo
, 
	`¡»¼Ü
(errno));

365 
	`’dŸÇdju¡_ehdr32
(&
out_ehdr
);

366 
	`do_wr™e
(
outfd
, &
out_ehdr
, (out_ehdr));

368 
	`’dŸÇdju¡_phdr32
(&
out_phdr
);

369 
	`do_wr™e
(
outfd
, &
out_phdr
, (out_phdr));

371 iàĞ(
by‹s
 = 
RAW_OFFSET
 - (
out_ehdr
è- (
out_phdr
)) < 0 )

373 
	`årštf
(
¡d”r
, "Header overflow.\n");

376 
	`do_wr™e
(
outfd
, 
bufãr
, 
by‹s
);

378  
by‹s
 = 0; by‹ < 
d©_siz
; by‹ +ğ
todo
 )

380 
todo
 = ((
d©_siz
 - 
by‹s
è> (
bufãr
)) ?

381 (
bufãr
è: (
d©_siz
 - 
by‹s
);

382 
	`do_»ad
(
šfd
, 
bufãr
, 
todo
);

383 
	`do_wr™e
(
outfd
, 
bufãr
, 
todo
);

386  
i
 = 0; i < ((
out_shdr
) / (out_shdr[0])); i++ )

387 
	`’dŸÇdju¡_shdr32
(&
out_shdr
[
i
]);

388 
	`do_wr™e
(
outfd
, &
out_shdr
[0], (out_shdr));

390 
	`do_wr™e
(
outfd
, 
out_sh¡¹ab
, (out_shstrtab));

391 
	`do_wr™e
(
outfd
, 
bufãr
, 4-(((
out_sh¡¹ab
)+
d©_siz
)&3));

393 
	`şo£
(
šfd
);

394 
	`şo£
(
outfd
);

397 
	}
}

	@boot/reloc.c

13 
asm
 (

31 
	tu32
;

32 
	~"../../../šşude/x’/muÉiboÙ.h
"

34 
_¡¬t
[];

36 *
	$memıy
(*
de¡
, cÚ¡ *
¤c
, 
n
)

38 *
s
 = (*)
¤c
, *
d
 = 
de¡
;

39  
n
-- )

40 *
d
++ = *
s
++;

41  
de¡
;

42 
	}
}

44 *
	$»loc_mbi_¡ruù
(*
Şd
, 
by‹s
)

46 *
®loc
 = &
_¡¬t
;

47 
®loc
 = (*)(((ïÎoø- 
by‹s
) & ~15ul);

48  
	`memıy
(
®loc
, 
Şd
, 
by‹s
);

49 
	}
}

51 *
	$»loc_mbi_¡ršg
(*
Şd
)

53 *
p
;

54  
p
 = 
Şd
; *p != '\0';…++ )

56  
	`»loc_mbi_¡ruù
(
Şd
, 
p
 - old + 1);

57 
	}
}

59 
muÉiboÙ_šfo_t
 *
	$»loc
(
muÉiboÙ_šfo_t
 *
mbi_Şd
)

61 
muÉiboÙ_šfo_t
 *
mbi
 = 
	`»loc_mbi_¡ruù
(
mbi_Şd
, (*mbi));

62 
i
;

64 iàĞ
mbi
->
æags
 & 
MBI_CMDLINE
 )

65 
mbi
->
cmdlše
 = (
u32
)
	`»loc_mbi_¡ršg
((*)mbi->cmdline);

67 iàĞ
mbi
->
æags
 & 
MBI_MODULES
 )

69 
moduË_t
 *
mods
 = 
	`»loc_mbi_¡ruù
(

70 (
moduË_t
 *)
mbi
->
mods_addr
, mbi->
mods_couÁ
 * (module_t));

72 
mbi
->
mods_addr
 = (
u32
)
mods
;

74  
i
 = 0; i < 
mbi
->
mods_couÁ
; i++ )

76 iàĞ
mods
[
i
].
¡ršg
 )

77 
mods
[
i
].
¡ršg
 = (
u32
)
	`»loc_mbi_¡ršg
((*)mods[i].string);

81 iàĞ
mbi
->
æags
 & 
MBI_MEMMAP
 )

82 
mbi
->
mm­_addr
 = (
u32
)
	`»loc_mbi_¡ruù
(

83 (
memÜy_m­_t
 *)
mbi
->
mm­_addr
, mbi->
mm­_Ëngth
);

85 iàĞ
mbi
->
æags
 & 
MBI_LOADERNAME
 )

86 
mbi
->
boÙ_lßd”_Çme
 = (
u32
)
	`»loc_mbi_¡ršg
(

87 (*)
mbi
->
boÙ_lßd”_Çme
);

90 
mbi
->
æags
 &ğ(
MBI_MEMLIMITS
 |

91 
MBI_BOOTDEV
 |

92 
MBI_CMDLINE
 |

93 
MBI_MODULES
 |

94 
MBI_MEMMAP
 |

95 
MBI_LOADERNAME
);

97  
mbi
;

98 
	}
}

	@boot/video.h

1 #iâdeà
__BOOT_VIDEO_H__


2 
	#__BOOT_VIDEO_H__


	)

8 
	#VIDEO_FIRST_MENU
 0x0000

	)

11 
	#VIDEO_FIRST_VESA
 0x0200

	)

14 
	#VIDEO_FIRST_SPECIAL
 0x0f00

	)

15 
	#VIDEO_80x25
 0x0f00

	)

16 
	#VIDEO_80x50
 0x0f01

	)

17 
	#VIDEO_80x43
 0x0f02

	)

18 
	#VIDEO_80x28
 0x0f03

	)

19 
	#VIDEO_CURRENT_MODE
 0x0f04

	)

20 
	#VIDEO_80x30
 0x0f05

	)

21 
	#VIDEO_80x34
 0x0f06

	)

22 
	#VIDEO_80x60
 0x0f07

	)

23 
	#VIDEO_LAST_SPECIAL
 0x0f08

	)

25 
	#ASK_VGA
 0xfffd

	)

26 
	#VIDEO_VESA_BY_SIZE
 0xffff

	)

29 
	#VIDEO_RECALC
 0x8000

	)

	@bzimage.c

1 
	~<x’/ÿche.h
>

2 
	~<x’/”ºo.h
>

3 
	~<x’/lib.h
>

4 
	~<x’/mm.h
>

5 
	~<x’/¡ršg.h
>

6 
	~<x’/ty³s.h
>

7 
	~<x’/decom´ess.h
>

8 
	~<asm/bzimage.h
>

10 
	#HEAPORDER
 3

	)

12 *
	gwšdow
;

13 
	#mem±r
 

	)

14 
mem±r
 
	gä“_mem_±r
;

15 
mem±r
 
	gä“_mem_’d_±r
;

17 
	#WSIZE
 0x80000000

	)

19 *
	gšbuf
;

20 
	gšsize
;

23 
	gš±r
;

26 
	goutút
;

28 
	#OF
(
¬gs
è
	)
args

29 
	#STATIC
 

	)

31 
	#memz”o
(
s
, 
n
è
	`mem£t
((s), 0, (n))

	)

33 
	tuch
;

34 
	tush
;

35 
	tulg
;

37 
	#INIT
 
__š™


	)

39 
	#g‘_by‹
(è(
š±r
 < 
šsize
 ? 
šbuf
[š±r++] : 
	`fl_šbuf
())

	)

42 #ifdeà
DEBUG


43 
	#As£¹
(
cÚd
, 
msg
èdØ{ ià(!(cÚd)è
	`”rÜ
(msg); } 0)

	)

44 
	#T¿û
(
x
èdØ{ 
årštf
 x; } 0)

	)

45 
	#T¿ûv
(
x
èdØ{ ià(
v”bo£
è
årštf
 x ; } 0)

	)

46 
	#T¿ûvv
(
x
èdØ{ ià(
v”bo£
 > 1è
årštf
 x ; } 0)

	)

47 
	#T¿ûc
(
c
, 
x
èdØ{ ià(
v”bo£
 && (c)è
årštf
 x ; } 0)

	)

48 
	#T¿ûcv
(
c
, 
x
èdØ{ ià(
v”bo£
 > 1 && (c)è
årštf
 x ; } 0)

	)

50 
	#As£¹
(
cÚd
, 
msg
)

	)

51 
	#T¿û
(
x
)

	)

52 
	#T¿ûv
(
x
)

	)

53 
	#T¿ûvv
(
x
)

	)

54 
	#T¿ûc
(
c
, 
x
)

	)

55 
	#T¿ûcv
(
c
, 
x
)

	)

58 
	gby‹s_out
;

59 
æush_wšdow
();

61 
__š™
 
	$”rÜ
(*
x
)

63 
	`·nic
("%s\n", 
x
);

64 
	}
}

66 
__š™
 
	$fl_šbuf
()

68 
	`”rÜ
("ran out of input data");

70 
	}
}

73 
	~"../../commÚ/šæ©e.c
"

75 
__š™
 
	$æush_wšdow
()

81 
c
 = 
üc
;

82 
n
;

83 *
š
, 
ch
;

85 
š
 = 
wšdow
;

86  
n
 = 0;‚ < 
outút
;‚++ )

88 
ch
 = *
š
++;

89 
c
 = 
üc_32_b
[(()ø^ 
ch
) & 0xff] ^ (c >> 8);

91 
üc
 = 
c
;

93 
by‹s_out
 +ğ()
outút
;

94 
outút
 = 0;

95 
	}
}

97 
__š™
 
	$ouut_Ëngth
(*
image
, 
image_Ën
)

99  *(
ušt32_t
 *)&
image
[
image_Ën
 - 4];

100 
	}
}

102 
__š™
 
	$gz_check
(*
image
, 
image_Ën
)

104 
magic0
, 
magic1
;

106 iàĞ
image_Ën
 < 2 )

109 
magic0
 = ()
image
[0];

110 
magic1
 = ()
image
[1];

112  (
magic0
 =ğ0x1fè&& ((
magic1
 == 0x8b) || (magic1 == 0x9e));

113 
	}
}

115 
__š™
 
	$³rfÜm_gunz
(*
ouut
, *
image
, 
image_Ën
)

117 
rc
;

119 iàĞ!
	`gz_check
(
image
, 
image_Ën
) )

122 
wšdow
 = (*)
ouut
;

124 
ä“_mem_±r
 = ()
	`®loc_x’h—p_·ges
(
HEAPORDER
, 0);

125 
ä“_mem_’d_±r
 = 
ä“_mem_±r
 + (
PAGE_SIZE
 << 
HEAPORDER
);

127 
šbuf
 = (*)
image
;

128 
šsize
 = 
image_Ën
;

129 
š±r
 = 0;

131 
	`makeüc
();

133 iàĞ
	`gunz
() < 0 )

135 
rc
 = -
EINVAL
;

139 
rc
 = 0;

142 
	`ä“_x’h—p_·ges
((*)
ä“_mem_±r
, 
HEAPORDER
);

144  
rc
;

145 
	}
}

147 
	s£tup_h—d”
 {

148 
ušt8_t
 
	m_·d0
[0x1f1];

149 
ušt8_t
 
	m£tup_£ùs
;

150 
ušt16_t
 
	mroÙ_æags
;

151 
ušt32_t
 
	msyssize
;

152 
ušt16_t
 
	m¿m_size
;

153 
ušt16_t
 
	mvid_mode
;

154 
ušt16_t
 
	mroÙ_dev
;

155 
ušt16_t
 
	mboÙ_æag
;

156 
ušt16_t
 
	mjump
;

157 
ušt32_t
 
	mh—d”
;

158 
	#HDR_MAGIC
 "HdrS"

	)

159 
	#HDR_MAGIC_SZ
 4

	)

160 
ušt16_t
 
	mv”siÚ
;

161 
	#VERSION
(
h
,
l
è(((h)<<8è| (l))

	)

162 
ušt32_t
 
	m»®mode_swtch
;

163 
ušt16_t
 
	m¡¬t_sys
;

164 
ušt16_t
 
	mk”Ãl_v”siÚ
;

165 
ušt8_t
 
	mty³_of_lßd”
;

166 
ušt8_t
 
	mlßdæags
;

167 
ušt16_t
 
	m£tup_move_size
;

168 
ušt32_t
 
	mcode32_¡¬t
;

169 
ušt32_t
 
	m¿mdisk_image
;

170 
ušt32_t
 
	m¿mdisk_size
;

171 
ušt32_t
 
	mboÙ£ù_kludge
;

172 
ušt16_t
 
	mh—p_’d_±r
;

173 
ušt16_t
 
	m_·d1
;

174 
ušt32_t
 
	mcmd_lše_±r
;

175 
ušt32_t
 
	mš™rd_addr_max
;

176 
ušt32_t
 
	mk”Ãl_®ignm’t
;

177 
ušt8_t
 
	m»loÿbË_k”Ãl
;

178 
ušt8_t
 
	m_·d2
[3];

179 
ušt32_t
 
	mcmdlše_size
;

180 
ušt32_t
 
	mh¬dw¬e_sub¬ch
;

181 
ušt64_t
 
	mh¬dw¬e_sub¬ch_d©a
;

182 
ušt32_t
 
	m·ylßd_off£t
;

183 
ušt32_t
 
	m·ylßd_Ëngth
;

184 } 
__©Œibu‹__
((
·cked
));

186 
__š™
 
	$bzimage_check
(
£tup_h—d”
 *
hdr
, 
Ën
)

188 iàĞ
Ën
 < (
£tup_h—d”
) )

191 iàĞ
	`memcmp
(&
hdr
->
h—d”
, 
HDR_MAGIC
, 
HDR_MAGIC_SZ
) != 0 )

194 iàĞ
hdr
->
v”siÚ
 < 
	`VERSION
(2,8) ) {

195 
	`´štk
("Cannot†oad bzImage v%d.%02d‡t†east v2.08 is„equired\n",

196 
hdr
->
v”siÚ
 >> 8, hdr->version & 0xff);

197  -
EINVAL
;

200 
	}
}

202 
__š™
 
	$bzimage_h—droom
(*
image_¡¬t
, 
image_Ëngth
)

204 
£tup_h—d”
 *
hdr
 = (£tup_h—d” *)
image_¡¬t
;

205 *
img
;

206 
”r
, 
h—droom
;

208 
”r
 = 
	`bzimage_check
(
hdr
, 
image_Ëngth
);

209 ià(
”r
 < 1)

212 
img
 = 
image_¡¬t
 + (
hdr
->
£tup_£ùs
+1) * 512;

213 
img
 +ğ
hdr
->
·ylßd_off£t
;

215 
h—droom
 = 
	`ouut_Ëngth
(
img
, 
hdr
->
·ylßd_Ëngth
);

216 ià(
	`gz_check
(
img
, 
hdr
->
·ylßd_Ëngth
)) {

217 
h—droom
 += headroom >> 12;

218 
h—droom
 += (32768 + 18);

220 
h—droom
 +ğ
hdr
->
·ylßd_Ëngth
;

221 
h—droom
 = (headroom + 4095) & ~4095;

223  
h—droom
;

224 
	}
}

226 
__š™
 
	$bzimage_·r£
(*
image_ba£
, **
image_¡¬t
, *
image_Ën
)

228 
£tup_h—d”
 *
hdr
 = (£tup_h—d” *)(*
image_¡¬t
);

229 
”r
 = 
	`bzimage_check
(
hdr
, *
image_Ën
);

230 
ouut_Ën
;

232 ià(
”r
 < 1)

233  
”r
;

235 
	`BUG_ON
(!(
image_ba£
 < *
image_¡¬t
));

237 *
image_¡¬t
 +ğ(
hdr
->
£tup_£ùs
+1) * 512;

238 *
image_¡¬t
 +ğ
hdr
->
·ylßd_off£t
;

239 *
image_Ën
 = 
hdr
->
·ylßd_Ëngth
;

240 
ouut_Ën
 = 
	`ouut_Ëngth
(*
image_¡¬t
, *
image_Ën
);

242 iàĞ(
”r
 = 
	`³rfÜm_gunz
(
image_ba£
, *
image_¡¬t
, *
image_Ën
)) > 0 )

243 
”r
 = 
	`decom´ess
(*
image_¡¬t
, *
image_Ën
, 
image_ba£
);

245 iàĞ!
”r
 )

247 *
image_¡¬t
 = 
image_ba£
;

248 *
image_Ën
 = 
ouut_Ën
;

251  
”r
 > 0 ? 0 :ƒrr;

252 
	}
}

	@clock.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_CLOCK


26 
	$do_şock
(
ev’t_Ä
, 
·ge_dœ
 *
pgd
, 
s_time_t
 
now
)

28 
	`MYASSERT
(
pgd
==
cu¼’t
->
cu¼’t_pgd
);

31 
s_time_t
 
diff
 = (
pgd
->
şock_»sidue
 + 
now
 -…gd->
şock_´ev_now
);

32 ià(
now
 < 
pgd
->
şock_´ev_now
) {

33 
diff
 = 
pgd
->
şock_»sidue
;

35 
pgd
->
şock_´ev_now
 = 
now
;

37 ià(
diff
 < 
	`MILLISECS
(
şock_³riod_ms
))

39 
pgd
->
şock_»sidue
 = 
diff
;

43 #ifdeà
ENABLE_REGIONING2


44 ià(!(
pgd
->
cu¼’t_»giÚ
 &&…gd->
»giÚšg_ıu
 =ğ
	`smp_´oûssÜ_id
()))

47 #ifdeà
ENABLE_TIMESTAMP


48 
	`time¡amp_¡¬t
(
TIMESTAMP_CLEAR_ABIT
);

50 
pgd
->
şock_»sidue
 = 0;

53 
	`my´štk
("pgdmâ:%x (%dÃwü3/%dtick/%dsched/%4Îdmsè", 
pgd
->
±
->
mâ
,…gd->
şock_ü3_chªges
,…gd->
şock_tim”
,…gd->
şock_scheduË
, 
diff
/1000000ULL);

54 
	`´št_İ’b™_couÁ
(
pgd
);

55 
	`´štk
("\n");

57 #ifdeà
ENABLE_ABIT


58 
	`ş—r_ab™
(
pgd
, 
now
);

60 
pgd
->
şock_ü3_chªges
 = 0;

61 
pgd
->
şock_tim”
 = 0;

62 
pgd
->
şock_scheduË
 = 0;

64 #ifdeà
ENABLE_TIMESTAMP


65 
	`time¡amp
(
TIMESTAMP_CLEAR_ABIT
, 1);

66 
	`time¡amp_’d
(
TIMESTAMP_CLEAR_ABIT
, 2);

71 ià(
ev’t_Ä
 =ğ
CLOCK_EVENT_NEW_CR3
) {

72 
pgd
->
şock_ü3_chªges
++;

73 #ifdeà
ENABLE_REGIONING2


74 ià(
pgd
->
cu¼’t_»giÚ
) {

76 
	`»giÚšg_·u£
(
CLOCK_EVENT_NEW_CR3
, 
now
);

79 } ià(
ev’t_Ä
 =ğ
CLOCK_EVENT_TIMER
) {

80 
pgd
->
şock_tim”
++;

81 #ifdeà
ENABLE_REGIONING2


82 
	`»giÚšg_—ch_tick
(
pgd
);

83 
	`»giÚšg_ş—n_·u£s
(
now
);

85 } ià(
ev’t_Ä
 =ğ
CLOCK_EVENT_SCHEDULE
) {

86 
pgd
->
şock_scheduË
++;

87 #ifdeà
ENABLE_REGIONING2


88 ià(
pgd
->
cu¼’t_»giÚ
) {

90 
	`»giÚšg_·u£
(
CLOCK_EVENT_SCHEDULE
, 
now
);

94 
	`my·nic
("Unknown clockƒvent?");

96 
	}
}

99 #ifdeà
ENABLE_BITMAP_BASIC


101 
	$şo£_b™m­
(
·ge_bË
 *
±
, 
±šdex
, 
de¡_ÿche
)

103 
Şd
;

104 #ifdeà
DEBUG_ASSERT


105 #ifdeà
ENABLE_BITMAP_VRT


106 ià(
±šdex
 > 
L4_PAGETABLE_ENTRIES
)

107 
	`my·nic
("close_bitmap:pti>L4_PAGETABLE_ENTRIES");

108 ià(
de¡_ÿche
 >ğ
MAX_CACHE
)

109 
	`my·nic
("close_bitmap:dest_cache >= MAX_CACHE");

110 ià(
de¡_ÿche
 < -1)

111 
	`my·nic
("close_bitmap:dest_cache<-1");

113 
	`MYASSERT
(
de¡_ÿche
 == -1);

117 
	`MYASSERT
(
±
->
Ëv–
 == 1);

119 
Şd
 = 
	`‹¡_ªd_ş—r_b™
(
±šdex
, ((
l1e_¡ruù
 *)
±
->
aux
)->
b™m­
[
de¡_ÿche
+1]);

121 
	`MYASSERT
(
Şd
 && "close_bitmap():‡lready clear??");

122 #ifdeà
VERBOSE_BITMAP_CHANGE


123 
	`my´štk
("$%d,…g:%x(%dè±:%x(%d)\n", 
de¡_ÿche
, 
±
->
pgd
->
mâ
,…t->
up_šdex
,…t->mâ, 
±šdex
 );

125 
	}
}

128 
	$İ’_b™m­
(
·ge_bË
 *
±
, 
±šdex
, 
de¡_ÿche
)

130 
Şd
;

131 #ifdeà
DEBUG_ASSERT


132 #ifdeà
ENABLE_BITMAP_VRT


133 ià(
±šdex
 > 
L4_PAGETABLE_ENTRIES
)

134 
	`my·nic
("open_bitmap:pti>L4_PAGETABLE_ENTEIES");

135 ià(
de¡_ÿche
 >ğ
MAX_CACHE
)

136 
	`my·nic
("open_bitmap:dest_cache>=MAX_CACHE");

137 ià(
de¡_ÿche
 < -1)

138 
	`my·nic
("open_bitmap:dest_cache<-1");

139 
	`MYASSERT
(
±
->
Ëv–
 == 1);

141 
	`MYASSERT
(
de¡_ÿche
 == -1);

146 
Şd
 = 
	`‹¡_ªd_£t_b™
(
±šdex
, ((
l1e_¡ruù
 *)
±
->
aux
)->
b™m­
[
de¡_ÿche
+1]);

148 
	`MYASSERT
(!
Şd
 && "open_bitmap():‡lready open??");

149 #ifdeà
VERBOSE_BITMAP_CHANGE


150 
	`my´štk
("$%d,…g:%x(%dè±:%x(%d)\n", 
de¡_ÿche
, 
±
->
pgd
->
mâ
,…t->
up_šdex
,…t->mâ, 
±šdex
);

152 
	}
}

155 
	$‹¡_b™m­
(
·ge_bË
 *
±
, 
±šdex
, 
de¡_ÿche
)

157 
	`MYASSERT
(
±
->
Ëv–
 == 1);

159  
	`‹¡_b™
(
±šdex
, ((
l1e_¡ruù
 *)
±
->
aux
)->
b™m­
[
de¡_ÿche
+1]);

160 
	}
}

162 #ifdeà
DEBUG_CHECK_BITMAP


163 
	g·nic_couÁ
 = 20;

167 
	$check_±_b™m­
(
·ge_bË
 *
±
, 
pgd_mâ
, 
loc
)

169 
ÿche
 = 
±
->cache;

170 
l1_pg’Œy_t
 *
l1t
;

171 
l1t
 = 
	`m­_domaš_·ge
(
±
->
mâ
);

172 
i
, 
couÁ
 = 0;

174  
i
=0;i<1024;i++) {

175 iàĞ
	`‹¡_b™m­
(
±
, 
i
, 
ÿche
) ) {

176 
couÁ
++;

177 ià(!
	`l1e_is_İ’
(
l1t
[
i
])) {

178 
	`my´štk
("NÚ´e£Á o¸şo£d(should bİ’è" "pgdmâ=%x,…tmâ=%x$%d,…gdi=%d,…‹i=%d,l1e=%x,†oc=%d, in™=%d\n", 
pgd_mâ
, 
±
->
mâ
, 
ÿche
,…t->
pgd_šdex
, 
i
, 
l1t
[i], 
loc
,…t->
š™
);

179 
·nic_couÁ
--;

180 ià(
·nic_couÁ
 < 0)

181 
	`my·nic
("check_bitmap()");

184 ià(
	`l1e_is_İ’
(
l1t
[
i
])) {

185 
	`my´štk
("O³n(should bnÙ-İ’è" "pgdmâ=%x,…tmâ=%x$%d,…gdi=%d,…‹i=%d,l1e=%x,†oc=%d, in™=%d\n", 
pgd_mâ
, 
±
->
mâ
, 
ÿche
,…t->
pgd_šdex
, 
i
, 
l1t
[i], 
loc
,…t->
š™
);

186 
·nic_couÁ
--;

187 ià(
·nic_couÁ
 < 0)

188 
	`my·nic
("check_bitmap()");

192 
	`unm­_domaš_·ge
(
l1t
);

193  
couÁ
;

194 
	}
}

197 
	$check_b™m­
(
·ge_dœ
 *
pgd
è{
	}
}

200 
	$´št_b™m­
(
·ge_dœ
 *
pgd
)

202 #ifdeà
VERBOSE_BITMAP_PRINT


203 
TODO
: 
»v›w


204 
·ge_bË
 *
±
;

205 
buff
[1024];

206 
ÿche
,
Ën
,
i
;

207 ià(!
pgd
)

208 
	`my·nic
("pgd==0??");

209 
ÿche
=0;ÿche<
MAX_CACHE
;cache++) {

210 
	`my´štk
("");

211 
	`´št_İ’b™_couÁ
(
pgd
);

212 
	`´štk
("$%d ", 
ÿche
);

213 
	`li¡_fÜ_—ch_’Œy
(
±
, &
pgd
->
±_li¡
, 
li¡
) {

215 
Ën
 = 
	`b™m­_sú´štf
(
buff
, 1024, 
±
->
b™m­_İ’
[
ÿche
] , 1024);

216 
i
=0;i<
Ën
;i++)

217 ià(
buff
[
i
] == '0')

218 
buff
[
i
] = '.';

219 
buff
[
Ën
] = 0;

220 
	`´štk
("up_šdex:%3d % ", 
±
->
up_šdex
, 
buff
);

222 
	`´štk
("\n");

225 
	}
}

228 #ifdeà
ENABLE_ABIT


229 
DEFINE_PER_CPU
([
BITS_TO_LONGS
(
L4_PAGETABLE_ENTRIES
)], 
ab™s
);

231 #ià
defšed
(
ENABLE_BITMAP_VRT
)

232 
	#BITMAP_INDEX
 (
ÿche
+1)

	)

233 #–ià
defšed
(
ENABLE_BITMAP_BASIC
)

234 
	#BITMAP_INDEX
 (0)

	)

236 #”rÜ 
b™m­_basic
 
Ü
 
b™m­_v¹
 ?

239 
	$ş—r_ab™_Ëaf
(
·ge_bË
 *
±
, 
s_time_t
 
now
)

241 
couÁ
 = 0;

242 
ÿche
;

243 
l1_pg’Œy_t
 *
l1t
;

244 
pos
;

246 
l1e_¡ruù
 *
aux
 = 
±
->aux;

247 
	`MYASSERT
(
aux
);

249 (*
ab™s
)[
	`BITS_TO_LONGS
(
L4_PAGETABLE_ENTRIES
)];

250 
ab™s
 = &(
	`³r_ıu
×b™s, 
	`smp_´oûssÜ_id
()));

251 
	`mem£t
(
ab™s
, 0, (*abits));

252 
ÿche
 = 0; cach< 
max_ÿche
; cache++) {

253 
l1t
 = 
±
->
shadow
[
ÿche
];

254  
pos
 = 
	`fšd_fœ¡_b™
(
aux
->
b™m­
[
BITMAP_INDEX
], 
L4_PAGETABLE_ENTRIES
);

255 
pos
 < 
L4_PAGETABLE_ENTRIES
;

256 
pos
 = 
	`fšd_Ãxt_b™
(
aux
->
b™m­
[
BITMAP_INDEX
], 
L4_PAGETABLE_ENTRIES
,…os+1) )

258 ià(
	`uÆik–y
(
	`‹¡_ªd_ş—r_b™
Ğ5, &
l1t
[
pos
].
l1
))) {

259 
	`£t_b™
(
pos
, 
ab™s
);

263 #ifdeà
ENABLE_HETERO


265 
l1t
 = 
	`mâ_to_vœt
(
±
->
mâ
);

269 
mâ
;

270  
pos
 = 
	`fšd_fœ¡_b™
(
aux
->
b™m­
[0], 
L4_PAGETABLE_ENTRIES
);

271 
pos
 < 
L4_PAGETABLE_ENTRIES
;

272 
pos
 = 
	`fšd_Ãxt_b™
(
aux
->
b™m­
[0], 
L4_PAGETABLE_ENTRIES
,…os+1) )

274 
mâ
 = 
	`l1e_g‘_pâ
(
l1t
[
pos
]);

275 #ifdeà
ENABLE_HOT_PAGES


276 
hÙÃss_´ev
 = 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
));

278 ià(
	`‹¡_b™
(
pos
, 
ab™s
)) {

279 
couÁ
++;

280 #ifdeà
ENABLE_HISTOGRAM


282 
b™s
 = 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
));

283 ià(!(
	`FTABLE_ABIT
(
mâ
) & 1UL)) {

284 #ifdeà
DEBUG_ASSERT


285 ià(
b™s
==32è
	`my·nic
("can't be 32!\n");

287 
	`vr_move_d’s™y
(
vr
, 
d’s™y
, d’s™y+1, 
ÿche
);

290 
	`FTABLE_ABIT
(
mâ
) >>= 1;

291 
	`FTABLE_ABIT
(
mâ
) |= (1UL<<31);

304 #ifdeà
ENABLE_HISTOGRAM


310 #ifdeà
ENABLE_HISTOGRAM


312 
b™s
 = 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
));

313 ià((
	`FTABLE_ABIT
(
mâ
) & 1UL)) {

314 #ifdeà
DEBUG_ASSERT


315 ià(!
b™s
è
	`my·nic
("can't be zero!\n");

317 
	`vr_move_d’s™y
(
vr
, 
d’s™y
, d’s™y-1, 
ÿche
);

320 
	`FTABLE_ABIT
(
mâ
) >>= 1;

322 #ifdeà
ENABLE_HISTOGRAM


327 
	`FTABLE_TIME
(
mâ
èğ(
now
 >> 20);

333 #ifdeà
ENABLE_HOT_PAGES


334 
	#THRESHOLD_HOT
 22

	)

335 
hÙÃss
 = 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
));

336 ià(
hÙÃss_´ev
 < 
THRESHOLD_HOT
 && 
hÙÃss
 >= THRESHOLD_HOT) {

337 
	`v¹_£t
(
mâ
, 
£ed_u£r_hÙ
, 
VRT_SET_LOCK_SYNC
 | 
VRT_SET_MAYBE_SAME
);

341  
couÁ
;

342 
	}
}

344 
	$ş—r_ab™_±
(
·ge_bË
 *
up_±
, 
s_time_t
 
now
)

346 
couÁ
 = 0;

347 
·ge_bË
 *
±
;

349 
	`li¡_fÜ_—ch_’Œy
(
±
, &
up_±
->
±_li¡
, 
li¡
) {

351 
	`my¥š_lock_±
(
±
, 124);

352 ià(
±
->
Ëv–
 == 1) {

353 
couÁ
 +ğ
	`ş—r_ab™_Ëaf
(
±
, 
now
);

355 
couÁ
 +ğ
	`ş—r_ab™_±
(
±
, 
now
);

357 
	`¥š_uÆock_±
(
±
, 124);

359  
couÁ
;

360 
	}
}

362 
	$´štx_ab™_Ëaf
(
·ge_bË
 *
±
)

364 
couÁ
 = 0;

365 
l1_pg’Œy_t
 *
l1t
;

366 
pos
;

367 
mâ
;

368 
l1e_¡ruù
 *
aux
 = 
±
->aux;

369 
	`MYASSERT
(
aux
);

371 
l1t
 = 
±
->
shadow
[0];

372  
pos
 = 
	`fšd_fœ¡_b™
(
aux
->
b™m­
[
BITMAP_INDEX
], 
L4_PAGETABLE_ENTRIES
);

373 
pos
 < 
L4_PAGETABLE_ENTRIES
;

374 
pos
 = 
	`fšd_Ãxt_b™
(
aux
->
b™m­
[
BITMAP_INDEX
], 
L4_PAGETABLE_ENTRIES
,…os+1) )

376 
mâ
 = 
	`l1e_g‘_pâ
(
l1t
[
pos
]);

377 
	`TRACE_2D
(
TRC_MIN_ABIT
, 
pos
, 
	`FTABLE_ABIT
(
mâ
) );

379 
couÁ
++;

381  
couÁ
;

382 
	}
}

384 
	$´štx_ab™_±
(
·ge_bË
 *
up_±
)

386 
couÁ
 = 0;

387 
·ge_bË
 *
±
;

389 
	`li¡_fÜ_—ch_’Œy
(
±
, &
up_±
->
±_li¡
, 
li¡
) {

391 
	`TRACE_4D
(
TRC_MIN_ABIT_PT
, 
±
->
mâ
,…t->
Ëv–
,…t->
up_±
->mâ,…t->
up_šdex
);

392 
	`my¥š_lock_±
(
±
, 169);

393 ià(
±
->
Ëv–
 == 1) {

394 
couÁ
 +ğ
	`´štx_ab™_Ëaf
(
±
);

396 
couÁ
 +ğ
	`´štx_ab™_±
(
±
);

398 
	`¥š_uÆock_±
(
±
, 169);

400  
couÁ
;

401 
	}
}

403 
	$ş—r_ab™
(
·ge_dœ
 *
pgd
, 
s_time_t
 
now
)

405 
couÁ
;

406 
	`MYASSERT
(!
	`‹¡_b™
(
PGD_KERNEL
, &
pgd
->
æag
));

408 
pgd
->
ş—r_ab™_couÁ
++;

409 ià(
pgd
->
ş—r_ab™_couÁ
 >= 32) {

411 
now_ms
 = 
now
/1000000ULL;

412 
couÁ
;

413 
pgd
->
ş—r_ab™_couÁ
 = 0;

415 ià((
TRC_MIN_ABIT
 & 
TRC_ALL
è=ğ
TRC_MIN
) {

416 
	`TRACE_2D
(
TRC_MIN_ABIT_PGD
, 
now_ms
, 
pgd
->
±
->
mâ
);

417 
	`TRACE_4D
(
TRC_MIN_ABIT_PT
, 
pgd
->
±
->
mâ
,…gd->±->
Ëv–
, -1,…gd->±->
up_šdex
);

418 
couÁ
 = 
	`´štx_ab™_±
(
pgd
->
±
);

419 
	`my´štk
("pgdmâ:%x ,¿û ouuˆ%d‡b™s..\n", 
pgd
->
±
->
mâ
, 
couÁ
);

424 
couÁ
 = 
	`ş—r_ab™_±
(
pgd
->
±
, 
now
);

425 
pcouÁ
[
COUNT_CLEAR_ABIT
]++;

426 #ifdeà
VERBOSE_CLOCK


427 
	`my´štk
("pgdmâ:%x , %d…age gÙ‡-b™ s‘\n", 
pgd
->
±
->
mâ
, 
couÁ
);

430 
	`æush_b_loÿl
();

431 
	}
}

	@compat.c

8 
	~<x’/cÚfig.h
>

9 
	~<x’/gue¡_acûss.h
>

10 
	~<x’/hy³rÿÎ.h
>

12 #iâdeà
COMPAT


13 
	t»t_t
;

17 
»t_t
 
do_physdev_İ_com·t
(
	$XEN_GUEST_HANDLE
(
physdev_İ_t
è
uİ
)

19 
physdev_İ
 
İ
;

21 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡
(&
İ
, 
uİ
, 1) != 0) )

22  -
EFAULT
;

24  
	`do_physdev_İ
(
İ
.
cmd
, 
	`gue¡_hªdË_äom_±r
(&
uİ
.
p
->
u
, ));

25 
	}
}

27 #iâdeà
COMPAT


30 
do_ev’t_chªÃl_İ_com·t
(
	$XEN_GUEST_HANDLE
(
evtchn_İ_t
è
uİ
)

32 
evtchn_İ
 
İ
;

34 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡
(&
İ
, 
uİ
, 1) != 0) )

35  -
EFAULT
;

37  
	`do_ev’t_chªÃl_İ
(
İ
.
cmd
, 
	`gue¡_hªdË_äom_±r
(&
uİ
.
p
->
u
, ));

38 
	}
}

	@cpu/amd.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/b™İs.h
>

4 
	~<x’/mm.h
>

5 
	~<x’/smp.h
>

6 
	~<x’/pci.h
>

7 
	~<asm/io.h
>

8 
	~<asm/m¤.h
>

9 
	~<asm/´oûssÜ.h
>

10 
	~<asm/amd.h
>

11 
	~<asm/hvm/suµÜt.h
>

12 
	~<asm/£tup.h
>

13 
	~<asm/aıi.h
>

15 
	~"ıu.h
"

32 
	gİt_çm»v
[14];

33 
¡ršg_·¿m
("ıuid_mask_ıu", 
İt_çm»v
);

35 
šlše
 
	$wrm¤_amd
(
šdex
, 
lo
,

36 
hi
)

38 
asm
 volatile (

41 : "c" (
šdex
), "a" (
lo
),

42 "d" (
hi
), "D" (0x9c5a203a)

44 
	}
}

46 
šlše
 
	$rdm¤_amd_§ã
(
m¤
, *
lo
,

47 *
hi
)

49 
”r
;

51 
asm
 volatile("1:„dmsr\n2:\n"

56 
	`_ASM_EXTABLE
(1b, 3b)

57 : "÷" (*
lo
), "=d" (*
hi
), "ô" (
”r
)

58 : "c" (
m¤
), "D" (0x9c5a203a), "2" (0), "i" (-
EFAULT
));

60  
”r
;

61 
	}
}

63 
šlše
 
	$wrm¤_amd_§ã
(
m¤
, 
lo
,

64 
hi
)

66 
”r
;

68 
asm
 volatile("1: wrmsr\n2:\n"

73 
	`_ASM_EXTABLE
(1b, 3b)

74 : "ô" (
”r
)

75 : "c" (
m¤
), "a" (
lo
), "d" (
hi
), "D" (0x9c5a203a),

76 "0" (0), "i" (-
EFAULT
));

78  
”r
;

79 
	}
}

90 
__devš™
 
	$£t_ıuidmask
(cÚ¡ 
ıušfo_x86
 *
c
)

92 
ã©_ecx
, 
ã©_edx
;

93 
extã©_ecx
, 
extã©_edx
;

94 ’um { 
nÙ_·r£d
, 
no_mask
, 
£t_mask
 } 
¡©us
;

96 ià(
¡©us
 =ğ
no_mask
)

99 ià(
¡©us
 =ğ
£t_mask
)

100 
£tmask
;

102 
	`ASSERT
((
¡©us
 =ğ
nÙ_·r£d
è&& (
	`smp_´oûssÜ_id
() == 0));

103 
¡©us
 = 
no_mask
;

105 ià(~(
İt_ıuid_mask_ecx
 & 
İt_ıuid_mask_edx
 &

106 
İt_ıuid_mask_ext_ecx
 & 
İt_ıuid_mask_ext_edx
)) {

107 
ã©_ecx
 = 
İt_ıuid_mask_ecx
;

108 
ã©_edx
 = 
İt_ıuid_mask_edx
;

109 
extã©_ecx
 = 
İt_ıuid_mask_ext_ecx
;

110 
extã©_edx
 = 
İt_ıuid_mask_ext_edx
;

111 } ià(*
İt_çm»v
 == '\0') {

113 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_0f_rev_c")) {

114 
ã©_ecx
 = 
AMD_FEATURES_K8_REV_C_ECX
;

115 
ã©_edx
 = 
AMD_FEATURES_K8_REV_C_EDX
;

116 
extã©_ecx
 = 
AMD_EXTFEATURES_K8_REV_C_ECX
;

117 
extã©_edx
 = 
AMD_EXTFEATURES_K8_REV_C_EDX
;

118 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_0f_rev_d")) {

119 
ã©_ecx
 = 
AMD_FEATURES_K8_REV_D_ECX
;

120 
ã©_edx
 = 
AMD_FEATURES_K8_REV_D_EDX
;

121 
extã©_ecx
 = 
AMD_EXTFEATURES_K8_REV_D_ECX
;

122 
extã©_edx
 = 
AMD_EXTFEATURES_K8_REV_D_EDX
;

123 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_0f_rev_e")) {

124 
ã©_ecx
 = 
AMD_FEATURES_K8_REV_E_ECX
;

125 
ã©_edx
 = 
AMD_FEATURES_K8_REV_E_EDX
;

126 
extã©_ecx
 = 
AMD_EXTFEATURES_K8_REV_E_ECX
;

127 
extã©_edx
 = 
AMD_EXTFEATURES_K8_REV_E_EDX
;

128 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_0f_rev_f")) {

129 
ã©_ecx
 = 
AMD_FEATURES_K8_REV_F_ECX
;

130 
ã©_edx
 = 
AMD_FEATURES_K8_REV_F_EDX
;

131 
extã©_ecx
 = 
AMD_EXTFEATURES_K8_REV_F_ECX
;

132 
extã©_edx
 = 
AMD_EXTFEATURES_K8_REV_F_EDX
;

133 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_0f_rev_g")) {

134 
ã©_ecx
 = 
AMD_FEATURES_K8_REV_G_ECX
;

135 
ã©_edx
 = 
AMD_FEATURES_K8_REV_G_EDX
;

136 
extã©_ecx
 = 
AMD_EXTFEATURES_K8_REV_G_ECX
;

137 
extã©_edx
 = 
AMD_EXTFEATURES_K8_REV_G_EDX
;

138 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_10_rev_b")) {

139 
ã©_ecx
 = 
AMD_FEATURES_FAM10h_REV_B_ECX
;

140 
ã©_edx
 = 
AMD_FEATURES_FAM10h_REV_B_EDX
;

141 
extã©_ecx
 = 
AMD_EXTFEATURES_FAM10h_REV_B_ECX
;

142 
extã©_edx
 = 
AMD_EXTFEATURES_FAM10h_REV_B_EDX
;

143 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_10_rev_c")) {

144 
ã©_ecx
 = 
AMD_FEATURES_FAM10h_REV_C_ECX
;

145 
ã©_edx
 = 
AMD_FEATURES_FAM10h_REV_C_EDX
;

146 
extã©_ecx
 = 
AMD_EXTFEATURES_FAM10h_REV_C_ECX
;

147 
extã©_edx
 = 
AMD_EXTFEATURES_FAM10h_REV_C_EDX
;

148 } ià(!
	`¡rcmp
(
İt_çm»v
, "fam_11_rev_b")) {

149 
ã©_ecx
 = 
AMD_FEATURES_FAM11h_REV_B_ECX
;

150 
ã©_edx
 = 
AMD_FEATURES_FAM11h_REV_B_EDX
;

151 
extã©_ecx
 = 
AMD_EXTFEATURES_FAM11h_REV_B_ECX
;

152 
extã©_edx
 = 
AMD_EXTFEATURES_FAM11h_REV_B_EDX
;

154 
	`´štk
("Inv®id…roûssÜ sŒšg: %s\n", 
İt_çm»v
);

155 
	`´štk
("CPUID will‚ot be masked\n");

162 
ã©_ecx
 &ğ
	`ıuid_ecx
(0x00000001);

163 
ã©_edx
 &ğ
	`ıuid_edx
(0x00000001);

164 
extã©_ecx
 &ğ
	`ıuid_ecx
(0x80000001);

165 
extã©_edx
 &ğ
	`ıuid_edx
(0x80000001);

167 
¡©us
 = 
£t_mask
;

168 
	`´štk
("Writing CPUID feature mask ECX:EDX -> %08Xh:%08Xh\n",

169 
ã©_ecx
, 
ã©_edx
);

170 
	`´štk
("Writing CPUIDƒxtended feature mask ECX:EDX -> %08Xh:%08Xh\n",

171 
extã©_ecx
, 
extã©_edx
);

173 
£tmask
:

176 ià(
c
->
x86
 >= 0x10) {

177 
	`wrm¤
(
MSR_K8_FEATURE_MASK
, 
ã©_edx
, 
ã©_ecx
);

178 
	`wrm¤
(
MSR_K8_EXT_FEATURE_MASK
, 
extã©_edx
, 
extã©_ecx
);

179 } ià(
c
->
x86
 == 0x0f) {

180 
	`wrm¤_amd
(
MSR_K8_FEATURE_MASK
, 
ã©_edx
, 
ã©_ecx
);

181 
	`wrm¤_amd
(
MSR_K8_EXT_FEATURE_MASK
, 
extã©_edx
, 
extã©_ecx
);

183 
	}
}

189 
	$ıu_has_amd_”¿tum
(cÚ¡ 
ıušfo_x86
 *
ıu
, 
osvw
, ...)

191 
va_li¡
 
­
;

192 
u32
 
¿nge
;

193 
u32
 
ms
;

195 ià(
ıu
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

198 
	`va_¡¬t
(
­
, 
osvw
);

200 ià(
osvw
) {

201 
u16
 
osvw_id
 = 
	`va_¬g
(
­
, );

203 ià(
	`ıu_has
(
ıu
, 
X86_FEATURE_OSVW
)) {

204 
u64
 
osvw_Ën
;

205 
	`rdm¤l
(
MSR_AMD_OSVW_ID_LENGTH
, 
osvw_Ën
);

207 ià(
osvw_id
 < 
osvw_Ën
) {

208 
u64
 
osvw_b™s
;

209 
	`rdm¤l
(
MSR_AMD_OSVW_STATUS
 + (
osvw_id
 >> 6),

210 
osvw_b™s
);

212 
	`va_’d
(
­
);

213  (
osvw_b™s
 >> (
osvw_id
 & 0x3f)) & 0x01;

219 
ms
 = (
ıu
->
x86_mod–
 << 8è| cpu->
x86_mask
;

220 (
¿nge
 = 
	`va_¬g
(
­
, ))) {

221 ià((
ıu
->
x86
 =ğ
	`AMD_MODEL_RANGE_FAMILY
(
¿nge
)) &&

222 (
ms
 >ğ
	`AMD_MODEL_RANGE_START
(
¿nge
)) &&

223 (
ms
 <ğ
	`AMD_MODEL_RANGE_END
(
¿nge
))) {

224 
	`va_’d
(
­
);

229 
	`va_’d
(
­
);

231 
	}
}

233 
	#num_phy¥ages
 0

	)

248 
vide
();

249 
__asm__
(".text\n.align 4\nvide:„et");

252 
	$c1_¿mpšg_may_ÿu£_şock_driá
(
ıušfo_x86
 *
c
)

254 ià(
c
->
x86
 < 0xf) {

261 } ià(
	`ıuid_edx
(0x80000007) & (1<<8)) {

271 
	}
}

277 
	$di§bË_c1_¿mpšg
()

279 
u8
 
pmm7
;

280 
node
, 
Ä_nodes
;

283 
Ä_nodes
 = ((
	`pci_cÚf_»ad32
(0, 0x18, 0x0, 0x60)>>4)&0x07)+1;

284 
node
 = 0;‚od< 
Ä_nodes
;‚ode++) {

286 
pmm7
 = 
	`pci_cÚf_»ad8
(0, 0x18+
node
, 0x3, 0x87);

288 ià(
pmm7
 == 0xFF)

290 
pmm7
 &= 0xFC;

291 
	`pci_cÚf_wr™e8
(0, 0x18+
node
, 0x3, 0x87, 
pmm7
);

292 
	`´štk
 ("AMD: Di§blšg C1 Clock Rampšg Nod#%x\n", 
node
);

294 
	}
}

296 
fÜû_mwa™
 
	g__ıuš™d©a
;

298 
	$di§bË_c1e
(*
unu£d
)

300 
ušt64_t
 
m¤_cÚ‹Á
;

307 ià((
	`rdm¤_§ã
(
MSR_K8_ENABLE_C1E
, 
m¤_cÚ‹Á
) == 0) &&

308 (
m¤_cÚ‹Á
 & (3ULL << 27)) &&

309 (
	`wrm¤_§ã
(
MSR_K8_ENABLE_C1E
, 
m¤_cÚ‹Á
 & ~(3ULL << 27)) != 0))

310 
	`´štk
(
KERN_ERR
 "FaedØdi§bË C1E oÀCPU#%u (%16"
PRIx64
")\n",

311 
	`smp_´oûssÜ_id
(), 
m¤_cÚ‹Á
);

312 
	}
}

314 
	$check_di§bË_c1e
(
pÜt
, 
u8
 
v®ue
)

317 ià((
pÜt
 =ğ
aıi_smi_cmd
è&& (
v®ue
 =ğ
aıi_’abË_v®ue
))

318 
	`Ú_—ch_ıu
(
di§bË_c1e
, 
NULL
, 1);

319 
	}
}

326 
	$check_syscfg_d¿m_mod_’
()

328 
ušt64_t
 
syscfg
;

329 
boŞ_t
 
´š‹d
 = 0;

331 ià(!((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
) &&

332 (
boÙ_ıu_d©a
.
x86
 >= 0x0f)))

335 
	`rdm¤l
(
MSR_K8_SYSCFG
, 
syscfg
);

336 ià(!(
syscfg
 & 
K8_MTRRFIXRANGE_DRAM_MODIFY
))

339 ià(!
	`‹¡_ªd_£t_boŞ
(
´š‹d
))

340 
	`´štk
(
KERN_ERR
 "MTRR: SYSCFG[MtrrFixDramModEn]‚ot "

343 
syscfg
 &ğ~
K8_MTRRFIXRANGE_DRAM_MODIFY
;

344 
	`wrm¤l
(
MSR_K8_SYSCFG
, 
syscfg
);

345 
	}
}

347 
__devš™
 
	$š™_amd
(
ıušfo_x86
 *
c
)

349 
u32
 
l
, 
h
;

350 
mby‹s
 = 
num_phy¥ages
 >> (20-
PAGE_SHIFT
);

351 
r
;

353 #ifdeà
CONFIG_SMP


354 
v®ue
;

362 ià(
c
->
x86
 == 15) {

363 
	`rdm¤l
(
MSR_K7_HWCR
, 
v®ue
);

364 
v®ue
 |= 1 << 6;

365 
	`wrm¤l
(
MSR_K7_HWCR
, 
v®ue
);

377 
	`ş—r_b™
(0*32+31, 
c
->
x86_ÿ·b™y
);

379 #ifdeà
CONFIG_X86_64


380 ià(
c
->
x86
 =ğ0xà&& c->
x86_mod–
 < 0x14

381 && 
	`ıu_has
(
c
, 
X86_FEATURE_LAHF_LM
)) {

387 
lo
, 
hi
;

389 
	`ş—r_b™
(
X86_FEATURE_LAHF_LM
, 
c
->
x86_ÿ·b™y
);

390 ià(!
	`rdm¤_amd_§ã
(0xc001100d, &
lo
, &
hi
)) {

391 
hi
 &= ~1;

392 
	`wrm¤_amd_§ã
(0xc001100d, 
lo
, 
hi
);

397 
r
 = 
	`g‘_mod–_Çme
(
c
);

399 
c
->
x86
)

408 
	#CBAR
 (0xfffcè

	)

409 
	#CBAR_ENB
 (0x80000000)

	)

410 
	#CBAR_KEY
 (0X000000CB)

	)

411 ià(
c
->
x86_mod–
==9 || c->x86_model == 10) {

412 ià(
	`šl
 (
CBAR
è& 
CBAR_ENB
)

413 
	`ou
 (0 | 
CBAR_KEY
, 
CBAR
);

417 ifĞ
c
->
x86_mod–
 < 6 )

420 iàĞ
c
->
x86_mod–
 == 0 ) {

421 
	`ş—r_b™
(
X86_FEATURE_APIC
, 
c
->
x86_ÿ·b™y
);

422 
	`£t_b™
(
X86_FEATURE_PGE
, 
c
->
x86_ÿ·b™y
);

427 iàĞ
c
->
x86_mod–
 =ğ6 && c->
x86_mask
 == 1 ) {

428 cÚ¡ 
K6_BUG_LOOP
 = 1000000;

429 
n
;

430 (*
f_vide
)();

431 
d
, 
d2
;

433 
	`´štk
(
KERN_INFO
 "AMD K6 stepping B detected - ");

440 
n
 = 
K6_BUG_LOOP
;

441 
f_vide
 = 
vide
;

442 
	`rdtsş
(
d
);

443 
n
--)

444 
	`f_vide
();

445 
	`rdtsş
(
d2
);

446 
d
 = 
d2
-d;

448 ià(
d
 > 20*
K6_BUG_LOOP
)

449 
	`´štk
("system stability may be impaired when morehan 32 MB‡re used.\n");

451 
	`´štk
("probably OK (after B9730xxxx).\n");

452 
	`´štk
(
KERN_INFO
 "Please see http://membres.lycos.fr/poulot/k6bug.html\n");

456 ià(
c
->
x86_mod–
 < 8 ||

457 (
c
->
x86_mod–
=ğ8 && c->
x86_mask
 < 8)) {

459 if(
mby‹s
>508)

460 
mby‹s
=508;

462 
	`rdm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

463 ià((
l
&0x0000FFFF)==0) {

464 
æags
;

465 
l
=(1<<0)|((
mby‹s
/4)<<1);

466 
	`loÿl_œq_§ve
(
æags
);

467 
	`wbšvd
();

468 
	`wrm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

469 
	`loÿl_œq_»¡Üe
(
æags
);

470 
	`´štk
(
KERN_INFO
 "Enabling old style K6 write‡llocation for %d Mb\n",

471 
mby‹s
);

476 ià((
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 >7) ||

477 
c
->
x86_mod–
 == 9 || c->x86_model == 13) {

480 if(
mby‹s
>4092)

481 
mby‹s
=4092;

483 
	`rdm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

484 ià((
l
&0xFFFF0000)==0) {

485 
æags
;

486 
l
=((
mby‹s
>>2)<<22)|(1<<16);

487 
	`loÿl_œq_§ve
(
æags
);

488 
	`wbšvd
();

489 
	`wrm¤
(
MSR_K6_WHCR
, 
l
, 
h
);

490 
	`loÿl_œq_»¡Üe
(
æags
);

491 
	`´štk
(
KERN_INFO
 "Enabling‚ew style K6 write‡llocation for %d Mb\n",

492 
mby‹s
);

496 ià(
c
->
x86_mod–
 == 13 || c->x86_model == 9 ||

497 (
c
->
x86_mod–
 =ğ8 && c->
x86_mask
 >= 8))

498 
	`£t_b™
(
X86_FEATURE_K6_MTRR
, 
c
->
x86_ÿ·b™y
);

502 ià(
c
->
x86_mod–
 == 10) {

514 ià(
c
->
x86_mod–
 >= 6 && c->x86_model <= 10) {

515 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_XMM
)) {

516 
	`´štk
(
KERN_INFO
 "Enabling disabled K7/SSE Support.\n");

517 
	`rdm¤
(
MSR_K7_HWCR
, 
l
, 
h
);

518 
l
 &= ~0x00008000;

519 
	`wrm¤
(
MSR_K7_HWCR
, 
l
, 
h
);

520 
	`£t_b™
(
X86_FEATURE_XMM
, 
c
->
x86_ÿ·b™y
);

528 ià((
c
->
x86_mod–
 =ğ8 && c->
x86_mask
>=1) || (c->x86_model > 8)) {

529 
	`rdm¤
(
MSR_K7_CLK_CTL
, 
l
, 
h
);

530 ià((
l
 & 0xfff00000) != 0x20000000) {

531 
	`´štk
 ("CPU: CLK_CTL MSR wa %x. R•rog¿mmšgØ%x\n", 
l
,

532 ((
l
 & 0x000fffff)|0x20000000));

533 
	`wrm¤
(
MSR_K7_CLK_CTL
, (
l
 & 0x000fffff)|0x20000000, 
h
);

539 
c
->
x86
) {

543 
	`£t_b™
(
X86_FEATURE_K8
, 
c
->
x86_ÿ·b™y
);

544 
	`di§bË_c1e
(
NULL
);

545 ià(
aıi_smi_cmd
 && (
aıi_’abË_v®ue
 | 
aıi_di§bË_v®ue
))

546 
pv_po¡_outb_hook
 = 
check_di§bË_c1e
;

549 
	`£t_b™
(
X86_FEATURE_K7
, 
c
->
x86_ÿ·b™y
);

553 
	`di¥Ïy_ÿchešfo
(
c
);

555 ià(
	`ıuid_—x
(0x80000000) >= 0x80000008) {

556 
c
->
x86_max_cÜes
 = (
	`ıuid_ecx
(0x80000008) & 0xff) + 1;

559 ià(
	`ıuid_—x
(0x80000000) >= 0x80000007) {

560 
c
->
x86_pow”
 = 
	`ıuid_edx
(0x80000007);

561 ià(
c
->
x86_pow”
 & (1<<8)) {

562 
	`£t_b™
(
X86_FEATURE_CONSTANT_TSC
, 
c
->
x86_ÿ·b™y
);

563 
	`£t_b™
(
X86_FEATURE_NONSTOP_TSC
, 
c
->
x86_ÿ·b™y
);

564 ià(
c
->
x86
 != 0x11)

565 
	`£t_b™
(
X86_FEATURE_TSC_RELIABLE
, 
c
->
x86_ÿ·b™y
);

569 #ifdeà
CONFIG_X86_HT


574 ià(
c
->
x86_max_cÜes
 > 1) {

575 
ıu
 = 
	`smp_´oûssÜ_id
();

576 
b™s
 = (
	`ıuid_ecx
(0x80000008) >> 12) & 0xf;

578 ià(
b™s
 == 0) {

579 (1 << 
b™s
è< 
c
->
x86_max_cÜes
)

580 
b™s
++;

582 
ıu_cÜe_id
[
ıu
] = 
phys_´oc_id
[ıu] & ((1<<
b™s
)-1);

583 
phys_´oc_id
[
ıu
] >>ğ
b™s
;

584 ià(
İt_ıu_šfo
)

585 
	`´štk
("CPU %d(%d) -> Core %d\n",

586 
ıu
, 
c
->
x86_max_cÜes
, 
ıu_cÜe_id
[cpu]);

591 ià(
c
->
x86
 >ğ0x10 && !
fÜû_mwa™
)

592 
	`ş—r_b™
(
X86_FEATURE_MWAIT
, 
c
->
x86_ÿ·b™y
);

595 ià(
c
->
x86
 < 6)

596 
	`ş—r_b™
(
X86_FEATURE_MCE
, 
c
->
x86_ÿ·b™y
);

598 #ifdeà
__x86_64__


600 
	`ş—r_b™
(
X86_FEATURE_SEP
, 
c
->
x86_ÿ·b™y
);

602 ià(
c
->
x86
 == 0x10) {

604 ià(
c
 =ğ&
boÙ_ıu_d©a
)

605 
	`check_’abË_amd_mmcÚf_dmi
();

607 
	`çm10h_check_’abË_mmcfg
();

612 ià(
c
->
x86
 > 0xà&& !
	`ıu_has_amd_”¿tum
(c, 
AMD_ERRATUM_400
))

613 
	`£t_b™
(
X86_FEATURE_ARAT
, 
c
->
x86_ÿ·b™y
);

616 ià((
	`smp_´oûssÜ_id
(è=ğ1è&& 
	`c1_¿mpšg_may_ÿu£_şock_driá
(
c
))

617 
	`di§bË_c1_¿mpšg
();

619 
	`£t_ıuidmask
(
c
);

621 
	`check_syscfg_d¿m_mod_’
();

622 
	}
}

624 
__ıuš™
 
	$amd_size_ÿche
(
ıušfo_x86
 * 
c
, 
size
)

627 ià((
c
->
x86
 == 6)) {

628 ià(
c
->
x86_mod–
 =ğ3 && c->
x86_mask
 == 0)

629 
size
 = 64;

630 ià(
c
->
x86_mod–
 == 4 &&

631 (
c
->
x86_mask
==0 || c->x86_mask==1))

632 
size
 = 256;

634  
size
;

635 
	}
}

637 
ıu_dev
 
amd_ıu_dev
 
	g__ıuš™d©a
 = {

638 .
c_v’dÜ
 = "AMD",

639 .
	gc_id’t
 = { "AuthenticAMD" },

640 .
	gc_mod–s
 = {

641 { .
v’dÜ
 = 
X86_VENDOR_AMD
, .
	gçmy
 = 4, .
	gmod–_Çmes
 =

652 .
	gc_š™
 = 
š™_amd
,

653 .
	gc_id’tify
 = 
g’”ic_id’tify
,

654 .
	gc_size_ÿche
 = 
amd_size_ÿche
,

657 
__š™
 
	$amd_š™_ıu
()

659 
ıu_devs
[
X86_VENDOR_AMD
] = &
amd_ıu_dev
;

661 
	}
}

	@cpu/centaur.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/lib.h
>

3 
	~<x’/š™.h
>

4 
	~<x’/b™İs.h
>

5 
	~<asm/´oûssÜ.h
>

6 
	~<asm/m¤.h
>

7 
	~<asm/e820.h
>

8 
	~"ıu.h
"

10 
	#ACE_PRESENT
 (1 << 6)

	)

11 
	#ACE_ENABLED
 (1 << 7)

	)

12 
	#ACE_FCR
 (1 << 28è

	)

14 
	#RNG_PRESENT
 (1 << 2)

	)

15 
	#RNG_ENABLED
 (1 << 3)

	)

16 
	#RNG_ENABLE
 (1 << 6è

	)

18 
__š™
 
	$š™_c3
(
ıušfo_x86
 *
c
)

20 
ušt64_t
 
m¤_cÚ‹Á
;

23 ià(
	`ıuid_—x
(0xC0000000) >= 0xC0000001) {

24 
u32
 
tmp
 = 
	`ıuid_edx
(0xC0000001);

27 ià((
tmp
 & (
ACE_PRESENT
 | 
ACE_ENABLED
)) == ACE_PRESENT) {

28 
	`rdm¤l
(
MSR_VIA_FCR
, 
m¤_cÚ‹Á
);

30 
	`wrm¤l
(
MSR_VIA_FCR
, 
m¤_cÚ‹Á
 | 
ACE_FCR
);

31 
	`´štk
(
KERN_INFO
 "CPU: Enabled ACE h/w crypto\n");

35 ià((
tmp
 & (
RNG_PRESENT
 | 
RNG_ENABLED
)) == RNG_PRESENT) {

36 
	`rdm¤l
(
MSR_VIA_RNG
, 
m¤_cÚ‹Á
);

38 
	`wrm¤l
(
MSR_VIA_RNG
, 
m¤_cÚ‹Á
 | 
RNG_ENABLE
);

39 
	`´štk
(
KERN_INFO
 "CPU: Enabled h/w RNG\n");

45 
c
->
x86_ÿ·b™y
[5] = 
	`ıuid_edx
(0xC0000001);

49 ià(
c
->
x86_mod–
 >=6 && c->x86_model <= 9) {

50 
	`rdm¤l
(
MSR_VIA_FCR
, 
m¤_cÚ‹Á
);

51 
	`wrm¤l
(
MSR_VIA_FCR
, 
m¤_cÚ‹Á
 | (1ULL << 1 | 1ULL << 7));

52 
	`£t_b™
(
X86_FEATURE_CX8
, 
c
->
x86_ÿ·b™y
);

56 ià(
c
->
x86_mod–
 >=6 && c->x86_model <9)

57 
	`£t_b™
(
X86_FEATURE_3DNOW
, 
c
->
x86_ÿ·b™y
);

59 
	`g‘_mod–_Çme
(
c
);

60 
	`di¥Ïy_ÿchešfo
(
c
);

61 
	}
}

63 
__š™
 
	$š™_ûÁaur
(
ıušfo_x86
 *
c
)

67 
	`ş—r_b™
(0*32+31, 
c
->
x86_ÿ·b™y
);

69 ià(
c
->
x86
 == 6)

70 
	`š™_c3
(
c
);

71 
	}
}

73 
	$ûÁaur_size_ÿche
(
ıušfo_x86
 * 
c
, 
size
)

76 ià((
c
->
x86
 =ğ6è&& ((c->
x86_mod–
 == 7) || (c->x86_model == 8)))

77 
size
 >>= 8;

82 ià((
c
->
x86
==6è&& (c->
x86_mod–
==9è&& (c->
x86_mask
==1è&& (
size
==65))

83 
size
 -=1;

85  
size
;

86 
	}
}

88 
ıu_dev
 
ûÁaur_ıu_dev
 
	g__š™d©a
 = {

89 .
c_v’dÜ
 = "Centaur",

90 .
	gc_id’t
 = { "CentaurHauls" },

91 .
	gc_š™
 = 
š™_ûÁaur
,

92 .
	gc_size_ÿche
 = 
ûÁaur_size_ÿche
,

95 
__š™
 
	$ûÁaur_š™_ıu
()

97 
ıu_devs
[
X86_VENDOR_CENTAUR
] = &
ûÁaur_ıu_dev
;

99 
	}
}

	@cpu/common.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/¡ršg.h
>

4 
	~<x’/d–ay.h
>

5 
	~<x’/smp.h
>

6 
	~<asm/cu¼’t.h
>

7 
	~<asm/´oûssÜ.h
>

8 
	~<asm/i387.h
>

9 
	~<asm/m¤.h
>

10 
	~<asm/io.h
>

11 
	~<asm/mp¥ec.h
>

12 
	~<asm/­ic.h
>

13 
	~<mach_­ic.h
>

14 
	~<asm/£tup.h
>

16 
	~"ıu.h
"

18 
	#tsc_di§bË
 0

	)

19 
	#di§bË_p£
 0

	)

21 
ÿchesize_ov”ride
 
	g__ıuš™d©a
 = -1;

22 
size_·¿m
("ÿchesize", 
ÿchesize_ov”ride
);

23 
boŞ_t
 
__ıuš™d©a
 
	gdi§bË_x86_fx¤
;

24 
boŞ—n_·¿m
("nofx¤", 
di§bË_x86_fx¤
);

25 
boŞ_t
 
__ıuš™d©a
 
	gdi§bË_x86_£rŸl_Ä
;

26 
boŞ—n_·¿m
("no£rŸÊumb”", 
di§bË_x86_£rŸl_Ä
);

28 
boŞ_t
 
__ıuš™d©a
 
	gu£_x§ve
;

29 
boŞ—n_·¿m
("x§ve", 
u£_x§ve
);

30 
__devš™d©a
 
	gİt_ıuid_mask_ecx
 = ~0u;

31 
š‹g”_·¿m
("ıuid_mask_ecx", 
İt_ıuid_mask_ecx
);

32 
__devš™d©a
 
	gİt_ıuid_mask_edx
 = ~0u;

33 
š‹g”_·¿m
("ıuid_mask_edx", 
İt_ıuid_mask_edx
);

34 
__devš™d©a
 
	gİt_ıuid_mask_ext_ecx
 = ~0u;

35 
š‹g”_·¿m
("ıuid_mask_ext_ecx", 
İt_ıuid_mask_ext_ecx
);

36 
__devš™d©a
 
	gİt_ıuid_mask_ext_edx
 = ~0u;

37 
š‹g”_·¿m
("ıuid_mask_ext_edx", 
İt_ıuid_mask_ext_edx
);

39 
ıu_dev
 * 
	gıu_devs
[
X86_VENDOR_NUM
] = {};

45 
u64
 
	gho¡_·t
 = 0x050100070406;

47 
__ıuš™d©a
 
	gş—»d_ÿps
[
NCAPINTS
];

49 
__š™
 
	$£tup_ş—r_ıu_ÿp
(
ÿp
)

51 
	`__ş—r_b™
(
ÿp
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

52 
	`__£t_b™
(
ÿp
, 
ş—»d_ÿps
);

53 
	}
}

55 
	$deçuÉ_š™
(
ıušfo_x86
 * 
c
)

59 ià(
c
->
ıuid_Ëv–
 == -1) {

61 ià(
c
->
x86
 == 4)

62 
	`§ã_¡rıy
(
c
->
x86_mod–_id
, "486");

63 ià(
c
->
x86
 == 3)

64 
	`§ã_¡rıy
(
c
->
x86_mod–_id
, "386");

66 
	}
}

68 
ıu_dev
 
	gdeçuÉ_ıu
 = {

69 .
c_š™
 = 
deçuÉ_š™
,

70 .
	gc_v’dÜ
 = "Unknown",

72 
ıu_dev
 * 
	gthis_ıu
 = &
deçuÉ_ıu
;

74 
boŞ_t
 
__ıuš™d©a
 
	gİt_ıu_šfo
;

75 
boŞ—n_·¿m
("ıušfo", 
İt_ıu_šfo
);

77 
__ıuš™
 
	$g‘_mod–_Çme
(
ıušfo_x86
 *
c
)

79 *
v
;

80 *
p
, *
q
;

82 ià(
	`ıuid_—x
(0x80000000) < 0x80000004)

85 
v
 = (*è
c
->
x86_mod–_id
;

86 
	`ıuid
(0x80000002, &
v
[0], &v[1], &v[2], &v[3]);

87 
	`ıuid
(0x80000003, &
v
[4], &v[5], &v[6], &v[7]);

88 
	`ıuid
(0x80000004, &
v
[8], &v[9], &v[10], &v[11]);

89 
c
->
x86_mod–_id
[48] = 0;

93 
p
 = 
q
 = &
c
->
x86_mod–_id
[0];

94  *
p
 == ' ' )

95 
p
++;

96 iàĞ
p
 !ğ
q
 ) {

97  *
p
 )

98 *
q
++ = *
p
++;

99  
q
 <ğ&
c
->
x86_mod–_id
[48] )

100 *
q
++ = '\0';

104 
	}
}

107 
__ıuš™
 
	$di¥Ïy_ÿchešfo
(
ıušfo_x86
 *
c
)

109 
n
, 
dummy
, 
ecx
, 
edx
, 
l2size
;

111 
n
 = 
	`ıuid_—x
(0x80000000);

113 ià(
n
 >= 0x80000005) {

114 
	`ıuid
(0x80000005, &
dummy
, &dummy, &
ecx
, &
edx
);

115 ià(
İt_ıu_šfo
)

116 
	`´štk
("CPU: L1 I cache %dK (%d bytes/line),"

118 
edx
>>24,ƒdx&0xFF, 
ecx
>>24,ƒcx&0xFF);

119 
c
->
x86_ÿche_size
=(
ecx
>>24)+(
edx
>>24);

122 ià(
n
 < 0x80000006)

125 
ecx
 = 
	`ıuid_ecx
(0x80000006);

126 
l2size
 = 
ecx
 >> 16;

129 ià(
this_ıu
->
c_size_ÿche
)

130 
l2size
 = 
this_ıu
->
	`c_size_ÿche
(
c
,l2size);

133 ià(
ÿchesize_ov”ride
 != -1)

134 
l2size
 = 
ÿchesize_ov”ride
;

136 iàĞ
l2size
 == 0 )

139 
c
->
x86_ÿche_size
 = 
l2size
;

141 ià(
İt_ıu_šfo
)

142 
	`´štk
("CPU: L2 Cache: %dK (%d bytes/line)\n",

143 
l2size
, 
ecx
 & 0xFF);

144 
	}
}

151 
__ıuš™
 *
	$bË_lookup_mod–
(
ıušfo_x86
 *
c
)

153 
ıu_mod–_šfo
 *
šfo
;

155 iàĞ
c
->
x86_mod–
 >= 16 )

156  
NULL
;

158 ià(!
this_ıu
)

159  
NULL
;

161 
šfo
 = 
this_ıu
->
c_mod–s
;

163 
šfo
 && info->
çmy
) {

164 ià(
šfo
->
çmy
 =ğ
c
->
x86
)

165  
šfo
->
mod–_Çmes
[
c
->
x86_mod–
];

166 
šfo
++;

168  
NULL
;

169 
	}
}

172 
__ıuš™
 
	$g‘_ıu_v’dÜ
(
ıušfo_x86
 *
c
, 
—¾y
)

174 *
v
 = 
c
->
x86_v’dÜ_id
;

175 
i
;

176 
´š‹d
;

178 
i
 = 0; i < 
X86_VENDOR_NUM
; i++) {

179 ià(
ıu_devs
[
i
]) {

180 ià(!
	`¡rcmp
(
v
,
ıu_devs
[
i
]->
c_id’t
[0]) ||

181 (
ıu_devs
[
i
]->
c_id’t
[1] &&

182 !
	`¡rcmp
(
v
,
ıu_devs
[
i
]->
c_id’t
[1]))) {

183 
c
->
x86_v’dÜ
 = 
i
;

184 ià(!
—¾y
)

185 
this_ıu
 = 
ıu_devs
[
i
];

190 ià(!
´š‹d
) {

191 
´š‹d
++;

192 
	`´štk
(
KERN_ERR
 "CPU: Vendor unknown, using generic init.\n");

193 
	`´štk
(
KERN_ERR
 "CPU: Your system may be unstable.\n");

195 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

196 
this_ıu
 = &
deçuÉ_ıu
;

197 
	}
}

201 
šlše
 
	$æag_is_chªg—bË_p
(
æag
)

203 
f1
, 
f2
;

205 
	`asm
("pushf\n\t"

215 : "=&r" (
f1
), "=&r" (
f2
)

216 : "œ" (
æag
));

218  ((
f1
^
f2
è& 
æag
) != 0;

219 
	}
}

223 
__ıuš™
 
	$have_ıuid_p
()

225  
	`æag_is_chªg—bË_p
(
X86_EFLAGS_ID
);

226 
	}
}

234 
__š™
 
	$—¾y_ıu_d‘eù
()

236 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

238 
c
->
x86_ÿche_®ignm’t
 = 32;

240 ià(!
	`have_ıuid_p
())

244 
	`ıuid
(0x00000000, &
c
->
ıuid_Ëv–
,

245 (*)&
c
->
x86_v’dÜ_id
[0],

246 (*)&
c
->
x86_v’dÜ_id
[8],

247 (*)&
c
->
x86_v’dÜ_id
[4]);

249 
	`g‘_ıu_v’dÜ
(
c
, 1);

251 
c
->
x86
 = 4;

252 ià(
c
->
ıuid_Ëv–
 >= 0x00000001) {

253 
u32
 
ÿp4
, 
tfms
, 
ÿp0
, 
misc
;

254 
	`ıuid
(0x00000001, &
tfms
, &
misc
, &
ÿp4
, &
ÿp0
);

255 
c
->
x86
 = (
tfms
 >> 8) & 15;

256 
c
->
x86_mod–
 = (
tfms
 >> 4) & 15;

257 ià(
c
->
x86
 == 0xf)

258 
c
->
x86
 +ğ(
tfms
 >> 20) & 0xff;

259 ià(
c
->
x86
 >= 0x6)

260 
c
->
x86_mod–
 +ğ((
tfms
 >> 16) & 0xF) << 4;

261 
c
->
x86_mask
 = 
tfms
 & 15;

262 
ÿp0
 &ğ~
ş—»d_ÿps
[0];

263 
ÿp4
 &ğ~
ş—»d_ÿps
[4];

264 ià(
ÿp0
 & (1<<19))

265 
c
->
x86_ÿche_®ignm’t
 = ((
misc
 >> 8) & 0xff) * 8;

267 
c
->
x86_ÿ·b™y
[0] = 
ÿp0
;

268 
c
->
x86_ÿ·b™y
[4] = 
ÿp4
;

270 
	}
}

272 
__ıuš™
 
	$g’”ic_id’tify
(
ıušfo_x86
 * 
c
)

274 
u32
 
tfms
, 
xlvl
;

276 ià(
	`have_ıuid_p
()) {

278 
	`ıuid
(0x00000000, &
c
->
ıuid_Ëv–
,

279 (*)&
c
->
x86_v’dÜ_id
[0],

280 (*)&
c
->
x86_v’dÜ_id
[8],

281 (*)&
c
->
x86_v’dÜ_id
[4]);

283 
	`g‘_ıu_v’dÜ
(
c
, 0);

288 iàĞ
c
->
ıuid_Ëv–
 >= 0x00000001 ) {

289 
u32
 
ÿ·b™y
, 
exÿp
, 
ebx
;

290 
	`ıuid
(0x00000001, &
tfms
, &
ebx
, &
exÿp
, &
ÿ·b™y
);

291 
c
->
x86_ÿ·b™y
[0] = 
ÿ·b™y
;

292 
c
->
x86_ÿ·b™y
[4] = 
exÿp
;

293 
c
->
x86
 = (
tfms
 >> 8) & 15;

294 
c
->
x86_mod–
 = (
tfms
 >> 4) & 15;

295 ià(
c
->
x86
 == 0xf)

296 
c
->
x86
 +ğ(
tfms
 >> 20) & 0xff;

297 ià(
c
->
x86
 >= 0x6)

298 
c
->
x86_mod–
 +ğ((
tfms
 >> 16) & 0xF) << 4;

299 
c
->
x86_mask
 = 
tfms
 & 15;

300 iàĞ
	`ıu_has
(
c
, 
X86_FEATURE_CLFLSH
) )

301 
c
->
x86_şæush_size
 = ((
ebx
 >> 8) & 0xff) * 8;

304 
c
->
x86
 = 4;

308 
xlvl
 = 
	`ıuid_—x
(0x80000000);

309 iàĞ(
xlvl
 & 0xffff0000) == 0x80000000 ) {

310 iàĞ
xlvl
 >= 0x80000001 ) {

311 
c
->
x86_ÿ·b™y
[1] = 
	`ıuid_edx
(0x80000001);

312 
c
->
x86_ÿ·b™y
[6] = 
	`ıuid_ecx
(0x80000001);

314 iàĞ
xlvl
 >= 0x80000004 )

315 
	`g‘_mod–_Çme
(
c
);

319 iàĞ
c
->
ıuid_Ëv–
 >= 0x00000007 ) {

320 
u32
 
dummy
, 
ebx
;

321 
	`ıuid_couÁ
(0x7, 0, &
dummy
, &
ebx
, &dummy, &dummy);

322 
c
->
x86_ÿ·b™y
[
X86_FEATURE_FSGSBASE
 / 32] = 
ebx
;

326 
	`—¾y_š‹l_wÜk¬ound
(
c
);

328 #ifdeà
CONFIG_X86_HT


329 
phys_´oc_id
[
	`smp_´oûssÜ_id
()] = (
	`ıuid_ebx
(1) >> 24) & 0xff;

331 
	}
}

333 
__ıuš™
 
	$squash_the_¡upid_£rŸl_numb”
(
ıušfo_x86
 *
c
)

335 ià(
	`ıu_has
(
c
, 
X86_FEATURE_PN
è&& 
di§bË_x86_£rŸl_Ä
 ) {

337 
ušt64_t
 
m¤_cÚ‹Á
;

338 
	`rdm¤l
(
MSR_IA32_BBL_CR_CTL
,
m¤_cÚ‹Á
);

339 
	`wrm¤l
(
MSR_IA32_BBL_CR_CTL
, 
m¤_cÚ‹Á
 | 0x200000);

340 
	`´štk
(
KERN_NOTICE
 "CPU serial‚umber disabled.\n");

341 
	`ş—r_b™
(
X86_FEATURE_PN
, 
c
->
x86_ÿ·b™y
);

344 
c
->
ıuid_Ëv–
 = 
	`ıuid_—x
(0);

346 
	}
}

352 
__ıuš™
 
	$id’tify_ıu
(
ıušfo_x86
 *
c
)

354 
i
;

356 
c
->
x86_ÿche_size
 = -1;

357 
c
->
x86_v’dÜ
 = 
X86_VENDOR_UNKNOWN
;

358 
c
->
ıuid_Ëv–
 = -1;

359 
c
->
x86_mod–
 = c->
x86_mask
 = 0;

360 
c
->
x86_v’dÜ_id
[0] = '\0';

361 
c
->
x86_mod–_id
[0] = '\0';

362 
c
->
x86_max_cÜes
 = 1;

363 
c
->
x86_num_siblšgs
 = 1;

364 
c
->
x86_şæush_size
 = 0;

365 
	`mem£t
(&
c
->
x86_ÿ·b™y
, 0,  c->x86_capability);

367 ià(!
	`have_ıuid_p
()) {

370 iàĞ
	`æag_is_chªg—bË_p
(
X86_EFLAGS_AC
) )

371 
c
->
x86
 = 4;

373 
c
->
x86
 = 3;

376 
	`g’”ic_id’tify
(
c
);

378 #ifdeà
NOISY_CAPS


379 
	`´štk
(
KERN_DEBUG
 "CPU: After generic identify, caps:");

380 
i
 = 0; i < 
NCAPINTS
; i++)

381 
	`´štk
(" %08x", 
c
->
x86_ÿ·b™y
[
i
]);

382 
	`´štk
("\n");

385 ià(
this_ıu
->
c_id’tify
) {

386 
this_ıu
->
	`c_id’tify
(
c
);

388 #ifdeà
NOISY_CAPS


389 
	`´štk
(
KERN_DEBUG
 "CPU: After vendor identify, caps:");

390 
i
 = 0; i < 
NCAPINTS
; i++)

391 
	`´štk
(" %08x", 
c
->
x86_ÿ·b™y
[
i
]);

392 
	`´štk
("\n");

406 ià(
this_ıu
->
c_š™
)

407 
this_ıu
->
	`c_š™
(
c
);

410 iàĞ!
u£_x§ve
 )

411 
	`ş—r_b™
(
X86_FEATURE_XSAVE
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

413 iàĞ
ıu_has_x§ve
 )

414 
	`x§ve_š™
();

417 
	`squash_the_¡upid_£rŸl_numb”
(
c
);

425 iàĞ
tsc_di§bË
 )

426 
	`ş—r_b™
(
X86_FEATURE_TSC
, 
c
->
x86_ÿ·b™y
);

429 ià(
di§bË_x86_fx¤
) {

430 
	`ş—r_b™
(
X86_FEATURE_FXSR
, 
c
->
x86_ÿ·b™y
);

431 
	`ş—r_b™
(
X86_FEATURE_XMM
, 
c
->
x86_ÿ·b™y
);

434 ià(
di§bË_p£
)

435 
	`ş—r_b™
(
X86_FEATURE_PSE
, 
c
->
x86_ÿ·b™y
);

437 
i
 = 0 ; i < 
NCAPINTS
 ; ++i)

438 
c
->
x86_ÿ·b™y
[
i
] &ğ~
ş—»d_ÿps
[i];

441 iàĞ!
c
->
x86_mod–_id
[0] ) {

442 *
p
;

443 
p
 = 
	`bË_lookup_mod–
(
c
);

444 iàĞ
p
 )

445 
	`§ã_¡rıy
(
c
->
x86_mod–_id
, 
p
);

448 
	`¢´štf
(
c
->
x86_mod–_id
, (c->x86_model_id),

449 "%02x/%02x", 
c
->
x86_v’dÜ
, c->
x86_mod–
);

454 #ifdeà
NOISY_CAPS


455 
	`´štk
(
KERN_DEBUG
 "CPU: After‡ll inits, caps:");

456 
i
 = 0; i < 
NCAPINTS
; i++)

457 
	`´štk
(" %08x", 
c
->
x86_ÿ·b™y
[
i
]);

458 
	`´štk
("\n");

467 iàĞ
c
 !ğ&
boÙ_ıu_d©a
 ) {

469  
i
 = 0 ; i < 
NCAPINTS
 ; i++ )

470 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[
i
] &ğ
c
->x86_capability[i];

472 
	`mcheck_š™
(
c
, 0);

474 
	`mcheck_š™
(
c
, 1);

476 
	`mŒr_bp_š™
();

478 
	}
}

486 
šlše
 
u32
 
	$phys_pkg_id
(
u32
 
ıuid_­ic
, 
šdex_msb
)

488  
	`h¬d_smp_´oûssÜ_id
(è>> 
šdex_msb
;

489 
	}
}

492 
	#SMT_LEVEL
 0

	)

495 
	#INVALID_TYPE
 0

	)

496 
	#SMT_TYPE
 1

	)

497 
	#CORE_TYPE
 2

	)

499 
	#LEAFB_SUBTYPE
(
ecx
è((Ócxè>> 8è& 0xff)

	)

500 
	#BITS_SHIFT_NEXT_LEVEL
(
—x
è(Óaxè& 0x1f)

	)

501 
	#LEVEL_MAX_SIBLINGS
(
ebx
è(Óbxè& 0xffff)

	)

507 
__ıuš™
 
	$d‘eù_ex‹nded_tİŞogy
(
ıušfo_x86
 *
c
)

509 
—x
, 
ebx
, 
ecx
, 
edx
, 
sub_šdex
;

510 
ht_mask_width
, 
cÜe_¶us_mask_width
;

511 
cÜe_£Ëù_mask
, 
cÜe_Ëv–_siblšgs
;

512 
š™Ÿl_­icid
;

513 
ıu
 = 
	`smp_´oûssÜ_id
();

515 iàĞ
c
->
ıuid_Ëv–
 < 0xb )

518 
	`ıuid_couÁ
(0xb, 
SMT_LEVEL
, &
—x
, &
ebx
, &
ecx
, &
edx
);

521 iàĞ
ebx
 =ğ0 || (
	`LEAFB_SUBTYPE
(
ecx
è!ğ
SMT_TYPE
) )

524 
	`£t_b™
(
X86_FEATURE_XTOPOLOGY
, 
c
->
x86_ÿ·b™y
);

526 
š™Ÿl_­icid
 = 
edx
;

529 
cÜe_Ëv–_siblšgs
 = 
c
->
x86_num_siblšgs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

530 
cÜe_¶us_mask_width
 = 
ht_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
—x
);

532 
sub_šdex
 = 1;

534 
	`ıuid_couÁ
(0xb, 
sub_šdex
, &
—x
, &
ebx
, &
ecx
, &
edx
);

537 iàĞ
	`LEAFB_SUBTYPE
(
ecx
è=ğ
CORE_TYPE
 ) {

538 
cÜe_Ëv–_siblšgs
 = 
	`LEVEL_MAX_SIBLINGS
(
ebx
);

539 
cÜe_¶us_mask_width
 = 
	`BITS_SHIFT_NEXT_LEVEL
(
—x
);

543 
sub_šdex
++;

544 }  
	`LEAFB_SUBTYPE
(
ecx
è!ğ
INVALID_TYPE
 );

546 
cÜe_£Ëù_mask
 = (~(-1 << 
cÜe_¶us_mask_width
)è>> 
ht_mask_width
;

548 
ıu_cÜe_id
[
ıu
] = 
	`phys_pkg_id
(
š™Ÿl_­icid
, 
ht_mask_width
)

549 & 
cÜe_£Ëù_mask
;

550 
phys_´oc_id
[
ıu
] = 
	`phys_pkg_id
(
š™Ÿl_­icid
, 
cÜe_¶us_mask_width
);

552 
c
->
­icid
 = 
	`phys_pkg_id
(
š™Ÿl_­icid
, 0);

553 
c
->
x86_max_cÜes
 = (
cÜe_Ëv–_siblšgs
 / c->
x86_num_siblšgs
);

555 iàĞ
İt_ıu_šfo
 )

557 
	`´štk
("CPU: Physical Processor ID: %d\n",

558 
phys_´oc_id
[
ıu
]);

559 iàĞ
c
->
x86_max_cÜes
 > 1 )

560 
	`´štk
("CPU: Processor Core ID: %d\n",

561 
ıu_cÜe_id
[
ıu
]);

563 
	}
}

565 #ifdeà
CONFIG_X86_HT


566 
__ıuš™
 
	$d‘eù_ht
(
ıušfo_x86
 *
c
)

568 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

569 
šdex_msb
, 
cÜe_b™s
;

570 
ıu
 = 
	`smp_´oûssÜ_id
();

572 
	`ıuid
(1, &
—x
, &
ebx
, &
ecx
, &
edx
);

574 
c
->
­icid
 = 
	`phys_pkg_id
((
ebx
 >> 24) & 0xFF, 0);

576 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_HT
è|| cpu_has(c, 
X86_FEATURE_CMP_LEGACY
)

577 || 
	`ıu_has
(
c
, 
X86_FEATURE_XTOPOLOGY
))

580 
c
->
x86_num_siblšgs
 = (
ebx
 & 0xff0000) >> 16;

582 ià(
c
->
x86_num_siblšgs
 == 1) {

583 
	`´štk
(
KERN_INFO
 "CPU: Hyper-Threading is disabled\n");

584 } ià(
c
->
x86_num_siblšgs
 > 1 ) {

586 ià(
c
->
x86_num_siblšgs
 > 
NR_CPUS
) {

587 
	`´štk
(
KERN_WARNING
 "CPU: UnsuµÜ‹d‚umb” oàthsiblšg %d", 
c
->
x86_num_siblšgs
);

588 
c
->
x86_num_siblšgs
 = 1;

592 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
c
->
x86_num_siblšgs
);

593 
phys_´oc_id
[
ıu
] = 
	`phys_pkg_id
((
ebx
 >> 24è& 0xFF, 
šdex_msb
);

595 ià(
İt_ıu_šfo
)

596 
	`´štk
("CPU: Physical Processor ID: %d\n",

597 
phys_´oc_id
[
ıu
]);

599 
c
->
x86_num_siblšgs
 = c->x86_num_siblšg / c->
x86_max_cÜes
;

601 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
c
->
x86_num_siblšgs
) ;

603 
cÜe_b™s
 = 
	`g‘_couÁ_Üd”
(
c
->
x86_max_cÜes
);

605 
ıu_cÜe_id
[
ıu
] = 
	`phys_pkg_id
((
ebx
 >> 24è& 0xFF, 
šdex_msb
) &

606 ((1 << 
cÜe_b™s
) - 1);

608 ià(
İt_ıu_šfo
 && 
c
->
x86_max_cÜes
 > 1)

609 
	`´štk
("CPU: Processor Core ID: %d\n",

610 
ıu_cÜe_id
[
ıu
]);

612 
	}
}

615 
__ıuš™
 
	$´št_ıu_šfo
(
ıu
)

617 cÚ¡ 
ıušfo_x86
 *
c
 = 
ıu_d©a
 + 
ıu
;

618 cÚ¡ *
v’dÜ
 = 
NULL
;

620 ià(!
İt_ıu_šfo
)

623 
	`´štk
("CPU%u: ", 
ıu
);

625 ià(
c
->
x86_v’dÜ
 < 
X86_VENDOR_NUM
)

626 
v’dÜ
 = 
this_ıu
->
c_v’dÜ
;

627 ià(
c
->
ıuid_Ëv–
 >= 0)

628 
v’dÜ
 = 
c
->
x86_v’dÜ_id
;

630 ià(
v’dÜ
 && 
	`¡ºcmp
(
c
->
x86_mod–_id
, v’dÜ, 
	`¡¾’
(vendor)))

631 
	`´štk
("% ", 
v’dÜ
);

633 ià(!
c
->
x86_mod–_id
[0])

634 
	`´štk
("%d86", 
c
->
x86
);

636 
	`´štk
("%s", 
c
->
x86_mod–_id
);

638 ià(
c
->
x86_mask
 || c->
ıuid_Ëv–
 >= 0)

639 
	`´štk
(" s‹µšg %02x\n", 
c
->
x86_mask
);

641 
	`´štk
("\n");

642 
	}
}

644 
ıumask_t
 
	gıu_š™Ÿlized
;

654 
__š™
 
	$—¾y_ıu_š™
()

656 
	`š‹l_ıu_š™
();

657 
	`amd_š™_ıu
();

658 #ifdeà
CONFIG_X86_32


659 
	`cyrix_š™_ıu
();

660 
	`nsc_š™_ıu
();

661 
	`ûÁaur_š™_ıu
();

662 
	`Œªsm‘a_š™_ıu
();

664 
	`—¾y_ıu_d‘eù
();

665 
	}
}

672 
__ıuš™
 
	$ıu_š™
()

674 
ıu
 = 
	`smp_´oûssÜ_id
();

675 
tss_¡ruù
 *
t
 = &
	`this_ıu
(
š™_tss
);

676 
desc_±r
 
gdt_desc
 = {

677 .
ba£
 = ()(
	`this_ıu
(
gdt_bË
è- 
FIRST_RESERVED_GDT_ENTRY
),

678 .
lim™
 = 
LAST_RESERVED_GDT_BYTE


681 ià(
	`ıu_‹¡_ªd_£t
(
ıu
, 
ıu_š™Ÿlized
)) {

682 
	`´štk
(
KERN_WARNING
 "CPU#%d‡Ì—dy in™Ÿlized!\n", 
ıu
);

683 ;;è
	`loÿl_œq_’abË
();

685 ià(
İt_ıu_šfo
)

686 
	`´štk
("In™Ÿlizšg CPU#%d\n", 
ıu
);

688 ià(
ıu_has_·t
)

689 
	`wrm¤l
(
MSR_IA32_CR_PAT
, 
ho¡_·t
);

692 
	`wr™e_±ba£
(
cu¼’t
);

694 
asm
 vŞ©Ğ"lgdˆ%0" : : "m" (
gdt_desc
) );

697 
asm
 vŞ©("pushà;‡ndw $0xbfff,(%"
__OP
"sp) ;…opf" );

700 
	`¡ts
();

703 
t
->
b™m­
 = 
IOBMP_INVALID_OFFSET
;

704 #ià
	`defšed
(
CONFIG_X86_32
)

705 
t
->
ss0
 = 
__HYPERVISOR_DS
;

706 
t
->
e¥0
 = 
	`g‘_¡ack_bÙtom
();

707 iàĞ
su³rvisÜ_mode_k”Ãl
 && 
ıu_has_£p
 )

708 
	`wrm¤
(
MSR_IA32_SYSENTER_ESP
, &
t
->
e¥1
, 0);

709 #–ià
	`defšed
(
CONFIG_X86_64
)

711 
	`BUG_ON
((
	`g‘_¡ack_bÙtom
() & 15) != 0);

712 
t
->
r¥0
 = 
	`g‘_¡ack_bÙtom
();

714 
	`lßd_TR
();

715 
asm
 volatile ( "lldt %%ax" : : "a" (0) );

718 
	#CD
(è
asm
 vŞ©Ğ"mov %0,%%db" #»gi¡” : : "r"(0ULè);

	)

719 
	`CD
(0); CD(1); CD(2); CD(3); ; CD(6); CD(7);

720 #undeà
CD


721 
	}
}

723 
	$ıu_unš™
(
ıu
)

725 
	`ıu_ş—r
(
ıu
, 
ıu_š™Ÿlized
);

726 
	}
}

	@cpu/cpu.h

2 
	sıu_mod–_šfo
 {

3 
	mv’dÜ
;

4 
	mçmy
;

5 *
	mmod–_Çmes
[16];

9 
	sıu_dev
 {

10 * 
	mc_v’dÜ
;

13 * 
	mc_id’t
[2];

15 
ıu_mod–_šfo
 
	mc_mod–s
[4];

17 (*
	mc_š™
)(
ıušfo_x86
 * 
	mc
);

18 (*
	mc_id’tify
)(
ıušfo_x86
 * 
	mc
);

19 (*
	mc_size_ÿche
)(
ıušfo_x86
 * 
	mc
, 
	msize
);

22 
ıu_dev
 * 
ıu_devs
 [
X86_VENDOR_NUM
];

24 
İt_ıuid_mask_ecx
, 
İt_ıuid_mask_edx
;

25 
İt_ıuid_mask_ext_ecx
, 
İt_ıuid_mask_ext_edx
;

27 
g‘_mod–_Çme
(
ıušfo_x86
 *
c
);

28 
di¥Ïy_ÿchešfo
(
ıušfo_x86
 *
c
);

30 
g’”ic_id’tify
(
ıušfo_x86
 * 
c
);

32 
—¾y_š‹l_wÜk¬ound
(
ıušfo_x86
 *
c
);

	@cpu/cyrix.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/œq.h
>

4 
	~<x’/b™İs.h
>

5 
	~<x’/d–ay.h
>

6 
	~<asm/io.h
>

7 
	~<asm/´oûssÜ.h
>

9 
	~"ıu.h
"

14 
__š™
 
	$do_cyrix_devid
(*
dœ0
, *
dœ1
)

16 
cü2
, 
cü3
;

17 
æags
;

20 
	`loÿl_œq_§ve
(
æags
);

21 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

22 
	`£tCx86
(
CX86_CCR3
, 
cü3
 ^ 0x80);

23 
	`g‘Cx86
(0xc0);

25 ià(
	`g‘Cx86
(
CX86_CCR3
è=ğ
cü3
) {

26 
cü2
 = 
	`g‘Cx86
(
CX86_CCR2
);

27 
	`£tCx86
(
CX86_CCR2
, 
cü2
 ^ 0x04);

28 
	`g‘Cx86
(0xc0);

30 ià(
	`g‘Cx86
(
CX86_CCR2
è=ğ
cü2
)

31 *
dœ0
 = 0xfd;

33 
	`£tCx86
(
CX86_CCR2
, 
cü2
);

34 *
dœ0
 = 0xfe;

38 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

41 *
dœ0
 = 
	`g‘Cx86
(
CX86_DIR0
);

42 *
dœ1
 = 
	`g‘Cx86
(
CX86_DIR1
);

44 
	`loÿl_œq_»¡Üe
(
æags
);

45 
	}
}

54 
Cx86_dœ0_msb
 
	g__š™d©a
 = 0;

56 
	gCx86_mod–
[][9] 
	g__š™d©a
 = {

60 
	gCx486_Çme
[][5] 
	g__š™d©a
 = {

64 
	gCx486S_Çme
[][4] 
	g__š™d©a
 = {

67 
	gCx486D_Çme
[][4] 
	g__š™d©a
 = {

70 
	gCx86_cb
[] 
	g__š™d©a
 = "?.5x Core/Bus Clock";

71 
	gcyrix_mod–_muÉ1
[] 
	g__š™d©a
 = "12??43";

72 
	gcyrix_mod–_muÉ2
[] 
	g__š™d©a
 = "12233445";

82 
__š™
 
	$check_cx686_¦İ
(
ıušfo_x86
 *
c
)

84 
æags
;

86 ià(
Cx86_dœ0_msb
 == 3) {

87 
cü3
, 
cü5
;

89 
	`loÿl_œq_§ve
(
æags
);

90 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

91 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

92 
cü5
 = 
	`g‘Cx86
(
CX86_CCR5
);

93 ià(
cü5
 & 2)

94 
	`£tCx86
(
CX86_CCR5
, 
cü5
 & 0xfd);

95 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

96 
	`loÿl_œq_»¡Üe
(
æags
);

98 
	}
}

101 
__š™
 
	$£t_cx86_»Üd”
()

103 
u8
 
cü3
;

105 
	`´štk
(
KERN_INFO
 "Enable Memory‡ccess„eorder on Cyrix/NSC…rocessor.\n");

106 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

107 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

110 
	`£tCx86
(
CX86_PCR0
, 
	`g‘Cx86
(CX86_PCR0) & ~0x80);

112 
cü3
 |= 0xe0;

113 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

114 
	}
}

116 
__š™
 
	$£t_cx86_memwb
()

118 
u32
 
ü0
;

120 
	`´štk
(
KERN_INFO
 "Enable Memory-Write-back mode on Cyrix/NSC…rocessor.\n");

123 
	`£tCx86
(
CX86_CCR2
, 
	`g‘Cx86
(CX86_CCR2) & ~0x04);

125 
ü0
 = 0x20000000;

126 
	`__asm__
("movl %%cr0,%%eax\n\t"

129 : : "r" (
ü0
)

132 
	`£tCx86
(
CX86_CCR2
, 
	`g‘Cx86
(CX86_CCR2) | 0x14 );

133 
	}
}

135 
__š™
 
	$£t_cx86_šc
()

137 
cü3
;

139 
	`´štk
(
KERN_INFO
 "Enable Incrementor on Cyrix/NSC…rocessor.\n");

141 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

142 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

145 
	`£tCx86
(
CX86_PCR1
, 
	`g‘Cx86
(CX86_PCR1) | 0x02);

148 
	`£tCx86
(
CX86_PCR0
, 
	`g‘Cx86
(CX86_PCR0) | 0x04);

149 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

150 
	}
}

156 
__š™
 
	$geode_cÚfigu»
()

158 
æags
;

159 
u8
 
cü3
, 
cü4
;

160 
	`loÿl_œq_§ve
(
æags
);

163 
	`£tCx86
(
CX86_CCR2
, 
	`g‘Cx86
(CX86_CCR2) | 0x88);

165 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

166 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

168 
cü4
 = 
	`g‘Cx86
(
CX86_CCR4
);

169 
cü4
 |= 0x38;

171 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

173 
	`£t_cx86_memwb
();

174 
	`£t_cx86_»Üd”
();

175 
	`£t_cx86_šc
();

177 
	`loÿl_œq_»¡Üe
(
æags
);

178 
	}
}

181 
__š™
 
	$š™_cyrix
(
ıušfo_x86
 *
c
)

183 
dœ0
, 
dœ0_m¢
, 
dœ0_l¢
, 
dœ1
 = 0;

184 cÚ¡ *
p
 = 
NULL
;

188 
	`ş—r_b™
(0*32+31, 
c
->
x86_ÿ·b™y
);

191 iàĞ
	`‹¡_b™
(1*32+24, 
c
->
x86_ÿ·b™y
) ) {

192 
	`ş—r_b™
(1*32+24, 
c
->
x86_ÿ·b™y
);

193 
	`£t_b™
(
X86_FEATURE_CXMMX
, 
c
->
x86_ÿ·b™y
);

196 
	`do_cyrix_devid
(&
dœ0
, &
dœ1
);

198 
	`check_cx686_¦İ
(
c
);

200 
Cx86_dœ0_msb
 = 
dœ0_m¢
 = 
dœ0
 >> 4;

201 
dœ0_l¢
 = 
dœ0
 & 0xf;

204 
c
->
x86_mod–
 = (
dœ1
 >> 4) + 1;

205 
c
->
x86_mask
 = 
dœ1
 & 0xf;

213 
dœ0_m¢
) {

214 
tmp
;

217 
p
 = 
Cx486_Çme
[
dœ0_l¢
 & 7];

221 
p
 = (
dœ0_l¢
 & 8è? 
Cx486D_Çme
[dir0_lsn & 5]

222 : 
Cx486S_Çme
[
dœ0_l¢
 & 3];

226 
Cx86_cb
[2] = 
cyrix_mod–_muÉ1
[
dœ0_l¢
 & 5];

227 
p
 = 
Cx86_cb
+2;

231 
Cx86_cb
[1] = ' ';

232 
Cx86_cb
[2] = 
cyrix_mod–_muÉ1
[
dœ0_l¢
 & 5];

233 ià(
dœ1
 > 0x21) {

234 
Cx86_cb
[0] = 'L';

235 
p
 = 
Cx86_cb
;

236 (
c
->
x86_mod–
)++;

238 
p
 = 
Cx86_cb
+1;

240 
	`£t_b™
(
X86_FEATURE_CYRIX_ARR
, 
c
->
x86_ÿ·b™y
);

246 
c
->
x86_ÿche_size
=16;

249 ià(
c
->
ıuid_Ëv–
 == 2) {

251 
	`£tCx86
(
CX86_CCR7
, 
	`g‘Cx86
(CX86_CCR7)|1);

254 if((
dœ1
 >= 0x50 && dir1 <= 0x54) || dir1 >= 0x63)

255 
	`geode_cÚfigu»
();

256 
	`g‘_mod–_Çme
(
c
);

260 
Cx86_cb
[2] = (
dœ0_l¢
 & 1) ? '3' : '4';

261 
p
 = 
Cx86_cb
+2;

262 
c
->
x86_mod–
 = (
dœ1
 & 0x20) ? 1 : 2;

267 ià(
dœ1
 > 7)

269 
dœ0_m¢
++;

271 
	`£tCx86
(
CX86_CCR7
, 
	`g‘Cx86
(CX86_CCR7)|1);

277 
tmp
 = (!(
dœ0_l¢
 & 7) || dir0_lsn & 1) ? 2 : 0;

278 
Cx86_cb
[
tmp
] = 
cyrix_mod–_muÉ2
[
dœ0_l¢
 & 7];

279 
p
 = 
Cx86_cb
+
tmp
;

280 ià(((
dœ1
 & 0x0f) > 4) || ((dir1 & 0xf0) == 0x20))

281 (
c
->
x86_mod–
)++;

283 
	`£t_b™
(
X86_FEATURE_CYRIX_ARR
, 
c
->
x86_ÿ·b™y
);

287 
dœ0_l¢
) {

289 
dœ0_m¢
 = 0;

290 
p
 = 
Cx486_Çme
[ 1];

294 
dœ0_m¢
 = 0;

295 
p
 = 
Cx486S_Çme
[0];

301 
dœ0_m¢
 = 7;

304 
	`§ã_¡rıy
(
c
->
x86_mod–_id
, 
Cx86_mod–
[
dœ0_m¢
 & 7]);

305 ià(
p
è
	`§ã_¡rÿt
(
c
->
x86_mod–_id
,…);

307 
	}
}

319 
šlše
 
	$‹¡_cyrix_52div
()

321 
‹¡
;

323 
__asm__
 
	`__vŞ©e__
(

327 : "÷" (
‹¡
)

332  (è(
‹¡
 >> 8) == 0x02;

333 
	}
}

335 
	$cyrix_id’tify
(
ıušfo_x86
 * 
c
)

338 iàĞ
c
->
x86
 =ğ4 && 
	`‹¡_cyrix_52div
() ) {

339 
dœ0
, 
dœ1
;

341 
	`§ã_¡rıy
(
c
->
x86_v’dÜ_id
, "CyrixInstead");

342 
c
->
x86_v’dÜ
 = 
X86_VENDOR_CYRIX
;

348 
	`do_cyrix_devid
(&
dœ0
, &
dœ1
);

350 
dœ0
>>=4;

354 ià(
dœ0
 == 5 || dir0 == 3)

356 
cü3
, 
cü4
;

357 
æags
;

358 
	`´štk
(
KERN_INFO
 "Enabling CPUID on Cyrix…rocessor.\n");

359 
	`loÿl_œq_§ve
(
æags
);

360 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

361 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

362 
cü4
 = 
	`g‘Cx86
(
CX86_CCR4
);

363 
	`£tCx86
(
CX86_CCR4
, 
cü4
 | 0x80);

364 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

365 
	`loÿl_œq_»¡Üe
(
æags
);

368 
	`g’”ic_id’tify
(
c
);

369 
	}
}

371 
ıu_dev
 
cyrix_ıu_dev
 
	g__š™d©a
 = {

372 .
c_v’dÜ
 = "Cyrix",

373 .
	gc_id’t
 = { "CyrixInstead" },

374 .
	gc_š™
 = 
š™_cyrix
,

375 .
	gc_id’tify
 = 
cyrix_id’tify
,

378 
__š™
 
	$cyrix_š™_ıu
()

380 
ıu_devs
[
X86_VENDOR_CYRIX
] = &
cyrix_ıu_dev
;

382 
	}
}

386 
ıu_dev
 
nsc_ıu_dev
 
	g__š™d©a
 = {

387 .
c_v’dÜ
 = "NSC",

388 .
	gc_id’t
 = { "Geode by NSC" },

389 .
	gc_š™
 = 
š™_cyrix
,

390 .
	gc_id’tify
 = 
g’”ic_id’tify
,

393 
__š™
 
	$nsc_š™_ıu
()

395 
ıu_devs
[
X86_VENDOR_NSC
] = &
nsc_ıu_dev
;

397 
	}
}

	@cpu/intel.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/k”Ãl.h
>

4 
	~<x’/¡ršg.h
>

5 
	~<x’/b™İs.h
>

6 
	~<x’/smp.h
>

7 
	~<asm/´oûssÜ.h
>

8 
	~<asm/m¤.h
>

9 
	~<asm/uacûss.h
>

10 
	~<asm/mp¥ec.h
>

11 
	~<asm/­ic.h
>

12 
	~<asm/i387.h
>

13 
	~<mach_­ic.h
>

14 
	~<asm/hvm/suµÜt.h
>

15 
	~<asm/£tup.h
>

17 
	~"ıu.h
"

19 
	#£Ëù_idË_routše
(
x
è(()0)

	)

21 
Œ­_š™_f00f_bug
();

23 #ifdeà
CONFIG_X86_INTEL_USERCOPY


27 
mov¦_mask
 mov¦_mask 
	g__»ad_mo¡ly
;

36 
__devš™
 
	$£t_ıuidmask
(cÚ¡ 
ıušfo_x86
 *
c
)

38 cÚ¡ *
exŒa
 = "";

40 ià(!~(
İt_ıuid_mask_ecx
 & 
İt_ıuid_mask_edx
 &

41 
İt_ıuid_mask_ext_ecx
 & 
İt_ıuid_mask_ext_edx
))

45 (
c
->
x86
 =ğ6è* c->
x86_mod–
) {

47 ià((
c
->
x86_mask
 & 0x0f) < 4)

51 
	`wrm¤
(
MSR_INTEL_CPUID_FEATURE_MASK
,

52 
İt_ıuid_mask_ecx
,

53 
İt_ıuid_mask_edx
);

54 ià(!~(
İt_ıuid_mask_ext_ecx
 & 
İt_ıuid_mask_ext_edx
))

56 
exŒa
 = "extended ";

65 ià((
c
->
x86_mask
 & 0x0f) <= 2)

70 
	`wrm¤
(
MSR_INTEL_CPUID1_FEATURE_MASK
,

71 
İt_ıuid_mask_ecx
,

72 
İt_ıuid_mask_edx
);

73 
	`wrm¤
(
MSR_INTEL_CPUID80000001_FEATURE_MASK
,

74 
İt_ıuid_mask_ext_ecx
,

75 
İt_ıuid_mask_ext_edx
);

79 
	`´štk
(
XENLOG_ERR
 "Cannot set CPU feature mask on CPU#%d\n",

80 
	`smp_´oûssÜ_id
());

81 
	}
}

83 
__devš™
 
	$—¾y_š‹l_wÜk¬ound
(
ıušfo_x86
 *
c
)

85 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
)

88 ià(
c
->
x86
 =ğ15 && c->
x86_ÿche_®ignm’t
 == 64)

89 
c
->
x86_ÿche_®ignm’t
 = 128;

92 ià(
c
->
x86
 > 6 || (c->x86 =ğ6 && c->
x86_mod–
 >= 0xd)) {

93 
u64
 
misc_’abË
;

95 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
);

97 ià(
misc_’abË
 & 
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
) {

98 
misc_’abË
 &ğ~
MSR_IA32_MISC_ENABLE_LIMIT_CPUID
;

99 
	`wrm¤l
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
);

100 
c
->
ıuid_Ëv–
 = 
	`ıuid_—x
(0);

101 
	`´štk
("»vi£d cpuid_Ëv– = %d\n", 
c
->
ıuid_Ëv–
);

104 
	}
}

110 
__devš™
 
	$IÁ–_”¿_wÜk¬ounds
(
ıušfo_x86
 *
c
)

112 
lo
, 
hi
;

114 ià((
c
->
x86
 =ğ15è&& (c->
x86_mod–
 =ğ1è&& (c->
x86_mask
 == 1)) {

115 
	`rdm¤
 (
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

116 ià((
lo
 & (1<<9)) == 0) {

117 
	`´štk
 (
KERN_INFO
 "CPU: C0 stepping P4 Xeon detected.\n");

118 
	`´štk
 (
KERN_INFO
 "CPU: Disabling hardware…refetching (Errata 037)\n");

119 
lo
 |= (1<<9);

120 
	`wrm¤
 (
MSR_IA32_MISC_ENABLE
, 
lo
, 
hi
);

123 
	}
}

129 
__devš™
 
	$num_ıu_cÜes
(
ıušfo_x86
 *
c
)

131 
—x
, 
ebx
, 
ecx
, 
edx
;

133 ià(
c
->
ıuid_Ëv–
 < 4)

137 
	`ıuid_couÁ
(4, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

138 ià(
—x
 & 0x1f)

139  ((
—x
 >> 26) + 1);

142 
	}
}

144 
__devš™
 
	$š™_š‹l
(
ıušfo_x86
 *
c
)

146 
l2
 = 0;

147 *
p
 = 
NULL
;

149 #ifdeà
CONFIG_X86_F00F_BUG


155 
c
->
f00f_bug
 = 0;

156 iàĞ
c
->
x86
 == 5 ) {

157 
f00f_wÜk¬ound_’abËd
 = 0;

159 
c
->
f00f_bug
 = 1;

160 iàĞ!
f00f_wÜk¬ound_’abËd
 ) {

161 
	`Œ­_š™_f00f_bug
();

162 
	`´štk
(
KERN_NOTICE
 "Intel Pentium with F0 0F bug - workaroundƒnabled.\n");

163 
f00f_wÜk¬ound_’abËd
 = 1;

169 
	`d‘eù_ex‹nded_tİŞogy
(
c
);

171 
	`£Ëù_idË_routše
(
c
);

172 
l2
 = 
	`š™_š‹l_ÿchešfo
(
c
);

173 ià(
c
->
ıuid_Ëv–
 > 9) {

174 
—x
 = 
	`ıuid_—x
(10);

176 ià((
—x
 & 0xff) && (((eax>>8) & 0xff) > 1))

177 
	`£t_b™
(
X86_FEATURE_ARCH_PERFMON
, 
c
->
x86_ÿ·b™y
);

181 ià((
c
->
x86
<<8 | c->
x86_mod–
<<4 | c->
x86_mask
) < 0x633)

182 
	`ş—r_b™
(
X86_FEATURE_SEP
, 
c
->
x86_ÿ·b™y
);

187 ià(
c
->
x86
 == 6) {

188 
c
->
x86_mod–
) {

190 ià(
c
->
x86_mask
 == 0) {

191 ià(
l2
 == 0)

192 
p
 = "Celeron (Covington)";

193 ià(
l2
 == 256)

194 
p
 = "Mobile Pentium II (Dixon)";

199 ià(
l2
 == 128)

200 
p
 = "Celeron (Mendocino)";

201 ià(
c
->
x86_mask
 == 0 || c->x86_mask == 5)

202 
p
 = "Celeron-A";

206 ià(
l2
 == 128)

207 
p
 = "Celeron (Coppermine)";

212 iàĞ
p
 )

213 
	`§ã_¡rıy
(
c
->
x86_mod–_id
, 
p
);

215 iàĞ!
	`ıu_has
(
c
, 
X86_FEATURE_XTOPOLOGY
) )

217 
c
->
x86_max_cÜes
 = 
	`num_ıu_cÜes
(c);

218 
	`d‘eù_ht
(
c
);

221 
	`£t_ıuidmask
(
c
);

224 
	`IÁ–_”¿_wÜk¬ounds
(
c
);

226 #ifdeà
CONFIG_X86_INTEL_USERCOPY


230 
c
->
x86
) {

236 
mov¦_mask
.
mask
 = 7;

239 
mov¦_mask
.
mask
 = 7;

244 ià(
c
->
x86
 == 15)

245 
	`£t_b™
(
X86_FEATURE_P4
, 
c
->
x86_ÿ·b™y
);

246 ià(
c
->
x86
 == 6)

247 
	`£t_b™
(
X86_FEATURE_P3
, 
c
->
x86_ÿ·b™y
);

248 ià((
c
->
x86
 =ğ0xà&& c->
x86_mod–
 >= 0x03) ||

249 (
c
->
x86
 =ğ0x6 && c->
x86_mod–
 >= 0x0e))

250 
	`£t_b™
(
X86_FEATURE_CONSTANT_TSC
, 
c
->
x86_ÿ·b™y
);

251 ià(
	`ıuid_edx
(0x80000007) & (1u<<8)) {

252 
	`£t_b™
(
X86_FEATURE_CONSTANT_TSC
, 
c
->
x86_ÿ·b™y
);

253 
	`£t_b™
(
X86_FEATURE_NONSTOP_TSC
, 
c
->
x86_ÿ·b™y
);

254 
	`£t_b™
(
X86_FEATURE_TSC_RELIABLE
, 
c
->
x86_ÿ·b™y
);

256 ià((
c
->
ıuid_Ëv–
 >= 0x00000006) &&

257 (
	`ıuid_—x
(0x00000006) & (1u<<2)))

258 
	`£t_b™
(
X86_FEATURE_ARAT
, 
c
->
x86_ÿ·b™y
);

259 
	}
}

262 
	$š‹l_size_ÿche
(
ıušfo_x86
 * 
c
, 
size
)

269 ià((
c
->
x86
 =ğ6è&& (c->
x86_mod–
 =ğ11è&& (
size
 == 0))

270 
size
 = 256;

271  
size
;

272 
	}
}

274 
ıu_dev
 
š‹l_ıu_dev
 
	g__devš™d©a
 = {

275 .
c_v’dÜ
 = "Intel",

276 .
	gc_id’t
 = { "GenuineIntel" },

277 .
	gc_mod–s
 = {

278 { .
v’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 4, .
	gmod–_Çmes
 =

291 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 5, .
	gmod–_Çmes
 =

302 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 6, .
	gmod–_Çmes
 =

316 { .
	gv’dÜ
 = 
X86_VENDOR_INTEL
, .
	gçmy
 = 15, .
	gmod–_Çmes
 =

326 .
	gc_š™
 = 
š™_š‹l
,

327 .
	gc_id’tify
 = 
g’”ic_id’tify
,

328 .
	gc_size_ÿche
 = 
š‹l_size_ÿche
,

331 
__š™
 
	$š‹l_ıu_š™
()

333 
ıu_devs
[
X86_VENDOR_INTEL
] = &
š‹l_ıu_dev
;

335 
	}
}

	@cpu/intel_cacheinfo.c

10 
	~<x’/cÚfig.h
>

11 
	~<x’/š™.h
>

12 
	~<x’/lib.h
>

13 
	~<x’/”ºo.h
>

14 
	~<asm/´oûssÜ.h
>

16 
	#LVL_1_INST
 1

	)

17 
	#LVL_1_DATA
 2

	)

18 
	#LVL_2
 3

	)

19 
	#LVL_3
 4

	)

20 
	#LVL_TRACE
 5

	)

22 
	s_ÿche_bË


24 
	mdesütÜ
;

25 
	mÿche_ty³
;

26 
	msize
;

30 
_ÿche_bË
 
	gÿche_bË
[] 
	g__ıuš™d©a
 =

32 { 0x06, 
LVL_1_INST
, 8 },

33 { 0x08, 
LVL_1_INST
, 16 },

34 { 0x0a, 
LVL_1_DATA
, 8 },

35 { 0x0c, 
LVL_1_DATA
, 16 },

36 { 0x22, 
LVL_3
, 512 },

37 { 0x23, 
LVL_3
, 1024 },

38 { 0x25, 
LVL_3
, 2048 },

39 { 0x29, 
LVL_3
, 4096 },

40 { 0x2c, 
LVL_1_DATA
, 32 },

41 { 0x30, 
LVL_1_INST
, 32 },

42 { 0x39, 
LVL_2
, 128 },

43 { 0x3a, 
LVL_2
, 192 },

44 { 0x3b, 
LVL_2
, 128 },

45 { 0x3c, 
LVL_2
, 256 },

46 { 0x3d, 
LVL_2
, 384 },

47 { 0x3e, 
LVL_2
, 512 },

48 { 0x41, 
LVL_2
, 128 },

49 { 0x42, 
LVL_2
, 256 },

50 { 0x43, 
LVL_2
, 512 },

51 { 0x44, 
LVL_2
, 1024 },

52 { 0x45, 
LVL_2
, 2048 },

53 { 0x46, 
LVL_3
, 4096 },

54 { 0x47, 
LVL_3
, 8192 },

55 { 0x49, 
LVL_3
, 4096 },

56 { 0x4a, 
LVL_3
, 6144 },

57 { 0x4b, 
LVL_3
, 8192 },

58 { 0x4c, 
LVL_3
, 12288 },

59 { 0x4d, 
LVL_3
, 16384 },

60 { 0x60, 
LVL_1_DATA
, 16 },

61 { 0x66, 
LVL_1_DATA
, 8 },

62 { 0x67, 
LVL_1_DATA
, 16 },

63 { 0x68, 
LVL_1_DATA
, 32 },

64 { 0x70, 
LVL_TRACE
, 12 },

65 { 0x71, 
LVL_TRACE
, 16 },

66 { 0x72, 
LVL_TRACE
, 32 },

67 { 0x73, 
LVL_TRACE
, 64 },

68 { 0x78, 
LVL_2
, 1024 },

69 { 0x79, 
LVL_2
, 128 },

70 { 0x7a, 
LVL_2
, 256 },

71 { 0x7b, 
LVL_2
, 512 },

72 { 0x7c, 
LVL_2
, 1024 },

73 { 0x7d, 
LVL_2
, 2048 },

74 { 0x7f, 
LVL_2
, 512 },

75 { 0x82, 
LVL_2
, 256 },

76 { 0x83, 
LVL_2
, 512 },

77 { 0x84, 
LVL_2
, 1024 },

78 { 0x85, 
LVL_2
, 2048 },

79 { 0x86, 
LVL_2
, 512 },

80 { 0x87, 
LVL_2
, 1024 },

85 
	e_ÿche_ty³


87 
	mCACHE_TYPE_NULL
 = 0,

88 
	mCACHE_TYPE_DATA
 = 1,

89 
	mCACHE_TYPE_INST
 = 2,

90 
	mCACHE_TYPE_UNIFIED
 = 3

93 
	u_ıuid4_Ëaf_—x
 {

95 
_ÿche_ty³
 
	mty³
:5;

96 
	mËv–
:3;

97 
	mis_£lf_š™Ÿlizšg
:1;

98 
	mis_fuÎy_assocŸtive
:1;

99 
	m»£rved
:4;

100 
	mnum_th»ads_sh¬šg
:12;

101 
	mnum_cÜes_Ú_d›
:6;

102 } 
	m¥l™
;

103 
u32
 
	mfuÎ
;

106 
	u_ıuid4_Ëaf_ebx
 {

108 
	mcoh”’cy_lše_size
:12;

109 
	mphysiÿl_lše_·¹™iÚ
:10;

110 
	mways_of_assocŸtiv™y
:10;

111 } 
	m¥l™
;

112 
u32
 
	mfuÎ
;

115 
	u_ıuid4_Ëaf_ecx
 {

117 
	mnumb”_of_£ts
:32;

118 } 
	m¥l™
;

119 
u32
 
	mfuÎ
;

122 
	s_ıuid4_šfo
 {

123 
_ıuid4_Ëaf_—x
 
	m—x
;

124 
_ıuid4_Ëaf_ebx
 
	mebx
;

125 
_ıuid4_Ëaf_ecx
 
	mecx
;

126 
	msize
;

127 
ıumask_t
 
	msh¬ed_ıu_m­
;

130 
	gnum_ÿche_Ëaves
;

132 
__ıuš™
 
	$ıuid4_ÿche_lookup
(
šdex
, 
_ıuid4_šfo
 *
this_Ëaf
)

134 
_ıuid4_Ëaf_—x
 
—x
;

135 
_ıuid4_Ëaf_ebx
 
ebx
;

136 
_ıuid4_Ëaf_ecx
 
ecx
;

137 
edx
;

139 
	`ıuid_couÁ
(4, 
šdex
, &
—x
.
fuÎ
, &
ebx
.fuÎ, &
ecx
.fuÎ, &
edx
);

140 ià(
—x
.
¥l™
.
ty³
 =ğ
CACHE_TYPE_NULL
)

141  -
EIO
;

143 
this_Ëaf
->
—x
 =ƒax;

144 
this_Ëaf
->
ebx
 =ƒbx;

145 
this_Ëaf
->
ecx
 =ƒcx;

146 
this_Ëaf
->
size
 = (
ecx
.
¥l™
.
numb”_of_£ts
 + 1) *

147 (
ebx
.
¥l™
.
coh”’cy_lše_size
 + 1) *

148 (
ebx
.
¥l™
.
physiÿl_lše_·¹™iÚ
 + 1) *

149 (
ebx
.
¥l™
.
ways_of_assocŸtiv™y
 + 1);

151 
	}
}

153 
__ıuš™
 
	$fšd_num_ÿche_Ëaves
()

155 
—x
, 
ebx
, 
ecx
, 
edx
;

156 
_ıuid4_Ëaf_—x
 
ÿche_—x
;

157 
i
 = -1;

160 ++
i
;

162 
	`ıuid_couÁ
(4, 
i
, &
—x
, &
ebx
, &
ecx
, &
edx
);

163 
ÿche_—x
.
fuÎ
 = 
—x
;

164 } 
ÿche_—x
.
¥l™
.
ty³
 !ğ
CACHE_TYPE_NULL
);

165  
i
;

166 
	}
}

168 
__ıuš™
 
	$š™_š‹l_ÿchešfo
(
ıušfo_x86
 *
c
)

170 
Œaû
 = 0, 
l1i
 = 0, 
l1d
 = 0, 
l2
 = 0, 
l3
 = 0;

171 
Ãw_l1d
 = 0, 
Ãw_l1i
 = 0;

172 
Ãw_l2
 = 0, 
Ãw_l3
 = 0, 
i
;

173 
l2_id
 = 0, 
l3_id
 = 0, 
num_th»ads_sh¬šg
, 
šdex_msb
;

175 ià(
c
->
ıuid_Ëv–
 > 3) {

176 
is_š™Ÿlized
;

178 ià(
is_š™Ÿlized
 == 0) {

180 
num_ÿche_Ëaves
 = 
	`fšd_num_ÿche_Ëaves
();

181 
is_š™Ÿlized
++;

188 
i
 = 0; i < 
num_ÿche_Ëaves
; i++) {

189 
_ıuid4_šfo
 
this_Ëaf
;

191 
»tv®
;

193 
»tv®
 = 
	`ıuid4_ÿche_lookup
(
i
, &
this_Ëaf
);

194 ià(
»tv®
 >= 0) {

195 
this_Ëaf
.
—x
.
¥l™
.
Ëv–
) {

197 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

198 
CACHE_TYPE_DATA
)

199 
Ãw_l1d
 = 
this_Ëaf
.
size
/1024;

200 ià(
this_Ëaf
.
—x
.
¥l™
.
ty³
 ==

201 
CACHE_TYPE_INST
)

202 
Ãw_l1i
 = 
this_Ëaf
.
size
/1024;

205 
Ãw_l2
 = 
this_Ëaf
.
size
/1024;

206 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

207 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

208 
l2_id
 = 
c
->
­icid
 >> 
šdex_msb
;

211 
Ãw_l3
 = 
this_Ëaf
.
size
/1024;

212 
num_th»ads_sh¬šg
 = 1 + 
this_Ëaf
.
—x
.
¥l™
.num_threads_sharing;

213 
šdex_msb
 = 
	`g‘_couÁ_Üd”
(
num_th»ads_sh¬šg
);

214 
l3_id
 = 
c
->
­icid
 >> 
šdex_msb
;

226 ià((
num_ÿche_Ëaves
 =ğ0 || 
c
->
x86
 =ğ15è&& c->
ıuid_Ëv–
 > 1) {

228 
i
, 
j
, 
n
;

229 
»gs
[4];

230 *
dp
 = (*)
»gs
;

231 
Úly_Œaû
 = 0;

233 ià(
num_ÿche_Ëaves
 !ğ0 && 
c
->
x86
 == 15)

234 
Úly_Œaû
 = 1;

237 
n
 = 
	`ıuid_—x
(2) & 0xFF;

239  
i
 = 0 ; i < 
n
 ; i++ ) {

240 
	`ıuid
(2, &
»gs
[0], &regs[1], &regs[2], &regs[3]);

243  
j
 = 0 ; j < 3 ; j++ ) {

244 iàĞ
»gs
[
j
] < 0 )„egs[j] = 0;

248  
j
 = 1 ; j < 16 ; j++ ) {

249 
des
 = 
dp
[
j
];

250 
k
 = 0;

253 
ÿche_bË
[
k
].
desütÜ
 != 0)

255 ià(
ÿche_bË
[
k
].
desütÜ
 =ğ
des
) {

256 ià(
Úly_Œaû
 && 
ÿche_bË
[
k
].
ÿche_ty³
 !ğ
LVL_TRACE
)

258 
ÿche_bË
[
k
].
ÿche_ty³
) {

259 
LVL_1_INST
:

260 
l1i
 +ğ
ÿche_bË
[
k
].
size
;

262 
LVL_1_DATA
:

263 
l1d
 +ğ
ÿche_bË
[
k
].
size
;

265 
LVL_2
:

266 
l2
 +ğ
ÿche_bË
[
k
].
size
;

268 
LVL_3
:

269 
l3
 +ğ
ÿche_bË
[
k
].
size
;

271 
LVL_TRACE
:

272 
Œaû
 +ğ
ÿche_bË
[
k
].
size
;

279 
k
++;

285 ià(
Ãw_l1d
)

286 
l1d
 = 
Ãw_l1d
;

288 ià(
Ãw_l1i
)

289 
l1i
 = 
Ãw_l1i
;

291 ià(
Ãw_l2
) {

292 
l2
 = 
Ãw_l2
;

295 ià(
Ãw_l3
) {

296 
l3
 = 
Ãw_l3
;

299 ià(
İt_ıu_šfo
) {

300 ià(
Œaû
)

301 
	`´štk
("CPU: T¿û cache: %dK uİs", 
Œaû
);

302 iàĞ
l1i
 )

303 
	`´štk
("CPU: L1 I cache: %dK", 
l1i
);

305 ià(
l1d
)

306 
	`´štk
(", L1 D cache: %dK\n", 
l1d
);

308 
	`´štk
("\n");

310 ià(
l2
)

311 
	`´štk
("CPU: L2 cache: %dK\n", 
l2
);

313 ià(
l3
)

314 
	`´štk
("CPU: L3 cache: %dK\n", 
l3
);

317 
c
->
x86_ÿche_size
 = 
l3
 ?†3 : (
l2
 ?†2 : (
l1i
+
l1d
));

319  
l2
;

320 
	}
}

	@cpu/mcheck/amd_f10.c

38 
	~<x’/š™.h
>

39 
	~<x’/ty³s.h
>

40 
	~<x’/k”Ãl.h
>

41 
	~<x’/cÚfig.h
>

42 
	~<x’/smp.h
>

44 
	~<asm/´oûssÜ.h
>

45 
	~<asm/sy¡em.h
>

46 
	~<asm/m¤.h
>

48 
	~"mû.h
"

49 
	~"x86_mÿ.h
"

52 
mcšfo_ex‹nded
 *

53 
	$amd_f10_hªdËr
(
mc_šfo
 *
mi
, 
ušt16_t
 
bªk
, 
ušt64_t
 
¡©us
)

55 
mcšfo_ex‹nded
 *
mc_ext
;

59 ià(
mi
 =ğ
NULL
 || 
bªk
 != 4)

60  
NULL
;

62 ià(!(
¡©us
 & 
MCi_STATUS_VAL
))

63  
NULL
;

65 ià(!(
¡©us
 & 
MCi_STATUS_MISCV
))

66  
NULL
;

68 
mc_ext
 = 
	`x86_mcšfo_»£rve
(
mi
, (
mcšfo_ex‹nded
));

69 ià(!
mc_ext
)

71 
mi
->
æags
 |ğ
MCINFO_FLAGS_UNCOMPLETE
;

72  
NULL
;

75 
	`mem£t
(
mc_ext
, 0, (mc_ext));

76 
mc_ext
->
commÚ
.
ty³
 = 
MC_TYPE_EXTENDED
;

77 
mc_ext
->
commÚ
.
size
 = (mc_ext);

78 
mc_ext
->
mc_m¤s
 = 3;

80 
mc_ext
->
mc_m¤
[0].
»g
 = 
MSR_F10_MC4_MISC1
;

81 
mc_ext
->
mc_m¤
[1].
»g
 = 
MSR_F10_MC4_MISC2
;

82 
mc_ext
->
mc_m¤
[2].
»g
 = 
MSR_F10_MC4_MISC3
;

84 
mc_ext
->
mc_m¤
[0].
v®ue
 = 
	`mÿ_rdm¤
(
MSR_F10_MC4_MISC1
);

85 
mc_ext
->
mc_m¤
[1].
v®ue
 = 
	`mÿ_rdm¤
(
MSR_F10_MC4_MISC2
);

86 
mc_ext
->
mc_m¤
[2].
v®ue
 = 
	`mÿ_rdm¤
(
MSR_F10_MC4_MISC3
);

88  
mc_ext
;

89 
	}
}

92 
mcheck_ty³
 
	$amd_f10_mcheck_š™
(
ıušfo_x86
 *
c
)

94 ià(
	`amd_k8_mcheck_š™
(
c
è=ğ
mcheck_nÚe
)

95  
mcheck_nÚe
;

97 
	`x86_mû_ÿÎback_»gi¡”
(
amd_f10_hªdËr
);

99  
mcheck_amd_çmXX
;

100 
	}
}

	@cpu/mcheck/amd_k8.c

55 
	~<x’/cÚfig.h
>

56 
	~<x’/š™.h
>

57 
	~<x’/ty³s.h
>

58 
	~<x’/k”Ãl.h
>

59 
	~<x’/smp.h
>

60 
	~<x’/sched.h
>

61 
	~<x’/sched-if.h
>

62 
	~<x’/soáœq.h
>

64 
	~<asm/´oûssÜ.h
>

65 
	~<asm/sh¬ed.h
>

66 
	~<asm/sy¡em.h
>

67 
	~<asm/m¤.h
>

69 
	~"mû.h
"

70 
	~"mû_quœks.h
"

73 
	$k8_machše_check
(
ıu_u£r_»gs
 *
»gs
, 
”rÜ_code
)

75 
	`mcheck_cmn_hªdËr
(
»gs
, 
”rÜ_code
, 
mÿ_®lbªks
);

76 
	}
}

79 
mcheck_ty³
 
	$amd_k8_mcheck_š™
(
ıušfo_x86
 *
c
)

81 
ušt32_t
 
i
;

82 
mûquœk_amd_æags
 
quœkæag
;

84 
quœkæag
 = 
	`mûquœk_lookup_amd_quœkd©a
(
c
);

86 
	`x86_mû_veùÜ_»gi¡”
(
k8_machše_check
);

88 
i
 = 0; i < 
Ä_mû_bªks
; i++) {

89 ià(
quœkæag
 =ğ
MCEQUIRK_K8_GART
 && 
i
 == 4) {

90 
	`mûquœk_amd_­¶y
(
quœkæag
);

93 
	`wrm¤l
(
	`MSR_IA32_MCx_CTL
(
i
), 0xffffffffffffffffULL);

94 
	`wrm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

98  
mcheck_amd_k8
;

99 
	}
}

	@cpu/mcheck/amd_nonfatal.c

54 
	~<x’/cÚfig.h
>

55 
	~<x’/š™.h
>

56 
	~<x’/ty³s.h
>

57 
	~<x’/k”Ãl.h
>

58 
	~<x’/smp.h
>

59 
	~<x’/tim”.h
>

60 
	~<x’/ev’t.h
>

62 
	~<asm/´oûssÜ.h
>

63 
	~<asm/sy¡em.h
>

64 
	~<asm/m¤.h
>

66 
	~"mû.h
"

68 
tim”
 
	gmû_tim”
;

70 
	#MCE_PERIOD
 
	`MILLISECS
(10000)

	)

71 
	#MCE_MIN
 
	`MILLISECS
(2000)

	)

72 
	#MCE_MAX
 
	`MILLISECS
(30000)

	)

74 
s_time_t
 
	g³riod
 = 
MCE_PERIOD
;

75 
	ghw_th»shŞd
 = 0;

76 
	gadju¡
 = 0;

77 
	gv¬ŸbË_³riod
 = 1;

83 
	$mû_amd_check»gs
(*
šfo
)

85 
mù–em_cook›_t
 
mùc
;

86 
mÿ_summ¬y
 
bs
;

88 
mùc
 = 
	`mcheck_mÿ_logout
(
MCA_POLLER
, 
mÿ_®lbªks
, &
bs
, 
NULL
);

90 ià(
bs
.
”rút
 && 
mùc
 !ğ
NULL
) {

91 
ušt64_t
 
dumpcouÁ
 = 0;

101 ià(
	`dom0_vmû_’abËd
()) {

102 
	`mù–em_comm™
(
mùc
);

103 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

104 } ià(++
dumpcouÁ
 >= 10) {

105 
	`x86_mcšfo_dump
((
mc_šfo
 *)
	`mù–em_d©­Œ
(
mùc
));

106 
	`mù–em_dismiss
(
mùc
);

108 
	`mù–em_dismiss
(
mùc
);

111 } ià(
mùc
 !ğ
NULL
) {

112 
	`mù–em_dismiss
(
mùc
);

120 ià(
bs
.
”rút
)

121 
adju¡
++;

122 
	}
}

131 
	$mû_amd_wÜk_â
(*
d©a
)

133 
	`Ú_—ch_ıu
(
mû_amd_check»gs
, 
d©a
, 1);

135 ià(
adju¡
 > 0) {

136 ià(!
	`dom0_vmû_’abËd
()) {

138 
	`´štk
("MCE:…olling„outine found correctableƒrror. "

143 ià(
hw_th»shŞd
) {

144 
ušt64_t
 
v®ue
;

145 
ušt32_t
 
couÁ”
;

147 
v®ue
 = 
	`mÿ_rdm¤
(
MSR_IA32_MC4_MISC
);

151 
couÁ”
 = (
v®ue
 & 0xFFF00000000ULL) >> 32U;

156 ià(
couÁ”
 > 0) {

160 ià(
adju¡
 == 0) {

161 
	`´štk
("CPU couÁ”„•Üt %"
PRIu32


164 
couÁ”
,

165 (
couÁ”
 == 1 ? "" : "s"),

166 (
couÁ”
 == 1 ? "was" : "were"));

170 
adju¡
 +ğ(
couÁ”
 - 1);

174 
v®ue
 &= ~(0x60FFF00000000ULL);

176 
v®ue
 |= (1ULL << 51);

177 
	`mÿ_wrm¤
(
MSR_IA32_MC4_MISC
, 
v®ue
);

178 
	`wmb
();

182 ià(
v¬ŸbË_³riod
 && 
adju¡
 > 0) {

184 
adju¡
++;

185 
³riod
 /ğ
adju¡
;

186 } ià(
v¬ŸbË_³riod
) {

188 
³riod
 *= 2;

190 ià(
v¬ŸbË_³riod
 && 
³riod
 > 
MCE_MAX
) {

192 
³riod
 = 
MCE_MAX
;

194 ià(
v¬ŸbË_³riod
 && 
³riod
 < 
MCE_MIN
) {

199 
³riod
 = 
MCE_MIN
;

202 
	`£t_tim”
(&
mû_tim”
, 
	`NOW
(è+ 
³riod
);

203 
adju¡
 = 0;

204 
	}
}

206 
	$amd_nÚçl_mcheck_š™
(
ıušfo_x86
 *
c
)

208 ià(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
)

215 ià(
v¬ŸbË_³riod
 && 
	`ıu_has
(
c
, 
X86_FEATURE_SVM
)) {

216 
ušt64_t
 
v®ue
;

219 
hw_th»shŞd
 = 1;

220 
	`rdm¤l
(
MSR_IA32_MC4_MISC
, 
v®ue
);

222 ià(
v®ue
 & (1ULL << 61)) {

224 
hw_th»shŞd
 = 0;

226 ià(!(
v®ue
 & (1ULL << 63))) {

228 
hw_th»shŞd
 = 0;

230 ià(!(
v®ue
 & (1ULL << 62))) {

232 
hw_th»shŞd
 = 0;

236 ià(
hw_th»shŞd
) {

238 
v®ue
 &= ~(0x60FFF00000000ULL);

240 
v®ue
 |= (1ULL << 51);

241 
	`wrm¤l
(
MSR_IA32_MC4_MISC
, 
v®ue
);

243 
	`wmb
();

244 
	`´štk
(
XENLOG_INFO
 "MCA: Use hwhresholdingo‡djust…olling frequency\n");

248 
	`š™_tim”
(&
mû_tim”
, 
mû_amd_wÜk_â
, 
NULL
, 0);

249 
	`£t_tim”
(&
mû_tim”
, 
	`NOW
(è+ 
³riod
);

252 
	}
}

	@cpu/mcheck/k7.c

6 
	~<x’/š™.h
>

7 
	~<x’/ty³s.h
>

8 
	~<x’/k”Ãl.h
>

9 
	~<x’/cÚfig.h
>

10 
	~<x’/smp.h
>

12 
	~<asm/´oûssÜ.h
>

13 
	~<asm/sy¡em.h
>

14 
	~<asm/m¤.h
>

16 
	~"mû.h
"

17 
	~"x86_mÿ.h
"

20 
ç¡ÿÎ
 
	$k7_machše_check
(
ıu_u£r_»gs
 * 
»gs
, 
”rÜ_code
)

22 
»cov”
 = 1;

23 
ušt64_t
 
m¤_cÚ‹Á
, 
mcg¡
;

24 
i
;

26 
	`rdm¤l
(
MSR_IA32_MCG_STATUS
, 
mcg¡
);

27 ià(
mcg¡
 & 
MCG_STATUS_RIPV
)

28 
»cov”
 = 0;

30 
	`´štk
(
KERN_EMERG
 "CPU %d: MachšCheck Exû±iÚ: 0x%016"
PRIx64
"\n",

31 
	`smp_´oûssÜ_id
(), 
mcg¡
);

33 
i
 = 1; i < 
Ä_mû_bªks
; i++) {

34 
ušt64_t
 
v®ue
;

36 
	`rdm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 
m¤_cÚ‹Á
);

37 ià(
m¤_cÚ‹Á
 & 
MCi_STATUS_VAL
) {

38 ià(
m¤_cÚ‹Á
 & 
MCi_STATUS_UC
)

39 
»cov”
 |= 1;

40 ià(
m¤_cÚ‹Á
 & 
MCi_STATUS_PCC
)

41 
»cov”
 |= 2;

42 
	`´štk
(
KERN_EMERG
 "Bªk %d: 0x%16"
PRIx64
,

43 
i
, 
m¤_cÚ‹Á
);

44 
m¤_cÚ‹Á
 &ğ~
MCi_STATUS_VAL
;

45 ià(
m¤_cÚ‹Á
 & 
MCi_STATUS_MISCV
) {

46 
	`rdm¤l
(
	`MSR_IA32_MCx_MISC
(
i
), 
v®ue
);

47 
	`´štk
("[0x%016"
PRIx64
"]", 
v®ue
);

49 ià(
m¤_cÚ‹Á
 & 
MCi_STATUS_ADDRV
) {

50 
	`rdm¤l
(
	`MSR_IA32_MCx_ADDR
(
i
), 
v®ue
);

51 
	`´štk
("‡ˆ0x%016"
PRIx64
, 
v®ue
);

53 
	`´štk
("\n");

55 
	`wrm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

57 
	`wmb
();

58 
	`add_št
(
TAINT_MACHINE_CHECK
);

62 ià(
»cov”
 & 2)

63 
	`mc_·nic
("CPU context corrupt");

64 ià(
»cov”
 & 1)

65 
	`mc_·nic
("Unableo continue");

66 
	`´štk
(
KERN_EMERG
 "Attemptingo continue.\n");

67 
mcg¡
 &ğ~
MCG_STATUS_MCIP
;

68 
	`wrm¤l
(
MSR_IA32_MCG_STATUS
, 
mcg¡
);

69 
	}
}

73 
mcheck_ty³
 
	$amd_k7_mcheck_š™
(
ıušfo_x86
 *
c
)

75 
i
;

77 
	`x86_mû_veùÜ_»gi¡”
(
k7_machše_check
);

81 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
, 0x0ULL);

82 
i
 = 1; i < 
Ä_mû_bªks
; i++) {

83 
	`wrm¤l
(
	`MSR_IA32_MCx_CTL
(
i
), 0xffffffffffffffffULL);

84 
	`wrm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

87  
mcheck_amd_k7
;

88 
	}
}

	@cpu/mcheck/mce-apei.c

32 
	~<x’/k”Ãl.h
>

33 
	~<x’/ı”.h
>

34 
	~<x’/”ºo.h
>

35 
	~<aıi/aıi.h
>

36 
	~<aıi/­ei.h
>

38 
	~"mû.h
"

40 
	#CPER_CREATOR_MCE
 \

41 
	`UUID_LE
(0x75a574e3, 0x5052, 0x4b29, 0x8a, 0x8e, 0xbe, 0x2c, \

42 0x64, 0x90, 0xb8, 0x9d)

	)

43 
	#CPER_SECTION_TYPE_MCE
 \

44 
	`UUID_LE
(0xfe08ffbe, 0x95e4, 0x4be7, 0xbc, 0x73, 0x40, 0x96, \

45 0x04, 0x4a, 0x38, 0xfc)

	)

47 #´agm¨
·ck
(1)

52 
	sı”_mû_»cÜd
 {

53 
ı”_»cÜd_h—d”
 
	mhdr
;

54 
ı”_£ùiÚ_desütÜ
 
	m£c_hdr
;

55 
mû
 
	mmû
;

56 } 
	g__·cked
;

58 #´agm¨
·ck
()

60 
	$­ei_wr™e_mû
(
mû
 *
m
)

62 
ı”_mû_»cÜd
 
rcd
;

64 ià(!
m
)

65  -
EINVAL
;

67 
	`mem£t
(&
rcd
, 0, (rcd));

68 
	`memıy
(
rcd
.
hdr
.
sigÇtu»
, 
CPER_SIG_RECORD
, 
CPER_SIG_SIZE
);

69 
rcd
.
hdr
.
»visiÚ
 = 
CPER_RECORD_REV
;

70 
rcd
.
hdr
.
sigÇtu»_’d
 = 
CPER_SIG_END
;

71 
rcd
.
hdr
.
£ùiÚ_couÁ
 = 1;

72 
rcd
.
hdr
.
”rÜ_£v”™y
 = 
CPER_SER_FATAL
;

74 
rcd
.
hdr
.
v®id©iÚ_b™s
 = 0;

75 
rcd
.
hdr
.
»cÜd_Ëngth
 = (rcd);

76 
rcd
.
hdr
.
ü—tÜ_id
 = 
CPER_CREATOR_MCE
;

77 
rcd
.
hdr
.
nÙifiÿtiÚ_ty³
 = 
CPER_NOTIFY_MCE
;

78 
rcd
.
hdr
.
»cÜd_id
 = 
	`ı”_Ãxt_»cÜd_id
();

79 
rcd
.
hdr
.
æags
 = 
CPER_HW_ERROR_FLAGS_PREVERR
;

81 
rcd
.
£c_hdr
.
£ùiÚ_off£t
 = (*)&rcd.
mû
 - (*)&rcd;

82 
rcd
.
£c_hdr
.
£ùiÚ_Ëngth
 = Ôcd.
mû
);

83 
rcd
.
£c_hdr
.
»visiÚ
 = 
CPER_SEC_REV
;

85 
rcd
.
£c_hdr
.
v®id©iÚ_b™s
 = 0;

86 
rcd
.
£c_hdr
.
æags
 = 
CPER_SEC_PRIMARY
;

87 
rcd
.
£c_hdr
.
£ùiÚ_ty³
 = 
CPER_SECTION_TYPE_MCE
;

88 
rcd
.
£c_hdr
.
£ùiÚ_£v”™y
 = 
CPER_SER_FATAL
;

90 
	`memıy
(&
rcd
.
mû
, 
m
, (*m));

92  
	`”¡_wr™e
(&
rcd
.
hdr
);

93 
	}
}

95 
size_t
 
	$­ei_»ad_mû
(
mû
 *
m
, 
u64
 *
»cÜd_id
)

97 
ı”_mû_»cÜd
 
rcd
;

98 
size_t
 
Ën
;

100 ià(!
m
 || !
»cÜd_id
)

101  -
EINVAL
;

103 
Ën
 = 
	`”¡_»ad_Ãxt
(&
rcd
.
hdr
, (rcd));

104 ià(
Ën
 <= 0)

105  
Ën
;

107 ià(
Ën
 !ğ(
rcd
) ||

108 
	`uuid_Ë_cmp
(
rcd
.
hdr
.
ü—tÜ_id
, 
CPER_CREATOR_MCE
)) {

109 
	`´štk
(
KERN_WARNING


111  -
EIO
;

114 
	`memıy
(
m
, &
rcd
.
mû
, (*m));

115 *
»cÜd_id
 = 
rcd
.
hdr
.record_id;

117  (*
m
);

118 
	}
}

121 
	$­ei_check_mû
()

123  
	`”¡_g‘_»cÜd_couÁ
();

124 
	}
}

126 
	$­ei_ş—r_mû
(
u64
 
»cÜd_id
)

128  
	`”¡_ş—r
(
»cÜd_id
);

129 
	}
}

	@cpu/mcheck/mce.c

6 
	~<x’/š™.h
>

7 
	~<x’/ty³s.h
>

8 
	~<x’/k”Ãl.h
>

9 
	~<x’/cÚfig.h
>

10 
	~<x’/smp.h
>

11 
	~<x’/”ºo.h
>

12 
	~<x’/cÚsŞe.h
>

13 
	~<x’/sched.h
>

14 
	~<x’/sched-if.h
>

15 
	~<x’/ıumask.h
>

16 
	~<x’/ev’t.h
>

17 
	~<x’/gue¡_acûss.h
>

18 
	~<x’/hy³rÿÎ.h
>

19 
	~<x’/ıu.h
>

21 
	~<asm/´oûssÜ.h
>

22 
	~<asm/sy¡em.h
>

23 
	~<asm/m¤.h
>

25 
	~"mû.h
"

27 
boŞ_t
 
__»ad_mo¡ly
 
	gmû_di§bËd
;

28 
švboŞ_·¿m
("mû", 
mû_di§bËd
);

29 
boŞ_t
 
__»ad_mo¡ly
 
	gmû_brßdÿ¡
 = 0;

30 
boŞ_t
 
	gis_mc_·nic
;

31 
__»ad_mo¡ly
 
	gÄ_mû_bªks
;

32 
__»ad_mo¡ly
 
	gfœ¡bªk
;

34 
šo£_š™
();

35 
mcšfo_ş—r
(
mc_šfo
 *);

36 
mÿ_bªks
 *
	gmÿ_®lbªks
;

38 
	#SEG_PL
(
£g£l
è((£g£lè& 0x3)

	)

39 
	#_MC_MSRINJ_F_REQ_HWCR_WREN
 (1 << 16)

	)

42 
	$x86_mû¼
(cÚ¡ *
msg
, 
”r
)

44 
	`gd´štk
(
XENLOG_WARNING
, "x86_mcerr: %s,„eturning %d\n",

45 
msg
 !ğ
NULL
 ? msg : "", 
”r
);

46  
”r
;

47 
	}
}

49 
	#x86_mû¼
(
msg
, 
”r
èÓ¼)

	)

52 
	gmû_v”bos™y
;

53 
__š™
 
	$mû_£t_v”bos™y
(*
¡r
)

55 ià(
	`¡rcmp
("v”bo£", 
¡r
) == 0)

56 
mû_v”bos™y
 = 
MCE_VERBOSE
;

58 
	`´štk
(
KERN_DEBUG
 "Machine Check verbosity†evel %s‚ot„ecognised"

59 "u£ mû_v”bos™y=v”bo£", 
¡r
);

60 
	}
}

61 
cu¡om_·¿m
("mû_v”bos™y", 
mû_£t_v”bos™y
);

64 
	$uÃx³ùed_machše_check
(
ıu_u£r_»gs
 *
»gs
, 
”rÜ_code
)

66 
	`´štk
(
XENLOG_ERR
 "CPU#%d: Unexpected int18 (Machine Check).\n",

67 
	`smp_´oûssÜ_id
());

68 
	}
}

71 
x86_mû_veùÜ_t
 
	g_machše_check_veùÜ
 = 
uÃx³ùed_machše_check
;

73 
	$x86_mû_veùÜ_»gi¡”
(
x86_mû_veùÜ_t
 
hdÌ
)

75 
_machše_check_veùÜ
 = 
hdÌ
;

76 
	`wmb
();

77 
	}
}

81 
	$machše_check_veùÜ
(
ıu_u£r_»gs
 *
»gs
, 
”rÜ_code
)

83 
	`_machše_check_veùÜ
(
»gs
, 
”rÜ_code
);

84 
	}
}

91 
x86_mû_ÿÎback_t
 
	gmc_ÿÎback_bªk_ex‹nded
 = 
NULL
;

93 
	$x86_mû_ÿÎback_»gi¡”
(
x86_mû_ÿÎback_t
 
cbfunc
)

95 
mc_ÿÎback_bªk_ex‹nded
 = 
cbfunc
;

96 
	}
}

101 
mû_»cov”abË_t
 
	gmc_»cov”abË_sÿn
 = 
NULL
;

103 
	$mû_»cov”abË_»gi¡”
(
mû_»cov”abË_t
 
cbfunc
)

105 
mc_»cov”abË_sÿn
 = 
cbfunc
;

106 
	}
}

108 
mÿ_bªks
 *
	$mÿbªks_®loc
()

110 
mÿ_bªks
 *
mb
;

112 
mb
 = 
	`xm®loc
(
mÿ_bªks
);

113 ià(!
mb
)

114  
NULL
;

116 
mb
->
bªk_m­
 = 
	`xm®loc_¬¿y
(,

117 
	`BITS_TO_LONGS
(
Ä_mû_bªks
));

118 ià(!
mb
->
bªk_m­
)

120 
	`xä“
(
mb
);

121  
NULL
;

124 
mb
->
num
 = 
Ä_mû_bªks
;

125 
	`mem£t
(
mb
->
bªk_m­
, 0, (è* 
	`BITS_TO_LONGS
(
Ä_mû_bªks
));

127  
mb
;

128 
	}
}

130 
	$mÿbªks_ä“
(
mÿ_bªks
 *
bªks
)

132 ià(
bªks
 =ğ
NULL
)

134 ià(
bªks
->
bªk_m­
)

135 
	`xä“
(
bªks
->
bªk_m­
);

136 
	`xä“
(
bªks
);

137 
	}
}

143 
mû_Ãed_ş—rbªk_t
 
	gmc_Ãed_ş—rbªk_sÿn
 = 
NULL
;

145 
	$mû_Ãed_ş—rbªk_»gi¡”
(
mû_Ãed_ş—rbªk_t
 
cbfunc
)

147 
mc_Ãed_ş—rbªk_sÿn
 = 
cbfunc
;

148 
	}
}

150 
mcšfo_bªk
 *
	$mÿ_š™_bªk
(
mÿ_sourû
 
who
,

151 
mc_šfo
 *
mi
, 
bªk
)

153 
mcšfo_bªk
 *
mib
;

154 
ušt64_t
 
addr
=0, 
misc
 = 0;

156 ià(!
mi
)

157  
NULL
;

159 
mib
 = 
	`x86_mcšfo_»£rve
(
mi
, (
mcšfo_bªk
));

160 ià(!
mib
)

162 
mi
->
æags
 |ğ
MCINFO_FLAGS_UNCOMPLETE
;

163  
NULL
;

166 
	`mem£t
(
mib
, 0,  (
mcšfo_bªk
));

167 
mib
->
mc_¡©us
 = 
	`mÿ_rdm¤
(
	`MSR_IA32_MCx_STATUS
(
bªk
));

169 
mib
->
commÚ
.
ty³
 = 
MC_TYPE_BANK
;

170 
mib
->
commÚ
.
size
 =  (
mcšfo_bªk
);

171 
mib
->
mc_bªk
 = 
bªk
;

173 
addr
 = 
misc
 = 0;

174 ià(
mib
->
mc_¡©us
 & 
MCi_STATUS_MISCV
)

175 
mib
->
mc_misc
 = 
	`mÿ_rdm¤
(
	`MSR_IA32_MCx_MISC
(
bªk
));

177 ià(
mib
->
mc_¡©us
 & 
MCi_STATUS_ADDRV
)

179 
mib
->
mc_addr
 = 
	`mÿ_rdm¤
(
	`MSR_IA32_MCx_ADDR
(
bªk
));

181 ià(
	`mâ_v®id
(
	`·ddr_to_pâ
(
mib
->
mc_addr
))) {

182 
domaš
 *
d
;

184 
d
 = 
	`maddr_g‘_owÃr
(
mib
->
mc_addr
);

185 ià(
d
 !ğ
NULL
 && (
who
 =ğ
MCA_POLLER
 ||

186 
who
 =ğ
MCA_CMCI_HANDLER
))

187 
mib
->
mc_domid
 = 
d
->
domaš_id
;

191 ià(
who
 =ğ
MCA_CMCI_HANDLER
) {

192 
mib
->
mc_ù¾2
 = 
	`mÿ_rdm¤
(
MSR_IA32_MC0_CTL2
 + 
bªk
);

193 
	`rdtsşl
(
mib
->
mc_tsc
);

196  
mib
;

197 
	}
}

199 
	$mÿ_š™_glob®
(
ušt32_t
 
æags
, 
mcšfo_glob®
 *
mig
)

201 
ušt64_t
 
¡©us
;

202 
ıu_Ä
;

203 
vıu
 *
v
 = 
cu¼’t
;

204 
domaš
 *
d
;

207 
	`mem£t
(
mig
, 0,  (
mcšfo_glob®
));

208 
mig
->
commÚ
.
ty³
 = 
MC_TYPE_GLOBAL
;

209 
mig
->
commÚ
.
size
 =  (
mcšfo_glob®
);

210 
¡©us
 = 
	`mÿ_rdm¤
(
MSR_IA32_MCG_STATUS
);

211 
mig
->
mc_g¡©us
 = 
¡©us
;

212 
mig
->
mc_domid
 = mig->
mc_vıuid
 = -1;

213 
mig
->
mc_æags
 = 
æags
;

214 
ıu_Ä
 = 
	`smp_´oûssÜ_id
();

216 
	`x86_mc_g‘_ıu_šfo
(
ıu_Ä
, &
mig
->
mc_sock‘id
,

217 &
mig
->
mc_cÜeid
, &mig->
mc_cÜe_th»adid
,

218 &
mig
->
mc_­icid
, 
NULL
, NULL, NULL);

221 ià(
v
 !ğ
NULL
 && ((
d
 = v->
domaš
) != NULL)) {

222 
mig
->
mc_domid
 = 
d
->
domaš_id
;

223 
mig
->
mc_vıuid
 = 
v
->
vıu_id
;

225 
mig
->
mc_domid
 = -1;

226 
mig
->
mc_vıuid
 = -1;

230 
	}
}

243 
mù–em_cook›_t
 
	$mcheck_mÿ_logout
(
mÿ_sourû
 
who
, 
mÿ_bªks
 *
bªkmask
,

244 
mÿ_summ¬y
 *
¥
, 
mÿ_bªks
* 
ş—r_bªk
)

246 
ušt64_t
 
g¡©us
, 
¡©us
;

247 
mcšfo_glob®
 *
mig
 = 
NULL
;

248 
mù–em_cook›_t
 
mùc
 = 
NULL
;

249 
ušt32_t
 
uc
 = 0, 
pcc
 = 0, 
»cov”
, 
Ãed_ş—r
 = 1, 
mc_æags
 = 0;

250 
mc_šfo
 *
mci
 = 
NULL
;

251 
mù–em_şass_t
 
which
 = 
MC_URGENT
;

252 
”rút
 = 0;

253 
i
;

255 
g¡©us
 = 
	`mÿ_rdm¤
(
MSR_IA32_MCG_STATUS
);

256 
who
) {

257 
MCA_MCE_HANDLER
:

258 
MCA_MCE_SCAN
:

259 
mc_æags
 = 
MC_FLAG_MCE
;

260 
which
 = 
MC_URGENT
;

263 
MCA_POLLER
:

264 
MCA_RESET
:

265 
mc_æags
 = 
MC_FLAG_POLLED
;

266 
which
 = 
MC_NONURGENT
;

269 
MCA_CMCI_HANDLER
:

270 
mc_æags
 = 
MC_FLAG_CMCI
;

271 
which
 = 
MC_NONURGENT
;

275 
	`BUG
();

281 
»cov”
 = (
mc_»cov”abË_sÿn
)? 1: 0;

283 
i
 = 0; i < 32 && i < 
Ä_mû_bªks
; i++) {

284 
mcšfo_bªk
 *
mib
;

287 ià(!
	`mÿbªks_‹¡
(
i
, 
bªkmask
))

290 
¡©us
 = 
	`mÿ_rdm¤
(
	`MSR_IA32_MCx_STATUS
(
i
));

291 ià(!(
¡©us
 & 
MCi_STATUS_VAL
))

298 iàĞ
mc_Ãed_ş—rbªk_sÿn
 )

299 
Ãed_ş—r
 = 
	`mc_Ãed_ş—rbªk_sÿn
(
who
, 
¡©us
);

306 ià(
”rút
++ == 0) {

307 iàĞ(
mùc
 = 
	`mù–em_»£rve
(
which
)è!ğ
NULL
 ) {

308 
mci
 = 
	`mù–em_d©­Œ
(
mùc
);

309 
	`mcšfo_ş—r
(
mci
);

310 
mig
 = (
mcšfo_glob®
*)
x86_mcšfo_»£rve


311 (
mci
, (
mcšfo_glob®
));

313 
	`ASSERT
(
mig
);

314 
	`mÿ_š™_glob®
(
mc_æags
, 
mig
);

317 
mcšfo_ex‹nded
 *
	`š‹l_g‘_ex‹nded_m¤s
(

318 
mcšfo_glob®
 *
mig
, 
mc_šfo
 *
mi
);

320 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 ==

321 
X86_VENDOR_INTEL
)

322 
	`š‹l_g‘_ex‹nded_m¤s
(
mig
, 
mci
);

328 ià((
¡©us
 & 
MCi_STATUS_UC
) != 0)

329 
uc
 |ğ(1 << 
i
);

332 ià((
¡©us
 & 
MCi_STATUS_PCC
) != 0)

333 
pcc
 |ğ(1 << 
i
);

335 ià(
»cov”
 && 
uc
)

338 
»cov”
 = 
	`mc_»cov”abË_sÿn
(
¡©us
);

340 
mib
 = 
	`mÿ_š™_bªk
(
who
, 
mci
, 
i
);

342 ià(
mc_ÿÎback_bªk_ex‹nded
)

343 
	`mc_ÿÎback_bªk_ex‹nded
(
mci
, 
i
, 
¡©us
);

346 ià(
who
 !ğ
MCA_MCE_SCAN
 && 
Ãed_ş—r
)

348 
	`mÿ_wrm¤
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

349 iàĞ
who
 =ğ
MCA_MCE_SCAN
 && 
Ãed_ş—r
)

350 
	`mÿbªks_£t
(
i
, 
ş—r_bªk
);

352 
	`wmb
();

355 ià(
mig
 && 
”rút
 > 0) {

356 ià(
pcc
)

357 
mig
->
mc_æags
 |ğ
MC_FLAG_UNCORRECTABLE
;

358 ià(
uc
)

359 
mig
->
mc_æags
 |ğ
MC_FLAG_RECOVERABLE
;

361 
mig
->
mc_æags
 |ğ
MC_FLAG_CORRECTABLE
;

365 ià(
¥
) {

366 
¥
->
”rút
 =ƒrrcnt;

367 
¥
->
rv
 = (
g¡©us
 & 
MCG_STATUS_RIPV
) != 0;

368 
¥
->
ev
 = (
g¡©us
 & 
MCG_STATUS_EIPV
) != 0;

369 
¥
->
uc
 = uc;

370 
¥
->
pcc
 =…cc;

371 
¥
->
»cov”abË
 = 
»cov”
;

374  
mci
 !ğ
NULL
 ? 
mùc
 : NULL;

375 
	}
}

377 
	#DOM_NORMAL
 0

	)

378 
	#DOM0_TRAP
 1

	)

379 
	#DOMU_TRAP
 2

	)

380 
	#DOMU_KILLED
 4

	)

383 
	$mcheck_cmn_hªdËr
(
ıu_u£r_»gs
 *
»gs
, 
”rÜ_code
,

384 
mÿ_bªks
 *
bªkmask
)

386 
x’_¡©e_lo¡
, 
dom0_¡©e_lo¡
, 
domU_¡©e_lo¡
;

387 
vıu
 *
v
 = 
cu¼’t
;

388 
domaš
 *
curdom
 = 
v
->domain;

389 
domid_t
 
domid
 = 
curdom
->
domaš_id
;

390 
ùx_x’
, 
ùx_dom0
, 
ùx_domU
;

391 
ušt32_t
 
dom_¡©e
 = 
DOM_NORMAL
;

392 
mù–em_cook›_t
 
mùc
 = 
NULL
;

393 
mÿ_summ¬y
 
bs
;

394 
mc_šfo
 *
mci
 = 
NULL
;

395 
œqlocked
 = 0;

396 
ušt64_t
 
g¡©us
;

397 
rv
;

405 
	`vıu_scheduË_lock_œq
(
v
);

406 
œqlocked
 = 1;

410 
g¡©us
 = 
	`mÿ_rdm¤
(
MSR_IA32_MCG_STATUS
);

411 
rv
 = ((
g¡©us
 & 
MCG_STATUS_RIPV
) != 0);

412 ià(!(
g¡©us
 & 
MCG_STATUS_MCIP
è&& 
rv
) {

413 
	`add_št
(
TAINT_MACHINE_CHECK
);

414 
	`vıu_scheduË_uÆock_œq
(
v
);

415 
œqlocked
 = 0;

416 
cmn_hªdËr_dÚe
;

423 
mùc
 = 
	`mcheck_mÿ_logout
(
MCA_MCE_HANDLER
, 
bªkmask
, &
bs
, 
NULL
);

424 ià(
mùc
 !ğ
NULL
)

425 
mci
 = (
mc_šfo
 *)
	`mù–em_d©­Œ
(
mùc
);

428 
g¡©us
 &ğ~
MCG_STATUS_MCIP
;

429 
	`mÿ_wrm¤
(
MSR_IA32_MCG_STATUS
, 
g¡©us
);

430 
	`wmb
();

433 ià(
rv
 && 
bs
.
”rút
 == 0) {

434 
	`vıu_scheduË_uÆock_œq
(
v
);

435 
œqlocked
 = 0;

436 
cmn_hªdËr_dÚe
;

439 ià(
bs
.
uc
 || bs.
pcc
)

440 
	`add_št
(
TAINT_MACHINE_CHECK
);

466 
ùx_x’
 = 
	`SEG_PL
(
»gs
->
cs
) == 0;

467 
ùx_dom0
 = !
ùx_x’
 && (
domid
 == 0);

468 
ùx_domU
 = !
ùx_x’
 && !
ùx_dom0
;

470 
x’_¡©e_lo¡
 = 
bs
.
uc
 !ğ0 || (
ùx_x’
 && (bs.
pcc
 || !
rv
)) ||

471 !
rv
;

472 
dom0_¡©e_lo¡
 = 
bs
.
uc
 !ğ0 || (
ùx_dom0
 && (bs.
pcc
 || !
rv
));

473 
domU_¡©e_lo¡
 = 
bs
.
uc
 !ğ0 || (
ùx_domU
 && (bs.
pcc
 || !
rv
));

475 ià(
x’_¡©e_lo¡
) {

478 
	`vıu_scheduË_uÆock_œq
(
v
);

479 
œqlocked
 = 0;

481 
	`´štk
("Terminal machine checkƒxception occurred in "

492 ià(
bs
.
ev
 & 
MCG_STATUS_EIPV
) {

493 
	`´štk
("MCE: Instruction Pointer is„elatedohe "

495 
	`show_executiÚ_¡©e
(
»gs
);

499 ià(
mùc
 !ğ
NULL
) {

500 
	`x86_mcšfo_dump
(
mci
);

501 
	`mù–em_comm™
(
mùc
);

503 
	`mc_·nic
("Hypervisor state†ost dueo machine check "

515 ià(
dom0_¡©e_lo¡
) {

516 ià(
dom0
 && dom0->
max_vıus
 && dom0->
vıu
[0] &&

517 
	`gue¡_has_Œ­_ÿÎback
(
dom0
, 0, 
TRAP_machše_check
)) {

518 
dom_¡©e
 = 
DOM0_TRAP
;

519 
	`£nd_gue¡_Œ­
(
dom0
, 0, 
TRAP_machše_check
);

523 ià(
mùc
 !ğ
NULL
) {

524 
	`x86_mcšfo_dump
(
mci
);

525 
	`mù–em_comm™
(
mùc
);

527 
	`mc_·nic
("Dom0 state†ost dueo machine check "

538 ià(
domU_¡©e_lo¡
) {

539 ià(
	`gue¡_has_Œ­_ÿÎback
(
v
->
domaš
, v->
vıu_id
,

540 
TRAP_machše_check
)) {

541 
dom_¡©e
 = 
DOMU_TRAP
;

542 
	`£nd_gue¡_Œ­
(
curdom
, 
v
->
vıu_id
,

543 
TRAP_machše_check
);

545 
dom_¡©e
 = 
DOMU_KILLED
;

551 
	`vıu_scheduË_uÆock_œq
(
v
);

552 
œqlocked
 = 0;

555 
	`domaš_üash
(
curdom
);

559 
dom_¡©e
) {

560 
DOM0_TRAP
:

561 
DOMU_TRAP
:

563 
	`vıu_scheduË_uÆock_œq
(
v
);

564 
œqlocked
 = 0;

569 
DOMU_KILLED
:

573 
DOM_NORMAL
:

574 
	`vıu_scheduË_uÆock_œq
(
v
);

575 
œqlocked
 = 0;

579 
cmn_hªdËr_dÚe
:

580 
	`BUG_ON
(
œqlocked
);

581 
	`BUG_ON
(!
rv
);

583 ià(
bs
.
”rút
) {

586 ià(
	`dom0_vmû_’abËd
()) {

587 ià(
mùc
 !ğ
NULL
)

588 
	`mù–em_comm™
(
mùc
);

589 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

591 
	`x86_mcšfo_dump
(
mci
);

592 ià(
mùc
 !ğ
NULL
)

593 
	`mù–em_dismiss
(
mùc
);

595 } ià(
mùc
 !ğ
NULL
) {

596 
	`mù–em_dismiss
(
mùc
);

598 
	}
}

600 
	$mcheck_mÿ_ş—rbªks
(
mÿ_bªks
 *
bªkmask
)

602 
i
;

603 
ušt64_t
 
¡©us
;

605 
i
 = 0; i < 32 && i < 
Ä_mû_bªks
; i++) {

606 ià(!
	`mÿbªks_‹¡
(
i
, 
bªkmask
))

608 
¡©us
 = 
	`mÿ_rdm¤
(
	`MSR_IA32_MCx_STATUS
(
i
));

609 ià(!(
¡©us
 & 
MCi_STATUS_VAL
))

611 
	`mÿ_wrm¤
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

613 
	}
}

615 
mcheck_ty³
 
	$amd_mcheck_š™
(
ıušfo_x86
 *
ci
)

617 
mcheck_ty³
 
rc
 = 
mcheck_nÚe
;

619 
ci
->
x86
) {

621 
rc
 = 
	`amd_k7_mcheck_š™
(
ci
);

628 
rc
 = 
	`amd_k8_mcheck_š™
(
ci
);

632 
rc
 = 
	`amd_f10_mcheck_š™
(
ci
);

636  
rc
;

637 
	}
}

640 
	$mû_avaabË
(
ıušfo_x86
 *
c
)

642  
	`ıu_has
(
c
, 
X86_FEATURE_MCE
è&& cpu_has(c, 
X86_FEATURE_MCA
);

643 
	}
}

649 
	$mû_fœ¡bªk
(
ıušfo_x86
 *
c
)

651 ià(
c
->
x86
 == 6) {

652 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
)

655 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 && c->
x86_mod–
 < 0x1a)

660 
	}
}

662 
	$show_mÿ_šfo
(
š™ed
, 
ıušfo_x86
 *
c
)

664 
mcheck_ty³
 
g_ty³
 = 
mcheck_un£t
;

666 ià(
š™ed
 !ğ
g_ty³
) {

667 
´efix
[20];

668 cÚ¡ *cÚ¡ 
ty³_¡r
[] = {

669 [
mcheck_amd_çmXX
] = "AMD",

670 [
mcheck_amd_k7
] = "AMD K7",

671 [
mcheck_amd_k8
] = "AMD K8",

672 [
mcheck_š‹l
] = "Intel"

675 
	`¢´štf
(
´efix
, 
	`ARRAY_SIZE
(prefix),

676 
g_ty³
 !ğ
mcheck_un£t
 ? 
XENLOG_WARNING
 "CPU%i: "

677 : 
XENLOG_INFO
,

678 
	`smp_´oûssÜ_id
());

679 
	`BUG_ON
(
š™ed
 >ğ
	`ARRAY_SIZE
(
ty³_¡r
));

680 
š™ed
) {

682 
	`´štk
("%s%s machine check„eportingƒnabled\n",

683 
´efix
, 
ty³_¡r
[
š™ed
]);

685 
mcheck_amd_çmXX
:

686 
	`´štk
("%s%s Fam%xh machine check„eportingƒnabled\n",

687 
´efix
, 
ty³_¡r
[
š™ed
], 
c
->
x86
);

689 
mcheck_nÚe
:

690 
	`´štk
("%sNØmachšcheck in™Ÿliz©iÚ\n", 
´efix
);

693 
g_ty³
 = 
š™ed
;

697 
	}
}

699 
	$£t_pŞl_bªkmask
(
ıušfo_x86
 *
c
)

701 
ıu
 = 
	`smp_´oûssÜ_id
();

702 
mÿ_bªks
 *
mb
;

704 
mb
 = 
	`³r_ıu
(
pŞl_bªkmask
, 
ıu
);

705 
	`BUG_ON
(!
mb
);

707 ià(
cmci_suµÜt
 && !
mû_di§bËd
) {

708 
mb
->
num
 = 
	`³r_ıu
(
no_cmci_bªks
, 
ıu
)->num;

709 
	`b™m­_cİy
(
mb
->
bªk_m­
, 
	`³r_ıu
(
no_cmci_bªks
, 
ıu
)->bank_map,

710 
Ä_mû_bªks
);

713 
	`b™m­_cİy
(
mb
->
bªk_m­
, 
mÿ_®lbªks
->bªk_m­, 
Ä_mû_bªks
);

714 ià(
	`mû_fœ¡bªk
(
c
))

715 
	`mÿbªks_ş—r
(0, 
mb
);

717 
	}
}

720 
	$mÿ_ÿp_š™
()

722 
ušt64_t
 
m¤_cÚ‹Á
;

724 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
m¤_cÚ‹Á
);

726 ià(
m¤_cÚ‹Á
 & 
MCG_CTL_P
)

727 
	`wrm¤l
(
MSR_IA32_MCG_CTL
, 0xffffffffffffffffULL);

729 ià(
Ä_mû_bªks
 && (
m¤_cÚ‹Á
 & 
MCG_CAP_COUNT
) !=‚r_mce_banks)

731 
	`d´štk
(
XENLOG_WARNING
, "Different bank‚umber on cpu %x\n",

732 
	`smp_´oûssÜ_id
());

733  -
ENODEV
;

735 
Ä_mû_bªks
 = 
m¤_cÚ‹Á
 & 
MCG_CAP_COUNT
;

738 ià(!
mÿ_®lbªks
)

740 
i
;

742 
mÿ_®lbªks
 = 
	`mÿbªks_®loc
();

743  
i
 = 0; i < 
Ä_mû_bªks
; i++)

744 
	`mÿbªks_£t
(
i
, 
mÿ_®lbªks
);

747  
mÿ_®lbªks
 ? 0:-
ENOMEM
;

748 
	}
}

750 
	$ıu_pŞl_bªkmask_ä“
(
ıu
)

752 
mÿ_bªks
 *
mb
 = 
	`³r_ıu
(
pŞl_bªkmask
, 
ıu
);

754 
	`mÿbªks_ä“
(
mb
);

755 
	}
}

757 
	$ıu_pŞl_bªkmask_®loc
(
ıu
)

759 
mÿ_bªks
 *
mb
;

761 
mb
 = 
	`mÿbªks_®loc
();

762 iàĞ!
mb
 )

763  -
ENOMEM
;

765 
	`³r_ıu
(
pŞl_bªkmask
, 
ıu
èğ
mb
;

767 
	}
}

769 
	$ıu_ÿÎback
(

770 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

772 
ıu
 = ()
hıu
;

773 
rc
 = 0;

775  
aùiÚ
 )

777 
CPU_UP_PREPARE
:

778 
rc
 = 
	`ıu_pŞl_bªkmask_®loc
(
ıu
);

780 
CPU_UP_CANCELED
:

781 
CPU_DEAD
:

782 
	`ıu_pŞl_bªkmask_ä“
(
ıu
);

788  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

789 
	}
}

791 
nÙif›r_block
 
	gıu_nfb
 = {

792 .
nÙif›r_ÿÎ
 = 
ıu_ÿÎback


796 
	$mcheck_š™
(
ıušfo_x86
 *
c
, 
boŞ_t
 
b¥
)

798 
mcheck_ty³
 
š™ed
 = 
mcheck_nÚe
;

800 ià(
mû_di§bËd
 == 1) {

801 
	`d´štk
(
XENLOG_INFO
, "MCE support disabled by bootparam\n");

805 ià(!
	`mû_avaabË
(
c
))

807 
	`´štk
(
XENLOG_INFO
 "CPU%i: No machine check support‡vailable\n",

808 
	`smp_´oûssÜ_id
());

813 ià(
	`mÿ_ÿp_š™
())

816 
c
->
x86_v’dÜ
) {

817 
X86_VENDOR_AMD
:

818 
š™ed
 = 
	`amd_mcheck_š™
(
c
);

821 
X86_VENDOR_INTEL
:

822 
c
->
x86
) {

825 
š™ed
 = 
	`š‹l_mcheck_š™
(
c
, 
b¥
);

834 
	`show_mÿ_šfo
(
š™ed
, 
c
);

835 ià(
š™ed
 =ğ
mcheck_nÚe
 || in™ed =ğ
mcheck_un£t
)

836 
out
;

838 
	`šo£_š™
();

840 
	`mù–em_š™
((
mc_šfo
));

842 
	`vmû_š™
(
c
);

845 
	`£t_š_ü4
(
X86_CR4_MCE
);

847 iàĞ
b¥
 )

850 iàĞ
	`ıu_pŞl_bªkmask_®loc
(0) )

851 
	`BUG
();

852 
	`»gi¡”_ıu_nÙif›r
(&
ıu_nfb
);

854 
	`£t_pŞl_bªkmask
(
c
);

857 
out
:

858 ià(
	`smp_´oûssÜ_id
() == 0)

860 
	`mÿbªks_ä“
(
mÿ_®lbªks
);

861 
mÿ_®lbªks
 = 
NULL
;

863 
	}
}

865 
	$mcšfo_ş—r
(
mc_šfo
 *
mi
)

867 
	`mem£t
(
mi
, 0, (
mc_šfo
));

868 
	`x86_mcšfo_ÃÁr›s
(
mi
) = 0;

869 
	}
}

871 *
	$x86_mcšfo_»£rve
(
mc_šfo
 *
mi
, 
size
)

873 
i
;

874 
’d1
, 
’d2
;

875 
mcšfo_commÚ
 *
mic_ba£
, *
mic_šdex
;

877 
mic_šdex
 = 
mic_ba£
 = 
	`x86_mcšfo_fœ¡
(
mi
);

880 
i
 = 0; i < 
	`x86_mcšfo_ÃÁr›s
(
mi
); i++) {

881 
mic_šdex
 = 
	`x86_mcšfo_Ãxt
(mic_index);

885 
’d1
 = ()((
ušt8_t
 *)
mic_ba£
 + (
mc_šfo
));

886 
’d2
 = ()((
ušt8_t
 *)
mic_šdex
 + 
size
);

888 ià(
’d1
 < 
’d2
)

890 
	`mû_´štk
(
MCE_CRITICAL
,

892  
NULL
;

896 
	`x86_mcšfo_ÃÁr›s
(
mi
)++;

898  
mic_šdex
;

899 
	}
}

901 *
	$x86_mcšfo_add
(
mc_šfo
 *
mi
, *
mcšfo
)

903 
mcšfo_commÚ
 *
mic
, *
buf
;

905 
mic
 = (
mcšfo_commÚ
 *)
mcšfo
;

906 
buf
 = 
	`x86_mcšfo_»£rve
(
mi
, 
mic
->
size
);

908 iàĞ!
buf
 )

909 
	`mû_´štk
(
MCE_CRITICAL
,

912 
	`memıy
(
buf
, 
mic
, mic->
size
);

914  
buf
;

915 
	}
}

920 
	$x86_mcšfo_dump
(
mc_šfo
 *
mi
)

922 
mcšfo_commÚ
 *
mic
 = 
NULL
;

923 
mcšfo_glob®
 *
mc_glob®
;

924 
mcšfo_bªk
 *
mc_bªk
;

927 
	`x86_mcšfo_lookup
(
mic
, 
mi
, 
MC_TYPE_GLOBAL
);

928 ià(
mic
 =ğ
NULL
)

930 
mc_glob®
 = (
mcšfo_glob®
 *)
mic
;

931 ià(
mc_glob®
->
mc_æags
 & 
MC_FLAG_MCE
) {

932 
	`´štk
(
XENLOG_WARNING


933 "CPU%d: MachšCheck Exû±iÚ: %16"
PRIx64
"\n",

934 
mc_glob®
->
mc_cÜeid
, mc_glob®->
mc_g¡©us
);

935 } ià(
mc_glob®
->
mc_æags
 & 
MC_FLAG_CMCI
) {

936 
	`´štk
(
XENLOG_WARNING
 "CMCI occurred on CPU %d.\n",

937 
mc_glob®
->
mc_cÜeid
);

938 } ià(
mc_glob®
->
mc_æags
 & 
MC_FLAG_POLLED
) {

939 
	`´štk
(
XENLOG_WARNING
 "POLLED occurred on CPU %d.\n",

940 
mc_glob®
->
mc_cÜeid
);

944 
	`x86_mcšfo_lookup
(
mic
, 
mi
, 
MC_TYPE_BANK
);

946 ià(
mic
 =ğ
NULL
)

948 ià(
mic
->
ty³
 !ğ
MC_TYPE_BANK
)

949 
Ãxt
;

951 
mc_bªk
 = (
mcšfo_bªk
 *)
mic
;

953 
	`´štk
(
XENLOG_WARNING
 "Bªk %d: %16"
PRIx64
,

954 
mc_bªk
->mc_bank,

955 
mc_bªk
->
mc_¡©us
);

956 ià(
mc_bªk
->
mc_¡©us
 & 
MCi_STATUS_MISCV
)

957 
	`´štk
("[%16"
PRIx64
"]", 
mc_bªk
->
mc_misc
);

958 ià(
mc_bªk
->
mc_¡©us
 & 
MCi_STATUS_ADDRV
)

959 
	`´štk
("‡ˆ%16"
PRIx64
, 
mc_bªk
->
mc_addr
);

961 
	`´štk
("\n");

962 
Ãxt
:

963 
mic
 = 
	`x86_mcšfo_Ãxt
(mic);

964 ià((
mic
 =ğ
NULL
è|| (mic->
size
 == 0))

967 
	}
}

969 
	$do_mc_g‘_ıu_šfo
(*
v
)

971 
ıu
 = 
	`smp_´oûssÜ_id
();

972 
cšdex
, 
ın
;

973 
ıušfo_x86
 *
c
;

974 
x’_mc_logiÿl_ıu_t
 *
log_ıus
, *
xı
;

975 
ušt32_t
 
junk
, 
ebx
;

977 
log_ıus
 = 
v
;

978 
c
 = &
ıu_d©a
[
ıu
];

979 
cšdex
 = 0;

980 
ın
 = 
ıu
 - 1;

985 
ın
 >= 0) {

986 ià(
	`ıu_Úlše
(
ın
))

987 
cšdex
++;

988 
ın
--;

991 
xı
 = &
log_ıus
[
cšdex
];

992 
c
 = &
ıu_d©a
[
ıu
];

993 
xı
->
mc_ıuÄ
 = 
ıu
;

994 
	`x86_mc_g‘_ıu_šfo
(
ıu
, &
xı
->
mc_chid
,

995 &
xı
->
mc_cÜeid
, &xı->
mc_th»adid
,

996 &
xı
->
mc_­icid
, &xı->
mc_ncÜes
,

997 &
xı
->
mc_ncÜes_aùive
, &xı->
mc_Áh»ads
);

998 
xı
->
mc_ıuid_Ëv–
 = 
c
->
ıuid_Ëv–
;

999 
xı
->
mc_çmy
 = 
c
->
x86
;

1000 
xı
->
mc_v’dÜ
 = 
c
->
x86_v’dÜ
;

1001 
xı
->
mc_mod–
 = 
c
->
x86_mod–
;

1002 
xı
->
mc_¡•
 = 
c
->
x86_mask
;

1003 
xı
->
mc_ÿche_size
 = 
c
->
x86_ÿche_size
;

1004 
xı
->
mc_ÿche_®ignm’t
 = 
c
->
x86_ÿche_®ignm’t
;

1005 
	`memıy
(
xı
->
mc_v’dÜid
, 
c
->
x86_v’dÜ_id
,  xcp->mc_vendorid);

1006 
	`memıy
(
xı
->
mc_b¿ndid
, 
c
->
x86_mod–_id
,  xcp->mc_brandid);

1007 
	`memıy
(
xı
->
mc_ıu_ÿps
, 
c
->
x86_ÿ·b™y
,  xcp->mc_cpu_caps);

1012 
xı
->
mc_nm¤v®s
 = 
__MC_NMSRS
;

1013 
xı
->
mc_m¤v®ues
[0].
»g
 = 
MSR_IA32_MCG_CAP
;

1014 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
xı
->
mc_m¤v®ues
[0].
v®ue
);

1016 ià(
c
->
ıuid_Ëv–
 >= 1) {

1017 
	`ıuid
(1, &
junk
, &
ebx
, &junk, &junk);

1018 
xı
->
mc_şu¡”id
 = (
ebx
 >> 24) & 0xff;

1020 
xı
->
mc_şu¡”id
 = 
	`h¬d_smp_´oûssÜ_id
();

1021 
	}
}

1024 
	$x86_mc_g‘_ıu_šfo
(
ıu
, 
ušt32_t
 *
chid
, 
ušt16_t
 *
cÜeid
,

1025 
ušt16_t
 *
th»adid
, 
ušt32_t
 *
­icid
,

1026 *
ncÜes
, *
ncÜes_aùive
,

1027 *
Áh»ads
)

1029 
ıušfo_x86
 *
c
;

1031 *
­icid
 = 
	`ıu_physiÿl_id
(
ıu
);

1032 
c
 = &
ıu_d©a
[
ıu
];

1033 ià(
c
->
­icid
 =ğ
BAD_APICID
) {

1034 *
chid
 = 
ıu
;

1035 *
cÜeid
 = 0;

1036 *
th»adid
 = 0;

1037 ià(
ncÜes
 !ğ
NULL
)

1038 *
ncÜes
 = 1;

1039 ià(
ncÜes_aùive
 !ğ
NULL
)

1040 *
ncÜes_aùive
 = 1;

1041 ià(
Áh»ads
 !ğ
NULL
)

1042 *
Áh»ads
 = 1;

1044 *
chid
 = 
phys_´oc_id
[
ıu
];

1045 ià(
c
->
x86_max_cÜes
 > 1)

1046 *
cÜeid
 = 
ıu_cÜe_id
[
ıu
];

1048 *
cÜeid
 = 0;

1049 *
th»adid
 = 
c
->
­icid
 & ((1 << (c->
x86_num_siblšgs
 - 1)) - 1);

1050 ià(
ncÜes
 !ğ
NULL
)

1051 *
ncÜes
 = 
c
->
x86_max_cÜes
;

1052 ià(
ncÜes_aùive
 !ğ
NULL
)

1053 *
ncÜes_aùive
 = 
c
->
boÙed_cÜes
;

1054 ià(
Áh»ads
 !ğ
NULL
)

1055 *
Áh»ads
 = 
c
->
x86_num_siblšgs
;

1057 
	}
}

1059 
	#INTPOSE_NENT
 50

	)

1061 
	sšo£_’t
 {

1062 
	mıu_Ä
;

1063 
ušt64_t
 
	mm¤
;

1064 
ušt64_t
 
	mv®
;

1065 } 
	gšo£_¬r
[
INTPOSE_NENT
];

1067 
	$šo£_š™
()

1069 
dÚe
;

1070 
i
;

1072 ià(
dÚe
++ > 0)

1075 
i
 = 0; i < 
INTPOSE_NENT
; i++) {

1076 
šo£_¬r
[
i
].
ıu_Ä
 = -1;

1079 
	}
}

1081 
šo£_’t
 *
	$šo£_lookup
(
ıu_Ä
, 
ušt64_t
 
m¤
,

1082 
ušt64_t
 *
v®p
)

1084 
i
;

1086 
i
 = 0; i < 
INTPOSE_NENT
; i++) {

1087 ià(
šo£_¬r
[
i
].
ıu_Ä
 == cpu_nr &&

1088 
šo£_¬r
[
i
].
m¤
 == msr) {

1089 ià(
v®p
 !ğ
NULL
)

1090 *
v®p
 = 
šo£_¬r
[
i
].
v®
;

1091  &
šo£_¬r
[
i
];

1095  
NULL
;

1096 
	}
}

1098 
	$šo£_add
(
ıu_Ä
, 
ušt64_t
 
m¤
, ušt64_ˆ
v®
)

1100 
šo£_’t
 *
’t
;

1101 
i
;

1103 ià((
’t
 = 
	`šo£_lookup
(
ıu_Ä
, 
m¤
, 
NULL
)) != NULL) {

1104 
’t
->
v®
 = val;

1108 
i
 = 0, 
’t
 = &
šo£_¬r
[0]; i < 
INTPOSE_NENT
; i++,ƒnt++) {

1109 ià(
’t
->
ıu_Ä
 == -1) {

1110 
’t
->
ıu_Ä
 = cpu_nr;

1111 
’t
->
m¤
 = msr;

1112 
’t
->
v®
 = val;

1117 
	`´štk
("intpose_add: interpose‡rray full -„equest dropped\n");

1118 
	}
}

1120 
	$šo£_šv®
(
ıu_Ä
, 
ušt64_t
 
m¤
)

1122 
šo£_’t
 *
’t
;

1124 ià((
’t
 = 
	`šo£_lookup
(
ıu_Ä
, 
m¤
, 
NULL
)) != NULL) {

1125 
’t
->
ıu_Ä
 = -1;

1127 
	}
}

1129 
	#IS_MCA_BANKREG
(
r
) \

1130 ((
r
è>ğ
MSR_IA32_MC0_CTL
 && \

1131 (
r
è<ğ
	`MSR_IA32_MCx_MISC
(
Ä_mû_bªks
 - 1) && \

1132 ((
r
è- 
MSR_IA32_MC0_CTL
è% 4 !ğ0è

	)

1134 
	$x86_mc_m¤šjeù_v”ify
(
x’_mc_m¤šjeù
 *
mci
)

1136 
ıušfo_x86
 *
c
;

1137 
i
, 
”rs
 = 0;

1139 
c
 = &
ıu_d©a
[
	`smp_´oûssÜ_id
()];

1141 
i
 = 0; i < 
mci
->
mcšj_couÁ
; i++) {

1142 
ušt64_t
 
»g
 = 
mci
->
mcšj_m¤
[
i
].reg;

1143 cÚ¡ *
»asÚ
 = 
NULL
;

1145 ià(
	`IS_MCA_BANKREG
(
»g
)) {

1146 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
) {

1153 
mci
->
mcšj_æags
 |=

1154 
_MC_MSRINJ_F_REQ_HWCR_WREN
;

1159 ià(!(
mci
->
mcšj_æags
 &

1160 
MC_MSRINJ_F_INTERPOSE
)) {

1161 
»asÚ
 = "must specify interposition";

1165 
»g
) {

1167 
MSR_IA32_MCG_STATUS
:

1171 
MSR_K8_HWCR
:

1172 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
)

1173 
»asÚ
 = "HV will operate HWCR";

1175 
»asÚ
 ="only supported on AMD";

1179 
»asÚ
 = "not‡„ecognized MCA MSR";

1184 ià(
»asÚ
 !ğ
NULL
) {

1185 
	`´štk
("HV MSR INJECT ERROR: MSR 0x%llx %s\n",

1186 ()
mci
->
mcšj_m¤
[
i
].
»g
, 
»asÚ
);

1187 
”rs
++;

1191  !
”rs
;

1192 
	}
}

1194 
ušt64_t
 
	$x86_mc_hwü_w»n
()

1196 
ušt64_t
 
Şd
;

1198 
	`rdm¤l
(
MSR_K8_HWCR
, 
Şd
);

1200 ià(!(
Şd
 & 
K8_HWCR_MCi_STATUS_WREN
)) {

1201 
ušt64_t
 
Ãw
 = 
Şd
 | 
K8_HWCR_MCi_STATUS_WREN
;

1202 
	`wrm¤l
(
MSR_K8_HWCR
, 
Ãw
);

1205  
Şd
;

1206 
	}
}

1208 
	$x86_mc_hwü_w»n_»¡Üe
(
ušt64_t
 
hwü
)

1210 ià(!(
hwü
 & 
K8_HWCR_MCi_STATUS_WREN
))

1211 
	`wrm¤l
(
MSR_K8_HWCR
, 
hwü
);

1212 
	}
}

1214 
	$x86_mc_m¤šjeù
(*
d©a
)

1216 
x’_mc_m¤šjeù
 *
mci
 = 
d©a
;

1217 
mcšfo_m¤
 *
m¤
;

1218 
ıušfo_x86
 *
c
;

1219 
ušt64_t
 
hwü
 = 0;

1220 
šo£
;

1221 
i
;

1223 
c
 = &
ıu_d©a
[
	`smp_´oûssÜ_id
()];

1225 ià(
mci
->
mcšj_æags
 & 
_MC_MSRINJ_F_REQ_HWCR_WREN
)

1226 
hwü
 = 
	`x86_mc_hwü_w»n
();

1228 
šo£
 = (
mci
->
mcšj_æags
 & 
MC_MSRINJ_F_INTERPOSE
) != 0;

1230 
i
 = 0, 
m¤
 = &
mci
->
mcšj_m¤
[0];

1231 
i
 < 
mci
->
mcšj_couÁ
; i++, 
m¤
++) {

1232 
	`´štk
("HV MSR INJECT (%s)arget %u‡ctual %u MSR 0x%llx "

1234 
šo£
 ? "interpose" : "hardware",

1235 
mci
->
mcšj_ıuÄ
, 
	`smp_´oûssÜ_id
(),

1236 ()
m¤
->
»g
,

1237 ()
m¤
->
v®ue
);

1239 ià(
šo£
)

1240 
	`šo£_add
(
mci
->
mcšj_ıuÄ
, 
m¤
->
»g
, m¤->
v®ue
);

1242 
	`wrm¤l
(
m¤
->
»g
, m¤->
v®ue
);

1245 ià(
mci
->
mcšj_æags
 & 
_MC_MSRINJ_F_REQ_HWCR_WREN
)

1246 
	`x86_mc_hwü_w»n_»¡Üe
(
hwü
);

1247 
	}
}

1250 
	$x86_mc_mûšjeù
(*
d©a
)

1252 
	`´štk
("SimuÏtšg #MC oÀıu %d\n", 
	`smp_´oûssÜ_id
());

1253 
__asm__
 
	`__vŞ©e__
("int $0x12");

1254 
	}
}

1256 
	$x86_cmci_šjeù
(*
d©a
)

1258 
	`´štk
("SimuÏtšg CMCI oÀıu %d\n", 
	`smp_´oûssÜ_id
());

1259 
__asm__
 
	`__vŞ©e__
("int $0xf7");

1260 
	}
}

1262 #ià
BITS_PER_LONG
 == 64

1264 
	#ID2COOKIE
(
id
è((
mù–em_cook›_t
)(id))

	)

1265 
	#COOKIE2ID
(
c
è((
ušt64_t
)(c))

	)

1267 #–ià
BITS_PER_LONG
 == 32

1269 
	#ID2COOKIE
(
id
è((
mù–em_cook›_t
)(
ušt32_t
)((idè& 0xffffffffU))

	)

1270 
	#COOKIE2ID
(
c
è((
ušt64_t
)(
ušt32_t
)(c))

	)

1272 #–ià
defšed
(
BITS_PER_LONG
)

1273 #”rÜ 
BITS_PER_LONG
 
has
 
uÃx³ùed
 
v®ue


1275 #”rÜ 
BITS_PER_LONG
 
defš™iÚ
 
ab£Á


1278 #ifdeà
CONFIG_COMPAT


1279 
	~<com·t/¬ch-x86/x’-mÿ.h
>

1281 
	#x’_mcšfo_m¤
 
mcšfo_m¤


	)

1282 
	gCHECK_mcšfo_m¤
;

1283 #undeà
x’_mcšfo_m¤


1284 #undeà
CHECK_mcšfo_m¤


1285 
	#CHECK_mcšfo_m¤
 
mcšfo_m¤


	)

1287 
	#x’_mcšfo_commÚ
 
mcšfo_commÚ


	)

1288 
	gCHECK_mcšfo_commÚ
;

1289 #undeà
x’_mcšfo_commÚ


1290 #undeà
CHECK_mcšfo_commÚ


1291 
	#CHECK_mcšfo_commÚ
 
mcšfo_commÚ


	)

1293 
CHECK_FIELD_
(, 
mc_ãtch
, 
æags
);

1294 
CHECK_FIELD_
(, 
mc_ãtch
, 
ãtch_id
);

1295 
	#CHECK_com·t_mc_ãtch
 
mc_ãtch


	)

1297 
CHECK_FIELD_
(, 
mc_physıušfo
, 
nıus
);

1298 
	#CHECK_com·t_mc_physıušfo
 
mc_physıušfo


	)

1300 
	#CHECK_com·t_mc_šjeù_v2
 
mc_šjeù_v2


	)

1301 
	gCHECK_mc
;

1302 #undeà
CHECK_com·t_mc_ãtch


1303 #undeà
CHECK_com·t_mc_physıušfo


1305 
	#x’_mc_šfo
 
mc_šfo


	)

1306 
	gCHECK_mc_šfo
;

1307 #undeà
x’_mc_šfo


1309 
	#x’_mcšfo_glob®
 
mcšfo_glob®


	)

1310 
	gCHECK_mcšfo_glob®
;

1311 #undeà
x’_mcšfo_glob®


1313 
	#x’_mcšfo_bªk
 
mcšfo_bªk


	)

1314 
	gCHECK_mcšfo_bªk
;

1315 #undeà
x’_mcšfo_bªk


1317 
	#x’_mcšfo_ex‹nded
 
mcšfo_ex‹nded


	)

1318 
	gCHECK_mcšfo_ex‹nded
;

1319 #undeà
x’_mcšfo_ex‹nded


1321 
	#x’_mcšfo_»cov”y
 
mcšfo_»cov”y


	)

1322 
	#x’_ıu_ofæše_aùiÚ
 
ıu_ofæše_aùiÚ


	)

1323 
	#x’_·ge_ofæše_aùiÚ
 
·ge_ofæše_aùiÚ


	)

1324 
	gCHECK_mcšfo_»cov”y
;

1325 #undeà
x’_ıu_ofæše_aùiÚ


1326 #undeà
x’_·ge_ofæše_aùiÚ


1327 #undeà
x’_mcšfo_»cov”y


1329 
	#com·t_mc_ãtch
 
x’_mc_ãtch


	)

1330 
	#com·t_mc_physıušfo
 
x’_mc_physıušfo


	)

1331 
	#com·t_hªdË_is_nuÎ
 
gue¡_hªdË_is_nuÎ


	)

1332 
	#cİy_to_com·t
 
cİy_to_gue¡


	)

1336 
do_mÿ
(
	$XEN_GUEST_HANDLE
(
x’_mc_t
è
u_x’_mc
)

1338 
»t
 = 0;

1339 
x’_mc
 
curİ
, *
İ
 = &curop;

1340 
vıu
 *
v
 = 
cu¼’t
;

1342 
x’_mc_ãtch
 *
Çt
;

1343 
com·t_mc_ãtch
 *
cmp
;

1344 } 
mc_ãtch
;

1346 
x’_mc_physıušfo
 *
Çt
;

1347 
com·t_mc_physıušfo
 *
cmp
;

1348 } 
mc_physıušfo
;

1349 
ušt32_t
 
æags
, 
cmdæags
;

1350 
Æıu
;

1351 
x’_mc_logiÿl_ıu_t
 *
log_ıus
 = 
NULL
;

1352 
mù–em_cook›_t
 
mùc
;

1353 
mù–em_şass_t
 
which
;

1354 
rg‘
;

1355 
x’_mc_m¤šjeù
 *
mc_m¤šjeù
;

1356 
x’_mc_mûšjeù
 *
mc_mûšjeù
;

1358 ià(!
	`IS_PRIV
(
v
->
domaš
) )

1359  
	`x86_mû¼
(
NULL
, -
EPERM
);

1361 iàĞ
	`cİy_äom_gue¡
(
İ
, 
u_x’_mc
, 1) )

1362  
	`x86_mû¼
("do_mÿ: faed cİyš oàx’_mc_t", -
EFAULT
);

1364 iàĞ
İ
->
š‹rçû_v”siÚ
 !ğ
XEN_MCA_INTERFACE_VERSION
 )

1365  
	`x86_mû¼
("do_mÿ: iÁ”çû v”siÚ mism©ch", -
EACCES
);

1367 
İ
->
cmd
) {

1368 
XEN_MC_ãtch
:

1369 
mc_ãtch
.
Çt
 = &
İ
->
u
.mc_fetch;

1370 
cmdæags
 = 
mc_ãtch
.
Çt
->
æags
;

1372 
cmdæags
 & (
XEN_MC_NONURGENT
 | 
XEN_MC_URGENT
)) {

1373 
XEN_MC_NONURGENT
:

1374 
which
 = 
MC_NONURGENT
;

1377 
XEN_MC_URGENT
:

1378 
which
 = 
MC_URGENT
;

1382  
	`x86_mû¼
("do_mÿ f‘ch: bad cmdæags", -
EINVAL
);

1385 
æags
 = 
XEN_MC_OK
;

1387 ià(
cmdæags
 & 
XEN_MC_ACK
) {

1388 
mù–em_cook›_t
 
cook›
 = 
	`ID2COOKIE
(
mc_ãtch
.
Çt
->
ãtch_id
);

1389 
	`mù–em_ack
(
which
, 
cook›
);

1391 ià(!
	`is_pv_32Ú64_vıu
(
v
)

1392 ? 
	`gue¡_hªdË_is_nuÎ
(
mc_ãtch
.
Çt
->
d©a
)

1393 : 
	`com·t_hªdË_is_nuÎ
(
mc_ãtch
.
cmp
->
d©a
))

1394  
	`x86_mû¼
("do_mca fetch: guest buffer "

1395 "šv®id", -
EINVAL
);

1397 ià((
mùc
 = 
	`mù–em_cÚsume_Şde¡_begš
(
which
))) {

1398 
mc_šfo
 *
mc
 = 
	`mù–em_d©­Œ
(
mùc
);

1399 ià(!
	`is_pv_32Ú64_vıu
(
v
)

1400 ? 
	`cİy_to_gue¡
(
mc_ãtch
.
Çt
->
d©a
, 
mc
, 1)

1401 : 
	`cİy_to_com·t
(
mc_ãtch
.
cmp
->
d©a
,

1402 
mc
, 1)) {

1403 
»t
 = -
EFAULT
;

1404 
æags
 |ğ
XEN_MC_FETCHFAILED
;

1405 
mc_ãtch
.
Çt
->
ãtch_id
 = 0;

1407 
mc_ãtch
.
Çt
->
ãtch_id
 = 
	`COOKIE2ID
(
mùc
);

1409 
	`mù–em_cÚsume_Şde¡_’d
(
mùc
);

1412 
æags
 |ğ
XEN_MC_NODATA
;

1413 
mc_ãtch
.
Çt
->
ãtch_id
 = 0;

1416 
mc_ãtch
.
Çt
->
æags
 = flags;

1417 ià(
	`cİy_to_gue¡
(
u_x’_mc
, 
İ
, 1) != 0)

1418 
»t
 = -
EFAULT
;

1423 
XEN_MC_nÙifydomaš
:

1424  
	`x86_mû¼
("do_mÿ‚Ùify unsuµÜ‹d", -
EINVAL
);

1426 
XEN_MC_physıušfo
:

1427 
mc_physıušfo
.
Çt
 = &
İ
->
u
.mc_physcpuinfo;

1428 
Æıu
 = 
	`num_Úlše_ıus
();

1430 ià(!
	`is_pv_32Ú64_vıu
(
v
)

1431 ? !
	`gue¡_hªdË_is_nuÎ
(
mc_physıušfo
.
Çt
->
šfo
)

1432 : !
	`com·t_hªdË_is_nuÎ
(
mc_physıušfo
.
cmp
->
šfo
)) {

1433 ià(
mc_physıušfo
.
Çt
->
nıus
 <= 0)

1434  
	`x86_mû¼
("do_mca cpuinfo:‚cpus <= 0",

1435 -
EINVAL
);

1436 
Æıu
 = 
	`mš
Òlıu, ()
mc_physıušfo
.
Çt
->
nıus
);

1437 
log_ıus
 = 
	`xm®loc_¬¿y
(
x’_mc_logiÿl_ıu_t
, 
Æıu
);

1438 ià(
log_ıus
 =ğ
NULL
)

1439  
	`x86_mû¼
("do_mÿ cpušfo", -
ENOMEM
);

1440 
	`Ú_—ch_ıu
(
do_mc_g‘_ıu_šfo
, 
log_ıus
, 1);

1441 ià(!
	`is_pv_32Ú64_vıu
(
v
)

1442 ? 
	`cİy_to_gue¡
(
mc_physıušfo
.
Çt
->
šfo
,

1443 
log_ıus
, 
Æıu
)

1444 : 
	`cİy_to_com·t
(
mc_physıušfo
.
cmp
->
šfo
,

1445 
log_ıus
, 
Æıu
))

1446 
»t
 = -
EFAULT
;

1447 
	`xä“
(
log_ıus
);

1450 
mc_physıušfo
.
Çt
->
nıus
 = 
Æıu
;

1452 ià(
	`cİy_to_gue¡
(
u_x’_mc
, 
İ
, 1))

1453  
	`x86_mû¼
("do_mÿ cpušfo", -
EFAULT
);

1457 
XEN_MC_m¤šjeù
:

1458 ià(
Ä_mû_bªks
 == 0)

1459  
	`x86_mû¼
("do_mÿ injeù", -
ENODEV
);

1461 
mc_m¤šjeù
 = &
İ
->
u
.mc_msrinject;

1462 
rg‘
 = 
mc_m¤šjeù
->
mcšj_ıuÄ
;

1464 ià(
rg‘
 >ğ
NR_CPUS
)

1465  
	`x86_mû¼
("do_mÿ injeù: bad¬g‘", -
EINVAL
);

1467 ià(!
	`ıu_Úlše
(
rg‘
))

1468  
	`x86_mû¼
("do_mca inject:arget offline",

1469 -
EINVAL
);

1471 ià(
mc_m¤šjeù
->
mcšj_couÁ
 == 0)

1474 ià(!
	`x86_mc_m¤šjeù_v”ify
(
mc_m¤šjeù
))

1475  
	`x86_mû¼
("do_mÿ injeù: iÎeg® MSR", -
EINVAL
);

1477 
	`add_št
(
TAINT_ERROR_INJECT
);

1479 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
rg‘
), 
x86_mc_m¤šjeù
,

1480 
mc_m¤šjeù
, 1);

1484 
XEN_MC_mûšjeù
:

1485 ià(
Ä_mû_bªks
 == 0)

1486  
	`x86_mû¼
("do_mÿ #MC", -
ENODEV
);

1488 
mc_mûšjeù
 = &
İ
->
u
.mc_mceinject;

1489 
rg‘
 = 
mc_mûšjeù
->
mûšj_ıuÄ
;

1491 ià(
rg‘
 >ğ
NR_CPUS
)

1492  
	`x86_mû¼
("do_mÿ #MC: bad¬g‘", -
EINVAL
);

1494 ià(!
	`ıu_Úlše
(
rg‘
))

1495  
	`x86_mû¼
("do_mÿ #MC:¬g‘ ofæše", -
EINVAL
);

1497 
	`add_št
(
TAINT_ERROR_INJECT
);

1499 iàĞ
mû_brßdÿ¡
 )

1500 
	`Ú_—ch_ıu
(
x86_mc_mûšjeù
, 
mc_mûšjeù
, 1);

1502 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
rg‘
), 
x86_mc_mûšjeù
,

1503 
mc_mûšjeù
, 1);

1506 
XEN_MC_šjeù_v2
:

1508 
ıumask_t
 
ıum­
;

1510 ià(
Ä_mû_bªks
 == 0)

1511  
	`x86_mû¼
("do_mÿ #MC", -
ENODEV
);

1513 iàĞ
İ
->
u
.
mc_šjeù_v2
.
æags
 & 
XEN_MC_INJECT_CPU_BROADCAST
 )

1514 
	`ıus_cİy
(
ıum­
, 
ıu_Úlše_m­
);

1517 
gcw
;

1519 
	`ıus_ş—r
(
ıum­
);

1520 
	`x’ùl_ıum­_to_ıumask
(&
ıum­
,

1521 &
İ
->
u
.
mc_šjeù_v2
.
ıum­
);

1522 
gcw
 = 
	`ıus_weight
(
ıum­
);

1523 
	`ıus_ªd
(
ıum­
, 
ıu_Úlše_m­
, cpumap);

1525 iàĞ
	`ıus_em±y
(
ıum­
) )

1526  
	`x86_mû¼
("NØÚlšCPU…as£d\n", -
EINVAL
);

1527 iàĞ
gcw
 !ğ
	`ıus_weight
(
ıum­
) )

1528 
	`d´štk
(
XENLOG_INFO
,

1532 
İ
->
u
.
mc_šjeù_v2
.
æags
 & 
XEN_MC_INJECT_TYPE_MASK
)

1534 
XEN_MC_INJECT_TYPE_MCE
:

1535 iàĞ
mû_brßdÿ¡
 &&

1536 !
	`ıus_equ®
(
ıum­
, 
ıu_Úlše_m­
) )

1537 
	`´štk
("Notrigger MCE on‡ll CPUs, may HANG!\n");

1538 
	`Ú_£Ëùed_ıus
(&
ıum­
, 
x86_mc_mûšjeù
, 
NULL
, 1);

1540 
XEN_MC_INJECT_TYPE_CMCI
:

1541 iàĞ!
cmci_suµÜt
 )

1542  
	`x86_mû¼
(

1543 "NØCMCI suµÜ‹d iÀ¶©fÜm\n", -
EINVAL
);

1544 
	`Ú_£Ëùed_ıus
(&
ıum­
, 
x86_cmci_šjeù
, 
NULL
, 1);

1547  
	`x86_mû¼
("WrÚg mÿy³\n", -
EINVAL
);

1553  
	`x86_mû¼
("do_mÿ: bad commªd", -
EINVAL
);

1556  
»t
;

1557 
	}
}

1559 
	gmcšfo_dumµed
;

1560 
	$x86_mcšfo_dump_·nic
(
mù–em_cook›_t
 
mùc
)

1562 
mc_šfo
 *
mc
 = 
	`mù–em_d©­Œ
(
mùc
);

1564 
	`x86_mcšfo_dump
(
mc
);

1565 
mcšfo_dumµed
++;

1568 
	}
}

1571 
	$mc_·nic_dump
()

1573 
ıu
;

1575 
	`d´štk
(
XENLOG_ERR
, "Begin dump mc_info\n");

1576 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

1577 
	`mù–em_´oûss_deã¼ed
(
ıu
, 
x86_mcšfo_dump_·nic
);

1578 
	`d´štk
(
XENLOG_ERR
, "End dum°mc_šfo, %x mcšfØdum³d\n", 
mcšfo_dumµed
);

1579 
	}
}

1581 
	$mc_·nic
(*
s
)

1583 
is_mc_·nic
 = 1;

1584 
	`cÚsŞe_fÜû_uÆock
();

1586 
	`´štk
("F©® machšcheck: %s\n", 
s
);

1587 
	`´štk
("\n"

1592 
	`mc_·nic_dump
();

1593 
	`·nic
("HARDWARE ERROR");

1594 
	}
}

	@cpu/mcheck/mce.h

1 #iâdeà
_MCE_H


3 
	#_MCE_H


	)

5 
	~<x’/š™.h
>

6 
	~<x’/smp.h
>

7 
	~<asm/ty³s.h
>

8 
	~<asm/Œ­s.h
>

9 
	~<asm/©omic.h
>

10 
	~<asm/³rıu.h
>

12 
	~"x86_mÿ.h
"

13 
	~"mù–em.h
"

15 
	#MCE_QUIET
 0

	)

16 
	#MCE_VERBOSE
 1

	)

18 
	#MCE_CRITICAL
 2

	)

20 
mû_v”bos™y
;

26 
	#mû_´štk
(
v
, 
s
, 
a
...) do { \

27 ià((
v
è<ğ
mû_v”bos™y
) \

28 
	`´štk
(
s
, ##
a
); \

29 } 0)

	)

31 
	emcheck_ty³
 {

32 
	mmcheck_un£t
 = -1,

33 
	mmcheck_nÚe
,

34 
	mmcheck_amd_çmXX
,

35 
	mmcheck_amd_k7
,

36 
	mmcheck_amd_k8
,

37 
	mmcheck_š‹l


41 
mcheck_ty³
 
amd_k7_mcheck_š™
(
ıušfo_x86
 *
c
);

42 
mcheck_ty³
 
amd_k8_mcheck_š™
(
ıušfo_x86
 *
c
);

43 
mcheck_ty³
 
amd_f10_mcheck_š™
(
ıušfo_x86
 *
c
);

45 
mcheck_ty³
 
š‹l_mcheck_š™
(
ıušfo_x86
 *
c
, 
boŞ_t
 
b¥
);

47 
š‹l_mcheck_tim”
(
ıušfo_x86
 *
c
);

48 
mû_š‹l_ã©u»_š™
(
ıušfo_x86
 *
c
);

49 
amd_nÚçl_mcheck_š™
(
ıušfo_x86
 *
c
);

51 
is_vmû_»ady
(
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
);

52 
unmm­_brok’_·ge
(
domaš
 *
d
, 
mâ_t
 
mâ
, 
gâ
);

54 
u64
 
mû_ÿp_š™
();

55 
fœ¡bªk
;

57 
š‹l_mû_rdm¤
(
ušt32_t
 
m¤
, 
ušt64_t
 *
v®
);

58 
š‹l_mû_wrm¤
(
ušt32_t
 
m¤
, 
ušt64_t
 
v®
);

60 
mû_avaabË
(
ıušfo_x86
 *
c
);

61 
mû_fœ¡bªk
(
ıušfo_x86
 *
c
);

63 
mc_šfo
 *
x86_mcšfo_g‘±r
();

64 
mc_·nic
(*
s
);

65 
x86_mc_g‘_ıu_šfo
(, 
ušt32_t
 *, 
ušt16_t
 *, uint16_t *,

66 
ušt32_t
 *, uint32_t *, uint32_t *, uint32_t *);

68 
	#dom0_vmû_’abËd
(è(
dom0
 && dom0->
max_vıus
 && dom0->
vıu
[0] \

69 && 
	`gue¡_’abËd_ev’t
(
dom0
->
vıu
[0], 
VIRQ_MCA
))

	)

72 (*
	tx86_mû_veùÜ_t
)(
	tıu_u£r_»gs
 *, );

73 
	`x86_mû_veùÜ_»gi¡”
(
x86_mû_veùÜ_t
);

77 
	`mcheck_cmn_hªdËr
(
ıu_u£r_»gs
 *, , 
mÿ_bªks
 *);

80 (*
	tmû_»cov”abË_t
)(
	tu64
 
	t¡©us
);

81 
	`mû_»cov”abË_»gi¡”
(
mû_»cov”abË_t
);

84 
šo£_’t
 *
	`šo£_lookup
(, 
ušt64_t
,

85 
ušt64_t
 *);

86 
	`šo£_šv®
(, 
ušt64_t
);

88 
šlše
 
ušt64_t
 
	$mÿ_rdm¤
(
m¤
)

90 
ušt64_t
 
v®
;

91 ià(
	`šo£_lookup
(
	`smp_´oûssÜ_id
(), 
m¤
, &
v®
è=ğ
NULL
)

92 
	`rdm¤l
(
m¤
, 
v®
);

93  
v®
;

94 
	}
}

97 
	#mÿ_wrm¤
(
m¤
, 
v®
) do { \

98 
	`šo£_šv®
(
	`smp_´oûssÜ_id
(), 
m¤
); \

99 
	`wrm¤l
(
m¤
, 
v®
); \

100 } 0)

	)

110 
	emÿ_sourû
 {

111 
	mMCA_MCE_HANDLER
,

112 
	mMCA_POLLER
,

113 
	mMCA_CMCI_HANDLER
,

114 
	mMCA_RESET
,

115 
	mMCA_MCE_SCAN


118 
	smÿ_summ¬y
 {

119 
ušt32_t
 
	m”rút
;

120 
	mrv
;

121 
	mev
;

122 
ušt32_t
 
	muc
;

123 
ušt32_t
 
	mpcc
;

125 
ušt32_t
 
	m»cov”abË
;

128 
DECLARE_PER_CPU
(
mÿ_bªks
 *, 
pŞl_bªkmask
);

129 
DECLARE_PER_CPU
(
mÿ_bªks
 *, 
no_cmci_bªks
);

131 
boŞ_t
 
cmci_suµÜt
;

132 
boŞ_t
 
is_mc_·nic
;

133 
boŞ_t
 
mû_brßdÿ¡
;

134 
mcheck_mÿ_ş—rbªks
(
mÿ_bªks
 *);

136 
mù–em_cook›_t
 
mcheck_mÿ_logout
(
mÿ_sourû
, 
mÿ_bªks
 *,

137 
mÿ_summ¬y
 *, 
mÿ_bªks
 *);

154 (*
	tmû_Ãed_ş—rbªk_t
)(
	tmÿ_sourû
 
	twho
, 
	tu64
 
	t¡©us
);

155 
	`mû_Ãed_ş—rbªk_»gi¡”
(
mû_Ãed_ş—rbªk_t
);

157 
mcšfo_ex‹nded
 *(*
	tx86_mû_ÿÎback_t
)

158 (
	tmc_šfo
 *, 
	tušt16_t
, 
	tušt64_t
);

159 
	`x86_mû_ÿÎback_»gi¡”
(
x86_mû_ÿÎback_t
);

161 *
	`x86_mcšfo_add
(
mc_šfo
 *
mi
, *
mcšfo
);

162 *
	`x86_mcšfo_»£rve
(
mc_šfo
 *
mi
, 
size
);

163 
	`x86_mcšfo_dump
(
mc_šfo
 *
mi
);

165 
	`fl_vm¤_d©a
(
mcšfo_bªk
 *
mc_bªk
, 
domaš
 *
d
,

166 
ušt64_t
 
g¡©us
);

167 
	`šjeù_vmû
(
domaš
 *
d
);

168 
	`vmû_domaš_šjeù
(
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
, 
mcšfo_glob®
 *
glob®
);

170 
	`vmû_š™
(
ıušfo_x86
 *
c
);

172 
šlše
 
	$mû_v’dÜ_bªk_m¤
(
ušt32_t
 
m¤
)

174 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

175 
m¤
 >ğ
MSR_IA32_MC0_CTL2
 && m¤ < (MSR_IA32_MC0_CTL2 + 
Ä_mû_bªks
) )

178 
	}
}

180 
šlše
 
	$mû_bªk_m¤
(
ušt32_t
 
m¤
)

182 iàĞ(
m¤
 >ğ
MSR_IA32_MC0_CTL
 && m¤ < 
	`MSR_IA32_MCx_CTL
(
Ä_mû_bªks
)) ||

183 
	`mû_v’dÜ_bªk_m¤
(
m¤
) )

186 
	}
}

189 
	smû
 {

190 
__u64
 
	m¡©us
;

191 
__u64
 
	mmisc
;

192 
__u64
 
	maddr
;

193 
__u64
 
	mmcg¡©us
;

194 
__u64
 
	m
;

195 
__u64
 
	mtsc
;

196 
__u64
 
	mtime
;

197 
__u8
 
	mıuv’dÜ
;

198 
__u8
 
	mšjeù_æags
;

199 
__u16
 
	m·d
;

200 
__u32
 
	mıuid
;

201 
__u8
 
	mcs
;

202 
__u8
 
	mbªk
;

203 
__u8
 
	mıu
;

204 
__u8
 
	mfšished
;

205 
__u32
 
	mextıu
;

206 
__u32
 
	msock‘id
;

207 
__u32
 
	m­icid
;

208 
__u64
 
	mmcgÿp
;

	@cpu/mcheck/mce_amd_quirks.c

20 
	~<asm-x86/m¤.h
>

21 
	~<asm-x86/´oûssÜ.h
>

23 
	~"mû_quœks.h
"

25 
	#ANY
 -1

	)

27 cÚ¡ 
mû_quœkd©a
 
	gmû_amd_quœks
[] = {

28 { 0x6 , 
ANY
 , ANY ,

29 
MCEQUIRK_K7_BANK0
 },

30 { 0xà , 
ANY
 , ANY ,

31 
MCEQUIRK_K8_GART
 },

34 
mûquœk_amd_æags


35 
	$mûquœk_lookup_amd_quœkd©a
(
ıušfo_x86
 *
c
)

37 
i
;

39 
	`BUG_ON
(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
);

41 
i
 = 0; i < 
	`ARRAY_SIZE
(
mû_amd_quœks
); i++) {

42 ià(
c
->
x86
 !ğ
mû_amd_quœks
[
i
].
ıu_çmy
)

44 iàĞ(
mû_amd_quœks
[
i
].
ıu_mod–
 !ğ
ANY
) &&

45 (
mû_amd_quœks
[
i
].
ıu_mod–
 !ğ
c
->
x86_mod–
) )

47 iàĞ(
mû_amd_quœks
[
i
].
ıu_¡•pšg
 !ğ
ANY
) &&

48 (
mû_amd_quœks
[
i
].
ıu_¡•pšg
 !ğ
c
->
x86_mask
) )

50  
mû_amd_quœks
[
i
].
quœk
;

53 
	}
}

55 
	$mûquœk_amd_­¶y
(
mûquœk_amd_æags
 
æags
)

57 
æags
) {

58 
MCEQUIRK_K7_BANK0
:

61 
MCEQUIRK_K8_GART
:

67 
	`wrm¤l
(
MSR_IA32_MC4_CTL
, ~(1ULL << 10));

68 
	`wrm¤l
(
MSR_IA32_MC4_STATUS
, 0ULL);

73 
	}
}

	@cpu/mcheck/mce_intel.c

1 
	~<x’/š™.h
>

2 
	~<x’/ty³s.h
>

3 
	~<x’/œq.h
>

4 
	~<x’/ev’t.h
>

5 
	~<x’/k”Ãl.h
>

6 
	~<x’/d–ay.h
>

7 
	~<x’/smp.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/ıu.h
>

10 
	~<asm/´oûssÜ.h
>

11 
	~<public/sysùl.h
>

12 
	~<asm/sy¡em.h
>

13 
	~<asm/m¤.h
>

14 
	~<asm/p2m.h
>

15 
	~<asm/mû.h
>

16 
	~<asm/­ic.h
>

17 
	~"mû.h
"

18 
	~"x86_mÿ.h
"

20 
DEFINE_PER_CPU
(
mÿ_bªks
 *, 
mû_bªks_owÃd
);

21 
DEFINE_PER_CPU
(
mÿ_bªks
 *, 
no_cmci_bªks
);

22 
DEFINE_PER_CPU
(
mÿ_bªks
 *, 
mû_ş—r_bªks
);

23 
boŞ_t
 
__»ad_mo¡ly
 
	gcmci_suµÜt
 = 0;

24 
boŞ_t
 
__»ad_mo¡ly
 
	g£r_suµÜt
 = 0;

25 
boŞ_t
 
__»ad_mo¡ly
 
	gmû_fÜû_brßdÿ¡
;

26 
boŞ—n_·¿m
("mû_fb", 
mû_fÜû_brßdÿ¡
);

28 
	gÄ_š‹l_ext_m¤s
 = 0;

31 #ifdeà
CONFIG_X86_MCE_THERMAL


32 
	$uÃx³ùed_th”m®_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

34 
	`´štk
(
KERN_ERR
 "Thermal: CPU%d: Unexpected LVT TMR interrupt!\n",

35 
	`smp_´oûssÜ_id
());

36 
	`add_št
(
TAINT_MACHINE_CHECK
);

37 
	}
}

40 
	$š‹l_th”m®_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

42 
ušt64_t
 
m¤_cÚ‹Á
;

43 
ıu
 = 
	`smp_´oûssÜ_id
();

44 
	`DEFINE_PER_CPU
(
s_time_t
, 
Ãxt
);

46 
	`ack_APIC_œq
();

47 ià(
	`NOW
(è< 
	`³r_ıu
(
Ãxt
, 
ıu
))

50 
	`³r_ıu
(
Ãxt
, 
ıu
èğ
	`NOW
(è+ 
	`MILLISECS
(5000);

51 
	`rdm¤l
(
MSR_IA32_THERM_STATUS
, 
m¤_cÚ‹Á
);

52 ià(
m¤_cÚ‹Á
 & 0x1) {

53 
	`´štk
(
KERN_EMERG
 "CPU%d: Tem³¿tu»‡bovth»shŞd\n", 
ıu
);

54 
	`´štk
(
KERN_EMERG
 "CPU%d: Running in modulated clock mode\n",

55 
ıu
);

56 
	`add_št
(
TAINT_MACHINE_CHECK
);

58 
	`´štk
(
KERN_INFO
 "CPU%d: Tem³¿tu»/¥“d‚Üm®\n", 
ıu
);

60 
	}
}

63 (*
v’dÜ_th”m®_š‹¼u±
)(
ıu_u£r_»gs
 *
»gs
)

64 ğ
uÃx³ùed_th”m®_š‹¼u±
;

66 
ç¡ÿÎ
 
	$smp_th”m®_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

68 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

69 
	`œq_’‹r
();

70 
	`v’dÜ_th”m®_š‹¼u±
(
»gs
);

71 
	`œq_ex™
();

72 
	`£t_œq_»gs
(
Şd_»gs
);

73 
	}
}

76 
	$š‹l_š™_th”m®
(
ıušfo_x86
 *
c
)

78 
ušt64_t
 
m¤_cÚ‹Á
;

79 
ušt32_t
 
v®
;

80 
tm2
 = 0;

81 
ıu
 = 
	`smp_´oûssÜ_id
();

84 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACPI
))

88 ià(!
	`ıu_has
(
c
, 
X86_FEATURE_ACC
))

95 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
m¤_cÚ‹Á
);

96 
v®
 = 
	`­ic_»ad
(
APIC_LVTTHMR
);

97 ià((
m¤_cÚ‹Á
 & (1ULL<<3)è&& (
v®
 & 
APIC_DM_SMI
)) {

98 
	`´štk
(
KERN_DEBUG
 "CPU%d: Th”m® mÚ™Üšg hªdËd by SMI\n",
ıu
);

102 ià(
	`ıu_has
(
c
, 
X86_FEATURE_TM2
è&& (
m¤_cÚ‹Á
 & (1ULL << 13)))

103 
tm2
 = 1;

106 ià(
v®
 & 
APIC_VECTOR_MASK
) {

107 
	`´štk
(
KERN_DEBUG
 "CPU%d: Thermal LVT vector (%#x)‡lready installed\n",

108 
ıu
, (
v®
 & 
APIC_VECTOR_MASK
));

113 
v®
 = 
THERMAL_APIC_VECTOR
;

114 
v®
 |ğ(
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
);

115 
	`­ic_wr™e_¬ound
(
APIC_LVTTHMR
, 
v®
);

117 
	`rdm¤l
(
MSR_IA32_THERM_INTERRUPT
, 
m¤_cÚ‹Á
);

118 
	`wrm¤l
(
MSR_IA32_THERM_INTERRUPT
, 
m¤_cÚ‹Á
 | 0x03);

121 
v’dÜ_th”m®_š‹¼u±
 = 
š‹l_th”m®_š‹¼u±
;

123 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
m¤_cÚ‹Á
);

124 
	`wrm¤l
(
MSR_IA32_MISC_ENABLE
, 
m¤_cÚ‹Á
 | (1ULL<<3));

126 
	`­ic_wr™e_¬ound
(
APIC_LVTTHMR
, 
	`­ic_»ad
(APIC_LVTTHMRè& ~
APIC_LVT_MASKED
);

127 ià(
İt_ıu_šfo
)

128 
	`´štk
(
KERN_INFO
 "CPU%u: Thermal monitoringƒnabled (%s)\n",

129 
ıu
, 
tm2
 ? "TM2" : "TM1");

131 
	}
}

135 
	smû_soáœq_b¬r›r
 {

136 
©omic_t
 
	mv®
;

137 
©omic_t
 
	mšg’
;

138 
©omic_t
 
	moutg’
;

141 
mû_soáœq_b¬r›r
 
	gmû_šside_b¬
, 
	gmû_£v”™y_b¬
;

142 
mû_soáœq_b¬r›r
 
	gmû_Œ­_b¬
;

150 
DEFINE_SPINLOCK
(
mû_logout_lock
);

152 
©omic_t
 
	g£v”™y_ıu
 = 
ATOMIC_INIT
(-1);

153 
©omic_t
 
	gfound_”rÜ
 = 
ATOMIC_INIT
(0);

154 
ıumask_t
 
	gmû_çl_ıus
;

156 
mû_b¬r›r_’‹r
(
mû_soáœq_b¬r›r
 *);

157 
mû_b¬r›r_ex™
(
mû_soáœq_b¬r›r
 *);

159 
mÿ_”rÜ_hªdËr
 *
	gmû_dhªdËrs
, *
	gmû_uhªdËrs
;

160 
	gmû_dhªdËr_num
, 
	gmû_uhªdËr_num
;

162 
	emû_»suÉ


164 
	mMCER_NOERROR
,

165 
	mMCER_RECOVERED
,

167 
	mMCER_CONTINUE
,

168 
	mMCER_RESET
,

172 
mû_»suÉ
 
	$mû_aùiÚ
(
ıu_u£r_»gs
 *
»gs
,

173 
mù–em_cook›_t
 
mùc
)

175 
mc_šfo
 *
loÿl_mi
;

176 
mû_»suÉ
 
»t
 = 
MCER_NOERROR
;

177 
ušt32_t
 
i
;

178 
mcšfo_commÚ
 *
mic
 = 
NULL
;

179 
mÿ_hªdË_»suÉ
 
mÿ_»s
;

180 
mÿ_bšfo
 
bšfo
;

181 
mÿ_”rÜ_hªdËr
 *
hªdËrs
 = 
mû_dhªdËrs
;

182 
hªdËr_num
 = 
mû_dhªdËr_num
;

185 ià(
»gs
)

187 
hªdËr_num
 = 
mû_uhªdËr_num
;

188 
hªdËrs
 = 
mû_uhªdËrs
;

192 
	`ASSERT
(
hªdËr_num
);

194 
loÿl_mi
 = (
mc_šfo
*)
	`mù–em_d©­Œ
(
mùc
);

195 
	`x86_mcšfo_lookup
(
mic
, 
loÿl_mi
, 
MC_TYPE_GLOBAL
);

196 ià(
mic
 =ğ
NULL
) {

197 
	`´štk
(
KERN_ERR
 "MCE: get†ocal bufferƒntry failed\n ");

198  
MCER_CONTINUE
;

201 
	`mem£t
(&
bšfo
, 0, (binfo));

202 
bšfo
.
mig
 = (
mcšfo_glob®
 *)
mic
;

203 
bšfo
.
mi
 = 
loÿl_mi
;

206 
	`x86_mcšfo_lookup
(
mic
, 
loÿl_mi
, 
MC_TYPE_BANK
);

208  ; 
»t
 !ğ
MCER_RESET
 && 
mic
 && mic->
size
;

209 
mic
 = 
	`x86_mcšfo_Ãxt
(mic) )

211 ià(
mic
->
ty³
 !ğ
MC_TYPE_BANK
) {

214 
bšfo
.
mib
 = (
mcšfo_bªk
*)
mic
;

215 
bšfo
.
bªk
 = bšfo.
mib
->
mc_bªk
;

216 
	`mem£t
(&
mÿ_»s
, 0x0f, (mca_res));

217  
i
 = 0; i < 
hªdËr_num
; i++ ) {

218 ià(
hªdËrs
[
i
].
	`owÃd_”rÜ
(
bšfo
.
mib
->
mc_¡©us
))

220 
hªdËrs
[
i
].
	`»cov”y_hªdËr
(
bšfo
.
bªk
, &bšfo, &
mÿ_»s
);

222 ià(
mÿ_»s
.
»suÉ
 & 
MCA_OWNER
)

223 
bšfo
.
mib
->
mc_domid
 = 
mÿ_»s
.
owÃr
;

225 ià(
mÿ_»s
.
»suÉ
 =ğ
MCA_NEED_RESET
)

226 
»t
 = 
MCER_RESET
;

227 ià(
mÿ_»s
.
»suÉ
 =ğ
MCA_RECOVERED
)

229 ià(
»t
 < 
MCER_RECOVERED
)

230 
»t
 = 
MCER_RECOVERED
;

232 ià(
mÿ_»s
.
»suÉ
 =ğ
MCA_NO_ACTION
)

234 ià(
»t
 < 
MCER_CONTINUE
)

235 
»t
 = 
MCER_CONTINUE
;

240 
	`ASSERT
(
i
 !ğ
hªdËr_num
);

243  
»t
;

244 
	}
}

251 
	$mû_d–ayed_aùiÚ
(
mù–em_cook›_t
 
mùc
)

253 
mû_»suÉ
 
»suÉ
;

254 
»t
 = 0;

256 
»suÉ
 = 
	`mû_aùiÚ
(
NULL
, 
mùc
);

258 
»suÉ
)

260 
MCER_RESET
:

261 
	`d´štk
(
XENLOG_ERR
, "MCE delayed‡ction failed\n");

262 
	`x86_mcšfo_dump
(
	`mù–em_d©­Œ
(
mùc
));

263 
	`·nic
("MCE: Software„ecovery failed forhe UCR\n");

265 
MCER_RECOVERED
:

266 
	`d´štk
(
XENLOG_INFO
, "MCE: Error is successfully„ecovered\n");

267 
»t
 = 1;

269 
MCER_CONTINUE
:

270 
	`d´štk
(
XENLOG_INFO
, "MCE: Error can't be„ecovered, "

272 
	`x86_mcšfo_dump
(
	`mù–em_d©­Œ
(
mùc
));

273 
»t
 = 1;

276 
»t
 = 0;

279  
»t
;

280 
	}
}

283 
	$mû_soáœq
()

285 
ıu
 = 
	`smp_´oûssÜ_id
();

286 
wÜkıu
;

288 
	`mû_´štk
(
MCE_VERBOSE
, "CPU%dƒÁ” soáœq\n", 
ıu
);

290 
	`mû_b¬r›r_’‹r
(&
mû_šside_b¬
);

301 
	`©omic_£t
(&
£v”™y_ıu
, 
ıu
);

303 
	`mû_b¬r›r_’‹r
(&
mû_£v”™y_b¬
);

304 ià(!
	`mù–em_has_deã¼ed
(
ıu
))

305 
	`©omic_£t
(&
£v”™y_ıu
, 
ıu
);

306 
	`mû_b¬r›r_ex™
(&
mû_£v”™y_b¬
);

309 ià(
	`©omic_»ad
(&
£v”™y_ıu
è=ğ
ıu
) {

311 
	`mû_´štk
(
MCE_VERBOSE
, "CPU%d hªdlšgƒ¼Üs\n", 
ıu
);

316 
	`fÜ_—ch_Úlše_ıu
(
wÜkıu
) {

317 
	`mù–em_´oûss_deã¼ed
(
wÜkıu
, 
mû_d–ayed_aùiÚ
);

321 ià(
	`dom0_vmû_’abËd
()) {

322 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: send MCE#o DOM0hrough virq\n");

323 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

327 
	`mû_b¬r›r_ex™
(&
mû_šside_b¬
);

328 
	}
}

335 
	$mû_urg’t_aùiÚ
(
ıu_u£r_»gs
 *
»gs
,

336 
mù–em_cook›_t
 
mùc
)

338 
ušt64_t
 
g¡©us
;

340 iàĞ
mùc
 =ğ
NULL
)

343 
g¡©us
 = 
	`mÿ_rdm¤
(
MSR_IA32_MCG_STATUS
);

345 iàĞ!(
g¡©us
 & 
MCG_STATUS_RIPV
è&& !
	`gue¡_mode
(
»gs
))

348  
	`mû_aùiÚ
(
»gs
, 
mùc
è=ğ
MCER_RESET
 ? -1 : 0;

349 
	}
}

366 
	$mû_·nic_check
()

368 ià(
is_mc_·nic
) {

369 
	`loÿl_œq_’abË
();

371 
	`h®t
();

373 
	}
}

378 
	$mû_b¬r›r_š™
(
mû_soáœq_b¬r›r
 *
b¬
)

380 
	`©omic_£t
(&
b¬
->
v®
, 0);

381 
	`©omic_£t
(&
b¬
->
šg’
, 0);

382 
	`©omic_£t
(&
b¬
->
outg’
, 0);

383 
	}
}

385 
	$mû_hªdËr_š™
()

387 ià(
	`smp_´oûssÜ_id
() != 0)

392 
	`mû_b¬r›r_š™
(&
mû_šside_b¬
);

393 
	`mû_b¬r›r_š™
(&
mû_£v”™y_b¬
);

394 
	`mû_b¬r›r_š™
(&
mû_Œ­_b¬
);

395 
	`¥š_lock_š™
(&
mû_logout_lock
);

396 
	`İ’_soáœq
(
MACHINE_CHECK_SOFTIRQ
, 
mû_soáœq
);

397 
	}
}

406 
	$mû_b¬r›r_dec
(
mû_soáœq_b¬r›r
 *
b¬
)

408 
	`©omic_šc
(&
b¬
->
outg’
);

409 
	`wmb
();

410 
	`©omic_dec
(&
b¬
->
v®
);

411 
	}
}

414 
	$mû_¥š_lock
(
¥šlock_t
 *
lk
)

416 !
	`¥š_Œylock
(
lk
)) {

417 
	`ıu_»Ïx
();

418 
	`mû_·nic_check
();

420 
	}
}

422 
	$mû_¥š_uÆock
(
¥šlock_t
 *
lk
)

424 
	`¥š_uÆock
(
lk
);

425 
	}
}

439 
	$mû_b¬r›r_’‹r
(
mû_soáœq_b¬r›r
 *
b¬
)

441 
g’
;

443 ià(!
mû_brßdÿ¡
)

445 
	`©omic_šc
(&
b¬
->
šg’
);

446 
g’
 = 
	`©omic_»ad
(&
b¬
->
outg’
);

447 
	`mb
();

448 
	`©omic_šc
(&
b¬
->
v®
);

449  
	`©omic_»ad
(&
b¬
->
v®
è!ğ
	`num_Úlše_ıus
() &&

450 
	`©omic_»ad
(&
b¬
->
outg’
è=ğ
g’
) {

451 
	`mb
();

452 
	`mû_·nic_check
();

454 
	}
}

456 
	$mû_b¬r›r_ex™
(
mû_soáœq_b¬r›r
 *
b¬
)

458 
g’
;

460 ià(!
mû_brßdÿ¡
)

462 
	`©omic_šc
(&
b¬
->
outg’
);

463 
g’
 = 
	`©omic_»ad
(&
b¬
->
šg’
);

464 
	`mb
();

465 
	`©omic_dec
(&
b¬
->
v®
);

466  
	`©omic_»ad
(&
b¬
->
v®
) != 0 &&

467 
	`©omic_»ad
(&
b¬
->
šg’
è=ğ
g’
 ) {

468 
	`mb
();

469 
	`mû_·nic_check
();

471 
	}
}

474 
	$mû_b¬r›r
(
mû_soáœq_b¬r›r
 *
b¬
)

476 
	`mû_b¬r›r_’‹r
(
b¬
);

477 
	`mû_b¬r›r_ex™
(
b¬
);

478 
	}
}

482 
šlše
 
	$š‹l_g‘_ex‹nded_m¤
(
mcšfo_ex‹nded
 *
ext
, 
u32
 
m¤
)

484 iàĞ
ext
->
mc_m¤s
 < 
	`ARRAY_SIZE
Óxt->
mc_m¤
)

485 && 
m¤
 < 
MSR_IA32_MCG_EAX
 + 
Ä_š‹l_ext_m¤s
 ) {

486 
ext
->
mc_m¤
[ext->
mc_m¤s
].
»g
 = 
m¤
;

487 
	`rdm¤l
(
m¤
, 
ext
->
mc_m¤
[ext->
mc_m¤s
].
v®ue
);

488 ++
ext
->
mc_m¤s
;

490 
	}
}

493 
mcšfo_ex‹nded
 *

494 
	$š‹l_g‘_ex‹nded_m¤s
(
mcšfo_glob®
 *
mig
, 
mc_šfo
 *
mi
)

496 
mcšfo_ex‹nded
 *
mc_ext
;

497 
i
;

503 ià(!
mi
|| !
mig
 || 
Ä_š‹l_ext_m¤s
 == 0 ||

504 !(
mig
->
mc_g¡©us
 & 
MCG_STATUS_EIPV
))

505  
NULL
;

507 
mc_ext
 = 
	`x86_mcšfo_»£rve
(
mi
, (
mcšfo_ex‹nded
));

508 ià(!
mc_ext
)

510 
mi
->
æags
 |ğ
MCINFO_FLAGS_UNCOMPLETE
;

511  
NULL
;

515 
	`mem£t
(&
mc_ext
, 0, (
mcšfo_ex‹nded
));

516 
mc_ext
->
commÚ
.
ty³
 = 
MC_TYPE_EXTENDED
;

517 
mc_ext
->
commÚ
.
size
 = (
mcšfo_ex‹nded
);

519 
i
 = 
MSR_IA32_MCG_EAX
; i <ğ
MSR_IA32_MCG_MISC
; i++)

520 
	`š‹l_g‘_ex‹nded_m¤
(
mc_ext
, 
i
);

522 #ifdeà
__x86_64__


523 
i
 = 
MSR_IA32_MCG_R8
; i <ğ
MSR_IA32_MCG_R15
; i++)

524 
	`š‹l_g‘_ex‹nded_m¤
(
mc_ext
, 
i
);

527  
mc_ext
;

528 
	}
}

530 
	eš‹l_mû_ty³


532 
	mš‹l_mû_šv®id
,

533 
	mš‹l_mû_çl
,

534 
	mš‹l_mû_cÜ»ùed
,

535 
	mš‹l_mû_uü_uúa
,

536 
	mš‹l_mû_uü_¤ao
,

537 
	mš‹l_mû_uü_¤¬
,

540 
š‹l_mû_ty³
 
	$š‹l_check_mû_ty³
(
ušt64_t
 
¡©us
)

542 ià(!(
¡©us
 & 
MCi_STATUS_VAL
))

543  
š‹l_mû_šv®id
;

545 ià(
¡©us
 & 
MCi_STATUS_PCC
)

546  
š‹l_mû_çl
;

549 ià(!(
¡©us
 & 
MCi_STATUS_UC
))

550  
š‹l_mû_cÜ»ùed
;

552 ià(!
£r_suµÜt
)

553  
š‹l_mû_çl
;

555 ià(
¡©us
 & 
MCi_STATUS_S
)

557 ià(
¡©us
 & 
MCi_STATUS_AR
)

559 ià(
¡©us
 & 
MCi_STATUS_OVER
)

560  
š‹l_mû_çl
;

562  
š‹l_mû_uü_¤¬
;

564  
š‹l_mû_uü_¤ao
;

567  
š‹l_mû_uü_uúa
;

570  
š‹l_mû_çl
;

571 
	}
}

573 
	$is_async_mem”r
(
ušt64_t
 
¡©us
)

575  (
¡©us
 & 0xFFFF) == 0x17A || (status & 0xFFF0) == 0xC0;

576 
	}
}

578 
mcšfo_»cov”y
 *
	$mci_add_·geoff_aùiÚ
(
bªk
, 
mc_šfo
 *
mi
,

579 
ušt64_t
 
mâ
, 
ušt32_t
 
¡©us
)

581 
mcšfo_»cov”y
 *
»c
;

583 ià(!
mi
)

584  
NULL
;

586 
»c
 = 
	`x86_mcšfo_»£rve
(
mi
, (
mcšfo_»cov”y
));

587 ià(!
»c
)

589 
mi
->
æags
 |ğ
MCINFO_FLAGS_UNCOMPLETE
;

590  
NULL
;

593 
	`mem£t
(
»c
, 0, (
mcšfo_»cov”y
));

595 
»c
->
mc_bªk
 = 
bªk
;

596 
»c
->
aùiÚ_ty³s
 = 
MC_ACTION_PAGE_OFFLINE
;

597 
»c
->
aùiÚ_šfo
.
·ge_»tœe
.
mâ
 = mfn;

598 
»c
->
aùiÚ_šfo
.
·ge_»tœe
.
¡©us
 = status;

599  
»c
;

600 
	}
}

602 
	$š‹l_mem”r_dhªdËr
(
bnum
,

603 
mÿ_bšfo
 *
bšfo
,

604 
mÿ_hªdË_»suÉ
 *
»suÉ
)

606 
mcšfo_bªk
 *
bªk
 = 
bšfo
->
mib
;

607 
mcšfo_glob®
 *
glob®
 = 
bšfo
->
mig
;

608 
domaš
 *
d
;

609 
mâ
, 
gâ
;

610 
ušt32_t
 
¡©us
;

611 
ušt64_t
 
mc_¡©us
, 
mc_misc
;

613 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: Enter UCR„ecovery‡ction\n");

614 
»suÉ
->»suÉ = 
MCA_NEED_RESET
;

616 
mc_¡©us
 = 
bªk
->mc_status;

617 
mc_misc
 = 
bªk
->mc_misc;

618 ià(!(
mc_¡©us
 & 
MCi_STATUS_ADDRV
) ||

619 !(
mc_¡©us
 & 
MCi_STATUS_MISCV
) ||

620 ((
mc_misc
 & 
MCi_MISC_ADDRMOD_MASK
è!ğ
MCi_MISC_PHYSMOD
) )

622 
»suÉ
->»suÉ |ğ
MCA_NO_ACTION
;

623 
	`d´štk
(
XENLOG_WARNING
,

628 
mâ
 = 
bªk
->
mc_addr
 >> 
PAGE_SHIFT
;

629 ià(
	`ofæše_·ge
(
mâ
, 1, &
¡©us
))

631 
	`d´štk
(
XENLOG_WARNING
,

632 "FaedØofæš·g%lx fÜ MCEƒ¼Ü\n", 
mâ
);

636 
	`mci_add_·geoff_aùiÚ
(
bnum
, 
bšfo
->
mi
, 
mâ
, 
¡©us
);

639 ià(
¡©us
 & 
PG_OFFLINE_OFFLINED
)

640 
»suÉ
->»suÉ = 
MCA_RECOVERED
;

641 ià(
¡©us
 & 
PG_OFFLINE_PENDING
) {

643 ià(
¡©us
 & 
PG_OFFLINE_OWNED
) {

644 
»suÉ
->»suÉ |ğ
MCA_OWNER
;

645 
»suÉ
->
owÃr
 = 
¡©us
 >> 
PG_OFFLINE_OWNER_SHIFT
;

646 
	`mû_´štk
(
MCE_QUIET
, "MCE: Thisƒrror…age is ownded"

647 " by DOM %d\n", 
»suÉ
->
owÃr
);

650 
bªk
->
mc_domid
 = 
»suÉ
->
owÃr
;

654 
	`BUG_ON
Ğ
»suÉ
->
owÃr
 =ğ
DOMID_COW
 );

655 iàĞ
»suÉ
->
owÃr
 !ğ
DOMID_XEN
 ) {

656 
d
 = 
	`g‘_domaš_by_id
(
»suÉ
->
owÃr
);

657 
	`ASSERT
(
d
);

658 
gâ
 = 
	`g‘_gpâ_äom_mâ
((
bªk
->
mc_addr
è>> 
PAGE_SHIFT
);

660 iàĞ!
	`is_vmû_»ady
(
bªk
, 
d
) )

662 
	`´štk
("DOM%d‚Ù„—dy fÜ vMCE\n", 
d
->
domaš_id
);

663 
vmû_çed
;

666 iàĞ
	`unmm­_brok’_·ge
(
d
, 
	`_mâ
(
mâ
), 
gâ
) )

668 
	`´štk
("Unmap broken memory %lx for DOM%d failed\n",

669 
mâ
, 
d
->
domaš_id
);

670 
vmû_çed
;

673 
bªk
->
mc_addr
 = 
gâ
 << 
PAGE_SHIFT
 |

674 (
bªk
->
mc_addr
 & (
PAGE_SIZE
 -1 ));

675 iàĞ
	`fl_vm¤_d©a
(
bªk
, 
d
,

676 
glob®
->
mc_g¡©us
) == -1 )

678 
	`mû_´štk
(
MCE_QUIET
, "Fill vMCE# data for DOM%d "

679 "çed\n", 
»suÉ
->
owÃr
);

680 
vmû_çed
;

684 iàĞ
	`šjeù_vmû
(
d
) < 0 )

686 
	`mû_´štk
(
MCE_QUIET
, "inject vMCEo DOM%d"

687 " faed\n", 
d
->
domaš_id
);

688 
vmû_çed
;

695 
»suÉ
->»suÉ = 
MCA_RECOVERED
;

696 
	`put_domaš
(
d
);

699 
vmû_çed
:

700 
	`put_domaš
(
d
);

701 
	`domaš_üash
(
d
);

705 
	}
}

707 
	$deçuÉ_check
(
ušt64_t
 
¡©us
)

710 
	}
}

712 
	$š‹l_deçuÉ_dhªdËr
(
bnum
,

713 
mÿ_bšfo
 *
bšfo
,

714 
mÿ_hªdË_»suÉ
 *
»suÉ
)

716 
ušt64_t
 
¡©us
 = 
bšfo
->
mib
->
mc_¡©us
;

717 
š‹l_mû_ty³
 
ty³
;

719 
ty³
 = 
	`š‹l_check_mû_ty³
(
¡©us
);

721 ià(
ty³
 =ğ
š‹l_mû_çl
 ||y³ =ğ
š‹l_mû_uü_¤¬
)

722 
»suÉ
->»suÉ = 
MCA_RESET
;

723 ià(
ty³
 =ğ
š‹l_mû_uü_¤ao
)

724 
»suÉ
->»suÉ = 
MCA_NO_ACTION
;

725 
	}
}

727 
mÿ_”rÜ_hªdËr
 
	gš‹l_mû_dhªdËrs
[] =

728 {{
is_async_mem”r
, 
š‹l_mem”r_dhªdËr
}, {
deçuÉ_check
, 
š‹l_deçuÉ_dhªdËr
}};

730 
	$š‹l_deçuÉ_uhªdËr
(
bnum
,

731 
mÿ_bšfo
 *
bšfo
,

732 
mÿ_hªdË_»suÉ
 *
»suÉ
)

734 
ušt64_t
 
¡©us
 = 
bšfo
->
mib
->
mc_¡©us
;

735 
š‹l_mû_ty³
 
ty³
;

737 
ty³
 = 
	`š‹l_check_mû_ty³
(
¡©us
);

739 
ty³
)

742 
š‹l_mû_uü_¤¬
:

743 
š‹l_mû_çl
:

744 
»suÉ
->»suÉ = 
MCA_RESET
;

747 
»suÉ
->»suÉ = 
MCA_NO_ACTION
;

750 
	}
}

752 
mÿ_”rÜ_hªdËr
 
	gš‹l_mû_uhªdËrs
[] =

753 {{
deçuÉ_check
, 
š‹l_deçuÉ_uhªdËr
}};

755 
	$š‹l_machše_check
(
ıu_u£r_»gs
 * 
»gs
, 
”rÜ_code
)

757 
ušt64_t
 
g¡©us
;

758 
mù–em_cook›_t
 
mùc
 = 
NULL
;

759 
mÿ_summ¬y
 
bs
;

760 
mÿ_bªks
 *
ş—r_bªk
;

762 
	`mû_¥š_lock
(&
mû_logout_lock
);

764 
ş—r_bªk
 = 
	`__g‘_ıu_v¬
(
mû_ş—r_bªks
);

765 
	`mem£t
Ğ
ş—r_bªk
->
bªk_m­
, 0x0,

766 (è* 
	`BITS_TO_LONGS
(
ş—r_bªk
->
num
));

767 
mùc
 = 
	`mcheck_mÿ_logout
(
MCA_MCE_SCAN
, 
mÿ_®lbªks
, &
bs
, 
ş—r_bªk
);

769 ià(
bs
.
”rút
) {

773 ià(
bs
.
uc
 || bs.
pcc
) {

774 
	`add_št
(
TAINT_MACHINE_CHECK
);

775 ià(
mùc
 !ğ
NULL
)

776 
	`mù–em_deãr
(
mùc
);

782 ià(
bs
.
pcc
 || !bs.
»cov”abË
)

783 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
mû_çl_ıus
);

785 ià(
mùc
 !ğ
NULL
)

786 
	`mù–em_comm™
(
mùc
);

788 
	`©omic_£t
(&
found_”rÜ
, 1);

791 
	`©omic_£t
(&
£v”™y_ıu
, 
	`smp_´oûssÜ_id
());

793 
	`mû_´štk
(
MCE_CRITICAL
, "MCE: clear_bank map %lx on CPU%d\n",

794 *((*)
ş—r_bªk
), 
	`smp_´oûssÜ_id
());

795 
	`mcheck_mÿ_ş—rbªks
(
ş—r_bªk
);

797 ià(
mùc
 !ğ
NULL
)

798 
	`mù–em_dismiss
(
mùc
);

800 
	`mû_¥š_uÆock
(&
mû_logout_lock
);

802 
	`mû_b¬r›r_’‹r
(&
mû_Œ­_b¬
);

803 iàĞ
mùc
 !ğ
NULL
 && 
	`mû_urg’t_aùiÚ
(
»gs
, mctc))

804 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
mû_çl_ıus
);

805 
	`mû_b¬r›r_ex™
(&
mû_Œ­_b¬
);

809 
	`mû_b¬r›r_’‹r
(&
mû_Œ­_b¬
);

810 ià(
	`©omic_»ad
(&
£v”™y_ıu
è=ğ
	`smp_´oûssÜ_id
())

816 ià(
	`©omic_»ad
(&
found_”rÜ
) == 0)

817 
	`mc_·nic
("MCE: No CPU found valid MCE,‚eed„eset\n");

818 ià(!
	`ıus_em±y
(
mû_çl_ıus
))

820 *
ebuå
, 
ebuf
[96] = "MCE: Fatalƒrror happened on CPUs ";

821 
ebuå
 = 
ebuf
 + 
	`¡¾’
(ebuf);

822 
	`ıumask_sú´štf
(
ebuå
, 95 - 
	`¡¾’
(
ebuf
), 
mû_çl_ıus
);

823 
	`mc_·nic
(
ebuf
);

825 
	`©omic_£t
(&
found_”rÜ
, 0);

827 
	`mû_b¬r›r_ex™
(&
mû_Œ­_b¬
);

830 
	`mû_b¬r›r_’‹r
(&
mû_Œ­_b¬
);

831 
g¡©us
 = 
	`mÿ_rdm¤
(
MSR_IA32_MCG_STATUS
);

832 ià((
g¡©us
 & 
MCG_STATUS_MCIP
) != 0) {

833 
	`mû_´štk
(
MCE_CRITICAL
, "MCE: Clear MCIP@†ast step");

834 
	`mÿ_wrm¤
(
MSR_IA32_MCG_STATUS
, 
g¡©us
 & ~
MCG_STATUS_MCIP
);

836 
	`mû_b¬r›r_ex™
(&
mû_Œ­_b¬
);

838 
	`¿i£_soáœq
(
MACHINE_CHECK_SOFTIRQ
);

839 
	}
}

851 
	$š‹l_Ãed_ş—rbªk_sÿn
(
mÿ_sourû
 
who
, 
u64
 
¡©us
)

853 iàĞ
who
 =ğ
MCA_CMCI_HANDLER
) {

855 iàĞ!(
¡©us
 & 
MCi_STATUS_UC
) )

858 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_OVER
)

859 && !(
¡©us
 & 
MCi_STATUS_EN
) )

862 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_OVER
)

863 && !(
¡©us
 & 
MCi_STATUS_PCC
è&& !(¡©u & 
MCi_STATUS_S
)

864 && !(
¡©us
 & 
MCi_STATUS_AR
))

869 iàĞ
who
 =ğ
MCA_MCE_SCAN
) {

871 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_OVER
)

872 && (
¡©us
 & 
MCi_STATUS_UC
è&& !(¡©u & 
MCi_STATUS_EN
))

875 iàĞ
£r_suµÜt
 && (
¡©us
 & 
MCi_STATUS_UC
)

876 && (
¡©us
 & 
MCi_STATUS_S
è&& (¡©u & 
MCi_STATUS_AR
 )

877 && (
¡©us
 & 
MCi_STATUS_OVER
) )

880 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_AR
)

881 && (
¡©us
 & 
MCi_STATUS_S
è&& (¡©u & 
MCi_STATUS_UC
))

888 
	}
}

897 
	$š‹l_»cov”abË_sÿn
(
u64
 
¡©us
)

900 iàĞ!(
¡©us
 & 
MCi_STATUS_UC
 ) )

902 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_EN
)

903 && !(
¡©us
 & 
MCi_STATUS_OVER
) )

906 iàĞ
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_OVER
)

907 && !(
¡©us
 & 
MCi_STATUS_PCC
è&& (¡©u & 
MCi_STATUS_S
)

908 && (
¡©us
 & 
MCi_STATUS_AR
) ) {

909 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: No SRARƒrror defined currently.\n");

913 ià(
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_PCC
)

914 && (
¡©us
 & 
MCi_STATUS_S
è&& !(¡©u & 
MCi_STATUS_AR
)

915 && (
¡©us
 & 
MCi_STATUS_EN
))

918 ià(
£r_suµÜt
 && !(
¡©us
 & 
MCi_STATUS_OVER
)

919 && (
¡©us
 & 
MCi_STATUS_EN
è&& !(¡©u & 
MCi_STATUS_PCC
)

920 && !(
¡©us
 & 
MCi_STATUS_S
è&& !(¡©u & 
MCi_STATUS_AR
))

923 
	}
}

926 
DEFINE_SPINLOCK
(
cmci_discov”_lock
);

931 
	$do_cmci_discov”
(
i
)

933 
m¤
 = 
MSR_IA32_MC0_CTL2
 + 
i
;

934 
u64
 
v®
;

936 
	`rdm¤l
(
m¤
, 
v®
);

938 ià(
v®
 & 
CMCI_EN
) {

939 
	`mÿbªks_ş—r
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

940 
out
;

943 
v®
 &ğ~
CMCI_THRESHOLD_MASK
;

944 
	`wrm¤l
(
m¤
, 
v®
 | 
CMCI_EN
 | 
CMCI_THRESHOLD
);

945 
	`rdm¤l
(
m¤
, 
v®
);

947 ià(!(
v®
 & 
CMCI_EN
)) {

949 
	`mÿbªks_£t
(
i
, 
	`__g‘_ıu_v¬
(
no_cmci_bªks
));

952 
	`mÿbªks_£t
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

953 
out
:

954 
	`mÿbªks_ş—r
(
i
, 
	`__g‘_ıu_v¬
(
no_cmci_bªks
));

956 
	}
}

958 
	$cmci_discov”
()

960 
æags
;

961 
i
;

962 
mù–em_cook›_t
 
mùc
;

963 
mÿ_summ¬y
 
bs
;

965 
	`mû_´štk
(
MCE_VERBOSE
, "CMCI: fšd owÃ¸Ú CPU%d\n", 
	`smp_´oûssÜ_id
());

967 
	`¥š_lock_œq§ve
(&
cmci_discov”_lock
, 
æags
);

969 
i
 = 0; i < 
Ä_mû_bªks
; i++)

970 ià(!
	`mÿbªks_‹¡
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
)))

971 
	`do_cmci_discov”
(
i
);

973 
	`¥š_uÆock_œq»¡Üe
(&
cmci_discov”_lock
, 
æags
);

981 
mùc
 = 
	`mcheck_mÿ_logout
(

982 
MCA_CMCI_HANDLER
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
), &
bs
, 
NULL
);

984 ià(
bs
.
”rút
 && 
mùc
 !ğ
NULL
) {

985 ià(
	`dom0_vmû_’abËd
()) {

986 
	`mù–em_comm™
(
mùc
);

987 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

989 
	`x86_mcšfo_dump
(
	`mù–em_d©­Œ
(
mùc
));

990 
	`mù–em_dismiss
(
mùc
);

992 } ià(
mùc
 !ğ
NULL
)

993 
	`mù–em_dismiss
(
mùc
);

995 
	`mû_´štk
(
MCE_VERBOSE
, "CMCI: CPU%d owner_map[%lx],‚o_cmci_map[%lx]\n",

996 
	`smp_´oûssÜ_id
(),

997 *((*)
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
)->
bªk_m­
),

998 *((*)
	`__g‘_ıu_v¬
(
no_cmci_bªks
)->
bªk_m­
));

999 
	}
}

1012 
	$mû_£t_owÃr
()

1014 ià(!
cmci_suµÜt
 || 
mû_di§bËd
 == 1)

1017 
	`cmci_discov”
();

1018 
	}
}

1020 
	$__ıu_mcheck_di¡ribu‹_cmci
(*
unu£d
)

1022 
	`cmci_discov”
();

1023 
	}
}

1025 
	$ıu_mcheck_di¡ribu‹_cmci
()

1027 ià(
cmci_suµÜt
 && !
mû_di§bËd
)

1028 
	`Ú_—ch_ıu
(
__ıu_mcheck_di¡ribu‹_cmci
, 
NULL
, 0);

1029 
	}
}

1031 
	$ş—r_cmci
()

1033 
i
;

1035 ià(!
cmci_suµÜt
 || 
mû_di§bËd
 == 1)

1038 
	`mû_´štk
(
MCE_VERBOSE
, "CMCI: clear_cmci support on CPU%d\n",

1039 
	`smp_´oûssÜ_id
());

1041 
i
 = 0; i < 
Ä_mû_bªks
; i++) {

1042 
m¤
 = 
MSR_IA32_MC0_CTL2
 + 
i
;

1043 
u64
 
v®
;

1044 ià(!
	`mÿbªks_‹¡
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
)))

1046 
	`rdm¤l
(
m¤
, 
v®
);

1047 ià(
v®
 & (
CMCI_EN
|
CMCI_THRESHOLD_MASK
))

1048 
	`wrm¤l
(
m¤
, 
v®
 & ~(
CMCI_EN
|
CMCI_THRESHOLD_MASK
));

1049 
	`mÿbªks_ş—r
(
i
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
));

1051 
	}
}

1053 
	$ıu_mcheck_di§bË
()

1055 
	`ş—r_š_ü4
(
X86_CR4_MCE
);

1057 ià(
cmci_suµÜt
 && !
mû_di§bËd
)

1058 
	`ş—r_cmci
();

1059 
	}
}

1061 
	$š‹l_š™_cmci
(
ıušfo_x86
 *
c
)

1063 
u32
 
l
, 
­ic
;

1064 
ıu
 = 
	`smp_´oûssÜ_id
();

1066 ià(!
	`mû_avaabË
(
c
è|| !
cmci_suµÜt
) {

1067 ià(
İt_ıu_šfo
)

1068 
	`mû_´štk
(
MCE_QUIET
, "CMCI: CPU%d ha nØCMCI suµÜt\n", 
ıu
);

1072 
­ic
 = 
	`­ic_»ad
(
APIC_CMCI
);

1073 iàĞ
­ic
 & 
APIC_VECTOR_MASK
 )

1075 
	`mû_´štk
(
MCE_QUIET
, "CPU%d CMCI LVT vector (%#x)‡lready installed\n",

1076 
ıu
, ( 
­ic
 & 
APIC_VECTOR_MASK
 ));

1080 
­ic
 = 
CMCI_APIC_VECTOR
;

1081 
­ic
 |ğ(
APIC_DM_FIXED
 | 
APIC_LVT_MASKED
);

1082 
	`­ic_wr™e_¬ound
(
APIC_CMCI
, 
­ic
);

1084 
l
 = 
	`­ic_»ad
(
APIC_CMCI
);

1085 
	`­ic_wr™e_¬ound
(
APIC_CMCI
, 
l
 & ~
APIC_LVT_MASKED
);

1087 
	`mû_£t_owÃr
();

1088 
	}
}

1090 
ç¡ÿÎ
 
	$smp_cmci_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

1092 
mù–em_cook›_t
 
mùc
;

1093 
mÿ_summ¬y
 
bs
;

1094 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

1096 
	`ack_APIC_œq
();

1097 
	`œq_’‹r
();

1099 
mùc
 = 
	`mcheck_mÿ_logout
(

1100 
MCA_CMCI_HANDLER
, 
	`__g‘_ıu_v¬
(
mû_bªks_owÃd
), &
bs
, 
NULL
);

1102 ià(
bs
.
”rút
 && 
mùc
 !ğ
NULL
) {

1103 ià(
	`dom0_vmû_’abËd
()) {

1104 
	`mù–em_comm™
(
mùc
);

1105 
	`mû_´štk
(
MCE_VERBOSE
, "CMCI: send CMCIo DOM0hrough virq\n");

1106 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

1108 
	`x86_mcšfo_dump
(
	`mù–em_d©­Œ
(
mùc
));

1109 
	`mù–em_dismiss
(
mùc
);

1111 } ià(
mùc
 !ğ
NULL
)

1112 
	`mù–em_dismiss
(
mùc
);

1114 
	`œq_ex™
();

1115 
	`£t_œq_»gs
(
Şd_»gs
);

1116 
	}
}

1120 
	$mû_is_brßdÿ¡
(
ıušfo_x86
 *
c
)

1122 ià(
mû_fÜû_brßdÿ¡
)

1129 ià(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 && c->
x86
 == 6 &&

1130 
c
->
x86_mod–
 >= 0xe)

1133 
	}
}

1136 
	$š‹l_š™_mÿ
(
ıušfo_x86
 *
c
)

1138 
boŞ_t
 
brßdÿ¡
, 
cmci
 = 0, 
£r
 = 0;

1139 
ext_num
 = 0, 
fœ¡
;

1140 
ušt64_t
 
m¤_cÚ‹Á
;

1142 
brßdÿ¡
 = 
	`mû_is_brßdÿ¡
(
c
);

1144 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
m¤_cÚ‹Á
);

1146 ià((
m¤_cÚ‹Á
 & 
MCG_CMCI_P
è&& 
ıu_has_­ic
)

1147 
cmci
 = 1;

1150 ià(
m¤_cÚ‹Á
 & 
MCG_SER_P
)

1151 
£r
 = 1;

1153 ià(
m¤_cÚ‹Á
 & 
MCG_EXT_P
)

1154 
ext_num
 = (
m¤_cÚ‹Á
 >> 
MCG_EXT_CNT
) & 0xff;

1156 
fœ¡
 = 
	`mû_fœ¡bªk
(
c
);

1158 ià(
	`smp_´oûssÜ_id
() == 0)

1160 
	`d´štk
(
XENLOG_INFO
, "MCA Capability: BCAST %x SER %x"

1162 
brßdÿ¡
, 
£r
, 
cmci
, 
fœ¡
, 
ext_num
);

1164 
mû_brßdÿ¡
 = 
brßdÿ¡
;

1165 
cmci_suµÜt
 = 
cmci
;

1166 
£r_suµÜt
 = 
£r
;

1167 
Ä_š‹l_ext_m¤s
 = 
ext_num
;

1168 
fœ¡bªk
 = 
fœ¡
;

1170 ià(
cmci
 !ğ
cmci_suµÜt
 || 
£r
 !ğ
£r_suµÜt
 ||

1171 
brßdÿ¡
 !ğ
mû_brßdÿ¡
 ||

1172 
fœ¡
 !ğ
fœ¡bªk
 || 
ext_num
 !ğ
Ä_š‹l_ext_m¤s
)

1174 
	`d´štk
(
XENLOG_WARNING
,

1177 
	`smp_´oûssÜ_id
(), 
brßdÿ¡
, 
£r
, 
cmci
, 
fœ¡
, 
ext_num
);

1179 
	}
}

1181 
	$š‹l_mû_po¡_»£t
()

1183 
mù–em_cook›_t
 
mùc
;

1184 
mÿ_summ¬y
 
bs
;

1186 
mùc
 = 
	`mcheck_mÿ_logout
(
MCA_RESET
, 
mÿ_®lbªks
, &
bs
, 
NULL
);

1189 ià(
bs
.
”rút
 && 
mùc
 !ğ
NULL
) {

1190 
	`x86_mcšfo_dump
(
	`mù–em_d©­Œ
(
mùc
));

1191 
	`mù–em_comm™
(
mùc
);

1194 
	}
}

1196 
	$š‹l_š™_mû
()

1198 
ušt64_t
 
m¤_cÚ‹Á
;

1199 
i
;

1201 
	`š‹l_mû_po¡_»£t
();

1204 
i
 = 
fœ¡bªk
; i < 
Ä_mû_bªks
; i++)

1208 
	`rdm¤l
(
	`MSR_IA32_MCx_CTL
(
i
), 
m¤_cÚ‹Á
);

1209 ià(!
m¤_cÚ‹Á
)

1212 
	`mû_´štk
(
MCE_VERBOSE
, "mû_š™: in™ bªk%d\n", 
i
);

1213 
	`wrm¤l
(
	`MSR_IA32_MCx_CTL
(
i
), 0xffffffffffffffffULL);

1214 
	`wrm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0x0ULL);

1217 ià(
fœ¡bªk
)

1218 
	`wrm¤l
(
MSR_IA32_MC0_STATUS
, 0x0ULL);

1220 
	`x86_mû_veùÜ_»gi¡”
(
š‹l_machše_check
);

1221 
	`mû_»cov”abË_»gi¡”
(
š‹l_»cov”abË_sÿn
);

1222 
	`mû_Ãed_ş—rbªk_»gi¡”
(
š‹l_Ãed_ş—rbªk_sÿn
);

1224 
mû_dhªdËrs
 = 
š‹l_mû_dhªdËrs
;

1225 
mû_dhªdËr_num
 = (
š‹l_mû_dhªdËrs
)/(
mÿ_”rÜ_hªdËr
);

1226 
mû_uhªdËrs
 = 
š‹l_mû_uhªdËrs
;

1227 
mû_uhªdËr_num
 = (
š‹l_mû_uhªdËrs
)/(
mÿ_”rÜ_hªdËr
);

1228 
	}
}

1230 
	$ıu_mÿbªk_ä“
(
ıu
)

1232 
mÿ_bªks
 *
mb1
, *
mb2
, *
mb3
;

1234 
mb1
 = 
	`³r_ıu
(
mû_ş—r_bªks
, 
ıu
);

1235 
mb2
 = 
	`³r_ıu
(
no_cmci_bªks
, 
ıu
);

1236 
mb3
 = 
	`³r_ıu
(
mû_bªks_owÃd
, 
ıu
);

1238 
	`mÿbªks_ä“
(
mb1
);

1239 
	`mÿbªks_ä“
(
mb2
);

1240 
	`mÿbªks_ä“
(
mb3
);

1241 
	}
}

1243 
	$ıu_mÿbªk_®loc
(
ıu
)

1245 
mÿ_bªks
 *
mb1
, *
mb2
, *
mb3
;

1247 
mb1
 = 
	`mÿbªks_®loc
();

1248 
mb2
 = 
	`mÿbªks_®loc
();

1249 
mb3
 = 
	`mÿbªks_®loc
();

1250 ià(!
mb1
 || !
mb2
 || !
mb3
)

1251 
out
;

1253 
	`³r_ıu
(
mû_ş—r_bªks
, 
ıu
èğ
mb1
;

1254 
	`³r_ıu
(
no_cmci_bªks
, 
ıu
èğ
mb2
;

1255 
	`³r_ıu
(
mû_bªks_owÃd
, 
ıu
èğ
mb3
;

1258 
out
:

1259 
	`mÿbªks_ä“
(
mb1
);

1260 
	`mÿbªks_ä“
(
mb2
);

1261 
	`mÿbªks_ä“
(
mb3
);

1262  -
ENOMEM
;

1263 
	}
}

1265 
	$ıu_ÿÎback
(

1266 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

1268 
ıu
 = ()
hıu
;

1269 
rc
 = 0;

1271  
aùiÚ
 )

1273 
CPU_UP_PREPARE
:

1274 
rc
 = 
	`ıu_mÿbªk_®loc
(
ıu
);

1276 
CPU_DYING
:

1277 
	`ıu_mcheck_di§bË
();

1279 
CPU_UP_CANCELED
:

1280 
CPU_DEAD
:

1281 
	`ıu_mcheck_di¡ribu‹_cmci
();

1282 
	`ıu_mÿbªk_ä“
(
ıu
);

1288  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

1289 
	}
}

1291 
nÙif›r_block
 
	gıu_nfb
 = {

1292 .
nÙif›r_ÿÎ
 = 
ıu_ÿÎback


1296 
mcheck_ty³
 
	$š‹l_mcheck_š™
(
ıušfo_x86
 *
c
, 
boŞ_t
 
b¥
)

1298 iàĞ
b¥
 )

1301 iàĞ
	`ıu_mÿbªk_®loc
(0) )

1302 
	`BUG
();

1303 
	`»gi¡”_ıu_nÙif›r
(&
ıu_nfb
);

1306 
	`š‹l_š™_mÿ
(
c
);

1308 
	`mû_hªdËr_š™
();

1310 
	`š‹l_š™_mû
();

1312 
	`š‹l_š™_cmci
(
c
);

1313 #ifdeà
CONFIG_X86_MCE_THERMAL


1314 
	`š‹l_š™_th”m®
(
c
);

1317  
mcheck_š‹l
;

1318 
	}
}

1321 
	$š‹l_mû_wrm¤
(
ušt32_t
 
m¤
, 
ušt64_t
 
v®
)

1323 
»t
 = 0;

1325 ià(
m¤
 >ğ
MSR_IA32_MC0_CTL2
 && m¤ < (MSR_IA32_MC0_CTL2 + 
Ä_mû_bªks
))

1327 
	`mû_´štk
(
MCE_QUIET
, "We have disabled CMCI capability, "

1329 
»t
 = 1;

1332  
»t
;

1333 
	}
}

1335 
	$š‹l_mû_rdm¤
(
ušt32_t
 
m¤
, 
ušt64_t
 *
v®
)

1337 
»t
 = 0;

1339 ià(
m¤
 >ğ
MSR_IA32_MC0_CTL2
 && m¤ < (MSR_IA32_MC0_CTL2 + 
Ä_mû_bªks
))

1341 
	`mû_´štk
(
MCE_QUIET
, "We have disabled CMCI capability, "

1343 
»t
 = 1;

1346  
»t
;

1347 
	}
}

	@cpu/mcheck/mce_quirks.h

19 #iâdeà
_MCE_QUIRK_H


20 
	#_MCE_QUIRK_H


	)

22 
	~<x’/ty³s.h
>

24 
	smû_quœkd©a
 {

25 
št32_t
 
	mıu_çmy
;

26 
št16_t
 
	mıu_mod–
;

27 
št16_t
 
	mıu_¡•pšg
;

28 
ušt32_t
 
	mquœk
;

35 
	emûquœk_amd_æags
 {

36 
	mMCEQUIRK_K7_BANK0
 = 0x1,

37 
	mMCEQUIRK_K8_GART
 = 0x2,

40 
	emûquœk_š‹l_æags
 {

41 
	mMCEQUIRK_DUMMY
 = 0x1,

44 
mûquœk_amd_æags


45 
mûquœk_lookup_amd_quœkd©a
(
ıušfo_x86
 *
c
);

47 
mûquœk_amd_­¶y
(
mûquœk_amd_æags
 
æags
);

49 
mûquœk_š‹l_æags


50 
mûquœk_lookup_š‹l_quœkd©a
(
ıušfo_x86
 *
c
);

52 
mûquœk_š‹l_­¶y
(
mûquœk_š‹l_æags
 
æags
);

	@cpu/mcheck/mctelem.c

15 
	~<x’/š™.h
>

16 
	~<x’/ty³s.h
>

17 
	~<x’/k”Ãl.h
>

18 
	~<x’/cÚfig.h
>

19 
	~<x’/smp.h
>

20 
	~<x’/”ºo.h
>

21 
	~<x’/sched.h
>

22 
	~<x’/sched-if.h
>

23 
	~<x’/ıumask.h
>

24 
	~<x’/ev’t.h
>

26 
	~<asm/´oûssÜ.h
>

27 
	~<asm/sy¡em.h
>

28 
	~<asm/m¤.h
>

30 
	~"mû.h
"

32 
	smù–em_’t
 {

33 
mù–em_’t
 *
	mmùe_Ãxt
;

34 
mù–em_’t
 *
	mmùe_´ev
;

35 
ušt32_t
 
	mmùe_æags
;

36 
ušt32_t
 
	mmùe_»fút
;

37 *
	mmùe_d©a
;

40 
	#MCTE_F_HOME_URGENT
 0x0001U

	)

41 
	#MCTE_F_HOME_NONURGENT
 0x0002U

	)

42 
	#MCTE_F_CLASS_URGENT
 0x0004U

	)

43 
	#MCTE_F_CLASS_NONURGENT
 0x0008U

	)

44 
	#MCTE_F_STATE_FREE
 0x0010U

	)

45 
	#MCTE_F_STATE_UNCOMMITTED
 0x0020U

	)

46 
	#MCTE_F_STATE_COMMITTED
 0x0040U

	)

47 
	#MCTE_F_STATE_PROCESSING
 0x0080U

	)

49 
	#MCTE_F_MASK_HOME
 (
MCTE_F_HOME_URGENT
 | 
MCTE_F_HOME_NONURGENT
)

	)

50 
	#MCTE_F_MASK_CLASS
 (
MCTE_F_CLASS_URGENT
 | 
MCTE_F_CLASS_NONURGENT
)

	)

51 
	#MCTE_F_MASK_STATE
 (
MCTE_F_STATE_FREE
 | \

52 
MCTE_F_STATE_UNCOMMITTED
 | \

53 
MCTE_F_STATE_COMMITTED
 | \

54 
MCTE_F_STATE_PROCESSING
)

	)

56 
	#MCTE_HOME
(
‹p
è(Ñ•)->
mùe_æags
 & 
MCTE_F_MASK_HOME
)

	)

58 
	#MCTE_CLASS
(
‹p
è(Ñ•)->
mùe_æags
 & 
MCTE_F_MASK_CLASS
)

	)

59 
	#MCTE_SET_CLASS
(
‹p
, 
Ãw
) do { \

60 (
‹p
)->
mùe_æags
 &ğ~
MCTE_F_MASK_CLASS
; \

61 (
‹p
)->
mùe_æags
 |ğ
MCTE_F_CLASS_
##
Ãw
; } 0)

	)

63 
	#MCTE_STATE
(
‹p
è(Ñ•)->
mùe_æags
 & 
MCTE_F_MASK_STATE
)

	)

64 
	#MCTE_TRANSITION_STATE
(
‹p
, 
Şd
, 
Ãw
) do { \

65 
	`BUG_ON
(
	`MCTE_STATE
(
‹p
è!ğ(
MCTE_F_STATE_
##
Şd
)); \

66 (
‹p
)->
mùe_æags
 &ğ~
MCTE_F_MASK_STATE
; \

67 (
‹p
)->
mùe_æags
 |ğ(
MCTE_F_STATE_
##
Ãw
); } 0)

	)

69 
	#MC_URGENT_NENT
 10

	)

70 
	#MC_NONURGENT_NENT
 20

	)

72 
	#MC_NCLASSES
 (
MC_NONURGENT
 + 1)

	)

74 
	#COOKIE2MCTE
(
c
è((
mù–em_’t
 *)(c))

	)

75 
	#MCTE2COOKIE
(
‹p
è((
mù–em_cook›_t
)Ñ•))

	)

77 
	smc_‹Ëm_ùl
 {

104 
mù–em_’t
 *
	mmùc_ä“
[
MC_NCLASSES
];

105 
mù–em_’t
 *
	mmùc_comm™‹d
[
MC_NCLASSES
];

106 
mù–em_’t
 *
	mmùc_´oûssšg_h—d
[
MC_NCLASSES
];

107 
mù–em_’t
 *
	mmùc_´oûssšg_
[
MC_NCLASSES
];

111 
mù–em_’t
 *
	mmùc_–ems
;

112 } 
	gmùùl
;

114 
	smc_‹Ëm_ıu_ùl
 {

121 
mù–em_’t
 *
	m³ndšg
;

122 
mù–em_’t
 *
	m´oûssšg
;

124 
DEFINE_PER_CPU
(
mc_‹Ëm_ıu_ùl
, 
mùùl
);

127 
DEFINE_SPINLOCK
(
´oûssšg_lock
);

129 
	$mù–em_xchg_h—d
(
mù–em_’t
 **
h—dp
,

130 
mù–em_’t
 **
Şd
,

131 
mù–em_’t
 *
Ãw
)

134 *
Şd
 = *
h—dp
;

135 
	`wmb
();

136 ià(
	`cmpxchg±r
(
h—dp
, *
Şd
, 
Ãw
) == *old)

139 
	}
}

142 
	$mù–em_deãr
(
mù–em_cook›_t
 
cook›
)

144 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

146 
	`mù–em_xchg_h—d
(&
	`this_ıu
(
mùùl
.
³ndšg
), &
‹p
->
mùe_Ãxt
,ep);

147 
	}
}

149 
mù–em_´oûss_deã¼ed
(
ıu
,

150 (*
â
)(
mù–em_cook›_t
))

152 
mù–em_’t
 *
‹p
;

153 
mù–em_’t
 *
h—d
, *
´ev
;

154 
»t
;

160 
	`mù–em_xchg_h—d
(&
	`³r_ıu
(
mùùl
.
³ndšg
, 
ıu
),

161 &
	`this_ıu
(
mùùl
.
´oûssšg
), 
NULL
);

163 
h—d
 = 
	`this_ıu
(
mùùl
.
´oûssšg
);

171 
‹p
 = 
h—d
, 
´ev
 = 
NULL
;• !ğNULL;• =•->
mùe_Ãxt
) {

172 
‹p
->
mùe_´ev
 = 
´ev
;

173 
´ev
 = 
‹p
;

182 
‹p
 = 
´ev
;• !ğ
NULL
;ep =…rev) {

183 
´ev
 = 
‹p
->
mùe_´ev
;

184 
‹p
->
mùe_Ãxt
 =•->
mùe_´ev
 = 
NULL
;

186 
»t
 = 
	`â
(
	`MCTE2COOKIE
(
‹p
));

187 ià(
´ev
 !ğ
NULL
)

188 
´ev
->
mùe_Ãxt
 = 
NULL
;

189 
‹p
->
mùe_´ev
 =•->
mùe_Ãxt
 = 
NULL
;

190 ià(
»t
 != 0)

191 
	`mù–em_comm™
(
	`MCTE2COOKIE
(
‹p
));

193 
	`mù–em_dismiss
(
	`MCTE2COOKIE
(
‹p
));

195 
	}
}

197 
	$mù–em_has_deã¼ed
(
ıu
)

199 ià(
	`³r_ıu
(
mùùl
.
³ndšg
, 
ıu
è!ğ
NULL
)

202 
	}
}

207 
	$mù–em_ä“
(
mù–em_’t
 *
‹p
)

209 
mù–em_şass_t
 
rg‘
 = 
	`MCTE_HOME
(
‹p
è=ğ
MCTE_F_HOME_URGENT
 ?

210 
MC_URGENT
 : 
MC_NONURGENT
;

212 
	`BUG_ON
(
‹p
->
mùe_»fút
 != 0);

213 
	`BUG_ON
(
	`MCTE_STATE
(
‹p
è!ğ
MCTE_F_STATE_FREE
);

215 
‹p
->
mùe_´ev
 = 
NULL
;

216 
	`mù–em_xchg_h—d
(&
mùùl
.
mùc_ä“
[
rg‘
], &
‹p
->
mùe_Ãxt
,ep);

217 
	}
}

222 
	$mù–em_hŞd
(
mù–em_’t
 *
‹p
)

224 
‹p
->
mùe_»fút
++;

225 
	}
}

230 
	$mù–em_´oûssšg_hŞd
(
mù–em_’t
 *
‹p
)

232 
which
 = 
	`MCTE_CLASS
(
‹p
è=ğ
MCTE_F_CLASS_URGENT
 ?

233 
MC_URGENT
 : 
MC_NONURGENT
;

235 
	`BUG_ON
(
‹p
 !ğ
mùùl
.
mùc_´oûssšg_h—d
[
which
]);

236 
‹p
->
mùe_»fút
++;

237 
	}
}

242 
	$mù–em_´oûssšg_»Ëa£
(
mù–em_’t
 *
‹p
)

244 
which
 = 
	`MCTE_CLASS
(
‹p
è=ğ
MCTE_F_CLASS_URGENT
 ?

245 
MC_URGENT
 : 
MC_NONURGENT
;

247 
	`BUG_ON
(
‹p
 !ğ
mùùl
.
mùc_´oûssšg_h—d
[
which
]);

248 ià(--
‹p
->
mùe_»fút
 == 0) {

249 
	`MCTE_TRANSITION_STATE
(
‹p
, 
PROCESSING
, 
FREE
);

250 
mùùl
.
mùc_´oûssšg_h—d
[
which
] = 
‹p
->
mùe_Ãxt
;

251 
	`mù–em_ä“
(
‹p
);

253 
	}
}

255 
	$mù–em_š™
(
»qd©asz
)

257 
ÿÎed
 = 0;

258 
d©asz
 = 0, 
»®d©asz
 = 0;

259 *
d©¬r
;

260 
i
;

262 
	`BUG_ON
(
MC_URGENT
 !ğ0 || 
MC_NONURGENT
 !ğ1 || 
MC_NCLASSES
 != 2);

267 ià(++
ÿÎed
 == 1) {

268 
»®d©asz
 = 
»qd©asz
;

269 
d©asz
 = (
»qd©asz
 & ~0xf) + 0x10;

271 
	`BUG_ON
(
»qd©asz
 !ğ
»®d©asz
);

275 ià((
mùùl
.
mùc_–ems
 = 
	`xm®loc_¬¿y
(
mù–em_’t
,

276 
MC_URGENT_NENT
 + 
MC_NONURGENT_NENT
)è=ğ
NULL
 ||

277 (
d©¬r
 = 
	`xm®loc_by‹s
((
MC_URGENT_NENT
 + 
MC_NONURGENT_NENT
) *

278 
d©asz
)è=ğ
NULL
) {

279 ià(
mùùl
.
mùc_–ems
)

280 
	`xä“
(
mùùl
.
mùc_–ems
);

281 
	`´štk
("Allocations for MCAelemetry failed\n");

285 
i
 = 0; i < 
MC_URGENT_NENT
 + 
MC_NONURGENT_NENT
; i++) {

286 
mù–em_’t
 *
‹p
, **
‹µ
;

288 
‹p
 = 
mùùl
.
mùc_–ems
 + 
i
;

289 
‹p
->
mùe_æags
 = 
MCTE_F_STATE_FREE
;

290 
‹p
->
mùe_»fút
 = 0;

291 
‹p
->
mùe_d©a
 = 
d©¬r
 + 
i
 * 
d©asz
;

293 ià(
i
 < 
MC_URGENT_NENT
) {

294 
‹µ
 = &
mùùl
.
mùc_ä“
[
MC_URGENT
];

295 
‹p
->
mùe_æags
 |ğ
MCTE_F_HOME_URGENT
;

297 
‹µ
 = &
mùùl
.
mùc_ä“
[
MC_NONURGENT
];

298 
‹p
->
mùe_æags
 |ğ
MCTE_F_HOME_NONURGENT
;

301 
‹p
->
mùe_Ãxt
 = *
‹µ
;

302 
‹p
->
mùe_´ev
 = 
NULL
;

303 *
‹µ
 = 
‹p
;

305 
	}
}

308 
	gmù–em_drİ_couÁ
;

314 
mù–em_cook›_t
 
	$mù–em_»£rve
(
mù–em_şass_t
 
which
)

316 
mù–em_’t
 **
ä“Í
;

317 
mù–em_’t
 *
Şdh—d
, *
Ãwh—d
;

318 
mù–em_şass_t
 
rg‘
 = (
which
 =ğ
MC_URGENT
) ?

319 
MC_URGENT
 : 
MC_NONURGENT
;

321 
ä“Í
 = &
mùùl
.
mùc_ä“
[
rg‘
];

323 ià((
Şdh—d
 = *
ä“Í
è=ğ
NULL
) {

324 ià(
which
 =ğ
MC_URGENT
 && 
rg‘
 == MC_URGENT) {

326 
rg‘
 = 
MC_NONURGENT
;

327 
ä“Í
 = &
mùùl
.
mùc_ä“
[
rg‘
];

330 
mù–em_drİ_couÁ
++;

331  (
NULL
);

335 
Ãwh—d
 = 
Şdh—d
->
mùe_Ãxt
;

336 ià(
	`cmpxchg±r
(
ä“Í
, 
Şdh—d
, 
Ãwh—d
) == oldhead) {

337 
mù–em_’t
 *
‹p
 = 
Şdh—d
;

339 
	`mù–em_hŞd
(
‹p
);

340 
	`MCTE_TRANSITION_STATE
(
‹p
, 
FREE
, 
UNCOMMITTED
);

341 
‹p
->
mùe_Ãxt
 = 
NULL
;

342 
‹p
->
mùe_´ev
 = 
NULL
;

343 ià(
which
 =ğ
MC_URGENT
)

344 
	`MCTE_SET_CLASS
(
‹p
, 
URGENT
);

346 
	`MCTE_SET_CLASS
(
‹p
, 
NONURGENT
);

347  
	`MCTE2COOKIE
(
‹p
);

350 
	}
}

352 *
	$mù–em_d©­Œ
(
mù–em_cook›_t
 
cook›
)

354 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

356  
‹p
->
mùe_d©a
;

357 
	}
}

363 
	$mù–em_dismiss
(
mù–em_cook›_t
 
cook›
)

365 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

367 
‹p
->
mùe_»fút
--;

368 
	`MCTE_TRANSITION_STATE
(
‹p
, 
UNCOMMITTED
, 
FREE
);

369 
	`mù–em_ä“
(
‹p
);

370 
	}
}

377 
	$mù–em_comm™
(
mù–em_cook›_t
 
cook›
)

379 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

380 
mù–em_şass_t
 
rg‘
 = 
	`MCTE_CLASS
(
‹p
è=ğ
MCTE_F_CLASS_URGENT
 ?

381 
MC_URGENT
 : 
MC_NONURGENT
;

383 
	`BUG_ON
(
‹p
->
mùe_Ãxt
 !ğ
NULL
 ||•->
mùe_´ev
 != NULL);

384 
	`MCTE_TRANSITION_STATE
(
‹p
, 
UNCOMMITTED
, 
COMMITTED
);

386 
	`mù–em_xchg_h—d
(&
mùùl
.
mùc_comm™‹d
[
rg‘
], &
‹p
->
mùe_´ev
,ep);

387 
	}
}

402 
mù–em_’t
 *
	gdªglšg
[
MC_NCLASSES
];

404 
	$mù–em_­³nd_´oûssšg
(
mù–em_şass_t
 
which
)

406 
mù–em_şass_t
 
rg‘
 = 
which
 =ğ
MC_URGENT
 ?

407 
MC_URGENT
 : 
MC_NONURGENT
;

408 
mù–em_’t
 **
commÍ
 = &
mùùl
.
mùc_comm™‹d
[
rg‘
];

409 
mù–em_’t
 **
´oşhp
 = &
mùùl
.
mùc_´oûssšg_h—d
[
rg‘
];

410 
mù–em_’t
 **
´oş
 = &
mùùl
.
mùc_´oûssšg_
[
rg‘
];

411 
mù–em_’t
 *
‹p
, *
É•
;

414 ià(*
commÍ
 =ğ
NULL
)

421 
	`mù–em_xchg_h—d
(
commÍ
, &
dªglšg
[
rg‘
], 
NULL
);

423 ià(
dªglšg
[
rg‘
] =ğ
NULL
)

429 
‹p
 = 
dªglšg
[
rg‘
], 
É•
 = 
NULL
;ep != NULL;

430 
‹p
 =•->
mùe_´ev
) {

431 
	`MCTE_TRANSITION_STATE
(
‹p
, 
COMMITTED
, 
PROCESSING
);

432 
‹p
->
mùe_Ãxt
 = 
É•
;

433 
É•
 = 
‹p
;

441 ià(*
´oşhp
 =ğ
NULL
) {

442 *
´oşhp
 = 
É•
;

443 *
´oş
 = 
dªglšg
[
rg‘
];

445 (*
´oş
)->
mùe_Ãxt
 = 
É•
;

446 
É•
->
mùe_´ev
 = *
´oş
;

447 *
´oş
 = 
dªglšg
[
rg‘
];

449 
	`wmb
();

450 
dªglšg
[
rg‘
] = 
NULL
;

451 
	`wmb
();

452 
	}
}

454 
mù–em_cook›_t
 
	$mù–em_cÚsume_Şde¡_begš
(
mù–em_şass_t
 
which
)

456 
mù–em_şass_t
 
rg‘
 = (
which
 =ğ
MC_URGENT
) ?

457 
MC_URGENT
 : 
MC_NONURGENT
;

458 
mù–em_’t
 *
‹p
;

460 
	`¥š_lock
(&
´oûssšg_lock
);

461 
	`mù–em_­³nd_´oûssšg
(
rg‘
);

462 ià((
‹p
 = 
mùùl
.
mùc_´oûssšg_h—d
[
rg‘
]è=ğ
NULL
) {

463 
	`¥š_uÆock
(&
´oûssšg_lock
);

464  
NULL
;

467 
	`mù–em_´oûssšg_hŞd
(
‹p
);

468 
	`wmb
();

469 
	`¥š_uÆock
(&
´oûssšg_lock
);

470  
	`MCTE2COOKIE
(
‹p
);

471 
	}
}

473 
	$mù–em_cÚsume_Şde¡_’d
(
mù–em_cook›_t
 
cook›
)

475 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

477 
	`¥š_lock
(&
´oûssšg_lock
);

478 
	`mù–em_´oûssšg_»Ëa£
(
‹p
);

479 
	`wmb
();

480 
	`¥š_uÆock
(&
´oûssšg_lock
);

481 
	}
}

483 
	$mù–em_ack
(
mù–em_şass_t
 
which
, 
mù–em_cook›_t
 
cook›
)

485 
mù–em_şass_t
 
rg‘
 = (
which
 =ğ
MC_URGENT
) ?

486 
MC_URGENT
 : 
MC_NONURGENT
;

487 
mù–em_’t
 *
‹p
 = 
	`COOKIE2MCTE
(
cook›
);

489 ià(
‹p
 =ğ
NULL
)

492 
	`¥š_lock
(&
´oûssšg_lock
);

493 ià(
‹p
 =ğ
mùùl
.
mùc_´oûssšg_h—d
[
rg‘
])

494 
	`mù–em_´oûssšg_»Ëa£
(
‹p
);

495 
	`wmb
();

496 
	`¥š_uÆock
(&
´oûssšg_lock
);

497 
	}
}

	@cpu/mcheck/mctelem.h

11 #iâdeà
_MCTELEM_H


13 
	#_MCTELEM_H


	)

15 
	~<x’/š™.h
>

16 
	~<x’/smp.h
>

17 
	~<asm/Œ­s.h
>

55 
mù–em_cook›
 *
	tmù–em_cook›_t
;

57 
	emù–em_şass
 {

58 
	mMC_URGENT
,

59 
	mMC_NONURGENT


60 } 
	tmù–em_şass_t
;

62 
mù–em_š™
();

63 
mù–em_cook›_t
 
mù–em_»£rve
(
mù–em_şass_t
);

64 *
mù–em_d©­Œ
(
mù–em_cook›_t
);

65 
mù–em_comm™
(
mù–em_cook›_t
);

66 
mù–em_dismiss
(
mù–em_cook›_t
);

67 
mù–em_cook›_t
 
mù–em_cÚsume_Şde¡_begš
(
mù–em_şass_t
);

68 
mù–em_cÚsume_Şde¡_’d
(
mù–em_cook›_t
);

69 
mù–em_ack
(
mù–em_şass_t
, 
mù–em_cook›_t
);

70 
mù–em_deãr
(
mù–em_cook›_t
);

71 
mù–em_´oûss_deã¼ed
(,

72 (*)(
mù–em_cook›_t
));

73 
	`mù–em_has_deã¼ed
();

	@cpu/mcheck/non-fatal.c

10 
	~<x’/cÚfig.h
>

11 
	~<x’/š™.h
>

12 
	~<x’/ty³s.h
>

13 
	~<x’/k”Ãl.h
>

14 
	~<x’/smp.h
>

15 
	~<x’/tim”.h
>

16 
	~<x’/”ºo.h
>

17 
	~<x’/ev’t.h
>

18 
	~<x’/sched.h
>

19 
	~<asm/´oûssÜ.h
>

20 
	~<asm/sy¡em.h
>

21 
	~<asm/m¤.h
>

23 
	~"mû.h
"

25 
DEFINE_PER_CPU
(
mÿ_bªks
 *, 
pŞl_bªkmask
);

26 
tim”
 
	gmû_tim”
;

28 
	#MCE_PERIOD
 
	`MILLISECS
(8000)

	)

29 
	#MCE_PERIOD_MIN
 
	`MILLISECS
(2000)

	)

30 
	#MCE_PERIOD_MAX
 
	`MILLISECS
(16000)

	)

32 
ušt64_t
 
	g³riod
 = 
MCE_PERIOD
;

33 
	gadju¡
 = 0;

34 
	gv¬ŸbË_³riod
 = 1;

36 
	$mû_check»gs
 (*
šfo
)

38 
mù–em_cook›_t
 
mùc
;

39 
mÿ_summ¬y
 
bs
;

40 
ušt64_t
 
dumpcouÁ
 = 0;

42 
mùc
 = 
	`mcheck_mÿ_logout
(
MCA_POLLER
, 
	`__g‘_ıu_v¬
(
pŞl_bªkmask
), &
bs
, 
NULL
);

44 ià(
bs
.
”rút
 && 
mùc
 !ğ
NULL
) {

45 
adju¡
++;

56 ià(
	`dom0_vmû_’abËd
()) {

57 
	`mù–em_comm™
(
mùc
);

58 
	`£nd_gue¡_glob®_vœq
(
dom0
, 
VIRQ_MCA
);

59 } ià(++
dumpcouÁ
 >= 10) {

60 
	`x86_mcšfo_dump
((
mc_šfo
 *)
	`mù–em_d©­Œ
(
mùc
));

61 
	`mù–em_dismiss
(
mùc
);

63 
	`mù–em_dismiss
(
mùc
);

65 } ià(
mùc
 !ğ
NULL
) {

66 
	`mù–em_dismiss
(
mùc
);

68 
	}
}

70 
	$mû_wÜk_â
(*
d©a
)

72 
	`Ú_—ch_ıu
(
mû_check»gs
, 
NULL
, 1);

74 ià(
v¬ŸbË_³riod
) {

75 ià(
adju¡
)

76 
³riod
 /ğ(
adju¡
 + 1);

78 
³riod
 *= 2;

79 ià(
³riod
 > 
MCE_PERIOD_MAX
)

80 
³riod
 = 
MCE_PERIOD_MAX
;

81 ià(
³riod
 < 
MCE_PERIOD_MIN
)

82 
³riod
 = 
MCE_PERIOD_MIN
;

85 
	`£t_tim”
(&
mû_tim”
, 
	`NOW
(è+ 
³riod
);

86 
adju¡
 = 0;

87 
	}
}

89 
__š™
 
	$š™_nÚçl_mû_check”
()

91 
ıušfo_x86
 *
c
 = &
boÙ_ıu_d©a
;

94 ià(
mû_di§bËd
 || !
	`mû_avaabË
(
c
))

95  -
ENODEV
;

97 iàĞ
	`__g‘_ıu_v¬
(
pŞl_bªkmask
è=ğ
NULL
 )

98  -
EINVAL
;

103 
c
->
x86_v’dÜ
) {

104 
X86_VENDOR_AMD
:

105 ià(
c
->
x86
 == 6) {

106 
	`š™_tim”
(&
mû_tim”
, 
mû_wÜk_â
, 
NULL
, 0);

107 
	`£t_tim”
(&
mû_tim”
, 
	`NOW
(è+ 
MCE_PERIOD
);

112 
	`amd_nÚçl_mcheck_š™
(
c
);

115 
X86_VENDOR_INTEL
:

120 iàĞ
c
->
x86
 != 5 )

122 
	`š™_tim”
(&
mû_tim”
, 
mû_wÜk_â
, 
NULL
, 0);

123 
	`£t_tim”
(&
mû_tim”
, 
	`NOW
(è+ 
MCE_PERIOD
);

128 
	`´štk
(
KERN_INFO
 "mcheck_poll: Machine check…ollingimer started.\n");

130 
	}
}

131 
__š™ÿÎ
(
š™_nÚçl_mû_check”
);

	@cpu/mcheck/vmce.c

5 
	~<x’/š™.h
>

6 
	~<x’/ty³s.h
>

7 
	~<x’/œq.h
>

8 
	~<x’/ev’t.h
>

9 
	~<x’/k”Ãl.h
>

10 
	~<x’/d–ay.h
>

11 
	~<x’/smp.h
>

12 
	~<x’/mm.h
>

13 
	~<asm/´oûssÜ.h
>

14 
	~<public/sysùl.h
>

15 
	~<asm/sy¡em.h
>

16 
	~<asm/m¤.h
>

17 
	~<asm/p2m.h
>

18 
	~"mû.h
"

19 
	~"x86_mÿ.h
"

21 
	#dom_vmû
(
x
è((x)->
¬ch
.
vmÿ_m¤s
)

	)

23 
ušt64_t
 
	gg_mcg_ÿp
;

26 
ušt64_t
 
	gh_mcg_ùl
 = 0UL;

27 
ušt64_t
 *
	gh_mci_ù¾
;

29 
	$vmû_š™_m¤
(
domaš
 *
d
)

31 
	`dom_vmû
(
d
èğ
	`xm®loc
(
domaš_mÿ_m¤s
);

32 iàĞ!
	`dom_vmû
(
d
) )

33  -
ENOMEM
;

35 
	`dom_vmû
(
d
)->
mci_ùl
 = 
	`xm®loc_¬¿y
(
ušt64_t
, 
Ä_mû_bªks
);

36 iàĞ!
	`dom_vmû
(
d
)->
mci_ùl
 )

38 
	`xä“
(
	`dom_vmû
(
d
));

39  -
ENOMEM
;

41 
	`mem£t
(
	`dom_vmû
(
d
)->
mci_ùl
, ~0,

42 (
	`dom_vmû
(
d
)->
mci_ùl
));

44 
	`dom_vmû
(
d
)->
mcg_¡©us
 = 0x0;

45 
	`dom_vmû
(
d
)->
mcg_ÿp
 = 
g_mcg_ÿp
;

46 
	`dom_vmû
(
d
)->
mcg_ùl
 = ~(
ušt64_t
)0x0;

47 
	`dom_vmû
(
d
)->
Ä_šjeùiÚ
 = 0;

49 
	`INIT_LIST_HEAD
(&
	`dom_vmû
(
d
)->
im·ù_h—d”
);

50 
	`¥š_lock_š™
(&
	`dom_vmû
(
d
)->
lock
);

53 
	}
}

55 
	$vmû_de¡roy_m¤
(
domaš
 *
d
)

57 iàĞ!
	`dom_vmû
(
d
) )

59 
	`xä“
(
	`dom_vmû
(
d
)->
mci_ùl
);

60 
	`xä“
(
	`dom_vmû
(
d
));

61 
	`dom_vmû
(
d
èğ
NULL
;

62 
	}
}

64 
	$bªk_mû_rdm¤
(
domaš
 *
d
, 
ušt32_t
 
m¤
, 
ušt64_t
 *
v®
)

66 
bªk
, 
»t
 = 1;

67 
domaš_mÿ_m¤s
 *
vmû
 = 
	`dom_vmû
(
d
);

68 
bªk_’Œy
 *
’Œy
;

70 
bªk
 = (
m¤
 - 
MSR_IA32_MC0_CTL
) / 4;

71 iàĞ
bªk
 >ğ
Ä_mû_bªks
 )

74  
m¤
 & (
MSR_IA32_MC0_CTL
 | 3) )

76 
MSR_IA32_MC0_CTL
:

77 *
v®
 = 
vmû
->
mci_ùl
[
bªk
] &

78 (
h_mci_ù¾
 ? h_mci_ù¾[
bªk
] : ~0UL);

79 
	`mû_´štk
(
MCE_VERBOSE
, "MCE:„dm¤ MC%u_CTL 0x%"
PRIx64
"\n",

80 
bªk
, *
v®
);

82 
MSR_IA32_MC0_STATUS
:

84 iàĞ!
	`li¡_em±y
(&
vmû
->
im·ù_h—d”
) )

86 
’Œy
 = 
	`li¡_’Œy
(
vmû
->
im·ù_h—d”
.
Ãxt
,

87 
bªk_’Œy
, 
li¡
);

88 iàĞ
’Œy
->
bªk
 == bank )

90 *
v®
 = 
’Œy
->
mci_¡©us
;

91 
	`mû_´štk
(
MCE_VERBOSE
,

93 "v®u0x%"
PRIx64
"\n", 
bªk
, *
v®
);

97 
MSR_IA32_MC0_ADDR
:

98 iàĞ!
	`li¡_em±y
(&
vmû
->
im·ù_h—d”
) )

100 
’Œy
 = 
	`li¡_’Œy
(
vmû
->
im·ù_h—d”
.
Ãxt
,

101 
bªk_’Œy
, 
li¡
);

102 iàĞ
’Œy
->
bªk
 == bank )

104 *
v®
 = 
’Œy
->
mci_addr
;

105 
	`mû_´štk
(
MCE_VERBOSE
,

107 "0x%"
PRIx64
"\n", 
bªk
, *
v®
);

111 
MSR_IA32_MC0_MISC
:

112 iàĞ!
	`li¡_em±y
(&
vmû
->
im·ù_h—d”
) )

114 
’Œy
 = 
	`li¡_’Œy
(
vmû
->
im·ù_h—d”
.
Ãxt
,

115 
bªk_’Œy
, 
li¡
);

116 iàĞ
’Œy
->
bªk
 == bank )

118 *
v®
 = 
’Œy
->
mci_misc
;

119 
	`mû_´štk
(
MCE_VERBOSE
,

121 "0x%"
PRIx64
"\n", 
bªk
, *
v®
);

126  
boÙ_ıu_d©a
.
x86_v’dÜ
 )

128 
X86_VENDOR_INTEL
:

129 
»t
 = 
	`š‹l_mû_rdm¤
(
m¤
, 
v®
);

132 
»t
 = 0;

138  
»t
;

139 
	}
}

146 
	$vmû_rdm¤
(
ušt32_t
 
m¤
, 
ušt64_t
 *
v®
)

148 
domaš
 *
d
 = 
cu¼’t
->domain;

149 
domaš_mÿ_m¤s
 *
vmû
 = 
	`dom_vmû
(
d
);

150 
»t
 = 1;

152 *
v®
 = 0;

154 
	`¥š_lock
(&
	`dom_vmû
(
d
)->
lock
);

156  
m¤
 )

158 
MSR_IA32_MCG_STATUS
:

159 *
v®
 = 
vmû
->
mcg_¡©us
;

160 ià(*
v®
)

161 
	`mû_´štk
(
MCE_VERBOSE
,

162 "MCE:„dm¤ MCG_STATUS 0x%"
PRIx64
"\n", *
v®
);

164 
MSR_IA32_MCG_CAP
:

165 *
v®
 = 
vmû
->
mcg_ÿp
;

166 
	`mû_´štk
(
MCE_VERBOSE
, "MCE:„dm¤ MCG_CAP 0x%"
PRIx64
"\n",

167 *
v®
);

169 
MSR_IA32_MCG_CTL
:

171 *
v®
 = 
vmû
->
mcg_ùl
 & 
h_mcg_ùl
;

172 
	`mû_´štk
(
MCE_VERBOSE
, "MCE:„dm¤ MCG_CTL 0x%"
PRIx64
"\n",

173 *
v®
);

176 
»t
 = 
	`mû_bªk_m¤
(
m¤
è? 
	`bªk_mû_rdm¤
(
d
, m¤, 
v®
) : 0;

180 
	`¥š_uÆock
(&
	`dom_vmû
(
d
)->
lock
);

181  
»t
;

182 
	}
}

184 
	$bªk_mû_wrm¤
(
domaš
 *
d
, 
u32
 
m¤
, 
u64
 
v®
)

186 
bªk
, 
»t
 = 1;

187 
domaš_mÿ_m¤s
 *
vmû
 = 
	`dom_vmû
(
d
);

188 
bªk_’Œy
 *
’Œy
 = 
NULL
;

190 
bªk
 = (
m¤
 - 
MSR_IA32_MC0_CTL
) / 4;

191 iàĞ
bªk
 >ğ
Ä_mû_bªks
 )

192  -
EINVAL
;

194  
m¤
 & (
MSR_IA32_MC0_CTL
 | 3) )

196 
MSR_IA32_MC0_CTL
:

197 
vmû
->
mci_ùl
[
bªk
] = 
v®
;

199 
MSR_IA32_MC0_STATUS
:

205 iàĞ!
	`li¡_em±y
(&
	`dom_vmû
(
d
)->
im·ù_h—d”
) )

207 
’Œy
 = 
	`li¡_’Œy
(
	`dom_vmû
(
d
)->
im·ù_h—d”
.
Ãxt
,

208 
bªk_’Œy
, 
li¡
);

209 iàĞ
’Œy
->
bªk
 == bank )

210 
’Œy
->
mci_¡©us
 = 
v®
;

211 
	`mû_´štk
(
MCE_VERBOSE
,

212 "MCE: w¸MC%u_STATUS %"
PRIx64
" in vMCE#\n",

213 
bªk
, 
v®
);

216 
	`mû_´štk
(
MCE_VERBOSE
,

217 "MCE: w¸MC%u_STATUS %"
PRIx64
"\n", 
bªk
, 
v®
);

219 
MSR_IA32_MC0_ADDR
:

220 
	`mû_´štk
(
MCE_QUIET
, "MCE: MC%u_ADDR i »ad-Úly\n", 
bªk
);

221 
»t
 = -1;

223 
MSR_IA32_MC0_MISC
:

224 
	`mû_´štk
(
MCE_QUIET
, "MCE: MC%u_MISC i »ad-Úly\n", 
bªk
);

225 
»t
 = -1;

228  
boÙ_ıu_d©a
.
x86_v’dÜ
 )

230 
X86_VENDOR_INTEL
:

231 
»t
 = 
	`š‹l_mû_wrm¤
(
m¤
, 
v®
);

234 
»t
 = 0;

240  
»t
;

241 
	}
}

248 
	$vmû_wrm¤
(
u32
 
m¤
, 
u64
 
v®
)

250 
domaš
 *
d
 = 
cu¼’t
->domain;

251 
bªk_’Œy
 *
’Œy
 = 
NULL
;

252 
domaš_mÿ_m¤s
 *
vmû
 = 
	`dom_vmû
(
d
);

253 
»t
 = 1;

255 iàĞ!
g_mcg_ÿp
 )

258 
	`¥š_lock
(&
vmû
->
lock
);

260  
m¤
 )

262 
MSR_IA32_MCG_CTL
:

263 
vmû
->
mcg_ùl
 = 
v®
;

265 
MSR_IA32_MCG_STATUS
:

266 
vmû
->
mcg_¡©us
 = 
v®
;

267 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: wrm¤ MCG_STATUS %"
PRIx64
"\n", 
v®
);

269 iàĞ
d
->
is_hvm
 && (
vmû
->
Ä_šjeùiÚ
 > 0) )

271 
vmû
->
Ä_šjeùiÚ
--;

272 iàĞ!
	`li¡_em±y
(&
vmû
->
im·ù_h—d”
) )

274 
’Œy
 = 
	`li¡_’Œy
(
vmû
->
im·ù_h—d”
.
Ãxt
,

275 
bªk_’Œy
, 
li¡
);

276 iàĞ
’Œy
->
mci_¡©us
 & 
MCi_STATUS_VAL
 )

277 
	`mû_´štk
(
MCE_QUIET
, "MCE: MCi_STATUS MSR should have "

280 
	`mû_´štk
(
MCE_QUIET
, "MCE: Delete HVM†ast injection "

282 
vmû
->
Ä_šjeùiÚ
);

283 
	`li¡_d–
(&
’Œy
->
li¡
);

284 
	`xä“
(
’Œy
);

287 
	`mû_´štk
(
MCE_QUIET
, "MCE: Not found HVM guest"

291 
MSR_IA32_MCG_CAP
:

292 
	`mû_´štk
(
MCE_QUIET
, "MCE: MCG_CAP is„ead-only\n");

293 
»t
 = -1;

296 
»t
 = 
	`mû_bªk_m¤
(
m¤
è? 
	`bªk_mû_wrm¤
(
d
, m¤, 
v®
) : 0;

300 
	`¥š_uÆock
(&
vmû
->
lock
);

301  
»t
;

302 
	}
}

304 
	$šjeù_vmû
(
domaš
 *
d
)

306 
ıu
 = 
	`smp_´oûssÜ_id
();

307 
ıumask_t
 
affš™y
;

310 iàĞ!
	`‹¡_ªd_£t_boŞ
(
d
->
vıu
[0]->
mû_³ndšg
) )

312 iàĞ
d
->
is_hvm
 )

314 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: inject vMCEo HVM DOM %d\n",

315 
d
->
domaš_id
);

316 
	`vıu_kick
(
d
->
vıu
[0]);

320 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: inject vMCEo PV DOM%d\n",

321 
d
->
domaš_id
);

322 iàĞ
	`gue¡_has_Œ­_ÿÎback
(
d
, 0, 
TRAP_machše_check
) )

324 
d
->
vıu
[0]->
ıu_affš™y_tmp
 =

325 
d
->
vıu
[0]->
ıu_affš™y
;

326 
	`ıus_ş—r
(
affš™y
);

327 
	`ıu_£t
(
ıu
, 
affš™y
);

328 
	`mû_´štk
(
MCE_VERBOSE
, "MCE: CPU%d set‡ffinity, old %d\n",

329 
ıu
, 
d
->
vıu
[0]->
´oûssÜ
);

330 
	`vıu_£t_affš™y
(
d
->
vıu
[0], &
affš™y
);

331 
	`vıu_kick
(
d
->
vıu
[0]);

335 
	`mû_´štk
(
MCE_VERBOSE
,

337 
	`domaš_üash
(
d
);

347 
	`mû_´štk
(
MCE_QUIET
, "There's‡…ending vMCE waitingo be injected "

348 "Øthi DOM%d!\n", 
d
->
domaš_id
);

352 
	}
}

361 
bªk_’Œy
* 
	$®loc_bªk_’Œy
()

363 
bªk_’Œy
 *
’Œy
;

365 
’Œy
 = 
	`xm®loc
(
bªk_’Œy
);

366 iàĞ
’Œy
 =ğ
NULL
 )

368 
	`´štk
(
KERN_ERR
 "MCE: malloc bank_entry failed\n");

369  
NULL
;

372 
	`mem£t
(
’Œy
, 0x0, (entry));

373 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

374  
’Œy
;

375 
	}
}

383 
	$fl_vm¤_d©a
(
mcšfo_bªk
 *
mc_bªk
, 
domaš
 *
d
,

384 
ušt64_t
 
g¡©us
) {

385 
bªk_’Œy
 *
’Œy
;

389 iàĞ
mc_bªk
->
mc_domid
 !ğ(
ušt16_t
)~0 )

394 iàĞ
d
->
is_hvm
 && (
	`dom_vmû
(d)->
Ä_šjeùiÚ
 > 0) )

396 
	`mû_´štk
(
MCE_QUIET
, "MCE: HVM guest has‚ot handled…revious"

401 
’Œy
 = 
	`®loc_bªk_’Œy
();

402 iàĞ
’Œy
 =ğ
NULL
 )

405 
’Œy
->
mci_¡©us
 = 
mc_bªk
->
mc_¡©us
;

406 
’Œy
->
mci_addr
 = 
mc_bªk
->
mc_addr
;

407 
’Œy
->
mci_misc
 = 
mc_bªk
->
mc_misc
;

408 
’Œy
->
bªk
 = 
mc_bªk
->mc_bank;

410 
	`¥š_lock
(&
	`dom_vmû
(
d
)->
lock
);

412 
	`li¡_add_
(&
’Œy
->
li¡
, &
	`dom_vmû
(
d
)->
im·ù_h—d”
);

414 
	`dom_vmû
(
d
)->
mcg_¡©us
 = 
g¡©us
;

416 
	`dom_vmû
(
d
)->
Ä_šjeùiÚ
++;

417 
	`¥š_uÆock
(&
	`dom_vmû
(
d
)->
lock
);

419 
	`mû_´štk
(
MCE_VERBOSE
,"MCE: Foundƒrror @[BANK%d "

420 "¡©u %"
PRIx64
"‡ddr %"PRIx64" domid %d]\n ",

421 
mc_bªk
->mc_bªk, mc_bªk->
mc_¡©us
, mc_bªk->
mc_addr
,

422 
mc_bªk
->
mc_domid
);

426 
	}
}

428 
	$vmû_domaš_šjeù
(

429 
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
, 
mcšfo_glob®
 *
glob®
)

431 
»t
;

433 
»t
 = 
	`fl_vm¤_d©a
(
bªk
, 
d
, 
glob®
->
mc_g¡©us
);

434 iàĞ
»t
 < 0 )

435  
»t
;

437  
	`šjeù_vmû
(
d
);

438 
	}
}

440 
	$vmû_š™
(
ıušfo_x86
 *
c
)

442 
u64
 
v®ue
;

443 
i
;

445 iàĞ!
h_mci_ù¾
 )

447 
h_mci_ù¾
 = 
	`xm®loc_¬¿y
(
ušt64_t
, 
Ä_mû_bªks
);

448 ià(!
h_mci_ù¾
)

450 
	`d´štk
(
XENLOG_INFO
, "Failedo‡lloc h_mci_ctrl\n");

451  -
ENOMEM
;

454 
	`mem£t
(
h_mci_ù¾
, 0xff, (h_mci_ctrl));

455 
i
 = 
fœ¡bªk
; i < 
Ä_mû_bªks
; i++)

456 
	`rdm¤l
(
	`MSR_IA32_MCx_CTL
(
i
), 
h_mci_ù¾
[i]);

459 ià(
g_mcg_ÿp
 & 
MCG_CTL_P
)

460 
	`rdm¤l
(
MSR_IA32_MCG_CTL
, 
h_mcg_ùl
);

462 
	`rdm¤l
(
MSR_IA32_MCG_CAP
, 
v®ue
);

464 
g_mcg_ÿp
 = 
v®ue
 & ~
MCG_CMCI_P
;

467 
	}
}

469 
	$mÿ_ùl_cÚæiù
(
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
)

471 
bªk_Ä
;

473 iàĞ!
bªk
 || !
d
 || !
h_mci_ù¾
 )

477 iàĞ~
d
->
¬ch
.
vmÿ_m¤s
->
mcg_ùl
 & 
h_mcg_ùl
 )

480 
bªk_Ä
 = 
bªk
->
mc_bªk
;

481 ià(~
d
->
¬ch
.
vmÿ_m¤s
->
mci_ùl
[
bªk_Ä
] & 
h_mci_ù¾
[bank_nr] )

484 
	}
}

486 
	$is_hvm_vmû_»ady
(
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
)

488 
vıu
 *
v
;

489 
no_vmû
 = 0, 
i
;

491 ià(!
	`is_hvm_domaš
(
d
))

495 
	`fÜ_—ch_vıu
(
d
, 
v
)

497 ià(!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] & 
X86_CR4_MCE
))

499 
no_vmû
 = 1;

503 ià(!
mû_brßdÿ¡
)

507 ià(
no_vmû
)

511  
i
 = 0; i < 
MAX_CPUID_INPUT
; i++ )

513 ià(
d
->
¬ch
.
ıuids
[
i
].
šput
[0] == 0x1)

515 
ušt32_t
 
v—x
 = 
d
->
¬ch
.
ıuids
[
i
].
—x
, 
vçm
, 
vmod
;

517 
vçm
 = (
v—x
 >> 8) & 15;

518 
vmod
 = (
v—x
 >> 4) & 15;

520 ià(
vçm
 == 0x6 || vfam == 0xf)

521 
vmod
 +ğ((
v—x
 >> 16) & 0xF) << 4;

522 ià(
vçm
 == 0xf)

523 
vçm
 +ğ(
v—x
 >> 20) & 0xff;

525 iàĞĞ
vçm
 !ğ
boÙ_ıu_d©a
.
x86
 ) ||

526 (
vmod
 !ğ
boÙ_ıu_d©a
.
x86_mod–
) )

528 
	`d´štk
(
XENLOG_WARNING
,

530 
no_vmû
 = 1;

536 ià(
no_vmû
)

540 ià(
	`mÿ_ùl_cÚæiù
(
bªk
, 
d
))

542 
	`d´štk
(
XENLOG_WARNING
,

548 
	}
}

550 
	$is_vmû_»ady
(
mcšfo_bªk
 *
bªk
, 
domaš
 *
d
)

552 iàĞ
d
 =ğ
dom0
)

553  
	`dom0_vmû_’abËd
();

556 iàĞ
	`is_hvm_domaš
(
d
) )

557  
	`is_hvm_vmû_»ady
(
bªk
, 
d
);

560 
	}
}

563 
	#P2M_UNMAP_TYPES
 (
	`p2m_to_mask
(
p2m_¿m_rw
) \

564 | 
	`p2m_to_mask
(
p2m_¿m_logdœty
) \

565 | 
	`p2m_to_mask
(
p2m_¿m_ro
) \

566 | 
	`p2m_to_mask
(
p2m_mmio_dœeù
))

	)

575 
	$unmm­_brok’_·ge
(
domaš
 *
d
, 
mâ_t
 
mâ
, 
gâ
)

577 
mâ_t
 
r_mâ
;

578 
p2m_domaš
 *
p2m
;

579 
p2m_ty³_t
 
±
;

582 iàĞ
d
 =ğ
dom0
 )

585 ià(!
	`mâ_v®id
(
	`mâ_x
(
mâ
)))

586  -
EINVAL
;

588 iàĞ!
	`is_hvm_domaš
(
d
è|| !
	`·gšg_mode_h­
(d) )

589  -
ENOSYS
;

591 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

592 
	`ASSERT
(
p2m
);

595 ià(
gâ
 > 
p2m
->
max_m­³d_pâ
)

596  -
EINVAL
;

598 
r_mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
±
);

599 iàĞ
	`p2m_to_mask
(
±
è& 
P2M_UNMAP_TYPES
)

601 
	`ASSERT
(
	`mâ_x
(
r_mâ
è=ğmâ_x(
mâ
));

602 
	`p2m_chªge_ty³
(
p2m
, 
gâ
, 
±
, 
p2m_¿m_brok’
);

607 
	}
}

	@cpu/mcheck/x86_mca.h

20 #iâdeà
X86_MCA_H


21 
	#X86_MCA_H


	)

23 
	~<public/¬ch-x86/x’-mÿ.h
>

33 
	#MCG_SER_P
 (1UL<<24)

	)

34 
	#MCG_CAP_COUNT
 0x00000000000000ffULL

	)

35 
	#MCG_CTL_P
 0x0000000000000100ULL

	)

36 
	#MCG_EXT_P
 (1UL<<9)

	)

37 
	#MCG_EXT_CNT
 (16)

	)

38 
	#MCG_CMCI_P
 (1UL<<10)

	)

42 
	#MCG_STATUS_RIPV
 0x0000000000000001ULL

	)

43 
	#MCG_STATUS_EIPV
 0x0000000000000002ULL

	)

44 
	#MCG_STATUS_MCIP
 0x0000000000000004ULL

	)

49 
	#MCi_STATUS_MCA
 0x000000000000ffffULL

	)

51 
	#MCi_STATUS_MSEC
 0x00000000ffff0000ULL

	)

53 
	#MCi_STATUS_OTHER
 0x01ffffff00000000ULL

	)

55 
	#MCi_STATUS_AR
 0x0080000000000000ULL

	)

57 
	#MCi_STATUS_S
 0x0100000000000000ULL

	)

59 
	#MCi_STATUS_PCC
 0x0200000000000000ULL

	)

61 
	#MCi_STATUS_ADDRV
 0x0400000000000000ULL

	)

63 
	#MCi_STATUS_MISCV
 0x0800000000000000ULL

	)

65 
	#MCi_STATUS_EN
 0x1000000000000000ULL

	)

67 
	#MCi_STATUS_UC
 0x2000000000000000ULL

	)

69 
	#MCi_STATUS_OVER
 0x4000000000000000ULL

	)

71 
	#MCi_STATUS_VAL
 0x8000000000000000ULL

	)

75 
	#MCi_STATUS_OTHER_RESERVED1
 0x00001fff00000000ULL

	)

77 
	#MCi_STATUS_OTEHR_UC_ECC
 0x0000200000000000ULL

	)

79 
	#MCi_STATUS_OTHER_C_ECC
 0x0000400000000000ULL

	)

81 
	#MCi_STATUS_OTHER_ECC_SYNDROME
 0x007f800000000000ULL

	)

83 
	#MCi_STATUS_OTHER_RESERVED2
 0x0180000000000000ULL

	)

86 
	#K8_HWCR_MCi_STATUS_WREN
 (1ULL << 18)

	)

89 
	#CMCI_THRESHOLD
 0x2

	)

91 
	#MCi_MISC_ADDRMOD_MASK
 (0x7UL << 6)

	)

92 
	#MCi_MISC_PHYSMOD
 (0x2UL << 6)

	)

94 
	~<asm/domaš.h
>

96 
	smÿ_bªks


98 
	mnum
;

99 *
	mbªk_m­
;

102 
šlše
 
mÿbªks_ş—r
(
b™
, 
mÿ_bªks
 *
bªks
) \

104 ià(!
	gbªks
 || !bªks->
	gbªk_m­
 || 
	gb™
 >ğ
bªks
->
num
)

106 
ş—r_b™
(
b™
, 
bªks
->
bªk_m­
);

109 
šlše
 
	$mÿbªks_£t
(
b™
, 
mÿ_bªks
* 
bªks
)

111 ià(!
bªks
 || !bªks->
bªk_m­
 || 
b™
 >ğbªks->
num
)

113 
	`£t_b™
(
b™
, 
bªks
->
bªk_m­
);

114 
	}
}

116 
šlše
 
	$mÿbªks_‹¡
(
b™
, 
mÿ_bªks
* 
bªks
)

118 ià(!
bªks
 || !bªks->
bªk_m­
 || 
b™
 >ğbªks->
num
)

120  
	`‹¡_b™
(
b™
, 
bªks
->
bªk_m­
);

121 
	}
}

123 
mÿ_bªks
 *
mÿbªks_®loc
();

124 
mÿbªks_ä“
(
mÿ_bªks
 *
bªks
);

125 
mÿ_bªks
 *
mÿ_®lbªks
;

140 
	#MCA_RECOVERED
 (0x1 << 0)

	)

142 
	#MCA_OWNER
 (0x1 << 1)

	)

144 
	#MCA_NEED_RESET
 (0x1 << 2)

	)

146 
	#MCA_NO_ACTION
 (0x1 << 3)

	)

148 
	smÿ_hªdË_»suÉ


150 
ušt32_t
 
	m»suÉ
;

152 
domid_t
 
	mowÃr
;

154 
»cov”y_aùiÚ
 *
	maùiÚ
;

158 
	smÿ_bšfo
 {

159 
	mbªk
;

160 
mcšfo_glob®
 *
	mmig
;

161 
mcšfo_bªk
 *
	mmib
;

162 
mc_šfo
 *
	mmi
;

163 
ıu_u£r_»gs
 *
	m»gs
;

166 (*
mÿ_´ehªdËr
)Ğ
ıu_u£r_»gs
 *
»gs
,

167 
mÿ_hªdË_»suÉ
 *
»suÉ
);

169 
	smÿ_”rÜ_hªdËr


176 (*
owÃd_”rÜ
)(
ušt64_t
 
¡©us
);

177 (*
»cov”y_hªdËr
)(
bªk
, 
mÿ_bšfo
 *
bšfo
,

178 
mÿ_hªdË_»suÉ
 *
»suÉ
);

182 
boŞ_t
 
mû_di§bËd
;

183 
Ä_mû_bªks
;

	@cpu/mtrr/amd.c

1 
	~<x’/š™.h
>

2 
	~<x’/mm.h
>

3 
	~<asm/mŒr.h
>

4 
	~<asm/m¤.h
>

6 
	~"mŒr.h
"

9 
	$amd_g‘_mŒr
(
»g
, *
ba£
,

10 *
size
, 
mŒr_ty³
 * 
ty³
)

12 
low
, 
high
;

14 
	`rdm¤
(
MSR_K6_UWCCR
, 
low
, 
high
);

16 ià(
»g
 == 1)

17 
low
 = 
high
;

19 *
ba£
 = (
low
 & 0xFFFE0000è>> 
PAGE_SHIFT
;

20 *
ty³
 = 0;

21 ià(
low
 & 1)

22 *
ty³
 = 
MTRR_TYPE_UNCACHABLE
;

23 ià(
low
 & 2)

24 *
ty³
 = 
MTRR_TYPE_WRCOMB
;

25 ià(!(
low
 & 3)) {

26 *
size
 = 0;

44 
low
 = (~low) & 0x1FFFC;

45 *
size
 = (
low
 + 4è<< (15 - 
PAGE_SHIFT
);

47 
	}
}

49 
	$amd_£t_mŒr
(
»g
, 
ba£
,

50 
size
, 
mŒr_ty³
 
ty³
)

61 
u32
 
»gs
[2];

66 
	`rdm¤
(
MSR_K6_UWCCR
, 
»gs
[0],„egs[1]);

70 ià(
size
 == 0)

71 
»gs
[
»g
] = 0;

80 
»gs
[
»g
] = (-
size
 >> (15 - 
PAGE_SHIFT
) & 0x0001FFFC)

81 | (
ba£
 << 
PAGE_SHIFT
è| (
ty³
 + 1);

87 
	`wbšvd
();

88 
	`wrm¤
(
MSR_K6_UWCCR
, 
»gs
[0],„egs[1]);

89 
	}
}

91 
	$amd_v®id©e_add_·ge
(
ba£
, 
size
, 
ty³
)

100 ià(
ty³
 > 
MTRR_TYPE_WRCOMB
 || 
size
 < (1 << (17 - 
PAGE_SHIFT
))

101 || (
size
 & ~(siz- 1)è- siz|| (
ba£
 & (size - 1)))

102  -
EINVAL
;

104 
	}
}

106 
mŒr_İs
 
	gamd_mŒr_İs
 = {

107 .
v’dÜ
 = 
X86_VENDOR_AMD
,

108 .
	g£t
 = 
amd_£t_mŒr
,

109 .
	gg‘
 = 
amd_g‘_mŒr
,

110 .
	gg‘_ä“_»giÚ
 = 
g’”ic_g‘_ä“_»giÚ
,

111 .
	gv®id©e_add_·ge
 = 
amd_v®id©e_add_·ge
,

112 .
	ghave_wrcomb
 = 
pos™ive_have_wrcomb
,

115 
__š™
 
	$amd_š™_mŒr
()

117 
	`£t_mŒr_İs
(&
amd_mŒr_İs
);

119 
	}
}

	@cpu/mtrr/cyrix.c

1 
	~<x’/š™.h
>

2 
	~<x’/mm.h
>

3 
	~<asm/mŒr.h
>

4 
	~<asm/m¤.h
>

5 
	~<asm/io.h
>

6 
	~"mŒr.h
"

8 
	g¬r3_´Ùeùed
;

11 
	$cyrix_g‘_¬r
(
»g
, *
ba£
,

12 *
size
, 
mŒr_ty³
 * 
ty³
)

14 
æags
;

15 
¬r
, 
cü3
, 
rü
, 
shiá
;

17 
¬r
 = 
CX86_ARR_BASE
 + (
»g
 << 1) +„eg;

20 
	`loÿl_œq_§ve
(
æags
);

22 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

23 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

24 ((*è
ba£
)[3] = 
	`g‘Cx86
(
¬r
);

25 ((*è
ba£
)[2] = 
	`g‘Cx86
(
¬r
 + 1);

26 ((*è
ba£
)[1] = 
	`g‘Cx86
(
¬r
 + 2);

27 
rü
 = 
	`g‘Cx86
(
CX86_RCR_BASE
 + 
»g
);

28 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

31 
	`loÿl_œq_»¡Üe
(
æags
);

32 
shiá
 = ((*è
ba£
)[1] & 0x0f;

33 *
ba£
 >>ğ
PAGE_SHIFT
;

38 ià(
shiá
)

39 *
size
 = (
»g
 < 7 ? 0x1UL : 0x40ULè<< (
shiá
 - 1);

41 *
size
 = 0;

44 ià(
»g
 < 7) {

45 
rü
) {

47 *
ty³
 = 
MTRR_TYPE_UNCACHABLE
;

50 *
ty³
 = 
MTRR_TYPE_WRBACK
;

53 *
ty³
 = 
MTRR_TYPE_WRCOMB
;

57 *
ty³
 = 
MTRR_TYPE_WRTHROUGH
;

61 
rü
) {

63 *
ty³
 = 
MTRR_TYPE_UNCACHABLE
;

66 *
ty³
 = 
MTRR_TYPE_WRCOMB
;

69 *
ty³
 = 
MTRR_TYPE_WRBACK
;

73 *
ty³
 = 
MTRR_TYPE_WRTHROUGH
;

77 
	}
}

80 
	$cyrix_g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû_»g
)

87 
i
;

88 
mŒr_ty³
 
Éy³
;

89 
lba£
, 
lsize
;

91 
»¶aû_»g
) {

93 ià(
size
 < 0x40)

98  
»¶aû_»g
;

100 ià(
¬r3_´Ùeùed
)

105  
»¶aû_»g
;

108 ià(
size
 > 0x2000) {

109 
	`cyrix_g‘_¬r
(7, &
lba£
, &
lsize
, &
Éy³
);

110 ià(
lsize
 == 0)

114 
i
 = 0; i < 7; i++) {

115 
	`cyrix_g‘_¬r
(
i
, &
lba£
, &
lsize
, &
Éy³
);

116 ià((
i
 =ğ3è&& 
¬r3_´Ùeùed
)

118 ià(
lsize
 == 0)

119  
i
;

122 
	`cyrix_g‘_¬r
(
i
, &
lba£
, &
lsize
, &
Éy³
);

123 ià((
lsize
 =ğ0è&& (
size
 >= 0x40))

124  
i
;

126  -
ENOSPC
;

127 
	}
}

129 
u32
 
	gü4
 = 0;

130 
u32
 
	gcü3
;

132 
	$´•¬e_£t
()

134 
u32
 
ü0
;

137 iàĞ
ıu_has_pge
 ) {

138 
ü4
 = 
	`»ad_ü4
();

139 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

144 
ü0
 = 
	`»ad_ü0
() | 0x40000000;

145 
	`wbšvd
();

146 
	`wr™e_ü0
(
ü0
);

147 
	`wbšvd
();

150 
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

153 
	`£tCx86
(
CX86_CCR3
, (
cü3
 & 0x0f) | 0x10);

155 
	}
}

157 
	$po¡_£t
()

160 
	`wbšvd
();

163 
	`£tCx86
(
CX86_CCR3
, 
cü3
);

166 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

169 iàĞ
ıu_has_pge
 )

170 
	`wr™e_ü4
(
ü4
);

171 
	}
}

173 
	$cyrix_£t_¬r
(
»g
, 
ba£
,

174 
size
, 
mŒr_ty³
 
ty³
)

176 
¬r
, 
¬r_ty³
, 
¬r_size
;

178 
¬r
 = 
CX86_ARR_BASE
 + (
»g
 << 1) +„eg;

181 ià(
»g
 >= 7)

182 
size
 >>= 6;

184 
size
 &= 0x7fff;

185 
¬r_size
 = 0; 
size
;‡rr_size++, size >>= 1) ;

187 ià(
»g
 < 7) {

188 
ty³
) {

189 
MTRR_TYPE_UNCACHABLE
:

190 
¬r_ty³
 = 1;

192 
MTRR_TYPE_WRCOMB
:

193 
¬r_ty³
 = 9;

195 
MTRR_TYPE_WRTHROUGH
:

196 
¬r_ty³
 = 24;

199 
¬r_ty³
 = 8;

203 
ty³
) {

204 
MTRR_TYPE_UNCACHABLE
:

205 
¬r_ty³
 = 0;

207 
MTRR_TYPE_WRCOMB
:

208 
¬r_ty³
 = 8;

210 
MTRR_TYPE_WRTHROUGH
:

211 
¬r_ty³
 = 25;

214 
¬r_ty³
 = 9;

219 
	`´•¬e_£t
();

221 
ba£
 <<ğ
PAGE_SHIFT
;

222 
	`£tCx86
(
¬r
, ((*è&
ba£
)[3]);

223 
	`£tCx86
(
¬r
 + 1, ((*è&
ba£
)[2]);

224 
	`£tCx86
(
¬r
 + 2, (((*è&
ba£
)[1]è| 
¬r_size
);

225 
	`£tCx86
(
CX86_RCR_BASE
 + 
»g
, 
¬r_ty³
);

227 
	`po¡_£t
();

228 
	}
}

231 
	mba£
;

232 
	msize
;

233 
mŒr_ty³
 
	mty³
;

234 } 
	t¬r_¡©e_t
;

236 
¬r_¡©e_t
 
	g¬r_¡©e
[8] = {

241 
	gcü_¡©e
[7] = { 0, 0, 0, 0, 0, 0, 0 };

243 
	$cyrix_£t_®l
()

245 
i
;

247 
	`´•¬e_£t
();

250 
i
 = 0; i < 4; i++)

251 
	`£tCx86
(
CX86_CCR0
 + 
i
, 
cü_¡©e
[i]);

252 ; 
i
 < 7; i++)

253 
	`£tCx86
(
CX86_CCR4
 + 
i
, 
cü_¡©e
[i]);

254 
i
 = 0; i < 8; i++)

255 
	`cyrix_£t_¬r
(
i
, 
¬r_¡©e
[i].
ba£
,

256 
¬r_¡©e
[
i
].
size
,‡¼_¡©e[i].
ty³
);

258 
	`po¡_£t
();

259 
	}
}

276 
__š™


277 
	$cyrix_¬r_š™
()

279 
£t_mŒr_cÚ‹xt
 
ùxt
;

280 
cü
[7];

281 
cüc
[7] = { 0, 0, 0, 0, 0, 0, 0 };

282 #ifdeà
CONFIG_SMP


283 
i
;

287 
	`£t_mŒr_´•¬e_§ve
(&
ùxt
);

288 
	`£t_mŒr_ÿche_di§bË
(&
ùxt
);

291 
cü
[0] = 
	`g‘Cx86
(
CX86_CCR0
);

292 
cü
[1] = 
	`g‘Cx86
(
CX86_CCR1
);

293 
cü
[2] = 
	`g‘Cx86
(
CX86_CCR2
);

294 
cü
[3] = 
ùxt
.
cü3
;

295 
cü
[4] = 
	`g‘Cx86
(
CX86_CCR4
);

296 
cü
[5] = 
	`g‘Cx86
(
CX86_CCR5
);

297 
cü
[6] = 
	`g‘Cx86
(
CX86_CCR6
);

299 ià(
cü
[3] & 1) {

300 
cüc
[3] = 1;

301 
¬r3_´Ùeùed
 = 1;

306 ià(
cü
[1] & 0x80) {

307 
cü
[1] &= 0x7f;

308 
cüc
[1] |= 0x80;

310 ià(
cü
[1] & 0x04) {

311 
cü
[1] &= 0xfb;

312 
cüc
[1] |= 0x04;

314 ià(
cü
[1] & 0x02) {

315 
cü
[1] &= 0xfd;

316 
cüc
[1] |= 0x02;

318 
¬r3_´Ùeùed
 = 0;

319 ià(
cü
[6] & 0x02) {

320 
cü
[6] &= 0xfd;

321 
cüc
[6] = 1;

322 
	`£tCx86
(
CX86_CCR6
, 
cü
[6]);

328 ià(
cüc
[1])

329 
	`£tCx86
(
CX86_CCR1
, 
cü
[1]);

332 ià(!(
cü
[5] & 0x20)) {

333 
cü
[5] |= 0x20;

334 
cüc
[5] = 1;

335 
	`£tCx86
(
CX86_CCR5
, 
cü
[5]);

337 #ifdeà
CONFIG_SMP


338 
i
 = 0; i < 7; i++)

339 
cü_¡©e
[
i
] = 
cü
[i];

340 
i
 = 0; i < 8; i++)

341 
	`cyrix_g‘_¬r
(
i
,

342 &
¬r_¡©e
[
i
].
ba£
, &¬r_¡©e[i].
size
,

343 &
¬r_¡©e
[
i
].
ty³
);

346 
	`£t_mŒr_dÚe
(&
ùxt
);

348 ià(
cüc
[5])

349 
	`´štk
(
KERN_INFO
 "mtrr: ARR usage was‚otƒnabled,ƒnabled manually\n");

350 ià(
cüc
[3])

351 
	`´štk
(
KERN_INFO
 "mtrr: ARR3 cannot be changed\n");

357 ià(
cüc
[6])

358 
	`´štk
(
KERN_INFO
 "mtrr: ARR3 was write…rotected, unprotected\n");

359 
	}
}

362 
mŒr_İs
 
	gcyrix_mŒr_İs
 = {

363 .
v’dÜ
 = 
X86_VENDOR_CYRIX
,

365 .
	g£t_®l
 = 
cyrix_£t_®l
,

366 .
	g£t
 = 
cyrix_£t_¬r
,

367 .
	gg‘
 = 
cyrix_g‘_¬r
,

368 .
	gg‘_ä“_»giÚ
 = 
cyrix_g‘_ä“_»giÚ
,

369 .
	gv®id©e_add_·ge
 = 
g’”ic_v®id©e_add_·ge
,

370 .
	ghave_wrcomb
 = 
pos™ive_have_wrcomb
,

373 
__š™
 
	$cyrix_š™_mŒr
()

375 
	`£t_mŒr_İs
(&
cyrix_mŒr_İs
);

377 
	}
}

	@cpu/mtrr/generic.c

3 
	~<x’/lib.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/mm.h
>

6 
	~<asm/æushb.h
>

7 
	~<asm/io.h
>

8 
	~<asm/mŒr.h
>

9 
	~<asm/m¤.h
>

10 
	~<asm/sy¡em.h
>

11 
	~<asm/ıuã©u».h
>

12 
	~"mŒr.h
"

14 
	sfixed_¿nge_block
 {

15 
	mba£_m¤
;

16 
	m¿nges
;

19 
fixed_¿nge_block
 
	gfixed_¿nge_blocks
[] = {

20 { 
MTRRfix64K_00000_MSR
, 1 },

21 { 
MTRRfix16K_80000_MSR
, 2 },

22 { 
MTRRfix4K_C0000_MSR
, 8 },

26 
	gsmp_chªges_mask
;

27 
mŒr_¡©e
 
	gmŒr_¡©e
 = {};

31 
	$g‘_mŒr_v¬_¿nge
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

33 
	`rdm¤l
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£
);

34 
	`rdm¤l
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask
);

35 
	}
}

38 
	$g‘_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

40 
ušt64_t
 *
p
 = (ušt64_ˆ*è
äs
;

41 
i
;

43 
	`rdm¤l
(
MTRRfix64K_00000_MSR
, 
p
[0]);

45 
i
 = 0; i < 2; i++)

46 
	`rdm¤l
(
MTRRfix16K_80000_MSR
 + 
i
, 
p
[1 + i]);

47 
i
 = 0; i < 8; i++)

48 
	`rdm¤l
(
MTRRfix4K_C0000_MSR
 + 
i
, 
p
[3 + i]);

49 
	}
}

51 
	$mŒr_§ve_fixed_¿nges
(*
šfo
)

53 ià(
ıu_has_mŒr
)

54 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

55 
	}
}

58 
__š™
 
	$g‘_mŒr_¡©e
()

60 
i
;

61 
mŒr_v¬_¿nge
 *
vrs
;

62 
ušt64_t
 
m¤_cÚ‹Á
;

64 ià(!
mŒr_¡©e
.
v¬_¿nges
) {

65 
mŒr_¡©e
.
v¬_¿nges
 = 
	`xm®loc_¬¿y
(
mŒr_v¬_¿nge
,

66 
num_v¬_¿nges
);

67 ià(!
mŒr_¡©e
.
v¬_¿nges
)

70 
vrs
 = 
mŒr_¡©e
.
v¬_¿nges
;

72 
	`rdm¤l
(
MTRRÿp_MSR
, 
m¤_cÚ‹Á
);

73 
mŒr_¡©e
.
have_fixed
 = (
m¤_cÚ‹Á
 >> 8) & 1;

75 
i
 = 0; i < 
num_v¬_¿nges
; i++)

76 
	`g‘_mŒr_v¬_¿nge
(
i
, &
vrs
[i]);

77 ià(
mŒr_¡©e
.
have_fixed
)

78 
	`g‘_fixed_¿nges
(
mŒr_¡©e
.
fixed_¿nges
);

80 
	`rdm¤l
(
MTRRdefTy³_MSR
, 
m¤_cÚ‹Á
);

81 
mŒr_¡©e
.
def_ty³
 = (
m¤_cÚ‹Á
 & 0xff);

82 
mŒr_¡©e
.
’abËd
 = (
m¤_cÚ‹Á
 & 0xc00) >> 10;

85 
	`rdm¤l
(
MTRRÿp_MSR
, 
mŒr_¡©e
.
mŒr_ÿp
);

86 
	}
}

89 
__š™
 
	$mŒr_¡©e_w¬n
()

91 
mask
 = 
smp_chªges_mask
;

93 ià(!
mask
)

95 ià(
mask
 & 
MTRR_CHANGE_MASK_FIXED
)

96 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent fixed MTRR settings\n");

97 ià(
mask
 & 
MTRR_CHANGE_MASK_VARIABLE
)

98 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent variable MTRR settings\n");

99 ià(
mask
 & 
MTRR_CHANGE_MASK_DEFTYPE
)

100 
	`´štk
(
KERN_WARNING
 "mtrr: your CPUs had inconsistent MTRRdefType settings\n");

101 
	`´štk
(
KERN_INFO
 "mtrr:…robably your BIOS does‚ot setup‡ll CPUs.\n");

102 
	`´štk
(
KERN_INFO
 "mtrr: corrected configuration.\n");

103 
	}
}

108 
	$mŒr_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

110 ià(
	`wrm¤_§ã
(
m¤
, 
m¤_cÚ‹Á
) < 0)

111 
	`´štk
(
KERN_ERR


112 "MTRR: CPU %u: Wr™šg MSR %xØ%"
PRIx64
" failed\n",

113 
	`smp_´oûssÜ_id
(), 
m¤
, 
m¤_cÚ‹Á
);

115 
mŒr_¡©e
.
ov”Ïµed
 = 
	`is_v¬_mŒr_ov”Ïµed
(&mtrr_state);

116 
	}
}

126 
	$£t_fixed_¿nge
(
m¤
, * 
chªged
, * 
m¤wÜds
)

128 
ušt64_t
 
m¤_cÚ‹Á
, 
v®
;

130 
	`rdm¤l
(
m¤
, 
m¤_cÚ‹Á
);

131 
v®
 = ((
ušt64_t
)
m¤wÜds
[1] << 32) | msrwords[0];

133 ià(
m¤_cÚ‹Á
 !ğ
v®
) {

134 
	`mŒr_wrm¤
(
m¤
, 
v®
);

135 *
chªged
 = 
TRUE
;

137 
	}
}

139 
	$g’”ic_g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû_»g
)

146 
i
, 
max
;

147 
mŒr_ty³
 
Éy³
;

148 
lba£
, 
lsize
;

150 
max
 = 
num_v¬_¿nges
;

151 ià(
»¶aû_»g
 >ğ0 &&„•Ïû_»g < 
max
)

152  
»¶aû_»g
;

153 
i
 = 0; i < 
max
; ++i) {

154 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

155 ià(
lsize
 == 0)

156  
i
;

158  -
ENOSPC
;

159 
	}
}

161 
	$g’”ic_g‘_mŒr
(
»g
, *
ba£
,

162 *
size
, 
mŒr_ty³
 *
ty³
)

164 
ušt64_t
 
_mask
, 
_ba£
;

166 
	`rdm¤l
(
	`MTRRphysMask_MSR
(
»g
), 
_mask
);

167 ià((
_mask
 & 0x800) == 0) {

169 *
ba£
 = 0;

170 *
size
 = 0;

171 *
ty³
 = 0;

175 
	`rdm¤l
(
	`MTRRphysBa£_MSR
(
»g
), 
_ba£
);

178 
_mask
 = 
size_Ü_mask
 | (_mask >> 
PAGE_SHIFT
);

182 *
size
 = -(
ušt32_t
)
_mask
;

183 *
ba£
 = 
_ba£
 >> 
PAGE_SHIFT
;

184 *
ty³
 = 
_ba£
 & 0xff;

185 
	}
}

191 
	$£t_fixed_¿nges
(
mŒr_ty³
 * 
äs
)

193 *
§ved
 = (*è
äs
;

194 
chªged
 = 
FALSE
;

195 
block
=-1, 
¿nge
;

197 
fixed_¿nge_blocks
[++
block
].
¿nges
)

198 
¿nge
=0;„ªg< 
fixed_¿nge_blocks
[
block
].
¿nges
;„ange++)

199 
	`£t_fixed_¿nge
(
fixed_¿nge_blocks
[
block
].
ba£_m¤
 + 
¿nge
,

200 &
chªged
, (*è
§ved
++);

202  
chªged
;

203 
	}
}

207 
	$£t_mŒr_v¬_¿nges
(
šdex
, 
mŒr_v¬_¿nge
 *
vr
)

209 
ušt32_t
 
lo
, 
hi
, 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

210 
ušt64_t
 
m¤_cÚ‹Á
;

211 
chªged
 = 
FALSE
;

213 
	`rdm¤l
(
	`MTRRphysBa£_MSR
(
šdex
), 
m¤_cÚ‹Á
);

214 
lo
 = (
ušt32_t
)
m¤_cÚ‹Á
;

215 
hi
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

216 
ba£_lo
 = (
ušt32_t
)
vr
->
ba£
;

217 
ba£_hi
 = (
ušt32_t
)(
vr
->
ba£
 >> 32);

219 
lo
 &= 0xfffff0ffUL;

220 
ba£_lo
 &= 0xfffff0ffUL;

221 
hi
 &ğ
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
);

222 
ba£_hi
 &ğ
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
);

224 ià((
ba£_lo
 !ğ
lo
è|| (
ba£_hi
 !ğ
hi
)) {

225 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
šdex
), 
vr
->
ba£
);

226 
chªged
 = 
TRUE
;

229 
	`rdm¤l
(
	`MTRRphysMask_MSR
(
šdex
), 
m¤_cÚ‹Á
);

230 
lo
 = (
ušt32_t
)
m¤_cÚ‹Á
;

231 
hi
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

232 
mask_lo
 = (
ušt32_t
)
vr
->
mask
;

233 
mask_hi
 = (
ušt32_t
)(
vr
->
mask
 >> 32);

235 
lo
 &= 0xfffff800UL;

236 
mask_lo
 &= 0xfffff800UL;

237 
hi
 &ğ
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
);

238 
mask_hi
 &ğ
size_ªd_mask
 >> (32 - 
PAGE_SHIFT
);

240 ià((
mask_lo
 !ğ
lo
è|| (
mask_hi
 !ğ
hi
)) {

241 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
šdex
), 
vr
->
mask
);

242 
chªged
 = 
TRUE
;

244  
chªged
;

245 
	}
}

247 
ušt64_t
 
	gdeáy³
;

249 
	$£t_mŒr_¡©e
()

257 
i
;

258 
chªge_mask
 = 0;

260 
i
 = 0; i < 
num_v¬_¿nges
; i++)

261 ià(
	`£t_mŒr_v¬_¿nges
(
i
, &
mŒr_¡©e
.
v¬_¿nges
[i]))

262 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_VARIABLE
;

264 ià(
mŒr_¡©e
.
have_fixed
 && 
	`£t_fixed_¿nges
(mŒr_¡©e.
fixed_¿nges
))

265 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_FIXED
;

269 ià((
deáy³
 & 0xffè!ğ
mŒr_¡©e
.
def_ty³


270 || ((
deáy³
 & 0xc00è>> 10è!ğ
mŒr_¡©e
.
’abËd
) {

271 
deáy³
 = (deáy³ & ~0xcffè| 
mŒr_¡©e
.
def_ty³
 | (mŒr_¡©e.
’abËd
 << 10);

272 
chªge_mask
 |ğ
MTRR_CHANGE_MASK_DEFTYPE
;

275  
chªge_mask
;

276 
	}
}

279 
	gü4
 = 0;

280 
DEFINE_SPINLOCK
(
£t_©omic™y_lock
);

289 
	$´•¬e_£t
()

291 
ü0
;

297 
	`¥š_lock
(&
£t_©omic™y_lock
);

300 
ü0
 = 
	`»ad_ü0
() | 0x40000000;

301 
	`wr™e_ü0
(
ü0
);

302 
	`wbšvd
();

305 iàĞ
ıu_has_pge
 ) {

306 
ü4
 = 
	`»ad_ü4
();

307 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

311 
	`æush_b_loÿl
();

314 
	`rdm¤l
(
MTRRdefTy³_MSR
, 
deáy³
);

317 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³
 & ~0xcff);

318 
	}
}

320 
	$po¡_£t
()

323 
	`æush_b_loÿl
();

326 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
deáy³
);

329 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

332 iàĞ
ıu_has_pge
 )

333 
	`wr™e_ü4
(
ü4
);

334 
	`¥š_uÆock
(&
£t_©omic™y_lock
);

335 
	}
}

337 
	$g’”ic_£t_®l
()

339 
mask
, 
couÁ
;

340 
æags
;

342 
	`loÿl_œq_§ve
(
æags
);

343 
	`´•¬e_£t
();

346 
mask
 = 
	`£t_mŒr_¡©e
();

348 
	`po¡_£t
();

349 
	`loÿl_œq_»¡Üe
(
æags
);

352 
couÁ
 = 0; couÁ <  
mask
 * 8; ++count) {

353 ià(
mask
 & 0x01)

354 
	`£t_b™
(
couÁ
, &
smp_chªges_mask
);

355 
mask
 >>= 1;

358 
	}
}

360 
	$g’”ic_£t_mŒr
(
»g
, 
ba£
,

361 
size
, 
mŒr_ty³
 
ty³
)

372 
æags
;

373 
mŒr_v¬_¿nge
 *
vr
;

375 
vr
 = &
mŒr_¡©e
.
v¬_¿nges
[
»g
];

377 
	`loÿl_œq_§ve
(
æags
);

378 
	`´•¬e_£t
();

380 ià(
size
 == 0) {

383 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 0);

384 
	`mem£t
(
vr
, 0, (
mŒr_v¬_¿nge
));

386 
ušt32_t
 
ba£_lo
, 
ba£_hi
, 
mask_lo
, 
mask_hi
;

388 
ba£_lo
 = 
ba£
 << 
PAGE_SHIFT
 | 
ty³
;

389 
ba£_hi
 = (
ba£
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

390 
mask_lo
 = -
size
 << 
PAGE_SHIFT
 | 0x800;

391 
mask_hi
 = (-
size
 & 
size_ªd_mask
è>> (32 - 
PAGE_SHIFT
);

392 
vr
->
ba£
 = ((
ušt64_t
)
ba£_hi
 << 32è| 
ba£_lo
;

393 
vr
->
mask
 = ((
ušt64_t
)
mask_hi
 << 32è| 
mask_lo
;

395 
	`mŒr_wrm¤
(
	`MTRRphysBa£_MSR
(
»g
), 
vr
->
ba£
);

396 
	`mŒr_wrm¤
(
	`MTRRphysMask_MSR
(
»g
), 
vr
->
mask
);

399 
	`po¡_£t
();

400 
	`loÿl_œq_»¡Üe
(
æags
);

401 
	}
}

403 
	$g’”ic_v®id©e_add_·ge
(
ba£
, 
size
, 
ty³
)

405 
lba£
, 
Ï¡
;

409 ià(
	`is_ıu
(
INTEL
è&& 
boÙ_ıu_d©a
.
x86
 == 6 &&

410 
boÙ_ıu_d©a
.
x86_mod–
 == 1 &&

411 
boÙ_ıu_d©a
.
x86_mask
 <= 7) {

412 ià(
ba£
 & ((1 << (22 - 
PAGE_SHIFT
)) - 1)) {

413 
	`´štk
(
KERN_WARNING
 "mŒr: ba£(0x%lx000èi nÙ 4 MiB‡ligÃd\n", 
ba£
);

414  -
EINVAL
;

416 ià(!(
ba£
 + 
size
 < 0x70000 || base > 0x7003F) &&

417 (
ty³
 =ğ
MTRR_TYPE_WRCOMB


418 || 
ty³
 =ğ
MTRR_TYPE_WRBACK
)) {

419 
	`´štk
(
KERN_WARNING
 "mtrr: writable mtrr between 0x70000000‡nd 0x7003FFFF may hanghe CPU.\n");

420  -
EINVAL
;

426 
Ï¡
 = 
ba£
 + 
size
 - 1;

427 
lba£
 = 
ba£
; !Öba£ & 1è&& (
Ï¡
 & 1);

428 
lba£
 =†ba£ >> 1, 
Ï¡
 =†ast >> 1) ;

429 ià(
lba£
 !ğ
Ï¡
) {

430 
	`´štk
(
KERN_WARNING
 "mtrr: base(0x%lx000) is‚ot‡ligned on‡ size(0x%lx000) boundary\n",

431 
ba£
, 
size
);

432  -
EINVAL
;

435 
	}
}

438 
	$g’”ic_have_wrcomb
()

440 
cÚfig
;

441 
	`rdm¤l
(
MTRRÿp_MSR
, 
cÚfig
);

442  (
cÚfig
 & (1ULL << 10));

443 
	}
}

445 
	$pos™ive_have_wrcomb
()

448 
	}
}

452 
mŒr_İs
 
	gg’”ic_mŒr_İs
 = {

453 .
u£_š‹l_if
 = 1,

454 .
	g£t_®l
 = 
g’”ic_£t_®l
,

455 .
	gg‘
 = 
g’”ic_g‘_mŒr
,

456 .
	gg‘_ä“_»giÚ
 = 
g’”ic_g‘_ä“_»giÚ
,

457 .
	g£t
 = 
g’”ic_£t_mŒr
,

458 .
	gv®id©e_add_·ge
 = 
g’”ic_v®id©e_add_·ge
,

459 .
	ghave_wrcomb
 = 
g’”ic_have_wrcomb
,

	@cpu/mtrr/main.c

34 
	~<x’/cÚfig.h
>

35 
	~<x’/š™.h
>

36 
	~<x’/lib.h
>

37 
	~<x’/smp.h
>

38 
	~<x’/¥šlock.h
>

39 
	~<asm/mŒr.h
>

40 
	~<asm/uacûss.h
>

41 
	~<asm/´oûssÜ.h
>

42 
	~<asm/m¤.h
>

43 
	~"mŒr.h
"

46 
	#DEFINE_MUTEX
(
_m
è
	`DEFINE_SPINLOCK
(_m)

	)

47 
	#mu‹x_lock
(
_m
è
	`¥š_lock
(_m)

	)

48 
	#mu‹x_uÆock
(
_m
è
	`¥š_uÆock
(_m)

	)

49 
	#dump_¡ack
(è(()0)

	)

50 
	#g‘_ıu
(è
	`smp_´oûssÜ_id
()

	)

51 
	#put_ıu
(èdØ{} 0)

	)

53 
u32
 
	gnum_v¬_¿nges
 = 0;

55 *
	gu§ge_bË
;

56 
DEFINE_MUTEX
(
mŒr_mu‹x
);

58 
u64
 
	gsize_Ü_mask
, 
	gsize_ªd_mask
;

60 
mŒr_İs
 * 
	gmŒr_İs
[
X86_VENDOR_NUM
] = {};

62 
mŒr_İs
 * 
	gmŒr_if
 = 
NULL
;

64 
£t_mŒr
(
»g
, 
ba£
,

65 
size
, 
mŒr_ty³
 
ty³
);

67 #iâdeà
CONFIG_X86_64


68 
¬r3_´Ùeùed
;

70 
	#¬r3_´Ùeùed
 0

	)

73 cÚ¡ *
	gmŒr_¡ršgs
[
MTRR_NUM_TYPES
] =

84 cÚ¡ *
	$mŒr_©Œib_to_¡r
(
x
)

86  (
x
 <ğ6è? 
mŒr_¡ršgs
[x] : "?";

87 
	}
}

89 
	$£t_mŒr_İs
(
mŒr_İs
 * 
İs
)

91 ià(
İs
->
v’dÜ
 && ops->v’dÜ < 
X86_VENDOR_NUM
)

92 
mŒr_İs
[
İs
->
v’dÜ
] = ops;

93 
	}
}

96 
	$have_wrcomb
()

98  (
mŒr_if
->
have_wrcomb
 ? mŒr_if->
	`have_wrcomb
() : 0);

99 
	}
}

102 
__š™
 
	$£t_num_v¬_¿nges
()

104 
cÚfig
 = 0;

106 ià(
	`u£_š‹l
()) {

107 
	`rdm¤l
(
MTRRÿp_MSR
, 
cÚfig
);

108 } ià(
	`is_ıu
(
AMD
))

109 
cÚfig
 = 2;

110 ià(
	`is_ıu
(
CYRIX
è|| is_ıu(
CENTAUR
))

111 
cÚfig
 = 8;

112 
num_v¬_¿nges
 = 
cÚfig
 & 0xff;

113 
	}
}

115 
__š™
 
	$š™_bË
()

117 
i
, 
max
;

119 
max
 = 
num_v¬_¿nges
;

120 ià((
u§ge_bË
 = 
	`xm®loc_¬¿y
(, 
max
)è=ğ
NULL
) {

121 
	`´štk
(
KERN_ERR
 "mtrr: could‚ot‡llocate\n");

124 
i
 = 0; i < 
max
; i++)

125 
u§ge_bË
[
i
] = 1;

126 
	}
}

128 
	s£t_mŒr_d©a
 {

129 
©omic_t
 
	mcouÁ
;

130 
©omic_t
 
	mg©e
;

131 
	msmp_ba£
;

132 
	msmp_size
;

133 
	msmp_»g
;

134 
mŒr_ty³
 
	msmp_ty³
;

146 
	ghŞd_mŒr_upd©es_Ú_­s
;

148 #ifdeà
CONFIG_SMP


150 
	$i_hªdËr
(*
šfo
)

155 
£t_mŒr_d©a
 *
d©a
 = 
šfo
;

156 
æags
;

158 
	`loÿl_œq_§ve
(
æags
);

160 
	`©omic_dec
(&
d©a
->
couÁ
);

161 !
	`©omic_»ad
(&
d©a
->
g©e
))

162 
	`ıu_»Ïx
();

165 ià(
d©a
->
smp_»g
 == ~0U)

168 
mŒr_if
->
	`£t_®l
();

170 
mŒr_if
->
	`£t
(
d©a
->
smp_»g
, d©a->
smp_ba£
,

171 
d©a
->
smp_size
, d©a->
smp_ty³
);

173 
	`©omic_dec
(&
d©a
->
couÁ
);

174 
	`©omic_»ad
(&
d©a
->
g©e
))

175 
	`ıu_»Ïx
();

177 
	`©omic_dec
(&
d©a
->
couÁ
);

178 
	`loÿl_œq_»¡Üe
(
æags
);

179 
	}
}

183 
šlše
 
	$ty³s_com·tibË
(
mŒr_ty³
 
ty³1
, mŒr_ty³ 
ty³2
) {

184  
ty³1
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

185 
ty³2
 =ğ
MTRR_TYPE_UNCACHABLE
 ||

186 (
ty³1
 =ğ
MTRR_TYPE_WRTHROUGH
 && 
ty³2
 =ğ
MTRR_TYPE_WRBACK
) ||

187 (
ty³1
 =ğ
MTRR_TYPE_WRBACK
 && 
ty³2
 =ğ
MTRR_TYPE_WRTHROUGH
);

188 
	}
}

229 
	$£t_mŒr
(
»g
, 
ba£
,

230 
size
, 
mŒr_ty³
 
ty³
)

232 
ıumask_t
 
®lbut£lf
;

233 
Ä_ıus
;

234 
£t_mŒr_d©a
 
d©a
;

235 
æags
;

237 
®lbut£lf
 = 
ıu_Úlše_m­
;

238 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbut£lf
);

239 
Ä_ıus
 = 
	`ıus_weight
(
®lbut£lf
);

241 
d©a
.
smp_»g
 = 
»g
;

242 
d©a
.
smp_ba£
 = 
ba£
;

243 
d©a
.
smp_size
 = 
size
;

244 
d©a
.
smp_ty³
 = 
ty³
;

245 
	`©omic_£t
(&
d©a
.
couÁ
, 
Ä_ıus
);

246 
	`©omic_£t
(&
d©a
.
g©e
,0);

249 
	`Ú_£Ëùed_ıus
(&
®lbut£lf
, 
i_hªdËr
, &
d©a
, 0);

251 
	`loÿl_œq_§ve
(
æags
);

253 
	`©omic_»ad
(&
d©a
.
couÁ
))

254 
	`ıu_»Ïx
();

257 
	`©omic_£t
(&
d©a
.
couÁ
, 
Ä_ıus
);

258 
	`smp_wmb
();

259 
	`©omic_£t
(&
d©a
.
g©e
,1);

269 ià(
»g
 == ~0U)

272 
mŒr_if
->
	`£t_®l
();

274 
mŒr_if
->
	`£t
(
»g
,
ba£
,
size
,
ty³
);

277 
	`©omic_»ad
(&
d©a
.
couÁ
))

278 
	`ıu_»Ïx
();

280 
	`©omic_£t
(&
d©a
.
couÁ
, 
Ä_ıus
);

281 
	`smp_wmb
();

282 
	`©omic_£t
(&
d©a
.
g©e
,0);

288 
	`©omic_»ad
(&
d©a
.
couÁ
))

289 
	`ıu_»Ïx
();

291 
	`loÿl_œq_»¡Üe
(
æags
);

292 
	}
}

330 
	$mŒr_add_·ge
(
ba£
, 
size
,

331 
ty³
, 
šüem’t
)

333 
i
, 
»¶aû
, 
”rÜ
;

334 
mŒr_ty³
 
Éy³
;

335 
lba£
, 
lsize
;

337 ià(!
mŒr_if
)

338  -
ENXIO
;

340 ià((
”rÜ
 = 
mŒr_if
->
	`v®id©e_add_·ge
(
ba£
,
size
,
ty³
)))

341  
”rÜ
;

343 ià(
ty³
 >ğ
MTRR_NUM_TYPES
) {

344 
	`´štk
(
KERN_WARNING
 "mŒr:y³: %u inv®id\n", 
ty³
);

345  -
EINVAL
;

349 ià((
ty³
 =ğ
MTRR_TYPE_WRCOMB
è&& !
	`have_wrcomb
()) {

350 
	`´štk
(
KERN_WARNING


352  -
ENOSYS
;

355 ià(!
size
) {

356 
	`´štk
(
KERN_WARNING
 "mtrr: zero sized„equest\n");

357  -
EINVAL
;

360 ià(
ba£
 & 
size_Ü_mask
 || 
size
 & size_or_mask) {

361 
	`´štk
(
KERN_WARNING
 "mtrr: base or sizeƒxceedshe MTRR width\n");

362  -
EINVAL
;

365 
”rÜ
 = -
EINVAL
;

366 
»¶aû
 = -1;

369 
	`mu‹x_lock
(&
mŒr_mu‹x
);

370 
i
 = 0; i < 
num_v¬_¿nges
; ++i) {

371 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

372 ià(!
lsize
 || 
ba£
 > 
lba£
 +†siz- 1 || ba£ + 
size
 - 1 <†base)

375 ià(
ba£
 < 
lba£
 || ba£ + 
size
 - 1 >†ba£ + 
lsize
 - 1) {

376 ià(
ba£
 <ğ
lba£
 && ba£ + 
size
 - 1 >ğlba£ + 
lsize
 - 1) {

378 ià(
ty³
 =ğ
Éy³
) {

379 
»¶aû
 =„•Ïû =ğ-1 ? 
i
 : -2;

382 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

385 
	`´štk
(
KERN_WARNING


387 " 0x%lx000,0x%lx000\n", 
ba£
, 
size
, 
lba£
,

388 
lsize
);

389 
out
;

392 ià(
Éy³
 !ğ
ty³
) {

393 ià(
	`ty³s_com·tibË
(
ty³
, 
Éy³
))

395 
	`´štk
 (
KERN_WARNING
 "mtrr:ype mismatch for %lx000,%lx000 old: %s‚ew: %s\n",

396 
ba£
, 
size
, 
	`mŒr_©Œib_to_¡r
(
Éy³
),

397 
	`mŒr_©Œib_to_¡r
(
ty³
));

398 
out
;

400 ià(
šüem’t
)

401 ++
u§ge_bË
[
i
];

402 
”rÜ
 = 
i
;

403 
out
;

406 
i
 = 
mŒr_if
->
	`g‘_ä“_»giÚ
(
ba£
, 
size
, 
»¶aû
);

407 ià(
i
 >= 0) {

408 
	`£t_mŒr
(
i
, 
ba£
, 
size
, 
ty³
);

409 ià(
	`lik–y
(
»¶aû
 < 0))

410 
u§ge_bË
[
i
] = 1;

412 
u§ge_bË
[
i
] = u§ge_bË[
»¶aû
] + !!
šüem’t
;

413 ià(
	`uÆik–y
(
»¶aû
 !ğ
i
)) {

414 
	`£t_mŒr
(
»¶aû
, 0, 0, 0);

415 
u§ge_bË
[
»¶aû
] = 0;

419 
	`´štk
(
KERN_INFO
 "mtrr:‚o more MTRRs‡vailable\n");

420 
”rÜ
 = 
i
;

421 
out
:

422 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

423  
”rÜ
;

424 
	}
}

426 
	$mŒr_check
(
ba£
, 
size
)

428 ià((
ba£
 & (
PAGE_SIZE
 - 1)è|| (
size
 & (PAGE_SIZE - 1))) {

429 
	`´štk
(
KERN_WARNING


431 
	`´štk
(
KERN_DEBUG


432 "mŒr: size: 0x%lx ba£: 0x%lx\n", 
size
, 
ba£
);

433 
	`dump_¡ack
();

437 
	}
}

476 
	$mŒr_add
(
ba£
, 
size
, 
ty³
,

477 
šüem’t
)

479 ià(
	`mŒr_check
(
ba£
, 
size
))

480  -
EINVAL
;

481  
	`mŒr_add_·ge
(
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT, 
ty³
,

482 
šüem’t
);

483 
	}
}

500 
	$mŒr_d–_·ge
(
»g
, 
ba£
, 
size
)

502 
i
, 
max
;

503 
mŒr_ty³
 
Éy³
;

504 
lba£
, 
lsize
;

505 
”rÜ
 = -
EINVAL
;

507 ià(!
mŒr_if
)

508  -
ENXIO
;

510 
max
 = 
num_v¬_¿nges
;

511 
	`mu‹x_lock
(&
mŒr_mu‹x
);

512 ià(
»g
 < 0) {

514 
i
 = 0; i < 
max
; ++i) {

515 
mŒr_if
->
	`g‘
(
i
, &
lba£
, &
lsize
, &
Éy³
);

516 ià(
lba£
 =ğ
ba£
 && 
lsize
 =ğ
size
) {

517 
»g
 = 
i
;

521 ià(
»g
 < 0) {

522 
	`´štk
(
KERN_DEBUG
 "mŒr:‚ØMTRR fÜ %lx000,%lx000 found\n", 
ba£
,

523 
size
);

524 
out
;

527 ià(
»g
 >ğ
max
) {

528 
	`´štk
(
KERN_WARNING
 "mŒr:„egi¡”: %doØbig\n", 
»g
);

529 
out
;

531 ià(
	`is_ıu
(
CYRIX
è&& !
	`u£_š‹l
()) {

532 ià((
»g
 =ğ3è&& 
¬r3_´Ùeùed
) {

533 
	`´štk
(
KERN_WARNING
 "mtrr: ARR3 cannot be changed\n");

534 
out
;

537 
mŒr_if
->
	`g‘
(
»g
, &
lba£
, &
lsize
, &
Éy³
);

538 ià(
lsize
 < 1) {

539 
	`´štk
(
KERN_WARNING
 "mŒr: MTRR %d‚Ù u£d\n", 
»g
);

540 
out
;

542 ià(
u§ge_bË
[
»g
] < 1) {

543 
	`´štk
(
KERN_WARNING
 "mŒr:„eg: %d ha couÁ=0\n", 
»g
);

544 
out
;

546 ià(--
u§ge_bË
[
»g
] < 1)

547 
	`£t_mŒr
(
»g
, 0, 0, 0);

548 
”rÜ
 = 
»g
;

549 
out
:

550 
	`mu‹x_uÆock
(&
mŒr_mu‹x
);

551  
”rÜ
;

552 
	}
}

569 
	$mŒr_d–
(
»g
, 
ba£
, 
size
)

571 ià(
	`mŒr_check
(
ba£
, 
size
))

572  -
EINVAL
;

573  
	`mŒr_d–_·ge
(
»g
, 
ba£
 >> 
PAGE_SHIFT
, 
size
 >> PAGE_SHIFT);

574 
	}
}

576 
EXPORT_SYMBOL
(
mŒr_add
);

577 
EXPORT_SYMBOL
(
mŒr_d–
);

583 
amd_š™_mŒr
();

584 
cyrix_š™_mŒr
();

586 
__š™
 
	$š™_ifs
()

588 #iâdeà
CONFIG_X86_64


589 
	`amd_š™_mŒr
();

590 
	`cyrix_š™_mŒr
();

592 
	}
}

597 
	smŒr_v®ue
 {

598 
mŒr_ty³
 
	mÉy³
;

599 
	mlba£
;

600 
	mlsize
;

603 
·ddr_b™s
 
	g__»ad_mo¡ly
 = 36;

612 
__š™
 
	$mŒr_bp_š™
()

614 
	`š™_ifs
();

616 ià(
ıu_has_mŒr
) {

617 
mŒr_if
 = &
g’”ic_mŒr_İs
;

618 
size_Ü_mask
 = 0xff000000;

619 
size_ªd_mask
 = 0x00f00000;

624 ià(
	`ıuid_—x
(0x80000000) >= 0x80000008) {

625 
·ddr_b™s
 = 
	`ıuid_—x
(0x80000008) & 0xff;

627 ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 &&

628 
boÙ_ıu_d©a
.
x86
 == 0xF &&

629 
boÙ_ıu_d©a
.
x86_mod–
 == 0x3 &&

630 (
boÙ_ıu_d©a
.
x86_mask
 == 0x3 ||

631 
boÙ_ıu_d©a
.
x86_mask
 == 0x4))

632 
·ddr_b™s
 = 36;

634 
size_Ü_mask
 = ~((1ULL << (
·ddr_b™s
 - 
PAGE_SHIFT
)) - 1);

635 
size_ªd_mask
 = ~
size_Ü_mask
 & 0xfffff00000ULL;

636 } ià(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_CENTAUR
 &&

637 
boÙ_ıu_d©a
.
x86
 == 6) {

640 
size_Ü_mask
 = 0xfff00000;

641 
size_ªd_mask
 = 0;

644 #iâdeà
CONFIG_X86_64


645 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

646 
X86_VENDOR_AMD
:

647 ià(
ıu_has_k6_mŒr
) {

649 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_AMD
];

650 
size_Ü_mask
 = 0xfff00000;

651 
size_ªd_mask
 = 0;

654 
X86_VENDOR_CYRIX
:

655 ià(
ıu_has_cyrix_¬r
) {

656 
mŒr_if
 = 
mŒr_İs
[
X86_VENDOR_CYRIX
];

657 
size_Ü_mask
 = 0xfff00000;

658 
size_ªd_mask
 = 0;

667 ià(
mŒr_if
) {

668 
	`£t_num_v¬_¿nges
();

669 
	`š™_bË
();

670 ià(
	`u£_š‹l
())

671 
	`g‘_mŒr_¡©e
();

673 
	}
}

675 
	$mŒr_­_š™
()

677 ià(!
mŒr_if
 || !
	`u£_š‹l
(è|| 
hŞd_mŒr_upd©es_Ú_­s
)

687 
	`£t_mŒr
(~0U, 0, 0, 0);

688 
	}
}

693 
	$mŒr_§ve_¡©e
()

695 
ıu
 = 
	`g‘_ıu
();

697 ià(
ıu
 == 0)

698 
	`mŒr_§ve_fixed_¿nges
(
NULL
);

700 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(0), 
mŒr_§ve_fixed_¿nges
, 
NULL
, 1);

701 
	`put_ıu
();

702 
	}
}

704 
	$mŒr_­s_sync_begš
()

706 ià(!
	`u£_š‹l
())

708 
hŞd_mŒr_upd©es_Ú_­s
 = 1;

709 
	}
}

711 
	$mŒr_­s_sync_’d
()

713 ià(!
	`u£_š‹l
())

715 
	`£t_mŒr
(~0U, 0, 0, 0);

716 
hŞd_mŒr_upd©es_Ú_­s
 = 0;

717 
	}
}

719 
	$mŒr_bp_»¡Üe
()

721 ià(!
	`u£_š‹l
())

723 
mŒr_if
->
	`£t_®l
();

724 
	}
}

726 
__š™
 
	$mŒr_š™_fšŸlize
()

728 ià(!
mŒr_if
)

730 ià(
	`u£_š‹l
())

731 
	`mŒr_¡©e_w¬n
();

733 
	}
}

734 
__š™ÿÎ
(
mŒr_š™_fšŸlize
);

	@cpu/mtrr/mtrr.h

5 #iâdeà
TRUE


6 
	#TRUE
 1

	)

7 
	#FALSE
 0

	)

10 
	#MTRRÿp_MSR
 0x0ã

	)

11 
	#MTRRdefTy³_MSR
 0x2ff

	)

13 
	#MTRRphysBa£_MSR
(
»g
è(0x200 + 2 * (»g))

	)

14 
	#MTRRphysMask_MSR
(
»g
è(0x200 + 2 * (»gè+ 1)

	)

16 
	#MTRRfix64K_00000_MSR
 0x250

	)

17 
	#MTRRfix16K_80000_MSR
 0x258

	)

18 
	#MTRRfix16K_A0000_MSR
 0x259

	)

19 
	#MTRRfix4K_C0000_MSR
 0x268

	)

20 
	#MTRRfix4K_C8000_MSR
 0x269

	)

21 
	#MTRRfix4K_D0000_MSR
 0x26a

	)

22 
	#MTRRfix4K_D8000_MSR
 0x26b

	)

23 
	#MTRRfix4K_E0000_MSR
 0x26c

	)

24 
	#MTRRfix4K_E8000_MSR
 0x26d

	)

25 
	#MTRRfix4K_F0000_MSR
 0x26e

	)

26 
	#MTRRfix4K_F8000_MSR
 0x26f

	)

28 
	#MTRR_CHANGE_MASK_FIXED
 0x01

	)

29 
	#MTRR_CHANGE_MASK_VARIABLE
 0x02

	)

30 
	#MTRR_CHANGE_MASK_DEFTYPE
 0x04

	)

33 
	smŒr_İs
 {

34 
u32
 
	mv’dÜ
;

35 
u32
 
	mu£_š‹l_if
;

37 (*
	m£t
)(
	m»g
, 
	mba£
,

38 
	msize
, 
mŒr_ty³
 
	mty³
);

39 (*
	m£t_®l
)();

41 (*
	mg‘
)(
	m»g
, *
	mba£
,

42 *
	msize
, 
mŒr_ty³
 * 
	mty³
);

43 (*
	mg‘_ä“_»giÚ
)(
	mba£
, 
	msize
,

44 
	m»¶aû_»g
);

45 (*
	mv®id©e_add_·ge
)(
	mba£
, 
	msize
,

46 
	mty³
);

47 (*
	mhave_wrcomb
)();

50 
g’”ic_g‘_ä“_»giÚ
(
ba£
, 
size
,

51 
»¶aû_»g
);

52 
g’”ic_v®id©e_add_·ge
(
ba£
, 
size
,

53 
ty³
);

55 
mŒr_İs
 
g’”ic_mŒr_İs
;

57 
pos™ive_have_wrcomb
();

60 
	s£t_mŒr_cÚ‹xt
 {

61 
	mæags
;

62 
	mü4v®
;

63 
ušt64_t
 
	mdeáy³
;

64 
u32
 
	mcü3
;

67 
£t_mŒr_dÚe
(
£t_mŒr_cÚ‹xt
 *
ùxt
);

68 
£t_mŒr_ÿche_di§bË
(
£t_mŒr_cÚ‹xt
 *
ùxt
);

69 
£t_mŒr_´•¬e_§ve
(
£t_mŒr_cÚ‹xt
 *
ùxt
);

71 
g‘_mŒr_¡©e
();

73 
£t_mŒr_İs
(
mŒr_İs
 * 
İs
);

75 
u64
 
size_Ü_mask
, 
size_ªd_mask
;

76 
mŒr_İs
 * 
mŒr_if
;

78 
	#is_ıu
(
vnd
è(
mŒr_if
 && mŒr_if->
v’dÜ
 =ğ
X86_VENDOR_
##vnd)

	)

79 
	#u£_š‹l
(è(
mŒr_if
 && mŒr_if->
u£_š‹l_if
 =ğ1)

	)

81 
num_v¬_¿nges
;

83 
mŒr_¡©e_w¬n
();

84 cÚ¡ *
mŒr_©Œib_to_¡r
(
x
);

85 
mŒr_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
);

	@cpu/mtrr/state.c

1 
	~<x’/mm.h
>

2 
	~<x’/š™.h
>

3 
	~<asm/io.h
>

4 
	~<asm/mŒr.h
>

5 
	~<asm/m¤.h
>

6 
	~"mŒr.h
"

10 
	$£t_mŒr_´•¬e_§ve
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

12 
ü0
;

15 
	`loÿl_œq_§ve
(
ùxt
->
æags
);

17 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

20 iàĞ
ıu_has_pge
 ) {

21 
ùxt
->
ü4v®
 = 
	`»ad_ü4
();

22 
	`wr™e_ü4
(
ùxt
->
ü4v®
 & () ~(1 << 7));

27 
ü0
 = 
	`»ad_ü0
() | 0x40000000;

28 
	`wbšvd
();

29 
	`wr™e_ü0
(
ü0
);

30 
	`wbšvd
();

32 ià(
	`u£_š‹l
()) {

34 
	`rdm¤l
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³
);

37 
ùxt
->
cü3
 = 
	`g‘Cx86
(
CX86_CCR3
);

39 
	}
}

41 
	$£t_mŒr_ÿche_di§bË
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

43 ià(
	`u£_š‹l
())

45 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³
 & 0xf300UL);

46 ià(
	`is_ıu
(
CYRIX
))

48 
	`£tCx86
(
CX86_CCR3
, (
ùxt
->
cü3
 & 0x0f) | 0x10);

49 
	}
}

52 
	$£t_mŒr_dÚe
(
£t_mŒr_cÚ‹xt
 *
ùxt
)

54 ià(
	`u£_š‹l
(è|| 
	`is_ıu
(
CYRIX
)) {

57 
	`wbšvd
();

60 ià(
	`u£_š‹l
())

62 
	`mŒr_wrm¤
(
MTRRdefTy³_MSR
, 
ùxt
->
deáy³
);

65 
	`£tCx86
(
CX86_CCR3
, 
ùxt
->
cü3
);

68 
	`wr™e_ü0
(
	`»ad_ü0
() & 0xbfffffff);

71 iàĞ
ıu_has_pge
 )

72 
	`wr™e_ü4
(
ùxt
->
ü4v®
);

75 
	`loÿl_œq_»¡Üe
(
ùxt
->
æags
);

76 
	}
}

	@cpu/transmeta.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/lib.h
>

3 
	~<x’/š™.h
>

4 
	~<asm/´oûssÜ.h
>

5 
	~<asm/m¤.h
>

6 
	~"ıu.h
"

8 
__š™
 
	$š™_Œªsm‘a
(
ıušfo_x86
 *
c
)

10 
ÿp_mask
, 
uk
, 
max
, 
dummy
;

11 
cms_»v1
, 
cms_»v2
;

12 
ıu_»v
, 
ıu_äeq
, 
ıu_æags
, 
Ãw_ıu_»v
;

13 
ıu_šfo
[65];

15 
	`g‘_mod–_Çme
(
c
);

16 
	`di¥Ïy_ÿchešfo
(
c
);

19 
max
 = 
	`ıuid_—x
(0x80860000);

20 
ıu_»v
 = 0;

21 iàĞ
max
 >= 0x80860001 ) {

22 
	`ıuid
(0x80860001, &
dummy
, &
ıu_»v
, &
ıu_äeq
, &
ıu_æags
);

23 ià(
ıu_»v
 != 0x02000000) {

24 
	`´štk
(
KERN_INFO
 "CPU: Processor„evision %u.%u.%u.%u, %u MHz\n",

25 (
ıu_»v
 >> 24) & 0xff,

26 (
ıu_»v
 >> 16) & 0xff,

27 (
ıu_»v
 >> 8) & 0xff,

28 
ıu_»v
 & 0xff,

29 
ıu_äeq
);

32 iàĞ
max
 >= 0x80860002 ) {

33 
	`ıuid
(0x80860002, &
Ãw_ıu_»v
, &
cms_»v1
, &
cms_»v2
, &
dummy
);

34 ià(
ıu_»v
 == 0x02000000) {

35 
	`´štk
(
KERN_INFO
 "CPU: Processor„evision %08X, %u MHz\n",

36 
Ãw_ıu_»v
, 
ıu_äeq
);

38 
	`´štk
(
KERN_INFO
 "CPU: Code Morphing Software„evision %u.%u.%u-%u-%u\n",

39 (
cms_»v1
 >> 24) & 0xff,

40 (
cms_»v1
 >> 16) & 0xff,

41 (
cms_»v1
 >> 8) & 0xff,

42 
cms_»v1
 & 0xff,

43 
cms_»v2
);

45 iàĞ
max
 >= 0x80860006 ) {

46 
	`ıuid
(0x80860003,

47 (*)&
ıu_šfo
[0],

48 (*)&
ıu_šfo
[4],

49 (*)&
ıu_šfo
[8],

50 (*)&
ıu_šfo
[12]);

51 
	`ıuid
(0x80860004,

52 (*)&
ıu_šfo
[16],

53 (*)&
ıu_šfo
[20],

54 (*)&
ıu_šfo
[24],

55 (*)&
ıu_šfo
[28]);

56 
	`ıuid
(0x80860005,

57 (*)&
ıu_šfo
[32],

58 (*)&
ıu_šfo
[36],

59 (*)&
ıu_šfo
[40],

60 (*)&
ıu_šfo
[44]);

61 
	`ıuid
(0x80860006,

62 (*)&
ıu_šfo
[48],

63 (*)&
ıu_šfo
[52],

64 (*)&
ıu_šfo
[56],

65 (*)&
ıu_šfo
[60]);

66 
ıu_šfo
[64] = '\0';

67 
	`´štk
(
KERN_INFO
 "CPU: %s\n", 
ıu_šfo
);

71 
	`rdm¤
(0x80860004, 
ÿp_mask
, 
uk
);

72 
	`wrm¤
(0x80860004, ~0, 
uk
);

73 
c
->
x86_ÿ·b™y
[0] = 
	`ıuid_edx
(0x00000001);

74 
	`wrm¤
(0x80860004, 
ÿp_mask
, 
uk
);

77 
	#USER686
 (
X86_FEATURE_TSC
|
X86_FEATURE_CX8
|
X86_FEATURE_CMOV
)

	)

78 iàĞ
c
->
x86
 =ğ5 && (c->
x86_ÿ·b™y
[0] & 
USER686
) == USER686 )

79 
c
->
x86
 = 6;

80 
	}
}

82 
	$Œªsm‘a_id’tify
(
ıušfo_x86
 * 
c
)

84 
u32
 
xlvl
;

85 
	`g’”ic_id’tify
(
c
);

88 
xlvl
 = 
	`ıuid_—x
(0x80860000);

89 iàĞ(
xlvl
 & 0xffff0000) == 0x80860000 ) {

90 iàĞ
xlvl
 >= 0x80860001 )

91 
c
->
x86_ÿ·b™y
[2] = 
	`ıuid_edx
(0x80860001);

93 
	}
}

95 
ıu_dev
 
Œªsm‘a_ıu_dev
 
	g__š™d©a
 = {

96 .
c_v’dÜ
 = "Transmeta",

97 .
	gc_id’t
 = { "GenuineTMx86", "TransmetaCPU" },

98 .
	gc_š™
 = 
š™_Œªsm‘a
,

99 .
	gc_id’tify
 = 
Œªsm‘a_id’tify
,

102 
__š™
 
	$Œªsm‘a_š™_ıu
()

104 
ıu_devs
[
X86_VENDOR_TRANSMETA
] = &
Œªsm‘a_ıu_dev
;

106 
	}
}

	@crash.c

11 
	~<asm/©omic.h
>

12 
	~<asm/–f.h
>

13 
	~<asm/³rıu.h
>

14 
	~<x’/ty³s.h
>

15 
	~<x’/œq.h
>

16 
	~<asm/nmi.h
>

17 
	~<x’/¡ršg.h
>

18 
	~<x’/–f.h
>

19 
	~<x’/–fcÜe.h
>

20 
	~<x’/smp.h
>

21 
	~<x’/d–ay.h
>

22 
	~<x’/³rfc.h
>

23 
	~<x’/kexec.h
>

24 
	~<x’/sched.h
>

25 
	~<public/x’.h
>

26 
	~<asm/sh¬ed.h
>

27 
	~<asm/hvm/suµÜt.h
>

28 
	~<asm/­ic.h
>

29 
	~<asm/io_­ic.h
>

31 
©omic_t
 
	gwa™šg_fÜ_üash_i
;

32 
	güashšg_ıu
;

34 
	$üash_nmi_ÿÎback
(
ıu_u£r_»gs
 *
»gs
, 
ıu
)

40 iàĞ
ıu
 =ğ
üashšg_ıu
 )

42 
	`loÿl_œq_di§bË
();

44 
	`kexec_üash_§ve_ıu
();

46 
	`__¡İ_this_ıu
();

48 
	`©omic_dec
(&
wa™šg_fÜ_üash_i
);

51 
	`h®t
();

54 
	}
}

56 
	$nmi_shoÙdown_ıus
()

58 
m£cs
;

60 
	`loÿl_œq_di§bË
();

62 
üashšg_ıu
 = 
	`smp_´oûssÜ_id
();

63 
	`loÿl_œq_couÁ
(
üashšg_ıu
) = 0;

65 
	`©omic_£t
(&
wa™šg_fÜ_üash_i
, 
	`num_Úlše_ıus
() - 1);

67 
	`£t_nmi_ÿÎback
(
üash_nmi_ÿÎback
);

69 
	`wmb
();

71 
	`smp_£nd_nmi_®lbut£lf
();

73 
m£cs
 = 1000;

74  (
	`©omic_»ad
(&
wa™šg_fÜ_üash_i
è> 0è&& 
m£cs
 )

76 
	`md–ay
(1);

77 
m£cs
--;

80 
	`__¡İ_this_ıu
();

81 
	`di§bË_IO_APIC
();

83 
	`loÿl_œq_’abË
();

84 
	}
}

86 
	$machše_üash_shutdown
()

88 
üash_x’_šfo_t
 *
šfo
;

90 
	`nmi_shoÙdown_ıus
();

92 
šfo
 = 
	`kexec_üash_§ve_šfo
();

93 
šfo
->
x’_phys_¡¬t
 = xen_phys_start;

94 
šfo
->
dom0_pâ_to_mâ_äame_li¡_li¡
 =

95 
	`¬ch_g‘_pâ_to_mâ_äame_li¡_li¡
(
dom0
);

96 
	}
}

	@debug.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/sched.h
>

21 
	~<x’/compe.h
>

22 
	~<x’/mm.h
>

23 
	~<x’/domaš_·ge.h
>

24 
	~<x’/gue¡_acûss.h
>

25 
	~<asm/p2m.h
>

32 #ifdeà
XEN_KDB_CONFIG


33 vŞ©
kdbdbg
;

34 
kdbp
(cÚ¡ *
fmt
, ...);

35 
	#DBGP
(...è{(
kdbdbg
è? 
	`kdbp
(
__VA_ARGS__
):0;}

	)

36 
	#DBGP1
(...è{(
kdbdbg
>1è? 
	`kdbp
(
__VA_ARGS__
):0;}

	)

37 
	#DBGP2
(...è{(
kdbdbg
>2è? 
	`kdbp
(
__VA_ARGS__
):0;}

	)

39 
	#DBGP1
(...è{0;}

	)

40 
	#DBGP2
(...è{0;}

	)

43 
	tdbgva_t
;

44 
	tdbgby‹_t
;

49 
	$dbg_hvm_va2mâ
(
dbgva_t
 
vaddr
, 
domaš
 *
dp
, 
tßddr
)

51 
mâ
, 
gâ
;

52 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

53 
p2m_ty³_t
 
gâty³
;

55 
	`DBGP2
("vaddr:%lx domid:%d\n", 
vaddr
, 
dp
->
domaš_id
);

57 
gâ
 = 
	`·gšg_gva_to_gâ
(
dp
->
vıu
[0], 
vaddr
, &
pãc
);

58 iàĞ
gâ
 =ğ
INVALID_GFN
 )

60 
	`DBGP2
("kdb:bad gfn from gva_to_gfn\n");

61  
INVALID_MFN
;

64 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
dp
), 
gâ
, &
gâty³
));

65 iàĞ
	`p2m_is_»adÚly
(
gâty³
è&& 
tßddr
 )

67 
	`DBGP2
("kdb:p2m_is_»adÚly: gâty³:%x\n", 
gâty³
);

68  
INVALID_MFN
;

71 
	`DBGP2
("X: vaddr:%lx domid:%d mâ:%lx\n", 
vaddr
, 
dp
->
domaš_id
, 
mâ
);

72  
mâ
;

73 
	}
}

75 #ià
defšed
(
__x86_64__
)

91 
	$dbg_pv_va2mâ
(
dbgva_t
 
vaddr
, 
domaš
 *
dp
, 
ušt64_t
 
pgd3v®
)

93 
l4_pg’Œy_t
 
l4e
, *
l4t
;

94 
l3_pg’Œy_t
 
l3e
, *
l3t
;

95 
l2_pg’Œy_t
 
l2e
, *
l2t
;

96 
l1_pg’Œy_t
 
l1e
, *
l1t
;

97 
ü3
 = (
pgd3v®
 ?…gd3v® : 
dp
->
vıu
[0]->
¬ch
.cr3);

98 
mâ
 = 
ü3
 >> 
PAGE_SHIFT
;

100 
	`DBGP2
("vaddr:%lx domid:%d cr3:%lx…gd3:%lx\n", 
vaddr
, 
dp
->
domaš_id
,

101 
ü3
, 
pgd3v®
);

103 iàĞ
pgd3v®
 == 0 )

105 
l4t
 = 
	`mâ_to_vœt
(
mâ
);

106 
l4e
 = 
l4t
[
	`l4_bË_off£t
(
vaddr
)];

107 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

108 
	`DBGP2
("l4t:%°l4to:%lx†4e:%lx mâ:%lx\n", 
l4t
,

109 
	`l4_bË_off£t
(
vaddr
), 
l4e
, 
mâ
);

110 iàĞ!(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
) )

112 
	`DBGP1
("l4 PAGE‚Ù…»£Á. vaddr:%lx cr3:%lx\n", 
vaddr
, 
ü3
);

113  
INVALID_MFN
;

116 
l3t
 = 
	`mâ_to_vœt
(
mâ
);

117 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
vaddr
)];

118 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

119 
	`DBGP2
("l3t:%°l3to:%lx†3e:%lx mâ:%lx\n", 
l3t
,

120 
	`l3_bË_off£t
(
vaddr
), 
l3e
, 
mâ
);

121 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

123 
	`DBGP1
("l3 PAGE‚Ù…»£Á. vaddr:%lx cr3:%lx\n", 
vaddr
, 
ü3
);

124  
INVALID_MFN
;

128 
l2t
 = 
	`mâ_to_vœt
(
mâ
);

129 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
vaddr
)];

130 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

131 
	`DBGP2
("l2t:%°l2to:%lx†2e:%lx mâ:%lx\n", 
l2t
, 
	`l2_bË_off£t
(
vaddr
),

132 
l2e
, 
mâ
);

133 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) ||

134 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) )

136 
	`DBGP1
("l2 PAGE‚Ù…»£Á. vaddr:%lx cr3:%lx\n", 
vaddr
, 
ü3
);

137  
INVALID_MFN
;

139 
l1t
 = 
	`mâ_to_vœt
(
mâ
);

140 
l1e
 = 
l1t
[
	`l1_bË_off£t
(
vaddr
)];

141 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

142 
	`DBGP2
("l1t:%°l1to:%lx†1e:%lx mâ:%lx\n", 
l1t
, 
	`l1_bË_off£t
(
vaddr
),

143 
l1e
, 
mâ
);

145  
	`mâ_v®id
(
mâ
è? mâ : 
INVALID_MFN
;

146 
	}
}

152 
	$dbg_pv_va2mâ
(
dbgva_t
 
vaddr
, 
domaš
 *
dp
, 
ušt64_t
 
pgd3v®
)

154 
l3_pg’Œy_t
 
l3e
, *
l3t
;

155 
l2_pg’Œy_t
 
l2e
, *
l2t
;

156 
l1_pg’Œy_t
 
l1e
, *
l1t
;

157 
ü3
 = (
pgd3v®
 ?…gd3v® : 
dp
->
vıu
[0]->
¬ch
.cr3);

158 
mâ
 = 
ü3
 >> 
PAGE_SHIFT
;

160 
	`DBGP2
("vaddr:%lx domid:%d cr3:%lx…gd3:%lx\n", 
vaddr
, 
dp
->
domaš_id
,

161 
ü3
, 
pgd3v®
);

163 iàĞ
pgd3v®
 == 0 )

165 
l3t
 = 
	`m­_domaš_·ge
(
mâ
);

166 
l3t
 +ğ(
ü3
 & 0xFE0UL) >> 3;

167 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
vaddr
)];

168 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

169 
	`unm­_domaš_·ge
(
l3t
);

170 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

171  
INVALID_MFN
;

174 
l2t
 = 
	`m­_domaš_·ge
(
mâ
);

175 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
vaddr
)];

176 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

177 
	`unm­_domaš_·ge
(
l2t
);

178 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) ||

179 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) )

180  
INVALID_MFN
;

182 
l1t
 = 
	`m­_domaš_·ge
(
mâ
);

183 
l1e
 = 
l1t
[
	`l1_bË_off£t
(
vaddr
)];

184 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

185 
	`unm­_domaš_·ge
(
l1t
);

187  
	`mâ_v®id
(
mâ
è? mâ : 
INVALID_MFN
;

188 
	}
}

193 
	$dbg_rw_gue¡_mem
(
dbgva_t
 
addr
, 
dbgby‹_t
 *
buf
, 
Ën
, 
domaš
 *
dp
,

194 
tßddr
, 
ušt64_t
 
pgd3
)

196  
Ën
 > 0 )

198 *
va
;

199 
mâ
, 
·geút
;

201 
·geút
 = 
	`mš_t
(, 
PAGE_SIZE
 - (
addr
 & ~
PAGE_MASK
), 
Ën
);

203 
mâ
 = (
dp
->
is_hvm


204 ? 
	`dbg_hvm_va2mâ
(
addr
, 
dp
, 
tßddr
)

205 : 
	`dbg_pv_va2mâ
(
addr
, 
dp
, 
pgd3
));

206 iàĞ
mâ
 =ğ
INVALID_MFN
 )

209 
va
 = 
	`m­_domaš_·ge
(
mâ
);

210 
va
 = v¨+ (
addr
 & (
PAGE_SIZE
-1));

212 iàĞ
tßddr
 )

214 
	`memıy
(
va
, 
buf
, 
·geút
);

215 
	`·gšg_m¬k_dœty
(
dp
, 
mâ
);

219 
	`memıy
(
buf
, 
va
, 
·geút
);

222 
	`unm­_domaš_·ge
(
va
);

224 
addr
 +ğ
·geút
;

225 
buf
 +ğ
·geút
;

226 
Ën
 -ğ
·geút
;

229  
Ën
;

230 
	}
}

240 
	$dbg_rw_mem
(
dbgva_t
 
addr
, 
dbgby‹_t
 *
buf
, 
Ën
, 
domid_t
 
domid
, 
tßddr
,

241 
ušt64_t
 
pgd3
)

243 
domaš
 *
dp
 = 
	`g‘_domaš_by_id
(
domid
);

244 
hyp
 = (
domid
 =ğ
DOMID_IDLE
);

246 
	`DBGP2
("gmem:addr:%lx buf:%p†en:$%d domid:%xoaddr:%x dp:%p\n",

247 
addr
, 
buf
, 
Ën
, 
domid
, 
tßddr
, 
dp
);

248 iàĞ
hyp
 )

250 iàĞ
tßddr
 )

251 
Ën
 = 
	`__cİy_to_u£r
((*)
addr
, 
buf
,†en);

253 
Ën
 = 
	`__cİy_äom_u£r
(
buf
, (*)
addr
,†en);

255 iàĞ
dp
 )

257 iàĞ!
dp
->
is_dyšg
 )

258 
Ën
ğ
	`dbg_rw_gue¡_mem
(
addr
, 
buf
,†’, 
dp
, 
tßddr
, 
pgd3
);

259 
	`put_domaš
(
dp
);

262 
	`DBGP2
("gmem:ex™:Ën:$%d\n", 
Ën
);

263  
Ën
;

264 
	}
}

	@delay.c

13 
	~<x’/cÚfig.h
>

14 
	~<x’/d–ay.h
>

15 
	~<x’/time.h
>

16 
	~<asm/m¤.h
>

17 
	~<asm/´oûssÜ.h
>

19 
	$__ud–ay
(
u£cs
)

21 
ticks
 = 
u£cs
 * (
ıu_khz
 / 1000);

22 
s
, 
e
;

24 
	`rdtsş
(
s
);

27 
	`»p_nİ
();

28 
	`rdtsş
(
e
);

29 } (
e
-
s
è< 
ticks
);

30 
	}
}

	@dmi_scan.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/ty³s.h
>

3 
	~<x’/lib.h
>

4 
	~<x’/k”Ãl.h
>

5 
	~<x’/¡ršg.h
>

6 
	~<x’/š™.h
>

7 
	~<x’/ÿche.h
>

8 
	~<x’/aıi.h
>

9 
	~<asm/io.h
>

10 
	~<asm/sy¡em.h
>

11 
	~<x’/dmi.h
>

13 
	#bt_iÜem­
(
b
,
l
è((
u8
 *)
	`__aıi_m­_bË
(b,l))

	)

14 
	#bt_iounm­
(
b
,
l
è(()0)

	)

15 
	#memıy_äomio
 
memıy


	)

16 
	#®loc_boÙmem
(
l
è
	`xm®loc_by‹s
Ö)

	)

18 
	sdmi_h—d”


20 
u8
 
	mty³
;

21 
u8
 
	mËngth
;

22 
u16
 
	mhªdË
;

25 #undeà
DMI_DEBUG


27 #ifdeà
DMI_DEBUG


28 
	#dmi_´štk
(
x
è
´štk
 
	)
x

30 
	#dmi_´štk
(
x
)

	)

33 * 
__š™
 
	$dmi_¡ršg
(
dmi_h—d”
 *
dm
, 
u8
 
s
)

35 *
bp
=(*)
dm
;

36 
bp
+=
dm
->
Ëngth
;

37 if(!
s
)

39 
s
--;

40 
s
>0 && *
bp
)

42 
bp
+=
	`¡¾’
(bp);

43 
bp
++;

44 
s
--;

46  
bp
;

47 
	}
}

54 
__š™
 
dmi_bË
(
u32
 
ba£
, 
Ën
, 
num
, (*
decode
)(
dmi_h—d”
 *))

56 
u8
 *
buf
;

57 
dmi_h—d”
 *
dm
;

58 
u8
 *
d©a
;

59 
i
=0;

61 
buf
 = 
	`bt_iÜem­
(
ba£
, 
Ën
);

62 if(
buf
==
NULL
)

65 
d©a
 = 
buf
;

72 
i
<
num
 && 
d©a
-
buf
+(
dmi_h—d”
)<=
Ën
)

74 
dm
=(
dmi_h—d”
 *)
d©a
;

80 
d©a
+=
dm
->
Ëngth
;

81 
d©a
-
buf
<
Ën
-1 && (data[0] || data[1]))

82 
d©a
++;

83 if(
d©a
-
buf
<
Ën
-1)

84 
	`decode
(
dm
);

85 
d©a
+=2;

86 
i
++;

88 
	`bt_iounm­
(
buf
, 
Ën
);

90 
	}
}

93 
šlše
 
__š™
 
	$dmi_checksum
(
u8
 *
buf
)

95 
u8
 
sum
=0;

96 
a
;

98 
a
=0;‡<15;‡++)

99 
sum
+=
buf
[
a
];

100  (
sum
==0);

101 
	}
}

103 
__š™
 
	$dmi_g‘_bË
(
u32
 *
ba£
, u32 *
Ën
)

105 
u8
 
buf
[15];

106 
__iomem
 *
p
, *
q
;

108 
p
 = 
	`maddr_to_vœt
(0xF0000);

109 
q
 = 
p
; q <… + 0x10000; q += 16) {

110 
	`memıy_äomio
(
buf
, 
q
, 15);

111 ià(
	`memcmp
(
buf
, "_DMI_", 5)==0 && 
	`dmi_checksum
(buf)) {

112 *
ba£
=
buf
[11]<<24|buf[10]<<16|buf[9]<<8|buf[8];

113 *
Ën
=
buf
[7]<<8|buf[6];

118 
	}
}

120 
__š™
 
dmi_™”©e
((*
decode
)(
dmi_h—d”
 *))

122 
u8
 
buf
[15];

123 
__iomem
 *
p
, *
q
;

125 
p
 = 
	`maddr_to_vœt
(0xF0000);

126 
q
 = 
p
; q <… + 0x10000; q += 16) {

127 
	`memıy_äomio
(
buf
, 
q
, 15);

128 ià(
	`memcmp
(
buf
, "_DMI_", 5)==0 && 
	`dmi_checksum
(buf)) {

129 
u16
 
num
=
buf
[13]<<8|buf[12];

130 
u16
 
Ën
=
buf
[7]<<8|buf[6];

131 
u32
 
ba£
=
buf
[11]<<24|buf[10]<<16|buf[9]<<8|buf[8];

137 if(
buf
[14]!=0)

138 
	`´štk
(
KERN_INFO
 "DMI %d.%d…resent.\n",

139 
buf
[14]>>4, buf[14]&0x0F);

141 
	`´štk
(
KERN_INFO
 "DMI…resent.\n");

142 
	`dmi_´štk
((
KERN_INFO
 "%d structures occupying %d bytes.\n",

143 
num
, 
Ën
));

144 
	`dmi_´štk
((
KERN_INFO
 "DMIable‡t 0x%08X.\n",

145 
ba£
));

146 if(
	`dmi_bË
(
ba£
,
Ën
, 
num
, 
decode
)==0)

151 
	}
}

153 *
	gdmi_id’t
[
DMI_STRING_MAX
];

159 
__š™
 
	$dmi_§ve_id’t
(
dmi_h—d”
 *
dm
, 
¦Ù
, 
¡ršg
)

161 *
d
 = (*)
dm
;

162 *
p
 = 
	`dmi_¡ršg
(
dm
, 
d
[
¡ršg
]);

163 if(
p
==
NULL
 || *p == 0)

165 ià(
dmi_id’t
[
¦Ù
])

167 
dmi_id’t
[
¦Ù
] = 
	`®loc_boÙmem
(
	`¡¾’
(
p
)+1);

168 if(
dmi_id’t
[
¦Ù
])

169 
	`¡¾ıy
(
dmi_id’t
[
¦Ù
], 
p
, 
	`¡¾’
(p)+1);

171 
	`´štk
(
KERN_ERR
 "dmi_save_ident: out of memory.\n");

172 
	}
}

177 
	#dmi_bÏckli¡
 
dmi_sy¡em_id


	)

178 
	#NO_MATCH
 { 
DMI_NONE
, 
NULL
}

	)

179 
	#MATCH
 
DMI_MATCH


	)

185 
__š™
 
	$brok’_toshiba_keybßrd
(
dmi_bÏckli¡
 *
d
)

187 
	`´štk
(
KERN_WARNING
 "Toshiba with broken keyboard detected. If your keyboard sometimes generates 3 keypresses instead of one, see http://davyd.ucc.asn.au/projects/toshiba/README\n");

189 
	}
}

192 #ifdeà
CONFIG_ACPI_SLEEP


193 
__š™
 
	$»£t_videomode_aá”_s3
(
dmi_bÏckli¡
 *
d
)

196 
aıi_video_æags
 |= 2;

198 
	}
}

202 #ifdef 
CONFIG_ACPI_BOOT


203 
__š™
 
__©Œibu‹__
((
unu£d
)è
	$dmi_di§bË_aıi
(
dmi_bÏckli¡
 *
d
)

205 ià(!
aıi_fÜû
) {

206 
	`´štk
(
KERN_NOTICE
 "% d‘eùed:‡ı˜off\n",
d
->
id’t
);

207 
	`di§bË_aıi
();

209 
	`´štk
(
KERN_NOTICE


213 
	}
}

218 
__š™
 
__©Œibu‹__
((
unu£d
)è
	$fÜû_aıi_ht
(
dmi_bÏckli¡
 *
d
)

220 ià(!
aıi_fÜû
) {

221 
	`´štk
(
KERN_NOTICE
 "% d‘eùed: fÜû u£ oàaıi=ht\n", 
d
->
id’t
);

222 
	`di§bË_aıi
();

223 
aıi_ht
 = 1;

225 
	`´štk
(
KERN_NOTICE


229 
	}
}

232 #ifdef 
CONFIG_ACPI_PCI


233 
__š™
 
	$di§bË_aıi_œq
(
dmi_bÏckli¡
 *
d
)

235 ià(!
aıi_fÜû
) {

236 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of‡cpi=noirq\n",

237 
d
->
id’t
);

238 
	`aıi_noœq_£t
();

241 
	}
}

242 
__š™
 
	$di§bË_aıi_pci
(
dmi_bÏckli¡
 *
d
)

244 ià(!
aıi_fÜû
) {

245 
	`´štk
(
KERN_NOTICE
 "%s detected: force use of…ci=noacpi\n",

246 
d
->
id’t
);

247 
	`aıi_di§bË_pci
();

250 
	}
}

263 
__š™d©a
 
dmi_bÏckli¡
 
	gdmi_bÏckli¡
[]={

265 { 
brok’_toshiba_keybßrd
, "Toshiba Satellite 4030cdt", {

266 
MATCH
(
DMI_PRODUCT_NAME
, "S4030CDT/4.3"),

267 
NO_MATCH
, NO_MATCH, NO_MATCH

269 #ifdeà
CONFIG_ACPI_SLEEP


270 { 
»£t_videomode_aá”_s3
, "Toshiba Satellite 4030cdt", {

271 
MATCH
(
DMI_PRODUCT_NAME
, "S4030CDT/4.3"),

272 
NO_MATCH
, NO_MATCH, NO_MATCH

276 #ifdef 
CONFIG_ACPI_BOOT


286 { 
dmi_di§bË_aıi
, "IBM Thinkpad", {

287 
MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

288 
MATCH
(
DMI_BOARD_NAME
, "2629H1G"),

289 
NO_MATCH
, NO_MATCH }},

295 { 
fÜû_aıi_ht
, "FSC Primergy T850", {

296 
MATCH
(
DMI_SYS_VENDOR
, "FUJITSU SIEMENS"),

297 
MATCH
(
DMI_PRODUCT_NAME
, "PRIMERGY T850"),

298 
NO_MATCH
, NO_MATCH }},

300 { 
fÜû_aıi_ht
, "DELL GX240", {

301 
MATCH
(
DMI_BOARD_VENDOR
, "Dell Computer Corporation"),

302 
MATCH
(
DMI_BOARD_NAME
, "OptiPlex GX240"),

303 
NO_MATCH
, NO_MATCH }},

305 { 
fÜû_aıi_ht
, "HP VISUALIZE NT Workstation", {

306 
MATCH
(
DMI_BOARD_VENDOR
, "Hewlett-Packard"),

307 
MATCH
(
DMI_PRODUCT_NAME
, "HP VISUALIZE NT Workstation"),

308 
NO_MATCH
, NO_MATCH }},

310 { 
fÜû_aıi_ht
, "Compaq Workstation W8000", {

311 
MATCH
(
DMI_SYS_VENDOR
, "Compaq"),

312 
MATCH
(
DMI_PRODUCT_NAME
, "Workstation W8000"),

313 
NO_MATCH
, NO_MATCH }},

315 { 
fÜû_aıi_ht
, "ASUS P4B266", {

316 
MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

317 
MATCH
(
DMI_BOARD_NAME
, "P4B266"),

318 
NO_MATCH
, NO_MATCH }},

320 { 
fÜû_aıi_ht
, "ASUS P2B-DS", {

321 
MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

322 
MATCH
(
DMI_BOARD_NAME
, "P2B-DS"),

323 
NO_MATCH
, NO_MATCH }},

325 { 
fÜû_aıi_ht
, "ASUS CUR-DLS", {

326 
MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

327 
MATCH
(
DMI_BOARD_NAME
, "CUR-DLS"),

328 
NO_MATCH
, NO_MATCH }},

330 { 
fÜû_aıi_ht
, "ABIT i440BX-W83977", {

331 
MATCH
(
DMI_BOARD_VENDOR
, "ABIT <http://www.abit.com>"),

332 
MATCH
(
DMI_BOARD_NAME
, "i440BX-W83977 (BP6)"),

333 
NO_MATCH
, NO_MATCH }},

335 { 
fÜû_aıi_ht
, "IBM Bladecenter", {

336 
MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

337 
MATCH
(
DMI_BOARD_NAME
, "IBMƒServer BladeCenter HS20"),

338 
NO_MATCH
, NO_MATCH }},

340 { 
fÜû_aıi_ht
, "IBMƒServer xSeries 360", {

341 
MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

342 
MATCH
(
DMI_BOARD_NAME
, "eServer xSeries 360"),

343 
NO_MATCH
, NO_MATCH }},

345 { 
fÜû_aıi_ht
, "IBMƒserver xSeries 330", {

346 
MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

347 
MATCH
(
DMI_BOARD_NAME
, "eserver xSeries 330"),

348 
NO_MATCH
, NO_MATCH }},

350 { 
fÜû_aıi_ht
, "IBMƒserver xSeries 440", {

351 
MATCH
(
DMI_BOARD_VENDOR
, "IBM"),

352 
MATCH
(
DMI_PRODUCT_NAME
, "eserver xSeries 440"),

353 
NO_MATCH
, NO_MATCH }},

357 #ifdef 
CONFIG_ACPI_PCI


362 { 
di§bË_aıi_œq
, "ASUS A7V", {

363 
MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC"),

364 
MATCH
(
DMI_BOARD_NAME
, "<A7V>"),

366 
MATCH
(
DMI_BIOS_VERSION
, "ASUS A7V ACPI BIOS Revision 1007"),

367 
NO_MATCH
 }},

372 { 
di§bË_aıi_pci
, "ASUS PR-DLS", {

373 
MATCH
(
DMI_BOARD_VENDOR
, "ASUSTeK Computer INC."),

374 
MATCH
(
DMI_BOARD_NAME
, "PR-DLS"),

375 
MATCH
(
DMI_BIOS_VERSION
, "ASUS PR-DLS ACPI BIOS Revision 1010"),

376 
MATCH
(
DMI_BIOS_DATE
, "03/21/2003") }},

378 { 
di§bË_aıi_pci
, "Acer TravelMate 36x Laptop", {

379 
MATCH
(
DMI_SYS_VENDOR
, "Acer"),

380 
MATCH
(
DMI_PRODUCT_NAME
, "TravelMate 360"),

381 
NO_MATCH
, NO_MATCH

386 { 
NULL
, }

395 
__š™
 
	$dmi_decode
(
dmi_h—d”
 *
dm
)

397 #ifdeà
DMI_DEBUG


398 
u8
 *
d©a
 = (u8 *)
dm
;

401 
dm
->
ty³
)

404 
	`dmi_´štk
(("BIOS Vendor: %s\n",

405 
	`dmi_¡ršg
(
dm
, 
d©a
[4])));

406 
	`dmi_§ve_id’t
(
dm
, 
DMI_BIOS_VENDOR
, 4);

407 
	`dmi_´štk
(("BIOS Version: %s\n",

408 
	`dmi_¡ršg
(
dm
, 
d©a
[5])));

409 
	`dmi_§ve_id’t
(
dm
, 
DMI_BIOS_VERSION
, 5);

410 
	`dmi_´štk
(("BIOS Release: %s\n",

411 
	`dmi_¡ršg
(
dm
, 
d©a
[8])));

412 
	`dmi_§ve_id’t
(
dm
, 
DMI_BIOS_DATE
, 8);

415 
	`dmi_´štk
(("System Vendor: %s\n",

416 
	`dmi_¡ršg
(
dm
, 
d©a
[4])));

417 
	`dmi_§ve_id’t
(
dm
, 
DMI_SYS_VENDOR
, 4);

418 
	`dmi_´štk
(("Product Name: %s\n",

419 
	`dmi_¡ršg
(
dm
, 
d©a
[5])));

420 
	`dmi_§ve_id’t
(
dm
, 
DMI_PRODUCT_NAME
, 5);

421 
	`dmi_´štk
(("Version: %s\n",

422 
	`dmi_¡ršg
(
dm
, 
d©a
[6])));

423 
	`dmi_§ve_id’t
(
dm
, 
DMI_PRODUCT_VERSION
, 6);

424 
	`dmi_´štk
(("Serial Number: %s\n",

425 
	`dmi_¡ršg
(
dm
, 
d©a
[7])));

428 
	`dmi_´štk
(("Board Vendor: %s\n",

429 
	`dmi_¡ršg
(
dm
, 
d©a
[4])));

430 
	`dmi_§ve_id’t
(
dm
, 
DMI_BOARD_VENDOR
, 4);

431 
	`dmi_´štk
(("Board Name: %s\n",

432 
	`dmi_¡ršg
(
dm
, 
d©a
[5])));

433 
	`dmi_§ve_id’t
(
dm
, 
DMI_BOARD_NAME
, 5);

434 
	`dmi_´štk
(("Board Version: %s\n",

435 
	`dmi_¡ršg
(
dm
, 
d©a
[6])));

436 
	`dmi_§ve_id’t
(
dm
, 
DMI_BOARD_VERSION
, 6);

439 
	}
}

441 
__š™
 
	$dmi_sÿn_machše
()

443 
”r
 = 
	`dmi_™”©e
(
dmi_decode
);

444 if(
”r
 == 0)

445 
	`dmi_check_sy¡em
(
dmi_bÏckli¡
);

447 
	`´štk
(
KERN_INFO
 "DMI‚ot…resent.\n");

448 
	}
}

459 
	$dmi_check_sy¡em
(
dmi_sy¡em_id
 *
li¡
)

461 
i
, 
couÁ
 = 0;

462 
dmi_sy¡em_id
 *
d
 = 
li¡
;

464 
d
->
id’t
) {

465 
i
 = 0; i < 
	`ARRAY_SIZE
(
d
->
m©ches
); i++) {

466 
s
 = 
d
->
m©ches
[
i
].
¦Ù
;

467 ià(
s
 =ğ
DMI_NONE
)

469 ià(
dmi_id’t
[
s
] && 
	`¡r¡r
(dmi_id’t[s], 
d
->
m©ches
[
i
].
sub¡r
))

472 
ç
;

474 ià(
d
->
ÿÎback
 && d->
	`ÿÎback
(d))

476 
couÁ
++;

477 
ç
: 
d
++;

480  
couÁ
;

481 
	}
}

483 
EXPORT_SYMBOL
(
dmi_check_sy¡em
);

492 * 
	$dmi_g‘_sy¡em_šfo
(
f›ld
)

494  
dmi_id’t
[
f›ld
];

495 
	}
}

497 
EXPORT_SYMBOL
(
dmi_g‘_sy¡em_šfo
);

	@domain.c

14 
	~<x’/cÚfig.h
>

15 
	~<x’/š™.h
>

16 
	~<x’/lib.h
>

17 
	~<x’/”ºo.h
>

18 
	~<x’/sched.h
>

19 
	~<x’/domaš.h
>

20 
	~<x’/smp.h
>

21 
	~<x’/d–ay.h
>

22 
	~<x’/soáœq.h
>

23 
	~<x’/g¿Á_bË.h
>

24 
	~<x’/ioÿp.h
>

25 
	~<x’/k”Ãl.h
>

26 
	~<x’/muÉiÿÎ.h
>

27 
	~<x’/œq.h
>

28 
	~<x’/ev’t.h
>

29 
	~<x’/cÚsŞe.h
>

30 
	~<x’/³rıu.h
>

31 
	~<x’/com·t.h
>

32 
	~<x’/aıi.h
>

33 
	~<x’/pci.h
>

34 
	~<x’/·gšg.h
>

35 
	~<x’/ıu.h
>

36 
	~<x’/wa™.h
>

37 
	~<public/sysùl.h
>

38 
	~<asm/»gs.h
>

39 
	~<asm/mc146818¹c.h
>

40 
	~<asm/sy¡em.h
>

41 
	~<asm/io.h
>

42 
	~<asm/´oûssÜ.h
>

43 
	~<asm/desc.h
>

44 
	~<asm/i387.h
>

45 
	~<asm/mp¥ec.h
>

46 
	~<asm/ldt.h
>

47 
	~<asm/hy³rÿÎ.h
>

48 
	~<asm/hvm/hvm.h
>

49 
	~<asm/hvm/suµÜt.h
>

50 
	~<asm/debug»g.h
>

51 
	~<asm/m¤.h
>

52 
	~<asm/Œ­s.h
>

53 
	~<asm/nmi.h
>

54 
	~<asm/mû.h
>

55 
	~<x’/numa.h
>

56 
	~<x’/iommu.h
>

57 #ifdeà
CONFIG_COMPAT


58 
	~<com·t/vıu.h
>

60 
	~<mši.h
>

62 
DEFINE_PER_CPU
(
vıu
 *, 
cu¼_vıu
);

63 
DEFINE_PER_CPU
(, 
ü4
);

65 
deçuÉ_idË
();

66 
deçuÉ_d—d_idË
();

67 (*
pm_idË
è(è
__»ad_mo¡ly
 = 
deçuÉ_idË
;

68 (*
d—d_idË
è(è
__»ad_mo¡ly
 = 
deçuÉ_d—d_idË
;

70 
	`·¿vœt_ùxt_sw™ch_äom
(
vıu
 *
v
);

71 
	`·¿vœt_ùxt_sw™ch_to
(
vıu
 *
v
);

73 
	`vıu_de¡roy_·g‘abËs
(
vıu
 *
v
);

75 
	$cÚtšue_idË_domaš
(
vıu
 *
v
)

77 
	`»£t_¡ack_ªd_jump
(
idË_loİ
);

78 
	}
}

80 
	$cÚtšue_nÚidË_domaš
(
vıu
 *
v
)

82 
	`check_wakeup_äom_wa™
();

83 
	`»£t_¡ack_ªd_jump
(
»t_äom_šŒ
);

84 
	}
}

86 
	$deçuÉ_idË
()

88 
	`loÿl_œq_di§bË
();

89 iàĞ
	`ıu_is_h®bË
(
	`smp_´oûssÜ_id
()) )

90 
	`§ã_h®t
();

92 
	`loÿl_œq_’abË
();

93 
	}
}

95 
	$deçuÉ_d—d_idË
()

102 
	`wbšvd
();

104 
	`h®t
();

105 
	}
}

107 
	$¶ay_d—d
()

109 
	`loÿl_œq_di§bË
();

120 
	`ıu_ex™_ş—r
(
	`smp_´oûssÜ_id
());

122 (*
d—d_idË
)();

123 
	}
}

125 
	$idË_loİ
()

129 iàĞ
	`ıu_is_ofæše
(
	`smp_´oûssÜ_id
()) )

130 
	`¶ay_d—d
();

131 (*
pm_idË
)();

132 
	`do_skËt
();

133 
	`do_soáœq
();

135 
	}
}

137 
	$¡¬tup_ıu_idË_loİ
()

139 
vıu
 *
v
 = 
cu¼’t
;

141 
	`ASSERT
(
	`is_idË_vıu
(
v
));

142 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
v
->
domaš
->
domaš_dœty_ıumask
);

143 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
v
->
vıu_dœty_ıumask
);

145 
	`»£t_¡ack_ªd_jump
(
idË_loİ
);

146 
	}
}

148 
	$dump_·geäame_šfo
(
domaš
 *
d
)

150 
·ge_šfo
 *
·ge
;

152 
	`´štk
("MemÜy…age b–ÚgšgØdomaš %u:\n", 
d
->
domaš_id
);

154 iàĞ
d
->
tÙ_·ges
 >= 10 )

156 
	`´štk
(" DomPage†istoo†ongo display\n");

160 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

161 
	`·ge_li¡_fÜ_—ch
 ( 
·ge
, &
d
->
·ge_li¡
 )

163 
	`´štk
(" DomPag%p: caf=%08lx,af=%" 
PRty³_šfo
 "\n",

164 
	`_p
(
	`·ge_to_mâ
(
·ge
)),

165 
·ge
->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

167 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

170 iàĞ
	`is_hvm_domaš
(
d
) )

172 
	`p2m_pod_dump_d©a
(
	`p2m_g‘_ho¡p2m
(
d
));

175 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

176 
	`·ge_li¡_fÜ_—ch
 ( 
·ge
, &
d
->
x’·ge_li¡
 )

178 
	`´štk
(" X’Pag%p: caf=%08lx,af=%" 
PRty³_šfo
 "\n",

179 
	`_p
(
	`·ge_to_mâ
(
·ge
)),

180 
·ge
->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

182 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

183 
	}
}

185 
domaš
 *
	$®loc_domaš_¡ruù
()

187 
domaš
 *
d
;

192 
b™s
 = 32 + 
PAGE_SHIFT
;

194 #ifdeà
__x86_64__


195 
b™s
 +ğ
pâ_pdx_hŞe_shiá
;

197 
d
 = 
	`®loc_x’h—p_·ges
(
	`g‘_Üd”_äom_by‹s
((*d)), 
	`MEMF_b™s
(
b™s
));

198 iàĞ
d
 !ğ
NULL
 )

199 
	`mem£t
(
d
, 0, (*d));

200  
d
;

201 
	}
}

203 
	$ä“_domaš_¡ruù
(
domaš
 *
d
)

205 
	`lock_´ofe_d”egi¡”_¡ruù
(
LOCKPROF_TYPE_PERDOM
, 
d
);

206 
	`ä“_x’h—p_·ges
(
d
, 
	`g‘_Üd”_äom_by‹s
((*d)));

207 
	}
}

209 
vıu
 *
	$®loc_vıu_¡ruù
()

211 
vıu
 *
v
;

218 
v
 = 
	`®loc_x’h—p_·ges
(
	`g‘_Üd”_äom_by‹s
((*v)), 
	`MEMF_b™s
(32));

219 iàĞ
v
 !ğ
NULL
 )

220 
	`mem£t
(
v
, 0, (*v));

221  
v
;

222 
	}
}

224 
	$ä“_vıu_¡ruù
(
vıu
 *
v
)

226 
	`ä“_x’h—p_·ges
(
v
, 
	`g‘_Üd”_äom_by‹s
((*v)));

227 
	}
}

229 #ifdeà
__x86_64__


231 
	$£tup_com·t_l4
(
vıu
 *
v
)

233 
·ge_šfo
 *
pg
;

234 
l4_pg’Œy_t
 *
l4b
;

235 
rc
;

237 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`vıu_to_node
(
v
)));

238 iàĞ
pg
 =ğ
NULL
 )

239  -
ENOMEM
;

241 
rc
 = 
	`£tup_com·t_¬g_xÏt
(
v
);

242 iàĞ
rc
 )

244 
	`ä“_domh—p_·ge
(
pg
);

245  
rc
;

249 
pg
->
u
.
šu£
.
ty³_šfo
 = 
PGT_l4_·ge_bË
|
PGT_v®id©ed
|1;

251 
l4b
 = 
	`·ge_to_vœt
(
pg
);

252 
	`cİy_·ge
(
l4b
, 
idË_pg_bË
);

253 
l4b
[0] = 
	`l4e_em±y
();

254 
l4b
[
	`l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

255 
	`l4e_äom_·ge
(
pg
, 
__PAGE_HYPERVISOR
);

256 
l4b
[
	`l4_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

257 
	`l4e_äom_·ddr
(
	`__·
(
v
->
domaš
->
¬ch
.
mm_³rdomaš_l3
),

258 
__PAGE_HYPERVISOR
);

260 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_·ge
(
pg
);

261 
v
->
¬ch
.
gue¡_bË_u£r
 = v->¬ch.
gue¡_bË
;

264 
	}
}

266 
	$»Ëa£_com·t_l4
(
vıu
 *
v
)

268 
	`ä“_com·t_¬g_xÏt
(
v
);

269 
	`ä“_domh—p_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

270 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

271 
v
->
¬ch
.
gue¡_bË_u£r
 = 
	`·g‘abË_nuÎ
();

272 
	}
}

274 
šlše
 
	$may_sw™ch_mode
(
domaš
 *
d
)

276  (!
	`is_hvm_domaš
(
d
è&& (d->
tÙ_·ges
 == 0));

277 
	}
}

279 
	$sw™ch_Çtive
(
domaš
 *
d
)

281 
vıuid
;

283 iàĞ
d
 =ğ
NULL
 )

284  -
EINVAL
;

285 iàĞ!
	`may_sw™ch_mode
(
d
) )

286  -
EACCES
;

287 iàĞ!
	`is_pv_32Ú64_domaš
(
d
) )

290 
d
->
¬ch
.
is_32b™_pv
 = d->¬ch.
has_32b™_shšfo
 = 0;

292  
vıuid
 = 0; vıuid < 
d
->
max_vıus
; vcpuid++ )

294 ià(
d
->
vıu
[
vıuid
])

295 
	`»Ëa£_com·t_l4
(
d
->
vıu
[
vıuid
]);

299 
	}
}

301 
	$sw™ch_com·t
(
domaš
 *
d
)

303 
vıuid
;

305 iàĞ
d
 =ğ
NULL
 )

306  -
EINVAL
;

307 iàĞ!
	`may_sw™ch_mode
(
d
) )

308  -
EACCES
;

309 iàĞ
	`is_pv_32Ú64_domaš
(
d
) )

312 
d
->
¬ch
.
is_32b™_pv
 = d->¬ch.
has_32b™_shšfo
 = 1;

314  
vıuid
 = 0; vıuid < 
d
->
max_vıus
; vcpuid++ )

316 iàĞ(
d
->
vıu
[
vıuid
] !ğ
NULL
) &&

317 (
	`£tup_com·t_l4
(
d
->
vıu
[
vıuid
]) != 0) )

318 
undo_ªd_ç
;

321 
	`domaš_£t_®loc_b™size
(
d
);

325 
undo_ªd_ç
:

326 
d
->
¬ch
.
is_32b™_pv
 = d->¬ch.
has_32b™_shšfo
 = 0;

327  
vıuid
-- != 0 )

329 iàĞ
d
->
vıu
[
vıuid
] !ğ
NULL
 )

330 
	`»Ëa£_com·t_l4
(
d
->
vıu
[
vıuid
]);

332  -
ENOMEM
;

333 
	}
}

336 
	#£tup_com·t_l4
(
v
è0

	)

337 
	#»Ëa£_com·t_l4
(
v
è(()0)

	)

340 
	$vıu_š™Ÿli£
(
vıu
 *
v
)

342 
domaš
 *
d
 = 
v
->domain;

343 
rc
;

345 
v
->
¬ch
.
vıu_šfo_mâ
 = 
INVALID_MFN
;

347 
v
->
¬ch
.
æags
 = 
TF_k”Ãl_mode
;

349 #ià
	`defšed
(
__i386__
)

350 
	`m­ÿche_vıu_š™
(
v
);

353 
idx
 = 
	`³rdomaš_±_pgidx
(
v
);

354 
·ge_šfo
 *
pg
;

356 iàĞ!
	`³rdomaš_±_·ge
(
d
, 
idx
) )

358 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`vıu_to_node
(
v
)));

359 iàĞ!
pg
 )

360  -
ENOMEM
;

361 
	`ş—r_·ge
(
	`·ge_to_vœt
(
pg
));

362 
	`³rdomaš_±_·ge
(
d
, 
idx
èğ
pg
;

363 
d
->
¬ch
.
mm_³rdomaš_l2
[
	`l2_bË_off£t
(
PERDOMAIN_VIRT_START
)+
idx
]

364 ğ
	`l2e_äom_·ge
(
pg
, 
__PAGE_HYPERVISOR
);

369 
	`·e_l3_ÿche_š™
(&
v
->
¬ch
.
·e_l3_ÿche
);

371 
	`·gšg_vıu_š™
(
v
);

373 
v
->
¬ch
.
³rdomaš_±es
 = 
	`³rdomaš_±es
(
d
, v);

375 
	`¥š_lock_š™
(&
v
->
¬ch
.
shadow_ldt_lock
);

377 iàĞ(
rc
 = 
	`x§ve_®loc_§ve_¬—
(
v
)) != 0 )

378  
rc
;

380 iàĞ
	`is_hvm_domaš
(
d
) )

382 iàĞ(
rc
 = 
	`hvm_vıu_š™Ÿli£
(
v
)) != 0 )

383 
	`x§ve_ä“_§ve_¬—
(
v
);

384  
rc
;

388 iàĞ!
	`is_idË_domaš
(
d
) )

389 
v
->
³riodic_³riod
 = 
	`MILLISECS
(10);

392 iàĞ!
	`is_idË_domaš
(
d
è&& (
v
->
vıu_id
 == 0) )

393 
	`p™_š™
(
v
, 
ıu_khz
);

395 
v
->
¬ch
.
scheduË_
 = 
cÚtšue_nÚidË_domaš
;

396 
v
->
¬ch
.
ùxt_sw™ch_äom
 = 
·¿vœt_ùxt_sw™ch_äom
;

397 
v
->
¬ch
.
ùxt_sw™ch_to
 = 
·¿vœt_ùxt_sw™ch_to
;

399 iàĞ
	`is_idË_domaš
(
d
) )

401 
v
->
¬ch
.
scheduË_
 = 
cÚtšue_idË_domaš
;

402 
v
->
¬ch
.
ü3
 = 
	`__·
(
idË_pg_bË
);

405 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] =

406 
	`»®_ü4_to_pv_gue¡_ü4
(
mmu_ü4_ã©u»s
);

408 
rc
 = 
	`is_pv_32Ú64_vıu
(
v
è? 
	`£tup_com·t_l4
(v) : 0;

409 iàĞ
rc
 )

410 
	`x§ve_ä“_§ve_¬—
(
v
);

412  
rc
;

413 
	}
}

415 
	$vıu_de¡roy
(
vıu
 *
v
)

417 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

418 
	`»Ëa£_com·t_l4
(
v
);

420 
	`x§ve_ä“_§ve_¬—
(
v
);

422 iàĞ
	`is_hvm_vıu
(
v
) )

423 
	`hvm_vıu_de¡roy
(
v
);

424 
	}
}

426 
	$¬ch_domaš_ü—‹
(
domaš
 *
d
, 
domü_æags
)

428 #ifdeà
__x86_64__


429 
·ge_šfo
 *
pg
;

431 
pd±_Üd”
;

433 
i
, 
·gšg_š™Ÿli£d
 = 0;

434 
rc
 = -
ENOMEM
;

436 
d
->
¬ch
.
hvm_domaš
.
h­_’abËd
 =

437 
	`is_hvm_domaš
(
d
) &&

438 
hvm_funcs
.
h­_suµÜ‹d
 &&

439 (
domü_æags
 & 
DOMCRF_h­
);

440 
d
->
¬ch
.
hvm_domaš
.
mem_sh¬šg_’abËd
 = 0;

442 
d
->
¬ch
.
s3_š‹gr™y
 = !!(
domü_æags
 & 
DOMCRF_s3_š‹gr™y
);

444 
	`INIT_LIST_HEAD
(&
d
->
¬ch
.
pdev_li¡
);

446 
d
->
¬ch
.
»lmem
 = 
RELMEM_nÙ_¡¬‹d
;

447 
	`INIT_PAGE_LIST_HEAD
(&
d
->
¬ch
.
»lmem_li¡
);

449 #ià
	`defšed
(
__i386__
)

451 
pd±_Üd”
 = 
	`g‘_Üd”_äom_by‹s
(
PDPT_L1_ENTRIES
 * (
l1_pg’Œy_t
));

452 
d
->
¬ch
.
mm_³rdomaš_±
 = 
	`®loc_x’h—p_·ges
(
pd±_Üd”
, 0);

453 iàĞ
d
->
¬ch
.
mm_³rdomaš_±
 =ğ
NULL
 )

454 
ç
;

455 
	`mem£t
(
d
->
¬ch
.
mm_³rdomaš_±
, 0, 
PAGE_SIZE
 << 
pd±_Üd”
);

457 
	`m­ÿche_domaš_š™
(
d
);

461 
	`BUILD_BUG_ON
(
PDPT_L2_ENTRIES
 * (*
d
->
¬ch
.
mm_³rdomaš_±_·ges
)

462 !ğ
PAGE_SIZE
);

463 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

464 iàĞ!
pg
 )

465 
ç
;

466 
d
->
¬ch
.
mm_³rdomaš_±_·ges
 = 
	`·ge_to_vœt
(
pg
);

467 
	`ş—r_·ge
(
d
->
¬ch
.
mm_³rdomaš_±_·ges
);

469 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

470 iàĞ
pg
 =ğ
NULL
 )

471 
ç
;

472 
d
->
¬ch
.
mm_³rdomaš_l2
 = 
	`·ge_to_vœt
(
pg
);

473 
	`ş—r_·ge
(
d
->
¬ch
.
mm_³rdomaš_l2
);

475 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

476 iàĞ
pg
 =ğ
NULL
 )

477 
ç
;

478 
d
->
¬ch
.
mm_³rdomaš_l3
 = 
	`·ge_to_vœt
(
pg
);

479 
	`ş—r_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
);

480 
d
->
¬ch
.
mm_³rdomaš_l3
[
	`l3_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

481 
	`l3e_äom_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l2
),

482 
__PAGE_HYPERVISOR
);

484 
	`HYPERVISOR_COMPAT_VIRT_START
(
d
) =

485 
	`is_hvm_domaš
(
d
è? ~0u : 
__HYPERVISOR_COMPAT_VIRT_START
;

489 iàĞ(
rc
 = 
	`·gšg_domaš_š™
(
d
, 
domü_æags
)) != 0 )

490 
ç
;

491 
·gšg_š™Ÿli£d
 = 1;

493 iàĞ!
	`is_idË_domaš
(
d
) )

495 
d
->
¬ch
.
iİÜt_ÿps
 =

496 
	`¿nge£t_Ãw
(
d
, "I/O PÜts", 
RANGESETF_´‘ty´št_hex
);

497 
rc
 = -
ENOMEM
;

498 iàĞ
d
->
¬ch
.
iİÜt_ÿps
 =ğ
NULL
 )

499 
ç
;

505 iàĞ(
d
->
sh¬ed_šfo
 = 
	`®loc_x’h—p_·ges
(0, 
	`MEMF_b™s
(32))è=ğ
NULL
 )

506 
ç
;

508 
	`ş—r_·ge
(
d
->
sh¬ed_šfo
);

509 
	`sh¬e_x’_·ge_w™h_gue¡
(

510 
	`vœt_to_·ge
(
d
->
sh¬ed_šfo
), d, 
XENSHARE_wr™abË
);

512 
d
->
¬ch
.
pœq_œq
 = 
	`xm®loc_¬¿y
(, d->
Ä_pœqs
);

513 iàĞ!
d
->
¬ch
.
pœq_œq
 )

514 
ç
;

515 
	`mem£t
(
d
->
¬ch
.
pœq_œq
, 0,

516 
d
->
Ä_pœqs
 * (*d->
¬ch
.
pœq_œq
));

518 
d
->
¬ch
.
œq_pœq
 = 
	`xm®loc_¬¿y
(, 
Ä_œqs
);

519 iàĞ!
d
->
¬ch
.
œq_pœq
 )

520 
ç
;

521 
	`mem£t
(
d
->
¬ch
.
œq_pœq
, 0,

522 
Ä_œqs
 * (*
d
->
¬ch
.
œq_pœq
));

524  
i
 = 1; 
	`¶©fÜm_Ëgacy_œq
(i); ++i )

525 iàĞ!
	`IO_APIC_IRQ
(
i
) )

526 
d
->
¬ch
.
œq_pœq
[
i
] = d->¬ch.
pœq_œq
[i] = i;

528 iàĞ
	`is_hvm_domaš
(
d
) )

530 
d
->
¬ch
.
pœq_emuœq
 = 
	`xm®loc_¬¿y
(, d->
Ä_pœqs
);

531 
d
->
¬ch
.
emuœq_pœq
 = 
	`xm®loc_¬¿y
(, 
Ä_œqs
);

532 iàĞ!
d
->
¬ch
.
pœq_emuœq
 || !d->¬ch.
emuœq_pœq
 )

533 
ç
;

534 
i
 = 0; i < 
d
->
Ä_pœqs
; i++)

535 
d
->
¬ch
.
pœq_emuœq
[
i
] = 
IRQ_UNBOUND
;

536 
i
 = 0; i < 
Ä_œqs
; i++)

537 
d
->
¬ch
.
emuœq_pœq
[
i
] = 
IRQ_UNBOUND
;

541 iàĞ(
rc
 = 
	`iommu_domaš_š™
(
d
)) != 0 )

542 
ç
;

545 
	`vmû_š™_m¤
(
d
);

548 iàĞ
	`is_hvm_domaš
(
d
) )

550 iàĞ(
rc
 = 
	`hvm_domaš_š™Ÿli£
(
d
)) != 0 )

552 
	`iommu_domaš_de¡roy
(
d
);

553 
ç
;

559 
d
->
¬ch
.
is_32b™_pv
 = d->¬ch.
has_32b™_shšfo
 =

560 (
CONFIG_PAGING_LEVELS
 != 4);

563 
	`mem£t
(
d
->
¬ch
.
ıuids
, 0, (d->arch.cpuids));

564  
i
 = 0; i < 
MAX_CPUID_INPUT
; i++ )

566 
d
->
¬ch
.
ıuids
[
i
].
šput
[0] = 
XEN_CPUID_INPUT_UNUSED
;

567 
d
->
¬ch
.
ıuids
[
i
].
šput
[1] = 
XEN_CPUID_INPUT_UNUSED
;

571 
	`tsc_£t_šfo
(
d
, 
TSC_MODE_DEFAULT
, 0UL, 0, 0);

572 
	`¥š_lock_š™
(&
d
->
¬ch
.
vtsc_lock
);

576 
ç
:

577 
d
->
is_dyšg
 = 
DOMDYING_d—d
;

578 
	`vmû_de¡roy_m¤
(
d
);

579 
	`xä“
(
d
->
¬ch
.
pœq_œq
);

580 
	`xä“
(
d
->
¬ch
.
œq_pœq
);

581 
	`xä“
(
d
->
¬ch
.
pœq_emuœq
);

582 
	`xä“
(
d
->
¬ch
.
emuœq_pœq
);

583 
	`ä“_x’h—p_·ge
(
d
->
sh¬ed_šfo
);

584 iàĞ
·gšg_š™Ÿli£d
 )

585 
	`·gšg_fš®_‹¬down
(
d
);

586 #ifdeà
__x86_64__


587 iàĞ
d
->
¬ch
.
mm_³rdomaš_l2
 )

588 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l2
));

589 iàĞ
d
->
¬ch
.
mm_³rdomaš_l3
 )

590 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
));

591 iàĞ
d
->
¬ch
.
mm_³rdomaš_±_·ges
 )

592 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_±_·ges
));

594 
	`ä“_x’h—p_·ges
(
d
->
¬ch
.
mm_³rdomaš_±
, 
pd±_Üd”
);

596  
rc
;

597 
	}
}

599 
	$¬ch_domaš_de¡roy
(
domaš
 *
d
)

601 #ifdeà
__x86_64__


602 
i
;

605 iàĞ
	`is_hvm_domaš
(
d
) )

606 
	`hvm_domaš_de¡roy
(
d
);

608 
	`vmû_de¡roy_m¤
(
d
);

609 
	`pci_»Ëa£_deviûs
(
d
);

610 
	`ä“_domaš_pœqs
(
d
);

611 iàĞ!
	`is_idË_domaš
(
d
) )

612 
	`iommu_domaš_de¡roy
(
d
);

614 
	`·gšg_fš®_‹¬down
(
d
);

616 #ifdeà
__i386__


617 
	`ä“_x’h—p_·ges
(

618 
d
->
¬ch
.
mm_³rdomaš_±
,

619 
	`g‘_Üd”_äom_by‹s
(
PDPT_L1_ENTRIES
 * (
l1_pg’Œy_t
)));

621  
i
 = 0; i < 
PDPT_L2_ENTRIES
; ++i )

623 iàĞ
	`³rdomaš_±_·ge
(
d
, 
i
) )

624 
	`ä“_domh—p_·ge
(
	`³rdomaš_±_·ge
(
d
, 
i
));

626 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_±_·ges
));

627 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l2
));

628 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
));

631 
	`ä“_x’h—p_·ge
(
d
->
sh¬ed_šfo
);

632 
	`xä“
(
d
->
¬ch
.
pœq_œq
);

633 
	`xä“
(
d
->
¬ch
.
œq_pœq
);

634 
	`xä“
(
d
->
¬ch
.
pœq_emuœq
);

635 
	`xä“
(
d
->
¬ch
.
emuœq_pœq
);

636 
	}
}

638 
	$pv_gue¡_ü4_fixup
(cÚ¡ 
vıu
 *
v
, 
gue¡_ü4
)

640 
hv_ü4_mask
, 
hv_ü4
 = 
	`»®_ü4_to_pv_gue¡_ü4
(
	`»ad_ü4
());

642 
hv_ü4_mask
 = ~
X86_CR4_TSD
;

643 iàĞ
ıu_has_de
 )

644 
hv_ü4_mask
 &ğ~
X86_CR4_DE
;

645 iàĞ
ıu_has_fsgsba£
 && !
	`is_pv_32b™_domaš
(
v
->
domaš
) )

646 
hv_ü4_mask
 &ğ~
X86_CR4_FSGSBASE
;

647 iàĞ
	`x§ve_’abËd
(
v
) )

648 
hv_ü4_mask
 &ğ~
X86_CR4_OSXSAVE
;

650 iàĞ(
gue¡_ü4
 & 
hv_ü4_mask
è!ğ(
hv_ü4
 & hv_cr4_mask) )

651 
	`gd´štk
(
XENLOG_WARNING
,

653 
hv_ü4
, 
gue¡_ü4
);

655  (
hv_ü4
 & 
hv_ü4_mask
è| (
gue¡_ü4
 & ~hv_cr4_mask);

656 
	}
}

659 
	$¬ch_£t_šfo_gue¡
(

660 
vıu
 *
v
, 
vıu_gue¡_cÚ‹xt_u
 
c
)

662 
domaš
 *
d
 = 
v
->domain;

663 
ü3_pâ
 = 
INVALID_MFN
;

664 
æags
, 
ü4
;

665 
i
, 
rc
 = 0, 
com·t
;

669 
com·t
 = 
	`is_pv_32Ú64_domaš
(
d
);

671 #ifdeà
CONFIG_COMPAT


672 
	#c
(
æd
è(
com·t
 ? (
c
.
cmp
->ædè: (c.
Çt
->æd))

	)

674 
	#c
(
æd
è(
c
.
Çt
->æd)

	)

676 
æags
 = 
	`c
(flags);

678 iàĞ!
	`is_hvm_vıu
(
v
) )

680 iàĞ!
com·t
 )

682 
	`fixup_gue¡_¡ack_£ËùÜ
(
d
, 
c
.
Çt
->
u£r_»gs
.
ss
);

683 
	`fixup_gue¡_¡ack_£ËùÜ
(
d
, 
c
.
Çt
->
k”Ãl_ss
);

684 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
Çt
->
u£r_»gs
.
cs
);

685 #ifdeà
__i386__


686 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
Çt
->
ev’t_ÿÎback_cs
);

687 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
Çt
->
ç§ã_ÿÎback_cs
);

690  
i
 = 0; i < 256; i++ )

691 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
Çt
->
Œ­_ùxt
[
i
].
cs
);

694 iàĞ((
c
.
Çt
->
ldt_ba£
 & (
PAGE_SIZE
-1)) != 0) ||

695 (
c
.
Çt
->
ldt_’ts
 > 8192) ||

696 !
	`¬¿y_acûss_ok
(
c
.
Çt
->
ldt_ba£
,

697 
c
.
Çt
->
ldt_’ts
,

698 
LDT_ENTRY_SIZE
) )

699  -
EINVAL
;

701 #ifdeà
CONFIG_COMPAT


704 
	`fixup_gue¡_¡ack_£ËùÜ
(
d
, 
c
.
cmp
->
u£r_»gs
.
ss
);

705 
	`fixup_gue¡_¡ack_£ËùÜ
(
d
, 
c
.
cmp
->
k”Ãl_ss
);

706 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
cmp
->
u£r_»gs
.
cs
);

707 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
cmp
->
ev’t_ÿÎback_cs
);

708 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
cmp
->
ç§ã_ÿÎback_cs
);

710  
i
 = 0; i < 256; i++ )

711 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
c
.
cmp
->
Œ­_ùxt
[
i
].
cs
);

714 iàĞ((
c
.
cmp
->
ldt_ba£
 & (
PAGE_SIZE
-1)) != 0) ||

715 (
c
.
cmp
->
ldt_’ts
 > 8192) ||

716 !
	`com·t_¬¿y_acûss_ok
(
c
.
cmp
->
ldt_ba£
,

717 
c
.
cmp
->
ldt_’ts
,

718 
LDT_ENTRY_SIZE
) )

719  -
EINVAL
;

724 
v
->
åu_š™Ÿli£d
 = !!(
æags
 & 
VGCF_I387_VALID
);

726 
v
->
¬ch
.
æags
 &ğ~
TF_k”Ãl_mode
;

727 iàĞ(
æags
 & 
VGCF_š_k”Ãl
è|| 
	`is_hvm_vıu
(
v
) )

728 
v
->
¬ch
.
æags
 |ğ
TF_k”Ãl_mode
;

730 iàĞ!
com·t
 )

731 
	`memıy
(&
v
->
¬ch
.
gue¡_cÚ‹xt
, 
c
.
Çt
, (*c.nat));

732 #ifdeà
CONFIG_COMPAT


734 
	`XLAT_vıu_gue¡_cÚ‹xt
(&
v
->
¬ch
.
gue¡_cÚ‹xt
, 
c
.
cmp
);

737 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 |= 2;

739 iàĞ
	`is_hvm_vıu
(
v
) )

741 
	`hvm_£t_šfo_gue¡
(
v
);

742 
out
;

746 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] &ğ
X86_CR0_TS
;

747 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] |ğ
	`»ad_ü0
(è& ~
X86_CR0_TS
;

749 
	`š™_št80_dœeù_Œ­
(
v
);

752 
v
->
¬ch
.
iİl
 = (v->¬ch.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 >> 12) & 3;

753 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 &ğ~
X86_EFLAGS_IOPL
;

756 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 |ğ
X86_EFLAGS_IF
;

758 
ü4
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4];

759 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] = 
ü4
 ? 
	`pv_gue¡_ü4_fixup
(v, cr4) :

760 
	`»®_ü4_to_pv_gue¡_ü4
(
mmu_ü4_ã©u»s
);

762 
	`mem£t
(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
, 0,

763 (
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
));

764  
i
 = 0; i < 8; i++ )

765 ()
	`£t_debug»g
(
v
, 
i
, 
	`c
(
debug»g
[i]));

767 iàĞ
v
->
is_š™Ÿli£d
 )

768 
out
;

770 iàĞ
v
->
vıu_id
 == 0 )

771 
d
->
vm_assi¡
 = 
	`c
(vm_assist);

773 iàĞ!
com·t
 )

774 
rc
 = ()
	`£t_gdt
(
v
, 
c
.
Çt
->
gdt_äames
, c.Çt->
gdt_’ts
);

775 #ifdeà
CONFIG_COMPAT


778 
gdt_äames
[
	`ARRAY_SIZE
(
c
.
cmp
->gdt_frames)];

779 
i
, 
n
 = (
c
.
cmp
->
gdt_’ts
 + 511) / 512;

781 iàĞ
n
 > 
	`ARRAY_SIZE
(
c
.
cmp
->
gdt_äames
) )

782  -
EINVAL
;

783  
i
 = 0; i < 
n
; ++i )

784 
gdt_äames
[
i
] = 
c
.
cmp
->gdt_frames[i];

785 
rc
 = ()
	`£t_gdt
(
v
, 
gdt_äames
, 
c
.
cmp
->
gdt_’ts
);

788 iàĞ
rc
 != 0 )

789  
rc
;

791 iàĞ!
com·t
 )

793 
ü3_pâ
 = 
	`gmâ_to_mâ
(
d
, 
	`x’_ü3_to_pâ
(
c
.
Çt
->
ù¾»g
[3]));

795 iàĞ!
	`mâ_v®id
(
ü3_pâ
) ||

796 (
	`·gšg_mode_»fcouÁs
(
d
)

797 ? !
	`g‘_·ge
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
)

798 : !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
,

799 
PGT_ba£_·ge_bË
)) )

801 
	`de¡roy_gdt
(
v
);

802  -
EINVAL
;

805 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
ü3_pâ
);

807 #ifdeà
__x86_64__


808 iàĞ
c
.
Çt
->
ù¾»g
[1] )

810 
ü3_pâ
 = 
	`gmâ_to_mâ
(
d
, 
	`x’_ü3_to_pâ
(
c
.
Çt
->
ù¾»g
[1]));

812 iàĞ!
	`mâ_v®id
(
ü3_pâ
) ||

813 (
	`·gšg_mode_»fcouÁs
(
d
)

814 ? !
	`g‘_·ge
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
)

815 : !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
,

816 
PGT_ba£_·ge_bË
)) )

818 
ü3_pâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
);

819 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

820 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

821 
	`put_·ge
(
	`mâ_to_·ge
(
ü3_pâ
));

823 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
ü3_pâ
));

824 
	`de¡roy_gdt
(
v
);

825  -
EINVAL
;

828 
v
->
¬ch
.
gue¡_bË_u£r
 = 
	`·g‘abË_äom_pâ
(
ü3_pâ
);

830 iàĞ!(
æags
 & 
VGCF_š_k”Ãl
) )

832 
	`de¡roy_gdt
(
v
);

833  -
EINVAL
;

838 
l4_pg’Œy_t
 *
l4b
;

840 
ü3_pâ
 = 
	`gmâ_to_mâ
(
d
, 
	`com·t_ü3_to_pâ
(
c
.
cmp
->
ù¾»g
[3]));

842 iàĞ!
	`mâ_v®id
(
ü3_pâ
) ||

843 (
	`·gšg_mode_»fcouÁs
(
d
)

844 ? !
	`g‘_·ge
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
)

845 : !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
ü3_pâ
), 
d
,

846 
PGT_l3_·ge_bË
)) )

848 
	`de¡roy_gdt
(
v
);

849  -
EINVAL
;

852 
l4b
 = 
	`__va
(
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
));

853 *
l4b
 = 
	`l4e_äom_pâ
(

854 
ü3_pâ
, 
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_ACCESSED
);

858 iàĞ
v
->
vıu_id
 == 0 )

859 
	`upd©e_domaš_w®lşock_time
(
d
);

862 
v
->
is_š™Ÿli£d
 = 1;

864 iàĞ
	`·gšg_mode_’abËd
(
d
) )

865 
	`·gšg_upd©e_·gšg_modes
(
v
);

867 
	`upd©e_ü3
(
v
);

869 
out
:

870 iàĞ
æags
 & 
VGCF_Úlše
 )

871 
	`ş—r_b™
(
_VPF_down
, &
v
->
·u£_æags
);

873 
	`£t_b™
(
_VPF_down
, &
v
->
·u£_æags
);

875 #undeà
c


876 
	}
}

878 
	$¬ch_vıu_»£t
(
vıu
 *
v
)

880 iàĞ!
	`is_hvm_vıu
(
v
) )

882 
	`de¡roy_gdt
(
v
);

883 
	`vıu_de¡roy_·g‘abËs
(
v
);

887 
	`vıu_’d_shutdown_deã¼®
(
v
);

889 
	}
}

897 
	$unm­_vıu_šfo
(
vıu
 *
v
)

899 
mâ
;

901 iàĞ
v
->
¬ch
.
vıu_šfo_mâ
 =ğ
INVALID_MFN
 )

904 
mâ
 = 
v
->
¬ch
.
vıu_šfo_mâ
;

905 
	`unm­_domaš_·ge_glob®
(
v
->
vıu_šfo
);

907 
v
->
vıu_šfo
 = &
dummy_vıu_šfo
;

908 
v
->
¬ch
.
vıu_šfo_mâ
 = 
INVALID_MFN
;

910 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

911 
	}
}

920 
	$m­_vıu_šfo
(
vıu
 *
v
, 
mâ
, 
off£t
)

922 
domaš
 *
d
 = 
v
->domain;

923 *
m­pšg
;

924 
vıu_šfo_t
 *
Ãw_šfo
;

925 
i
;

927 iàĞ
off£t
 > (
PAGE_SIZE
 - (
vıu_šfo_t
)) )

928  -
EINVAL
;

930 iàĞ
v
->
¬ch
.
vıu_šfo_mâ
 !ğ
INVALID_MFN
 )

931  -
EINVAL
;

934 iàĞ(
v
 !ğ
cu¼’t
è&& !
	`‹¡_b™
(
_VPF_down
, &v->
·u£_æags
) )

935  -
EINVAL
;

937 
mâ
 = 
	`gmâ_to_mâ
(
d
, mfn);

938 iàĞ!
	`mâ_v®id
(
mâ
) ||

939 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_wr™abË_·ge
) )

940  -
EINVAL
;

942 
m­pšg
 = 
	`m­_domaš_·ge_glob®
(
mâ
);

943 iàĞ
m­pšg
 =ğ
NULL
 )

945 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

946  -
ENOMEM
;

949 
Ãw_šfo
 = (
vıu_šfo_t
 *)(
m­pšg
 + 
off£t
);

951 iàĞ
v
->
vıu_šfo
 =ğ&
dummy_vıu_šfo
 )

953 
	`mem£t
(
Ãw_šfo
, 0, (*new_info));

954 
	`__vıu_šfo
(
v
, 
Ãw_šfo
, 
evtchn_upÿÎ_mask
) = 1;

958 
	`memıy
(
Ãw_šfo
, 
v
->
vıu_šfo
, (*new_info));

961 
v
->
vıu_šfo
 = 
Ãw_šfo
;

962 
v
->
¬ch
.
vıu_šfo_mâ
 = 
mâ
;

965 
	`wmb
();

971 
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_³ndšg
) = 1;

972  
i
 = 0; i < 
	`BITS_PER_EVTCHN_WORD
(
d
); i++ )

973 
	`£t_b™
(
i
, &
	`vıu_šfo
(
v
, 
evtchn_³ndšg_£l
));

976 
	}
}

979 
¬ch_do_vıu_İ
(

980 
cmd
, 
vıu
 *
v
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

982 
rc
 = 0;

984  
cmd
 )

986 
VCPUOP_»gi¡”_run¡©e_memÜy_¬—
:

988 
vıu_»gi¡”_run¡©e_memÜy_¬—
 
¬—
;

989 
vıu_run¡©e_šfo
 
run¡©e
;

991 
rc
 = -
EFAULT
;

992 iàĞ
	`cİy_äom_gue¡
(&
¬—
, 
¬g
, 1) )

995 iàĞ!
	`gue¡_hªdË_okay
(
¬—
.
addr
.
h
, 1) )

998 
rc
 = 0;

999 
	`run¡©e_gue¡
(
v
èğ
¬—
.
addr
.
h
;

1001 iàĞ
v
 =ğ
cu¼’t
 )

1003 
	`__cİy_to_gue¡
(
	`run¡©e_gue¡
(
v
), &v->
run¡©e
, 1);

1007 
	`vıu_run¡©e_g‘
(
v
, &
run¡©e
);

1008 
	`__cİy_to_gue¡
(
	`run¡©e_gue¡
(
v
), &
run¡©e
, 1);

1014 
VCPUOP_»gi¡”_vıu_šfo
:

1016 
domaš
 *
d
 = 
v
->domain;

1017 
vıu_»gi¡”_vıu_šfo
 
šfo
;

1019 
rc
 = -
EFAULT
;

1020 iàĞ
	`cİy_äom_gue¡
(&
šfo
, 
¬g
, 1) )

1023 
	`domaš_lock
(
d
);

1024 
rc
 = 
	`m­_vıu_šfo
(
v
, 
šfo
.
mâ
, info.
off£t
);

1025 
	`domaš_uÆock
(
d
);

1035 
VCPUOP_»gi¡”_vıu_time_memÜy_¬—
:

1037 
vıu_»gi¡”_time_memÜy_¬—
 
¬—
;

1039 
rc
 = -
EFAULT
;

1040 iàĞ
	`cİy_äom_gue¡
(&
¬—
, 
¬g
, 1) )

1043 iàĞ!
	`gue¡_hªdË_okay
(
¬—
.
addr
.
h
, 1) )

1046 
rc
 = 0;

1047 
v
->
¬ch
.
time_šfo_gue¡
 = 
¬—
.
addr
.
h
;

1049 
	`fÜû_upd©e_vıu_sy¡em_time
(
v
);

1055 
VCPUOP_g‘_physid
:

1057 
vıu_g‘_physid
 
ıu_id
;

1059 
rc
 = -
EINVAL
;

1060 iàĞ!
	`is_pšÃd_vıu
(
v
) )

1063 
ıu_id
.
phys_id
 =

1064 (
ušt64_t
)
x86_ıu_to_­icid
[
v
->
vıu_id
] |

1065 ((
ušt64_t
)
	`aıi_g‘_´oûssÜ_id
(
v
->
vıu_id
) << 32);

1067 
rc
 = -
EFAULT
;

1068 iàĞ
	`cİy_to_gue¡
(
¬g
, &
ıu_id
, 1) )

1071 
rc
 = 0;

1076 
rc
 = -
ENOSYS
;

1080  
rc
;

1081 
	}
}

1083 #ifdeà
__x86_64__


1085 
	#lßd£gm’t
(
£g
,
v®ue
) ({ \

1086 
__r
 = 1; \

1087 
asm
 volatile ( \

1094 
	`_ASM_EXTABLE
(1b, 3b) \

1095 : "ô" (
__r
è: "r" (
v®ue
), "0" (__r) );\

1096 
__r
; })

	)

1103 
DEFINE_PER_CPU
(, 
dœty_£gm’t_mask
);

1104 
	#DIRTY_DS
 0x01

	)

1105 
	#DIRTY_ES
 0x02

	)

1106 
	#DIRTY_FS
 0x04

	)

1107 
	#DIRTY_GS
 0x08

	)

1108 
	#DIRTY_FS_BASE
 0x10

	)

1109 
	#DIRTY_GS_BASE_USER
 0x20

	)

1111 
	$lßd_£gm’ts
(
vıu
 *
n
)

1113 
vıu_gue¡_cÚ‹xt
 *
nùxt
 = &
n
->
¬ch
.
gue¡_cÚ‹xt
;

1114 
®l_£gs_okay
 = 1;

1115 
dœty_£gm’t_mask
, 
ıu
 = 
	`smp_´oûssÜ_id
();

1118 
dœty_£gm’t_mask
 = 
	`³r_ıu
(dœty_£gm’t_mask, 
ıu
);

1119 
	`³r_ıu
(
dœty_£gm’t_mask
, 
ıu
) = 0;

1122 iàĞ
	`uÆik–y
((
dœty_£gm’t_mask
 & 
DIRTY_DS
è| 
nùxt
->
u£r_»gs
.
ds
) )

1123 
®l_£gs_okay
 &ğ
	`lßd£gm’t
(
ds
, 
nùxt
->
u£r_»gs
.ds);

1126 iàĞ
	`uÆik–y
((
dœty_£gm’t_mask
 & 
DIRTY_ES
è| 
nùxt
->
u£r_»gs
.
es
) )

1127 
®l_£gs_okay
 &ğ
	`lßd£gm’t
(
es
, 
nùxt
->
u£r_»gs
.es);

1133 iàĞ
	`uÆik–y
((
dœty_£gm’t_mask
 & (
DIRTY_FS
 | 
DIRTY_FS_BASE
)) |

1134 
nùxt
->
u£r_»gs
.
fs
) )

1135 
®l_£gs_okay
 &ğ
	`lßd£gm’t
(
fs
, 
nùxt
->
u£r_»gs
.fs);

1141 iàĞ
	`uÆik–y
((
dœty_£gm’t_mask
 & (
DIRTY_GS
 | 
DIRTY_GS_BASE_USER
)) |

1142 
nùxt
->
u£r_»gs
.
gs
) )

1145 iàĞ(
dœty_£gm’t_mask
 & 
DIRTY_GS
è|| !
nùxt
->
gs_ba£_u£r
 )

1146 
®l_£gs_okay
 &ğ
	`lßd£gm’t
(
gs
, 
nùxt
->
u£r_»gs
.gs);

1149 iàĞ!
	`is_pv_32Ú64_domaš
(
n
->
domaš
) )

1152 iàĞ
nùxt
->
fs_ba£
 )

1153 
	`wrm¤l
(
MSR_FS_BASE
, 
nùxt
->
fs_ba£
);

1157 
	`wrm¤l
(
MSR_SHADOW_GS_BASE
, 
nùxt
->
gs_ba£_k”Ãl
);

1160 iàĞ
nùxt
->
gs_ba£_u£r
 )

1161 
	`wrm¤l
(
MSR_GS_BASE
, 
nùxt
->
gs_ba£_u£r
);

1164 iàĞ(
n
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) )

1165 
asm
 volatile ( "swapgs" );

1168 iàĞ
	`uÆik–y
(!
®l_£gs_okay
) )

1170 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1171 *
r¥
 =

1172 (
n
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) ?

1173 (*)
»gs
->
r¥
 :

1174 (*)
nùxt
->
k”Ãl_¥
;

1175 
cs_ªd_mask
, 
ræags
;

1177 iàĞ
	`is_pv_32Ú64_domaš
(
n
->
domaš
) )

1179 *
e¥
 = 
	`ršg_1
(
»gs
) ?

1180 (*)
»gs
->
r¥
 :

1181 (*)
nùxt
->
k”Ãl_¥
;

1182 
cs_ªd_mask
, 
eæags
;

1183 
»t
 = 0;

1186 
cs_ªd_mask
 = ()
»gs
->
cs
 |

1187 (()
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) << 16);

1189 
eæags
 = 
»gs
->
_eæags
 & ~
X86_EFLAGS_IF
;

1190 
eæags
 |ğ!
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) << 9;

1192 iàĞ!
	`ršg_1
(
»gs
) )

1194 
»t
 = 
	`put_u£r
(
»gs
->
ss
, 
e¥
-1);

1195 
»t
 |ğ
	`put_u£r
(
»gs
->
_e¥
, 
e¥
-2);

1196 
e¥
 -= 2;

1199 iàĞ
»t
 |

1200 
	`put_u£r
(
eæags
, 
e¥
-1) |

1201 
	`put_u£r
(
cs_ªd_mask
, 
e¥
-2) |

1202 
	`put_u£r
(
»gs
->
_e
, 
e¥
-3) |

1203 
	`put_u£r
(
nùxt
->
u£r_»gs
.
gs
, 
e¥
-4) |

1204 
	`put_u£r
(
nùxt
->
u£r_»gs
.
fs
, 
e¥
-5) |

1205 
	`put_u£r
(
nùxt
->
u£r_»gs
.
es
, 
e¥
-6) |

1206 
	`put_u£r
(
nùxt
->
u£r_»gs
.
ds
, 
e¥
-7) )

1208 
	`gd´štk
(
XENLOG_ERR
, "Error while creating compat "

1210 
	`domaš_üash
(
n
->
domaš
);

1213 iàĞ
	`‹¡_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

1214 &
n
->
¬ch
.
gue¡_cÚ‹xt
.
æags
) )

1215 
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) = 1;

1217 
»gs
->
’Œy_veùÜ
 = 
TRAP_sysÿÎ
;

1218 
»gs
->
_eæags
 &= 0xFFFCBEFFUL;

1219 
»gs
->
ss
 = 
FLAT_COMPAT_KERNEL_SS
;

1220 
»gs
->
_e¥
 = ()(
e¥
-7);

1221 
»gs
->
cs
 = 
FLAT_COMPAT_KERNEL_CS
;

1222 
»gs
->
_e
 = 
nùxt
->
ç§ã_ÿÎback_e
;

1226 iàĞ!(
n
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) )

1227 
	`toggË_gue¡_mode
(
n
);

1229 
»gs
->
cs
 &= ~3;

1232 
cs_ªd_mask
 = ()
»gs
->
cs
 |

1233 (()
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) << 32);

1236 
ræags
 = 
»gs
->ræag & ~
X86_EFLAGS_IF
;

1237 
ræags
 |ğ!
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) << 9;

1239 iàĞ
	`put_u£r
(
»gs
->
ss
, 
r¥
- 1) |

1240 
	`put_u£r
(
»gs
->
r¥
,„sp- 2) |

1241 
	`put_u£r
(
ræags
, 
r¥
- 3) |

1242 
	`put_u£r
(
cs_ªd_mask
, 
r¥
- 4) |

1243 
	`put_u£r
(
»gs
->
r
, 
r¥
- 5) |

1244 
	`put_u£r
(
nùxt
->
u£r_»gs
.
gs
, 
r¥
- 6) |

1245 
	`put_u£r
(
nùxt
->
u£r_»gs
.
fs
, 
r¥
- 7) |

1246 
	`put_u£r
(
nùxt
->
u£r_»gs
.
es
, 
r¥
- 8) |

1247 
	`put_u£r
(
nùxt
->
u£r_»gs
.
ds
, 
r¥
- 9) |

1248 
	`put_u£r
(
»gs
->
r11
, 
r¥
-10) |

1249 
	`put_u£r
(
»gs
->
rcx
, 
r¥
-11) )

1251 
	`gd´štk
(
XENLOG_ERR
, "Error while creating failsafe "

1253 
	`domaš_üash
(
n
->
domaš
);

1256 iàĞ
	`‹¡_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

1257 &
n
->
¬ch
.
gue¡_cÚ‹xt
.
æags
) )

1258 
	`vıu_šfo
(
n
, 
evtchn_upÿÎ_mask
) = 1;

1260 
»gs
->
’Œy_veùÜ
 = 
TRAP_sysÿÎ
;

1261 
»gs
->
ræags
 &ğ~(
X86_EFLAGS_AC
|
X86_EFLAGS_VM
|
X86_EFLAGS_RF
|

1262 
X86_EFLAGS_NT
|
X86_EFLAGS_TF
);

1263 
»gs
->
ss
 = 
FLAT_KERNEL_SS
;

1264 
»gs
->
r¥
 = ()(rsp-11);

1265 
»gs
->
cs
 = 
FLAT_KERNEL_CS
;

1266 
»gs
->
r
 = 
nùxt
->
ç§ã_ÿÎback_e
;

1268 
	}
}

1270 
	$§ve_£gm’ts
(
vıu
 *
v
)

1272 
vıu_gue¡_cÚ‹xt
 *
ùxt
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
;

1273 
ıu_u£r_»gs
 *
»gs
 = &
ùxt
->
u£r_»gs
;

1274 
dœty_£gm’t_mask
 = 0;

1276 
»gs
->
ds
 = 
	`»ad_£gm’t_»gi¡”
(ds);

1277 
»gs
->
es
 = 
	`»ad_£gm’t_»gi¡”
(es);

1278 
»gs
->
fs
 = 
	`»ad_£gm’t_»gi¡”
(fs);

1279 
»gs
->
gs
 = 
	`»ad_£gm’t_»gi¡”
(gs);

1281 iàĞ
»gs
->
ds
 )

1282 
dœty_£gm’t_mask
 |ğ
DIRTY_DS
;

1284 iàĞ
»gs
->
es
 )

1285 
dœty_£gm’t_mask
 |ğ
DIRTY_ES
;

1287 iàĞ
»gs
->
fs
 || 
	`is_pv_32Ú64_domaš
(
v
->
domaš
) )

1289 
dœty_£gm’t_mask
 |ğ
DIRTY_FS
;

1290 
ùxt
->
fs_ba£
 = 0;

1292 iàĞ
ùxt
->
fs_ba£
 )

1294 
dœty_£gm’t_mask
 |ğ
DIRTY_FS_BASE
;

1297 iàĞ
»gs
->
gs
 || 
	`is_pv_32Ú64_domaš
(
v
->
domaš
) )

1299 
dœty_£gm’t_mask
 |ğ
DIRTY_GS
;

1300 
ùxt
->
gs_ba£_u£r
 = 0;

1302 iàĞ
ùxt
->
gs_ba£_u£r
 )

1304 
dœty_£gm’t_mask
 |ğ
DIRTY_GS_BASE_USER
;

1307 
	`this_ıu
(
dœty_£gm’t_mask
) = dirty_segment_mask;

1308 
	}
}

1310 
	#sw™ch_k”Ãl_¡ack
(
v
è(()0)

	)

1312 #–ià
defšed
(
__i386__
)

1314 
	#lßd_£gm’ts
(
n
è(()0)

	)

1315 
	#§ve_£gm’ts
(
p
è(()0)

	)

1317 
šlše
 
	$sw™ch_k”Ãl_¡ack
(
vıu
 *
v
)

1319 
tss_¡ruù
 *
tss
 = &
	`this_ıu
(
š™_tss
);

1320 
tss
->
e¥1
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
;

1321 
tss
->
ss1
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
;

1322 
	}
}

1326 
	$·¿vœt_ùxt_sw™ch_äom
(
vıu
 *
v
)

1328 
	`§ve_£gm’ts
(
v
);

1336 iàĞ
	`uÆik–y
(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] & 
DR7_ACTIVE_MASK
) )

1337 
	`wr™e_debug»g
(7, 0);

1338 
	}
}

1340 
	$·¿vœt_ùxt_sw™ch_to
(
vıu
 *
v
)

1342 
ü4
;

1344 
	`£t_št80_dœeù_Œ­
(
v
);

1345 
	`sw™ch_k”Ãl_¡ack
(
v
);

1347 
ü4
 = 
	`pv_gue¡_ü4_to_»®_ü4
(
v
);

1348 iàĞ
	`uÆik–y
(
ü4
 !ğ
	`»ad_ü4
()) )

1349 
	`wr™e_ü4
(
ü4
);

1351 iàĞ
	`uÆik–y
(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] & 
DR7_ACTIVE_MASK
) )

1353 
	`wr™e_debug»g
(0, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0]);

1354 
	`wr™e_debug»g
(1, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1]);

1355 
	`wr™e_debug»g
(2, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2]);

1356 
	`wr™e_debug»g
(3, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3]);

1357 
	`wr™e_debug»g
(6, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6]);

1358 
	`wr™e_debug»g
(7, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7]);

1361 iàĞ(
v
->
domaš
->
¬ch
.
tsc_mode
 =ğ
TSC_MODE_PVRDTSCP
) &&

1362 
	`boÙ_ıu_has
(
X86_FEATURE_RDTSCP
) )

1363 
	`wr™e_rdtsı_aux
(
v
->
domaš
->
¬ch
.
šÿº©iÚ
);

1364 
	}
}

1367 
	$upd©e_run¡©e_¬—
(
vıu
 *
v
)

1369 iàĞ
	`gue¡_hªdË_is_nuÎ
(
	`run¡©e_gue¡
(
v
)) )

1372 #ifdeà
CONFIG_COMPAT


1373 iàĞ
	`has_32b™_shšfo
(
v
->
domaš
) )

1375 
com·t_vıu_run¡©e_šfo
 
šfo
;

1377 
	`XLAT_vıu_run¡©e_šfo
(&
šfo
, &
v
->
run¡©e
);

1378 
	`__cİy_to_gue¡
(
v
->
run¡©e_gue¡
.
com·t
, &
šfo
, 1);

1383 
	`__cİy_to_gue¡
(
	`run¡©e_gue¡
(
v
), &v->
run¡©e
, 1);

1384 
	}
}

1386 
šlše
 
	$Ãed_fuÎ_gdt
(
vıu
 *
v
)

1388  (!
	`is_hvm_vıu
(
v
è&& !
	`is_idË_vıu
(v));

1389 
	}
}

1391 
	$__cÚ‹xt_sw™ch
()

1393 
ıu_u£r_»gs
 *
¡ack_»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1394 
ıu
 = 
	`smp_´oûssÜ_id
();

1395 
vıu
 *
p
 = 
	`³r_ıu
(
cu¼_vıu
, 
ıu
);

1396 
vıu
 *
n
 = 
cu¼’t
;

1397 
desc_¡ruù
 *
gdt
;

1398 
desc_±r
 
gdt_desc
;

1400 
	`ASSERT
(
p
 !ğ
n
);

1401 
	`ASSERT
(
	`ıus_em±y
(
n
->
vıu_dœty_ıumask
));

1403 iàĞ!
	`is_idË_vıu
(
p
) )

1405 
	`memıy
(&
p
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
,

1406 
¡ack_»gs
,

1407 
CTXT_SWITCH_STACK_BYTES
);

1408 
	`§ve_š™_åu
(
p
);

1409 
p
->
¬ch
.
	`ùxt_sw™ch_äom
(p);

1417 iàĞ
p
->
domaš
 !ğ
n
->domain )

1418 
	`ıu_£t
(
ıu
, 
n
->
domaš
->
domaš_dœty_ıumask
);

1419 
	`ıu_£t
(
ıu
, 
n
->
vıu_dœty_ıumask
);

1421 iàĞ!
	`is_idË_vıu
(
n
) )

1423 
	`memıy
(
¡ack_»gs
,

1424 &
n
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
,

1425 
CTXT_SWITCH_STACK_BYTES
);

1426 iàĞ
	`x§ve_’abËd
(
n
è&&‚->
¬ch
.
xü0
 !ğ
	`g‘_xü0
() )

1427 
	`£t_xü0
(
n
->
¬ch
.
xü0
);

1428 
n
->
¬ch
.
	`ùxt_sw™ch_to
(n);

1431 
gdt
 = !
	`is_pv_32Ú64_vıu
(
n
è? 
	`³r_ıu
(
gdt_bË
, 
ıu
) :

1432 
	`³r_ıu
(
com·t_gdt_bË
, 
ıu
);

1433 iàĞ
	`Ãed_fuÎ_gdt
(
n
) )

1435 
·ge_šfo
 *
·ge
 = 
	`vœt_to_·ge
(
gdt
);

1436 
i
;

1437  
i
 = 0; i < 
NR_RESERVED_GDT_PAGES
; i++ )

1438 
	`l1e_wr™e
(
n
->
¬ch
.
³rdomaš_±es
 +

1439 
FIRST_RESERVED_GDT_PAGE
 + 
i
,

1440 
	`l1e_äom_·ge
(
·ge
 + 
i
, 
__PAGE_HYPERVISOR
));

1443 iàĞ
	`Ãed_fuÎ_gdt
(
p
) &&

1444 ((
p
->
vıu_id
 !ğ
n
->vıu_idè|| !
	`Ãed_fuÎ_gdt
(n)) )

1446 
gdt_desc
.
lim™
 = 
LAST_RESERVED_GDT_BYTE
;

1447 
gdt_desc
.
ba£
 = ()(
gdt
 - 
FIRST_RESERVED_GDT_ENTRY
);

1448 
asm
 vŞ©Ğ"lgdˆ%0" : : "m" (
gdt_desc
) );

1451 #ifdeà
ENABLE_PER_CACHE_PT


1452 
·ge_dœ
 *
pgd
 = 
cu¼’t
->
cu¼’t_pgd
;

1453 ià(
pgd
) {

1454 
mâ
 = 
	`vœt_to_mâ
(
pgd
->
±
->
shadow
[
ÿche_now
]);

1455 #ifdeà
ENABLE_REGIONING2


1456 
v»giÚ_t
 *
vr
 = 
pgd
->
cu¼’t_»giÚ
;

1457 
ıu
 = 
pgd
->
»giÚšg_ıu
;

1458 ià(
vr
 && 
ıu
 =ğ
	`smp_´oûssÜ_id
()) {

1459 
mâ
 = 
	`vœt_to_mâ
(
pgd
->
±
->
»giÚšg_shadow
);

1462 
	`MYASSERT
(
	`is_x’_h—p_mâ
(
mâ
));

1463 #ifdeà
NO_PGD_ABOVE_4GB


1464 
	`MYASSERT
(!((
mâ
 << 
PAGE_SHIFT
) & 0xffffffff00000fff));

1466 
	`_wr™e_ü3
(
mâ
 << 
PAGE_SHIFT
, 1);

1468 
	`_wr™e_ü3
(
n
->
¬ch
.
ü3
, 1);

1471 #ifdeà
ENABLE_PGD


1472 
	`_wr™e_ü3
(
n
->
¬ch
.
ü3
, 1);

1474 
	`wr™e_±ba£
(
n
);

1478 iàĞ
	`Ãed_fuÎ_gdt
(
n
) &&

1479 ((
p
->
vıu_id
 !ğ
n
->vıu_idè|| !
	`Ãed_fuÎ_gdt
(p)) )

1481 
gdt_desc
.
lim™
 = 
LAST_RESERVED_GDT_BYTE
;

1482 
gdt_desc
.
ba£
 = 
	`GDT_VIRT_START
(
n
);

1483 
asm
 vŞ©Ğ"lgdˆ%0" : : "m" (
gdt_desc
) );

1486 iàĞ
p
->
domaš
 !ğ
n
->domain )

1487 
	`ıu_ş—r
(
ıu
, 
p
->
domaš
->
domaš_dœty_ıumask
);

1488 
	`ıu_ş—r
(
ıu
, 
p
->
vıu_dœty_ıumask
);

1490 
	`³r_ıu
(
cu¼_vıu
, 
ıu
èğ
n
;

1491 
	}
}

1494 
	$cÚ‹xt_sw™ch
(
vıu
 *
´ev
, vıu *
Ãxt
)

1496 
ıu
 = 
	`smp_´oûssÜ_id
();

1497 
ıumask_t
 
dœty_mask
 = 
Ãxt
->
vıu_dœty_ıumask
;

1498 #ifdeà
VERBOSE_USCHED_DETAIL


1502 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

1505 
	`ASSERT
(
	`ıus_weight
(
dœty_mask
) <= 1);

1506 iàĞ
	`uÆik–y
(!
	`ıu_is£t
(
ıu
, 
dœty_mask
è&& !
	`ıus_em±y
(dirty_mask)) )

1509 
	`æush_b_mask
(&
dœty_mask
);

1512 ià(
´ev
 !ğ
Ãxt
)

1513 
	`upd©e_run¡©e_¬—
(
´ev
);

1515 iàĞ
	`is_hvm_vıu
(
´ev
è&& !
	`li¡_em±y
(&´ev->
¬ch
.
hvm_vıu
.
tm_li¡
) )

1516 
	`±_§ve_tim”
(
´ev
);

1518 
	`loÿl_œq_di§bË
();

1520 
	`£t_cu¼’t
(
Ãxt
);

1522 iàĞ(
	`³r_ıu
(
cu¼_vıu
, 
ıu
è=ğ
Ãxt
) ||

1523 (
	`is_idË_vıu
(
Ãxt
è&& 
	`ıu_Úlše
(
ıu
)) )

1525 
	`loÿl_œq_’abË
();

1529 
	`__cÚ‹xt_sw™ch
();

1531 #ifdeà
CONFIG_COMPAT


1532 iàĞ!
	`is_hvm_vıu
(
Ãxt
) &&

1533 (
	`is_idË_vıu
(
´ev
) ||

1534 
	`is_hvm_vıu
(
´ev
) ||

1535 
	`is_pv_32Ú64_vıu
(
´ev
è!ğis_pv_32Ú64_vıu(
Ãxt
)) )

1537 
ušt64_t
 
eãr
 = 
	`»ad_eãr
();

1538 iàĞ!(
eãr
 & 
EFER_SCE
) )

1539 
	`wr™e_eãr
(
eãr
 | 
EFER_SCE
);

1544 
	`loÿl_œq_’abË
();

1546 iàĞ!
	`is_hvm_vıu
(
Ãxt
) )

1548 
	`lßd_LDT
(
Ãxt
);

1549 
	`lßd_£gm’ts
(
Ãxt
);

1553 
	`cÚ‹xt_§ved
(
´ev
);

1555 ià(
´ev
 !ğ
Ãxt
)

1556 
	`upd©e_run¡©e_¬—
(
Ãxt
);

1557 #ifdeà
ENABLE_TIMESTAMP


1558 
	`vtime¡amp
(0, 2);

1559 
	`vtime¡amp_’d
(0, 3);

1561 
	`scheduË_
(
Ãxt
);

1562 
	`BUG
();

1563 
	}
}

1565 
	$cÚtšue_ruÂšg
(
vıu
 *
§me
)

1567 
	`scheduË_
(
§me
);

1568 
	`BUG
();

1569 
	}
}

1571 
	$__sync_loÿl_exec¡©e
()

1573 
æags
;

1574 
sw™ch_»quœed
;

1576 
	`loÿl_œq_§ve
(
æags
);

1578 
sw™ch_»quœed
 = (
	`this_ıu
(
cu¼_vıu
è!ğ
cu¼’t
);

1580 iàĞ
sw™ch_»quœed
 )

1582 
	`ASSERT
(
cu¼’t
 =ğ
idË_vıu
[
	`smp_´oûssÜ_id
()]);

1583 
	`__cÚ‹xt_sw™ch
();

1586 
	`loÿl_œq_»¡Üe
(
æags
);

1588  
sw™ch_»quœed
;

1589 
	}
}

1591 
	$sync_loÿl_exec¡©e
()

1593 ()
	`__sync_loÿl_exec¡©e
();

1594 
	}
}

1596 
	$sync_vıu_exec¡©e
(
vıu
 *
v
)

1598 iàĞ
	`ıu_is£t
(
	`smp_´oûssÜ_id
(), 
v
->
vıu_dœty_ıumask
) )

1599 
	`sync_loÿl_exec¡©e
();

1602 
	`æush_b_mask
(&
v
->
vıu_dœty_ıumask
);

1603 
	}
}

1605 
	#Ãxt_¬g
(
fmt
, 
¬gs
) ({ \

1606 
__¬g
; \

1607  *(
fmt
)++ ) \

1609 'i': 
__¬g
 = ()
	`va_¬g
(
¬gs
, ); ; \

1610 'l': 
__¬g
 = ()
	`va_¬g
(
¬gs
, ); ; \

1611 'h': 
__¬g
 = ()
	`va_¬g
(
¬gs
, *); ; \

1612 : 
__¬g
 = 0; 
	`BUG
(); \

1614 
__¬g
; \

1615 })

	)

1617 
	$hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

1618 
İ
, cÚ¡ *
fÜm©
, ...)

1620 
mc_¡©e
 *
mcs
 = &
cu¼’t
->mc_state;

1621 
ıu_u£r_»gs
 *
»gs
;

1622 cÚ¡ *
p
 = 
fÜm©
;

1623 
¬g
;

1624 
i
;

1625 
va_li¡
 
¬gs
;

1627 
	`va_¡¬t
(
¬gs
, 
fÜm©
);

1629 iàĞ
	`‹¡_b™
(
_MCSF_š_muÉiÿÎ
, &
mcs
->
æags
) )

1631 
	`__£t_b™
(
_MCSF_ÿÎ_´“m±ed
, &
mcs
->
æags
);

1633  
i
 = 0; *
p
 != '\0'; i++ )

1634 
mcs
->
ÿÎ
.
¬gs
[
i
] = 
	`Ãxt_¬g
(
p
,‡rgs);

1635 iàĞ
	`is_pv_32Ú64_domaš
(
cu¼’t
->
domaš
) )

1637  ; 
i
 < 6; i++ )

1638 
mcs
->
ÿÎ
.
¬gs
[
i
] = 0;

1643 
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1644 
»gs
->
—x
 = 
İ
;

1647 iàĞ!
	`is_hvm_vıu
(
cu¼’t
) )

1648 
»gs
->
e
 -= 2;

1650 
cu¼’t
->
¬ch
.
hvm_vıu
.
hÿÎ_´“m±ed
 = 1;

1652 #ifdeà
__x86_64__


1653 iàĞ!
	`is_hvm_vıu
(
cu¼’t
) ?

1654 !
	`is_pv_32Ú64_vıu
(
cu¼’t
) :

1655 (
	`hvm_gue¡_x86_mode
(
cu¼’t
) == 8) )

1657  
i
 = 0; *
p
 != '\0'; i++ )

1659 
¬g
 = 
	`Ãxt_¬g
(
p
, 
¬gs
);

1660  
i
 )

1662 0: 
»gs
->
rdi
 = 
¬g
; ;

1663 1: 
»gs
->
rsi
 = 
¬g
; ;

1664 2: 
»gs
->
rdx
 = 
¬g
; ;

1665 3: 
»gs
->
r10
 = 
¬g
; ;

1666 4: 
»gs
->
r8
 = 
¬g
; ;

1667 5: 
»gs
->
r9
 = 
¬g
; ;

1674 iàĞ
su³rvisÜ_mode_k”Ãl
 )

1675 
»gs
->
e
 &= ~31;

1677  
i
 = 0; *
p
 != '\0'; i++ )

1679 
¬g
 = 
	`Ãxt_¬g
(
p
, 
¬gs
);

1680  
i
 )

1682 0: 
»gs
->
ebx
 = 
¬g
; ;

1683 1: 
»gs
->
ecx
 = 
¬g
; ;

1684 2: 
»gs
->
edx
 = 
¬g
; ;

1685 3: 
»gs
->
esi
 = 
¬g
; ;

1686 4: 
»gs
->
edi
 = 
¬g
; ;

1687 5: 
»gs
->
ebp
 = 
¬g
; ;

1693 
	`va_’d
(
¬gs
);

1695  
İ
;

1696 
	}
}

1698 #ifdeà
CONFIG_COMPAT


1699 
	$hy³rÿÎ_xÏt_cÚtšu©iÚ
(*
id
, 
mask
, ...)

1701 
rc
 = 0;

1702 
mc_¡©e
 *
mcs
 = &
cu¼’t
->mc_state;

1703 
ıu_u£r_»gs
 *
»gs
;

1704 
i
, 
cv®
 = 0;

1705 
nv®
 = 0;

1706 
va_li¡
 
¬gs
;

1708 
	`BUG_ON
(
id
 && *id > 5);

1709 
	`BUG_ON
(
id
 && (
mask
 & (1U << *id)));

1711 
	`va_¡¬t
(
¬gs
, 
mask
);

1713 iàĞ
	`‹¡_b™
(
_MCSF_š_muÉiÿÎ
, &
mcs
->
æags
) )

1715 iàĞ!
	`‹¡_b™
(
_MCSF_ÿÎ_´“m±ed
, &
mcs
->
æags
) )

1717  
i
 = 0; i < 6; ++i, 
mask
 >>= 1 )

1719 iàĞ
mask
 & 1 )

1721 
nv®
 = 
	`va_¬g
(
¬gs
, );

1722 
cv®
 = 
	`va_¬g
(
¬gs
, );

1723 iàĞ
cv®
 =ğ
nv®
 )

1724 
mask
 &= ~1U;

1726 
	`BUG_ON
(
nv®
 == ()nval);

1728 iàĞ
id
 && *id =ğ
i
 )

1730 *
id
 = 
mcs
->
ÿÎ
.
¬gs
[
i
];

1731 
id
 = 
NULL
;

1733 iàĞ(
mask
 & 1è&& 
mcs
->
ÿÎ
.
¬gs
[
i
] =ğ
nv®
 )

1735 
mcs
->
ÿÎ
.
¬gs
[
i
] = 
cv®
;

1736 ++
rc
;

1739 
	`BUG_ON
(
mcs
->
ÿÎ
.
¬gs
[
i
] != ()mcs->call.args[i]);

1744 
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1745  
i
 = 0; i < 6; ++i, 
mask
 >>= 1 )

1747 *
»g
;

1749  
i
 )

1751 0: 
»g
 = &
»gs
->
ebx
; ;

1752 1: 
»g
 = &
»gs
->
ecx
; ;

1753 2: 
»g
 = &
»gs
->
edx
; ;

1754 3: 
»g
 = &
»gs
->
esi
; ;

1755 4: 
»g
 = &
»gs
->
edi
; ;

1756 5: 
»g
 = &
»gs
->
ebp
; ;

1757 : 
	`BUG
(); 
»g
 = 
NULL
; ;

1759 iàĞ(
mask
 & 1) )

1761 
nv®
 = 
	`va_¬g
(
¬gs
, );

1762 
cv®
 = 
	`va_¬g
(
¬gs
, );

1763 iàĞ
cv®
 =ğ
nv®
 )

1764 
mask
 &= ~1U;

1766 
	`BUG_ON
(
nv®
 == ()nval);

1768 iàĞ
id
 && *id =ğ
i
 )

1770 *
id
 = *
»g
;

1771 
id
 = 
NULL
;

1773 iàĞ(
mask
 & 1è&& *
»g
 =ğ
nv®
 )

1775 *
»g
 = 
cv®
;

1776 ++
rc
;

1779 
	`BUG_ON
(*
»g
 != ()*reg);

1783 
	`va_’d
(
¬gs
);

1785  
rc
;

1786 
	}
}

1789 
	$»lšquish_memÜy
(

1790 
domaš
 *
d
, 
·ge_li¡_h—d
 *
li¡
, 
ty³
)

1792 
·ge_šfo
 *
·ge
;

1793 
x
, 
y
;

1794 
»t
 = 0;

1797 
	`¥š_lock_»cursive
(&
d
->
·ge_®loc_lock
);

1799  (
·ge
 = 
	`·ge_li¡_»move_h—d
(
li¡
)) )

1802 iàĞ
	`uÆik–y
(!
	`g‘_·ge
(
·ge
, 
d
)) )

1805 
	`·ge_li¡_add_
(
·ge
, &
d
->
¬ch
.
»lmem_li¡
);

1809 iàĞ
	`‹¡_ªd_ş—r_b™
(
_PGT_pšÃd
, &
·ge
->
u
.
šu£
.
ty³_šfo
) )

1810 
»t
 = 
	`put_·ge_ªd_ty³_´“m±ibË
(
·ge
, 1);

1811  
»t
 )

1815 -
EAGAIN
:

1816 -
EINTR
:

1817 
»t
 = -
EAGAIN
;

1818 
	`·ge_li¡_add
(
·ge
, 
li¡
);

1819 
	`£t_b™
(
_PGT_pšÃd
, &
·ge
->
u
.
šu£
.
ty³_šfo
);

1820 
	`put_·ge
(
·ge
);

1821 
out
;

1823 
	`BUG
();

1826 
	`ş—r_su³½age_m¬k
(
·ge
);

1828 iàĞ
	`‹¡_ªd_ş—r_b™
(
_PGC_®loÿ‹d
, &
·ge
->
couÁ_šfo
) )

1829 
	`put_·ge
(
·ge
);

1839 
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
;

1842 
x
 = 
y
;

1843 iàĞ
	`lik–y
((
x
 & 
PGT_ty³_mask
è!ğ
ty³
) ||

1844 
	`lik–y
(!(
x
 & (
PGT_v®id©ed
|
PGT_·¹Ÿl
))) )

1847 
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
,

1848 
x
 & ~(
PGT_v®id©ed
|
PGT_·¹Ÿl
));

1849 iàĞ
	`lik–y
(
y
 =ğ
x
) )

1852  
»t
 = 
	`ä“_·ge_ty³
(
·ge
, 
x
, 1) )

1856 -
EINTR
:

1857 
	`·ge_li¡_add
(
·ge
, 
li¡
);

1858 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_v®id©ed
;

1859 iàĞ
x
 & 
PGT_·¹Ÿl
 )

1860 
	`put_·ge
(
·ge
);

1861 
	`put_·ge
(
·ge
);

1862 
»t
 = -
EAGAIN
;

1863 
out
;

1864 -
EAGAIN
:

1865 
	`·ge_li¡_add
(
·ge
, 
li¡
);

1866 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_·¹Ÿl
;

1867 iàĞ
x
 & 
PGT_·¹Ÿl
 )

1868 
	`put_·ge
(
·ge
);

1869 
out
;

1871 
	`BUG
();

1873 iàĞ
x
 & 
PGT_·¹Ÿl
 )

1875 
·ge
->
u
.
šu£
.
ty³_šfo
--;

1876 
	`put_·ge
(
·ge
);

1883 
	`·ge_li¡_add_
(
·ge
, &
d
->
¬ch
.
»lmem_li¡
);

1884 
	`put_·ge
(
·ge
);

1886 iàĞ
	`hy³rÿÎ_´“m±_check
() )

1888 
»t
 = -
EAGAIN
;

1889 
out
;

1894 
	`·ge_li¡_move
(
li¡
, &
d
->
¬ch
.
»lmem_li¡
);

1896 
out
:

1897 
	`¥š_uÆock_»cursive
(&
d
->
·ge_®loc_lock
);

1898  
»t
;

1899 
	}
}

1901 
	$vıu_de¡roy_·g‘abËs
(
vıu
 *
v
)

1903 
domaš
 *
d
 = 
v
->domain;

1904 
pâ
;

1906 #ifdeà
__x86_64__


1907 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

1909 
pâ
 = 
	`l4e_g‘_pâ
(*(
l4_pg’Œy_t
 *)

1910 
	`__va
(
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
)));

1912 iàĞ
pâ
 != 0 )

1914 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

1915 
	`put_·ge
(
	`mâ_to_·ge
(
pâ
));

1917 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
pâ
));

1920 
	`l4e_wr™e
(

1921 (
l4_pg’Œy_t
 *)
	`__va
(
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
)),

1922 
	`l4e_em±y
());

1924 
v
->
¬ch
.
ü3
 = 0;

1929 
pâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
);

1930 iàĞ
pâ
 != 0 )

1932 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

1933 
	`put_·ge
(
	`mâ_to_·ge
(
pâ
));

1935 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
pâ
));

1936 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

1939 #ifdeà
__x86_64__


1941 
pâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË_u£r
);

1942 iàĞ
pâ
 != 0 )

1944 iàĞ!
	`is_pv_32b™_vıu
(
v
) )

1946 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

1947 
	`put_·ge
(
	`mâ_to_·ge
(
pâ
));

1949 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
pâ
));

1951 
v
->
¬ch
.
gue¡_bË_u£r
 = 
	`·g‘abË_nuÎ
();

1955 
v
->
¬ch
.
ü3
 = 0;

1956 
	}
}

1958 
	$domaš_»lšquish_»sourûs
(
domaš
 *
d
)

1960 
»t
;

1961 
vıu
 *
v
;

1963 
	`BUG_ON
(!
	`ıus_em±y
(
d
->
domaš_dœty_ıumask
));

1965  
d
->
¬ch
.
»lmem
 )

1967 
RELMEM_nÙ_¡¬‹d
:

1969 
	`·gšg_‹¬down
(
d
);

1971 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1974 
	`vıu_de¡roy_·g‘abËs
(
v
);

1980 
	`de¡roy_gdt
(
v
);

1982 
	`unm­_vıu_šfo
(
v
);

1985 iàĞ
d
->
¬ch
.
pœq_eoi_m­
 !ğ
NULL
 )

1987 
	`unm­_domaš_·ge_glob®
(
d
->
¬ch
.
pœq_eoi_m­
);

1988 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
d
->
¬ch
.
pœq_eoi_m­_mâ
));

1989 
d
->
¬ch
.
pœq_eoi_m­
 = 
NULL
;

1992 
d
->
¬ch
.
»lmem
 = 
RELMEM_x’
;

1996 
RELMEM_x’
:

1997 
»t
 = 
	`»lšquish_memÜy
(
d
, &d->
x’·ge_li¡
, ~0UL);

1998 iàĞ
»t
 )

1999  
»t
;

2000 #ià
CONFIG_PAGING_LEVELS
 >= 4

2001 
d
->
¬ch
.
»lmem
 = 
RELMEM_l4
;

2004 
RELMEM_l4
:

2005 
»t
 = 
	`»lšquish_memÜy
(
d
, &d->
·ge_li¡
, 
PGT_l4_·ge_bË
);

2006 iàĞ
»t
 )

2007  
»t
;

2009 #ià
CONFIG_PAGING_LEVELS
 >= 3

2010 
d
->
¬ch
.
»lmem
 = 
RELMEM_l3
;

2013 
RELMEM_l3
:

2014 
»t
 = 
	`»lšquish_memÜy
(
d
, &d->
·ge_li¡
, 
PGT_l3_·ge_bË
);

2015 iàĞ
»t
 )

2016  
»t
;

2018 
d
->
¬ch
.
»lmem
 = 
RELMEM_l2
;

2021 
RELMEM_l2
:

2022 
»t
 = 
	`»lšquish_memÜy
(
d
, &d->
·ge_li¡
, 
PGT_l2_·ge_bË
);

2023 iàĞ
»t
 )

2024  
»t
;

2025 
d
->
¬ch
.
»lmem
 = 
RELMEM_dÚe
;

2028 
RELMEM_dÚe
:

2032 
	`BUG
();

2035 iàĞ
	`is_hvm_domaš
(
d
) )

2036 
	`hvm_domaš_»lšquish_»sourûs
(
d
);

2039 
	}
}

2041 
	$¬ch_dump_domaš_šfo
(
domaš
 *
d
)

2043 
	`·gšg_dump_domaš_šfo
(
d
);

2044 
	}
}

2046 
	$¬ch_dump_vıu_šfo
(
vıu
 *
v
)

2048 
	`·gšg_dump_vıu_šfo
(
v
);

2049 
	}
}

2051 
	$domaš_ıuid
(

2052 
domaš
 *
d
,

2053 
šput
,

2054 
sub_šput
,

2055 *
—x
,

2056 *
ebx
,

2057 *
ecx
,

2058 *
edx
)

2060 
ıuid_šput_t
 *
ıuid
;

2061 
i
;

2063  
i
 = 0; i < 
MAX_CPUID_INPUT
; i++ )

2065 
ıuid
 = &
d
->
¬ch
.
ıuids
[
i
];

2067 iàĞ(
ıuid
->
šput
[0] == input) &&

2068 ((
ıuid
->
šput
[1] =ğ
XEN_CPUID_INPUT_UNUSED
) ||

2069 (
ıuid
->
šput
[1] =ğ
sub_šput
)) )

2071 *
—x
 = 
ıuid
->eax;

2072 *
ebx
 = 
ıuid
->ebx;

2073 *
ecx
 = 
ıuid
->ecx;

2074 *
edx
 = 
ıuid
->edx;

2080 iàĞ(
šput
 == 0x80000007) &&

2081 !
d
->
di§bË_mig¿‹
 && !d->
¬ch
.
vtsc
 )

2082 *
edx
 &= ~(1u<<8);

2088 *
—x
 = *
ebx
 = *
ecx
 = *
edx
 = 0;

2089 
	}
}

2091 
	$vıu_kick
(
vıu
 *
v
)

2102 
boŞ_t
 
ruÂšg
 = 
v
->
is_ruÂšg
;

2103 
	`vıu_unblock
(
v
);

2104 iàĞ
ruÂšg
 && (
	`š_œq
(è|| (
v
 !ğ
cu¼’t
)) )

2105 
	`ıu_¿i£_soáœq
(
v
->
´oûssÜ
, 
VCPU_KICK_SOFTIRQ
);

2106 
	}
}

2108 
	$vıu_m¬k_ev’ts_³ndšg
(
vıu
 *
v
)

2110 
®»ady_³ndšg
 = 
	`‹¡_ªd_£t_b™
(

2111 0, (*)&
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_³ndšg
));

2113 iàĞ
®»ady_³ndšg
 )

2116 iàĞ
	`is_hvm_vıu
(
v
) )

2117 
	`hvm_as£¹_evtchn_œq
(
v
);

2119 
	`vıu_kick
(
v
);

2120 
	}
}

2122 
	$vıu_kick_soáœq
()

2129 
	}
}

2131 
__š™
 
	$š™_vıu_kick_soáœq
()

2133 
	`İ’_soáœq
(
VCPU_KICK_SOFTIRQ
, 
vıu_kick_soáœq
);

2135 
	}
}

2136 
__š™ÿÎ
(
š™_vıu_kick_soáœq
);

	@domain_build.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/š™.h
>

9 
	~<x’/lib.h
>

10 
	~<x’/ùy³.h
>

11 
	~<x’/sched.h
>

12 
	~<x’/sched-if.h
>

13 
	~<x’/smp.h
>

14 
	~<x’/d–ay.h
>

15 
	~<x’/ev’t.h
>

16 
	~<x’/cÚsŞe.h
>

17 
	~<x’/k”Ãl.h
>

18 
	~<x’/domaš.h
>

19 
	~<x’/v”siÚ.h
>

20 
	~<x’/ioÿp.h
>

21 
	~<x’/b™İs.h
>

22 
	~<x’/com·t.h
>

23 
	~<x’/lib–f.h
>

24 
	~<asm/»gs.h
>

25 
	~<asm/sy¡em.h
>

26 
	~<asm/io.h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<asm/desc.h
>

29 
	~<asm/i387.h
>

30 
	~<asm/·gšg.h
>

31 
	~<asm/p2m.h
>

32 
	~<asm/e820.h
>

33 
	~<asm/aıi.h
>

34 
	~<asm/£tup.h
>

35 
	~<asm/bzimage.h
>

36 
	~<asm/io_­ic.h
>

38 
	~<public/v”siÚ.h
>

40 
__š™d©a
 
	gdom0_Ä·ges
;

41 
__š™d©a
 
	gdom0_mš_Ä·ges
;

42 
__š™d©a
 
	gdom0_max_Ä·ges
 = 
LONG_MAX
;

64 
__š™
 
	$·r£_amt
(cÚ¡ *
s
, cÚ¡ **
ps
)

66 
·ges
 = 
	`·r£_size_ªd_un™
((*
s
 =ğ'-'è? s+1 : s, 
ps
è>> 
PAGE_SHIFT
;

67  (*
s
 =ğ'-'è? -
·ges
 :…ages;

68 
	}
}

69 
__š™
 
	$·r£_dom0_mem
(cÚ¡ *
s
)

72 iàĞ!
	`¡ºcmp
(
s
, "min:", 4) )

73 
dom0_mš_Ä·ges
 = 
	`·r£_amt
(
s
+4, &s);

74 iàĞ!
	`¡ºcmp
(
s
, "max:", 4) )

75 
dom0_max_Ä·ges
 = 
	`·r£_amt
(
s
+4, &s);

77 
dom0_Ä·ges
 = 
	`·r£_amt
(
s
, &s);

78 iàĞ*
s
 != ',' )

80 }  *
s
++ == ',' );

81 
	}
}

82 
cu¡om_·¿m
("dom0_mem", 
·r£_dom0_mem
);

84 
__š™d©a
 
	gİt_dom0_max_vıus
;

85 
š‹g”_·¿m
("dom0_max_vıus", 
İt_dom0_max_vıus
);

87 
vıu
 *
__š™
 
	$®loc_dom0_vıu0
()

89 iàĞ
İt_dom0_max_vıus
 == 0 )

90 
İt_dom0_max_vıus
 = 
	`num_ıupoŞ_ıus
(
ıupoŞ0
);

91 iàĞ
İt_dom0_max_vıus
 > 
MAX_VIRT_CPUS
 )

92 
İt_dom0_max_vıus
 = 
MAX_VIRT_CPUS
;

94 
dom0
->
vıu
 = 
	`xm®loc_¬¿y
(vıu *, 
İt_dom0_max_vıus
);

95 iàĞ!
dom0
->
vıu
 )

96  
NULL
;

97 
	`mem£t
(
dom0
->
vıu
, 0, 
İt_dom0_max_vıus
 * (*dom0->vcpu));

98 
dom0
->
max_vıus
 = 
İt_dom0_max_vıus
;

100  
	`®loc_vıu
(
dom0
, 0, 0);

101 
	}
}

103 
boŞ_t
 
__š™d©a
 
	gİt_dom0_shadow
;

104 
boŞ—n_·¿m
("dom0_shadow", 
İt_dom0_shadow
);

106 
__š™d©a
 
	gİt_dom0_iİÜts_di§bË
[200] = "";

107 
¡ršg_·¿m
("dom0_iİÜts_di§bË", 
İt_dom0_iİÜts_di§bË
);

109 #ià
defšed
(
__i386__
)

111 
	#L1_PROT
 (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_ACCESSED
)

	)

112 
	#L2_PROT
 (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_ACCESSED
|
_PAGE_DIRTY
|
_PAGE_USER
)

	)

113 
	#L3_PROT
 (
_PAGE_PRESENT
)

	)

114 #–ià
defšed
(
__x86_64__
)

116 
	#BASE_PROT
 (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_ACCESSED
|
_PAGE_USER
)

	)

117 
	#L1_PROT
 (
BASE_PROT
|
_PAGE_GUEST_KERNEL
)

	)

119 
	#COMPAT_L1_PROT
 (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_ACCESSED
)

	)

120 
	#L2_PROT
 (
BASE_PROT
|
_PAGE_DIRTY
)

	)

121 
	#L3_PROT
 (
BASE_PROT
|
_PAGE_DIRTY
)

	)

122 
	#L4_PROT
 (
BASE_PROT
|
_PAGE_DIRTY
)

	)

125 
	#round_pgup
(
_p
è(((_p)+(
PAGE_SIZE
-1))&
PAGE_MASK
)

	)

126 
	#round_pgdown
(
_p
è((_p)&
PAGE_MASK
)

	)

128 
·ge_šfo
 * 
__š™
 
	$®loc_chunk
(

129 
domaš
 *
d
, 
max_·ges
)

131 
__š™d©a
 
Ï¡_Üd”
 = 
MAX_ORDER
;

132 
__š™d©a
 
memæags
 = 
MEMF_no_dma
 | 
	`MEMF_node
(1);

133 
·ge_šfo
 *
·ge
;

134 
Üd”
 = 
	`g‘_Üd”_äom_·ges
(
max_·ges
), 
ä“_Üd”
;

136 iàĞ
Üd”
 > 
Ï¡_Üd”
 )

137 
Üd”
 = 
Ï¡_Üd”
;

138 iàĞ
max_·ges
 & (max_pages - 1) )

139 --
Üd”
;

140  (
·ge
 = 
	`®loc_domh—p_·ges
(
d
, 
Üd”
, 
memæags
)è=ğ
NULL
 )

141 iàĞ
Üd”
-- == 0 )

143 iàĞ
·ge
 )

144 
Ï¡_Üd”
 = 
Üd”
;

145 iàĞ
memæags
 )

151 
Ï¡_Üd”
 = 21 - 
PAGE_SHIFT
;

152 
memæags
 = 0;

153  
	`®loc_chunk
(
d
, 
max_·ges
);

160  
ä“_Üd”
 = 
Üd”
; !
memæags
 && 
·ge
 && order--; )

162 
·ge_šfo
 *
pg2
;

164 iàĞ
d
->
tÙ_·ges
 + (1 << 
Üd”
è> d->
max_·ges
 )

166 
pg2
 = 
	`®loc_domh—p_·ges
(
d
, 
Üd”
, 0);

167 iàĞ
pg2
 > 
·ge
 )

169 
	`ä“_domh—p_·ges
(
·ge
, 
ä“_Üd”
);

170 
·ge
 = 
pg2
;

171 
ä“_Üd”
 = 
Üd”
;

173 iàĞ
pg2
 )

174 
	`ä“_domh—p_·ges
(
pg2
, 
Üd”
);

176  
·ge
;

177 
	}
}

179 
__š™
 
	$compu‹_dom0_Ä_·ges
(

180 
domaš
 *
d
, 
–f_dom_·rms
 *
·rms
, 
š™rd_Ën
)

182 
ava
 = 
	`ava_domh—p_·ges
(è+ 
	`š™Ÿl_images_Ä·ges
();

183 
Ä_·ges
 = 
dom0_Ä·ges
;

184 
mš_·ges
 = 
dom0_mš_Ä·ges
;

185 
max_·ges
 = 
dom0_max_Ä·ges
;

188 
ava
 -ğ(
İt_dom0_max_vıus
 - 1UL)

189 << 
	`g‘_Üd”_äom_by‹s
((
vıu
));

191 iàĞ
	`is_pv_32Ú64_domaš
(
d
) )

192 
ava
 -ğ
İt_dom0_max_vıus
 - 1;

195 iàĞ
iommu_’abËd
 )

197 
s
;

199  
s
 = 9; s < 
BITS_PER_LONG
; s += 9 )

200 
ava
 -ğ
max_pdx
 >> 
s
;

208 iàĞ
Ä_·ges
 == 0 )

209 
Ä_·ges
 = -
	`mš
(
ava
 / 16, 128UL << (20 - 
PAGE_SHIFT
));

212 iàĞ()
Ä_·ges
 < 0 )‚r_·ge +ğ
ava
;

213 iàĞ()
mš_·ges
 < 0 ) mš_·ge +ğ
ava
;

214 iàĞ()
max_·ges
 < 0 ) max_·ge +ğ
ava
;

217 
Ä_·ges
 = 
	`max
Òr_·ges, 
mš_·ges
);

218 
Ä_·ges
 = 
	`mš
Òr_·ges, 
max_·ges
);

219 
Ä_·ges
 = 
	`mš
Òr_·ges, 
ava
);

221 #ifdeà
__x86_64__


222 iàĞ(
·rms
->
p2m_ba£
 =ğ
UNSET_ADDR
è&& (
dom0_Ä·ges
 <= 0) &&

223 ((
dom0_mš_Ä·ges
 <ğ0è|| (
Ä_·ges
 > 
mš_·ges
)) )

233 
v¡¬t
, 
v’d
, 
’d
;

234 
size_t
 
sizeof_lÚg
 = 
	`is_pv_32b™_domaš
(
d
) ? () : ();

236 
v¡¬t
 = 
·rms
->
vœt_ba£
;

237 
v’d
 = 
	`round_pgup
(
·rms
->
vœt_k’d
);

238 iàĞ!
·rms
->
–f_nÙes
[
XEN_ELFNOTE_MOD_START_PFN
].
d©a
.
num
 )

239 
v’d
 +ğ
	`round_pgup
(
š™rd_Ën
);

240 
’d
 = 
v’d
 + 
Ä_·ges
 * 
sizeof_lÚg
;

242 iàĞ
’d
 > 
v¡¬t
 )

243 
’d
 +ğ’d - 
v¡¬t
;

244 iàĞ
’d
 <ğ
v¡¬t
 ||

245 (
sizeof_lÚg
 < (
’d
) &&ƒnd > (1UL << (8 * sizeof_long))) )

247 
’d
 = 
sizeof_lÚg
 >= (end) ? 0 : 1UL << (8 * sizeof_long);

248 
Ä_·ges
 = (
’d
 - 
v’d
è/ (2 * 
sizeof_lÚg
);

249 iàĞ
dom0_mš_Ä·ges
 > 0 && 
Ä_·ges
 < 
mš_·ges
 )

250 
Ä_·ges
 = 
mš_·ges
;

251 
	`´štk
("Dom0 memÜy cl³dØ%lu…ages\n", 
Ä_·ges
);

256  
Ä_·ges
;

257 
	}
}

259 
__š™
 
	$´oûss_dom0_iİÜts_di§bË
()

261 
io_äom
, 
io_to
;

262 *
t
, *
s
 = 
İt_dom0_iİÜts_di§bË
;

263 cÚ¡ *
u
;

265 iàĞ*
s
 == '\0' )

268  (
t
 = 
	`¡r£p
(&
s
, ",")è!ğ
NULL
 )

270 
io_äom
 = 
	`sim¶e_¡¹oul
(
t
, &
u
, 16);

271 iàĞ
u
 =ğ
t
 )

273 
·r£_”rÜ
:

274 
	`´štk
("Invalid ioport„ange <%s> "

275 "š dom0_iİÜts_di§bË, skpšg\n", 
t
);

279 iàĞ*
u
 == '\0' )

280 
io_to
 = 
io_äom
;

281 iàĞ*
u
 == '-' )

282 
io_to
 = 
	`sim¶e_¡¹oul
(
u
 + 1, &u, 16);

284 
·r£_”rÜ
;

286 iàĞ(*
u
 !ğ'\0'è|| (
io_to
 < 
io_äom
) || (io_to >= 65536) )

287 
·r£_”rÜ
;

289 
	`´štk
("Disabling dom0‡ccesso ioport„ange %04lx-%04lx\n",

290 
io_äom
, 
io_to
);

292 iàĞ
	`iİÜts_d’y_acûss
(
dom0
, 
io_äom
, 
io_to
) != 0 )

293 
	`BUG
();

295 
	}
}

297 
__š™
 
cÚ¡ruù_dom0
(

298 
domaš
 *
d
,

299 cÚ¡ 
moduË_t
 *
image
, 
image_h—droom
,

300 
moduË_t
 *
š™rd
,

301 *(*
boÙ¡¿p_m­
)(cÚ¡ 
moduË_t
 *),

302 *
cmdlše
)

304 
	gi
, 
	gıu
, 
	grc
, 
	gcom·tibË
, 
	gcom·t32
, 
	gÜd”
, 
	gmachše
;

305 
ıu_u£r_»gs
 *
	g»gs
;

306 
	gpâ
, 
	gmâ
;

307 
	gÄ_·ges
;

308 
	gÄ_±_·ges
;

309 
	g®loc_¥â
;

310 
	g®loc_•â
;

311 
	gš™rd_pâ
 = -1, 
	gš™rd_mâ
 = 0;

312 
	gcouÁ
;

313 
·ge_šfo
 *
	g·ge
 = 
NULL
;

314 
¡¬t_šfo_t
 *
	gsi
;

315 
vıu
 *
	gv
 = 
d
->vcpu[0];

316 
	gv®ue
;

317 *
	gimage_ba£
 = 
boÙ¡¿p_m­
(
image
);

318 
	gimage_Ën
 = 
image
->
mod_’d
;

319 *
	gimage_¡¬t
 = 
image_ba£
 + 
image_h—droom
;

320 
	gš™rd_Ën
 = 
š™rd
 ? in™rd->
mod_’d
 : 0;

321 #ià
CONFIG_PAGING_LEVELS
 < 4

322 
moduË_t
 
	gm±
;

323 *
	gm±_±r
;

325 
l4_pg’Œy_t
 *
	gl4b
 = 
NULL
, *
	gl4¡¬t
 = NULL;

327 
l3_pg’Œy_t
 *
	gl3b
 = 
NULL
, *
	gl3¡¬t
 = NULL;

328 
l2_pg’Œy_t
 *
	gl2b
 = 
NULL
, *
	gl2¡¬t
 = NULL;

329 
l1_pg’Œy_t
 *
	gl1b
 = 
NULL
, *
	gl1¡¬t
 = NULL;

336 
–f_bš¬y
 
	g–f
;

337 
–f_dom_·rms
 
	g·rms
;

338 
	gvk”n_¡¬t
;

339 
	gvk”n_’d
;

340 
	gvš™rd_¡¬t
;

341 
	gvš™rd_’d
;

342 
	gvphysm­_¡¬t
;

343 
	gvphysm­_’d
;

344 
	gv¡¬tšfo_¡¬t
;

345 
	gv¡¬tšfo_’d
;

346 
	gv¡ack_¡¬t
;

347 
	gv¡ack_’d
;

348 
	gv±_¡¬t
;

349 
	gv±_’d
;

350 
	gv_¡¬t
;

351 
	gv_’d
;

354 
·ddr_t
 
	gm±_®loc
;

357 
BUG_ON
(
d
->
domaš_id
 != 0);

358 
BUG_ON
(
d
->
vıu
[0] =ğ
NULL
);

359 
BUG_ON
(
v
->
is_š™Ÿli£d
);

361 
´štk
("*** LOADING DOMAIN 0 ***\n");

363 
	gd
->
	gmax_·ges
 = ~0U;

365 iàĞ(
	grc
 = 
bzimage_·r£
(
image_ba£
, &
image_¡¬t
, &
image_Ën
)) != 0 )

366  
rc
;

368 iàĞ(
	grc
 = 
–f_š™
(&
–f
, 
image_¡¬t
, 
image_Ën
)) != 0 )

369  
rc
;

370 #ifdeà
VERBOSE


371 
–f_£t_v”bo£
(&
–f
);

373 
–f_·r£_bš¬y
(&
–f
);

374 iàĞ(
	grc
 = 
–f_x’_·r£
(&
–f
, &
·rms
)) != 0 )

375  
rc
;

378 
	gcom·tibË
 = 0;

379 
	gcom·t32
 = 0;

380 
	gmachše
 = 
–f_uv®
(&
–f
,ƒlf.
ehdr
, 
e_machše
);

381 
	gCONFIG_PAGING_LEVELS
) {

383 ià(
·rms
.
·e
 =ğ
PAEKERN_bimod®
)

384 
·rms
.
·e
 = 
PAEKERN_ex‹nded_ü3
;

385 
´štk
(" Xen kernel: 32-bit, PAE,†sb\n");

386 ià(
–f_32b™
(&
–f
è&& 
	g·rms
.
	g·e
 && 
	gmachše
 =ğ
EM_386
)

387 
com·tibË
 = 1;

390 
´štk
(" Xen kernel: 64-bit,†sb, compat32\n");

391 ià(
–f_32b™
(&
–f
è&& 
	g·rms
.
	g·e
 =ğ
PAEKERN_bimod®
)

392 
·rms
.
·e
 = 
PAEKERN_ex‹nded_ü3
;

393 ià(
–f_32b™
(&
–f
è&& 
	g·rms
.
	g·e
 && 
	gmachše
 =ğ
EM_386
)

395 
com·t32
 = 1;

396 
	gcom·tibË
 = 1;

398 ià(
–f_64b™
(&
–f
è&& 
	gmachše
 =ğ
EM_X86_64
)

399 
com·tibË
 = 1;

402 
´štk
(" Dom0 k”Ãl: %s%s, %s,…add¸0x%" 
PRIx64
 " -> 0x%" PRIx64 "\n",

403 
–f_64b™
(&
–f
) ? "64-bit" : "32-bit",

404 
·rms
.
·e
 ? ", PAE" : "",

405 
–f_msb
(&
–f
) ? "msb" : "lsb",

406 
–f
.
p¡¬t
,ƒlf.
³nd
);

407 iàĞ
	g–f
.
	gbsd_symb_p¡¬t
 )

408 
´štk
(" Dom0 symbŞ m­ 0x%" 
PRIx64
 " -> 0x%" PRIx64 "\n",

409 
–f
.
bsd_symb_p¡¬t
,ƒlf.
bsd_symb_³nd
);

411 iàĞ!
	gcom·tibË
 )

413 
´štk
("Mismatch between Xen‡nd DOM0 kernel\n");

414  -
	gEINVAL
;

417 #ià
defšed
(
__x86_64__
)

418 iàĞ
	gcom·t32
 )

420 
	gd
->
	g¬ch
.
	gis_32b™_pv
 = 
d
->
¬ch
.
has_32b™_shšfo
 = 1;

421 
	gv
->
	gvıu_šfo
 = (*)&
d
->
sh¬ed_šfo
->
com·t
.
vıu_šfo
[0];

422 iàĞ
£tup_com·t_¬g_xÏt
(
v
) != 0 )

423 
BUG
();

427 
	gÄ_·ges
 = 
compu‹_dom0_Ä_·ges
(
d
, &
·rms
, 
š™rd_Ën
);

429 iàĞ
	g·rms
.
	g·e
 =ğ
PAEKERN_ex‹nded_ü3
 )

430 
£t_b™
(
VMASST_TYPE_·e_ex‹nded_ü3
, &
d
->
vm_assi¡
);

432 iàĞ(
	g·rms
.
	gvœt_hv_¡¬t_low
 !ğ
UNSET_ADDR
è&& 
–f_32b™
(&
–f
) )

434 
mask
 = (1UL << 
L2_PAGETABLE_SHIFT
) - 1;

435 
	gv®ue
 = (
·rms
.
vœt_hv_¡¬t_low
 + 
mask
) & ~mask;

436 
BUG_ON
(!
is_pv_32b™_domaš
(
d
));

437 #ià
defšed
(
__i386__
)

438 iàĞ
	gv®ue
 > 
	gHYPERVISOR_VIRT_START
 )

439 
·nic
("Domain 0ƒxpectsoo high‡ hypervisor start‡ddress.\n");

441 iàĞ
	gv®ue
 > 
	g__HYPERVISOR_COMPAT_VIRT_START
 )

442 
·nic
("Domain 0ƒxpectsoo high‡ hypervisor start‡ddress.\n");

443 
HYPERVISOR_COMPAT_VIRT_START
(
d
) =

444 
max_t
(, 
m2p_com·t_v¡¬t
, 
v®ue
);

448 iàĞ(
	g·rms
.
	gp2m_ba£
 !ğ
UNSET_ADDR
è&& 
–f_32b™
(&
–f
) )

450 
´štk
(
XENLOG_WARNING
 "P2Mable base ignored\n");

451 
	g·rms
.
	gp2m_ba£
 = 
UNSET_ADDR
;

454 
domaš_£t_®loc_b™size
(
d
);

463 
	gv_¡¬t
 = 
·rms
.
vœt_ba£
;

464 
	gvk”n_¡¬t
 = 
·rms
.
vœt_k¡¬t
;

465 
	gvk”n_’d
 = 
·rms
.
vœt_k’d
;

466 iàĞ
	g·rms
.
	g–f_nÙes
[
XEN_ELFNOTE_MOD_START_PFN
].
	gd©a
.
	gnum
 )

468 
	gvš™rd_¡¬t
 = 
vš™rd_’d
 = 0;

469 
	gvphysm­_¡¬t
 = 
round_pgup
(
vk”n_’d
);

473 
	gvš™rd_¡¬t
 = 
round_pgup
(
vk”n_’d
);

474 
	gvš™rd_’d
 = 
vš™rd_¡¬t
 + 
š™rd_Ën
;

475 
	gvphysm­_¡¬t
 = 
round_pgup
(
vš™rd_’d
);

477 
	gvphysm­_’d
 = 
vphysm­_¡¬t
 + (
Ä_·ges
 * (!
is_pv_32Ú64_domaš
(
d
) ?

480 iàĞ
	g·rms
.
	gp2m_ba£
 !ğ
UNSET_ADDR
 )

481 
vphysm­_’d
 = 
vphysm­_¡¬t
;

482 
	gv¡¬tšfo_¡¬t
 = 
round_pgup
(
vphysm­_’d
);

483 
	gv¡¬tšfo_’d
 = (
v¡¬tšfo_¡¬t
 +

484 (
¡¬t_šfo
) +

485 (
dom0_vga_cÚsŞe_šfo
));

486 
	gv±_¡¬t
 = 
round_pgup
(
v¡¬tšfo_’d
);

487  
	gÄ_±_·ges
 = 2; ;‚r_pt_pages++ )

489 
	gv±_’d
 = 
v±_¡¬t
 + (
Ä_±_·ges
 * 
PAGE_SIZE
);

490 
	gv¡ack_¡¬t
 = 
v±_’d
;

491 
	gv¡ack_’d
 = 
v¡ack_¡¬t
 + 
PAGE_SIZE
;

492 
	gv_’d
 = (
v¡ack_’d
 + (1UL<<22)-1) & ~((1UL<<22)-1);

493 iàĞ(
	gv_’d
 - 
	gv¡ack_’d
) < (512UL << 10) )

494 
	gv_’d
 += 1UL << 22;

495 #ià
defšed
(
__i386__
)

497 iàĞ(((
	gv_’d
 - 
	gv_¡¬t
 + ((1UL<<
	gL2_PAGETABLE_SHIFT
)-1)) >>

498 
	gL2_PAGETABLE_SHIFT
è+ 5è<ğ
Ä_±_·ges
 )

500 #–ià
defšed
(
__x86_64__
)

501 
	#NR
(
_l
,
_h
,
_s
) \

502 (((((
_h
è+ ((1UL<<(
_s
))-1)) & ~((1UL<<(_s))-1)) - \

503 ((
_l
è& ~((1UL<<(
_s
))-1))è>> (_s))

	)

505 
NR
(
v_¡¬t
, 
v_’d
, 
L4_PAGETABLE_SHIFT
) +

506 (!
is_pv_32Ú64_domaš
(
d
) ?

507 
NR
(
v_¡¬t
, 
v_’d
, 
L3_PAGETABLE_SHIFT
) :

509 
NR
(
v_¡¬t
, 
v_’d
, 
L2_PAGETABLE_SHIFT
))

510 <ğ
Ä_±_·ges
 )

515 
	gcouÁ
 = 
v_’d
 - 
v_¡¬t
;

516 iàĞ
	gvš™rd_¡¬t
 )

517 
	gcouÁ
 -ğ
PAGE_ALIGN
(
š™rd_Ën
);

518 
	gÜd”
 = 
g‘_Üd”_äom_by‹s
(
couÁ
);

519 iàĞ(1UL << 
	gÜd”
è+ 
PFN_UP
(
š™rd_Ën
è> 
	gÄ_·ges
 )

520 
·nic
("Domain 0‡llocation isoo small for kernel image.\n");

522 iàĞ
	g·rms
.
	gp2m_ba£
 !ğ
UNSET_ADDR
 )

524 
vphysm­_¡¬t
 = 
·rms
.
p2m_ba£
;

525 
	gvphysm­_’d
 = 
vphysm­_¡¬t
 + 
Ä_·ges
 * ();

527 #ifdeà
__i386__


528 iàĞ!
‹¡_b™
(
XENFEAT_·e_pgdœ_above_4gb
, 
·rms
.
f_suµÜ‹d
) )

529 
	g·ge
 = 
®loc_domh—p_·ges
(
d
, 
Üd”
, 
MEMF_b™s
(32));

532 
	g·ge
 = 
®loc_domh—p_·ges
(
d
, 
Üd”
, 0);

533 iàĞ
	g·ge
 =ğ
NULL
 )

534 
·nic
("Notƒnough RAM for domain 0‡llocation.\n");

535 
	g®loc_¥â
 = 
·ge_to_mâ
(
·ge
);

536 
	g®loc_•â
 = 
®loc_¥â
 + 
d
->
tÙ_·ges
;

538 iàĞ
	gš™rd_Ën
 )

540 
	gš™rd_pâ
 = 
vš™rd_¡¬t
 ?

541 (
vš™rd_¡¬t
 - 
v_¡¬t
è>> 
PAGE_SHIFT
 :

542 
d
->
tÙ_·ges
;

543 
	gš™rd_mâ
 = 
mâ
 = 
š™rd
->
mod_¡¬t
;

544 
	gcouÁ
 = 
PFN_UP
(
š™rd_Ën
);

545 #ifdeà
__x86_64__


546 iàĞ
	gd
->
	g¬ch
.
	gphy§ddr_b™size
 &&

547 ((
	gmâ
 + 
	gcouÁ
 - 1è>> (
	gd
->
	g¬ch
.
	gphy§ddr_b™size
 - 
	gPAGE_SHIFT
)) )

549 
	gÜd”
 = 
g‘_Üd”_äom_·ges
(
couÁ
);

550 
	g·ge
 = 
®loc_domh—p_·ges
(
d
, 
Üd”
, 0);

551 iàĞ!
	g·ge
 )

552 
·nic
("Notƒnough RAM for domain 0 initrd.\n");

553  
	gcouÁ
 = -
couÁ
; 
	gÜd”
--; )

554 iàĞ
	gcouÁ
 & (1UL << 
	gÜd”
) )

556 
ä“_domh—p_·ges
(
·ge
, 
Üd”
);

557 
	g·ge
 +ğ1UL << 
Üd”
;

559 
memıy
(
·ge_to_vœt
(
·ge
), 
mâ_to_vœt
(
š™rd
->
mod_¡¬t
),

560 
š™rd_Ën
);

561 
	gm±_®loc
 = (
·ddr_t
)
š™rd
->
mod_¡¬t
 << 
PAGE_SHIFT
;

562 
š™_domh—p_·ges
(
m±_®loc
,

563 
m±_®loc
 + 
PAGE_ALIGN
(
š™rd_Ën
));

564 
	gš™rd
->
	gmod_¡¬t
 = 
š™rd_mâ
 = 
·ge_to_mâ
(
·ge
);

568  
	gcouÁ
-- )

569 iàĞ
assign_·ges
(
d
, 
mâ_to_·ge
(
mâ
++), 0, 0) )

570 
BUG
();

571 
	gš™rd
->
	gmod_’d
 = 0;

574 
´štk
("PHYSICAL MEMORY ARRANGEMENT:\n"

575 " Dom0‡Îoc.: %"
PRI·ddr
"->%"PRIpaddr,

576 
pâ_to_·ddr
(
®loc_¥â
),…â_to_·ddr(
®loc_•â
));

577 iàĞ
	gd
->
	gtÙ_·ges
 < 
	gÄ_·ges
 )

578 
´štk
(" (%lu…ageso be‡llocated)",

579 
Ä_·ges
 - 
d
->
tÙ_·ges
);

580 iàĞ
	gš™rd
 )

582 
	gm±_®loc
 = (
·ddr_t
)
š™rd
->
mod_¡¬t
 << 
PAGE_SHIFT
;

583 
´štk
("\ÀIn™.„amdisk: %"
PRI·ddr
"->%"PRIpaddr,

584 
m±_®loc
, m±_®loø+ 
š™rd_Ën
);

586 
´štk
("\nVIRTUAL MEMORY ARRANGEMENT:\n"

594 
_p
(
vk”n_¡¬t
), _p(
vk”n_’d
),

595 
_p
(
vš™rd_¡¬t
), _p(
vš™rd_’d
),

596 
_p
(
vphysm­_¡¬t
), _p(
vphysm­_’d
),

597 
_p
(
v¡¬tšfo_¡¬t
), _p(
v¡¬tšfo_’d
),

598 
_p
(
v±_¡¬t
), _p(
v±_’d
),

599 
_p
(
v¡ack_¡¬t
), _p(
v¡ack_’d
),

600 
_p
(
v_¡¬t
), _p(
v_’d
));

601 
´štk
(" ENTRY ADDRESS: %p\n", 
_p
(
·rms
.
vœt_’Œy
));

603 
	gm±_®loc
 = (
v±_¡¬t
 - 
v_¡¬t
è+ 
pâ_to_·ddr
(
®loc_¥â
);

604 iàĞ
	gvš™rd_¡¬t
 )

605 
	gm±_®loc
 -ğ
PAGE_ALIGN
(
š™rd_Ën
);

607 #ià
defšed
(
__i386__
)

612 iàĞ
	gv_¡¬t
 < (1UL<<30) )

614 
´štk
("Initial†oading isn't‡llowedo†owest 1GB of memory.\n");

615  -
	gEINVAL
;

618 
	gm±
.
	gmod_¡¬t
 = 
m±_®loc
 >> 
PAGE_SHIFT
;

619 
	gm±
.
	gmod_’d
 = 
v±_’d
 - 
v±_¡¬t
;

620 
	gm±_±r
 = 
boÙ¡¿p_m­
(&
m±
);

621 
	#MPT_ALLOC
(
n
è(
m±_±r
 +ğÒ)*
PAGE_SIZE
, 
m±_®loc
 +ğÒ)*PAGE_SIZE)

	)

624 
	gl3¡¬t
 = 
l3b
 = 
m±_±r
; 
MPT_ALLOC
(1);

625 
	gl2¡¬t
 = 
l2b
 = 
m±_±r
; 
MPT_ALLOC
(4);

626 
	gi
 = 0; i < 
	gL3_PAGETABLE_ENTRIES
; i++) {

627 iàĞ
	gi
 < 3 )

628 
ş—r_·ge
(
l2b
 + 
i
 * 
L2_PAGETABLE_ENTRIES
);

630 
cİy_·ge
(
l2b
 + 
i
 * 
L2_PAGETABLE_ENTRIES
,

631 
idË_pg_bË_l2
 + 
i
 * 
L2_PAGETABLE_ENTRIES
);

632 
	gl3b
[
i
] = 
l3e_äom_pâ
(
m±
.
mod_¡¬t
 + 1 + i, 
L3_PROT
);

633 
	gl2b
[(
LINEAR_PT_VIRT_START
 >> 
L2_PAGETABLE_SHIFT
)+
i
] =

634 
l2e_äom_pâ
(
m±
.
mod_¡¬t
 + 1 + 
i
, 
__PAGE_HYPERVISOR
);

636 
	gv
->
	g¬ch
.
	ggue¡_bË
 = 
·g‘abË_äom_pâ
(
m±
.
mod_¡¬t
);

638  
	gi
 = 0; i < 
	gPDPT_L2_ENTRIES
; i++ )

639 
	gl2b
[
l2_lš—r_off£t
(
PERDOMAIN_VIRT_START
è+ 
i
] =

640 
l2e_äom_·ge
(
³rdomaš_±_·ge
(
d
, 
i
), 
__PAGE_HYPERVISOR
);

642 
	gl2b
 +ğ
l2_lš—r_off£t
(
v_¡¬t
);

643 
	gpâ
 = 
®loc_¥â
;

644  
	gcouÁ
 = 0; couÁ < ((
	gv_’d
-
	gv_¡¬t
)>>
	gPAGE_SHIFT
); count++ )

646 iàĞ!(()
	gl1b
 & (
	gPAGE_SIZE
-1)) )

648 
	gl1b
 = 
m±_±r
;

649 *
	gl2b
 = 
l2e_äom_·ddr
(
m±_®loc
, 
L2_PROT
);

650 
MPT_ALLOC
(1);

651 
	gl2b
++;

652 
ş—r_·ge
(
l1b
);

653 iàĞ
	gcouÁ
 == 0 )

654 
l1b
 +ğ
l1_bË_off£t
(
v_¡¬t
);

656 iàĞ
	gcouÁ
 < 
	gš™rd_pâ
 || couÁ >ğ
š™rd_pâ
 + 
PFN_UP
(
š™rd_Ën
) )

657 
mâ
 = 
pâ
++;

659 
	gmâ
 = 
š™rd_mâ
++;

660 *
	gl1b
 = 
l1e_äom_pâ
(
mâ
, 
L1_PROT
);

661 
	gl1b
++;

663 
	g·ge
 = 
mâ_to_·ge
(
mâ
);

664 iàĞ!
g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_wr™abË_·ge
) )

665 
BUG
();

667 #undeà
MPT_ALLOC


670 
	gm±_®loc
 = (
·ddr_t
)
m±
.
mod_¡¬t
 << 
PAGE_SHIFT
;

671 
	gm±_±r
 = 
l3¡¬t
;

672 
	gl2b
 = 
l2¡¬t
 + 
l2_lš—r_off£t
(
v±_¡¬t
);

673 
	gl1¡¬t
 = 
m±_±r
 + (
l2e_g‘_·ddr
(*
l2b
è- 
m±_®loc
);

674 
	gl1b
 = 
l1¡¬t
 + 
l1_bË_off£t
(
v±_¡¬t
);

675  
	gcouÁ
 = 0; couÁ < 
	gÄ_±_·ges
; count++ )

677 
	g·ge
 = 
mâ_to_·ge
(
l1e_g‘_pâ
(*
l1b
));

678 iàĞ!
	gİt_dom0_shadow
 )

679 
l1e_»move_æags
(*
l1b
, 
_PAGE_RW
);

681 iàĞ!
g‘_·ge_ty³
(
·ge
, 
PGT_wr™abË_·ge
) )

682 
BUG
();

684  
	gcouÁ
 )

687 
·ge
->
u
.
šu£
.
ty³_šfo
 &ğ~
PGT_ty³_mask
;

688 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 |ğ
PGT_l3_·ge_bË
;

689 
g‘_·ge
(
·ge
, 
d
);

692 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
++;

693 
	g·ge
->
	gcouÁ_šfo
++;

694 
£t_b™
(
_PGT_pšÃd
, &
·ge
->
u
.
šu£
.
ty³_šfo
);

697 
·ge
->
u
.
šu£
.
ty³_šfo
 &ğ~
PGT_ty³_mask
;

698 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 |ğ
PGT_l2_·ge_bË
;

699 iàĞ
	gcouÁ
 == 4 )

700 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_·e_x’_l2
;

701 
g‘_·ge
(
·ge
, 
d
);

704 
·ge
->
u
.
šu£
.
ty³_šfo
 &ğ~
PGT_ty³_mask
;

705 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 |ğ
PGT_l1_·ge_bË
;

706 
g‘_·ge
(
·ge
, 
d
);

709 iàĞ!(()++
	gl1b
 & (
	gPAGE_SIZE
 - 1)) )

710 
	gl1b
 = 
m±_±r
 + (
l2e_g‘_·ddr
(*++
l2b
è- 
m±_®loc
);

717 
	gl3¡¬t
[0] = 
l3e_äom_·ddr
(
__·
(
idË_pg_bË_l2
), 
L3_PROT
);

719 #–ià
defšed
(
__x86_64__
)

722 iàĞ!
is_pv_32Ú64_domaš
(
d
) ?

723 ((
	gv_¡¬t
 < 
	gHYPERVISOR_VIRT_END
) &&

724 (
	gv_’d
 > 
	gHYPERVISOR_VIRT_START
)) :

725 (
v_’d
 > 
HYPERVISOR_COMPAT_VIRT_START
(
d
)) )

727 
´štk
("DOM0 image overlaps with Xen…rivate‡rea.\n");

728  -
	gEINVAL
;

731 iàĞ
is_pv_32Ú64_domaš
(
d
) )

733 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gç§ã_ÿÎback_cs
 = 
FLAT_COMPAT_KERNEL_CS
;

734 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gev’t_ÿÎback_cs
 = 
FLAT_COMPAT_KERNEL_CS
;

738 iàĞ!
is_pv_32Ú64_domaš
(
d
) )

740 
maddr_to_·ge
(
m±_®loc
)->
	gu
.
	gšu£
.
	gty³_šfo
 = 
PGT_l4_·ge_bË
;

741 
	gl4¡¬t
 = 
l4b
 = 
__va
(
m±_®loc
); 
	gm±_®loc
 +ğ
PAGE_SIZE
;

745 
	g·ge
 = 
®loc_domh—p_·ge
(
NULL
, 0);

746 iàĞ!
	g·ge
 )

747 
·nic
("Notƒnough RAM for domain 0 PML4.\n");

748 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 = 
PGT_l4_·ge_bË
|
PGT_v®id©ed
|1;

749 
	gl4¡¬t
 = 
l4b
 = 
·ge_to_vœt
(
·ge
);

751 
cİy_·ge
(
l4b
, 
idË_pg_bË
);

752 
	gl4b
[0] = 
l4e_em±y
();

753 
	gl4b
[
l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

754 
l4e_äom_·ddr
(
__·
(
l4¡¬t
), 
__PAGE_HYPERVISOR
);

755 
	gl4b
[
l4_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

756 
l4e_äom_·ddr
(
__·
(
d
->
¬ch
.
mm_³rdomaš_l3
), 
__PAGE_HYPERVISOR
);

757 
	gv
->
	g¬ch
.
	ggue¡_bË
 = 
·g‘abË_äom_·ddr
(
__·
(
l4¡¬t
));

758 iàĞ
is_pv_32Ú64_domaš
(
d
) )

759 
	gv
->
	g¬ch
.
	ggue¡_bË_u£r
 = 
v
->
¬ch
.
gue¡_bË
;

761 
	gl4b
 +ğ
l4_bË_off£t
(
v_¡¬t
);

762 
	gpâ
 = 
®loc_¥â
;

763  
	gcouÁ
 = 0; couÁ < ((
	gv_’d
-
	gv_¡¬t
)>>
	gPAGE_SHIFT
); count++ )

765 iàĞ!(()
	gl1b
 & (
	gPAGE_SIZE
-1)) )

767 
maddr_to_·ge
(
m±_®loc
)->
	gu
.
	gšu£
.
	gty³_šfo
 = 
PGT_l1_·ge_bË
;

768 
	gl1¡¬t
 = 
l1b
 = 
__va
(
m±_®loc
); 
	gm±_®loc
 +ğ
PAGE_SIZE
;

769 
ş—r_·ge
(
l1b
);

770 iàĞ
	gcouÁ
 == 0 )

771 
l1b
 +ğ
l1_bË_off£t
(
v_¡¬t
);

772 iàĞ!(()
	gl2b
 & (
	gPAGE_SIZE
-1)) )

774 
maddr_to_·ge
(
m±_®loc
)->
	gu
.
	gšu£
.
	gty³_šfo
 = 
PGT_l2_·ge_bË
;

775 
	gl2¡¬t
 = 
l2b
 = 
__va
(
m±_®loc
); 
	gm±_®loc
 +ğ
PAGE_SIZE
;

776 
ş—r_·ge
(
l2b
);

777 iàĞ
	gcouÁ
 == 0 )

778 
l2b
 +ğ
l2_bË_off£t
(
v_¡¬t
);

779 iàĞ!(()
	gl3b
 & (
	gPAGE_SIZE
-1)) )

781 
maddr_to_·ge
(
m±_®loc
)->
	gu
.
	gšu£
.
	gty³_šfo
 =

782 
PGT_l3_·ge_bË
;

783 
	gl3¡¬t
 = 
l3b
 = 
__va
(
m±_®loc
); 
	gm±_®loc
 +ğ
PAGE_SIZE
;

784 
ş—r_·ge
(
l3b
);

785 iàĞ
	gcouÁ
 == 0 )

786 
l3b
 +ğ
l3_bË_off£t
(
v_¡¬t
);

787 *
	gl4b
 = 
l4e_äom_·ddr
(
__·
(
l3¡¬t
), 
L4_PROT
);

788 
	gl4b
++;

790 *
	gl3b
 = 
l3e_äom_·ddr
(
__·
(
l2¡¬t
), 
L3_PROT
);

791 
	gl3b
++;

793 *
	gl2b
 = 
l2e_äom_·ddr
(
__·
(
l1¡¬t
), 
L2_PROT
);

794 
	gl2b
++;

796 iàĞ
	gcouÁ
 < 
	gš™rd_pâ
 || couÁ >ğ
š™rd_pâ
 + 
PFN_UP
(
š™rd_Ën
) )

797 
mâ
 = 
pâ
++;

799 
	gmâ
 = 
š™rd_mâ
++;

800 *
	gl1b
 = 
l1e_äom_pâ
(
mâ
, (!
is_pv_32Ú64_domaš
(
d
) ?

801 
L1_PROT
 : 
COMPAT_L1_PROT
));

802 
	gl1b
++;

804 
	g·ge
 = 
mâ_to_·ge
(
mâ
);

805 iàĞ(
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 == 0) &&

806 !
g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_wr™abË_·ge
) )

807 
BUG
();

810 iàĞ
is_pv_32Ú64_domaš
(
d
) )

813  
	gi
 = 0, 
	gl3b
 = 
l3¡¬t
; i < 4; ++i, ++l3tab )

815 iàĞ!
l3e_g‘_š‹
(*
l3b
) )

817 
maddr_to_·ge
(
m±_®loc
)->
	gu
.
	gšu£
.
	gty³_šfo
 = 
PGT_l2_·ge_bË
;

818 
	gl2b
 = 
__va
(
m±_®loc
); 
	gm±_®loc
 +ğ
PAGE_SIZE
;

819 
ş—r_·ge
(
l2b
);

820 *
	gl3b
 = 
l3e_äom_·ddr
(
__·
(
l2b
), 
L3_PROT
);

822 iàĞ
	gi
 == 3 )

823 
l3e_g‘_·ge
(*
l3b
)->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_·e_x’_l2
;

826 
	gl2b
 = 
l3e_to_l2e
(
l3¡¬t
[3]);

827 
memıy
(&
l2b
[
COMPAT_L2_PAGETABLE_FIRST_XEN_SLOT
(
d
)],

828 &
com·t_idË_pg_bË_l2
[
l2_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)],

829 
COMPAT_L2_PAGETABLE_XEN_SLOTS
(
d
è* (*
l2b
));

833 
	gl4b
 = 
l4¡¬t
 + 
l4_bË_off£t
(
v±_¡¬t
);

834 
	gl3¡¬t
 = 
l3b
 = 
l4e_to_l3e
(*
l4b
);

835 
	gl3b
 +ğ
l3_bË_off£t
(
v±_¡¬t
);

836 
	gl2¡¬t
 = 
l2b
 = 
l3e_to_l2e
(*
l3b
);

837 
	gl2b
 +ğ
l2_bË_off£t
(
v±_¡¬t
);

838 
	gl1¡¬t
 = 
l1b
 = 
l2e_to_l1e
(*
l2b
);

839 
	gl1b
 +ğ
l1_bË_off£t
(
v±_¡¬t
);

840  
	gcouÁ
 = 0; couÁ < 
	gÄ_±_·ges
; count++ )

842 
l1e_»move_æags
(*
l1b
, 
_PAGE_RW
);

843 
	g·ge
 = 
mâ_to_·ge
(
l1e_g‘_pâ
(*
l1b
));

846 
	g·ge
->
	gcouÁ_šfo
 = 
PGC_®loÿ‹d
 | 3;

847 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 |ğ
PGT_v®id©ed
 | 1;

850 iàĞ(
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 & 
	gPGT_ty³_mask
) ==

851 (!
is_pv_32Ú64_domaš
(
d
) ?

852 
PGT_l4_·ge_bË
 : 
PGT_l3_·ge_bË
) )

854 
·ge
->
couÁ_šfo
 += 1;

855 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 +ğ1 | 
PGT_pšÃd
;

859 iàĞ!(()++
	gl1b
 & (
	gPAGE_SIZE
 - 1)) )

861 iàĞ!(()++
	gl2b
 & (
	gPAGE_SIZE
 - 1)) )

863 iàĞ!(()++
	gl3b
 & (
	gPAGE_SIZE
 - 1)) )

864 
	gl3¡¬t
 = 
l3b
 = 
l4e_to_l3e
(*++
l4b
);

865 
	gl2¡¬t
 = 
l2b
 = 
l3e_to_l2e
(*
l3b
);

867 
	gl1¡¬t
 = 
l1b
 = 
l2e_to_l1e
(*
l2b
);

874  
	gi
 = 0; i < 
	gXEN_LEGACY_MAX_VCPUS
; i++ )

875 
sh¬ed_šfo
(
d
, 
vıu_šfo
[
i
].
evtchn_upÿÎ_mask
) = 1;

877 
´štk
("Dom0 ha maximum %u VCPUs\n", 
İt_dom0_max_vıus
);

879 
	gıu
 = 
fœ¡_ıu
(
ıupoŞ0
->
ıu_v®id
);

880  
	gi
 = 1; i < 
	gİt_dom0_max_vıus
; i++ )

882 
	gıu
 = 
cyşe_ıu
(
ıu
, 
ıupoŞ0
->
ıu_v®id
);

883 ()
®loc_vıu
(
d
, 
i
, 
ıu
);

887 iàĞ
·gšg_mode_’abËd
(
d
) )

888 
·gšg_upd©e_·gšg_modes
(
v
);

890 
upd©e_ü3
(
v
);

894 
_wr™e_ü3
(
v
->
¬ch
.
ü3
, 6);

896 
wr™e_±ba£
(
v
);

900 
	g–f
.
	gde¡
 = (*)
vk”n_¡¬t
;

901 
–f_lßd_bš¬y
(&
–f
);

902 
boÙ¡¿p_m­
(
NULL
);

904 iàĞ
	gUNSET_ADDR
 !ğ
·rms
.
vœt_hy³rÿÎ
 )

906 iàĞ(
·rms
.
vœt_hy³rÿÎ
 < 
v_¡¬t
) ||

907 (
·rms
.
vœt_hy³rÿÎ
 >ğ
v_’d
) )

910 
_wr™e_ü3
(
cu¼’t
->
¬ch
.
ü3
, 6);

912 
wr™e_±ba£
(
cu¼’t
);

914 
´štk
("Invalid HYPERCALL_PAGE field in ELF‚otes.\n");

917 
hy³rÿÎ_·ge_š™Ÿli£
(

918 
d
, (*)()
·rms
.
vœt_hy³rÿÎ
);

922 
disÿrd_š™Ÿl_images
();

925 
	gsi
 = (
¡¬t_šfo_t
 *)
v¡¬tšfo_¡¬t
;

926 
ş—r_·ge
(
si
);

927 
	gsi
->
	gÄ_·ges
 = 
Ä_·ges
;

929 
	gsi
->
	gsh¬ed_šfo
 = 
vœt_to_maddr
(
d
->
sh¬ed_šfo
);

931 
	gsi
->
	gæags
 = 
SIF_PRIVILEGED
 | 
SIF_INITDOMAIN
;

932 iàĞ!
	gvš™rd_¡¬t
 && 
	gš™rd_Ën
 )

933 
	gsi
->
	gæags
 |ğ
SIF_MOD_START_PFN
;

934 
	gsi
->
	gæags
 |ğ(
x’_´oûssÜ_pmb™s
 << 8è& 
SIF_PM_MASK
;

935 
	gsi
->
	g±_ba£
 = 
v±_¡¬t
 + 2 * 
PAGE_SIZE
 * !!
is_pv_32Ú64_domaš
(
d
);

936 
	gsi
->
	gÄ_±_äames
 = 
Ä_±_·ges
;

937 
	gsi
->
	gmâ_li¡
 = 
vphysm­_¡¬t
;

938 
¢´štf
(
si
->
magic
, (si->magic), "xen-3.0-x86_%d%s",

939 
–f_64b™
(&
–f
è? 64 : 32, 
·rms
.
·e
 ? "p" : "");

941 
	gcouÁ
 = 
d
->
tÙ_·ges
;

942 #ifdeà
__x86_64__


944 iàĞ
	g·rms
.
	gp2m_ba£
 !ğ
UNSET_ADDR
 )

946 
va
 = 
vphysm­_¡¬t
;

948 iàĞ
	gv_¡¬t
 <ğ
vphysm­_’d
 && 
vphysm­_¡¬t
 <ğ
v_’d
 )

949 
·nic
("DOM0 P->Mable overlaps initial mapping");

951  
	gva
 < 
	gvphysm­_’d
 )

953 iàĞ
	gd
->
	gtÙ_·ges
 + ((
round_pgup
(
vphysm­_’d
è- 
	gva
)

954 >> 
	gPAGE_SHIFT
è+ 3 > 
	gÄ_·ges
 )

955 
·nic
("Dom0‡llocationoo small for initial P->Mable.\n");

957 
	gl4b
 = 
l4¡¬t
 + 
l4_bË_off£t
(
va
);

958 iàĞ!
l4e_g‘_š‹
(*
l4b
) )

960 
	g·ge
 = 
®loc_domh—p_·ge
(
d
, 0);

961 iàĞ!
	g·ge
 )

964 
	g·ge
->
	gcouÁ_šfo
 = 
PGC_®loÿ‹d
 | 2;

965 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 =

966 
PGT_l3_·ge_bË
 | 
PGT_v®id©ed
 | 1;

967 
ş—r_·ge
(
·ge_to_vœt
(
·ge
));

968 *
	gl4b
 = 
l4e_äom_·ge
(
·ge
, 
L4_PROT
);

970 
	gl3b
 = 
·ge_to_vœt
(
l4e_g‘_·ge
(*
l4b
));

971 
	gl3b
 +ğ
l3_bË_off£t
(
va
);

972 iàĞ!
l3e_g‘_š‹
(*
l3b
) )

974 iàĞ
	gıu_has_·ge1gb
 &&

975 !(
	gva
 & ((1UL << 
	gL3_PAGETABLE_SHIFT
) - 1)) &&

976 
	gvphysm­_’d
 >ğ
va
 + (1UL << 
L3_PAGETABLE_SHIFT
) &&

977 (
·ge
 = 
®loc_domh—p_·ges
(
d
,

978 
L3_PAGETABLE_SHIFT
 -

979 
PAGE_SHIFT
,

980 0)è!ğ
NULL
 )

982 *
l3b
 = 
l3e_äom_·ge
(
·ge
,

983 
L1_PROT
|
_PAGE_DIRTY
|
_PAGE_PSE
);

984 
	gva
 +ğ1UL << 
L3_PAGETABLE_SHIFT
;

987 iàĞ(
	g·ge
 = 
®loc_domh—p_·ge
(
d
, 0)è=ğ
NULL
 )

992 
	g·ge
->
	gcouÁ_šfo
 = 
PGC_®loÿ‹d
 | 2;

993 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 =

994 
PGT_l2_·ge_bË
 | 
PGT_v®id©ed
 | 1;

995 
ş—r_·ge
(
·ge_to_vœt
(
·ge
));

996 *
	gl3b
 = 
l3e_äom_·ge
(
·ge
, 
L3_PROT
);

999 
	gl2b
 = 
·ge_to_vœt
(
l3e_g‘_·ge
(*
l3b
));

1000 
	gl2b
 +ğ
l2_bË_off£t
(
va
);

1001 iàĞ!
l2e_g‘_š‹
(*
l2b
) )

1003 iàĞ!(
	gva
 & ((1UL << 
	gL2_PAGETABLE_SHIFT
) - 1)) &&

1004 
	gvphysm­_’d
 >ğ
va
 + (1UL << 
L2_PAGETABLE_SHIFT
) &&

1005 (
·ge
 = 
®loc_domh—p_·ges
(
d
,

1006 
L2_PAGETABLE_SHIFT
 -

1007 
PAGE_SHIFT
,

1008 0)è!ğ
NULL
 )

1010 *
l2b
 = 
l2e_äom_·ge
(
·ge
,

1011 
L1_PROT
|
_PAGE_DIRTY
|
_PAGE_PSE
);

1012 iàĞ
	gİt_®low_su³½age
 )

1013 
g‘_su³½age
(
·ge_to_mâ
(
·ge
), 
d
);

1014 
	gva
 +ğ1UL << 
L2_PAGETABLE_SHIFT
;

1017 iàĞ(
	g·ge
 = 
®loc_domh—p_·ge
(
d
, 0)è=ğ
NULL
 )

1022 
	g·ge
->
	gcouÁ_šfo
 = 
PGC_®loÿ‹d
 | 2;

1023 
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 =

1024 
PGT_l1_·ge_bË
 | 
PGT_v®id©ed
 | 1;

1025 
ş—r_·ge
(
·ge_to_vœt
(
·ge
));

1026 *
	gl2b
 = 
l2e_äom_·ge
(
·ge
, 
L2_PROT
);

1029 
	gl1b
 = 
·ge_to_vœt
(
l2e_g‘_·ge
(*
l2b
));

1030 
	gl1b
 +ğ
l1_bË_off£t
(
va
);

1031 
BUG_ON
(
l1e_g‘_š‹
(*
l1b
));

1032 
	g·ge
 = 
®loc_domh—p_·ge
(
d
, 0);

1033 iàĞ!
	g·ge
 )

1035 *
	gl1b
 = 
l1e_äom_·ge
(
·ge
, 
L1_PROT
|
_PAGE_DIRTY
);

1036 
	gva
 +ğ
PAGE_SIZE
;

1037 
	gva
 &ğ
PAGE_MASK
;

1039 iàĞ!
	g·ge
 )

1040 
·nic
("Notƒnough RAM for DOM0 P->Mable.\n");

1045  
	gpâ
 = 0;…â < 
	gcouÁ
;…fn++ )

1047 
	gmâ
 = 
pâ
 + 
®loc_¥â
;

1048 iàĞ
	gpâ
 >ğ
š™rd_pâ
 )

1050 iàĞ
pâ
 < 
š™rd_pâ
 + 
PFN_UP
(
š™rd_Ën
) )

1051 
mâ
 = 
š™rd
->
mod_¡¬t
 + (
pâ
 - 
š™rd_pâ
);

1053 
	gmâ
 -ğ
PFN_UP
(
š™rd_Ën
);

1055 #iâdeà
NDEBUG


1056 
	#REVERSE_START
 ((
v_’d
 - 
v_¡¬t
è>> 
PAGE_SHIFT
)

	)

1057 iàĞ
	gpâ
 > 
	gREVERSE_START
 && (
	gvš™rd_¡¬t
 ||…â < 
	gš™rd_pâ
) )

1058 
	gmâ
 = 
®loc_•â
 - (
pâ
 - 
REVERSE_START
);

1060 iàĞ!
is_pv_32Ú64_domaš
(
d
) )

1061 ((*)
	gvphysm­_¡¬t
)[
pâ
] = 
mâ
;

1063 ((*)
	gvphysm­_¡¬t
)[
pâ
] = 
mâ
;

1064 
£t_gpâ_äom_mâ
(
mâ
, 
pâ
);

1065 ià(!(
	gpâ
 & 0xfffff))

1066 
´oûss_³ndšg_soáœqs
();

1068 
	gsi
->
	gfœ¡_p2m_pâ
 = 
pâ
;

1069 
	gsi
->
	gÄ_p2m_äames
 = 
d
->
tÙ_·ges
 - 
couÁ
;

1070 
·ge_li¡_fÜ_—ch
 ( 
·ge
, &
d
->
·ge_li¡
 )

1072 
	gmâ
 = 
·ge_to_mâ
(
·ge
);

1073 
BUG_ON
(
SHARED_M2P
(
g‘_gpâ_äom_mâ
(
mâ
)));

1074 iàĞ
g‘_gpâ_äom_mâ
(
mâ
è>ğ
couÁ
 )

1076 
BUG_ON
(
is_pv_32b™_domaš
(
d
));

1077 iàĞ!
	g·ge
->
	gu
.
	gšu£
.
	gty³_šfo
 &&

1078 !
g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_wr™abË_·ge
) )

1079 
BUG
();

1080 ((*)
	gvphysm­_¡¬t
)[
pâ
] = 
mâ
;

1081 
£t_gpâ_äom_mâ
(
mâ
, 
pâ
);

1082 ++
	gpâ
;

1083 ià(!(
	gpâ
 & 0xfffff))

1084 
´oûss_³ndšg_soáœqs
();

1087 
BUG_ON
(
pâ
 !ğ
d
->
tÙ_·ges
);

1088 #iâdeà
NDEBUG


1089 
	g®loc_•â
 +ğ
PFN_UP
(
š™rd_Ën
è+ 
si
->
Ä_p2m_äames
;

1091  
	gpâ
 < 
	gÄ_·ges
 )

1093 iàĞ(
	g·ge
 = 
®loc_chunk
(
d
, 
Ä_·ges
 - d->
tÙ_·ges
)è=ğ
NULL
 )

1094 
·nic
("Notƒnough RAM for DOM0„eservation.\n");

1095  
	gpâ
 < 
	gd
->
	gtÙ_·ges
 )

1097 
	gmâ
 = 
·ge_to_mâ
(
·ge
);

1098 #iâdeà
NDEBUG


1099 
	#pâ
 (
Ä_·ges
 - 1 - (
pâ
 - (
®loc_•â
 - 
®loc_¥â
)))

	)

1101 iàĞ!
is_pv_32Ú64_domaš
(
d
) )

1102 ((*)
	gvphysm­_¡¬t
)[
pâ
] = 
mâ
;

1104 ((*)
	gvphysm­_¡¬t
)[
pâ
] = 
mâ
;

1105 
£t_gpâ_äom_mâ
(
mâ
, 
pâ
);

1106 #undeà
pâ


1107 
	g·ge
++; 
	gpâ
++;

1108 ià(!(
	gpâ
 & 0xfffff))

1109 
´oûss_³ndšg_soáœqs
();

1113 iàĞ
	gš™rd_Ën
 != 0 )

1115 
si
->
mod_¡¬t
 = 
vš™rd_¡¬t
 ?: 
š™rd_pâ
;

1116 
	gsi
->
	gmod_Ën
 = 
š™rd_Ën
;

1119 
mem£t
(
si
->
cmd_lše
, 0, (si->cmd_line));

1120 iàĞ
	gcmdlše
 !ğ
NULL
 )

1121 
¡¾ıy
((*)
si
->
cmd_lše
, 
cmdlše
, (si->cmd_line));

1123 iàĞ
fl_cÚsŞe_¡¬t_šfo
((*)(
si
 + 1)) )

1125 
	gsi
->
	gcÚsŞe
.
	gdom0
.
	gšfo_off
 = (
¡¬t_šfo
);

1126 
	gsi
->
	gcÚsŞe
.
	gdom0
.
	gšfo_size
 = (
dom0_vga_cÚsŞe_šfo
);

1129 #ià
defšed
(
__x86_64__
)

1130 iàĞ
is_pv_32Ú64_domaš
(
d
) )

1131 
xÏt_¡¬t_šfo
(
si
, 
XLAT_¡¬t_šfo_cÚsŞe_dom0
);

1136 
_wr™e_ü3
(
cu¼’t
->
¬ch
.
ü3
, 6);

1138 
wr™e_±ba£
(
cu¼’t
);

1141 #ià
defšed
(
__i386__
)

1143 
	gm±
.
	gmod_’d
 = 5 * 
PAGE_SIZE
;

1144 
	gl3¡¬t
 = 
m±_±r
 = 
boÙ¡¿p_m­
(&
m±
);

1145 
	gl2¡¬t
 = 
m±_±r
 + 
PAGE_SIZE
;

1146 
	gl3¡¬t
[0] = 
l3e_äom_pâ
(
m±
.
mod_¡¬t
 + 1, 
L3_PROT
);

1149 iàĞ
·gšg_mode_’abËd
(
d
) )

1150 
·gšg_upd©e_·gšg_modes
(
v
);

1152 
upd©e_ü3
(
v
);

1158 
z­_low_m­pšgs
(
l2¡¬t
);

1161 
upd©e_domaš_w®lşock_time
(
d
);

1163 
	gv
->
	gis_š™Ÿli£d
 = 1;

1164 
ş—r_b™
(
_VPF_down
, &
v
->
·u£_æags
);

1174 
	g»gs
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
;

1175 
	g»gs
->
	gds
 = 
»gs
->
es
 =„egs->
fs
 =„egs->
gs
 =

1176 !
is_pv_32Ú64_domaš
(
d
è? 
FLAT_KERNEL_DS
 : 
FLAT_COMPAT_KERNEL_DS
;

1177 
	g»gs
->
	gss
 = (!
is_pv_32Ú64_domaš
(
d
) ?

1178 
FLAT_KERNEL_SS
 : 
FLAT_COMPAT_KERNEL_SS
);

1179 
	g»gs
->
	gcs
 = (!
is_pv_32Ú64_domaš
(
d
) ?

1180 
FLAT_KERNEL_CS
 : 
FLAT_COMPAT_KERNEL_CS
);

1181 
	g»gs
->
	ge
 = 
·rms
.
vœt_’Œy
;

1182 
	g»gs
->
	ge¥
 = 
v¡ack_’d
;

1183 
	g»gs
->
	gesi
 = 
v¡¬tšfo_¡¬t
;

1184 
	g»gs
->
	geæags
 = 
X86_EFLAGS_IF
;

1186 iàĞ
	gİt_dom0_shadow
 )

1187 iàĞ
·gšg_’abË
(
d
, 
PG_SH_’abË
) == 0 )

1188 
·gšg_upd©e_·gšg_modes
(
v
);

1190 iàĞ
	gsu³rvisÜ_mode_k”Ãl
 )

1192 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gk”Ãl_ss
 &= ~3;

1193 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gu£r_»gs
.
	gss
 &= ~3;

1194 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gu£r_»gs
.
	ges
 &= ~3;

1195 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gu£r_»gs
.
	gds
 &= ~3;

1196 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gu£r_»gs
.
	gfs
 &= ~3;

1197 
	gv
->
	g¬ch
.
	ggue¡_cÚ‹xt
.
	gu£r_»gs
.
	ggs
 &= ~3;

1198 
´štk
("Dom0„uns in„ing 0 (supervisor mode)\n");

1199 iàĞ!
‹¡_b™
(
XENFEAT_su³rvisÜ_mode_k”Ãl
,

1200 
·rms
.
f_suµÜ‹d
) )

1201 
·nic
("Dom0 does‚ot support supervisor-modeƒxecution\n");

1205 iàĞ
‹¡_b™
(
XENFEAT_su³rvisÜ_mode_k”Ãl
, 
·rms
.
f_»quœed
) )

1206 
·nic
("Dom0„equires supervisor-modeƒxecution\n");

1209 
	grc
 = 0;

1212 
	grc
 |ğ
iİÜts_³rm™_acûss
(
dom0
, 0, 0xFFFF);

1213 
	grc
 |ğ
iomem_³rm™_acûss
(
dom0
, 0UL, ~0UL);

1214 
	grc
 |ğ
œqs_³rm™_acûss
(
dom0
, 0, 
d
->
Ä_pœqs
 - 1);

1220 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 0x20, 0x21);

1222 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 0xA0, 0xA1);

1224 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 0x40, 0x43);

1226 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 0x61, 0x61);

1228 iàĞ
	gpmtmr_iİÜt
 )

1229 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 
pmtmr_iİÜt
,…mtmr_ioport + 3);

1231 
	grc
 |ğ
iİÜts_d’y_acûss
(
dom0
, 0xcfc, 0xcff);

1233 
´oûss_dom0_iİÜts_di§bË
();

1239 iàĞ
	gmp_Ïpic_addr
 != 0 )

1241 
mâ
 = 
·ddr_to_pâ
(
mp_Ïpic_addr
);

1242 
	grc
 |ğ
iomem_d’y_acûss
(
dom0
, 
mâ
, mfn);

1245  
	gi
 = 0; i < 
	gÄ_ißpics
; i++ )

1247 
	gmâ
 = 
·ddr_to_pâ
(
mp_ißpics
[
i
].
mpc_­iÿddr
);

1248 iàĞ
	gsmp_found_cÚfig
 )

1249 
	grc
 |ğ
iomem_d’y_acûss
(
dom0
, 
mâ
, mfn);

1253  
	gi
 = 0; i < 
	ge820
.
	gÄ_m­
; i++ )

1255 
	gsâ
, 
	geâ
;

1256 
	gsâ
 = 
max_t
(, 
·ddr_to_pâ
(
e820
.
m­
[
i
].
addr
), 0x100ul);

1257 
	geâ
 = 
·ddr_to_pâ
(
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
 - 1);

1258 iàĞ(
	ge820
.
	gm­
[
i
].
	gty³
 =ğ
E820_UNUSABLE
) &&

1259 (
e820
.
m­
[
i
].
size
 != 0) &&

1260 (
sâ
 <ğ
eâ
) )

1261 
rc
 |ğ
iomem_d’y_acûss
(
dom0
, 
sâ
, 
eâ
);

1264 
BUG_ON
(
rc
 != 0);

1266 
iommu_dom0_š™
(
dom0
);

	@domctl.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/ty³s.h
>

9 
	~<x’/lib.h
>

10 
	~<x’/mm.h
>

11 
	~<x’/gue¡_acûss.h
>

12 
	~<x’/com·t.h
>

13 
	~<x’/pci.h
>

14 
	~<public/domùl.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/domaš.h
>

17 
	~<x’/ev’t.h
>

18 
	~<x’/domaš_·ge.h
>

19 
	~<asm/m¤.h
>

20 
	~<x’/Œaû.h
>

21 
	~<x’/cÚsŞe.h
>

22 
	~<x’/ioÿp.h
>

23 
	~<x’/·gšg.h
>

24 
	~<asm/œq.h
>

25 
	~<asm/hvm/hvm.h
>

26 
	~<asm/hvm/suµÜt.h
>

27 
	~<asm/hvm/ÿch—‰r.h
>

28 
	~<asm/´oûssÜ.h
>

29 
	~<asm/aıi.h
>

30 
	~<asm/hy³rÿÎ.h
>

31 
	~<xsm/xsm.h
>

32 
	~<x’/iommu.h
>

33 
	~<asm/mem_ev’t.h
>

34 
	~<public/mem_ev’t.h
>

35 
	~<asm/mem_sh¬šg.h
>

36 
	~<asm/i387.h
>

38 #ifdeà
XEN_KDB_CONFIG


39 
	~"../kdb/šşude/kdbdefs.h
"

40 
	~"../kdb/šşude/kdb´Ùo.h
"

42 
	tkdbva_t
;

43 
	tkdbbyt_t
;

44 
dbg_rw_mem
(
kdbva_t
, 
kdbbyt_t
 *, , 
domid_t
, , 
ušt64_t
);

47 
	$gdbsx_gue¡_mem_io
(

48 
domid_t
 
domid
, 
x’_domùl_gdbsx_memio
 *
iİ
)

50 
ulÚg
 
l_uva
 = (ulÚg)
iİ
->
uva
;

51 
iİ
->
»maš
 = 
	`dbg_rw_mem
(

52 (
kdbva_t
)
iİ
->
gva
, (
kdbbyt_t
 *)
l_uva
, iİ->
Ën
, 
domid
,

53 
iİ
->
gwr
, iİ->
pgd3v®
);

54  (
iİ
->
»maš
 ? -
EFAULT
 : 0);

55 
	}
}

57 
¬ch_do_domùl
(

58 
x’_domùl
 *
domùl
,

59 
	$XEN_GUEST_HANDLE
(
x’_domùl_t
è
u_domùl
)

61 
»t
 = 0;

63  
domùl
->
cmd
 )

66 
XEN_DOMCTL_shadow_İ
:

68 
domaš
 *
d
;

69 
»t
 = -
ESRCH
;

70 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

71 iàĞ
d
 !ğ
NULL
 )

73 
»t
 = 
	`·gšg_domùl
(
d
,

74 &
domùl
->
u
.
shadow_İ
,

75 
	`gue¡_hªdË_ÿ¡
(
u_domùl
, ));

76 
	`rcu_uÆock_domaš
(
d
);

77 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1);

82 
XEN_DOMCTL_iİÜt_³rmissiÚ
:

84 
domaš
 *
d
;

85 
å
 = 
domùl
->
u
.
iİÜt_³rmissiÚ
.
fœ¡_pÜt
;

86 
Å
 = 
domùl
->
u
.
iİÜt_³rmissiÚ
.
Ä_pÜts
;

88 
»t
 = -
EINVAL
;

89 iàĞ(
å
 + 
Å
) > 65536 )

92 
»t
 = -
ESRCH
;

93 iàĞ
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
) )

96 iàĞ
Å
 == 0 )

97 
»t
 = 0;

98 iàĞ
domùl
->
u
.
iİÜt_³rmissiÚ
.
®low_acûss
 )

99 
»t
 = 
	`iİÜts_³rm™_acûss
(
d
, 
å
, f°+ 
Å
 - 1);

101 
»t
 = 
	`iİÜts_d’y_acûss
(
d
, 
å
, f°+ 
Å
 - 1);

103 
	`rcu_uÆock_domaš
(
d
);

107 
XEN_DOMCTL_g‘·geäamešfo
:

109 
·ge_šfo
 *
·ge
;

110 
mâ
 = 
domùl
->
u
.
g‘·geäamešfo
.
gmâ
;

111 
domid_t
 
dom
 = 
domùl
->
domaš
;

112 
domaš
 *
d
;

114 
»t
 = -
EINVAL
;

116 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
mâ
)) ||

117 
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
dom
)è=ğ
NULL
) )

120 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

122 
»t
 = 
	`xsm_g‘·geäamešfo
(
·ge
);

123 iàĞ
»t
 )

125 
	`rcu_uÆock_domaš
(
d
);

129 iàĞ
	`lik–y
(
	`g‘_·ge
(
·ge
, 
d
)) )

131 
»t
 = 0;

133 
domùl
->
u
.
g‘·geäamešfo
.
ty³
 = 
XEN_DOMCTL_PFINFO_NOTAB
;

135 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0 )

137  
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
 )

139 
PGT_l1_·ge_bË
:

140 
domùl
->
u
.
g‘·geäamešfo
.
ty³
 = 
XEN_DOMCTL_PFINFO_L1TAB
;

142 
PGT_l2_·ge_bË
:

143 
domùl
->
u
.
g‘·geäamešfo
.
ty³
 = 
XEN_DOMCTL_PFINFO_L2TAB
;

145 
PGT_l3_·ge_bË
:

146 
domùl
->
u
.
g‘·geäamešfo
.
ty³
 = 
XEN_DOMCTL_PFINFO_L3TAB
;

148 
PGT_l4_·ge_bË
:

149 
domùl
->
u
.
g‘·geäamešfo
.
ty³
 = 
XEN_DOMCTL_PFINFO_L4TAB
;

154 
	`put_·ge
(
·ge
);

157 
	`rcu_uÆock_domaš
(
d
);

159 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1);

163 
XEN_DOMCTL_g‘·geäamešfo3
:

164 #ifdeà
__x86_64__


165 ià(!
	`has_32b™_shšfo
(
cu¼’t
->
domaš
))

167 
n
, 
j
;

168 
num
 = 
domùl
->
u
.
g‘·geäamešfo3
.num;

169 
domid_t
 
dom
 = 
domùl
->
domaš
;

170 
domaš
 *
d
;

171 
·ge_šfo
 *
·ge
;

172 
x’_pâ_t
 *
¬r
;

174 
»t
 = -
ESRCH
;

175 iàĞ
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
dom
)è=ğ
NULL
) )

178 iàĞ
	`uÆik–y
(
num
 > 1024) ||

179 
	`uÆik–y
(
num
 !ğ
domùl
->
u
.
g‘·geäamešfo3
.num) )

181 
»t
 = -
E2BIG
;

182 
	`rcu_uÆock_domaš
(
d
);

186 
·ge
 = 
	`®loc_domh—p_·ge
(
NULL
, 0);

187 iàĞ!
·ge
 )

189 
»t
 = -
ENOMEM
;

190 
	`rcu_uÆock_domaš
(
d
);

193 
¬r
 = 
	`·ge_to_vœt
(
·ge
);

195  
n
 = 
»t
 = 0;‚ < 
num
; )

197 
k
 = 
	`mš_t
(, 
num
 - 
n
,

198 
PAGE_SIZE
 / (*
¬r
));

200 iàĞ
	`cİy_äom_gue¡_off£t
(
¬r
,

201 
domùl
->
u
.
g‘·geäamešfo3
.
¬¿y
,

202 
n
, 
k
) )

204 
»t
 = -
EFAULT
;

208  
j
 = 0; j < 
k
; j++ )

210 
ty³
 = 0, 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
¬r
[
j
]);

212 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

214 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
mâ
)) ||

215 
	`uÆik–y
(
	`is_x’_h—p_mâ
(
mâ
)) )

216 
ty³
 = 
XEN_DOMCTL_PFINFO_XTAB
;

217 iàĞ
	`xsm_g‘·geäamešfo
(
·ge
) != 0 )

219 iàĞ
	`lik–y
(
	`g‘_·ge
(
·ge
, 
d
)) )

221  
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
 )

223 
PGT_l1_·ge_bË
:

224 
ty³
 = 
XEN_DOMCTL_PFINFO_L1TAB
;

226 
PGT_l2_·ge_bË
:

227 
ty³
 = 
XEN_DOMCTL_PFINFO_L2TAB
;

229 
PGT_l3_·ge_bË
:

230 
ty³
 = 
XEN_DOMCTL_PFINFO_L3TAB
;

232 
PGT_l4_·ge_bË
:

233 
ty³
 = 
XEN_DOMCTL_PFINFO_L4TAB
;

237 iàĞ
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_pšÃd
 )

238 
ty³
 |ğ
XEN_DOMCTL_PFINFO_LPINTAB
;

240 
	`put_·ge
(
·ge
);

243 
ty³
 = 
XEN_DOMCTL_PFINFO_XTAB
;

245 
¬r
[
j
] = 
ty³
;

248 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
g‘·geäamešfo3
.
¬¿y
,

249 
n
, 
¬r
, 
k
) )

251 
»t
 = -
EFAULT
;

255 
n
 +ğ
k
;

258 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
¬r
));

260 
	`rcu_uÆock_domaš
(
d
);

265 
XEN_DOMCTL_g‘·geäamešfo2
:

267 
n
,
j
;

268 
num
 = 
domùl
->
u
.
g‘·geäamešfo2
.num;

269 
domid_t
 
dom
 = 
domùl
->
domaš
;

270 
domaš
 *
d
;

271 
ušt32_t
 *
¬r32
;

272 
»t
 = -
ESRCH
;

274 iàĞ
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
dom
)è=ğ
NULL
) )

277 iàĞ
	`uÆik–y
(
num
 > 1024) )

279 
»t
 = -
E2BIG
;

280 
	`rcu_uÆock_domaš
(
d
);

284 
¬r32
 = 
	`®loc_x’h—p_·ge
();

285 iàĞ!
¬r32
 )

287 
»t
 = -
ENOMEM
;

288 
	`rcu_uÆock_domaš
(
d
);

292 
»t
 = 0;

293  
n
 = 0;‚ < 
num
; )

295 
k
 = 
PAGE_SIZE
 / 4;

296 iàĞ(
num
 - 
n
è< 
k
 )

297 
k
 = 
num
 - 
n
;

299 iàĞ
	`cİy_äom_gue¡_off£t
(
¬r32
,

300 
domùl
->
u
.
g‘·geäamešfo2
.
¬¿y
,

301 
n
, 
k
) )

303 
»t
 = -
EFAULT
;

307  
j
 = 0; j < 
k
; j++ )

309 
·ge_šfo
 *
·ge
;

310 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
¬r32
[
j
]);

312 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

314 iàĞ
domùl
->
cmd
 =ğ
XEN_DOMCTL_g‘·geäamešfo3
)

315 
¬r32
[
j
] = 0;

317 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
mâ
)) ||

318 
	`uÆik–y
(
	`is_x’_h—p_mâ
(
mâ
)) )

319 
¬r32
[
j
] |ğ
XEN_DOMCTL_PFINFO_XTAB
;

320 iàĞ
	`xsm_g‘·geäamešfo
(
·ge
) != 0 )

322 iàĞ
	`lik–y
(
	`g‘_·ge
(
·ge
, 
d
)) )

324 
ty³
 = 0;

326  
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
 )

328 
PGT_l1_·ge_bË
:

329 
ty³
 = 
XEN_DOMCTL_PFINFO_L1TAB
;

331 
PGT_l2_·ge_bË
:

332 
ty³
 = 
XEN_DOMCTL_PFINFO_L2TAB
;

334 
PGT_l3_·ge_bË
:

335 
ty³
 = 
XEN_DOMCTL_PFINFO_L3TAB
;

337 
PGT_l4_·ge_bË
:

338 
ty³
 = 
XEN_DOMCTL_PFINFO_L4TAB
;

342 iàĞ
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_pšÃd
 )

343 
ty³
 |ğ
XEN_DOMCTL_PFINFO_LPINTAB
;

344 
¬r32
[
j
] |ğ
ty³
;

345 
	`put_·ge
(
·ge
);

348 
¬r32
[
j
] |ğ
XEN_DOMCTL_PFINFO_XTAB
;

352 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
g‘·geäamešfo2
.
¬¿y
,

353 
n
, 
¬r32
, 
k
) )

355 
»t
 = -
EFAULT
;

359 
n
 +ğ
k
;

362 
	`ä“_x’h—p_·ge
(
¬r32
);

364 
	`rcu_uÆock_domaš
(
d
);

368 
XEN_DOMCTL_g‘memli¡
:

370 
i
;

371 
domaš
 *
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->domain);

372 
max_pâs
 = 
domùl
->
u
.
g‘memli¡
.max_pfns;

373 
ušt64_t
 
mâ
;

374 
·ge_šfo
 *
·ge
;

376 
»t
 = -
EINVAL
;

377 iàĞ
d
 !ğ
NULL
 )

379 
»t
 = 
	`xsm_g‘memli¡
(
d
);

380 iàĞ
»t
 )

382 
	`rcu_uÆock_domaš
(
d
);

386 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

388 iàĞ
	`uÆik–y
(
d
->
is_dyšg
) ) {

389 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

390 
g‘memli¡_out
;

393 
»t
 = 
i
 = 0;

394 
	`·ge_li¡_fÜ_—ch
(
·ge
, &
d
->
·ge_li¡
)

396 iàĞ
i
 >ğ
max_pâs
 )

398 
mâ
 = 
	`·ge_to_mâ
(
·ge
);

399 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
g‘memli¡
.
bufãr
,

400 
i
, &
mâ
, 1) )

402 
»t
 = -
EFAULT
;

405 ++
i
;

408 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

410 
domùl
->
u
.
g‘memli¡
.
num_pâs
 = 
i
;

411 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1);

412 
g‘memli¡_out
:

413 
	`rcu_uÆock_domaš
(
d
);

418 
XEN_DOMCTL_hy³rÿÎ_š™
:

420 
domaš
 *
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->domain);

421 
gmâ
 = 
domùl
->
u
.
hy³rÿÎ_š™
.gmfn;

422 
mâ
;

423 *
hy³rÿÎ_·ge
;

425 
»t
 = -
ESRCH
;

426 iàĞ
	`uÆik–y
(
d
 =ğ
NULL
) )

429 
»t
 = 
	`xsm_hy³rÿÎ_š™
(
d
);

430 iàĞ
»t
 )

432 
	`rcu_uÆock_domaš
(
d
);

436 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

438 
»t
 = -
EACCES
;

439 iàĞ!
	`mâ_v®id
(
mâ
) ||

440 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_wr™abË_·ge
) )

442 
	`rcu_uÆock_domaš
(
d
);

446 
»t
 = 0;

448 
hy³rÿÎ_·ge
 = 
	`m­_domaš_·ge
(
mâ
);

449 
	`hy³rÿÎ_·ge_š™Ÿli£
(
d
, 
hy³rÿÎ_·ge
);

450 
	`unm­_domaš_·ge
(
hy³rÿÎ_·ge
);

452 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

454 
	`rcu_uÆock_domaš
(
d
);

458 
XEN_DOMCTL_£thvmcÚ‹xt
:

460 
hvm_domaš_cÚ‹xt
 
c
 = { .
size
 = 
domùl
->
u
.
hvmcÚ‹xt
.size };

461 
domaš
 *
d
;

463 
»t
 = -
ESRCH
;

464 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

467 
»t
 = 
	`xsm_hvmcÚ‹xt
(
d
, 
domùl
->
cmd
);

468 iàĞ
»t
 )

469 
£thvmcÚ‹xt_out
;

471 
»t
 = -
EINVAL
;

472 iàĞ!
	`is_hvm_domaš
(
d
) )

473 
£thvmcÚ‹xt_out
;

475 
»t
 = -
ENOMEM
;

476 iàĞ(
c
.
d©a
 = 
	`xm®loc_by‹s
(c.
size
)è=ğ
NULL
 )

477 
£thvmcÚ‹xt_out
;

479 
»t
 = -
EFAULT
;

480 iàĞ
	`cİy_äom_gue¡
(
c
.
d©a
, 
domùl
->
u
.
hvmcÚ‹xt
.
bufãr
, c.
size
) != 0)

481 
£thvmcÚ‹xt_out
;

483 
	`domaš_·u£
(
d
);

484 
»t
 = 
	`hvm_lßd
(
d
, &
c
);

485 
	`domaš_uÅau£
(
d
);

487 
£thvmcÚ‹xt_out
:

488 iàĞ
c
.
d©a
 !ğ
NULL
 )

489 
	`xä“
(
c
.
d©a
);

491 
	`rcu_uÆock_domaš
(
d
);

495 
XEN_DOMCTL_g‘hvmcÚ‹xt
:

497 
hvm_domaš_cÚ‹xt
 
c
 = { 0 };

498 
domaš
 *
d
;

500 
»t
 = -
ESRCH
;

501 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

504 
»t
 = 
	`xsm_hvmcÚ‹xt
(
d
, 
domùl
->
cmd
);

505 iàĞ
»t
 )

506 
g‘hvmcÚ‹xt_out
;

508 
»t
 = -
EINVAL
;

509 iàĞ!
	`is_hvm_domaš
(
d
) )

510 
g‘hvmcÚ‹xt_out
;

512 
c
.
size
 = 
	`hvm_§ve_size
(
d
);

514 iàĞ
	`gue¡_hªdË_is_nuÎ
(
domùl
->
u
.
hvmcÚ‹xt
.
bufãr
) )

517 
domùl
->
u
.
hvmcÚ‹xt
.
size
 = 
c
.size;

518 
»t
 = 0;

519 
g‘hvmcÚ‹xt_out
;

523 
»t
 = -
ENOSPC
;

524 iàĞ
domùl
->
u
.
hvmcÚ‹xt
.
size
 < 
c
.size )

525 
g‘hvmcÚ‹xt_out
;

528 
»t
 = -
ENOMEM
;

529 iàĞ(
c
.
d©a
 = 
	`xm®loc_by‹s
(c.
size
)è=ğ
NULL
 )

530 
g‘hvmcÚ‹xt_out
;

532 
	`domaš_·u£
(
d
);

533 
»t
 = 
	`hvm_§ve
(
d
, &
c
);

534 
	`domaš_uÅau£
(
d
);

536 
domùl
->
u
.
hvmcÚ‹xt
.
size
 = 
c
.
cur
;

537 iàĞ
	`cİy_to_gue¡
(
domùl
->
u
.
hvmcÚ‹xt
.
bufãr
, 
c
.
d©a
, c.
size
) != 0 )

538 
»t
 = -
EFAULT
;

540 
g‘hvmcÚ‹xt_out
:

541 iàĞ
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

542 
»t
 = -
EFAULT
;

544 iàĞ
c
.
d©a
 !ğ
NULL
 )

545 
	`xä“
(
c
.
d©a
);

547 
	`rcu_uÆock_domaš
(
d
);

551 
XEN_DOMCTL_g‘hvmcÚ‹xt_·¹Ÿl
:

553 
domaš
 *
d
;

555 
»t
 = -
ESRCH
;

556 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

559 
»t
 = 
	`xsm_hvmcÚ‹xt
(
d
, 
domùl
->
cmd
);

560 iàĞ
»t
 )

561 
g‘hvmcÚ‹xt_·¹Ÿl_out
;

563 
»t
 = -
EINVAL
;

564 iàĞ!
	`is_hvm_domaš
(
d
) )

565 
g‘hvmcÚ‹xt_·¹Ÿl_out
;

567 
	`domaš_·u£
(
d
);

568 
»t
 = 
	`hvm_§ve_Úe
(
d
, 
domùl
->
u
.
hvmcÚ‹xt_·¹Ÿl
.
ty³
,

569 
domùl
->
u
.
hvmcÚ‹xt_·¹Ÿl
.
š¡ªû
,

570 
domùl
->
u
.
hvmcÚ‹xt_·¹Ÿl
.
bufãr
);

571 
	`domaš_uÅau£
(
d
);

573 
g‘hvmcÚ‹xt_·¹Ÿl_out
:

574 
	`rcu_uÆock_domaš
(
d
);

579 
XEN_DOMCTL_£t_add»ss_size
:

581 
domaš
 *
d
;

583 
»t
 = -
ESRCH
;

584 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

587 
»t
 = 
	`xsm_add»ss_size
(
d
, 
domùl
->
cmd
);

588 iàĞ
»t
 )

590 
	`rcu_uÆock_domaš
(
d
);

594  
domùl
->
u
.
add»ss_size
.
size
 )

596 #ifdeà
CONFIG_COMPAT


598 
»t
 = 
	`sw™ch_com·t
(
d
);

601 
»t
 = 
	`sw™ch_Çtive
(
d
);

605 
»t
 = (
domùl
->
u
.
add»ss_size
.
size
 =ğ
BITS_PER_LONG
è? 0 : -
EINVAL
;

609 
	`rcu_uÆock_domaš
(
d
);

613 
XEN_DOMCTL_g‘_add»ss_size
:

615 
domaš
 *
d
;

617 
»t
 = -
ESRCH
;

618 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

621 
»t
 = 
	`xsm_add»ss_size
(
d
, 
domùl
->
cmd
);

622 iàĞ
»t
 )

624 
	`rcu_uÆock_domaš
(
d
);

628 
domùl
->
u
.
add»ss_size
.
size
 =

629 
	`is_pv_32Ú64_domaš
(
d
è? 32 : 
BITS_PER_LONG
;

631 
»t
 = 0;

632 
	`rcu_uÆock_domaš
(
d
);

634 iàĞ
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

635 
»t
 = -
EFAULT
;

639 
XEN_DOMCTL_£t_machše_add»ss_size
:

641 
domaš
 *
d
;

643 
»t
 = -
ESRCH
;

644 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

647 
»t
 = 
	`xsm_machše_add»ss_size
(
d
, 
domùl
->
cmd
);

648 iàĞ
»t
 )

649 
	`rcu_uÆock_domaš
(
d
);

651 
»t
 = -
EBUSY
;

652 iàĞ
d
->
tÙ_·ges
 > 0 )

653 
£t_machše_add»ss_size_out
;

655 
d
->
¬ch
.
phy§ddr_b™size
 = 
domùl
->
u
.
add»ss_size
.
size
;

657 
»t
 = 0;

658 
£t_machše_add»ss_size_out
:

659 
	`rcu_uÆock_domaš
(
d
);

663 
XEN_DOMCTL_g‘_machše_add»ss_size
:

665 
domaš
 *
d
;

667 
»t
 = -
ESRCH
;

668 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

671 
»t
 = 
	`xsm_machše_add»ss_size
(
d
, 
domùl
->
cmd
);

672 iàĞ
»t
 )

674 
	`rcu_uÆock_domaš
(
d
);

678 
domùl
->
u
.
add»ss_size
.
size
 = 
d
->
¬ch
.
phy§ddr_b™size
;

680 
»t
 = 0;

681 
	`rcu_uÆock_domaš
(
d
);

683 iàĞ
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

684 
»t
 = -
EFAULT
;

690 
XEN_DOMCTL_£ndŒigg”
:

692 
domaš
 *
d
;

693 
vıu
 *
v
;

695 
»t
 = -
ESRCH
;

696 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

699 
»t
 = 
	`xsm_£ndŒigg”
(
d
);

700 iàĞ
»t
 )

701 
£ndŒigg”_out
;

703 
»t
 = -
EINVAL
;

704 iàĞ
domùl
->
u
.
£ndŒigg”
.
vıu
 >ğ
MAX_VIRT_CPUS
 )

705 
£ndŒigg”_out
;

707 
»t
 = -
ESRCH
;

708 iàĞ
domùl
->
u
.
£ndŒigg”
.
vıu
 >ğ
d
->
max_vıus
 ||

709 (
v
 = 
d
->
vıu
[
domùl
->
u
.
£ndŒigg”
.vıu]è=ğ
NULL
 )

710 
£ndŒigg”_out
;

712  
domùl
->
u
.
£ndŒigg”
.
Œigg”
 )

714 
XEN_DOMCTL_SENDTRIGGER_NMI
:

716 
»t
 = 0;

717 iàĞ!
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
) )

718 
	`vıu_kick
(
v
);

722 
XEN_DOMCTL_SENDTRIGGER_POWER
:

724 
»t
 = -
EINVAL
;

725 iàĞ
	`is_hvm_domaš
(
d
) )

727 
»t
 = 0;

728 
	`hvm_aıi_pow”_bu‰Ú
(
d
);

733 
XEN_DOMCTL_SENDTRIGGER_SLEEP
:

735 
	`hvm_aıi_¦“p_bu‰Ú
(
domaš
 *
d
);

737 
»t
 = -
EINVAL
;

738 iàĞ
	`is_hvm_domaš
(
d
) )

740 
»t
 = 0;

741 
	`hvm_aıi_¦“p_bu‰Ú
(
d
);

747 
»t
 = -
ENOSYS
;

750 
£ndŒigg”_out
:

751 
	`rcu_uÆock_domaš
(
d
);

755 
XEN_DOMCTL_g‘_deviû_group
:

757 
domaš
 *
d
;

758 
u32
 
max_sdevs
;

759 
u8
 
bus
, 
devâ
;

760 
	`XEN_GUEST_HANDLE_64
(
ušt32
è
sdevs
;

761 
num_sdevs
;

763 
»t
 = -
ENOSYS
;

764 iàĞ!
iommu_’abËd
 )

767 
»t
 = -
EINVAL
;

768 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

771 
bus
 = (
domùl
->
u
.
g‘_deviû_group
.
machše_bdf
 >> 16) & 0xff;

772 
devâ
 = (
domùl
->
u
.
g‘_deviû_group
.
machše_bdf
 >> 8) & 0xff;

773 
max_sdevs
 = 
domùl
->
u
.
g‘_deviû_group
.max_sdevs;

774 
sdevs
 = 
domùl
->
u
.
g‘_deviû_group
.
sdev_¬¿y
;

776 
num_sdevs
 = 
	`iommu_g‘_deviû_group
(
d
, 
bus
, 
devâ
, 
sdevs
, 
max_sdevs
);

777 iàĞ
num_sdevs
 < 0 )

779 
	`d´štk
(
XENLOG_ERR
, "iommu_get_device_group() failed!\n");

780 
»t
 = -
EFAULT
;

781 
domùl
->
u
.
g‘_deviû_group
.
num_sdevs
 = 0;

785 
»t
 = 0;

786 
domùl
->
u
.
g‘_deviû_group
.
num_sdevs
 =‚um_sdevs;

788 iàĞ
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

789 
»t
 = -
EFAULT
;

790 
	`rcu_uÆock_domaš
(
d
);

794 
XEN_DOMCTL_‹¡_assign_deviû
:

796 
u8
 
bus
, 
devâ
;

798 
»t
 = -
ENOSYS
;

799 iàĞ!
iommu_’abËd
 )

802 
»t
 = 
	`xsm_‹¡_assign_deviû
(
domùl
->
u
.
assign_deviû
.
machše_bdf
);

803 iàĞ
»t
 )

806 
»t
 = -
EINVAL
;

807 
bus
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 16) & 0xff;

808 
devâ
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 8) & 0xff;

810 iàĞ
	`deviû_assigÃd
(
bus
, 
devâ
) )

812 
	`gd´štk
(
XENLOG_ERR
, "XEN_DOMCTL_test_assign_device: "

814 
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devfn));

817 
»t
 = 0;

821 
XEN_DOMCTL_assign_deviû
:

823 
domaš
 *
d
;

824 
u8
 
bus
, 
devâ
;

826 
»t
 = -
ENOSYS
;

827 iàĞ!
iommu_’abËd
 )

830 
»t
 = -
EINVAL
;

831 iàĞ
	`uÆik–y
((
d
 = 
	`g‘_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
) )

833 
	`gd´štk
(
XENLOG_ERR
,

838 
»t
 = 
	`xsm_assign_deviû
(
d
, 
domùl
->
u
.
assign_deviû
.
machše_bdf
);

839 iàĞ
»t
 )

840 
assign_deviû_out
;

842 
bus
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 16) & 0xff;

843 
devâ
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 8) & 0xff;

845 
»t
 = 
	`assign_deviû
(
d
, 
bus
, 
devâ
);

846 iàĞ
»t
 )

847 
	`gd´štk
(
XENLOG_ERR
, "XEN_DOMCTL_assign_device: "

849 
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devfn));

851 
assign_deviû_out
:

852 
	`put_domaš
(
d
);

856 
XEN_DOMCTL_d—ssign_deviû
:

858 
domaš
 *
d
;

859 
u8
 
bus
, 
devâ
;

861 
»t
 = -
ENOSYS
;

862 iàĞ!
iommu_’abËd
 )

865 
»t
 = -
EINVAL
;

866 iàĞ
	`uÆik–y
((
d
 = 
	`g‘_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
) )

868 
	`gd´štk
(
XENLOG_ERR
,

873 
»t
 = 
	`xsm_assign_deviû
(
d
, 
domùl
->
u
.
assign_deviû
.
machše_bdf
);

874 iàĞ
»t
 )

875 
d—ssign_deviû_out
;

877 
bus
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 16) & 0xff;

878 
devâ
 = (
domùl
->
u
.
assign_deviû
.
machše_bdf
 >> 8) & 0xff;

880 
	`¥š_lock
(&
pcidevs_lock
);

881 
»t
 = 
	`d—ssign_deviû
(
d
, 
bus
, 
devâ
);

882 
	`¥š_uÆock
(&
pcidevs_lock
);

883 iàĞ
»t
 )

884 
	`gd´štk
(
XENLOG_ERR
, "XEN_DOMCTL_deassign_device: "

886 
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devfn));

888 
d—ssign_deviû_out
:

889 
	`put_domaš
(
d
);

893 
XEN_DOMCTL_bšd_±_œq
:

895 
domaš
 * 
d
;

896 
x’_domùl_bšd_±_œq_t
 * 
bšd
;

898 
»t
 = -
ESRCH
;

899 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

901 
bšd
 = &(
domùl
->
u
.
bšd_±_œq
);

903 
»t
 = 
	`xsm_bšd_±_œq
(
d
, 
bšd
);

904 iàĞ
»t
 )

905 
bšd_out
;

907 
»t
 = -
EPERM
;

908 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) &&

909 !
	`œq_acûss_³rm™‹d
(
cu¼’t
->
domaš
, 
bšd
->
machše_œq
) )

910 
bšd_out
;

912 
»t
 = -
ESRCH
;

913 iàĞ
iommu_’abËd
 )

915 
	`¥š_lock
(&
pcidevs_lock
);

916 
»t
 = 
	`±_œq_ü—‹_bšd_vtd
(
d
, 
bšd
);

917 
	`¥š_uÆock
(&
pcidevs_lock
);

919 iàĞ
»t
 < 0 )

920 
	`gd´štk
(
XENLOG_ERR
, "pt_irq_create_bind failed!\n");

922 
bšd_out
:

923 
	`rcu_uÆock_domaš
(
d
);

927 
XEN_DOMCTL_unbšd_±_œq
:

929 
domaš
 * 
d
;

930 
x’_domùl_bšd_±_œq_t
 * 
bšd
;

932 
»t
 = -
ESRCH
;

933 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

935 
bšd
 = &(
domùl
->
u
.
bšd_±_œq
);

937 
»t
 = -
EPERM
;

938 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) &&

939 !
	`œq_acûss_³rm™‹d
(
cu¼’t
->
domaš
, 
bšd
->
machše_œq
) )

940 
unbšd_out
;

942 iàĞ
iommu_’abËd
 )

944 
	`¥š_lock
(&
pcidevs_lock
);

945 
»t
 = 
	`±_œq_de¡roy_bšd_vtd
(
d
, 
bšd
);

946 
	`¥š_uÆock
(&
pcidevs_lock
);

948 iàĞ
»t
 < 0 )

949 
	`gd´štk
(
XENLOG_ERR
, "pt_irq_destroy_bind failed!\n");

951 
unbšd_out
:

952 
	`rcu_uÆock_domaš
(
d
);

956 
XEN_DOMCTL_memÜy_m­pšg
:

958 
domaš
 *
d
;

959 
gâ
 = 
domùl
->
u
.
memÜy_m­pšg
.
fœ¡_gâ
;

960 
mâ
 = 
domùl
->
u
.
memÜy_m­pšg
.
fœ¡_mâ
;

961 
Ä_mâs
 = 
domùl
->
u
.
memÜy_m­pšg
.nr_mfns;

962 
i
;

964 
»t
 = -
EINVAL
;

965 iàĞ(
mâ
 + 
Ä_mâs
 - 1) < mfn )

968 
»t
 = -
EPERM
;

969 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) &&

970 !
	`iomem_acûss_³rm™‹d
(
cu¼’t
->
domaš
, 
mâ
, mâ + 
Ä_mâs
 - 1) )

973 
»t
 = -
ESRCH
;

974 iàĞ
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
) )

977 
»t
=0;

978 iàĞ
domùl
->
u
.
memÜy_m­pšg
.
add_m­pšg
 )

980 
	`gd´štk
(
XENLOG_INFO
,

982 
gâ
, 
mâ
, 
Ä_mâs
);

984 
»t
 = 
	`iomem_³rm™_acûss
(
d
, 
mâ
, mâ + 
Ä_mâs
 - 1);

985  
i
 = 0; i < 
Ä_mâs
; i++ )

986 
	`£t_mmio_p2m_’Œy
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
+
i
, 
	`_mâ
(
mâ
+i));

990 
	`gd´štk
(
XENLOG_INFO
,

992 
gâ
, 
mâ
, 
Ä_mâs
);

994  
i
 = 0; i < 
Ä_mâs
; i++ )

995 
	`ş—r_mmio_p2m_’Œy
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
+
i
);

996 
»t
 = 
	`iomem_d’y_acûss
(
d
, 
mâ
, mâ + 
Ä_mâs
 - 1);

999 
	`rcu_uÆock_domaš
(
d
);

1003 
XEN_DOMCTL_iİÜt_m­pšg
:

1005 
	#MAX_IOPORTS
 0x10000

	)

1006 
domaš
 *
d
;

1007 
hvm_iommu
 *
hd
;

1008 
fgp
 = 
domùl
->
u
.
iİÜt_m­pšg
.
fœ¡_gpÜt
;

1009 
fmp
 = 
domùl
->
u
.
iİÜt_m­pšg
.
fœ¡_mpÜt
;

1010 
Å
 = 
domùl
->
u
.
iİÜt_m­pšg
.
Ä_pÜts
;

1011 
g2m_iİÜt
 *g2m_ioport;

1012 
found
 = 0;

1014 
»t
 = -
EINVAL
;

1015 iàĞ(
Å
 =ğ0è|| (
fgp
 > 
MAX_IOPORTS
è|| (
fmp
 > MAX_IOPORTS) ||

1016 ((
fgp
 + 
Å
è> 
MAX_IOPORTS
è|| ((
fmp
 +‚p) > MAX_IOPORTS) )

1018 
	`gd´štk
(
XENLOG_ERR
,

1020 
fgp
, 
fmp
, 
Å
);

1024 
»t
 = -
EPERM
;

1025 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) &&

1026 !
	`iİÜts_acûss_³rm™‹d
(
cu¼’t
->
domaš
, 
fmp
, fm°+ 
Å
 - 1) )

1029 
»t
 = -
ESRCH
;

1030 iàĞ
	`uÆik–y
((
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
) )

1033 
hd
 = 
	`domaš_hvm_iommu
(
d
);

1034 iàĞ
domùl
->
u
.
iİÜt_m­pšg
.
add_m­pšg
 )

1036 
	`gd´štk
(
XENLOG_INFO
,

1038 
fgp
, 
fmp
, 
Å
);

1040 
	`li¡_fÜ_—ch_’Œy
(
g2m_iİÜt
, &
hd
->
g2m_iİÜt_li¡
, 
li¡
)

1041 ià(
g2m_iİÜt
->
mpÜt
 =ğ
fmp
 )

1043 
g2m_iİÜt
->
gpÜt
 = 
fgp
;

1044 
g2m_iİÜt
->
Å
 =‚p;

1045 
found
 = 1;

1048 iàĞ!
found
 )

1050 
g2m_iİÜt
 = 
	`xm®loc
(g2m_ioport);

1051 
g2m_iİÜt
->
gpÜt
 = 
fgp
;

1052 
g2m_iİÜt
->
mpÜt
 = 
fmp
;

1053 
g2m_iİÜt
->
Å
 =‚p;

1054 
	`li¡_add_
(&
g2m_iİÜt
->
li¡
, &
hd
->
g2m_iİÜt_li¡
);

1056 
»t
 = 
	`iİÜts_³rm™_acûss
(
d
, 
fmp
, fm°+ 
Å
 - 1);

1060 
	`gd´štk
(
XENLOG_INFO
,

1062 
fgp
, 
fmp
, 
Å
);

1063 
	`li¡_fÜ_—ch_’Œy
(
g2m_iİÜt
, &
hd
->
g2m_iİÜt_li¡
, 
li¡
)

1064 iàĞ
g2m_iİÜt
->
mpÜt
 =ğ
fmp
 )

1066 
	`li¡_d–
(&
g2m_iİÜt
->
li¡
);

1067 
	`xä“
(
g2m_iİÜt
);

1070 
»t
 = 
	`iİÜts_d’y_acûss
(
d
, 
fmp
, fm°+ 
Å
 - 1);

1072 
	`rcu_uÆock_domaš
(
d
);

1076 
XEN_DOMCTL_pš_mem_ÿch—‰r
:

1078 
domaš
 *
d
;

1080 
»t
 = -
ESRCH
;

1081 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1082 iàĞ
d
 =ğ
NULL
 )

1085 
»t
 = 
	`xsm_pš_mem_ÿch—‰r
(
d
);

1086 iàĞ
»t
 )

1087 
pš_out
;

1089 
»t
 = 
	`hvm_£t_mem_pšÃd_ÿch—‰r
(

1090 
d
, 
domùl
->
u
.
pš_mem_ÿch—‰r
.
¡¬t
,

1091 
domùl
->
u
.
pš_mem_ÿch—‰r
.
’d
,

1092 
domùl
->
u
.
pš_mem_ÿch—‰r
.
ty³
);

1094 
pš_out
:

1095 
	`rcu_uÆock_domaš
(
d
);

1099 
XEN_DOMCTL_£t_ext_vıucÚ‹xt
:

1100 
XEN_DOMCTL_g‘_ext_vıucÚ‹xt
:

1102 
x’_domùl_ext_vıucÚ‹xt
 *
evc
;

1103 
domaš
 *
d
;

1104 
vıu
 *
v
;

1106 
evc
 = &
domùl
->
u
.
ext_vıucÚ‹xt
;

1108 
»t
 = -
ESRCH
;

1109 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1110 iàĞ
d
 =ğ
NULL
 )

1113 
»t
 = 
	`xsm_ext_vıucÚ‹xt
(
d
, 
domùl
->
cmd
);

1114 iàĞ
»t
 )

1115 
ext_vıucÚ‹xt_out
;

1117 
»t
 = -
ESRCH
;

1118 iàĞ(
evc
->
vıu
 >ğ
d
->
max_vıus
) ||

1119 ((
v
 = 
d
->
vıu
[
evc
->vıu]è=ğ
NULL
) )

1120 
ext_vıucÚ‹xt_out
;

1122 iàĞ
domùl
->
cmd
 =ğ
XEN_DOMCTL_g‘_ext_vıucÚ‹xt
 )

1124 
evc
->
size
 = (*evc);

1125 #ifdeà
__x86_64__


1126 
evc
->
sy£Á”_ÿÎback_cs
 = 
v
->
¬ch
.sysenter_callback_cs;

1127 
evc
->
sy£Á”_ÿÎback_e
 = 
v
->
¬ch
.sysenter_callback_eip;

1128 
evc
->
sy£Á”_di§bËs_ev’ts
 = 
v
->
¬ch
.sysenter_disables_events;

1129 
evc
->
sysÿÎ32_ÿÎback_cs
 = 
v
->
¬ch
.syscall32_callback_cs;

1130 
evc
->
sysÿÎ32_ÿÎback_e
 = 
v
->
¬ch
.syscall32_callback_eip;

1131 
evc
->
sysÿÎ32_di§bËs_ev’ts
 = 
v
->
¬ch
.syscall32_disables_events;

1133 
evc
->
sy£Á”_ÿÎback_cs
 = 0;

1134 
evc
->
sy£Á”_ÿÎback_e
 = 0;

1135 
evc
->
sy£Á”_di§bËs_ev’ts
 = 0;

1136 
evc
->
sysÿÎ32_ÿÎback_cs
 = 0;

1137 
evc
->
sysÿÎ32_ÿÎback_e
 = 0;

1138 
evc
->
sysÿÎ32_di§bËs_ev’ts
 = 0;

1143 
»t
 = -
EINVAL
;

1144 iàĞ
evc
->
size
 != (*evc) )

1145 
ext_vıucÚ‹xt_out
;

1146 #ifdeà
__x86_64__


1147 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
evc
->
sy£Á”_ÿÎback_cs
);

1148 
v
->
¬ch
.
sy£Á”_ÿÎback_cs
 = 
evc
->sysenter_callback_cs;

1149 
v
->
¬ch
.
sy£Á”_ÿÎback_e
 = 
evc
->sysenter_callback_eip;

1150 
v
->
¬ch
.
sy£Á”_di§bËs_ev’ts
 = 
evc
->sysenter_disables_events;

1151 
	`fixup_gue¡_code_£ËùÜ
(
d
, 
evc
->
sysÿÎ32_ÿÎback_cs
);

1152 
v
->
¬ch
.
sysÿÎ32_ÿÎback_cs
 = 
evc
->syscall32_callback_cs;

1153 
v
->
¬ch
.
sysÿÎ32_ÿÎback_e
 = 
evc
->syscall32_callback_eip;

1154 
v
->
¬ch
.
sysÿÎ32_di§bËs_ev’ts
 = 
evc
->syscall32_disables_events;

1157 iàĞ(
evc
->
sy£Á”_ÿÎback_cs
 & ~3) ||

1158 
evc
->
sy£Á”_ÿÎback_e
 ||

1159 (
evc
->
sysÿÎ32_ÿÎback_cs
 & ~3) ||

1160 
evc
->
sysÿÎ32_ÿÎback_e
 )

1161 
ext_vıucÚ‹xt_out
;

1165 
»t
 = 0;

1167 
ext_vıucÚ‹xt_out
:

1168 
	`rcu_uÆock_domaš
(
d
);

1169 iàĞ(
domùl
->
cmd
 =ğ
XEN_DOMCTL_g‘_ext_vıucÚ‹xt
) &&

1170 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

1171 
»t
 = -
EFAULT
;

1175 
XEN_DOMCTL_£t_ıuid
:

1177 
domaš
 *
d
;

1178 
x’_domùl_ıuid_t
 *
ùl
 = &
domùl
->
u
.
ıuid
;

1179 
ıuid_šput_t
 *
ıuid
 = 
NULL
;

1180 
i
;

1182 
»t
 = -
ESRCH
;

1183 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1184 iàĞ
d
 =ğ
NULL
 )

1187  
i
 = 0; i < 
MAX_CPUID_INPUT
; i++ )

1189 
ıuid
 = &
d
->
¬ch
.
ıuids
[
i
];

1191 iàĞ
ıuid
->
šput
[0] =ğ
XEN_CPUID_INPUT_UNUSED
 )

1194 iàĞ(
ıuid
->
šput
[0] =ğ
ùl
->input[0]) &&

1195 ((
ıuid
->
šput
[1] =ğ
XEN_CPUID_INPUT_UNUSED
) ||

1196 (
ıuid
->
šput
[1] =ğ
ùl
->input[1])) )

1200 iàĞ
i
 =ğ
MAX_CPUID_INPUT
 )

1202 
»t
 = -
ENOENT
;

1206 
	`memıy
(
ıuid
, 
ùl
, (
ıuid_šput_t
));

1207 
»t
 = 0;

1210 
	`rcu_uÆock_domaš
(
d
);

1214 
XEN_DOMCTL_g‘tscšfo
:

1216 
domaš
 *
d
;

1217 
x’_gue¡_tsc_šfo_t
 
šfo
;

1219 
»t
 = -
ESRCH
;

1220 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1221 iàĞ
d
 =ğ
NULL
 )

1224 
	`domaš_·u£
(
d
);

1225 
	`tsc_g‘_šfo
(
d
, &
šfo
.
tsc_mode
,

1226 &
šfo
.
–­£d_n£c
,

1227 &
šfo
.
gtsc_khz
,

1228 &
šfo
.
šÿº©iÚ
);

1229 iàĞ
	`cİy_to_gue¡
(
domùl
->
u
.
tsc_šfo
.
out_šfo
, &
šfo
, 1) )

1230 
»t
 = -
EFAULT
;

1232 
»t
 = 0;

1233 
	`domaš_uÅau£
(
d
);

1235 
	`rcu_uÆock_domaš
(
d
);

1239 
XEN_DOMCTL_£‰scšfo
:

1241 
domaš
 *
d
;

1243 
»t
 = -
ESRCH
;

1244 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1245 iàĞ
d
 =ğ
NULL
 )

1248 
	`domaš_·u£
(
d
);

1249 
	`tsc_£t_šfo
(
d
, 
domùl
->
u
.
tsc_šfo
.
šfo
.
tsc_mode
,

1250 
domùl
->
u
.
tsc_šfo
.
šfo
.
–­£d_n£c
,

1251 
domùl
->
u
.
tsc_šfo
.
šfo
.
gtsc_khz
,

1252 
domùl
->
u
.
tsc_šfo
.
šfo
.
šÿº©iÚ
);

1253 
	`domaš_uÅau£
(
d
);

1255 
	`rcu_uÆock_domaš
(
d
);

1256 
»t
 = 0;

1260 
XEN_DOMCTL_suµ»ss_¥urious_·ge_çuÉs
:

1262 
domaš
 *
d
;

1264 
»t
 = -
ESRCH
;

1265 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1266 iàĞ
d
 !ğ
NULL
 )

1268 
d
->
¬ch
.
suµ»ss_¥urious_·ge_çuÉs
 = 1;

1269 
	`rcu_uÆock_domaš
(
d
);

1270 
»t
 = 0;

1275 
XEN_DOMCTL_debug_İ
:

1277 
domaš
 *
d
;

1278 
vıu
 *
v
;

1280 
»t
 = -
ESRCH
;

1281 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1282 iàĞ
d
 =ğ
NULL
 )

1285 
»t
 = -
EINVAL
;

1286 iàĞ(
domùl
->
u
.
debug_İ
.
vıu
 >ğ
d
->
max_vıus
) ||

1287 ((
v
 = 
d
->
vıu
[
domùl
->
u
.
debug_İ
.vıu]è=ğ
NULL
) )

1288 
debug_İ_out
;

1290 
»t
 = -
EINVAL
;

1291 iàĞ!
	`is_hvm_domaš
(
d
))

1292 
debug_İ_out
;

1294 
»t
 = 
	`hvm_debug_İ
(
v
, 
domùl
->
u
.
debug_İ
.
İ
);

1296 
debug_İ_out
:

1297 
	`rcu_uÆock_domaš
(
d
);

1301 
XEN_DOMCTL_gdbsx_gue¡memio
:

1303 
domaš
 *
d
;

1305 
»t
 = -
ESRCH
;

1306 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

1309 
domùl
->
u
.
gdbsx_gue¡_memio
.
»maš
 =

1310 
domùl
->
u
.
gdbsx_gue¡_memio
.
Ën
;

1312 
»t
 = 
	`gdbsx_gue¡_mem_io
(
domùl
->
domaš
, &domùl->
u
.
gdbsx_gue¡_memio
);

1313 iàĞ!
»t
 && 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

1314 
»t
 = -
EFAULT
;

1316 
	`rcu_uÆock_domaš
(
d
);

1320 
XEN_DOMCTL_gdbsx_·u£vıu
:

1322 
domaš
 *
d
;

1323 
vıu
 *
v
;

1325 
»t
 = -
ESRCH
;

1326 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

1329 
»t
 = -
EBUSY
;

1330 iàĞ!
d
->
is_·u£d_by_cÚŒŞËr
 )

1332 
	`rcu_uÆock_domaš
(
d
);

1335 
»t
 = -
EINVAL
;

1336 iàĞ
domùl
->
u
.
gdbsx_·u£uÅ_vıu
.
vıu
 >ğ
MAX_VIRT_CPUS
 ||

1337 (
v
 = 
d
->
vıu
[
domùl
->
u
.
gdbsx_·u£uÅ_vıu
.vıu]è=ğ
NULL
 )

1339 
	`rcu_uÆock_domaš
(
d
);

1342 
	`vıu_·u£
(
v
);

1343 
»t
 = 0;

1344 
	`rcu_uÆock_domaš
(
d
);

1348 
XEN_DOMCTL_gdbsx_uÅau£vıu
:

1350 
domaš
 *
d
;

1351 
vıu
 *
v
;

1353 
»t
 = -
ESRCH
;

1354 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

1357 
»t
 = -
EBUSY
;

1358 iàĞ!
d
->
is_·u£d_by_cÚŒŞËr
 )

1360 
	`rcu_uÆock_domaš
(
d
);

1363 
»t
 = -
EINVAL
;

1364 iàĞ
domùl
->
u
.
gdbsx_·u£uÅ_vıu
.
vıu
 >ğ
MAX_VIRT_CPUS
 ||

1365 (
v
 = 
d
->
vıu
[
domùl
->
u
.
gdbsx_·u£uÅ_vıu
.vıu]è=ğ
NULL
 )

1367 
	`rcu_uÆock_domaš
(
d
);

1370 iàĞ!
	`©omic_»ad
(&
v
->
·u£_couÁ
) )

1371 
	`´štk
("WARN: UÅausšg vıu:%d which i nÙ…au£d\n", 
v
->
vıu_id
);

1372 
	`vıu_uÅau£
(
v
);

1373 
»t
 = 0;

1374 
	`rcu_uÆock_domaš
(
d
);

1378 
XEN_DOMCTL_gdbsx_dom¡©us
:

1380 
domaš
 *
d
;

1381 
vıu
 *
v
;

1383 
»t
 = -
ESRCH
;

1384 iàĞ(
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
)è=ğ
NULL
 )

1387 
domùl
->
u
.
gdbsx_dom¡©us
.
vıu_id
 = -1;

1388 
domùl
->
u
.
gdbsx_dom¡©us
.
·u£d
 = 
d
->
is_·u£d_by_cÚŒŞËr
;

1389 iàĞ
domùl
->
u
.
gdbsx_dom¡©us
.
·u£d
 )

1391 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1393 iàĞ
v
->
¬ch
.
gdbsx_vıu_ev’t
 )

1395 
domùl
->
u
.
gdbsx_dom¡©us
.
vıu_id
 = 
v
->vcpu_id;

1396 
domùl
->
u
.
gdbsx_dom¡©us
.
vıu_ev
 =

1397 
v
->
¬ch
.
gdbsx_vıu_ev’t
;

1398 
v
->
¬ch
.
gdbsx_vıu_ev’t
 = 0;

1403 
»t
 = 0;

1404 iàĞ
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

1405 
»t
 = -
EFAULT
;

1406 
	`rcu_uÆock_domaš
(
d
);

1410 
XEN_DOMCTL_£tvıuext¡©e
:

1411 
XEN_DOMCTL_g‘vıuext¡©e
:

1413 
x’_domùl_vıuext¡©e
 *
evc
;

1414 
domaš
 *
d
;

1415 
vıu
 *
v
;

1416 
ušt32_t
 
off£t
 = 0;

1417 
ušt64_t
 
_xã©u»_mask
 = 0;

1418 
ušt64_t
 
_xü0
, 
_xü0_accum
;

1419 *
»ûive_buf
 = 
NULL
, *
_x§ve_¬—
;

1421 
	#PV_XSAVE_SIZE
 (2 * (
ušt64_t
è+ 
x§ve_útxt_size
)

	)

1423 
evc
 = &
domùl
->
u
.
vıuext¡©e
;

1425 
»t
 = -
ESRCH
;

1427 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1428 iàĞ
d
 =ğ
NULL
 )

1431 
»t
 = 
	`xsm_vıuext¡©e
(
d
, 
domùl
->
cmd
);

1432 iàĞ
»t
 )

1433 
vıuext¡©e_out
;

1435 
»t
 = -
ESRCH
;

1436 iàĞ(
evc
->
vıu
 >ğ
d
->
max_vıus
) ||

1437 ((
v
 = 
d
->
vıu
[
evc
->vıu]è=ğ
NULL
) )

1438 
vıuext¡©e_out
;

1440 iàĞ
domùl
->
cmd
 =ğ
XEN_DOMCTL_g‘vıuext¡©e
 )

1442 iàĞ!
evc
->
size
 && !evc->
xã©u»_mask
 )

1444 
evc
->
xã©u»_mask
 = xfeature_mask;

1445 
evc
->
size
 = 
PV_XSAVE_SIZE
;

1446 
»t
 = 0;

1447 
vıuext¡©e_out
;

1449 iàĞ
evc
->
size
 !ğ
PV_XSAVE_SIZE
 ||

1450 
evc
->
xã©u»_mask
 != xfeature_mask )

1452 
»t
 = -
EINVAL
;

1453 
vıuext¡©e_out
;

1455 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
vıuext¡©e
.
bufãr
,

1456 
off£t
, (*)&
v
->
¬ch
.
xü0
,

1457 (
v
->
¬ch
.
xü0
)) )

1459 
»t
 = -
EFAULT
;

1460 
vıuext¡©e_out
;

1462 
off£t
 +ğ(
v
->
¬ch
.
xü0
);

1463 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
vıuext¡©e
.
bufãr
,

1464 
off£t
, (*)&
v
->
¬ch
.
xü0_accum
,

1465 (
v
->
¬ch
.
xü0_accum
)) )

1467 
»t
 = -
EFAULT
;

1468 
vıuext¡©e_out
;

1470 
off£t
 +ğ(
v
->
¬ch
.
xü0_accum
);

1471 iàĞ
	`cİy_to_gue¡_off£t
(
domùl
->
u
.
vıuext¡©e
.
bufãr
,

1472 
off£t
, 
v
->
¬ch
.
x§ve_¬—
,

1473 
x§ve_útxt_size
) )

1475 
»t
 = -
EFAULT
;

1476 
vıuext¡©e_out
;

1481 
»t
 = -
EINVAL
;

1483 
_xã©u»_mask
 = 
evc
->
xã©u»_mask
;

1485 iàĞ(
_xã©u»_mask
 & 
xã©u»_mask
) != _xfeature_mask )

1486 
vıuext¡©e_out
;

1487 iàĞ
evc
->
size
 > 
PV_XSAVE_SIZE
 ||ƒvc->siz< 2 * (
ušt64_t
) )

1488 
vıuext¡©e_out
;

1490 
»ûive_buf
 = 
	`xm®loc_by‹s
(
evc
->
size
);

1491 iàĞ!
»ûive_buf
 )

1493 
»t
 = -
ENOMEM
;

1494 
vıuext¡©e_out
;

1496 iàĞ
	`cİy_äom_gue¡_off£t
(
»ûive_buf
, 
domùl
->
u
.
vıuext¡©e
.
bufãr
,

1497 
off£t
, 
evc
->
size
) )

1499 
»t
 = -
EFAULT
;

1500 
	`xä“
(
»ûive_buf
);

1501 
vıuext¡©e_out
;

1504 
_xü0
 = *(
ušt64_t
 *)
»ûive_buf
;

1505 
_xü0_accum
 = *(
ušt64_t
 *)(
»ûive_buf
 + (uint64_t));

1506 
_x§ve_¬—
 = 
»ûive_buf
 + 2 * (
ušt64_t
);

1508 iàĞ!(
_xü0
 & 
XSTATE_FP
è|| _xü0 & ~
xã©u»_mask
 )

1510 
	`xä“
(
»ûive_buf
);

1511 
vıuext¡©e_out
;

1513 iàĞ(
_xü0
 & 
_xü0_accum
) != _xcr0 )

1515 
	`xä“
(
»ûive_buf
);

1516 
vıuext¡©e_out
;

1519 
v
->
¬ch
.
xü0
 = 
_xü0
;

1520 
v
->
¬ch
.
xü0_accum
 = 
_xü0_accum
;

1521 
	`memıy
(
v
->
¬ch
.
x§ve_¬—
, 
_x§ve_¬—
, 
evc
->
size
 - 2 * (
ušt64_t
) );

1523 
	`xä“
(
»ûive_buf
);

1526 
»t
 = 0;

1528 
vıuext¡©e_out
:

1529 
	`rcu_uÆock_domaš
(
d
);

1530 iàĞ(
domùl
->
cmd
 =ğ
XEN_DOMCTL_g‘vıuext¡©e
) &&

1531 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1) )

1532 
»t
 = -
EFAULT
;

1536 #ifdeà
__x86_64__


1537 
XEN_DOMCTL_mem_ev’t_İ
:

1539 
domaš
 *
d
;

1541 
»t
 = -
ESRCH
;

1542 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1543 iàĞ
d
 !ğ
NULL
 )

1545 
»t
 = 
	`mem_ev’t_domùl
(
d
, &
domùl
->
u
.
mem_ev’t_İ
,

1546 
	`gue¡_hªdË_ÿ¡
(
u_domùl
, ));

1547 
	`rcu_uÆock_domaš
(
d
);

1548 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1);

1553 
XEN_DOMCTL_mem_sh¬šg_İ
:

1555 
domaš
 *
d
;

1557 
»t
 = -
ESRCH
;

1558 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1559 iàĞ
d
 !ğ
NULL
 )

1561 
»t
 = 
	`mem_sh¬šg_domùl
(
d
, &
domùl
->
u
.
mem_sh¬šg_İ
);

1562 
	`rcu_uÆock_domaš
(
d
);

1563 
	`cİy_to_gue¡
(
u_domùl
, 
domùl
, 1);

1569 
XEN_DOMCTL_£t_acûss_»quœed
:

1571 
domaš
 *
d
;

1572 
p2m_domaš
* 
p2m
;

1574 
»t
 = -
EPERM
;

1575 iàĞ
cu¼’t
->
domaš
->
domaš_id
 =ğ
domùl
->domain )

1578 
»t
 = -
ESRCH
;

1579 
d
 = 
	`rcu_lock_domaš_by_id
(
domùl
->
domaš
);

1580 iàĞ
d
 !ğ
NULL
 )

1582 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

1583 
p2m
->
acûss_»quœed
 = 
domùl
->
u
.access_required.access_required;

1584 
	`rcu_uÆock_domaš
(
d
);

1590 
»t
 = -
ENOSYS
;

1594  
»t
;

1595 
	}
}

1597 
	$¬ch_g‘_šfo_gue¡
(
vıu
 *
v
, 
vıu_gue¡_cÚ‹xt_u
 
c
)

1599 #ifdeà
CONFIG_COMPAT


1600 
	#c
(
æd
è(!
	`is_pv_32Ú64_domaš
(
v
->
domaš
è? (
c
.
Çt
->ædè: (c.
cmp
->æd))

	)

1602 
	#c
(
æd
è(
c
.
Çt
->æd)

	)

1606 iàĞ
	`x§ve_’abËd
(
v
) )

1607 
	`memıy
(
v
->
¬ch
.
x§ve_¬—
, &v->¬ch.
gue¡_cÚ‹xt
.
åu_ùxt
,

1608 (
v
->
¬ch
.
gue¡_cÚ‹xt
.
åu_ùxt
));

1610 iàĞ!
	`is_pv_32Ú64_domaš
(
v
->
domaš
) )

1611 
	`memıy
(
c
.
Çt
, &
v
->
¬ch
.
gue¡_cÚ‹xt
, (*c.nat));

1612 #ifdeà
CONFIG_COMPAT


1614 
	`XLAT_vıu_gue¡_cÚ‹xt
(
c
.
cmp
, &
v
->
¬ch
.
gue¡_cÚ‹xt
);

1617 
	`c
(
æags
 &ğ~(
VGCF_i387_v®id
|
VGCF_š_k”Ãl
));

1618 iàĞ
v
->
åu_š™Ÿli£d
 )

1619 
	`c
(
æags
 |ğ
VGCF_i387_v®id
);

1620 iàĞ!
	`‹¡_b™
(
_VPF_down
, &
v
->
·u£_æags
) )

1621 
	`c
(
æags
 |ğ
VGCF_Úlše
);

1623 iàĞ
	`is_hvm_vıu
(
v
) )

1625 
£gm’t_»gi¡”
 
¤eg
;

1626 
	`mem£t
(
c
.
Çt
->
ù¾»g
, 0, (c.nat->ctrlreg));

1627 
c
.
Çt
->
ù¾»g
[0] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

1628 
c
.
Çt
->
ù¾»g
[2] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2];

1629 
c
.
Çt
->
ù¾»g
[3] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

1630 
c
.
Çt
->
ù¾»g
[4] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

1631 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
¤eg
);

1632 
c
.
Çt
->
u£r_»gs
.
cs
 = 
¤eg
.
£l
;

1633 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
¤eg
);

1634 
c
.
Çt
->
u£r_»gs
.
ss
 = 
¤eg
.
£l
;

1635 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
¤eg
);

1636 
c
.
Çt
->
u£r_»gs
.
ds
 = 
¤eg
.
£l
;

1637 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
¤eg
);

1638 
c
.
Çt
->
u£r_»gs
.
es
 = 
¤eg
.
£l
;

1639 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
¤eg
);

1640 
c
.
Çt
->
u£r_»gs
.
fs
 = 
¤eg
.
£l
;

1641 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
¤eg
);

1642 
c
.
Çt
->
u£r_»gs
.
gs
 = 
¤eg
.
£l
;

1647 
	`BUG_ON
((
	`c
(
u£r_»gs
.
eæags
è& 
X86_EFLAGS_IOPL
) != 0);

1648 
	`c
(
u£r_»gs
.
eæags
 |ğ
v
->
¬ch
.
iİl
 << 12);

1650 iàĞ!
	`is_pv_32Ú64_domaš
(
v
->
domaš
) )

1652 
c
.
Çt
->
ù¾»g
[3] = 
	`x’_pâ_to_ü3
(

1653 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
));

1654 #ifdeà
__x86_64__


1655 
c
.
Çt
->
ù¾»g
[1] =

1656 
	`·g‘abË_is_nuÎ
(
v
->
¬ch
.
gue¡_bË_u£r
) ? 0

1657 : 
	`x’_pâ_to_ü3
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË_u£r
));

1661 
c
.
Çt
->
debug»g
[7] |= c.nat->debugreg[5];

1662 
c
.
Çt
->
debug»g
[5] = 0;

1664 #ifdeà
CONFIG_COMPAT


1667 
l4_pg’Œy_t
 *
l4e
 = 
	`__va
(
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
));

1668 
c
.
cmp
->
ù¾»g
[3] = 
	`com·t_pâ_to_ü3
(
	`l4e_g‘_pâ
(*
l4e
));

1671 
c
.
cmp
->
debug»g
[7] |= c.cmp->debugreg[5];

1672 
c
.
cmp
->
debug»g
[5] = 0;

1676 iàĞ
	`gue¡_k”Ãl_mode
(
v
, &v->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
) )

1677 
	`c
(
æags
 |ğ
VGCF_š_k”Ãl
);

1680 
	`c
(
vm_assi¡
 = 
v
->
domaš
->vm_assist);

1681 #undeà
c


1682 
	}
}

	@e820.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/lib.h
>

4 
	~<x’/mm.h
>

5 
	~<x’/com·t.h
>

6 
	~<x’/dmi.h
>

7 
	~<asm/e820.h
>

8 
	~<asm/·ge.h
>

9 
	~<asm/´oûssÜ.h
>

10 
	~<asm/mŒr.h
>

11 
	~<asm/m¤.h
>

17 
__š™d©a
 
	gİt_mem
;

18 
size_·¿m
("mem", 
İt_mem
);

24 
__š™d©a
 
	gİt_avamem
;

25 
size_·¿m
("avamem", 
İt_avamem
);

28 
s8
 
__š™d©a
 
	ge820_mŒr_ş
 = -1;

29 
boŞ—n_·¿m
("e820-mŒr-ş", 
e820_mŒr_ş
);

32 
boŞ_t
 
__š™d©a
 
	ge820_v”bo£
;

33 
boŞ—n_·¿m
("e820-v”bo£", 
e820_v”bo£
);

35 
e820m­
 
	ge820
;

43 
__š™
 
	$e820_®l_m­³d
(
u64
 
¡¬t
, u64 
’d
, 
ty³
)

45 
i
;

47 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

48 
e820’Œy
 *
ei
 = &
e820
.
m­
[
i
];

50 ià(
ty³
 && 
ei
->type !=ype)

53 ià(
ei
->
addr
 >ğ
’d
 ||ƒi->add¸+ƒi->
size
 <ğ
¡¬t
)

59 ià(
ei
->
addr
 <ğ
¡¬t
)

60 
¡¬t
 = 
ei
->
addr
 +ƒi->
size
;

65 ià(
¡¬t
 >ğ
’d
)

69 
	}
}

71 
__š™
 
	$add_memÜy_»giÚ
(
¡¬t
,

72 
size
, 
ty³
)

74 
x
;

77 
x
 = 
e820
.
Ä_m­
;

79 ià(
x
 =ğ
E820MAX
) {

80 
	`´štk
(
KERN_ERR
 "Ooops! Too manyƒntries inhe memory map!\n");

84 
e820
.
m­
[
x
].
addr
 = 
¡¬t
;

85 
e820
.
m­
[
x
].
size
 = size;

86 
e820
.
m­
[
x
].
ty³
 =ype;

87 
e820
.
Ä_m­
++;

89 
	}
}

91 
__š™
 
	$´št_e820_memÜy_m­
(
e820’Œy
 *
m­
, 
’Œ›s
)

93 
i
;

95 
i
 = 0; i < 
’Œ›s
; i++) {

96 
	`´štk
(" %016Lx - %016Lx ",

97 ()(
m­
[
i
].
addr
),

98 ()(
m­
[
i
].
addr
 + m­[i].
size
));

99 
m­
[
i
].
ty³
) {

100 
E820_RAM
:

101 
	`´štk
("(usable)\n");

103 
E820_RESERVED
:

104 
	`´štk
("(reserved)\n");

106 
E820_ACPI
:

107 
	`´štk
("(ACPI data)\n");

109 
E820_NVS
:

110 
	`´štk
("(ACPI NVS)\n");

112 
E820_UNUSABLE
:

113 
	`´štk
("(unusable)\n");

116 
	`´štk
("ty³ %u\n", 
m­
[
i
].
ty³
);

120 
	}
}

129 
	schªge_memb”
 {

130 
e820’Œy
 *
	mpbios
;

131 
	maddr
;

133 
chªge_memb”
 
	gchªge_pošt_li¡
[2*
E820MAX
] 
	g__š™d©a
;

134 
chªge_memb”
 *
	gchªge_pošt
[2*
E820MAX
] 
	g__š™d©a
;

135 
e820’Œy
 *
	gov”Ïp_li¡
[
E820MAX
] 
	g__š™d©a
;

136 
e820’Œy
 
	gÃw_bios
[
E820MAX
] 
	g__š™d©a
;

138 
__š™
 
	$§n™ize_e820_m­
(
e820’Œy
 * 
biosm­
, * 
²r_m­
)

140 
chªge_memb”
 *
chªge_tmp
;

141 
cu¼’t_ty³
, 
Ï¡_ty³
;

142 
Ï¡_addr
;

143 
chgidx
, 
¡l_chªgšg
;

144 
ov”Ïp_’Œ›s
;

145 
Ãw_bios_’Œy
;

146 
Şd_Ä
, 
Ãw_Ä
, 
chg_Ä
;

147 
i
;

186 ià(*
²r_m­
 < 2)

189 
Şd_Ä
 = *
²r_m­
;

192 
i
=0; i<
Şd_Ä
; i++)

193 ià(
biosm­
[
i
].
addr
 + biosm­[i].
size
 < biosmap[i].addr)

197 
i
=0; i < 2*
Şd_Ä
; i++)

198 
chªge_pošt
[
i
] = &
chªge_pošt_li¡
[i];

202 
chgidx
 = 0;

203 
i
=0; i < 
Şd_Ä
; i++) {

204 ià(
biosm­
[
i
].
size
 != 0) {

205 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].addr;

206 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

207 
chªge_pošt
[
chgidx
]->
addr
 = 
biosm­
[
i
].add¸+ biosm­[i].
size
;

208 
chªge_pošt
[
chgidx
++]->
pbios
 = &
biosm­
[
i
];

211 
chg_Ä
 = 
chgidx
;

214 
¡l_chªgšg
 = 1;

215 
¡l_chªgšg
) {

216 
¡l_chªgšg
 = 0;

217 
i
=1; i < 
chg_Ä
; i++) {

220 ià((
chªge_pošt
[
i
]->
addr
 < change_point[i-1]->addr) ||

221 ((
chªge_pošt
[
i
]->
addr
 == change_point[i-1]->addr) &&

222 (
chªge_pošt
[
i
]->
addr
 =ğchªge_pošt[i]->
pbios
->addr) &&

223 (
chªge_pošt
[
i
-1]->
addr
 !ğchªge_pošt[i-1]->
pbios
->addr))

226 
chªge_tmp
 = 
chªge_pošt
[
i
];

227 
chªge_pošt
[
i
] = change_point[i-1];

228 
chªge_pošt
[
i
-1] = 
chªge_tmp
;

229 
¡l_chªgšg
=1;

235 
ov”Ïp_’Œ›s
=0;

236 
Ãw_bios_’Œy
=0;

237 
Ï¡_ty³
 = 0;

238 
Ï¡_addr
 = 0;

240 
chgidx
=0; chgidx < 
chg_Ä
; chgidx++)

243 ià(
chªge_pošt
[
chgidx
]->
addr
 =ğchªge_pošt[chgidx]->
pbios
->addr)

246 
ov”Ïp_li¡
[
ov”Ïp_’Œ›s
++]=
chªge_pošt
[
chgidx
]->
pbios
;

251 
i
=0; i<
ov”Ïp_’Œ›s
; i++)

253 ià(
ov”Ïp_li¡
[
i
] =ğ
chªge_pošt
[
chgidx
]->
pbios
)

254 
ov”Ïp_li¡
[
i
] = ov”Ïp_li¡[
ov”Ïp_’Œ›s
-1];

256 
ov”Ïp_’Œ›s
--;

260 
cu¼’t_ty³
 = 0;

261 
i
=0; i<
ov”Ïp_’Œ›s
; i++)

262 ià(
ov”Ïp_li¡
[
i
]->
ty³
 > 
cu¼’t_ty³
)

263 
cu¼’t_ty³
 = 
ov”Ïp_li¡
[
i
]->
ty³
;

265 ià(
cu¼’t_ty³
 !ğ
Ï¡_ty³
) {

266 ià(
Ï¡_ty³
 != 0) {

267 
Ãw_bios
[
Ãw_bios_’Œy
].
size
 =

268 
chªge_pošt
[
chgidx
]->
addr
 - 
Ï¡_addr
;

270 ià(
Ãw_bios
[
Ãw_bios_’Œy
].
size
 != 0)

271 ià(++
Ãw_bios_’Œy
 >ğ
E820MAX
)

274 ià(
cu¼’t_ty³
 != 0) {

275 
Ãw_bios
[
Ãw_bios_’Œy
].
addr
 = 
chªge_pošt
[
chgidx
]->addr;

276 
Ãw_bios
[
Ãw_bios_’Œy
].
ty³
 = 
cu¼’t_ty³
;

277 
Ï¡_addr
=
chªge_pošt
[
chgidx
]->
addr
;

279 
Ï¡_ty³
 = 
cu¼’t_ty³
;

282 
Ãw_Ä
 = 
Ãw_bios_’Œy
;

285 
	`memıy
(
biosm­
, 
Ãw_bios
, 
Ãw_Ä
*(
e820’Œy
));

286 *
²r_m­
 = 
Ãw_Ä
;

289 
	}
}

307 
__š™
 
	$cİy_e820_m­
(
e820’Œy
 * 
biosm­
, 
Ä_m­
)

310 ià(
Ä_m­
 < 2)

314 
¡¬t
 = 
biosm­
->
addr
;

315 
size
 = 
biosm­
->size;

316 
’d
 = 
¡¬t
 + 
size
;

317 
ty³
 = 
biosm­
->type;

320 ià(
¡¬t
 > 
’d
)

327 ià(
ty³
 =ğ
E820_RAM
) {

328 ià(
¡¬t
 < 0x100000ULL && 
’d
 > 0xA0000ULL) {

329 ià(
¡¬t
 < 0xA0000ULL)

330 
	`add_memÜy_»giÚ
(
¡¬t
, 0xA0000ULL-¡¬t, 
ty³
);

331 ià(
’d
 <= 0x100000ULL)

333 
¡¬t
 = 0x100000ULL;

334 
size
 = 
’d
 - 
¡¬t
;

337 
	`add_memÜy_»giÚ
(
¡¬t
, 
size
, 
ty³
);

338 } 
biosm­
++,--
Ä_m­
);

340 
	}
}

346 
__š™
 
	$fšd_max_pâ
()

348 
i
;

349 
max_pâ
 = 0;

352 ià(
efi_’abËd
) {

353 
	`efi_memm­_w®k
(
efi_fšd_max_pâ
, &
max_pâ
);

358 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

359 
¡¬t
, 
’d
;

361 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
)

363 
¡¬t
 = 
	`PFN_UP
(
e820
.
m­
[
i
].
addr
);

364 
’d
 = 
	`PFN_DOWN
(
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
);

365 ià(
¡¬t
 >ğ
’d
)

367 ià(
’d
 > 
max_pâ
)

368 
max_pâ
 = 
’d
;

371  
max_pâ
;

372 
	}
}

374 
__š™
 
	$ş_to_lim™
(
ušt64_t
 
lim™
, *
w¬nmsg
)

376 
i
;

377 
_w¬nmsg
[160];

378 
ušt64_t
 
Şd_lim™
 = 0;

383  
i
 = 0; i < 
e820
.
Ä_m­
; i++ )

384 iàĞ(
e820
.
m­
[
i
].
ty³
 =ğ
E820_RAM
) &&

385 ((
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
è> 
lim™
) )

389 iàĞ
i
 =ğ
e820
.
Ä_m­
 )

392 
Şd_lim™
 = 
	`max_t
(

393 
ušt64_t
, 
Şd_lim™
, 
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
);

396 iàĞ
	`e820_chªge_¿nge_ty³
(&
e820
, 
	`max
Ó820.
m­
[
i
].
addr
, 
lim™
),

397 
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
,

398 
E820_RAM
, 
E820_UNUSABLE
) )

405 iàĞ
e820
.
m­
[
i
].
addr
 < 
lim™
 )

407 
e820
.
m­
[
i
].
size
 = 
lim™
 -ƒ820.m­[i].
addr
;

411 
	`memmove
(&
e820
.
m­
[
i
], &e820.map[i+1],

412 (
e820
.
Ä_m­
 - 
i
 - 1è* (
e820’Œy
));

413 
e820
.
Ä_m­
--;

417 iàĞ
Şd_lim™
 )

419 iàĞ
w¬nmsg
 )

421 
	`¢´štf
(
_w¬nmsg
, (_w¬nmsg), 
w¬nmsg
, ()(
lim™
>>30));

422 
	`´štk
("WARNING: %s\n", 
_w¬nmsg
);

424 
	`´štk
("Truncating RAM from %lukBo %lukB\n",

425 ()(
Şd_lim™
 >> 10), ()(
lim™
 >> 10));

427 
	}
}

430 
	#MSR_MTRRphysBa£
(
»g
è(0x200 + 2 * (»g))

	)

431 
	#MSR_MTRRphysMask
(
»g
è(0x200 + 2 * (»gè+ 1)

	)

432 
ušt64_t
 
__š™
 
	$mŒr_tİ_of_¿m
()

434 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

435 
ušt64_t
 
mŒr_ÿp
, 
mŒr_def
, 
addr_mask
, 
ba£
, 
mask
, 
tİ
;

436 
i
, 
phys_b™s
 = 36;

439 iàĞ
e820_mŒr_ş
 == -1 )

441 
v’dÜ
[13];

442 
	`ıuid
(0x00000000, &
—x
,

443 (
ušt32_t
 *)&
v’dÜ
[0],

444 (
ušt32_t
 *)&
v’dÜ
[8],

445 (
ušt32_t
 *)&
v’dÜ
[4]);

446 
v’dÜ
[12] = '\0';

447 
e820_mŒr_ş
 = !
	`¡rcmp
(
v’dÜ
, "GenuineIntel");

450 iàĞ!
e820_mŒr_ş
 )

453 iàĞ
e820_v”bo£
 )

454 
	`´štk
("Checking MTRR„anges...\n");

457 
	`ıuid
(0x00000001, &
—x
, &
ebx
, &
ecx
, &
edx
);

458 iàĞ!
	`‹¡_b™
(
X86_FEATURE_MTRR
 & 31, &
edx
) )

462 
	`ıuid
(0x80000000, &
—x
, &
ebx
, &
ecx
, &
edx
);

463 iàĞ
—x
 >= 0x80000008 )

465 
	`ıuid
(0x80000008, &
—x
, &
ebx
, &
ecx
, &
edx
);

466 
phys_b™s
 = (
ušt8_t
)
—x
;

468 
addr_mask
 = ((1uÎ << 
phys_b™s
) - 1) & ~((1ull << 12) - 1);

470 
	`rdm¤l
(
MSR_MTRRÿp
, 
mŒr_ÿp
);

471 
	`rdm¤l
(
MSR_MTRRdefTy³
, 
mŒr_def
);

473 iàĞ
e820_v”bo£
 )

474 
	`´štk
(" MTRR c­: %"
PRIx64
"y³: %"PRIx64"\n", 
mŒr_ÿp
, 
mŒr_def
);

477 iàĞ!
	`‹¡_b™
(11, &
mŒr_def
è|| ((
ušt8_t
)mŒr_deà=ğ
MTRR_TYPE_WRBACK
) )

484 
tİ
 = 0;

485  
i
 = 0; i < (
ušt8_t
)
mŒr_ÿp
; i++ )

487 
	`rdm¤l
(
	`MSR_MTRRphysBa£
(
i
), 
ba£
);

488 
	`rdm¤l
(
	`MSR_MTRRphysMask
(
i
), 
mask
);

490 iàĞ
e820_v”bo£
 )

491 
	`´štk
(" MTRR[%d]: ba£ %"
PRIx64
" mask %"PRIx64"\n",

492 
i
, 
ba£
, 
mask
);

494 iàĞ!
	`‹¡_b™
(11, &
mask
è|| ((
ušt8_t
)
ba£
 !ğ
MTRR_TYPE_WRBACK
) )

496 
ba£
 &ğ
addr_mask
;

497 
mask
 &ğ
addr_mask
;

498 
tİ
 = 
	`max_t
(
ušt64_t
,İ, ((
ba£
 | ~
mask
è& 
addr_mask
è+ 
PAGE_SIZE
);

501  
tİ
;

502 
	}
}

504 
__š™
 
	$»£rve_dmi_»giÚ
()

506 
u32
 
ba£
, 
Ën
;

507 iàĞ(
	`dmi_g‘_bË
(&
ba£
, &
Ën
) == 0) && ((base +†en) > base) &&

508 
	`»£rve_e820_¿m
(&
e820
, 
ba£
, ba£ + 
Ën
) )

509 
	`´štk
("WARNING: DMIable†ocated in E820 RAM %08x-%08x. Fixed.\n",

510 
ba£
, ba£+
Ën
);

511 
	}
}

513 
__š™
 
	$machše_¥ecific_memÜy_£tup
(

514 
e820’Œy
 *
¿w
, *
¿w_Ä
)

516 
ušt64_t
 
tİ_of_¿m
, 
size
;

517 
i
;

519 
Ä
 = ()*
¿w_Ä
;

520 
	`§n™ize_e820_m­
(
¿w
, &
Ä
);

521 *
¿w_Ä
 = 
Ä
;

522 ()
	`cİy_e820_m­
(
¿w
, 
Ä
);

524 iàĞ
İt_mem
 )

525 
	`ş_to_lim™
(
İt_mem
, 
NULL
);

527 iàĞ
İt_avamem
 )

529  
i
 = 
size
 = 0; (˜< 
e820
.
Ä_m­
è&& (siz<ğ
İt_avamem
); i++ )

530 iàĞ
e820
.
m­
[
i
].
ty³
 =ğ
E820_RAM
 )

531 
size
 +ğ
e820
.
m­
[
i
].size;

532 iàĞ
size
 > 
İt_avamem
 )

533 
	`ş_to_lim™
(

534 
e820
.
m­
[
i
-1].
addr
 +ƒ820.m­[i-1].
size
 - (size-
İt_avamem
),

535 
NULL
);

538 #ifdeà
__i386__


539 
	`ş_to_lim™
((1ULL << 30è* 
MACHPHYS_MBYTES
,

544 
m±_lim™
, 
ro_m±_lim™
;

546 
m±_lim™
 = ((
RDWR_MPT_VIRT_END
 - 
RDWR_MPT_VIRT_START
)

547 / ()è<< 
PAGE_SHIFT
;

548 
ro_m±_lim™
 = ((
RO_MPT_VIRT_END
 - 
RO_MPT_VIRT_START
)

549 / ()è<< 
PAGE_SHIFT
;

550 iàĞ
m±_lim™
 > 
ro_m±_lim™
 )

551 
m±_lim™
 = 
ro_m±_lim™
;

552 
	`ş_to_lim™
(
m±_lim™
,

558 
	`»£rve_dmi_»giÚ
();

560 
tİ_of_¿m
 = 
	`mŒr_tİ_of_¿m
();

561 iàĞ
tİ_of_¿m
 )

562 
	`ş_to_lim™
(
tİ_of_¿m
, "MTRRs do‚ot cover‡ll of memory.");

563 
	}
}

565 
__š™
 
	$e820_chªge_¿nge_ty³
(

566 
e820m­
 *
e820
, 
ušt64_t
 
s
, ušt64_ˆ
e
,

567 
ušt32_t
 
Üig_ty³
, ušt32_ˆ
Ãw_ty³
)

569 
ušt64_t
 
rs
 = 0, 
»
 = 0;

570 
i
;

572  
i
 = 0; i < 
e820
->
Ä_m­
; i++ )

575 
rs
 = 
e820
->
m­
[
i
].
addr
;

576 
»
 = 
rs
 + 
e820
->
m­
[
i
].
size
;

577 iàĞ(
s
 >ğ
rs
è&& (
e
 <ğ
»
) )

581 iàĞ(
i
 =ğ
e820
->
Ä_m­
è|| (e820->
m­
[i].
ty³
 !ğ
Üig_ty³
) )

584 iàĞ(
s
 =ğ
rs
è&& (
e
 =ğ
»
) )

586 
e820
->
m­
[
i
].
ty³
 = 
Ãw_ty³
;

588 iàĞ(
s
 =ğ
rs
è|| (
e
 =ğ
»
) )

590 iàĞ(
e820
->
Ä_m­
 + 1è> 
	`ARRAY_SIZE
Ó820->
m­
) )

591 
ov”æow
;

593 
	`memmove
(&
e820
->
m­
[
i
+1], &e820->map[i],

594 (
e820
->
Ä_m­
-
i
è* Ó820->
m­
[0]));

595 
e820
->
Ä_m­
++;

597 iàĞ
s
 =ğ
rs
 )

599 
e820
->
m­
[
i
].
size
 = 
e
 - 
s
;

600 
e820
->
m­
[
i
].
ty³
 = 
Ãw_ty³
;

601 
e820
->
m­
[
i
+1].
addr
 = 
e
;

602 
e820
->
m­
[
i
+1].
size
 = 
»
 - 
e
;

606 
e820
->
m­
[
i
].
size
 = 
s
 - 
rs
;

607 
e820
->
m­
[
i
+1].
addr
 = 
s
;

608 
e820
->
m­
[
i
+1].
size
 = 
e
 - 
s
;

609 
e820
->
m­
[
i
+1].
ty³
 = 
Ãw_ty³
;

614 iàĞ(
e820
->
Ä_m­
 + 2è> 
	`ARRAY_SIZE
Ó820->
m­
) )

615 
ov”æow
;

617 
	`memmove
(&
e820
->
m­
[
i
+2], &e820->map[i],

618 (
e820
->
Ä_m­
-
i
è* Ó820->
m­
[0]));

619 
e820
->
Ä_m­
 += 2;

621 
e820
->
m­
[
i
].
size
 = 
s
 - 
rs
;

622 
e820
->
m­
[
i
+1].
addr
 = 
s
;

623 
e820
->
m­
[
i
+1].
size
 = 
e
 - 
s
;

624 
e820
->
m­
[
i
+1].
ty³
 = 
Ãw_ty³
;

625 
e820
->
m­
[
i
+2].
addr
 = 
e
;

626 
e820
->
m­
[
i
+2].
size
 = 
»
 - 
e
;

630  
i
 = 0; i < (
e820
->
Ä_m­
 - 1); i++ )

632 iàĞ(
e820
->
m­
[
i
].
ty³
 !=ƒ820->map[i+1].type) ||

633 ((
e820
->
m­
[
i
].
addr
 +ƒ820->m­[i].
size
) !=ƒ820->map[i+1].addr) )

635 
e820
->
m­
[
i
].
size
 +=ƒ820->map[i+1].size;

636 
	`memmove
(&
e820
->
m­
[
i
+1], &e820->map[i+2],

637 (
e820
->
Ä_m­
-
i
-2è* Ó820->
m­
[0]));

638 
e820
->
Ä_m­
--;

639 
i
--;

644 
ov”æow
:

645 
	`´štk
("Ov”æow iÀe820 wh»£rvšg„egiÚ %"
PRIx64
"-%"PRIx64"\n",

646 
s
, 
e
);

648 
	}
}

651 
__š™
 
	$»£rve_e820_¿m
(
e820m­
 *
e820
, 
ušt64_t
 
s
, ušt64_ˆ
e
)

653  
	`e820_chªge_¿nge_ty³
(
e820
, 
s
, 
e
, 
E820_RAM
, 
E820_RESERVED
);

654 
	}
}

656 
__š™
 
	$š™_e820
(

657 cÚ¡ *
¡r
, 
e820’Œy
 *
¿w
, *
¿w_Ä
)

659 iàĞ
e820_v”bo£
 )

661 
	`´štk
("In™ŸÈ% RAM m­:\n", 
¡r
);

662 
	`´št_e820_memÜy_m­
(
¿w
, *
¿w_Ä
);

665 
	`machše_¥ecific_memÜy_£tup
(
¿w
, 
¿w_Ä
);

667 
	`´štk
("% RAM m­:\n", 
¡r
);

668 
	`´št_e820_memÜy_m­
(
e820
.
m­
,ƒ820.
Ä_m­
);

670  
	`fšd_max_pâ
();

671 
	}
}

	@extable.c

2 
	~<x’/cÚfig.h
>

3 
	~<x’/š™.h
>

4 
	~<x’/³rfc.h
>

5 
	~<x’/sÜt.h
>

6 
	~<x’/¥šlock.h
>

7 
	~<asm/uacûss.h
>

9 
exû±iÚ_bË_’Œy
 
__¡¬t___ex_bË
[];

10 
exû±iÚ_bË_’Œy
 
__¡İ___ex_bË
[];

11 
exû±iÚ_bË_’Œy
 
__¡¬t___´e_ex_bË
[];

12 
exû±iÚ_bË_’Œy
 
__¡İ___´e_ex_bË
[];

14 #ifdeà
__i386__


15 
	#EX_FIELD
(
±r
, 
f›ld
èÕŒ)->
	)
field

16 
	#sw­_ex
 
NULL


	)

18 
	#EX_FIELD
(
±r
, 
f›ld
è(()&ÕŒ)->f›ld + (±r)->f›ld)

	)

21 
šlše
 
	$ex_addr
(cÚ¡ 
exû±iÚ_bË_’Œy
 *
x
)

23  
	`EX_FIELD
(
x
, 
addr
);

24 
	}
}

26 
šlše
 
	$ex_cÚt
(cÚ¡ 
exû±iÚ_bË_’Œy
 *
x
)

28  
	`EX_FIELD
(
x
, 
cÚt
);

29 
	}
}

31 
__š™
 
	$cmp_ex
(cÚ¡ *
a
, cÚ¡ *
b
)

33 cÚ¡ 
exû±iÚ_bË_’Œy
 *
l
 = 
a
, *
r
 = 
b
;

34 
l
 = 
	`ex_addr
(
l
);

35 
r
 = 
	`ex_addr
(
r
);

38 ià(
l
 > 
r
)

40 ià(
l
 < 
r
)

43 
	}
}

45 #iâdeà
sw­_ex


46 
__š™
 
	$sw­_ex
(*
a
, *
b
, 
size
)

48 
exû±iÚ_bË_’Œy
 *
l
 = 
a
, *
r
 = 
b
, 
tmp
;

49 
d–
 = 
b
 - 
a
;

51 
tmp
 = *
l
;

52 
l
->
addr
 = 
r
->add¸+ 
d–
;

53 
l
->
cÚt
 = 
r
->cÚˆ+ 
d–
;

54 
r
->
addr
 = 
tmp
.add¸- 
d–
;

55 
r
->
cÚt
 = 
tmp
.cÚˆ- 
d–
;

56 
	}
}

59 
__š™
 
	$sÜt_exû±iÚ_bËs
()

61 
	`sÜt
(
__¡¬t___ex_bË
, 
__¡İ___ex_bË
 - __start___ex_table,

62 (
exû±iÚ_bË_’Œy
), 
cmp_ex
, 
sw­_ex
);

63 
	`sÜt
(
__¡¬t___´e_ex_bË
,

64 
__¡İ___´e_ex_bË
 - 
__¡¬t___´e_ex_bË
,

65 (
exû±iÚ_bË_’Œy
), 
cmp_ex
, 
sw­_ex
);

66 
	}
}

68 
šlše
 

69 
	$£¬ch_Úe_bË
(cÚ¡ 
exû±iÚ_bË_’Œy
 *
fœ¡
,

70 cÚ¡ 
exû±iÚ_bË_’Œy
 *
Ï¡
,

71 
v®ue
)

73 cÚ¡ 
exû±iÚ_bË_’Œy
 *
mid
;

74 
diff
;

76  
fœ¡
 <ğ
Ï¡
 )

78 
mid
 = (
Ï¡
 - 
fœ¡
) / 2 + first;

79 
diff
 = 
	`ex_addr
(
mid
è- 
v®ue
;

80 ià(
diff
 == 0)

81  
	`ex_cÚt
(
mid
);

82 ià(
diff
 < 0)

83 
fœ¡
 = 
mid
+1;

85 
Ï¡
 = 
mid
-1;

88 
	}
}

91 
	$£¬ch_exû±iÚ_bË
(
addr
)

93  
	`£¬ch_Úe_bË
(

94 
__¡¬t___ex_bË
, 
__¡İ___ex_bË
-1, 
addr
);

95 
	}
}

98 
	$£¬ch_´e_exû±iÚ_bË
(
ıu_u£r_»gs
 *
»gs
)

100 
addr
 = ()
»gs
->
e
;

101 
fixup
 = 
	`£¬ch_Úe_bË
(

102 
__¡¬t___´e_ex_bË
, 
__¡İ___´e_ex_bË
-1, 
addr
);

103 iàĞ
fixup
 )

105 
	`d´štk
(
XENLOG_INFO
, "P»-exû±iÚ: %°-> %p\n", 
	`_p
(
addr
), _p(
fixup
));

106 
	`³rfc_šü
(
exû±iÚ_fixed
);

108  
fixup
;

109 
	}
}

	@flushtlb.c

10 
	~<x’/cÚfig.h
>

11 
	~<x’/sched.h
>

12 
	~<x’/soáœq.h
>

13 
	~<asm/æushb.h
>

14 
	~<asm/·ge.h
>

17 #ifdeà
NDEBUG


18 
	#WRAP_MASK
 (0xFFFFFFFFU)

	)

20 
	#WRAP_MASK
 (0x000003FFU)

	)

23 
u32
 
	gbæush_şock
 = 1U;

24 
DEFINE_PER_CPU
(
u32
, 
bæush_time
);

34 
u32
 
	$´e_æush
()

36 
u32
 
t
, 
t1
, 
t2
;

38 
t
 = 
bæush_şock
;

40 
t1
 = 
t2
 = 
t
;

42 iàĞ
	`uÆik–y
(
t1
 == 0) )

43 
sk_şocktick
;

44 
t2
 = (
t
 + 1è& 
WRAP_MASK
;

46  
	`uÆik–y
((
t
 = 
	`cmpxchg
(&
bæush_şock
, 
t1
, 
t2
)) !=1) );

49 iàĞ
	`uÆik–y
(
t2
 == 0) )

50 
	`¿i£_soáœq
(
NEW_TLBFLUSH_CLOCK_PERIOD_SOFTIRQ
);

52 
sk_şocktick
:

53  
t2
;

54 
	}
}

68 
	$po¡_æush
(
u32
 
t
)

70 
	`this_ıu
(
bæush_time
èğ
t
;

71 
	}
}

74 #ifdeà
VERBOSE_UPDATE_CR3


75 
	$´št_ü3
(
ü3
, 
hšt
)

77 ià(!
mši_aùiv©ed
)

79 ià(
hšt
 == 1)

81 ià(
hšt
 == 3) {

82 
	`com·»_ü3
();

85 ià(
hšt
 == 2)

88 
mâ
 = (
	`»ad_ü3
()>>
PAGE_SHIFT
);

89 
	`my´štk
("ü3:%lx->%lx ", 
mâ
, 
ü3
 >> 
PAGE_SHIFT
);

91 ià(
hšt
 == 1) {

92 
	`´štk
("\n");

93 } ià(
hšt
 == 2) {

94 
	`´štk
("\n");

95 } ià(
hšt
 == 3) {

96 
vıu
 *
v
 = 
cu¼’t
;

97 *
¡r
;

98 iàĞ
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
 ) {

99 
¡r
 = "To kernel";

101 
¡r
 = "To user";

102 
	`´štk
("¿x:%ld„:%lx sys:%lx %s\n", 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
¿x
, v->¬ch.gue¡_cÚ‹xt.u£r_»gs.
r
,

103 
v
->
¬ch
.
gue¡_cÚ‹xt
.
sysÿÎ_ÿÎback_e
,

104 
¡r
);

107 
	`´štk
(" TODO (%d)\n", 
hšt
);

111 ià(
cu¼’t
->
´št_couÁdown
 > 0) {

112 
·ge_dœ
 *
pgd
 = 
cu¼’t
->
cu¼’t_pgd
;

113 
mâ
 = (
	`»ad_ü3
()>>
PAGE_SHIFT
);

114 ià(
pgd
)

115 
	`my´štk
("pgdmâ:%x, cr3:%lx->%lx mâ[%x,%x]\n",
pgd
->
±
->
mâ
, mâ, 
ü3
 >> 
PAGE_SHIFT
, 
	`vœt_to_mâ
Õgd->±->
shadow
[0]), virt_to_mfn(pgd->pt->shadow[1]));

117 
	`my´štk
("ü3:%lx->%lx\n", 
mâ
, 
ü3
 >> 
PAGE_SHIFT
);

118 
cu¼’t
->
´št_couÁdown
--;

121 
	}
}

125 
	$_wr™e_ü3
(
ü3
, 
hšt
)

127 
æags
;

128 
u32
 
t
;

130 #ifdeà
VERBOSE_UPDATE_CR3


131 
	`´št_ü3
(
ü3
, 
hšt
);

135 
	`loÿl_œq_§ve
(
æags
);

137 
t
 = 
	`´e_æush
();

139 
	`hvm_æush_gue¡_bs
();

141 #ifdeà
USER_MAPPINGS_ARE_GLOBAL


143 
ü4
 = 
	`»ad_ü4
();

144 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

145 
asm
 vŞ©Ğ"mov %0, %%ü3" : : "r" (
ü3
) : "memory" );

146 
	`wr™e_ü4
(
ü4
);

149 
asm
 vŞ©Ğ"mov %0, %%ü3" : : "r" (
ü3
) : "memory" );

152 
	`po¡_æush
(
t
);

154 
	`loÿl_œq_»¡Üe
(
æags
);

155 
	}
}

157 
	$wr™e_ü3
(
ü3
)

159 ià(
mši_aùiv©ed
)

160 
	`my·nic
("Uncaptured write_cr3()\n");

161 
	`_wr™e_ü3
(
ü3
, 100);

162 
	}
}

164 
	$æush_¬—_loÿl
(cÚ¡ *
va
, 
æags
)

166 cÚ¡ 
ıušfo_x86
 *
c
 = &
cu¼’t_ıu_d©a
;

167 
Üd”
 = (
æags
 - 1è& 
FLUSH_ORDER_MASK
;

168 
œqæ
;

171 
	`loÿl_œq_§ve
(
œqæ
);

173 iàĞ
æags
 & (
FLUSH_TLB
|
FLUSH_TLB_GLOBAL
) )

175 iàĞ
Üd”
 == 0 )

183 
asm
 volatile ( "invlpg %0"

184 : : "m" (*(cÚ¡ *)(
va
)) : "memory" );

188 
u32
 
t
 = 
	`´e_æush
();

190 
	`hvm_æush_gue¡_bs
();

192 #iâdeà
USER_MAPPINGS_ARE_GLOBAL


193 iàĞ!(
æags
 & 
FLUSH_TLB_GLOBAL
è|| !(
	`»ad_ü4
(è& 
X86_CR4_PGE
) )

195 
asm
 volatile ( "mov %0, %%cr3"

196 : : "r" (
	`»ad_ü3
()) : "memory" );

201 
ü4
 = 
	`»ad_ü4
();

202 
	`wr™e_ü4
(
ü4
 & ~
X86_CR4_PGE
);

203 
	`b¬r›r
();

204 
	`wr™e_ü4
(
ü4
);

207 
	`po¡_æush
(
t
);

211 iàĞ
æags
 & 
FLUSH_CACHE
 )

213 
i
, 
sz
 = 0;

215 iàĞ
Üd”
 < (
BITS_PER_LONG
 - 
PAGE_SHIFT
) )

216 
sz
 = 1UL << (
Üd”
 + 
PAGE_SHIFT
);

218 iàĞ
c
->
x86_şæush_size
 && c->
x86_ÿche_size
 && 
sz
 &&

219 ((
sz
 >> 10è< 
c
->
x86_ÿche_size
) )

221 
va
 = (cÚ¡ *)(()v¨& ~(
sz
 - 1));

222  
i
 = 0; i < 
sz
; i +ğ
c
->
x86_şæush_size
 )

223 
asm
 volatile ( "clflush %0"

224 : : "m" (((cÚ¡ *)
va
)[
i
]) );

228 
	`wbšvd
();

232 
	`loÿl_œq_»¡Üe
(
œqæ
);

233 
	}
}

	@gdbstub.c

22 
	~<asm/debugg”.h
>

24 
u16


25 
	$gdb_¬ch_sigÇl_num
(
ıu_u£r_»gs
 *
»gs
, 
cook›
)

28 
	}
}

35 
	$gdb_¬ch_cİy_äom_u£r
(*
de¡
, cÚ¡ *
¤c
, 
Ën
)

37  
	`__cİy_äom_u£r
(
de¡
, 
¤c
, 
Ën
);

38 
	}
}

41 
	$gdb_¬ch_cİy_to_u£r
(*
de¡
, cÚ¡ *
¤c
, 
Ën
)

43  
	`__cİy_to_u£r
(
de¡
, 
¤c
, 
Ën
);

44 
	}
}

47 
	$gdb_¬ch_´št_¡©e
(
ıu_u£r_»gs
 *
»gs
)

50 
	}
}

53 
	$gdb_¬ch_’‹r
(
ıu_u£r_»gs
 *
»gs
)

56 
	}
}

59 
	$gdb_¬ch_ex™
(
ıu_u£r_»gs
 *
»gs
)

62 
	}
}

65 
	$gdb_¬ch_»sume
(
ıu_u£r_»gs
 *
»gs
,

66 
addr
, 
ty³
,

67 
gdb_cÚ‹xt
 *
ùx
)

69 iàĞ
addr
 != -1UL )

70 
»gs
->
e
 = 
addr
;

72 
»gs
->
eæags
 &ğ~
X86_EFLAGS_TF
;

75 
»gs
->
eæags
 |ğ
X86_EFLAGS_RF
;

78 iàĞ
ty³
 =ğ
GDB_STEP
 )

79 
»gs
->
eæags
 |ğ
X86_EFLAGS_TF
;

80 
	}
}

	@genapic/bigsmp.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/ıumask.h
>

3 
	~<asm/cu¼’t.h
>

4 
	~<asm/mp¥ec.h
>

5 
	~<asm/g’­ic.h
>

6 
	~<asm/fixm­.h
>

7 
	~<asm/­icdef.h
>

8 
	~<x’/k”Ãl.h
>

9 
	~<x’/smp.h
>

10 
	~<x’/š™.h
>

11 
	~<x’/dmi.h
>

12 
	~<asm/mach-deçuÉ/mach_mµ¬£.h
>

13 
	~<asm/io_­ic.h
>

15 
	gdmi_bigsmp
;

17 
__š™
 
	$fÜû_bigsmp
(
dmi_sy¡em_id
 *
d
)

19 
	`´štk
(
KERN_NOTICE
 "% d‘eùed: fÜû u£ oà­ic=bigsmp\n", 
d
->
id’t
);

20 
dmi_bigsmp
 = 1;

22 
	}
}

25 
dmi_sy¡em_id
 
__š™d©a
 
	gbigsmp_dmi_bË
[] = {

26 { 
fÜû_bigsmp
, "HP ProLiant DL760 G2", {

27 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

28 
DMI_MATCH
(
DMI_BIOS_VERSION
, "P44-"),

31 { 
fÜû_bigsmp
, "HP ProLiant DL740", {

32 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

33 
DMI_MATCH
(
DMI_BIOS_VERSION
, "P47-"),

35 { 
fÜû_bigsmp
, "UNISYS ES7000-ONE", {

36 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ES7000-ONE")

43 
__š™
 
	$´obe_bigsmp
()

45 ià(
def_to_bigsmp
)

46 
dmi_bigsmp
 = 1;

48 
	`dmi_check_sy¡em
(
bigsmp_dmi_bË
);

49  
dmi_bigsmp
;

50 
	}
}

52 cÚ¡ 
g’­ic
 
	g­ic_bigsmp
 = {

53 
APIC_INIT
("bigsmp", 
´obe_bigsmp
),

54 
GENAPIC_PHYS


	@genapic/default.c

4 
	~<x’/cÚfig.h
>

5 
	~<x’/ıumask.h
>

6 
	~<asm/cu¼’t.h
>

7 
	~<asm/mp¥ec.h
>

8 
	~<asm/g’­ic.h
>

9 
	~<asm/fixm­.h
>

10 
	~<asm/­icdef.h
>

11 
	~<x’/k”Ãl.h
>

12 
	~<x’/¡ršg.h
>

13 
	~<x’/smp.h
>

14 
	~<x’/š™.h
>

15 
	~<asm/io_­ic.h
>

16 
	~<asm/mach-deçuÉ/mach_mµ¬£.h
>

19 
__š™
 
	$´obe_deçuÉ
()

22 
	}
}

24 cÚ¡ 
g’­ic
 
	g­ic_deçuÉ
 = {

25 
APIC_INIT
("deçuÉ", 
´obe_deçuÉ
),

26 
GENAPIC_FLAT


	@genapic/delivery.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/œq.h
>

3 
	~<x’/sched.h
>

4 
	~<asm/cu¼’t.h
>

5 
	~<asm/smp.h
>

6 
	~<asm/h¬dœq.h
>

7 
	~<mach_­ic.h
>

10 cÚ¡ 
ıumask_t
 *
	$rg‘_ıus_®l
()

12  &
ıu_Úlše_m­
;

13 
	}
}

19 
	$š™_­ic_ldr_æ©
()

21 
v®
;

23 
	`­ic_wr™e_¬ound
(
APIC_DFR
, 
APIC_DFR_FLAT
);

24 
v®
 = 
	`­ic_»ad
(
APIC_LDR
è& ~
APIC_LDR_MASK
;

25 
v®
 |ğ
	`SET_xAPIC_LOGICAL_ID
(1UL << 
	`smp_´oûssÜ_id
());

26 
	`­ic_wr™e_¬ound
(
APIC_LDR
, 
v®
);

27 
	}
}

29 
__š™
 
	$şu¡”ed_­ic_check_æ©
()

31 
	`´štk
("EÇblšg APIC mode: FÏt. Usšg %d I/O APICs\n", 
Ä_ißpics
);

32 
	}
}

34 cÚ¡ 
ıumask_t
 *
	$veùÜ_®loÿtiÚ_ıumask_æ©
(
ıu
)

36  &
ıu_Úlše_m­
;

37 
	}
}

39 
	$ıu_mask_to_­icid_æ©
(cÚ¡ 
ıumask_t
 *
ıumask
)

41  
	`ıus_addr
(*
ıumask
)[0]&0xFF;

42 
	}
}

48 
	$š™_­ic_ldr_phys
()

50 
v®
;

51 
	`­ic_wr™e_¬ound
(
APIC_DFR
, 
APIC_DFR_FLAT
);

53 
v®
 = 
	`­ic_»ad
(
APIC_LDR
è& ~
APIC_LDR_MASK
;

54 
	`­ic_wr™e_¬ound
(
APIC_LDR
, 
v®
);

55 
	}
}

57 
__š™
 
	$şu¡”ed_­ic_check_phys
()

59 
	`´štk
("EÇblšg APIC mode: Phys. Usšg %d I/O APICs\n", 
Ä_ißpics
);

60 
	}
}

62 cÚ¡ 
ıumask_t
 *
	$veùÜ_®loÿtiÚ_ıumask_phys
(
ıu
)

64  
	`ıumask_of
(
ıu
);

65 
	}
}

67 
	$ıu_mask_to_­icid_phys
(cÚ¡ 
ıumask_t
 *
ıumask
)

70  
	`ıu_physiÿl_id
(
	`ıumask_fœ¡
(
ıumask
));

71 
	}
}

	@genapic/probe.c

6 
	~<x’/cÚfig.h
>

7 
	~<x’/ıumask.h
>

8 
	~<x’/¡ršg.h
>

9 
	~<x’/k”Ãl.h
>

10 
	~<x’/ùy³.h
>

11 
	~<x’/š™.h
>

12 
	~<asm/ÿche.h
>

13 
	~<asm/fixm­.h
>

14 
	~<asm/mp¥ec.h
>

15 
	~<asm/­icdef.h
>

16 
	~<asm/mach-g’”ic/mach_­ic.h
>

17 
	~<asm/£tup.h
>

19 cÚ¡ 
g’­ic
 
­ic_summ™
;

20 cÚ¡ 
g’­ic
 
­ic_bigsmp
;

21 cÚ¡ 
g’­ic
 
­ic_deçuÉ
;

23 cÚ¡ 
g’­ic
 *
__»ad_mo¡ly
 
	gg’­ic
;

25 cÚ¡ 
g’­ic
 *
	g­ic_´obe
[] 
	g__š™d©a
 = {

26 &
­ic_summ™
,

27 &
­ic_bigsmp
,

28 &
­ic_deçuÉ
,

29 
NULL
,

32 
	gcmdlše_­ic
;

34 
__š™
 
	$g’”ic_bigsmp_´obe
()

43 ià(!
cmdlše_­ic
 && 
g’­ic
 =ğ&
­ic_deçuÉ
)

44 ià(
­ic_bigsmp
.
	`´obe
()) {

45 
g’­ic
 = &
­ic_bigsmp
;

46 
	`´štk
(
KERN_INFO
 "Overriding APIC driver with %s\n",

47 
g’­ic
->
Çme
);

49 
	}
}

51 
__š™
 
	$g’­ic_­ic_fÜû
(*
¡r
)

53 
i
;

54 
i
 = 0; 
­ic_´obe
[i]; i++)

55 ià(!
	`¡rcmp
(
­ic_´obe
[
i
]->
Çme
, 
¡r
))

56 
g’­ic
 = 
­ic_´obe
[
i
];

57 
	}
}

58 
cu¡om_·¿m
("­ic", 
g’­ic_­ic_fÜû
);

60 
__š™
 
	$g’”ic_­ic_´obe
()

62 
i
, 
chªged
;

64 
	`check_x2­ic_´“ÇbËd
();

65 
cmdlše_­ic
 = 
chªged
 = (
g’­ic
 !ğ
NULL
);

67 
i
 = 0; !
chªged
 && 
­ic_´obe
[i]; i++) {

68 ià(
­ic_´obe
[
i
]->
	`´obe
()) {

69 
chªged
 = 1;

70 
g’­ic
 = 
­ic_´obe
[
i
];

73 ià(!
chªged
)

74 
g’­ic
 = &
­ic_deçuÉ
;

76 
	`´štk
(
KERN_INFO
 "Usšg APIC driv” %s\n", 
g’­ic
->
Çme
);

77 
	}
}

81 
__š™
 
	$mps_Ûm_check
(
mp_cÚfig_bË
 *
mpc
, *
Ûm
, *
´oduùid
)

83 
i
;

84 
i
 = 0; 
­ic_´obe
[i]; ++i) {

85 ià(
­ic_´obe
[
i
]->
	`mps_Ûm_check
(
mpc
,
Ûm
,
´oduùid
)) {

86 ià(!
cmdlše_­ic
) {

87 
g’­ic
 = 
­ic_´obe
[
i
];

88 
	`´štk
(
KERN_INFO
 "Switchedo APIC driver `%s'.\n",

89 
g’­ic
->
Çme
);

95 
	}
}

97 
__š™
 
	$aıi_madt_Ûm_check
(*
Ûm_id
, *
Ûm_bË_id
)

99 
i
;

100 
i
 = 0; 
­ic_´obe
[i]; ++i) {

101 ià(
­ic_´obe
[
i
]->
	`aıi_madt_Ûm_check
(
Ûm_id
, 
Ûm_bË_id
)) {

102 ià(!
cmdlše_­ic
) {

103 
g’­ic
 = 
­ic_´obe
[
i
];

104 
	`´štk
(
KERN_INFO
 "Switchedo APIC driver `%s'.\n",

105 
g’­ic
->
Çme
);

111 
	}
}

	@genapic/summit.c

4 
	~<x’/cÚfig.h
>

5 
	~<x’/ıumask.h
>

6 
	~<asm/cu¼’t.h
>

7 
	~<asm/mp¥ec.h
>

8 
	~<asm/g’­ic.h
>

9 
	~<asm/fixm­.h
>

10 
	~<asm/­icdef.h
>

11 
	~<x’/k”Ãl.h
>

12 
	~<x’/¡ršg.h
>

13 
	~<x’/smp.h
>

14 
	~<x’/š™.h
>

15 
	~<asm/mach-summ™/mach_mµ¬£.h
>

16 
	~<asm/io_­ic.h
>

18 
__š™
 
	$´obe_summ™
()

22 
	}
}

24 cÚ¡ 
g’­ic
 
	g­ic_summ™
 = {

25 
APIC_INIT
("summ™", 
´obe_summ™
),

26 
GENAPIC_PHYS


	@genapic/x2apic.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/š™.h
>

22 
	~<x’/ıumask.h
>

23 
	~<asm/­icdef.h
>

24 
	~<asm/g’­ic.h
>

25 
	~<asm/­ic.h
>

26 
	~<asm/io_­ic.h
>

27 
	~<asm/m¤.h
>

28 
	~<asm/´oûssÜ.h
>

29 
	~<x’/smp.h
>

30 
	~<asm/mach-deçuÉ/mach_mµ¬£.h
>

32 
boŞ_t
 
__š™d©a
 
	gx2­ic_phys
;

33 
boŞ—n_·¿m
("x2­ic_phys", 
x2­ic_phys
);

35 
	$š™_­ic_ldr_x2­ic_phys
()

37 
	}
}

39 
	$š™_­ic_ldr_x2­ic_şu¡”
()

41 
ıu
 = 
	`smp_´oûssÜ_id
();

42 
ıu_2_logiÿl_­icid
[
ıu
] = 
	`­ic_»ad
(
APIC_LDR
);

43 
	}
}

45 
__š™
 
	$şu¡”ed_­ic_check_x2­ic
()

47 
	}
}

49 
	$ıu_mask_to_­icid_x2­ic_şu¡”
(cÚ¡ 
ıumask_t
 *
ıumask
)

51  
ıu_2_logiÿl_­icid
[
	`ıumask_fœ¡
(
ıumask
)];

52 
	}
}

54 
	$__£nd_IPI_mask_x2­ic
(

55 cÚ¡ 
ıumask_t
 *
ıumask
, 
veùÜ
, 
de¡_mode
)

57 
ıu
;

58 
æags
;

59 
ušt64_t
 
m¤_cÚ‹Á
;

71 
	`mb
();

73 
	`loÿl_œq_§ve
(
æags
);

75 
	`fÜ_—ch_ıu_mask
 ( 
ıu
, *
ıumask
 )

77 iàĞ!
	`ıu_Úlše
(
ıu
è|| (ıu =ğ
	`smp_´oûssÜ_id
()) )

79 
m¤_cÚ‹Á
 = (
de¡_mode
 =ğ
APIC_DEST_PHYSICAL
)

80 ? 
	`ıu_physiÿl_id
(
ıu
è: 
ıu_2_logiÿl_­icid
[cpu];

81 
m¤_cÚ‹Á
 = (m¤_cÚ‹Á << 32è| 
APIC_DM_FIXED
 | 
de¡_mode
 | 
veùÜ
;

82 
	`­ic_wrm¤
(
APIC_ICR
, 
m¤_cÚ‹Á
);

85 
	`loÿl_œq_»¡Üe
(
æags
);

86 
	}
}

88 
	$£nd_IPI_mask_x2­ic_phys
(cÚ¡ 
ıumask_t
 *
ıumask
, 
veùÜ
)

90 
	`__£nd_IPI_mask_x2­ic
(
ıumask
, 
veùÜ
, 
APIC_DEST_PHYSICAL
);

91 
	}
}

93 
	$£nd_IPI_mask_x2­ic_şu¡”
(cÚ¡ 
ıumask_t
 *
ıumask
, 
veùÜ
)

95 
	`__£nd_IPI_mask_x2­ic
(
ıumask
, 
veùÜ
, 
APIC_DEST_LOGICAL
);

96 
	}
}

98 cÚ¡ 
g’­ic
 
	g­ic_x2­ic_phys
 = {

99 
APIC_INIT
("x2­ic_phys", 
NULL
),

100 .
št_d–iv”y_mode
 = 
de¡_Fixed
,

101 .
	gšt_de¡_mode
 = 0 ,

102 .
	gš™_­ic_ldr
 = 
š™_­ic_ldr_x2­ic_phys
,

103 .
	gşu¡”ed_­ic_check
 = 
şu¡”ed_­ic_check_x2­ic
,

104 .
	grg‘_ıus
 = 
rg‘_ıus_®l
,

105 .
	gveùÜ_®loÿtiÚ_ıumask
 = 
veùÜ_®loÿtiÚ_ıumask_phys
,

106 .
	gıu_mask_to_­icid
 = 
ıu_mask_to_­icid_phys
,

107 .
	g£nd_IPI_mask
 = 
£nd_IPI_mask_x2­ic_phys
,

108 .
	g£nd_IPI_£lf
 = 
£nd_IPI_£lf_x2­ic


111 cÚ¡ 
g’­ic
 
	g­ic_x2­ic_şu¡”
 = {

112 
APIC_INIT
("x2­ic_şu¡”", 
NULL
),

113 .
št_d–iv”y_mode
 = 
de¡_Lowe¡Prio
,

114 .
	gšt_de¡_mode
 = 1 ,

115 .
	gš™_­ic_ldr
 = 
š™_­ic_ldr_x2­ic_şu¡”
,

116 .
	gşu¡”ed_­ic_check
 = 
şu¡”ed_­ic_check_x2­ic
,

117 .
	grg‘_ıus
 = 
rg‘_ıus_®l
,

118 .
	gveùÜ_®loÿtiÚ_ıumask
 = 
veùÜ_®loÿtiÚ_ıumask_phys
,

119 .
	gıu_mask_to_­icid
 = 
ıu_mask_to_­icid_x2­ic_şu¡”
,

120 .
	g£nd_IPI_mask
 = 
£nd_IPI_mask_x2­ic_şu¡”
,

121 .
	g£nd_IPI_£lf
 = 
£nd_IPI_£lf_x2­ic


124 cÚ¡ 
g’­ic
 *
__š™
 
	$­ic_x2­ic_´obe
()

126  
x2­ic_phys
 ? &
­ic_x2­ic_phys
 : &
­ic_x2­ic_şu¡”
;

127 
	}
}

129 
__š™
 
	$check_x2­ic_´“ÇbËd
()

131 
u32
 
lo
, 
hi
;

133 iàĞ!
ıu_has_x2­ic
 )

137 
	`rdm¤
(
MSR_IA32_APICBASE
, 
lo
, 
hi
);

138 iàĞ
lo
 & 
MSR_IA32_APICBASE_EXTD
 )

140 
	`´štk
("x2APIC mode is‡lreadyƒnabled by BIOS.\n");

141 #iâdeà
__i386__


142 
x2­ic_’abËd
 = 1;

143 
g’­ic
 = 
	`­ic_x2­ic_´obe
();

145 
lo
 &ğ~(
MSR_IA32_APICBASE_ENABLE
 | 
MSR_IA32_APICBASE_EXTD
);

146 
	`wrm¤
(
MSR_IA32_APICBASE
, 
lo
, 
hi
);

147 
lo
 |ğ
MSR_IA32_APICBASE_ENABLE
;

148 
	`wrm¤
(
MSR_IA32_APICBASE
, 
lo
, 
hi
);

149 
	`´štk
("x2APIC disabled…ermanently on x86_32.\n");

153 #ifdeà
__i386__


154 
	`ş—r_b™
(
X86_FEATURE_X2APIC
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
);

156 
	}
}

	@hetero.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 
	#HETERO_SYNC1


25 
	#HETERO_SYNC2


	)

27 #ifdeà
ENABLE_HETERO


28 
©omic_t
 
	gh‘”o_·ges_couÁ
;

29 
©omic_t
 
	gh‘”o_·ges_vm
[
MAX_HETERO_VM
];

30 
	gh‘”o_·ges_vm_lim™
[
MAX_HETERO_VM
];

31 
	gh‘”o_·ges_vm_ex³ù
[
MAX_HETERO_VM
];

32 
	gvm_tÙ_·ges
[
MAX_HETERO_VM
];

33 
¥šlock_t
 
	gh‘”o_lock
;

35 
©omic_t
 
	ghÙ_·ges_vm
[
MAX_HETERO_VM
];

37 #ifdeà
HETERO_SYNC1


38 
©omic_t
 
	gsim¶e_b¬r›r
;

39 
	$h‘”o_wa™
(*
unu£d
)

41 
	`©omic_dec
(&
sim¶e_b¬r›r
);

42 
	`æush_b_loÿl
();

44 
	`my¥š_lock
(&
h‘”o_lock
, 63);

45 
	`¥š_uÆock
(&
h‘”o_lock
);

46 
	}
}

49 
	$h‘”o_adju¡_lim™
(
domid
, 
d–
)

51 
h‘”o_·ges_vm_lim™
[
domid
] +ğ
d–
;

52 
	}
}

54 
	$h‘”o_š™Ÿlize
()

56 
i
;

57 
i
=0;i<
max_·ge
;i++) {

58 
	`FTABLE_HETERO
(
i
) = 0;

60 
	`©omic_£t
(&
h‘”o_·ges_couÁ
, 0);

61 
i
=0;i<
MAX_HETERO_VM
;i++) {

62 
	`©omic_£t
(&
h‘”o_·ges_vm
[
i
], 0);

63 
h‘”o_·ges_vm_lim™
[
i
] = 0;

64 
h‘”o_·ges_vm_ex³ù
[
i
] = 0;

65 
vm_tÙ_·ges
[
i
] = 0;

66 
	`©omic_£t
(&
hÙ_·ges_vm
[
i
], 0);

69 
h‘”o_·ges_vm_lim™
[0] = 64;

70 
h‘”o_·ges_vm_lim™
[1] = 2048;

71 
h‘”o_·ges_vm_lim™
[2] = 2048;

72 
h‘”o_·ges_vm_lim™
[3] = 2048;

74 
	`¥š_lock_š™
(&
h‘”o_lock
);

75 
	}
}

92 
	$Ëss_thª_lim™
(
mâ
)

94 
domaš
 *
vm
 = 
	`·ge_g‘_owÃr
(
	`__mâ_to_·ge
(
mâ
));

95 ià(
vm
) {

96 
vm_id
 = 
vm
->
domaš_id
;

97 ià(
vm_id
>=0 && vm_id < 
MAX_HETERO_VM
) {

98 ià(
h‘”o_·ges_vm_lim™
[
vm_id
] == 0)

100 ià(
h‘”o_·ges_vm_ex³ù
[
vm_id
] == 0)

101 
h‘”o_·ges_vm_ex³ù
[
vm_id
] = 
	`©omic_»ad
(&
h‘”o_·ges_vm
[vm_id]);

102 ià(
h‘”o_·ges_vm_ex³ù
[
vm_id
] =ğ
h‘”o_·ges_vm_lim™
[vm_id])

104 ià(
h‘”o_·ges_vm_ex³ù
[
vm_id
] < 
h‘”o_·ges_vm_lim™
[vm_id]) {

105 
h‘”o_·ges_vm_ex³ù
[
vm_id
]++;

108 
h‘”o_·ges_vm_ex³ù
[
vm_id
]--;

112 
	`my´štk
("WARN inv®id vm_id:%d\n", 
vm_id
);

115 
	`my´štk
("WARN‚uÎ owÃr..mâ:%lx\n", 
mâ
);

118 
	}
}

121 
	$h‘”o
(
mâ
, 
add
 )

123 
rm­_£t
 *
rms
;

124 
i
,
j
;

125 
·ge_bË
 *
±
;

126 
±i
;

127 
rm­_couÁ
 = 0;

128 
rm­s_butš
 *
r
;

130 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
RMAPS_USER
);

132 ià(
r
->
rm­_couÁ
 > 200) {

133 
	`my´štk
("sk %d„m­s..\n", 
r
->
rm­_couÁ
);

137 
Ãw_mâ
;

138 ià(
add
) {

139 *
p
;

140 #ifdeà
ENABLE_MULTI_NODE


141 
p
 = 
	`®loc_x’h—p_·ges
(0,
	`MEMF_node
(
FAST_MEMORY_NODE
));

143 
p
 = 
	`my®loc_x’h—p_·ge
(10);

145 
	`MYASSERT
(
p
);

146 
Ãw_mâ
 = 
	`vœt_to_mâ
(
p
);

147 
	`memıy
(
p
, 
	`mâ_to_vœt
(
mâ
), 
PAGE_SIZE
);

149 
	`©omic_šc
(&
h‘”o_·ges_couÁ
);

151 
domaš
 *
vm
 = 
	`·ge_g‘_owÃr
(
	`__mâ_to_·ge
(
mâ
));

152 ià(
vm
) {

153 
vm_id
 = 
vm
->
domaš_id
;

154 ià(
vm_id
>=0 && vm_id < 
MAX_HETERO_VM
) {

155 
vm_tÙ_·ges
[
vm_id
] = 
vm
->
tÙ_·ges
;

156 
	`©omic_šc
(&
h‘”o_·ges_vm
[
vm_id
]);

158 
	`my´štk
("WARN inv®id vm_id:%d\n", 
vm_id
);

161 
	`my´štk
("WARN‚uÎ owÃr..mâ:%lx\n", 
mâ
);

164 
	`MYASSERT
(
	`FTABLE_HETERO
(
mâ
) == 0);

165 
	`FTABLE_HETERO
(
mâ
èğ
Ãw_mâ
;

167 
Ãw_mâ
 = 
mâ
;

170 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
r
->
rm­s_li¡
, 
li¡
) {

171 
i
=0;i<
rms
->
size
;i++) {

172 
±
 = 
	`rme_±
(
rms
->
rm­s
[
i
]);

173 
±i
 = 
	`rme_±i
(
rms
->
rm­s
[
i
]);

174 ià(!
±
)

176 
j
=0;j<
max_ÿche
;j++) {

177 
l1_pg’Œy_t
 *
l1t
 = (l1_pg’Œy_ˆ*)
±
->
shadow
[
j
];

178 #ifdeà
DEBUG_ASSERT


181 
rm­_couÁ
++;

183 
l1t
[
±i
] = 
	`l1e_äom_pâ
(
Ãw_mâ
 , 
	`l1e_g‘_æags
(l1t[pti]));

190 ià(!
add
) {

191 
h‘”o_mâ
 = 
	`FTABLE_HETERO
(
mâ
);

192 
	`MYASSERT
(
h‘”o_mâ
 != 0);

193 
	`©omic_dec
(&
h‘”o_·ges_couÁ
);

194 
domaš
 *
vm
 = 
	`·ge_g‘_owÃr
(
	`__mâ_to_·ge
(
mâ
));

195 ià(
vm
) {

196 
vm_id
 = 
vm
->
domaš_id
;

197 ià(
vm_id
>=0 && vm_id < 
MAX_HETERO_VM
) {

198 
vm_tÙ_·ges
[
vm_id
] = 
vm
->
tÙ_·ges
;

199 
	`©omic_dec
(&
h‘”o_·ges_vm
[
vm_id
]);

201 
	`my´štk
("WARN deøšv®id vm_id:%d\n", 
vm_id
);

204 
	`my´štk
("WARN deønuÎ owÃr..mâ:%lx\n", 
mâ
);

207 
	`FTABLE_HETERO
(
mâ
) = 0;

209 *
p
;

210 
p
 = 
	`mâ_to_vœt
(
h‘”o_mâ
);

211 
	`memıy
(
	`mâ_to_vœt
(
mâ
), 
p
, 
PAGE_SIZE
);

212 
	`myä“_x’h—p_·ge
(
	`mâ_to_vœt
(
h‘”o_mâ
), 10);

214  
rm­_couÁ
;

215 
	}
}

219 
	#MAX_SCAN
 2048

220 
	#MAX_TEMP_MFNS
 1024

	)

221 
	#TIME_WINDOW
 3000

223 
	`sÿn_hÙ_·ges
(
s_time_t
 
now
, 
v»giÚ_t
 *
vr
, *
mâs
, *
æag
, *
mig¿‹
)

	)

225 #ifdeà
DEBUG_ASSERT


226 ià(!
¥š_is_locked
(&
vr
->
lock
))

227 
my·nic
("scan_hot_pages:grep vr->lock first!");

229 
	gäame_couÁ
 = 0;

230 *
	gmig¿‹
 = 0;

231 ià(
	gvr
->
	gh—d
 == -1)

233 
	g¡¬t
 = 
FTABLE_PREV
(
vr
->
h—d
);

234 
	gcur
 = 
¡¬t
;

236 
s_time_t
 
	gtime
;

237 
	g»t
 = 0;

238 
	#HETERO_PAGE_VM_LIMITS


	)

239 #ifdeà
HETERO_PAGE_VM_LIMITS


240 
	gw™hš_lim™
;

243 
	gäame_couÁ
++;

244 
	gtime
 = (()
FTABLE_TIME
(
cur
) << 20);

245 #ifdeà
HETERO_PAGE_VM_LIMITS


246 
	gw™hš_lim™
 = 
Ëss_thª_lim™
(
cur
);

249 ià(
	gtime
 + 
MILLISECS
(
TIME_WINDOW
è< 
	gnow
) {

250 
	gæag
[
»t
] = 0;

251 
	gmâs
[
»t
++] = 
cur
;

252 #ifdeà
ENABLE_HETERO


253 ià(
FTABLE_HETERO
(
cur
))

254 *
	gmig¿‹
 = 1;

257 #ifdeà
ENABLE_HETERO


259 ià(!
FTABLE_HETERO
(
cur
)) {

260 #ifdeà
HETERO_PAGE_VM_LIMITS


261 ià(
	gw™hš_lim™
 == 1) {

263 
æag
[
»t
] = 1;

264 
	gmâs
[
»t
++] = 
cur
;

265 *
	gmig¿‹
 = 1;

266 #ifdeà
HETERO_PAGE_VM_LIMITS


270 #ifdeà
HETERO_PAGE_VM_LIMITS


271 ià(
	gw™hš_lim™
 == 0) {

272 
æag
[
»t
] = 0;

273 
	gmâs
[
»t
++] = 
cur
;

274 *
	gmig¿‹
 = 1;

280 
	gcur
 = 
FTABLE_PREV
(
cur
);

281 ià(
	g»t
 >ğ
MAX_TEMP_MFNS
 || 
äame_couÁ
 >ğ
MAX_SCAN
) {

282 
vr
->
h—d
 = 
cur
;

285 } 
	gcur
 !ğ
¡¬t
);

288  
	g»t
;

291 
DEFINE_PER_CPU
([
MAX_TEMP_MFNS
], 
mâs_äom_hÙ_li¡
);

292 
DEFINE_PER_CPU
([
MAX_TEMP_MFNS
], 
æag_äom_hÙ_li¡
);

294 
	$shršk_hÙ_·ges
(
s_time_t
 
now
)

296 *
mâs
 = 
	`³r_ıu
(
mâs_äom_hÙ_li¡
, 
	`smp_´oûssÜ_id
());

297 *
æag
 = 
	`³r_ıu
(
æag_äom_hÙ_li¡
, 
	`smp_´oûssÜ_id
());

300 
i
, 
»t
, 
mig¿‹
;

301 #ifdeà
HETERO_PAGE_VM_LIMITS


302 
i
=0;i<
MAX_HETERO_VM
;i++) {

303 
h‘”o_·ges_vm_ex³ù
[
i
] = 0;

306 
	`my¥š_lock
(&
£ed_u£r_hÙ
->
lock
, 29);

307 
»t
 = 
	`sÿn_hÙ_·ges
(
now
, 
£ed_u£r_hÙ
, 
mâs
, 
æag
, &
mig¿‹
);

308 #ifdeà
ENABLE_HETERO


309 ià(
mig¿‹
)

311 #ifdeà
ENABLE_TIMESTAMP


312 
	`time¡amp_¡¬t
(
TIMESTAMP_PAGE_MIGRATE
);

314 #ifdeà
HETERO_SYNC1


315 
	`©omic_£t
(&
sim¶e_b¬r›r
, 
max_´oc
-1);

316 ià(!
	`my¥š_Œylock
(&
h‘”o_lock
, 34)) {

317 
	`my·nic
("TODO skip hetero() callo‡void deadlock..\n");

320 
	`smp_ÿÎ_funùiÚ
(
h‘”o_wa™
, 
NULL
, 0);

321 #ifdeà
HETERO_SYNC2


322 ;
	`©omic_»ad
(&
sim¶e_b¬r›r
););

326 
cİy_couÁ
 = 0;

327 
rm­_couÁ
 = 0;

328 
i
=0;i<
»t
;i++) {

329 ià(!
æag
[
i
]) {

330 ià(
	`FTABLE_HETERO
(
mâs
[
i
])) {

331 
rm­_couÁ
 +ğ
	`h‘”o
(
mâs
[
i
], 0);

332 
cİy_couÁ
++;

335 
	`MYASSERT
(
	`FTABLE_HETERO
(
mâs
[
i
]) == 0);

336 
rm­_couÁ
 +ğ
	`h‘”o
(
mâs
[
i
], 1);

337 
cİy_couÁ
++;

340 #ifdeà
HETERO_SYNC1


341 
	`¥š_uÆock
(&
h‘”o_lock
);

343 
	`æush_b_loÿl
();

346 #ifdeà
ENABLE_TIMESTAMP


347 
	`time¡amp
(
TIMESTAMP_PAGE_MIGRATE
, 1);

348 
	`time¡amp_’d
(
TIMESTAMP_PAGE_MIGRATE
, 2);

352 
	`¥š_uÆock
(&
£ed_u£r_hÙ
->
lock
);

353 
i
=0;i<
»t
;i++) {

354 #ifdeà
ENABLE_HETERO


355 ià(
æag
[
i
])

357 
	`MYASSERT
(
	`FTABLE_HETERO
(
mâs
[
i
])==0);

359 
	`v¹_£t
(
mâs
[
i
], 
NULL
, 
VRT_SET_LOCK_SYNC
);

361 
	`FTABLE_TIME
(
mâs
[
i
]) = 0;

362 
	`FTABLE_ABIT
(
mâs
[
i
]) = 0;

364 
	}
}

	@hpet.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/”ºo.h
>

9 
	~<x’/time.h
>

10 
	~<x’/tim”.h
>

11 
	~<x’/smp.h
>

12 
	~<x’/soáœq.h
>

13 
	~<x’/œq.h
>

14 
	~<asm/fixm­.h
>

15 
	~<asm/div64.h
>

16 
	~<asm/h³t.h
>

17 
	~<asm/msi.h
>

18 
	~<mach_­ic.h
>

19 
	~<x’/ıuidË.h
>

21 
	#MAX_DELTA_NS
 
	`MILLISECS
(10*1000)

	)

22 
	#MIN_DELTA_NS
 
	`MICROSECS
(20)

	)

24 
	#MAX_HPET_NUM
 32

	)

26 
	#HPET_EVT_USED_BIT
 0

	)

27 
	#HPET_EVT_USED
 (1 << 
HPET_EVT_USED_BIT
)

	)

28 
	#HPET_EVT_DISABLE_BIT
 1

	)

29 
	#HPET_EVT_DISABLE
 (1 << 
HPET_EVT_DISABLE_BIT
)

	)

31 
	sh³t_ev’t_chªÃl


33 
	mmuÉ
;

34 
	mshiá
;

35 
s_time_t
 
	mÃxt_ev’t
;

36 
ıumask_t
 
	mıumask
;

48 
rwlock_t
 
	mıumask_lock
;

49 
¥šlock_t
 
	mlock
;

50 (*
	mev’t_hªdËr
)(
	mh³t_ev’t_chªÃl
 *);

52 
	midx
;

53 
	mıu
;

54 
	mœq
;

55 
	mæags
;

56 } 
	g__ÿch–še_®igÃd
;

57 
h³t_ev’t_chªÃl
 
	gËgacy_h³t_ev’t
;

58 
h³t_ev’t_chªÃl
 
	gh³t_ev’ts
[
MAX_HPET_NUM
] =

59 { [0 ... 
MAX_HPET_NUM
-1].
œq
 = -1 };

60 
	gnum_h³ts_u£d
;

62 
DEFINE_PER_CPU
(
h³t_ev’t_chªÃl
 *, 
ıu_bc_chªÃl
);

64 *
	gœq_chªÃl
;

66 
	#œq_to_chªÃl
(
œq
è
œq_chªÃl
[œq]

	)

68 
	gh³t_add»ss
;

75 
boŞ_t
 
__»ad_mo¡ly
 
	gfÜû_h³t_brßdÿ¡
;

76 
boŞ—n_·¿m
("h³tbrßdÿ¡", 
fÜû_h³t_brßdÿ¡
);

89 
šlše
 
	$div_sc
(
ticks
, 
n£c
,

90 
shiá
)

92 
ušt64_t
 
tmp
 = ((ušt64_t)
ticks
è<< 
shiá
;

94 
	`do_div
(
tmp
, 
n£c
);

95  (è
tmp
;

96 
	}
}

103 
šlše
 
	$ns2ticks
(
n£c
, 
shiá
,

104 
çùÜ
)

106 
ušt64_t
 
tmp
 = ((ušt64_t)
n£c
 * 
çùÜ
è>> 
shiá
;

108  (è
tmp
;

109 
	}
}

111 
	$h³t_Ãxt_ev’t
(
d–
, 
tim”
)

113 
ušt32_t
 
út
, 
cmp
;

114 
æags
;

116 
	`loÿl_œq_§ve
(
æags
);

117 
út
 = 
	`h³t_»ad32
(
HPET_COUNTER
);

118 
cmp
 = 
út
 + 
d–
;

119 
	`h³t_wr™e32
(
cmp
, 
	`HPET_Tn_CMP
(
tim”
));

120 
cmp
 = 
	`h³t_»ad32
(
HPET_COUNTER
);

121 
	`loÿl_œq_»¡Üe
(
æags
);

124  ((
cmp
 + 2 - 
út
è> 
d–
è? -
ETIME
 : 0;

125 
	}
}

127 
	$»´og¿m_h³t_evt_chªÃl
(

128 
h³t_ev’t_chªÃl
 *
ch
,

129 
s_time_t
 
expœe
, s_time_ˆ
now
, 
fÜû
)

131 
št64_t
 
d–
;

132 
»t
;

134 iàĞ(
ch
->
æags
 & 
HPET_EVT_DISABLE
è|| (
expœe
 == 0) )

137 iàĞ
	`uÆik–y
(
expœe
 < 0) )

139 
	`´štk
(
KERN_DEBUG
 "reprogram:ƒxpire <= 0\n");

140  -
ETIME
;

143 
d–
 = 
expœe
 - 
now
;

144 iàĞ(
d–
 <ğ0è&& !
fÜû
 )

145  -
ETIME
;

147 
ch
->
Ãxt_ev’t
 = 
expœe
;

149 iàĞ
expœe
 =ğ
STIME_MAX
 )

152 
	`h³t_wr™e32
(0, 
	`HPET_Tn_CMP
(
ch
->
idx
));

156 
d–
 = 
	`mš_t
(
št64_t
, d–, 
MAX_DELTA_NS
);

157 
d–
 = 
	`max_t
(
št64_t
, d–, 
MIN_DELTA_NS
);

158 
d–
 = 
	`ns2ticks
(d–, 
ch
->
shiá
, ch->
muÉ
);

160 
»t
 = 
	`h³t_Ãxt_ev’t
(
d–
, 
ch
->
idx
);

161  
»t
 && 
fÜû
 )

163 
d–
 += delta;

164 
»t
 = 
	`h³t_Ãxt_ev’t
(
d–
, 
ch
->
idx
);

167  
»t
;

168 
	}
}

170 
	$evt_do_brßdÿ¡
(
ıumask_t
 
mask
)

172 
»t
 = 0, 
ıu
 = 
	`smp_´oûssÜ_id
();

174 iàĞ
	`ıu_is£t
(
ıu
, 
mask
) )

176 
	`ıu_ş—r
(
ıu
, 
mask
);

177 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

178 
»t
 = 1;

181 
	`ıuidË_wakeup_mwa™
(&
mask
);

183 iàĞ!
	`ıus_em±y
(
mask
) )

185 
	`ıumask_¿i£_soáœq
(
mask
, 
TIMER_SOFTIRQ
);

186 
»t
 = 1;

188  
»t
;

189 
	}
}

191 
	$hªdË_h³t_brßdÿ¡
(
h³t_ev’t_chªÃl
 *
ch
)

193 
ıumask_t
 
mask
;

194 
s_time_t
 
now
, 
Ãxt_ev’t
;

195 
ıu
;

197 
	`¥š_lock_œq
(&
ch
->
lock
);

199 
agaš
:

200 
ch
->
Ãxt_ev’t
 = 
STIME_MAX
;

202 
	`¥š_uÆock_œq
(&
ch
->
lock
);

204 
Ãxt_ev’t
 = 
STIME_MAX
;

205 
mask
 = (
ıumask_t
)
CPU_MASK_NONE
;

206 
now
 = 
	`NOW
();

209 
	`fÜ_—ch_ıu_mask
(
ıu
, 
ch
->
ıumask
)

211 
	`wr™e_lock_œq
(&
ch
->
ıumask_lock
);

213 iàĞ
	`ıu_is£t
(
ıu
, 
ch
->
ıumask
) )

215 iàĞ
	`³r_ıu
(
tim”_d—dlše
, 
ıu
è<ğ
now
 )

216 
	`ıu_£t
(
ıu
, 
mask
);

217 iàĞ
	`³r_ıu
(
tim”_d—dlše
, 
ıu
è< 
Ãxt_ev’t
 )

218 
Ãxt_ev’t
 = 
	`³r_ıu
(
tim”_d—dlše
, 
ıu
);

221 
	`wr™e_uÆock_œq
(&
ch
->
ıumask_lock
);

225 
	`evt_do_brßdÿ¡
(
mask
);

227 iàĞ
Ãxt_ev’t
 !ğ
STIME_MAX
 )

229 
	`¥š_lock_œq
(&
ch
->
lock
);

231 iàĞ
Ãxt_ev’t
 < 
ch
->next_event &&

232 
	`»´og¿m_h³t_evt_chªÃl
(
ch
, 
Ãxt_ev’t
, 
now
, 0) )

233 
agaš
;

235 
	`¥š_uÆock_œq
(&
ch
->
lock
);

237 
	}
}

239 
	$h³t_š‹¼u±_hªdËr
(
œq
, *
d©a
,

240 
ıu_u£r_»gs
 *
»gs
)

242 
h³t_ev’t_chªÃl
 *
ch
 = (h³t_ev’t_chªÃÈ*)
d©a
;

244 
	`this_ıu
(
œq_couÁ
)--;

246 iàĞ!
ch
->
ev’t_hªdËr
 )

248 
	`´štk
(
XENLOG_WARNING
 "Spuriou HPETim” iÁ”ru± oÀHPETim” %d\n", 
ch
->
idx
);

252 
ch
->
	`ev’t_hªdËr
(ch);

253 
	}
}

255 
	$h³t_msi_unmask
(
œq
)

257 
cfg
;

258 
ch_idx
 = 
	`œq_to_chªÃl
(
œq
);

259 
h³t_ev’t_chªÃl
 *
ch
;

261 
	`BUG_ON
(
ch_idx
 < 0);

262 
ch
 = &
h³t_ev’ts
[
ch_idx
];

264 
cfg
 = 
	`h³t_»ad32
(
	`HPET_Tn_CFG
(
ch
->
idx
));

265 
cfg
 |ğ
HPET_TN_FSB
;

266 
	`h³t_wr™e32
(
cfg
, 
	`HPET_Tn_CFG
(
ch
->
idx
));

267 
	}
}

269 
	$h³t_msi_mask
(
œq
)

271 
cfg
;

272 
ch_idx
 = 
	`œq_to_chªÃl
(
œq
);

273 
h³t_ev’t_chªÃl
 *
ch
;

275 
	`BUG_ON
(
ch_idx
 < 0);

276 
ch
 = &
h³t_ev’ts
[
ch_idx
];

278 
cfg
 = 
	`h³t_»ad32
(
	`HPET_Tn_CFG
(
ch
->
idx
));

279 
cfg
 &ğ~
HPET_TN_FSB
;

280 
	`h³t_wr™e32
(
cfg
, 
	`HPET_Tn_CFG
(
ch
->
idx
));

281 
	}
}

283 
	$h³t_msi_wr™e
(
œq
, 
msi_msg
 *
msg
)

285 
ch_idx
 = 
	`œq_to_chªÃl
(
œq
);

286 
h³t_ev’t_chªÃl
 *
ch
;

288 
	`BUG_ON
(
ch_idx
 < 0);

289 
ch
 = &
h³t_ev’ts
[
ch_idx
];

291 
	`h³t_wr™e32
(
msg
->
d©a
, 
	`HPET_Tn_ROUTE
(
ch
->
idx
));

292 
	`h³t_wr™e32
(
msg
->
add»ss_lo
, 
	`HPET_Tn_ROUTE
(
ch
->
idx
) + 4);

293 
	}
}

295 
	$h³t_msi_»ad
(
œq
, 
msi_msg
 *
msg
)

297 
ch_idx
 = 
	`œq_to_chªÃl
(
œq
);

298 
h³t_ev’t_chªÃl
 *
ch
;

300 
	`BUG_ON
(
ch_idx
 < 0);

301 
ch
 = &
h³t_ev’ts
[
ch_idx
];

303 
msg
->
d©a
 = 
	`h³t_»ad32
(
	`HPET_Tn_ROUTE
(
ch
->
idx
));

304 
msg
->
add»ss_lo
 = 
	`h³t_»ad32
(
	`HPET_Tn_ROUTE
(
ch
->
idx
) + 4);

305 
msg
->
add»ss_hi
 = 0;

306 
	}
}

308 
	$h³t_msi_¡¬tup
(
œq
)

310 
	`h³t_msi_unmask
(
œq
);

312 
	}
}

314 
	$h³t_msi_shutdown
(
œq
)

316 
	`h³t_msi_mask
(
œq
);

317 
	}
}

319 
	$h³t_msi_ack
(
œq
)

321 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

323 
	`œq_com¶‘e_move
(&
desc
);

324 
	`move_Çtive_œq
(
œq
);

325 
	`ack_APIC_œq
();

326 
	}
}

328 
	$h³t_msi_’d
(
œq
)

330 
	}
}

332 
	$h³t_msi_£t_affš™y
(
œq
, 
ıumask_t
 
mask
)

334 
msi_msg
 
msg
;

335 
de¡
;

336 
œq_desc
 * 
desc
 = 
	`œq_to_desc
(
œq
);

337 
œq_cfg
 *
cfg
ğ
desc
->
ch_d©a
;

339 
de¡
 = 
	`£t_desc_affš™y
(
desc
, &
mask
);

340 ià(
de¡
 =ğ
BAD_APICID
)

343 
	`h³t_msi_»ad
(
œq
, &
msg
);

344 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

345 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

346 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

347 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

348 
	`h³t_msi_wr™e
(
œq
, &
msg
);

349 
	}
}

354 
hw_œq_cÚŒŞËr
 
	gh³t_msi_ty³
 = {

355 .
ty³Çme
 = "HPET-MSI",

356 .
	g¡¬tup
 = 
h³t_msi_¡¬tup
,

357 .
	gshutdown
 = 
h³t_msi_shutdown
,

358 .
	g’abË
 = 
h³t_msi_unmask
,

359 .
	gdi§bË
 = 
h³t_msi_mask
,

360 .
	gack
 = 
h³t_msi_ack
,

361 .
	g’d
 = 
h³t_msi_’d
,

362 .
	g£t_affš™y
 = 
h³t_msi_£t_affš™y
,

365 
	$h³t_£tup_msi_œq
(
œq
)

367 
»t
;

368 
msi_msg
 
msg
;

369 
h³t_ev’t_chªÃl
 *
ch
 = &
h³t_ev’ts
[
	`œq_to_chªÃl
(
œq
)];

370 
œq_desc_t
 *
desc
 = 
	`œq_to_desc
(
œq
);

372 iàĞ
desc
->
hªdËr
 =ğ&
no_œq_ty³
 )

374 
desc
->
hªdËr
 = &
h³t_msi_ty³
;

375 
»t
 = 
	`»que¡_œq
(
œq
, 
h³t_š‹¼u±_hªdËr
,

376 0, "HPET", 
ch
);

377 iàĞ
»t
 < 0 )

378  
»t
;

380 iàĞ
desc
->
hªdËr
 !ğ&
h³t_msi_ty³
 )

382  -
EINVAL
;

385 
	`msi_compo£_msg
(
NULL
, 
œq
, &
msg
);

386 
	`h³t_msi_wr™e
(
œq
, &
msg
);

389 
	}
}

391 
	$h³t_assign_œq
(
h³t_ev’t_chªÃl
 *
ch
)

393 
œq
 = 
ch
->irq;

395 iàĞ
œq
 < 0 )

397 iàĞ(
œq
 = 
	`ü—‹_œq
()) < 0 )

398  
œq
;

400 
œq_chªÃl
[
œq
] = 
ch
 - &
h³t_ev’ts
[0];

401 
ch
->
œq
 = irq;

405 iàĞ
	`h³t_£tup_msi_œq
(
œq
) )

407 
	`de¡roy_œq
(
œq
);

408 
œq_chªÃl
[
œq
] = -1;

409 
ch
->
œq
 = -1;

410  -
EINVAL
;

414 
	}
}

416 
	$h³t_fsb_ÿp_lookup
()

418 
id
;

419 
num_chs
, 
num_chs_u£d
;

420 
i
;

423 iàĞ
iommu_šŒem­
 )

425 
	`´štk
(
XENLOG_INFO
 "HPET's MSI mode hasn't been supported when "

430 
id
 = 
	`h³t_»ad32
(
HPET_ID
);

432 
num_chs
 = ((
id
 & 
HPET_ID_NUMBER
è>> 
HPET_ID_NUMBER_SHIFT
);

433 
num_chs
++;

435 
num_chs_u£d
 = 0;

436  
i
 = 0; i < 
num_chs
; i++ )

438 
h³t_ev’t_chªÃl
 *
ch
 = &
h³t_ev’ts
[
num_chs_u£d
];

439 
cfg
 = 
	`h³t_»ad32
(
	`HPET_Tn_CFG
(
i
));

442 iàĞ!(
cfg
 & 
HPET_TN_FSB_CAP
) )

445 
ch
->
æags
 = 0;

446 
ch
->
idx
 = 
i
;

448 iàĞ
	`h³t_assign_œq
(
ch
) )

451 
num_chs_u£d
++;

454 
	`´štk
(
XENLOG_INFO


456 
num_chs
, 
num_chs_u£d
);

458  
num_chs_u£d
;

459 
	}
}

461 
	gÃxt_chªÃl
;

462 
¥šlock_t
 
	gÃxt_lock
 = 
SPIN_LOCK_UNLOCKED
;

464 
h³t_ev’t_chªÃl
 *
	$h³t_g‘_chªÃl
(
ıu
)

466 
i
;

467 
Ãxt
;

468 
h³t_ev’t_chªÃl
 *
ch
;

470 iàĞ
num_h³ts_u£d
 == 0 )

471  &
Ëgacy_h³t_ev’t
;

473 
	`¥š_lock
(&
Ãxt_lock
);

474 
Ãxt
 = 
Ãxt_chªÃl
 = (Ãxt_chªÃÈ+ 1è% 
num_h³ts_u£d
;

475 
	`¥š_uÆock
(&
Ãxt_lock
);

478  
i
 = 
Ãxt
; i <‚exˆ+ 
num_h³ts_u£d
; i++ )

480 
ch
 = &
h³t_ev’ts
[
i
 % 
num_h³ts_u£d
];

481 iàĞ!
	`‹¡_ªd_£t_b™
(
HPET_EVT_USED_BIT
, &
ch
->
æags
) )

483 
ch
->
ıu
 = cpu;

484  
ch
;

489 
ch
 = &
h³t_ev’ts
[
Ãxt
];

490 iàĞ!
	`‹¡_ªd_£t_b™
(
HPET_EVT_USED_BIT
, &
ch
->
æags
) )

491 
ch
->
ıu
 = cpu;

493  
ch
;

494 
	}
}

496 
	$h³t_©ch_chªÃl
(
ıu
, 
h³t_ev’t_chªÃl
 *
ch
)

498 
	`ASSERT
(
	`¥š_is_locked
(&
ch
->
lock
));

500 
	`³r_ıu
(
ıu_bc_chªÃl
, 
ıu
èğ
ch
;

503 iàĞ!
	`‹¡_ªd_£t_b™
(
HPET_EVT_USED_BIT
, &
ch
->
æags
) )

504 
ch
->
ıu
 = cpu;

506 iàĞ
ch
->
ıu
 != cpu )

510 
œq_desc
[
ch
->
œq
].
hªdËr
->

511 
	`£t_affš™y
(
ch
->
œq
, 
	`ıumask_of_ıu
(ch->
ıu
));

512 
	}
}

514 
	$h³t_d‘ach_chªÃl
(
ıu
, 
h³t_ev’t_chªÃl
 *
ch
)

516 
	`ASSERT
(
	`¥š_is_locked
(&
ch
->
lock
));

517 
	`ASSERT
(
ch
 =ğ
	`³r_ıu
(
ıu_bc_chªÃl
, 
ıu
));

519 
	`³r_ıu
(
ıu_bc_chªÃl
, 
ıu
èğ
NULL
;

521 iàĞ
ıu
 !ğ
ch
->cpu )

524 iàĞ
	`ıus_em±y
(
ch
->
ıumask
) )

526 
ch
->
ıu
 = -1;

527 
	`ş—r_b™
(
HPET_EVT_USED_BIT
, &
ch
->
æags
);

531 
ch
->
ıu
 = 
	`fœ¡_ıu
(ch->
ıumask
);

533 
œq_desc
[
ch
->
œq
].
hªdËr
->

534 
	`£t_affš™y
(
ch
->
œq
, 
	`ıumask_of_ıu
(ch->
ıu
));

535 
	}
}

537 
	~<asm/mc146818¹c.h
>

539 (*
pv_¹c_hªdËr
)(
pÜt
, 
ušt8_t
 
v®ue
);

541 
	$hªdË_¹c_Úû
(
pÜt
, 
ušt8_t
 
v®ue
)

543 
šdex
;

545 iàĞ
pÜt
 == 0x70 )

547 
šdex
 = 
v®ue
;

551 iàĞ
šdex
 !ğ
RTC_REG_B
 )

555 iàĞ
v®ue
 & (
RTC_PIE
 | 
RTC_AIE
 | 
RTC_UIE
 ) )

557 
	`ıuidË_di§bË_d“p_c¡©e
();

558 
pv_¹c_hªdËr
 = 
NULL
;

560 
	}
}

562 
	$h³t_brßdÿ¡_š™
()

564 
u64
 
h³t_¿‹
;

565 
u32
 
h³t_id
, 
cfg
;

566 
i
;

568 iàĞ
œq_chªÃl
 =ğ
NULL
 )

570 
œq_chªÃl
 = 
	`xm®loc_¬¿y
(, 
Ä_œqs
);

571 
	`BUG_ON
(
œq_chªÃl
 =ğ
NULL
);

572  
i
 = 0; i < 
Ä_œqs
; i++ )

573 
œq_chªÃl
[
i
] = -1;

576 
h³t_¿‹
 = 
	`h³t_£tup
();

577 iàĞ
h³t_¿‹
 == 0 )

580 
num_h³ts_u£d
 = 
	`h³t_fsb_ÿp_lookup
();

581 iàĞ
num_h³ts_u£d
 > 0 )

584 
cfg
 = 
	`h³t_»ad32
(
HPET_CFG
);

585 
cfg
 &ğ~
HPET_CFG_LEGACY
;

586 
	`h³t_wr™e32
(
cfg
, 
HPET_CFG
);

588  
i
 = 0; i < 
num_h³ts_u£d
; i++ )

591 
cfg
 = 
	`h³t_»ad32
(
	`HPET_Tn_CFG
(
h³t_ev’ts
[
i
].
idx
));

592 
cfg
 &ğ~
HPET_TN_PERIODIC
;

593 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

594 
	`h³t_wr™e32
(
cfg
, 
	`HPET_Tn_CFG
(
h³t_ev’ts
[
i
].
idx
));

596 
h³t_ev’ts
[
i
].
muÉ
 = 
	`div_sc
(()
h³t_¿‹
,

598 
h³t_ev’ts
[
i
].
shiá
 = 32;

599 
h³t_ev’ts
[
i
].
Ãxt_ev’t
 = 
STIME_MAX
;

600 
	`¥š_lock_š™
(&
h³t_ev’ts
[
i
].
lock
);

601 
	`rwlock_š™
(&
h³t_ev’ts
[
i
].
ıumask_lock
);

602 
	`wmb
();

603 
h³t_ev’ts
[
i
].
ev’t_hªdËr
 = 
hªdË_h³t_brßdÿ¡
;

609 iàĞ
Ëgacy_h³t_ev’t
.
æags
 & 
HPET_EVT_DISABLE
 )

612 
h³t_id
 = 
	`h³t_»ad32
(
HPET_ID
);

613 iàĞ!(
h³t_id
 & 
HPET_ID_LEGSUP
) )

617 
cfg
 = 
	`h³t_»ad32
(
HPET_CFG
);

618 
cfg
 |ğ
HPET_CFG_LEGACY
;

619 
	`h³t_wr™e32
(
cfg
, 
HPET_CFG
);

622 
cfg
 = 
	`h³t_»ad32
(
HPET_T0_CFG
);

623 
cfg
 &ğ~
HPET_TN_PERIODIC
;

624 
cfg
 |ğ
HPET_TN_ENABLE
 | 
HPET_TN_32BIT
;

625 
	`h³t_wr™e32
(
cfg
, 
HPET_T0_CFG
);

631 
Ëgacy_h³t_ev’t
.
muÉ
 = 
	`div_sc
(()
h³t_¿‹
, 1000000000ul, 32);

632 
Ëgacy_h³t_ev’t
.
shiá
 = 32;

633 
Ëgacy_h³t_ev’t
.
Ãxt_ev’t
 = 
STIME_MAX
;

634 
Ëgacy_h³t_ev’t
.
idx
 = 0;

635 
Ëgacy_h³t_ev’t
.
æags
 = 0;

636 
	`¥š_lock_š™
(&
Ëgacy_h³t_ev’t
.
lock
);

637 
	`rwlock_š™
(&
Ëgacy_h³t_ev’t
.
ıumask_lock
);

638 
	`wmb
();

639 
Ëgacy_h³t_ev’t
.
ev’t_hªdËr
 = 
hªdË_h³t_brßdÿ¡
;

641 iàĞ!
fÜû_h³t_brßdÿ¡
 )

642 
pv_¹c_hªdËr
 = 
hªdË_¹c_Úû
;

643 
	}
}

645 
	$h³t_di§bË_Ëgacy_brßdÿ¡
()

647 
u32
 
cfg
;

648 
æags
;

650 iàĞ!
Ëgacy_h³t_ev’t
.
shiá
 )

653 
	`¥š_lock_œq§ve
(&
Ëgacy_h³t_ev’t
.
lock
, 
æags
);

655 
Ëgacy_h³t_ev’t
.
æags
 |ğ
HPET_EVT_DISABLE
;

658 
cfg
 = 
	`h³t_»ad32
(
HPET_T0_CFG
);

659 
cfg
 &ğ~
HPET_TN_ENABLE
;

660 
	`h³t_wr™e32
(
cfg
, 
HPET_T0_CFG
);

663 
cfg
 = 
	`h³t_»ad32
(
HPET_CFG
);

664 
cfg
 &ğ~
HPET_CFG_LEGACY
;

665 
	`h³t_wr™e32
(
cfg
, 
HPET_CFG
);

667 
	`¥š_uÆock_œq»¡Üe
(&
Ëgacy_h³t_ev’t
.
lock
, 
æags
);

669 
	`smp_£nd_ev’t_check_mask
(&
ıu_Úlše_m­
);

670 
	}
}

672 
	$h³t_brßdÿ¡_’‹r
()

674 
ıu
 = 
	`smp_´oûssÜ_id
();

675 
h³t_ev’t_chªÃl
 *
ch
 = 
	`³r_ıu
(
ıu_bc_chªÃl
, 
ıu
);

677 iàĞ
	`this_ıu
(
tim”_d—dlše
) == 0 )

680 iàĞ!
ch
 )

681 
ch
 = 
	`h³t_g‘_chªÃl
(
ıu
);

683 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

685 iàĞ
ch
 !ğ&
Ëgacy_h³t_ev’t
 )

687 
	`¥š_lock
(&
ch
->
lock
);

688 
	`h³t_©ch_chªÃl
(
ıu
, 
ch
);

689 
	`¥š_uÆock
(&
ch
->
lock
);

693 
	`di§bË_APIC_tim”
();

694 
	`ıu_£t
(
ıu
, 
ch
->
ıumask
);

696 
	`¥š_lock
(&
ch
->
lock
);

698 iàĞ
	`this_ıu
(
tim”_d—dlše
è< 
ch
->
Ãxt_ev’t
 )

699 
	`»´og¿m_h³t_evt_chªÃl
(
ch
, 
	`this_ıu
(
tim”_d—dlše
), 
	`NOW
(), 1);

700 
	`¥š_uÆock
(&
ch
->
lock
);

701 
	}
}

703 
	$h³t_brßdÿ¡_ex™
()

705 
ıu
 = 
	`smp_´oûssÜ_id
();

706 
h³t_ev’t_chªÃl
 *
ch
 = 
	`³r_ıu
(
ıu_bc_chªÃl
, 
ıu
);

708 iàĞ
	`this_ıu
(
tim”_d—dlše
) == 0 )

711 iàĞ!
ch
 )

712 
ch
 = 
	`h³t_g‘_chªÃl
(
ıu
);

715 
	`’abË_APIC_tim”
();

716 iàĞ!
	`»´og¿m_tim”
(
	`this_ıu
(
tim”_d—dlše
)) )

717 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

719 
	`»ad_lock_œq
(&
ch
->
ıumask_lock
);

720 
	`ıu_ş—r
(
ıu
, 
ch
->
ıumask
);

721 
	`»ad_uÆock_œq
(&
ch
->
ıumask_lock
);

723 iàĞ
ch
 !ğ&
Ëgacy_h³t_ev’t
 )

725 
	`¥š_lock_œq
(&
ch
->
lock
);

726 
	`h³t_d‘ach_chªÃl
(
ıu
, 
ch
);

727 
	`¥š_uÆock_œq
(&
ch
->
lock
);

729 
	}
}

731 
	$h³t_brßdÿ¡_is_avaabË
()

733  (
Ëgacy_h³t_ev’t
.
ev’t_hªdËr
 =ğ
hªdË_h³t_brßdÿ¡


734 || 
num_h³ts_u£d
 > 0);

735 
	}
}

737 
	$h³t_Ëgacy_œq_tick
()

739 
	`this_ıu
(
œq_couÁ
)--;

741 iàĞ!
Ëgacy_h³t_ev’t
.
ev’t_hªdËr
 )

743 
Ëgacy_h³t_ev’t
.
	`ev’t_hªdËr
(&legacy_hpet_event);

745 
	}
}

747 
u64
 
	$h³t_£tup
()

749 
u64
 
h³t_¿‹
;

750 
u32
 
sy¡em_»£t_Ïtch
;

751 
u32
 
h³t_id
, 
h³t_³riod
, 
cfg
;

752 
i
;

754 iàĞ
sy¡em_»£t_Ïtch
 =ğ
sy¡em_»£t_couÁ”
 )

755  
h³t_¿‹
;

756 
sy¡em_»£t_Ïtch
 = 
sy¡em_»£t_couÁ”
;

758 iàĞ
h³t_add»ss
 == 0 )

761 
	`£t_fixm­_noÿche
(
FIX_HPET_BASE
, 
h³t_add»ss
);

763 
h³t_id
 = 
	`h³t_»ad32
(
HPET_ID
);

764 iàĞ(
h³t_id
 & 
HPET_ID_REV
) == 0 )

766 
	`´štk
("BAD HPET„evision id.\n");

771 
h³t_³riod
 = 
	`h³t_»ad32
(
HPET_PERIOD
);

772 iàĞ(
h³t_³riod
 > 100000000) || (hpet_period < 100000) )

774 
	`´štk
("BAD HPET…”iod %u.\n", 
h³t_³riod
);

778 
cfg
 = 
	`h³t_»ad32
(
HPET_CFG
);

779 
cfg
 &ğ~(
HPET_CFG_ENABLE
 | 
HPET_CFG_LEGACY
);

780 
	`h³t_wr™e32
(
cfg
, 
HPET_CFG
);

782  
i
 = 0; i <ğ((
h³t_id
 >> 8) & 31); i++ )

784 
cfg
 = 
	`h³t_»ad32
(
	`HPET_Tn_CFG
(
i
));

785 
cfg
 &ğ~
HPET_TN_ENABLE
;

786 
	`h³t_wr™e32
(
cfg
, 
	`HPET_Tn_CFG
(
i
));

789 
cfg
 = 
	`h³t_»ad32
(
HPET_CFG
);

790 
cfg
 |ğ
HPET_CFG_ENABLE
;

791 
	`h³t_wr™e32
(
cfg
, 
HPET_CFG
);

793 
h³t_¿‹
 = 1000000000000000ULL;

794 ()
	`do_div
(
h³t_¿‹
, 
h³t_³riod
);

796  
h³t_¿‹
;

797 
	}
}

	@hvm/asid.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/š™.h
>

22 
	~<x’/lib.h
>

23 
	~<x’/sched.h
>

24 
	~<x’/smp.h
>

25 
	~<x’/³rıu.h
>

26 
	~<asm/hvm/asid.h
>

50 
	shvm_asid_d©a
 {

51 
u64
 
	mcÜe_asid_g’”©iÚ
;

52 
u32
 
	mÃxt_asid
;

53 
u32
 
	mmax_asid
;

54 
boŞ_t
 
	mdi§bËd
;

57 
DEFINE_PER_CPU
(
hvm_asid_d©a
, hvm_asid_data);

59 
	$hvm_asid_š™
(
Çsids
)

61 
s8
 
g_di§bËd
 = -1;

62 
hvm_asid_d©a
 *
d©a
 = &
	`this_ıu
(hvm_asid_data);

64 
d©a
->
max_asid
 = 
Çsids
 - 1;

65 
d©a
->
di§bËd
 = (
Çsids
 <= 1);

67 iàĞ
g_di§bËd
 !ğ
d©a
->
di§bËd
 )

69 
	`´štk
("HVM: ASID %§bËd.\n", 
d©a
->
di§bËd
 ? "dis" : "en");

70 iàĞ
g_di§bËd
 < 0 )

71 
g_di§bËd
 = 
d©a
->
di§bËd
;

75 
d©a
->
cÜe_asid_g’”©iÚ
 = 1;

78 
d©a
->
Ãxt_asid
 = 1;

79 
	}
}

81 
	$hvm_asid_æush_vıu
(
vıu
 *
v
)

83 
v
->
¬ch
.
hvm_vıu
.
asid_g’”©iÚ
 = 0;

84 
	}
}

86 
	$hvm_asid_æush_cÜe
()

88 
hvm_asid_d©a
 *
d©a
 = &
	`this_ıu
(hvm_asid_data);

90 iàĞ
d©a
->
di§bËd
 )

93 iàĞ
	`lik–y
(++
d©a
->
cÜe_asid_g’”©iÚ
 != 0) )

101 
	`´štk
("HVM: ASID generation overrun. Disabling ASIDs.\n");

102 
d©a
->
di§bËd
 = 1;

103 
	}
}

105 
boŞ_t
 
	$hvm_asid_hªdË_vm’‹r
()

107 
vıu
 *
cu¼
 = 
cu¼’t
;

108 
hvm_asid_d©a
 *
d©a
 = &
	`this_ıu
(hvm_asid_data);

112 iàĞ
d©a
->
di§bËd
 )

113 
di§bËd
;

116 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
asid_g’”©iÚ
 =ğ
d©a
->
cÜe_asid_g’”©iÚ
 )

120 iàĞ
	`uÆik–y
(
d©a
->
Ãxt_asid
 > d©a->
max_asid
) )

122 
	`hvm_asid_æush_cÜe
();

123 
d©a
->
Ãxt_asid
 = 1;

124 iàĞ
d©a
->
di§bËd
 )

125 
di§bËd
;

129 
cu¼
->
¬ch
.
hvm_vıu
.
asid
 = 
d©a
->
Ãxt_asid
++;

130 
cu¼
->
¬ch
.
hvm_vıu
.
asid_g’”©iÚ
 = 
d©a
->
cÜe_asid_g’”©iÚ
;

136  (
cu¼
->
¬ch
.
hvm_vıu
.
asid
 == 1);

138 
di§bËd
:

139 
cu¼
->
¬ch
.
hvm_vıu
.
asid
 = 0;

141 
	}
}

	@hvm/emulate.c

12 
	~<x’/cÚfig.h
>

13 
	~<x’/š™.h
>

14 
	~<x’/lib.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/·gšg.h
>

17 
	~<x’/Œaû.h
>

18 
	~<asm/ev’t.h
>

19 
	~<asm/hvm/emuÏ‹.h
>

20 
	~<asm/hvm/hvm.h
>

21 
	~<asm/hvm/Œaû.h
>

22 
	~<asm/hvm/suµÜt.h
>

24 
	$hvmŒaû_io_assi¡
(
is_mmio
, 
iÜeq_t
 *
p
)

26 
size
, 
ev’t
;

27 
bufãr
[12];

29 iàĞ
	`lik–y
(!
tb_š™_dÚe
) )

32 iàĞ
is_mmio
 )

33 
ev’t
 = 
p
->
dœ
 ? 
TRC_HVM_IOMEM_READ
 : 
TRC_HVM_IOMEM_WRITE
;

35 
ev’t
 = 
p
->
dœ
 ? 
TRC_HVM_IOPORT_READ
 : 
TRC_HVM_IOPORT_WRITE
;

37 *(
ušt64_t
 *)
bufãr
 = 
p
->
addr
;

38 
size
 = (
p
->
addr
 !ğ(
u32
)p->addr) ? 8 : 4;

39 iàĞ
size
 == 8 )

40 
ev’t
 |ğ
TRC_64_FLAG
;

42 iàĞ!
p
->
d©a_is_±r
 )

44 *(
ušt32_t
 *)&
bufãr
[
size
] = 
p
->
d©a
;

45 
size
 += 4;

48 
	`Œaû_v¬
(
ev’t
, 0 , 
size
, 
bufãr
);

49 
	}
}

51 
	$hvmemul_do_io
(

52 
is_mmio
, 
·ddr_t
 
addr
, *
»ps
, 
size
,

53 
·ddr_t
 
¿m_g·
, 
dœ
, 
df
, *
p_d©a
)

55 
·ddr_t
 
v®ue
 = 
¿m_g·
;

56 
v®ue_is_±r
 = (
p_d©a
 =ğ
NULL
);

57 
vıu
 *
cu¼
 = 
cu¼’t
;

58 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼
->
domaš
);

59 
iÜeq_t
 *
p
 = 
	`g‘_iÜeq
(
cu¼
);

60 
¿m_gâ
 = 
	`·ddr_to_pâ
(
¿m_g·
);

61 
p2m_ty³_t
 
p2mt
;

62 
mâ_t
 
¿m_mâ
;

63 
rc
;

66 
¿m_mâ
 = 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
¿m_gâ
, &
p2mt
, 0);

67 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

69 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
¿m_gâ
);

70  
X86EMUL_RETRY
;

72 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

73  
X86EMUL_RETRY
;

79 iàĞ
	`uÆik–y
((
size
 > ()) || (size & (size - 1))) )

81 
	`gd´štk
(
XENLOG_WARNING
, "bad mmiØsiz%d\n", 
size
);

82 
	`ASSERT
(
p_d©a
 !ğ
NULL
);

83 iàĞ
dœ
 =ğ
IOREQ_READ
 )

84 
	`mem£t
(
p_d©a
, ~0, 
size
);

85  
X86EMUL_UNHANDLEABLE
;

88 iàĞ(
p_d©a
 !ğ
NULL
è&& (
dœ
 =ğ
IOREQ_WRITE
) )

90 
	`memıy
(&
v®ue
, 
p_d©a
, 
size
);

91 
p_d©a
 = 
NULL
;

94 iàĞ
is_mmio
 && !
v®ue_is_±r
 )

97 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

99 
·ddr_t
 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_·
;

100 
by‹s
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_by‹s
;

101 iàĞ(
addr
 >ğ
·
è&& (×dd¸+ 
size
è<ğÕ¨+ 
by‹s
)) )

102  
X86EMUL_OKAY
;

106 
·ddr_t
 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_·
;

107 
by‹s
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_by‹s
;

108 iàĞ(
addr
 >ğ
·
è&& (×dd¸+ 
size
è<ğÕ¨+ 
by‹s
)) )

110 
	`memıy
(
p_d©a
, &
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad
[
addr
 - 
·
],

111 
size
);

112  
X86EMUL_OKAY
;

117  
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 )

119 
HVMIO_nÚe
:

121 
HVMIO_com¶‘ed
:

122 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_nÚe
;

123 iàĞ
p_d©a
 =ğ
NULL
 )

124  
X86EMUL_UNHANDLEABLE
;

125 
fšish_acûss
;

126 
HVMIO_di¥©ched
:

128 iàĞ
is_mmio
 && !
v®ue_is_±r
 && (
dœ
 =ğ
IOREQ_WRITE
) &&

129 (
addr
 =ğ(
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_·
 +

130 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_by‹s
)) )

131  
X86EMUL_RETRY
;

133  
X86EMUL_UNHANDLEABLE
;

136 iàĞ
p
->
¡©e
 !ğ
STATE_IOREQ_NONE
 )

138 
	`gd´štk
(
XENLOG_WARNING
, "WARNING: io‡lready…ending (%d)?\n",

139 
p
->
¡©e
);

140  
X86EMUL_UNHANDLEABLE
;

143 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 =

144 (
p_d©a
 =ğ
NULL
è? 
HVMIO_di¥©ched
 : 
HVMIO_awa™šg_com¶‘iÚ
;

145 
cu¼
->
¬ch
.
hvm_vıu
.
io_size
 = 
size
;

147 
p
->
dœ
 = dir;

148 
p
->
d©a_is_±r
 = 
v®ue_is_±r
;

149 
p
->
ty³
 = 
is_mmio
 ? 
IOREQ_TYPE_COPY
 : 
IOREQ_TYPE_PIO
;

150 
p
->
size
 = size;

151 
p
->
addr
 =‡ddr;

152 
p
->
couÁ
 = *
»ps
;

153 
p
->
df
 = df;

154 
p
->
d©a
 = 
v®ue
;

156 
	`hvmŒaû_io_assi¡
(
is_mmio
, 
p
);

158 iàĞ
is_mmio
 )

160 
rc
 = 
	`hvm_mmio_š‹rû±
(
p
);

161 iàĞ
rc
 =ğ
X86EMUL_UNHANDLEABLE
 )

162 
rc
 = 
	`hvm_bufã»d_io_š‹rû±
(
p
);

166 
rc
 = 
	`hvm_pÜtio_š‹rû±
(
p
);

169  
rc
 )

171 
X86EMUL_OKAY
:

172 
X86EMUL_RETRY
:

173 *
»ps
 = 
p
->
couÁ
;

174 
p
->
¡©e
 = 
STATE_IORESP_READY
;

175 
	`hvm_io_assi¡
();

176 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_nÚe
;

178 
X86EMUL_UNHANDLEABLE
:

179 
rc
 = 
X86EMUL_RETRY
;

180 iàĞ!
	`hvm_£nd_assi¡_»q
(
cu¼
) )

181 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_nÚe
;

182 iàĞ
p_d©a
 =ğ
NULL
 )

183 
rc
 = 
X86EMUL_OKAY
;

186 
	`BUG
();

189 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

190  
rc
;

192 
fšish_acûss
:

193 iàĞ
p_d©a
 !ğ
NULL
 )

194 
	`memıy
(
p_d©a
, &
cu¼
->
¬ch
.
hvm_vıu
.
io_d©a
, 
size
);

196 iàĞ
is_mmio
 && !
v®ue_is_±r
 )

199 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

201 
·ddr_t
 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_·
;

202 
by‹s
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_by‹s
;

203 iàĞ
by‹s
 == 0 )

204 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_·
 = 
addr
;

205 iàĞ
addr
 =ğ(
·
 + 
by‹s
) )

206 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_by‹s
 +ğ
size
;

210 
·ddr_t
 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_·
;

211 
by‹s
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_by‹s
;

212 iàĞ
by‹s
 == 0 )

213 
·
 = 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_·
 = 
addr
;

214 iàĞ(
addr
 =ğ(
·
 + 
by‹s
)) &&

215 ((
by‹s
 + 
size
) <

216 (
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad
)) )

218 
	`memıy
(&
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad
[
addr
 - 
·
],

219 
p_d©a
, 
size
);

220 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_by‹s
 +ğ
size
;

225  
X86EMUL_OKAY
;

226 
	}
}

228 
	$hvmemul_do_pio
(

229 
pÜt
, *
»ps
, 
size
,

230 
·ddr_t
 
¿m_g·
, 
dœ
, 
df
, *
p_d©a
)

232  
	`hvmemul_do_io
(0, 
pÜt
, 
»ps
, 
size
, 
¿m_g·
, 
dœ
, 
df
, 
p_d©a
);

233 
	}
}

235 
	$hvmemul_do_mmio
(

236 
·ddr_t
 
g·
, *
»ps
, 
size
,

237 
·ddr_t
 
¿m_g·
, 
dœ
, 
df
, *
p_d©a
)

239  
	`hvmemul_do_io
(1, 
g·
, 
»ps
, 
size
, 
¿m_g·
, 
dœ
, 
df
, 
p_d©a
);

240 
	}
}

248 
	$hvmemul_lš—r_to_phys
(

249 
addr
,

250 
·ddr_t
 *
·ddr
,

251 
by‹s_³r_»p
,

252 *
»ps
,

253 
ušt32_t
 
pãc
,

254 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

256 
vıu
 *
cu¼
 = 
cu¼’t
;

257 
pâ
, 
Åâ
, 
dÚe
, 
todo
, 
i
, 
off£t
 = 
addr
 & ~
PAGE_MASK
;

258 
»v”£
;

264 *
»ps
 = 
	`mš_t
(, *reps, 4096);

267 iàĞ!(
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PG
) )

269 *
·ddr
 = 
addr
;

270  
X86EMUL_OKAY
;

274 
»v”£
 = (
hvmemul_ùxt
->
ùxt
.
»gs
->
eæags
 & 
X86_EFLAGS_DF
è&& (*
»ps
 > 1);

276 iàĞ
»v”£
 && ((
PAGE_SIZE
 - 
off£t
è< 
by‹s_³r_»p
) )

279 
·ddr_t
 
_·ddr
;

280 
Úe_»p
 = 1;

281 
rc
 = 
	`hvmemul_lš—r_to_phys
(

282 
addr
, &
_·ddr
, 
by‹s_³r_»p
, &
Úe_»p
, 
pãc
, 
hvmemul_ùxt
);

283 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

284  
rc
;

285 
pâ
 = 
_·ddr
 >> 
PAGE_SHIFT
;

287 iàĞ(
pâ
 = 
	`·gšg_gva_to_gâ
(
cu¼
, 
addr
, &
pãc
)è=ğ
INVALID_GFN
 )

289 iàĞ
pãc
 =ğ
PFEC_·ge_·ged
 ||…ãø=ğ
PFEC_·ge_sh¬ed
 )

290  
X86EMUL_RETRY
;

291 
	`hvm_šjeù_exû±iÚ
(
TRAP_·ge_çuÉ
, 
pãc
, 
addr
);

292  
X86EMUL_EXCEPTION
;

295 
dÚe
 = 
»v”£
 ? 
by‹s_³r_»p
 + 
off£t
 : 
PAGE_SIZE
 - offset;

296 
todo
 = *
»ps
 * 
by‹s_³r_»p
;

297  
i
 = 1; 
dÚe
 < 
todo
; i++ )

300 
addr
 +ğ
»v”£
 ? -
PAGE_SIZE
 : PAGE_SIZE;

301 
Åâ
 = 
	`·gšg_gva_to_gâ
(
cu¼
, 
addr
, &
pãc
);

304 iàĞ(
Åâ
 =ğ
INVALID_GFN
è|| (Åâ !ğ(
pâ
 + (
»v”£
 ? -
i
 : i))) )

306 iàĞ
pãc
 =ğ
PFEC_·ge_·ged
 ||…ãø=ğ
PFEC_·ge_sh¬ed
 )

307  
X86EMUL_RETRY
;

308 
dÚe
 /ğ
by‹s_³r_»p
;

309 iàĞ
dÚe
 == 0 )

311 
	`ASSERT
(!
»v”£
);

312 iàĞ
Åâ
 !ğ
INVALID_GFN
 )

313  
X86EMUL_UNHANDLEABLE
;

314 
	`hvm_šjeù_exû±iÚ
(
TRAP_·ge_çuÉ
, 
pãc
, 
addr
 & 
PAGE_MASK
);

315  
X86EMUL_EXCEPTION
;

317 *
»ps
 = 
dÚe
;

321 
dÚe
 +ğ
PAGE_SIZE
;

324 *
·ddr
 = ((
·ddr_t
)
pâ
 << 
PAGE_SHIFT
è| 
off£t
;

325  
X86EMUL_OKAY
;

326 
	}
}

329 
	$hvmemul_vœtu®_to_lš—r
(

330 
x86_£gm’t
 
£g
,

331 
off£t
,

332 
by‹s_³r_»p
,

333 *
»ps
,

334 
hvm_acûss_ty³
 
acûss_ty³
,

335 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
,

336 *
·ddr
)

338 
£gm’t_»gi¡”
 *
»g
;

339 
okay
;

341 iàĞ
£g
 =ğ
x86_£g_nÚe
 )

343 *
·ddr
 = 
off£t
;

344  
X86EMUL_OKAY
;

352 *
»ps
 = 
	`mš_t
(, *reps, 4096);

354 
»g
 = 
	`hvmemul_g‘_£g_»g
(
£g
, 
hvmemul_ùxt
);

356 iàĞ(
hvmemul_ùxt
->
ùxt
.
»gs
->
eæags
 & 
X86_EFLAGS_DF
è&& (*
»ps
 > 1) )

362 
	`ASSERT
(
off£t
 >ğ((*
»ps
 - 1è* 
by‹s_³r_»p
));

363 
okay
 = 
	`hvm_vœtu®_to_lš—r_addr
(

364 
£g
, 
»g
, 
off£t
 - (*
»ps
 - 1è* 
by‹s_³r_»p
,

365 *
»ps
 * 
by‹s_³r_»p
, 
acûss_ty³
,

366 
hvmemul_ùxt
->
ùxt
.
addr_size
, 
·ddr
);

367 *
·ddr
 +ğ(*
»ps
 - 1è* 
by‹s_³r_»p
;

368 iàĞ
hvmemul_ùxt
->
ùxt
.
addr_size
 != 64 )

369 *
·ddr
 = (
ušt32_t
)*paddr;

373 
okay
 = 
	`hvm_vœtu®_to_lš—r_addr
(

374 
£g
, 
»g
, 
off£t
, *
»ps
 * 
by‹s_³r_»p
, 
acûss_ty³
,

375 
hvmemul_ùxt
->
ùxt
.
addr_size
, 
·ddr
);

378 iàĞ
okay
 )

379  
X86EMUL_OKAY
;

382 iàĞ*
»ps
 != 1 )

383  
X86EMUL_UNHANDLEABLE
;

386 
hvmemul_ùxt
->
exn_³ndšg
 = 1;

387 
hvmemul_ùxt
->
exn_veùÜ
 = 
TRAP_gp_çuÉ
;

388 
hvmemul_ùxt
->
exn_”rÜ_code
 = 0;

389 
hvmemul_ùxt
->
exn_š¢_Ën
 = 0;

390  
X86EMUL_EXCEPTION
;

391 
	}
}

393 
	$__hvmemul_»ad
(

394 
x86_£gm’t
 
£g
,

395 
off£t
,

396 *
p_d©a
,

397 
by‹s
,

398 
hvm_acûss_ty³
 
acûss_ty³
,

399 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

401 
vıu
 *
cu¼
 = 
cu¼’t
;

402 
addr
, 
»ps
 = 1;

403 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

404 
·ddr_t
 
g·
;

405 
rc
;

407 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

408 
£g
, 
off£t
, 
by‹s
, &
»ps
, 
acûss_ty³
, 
hvmemul_ùxt
, &
addr
);

409 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

410  
rc
;

412 iàĞ
	`uÆik–y
(
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gva
 =ğ(
addr
 & 
PAGE_MASK
)) &&

413 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gva
 )

415 
off
 = 
addr
 & (
PAGE_SIZE
 - 1);

416 iàĞ
acûss_ty³
 =ğ
hvm_acûss_š¢_ãtch
 )

417  
X86EMUL_UNHANDLEABLE
;

418 
g·
 = (((
·ddr_t
)
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gpâ
 << 
PAGE_SHIFT
è| 
off
);

419 iàĞ(
off
 + 
by‹s
è<ğ
PAGE_SIZE
 )

420  
	`hvmemul_do_mmio
(
g·
, &
»ps
, 
by‹s
, 0,

421 
IOREQ_READ
, 0, 
p_d©a
);

424 iàĞ(
£g
 !ğ
x86_£g_nÚe
) &&

425 (
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3) )

426 
pãc
 |ğ
PFEC_u£r_mode
;

428 
rc
 = ((
acûss_ty³
 =ğ
hvm_acûss_š¢_ãtch
) ?

429 
	`hvm_ãtch_äom_gue¡_vœt
(
p_d©a
, 
addr
, 
by‹s
, 
pãc
) :

430 
	`hvm_cİy_äom_gue¡_vœt
(
p_d©a
, 
addr
, 
by‹s
, 
pãc
));

432  
rc
 )

434 
HVMCOPY_bad_gva_to_gâ
:

435  
X86EMUL_EXCEPTION
;

436 
HVMCOPY_unhªdËabË
:

437  
X86EMUL_UNHANDLEABLE
;

438 
HVMCOPY_bad_gâ_to_mâ
:

439 iàĞ
acûss_ty³
 =ğ
hvm_acûss_š¢_ãtch
 )

440  
X86EMUL_UNHANDLEABLE
;

441 
rc
 = 
	`hvmemul_lš—r_to_phys
(

442 
addr
, &
g·
, 
by‹s
, &
»ps
, 
pãc
, 
hvmemul_ùxt
);

443 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

444  
rc
;

445  
	`hvmemul_do_mmio
(
g·
, &
»ps
, 
by‹s
, 0, 
IOREQ_READ
, 0, 
p_d©a
);

446 
HVMCOPY_gâ_·ged_out
:

447  
X86EMUL_RETRY
;

448 
HVMCOPY_gâ_sh¬ed
:

449  
X86EMUL_RETRY
;

454  
X86EMUL_OKAY
;

455 
	}
}

457 
	$hvmemul_»ad
(

458 
x86_£gm’t
 
£g
,

459 
off£t
,

460 *
p_d©a
,

461 
by‹s
,

462 
x86_emuÏ‹_ùxt
 *
ùxt
)

464  
	`__hvmemul_»ad
(

465 
£g
, 
off£t
, 
p_d©a
, 
by‹s
, 
hvm_acûss_»ad
,

466 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt));

467 
	}
}

469 
	$hvmemul_š¢_ãtch
(

470 
x86_£gm’t
 
£g
,

471 
off£t
,

472 *
p_d©a
,

473 
by‹s
,

474 
x86_emuÏ‹_ùxt
 *
ùxt
)

476 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

477 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

478 
š¢_off
 = 
off£t
 - 
hvmemul_ùxt
->
š¢_buf_e
;

481 iàĞ
	`uÆik–y
((
š¢_off
 + 
by‹s
è> 
hvmemul_ùxt
->
š¢_buf_by‹s
) )

482  
	`__hvmemul_»ad
(

483 
£g
, 
off£t
, 
p_d©a
, 
by‹s
,

484 
hvm_acûss_š¢_ãtch
, 
hvmemul_ùxt
);

487 
	`memıy
(
p_d©a
, &
hvmemul_ùxt
->
š¢_buf
[
š¢_off
], 
by‹s
);

488  
X86EMUL_OKAY
;

489 
	}
}

491 
	$hvmemul_wr™e
(

492 
x86_£gm’t
 
£g
,

493 
off£t
,

494 *
p_d©a
,

495 
by‹s
,

496 
x86_emuÏ‹_ùxt
 *
ùxt
)

498 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

499 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

500 
vıu
 *
cu¼
 = 
cu¼’t
;

501 
addr
, 
»ps
 = 1;

502 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
 | 
PFEC_wr™e_acûss
;

503 
·ddr_t
 
g·
;

504 
rc
;

506 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

507 
£g
, 
off£t
, 
by‹s
, &
»ps
, 
hvm_acûss_wr™e
, 
hvmemul_ùxt
, &
addr
);

508 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

509  
rc
;

511 iàĞ
	`uÆik–y
(
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gva
 =ğ(
addr
 & 
PAGE_MASK
)) &&

512 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gva
 )

514 
off
 = 
addr
 & (
PAGE_SIZE
 - 1);

515 
g·
 = (((
·ddr_t
)
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gpâ
 << 
PAGE_SHIFT
è| 
off
);

516 iàĞ(
off
 + 
by‹s
è<ğ
PAGE_SIZE
 )

517  
	`hvmemul_do_mmio
(
g·
, &
»ps
, 
by‹s
, 0,

518 
IOREQ_WRITE
, 0, 
p_d©a
);

521 iàĞ(
£g
 !ğ
x86_£g_nÚe
) &&

522 (
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3) )

523 
pãc
 |ğ
PFEC_u£r_mode
;

525 
rc
 = 
	`hvm_cİy_to_gue¡_vœt
(
addr
, 
p_d©a
, 
by‹s
, 
pãc
);

527  
rc
 )

529 
HVMCOPY_bad_gva_to_gâ
:

530  
X86EMUL_EXCEPTION
;

531 
HVMCOPY_unhªdËabË
:

532  
X86EMUL_UNHANDLEABLE
;

533 
HVMCOPY_bad_gâ_to_mâ
:

534 
rc
 = 
	`hvmemul_lš—r_to_phys
(

535 
addr
, &
g·
, 
by‹s
, &
»ps
, 
pãc
, 
hvmemul_ùxt
);

536 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

537  
rc
;

538  
	`hvmemul_do_mmio
(
g·
, &
»ps
, 
by‹s
, 0,

539 
IOREQ_WRITE
, 0, 
p_d©a
);

540 
HVMCOPY_gâ_·ged_out
:

541  
X86EMUL_RETRY
;

542 
HVMCOPY_gâ_sh¬ed
:

543  
X86EMUL_RETRY
;

548  
X86EMUL_OKAY
;

549 
	}
}

551 
	$hvmemul_cmpxchg
(

552 
x86_£gm’t
 
£g
,

553 
off£t
,

554 *
p_Şd
,

555 *
p_Ãw
,

556 
by‹s
,

557 
x86_emuÏ‹_ùxt
 *
ùxt
)

560  
	`hvmemul_wr™e
(
£g
, 
off£t
, 
p_Ãw
, 
by‹s
, 
ùxt
);

561 
	}
}

563 
	$hvmemul_»p_šs
(

564 
ušt16_t
 
¤c_pÜt
,

565 
x86_£gm’t
 
d¡_£g
,

566 
d¡_off£t
,

567 
by‹s_³r_»p
,

568 *
»ps
,

569 
x86_emuÏ‹_ùxt
 *
ùxt
)

571 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

572 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

573 
addr
;

574 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
 | 
PFEC_wr™e_acûss
;

575 
·ddr_t
 
g·
;

576 
rc
;

578 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

579 
d¡_£g
, 
d¡_off£t
, 
by‹s_³r_»p
, 
»ps
, 
hvm_acûss_wr™e
,

580 
hvmemul_ùxt
, &
addr
);

581 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

582  
rc
;

584 iàĞ
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3 )

585 
pãc
 |ğ
PFEC_u£r_mode
;

587 
rc
 = 
	`hvmemul_lš—r_to_phys
(

588 
addr
, &
g·
, 
by‹s_³r_»p
, 
»ps
, 
pãc
, 
hvmemul_ùxt
);

589 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

590  
rc
;

592  
	`hvmemul_do_pio
(
¤c_pÜt
, 
»ps
, 
by‹s_³r_»p
, 
g·
, 
IOREQ_READ
,

593 !!(
ùxt
->
»gs
->
eæags
 & 
X86_EFLAGS_DF
), 
NULL
);

594 
	}
}

596 
	$hvmemul_»p_outs
(

597 
x86_£gm’t
 
¤c_£g
,

598 
¤c_off£t
,

599 
ušt16_t
 
d¡_pÜt
,

600 
by‹s_³r_»p
,

601 *
»ps
,

602 
x86_emuÏ‹_ùxt
 *
ùxt
)

604 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

605 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

606 
addr
;

607 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

608 
·ddr_t
 
g·
;

609 
rc
;

611 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

612 
¤c_£g
, 
¤c_off£t
, 
by‹s_³r_»p
, 
»ps
, 
hvm_acûss_»ad
,

613 
hvmemul_ùxt
, &
addr
);

614 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

615  
rc
;

617 iàĞ
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3 )

618 
pãc
 |ğ
PFEC_u£r_mode
;

620 
rc
 = 
	`hvmemul_lš—r_to_phys
(

621 
addr
, &
g·
, 
by‹s_³r_»p
, 
»ps
, 
pãc
, 
hvmemul_ùxt
);

622 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

623  
rc
;

625  
	`hvmemul_do_pio
(
d¡_pÜt
, 
»ps
, 
by‹s_³r_»p
, 
g·
, 
IOREQ_WRITE
,

626 !!(
ùxt
->
»gs
->
eæags
 & 
X86_EFLAGS_DF
), 
NULL
);

627 
	}
}

629 
	$hvmemul_»p_movs
(

630 
x86_£gm’t
 
¤c_£g
,

631 
¤c_off£t
,

632 
x86_£gm’t
 
d¡_£g
,

633 
d¡_off£t
,

634 
by‹s_³r_»p
,

635 *
»ps
,

636 
x86_emuÏ‹_ùxt
 *
ùxt
)

638 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

639 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

640 
§ddr
, 
daddr
, 
by‹s
;

641 
·ddr_t
 
sg·
, 
dg·
;

642 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

643 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
);

644 
p2m_ty³_t
 
p2mt
;

645 
rc
, 
df
 = !!(
ùxt
->
»gs
->
eæags
 & 
X86_EFLAGS_DF
);

646 *
buf
;

648 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

649 
¤c_£g
, 
¤c_off£t
, 
by‹s_³r_»p
, 
»ps
, 
hvm_acûss_»ad
,

650 
hvmemul_ùxt
, &
§ddr
);

651 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

652  
rc
;

654 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

655 
d¡_£g
, 
d¡_off£t
, 
by‹s_³r_»p
, 
»ps
, 
hvm_acûss_wr™e
,

656 
hvmemul_ùxt
, &
daddr
);

657 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

658  
rc
;

660 iàĞ
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3 )

661 
pãc
 |ğ
PFEC_u£r_mode
;

663 
rc
 = 
	`hvmemul_lš—r_to_phys
(

664 
§ddr
, &
sg·
, 
by‹s_³r_»p
, 
»ps
, 
pãc
, 
hvmemul_ùxt
);

665 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

666  
rc
;

668 
rc
 = 
	`hvmemul_lš—r_to_phys
(

669 
daddr
, &
dg·
, 
by‹s_³r_»p
, 
»ps
,

670 
pãc
 | 
PFEC_wr™e_acûss
, 
hvmemul_ùxt
);

671 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

672  
rc
;

674 ()
	`gâ_to_mâ
(
p2m
, 
sg·
 >> 
PAGE_SHIFT
, &
p2mt
);

675 iàĞ!
	`p2m_is_¿m
(
p2mt
è&& !
	`p2m_is_g¿Á
(p2mt) )

676  
	`hvmemul_do_mmio
(

677 
sg·
, 
»ps
, 
by‹s_³r_»p
, 
dg·
, 
IOREQ_READ
, 
df
, 
NULL
);

679 ()
	`gâ_to_mâ
(
p2m
, 
dg·
 >> 
PAGE_SHIFT
, &
p2mt
);

680 iàĞ!
	`p2m_is_¿m
(
p2mt
è&& !
	`p2m_is_g¿Á
(p2mt) )

681  
	`hvmemul_do_mmio
(

682 
dg·
, 
»ps
, 
by‹s_³r_»p
, 
sg·
, 
IOREQ_WRITE
, 
df
, 
NULL
);

685 
by‹s
 = *
»ps
 * 
by‹s_³r_»p
;

688 iàĞ
df
 )

689 
sg·
 -ğ
by‹s
 - 
by‹s_³r_»p
;

696 iàĞ((
dg·
 + 
by‹s_³r_»p
è> 
sg·
è&& (dg· < (sg· + 
by‹s
)) )

697  
X86EMUL_UNHANDLEABLE
;

700 iàĞ
df
 )

701 
dg·
 -ğ
by‹s
 - 
by‹s_³r_»p
;

704 
buf
 = 
	`xm®loc_by‹s
(
by‹s
);

705 iàĞ
buf
 =ğ
NULL
 )

706  
X86EMUL_UNHANDLEABLE
;

712 
rc
 = 
	`hvm_cİy_äom_gue¡_phys
(
buf
, 
sg·
, 
by‹s
);

713 iàĞ
rc
 =ğ
HVMCOPY_okay
 )

714 
rc
 = 
	`hvm_cİy_to_gue¡_phys
(
dg·
, 
buf
, 
by‹s
);

716 
	`xä“
(
buf
);

718 iàĞ
rc
 =ğ
HVMCOPY_gâ_·ged_out
 )

719  
X86EMUL_RETRY
;

720 iàĞ
rc
 =ğ
HVMCOPY_gâ_sh¬ed
 )

721  
X86EMUL_RETRY
;

722 iàĞ
rc
 !ğ
HVMCOPY_okay
 )

724 
	`gd´štk
(
XENLOG_WARNING
, "Failed memory-to-memory REP MOVS: sgpa=%"

725 
PRI·ddr
" dgpa=%"PRIpaddr"„eps=%lu bytes_per_rep=%u\n",

726 
sg·
, 
dg·
, *
»ps
, 
by‹s_³r_»p
);

727  
X86EMUL_UNHANDLEABLE
;

730  
X86EMUL_OKAY
;

731 
	}
}

733 
	$hvmemul_»ad_£gm’t
(

734 
x86_£gm’t
 
£g
,

735 
£gm’t_»gi¡”
 *
»g
,

736 
x86_emuÏ‹_ùxt
 *
ùxt
)

738 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

739 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

740 
£gm’t_»gi¡”
 *
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
£g
, 
hvmemul_ùxt
);

741 
	`memıy
(
»g
, 
¤eg
, (
£gm’t_»gi¡”
));

742  
X86EMUL_OKAY
;

743 
	}
}

745 
	$hvmemul_wr™e_£gm’t
(

746 
x86_£gm’t
 
£g
,

747 
£gm’t_»gi¡”
 *
»g
,

748 
x86_emuÏ‹_ùxt
 *
ùxt
)

750 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

751 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

752 
£gm’t_»gi¡”
 *
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
£g
, 
hvmemul_ùxt
);

754 
	`memıy
(
¤eg
, 
»g
, (
£gm’t_»gi¡”
));

755 
	`__£t_b™
(
£g
, &
hvmemul_ùxt
->
£g_»g_dœty
);

757  
X86EMUL_OKAY
;

758 
	}
}

760 
	$hvmemul_»ad_io
(

761 
pÜt
,

762 
by‹s
,

763 *
v®
,

764 
x86_emuÏ‹_ùxt
 *
ùxt
)

766 
»ps
 = 1;

767 *
v®
 = 0;

768  
	`hvmemul_do_pio
(
pÜt
, &
»ps
, 
by‹s
, 0, 
IOREQ_READ
, 0, 
v®
);

769 
	}
}

771 
	$hvmemul_wr™e_io
(

772 
pÜt
,

773 
by‹s
,

774 
v®
,

775 
x86_emuÏ‹_ùxt
 *
ùxt
)

777 
»ps
 = 1;

778  
	`hvmemul_do_pio
(
pÜt
, &
»ps
, 
by‹s
, 0, 
IOREQ_WRITE
, 0, &
v®
);

779 
	}
}

781 
	$hvmemul_»ad_ü
(

782 
»g
,

783 *
v®
,

784 
x86_emuÏ‹_ùxt
 *
ùxt
)

786  
»g
 )

792 *
v®
 = 
cu¼’t
->
¬ch
.
hvm_vıu
.
gue¡_ü
[
»g
];

793 
	`HVMTRACE_LONG_2D
(
CR_READ
, 
»g
, 
	`TRC_PAR_LONG
(*
v®
));

794  
X86EMUL_OKAY
;

799  
X86EMUL_UNHANDLEABLE
;

800 
	}
}

802 
	$hvmemul_wr™e_ü
(

803 
»g
,

804 
v®
,

805 
x86_emuÏ‹_ùxt
 *
ùxt
)

807 
	`HVMTRACE_LONG_2D
(
CR_WRITE
, 
»g
, 
	`TRC_PAR_LONG
(
v®
));

808  
»g
 )

811  
	`hvm_£t_ü0
(
v®
);

813 
cu¼’t
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
v®
;

814  
X86EMUL_OKAY
;

816  
	`hvm_£t_ü3
(
v®
);

818  
	`hvm_£t_ü4
(
v®
);

823  
X86EMUL_UNHANDLEABLE
;

824 
	}
}

826 
	$hvmemul_»ad_m¤
(

827 
»g
,

828 
ušt64_t
 *
v®
,

829 
x86_emuÏ‹_ùxt
 *
ùxt
)

831  
	`hvm_m¤_»ad_š‹rû±
(
»g
, 
v®
);

832 
	}
}

834 
	$hvmemul_wr™e_m¤
(

835 
»g
,

836 
ušt64_t
 
v®
,

837 
x86_emuÏ‹_ùxt
 *
ùxt
)

839  
	`hvm_m¤_wr™e_š‹rû±
(
»g
, 
v®
);

840 
	}
}

842 
	$hvmemul_wbšvd
(

843 
x86_emuÏ‹_ùxt
 *
ùxt
)

845 
hvm_funcs
.
	`wbšvd_š‹rû±
();

846  
X86EMUL_OKAY
;

847 
	}
}

849 
	$hvmemul_ıuid
(

850 *
—x
,

851 *
ebx
,

852 *
ecx
,

853 *
edx
,

854 
x86_emuÏ‹_ùxt
 *
ùxt
)

856 
hvm_funcs
.
	`ıuid_š‹rû±
(
—x
, 
ebx
, 
ecx
, 
edx
);

857  
X86EMUL_OKAY
;

858 
	}
}

860 
	$hvmemul_šjeù_hw_exû±iÚ
(

861 
ušt8_t
 
veùÜ
,

862 
št32_t
 
”rÜ_code
,

863 
x86_emuÏ‹_ùxt
 *
ùxt
)

865 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

866 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

868 
hvmemul_ùxt
->
exn_³ndšg
 = 1;

869 
hvmemul_ùxt
->
exn_veùÜ
 = 
veùÜ
;

870 
hvmemul_ùxt
->
exn_”rÜ_code
 = 
”rÜ_code
;

871 
hvmemul_ùxt
->
exn_š¢_Ën
 = 0;

873  
X86EMUL_OKAY
;

874 
	}
}

876 
	$hvmemul_šjeù_sw_š‹¼u±
(

877 
ušt8_t
 
veùÜ
,

878 
ušt8_t
 
š¢_Ën
,

879 
x86_emuÏ‹_ùxt
 *
ùxt
)

881 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

882 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

884 
hvmemul_ùxt
->
exn_³ndšg
 = 1;

885 
hvmemul_ùxt
->
exn_veùÜ
 = 
veùÜ
;

886 
hvmemul_ùxt
->
exn_”rÜ_code
 = -1;

887 
hvmemul_ùxt
->
exn_š¢_Ën
 = 
š¢_Ën
;

889  
X86EMUL_OKAY
;

890 
	}
}

892 
hvmemul_g‘_åu
(

893 (*
exû±iÚ_ÿÎback
)(*, 
ıu_u£r_»gs
 *),

894 *
exû±iÚ_ÿÎback_¬g
,

895 
x86_emuÏ‹_åu_ty³
 
ty³
,

896 
x86_emuÏ‹_ùxt
 *
ùxt
)

898 
vıu
 *
cu¼
 = 
cu¼’t
;

900  
ty³
 )

902 
X86EMUL_FPU_åu
:

904 
X86EMUL_FPU_mmx
:

905 iàĞ!
ıu_has_mmx
 )

906  
X86EMUL_UNHANDLEABLE
;

909  
X86EMUL_UNHANDLEABLE
;

912 iàĞ!
cu¼
->
åu_dœt›d
 )

913 
hvm_funcs
.
	`åu_dœty_š‹rû±
();

915 
cu¼
->
¬ch
.
hvm_vıu
.
åu_exû±iÚ_ÿÎback
 = 
exû±iÚ_ÿÎback
;

916 
cu¼
->
¬ch
.
hvm_vıu
.
åu_exû±iÚ_ÿÎback_¬g
 = 
exû±iÚ_ÿÎback_¬g
;

918  
X86EMUL_OKAY
;

919 
	}
}

921 
	$hvmemul_put_åu
(

922 
x86_emuÏ‹_ùxt
 *
ùxt
)

924 
vıu
 *
cu¼
 = 
cu¼’t
;

925 
cu¼
->
¬ch
.
hvm_vıu
.
åu_exû±iÚ_ÿÎback
 = 
NULL
;

926 
	}
}

928 
	$hvmemul_švÍg
(

929 
x86_£gm’t
 
£g
,

930 
off£t
,

931 
x86_emuÏ‹_ùxt
 *
ùxt
)

933 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
 =

934 
	`cÚš”_of
(
ùxt
, 
hvm_emuÏ‹_ùxt
, ctxt);

935 
addr
, 
»ps
 = 1;

936 
rc
;

938 
rc
 = 
	`hvmemul_vœtu®_to_lš—r
(

939 
£g
, 
off£t
, 1, &
»ps
, 
hvm_acûss_nÚe
, 
hvmemul_ùxt
, &
addr
);

941 iàĞ
rc
 =ğ
X86EMUL_OKAY
 )

942 
hvm_funcs
.
	`švÍg_š‹rû±
(
addr
);

944  
rc
;

945 
	}
}

947 cÚ¡ 
x86_emuÏ‹_İs
 
	ghvm_emuÏ‹_İs
 = {

948 .
»ad
 = 
hvmemul_»ad
,

949 .
	gš¢_ãtch
 = 
hvmemul_š¢_ãtch
,

950 .
	gwr™e
 = 
hvmemul_wr™e
,

951 .
	gcmpxchg
 = 
hvmemul_cmpxchg
,

952 .
	g»p_šs
 = 
hvmemul_»p_šs
,

953 .
	g»p_outs
 = 
hvmemul_»p_outs
,

954 .
	g»p_movs
 = 
hvmemul_»p_movs
,

955 .
	g»ad_£gm’t
 = 
hvmemul_»ad_£gm’t
,

956 .
	gwr™e_£gm’t
 = 
hvmemul_wr™e_£gm’t
,

957 .
	g»ad_io
 = 
hvmemul_»ad_io
,

958 .
	gwr™e_io
 = 
hvmemul_wr™e_io
,

959 .
	g»ad_ü
 = 
hvmemul_»ad_ü
,

960 .
	gwr™e_ü
 = 
hvmemul_wr™e_ü
,

961 .
	g»ad_m¤
 = 
hvmemul_»ad_m¤
,

962 .
	gwr™e_m¤
 = 
hvmemul_wr™e_m¤
,

963 .
	gwbšvd
 = 
hvmemul_wbšvd
,

964 .
	gıuid
 = 
hvmemul_ıuid
,

965 .
	gšjeù_hw_exû±iÚ
 = 
hvmemul_šjeù_hw_exû±iÚ
,

966 .
	gšjeù_sw_š‹¼u±
 = 
hvmemul_šjeù_sw_š‹¼u±
,

967 .
	gg‘_åu
 = 
hvmemul_g‘_åu
,

968 .
	gput_åu
 = 
hvmemul_put_åu
,

969 .
	gšvÍg
 = 
hvmemul_švÍg


972 
	$hvm_emuÏ‹_Úe
(

973 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

975 
ıu_u£r_»gs
 *
»gs
 = 
hvmemul_ùxt
->
ùxt
.regs;

976 
vıu
 *
cu¼
 = 
cu¼’t
;

977 
ušt32_t
 
Ãw_šŒ_shadow
, 
pãc
 = 
PFEC_·ge_´e£Á
;

978 
addr
;

979 
rc
;

981 iàĞ
	`hvm_lÚg_mode_’abËd
(
cu¼
) &&

982 
hvmemul_ùxt
->
£g_»g
[
x86_£g_cs
].
©Œ
.
f›lds
.
l
 )

984 
hvmemul_ùxt
->
ùxt
.
addr_size
 = hvmemul_ùxt->ùxt.
¥_size
 = 64;

988 
hvmemul_ùxt
->
ùxt
.
addr_size
 =

989 
hvmemul_ùxt
->
£g_»g
[
x86_£g_cs
].
©Œ
.
f›lds
.
db
 ? 32 : 16;

990 
hvmemul_ùxt
->
ùxt
.
¥_size
 =

991 
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
db
 ? 32 : 16;

994 iàĞ
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
d¶
 == 3 )

995 
pãc
 |ğ
PFEC_u£r_mode
;

997 
hvmemul_ùxt
->
š¢_buf_e
 = 
»gs
->
e
;

998 
hvmemul_ùxt
->
š¢_buf_by‹s
 =

999 (
	`hvm_vœtu®_to_lš—r_addr
(

1000 
x86_£g_cs
, &
hvmemul_ùxt
->
£g_»g
[x86_seg_cs],

1001 
»gs
->
e
, (
hvmemul_ùxt
->
š¢_buf
),

1002 
hvm_acûss_š¢_ãtch
, 
hvmemul_ùxt
->
ùxt
.
addr_size
, &
addr
) &&

1003 !
	`hvm_ãtch_äom_gue¡_vœt_noçuÉ
(

1004 
hvmemul_ùxt
->
š¢_buf
, 
addr
,

1005 (
hvmemul_ùxt
->
š¢_buf
), 
pãc
))

1006 ? (
hvmemul_ùxt
->
š¢_buf
) : 0;

1008 
hvmemul_ùxt
->
exn_³ndšg
 = 0;

1010 
rc
 = 
	`x86_emuÏ‹
(&
hvmemul_ùxt
->
ùxt
, &
hvm_emuÏ‹_İs
);

1012 iàĞ
rc
 !ğ
X86EMUL_RETRY
 )

1013 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_»ad_by‹s
 =

1014 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_Ïrge_wr™e_by‹s
 = 0;

1016 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

1017  
rc
;

1019 
Ãw_šŒ_shadow
 = 
hvmemul_ùxt
->
šŒ_shadow
;

1022 iàĞ
hvmemul_ùxt
->
ùxt
.
»tœe
.
æags
.
mov_ss
 )

1023 
Ãw_šŒ_shadow
 ^ğ
HVM_INTR_SHADOW_MOV_SS
;

1025 
Ãw_šŒ_shadow
 &ğ~
HVM_INTR_SHADOW_MOV_SS
;

1028 iàĞ
hvmemul_ùxt
->
ùxt
.
»tœe
.
æags
.
¡i
 )

1029 
Ãw_šŒ_shadow
 ^ğ
HVM_INTR_SHADOW_STI
;

1031 
Ãw_šŒ_shadow
 &ğ~
HVM_INTR_SHADOW_STI
;

1033 iàĞ
hvmemul_ùxt
->
šŒ_shadow
 !ğ
Ãw_šŒ_shadow
 )

1035 
hvmemul_ùxt
->
šŒ_shadow
 = 
Ãw_šŒ_shadow
;

1036 
hvm_funcs
.
	`£t_š‹¼u±_shadow
(
cu¼
, 
Ãw_šŒ_shadow
);

1039 iàĞ
hvmemul_ùxt
->
ùxt
.
»tœe
.
æags
.
hÉ
 &&

1040 !
	`hvm_loÿl_ev’ts_Ãed_d–iv”y
(
cu¼
) )

1042 
	`hvm_hÉ
(
»gs
->
eæags
);

1045  
X86EMUL_OKAY
;

1046 
	}
}

1048 
	$hvm_emuÏ‹_´•¬e
(

1049 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
,

1050 
ıu_u£r_»gs
 *
»gs
)

1052 
hvmemul_ùxt
->
šŒ_shadow
 = 
hvm_funcs
.
	`g‘_š‹¼u±_shadow
(
cu¼’t
);

1053 
hvmemul_ùxt
->
ùxt
.
»gs
 =„egs;

1054 
hvmemul_ùxt
->
ùxt
.
fÜû_wr™eback
 = 1;

1055 
hvmemul_ùxt
->
£g_»g_acûs£d
 = 0;

1056 
hvmemul_ùxt
->
£g_»g_dœty
 = 0;

1057 
	`hvmemul_g‘_£g_»g
(
x86_£g_cs
, 
hvmemul_ùxt
);

1058 
	`hvmemul_g‘_£g_»g
(
x86_£g_ss
, 
hvmemul_ùxt
);

1059 
	}
}

1061 
	$hvm_emuÏ‹_wr™eback
(

1062 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

1064 
x86_£gm’t
 
£g
;

1066 
£g
 = 
	`fšd_fœ¡_b™
(&
hvmemul_ùxt
->
£g_»g_dœty
,

1067 
	`ARRAY_SIZE
(
hvmemul_ùxt
->
£g_»g
));

1069  
£g
 < 
	`ARRAY_SIZE
(
hvmemul_ùxt
->
£g_»g
) )

1071 
	`hvm_£t_£gm’t_»gi¡”
(
cu¼’t
, 
£g
, &
hvmemul_ùxt
->
£g_»g
[seg]);

1072 
£g
 = 
	`fšd_Ãxt_b™
(&
hvmemul_ùxt
->
£g_»g_dœty
,

1073 
	`ARRAY_SIZE
(
hvmemul_ùxt
->
£g_»g
),

1074 
£g
+1);

1076 
	}
}

1078 
£gm’t_»gi¡”
 *
	$hvmemul_g‘_£g_»g
(

1079 
x86_£gm’t
 
£g
,

1080 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

1082 iàĞ!
	`__‹¡_ªd_£t_b™
(
£g
, &
hvmemul_ùxt
->
£g_»g_acûs£d
) )

1083 
	`hvm_g‘_£gm’t_»gi¡”
(
cu¼’t
, 
£g
, &
hvmemul_ùxt
->
£g_»g
[seg]);

1084  &
hvmemul_ùxt
->
£g_»g
[
£g
];

1085 
	}
}

	@hvm/hpet.c

20 
	~<asm/hvm/v±.h
>

21 
	~<asm/hvm/io.h
>

22 
	~<asm/hvm/suµÜt.h
>

23 
	~<asm/cu¼’t.h
>

24 
	~<x’/sched.h
>

25 
	~<x’/ev’t.h
>

27 
	#domaš_vh³t
(
x
è(&(x)->
¬ch
.
hvm_domaš
.
¶_time
.
vh³t
)

	)

28 
	#vıu_vh³t
(
x
è(
	`domaš_vh³t
((x)->
domaš
))

	)

29 
	#vh³t_domaš
(
x
è(
	`cÚš”_of
((x), 
domaš
, \

30 
¬ch
.
hvm_domaš
.
¶_time
.
vh³t
))

	)

31 
	#vh³t_vıu
(
x
è(
	`±_glob®_vıu_rg‘
(
	`vh³t_domaš
(x)))

	)

33 
	#HPET_BASE_ADDRESS
 0xãd00000ULL

	)

34 
	#HPET_MMAP_SIZE
 1024

	)

35 
	#S_TO_NS
 1000000000ULL

	)

36 
	#S_TO_FS
 1000000000000000ULL

	)

39 
	#STIME_PER_HPET_TICK
 16

	)

40 
	#gue¡_time_h³t
(
h³t
) \

41 (
	`hvm_g‘_gue¡_time
(
	`vh³t_vıu
(
h³t
)è/ 
STIME_PER_HPET_TICK
)

	)

43 
	#HPET_ID
 0x000

	)

44 
	#HPET_PERIOD
 0x004

	)

45 
	#HPET_CFG
 0x010

	)

46 
	#HPET_STATUS
 0x020

	)

47 
	#HPET_COUNTER
 0x0f0

	)

48 
	#HPET_T0_CFG
 0x100

	)

49 
	#HPET_T0_CMP
 0x108

	)

50 
	#HPET_T0_ROUTE
 0x110

	)

51 
	#HPET_T1_CFG
 0x120

	)

52 
	#HPET_T1_CMP
 0x128

	)

53 
	#HPET_T1_ROUTE
 0x130

	)

54 
	#HPET_T2_CFG
 0x140

	)

55 
	#HPET_T2_CMP
 0x148

	)

56 
	#HPET_T2_ROUTE
 0x150

	)

57 
	#HPET_T3_CFG
 0x160

	)

59 
	#HPET_CFG_ENABLE
 0x001

	)

60 
	#HPET_CFG_LEGACY
 0x002

	)

62 
	#HPET_TN_INT_TYPE_LEVEL
 0x002

	)

63 
	#HPET_TN_ENABLE
 0x004

	)

64 
	#HPET_TN_PERIODIC
 0x008

	)

65 
	#HPET_TN_PERIODIC_CAP
 0x010

	)

66 
	#HPET_TN_SIZE_CAP
 0x020

	)

67 
	#HPET_TN_SETVAL
 0x040

	)

68 
	#HPET_TN_32BIT
 0x100

	)

69 
	#HPET_TN_INT_ROUTE_MASK
 0x3e00

	)

70 
	#HPET_TN_INT_ROUTE_SHIFT
 9

	)

71 
	#HPET_TN_INT_ROUTE_CAP_SHIFT
 32

	)

72 
	#HPET_TN_CFG_BITS_READONLY_OR_RESERVED
 0xffff80b1U

	)

75 
	#HPET_TN_INT_ROUTE_CAP
 (0x00f00000ULL \

76 << 
HPET_TN_INT_ROUTE_CAP_SHIFT
)

	)

78 
	#HPET_TN_INT_ROUTE_CAP_MASK
 (0xffffffffULL \

79 << 
HPET_TN_INT_ROUTE_CAP_SHIFT
)

	)

81 
	#h³t_tick_to_ns
(
h
, 
tick
) \

82 ((
s_time_t
)((((
tick
è> (
h
)->
h³t_to_ns_lim™
) ? \

83 ~0ULL : (
tick
è* (
h
)->
h³t_to_ns_sÿË
è>> 10))

	)

85 
	#tim”_cÚfig
(
h
, 
n
è(h->
h³t
.
tim”s
[n].
cÚfig
)

	)

86 
	#tim”_’abËd
(
h
, 
n
è(
	`tim”_cÚfig
(h,‚è& 
HPET_TN_ENABLE
)

	)

87 
	#tim”_is_³riodic
(
h
, 
n
è(
	`tim”_cÚfig
(h,‚è& 
HPET_TN_PERIODIC
)

	)

88 
	#tim”_is_32b™
(
h
, 
n
è(
	`tim”_cÚfig
(h,‚è& 
HPET_TN_32BIT
)

	)

89 
	#h³t_’abËd
(
h
è(h->
h³t
.
cÚfig
 & 
HPET_CFG_ENABLE
)

	)

90 
	#tim”_Ëv–
(
h
, 
n
è(
	`tim”_cÚfig
(h,‚è& 
HPET_TN_INT_TYPE_LEVEL
)

	)

92 
	#tim”_št_rou‹
(
h
, 
n
) \

93 ((
	`tim”_cÚfig
(
h
, 
n
è& 
HPET_TN_INT_ROUTE_MASK
è>> 
HPET_TN_INT_ROUTE_SHIFT
)

	)

95 
	#tim”_št_rou‹_ÿp
(
h
, 
n
) \

96 ((
	`tim”_cÚfig
(
h
, 
n
è& 
HPET_TN_INT_ROUTE_CAP_MASK
) \

97 >> 
HPET_TN_INT_ROUTE_CAP_SHIFT
)

	)

99 
šlše
 
ušt64_t
 
	$h³t_»ad_mašcouÁ”
(
HPETS‹
 *
h
)

101 
	`ASSERT
(
	`¥š_is_locked
(&
h
->
lock
));

103 iàĞ
	`h³t_’abËd
(
h
) )

104  
	`gue¡_time_h³t
(
h
è+ h->
mc_off£t
;

106  
h
->
h³t
.
mc64
;

107 
	}
}

109 
ušt64_t
 
	$h³t_g‘_com·¿tÜ
(
HPETS‹
 *
h
, 
Š
)

111 
ušt64_t
 
com·¿tÜ
;

112 
ušt64_t
 
–­£d
;

114 
com·¿tÜ
 = 
h
->
h³t
.
com·¿tÜ64
[
Š
];

115 iàĞ
	`tim”_is_³riodic
(
h
, 
Š
) )

118 
ušt64_t
 
³riod
 = 
h
->
h³t
.³riod[
Š
];

119 ià(
³riod
)

121 
–­£d
 = 
	`h³t_»ad_mašcouÁ”
(
h
è+ 
³riod
 - 1 - 
com·¿tÜ
;

122 
com·¿tÜ
 +ğ(
–­£d
 / 
³riod
) *…eriod;

123 
h
->
h³t
.
com·¿tÜ64
[
Š
] = 
com·¿tÜ
;

128 iàĞ
	`tim”_is_32b™
(
h
, 
Š
) )

129 
com·¿tÜ
 = (
ušt32_t
)comparator;

130 
h
->
h³t
.
tim”s
[
Š
].
cmp
 = 
com·¿tÜ
;

131  
com·¿tÜ
;

132 
	}
}

133 
šlše
 
ušt64_t
 
	$h³t_»ad64
(
HPETS‹
 *
h
, 
addr
)

135 
addr
 &= ~7;

137  
addr
 )

139 
HPET_ID
:

140  
h
->
h³t
.
ÿ·b™y
;

141 
HPET_CFG
:

142  
h
->
h³t
.
cÚfig
;

143 
HPET_STATUS
:

144  
h
->
h³t
.
i¤
;

145 
HPET_COUNTER
:

146  
	`h³t_»ad_mašcouÁ”
(
h
);

147 
HPET_T0_CFG
:

148 
HPET_T1_CFG
:

149 
HPET_T2_CFG
:

150  
h
->
h³t
.
tim”s
[(
addr
 - 
HPET_T0_CFG
è>> 5].
cÚfig
;

151 
HPET_T0_CMP
:

152 
HPET_T1_CMP
:

153 
HPET_T2_CMP
:

154  
	`h³t_g‘_com·¿tÜ
(
h
, (
addr
 - 
HPET_T0_CMP
) >> 5);

155 
HPET_T0_ROUTE
:

156 
HPET_T1_ROUTE
:

157 
HPET_T2_ROUTE
:

158  
h
->
h³t
.
tim”s
[(
addr
 - 
HPET_T0_ROUTE
è>> 5].
fsb
;

162 
	}
}

164 
šlše
 
	$h³t_check_acûss_Ëngth
(

165 
addr
, 
Ën
)

167 iàĞ(
addr
 & (
Ën
 - 1)) || (len > 8) )

174 
	`gd´štk
(
XENLOG_WARNING
, "HPET:‡ccess‡cross„egister boundary: "

175 "%lx %lx\n", 
addr
, 
Ën
);

176  -
EINVAL
;

180 
	}
}

182 
	$h³t_»ad
(

183 
vıu
 *
v
, 
addr
, 
Ëngth
,

184 *
pv®
)

186 
HPETS‹
 *
h
 = 
	`vıu_vh³t
(
v
);

187 
»suÉ
;

188 
ušt64_t
 
v®
;

190 
addr
 &ğ
HPET_MMAP_SIZE
-1;

192 iàĞ
	`h³t_check_acûss_Ëngth
(
addr
, 
Ëngth
) != 0 )

194 
»suÉ
 = ~0ul;

195 
out
;

198 
	`¥š_lock
(&
h
->
lock
);

200 
v®
 = 
	`h³t_»ad64
(
h
, 
addr
);

202 
»suÉ
 = 
v®
;

203 iàĞ
Ëngth
 != 8 )

204 
»suÉ
 = (
v®
 >> ((
addr
 & 7è* 8)è& ((1ULL << (
Ëngth
 * 8)) - 1);

206 
	`¥š_uÆock
(&
h
->
lock
);

208 
out
:

209 *
pv®
 = 
»suÉ
;

210  
X86EMUL_OKAY
;

211 
	}
}

213 
	$h³t_¡İ_tim”
(
HPETS‹
 *
h
, 
Š
)

215 
	`ASSERT
(
Š
 < 
HPET_TIMER_NUM
);

216 
	`ASSERT
(
	`¥š_is_locked
(&
h
->
lock
));

217 
	`de¡roy_³riodic_time
(&
h
->
±
[
Š
]);

220 
	`h³t_g‘_com·¿tÜ
(
h
, 
Š
);

221 
	}
}

225 
	#HPET_TINY_TIME_SPAN
 ((
h
->
¡ime_äeq
 >> 10è/ 
STIME_PER_HPET_TICK
)

	)

227 
	$h³t_£t_tim”
(
HPETS‹
 *
h
, 
Š
)

229 
ušt64_t
 
Š_cmp
, 
cur_tick
, 
diff
;

230 
œq
;

231 
ÚeshÙ
;

233 
	`ASSERT
(
Š
 < 
HPET_TIMER_NUM
);

234 
	`ASSERT
(
	`¥š_is_locked
(&
h
->
lock
));

236 iàĞ(
Š
 =ğ0è&& (
h
->
h³t
.
cÚfig
 & 
HPET_CFG_LEGACY
) )

240 
PITS‹
 *
p™
 = &
	`vh³t_domaš
(
h
)->
¬ch
.
hvm_domaš
.
¶_time
.
vp™
;

241 
	`p™_¡İ_chªÃl0_œq
(
p™
);

244 iàĞ!
	`tim”_’abËd
(
h
, 
Š
) )

247 
Š_cmp
 = 
	`h³t_g‘_com·¿tÜ
(
h
, 
Š
);

248 
cur_tick
 = 
	`h³t_»ad_mašcouÁ”
(
h
);

249 iàĞ
	`tim”_is_32b™
(
h
, 
Š
) )

251 
Š_cmp
 = (
ušt32_t
)tn_cmp;

252 
cur_tick
 = (
ušt32_t
)cur_tick;

255 
diff
 = 
Š_cmp
 - 
cur_tick
;

263 iàĞ(
št64_t
)
diff
 < 0 )

264 
diff
 = (
	`tim”_is_32b™
(
h
, 
Š
è&& (-difà> 
HPET_TINY_TIME_SPAN
))

265 ? (
ušt32_t
)
diff
 : 0;

267 iàĞ(
Š
 <ğ1è&& (
h
->
h³t
.
cÚfig
 & 
HPET_CFG_LEGACY
) )

271 
œq
 = (
Š
 == 0) ? 0 : 8;

273 
œq
 = 
	`tim”_št_rou‹
(
h
, 
Š
);

281 
ÚeshÙ
 = !
	`tim”_is_³riodic
(
h
, 
Š
);

282 
	`ü—‹_³riodic_time
(
	`vh³t_vıu
(
h
), &h->
±
[
Š
],

283 
	`h³t_tick_to_ns
(
h
, 
diff
),

284 
ÚeshÙ
 ? 0 : 
	`h³t_tick_to_ns
(
h
, h->
h³t
.
³riod
[
Š
]),

285 
œq
, 
NULL
, NULL);

286 
	}
}

288 
šlše
 
ušt64_t
 
	$h³t_fixup_»g
(

289 
ušt64_t
 
Ãw
, ušt64_ˆ
Şd
, ušt64_ˆ
mask
)

291 
Ãw
 &ğ
mask
;

292 
Ãw
 |ğ
Şd
 & ~
mask
;

293  
Ãw
;

294 
	}
}

296 
	$h³t_wr™e
(

297 
vıu
 *
v
, 
addr
,

298 
Ëngth
, 
v®
)

300 
HPETS‹
 *
h
 = 
	`vıu_vh³t
(
v
);

301 
ušt64_t
 
Şd_v®
, 
Ãw_v®
;

302 
Š
, 
i
;

305 
¡¬t_tim”s
 = 0;

306 
¡İ_tim”s
 = 0;

307 
	#£t_¡İ_tim”
(
n
è(
	`__£t_b™
(Ò), &
¡İ_tim”s
))

	)

308 
	#£t_¡¬t_tim”
(
n
è(
	`__£t_b™
(Ò), &
¡¬t_tim”s
))

	)

309 
	#£t_»¡¬t_tim”
(
n
è(
	`£t_¡İ_tim”
Ò),
	`£t_¡¬t_tim”
Ò))

	)

311 
addr
 &ğ
HPET_MMAP_SIZE
-1;

313 iàĞ
	`h³t_check_acûss_Ëngth
(
addr
, 
Ëngth
) != 0 )

314 
out
;

316 
	`¥š_lock
(&
h
->
lock
);

318 
Şd_v®
 = 
	`h³t_»ad64
(
h
, 
addr
);

319 
Ãw_v®
 = 
v®
;

320 iàĞ
Ëngth
 != 8 )

321 
Ãw_v®
 = 
	`h³t_fixup_»g
(

322 
Ãw_v®
 << (
addr
 & 7è* 8, 
Şd_v®
,

323 ((1ULL << (
Ëngth
*8)è- 1è<< ((
addr
 & 7) * 8));

325  
addr
 & ~7 )

327 
HPET_CFG
:

328 
h
->
h³t
.
cÚfig
 = 
	`h³t_fixup_»g
(
Ãw_v®
, 
Şd_v®
, 0x3);

330 iàĞ!(
Şd_v®
 & 
HPET_CFG_ENABLE
è&& (
Ãw_v®
 & HPET_CFG_ENABLE) )

333 
h
->
mc_off£t
 = h->
h³t
.
mc64
 - 
	`gue¡_time_h³t
(h);

334  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

336 
h
->
h³t
.
com·¿tÜ64
[
i
] =

337 
h
->
h³t
.
tim”s
[
i
].
cÚfig
 & 
HPET_TN_32BIT
 ?

338 (
ušt32_t
)
h
->
h³t
.
tim”s
[
i
].
cmp
 :

339 
h
->
h³t
.
tim”s
[
i
].
cmp
;

340 iàĞ
	`tim”_’abËd
(
h
, 
i
) )

341 
	`£t_¡¬t_tim”
(
i
);

344 iàĞ(
Şd_v®
 & 
HPET_CFG_ENABLE
è&& !(
Ãw_v®
 & HPET_CFG_ENABLE) )

347 
h
->
h³t
.
mc64
 = h->
mc_off£t
 + 
	`gue¡_time_h³t
(h);

348  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

349 iàĞ
	`tim”_’abËd
(
h
, 
i
) )

350 
	`£t_¡İ_tim”
(
i
);

354 
HPET_COUNTER
:

355 
h
->
h³t
.
mc64
 = 
Ãw_v®
;

356 iàĞ
	`h³t_’abËd
(
h
) )

358 
	`gd´štk
(
XENLOG_WARNING
,

360  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

361 iàĞ
	`tim”_’abËd
(
h
, 
i
) )

362 
	`£t_»¡¬t_tim”
(
i
);

366 
HPET_T0_CFG
:

367 
HPET_T1_CFG
:

368 
HPET_T2_CFG
:

369 
Š
 = (
addr
 - 
HPET_T0_CFG
) >> 5;

371 
h
->
h³t
.
tim”s
[
Š
].
cÚfig
 = 
	`h³t_fixup_»g
(
Ãw_v®
, 
Şd_v®
, 0x3f4e);

373 iàĞ
	`tim”_Ëv–
(
h
, 
Š
) )

375 
	`gd´štk
(
XENLOG_ERR
,

377 
	`domaš_üash
(
cu¼’t
->
domaš
);

381 iàĞ
Ãw_v®
 & 
HPET_TN_32BIT
 )

383 
h
->
h³t
.
tim”s
[
Š
].
cmp
 = (
ušt32_t
)h->hpet.timers[tn].cmp;

384 
h
->
h³t
.
³riod
[
Š
] = (
ušt32_t
)h->hpet.period[tn];

386 iàĞ
	`h³t_’abËd
(
h
) )

388 iàĞ
Ãw_v®
 & 
HPET_TN_ENABLE
 )

390 iàĞ(
Ãw_v®
 ^ 
Şd_v®
è& 
HPET_TN_PERIODIC
 )

394 
	`£t_»¡¬t_tim”
(
Š
);

395 iàĞ(
Ãw_v®
 & 
HPET_TN_32BIT
) &&

396 !(
Şd_v®
 & 
HPET_TN_32BIT
) )

399 
	`£t_»¡¬t_tim”
(
Š
);

400 iàĞ!(
Şd_v®
 & 
HPET_TN_ENABLE
) )

402 
	`£t_¡¬t_tim”
(
Š
);

404 iàĞ
Şd_v®
 & 
HPET_TN_ENABLE
 )

406 
	`£t_¡İ_tim”
(
Š
);

410 
HPET_T0_CMP
:

411 
HPET_T1_CMP
:

412 
HPET_T2_CMP
:

413 
Š
 = (
addr
 - 
HPET_T0_CMP
) >> 5;

414 iàĞ
	`tim”_is_32b™
(
h
, 
Š
) )

415 
Ãw_v®
 = (
ušt32_t
)new_val;

416 
h
->
h³t
.
tim”s
[
Š
].
cmp
 = 
Ãw_v®
;

417 iàĞ
h
->
h³t
.
tim”s
[
Š
].
cÚfig
 & 
HPET_TN_SETVAL
 )

426 
h
->
h³t
.
tim”s
[
Š
].
cÚfig
 &ğ~
HPET_TN_SETVAL
;

427 iàĞ
	`tim”_is_³riodic
(
h
, 
Š
) )

434 iàĞ
	`h³t_tick_to_ns
(
h
, 
Ãw_v®
è< 
	`MICROSECS
(100) )

435 
Ãw_v®
 = (
	`MICROSECS
(100è<< 10è/ 
h
->
h³t_to_ns_sÿË
;

436 
Ãw_v®
 &ğ(
	`tim”_is_32b™
(
h
, 
Š
) ? ~0u : ~0ull) >> 1;

437 
h
->
h³t
.
³riod
[
Š
] = 
Ãw_v®
;

439 
h
->
h³t
.
com·¿tÜ64
[
Š
] = 
Ãw_v®
;

440 iàĞ
	`h³t_’abËd
(
h
è&& 
	`tim”_’abËd
(h, 
Š
) )

441 
	`£t_»¡¬t_tim”
(
Š
);

444 
HPET_T0_ROUTE
:

445 
HPET_T1_ROUTE
:

446 
HPET_T2_ROUTE
:

447 
Š
 = (
addr
 - 
HPET_T0_ROUTE
) >> 5;

448 
h
->
h³t
.
tim”s
[
Š
].
fsb
 = 
Ãw_v®
;

457 
¡İ_tim”s
)

459 
i
 = 
	`fšd_fœ¡_£t_b™
(
¡İ_tim”s
);

460 
	`__ş—r_b™
(
i
, &
¡İ_tim”s
);

461 
	`h³t_¡İ_tim”
(
h
, 
i
);

464 
¡¬t_tim”s
)

466 
i
 = 
	`fšd_fœ¡_£t_b™
(
¡¬t_tim”s
);

467 
	`__ş—r_b™
(
i
, &
¡¬t_tim”s
);

468 
	`h³t_£t_tim”
(
h
, 
i
);

471 #undeà
£t_¡İ_tim”


472 #undeà
£t_¡¬t_tim”


473 #undeà
£t_»¡¬t_tim”


475 
	`¥š_uÆock
(&
h
->
lock
);

477 
out
:

478  
X86EMUL_OKAY
;

479 
	}
}

481 
	$h³t_¿nge
(
vıu
 *
v
, 
addr
)

483  (
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_HPET_ENABLED
] &&

484 (
addr
 >ğ
HPET_BASE_ADDRESS
) &&

485 (
addr
 < (
HPET_BASE_ADDRESS
 + 
HPET_MMAP_SIZE
)));

486 
	}
}

488 cÚ¡ 
hvm_mmio_hªdËr
 
	gh³t_mmio_hªdËr
 = {

489 .
check_hªdËr
 = 
h³t_¿nge
,

490 .
	g»ad_hªdËr
 = 
h³t_»ad
,

491 .
	gwr™e_hªdËr
 = 
h³t_wr™e


495 
	$h³t_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

497 
HPETS‹
 *
hp
 = 
	`domaš_vh³t
(
d
);

498 
rc
;

500 
	`¥š_lock
(&
hp
->
lock
);

503 
hp
->
h³t
.
mc64
 = hp->
mc_off£t
 + 
	`gue¡_time_h³t
(hp);

506 
rc
 = 
	`_hvm_š™_’Œy
(
h
, 
	`HVM_SAVE_CODE
(
HPET
), 0, 
	`HVM_SAVE_LENGTH
(HPET));

507 iàĞ
rc
 == 0 )

509 
hvm_hw_h³t
 *
»c
 = (hvm_hw_h³ˆ*)&
h
->
d©a
[h->
cur
];

510 
h
->
cur
 +ğ
	`HVM_SAVE_LENGTH
(
HPET
);

511 
	`mem£t
(
»c
, 0, 
	`HVM_SAVE_LENGTH
(
HPET
));

512 
	#C
(
x
è
»c
->x = 
hp
->
h³t
.
	)
x

513 
	`C
(
ÿ·b™y
);

514 
	`C
(
cÚfig
);

515 
	`C
(
i¤
);

516 
	`C
(
mc64
);

517 
	`C
(
tim”s
[0].
cÚfig
);

518 
	`C
(
tim”s
[0].
fsb
);

519 
	`C
(
tim”s
[1].
cÚfig
);

520 
	`C
(
tim”s
[1].
fsb
);

521 
	`C
(
tim”s
[2].
cÚfig
);

522 
	`C
(
tim”s
[2].
fsb
);

523 
	`C
(
³riod
[0]);

524 
	`C
(
³riod
[1]);

525 
	`C
(
³riod
[2]);

526 #undeà
C


529 
»c
->
tim”s
[0].
cmp
 = 
hp
->
h³t
.
com·¿tÜ64
[0];

530 
»c
->
tim”s
[1].
cmp
 = 
hp
->
h³t
.
com·¿tÜ64
[1];

531 
»c
->
tim”s
[2].
cmp
 = 
hp
->
h³t
.
com·¿tÜ64
[2];

534 
	`¥š_uÆock
(&
hp
->
lock
);

536  
rc
;

537 
	}
}

539 
	$h³t_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

541 
HPETS‹
 *
hp
 = 
	`domaš_vh³t
(
d
);

542 
hvm_hw_h³t
 *
»c
;

543 
ušt64_t
 
cmp
;

544 
i
;

546 
	`¥š_lock
(&
hp
->
lock
);

549 iàĞ
	`_hvm_check_’Œy
(
h
, 
	`HVM_SAVE_CODE
(
HPET
), 
	`HVM_SAVE_LENGTH
(HPET), 1) )

551 
	`¥š_uÆock
(&
hp
->
lock
);

552  -
EINVAL
;

555 
»c
 = (
hvm_hw_h³t
 *)&
h
->
d©a
[h->
cur
];

556 
h
->
cur
 +ğ
	`HVM_SAVE_LENGTH
(
HPET
);

558 
	#C
(
x
è
hp
->
h³t
.x = 
»c
->
	)
x

559 
	`C
(
ÿ·b™y
);

560 
	`C
(
cÚfig
);

561 
	`C
(
i¤
);

562 
	`C
(
mc64
);

565 
	#HPET_TIMER_NUM
 3

	)

566  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

568 
	`C
(
tim”s
[
i
].
cÚfig
);

569 
	`C
(
tim”s
[
i
].
fsb
);

570 
	`C
(
³riod
[
i
]);

573 
cmp
 = 
»c
->
tim”s
[
i
].cmp;

574 
hp
->
h³t
.
com·¿tÜ64
[
i
] = 
cmp
;

575 iàĞ
	`tim”_is_32b™
(
hp
, 
i
) )

576 
cmp
 = (
ušt32_t
)cmp;

577 
hp
->
h³t
.
tim”s
[
i
].
cmp
 = cmp;

579 #undeà
C


582 
hp
->
mc_off£t
 = hp->
h³t
.
mc64
 - 
	`gue¡_time_h³t
(hp);

586 iàĞ
	`h³t_’abËd
(
hp
) )

587  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

588 iàĞ
	`tim”_’abËd
(
hp
, 
i
) )

589 
	`h³t_£t_tim”
(
hp
, 
i
);

591 
	`¥š_uÆock
(&
hp
->
lock
);

594 
	}
}

596 
HVM_REGISTER_SAVE_RESTORE
(
HPET
, 
h³t_§ve
, 
h³t_lßd
, 1, 
HVMSR_PER_DOM
);

598 
	$h³t_š™
(
vıu
 *
v
)

600 
HPETS‹
 *
h
 = 
	`vıu_vh³t
(
v
);

601 
i
;

603 
	`mem£t
(
h
, 0, (
HPETS‹
));

605 
	`¥š_lock_š™
(&
h
->
lock
);

607 
h
->
¡ime_äeq
 = 
S_TO_NS
;

609 
h
->
h³t_to_ns_sÿË
 = ((
S_TO_NS
 * 
STIME_PER_HPET_TICK
è<< 10è/ h->
¡ime_äeq
;

610 
h
->
h³t_to_ns_lim™
 = ~0ULL / h->
h³t_to_ns_sÿË
;

613 
h
->
h³t
.
ÿ·b™y
 = 0x8086A201ULL;

617 
h
->
h³t
.
ÿ·b™y
 |ğ((
S_TO_FS
*
STIME_PER_HPET_TICK
/h->
¡ime_äeq
) << 32);

619  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

621 
h
->
h³t
.
tim”s
[
i
].
cÚfig
 =

622 
HPET_TN_INT_ROUTE_CAP
 | 
HPET_TN_SIZE_CAP
 | 
HPET_TN_PERIODIC_CAP
;

623 
h
->
h³t
.
tim”s
[
i
].
cmp
 = ~0ULL;

624 
h
->
±
[
i
].
sourû
 = 
PTSRC_i§
;

626 
	}
}

628 
	$h³t_deš™
(
domaš
 *
d
)

630 
i
;

631 
HPETS‹
 *
h
 = 
	`domaš_vh³t
(
d
);

633 
	`¥š_lock
(&
h
->
lock
);

635 iàĞ
	`h³t_’abËd
(
h
) )

636  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

637 iàĞ
	`tim”_’abËd
(
h
, 
i
) )

638 
	`h³t_¡İ_tim”
(
h
, 
i
);

640 
	`¥š_uÆock
(&
h
->
lock
);

641 
	}
}

643 
	$h³t_»£t
(
domaš
 *
d
)

645 
	`h³t_deš™
(
d
);

646 
	`h³t_š™
(
d
->
vıu
[0]);

647 
	}
}

	@hvm/hvm.c

22 
	~<x’/cÚfig.h
>

23 
	~<x’/ùy³.h
>

24 
	~<x’/š™.h
>

25 
	~<x’/lib.h
>

26 
	~<x’/Œaû.h
>

27 
	~<x’/sched.h
>

28 
	~<x’/œq.h
>

29 
	~<x’/soáœq.h
>

30 
	~<x’/domaš.h
>

31 
	~<x’/domaš_·ge.h
>

32 
	~<x’/hy³rÿÎ.h
>

33 
	~<x’/gue¡_acûss.h
>

34 
	~<x’/ev’t.h
>

35 
	~<x’/·gšg.h
>

36 
	~<x’/ıu.h
>

37 
	~<x’/wa™.h
>

38 
	~<asm/shadow.h
>

39 
	~<asm/h­.h
>

40 
	~<asm/cu¼’t.h
>

41 
	~<asm/e820.h
>

42 
	~<asm/io.h
>

43 
	~<asm/»gs.h
>

44 
	~<asm/ıuã©u».h
>

45 
	~<asm/´oûssÜ.h
>

46 
	~<asm/ty³s.h
>

47 
	~<asm/m¤.h
>

48 
	~<asm/i387.h
>

49 
	~<asm/Œ­s.h
>

50 
	~<asm/mc146818¹c.h
>

51 
	~<asm/¥šlock.h
>

52 
	~<asm/mû.h
>

53 
	~<asm/hvm/hvm.h
>

54 
	~<asm/hvm/v±.h
>

55 
	~<asm/hvm/suµÜt.h
>

56 
	~<asm/hvm/ÿch—‰r.h
>

57 
	~<asm/hvm/Œaû.h
>

58 
	~<asm/mŒr.h
>

59 
	~<asm/­ic.h
>

60 
	~<public/sched.h
>

61 
	~<public/hvm/iÜeq.h
>

62 
	~<public/v”siÚ.h
>

63 
	~<public/memÜy.h
>

64 
	~<asm/mem_ev’t.h
>

65 
	~<public/mem_ev’t.h
>

67 
boŞ_t
 
__»ad_mo¡ly
 
	ghvm_’abËd
;

69 
İt_hvm_debug_Ëv–
 
	g__»ad_mo¡ly
;

70 
š‹g”_·¿m
("hvm_debug", 
İt_hvm_debug_Ëv–
);

72 
hvm_funùiÚ_bË
 
hvm_funcs
 
	g__»ad_mo¡ly
;

75 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

76 
	ghvm_io_b™m­
[3*
PAGE_SIZE
/
BYTES_PER_LONG
];

78 
	$ıu_ÿÎback
(

79 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

81 
ıu
 = ()
hıu
;

82 
rc
 = 0;

84  
aùiÚ
 )

86 
CPU_UP_PREPARE
:

87 
rc
 = 
hvm_funcs
.
	`ıu_up_´•¬e
(
ıu
);

89 
CPU_DYING
:

90 
	`hvm_ıu_down
();

92 
CPU_UP_CANCELED
:

93 
CPU_DEAD
:

94 
hvm_funcs
.
	`ıu_d—d
(
ıu
);

100  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

101 
	}
}

103 
nÙif›r_block
 
	gıu_nfb
 = {

104 .
nÙif›r_ÿÎ
 = 
ıu_ÿÎback


107 
__š™
 
	$hvm_’abË
()

109 
hvm_funùiÚ_bË
 *
	`¡¬t_svm
();

110 
hvm_funùiÚ_bË
 *
	`¡¬t_vmx
();

111 
hvm_pÜt80_®lowed
;

113 
hvm_funùiÚ_bË
 *
âs
 = 
NULL
;

115  
boÙ_ıu_d©a
.
x86_v’dÜ
 )

117 
X86_VENDOR_INTEL
:

118 
âs
 = 
	`¡¬t_vmx
();

120 
X86_VENDOR_AMD
:

121 
âs
 = 
	`¡¬t_svm
();

127 iàĞ
âs
 =ğ
NULL
 )

130 
hvm_funcs
 = *
âs
;

131 
hvm_’abËd
 = 1;

133 
	`´štk
("HVM: % ’abËd\n", 
hvm_funcs
.
Çme
);

134 iàĞ
hvm_funcs
.
h­_suµÜ‹d
 )

135 
	`´štk
("HVM: Hardware Assisted Paging detected.\n");

141 
	`mem£t
(
hvm_io_b™m­
, ~0, (hvm_io_bitmap));

142 iàĞ
hvm_pÜt80_®lowed
 )

143 
	`__ş—r_b™
(0x80, 
hvm_io_b™m­
);

144 
	`__ş—r_b™
(0xed, 
hvm_io_b™m­
);

146 
	`»gi¡”_ıu_nÙif›r
(&
ıu_nfb
);

149 
	}
}

150 
´esmp_š™ÿÎ
(
hvm_’abË
);

158 
	$hvm_ev’t_Ãeds_»šjeùiÚ
(
ušt8_t
 
ty³
, ušt8_ˆ
veùÜ
)

160  
ty³
 )

162 
X86_EVENTTYPE_EXT_INTR
:

163 
X86_EVENTTYPE_NMI
:

165 
X86_EVENTTYPE_HW_EXCEPTION
:

171  (
veùÜ
 != 3) && (vector != 4);

177 
	}
}

183 
ušt8_t
 
	$hvm_combše_hw_exû±iÚs
(
ušt8_t
 
vec1
, ušt8_ˆ
vec2
)

186 iàĞ
vec1
 =ğ
TRAP_doubË_çuÉ
 )

188 
	`hvm_ŒË_çuÉ
();

189  
TRAP_doubË_çuÉ
;

193 iàĞ
vec1
 =ğ
TRAP_·ge_çuÉ
 )

194  
TRAP_doubË_çuÉ
;

197 iàĞ!((1u << 
vec1
è& 0x7c01uè|| (
vec2
 =ğ
TRAP_·ge_çuÉ
) )

198  
vec2
;

201  
TRAP_doubË_çuÉ
;

202 
	}
}

204 
	$hvm_£t_rdtsc_ex™šg
(
domaš
 *
d
, 
boŞ_t
 
’abË
)

206 
vıu
 *
v
;

208 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

209 
hvm_funcs
.
	`£t_rdtsc_ex™šg
(
v
, 
’abË
);

210 
	}
}

212 
	$hvm_£t_gue¡_tsc
(
vıu
 *
v
, 
u64
 
gue¡_tsc
)

214 
ušt64_t
 
tsc
;

216 iàĞ
v
->
domaš
->
¬ch
.
vtsc
 )

218 
tsc
 = 
	`hvm_g‘_gue¡_time
(
v
);

219 
tsc
 = 
	`gtime_to_gtsc
(
v
->
domaš
,sc);

223 
	`rdtsşl
(
tsc
);

226 
v
->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
 = 
gue¡_tsc
 - 
tsc
;

227 
hvm_funcs
.
	`£t_tsc_off£t
(
v
, v->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
);

228 
	}
}

230 
u64
 
	$hvm_g‘_gue¡_tsc
(
vıu
 *
v
)

232 
ušt64_t
 
tsc
;

234 iàĞ
v
->
domaš
->
¬ch
.
vtsc
 )

236 
tsc
 = 
	`hvm_g‘_gue¡_time
(
v
);

237 
tsc
 = 
	`gtime_to_gtsc
(
v
->
domaš
,sc);

238 
v
->
domaš
->
¬ch
.
vtsc_k”ncouÁ
++;

242 
	`rdtsşl
(
tsc
);

245  
tsc
 + 
v
->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
;

246 
	}
}

248 
	$hvm_mig¿‹_tim”s
(
vıu
 *
v
)

250 
	`¹c_mig¿‹_tim”s
(
v
);

251 
	`±_mig¿‹
(
v
);

252 
	}
}

254 
	$hvm_mig¿‹_pœqs
(
vıu
 *
v
)

256 
pœq
, 
œq
;

257 
œq_desc
 *
desc
;

258 
domaš
 *
d
 = 
v
->domain;

259 
hvm_œq_dpci
 *hvm_œq_dpc˜ğ
d
->
¬ch
.
hvm_domaš
.
œq
.
dpci
;

261 iàĞ!
iommu_’abËd
 || (
hvm_œq_dpci
 =ğ
NULL
) )

264 
	`¥š_lock
(&
d
->
ev’t_lock
);

265  
pœq
 = 
	`fšd_fœ¡_b™
(
hvm_œq_dpci
->
m­pšg
, 
d
->
Ä_pœqs
);

266 
pœq
 < 
d
->
Ä_pœqs
;

267 
pœq
 = 
	`fšd_Ãxt_b™
(
hvm_œq_dpci
->
m­pšg
, 
d
->
Ä_pœqs
,…irq + 1) )

269 iàĞ!(
hvm_œq_dpci
->
mœq
[
pœq
].
æags
 & 
HVM_IRQ_DPCI_MACH_MSI
) ||

270 (
hvm_œq_dpci
->
mœq
[
pœq
].
gmsi
.
de¡_vıu_id
 !ğ
v
->
vıu_id
) )

272 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
v
->
domaš
, 
pœq
, 
NULL
);

273 ià(!
desc
)

275 
œq
 = 
desc
 - 
œq_desc
;

276 
	`ASSERT
(
	`MSI_IRQ
(
œq
));

277 
	`œq_£t_affš™y
(
desc
, 
	`ıumask_of
(
v
->
´oûssÜ
));

278 
	`¥š_uÆock_œq
(&
desc
->
lock
);

280 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

281 
	}
}

283 
	$hvm_do_»sume
(
vıu
 *
v
)

285 
iÜeq_t
 *
p
;

287 
	`±_»¡Üe_tim”
(
v
);

289 
	`check_wakeup_äom_wa™
();

292 
p
 = 
	`g‘_iÜeq
(
v
);

293  
p
->
¡©e
 !ğ
STATE_IOREQ_NONE
 )

295  
p
->
¡©e
 )

297 
STATE_IORESP_READY
:

298 
	`hvm_io_assi¡
();

300 
STATE_IOREQ_READY
:

301 
STATE_IOREQ_INPROCESS
:

302 
	`wa™_Ú_x’_ev’t_chªÃl
(
v
->
¬ch
.
hvm_vıu
.
x’_pÜt
,

303 (
p
->
¡©e
 !ğ
STATE_IOREQ_READY
) &&

304 (
p
->
¡©e
 !ğ
STATE_IOREQ_INPROCESS
));

307 
	`gd´štk
(
XENLOG_ERR
, "Weœd HVM iÜeque¡ s‹ %d.\n", 
p
->
¡©e
);

308 
	`domaš_üash
(
v
->
domaš
);

314 ià(
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
 != -1)

316 
	`hvm_šjeù_exû±iÚ
(
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
,

317 
v
->
¬ch
.
hvm_vıu
.
šjeù_”rÜ_code
,

318 
v
->
¬ch
.
hvm_vıu
.
šjeù_ü2
);

319 
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
 = -1;

321 
	}
}

323 
	$hvm_š™_iÜeq_·ge
(

324 
domaš
 *
d
, 
hvm_iÜeq_·ge
 *
iÜp
)

326 
	`mem£t
(
iÜp
, 0, (*iorp));

327 
	`¥š_lock_š™
(&
iÜp
->
lock
);

328 
	`domaš_·u£
(
d
);

329 
	}
}

331 
	$hvm_de¡roy_iÜeq_·ge
(

332 
domaš
 *
d
, 
hvm_iÜeq_·ge
 *
iÜp
)

334 
	`¥š_lock
(&
iÜp
->
lock
);

336 
	`ASSERT
(
d
->
is_dyšg
);

338 iàĞ
iÜp
->
va
 !ğ
NULL
 )

340 
	`unm­_domaš_·ge_glob®
(
iÜp
->
va
);

341 
	`put_·ge_ªd_ty³
(
iÜp
->
·ge
);

342 
iÜp
->
va
 = 
NULL
;

345 
	`¥š_uÆock
(&
iÜp
->
lock
);

346 
	}
}

348 
	$hvm_£t_iÜeq_·ge
(

349 
domaš
 *
d
, 
hvm_iÜeq_·ge
 *
iÜp
, 
gmâ
)

351 
·ge_šfo
 *
·ge
;

352 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

353 
p2m_ty³_t
 
p2mt
;

354 
mâ
;

355 *
va
;

357 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ_unsh¬e
(
p2m
, 
gmâ
, &
p2mt
, 0));

358 iàĞ!
	`p2m_is_¿m
(
p2mt
) )

359  -
EINVAL
;

360 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

362 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
gmâ
);

363  -
ENOENT
;

365 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

366  -
ENOENT
;

367 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

369 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

370 iàĞ!
	`g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_wr™abË_·ge
) )

371  -
EINVAL
;

373 
va
 = 
	`m­_domaš_·ge_glob®
(
mâ
);

374 iàĞ
va
 =ğ
NULL
 )

376 
	`put_·ge_ªd_ty³
(
·ge
);

377  -
ENOMEM
;

380 
	`¥š_lock
(&
iÜp
->
lock
);

382 iàĞ(
iÜp
->
va
 !ğ
NULL
è|| 
d
->
is_dyšg
 )

384 
	`¥š_uÆock
(&
iÜp
->
lock
);

385 
	`unm­_domaš_·ge_glob®
(
va
);

386 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

387  -
EINVAL
;

390 
iÜp
->
va
 = va;

391 
iÜp
->
·ge
 =…age;

393 
	`¥š_uÆock
(&
iÜp
->
lock
);

395 
	`domaš_uÅau£
(
d
);

398 
	}
}

400 
	$hvm_´št_lše
(

401 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

403 
vıu
 *
cu¼
 = 
cu¼’t
;

404 
hvm_domaš
 *
hd
 = &
cu¼
->
domaš
->
¬ch
.hvm_domain;

405 
c
 = *
v®
;

407 
	`BUG_ON
(
by‹s
 != 1);

410 iàĞ!
	`i¥ršt
(
c
) && (c != '\n') && (c != '\t') )

411  
X86EMUL_OKAY
;

413 
	`¥š_lock
(&
hd
->
pbuf_lock
);

414 
hd
->
pbuf
[hd->
pbuf_idx
++] = 
c
;

415 iàĞ(
hd
->
pbuf_idx
 =ğ((hd->
pbuf
è- 2)è|| (
c
 == '\n') )

417 iàĞ
c
 != '\n' )

418 
hd
->
pbuf
[hd->
pbuf_idx
++] = '\n';

419 
hd
->
pbuf
[hd->
pbuf_idx
] = '\0';

420 
	`´štk
(
XENLOG_G_DEBUG
 "HVM%u: %s", 
cu¼
->
domaš
->
domaš_id
, 
hd
->
pbuf
);

421 
hd
->
pbuf_idx
 = 0;

423 
	`¥š_uÆock
(&
hd
->
pbuf_lock
);

425  
X86EMUL_OKAY
;

426 
	}
}

428 
	$hvm_domaš_š™Ÿli£
(
domaš
 *
d
)

430 
rc
;

432 iàĞ!
hvm_’abËd
 )

434 
	`gd´štk
(
XENLOG_WARNING
, "Attempto create‡ HVM guest "

436  -
EINVAL
;

439 
	`¥š_lock_š™
(&
d
->
¬ch
.
hvm_domaš
.
pbuf_lock
);

440 
	`¥š_lock_š™
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

441 
	`¥š_lock_š™
(&
d
->
¬ch
.
hvm_domaš
.
uc_lock
);

443 
	`INIT_LIST_HEAD
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
);

444 
	`¥š_lock_š™
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

446 
	`hvm_š™_gue¡_time
(
d
);

448 
d
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_HPET_ENABLED
] = 1;

450 
	`hvm_š™_ÿch—‰r_»giÚ_li¡
(
d
);

452 
rc
 = 
	`·gšg_’abË
(
d
, 
PG_»fcouÁs
|
PG_Œª¦©e
|
PG_ex‹º®
);

453 iàĞ
rc
 != 0 )

454 
ç1
;

456 
	`vpic_š™
(
d
);

458 
rc
 = 
	`vißpic_š™
(
d
);

459 iàĞ
rc
 != 0 )

460 
ç1
;

462 
	`¡dvga_š™
(
d
);

464 
	`¹c_š™
(
d
);

466 
	`hvm_š™_iÜeq_·ge
(
d
, &d->
¬ch
.
hvm_domaš
.
iÜeq
);

467 
	`hvm_š™_iÜeq_·ge
(
d
, &d->
¬ch
.
hvm_domaš
.
buf_iÜeq
);

469 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0xe9, 1, 
hvm_´št_lše
);

471 
rc
 = 
hvm_funcs
.
	`domaš_š™Ÿli£
(
d
);

472 iàĞ
rc
 != 0 )

473 
ç2
;

477 
ç2
:

478 
	`¹c_deš™
(
d
);

479 
	`¡dvga_deš™
(
d
);

480 
	`vißpic_deš™
(
d
);

481 
ç1
:

482 
	`hvm_de¡roy_ÿch—‰r_»giÚ_li¡
(
d
);

483  
rc
;

484 
	}
}

486 
msixtbl_±_ş—nup
(
domaš
 *
d
);

488 
	$hvm_domaš_»lšquish_»sourûs
(
domaš
 *
d
)

490 
	`hvm_de¡roy_iÜeq_·ge
(
d
, &d->
¬ch
.
hvm_domaš
.
iÜeq
);

491 
	`hvm_de¡roy_iÜeq_·ge
(
d
, &d->
¬ch
.
hvm_domaš
.
buf_iÜeq
);

493 
	`msixtbl_±_ş—nup
(
d
);

496 
	`¹c_deš™
(
d
);

497 iàĞ
d
->
vıu
 !ğ
NULL
 && d->vcpu[0] != NULL )

499 
	`p™_deš™
(
d
);

500 
	`pmtim”_deš™
(
d
);

501 
	`h³t_deš™
(
d
);

503 
	}
}

505 
	$hvm_domaš_de¡roy
(
domaš
 *
d
)

507 
hvm_funcs
.
	`domaš_de¡roy
(
d
);

508 
	`¹c_deš™
(
d
);

509 
	`¡dvga_deš™
(
d
);

510 
	`vißpic_deš™
(
d
);

511 
	`hvm_de¡roy_ÿch—‰r_»giÚ_li¡
(
d
);

512 
	}
}

514 
	$hvm_§ve_ıu_ùxt
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

516 
vıu
 *
v
;

517 
hvm_hw_ıu
 
ùxt
;

518 
£gm’t_»gi¡”
 
£g
;

519 
vıu_gue¡_cÚ‹xt
 *
vc
;

521 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

525 iàĞ
	`‹¡_b™
(
_VPF_down
, &
v
->
·u£_æags
) )

529 
hvm_funcs
.
	`§ve_ıu_ùxt
(
v
, &
ùxt
);

531 
ùxt
.
m¤_tsc_aux
 = 
	`hvm_m¤_tsc_aux
(
v
);

533 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_idŒ
, &
£g
);

534 
ùxt
.
idŒ_lim™
 = 
£g
.
lim™
;

535 
ùxt
.
idŒ_ba£
 = 
£g
.
ba£
;

537 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gdŒ
, &
£g
);

538 
ùxt
.
gdŒ_lim™
 = 
£g
.
lim™
;

539 
ùxt
.
gdŒ_ba£
 = 
£g
.
ba£
;

541 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
£g
);

542 
ùxt
.
cs_£l
 = 
£g
.
£l
;

543 
ùxt
.
cs_lim™
 = 
£g
.
lim™
;

544 
ùxt
.
cs_ba£
 = 
£g
.
ba£
;

545 
ùxt
.
cs_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

547 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
£g
);

548 
ùxt
.
ds_£l
 = 
£g
.
£l
;

549 
ùxt
.
ds_lim™
 = 
£g
.
lim™
;

550 
ùxt
.
ds_ba£
 = 
£g
.
ba£
;

551 
ùxt
.
ds_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

553 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
£g
);

554 
ùxt
.
es_£l
 = 
£g
.
£l
;

555 
ùxt
.
es_lim™
 = 
£g
.
lim™
;

556 
ùxt
.
es_ba£
 = 
£g
.
ba£
;

557 
ùxt
.
es_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

559 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
£g
);

560 
ùxt
.
ss_£l
 = 
£g
.
£l
;

561 
ùxt
.
ss_lim™
 = 
£g
.
lim™
;

562 
ùxt
.
ss_ba£
 = 
£g
.
ba£
;

563 
ùxt
.
ss_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

565 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
£g
);

566 
ùxt
.
fs_£l
 = 
£g
.
£l
;

567 
ùxt
.
fs_lim™
 = 
£g
.
lim™
;

568 
ùxt
.
fs_ba£
 = 
£g
.
ba£
;

569 
ùxt
.
fs_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

571 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
£g
);

572 
ùxt
.
gs_£l
 = 
£g
.
£l
;

573 
ùxt
.
gs_lim™
 = 
£g
.
lim™
;

574 
ùxt
.
gs_ba£
 = 
£g
.
ba£
;

575 
ùxt
.
gs_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

577 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_Œ
, &
£g
);

578 
ùxt
.
Œ_£l
 = 
£g
.
£l
;

579 
ùxt
.
Œ_lim™
 = 
£g
.
lim™
;

580 
ùxt
.
Œ_ba£
 = 
£g
.
ba£
;

581 
ùxt
.
Œ_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

583 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ldŒ
, &
£g
);

584 
ùxt
.
ldŒ_£l
 = 
£g
.
£l
;

585 
ùxt
.
ldŒ_lim™
 = 
£g
.
lim™
;

586 
ùxt
.
ldŒ_ba£
 = 
£g
.
ba£
;

587 
ùxt
.
ldŒ_¬by‹s
 = 
£g
.
©Œ
.
by‹s
;

589 
vc
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
;

591 iàĞ
v
->
åu_š™Ÿli£d
 )

592 
	`memıy
(
ùxt
.
åu_»gs
, &
vc
->
åu_ùxt
, (ctxt.fpu_regs));

594 
	`mem£t
(
ùxt
.
åu_»gs
, 0, (ctxt.fpu_regs));

596 
ùxt
.
¿x
 = 
vc
->
u£r_»gs
.
—x
;

597 
ùxt
.
rbx
 = 
vc
->
u£r_»gs
.
ebx
;

598 
ùxt
.
rcx
 = 
vc
->
u£r_»gs
.
ecx
;

599 
ùxt
.
rdx
 = 
vc
->
u£r_»gs
.
edx
;

600 
ùxt
.
rbp
 = 
vc
->
u£r_»gs
.
ebp
;

601 
ùxt
.
rsi
 = 
vc
->
u£r_»gs
.
esi
;

602 
ùxt
.
rdi
 = 
vc
->
u£r_»gs
.
edi
;

603 
ùxt
.
r¥
 = 
vc
->
u£r_»gs
.
e¥
;

604 
ùxt
.
r
 = 
vc
->
u£r_»gs
.
e
;

605 
ùxt
.
ræags
 = 
vc
->
u£r_»gs
.
eæags
;

606 #ifdeà
__x86_64__


607 
ùxt
.
r8
 = 
vc
->
u£r_»gs
.r8;

608 
ùxt
.
r9
 = 
vc
->
u£r_»gs
.r9;

609 
ùxt
.
r10
 = 
vc
->
u£r_»gs
.r10;

610 
ùxt
.
r11
 = 
vc
->
u£r_»gs
.r11;

611 
ùxt
.
r12
 = 
vc
->
u£r_»gs
.r12;

612 
ùxt
.
r13
 = 
vc
->
u£r_»gs
.r13;

613 
ùxt
.
r14
 = 
vc
->
u£r_»gs
.r14;

614 
ùxt
.
r15
 = 
vc
->
u£r_»gs
.r15;

616 
ùxt
.
dr0
 = 
vc
->
debug»g
[0];

617 
ùxt
.
dr1
 = 
vc
->
debug»g
[1];

618 
ùxt
.
dr2
 = 
vc
->
debug»g
[2];

619 
ùxt
.
dr3
 = 
vc
->
debug»g
[3];

620 
ùxt
.
dr6
 = 
vc
->
debug»g
[6];

621 
ùxt
.
dr7
 = 
vc
->
debug»g
[7];

623 iàĞ
	`hvm_§ve_’Œy
(
CPU
, 
v
->
vıu_id
, 
h
, &
ùxt
) != 0 )

627 
	}
}

629 
boŞ_t
 
	$hvm_eãr_v®id
(
ušt64_t
 
v®ue
, ušt64_ˆ
eãr_v®idb™s
)

631  !((
v®ue
 & ~
eãr_v®idb™s
) ||

632 (((è!ğ8è&& (
v®ue
 & 
EFER_LME
)) ||

633 (!
ıu_has_nx
 && (
v®ue
 & 
EFER_NX
)) ||

634 (!
ıu_has_sysÿÎ
 && (
v®ue
 & 
EFER_SCE
)) ||

635 (!
ıu_has_lm¦
 && (
v®ue
 & 
EFER_LMSLE
)) ||

636 (!
ıu_has_ffx¤
 && (
v®ue
 & 
EFER_FFXSE
)) ||

637 ((
v®ue
 & (
EFER_LME
|
EFER_LMA
)) == EFER_LMA));

638 
	}
}

640 
	$hvm_lßd_ıu_ùxt
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

642 
vıuid
, 
rc
;

643 
vıu
 *
v
;

644 
hvm_hw_ıu
 
ùxt
;

645 
£gm’t_»gi¡”
 
£g
;

646 
vıu_gue¡_cÚ‹xt
 *
vc
;

649 
vıuid
 = 
	`hvm_lßd_š¡ªû
(
h
);

650 iàĞ
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[vıuid]è=ğ
NULL
 )

652 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: domaš ha nØvıu %u\n", 
vıuid
);

653  -
EINVAL
;

655 
vc
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
;

658 
rc
 = 0;

659 
	`domaš_lock
(
d
);

660 iàĞ!
v
->
is_š™Ÿli£d
 )

661 
rc
 = 
	`boÙ_vıu
(
d
, 
vıuid
, 
vc
);

662 
	`domaš_uÆock
(
d
);

663 iàĞ
rc
 != 0 )

664  
rc
;

666 iàĞ
	`hvm_lßd_’Œy
(
CPU
, 
h
, &
ùxt
) != 0 )

667  -
EINVAL
;

670 iàĞ(
ùxt
.
ü0
 & 
HVM_CR0_GUEST_RESERVED_BITS
) ||

671 !(
ùxt
.
ü0
 & 
X86_CR0_ET
) ||

672 ((
ùxt
.
ü0
 & (
X86_CR0_PE
|
X86_CR0_PG
)) == X86_CR0_PG) )

674 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: bad CR0 0x%"
PRIx64
"\n",

675 
ùxt
.
ü0
);

676  -
EINVAL
;

679 iàĞ
ùxt
.
ü4
 & 
	`HVM_CR4_GUEST_RESERVED_BITS
(
v
) )

681 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: bad CR4 0x%"
PRIx64
"\n",

682 
ùxt
.
ü4
);

683  -
EINVAL
;

686 iàĞ!
	`hvm_eãr_v®id
(

687 
ùxt
.
m¤_eãr
,

688 
EFER_FFXSE
 | 
EFER_LMSLE
 | 
EFER_LME
 | 
EFER_LMA
 | 
EFER_NX
 | 
EFER_SCE
) )

690 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: bad EFER 0x%"
PRIx64
"\n",

691 
ùxt
.
m¤_eãr
);

692  -
EINVAL
;

698 
	#UNFOLD_ARBYTES
(
_r
) \

699 iàĞ(
_r
 & 0xf000) && !(_r & 0x0f00) ) \

700 
_r
 = ((_¸& 0xffè| ((_¸>> 4è& 0xf00))

	)

701 
	`UNFOLD_ARBYTES
(
ùxt
.
cs_¬by‹s
);

702 
	`UNFOLD_ARBYTES
(
ùxt
.
ds_¬by‹s
);

703 
	`UNFOLD_ARBYTES
(
ùxt
.
es_¬by‹s
);

704 
	`UNFOLD_ARBYTES
(
ùxt
.
fs_¬by‹s
);

705 
	`UNFOLD_ARBYTES
(
ùxt
.
gs_¬by‹s
);

706 
	`UNFOLD_ARBYTES
(
ùxt
.
ss_¬by‹s
);

707 
	`UNFOLD_ARBYTES
(
ùxt
.
Œ_¬by‹s
);

708 
	`UNFOLD_ARBYTES
(
ùxt
.
ldŒ_¬by‹s
);

709 #undeà
UNFOLD_ARBYTES


712 iàĞ
hvm_funcs
.
	`lßd_ıu_ùxt
(
v
, &
ùxt
) < 0 )

713  -
EINVAL
;

715 
v
->
¬ch
.
hvm_vıu
.
m¤_tsc_aux
 = 
ùxt
.msr_tsc_aux;

717 
£g
.
lim™
 = 
ùxt
.
idŒ_lim™
;

718 
£g
.
ba£
 = 
ùxt
.
idŒ_ba£
;

719 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_idŒ
, &
£g
);

721 
£g
.
lim™
 = 
ùxt
.
gdŒ_lim™
;

722 
£g
.
ba£
 = 
ùxt
.
gdŒ_ba£
;

723 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_gdŒ
, &
£g
);

725 
£g
.
£l
 = 
ùxt
.
cs_£l
;

726 
£g
.
lim™
 = 
ùxt
.
cs_lim™
;

727 
£g
.
ba£
 = 
ùxt
.
cs_ba£
;

728 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
cs_¬by‹s
;

729 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
£g
);

731 
£g
.
£l
 = 
ùxt
.
ds_£l
;

732 
£g
.
lim™
 = 
ùxt
.
ds_lim™
;

733 
£g
.
ba£
 = 
ùxt
.
ds_ba£
;

734 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
ds_¬by‹s
;

735 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
£g
);

737 
£g
.
£l
 = 
ùxt
.
es_£l
;

738 
£g
.
lim™
 = 
ùxt
.
es_lim™
;

739 
£g
.
ba£
 = 
ùxt
.
es_ba£
;

740 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
es_¬by‹s
;

741 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
£g
);

743 
£g
.
£l
 = 
ùxt
.
ss_£l
;

744 
£g
.
lim™
 = 
ùxt
.
ss_lim™
;

745 
£g
.
ba£
 = 
ùxt
.
ss_ba£
;

746 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
ss_¬by‹s
;

747 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
£g
);

749 
£g
.
£l
 = 
ùxt
.
fs_£l
;

750 
£g
.
lim™
 = 
ùxt
.
fs_lim™
;

751 
£g
.
ba£
 = 
ùxt
.
fs_ba£
;

752 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
fs_¬by‹s
;

753 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
£g
);

755 
£g
.
£l
 = 
ùxt
.
gs_£l
;

756 
£g
.
lim™
 = 
ùxt
.
gs_lim™
;

757 
£g
.
ba£
 = 
ùxt
.
gs_ba£
;

758 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
gs_¬by‹s
;

759 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
£g
);

761 
£g
.
£l
 = 
ùxt
.
Œ_£l
;

762 
£g
.
lim™
 = 
ùxt
.
Œ_lim™
;

763 
£g
.
ba£
 = 
ùxt
.
Œ_ba£
;

764 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
Œ_¬by‹s
;

765 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_Œ
, &
£g
);

767 
£g
.
£l
 = 
ùxt
.
ldŒ_£l
;

768 
£g
.
lim™
 = 
ùxt
.
ldŒ_lim™
;

769 
£g
.
ba£
 = 
ùxt
.
ldŒ_ba£
;

770 
£g
.
©Œ
.
by‹s
 = 
ùxt
.
ldŒ_¬by‹s
;

771 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ldŒ
, &
£g
);

773 
	`memıy
(&
vc
->
åu_ùxt
, 
ùxt
.
åu_»gs
, (ctxt.fpu_regs));

776 iàĞ
	`x§ve_’abËd
(
v
) )

778 
x§ve_¡ruù
 *
x§ve_¬—
 = 
v
->
¬ch
.xsave_area;

780 
	`memıy
(
v
->
¬ch
.
x§ve_¬—
, 
ùxt
.
åu_»gs
, (ctxt.fpu_regs));

781 
x§ve_¬—
->
x§ve_hdr
.
x¡©e_bv
 = 
XSTATE_FP_SSE
;

782 
v
->
¬ch
.
xü0_accum
 = 
XSTATE_FP_SSE
;

783 
v
->
¬ch
.
xü0
 = 
XSTATE_FP_SSE
;

786 
vc
->
u£r_»gs
.
—x
 = 
ùxt
.
¿x
;

787 
vc
->
u£r_»gs
.
ebx
 = 
ùxt
.
rbx
;

788 
vc
->
u£r_»gs
.
ecx
 = 
ùxt
.
rcx
;

789 
vc
->
u£r_»gs
.
edx
 = 
ùxt
.
rdx
;

790 
vc
->
u£r_»gs
.
ebp
 = 
ùxt
.
rbp
;

791 
vc
->
u£r_»gs
.
esi
 = 
ùxt
.
rsi
;

792 
vc
->
u£r_»gs
.
edi
 = 
ùxt
.
rdi
;

793 
vc
->
u£r_»gs
.
e¥
 = 
ùxt
.
r¥
;

794 
vc
->
u£r_»gs
.
e
 = 
ùxt
.
r
;

795 
vc
->
u£r_»gs
.
eæags
 = 
ùxt
.
ræags
 | 2;

796 #ifdeà
__x86_64__


797 
vc
->
u£r_»gs
.
r8
 = 
ùxt
.r8;

798 
vc
->
u£r_»gs
.
r9
 = 
ùxt
.r9;

799 
vc
->
u£r_»gs
.
r10
 = 
ùxt
.r10;

800 
vc
->
u£r_»gs
.
r11
 = 
ùxt
.r11;

801 
vc
->
u£r_»gs
.
r12
 = 
ùxt
.r12;

802 
vc
->
u£r_»gs
.
r13
 = 
ùxt
.r13;

803 
vc
->
u£r_»gs
.
r14
 = 
ùxt
.r14;

804 
vc
->
u£r_»gs
.
r15
 = 
ùxt
.r15;

806 
vc
->
debug»g
[0] = 
ùxt
.
dr0
;

807 
vc
->
debug»g
[1] = 
ùxt
.
dr1
;

808 
vc
->
debug»g
[2] = 
ùxt
.
dr2
;

809 
vc
->
debug»g
[3] = 
ùxt
.
dr3
;

810 
vc
->
debug»g
[6] = 
ùxt
.
dr6
;

811 
vc
->
debug»g
[7] = 
ùxt
.
dr7
;

813 
vc
->
æags
 = 
VGCF_Úlše
;

814 
v
->
åu_š™Ÿli£d
 = 1;

817 
v
->
is_š™Ÿli£d
 = 1;

818 
	`ş—r_b™
(
_VPF_down
, &
v
->
·u£_æags
);

819 
	`vıu_wake
(
v
);

822 
	}
}

824 
HVM_REGISTER_SAVE_RESTORE
(
CPU
, 
hvm_§ve_ıu_ùxt
, 
hvm_lßd_ıu_ùxt
,

825 1, 
HVMSR_PER_VCPU
);

827 
	#HVM_CPU_XSAVE_SIZE
 (3 * (
ušt64_t
è+ 
x§ve_útxt_size
)

	)

829 
	$hvm_§ve_ıu_x§ve_¡©es
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

831 
vıu
 *
v
;

832 
hvm_hw_ıu_x§ve
 *
ùxt
;

834 iàĞ!
ıu_has_x§ve
 )

837 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

839 iàĞ!
	`x§ve_’abËd
(
v
) )

841 iàĞ
	`_hvm_š™_’Œy
(
h
, 
CPU_XSAVE_CODE
, 
v
->
vıu_id
, 
HVM_CPU_XSAVE_SIZE
) )

843 
ùxt
 = (
hvm_hw_ıu_x§ve
 *)&
h
->
d©a
[h->
cur
];

844 
h
->
cur
 +ğ
HVM_CPU_XSAVE_SIZE
;

845 
	`mem£t
(
ùxt
, 0, 
HVM_CPU_XSAVE_SIZE
);

847 
ùxt
->
xã©u»_mask
 = xfeature_mask;

848 
ùxt
->
xü0
 = 
v
->
¬ch
.xcr0;

849 
ùxt
->
xü0_accum
 = 
v
->
¬ch
.xcr0_accum;

850 iàĞ
v
->
åu_š™Ÿli£d
 )

851 
	`memıy
(&
ùxt
->
§ve_¬—
,

852 
v
->
¬ch
.
x§ve_¬—
, 
x§ve_útxt_size
);

856 
	}
}

858 
	$hvm_lßd_ıu_x§ve_¡©es
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

860 
vıuid
;

861 
vıu
 *
v
;

862 
hvm_hw_ıu_x§ve
 *
ùxt
;

863 
hvm_§ve_desütÜ
 *
desc
;

864 
ušt64_t
 
_xã©u»_mask
;

867 
vıuid
 = 
	`hvm_lßd_š¡ªû
(
h
);

868 iàĞ
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[vıuid]è=ğ
NULL
 )

870 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: domaš ha nØvıu %u\n", 
vıuid
);

871  -
EINVAL
;

875 iàĞ!
	`x§ve_’abËd
(
v
) )

876  -
EINVAL
;

879 
desc
 = (
hvm_§ve_desütÜ
 *)&
h
->
d©a
[h->
cur
];

880 iàĞ (*
desc
è> 
h
->
size
 - h->
cur
)

882 
	`gd´štk
(
XENLOG_WARNING
,

884 "fÜy³ %u\n", 
CPU_XSAVE_CODE
);

887 iàĞ
desc
->
Ëngth
 +  (*descè> 
h
->
size
 - h->
cur
)

889 
	`gd´štk
(
XENLOG_WARNING
,

891 "fÜy³ %u\n", 
desc
->
Ëngth
, 
CPU_XSAVE_CODE
);

894 iàĞ
CPU_XSAVE_CODE
 !ğ
desc
->
ty³code
 || (desc->
Ëngth
 > 
HVM_CPU_XSAVE_SIZE
) )

896 
	`gd´štk
(
XENLOG_WARNING
,

898 "§wy³ %u†’gth %u\n", 
CPU_XSAVE_CODE
,

899 (
ušt32_t
)
HVM_CPU_XSAVE_SIZE
,

900 
desc
->
ty³code
, desc->
Ëngth
);

903 
h
->
cur
 +ğ (*
desc
);

906 
ùxt
 = (
hvm_hw_ıu_x§ve
 *)&
h
->
d©a
[h->
cur
];

907 
h
->
cur
 +ğ
desc
->
Ëngth
;

909 
_xã©u»_mask
 = 
ùxt
->
xã©u»_mask
;

910 iàĞ(
_xã©u»_mask
 & 
xã©u»_mask
) != _xfeature_mask )

911  -
EINVAL
;

913 
v
->
¬ch
.
xü0
 = 
ùxt
->xcr0;

914 
v
->
¬ch
.
xü0_accum
 = 
ùxt
->xcr0_accum;

915 
	`memıy
(
v
->
¬ch
.
x§ve_¬—
, &
ùxt
->
§ve_¬—
, 
x§ve_útxt_size
);

918 
	}
}

923 
	$__hvm_»gi¡”_CPU_XSAVE_§ve_ªd_»¡Üe
()

925 
	`hvm_»gi¡”_§vevm
(
CPU_XSAVE_CODE
,

927 
hvm_§ve_ıu_x§ve_¡©es
,

928 
hvm_lßd_ıu_x§ve_¡©es
,

929 
HVM_CPU_XSAVE_SIZE
 +  (
hvm_§ve_desütÜ
),

930 
HVMSR_PER_VCPU
);

932 
	}
}

933 
__š™ÿÎ
(
__hvm_»gi¡”_CPU_XSAVE_§ve_ªd_»¡Üe
);

935 
	$hvm_vıu_š™Ÿli£
(
vıu
 *
v
)

937 
rc
;

939 
	`hvm_asid_æush_vıu
(
v
);

941 iàĞ(
rc
 = 
	`vÏpic_š™
(
v
)) != 0 )

942 
ç1
;

944 iàĞ(
rc
 = 
hvm_funcs
.
	`vıu_š™Ÿli£
(
v
)) != 0 )

945 
ç2
;

948 
rc
 = 
	`®loc_unbound_x’_ev’t_chªÃl
(
v
, 0);

949 iàĞ
rc
 < 0 )

950 
ç3
;

953 
v
->
¬ch
.
hvm_vıu
.
x’_pÜt
 = 
rc
;

954 
	`¥š_lock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
iÜeq
.
lock
);

955 iàĞ
v
->
domaš
->
¬ch
.
hvm_domaš
.
iÜeq
.
va
 !ğ
NULL
 )

956 
	`g‘_iÜeq
(
v
)->
vp_•Üt
 = v->
¬ch
.
hvm_vıu
.
x’_pÜt
;

957 
	`¥š_uÆock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
iÜeq
.
lock
);

959 
	`¥š_lock_š™
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

960 
	`INIT_LIST_HEAD
(&
v
->
¬ch
.
hvm_vıu
.
tm_li¡
);

962 
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
 = -1;

964 #ifdeà
CONFIG_COMPAT


965 
rc
 = 
	`£tup_com·t_¬g_xÏt
(
v
);

966 iàĞ
rc
 != 0 )

967 
ç3
;

970 
rc
 = 
	`hvm_vıu_ÿch—‰r_š™
(
v
);

971 iàĞ
rc
 != 0 )

972 
ç4
;

974 
	`skËt_š™
(&
v
->
¬ch
.
hvm_vıu
.
as£¹_evtchn_œq_skËt
,

975 ((*)())
hvm_as£¹_evtchn_œq
,

976 ()
v
);

978 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 = 2;

980 iàĞ
v
->
vıu_id
 == 0 )

983 
	`p™_š™
(
v
, 
ıu_khz
);

984 
	`pmtim”_š™
(
v
);

985 
	`h³t_š™
(
v
);

988 
	`hvm_£t_gue¡_tsc
(
v
, 0);

991 
v
->
is_š™Ÿli£d
 = 1;

992 
	`ş—r_b™
(
_VPF_down
, &
v
->
·u£_æags
);

997 
ç4
:

998 #ifdeà
CONFIG_COMPAT


999 
	`ä“_com·t_¬g_xÏt
(
v
);

1001 
ç3
:

1002 
hvm_funcs
.
	`vıu_de¡roy
(
v
);

1003 
ç2
:

1004 
	`vÏpic_de¡roy
(
v
);

1005 
ç1
:

1006  
rc
;

1007 
	}
}

1009 
	$hvm_vıu_de¡roy
(
vıu
 *
v
)

1011 #ifdeà
CONFIG_COMPAT


1012 
	`ä“_com·t_¬g_xÏt
(
v
);

1014 
	`skËt_kl
(&
v
->
¬ch
.
hvm_vıu
.
as£¹_evtchn_œq_skËt
);

1015 
	`hvm_vıu_ÿch—‰r_de¡roy
(
v
);

1016 
	`vÏpic_de¡roy
(
v
);

1017 
hvm_funcs
.
	`vıu_de¡roy
(
v
);

1021 
	}
}

1023 
	$hvm_vıu_down
(
vıu
 *
v
)

1025 
domaš
 *
d
 = 
v
->domain;

1026 
Úlše_couÁ
 = 0;

1029 
	`£t_b™
(
_VPF_down
, &
v
->
·u£_æags
);

1030 
	`vıu_¦“p_nosync
(
v
);

1033 
	`domaš_lock
(
d
);

1034 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1035 iàĞ!
	`‹¡_b™
(
_VPF_down
, &
v
->
·u£_æags
) )

1036 
Úlše_couÁ
++;

1037 
	`domaš_uÆock
(
d
);

1040 iàĞ
Úlše_couÁ
 == 0 )

1042 
	`gd´štk
(
XENLOG_INFO
, "All CPUs offline --…owering off.\n");

1043 
	`domaš_shutdown
(
d
, 
SHUTDOWN_pow”off
);

1045 
	}
}

1047 
boŞ_t
 
	$hvm_£nd_assi¡_»q
(
vıu
 *
v
)

1049 
iÜeq_t
 *
p
;

1051 iàĞ
	`uÆik–y
(!
	`vıu_¡¬t_shutdown_deã¼®
(
v
)) )

1054 
p
 = 
	`g‘_iÜeq
(
v
);

1055 iàĞ
	`uÆik–y
(
p
->
¡©e
 !ğ
STATE_IOREQ_NONE
) )

1058 
	`gd´štk
(
XENLOG_ERR
, "Deviû mod– s‘ bad IO s‹ %d.\n", 
p
->
¡©e
);

1059 
	`domaš_üash
(
v
->
domaš
);

1063 
	`´•¬e_wa™_Ú_x’_ev’t_chªÃl
(
v
->
¬ch
.
hvm_vıu
.
x’_pÜt
);

1069 
p
->
¡©e
 = 
STATE_IOREQ_READY
;

1070 
	`nÙify_vŸ_x’_ev’t_chªÃl
(
v
->
domaš
, v->
¬ch
.
hvm_vıu
.
x’_pÜt
);

1073 
	}
}

1075 
	$hvm_hÉ
(
ræags
)

1077 
vıu
 *
cu¼
 = 
cu¼’t
;

1079 iàĞ
	`hvm_ev’t_³ndšg
(
cu¼
) )

1087 iàĞ
	`uÆik–y
(!(
ræags
 & 
X86_EFLAGS_IF
)) )

1088  
	`hvm_vıu_down
(
cu¼
);

1090 
	`do_sched_İ_com·t
(
SCHEDOP_block
, 0);

1092 
	`HVMTRACE_1D
(
HLT
, 
	`vıu_ruÂabË
(
cu¼
));

1093 
	}
}

1095 
	$hvm_ŒË_çuÉ
()

1097 
vıu
 *
v
 = 
cu¼’t
;

1098 
	`gd´štk
(
XENLOG_INFO
, "Triple fault on VCPU%d - "

1099 "švokšg HVM sy¡em„e£t.\n", 
v
->
vıu_id
);

1100 
	`domaš_shutdown
(
v
->
domaš
, 
SHUTDOWN_»boÙ
);

1101 
	}
}

1103 
boŞ_t
 
	$hvm_h­_Ã¡ed_·ge_çuÉ
(
g·
,

1104 
boŞ_t
 
gÏ_v®id
,

1105 
gÏ
,

1106 
boŞ_t
 
acûss_v®id
,

1107 
boŞ_t
 
acûss_r
,

1108 
boŞ_t
 
acûss_w
,

1109 
boŞ_t
 
acûss_x
)

1111 
gâ
 = 
g·
 >> 
PAGE_SHIFT
;

1112 
p2m_ty³_t
 
p2mt
;

1113 
p2m_acûss_t
 
p2ma
;

1114 
mâ_t
 
mâ
;

1115 
vıu
 *
v
 = 
cu¼’t
;

1116 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

1118 
mâ
 = 
	`gâ_to_mâ_ty³_cu¼’t
(
p2m
, 
gâ
, &
p2mt
, &
p2ma
, 
p2m_gue¡
);

1121 iàĞ
acûss_v®id
 && (
	`mâ_x
(
mâ
è!ğ
INVALID_MFN
) )

1123 
viŞ©iÚ
 = 0;

1125 
p2ma
)

1127 
p2m_acûss_n
:

1129 
viŞ©iÚ
 = 
acûss_r
 || 
acûss_w
 || 
acûss_x
;

1131 
p2m_acûss_r
:

1132 
viŞ©iÚ
 = 
acûss_w
 || 
acûss_x
;

1134 
p2m_acûss_w
:

1135 
viŞ©iÚ
 = 
acûss_r
 || 
acûss_x
;

1137 
p2m_acûss_x
:

1138 
viŞ©iÚ
 = 
acûss_r
 || 
acûss_w
;

1140 
p2m_acûss_rx
:

1141 
p2m_acûss_rx2rw
:

1142 
viŞ©iÚ
 = 
acûss_w
;

1144 
p2m_acûss_wx
:

1145 
viŞ©iÚ
 = 
acûss_r
;

1147 
p2m_acûss_rw
:

1148 
viŞ©iÚ
 = 
acûss_x
;

1150 
p2m_acûss_rwx
:

1154 iàĞ
viŞ©iÚ
 )

1156 
	`p2m_mem_acûss_check
(
g·
, 
gÏ_v®id
, 
gÏ
, 
acûss_r
, 
acûss_w
, 
acûss_x
);

1166 iàĞ(
p2mt
 =ğ
p2m_mmio_dm
è|| (p2mˆ=ğ
p2m_¿m_ro
) )

1168 iàĞ!
	`hªdË_mmio
() )

1169 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1173 #ifdeà
__x86_64__


1175 iàĞ
	`p2m_is_·ged
(
p2mt
è|| (p2mˆ=ğ
p2m_¿m_·gšg_out
) )

1176 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
gâ
);

1179 iàĞ
p2mt
 =ğ
p2m_¿m_sh¬ed
 )

1181 
	`mem_sh¬šg_unsh¬e_·ge
(
p2m
, 
gâ
, 0);

1187 iàĞ
	`p2m_is_¿m
(
p2mt
) )

1194 
	`·gšg_m¬k_dœty
(
v
->
domaš
, 
	`mâ_x
(
mâ
));

1195 
	`p2m_chªge_ty³
(
p2m
, 
gâ
, 
p2m_¿m_logdœty
, 
p2m_¿m_rw
);

1200 iàĞ
p2mt
 =ğ
p2m_g¿Á_m­_ro
 )

1202 
	`gd´štk
(
XENLOG_WARNING
,

1204 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1209 
	}
}

1211 
	$hvm_hªdË_x£tbv
(
u64
 
Ãw_bv
)

1213 
vıu
 *
v
 = 
cu¼’t
;

1214 
£gm’t_»gi¡”
 
¤eg
;

1216 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
¤eg
);

1217 iàĞ
¤eg
.
©Œ
.
f›lds
.
d¶
 != 0 )

1218 
”r
;

1220 iàĞ((
Ãw_bv
 ^ 
xã©u»_mask
) & ~xfeature_mask) || !(new_bv & 1) )

1221 
”r
;

1223 iàĞ(
xã©u»_mask
 & 
XSTATE_YMM
 & 
Ãw_bv
è&& !Òew_bv & 
XSTATE_SSE
) )

1224 
”r
;

1226 
v
->
¬ch
.
xü0
 = 
Ãw_bv
;

1227 
v
->
¬ch
.
xü0_accum
 |ğ
Ãw_bv
;

1228 
	`£t_xü0
(
Ãw_bv
);

1231 
”r
:

1232 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1234 
	}
}

1236 
	$hvm_£t_eãr
(
ušt64_t
 
v®ue
)

1238 
vıu
 *
v
 = 
cu¼’t
;

1240 
v®ue
 &ğ~
EFER_LMA
;

1242 iàĞ!
	`hvm_eãr_v®id
(
v®ue
,

1243 
EFER_FFXSE
 | 
EFER_LMSLE
 | 
EFER_LME
 | 
EFER_NX
 | 
EFER_SCE
) )

1245 
	`gd´štk
(
XENLOG_WARNING
, "Tryingo set„eserved bit in "

1246 "EFER: %"
PRIx64
"\n", 
v®ue
);

1247 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1248  
X86EMUL_EXCEPTION
;

1251 iàĞ((
v®ue
 ^ 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
è& 
EFER_LME
) &&

1252 
	`hvm_·gšg_’abËd
(
v
) )

1254 
	`gd´štk
(
XENLOG_WARNING
,

1256 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1257  
X86EMUL_EXCEPTION
;

1260 
v®ue
 |ğ
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_LMA
;

1261 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 = 
v®ue
;

1262 
	`hvm_upd©e_gue¡_eãr
(
v
);

1264  
X86EMUL_OKAY
;

1265 
	}
}

1267 
shadow_blow_bËs_³r_domaš
(
domaš
 *
d
);

1270 
boŞ_t
 
	$domaš_ex™_uc_mode
(
vıu
 *
v
)

1272 
domaš
 *
d
 = 
v
->domain;

1273 
vıu
 *
vs
;

1275 
	`fÜ_—ch_vıu
 ( 
d
, 
vs
 )

1277 iàĞ(
vs
 =ğ
v
è|| !vs->
is_š™Ÿli£d
 )

1279 iàĞ(
vs
->
¬ch
.
hvm_vıu
.
ÿche_mode
 =ğ
NO_FILL_CACHE_MODE
) ||

1280 
	`mŒr_·t_nÙ_equ®
(
vs
, 
v
) )

1285 
	}
}

1287 
	$loÿl_æush_ÿche
(*
šfo
)

1289 
	`wbšvd
();

1290 
	}
}

1292 
	$hvm_£t_uc_mode
(
vıu
 *
v
, 
boŞ_t
 
is_š_uc_mode
)

1294 
v
->
domaš
->
¬ch
.
hvm_domaš
.
is_š_uc_mode
 = is_in_uc_mode;

1295 
	`shadow_blow_bËs_³r_domaš
(
v
->
domaš
);

1296 iàĞ
hvm_funcs
.
£t_uc_mode
 )

1297  
hvm_funcs
.
	`£t_uc_mode
(
v
);

1298 
	}
}

1300 
	$hvm_£t_ü0
(
v®ue
)

1302 
vıu
 *
v
 = 
cu¼’t
;

1303 
p2m_ty³_t
 
p2mt
;

1304 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

1305 
gâ
, 
mâ
, 
Şd_v®ue
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

1307 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
, "Upd©CR0 v®uğ%lx", 
v®ue
);

1309 iàĞ(
u32
)
v®ue
 != value )

1311 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
,

1313 
v®ue
);

1314 
gpf
;

1317 
v®ue
 &ğ~
HVM_CR0_GUEST_RESERVED_BITS
;

1320 
v®ue
 |ğ
X86_CR0_ET
;

1322 iàĞ(
v®ue
 & (
X86_CR0_PE
 | 
X86_CR0_PG
)) == X86_CR0_PG )

1323 
gpf
;

1325 iàĞ(
v®ue
 & 
X86_CR0_PG
è&& !(
Şd_v®ue
 & X86_CR0_PG) )

1327 iàĞ
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_LME
 )

1329 iàĞ!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] & 
X86_CR4_PAE
) )

1331 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "Enable…aging before PAEƒnable");

1332 
gpf
;

1334 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "Enabling†ong mode");

1335 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 |ğ
EFER_LMA
;

1336 
	`hvm_upd©e_gue¡_eãr
(
v
);

1339 iàĞ!
	`·gšg_mode_h­
(
v
->
domaš
) )

1342 
gâ
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3]>>
PAGE_SHIFT
;

1343 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
));

1344 iàĞ!
	`p2m_is_¿m
(
p2mt
è|| !
	`mâ_v®id
(
mâ
) ||

1345 !
	`g‘_·ge
(
	`mâ_to_·ge
(
mâ
), 
v
->
domaš
))

1347 
	`gd´štk
(
XENLOG_ERR
, "Invalid CR3 value = %lx (mfn=%lx)\n",

1348 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3], 
mâ
);

1349 
	`domaš_üash
(
v
->
domaš
);

1350  
X86EMUL_UNHANDLEABLE
;

1354 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
mâ
);

1356 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
, "Update CR3 value = %lx, mfn = %lx",

1357 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3], 
mâ
);

1360 iàĞ!(
v®ue
 & 
X86_CR0_PG
è&& (
Şd_v®ue
 & X86_CR0_PG) )

1363 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

1365 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 &ğ~
EFER_LMA
;

1366 
	`hvm_upd©e_gue¡_eãr
(
v
);

1369 iàĞ!
	`·gšg_mode_h­
(
v
->
domaš
) )

1371 
	`put_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

1372 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

1376 iàĞ
	`has_¬ch_mmios
(
v
->
domaš
) )

1378 iàĞ(
v®ue
 & 
X86_CR0_CD
è&& !(v®u& 
X86_CR0_NW
) )

1381 
	`¥š_lock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
uc_lock
);

1382 
v
->
¬ch
.
hvm_vıu
.
ÿche_mode
 = 
NO_FILL_CACHE_MODE
;

1384 iàĞ!
v
->
domaš
->
¬ch
.
hvm_domaš
.
is_š_uc_mode
 )

1387 
	`Ú_—ch_ıu
(
loÿl_æush_ÿche
, 
NULL
, 1);

1388 
	`hvm_£t_uc_mode
(
v
, 1);

1390 
	`¥š_uÆock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
uc_lock
);

1392 iàĞ!(
v®ue
 & (
X86_CR0_CD
 | 
X86_CR0_NW
)) &&

1393 (
v
->
¬ch
.
hvm_vıu
.
ÿche_mode
 =ğ
NO_FILL_CACHE_MODE
) )

1396 
	`¥š_lock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
uc_lock
);

1397 
v
->
¬ch
.
hvm_vıu
.
ÿche_mode
 = 
NORMAL_CACHE_MODE
;

1399 iàĞ
	`domaš_ex™_uc_mode
(
v
) )

1400 
	`hvm_£t_uc_mode
(
v
, 0);

1402 
	`¥š_uÆock
(&
v
->
domaš
->
¬ch
.
hvm_domaš
.
uc_lock
);

1406 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
v®ue
;

1407 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

1409 iàĞ(
v®ue
 ^ 
Şd_v®ue
è& 
X86_CR0_PG
 )

1410 
	`·gšg_upd©e_·gšg_modes
(
v
);

1412  
X86EMUL_OKAY
;

1414 
gpf
:

1415 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1416  
X86EMUL_EXCEPTION
;

1417 
	}
}

1419 
	$hvm_£t_ü3
(
v®ue
)

1421 
mâ
;

1422 
p2m_ty³_t
 
p2mt
;

1423 
vıu
 *
v
 = 
cu¼’t
;

1425 iàĞ
	`hvm_·gšg_’abËd
(
v
è&& !
	`·gšg_mode_h­
(v->
domaš
) &&

1426 (
v®ue
 !ğ
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3]) )

1429 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
, "CR3 v®uğ%lx", 
v®ue
);

1430 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
),

1431 
v®ue
 >> 
PAGE_SHIFT
, &
p2mt
));

1432 iàĞ!
	`p2m_is_¿m
(
p2mt
è|| !
	`mâ_v®id
(
mâ
) ||

1433 !
	`g‘_·ge
(
	`mâ_to_·ge
(
mâ
), 
v
->
domaš
) )

1434 
bad_ü3
;

1436 
	`put_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

1437 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
mâ
);

1439 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
, "Upd©CR3 v®uğ%lx", 
v®ue
);

1442 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = 
v®ue
;

1443 
	`·gšg_upd©e_ü3
(
v
);

1444  
X86EMUL_OKAY
;

1446 
bad_ü3
:

1447 
	`gd´štk
(
XENLOG_ERR
, "Invalid CR3\n");

1448 
	`domaš_üash
(
v
->
domaš
);

1449  
X86EMUL_UNHANDLEABLE
;

1450 
	}
}

1452 
	$hvm_£t_ü4
(
v®ue
)

1454 
vıu
 *
v
 = 
cu¼’t
;

1455 
Şd_ü
;

1457 iàĞ
v®ue
 & 
	`HVM_CR4_GUEST_RESERVED_BITS
(
v
) )

1459 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
,

1461 
v®ue
);

1462 
gpf
;

1465 iàĞ!(
v®ue
 & 
X86_CR4_PAE
è&& 
	`hvm_lÚg_mode_’abËd
(
v
) )

1467 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "Guest cleared CR4.PAE while "

1469 
gpf
;

1472 
Şd_ü
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

1473 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 
v®ue
;

1474 
	`hvm_upd©e_gue¡_ü
(
v
, 4);

1477 iàĞ(
Şd_ü
 ^ 
v®ue
è& (
X86_CR4_PSE
 | 
X86_CR4_PGE
 | 
X86_CR4_PAE
) )

1478 
	`·gšg_upd©e_·gšg_modes
(
v
);

1480  
X86EMUL_OKAY
;

1482 
gpf
:

1483 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1484  
X86EMUL_EXCEPTION
;

1485 
	}
}

1487 
	$hvm_vœtu®_to_lš—r_addr
(

1488 
x86_£gm’t
 
£g
,

1489 
£gm’t_»gi¡”
 *
»g
,

1490 
off£t
,

1491 
by‹s
,

1492 
hvm_acûss_ty³
 
acûss_ty³
,

1493 
addr_size
,

1494 *
lš—r_addr
)

1496 
addr
 = 
off£t
;

1497 
ušt32_t
 
Ï¡_by‹
;

1499 iàĞ!(
cu¼’t
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
) )

1505 
addr
 = (
ušt32_t
)×dd¸+ 
»g
->
ba£
);

1507 iàĞ
addr_size
 != 64 )

1513  
acûss_ty³
 )

1515 
hvm_acûss_»ad
:

1516 iàĞ(
»g
->
©Œ
.
f›lds
.
ty³
 & 0xa) == 0x8 )

1517 
gpf
;

1519 
hvm_acûss_wr™e
:

1520 iàĞ(
»g
->
©Œ
.
f›lds
.
ty³
 & 0xa) != 0x2 )

1521 
gpf
;

1527 
Ï¡_by‹
 = 
off£t
 + 
by‹s
 - 1;

1530 iàĞ(
»g
->
©Œ
.
f›lds
.
ty³
 & 0xc) == 0x4 )

1533 iàĞ!
»g
->
©Œ
.
f›lds
.
db
 )

1534 
Ï¡_by‹
 = (
ušt16_t
)last_byte;

1537 iàĞ(
off£t
 <ğ
»g
->
lim™
è|| (
Ï¡_by‹
 < offset) )

1538 
gpf
;

1540 iàĞ(
Ï¡_by‹
 > 
»g
->
lim™
è|| (Ï¡_by‹ < 
off£t
) )

1541 
gpf
;

1547 
addr
 = (
ušt32_t
)×dd¸+ 
»g
->
ba£
);

1555 iàĞ(
£g
 =ğ
x86_£g_fs
è|| (£g =ğ
x86_£g_gs
) )

1556 
addr
 +ğ
»g
->
ba£
;

1558 iàĞ!
	`is_ÿnÚiÿl_add»ss
(
addr
) )

1559 
gpf
;

1562 *
lš—r_addr
 = 
addr
;

1565 
gpf
:

1567 
	}
}

1569 *
	$__hvm_m­_gue¡_äame
(
gâ
, 
boŞ_t
 
wr™abË
)

1571 
mâ
;

1572 
p2m_ty³_t
 
p2mt
;

1573 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
);

1575 
mâ
 = 
	`mâ_x
(
wr™abË


1576 ? 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
gâ
, &
p2mt
, 0)

1577 : 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
));

1578 iàĞ(
	`p2m_is_sh¬ed
(
p2mt
è&& 
wr™abË
è|| !
	`p2m_is_¿m
(p2mt) )

1579  
NULL
;

1580 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

1582 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
gâ
);

1583  
NULL
;

1586 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

1588 iàĞ
wr™abË
 )

1589 
	`·gšg_m¬k_dœty
(
cu¼’t
->
domaš
, 
mâ
);

1591  
	`m­_domaš_·ge
(
mâ
);

1592 
	}
}

1594 *
	$hvm_m­_gue¡_äame_rw
(
gâ
)

1596  
	`__hvm_m­_gue¡_äame
(
gâ
, 1);

1597 
	}
}

1599 *
	$hvm_m­_gue¡_äame_ro
(
gâ
)

1601  
	`__hvm_m­_gue¡_äame
(
gâ
, 0);

1602 
	}
}

1604 
	$hvm_unm­_gue¡_äame
(*
p
)

1606 iàĞ
p
 )

1607 
	`unm­_domaš_·ge
(
p
);

1608 
	}
}

1610 *
	$hvm_m­_’Œy
(
va
)

1612 
gâ
;

1613 
ušt32_t
 
pãc
;

1614 *
v
;

1616 iàĞ((
va
 & ~
PAGE_MASK
è+ 8è> 
PAGE_SIZE
 )

1618 
	`gd´štk
(
XENLOG_ERR
, "Descriptorableƒntry "

1620 
ç
;

1628 
pãc
 = 
PFEC_·ge_´e£Á
;

1629 
gâ
 = 
	`·gšg_gva_to_gâ
(
cu¼’t
, 
va
, &
pãc
);

1630 iàĞ(
pãc
 =ğ
PFEC_·ge_·ged
è|| (pãø=ğ
PFEC_·ge_sh¬ed
) )

1631 
ç
;

1633 
v
 = 
	`hvm_m­_gue¡_äame_rw
(
gâ
);

1634 iàĞ
v
 =ğ
NULL
 )

1635 
ç
;

1637  
v
 + (
va
 & ~
PAGE_MASK
);

1639 
ç
:

1640 
	`domaš_üash
(
cu¼’t
->
domaš
);

1641  
NULL
;

1642 
	}
}

1644 
	$hvm_unm­_’Œy
(*
p
)

1646 
	`hvm_unm­_gue¡_äame
(
p
);

1647 
	}
}

1649 
	$hvm_lßd_£gm’t_£ËùÜ
(

1650 
x86_£gm’t
 
£g
, 
ušt16_t
 
£l
)

1652 
£gm’t_»gi¡”
 
desùab
, 
cs
, 
£gr
;

1653 
desc_¡ruù
 *
pdesc
, 
desc
;

1654 
u8
 
d¶
, 
½l
, 
ıl
;

1655 
çuÉ_ty³
 = 
TRAP_šv®id_tss
;

1656 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1657 
vıu
 *
v
 = 
cu¼’t
;

1659 iàĞ
»gs
->
eæags
 & 
X86_EFLAGS_VM
 )

1661 
£gr
.
£l
 = sel;

1662 
£gr
.
ba£
 = (
ušt32_t
)
£l
 << 4;

1663 
£gr
.
lim™
 = 0xffffu;

1664 
£gr
.
©Œ
.
by‹s
 = 0xf3;

1665 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
£g
, &
£gr
);

1670 iàĞ(
£l
 & 0xfffc) == 0 )

1672 iàĞ(
£g
 =ğ
x86_£g_cs
è|| (£g =ğ
x86_£g_ss
) )

1673 
ç
;

1674 
	`mem£t
(&
£gr
, 0, (segr));

1675 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
£g
, &
£gr
);

1680 iàĞ(
£g
 =ğ
x86_£g_ldŒ
è&& (
£l
 & 4) )

1681 
ç
;

1683 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
cs
);

1684 
	`hvm_g‘_£gm’t_»gi¡”
(

1685 
v
, (
£l
 & 4è? 
x86_£g_ldŒ
 : 
x86_£g_gdŒ
, &
desùab
);

1688 iàĞ((
£l
 & 0xfff8è+ 7è> 
desùab
.
lim™
 )

1689 
ç
;

1691 
pdesc
 = 
	`hvm_m­_’Œy
(
desùab
.
ba£
 + (
£l
 & 0xfff8));

1692 iàĞ
pdesc
 =ğ
NULL
 )

1693 
hvm_m­_ç
;

1696 
desc
 = *
pdesc
;

1699 iàĞ!(
desc
.
b
 & (1u<<15)) )

1701 
çuÉ_ty³
 = 
TRAP_no_£gm’t
;

1702 
unm­_ªd_ç
;

1706 iàĞ(
desc
.
b
 & (1u<<12)è=ğ((
£g
 =ğ
x86_£g_ldŒ
) << 12) )

1707 
unm­_ªd_ç
;

1709 
d¶
 = (
desc
.
b
 >> 13) & 3;

1710 
½l
 = 
£l
 & 3;

1711 
ıl
 = 
cs
.
£l
 & 3;

1713  
£g
 )

1715 
x86_£g_cs
:

1717 iàĞ!(
desc
.
b
 & (1u<<11)) )

1718 
unm­_ªd_ç
;

1720 iàĞ((
desc
.
b
 & (6u<<9)è!ğ6è&& (
d¶
 !ğ
½l
) )

1721 
unm­_ªd_ç
;

1723 
x86_£g_ss
:

1725 iàĞ(
desc
.
b
 & (5u<<9)) != (1u<<9) )

1726 
unm­_ªd_ç
;

1727 iàĞ(
d¶
 !ğ
ıl
è|| (d¶ !ğ
½l
) )

1728 
unm­_ªd_ç
;

1730 
x86_£g_ldŒ
:

1732 iàĞ(
desc
.
b
 & (15u<<8)) != (2u<<8) )

1733 
unm­_ªd_ç
;

1734 
sk_acûs£d_æag
;

1737 iàĞ(
desc
.
b
 & (5u<<9)) == (4u<<9) )

1738 
unm­_ªd_ç
;

1740 iàĞ((
desc
.
b
 & (6u<<9)è!ğ6è&& ((
d¶
 < 
ıl
è|| (d¶ < 
½l
)) )

1741 
unm­_ªd_ç
;

1744 }  !(
desc
.
b
 & 0x100) &&

1745 (
	`cmpxchg
(&
pdesc
->
b
, 
desc
.b, desc.b | 0x100) != desc.b) );

1748 
desc
.
b
 |= 0x100;

1750 
sk_acûs£d_æag
:

1751 
	`hvm_unm­_’Œy
(
pdesc
);

1753 
£gr
.
ba£
 = (((
desc
.
b
 << 0) & 0xff000000u) |

1754 ((
desc
.
b
 << 16) & 0x00ff0000u) |

1755 ((
desc
.
a
 >> 16) & 0x0000ffffu));

1756 
£gr
.
©Œ
.
by‹s
 = (((
desc
.
b
 >> 8) & 0x00ffu) |

1757 ((
desc
.
b
 >> 12) & 0x0f00u));

1758 
£gr
.
lim™
 = (
desc
.
b
 & 0x000f0000uè| (desc.
a
 & 0x0000ffffu);

1759 iàĞ
£gr
.
©Œ
.
f›lds
.
g
 )

1760 
£gr
.
lim™
 = (segr.limit << 12) | 0xfffu;

1761 
£gr
.
£l
 = sel;

1762 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
£g
, &
£gr
);

1766 
unm­_ªd_ç
:

1767 
	`hvm_unm­_’Œy
(
pdesc
);

1768 
ç
:

1769 
	`hvm_šjeù_exû±iÚ
(
çuÉ_ty³
, 
£l
 & 0xfffc, 0);

1770 
hvm_m­_ç
:

1772 
	}
}

1774 
	$hvm_sk_sw™ch
(

1775 
ušt16_t
 
tss_£l
, 
hvm_sk_sw™ch_»asÚ
 
sksw™ch_»asÚ
,

1776 
št32_t
 
”rcode
)

1778 
vıu
 *
v
 = 
cu¼’t
;

1779 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1780 
£gm’t_»gi¡”
 
gdt
, 
Œ
, 
´ev_Œ
, 
£gr
;

1781 
desc_¡ruù
 *
İtss_desc
 = 
NULL
, *
Åtss_desc
 = NULL, 
tss_desc
;

1782 
eæags
;

1783 
exn_¿i£d
, 
rc
;

1785 
u16
 
back_lšk
,
__blh
;

1786 
u32
 
e¥0
;

1787 
u16
 
ss0
, 
_0
;

1788 
u32
 
e¥1
;

1789 
u16
 
ss1
, 
_1
;

1790 
u32
 
e¥2
;

1791 
u16
 
ss2
, 
_2
;

1792 
u32
 
ü3
, 
e
, 
eæags
, 
—x
, 
ecx
, 
edx
, 
ebx
, 
e¥
, 
ebp
, 
esi
, 
edi
;

1793 
u16
 
es
, 
_3
, 
cs
, 
_4
, 
ss
, 
_5
, 
ds
, 
_6
, 
fs
, 
_7
, 
gs
, 
_8
, 
ldt
, 
_9
;

1794 
u16
 
Œaû
, 
iom­
;

1795 } 
tss
 = { 0 };

1797 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gdŒ
, &
gdt
);

1798 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_Œ
, &
´ev_Œ
);

1800 iàĞ((
tss_£l
 & 0xfff8è+ 7è> 
gdt
.
lim™
 )

1802 
	`hvm_šjeù_exû±iÚ
((
sksw™ch_»asÚ
 =ğ
TSW_œ‘
) ?

1803 
TRAP_šv®id_tss
 : 
TRAP_gp_çuÉ
,

1804 
tss_£l
 & 0xfff8, 0);

1805 
out
;

1808 
İtss_desc
 = 
	`hvm_m­_’Œy
(
gdt
.
ba£
 + (
´ev_Œ
.
£l
 & 0xfff8));

1809 iàĞ
İtss_desc
 =ğ
NULL
 )

1810 
out
;

1812 
Åtss_desc
 = 
	`hvm_m­_’Œy
(
gdt
.
ba£
 + (
tss_£l
 & 0xfff8));

1813 iàĞ
Åtss_desc
 =ğ
NULL
 )

1814 
out
;

1816 
tss_desc
 = *
Åtss_desc
;

1817 
Œ
.
£l
 = 
tss_£l
;

1818 
Œ
.
ba£
 = (((
tss_desc
.
b
 << 0) & 0xff000000u) |

1819 ((
tss_desc
.
b
 << 16) & 0x00ff0000u) |

1820 ((
tss_desc
.
a
 >> 16) & 0x0000ffffu));

1821 
Œ
.
©Œ
.
by‹s
 = (((
tss_desc
.
b
 >> 8) & 0x00ffu) |

1822 ((
tss_desc
.
b
 >> 12) & 0x0f00u));

1823 
Œ
.
lim™
 = (
tss_desc
.
b
 & 0x000f0000uè| (tss_desc.
a
 & 0x0000ffffu);

1824 iàĞ
Œ
.
©Œ
.
f›lds
.
g
 )

1825 
Œ
.
lim™
 = (tr.limit << 12) | 0xfffu;

1827 iàĞ!
Œ
.
©Œ
.
f›lds
.
p
 )

1829 
	`hvm_šjeù_exû±iÚ
(
TRAP_no_£gm’t
, 
tss_£l
 & 0xfff8, 0);

1830 
out
;

1833 iàĞ
Œ
.
©Œ
.
f›lds
.
ty³
 !ğ((
sksw™ch_»asÚ
 =ğ
TSW_œ‘
) ? 0xb : 0x9) )

1835 
	`hvm_šjeù_exû±iÚ
(

1836 (
sksw™ch_»asÚ
 =ğ
TSW_œ‘
è? 
TRAP_šv®id_tss
 : 
TRAP_gp_çuÉ
,

1837 
tss_£l
 & 0xfff8, 0);

1838 
out
;

1841 iàĞ
Œ
.
lim™
 < ((
tss
)-1) )

1843 
	`hvm_šjeù_exû±iÚ
(
TRAP_šv®id_tss
, 
tss_£l
 & 0xfff8, 0);

1844 
out
;

1847 
rc
 = 
	`hvm_cİy_äom_gue¡_vœt
(

1848 &
tss
, 
´ev_Œ
.
ba£
, Ñss), 
PFEC_·ge_´e£Á
);

1849 iàĞ
rc
 =ğ
HVMCOPY_bad_gva_to_gâ
 )

1850 
out
;

1851 iàĞ
rc
 =ğ
HVMCOPY_gâ_·ged_out
 )

1852 
out
;

1853 iàĞ
rc
 =ğ
HVMCOPY_gâ_sh¬ed
 )

1854 
out
;

1856 
eæags
 = 
»gs
->eflags;

1857 iàĞ
sksw™ch_»asÚ
 =ğ
TSW_œ‘
 )

1858 
eæags
 &ğ~
X86_EFLAGS_NT
;

1860 
tss
.
ü3
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

1861 
tss
.
e
 = 
»gs
->eip;

1862 
tss
.
eæags
 =ƒflags;

1863 
tss
.
—x
 = 
»gs
->eax;

1864 
tss
.
ecx
 = 
»gs
->ecx;

1865 
tss
.
edx
 = 
»gs
->edx;

1866 
tss
.
ebx
 = 
»gs
->ebx;

1867 
tss
.
e¥
 = 
»gs
->esp;

1868 
tss
.
ebp
 = 
»gs
->ebp;

1869 
tss
.
esi
 = 
»gs
->esi;

1870 
tss
.
edi
 = 
»gs
->edi;

1872 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
£gr
);

1873 
tss
.
es
 = 
£gr
.
£l
;

1874 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
£gr
);

1875 
tss
.
cs
 = 
£gr
.
£l
;

1876 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
£gr
);

1877 
tss
.
ss
 = 
£gr
.
£l
;

1878 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
£gr
);

1879 
tss
.
ds
 = 
£gr
.
£l
;

1880 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
£gr
);

1881 
tss
.
fs
 = 
£gr
.
£l
;

1882 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
£gr
);

1883 
tss
.
gs
 = 
£gr
.
£l
;

1884 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ldŒ
, &
£gr
);

1885 
tss
.
ldt
 = 
£gr
.
£l
;

1887 
rc
 = 
	`hvm_cİy_to_gue¡_vœt
(

1888 
´ev_Œ
.
ba£
, &
tss
, Ñss), 
PFEC_·ge_´e£Á
);

1889 iàĞ
rc
 =ğ
HVMCOPY_bad_gva_to_gâ
 )

1890 
out
;

1891 iàĞ
rc
 =ğ
HVMCOPY_gâ_·ged_out
 )

1892 
out
;

1893 iàĞ
rc
 =ğ
HVMCOPY_gâ_sh¬ed
 )

1894 
out
;

1896 
rc
 = 
	`hvm_cİy_äom_gue¡_vœt
(

1897 &
tss
, 
Œ
.
ba£
, Ñss), 
PFEC_·ge_´e£Á
);

1898 iàĞ
rc
 =ğ
HVMCOPY_bad_gva_to_gâ
 )

1899 
out
;

1900 iàĞ
rc
 =ğ
HVMCOPY_gâ_·ged_out
 )

1901 
out
;

1904 iàĞ
rc
 =ğ
HVMCOPY_gâ_sh¬ed
 )

1905 
out
;

1908 iàĞ
	`hvm_£t_ü3
(
tss
.
ü3
) )

1909 
out
;

1911 
»gs
->
e
 = 
tss
.eip;

1912 
»gs
->
eæags
 = 
tss
.eflags | 2;

1913 
»gs
->
—x
 = 
tss
.eax;

1914 
»gs
->
ecx
 = 
tss
.ecx;

1915 
»gs
->
edx
 = 
tss
.edx;

1916 
»gs
->
ebx
 = 
tss
.ebx;

1917 
»gs
->
e¥
 = 
tss
.esp;

1918 
»gs
->
ebp
 = 
tss
.ebp;

1919 
»gs
->
esi
 = 
tss
.esi;

1920 
»gs
->
edi
 = 
tss
.edi;

1922 iàĞ(
sksw™ch_»asÚ
 =ğ
TSW_ÿÎ_Ü_št
) )

1924 
»gs
->
eæags
 |ğ
X86_EFLAGS_NT
;

1925 
tss
.
back_lšk
 = 
´ev_Œ
.
£l
;

1928 
exn_¿i£d
 = 0;

1929 iàĞ
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_ldŒ
, 
tss
.
ldt
) ||

1930 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_es
, 
tss
.
es
) ||

1931 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_cs
, 
tss
.
cs
) ||

1932 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_ss
, 
tss
.
ss
) ||

1933 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_ds
, 
tss
.
ds
) ||

1934 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_fs
, 
tss
.
fs
) ||

1935 
	`hvm_lßd_£gm’t_£ËùÜ
(
x86_£g_gs
, 
tss
.
gs
) )

1936 
exn_¿i£d
 = 1;

1938 
rc
 = 
	`hvm_cİy_to_gue¡_vœt
(

1939 
Œ
.
ba£
, &
tss
, Ñss), 
PFEC_·ge_´e£Á
);

1940 iàĞ
rc
 =ğ
HVMCOPY_bad_gva_to_gâ
 )

1941 
exn_¿i£d
 = 1;

1942 iàĞ
rc
 =ğ
HVMCOPY_gâ_·ged_out
 )

1943 
out
;

1944 iàĞ
rc
 =ğ
HVMCOPY_gâ_sh¬ed
 )

1945 
out
;

1947 iàĞ(
tss
.
Œaû
 & 1è&& !
exn_¿i£d
 )

1948 
	`hvm_šjeù_exû±iÚ
(
TRAP_debug
, 
tss_£l
 & 0xfff8, 0);

1950 
Œ
.
©Œ
.
f›lds
.
ty³
 = 0xb;

1951 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_Œ
, &
Œ
);

1953 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] |ğ
X86_CR0_TS
;

1954 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

1956 iàĞ(
sksw™ch_»asÚ
 =ğ
TSW_œ‘
) ||

1957 (
sksw™ch_»asÚ
 =ğ
TSW_jmp
) )

1958 
	`ş—r_b™
(41, 
İtss_desc
);

1960 iàĞ
sksw™ch_»asÚ
 !ğ
TSW_œ‘
 )

1961 
	`£t_b™
(41, 
Åtss_desc
);

1963 iàĞ
”rcode
 >= 0 )

1965 
£gm’t_»gi¡”
 
»g
;

1966 
lš—r_addr
;

1967 
»gs
->
e¥
 -= 4;

1968 
	`hvm_g‘_£gm’t_»gi¡”
(
cu¼’t
, 
x86_£g_ss
, &
»g
);

1970 iàĞ
	`hvm_vœtu®_to_lš—r_addr
(
x86_£g_ss
, &
»g
, 
»gs
->
e¥
,

1971 4, 
hvm_acûss_wr™e
, 32,

1972 &
lš—r_addr
) )

1973 
	`hvm_cİy_to_gue¡_vœt_noçuÉ
(
lš—r_addr
, &
”rcode
, 4, 0);

1976 
out
:

1977 
	`hvm_unm­_’Œy
(
İtss_desc
);

1978 
	`hvm_unm­_’Œy
(
Åtss_desc
);

1979 
	}
}

1981 
	#HVMCOPY_äom_gue¡
 (0u<<0)

	)

1982 
	#HVMCOPY_to_gue¡
 (1u<<0)

	)

1983 
	#HVMCOPY_no_çuÉ
 (0u<<1)

	)

1984 
	#HVMCOPY_çuÉ
 (1u<<1)

	)

1985 
	#HVMCOPY_phys
 (0u<<2)

	)

1986 
	#HVMCOPY_vœt
 (1u<<2)

	)

1987 
hvm_cİy_»suÉ
 
	$__hvm_cİy
(

1988 *
buf
, 
·ddr_t
 
addr
, 
size
, 
æags
, 
ušt32_t
 
pãc
)

1990 
vıu
 *
cu¼
 = 
cu¼’t
;

1991 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼
->
domaš
);

1992 
gâ
, 
mâ
;

1993 
p2m_ty³_t
 
p2mt
;

1994 *
p
;

1995 
couÁ
, 
todo
 = 
size
;

2009 iàĞ
	`š_©omic
() )

2010  
HVMCOPY_unhªdËabË
;

2013  
todo
 > 0 )

2015 
couÁ
 = 
	`mš_t
(, 
PAGE_SIZE
 - (
addr
 & ~
PAGE_MASK
), 
todo
);

2017 iàĞ
æags
 & 
HVMCOPY_vœt
 )

2019 
gâ
 = 
	`·gšg_gva_to_gâ
(
cu¼
, 
addr
, &
pãc
);

2020 iàĞ
gâ
 =ğ
INVALID_GFN
 )

2022 iàĞ
pãc
 =ğ
PFEC_·ge_·ged
 )

2023  
HVMCOPY_gâ_·ged_out
;

2024 iàĞ
pãc
 =ğ
PFEC_·ge_sh¬ed
 )

2025  
HVMCOPY_gâ_sh¬ed
;

2026 iàĞ
æags
 & 
HVMCOPY_çuÉ
 )

2027 
	`hvm_šjeù_exû±iÚ
(
TRAP_·ge_çuÉ
, 
pãc
, 
addr
);

2028  
HVMCOPY_bad_gva_to_gâ
;

2033 
gâ
 = 
addr
 >> 
PAGE_SHIFT
;

2036 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ_unsh¬e
(
p2m
, 
gâ
, &
p2mt
, 0));

2038 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

2040 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
gâ
);

2041  
HVMCOPY_gâ_·ged_out
;

2043 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

2044  
HVMCOPY_gâ_sh¬ed
;

2045 iàĞ
	`p2m_is_g¿Á
(
p2mt
) )

2046  
HVMCOPY_unhªdËabË
;

2047 iàĞ!
	`p2m_is_¿m
(
p2mt
) )

2048  
HVMCOPY_bad_gâ_to_mâ
;

2049 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

2051 
p
 = (*)
	`m­_domaš_·ge
(
mâ
è+ (
addr
 & ~
PAGE_MASK
);

2053 iàĞ
æags
 & 
HVMCOPY_to_gue¡
 )

2055 iàĞ
p2mt
 =ğ
p2m_¿m_ro
 )

2057 
Ï¡·ge
;

2058 iàĞ
	`xchg
(&
Ï¡·ge
, 
gâ
) != gfn )

2059 
	`gd´štk
(
XENLOG_DEBUG
, "guest‡ttempted writeo„ead-only"

2061 
gâ
, 
mâ
);

2065 
	`memıy
(
p
, 
buf
, 
couÁ
);

2066 
	`·gšg_m¬k_dœty
(
cu¼
->
domaš
, 
mâ
);

2071 
	`memıy
(
buf
, 
p
, 
couÁ
);

2074 
	`unm­_domaš_·ge
(
p
);

2076 
addr
 +ğ
couÁ
;

2077 
buf
 +ğ
couÁ
;

2078 
todo
 -ğ
couÁ
;

2081  
HVMCOPY_okay
;

2082 
	}
}

2084 
hvm_cİy_»suÉ
 
	$hvm_cİy_to_gue¡_phys
(

2085 
·ddr_t
 
·ddr
, *
buf
, 
size
)

2087  
	`__hvm_cİy
(
buf
, 
·ddr
, 
size
,

2088 
HVMCOPY_to_gue¡
 | 
HVMCOPY_çuÉ
 | 
HVMCOPY_phys
,

2090 
	}
}

2092 
hvm_cİy_»suÉ
 
	$hvm_cİy_äom_gue¡_phys
(

2093 *
buf
, 
·ddr_t
 
·ddr
, 
size
)

2095  
	`__hvm_cİy
(
buf
, 
·ddr
, 
size
,

2096 
HVMCOPY_äom_gue¡
 | 
HVMCOPY_çuÉ
 | 
HVMCOPY_phys
,

2098 
	}
}

2100 
hvm_cİy_»suÉ
 
	$hvm_cİy_to_gue¡_vœt
(

2101 
vaddr
, *
buf
, 
size
, 
ušt32_t
 
pãc
)

2103  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2104 
HVMCOPY_to_gue¡
 | 
HVMCOPY_çuÉ
 | 
HVMCOPY_vœt
,

2105 
PFEC_·ge_´e£Á
 | 
PFEC_wr™e_acûss
 | 
pãc
);

2106 
	}
}

2108 
hvm_cİy_»suÉ
 
	$hvm_cİy_äom_gue¡_vœt
(

2109 *
buf
, 
vaddr
, 
size
, 
ušt32_t
 
pãc
)

2111  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2112 
HVMCOPY_äom_gue¡
 | 
HVMCOPY_çuÉ
 | 
HVMCOPY_vœt
,

2113 
PFEC_·ge_´e£Á
 | 
pãc
);

2114 
	}
}

2116 
hvm_cİy_»suÉ
 
	$hvm_ãtch_äom_gue¡_vœt
(

2117 *
buf
, 
vaddr
, 
size
, 
ušt32_t
 
pãc
)

2119 iàĞ
	`hvm_nx_’abËd
(
cu¼’t
) )

2120 
pãc
 |ğ
PFEC_š¢_ãtch
;

2121  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2122 
HVMCOPY_äom_gue¡
 | 
HVMCOPY_çuÉ
 | 
HVMCOPY_vœt
,

2123 
PFEC_·ge_´e£Á
 | 
pãc
);

2124 
	}
}

2126 
hvm_cİy_»suÉ
 
	$hvm_cİy_to_gue¡_vœt_noçuÉ
(

2127 
vaddr
, *
buf
, 
size
, 
ušt32_t
 
pãc
)

2129  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2130 
HVMCOPY_to_gue¡
 | 
HVMCOPY_no_çuÉ
 | 
HVMCOPY_vœt
,

2131 
PFEC_·ge_´e£Á
 | 
PFEC_wr™e_acûss
 | 
pãc
);

2132 
	}
}

2134 
hvm_cİy_»suÉ
 
	$hvm_cİy_äom_gue¡_vœt_noçuÉ
(

2135 *
buf
, 
vaddr
, 
size
, 
ušt32_t
 
pãc
)

2137  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2138 
HVMCOPY_äom_gue¡
 | 
HVMCOPY_no_çuÉ
 | 
HVMCOPY_vœt
,

2139 
PFEC_·ge_´e£Á
 | 
pãc
);

2140 
	}
}

2142 
hvm_cİy_»suÉ
 
	$hvm_ãtch_äom_gue¡_vœt_noçuÉ
(

2143 *
buf
, 
vaddr
, 
size
, 
ušt32_t
 
pãc
)

2145 iàĞ
	`hvm_nx_’abËd
(
cu¼’t
) )

2146 
pãc
 |ğ
PFEC_š¢_ãtch
;

2147  
	`__hvm_cİy
(
buf
, 
vaddr
, 
size
,

2148 
HVMCOPY_äom_gue¡
 | 
HVMCOPY_no_çuÉ
 | 
HVMCOPY_vœt
,

2149 
PFEC_·ge_´e£Á
 | 
pãc
);

2150 
	}
}

2152 
	$cİy_to_u£r_hvm
(*
to
, cÚ¡ *
äom
, 
Ën
)

2154 
rc
;

2156 #ifdeà
__x86_64__


2157 iàĞ!
cu¼’t
->
¬ch
.
hvm_vıu
.
hÿÎ_64b™
 &&

2158 
	`is_com·t_¬g_xÏt_¿nge
(
to
, 
Ën
) )

2160 
	`memıy
(
to
, 
äom
, 
Ën
);

2165 
rc
 = 
	`hvm_cİy_to_gue¡_vœt_noçuÉ
(()
to
, (*)
äom
,

2166 
Ën
, 0);

2167  
rc
 ? 
Ën
 : 0;

2168 
	}
}

2170 
	$cİy_äom_u£r_hvm
(*
to
, cÚ¡ *
äom
, 
Ën
)

2172 
rc
;

2174 #ifdeà
__x86_64__


2175 iàĞ!
cu¼’t
->
¬ch
.
hvm_vıu
.
hÿÎ_64b™
 &&

2176 
	`is_com·t_¬g_xÏt_¿nge
(
äom
, 
Ën
) )

2178 
	`memıy
(
to
, 
äom
, 
Ën
);

2183 
rc
 = 
	`hvm_cİy_äom_gue¡_vœt_noçuÉ
(
to
, ()
äom
, 
Ën
, 0);

2184  
rc
 ? 
Ën
 : 0;

2185 
	}
}

2187 
	$hvm_ıuid
(
šput
, *
—x
, *
ebx
,

2188 *
ecx
, *
edx
)

2190 
vıu
 *
v
 = 
cu¼’t
;

2191 
couÁ
 = *
ecx
;

2193 iàĞ
	`ıuid_vœidŸn_Ëaves
(
šput
, 
—x
, 
ebx
, 
ecx
, 
edx
) )

2196 iàĞ
	`ıuid_hy³rvisÜ_Ëaves
(
šput
, 
couÁ
, 
—x
, 
ebx
, 
ecx
, 
edx
) )

2199 
	`domaš_ıuid
(
v
->
domaš
, 
šput
, *
ecx
, 
—x
, 
ebx
,ƒcx, 
edx
);

2201  
šput
 )

2205 *
ebx
 &= 0x00FFFFFFu;

2206 *
ebx
 |ğ(
v
->
vıu_id
 * 2) << 24;

2207 iàĞ
	`vÏpic_hw_di§bËd
(
	`vıu_vÏpic
(
v
)) )

2208 
	`__ş—r_b™
(
X86_FEATURE_APIC
 & 31, 
edx
);

2211 iàĞ
	`x§ve_’abËd
(
v
) )

2212 *
ecx
 |ğ(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] & 
X86_CR4_OSXSAVE
) ?

2213 
	`ıuã©_mask
(
X86_FEATURE_OSXSAVE
) : 0;

2217 *
edx
 = 
v
->
vıu_id
 * 2;

2221 
sub_Ëaf
, 
_—x
, 
_ebx
, 
_ecx
, 
_edx
;

2223 iàĞ
couÁ
 =ğ0 && 
v
->
¬ch
.
xü0
 )

2226 *
ebx
 = 
XSAVE_AREA_MIN_SIZE
;

2227  
sub_Ëaf
 = 2; sub_leaf < 64; sub_leaf++ )

2229 iàĞ!(
v
->
¬ch
.
xü0
 & (1ULL << 
sub_Ëaf
)) )

2231 
	`domaš_ıuid
(
v
->
domaš
, 
šput
, 
sub_Ëaf
, &
_—x
, &
_ebx
, &
_ecx
,

2232 &
_edx
);

2233 iàĞ(
_—x
 + 
_ebx
è> *
ebx
 )

2234 *
ebx
 = 
_—x
 + 
_ebx
;

2242 iàĞ
v
->
domaš
->
¬ch
.
tsc_mode
 !ğ
TSC_MODE_DEFAULT
 ||

2243 !
	`ho¡_tsc_is_§ã
() )

2244 *
edx
 &ğ~
	`ıuã©_mask
(
X86_FEATURE_RDTSCP
);

2247 
	}
}

2249 
	$hvm_rdtsc_š‹rû±
(
ıu_u£r_»gs
 *
»gs
)

2251 
ušt64_t
 
tsc
;

2252 
vıu
 *
v
 = 
cu¼’t
;

2254 
tsc
 = 
	`hvm_g‘_gue¡_tsc
(
v
);

2255 
»gs
->
—x
 = (
ušt32_t
)
tsc
;

2256 
»gs
->
edx
 = (
ušt32_t
)(
tsc
 >> 32);

2258 
	`HVMTRACE_2D
(
RDTSC
, 
»gs
->
—x
,„egs->
edx
);

2259 
	}
}

2261 
	$hvm_m¤_»ad_š‹rû±
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

2263 
vıu
 *
v
 = 
cu¼’t
;

2264 
ušt64_t
 *
v¬_¿nge_ba£
, *
fixed_¿nge_ba£
;

2265 
šdex
, 
mŒr
;

2266 
ušt32_t
 
ıuid
[4];

2267 
»t
 = 
X86EMUL_OKAY
;

2269 
v¬_¿nge_ba£
 = (
ušt64_t
 *)
v
->
¬ch
.
hvm_vıu
.
mŒr
.
v¬_¿nges
;

2270 
fixed_¿nge_ba£
 = (
ušt64_t
 *)
v
->
¬ch
.
hvm_vıu
.
mŒr
.
fixed_¿nges
;

2272 
	`hvm_ıuid
(1, &
ıuid
[0], &cpuid[1], &cpuid[2], &cpuid[3]);

2273 
mŒr
 = !!(
ıuid
[3] & 
	`ıuã©_mask
(
X86_FEATURE_MTRR
));

2275  
m¤
 )

2277 
MSR_EFER
:

2278 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
;

2281 
MSR_IA32_TSC
:

2282 *
m¤_cÚ‹Á
 = 
	`hvm_g‘_gue¡_tsc
(
v
);

2285 
MSR_TSC_AUX
:

2286 *
m¤_cÚ‹Á
 = 
	`hvm_m¤_tsc_aux
(
v
);

2289 
MSR_IA32_APICBASE
:

2290 *
m¤_cÚ‹Á
 = 
	`vıu_vÏpic
(
v
)->
hw
.
­ic_ba£_m¤
;

2293 
MSR_IA32_APICBASE_MSR
 ... MSR_IA32_APICBASE_MSR + 0x3ff:

2294 iàĞ
	`hvm_x2­ic_m¤_»ad
(
v
, 
m¤
, 
m¤_cÚ‹Á
) )

2295 
gp_çuÉ
;

2298 
MSR_IA32_TSC_DEADLINE
:

2299 *
m¤_cÚ‹Á
 = 
	`vÏpic_tdt_m¤_g‘
(
	`vıu_vÏpic
(
v
));

2302 
MSR_IA32_CR_PAT
:

2303 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_vıu
.
·t_ü
;

2306 
MSR_MTRRÿp
:

2307 iàĞ!
mŒr
 )

2308 
gp_çuÉ
;

2309 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_vıu
.
mŒr
.
mŒr_ÿp
;

2311 
MSR_MTRRdefTy³
:

2312 iàĞ!
mŒr
 )

2313 
gp_çuÉ
;

2314 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_vıu
.
mŒr
.
def_ty³


2315 | (
v
->
¬ch
.
hvm_vıu
.
mŒr
.
’abËd
 << 10);

2317 
MSR_MTRRfix64K_00000
:

2318 iàĞ!
mŒr
 )

2319 
gp_çuÉ
;

2320 *
m¤_cÚ‹Á
 = 
fixed_¿nge_ba£
[0];

2322 
MSR_MTRRfix16K_80000
:

2323 
MSR_MTRRfix16K_A0000
:

2324 iàĞ!
mŒr
 )

2325 
gp_çuÉ
;

2326 
šdex
 = 
m¤
 - 
MSR_MTRRfix16K_80000
;

2327 *
m¤_cÚ‹Á
 = 
fixed_¿nge_ba£
[
šdex
 + 1];

2329 
MSR_MTRRfix4K_C0000
...
MSR_MTRRfix4K_F8000
:

2330 iàĞ!
mŒr
 )

2331 
gp_çuÉ
;

2332 
šdex
 = 
m¤
 - 
MSR_MTRRfix4K_C0000
;

2333 *
m¤_cÚ‹Á
 = 
fixed_¿nge_ba£
[
šdex
 + 3];

2335 
MSR_IA32_MTRR_PHYSBASE0
...
MSR_IA32_MTRR_PHYSMASK7
:

2336 iàĞ!
mŒr
 )

2337 
gp_çuÉ
;

2338 
šdex
 = 
m¤
 - 
MSR_IA32_MTRR_PHYSBASE0
;

2339 *
m¤_cÚ‹Á
 = 
v¬_¿nge_ba£
[
šdex
];

2342 
MSR_K8_ENABLE_C1E
:

2343 
MSR_AMD64_NB_CFG
:

2349 *
m¤_cÚ‹Á
 = 0;

2353 iàĞ(
»t
 = 
	`vmû_rdm¤
(
m¤
, 
m¤_cÚ‹Á
)) < 0 )

2354 
gp_çuÉ
;

2356 
»t
 = ((ret == 0)

2357 ? 
hvm_funcs
.
	`m¤_»ad_š‹rû±
(
m¤
, 
m¤_cÚ‹Á
)

2358 : 
X86EMUL_OKAY
);

2362 
out
:

2363 
	`HVMTRACE_3D
(
MSR_READ
, 
m¤
,

2364 (
ušt32_t
)*
m¤_cÚ‹Á
, (uint32_t)(*msr_content >> 32));

2365  
»t
;

2367 
gp_çuÉ
:

2368 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

2369 
»t
 = 
X86EMUL_EXCEPTION
;

2370 *
m¤_cÚ‹Á
 = -1ull;

2371 
out
;

2372 
	}
}

2374 
	$hvm_m¤_wr™e_š‹rû±
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

2376 
vıu
 *
v
 = 
cu¼’t
;

2377 
šdex
, 
mŒr
;

2378 
ušt32_t
 
ıuid
[4];

2379 
»t
 = 
X86EMUL_OKAY
;

2381 
	`HVMTRACE_3D
(
MSR_WRITE
, 
m¤
,

2382 (
ušt32_t
)
m¤_cÚ‹Á
, (uint32_t)(msr_content >> 32));

2384 
	`hvm_ıuid
(1, &
ıuid
[0], &cpuid[1], &cpuid[2], &cpuid[3]);

2385 
mŒr
 = !!(
ıuid
[3] & 
	`ıuã©_mask
(
X86_FEATURE_MTRR
));

2387  
m¤
 )

2389 
MSR_EFER
:

2390 iàĞ
	`hvm_£t_eãr
(
m¤_cÚ‹Á
) )

2391  
X86EMUL_EXCEPTION
;

2394 
MSR_IA32_TSC
:

2395 
	`hvm_£t_gue¡_tsc
(
v
, 
m¤_cÚ‹Á
);

2398 
MSR_TSC_AUX
:

2399 
v
->
¬ch
.
hvm_vıu
.
m¤_tsc_aux
 = (
ušt32_t
)
m¤_cÚ‹Á
;

2400 iàĞ
ıu_has_rdtsı


2401 && (
v
->
domaš
->
¬ch
.
tsc_mode
 !ğ
TSC_MODE_PVRDTSCP
) )

2402 
	`wrm¤l
(
MSR_TSC_AUX
, (
ušt32_t
)
m¤_cÚ‹Á
);

2405 
MSR_IA32_APICBASE
:

2406 
	`vÏpic_m¤_£t
(
	`vıu_vÏpic
(
v
), 
m¤_cÚ‹Á
);

2409 
MSR_IA32_TSC_DEADLINE
:

2410 
	`vÏpic_tdt_m¤_£t
(
	`vıu_vÏpic
(
v
), 
m¤_cÚ‹Á
);

2413 
MSR_IA32_APICBASE_MSR
 ... MSR_IA32_APICBASE_MSR + 0x3ff:

2414 iàĞ
	`hvm_x2­ic_m¤_wr™e
(
v
, 
m¤
, 
m¤_cÚ‹Á
) )

2415 
gp_çuÉ
;

2418 
MSR_IA32_CR_PAT
:

2419 iàĞ!
	`·t_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
·t_ü
, 
m¤_cÚ‹Á
) )

2420 
gp_çuÉ
;

2423 
MSR_MTRRÿp
:

2424 iàĞ!
mŒr
 )

2425 
gp_çuÉ
;

2426 
gp_çuÉ
;

2427 
MSR_MTRRdefTy³
:

2428 iàĞ!
mŒr
 )

2429 
gp_çuÉ
;

2430 iàĞ!
	`mŒr_def_ty³_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
mŒr
, 
m¤_cÚ‹Á
) )

2431 
gp_çuÉ
;

2433 
MSR_MTRRfix64K_00000
:

2434 iàĞ!
mŒr
 )

2435 
gp_çuÉ
;

2436 iàĞ!
	`mŒr_fix_¿nge_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
mŒr
, 0, 
m¤_cÚ‹Á
) )

2437 
gp_çuÉ
;

2439 
MSR_MTRRfix16K_80000
:

2440 
MSR_MTRRfix16K_A0000
:

2441 iàĞ!
mŒr
 )

2442 
gp_çuÉ
;

2443 
šdex
 = 
m¤
 - 
MSR_MTRRfix16K_80000
 + 1;

2444 iàĞ!
	`mŒr_fix_¿nge_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
mŒr
,

2445 
šdex
, 
m¤_cÚ‹Á
) )

2446 
gp_çuÉ
;

2448 
MSR_MTRRfix4K_C0000
...
MSR_MTRRfix4K_F8000
:

2449 iàĞ!
mŒr
 )

2450 
gp_çuÉ
;

2451 
šdex
 = 
m¤
 - 
MSR_MTRRfix4K_C0000
 + 3;

2452 iàĞ!
	`mŒr_fix_¿nge_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
mŒr
,

2453 
šdex
, 
m¤_cÚ‹Á
) )

2454 
gp_çuÉ
;

2456 
MSR_IA32_MTRR_PHYSBASE0
...
MSR_IA32_MTRR_PHYSMASK7
:

2457 iàĞ!
mŒr
 )

2458 
gp_çuÉ
;

2459 iàĞ!
	`mŒr_v¬_¿nge_m¤_£t
(
v
->
domaš
, &v->
¬ch
.
hvm_vıu
.
mŒr
,

2460 
m¤
, 
m¤_cÚ‹Á
) )

2461 
gp_çuÉ
;

2464 
MSR_AMD64_NB_CFG
:

2469 iàĞ(
»t
 = 
	`vmû_wrm¤
(
m¤
, 
m¤_cÚ‹Á
)) < 0 )

2470 
gp_çuÉ
;

2472 
»t
 = ((ret == 0)

2473 ? 
hvm_funcs
.
	`m¤_wr™e_š‹rû±
(
m¤
, 
m¤_cÚ‹Á
)

2474 : 
X86EMUL_OKAY
);

2478  
»t
;

2480 
gp_çuÉ
:

2481 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

2482  
X86EMUL_EXCEPTION
;

2483 
	}
}

2485 
hvm_štblk
 
	$hvm_š‹¼u±_blocked
(
vıu
 *
v
, 
hvm_šck
 
šck
)

2487 
šŒ_shadow
;

2489 
	`ASSERT
(
v
 =ğ
cu¼’t
);

2491 iàĞ(
šck
.
sourû
 !ğ
hvm_št¤c_nmi
) &&

2492 !(
	`gue¡_ıu_u£r_»gs
()->
eæags
 & 
X86_EFLAGS_IF
) )

2493  
hvm_štblk_ræags_›
;

2495 
šŒ_shadow
 = 
hvm_funcs
.
	`g‘_š‹¼u±_shadow
(
v
);

2497 iàĞ
šŒ_shadow
 & (
HVM_INTR_SHADOW_STI
|
HVM_INTR_SHADOW_MOV_SS
) )

2498  
hvm_štblk_shadow
;

2500 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_nmi
 )

2501  ((
šŒ_shadow
 & 
HVM_INTR_SHADOW_NMI
) ?

2502 
hvm_štblk_nmi_œ‘
 : 
hvm_štblk_nÚe
);

2504 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_Ïpic
 )

2506 
ušt32_t
 
r
 = 
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
) & 0xF0;

2507 iàĞ(
r
 >> 4è>ğ(
šck
.
veùÜ
 >> 4) )

2508  
hvm_štblk_r
;

2511  
hvm_štblk_nÚe
;

2512 
	}
}

2514 
	$g¿Á_bË_İ_is_®lowed
(
cmd
)

2516 
cmd
) {

2517 
GNTTABOP_qu”y_size
:

2518 
GNTTABOP_£tup_bË
:

2519 
GNTTABOP_£t_v”siÚ
:

2520 
GNTTABOP_cİy
:

2521 
GNTTABOP_m­_g¿Á_»f
:

2522 
GNTTABOP_unm­_g¿Á_»f
:

2528 
	}
}

2530 
hvm_g¿Á_bË_İ
(

2531 
cmd
, 
	$XEN_GUEST_HANDLE
(è
uİ
, 
couÁ
)

2533 iàĞ!
	`g¿Á_bË_İ_is_®lowed
(
cmd
) )

2534  -
ENOSYS
;

2535  
	`do_g¿Á_bË_İ
(
cmd
, 
uİ
, 
couÁ
);

2536 
	}
}

2538 
hvm_memÜy_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2540 
rc
 = 
	`do_memÜy_İ
(
cmd
, 
¬g
);

2541 iàĞ(
cmd
 & 
MEMOP_CMD_MASK
è=ğ
XENMEM_deü—£_»£rv©iÚ
 )

2542 
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
qemu_m­ÿche_šv®id©e
 = 1;

2543  
rc
;

2544 
	}
}

2546 
hvm_physdev_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2548  
cmd
 )

2550 
PHYSDEVOP_m­_pœq
:

2551 
PHYSDEVOP_unm­_pœq
:

2552 
PHYSDEVOP_eoi
:

2553 
PHYSDEVOP_œq_¡©us_qu”y
:

2554 
PHYSDEVOP_g‘_ä“_pœq
:

2555  
	`do_physdev_İ
(
cmd
, 
¬g
);

2557  -
ENOSYS
;

2559 
	}
}

2561 
hvm_vıu_İ
(

2562 
cmd
, 
vıuid
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2564 
rc
;

2566  
cmd
 )

2568 
VCPUOP_»gi¡”_run¡©e_memÜy_¬—
:

2569 
VCPUOP_g‘_run¡©e_šfo
:

2570 
VCPUOP_£t_³riodic_tim”
:

2571 
VCPUOP_¡İ_³riodic_tim”
:

2572 
VCPUOP_£t_sšgËshÙ_tim”
:

2573 
VCPUOP_¡İ_sšgËshÙ_tim”
:

2574 
rc
 = 
	`do_vıu_İ
(
cmd
, 
vıuid
, 
¬g
);

2577 
rc
 = -
ENOSYS
;

2581  
rc
;

2582 
	}
}

2584 
	thvm_hy³rÿÎ_t
(

2588 
	#HYPERCALL
(
x
) \

2589 [ 
__HYPERVISOR_
 ## 
x
 ] = (
hvm_hy³rÿÎ_t
 *è
do_
 ## 
	)
x

2591 #ià
defšed
(
__i386__
)

2593 
hvm_hy³rÿÎ_t
 *
	ghvm_hy³rÿÎ32_bË
[
NR_hy³rÿÎs
] = {

2594 [ 
__HYPERVISOR_memÜy_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_memÜy_İ
,

2595 [ 
__HYPERVISOR_g¿Á_bË_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_g¿Á_bË_İ
,

2596 [ 
__HYPERVISOR_vıu_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_vıu_İ
,

2597 [ 
__HYPERVISOR_physdev_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_physdev_İ
,

2598 
HYPERCALL
(
x’_v”siÚ
),

2599 
HYPERCALL
(
ev’t_chªÃl_İ
),

2600 
HYPERCALL
(
sched_İ
),

2601 
HYPERCALL
(
£t_tim”_İ
),

2602 
HYPERCALL
(
hvm_İ
),

2603 
HYPERCALL
(
sysùl
),

2604 
HYPERCALL
(
tmem_İ
)

2609 
hvm_g¿Á_bË_İ_com·t32
(
cmd
,

2610 
	$XEN_GUEST_HANDLE
(è
uİ
,

2611 
couÁ
)

2613 iàĞ!
	`g¿Á_bË_İ_is_®lowed
(
cmd
) )

2614  -
ENOSYS
;

2615  
	`com·t_g¿Á_bË_İ
(
cmd
, 
uİ
, 
couÁ
);

2616 
	}
}

2618 
hvm_memÜy_İ_com·t32
(
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2620 
rc
 = 
	`com·t_memÜy_İ
(
cmd
, 
¬g
);

2621 iàĞ(
cmd
 & 
MEMOP_CMD_MASK
è=ğ
XENMEM_deü—£_»£rv©iÚ
 )

2622 
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
qemu_m­ÿche_šv®id©e
 = 1;

2623  
rc
;

2624 
	}
}

2626 
hvm_vıu_İ_com·t32
(

2627 
cmd
, 
vıuid
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2629 
rc
;

2631  
cmd
 )

2633 
VCPUOP_»gi¡”_run¡©e_memÜy_¬—
:

2634 
VCPUOP_g‘_run¡©e_šfo
:

2635 
VCPUOP_£t_³riodic_tim”
:

2636 
VCPUOP_¡İ_³riodic_tim”
:

2637 
VCPUOP_£t_sšgËshÙ_tim”
:

2638 
VCPUOP_¡İ_sšgËshÙ_tim”
:

2639 
rc
 = 
	`com·t_vıu_İ
(
cmd
, 
vıuid
, 
¬g
);

2642 
rc
 = -
ENOSYS
;

2646  
rc
;

2647 
	}
}

2649 
hvm_physdev_İ_com·t32
(

2650 
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

2652  
cmd
 )

2654 
PHYSDEVOP_m­_pœq
:

2655 
PHYSDEVOP_unm­_pœq
:

2656 
PHYSDEVOP_eoi
:

2657 
PHYSDEVOP_œq_¡©us_qu”y
:

2658 
PHYSDEVOP_g‘_ä“_pœq
:

2659  
	`com·t_physdev_İ
(
cmd
, 
¬g
);

2662  -
ENOSYS
;

2665 
	}
}

2667 
hvm_hy³rÿÎ_t
 *
	ghvm_hy³rÿÎ64_bË
[
NR_hy³rÿÎs
] = {

2668 [ 
__HYPERVISOR_memÜy_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_memÜy_İ
,

2669 [ 
__HYPERVISOR_g¿Á_bË_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_g¿Á_bË_İ
,

2670 [ 
__HYPERVISOR_vıu_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_vıu_İ
,

2671 [ 
__HYPERVISOR_physdev_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_physdev_İ
,

2672 
HYPERCALL
(
x’_v”siÚ
),

2673 
HYPERCALL
(
ev’t_chªÃl_İ
),

2674 
HYPERCALL
(
sched_İ
),

2675 
HYPERCALL
(
£t_tim”_İ
),

2676 
HYPERCALL
(
hvm_İ
),

2677 
HYPERCALL
(
sysùl
),

2678 
HYPERCALL
(
tmem_İ
)

2681 
	#COMPAT_CALL
(
x
) \

2682 [ 
__HYPERVISOR_
 ## 
x
 ] = (
hvm_hy³rÿÎ_t
 *è
com·t_
 ## 
	)
x

2684 
hvm_hy³rÿÎ_t
 *
	ghvm_hy³rÿÎ32_bË
[
NR_hy³rÿÎs
] = {

2685 [ 
__HYPERVISOR_memÜy_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_memÜy_İ_com·t32
,

2686 [ 
__HYPERVISOR_g¿Á_bË_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_g¿Á_bË_İ_com·t32
,

2687 [ 
__HYPERVISOR_vıu_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_vıu_İ_com·t32
,

2688 [ 
__HYPERVISOR_physdev_İ
 ] = (
hvm_hy³rÿÎ_t
 *)
hvm_physdev_İ_com·t32
,

2689 
COMPAT_CALL
(
x’_v”siÚ
),

2690 
HYPERCALL
(
ev’t_chªÃl_İ
),

2691 
COMPAT_CALL
(
sched_İ
),

2692 
COMPAT_CALL
(
£t_tim”_İ
),

2693 
HYPERCALL
(
hvm_İ
),

2694 
HYPERCALL
(
sysùl
),

2695 
HYPERCALL
(
tmem_İ
)

2700 
	$hvm_do_hy³rÿÎ
(
ıu_u£r_»gs
 *
»gs
)

2702 
vıu
 *
cu¼
 = 
cu¼’t
;

2703 
£gm’t_»gi¡”
 
¤eg
;

2704 
mode
 = 
	`hvm_gue¡_x86_mode
(
cu¼
);

2705 
ušt32_t
 
—x
 = 
»gs
->eax;

2707  
mode
 )

2709 #ifdeà
__x86_64__


2714 
	`hvm_g‘_£gm’t_»gi¡”
(
cu¼
, 
x86_£g_ss
, &
¤eg
);

2715 iàĞ
	`uÆik–y
(
¤eg
.
©Œ
.
f›lds
.
d¶
 == 3) )

2718 
»gs
->
—x
 = -
EPERM
;

2719  
HVM_HCALL_com¶‘ed
;

2725 iàĞ(
—x
 & 0x80000000è&& 
	`is_vœidŸn_domaš
(
cu¼
->
domaš
) )

2726  
	`vœidŸn_hy³rÿÎ
(
»gs
);

2728 iàĞ(
—x
 >ğ
NR_hy³rÿÎs
è|| !
hvm_hy³rÿÎ32_bË
[eax] )

2730 
»gs
->
—x
 = -
ENOSYS
;

2731  
HVM_HCALL_com¶‘ed
;

2734 
cu¼
->
¬ch
.
hvm_vıu
.
hÿÎ_´“m±ed
 = 0;

2736 #ifdeà
__x86_64__


2737 iàĞ
mode
 == 8 )

2739 
	`HVM_DBG_LOG
(
DBG_LEVEL_HCALL
, "hcall%u(%lx, %lx, %lx, %lx, %lx, %lx)",

2740 
—x
, 
»gs
->
rdi
,„egs->
rsi
,„egs->
rdx
,

2741 
»gs
->
r10
,„egs->
r8
,„egs->
r9
);

2743 
cu¼
->
¬ch
.
hvm_vıu
.
hÿÎ_64b™
 = 1;

2744 
»gs
->
¿x
 = 
hvm_hy³rÿÎ64_bË
[
—x
]Ôegs->
rdi
,

2745 
»gs
->
rsi
,

2746 
»gs
->
rdx
,

2747 
»gs
->
r10
,

2748 
»gs
->
r8
,

2749 
»gs
->
r9
);

2750 
cu¼
->
¬ch
.
hvm_vıu
.
hÿÎ_64b™
 = 0;

2755 
	`HVM_DBG_LOG
(
DBG_LEVEL_HCALL
, "hÿÎ%u(%x, %x, %x, %x, %x, %x)", 
—x
,

2756 (
ušt32_t
)
»gs
->
ebx
, (ušt32_tìegs->
ecx
,

2757 (
ušt32_t
)
»gs
->
edx
, (ušt32_tìegs->
esi
,

2758 (
ušt32_t
)
»gs
->
edi
, (ušt32_tìegs->
ebp
);

2760 
»gs
->
—x
 = 
hvm_hy³rÿÎ32_bË
[—x]((
ušt32_t
ìegs->
ebx
,

2761 (
ušt32_t
)
»gs
->
ecx
,

2762 (
ušt32_t
)
»gs
->
edx
,

2763 (
ušt32_t
)
»gs
->
esi
,

2764 (
ušt32_t
)
»gs
->
edi
,

2765 (
ušt32_t
)
»gs
->
ebp
);

2768 
	`HVM_DBG_LOG
(
DBG_LEVEL_HCALL
, "hcall%u -> %lx",

2769 
—x
, ()
»gs
->eax);

2771 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
hÿÎ_´“m±ed
 )

2772  
HVM_HCALL_´“m±ed
;

2774 iàĞ
	`uÆik–y
(
cu¼
->
domaš
->
¬ch
.
hvm_domaš
.
qemu_m­ÿche_šv®id©e
) &&

2775 
	`‹¡_ªd_ş—r_boŞ
(
cu¼
->
domaš
->
¬ch
.
hvm_domaš
.

2776 
qemu_m­ÿche_šv®id©e
) )

2777  
HVM_HCALL_šv®id©e
;

2779  
HVM_HCALL_com¶‘ed
;

2780 
	}
}

2782 
	$hvm_Ïtch_shšfo_size
(
domaš
 *
d
)

2784 
boŞ_t
 
Ãw_has_32b™
;

2792 iàĞ
cu¼’t
->
domaš
 =ğ
d
 ) {

2793 
Ãw_has_32b™
 = (
	`hvm_gue¡_x86_mode
(
cu¼’t
) != 8);

2794 ià(
Ãw_has_32b™
 !ğ
d
->
¬ch
.
has_32b™_shšfo
) {

2795 
d
->
¬ch
.
has_32b™_shšfo
 = 
Ãw_has_32b™
;

2807 
	`upd©e_domaš_w®lşock_time
(
d
);

2810 
	}
}

2814 
	$hvm_hy³rÿÎ_·ge_š™Ÿli£
(
domaš
 *
d
,

2815 *
hy³rÿÎ_·ge
)

2817 
	`hvm_Ïtch_shšfo_size
(
d
);

2818 
hvm_funcs
.
	`š™_hy³rÿÎ_·ge
(
d
, 
hy³rÿÎ_·ge
);

2819 
	}
}

2821 
hvmİ_£t_pci_štx_Ëv–
(

2822 
	$XEN_GUEST_HANDLE
(
x’_hvm_£t_pci_štx_Ëv–_t
è
uİ
)

2824 
x’_hvm_£t_pci_štx_Ëv–
 
İ
;

2825 
domaš
 *
d
;

2826 
rc
;

2828 iàĞ
	`cİy_äom_gue¡
(&
İ
, 
uİ
, 1) )

2829  -
EFAULT
;

2831 iàĞ(
İ
.
domaš
 > 0è|| (İ.
bus
 > 0è|| (İ.
deviû
 > 31è|| (İ.
štx
 > 3) )

2832  -
EINVAL
;

2834 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
İ
.
domid
, &
d
);

2835 iàĞ
rc
 != 0 )

2836  
rc
;

2838 
rc
 = -
EINVAL
;

2839 iàĞ!
	`is_hvm_domaš
(
d
) )

2840 
out
;

2842 
rc
 = 
	`xsm_hvm_£t_pci_štx_Ëv–
(
d
);

2843 iàĞ
rc
 )

2844 
out
;

2846 
rc
 = 0;

2847  
İ
.
Ëv–
 )

2850 
	`hvm_pci_štx_d—s£¹
(
d
, 
İ
.
deviû
, op.
štx
);

2853 
	`hvm_pci_štx_as£¹
(
d
, 
İ
.
deviû
, op.
štx
);

2856 
rc
 = -
EINVAL
;

2860 
out
:

2861 
	`rcu_uÆock_domaš
(
d
);

2862  
rc
;

2863 
	}
}

2865 
	$hvm_vıu_»£t_¡©e
(
vıu
 *
v
, 
ušt16_t
 
cs
, ušt16_ˆ

)

2867 
domaš
 *
d
 = 
v
->domain;

2868 
vıu_gue¡_cÚ‹xt
 *
ùxt
;

2869 
£gm’t_»gi¡”
 
»g
;

2871 
	`BUG_ON
(
	`vıu_ruÂabË
(
v
));

2873 
	`domaš_lock
(
d
);

2875 iàĞ
v
->
is_š™Ÿli£d
 )

2876 
out
;

2878 iàĞ!
	`·gšg_mode_h­
(
d
) )

2880 iàĞ
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PG
 )

2881 
	`put_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

2882 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

2885 
ùxt
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
;

2886 
	`mem£t
(
ùxt
, 0, (*ctxt));

2887 
ùxt
->
æags
 = 
VGCF_Úlše
;

2888 
ùxt
->
u£r_»gs
.
eæags
 = 2;

2889 
ùxt
->
u£r_»gs
.
edx
 = 0x00000f00;

2890 
ùxt
->
u£r_»gs
.
e
 = 

;

2892 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
X86_CR0_ET
;

2893 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

2895 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 0;

2896 
	`hvm_upd©e_gue¡_ü
(
v
, 2);

2898 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = 0;

2899 
	`hvm_upd©e_gue¡_ü
(
v
, 3);

2901 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 0;

2902 
	`hvm_upd©e_gue¡_ü
(
v
, 4);

2904 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 = 0;

2905 
	`hvm_upd©e_gue¡_eãr
(
v
);

2907 
»g
.
£l
 = 
cs
;

2908 
»g
.
ba£
 = (
ušt32_t
ìeg.
£l
 << 4;

2909 
»g
.
lim™
 = 0xffff;

2910 
»g
.
©Œ
.
by‹s
 = 0x09b;

2911 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
»g
);

2913 
»g
.
£l
 =„eg.
ba£
 = 0;

2914 
»g
.
lim™
 = 0xffff;

2915 
»g
.
©Œ
.
by‹s
 = 0x093;

2916 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
»g
);

2917 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
»g
);

2918 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
»g
);

2919 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
»g
);

2920 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
»g
);

2922 
»g
.
©Œ
.
by‹s
 = 0x82;

2923 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_ldŒ
, &
»g
);

2925 
»g
.
©Œ
.
by‹s
 = 0x8b;

2926 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_Œ
, &
»g
);

2928 
»g
.
©Œ
.
by‹s
 = 0;

2929 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_gdŒ
, &
»g
);

2930 
	`hvm_£t_£gm’t_»gi¡”
(
v
, 
x86_£g_idŒ
, &
»g
);

2933 
v
->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
 =

2934 
v
->
domaš
->
vıu
[0]->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
;

2935 
hvm_funcs
.
	`£t_tsc_off£t
(
v
, v->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
);

2937 
	`·gšg_upd©e_·gšg_modes
(
v
);

2939 
v
->
¬ch
.
æags
 |ğ
TF_k”Ãl_mode
;

2940 
v
->
is_š™Ÿli£d
 = 1;

2941 
	`ş—r_b™
(
_VPF_down
, &
v
->
·u£_æags
);

2943 
out
:

2944 
	`domaš_uÆock
(
d
);

2945 
	}
}

2947 
	$hvm_s3_su¥’d
(
domaš
 *
d
)

2949 
vıu
 *
v
;

2951 
	`domaš_·u£
(
d
);

2952 
	`domaš_lock
(
d
);

2954 iàĞ
d
->
is_dyšg
 || (d->
vıu
 =ğ
NULL
) || (d->vcpu[0] == NULL) ||

2955 
	`‹¡_ªd_£t_boŞ
(
d
->
¬ch
.
hvm_domaš
.
is_s3_su¥’ded
) )

2957 
	`domaš_uÆock
(
d
);

2958 
	`domaš_uÅau£
(
d
);

2962 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

2964 
	`vÏpic_»£t
(
	`vıu_vÏpic
(
v
));

2965 
	`vıu_»£t
(
v
);

2968 
	`vpic_»£t
(
d
);

2969 
	`vißpic_»£t
(
d
);

2970 
	`p™_»£t
(
d
);

2971 
	`¹c_»£t
(
d
);

2972 
	`pmtim”_»£t
(
d
);

2973 
	`h³t_»£t
(
d
);

2975 
	`hvm_vıu_»£t_¡©e
(
d
->
vıu
[0], 0xf000, 0xfff0);

2977 
	`domaš_uÆock
(
d
);

2978 
	}
}

2980 
	$hvm_s3_»sume
(
domaš
 *
d
)

2982 iàĞ
	`‹¡_ªd_ş—r_boŞ
(
d
->
¬ch
.
hvm_domaš
.
is_s3_su¥’ded
) )

2983 
	`domaš_uÅau£
(
d
);

2984 
	}
}

2986 
hvmİ_£t_i§_œq_Ëv–
(

2987 
	$XEN_GUEST_HANDLE
(
x’_hvm_£t_i§_œq_Ëv–_t
è
uİ
)

2989 
x’_hvm_£t_i§_œq_Ëv–
 
İ
;

2990 
domaš
 *
d
;

2991 
rc
;

2993 iàĞ
	`cİy_äom_gue¡
(&
İ
, 
uİ
, 1) )

2994  -
EFAULT
;

2996 iàĞ
İ
.
i§_œq
 > 15 )

2997  -
EINVAL
;

2999 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
İ
.
domid
, &
d
);

3000 iàĞ
rc
 != 0 )

3001  
rc
;

3003 
rc
 = -
EINVAL
;

3004 iàĞ!
	`is_hvm_domaš
(
d
) )

3005 
out
;

3007 
rc
 = 
	`xsm_hvm_£t_i§_œq_Ëv–
(
d
);

3008 iàĞ
rc
 )

3009 
out
;

3011 
rc
 = 0;

3012  
İ
.
Ëv–
 )

3015 
	`hvm_i§_œq_d—s£¹
(
d
, 
İ
.
i§_œq
);

3018 
	`hvm_i§_œq_as£¹
(
d
, 
İ
.
i§_œq
);

3021 
rc
 = -
EINVAL
;

3025 
out
:

3026 
	`rcu_uÆock_domaš
(
d
);

3027  
rc
;

3028 
	}
}

3030 
hvmİ_£t_pci_lšk_rou‹
(

3031 
	$XEN_GUEST_HANDLE
(
x’_hvm_£t_pci_lšk_rou‹_t
è
uİ
)

3033 
x’_hvm_£t_pci_lšk_rou‹
 
İ
;

3034 
domaš
 *
d
;

3035 
rc
;

3037 iàĞ
	`cİy_äom_gue¡
(&
İ
, 
uİ
, 1) )

3038  -
EFAULT
;

3040 iàĞ(
İ
.
lšk
 > 3è|| (İ.
i§_œq
 > 15) )

3041  -
EINVAL
;

3043 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
İ
.
domid
, &
d
);

3044 iàĞ
rc
 != 0 )

3045  
rc
;

3047 
rc
 = -
EINVAL
;

3048 iàĞ!
	`is_hvm_domaš
(
d
) )

3049 
out
;

3051 
rc
 = 
	`xsm_hvm_£t_pci_lšk_rou‹
(
d
);

3052 iàĞ
rc
 )

3053 
out
;

3055 
rc
 = 0;

3056 
	`hvm_£t_pci_lšk_rou‹
(
d
, 
İ
.
lšk
, op.
i§_œq
);

3058 
out
:

3059 
	`rcu_uÆock_domaš
(
d
);

3060  
rc
;

3061 
	}
}

3063 
	$hvmİ_æush_b_®l
()

3065 
domaš
 *
d
 = 
cu¼’t
->domain;

3066 
vıu
 *
v
;

3068 iàĞ!
	`is_hvm_domaš
(
d
) )

3069  -
EINVAL
;

3072 iàĞ!
	`¥š_Œylock
(&
d
->
hy³rÿÎ_d—dlock_mu‹x
) )

3073  -
EAGAIN
;

3076 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3077 iàĞ
v
 !ğ
cu¼’t
 )

3078 
	`vıu_·u£_nosync
(
v
);

3081 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3082 iàĞ
v
 !ğ
cu¼’t
 )

3083  !
	`vıu_ruÂabË
(
v
è&& v->
is_ruÂšg
 )

3084 
	`ıu_»Ïx
();

3087 
	`¥š_uÆock
(&
d
->
hy³rÿÎ_d—dlock_mu‹x
);

3090 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3091 
	`·gšg_upd©e_ü3
(
v
);

3094 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

3097 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3098 iàĞ
v
 !ğ
cu¼’t
 )

3099 
	`vıu_uÅau£
(
v
);

3102 
	}
}

3104 
do_hvm_İ
(
İ
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

3107 
domaš
 *
cu¼_d
 = 
cu¼’t
->domain;

3108 
rc
 = 0;

3110  
İ
 )

3112 
HVMOP_£t_·¿m
:

3113 
HVMOP_g‘_·¿m
:

3115 
x’_hvm_·¿m
 
a
;

3116 
hvm_iÜeq_·ge
 *
iÜp
;

3117 
domaš
 *
d
;

3118 
vıu
 *
v
;

3120 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3121  -
EFAULT
;

3123 iàĞ
a
.
šdex
 >ğ
HVM_NR_PARAMS
 )

3124  -
EINVAL
;

3126 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3127 iàĞ
rc
 != 0 )

3128  
rc
;

3130 
rc
 = -
EINVAL
;

3131 iàĞ!
	`is_hvm_domaš
(
d
) )

3132 
·¿m_ç
;

3134 
rc
 = 
	`xsm_hvm_·¿m
(
d
, 
İ
);

3135 iàĞ
rc
 )

3136 
·¿m_ç
;

3138 iàĞ
İ
 =ğ
HVMOP_£t_·¿m
 )

3140 
rc
 = 0;

3142  
a
.
šdex
 )

3144 
HVM_PARAM_IOREQ_PFN
:

3145 
iÜp
 = &
d
->
¬ch
.
hvm_domaš
.
iÜeq
;

3146 iàĞ(
rc
 = 
	`hvm_£t_iÜeq_·ge
(
d
, 
iÜp
, 
a
.
v®ue
)) != 0 )

3148 
	`¥š_lock
(&
iÜp
->
lock
);

3149 iàĞ
iÜp
->
va
 !ğ
NULL
 )

3151 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3152 
	`g‘_iÜeq
(
v
)->
vp_•Üt
 = v->
¬ch
.
hvm_vıu
.
x’_pÜt
;

3153 
	`¥š_uÆock
(&
iÜp
->
lock
);

3155 
HVM_PARAM_BUFIOREQ_PFN
:

3156 
iÜp
 = &
d
->
¬ch
.
hvm_domaš
.
buf_iÜeq
;

3157 
rc
 = 
	`hvm_£t_iÜeq_·ge
(
d
, 
iÜp
, 
a
.
v®ue
);

3159 
HVM_PARAM_CALLBACK_IRQ
:

3160 
	`hvm_£t_ÿÎback_vŸ
(
d
, 
a
.
v®ue
);

3161 
	`hvm_Ïtch_shšfo_size
(
d
);

3163 
HVM_PARAM_TIMER_MODE
:

3164 iàĞ
a
.
v®ue
 > 
HVMPTM_Úe_mis£d_tick_³ndšg
 )

3165 
rc
 = -
EINVAL
;

3167 
HVM_PARAM_VIRIDIAN
:

3168 iàĞ
a
.
v®ue
 > 1 )

3169 
rc
 = -
EINVAL
;

3171 
HVM_PARAM_IDENT_PT
:

3173 
rc
 = -
EPERM
;

3174 iàĞ
cu¼_d
 =ğ
d
 )

3177 
rc
 = -
EINVAL
;

3178 iàĞ
d
->
¬ch
.
hvm_domaš
.
·¿ms
[
a
.
šdex
] != 0 )

3181 
rc
 = 0;

3182 iàĞ!
	`·gšg_mode_h­
(
d
) )

3190 
rc
 = -
EAGAIN
;

3191 iàĞ!
	`domùl_lock_acquœe
() )

3194 
rc
 = 0;

3195 
	`domaš_·u£
(
d
);

3196 
d
->
¬ch
.
hvm_domaš
.
·¿ms
[
a
.
šdex
] =‡.
v®ue
;

3197 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3198 
	`·gšg_upd©e_ü3
(
v
);

3199 
	`domaš_uÅau£
(
d
);

3201 
	`domùl_lock_»Ëa£
();

3203 
HVM_PARAM_DM_DOMAIN
:

3205 
rc
 = -
EPERM
;

3206 iàĞ
cu¼_d
 =ğ
d
 )

3209 iàĞ
a
.
v®ue
 =ğ
DOMID_SELF
 )

3210 
a
.
v®ue
 = 
cu¼_d
->
domaš_id
;

3212 
rc
 = 0;

3213 
	`domaš_·u£
(
d
);

3214 
iÜp
 = &
d
->
¬ch
.
hvm_domaš
.
iÜeq
;

3215 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3217 
Şd_pÜt
, 
Ãw_pÜt
;

3218 
Ãw_pÜt
 = 
	`®loc_unbound_x’_ev’t_chªÃl
(
v
, 
a
.
v®ue
);

3219 iàĞ
Ãw_pÜt
 < 0 )

3221 
rc
 = 
Ãw_pÜt
;

3225 
Şd_pÜt
 = 
	`xchg
(&
v
->
¬ch
.
hvm_vıu
.
x’_pÜt
, 
Ãw_pÜt
);

3226 
	`ä“_x’_ev’t_chªÃl
(
v
, 
Şd_pÜt
);

3227 
	`¥š_lock
(&
iÜp
->
lock
);

3228 iàĞ
iÜp
->
va
 !ğ
NULL
 )

3229 
	`g‘_iÜeq
(
v
)->
vp_•Üt
 = v->
¬ch
.
hvm_vıu
.
x’_pÜt
;

3230 
	`¥š_uÆock
(&
iÜp
->
lock
);

3232 
	`domaš_uÅau£
(
d
);

3234 
HVM_PARAM_ACPI_S_STATE
:

3236 
rc
 = -
EPERM
;

3237 iàĞ
cu¼_d
 =ğ
d
 )

3240 
rc
 = 0;

3241 iàĞ
a
.
v®ue
 == 3 )

3242 
	`hvm_s3_su¥’d
(
d
);

3243 iàĞ
a
.
v®ue
 == 0 )

3244 
	`hvm_s3_»sume
(
d
);

3246 
rc
 = -
EINVAL
;

3249 
HVM_PARAM_ACPI_IOPORTS_LOCATION
:

3250 
rc
 = 
	`pmtim”_chªge_iİÜt
(
d
, 
a
.
v®ue
);

3252 
HVM_PARAM_MEMORY_EVENT_CR0
:

3253 
HVM_PARAM_MEMORY_EVENT_CR3
:

3254 
HVM_PARAM_MEMORY_EVENT_CR4
:

3255 iàĞ
d
 =ğ
cu¼’t
->
domaš
 )

3256 
rc
 = -
EPERM
;

3258 
HVM_PARAM_MEMORY_EVENT_INT3
:

3259 
HVM_PARAM_MEMORY_EVENT_SINGLE_STEP
:

3260 iàĞ
d
 =ğ
cu¼’t
->
domaš
 )

3262 
rc
 = -
EPERM
;

3265 iàĞ
a
.
v®ue
 & 
HVMPME_ÚchªgeÚly
 )

3266 
rc
 = -
EINVAL
;

3270 iàĞ
rc
 == 0 )

3272 
d
->
¬ch
.
hvm_domaš
.
·¿ms
[
a
.
šdex
] =‡.
v®ue
;

3274  
a
.
šdex
 )

3276 
HVM_PARAM_MEMORY_EVENT_INT3
:

3277 
HVM_PARAM_MEMORY_EVENT_SINGLE_STEP
:

3279 
	`domaš_·u£
(
d
);

3280 
	`domaš_uÅau£
(
d
);

3283 
HVM_PARAM_MEMORY_EVENT_CR3
:

3285 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

3286 
hvm_funcs
.
	`upd©e_gue¡_ü
(
v
, 0);

3296  
a
.
šdex
 )

3298 
HVM_PARAM_ACPI_S_STATE
:

3299 
a
.
v®ue
 = 
d
->
¬ch
.
hvm_domaš
.
is_s3_su¥’ded
 ? 3 : 0;

3302 
a
.
v®ue
 = 
d
->
¬ch
.
hvm_domaš
.
·¿ms
[a.
šdex
];

3305 
rc
 = 
	`cİy_to_gue¡
(
¬g
, &
a
, 1è? -
EFAULT
 : 0;

3308 
	`HVM_DBG_LOG
(
DBG_LEVEL_HCALL
, "% ·¿m %u = %"
PRIx64
,

3309 
İ
 =ğ
HVMOP_£t_·¿m
 ? "set" : "get",

3310 
a
.
šdex
,‡.
v®ue
);

3312 
·¿m_ç
:

3313 
	`rcu_uÆock_domaš
(
d
);

3317 
HVMOP_£t_pci_štx_Ëv–
:

3318 
rc
 = 
	`hvmİ_£t_pci_štx_Ëv–
(

3319 
	`gue¡_hªdË_ÿ¡
(
¬g
, 
x’_hvm_£t_pci_štx_Ëv–_t
));

3322 
HVMOP_£t_i§_œq_Ëv–
:

3323 
rc
 = 
	`hvmİ_£t_i§_œq_Ëv–
(

3324 
	`gue¡_hªdË_ÿ¡
(
¬g
, 
x’_hvm_£t_i§_œq_Ëv–_t
));

3327 
HVMOP_£t_pci_lšk_rou‹
:

3328 
rc
 = 
	`hvmİ_£t_pci_lšk_rou‹
(

3329 
	`gue¡_hªdË_ÿ¡
(
¬g
, 
x’_hvm_£t_pci_lšk_rou‹_t
));

3332 
HVMOP_æush_bs
:

3333 
rc
 = 
	`gue¡_hªdË_is_nuÎ
(
¬g
è? 
	`hvmİ_æush_b_®l
(è: -
ENOSYS
;

3336 
HVMOP_Œack_dœty_v¿m
:

3338 
x’_hvm_Œack_dœty_v¿m
 
a
;

3339 
domaš
 *
d
;

3341 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3342  -
EFAULT
;

3344 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3345 iàĞ
rc
 != 0 )

3346  
rc
;

3348 
rc
 = -
EINVAL
;

3349 iàĞ!
	`is_hvm_domaš
(
d
) )

3350 
·¿m_ç2
;

3352 
rc
 = 
	`xsm_hvm_·¿m
(
d
, 
İ
);

3353 iàĞ
rc
 )

3354 
·¿m_ç2
;

3356 
rc
 = -
ESRCH
;

3357 iàĞ
d
->
is_dyšg
 )

3358 
·¿m_ç2
;

3360 
rc
 = -
EINVAL
;

3361 iàĞ
d
->
vıu
 =ğ
NULL
 || d->vcpu[0] == NULL )

3362 
·¿m_ç2
;

3364 iàĞ
	`shadow_mode_’abËd
(
d
) )

3365 
rc
 = 
	`shadow_Œack_dœty_v¿m
(
d
, 
a
.
fœ¡_pâ
,‡.
Ä
,‡.
dœty_b™m­
);

3367 
rc
 = 
	`h­_Œack_dœty_v¿m
(
d
, 
a
.
fœ¡_pâ
,‡.
Ä
,‡.
dœty_b™m­
);

3369 
·¿m_ç2
:

3370 
	`rcu_uÆock_domaš
(
d
);

3374 
HVMOP_modif›d_memÜy
:

3376 
x’_hvm_modif›d_memÜy
 
a
;

3377 
domaš
 *
d
;

3378 
p2m_domaš
 *
p2m
;

3379 
pâ
;

3381 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3382  -
EFAULT
;

3384 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3385 iàĞ
rc
 != 0 )

3386  
rc
;

3388 
rc
 = -
EINVAL
;

3389 iàĞ!
	`is_hvm_domaš
(
d
) )

3390 
·¿m_ç3
;

3392 
rc
 = 
	`xsm_hvm_·¿m
(
d
, 
İ
);

3393 iàĞ
rc
 )

3394 
·¿m_ç3
;

3396 
rc
 = -
EINVAL
;

3397 iàĞ(
a
.
fœ¡_pâ
 > 
	`domaš_g‘_maximum_gpâ
(
d
)) ||

3398 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1) <‡.first_pfn) ||

3399 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1è> 
	`domaš_g‘_maximum_gpâ
(
d
)) )

3400 
·¿m_ç3
;

3402 
rc
 = 0;

3403 iàĞ!
	`·gšg_mode_log_dœty
(
d
) )

3404 
·¿m_ç3
;

3406 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3407  
pâ
 = 
a
.
fœ¡_pâ
;…â <‡.fœ¡_pâ +‡.
Ä
;…fn++ )

3409 
p2m_ty³_t
 
t
;

3410 
mâ_t
 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
pâ
, &
t
);

3411 iàĞ
	`p2m_is_·gšg
(
t
) )

3413 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
pâ
);

3415 
rc
 = -
EINVAL
;

3416 
·¿m_ç3
;

3418 ifĞ
	`p2m_is_sh¬ed
(
t
) )

3419 
	`gd´štk
(
XENLOG_WARNING
,

3420 "sh¬ed…â 0x%lx modif›d?\n", 
pâ
);

3422 iàĞ
	`mâ_x
(
mâ
è!ğ
INVALID_MFN
 )

3424 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
mâ
));

3427 
	`sh_»move_shadows
(
d
->
vıu
[0], 
mâ
, 1, 0);

3431 
·¿m_ç3
:

3432 
	`rcu_uÆock_domaš
(
d
);

3436 
HVMOP_g‘_mem_ty³
:

3438 
x’_hvm_g‘_mem_ty³
 
a
;

3439 
domaš
 *
d
;

3440 
p2m_ty³_t
 
t
;

3442 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3443  -
EFAULT
;

3445 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3446 iàĞ
rc
 != 0 )

3447  
rc
;

3449 
rc
 = -
EINVAL
;

3450 iàĞ
	`is_hvm_domaš
(
d
) )

3452 
	`gâ_to_mâ_unsh¬e
(
	`p2m_g‘_ho¡p2m
(
d
), 
a
.
pâ
, &
t
, 0);

3453 iàĞ
	`p2m_is_mmio
(
t
) )

3454 
a
.
mem_ty³
 = 
HVMMEM_mmio_dm
;

3455 iàĞ
	`p2m_is_»adÚly
(
t
) )

3456 
a
.
mem_ty³
 = 
HVMMEM_¿m_ro
;

3457 iàĞ
	`p2m_is_¿m
(
t
) )

3458 
a
.
mem_ty³
 = 
HVMMEM_¿m_rw
;

3460 
a
.
mem_ty³
 = 
HVMMEM_mmio_dm
;

3461 
rc
 = 
	`cİy_to_gue¡
(
¬g
, &
a
, 1è? -
EFAULT
 : 0;

3463 
	`rcu_uÆock_domaš
(
d
);

3467 
HVMOP_£t_mem_ty³
:

3469 
x’_hvm_£t_mem_ty³
 
a
;

3470 
domaš
 *
d
;

3471 
p2m_domaš
 *
p2m
;

3472 
pâ
;

3475 
p2m_ty³_t
 
memty³
[] = {

3476 
p2m_¿m_rw
,

3477 
p2m_¿m_ro
,

3478 
p2m_mmio_dm


3481 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3482  -
EFAULT
;

3484 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3485 iàĞ
rc
 != 0 )

3486  
rc
;

3488 
rc
 = -
EINVAL
;

3489 iàĞ!
	`is_hvm_domaš
(
d
) )

3490 
·¿m_ç4
;

3492 
rc
 = -
EINVAL
;

3493 iàĞ(
a
.
fœ¡_pâ
 > 
	`domaš_g‘_maximum_gpâ
(
d
)) ||

3494 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1) <‡.first_pfn) ||

3495 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1è> 
	`domaš_g‘_maximum_gpâ
(
d
)) )

3496 
·¿m_ç4
;

3498 iàĞ
a
.
hvmmem_ty³
 >ğ
	`ARRAY_SIZE
(
memty³
) )

3499 
·¿m_ç4
;

3501 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3502  
pâ
 = 
a
.
fœ¡_pâ
;…â <‡.fœ¡_pâ +‡.
Ä
;…fn++ )

3504 
p2m_ty³_t
 
t
;

3505 
p2m_ty³_t
 
Á
;

3506 
mâ_t
 
mâ
;

3507 
mâ
 = 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
pâ
, &
t
, 0);

3508 iàĞ
	`p2m_is_·gšg
(
t
) )

3510 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
pâ
);

3512 
rc
 = -
EINVAL
;

3513 
·¿m_ç4
;

3515 iàĞ
	`p2m_is_sh¬ed
(
t
) )

3517 
rc
 = -
EINVAL
;

3518 
·¿m_ç4
;

3520 iàĞ
	`p2m_is_g¿Á
(
t
) )

3522 
	`gd´štk
(
XENLOG_WARNING
,

3524 "ww”wÜkšg?\n", 
pâ
);

3525 
·¿m_ç4
;

3529 
Á
 = 
	`p2m_chªge_ty³
(
p2m
, 
pâ
, 
t
, 
memty³
[
a
.
hvmmem_ty³
]);

3530 iàĞ
Á
 !ğ
t
 )

3532 
	`gd´štk
(
XENLOG_WARNING
,

3535 
pâ
, 
t
, 
Á
, 
memty³
[
a
.
hvmmem_ty³
]);

3536 
·¿m_ç4
;

3541 
rc
 = 0;

3543 
·¿m_ç4
:

3544 
	`rcu_uÆock_domaš
(
d
);

3548 
HVMOP_£t_mem_acûss
:

3550 
x’_hvm_£t_mem_acûss
 
a
;

3551 
domaš
 *
d
;

3552 
p2m_domaš
 *
p2m
;

3553 
pâ
;

3555 
p2m_acûss_t
 
memacûss
[] = {

3556 
p2m_acûss_n
,

3557 
p2m_acûss_r
,

3558 
p2m_acûss_w
,

3559 
p2m_acûss_rw
,

3560 
p2m_acûss_x
,

3561 
p2m_acûss_rx
,

3562 
p2m_acûss_wx
,

3563 
p2m_acûss_rwx
,

3564 
p2m_acûss_rx2rw
,

3568 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3569  -
EFAULT
;

3571 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3572 iàĞ
rc
 != 0 )

3573  
rc
;

3575 
rc
 = -
EINVAL
;

3576 iàĞ!
	`is_hvm_domaš
(
d
) )

3577 
·¿m_ç5
;

3579 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3580 
memacûss
[
HVMMEM_acûss_deçuÉ
] = 
p2m
->
deçuÉ_acûss
;

3583 iàĞ
a
.
fœ¡_pâ
 == ~0ull )

3585 
rc
 = 0;

3586 
p2m
->
deçuÉ_acûss
 = 
memacûss
[
a
.
hvmmem_acûss
];

3587 
·¿m_ç5
;

3590 
rc
 = -
EINVAL
;

3591 iàĞ(
a
.
fœ¡_pâ
 > 
	`domaš_g‘_maximum_gpâ
(
d
)) ||

3592 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1) <‡.first_pfn) ||

3593 ((
a
.
fœ¡_pâ
 +‡.
Ä
 - 1è> 
	`domaš_g‘_maximum_gpâ
(
d
)) )

3594 
·¿m_ç5
;

3596 iàĞ
a
.
hvmmem_acûss
 >ğ
	`ARRAY_SIZE
(
memacûss
) )

3597 
·¿m_ç5
;

3599  
pâ
 = 
a
.
fœ¡_pâ
;…â <‡.fœ¡_pâ +‡.
Ä
;…fn++ )

3601 
p2m_ty³_t
 
t
;

3602 
mâ_t
 
mâ
;

3603 
sucûss
;

3605 
mâ
 = 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
pâ
, &
t
, 0);

3607 
	`p2m_lock
(
p2m
);

3608 
sucûss
 = 
p2m
->
	`£t_’Œy
Õ2m, 
pâ
, 
mâ
, 0, 
t
, 
memacûss
[
a
.
hvmmem_acûss
]);

3609 
	`p2m_uÆock
(
p2m
);

3610 iàĞ!
sucûss
 )

3611 
·¿m_ç5
;

3614 
rc
 = 0;

3616 
·¿m_ç5
:

3617 
	`rcu_uÆock_domaš
(
d
);

3621 
HVMOP_g‘_mem_acûss
:

3623 
x’_hvm_g‘_mem_acûss
 
a
;

3624 
domaš
 *
d
;

3625 
p2m_domaš
 *
p2m
;

3626 
p2m_ty³_t
 
t
;

3627 
p2m_acûss_t
 
ac
;

3628 
mâ_t
 
mâ
;

3631 
hvmmem_acûss_t
 
memacûss
[] = {

3632 
HVMMEM_acûss_n
,

3633 
HVMMEM_acûss_r
,

3634 
HVMMEM_acûss_w
,

3635 
HVMMEM_acûss_rw
,

3636 
HVMMEM_acûss_x
,

3637 
HVMMEM_acûss_rx
,

3638 
HVMMEM_acûss_wx
,

3639 
HVMMEM_acûss_rwx
,

3640 
HVMMEM_acûss_rx2rw


3643 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3644  -
EFAULT
;

3646 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3647 iàĞ
rc
 != 0 )

3648  
rc
;

3650 
rc
 = -
EINVAL
;

3651 iàĞ!
	`is_hvm_domaš
(
d
) )

3652 
·¿m_ç6
;

3654 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3656 iàĞ
a
.
pâ
 == ~0ull )

3658 
a
.
hvmmem_acûss
 = 
memacûss
[
p2m
->
deçuÉ_acûss
];

3661 
rc
 = -
EINVAL
;

3662 iàĞ(
a
.
pâ
 > 
	`domaš_g‘_maximum_gpâ
(
d
)) )

3663 
·¿m_ç6
;

3665 
rc
 = -
ESRCH
;

3666 
mâ
 = 
p2m
->
	`g‘_’Œy
Õ2m, 
a
.
pâ
, &
t
, &
ac
, 
p2m_qu”y
);

3668 iàĞ
	`mâ_x
(
mâ
è=ğ
INVALID_MFN
 )

3669 
·¿m_ç6
;

3671 
rc
 = -
ERANGE
;

3672 iàĞ
ac
 >ğ
	`ARRAY_SIZE
(
memacûss
) )

3673 
·¿m_ç6
;

3675 
a
.
hvmmem_acûss
 = 
memacûss
[
ac
];

3678 
rc
 = 
	`cİy_to_gue¡
(
¬g
, &
a
, 1è? -
EFAULT
 : 0;

3680 
·¿m_ç6
:

3681 
	`rcu_uÆock_domaš
(
d
);

3685 
HVMOP_·g‘abË_dyšg
:

3687 
x’_hvm_·g‘abË_dyšg
 
a
;

3688 
domaš
 *
d
;

3690 iàĞ
	`cİy_äom_gue¡
(&
a
, 
¬g
, 1) )

3691  -
EFAULT
;

3693 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
a
.
domid
, &
d
);

3694 iàĞ
rc
 != 0 )

3695  
rc
;

3697 
rc
 = -
EINVAL
;

3698 iàĞ!
	`is_hvm_domaš
(
d
è|| !
	`·gšg_mode_shadow
(d) )

3699 
·¿m_ç7
;

3701 
rc
 = 0;

3702 
	`·g‘abË_dyšg
(
d
, 
a
.
g·
);

3704 
·¿m_ç7
:

3705 
	`rcu_uÆock_domaš
(
d
);

3709 
HVMOP_g‘_time
: {

3710 
x’_hvm_g‘_time_t
 
gxt
;

3712 
gxt
.
now
 = 
	`NOW
();

3713 iàĞ
	`cİy_to_gue¡
(
¬g
, &
gxt
, 1) )

3714 
rc
 = -
EFAULT
;

3718 
HVMOP_x’Œaû
: {

3719 
x’_hvm_x’Œaû_t
 
Œ
;

3721 iàĞ
	`cİy_äom_gue¡
(&
Œ
, 
¬g
, 1 ) )

3722  -
EFAULT
;

3724 iàĞ
Œ
.
exŒa_by‹s
 > Ñr.
exŒa
)

3725 || (
Œ
.
ev’t
 & ~((1u<<
TRC_SUBCLS_SHIFT
)-1)) )

3726  -
EINVAL
;

3729 
	`Œaû_v¬
(
Œ
.
ev’t
 | 
TRC_GUEST
, 0 ,

3730 
Œ
.
exŒa_by‹s
,

3731 (*)
Œ
.
exŒa
);

3735 
HVMOP_šjeù_Œ­
:

3737 
x’_hvm_šjeù_Œ­_t
 
Œ
;

3738 
domaš
 *
d
;

3739 
vıu
 *
v
;

3741 iàĞ
	`cİy_äom_gue¡
(&
Œ
, 
¬g
, 1 ) )

3742  -
EFAULT
;

3744 
rc
 = 
	`rcu_lock_»mÙe_rg‘_domaš_by_id
(
Œ
.
domid
, &
d
);

3745 iàĞ
rc
 != 0 )

3746  
rc
;

3748 
rc
 = -
EINVAL
;

3749 iàĞ!
	`is_hvm_domaš
(
d
) )

3750 
·¿m_ç8
;

3752 
rc
 = -
ENOENT
;

3753 iàĞ
Œ
.
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[Œ.vıuid]è=ğ
NULL
 )

3754 
·¿m_ç8
;

3756 iàĞ
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
 != -1 )

3757 
rc
 = -
EBUSY
;

3760 
v
->
¬ch
.
hvm_vıu
.
šjeù_Œ­
 = 
Œ
.
Œ­
;

3761 
v
->
¬ch
.
hvm_vıu
.
šjeù_”rÜ_code
 = 
Œ
.
”rÜ_code
;

3762 
v
->
¬ch
.
hvm_vıu
.
šjeù_ü2
 = 
Œ
.
ü2
;

3765 
·¿m_ç8
:

3766 
	`rcu_uÆock_domaš
(
d
);

3772 
	`gd´štk
(
XENLOG_WARNING
, "Bad HVM o°%ld.\n", 
İ
);

3773 
rc
 = -
ENOSYS
;

3778 iàĞ
rc
 =ğ-
EAGAIN
 )

3779 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

3780 
__HYPERVISOR_hvm_İ
, "lh", 
İ
, 
¬g
);

3782  
rc
;

3783 
	}
}

3785 
	$hvm_debug_İ
(
vıu
 *
v
, 
št32_t
 
İ
)

3787 
rc
;

3789  
İ
 )

3791 
XEN_DOMCTL_DEBUG_OP_SINGLE_STEP_ON
:

3792 
XEN_DOMCTL_DEBUG_OP_SINGLE_STEP_OFF
:

3793 
rc
 = -
ENOSYS
;

3794 iàĞ!
ıu_has_mÚ™Ü_Œ­_æag
 )

3796 
rc
 = 0;

3797 
	`vıu_·u£
(
v
);

3798 
v
->
¬ch
.
hvm_vıu
.
sšgË_¡•
 =

3799 (
İ
 =ğ
XEN_DOMCTL_DEBUG_OP_SINGLE_STEP_ON
);

3800 
	`vıu_uÅau£
(
v
);

3803 
rc
 = -
ENOSYS
;

3807  
rc
;

3808 
	}
}

3810 #ifdeà
__x86_64__


3811 
	$hvm_memÜy_ev’t_Œ­s
(
p
, 
ušt32_t
 
»asÚ
,

3812 
v®ue
, 
Şd
,

3813 
boŞ_t
 
gÏ_v®id
, 
gÏ
)

3815 
vıu
* 
v
 = 
cu¼’t
;

3816 
domaš
 *
d
 = 
v
->domain;

3817 
mem_ev’t_»que¡_t
 
»q
;

3818 
rc
;

3820 iàĞ!(
p
 & 
HVMPME_MODE_MASK
) )

3823 iàĞ(
p
 & 
HVMPME_ÚchªgeÚly
è&& (
v®ue
 =ğ
Şd
) )

3826 
rc
 = 
	`mem_ev’t_check_ršg
(
d
);

3827 iàĞ
rc
 )

3828  
rc
;

3830 
	`mem£t
(&
»q
, 0, (req));

3831 
»q
.
ty³
 = 
MEM_EVENT_TYPE_ACCESS
;

3832 
»q
.
»asÚ
 =„eason;

3834 iàĞ(
p
 & 
HVMPME_MODE_MASK
è=ğ
HVMPME_mode_sync
 )

3836 
»q
.
æags
 |ğ
MEM_EVENT_FLAG_VCPU_PAUSED
;

3837 
	`vıu_·u£_nosync
(
v
);

3840 
»q
.
gâ
 = 
v®ue
;

3841 
»q
.
vıu_id
 = 
v
->vcpu_id;

3842 iàĞ
gÏ_v®id
 )

3844 
»q
.
off£t
 = 
gÏ
 & ((1 << 
PAGE_SHIFT
) - 1);

3845 
»q
.
gÏ
 = gla;

3846 
»q
.
gÏ_v®id
 = 1;

3849 
	`mem_ev’t_put_»que¡
(
d
, &
»q
);

3852 
	}
}

3854 
	$hvm_memÜy_ev’t_ü0
(
v®ue
, 
Şd
)

3856 
	`hvm_memÜy_ev’t_Œ­s
(
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš


3857 .
·¿ms
[
HVM_PARAM_MEMORY_EVENT_CR0
],

3858 
MEM_EVENT_REASON_CR0
,

3859 
v®ue
, 
Şd
, 0, 0);

3860 
	}
}

3862 
	$hvm_memÜy_ev’t_ü3
(
v®ue
, 
Şd
)

3864 
	`hvm_memÜy_ev’t_Œ­s
(
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš


3865 .
·¿ms
[
HVM_PARAM_MEMORY_EVENT_CR3
],

3866 
MEM_EVENT_REASON_CR3
,

3867 
v®ue
, 
Şd
, 0, 0);

3868 
	}
}

3870 
	$hvm_memÜy_ev’t_ü4
(
v®ue
, 
Şd
)

3872 
	`hvm_memÜy_ev’t_Œ­s
(
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš


3873 .
·¿ms
[
HVM_PARAM_MEMORY_EVENT_CR4
],

3874 
MEM_EVENT_REASON_CR4
,

3875 
v®ue
, 
Şd
, 0, 0);

3876 
	}
}

3878 
	$hvm_memÜy_ev’t_št3
(
gÏ
)

3880 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

3881 
gâ
;

3882 
gâ
 = 
	`·gšg_gva_to_gâ
(
cu¼’t
, 
gÏ
, &
pãc
);

3884  
	`hvm_memÜy_ev’t_Œ­s
(
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš


3885 .
·¿ms
[
HVM_PARAM_MEMORY_EVENT_INT3
],

3886 
MEM_EVENT_REASON_INT3
,

3887 
gâ
, 0, 1, 
gÏ
);

3888 
	}
}

3890 
	$hvm_memÜy_ev’t_sšgË_¡•
(
gÏ
)

3892 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
;

3893 
gâ
;

3894 
gâ
 = 
	`·gšg_gva_to_gâ
(
cu¼’t
, 
gÏ
, &
pãc
);

3896  
	`hvm_memÜy_ev’t_Œ­s
(
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš


3897 .
·¿ms
[
HVM_PARAM_MEMORY_EVENT_SINGLE_STEP
],

3898 
MEM_EVENT_REASON_SINGLESTEP
,

3899 
gâ
, 0, 1, 
gÏ
);

3900 
	}
}

	@hvm/i8254.c

27 
	~<x’/cÚfig.h
>

28 
	~<x’/ty³s.h
>

29 
	~<x’/mm.h
>

30 
	~<x’/xm®loc.h
>

31 
	~<x’/lib.h
>

32 
	~<x’/”ºo.h
>

33 
	~<x’/sched.h
>

34 
	~<asm/time.h
>

35 
	~<asm/hvm/hvm.h
>

36 
	~<asm/hvm/io.h
>

37 
	~<asm/hvm/suµÜt.h
>

38 
	~<asm/hvm/v±.h
>

39 
	~<asm/cu¼’t.h
>

41 
	#domaš_vp™
(
x
è(&(x)->
¬ch
.
hvm_domaš
.
¶_time
.
vp™
)

	)

42 
	#vıu_vp™
(
x
è(
	`domaš_vp™
((x)->
domaš
))

	)

43 
	#vp™_domaš
(
x
è(
	`cÚš”_of
((x), 
domaš
, \

44 
¬ch
.
hvm_domaš
.
¶_time
.
vp™
))

	)

45 
	#vp™_vıu
(
x
è(
	`±_glob®_vıu_rg‘
(
	`vp™_domaš
(x)))

	)

47 
	#RW_STATE_LSB
 1

	)

48 
	#RW_STATE_MSB
 2

	)

49 
	#RW_STATE_WORD0
 3

	)

50 
	#RW_STATE_WORD1
 4

	)

52 
hªdË_p™_io
(

53 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
);

54 
hªdË_¥—k”_io
(

55 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
);

57 
	#g‘_gue¡_time
(
v
) \

58 (
	`is_hvm_vıu
(
v
è? 
	`hvm_g‘_gue¡_time
(vè: (
u64
)
	`g‘_s_time
())

	)

60 
	$p™_g‘_couÁ
(
PITS‹
 *
p™
, 
chªÃl
)

62 
ušt64_t
 
d
;

63 
couÁ”
;

64 
hvm_hw_p™_chªÃl
 *
c
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

65 
vıu
 *
v
 = 
	`vp™_vıu
(
p™
);

67 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

69 
d
 = 
	`muldiv64
(
	`g‘_gue¡_time
(
v
è- 
p™
->
couÁ_lßd_time
[
chªÃl
],

70 
PIT_FREQ
, 
SYSTEM_TIME_HZ
);

72  
c
->
mode
 )

78 
couÁ”
 = (
c
->
couÁ
 - 
d
) & 0xffff;

82 
couÁ”
 = 
c
->
couÁ
 - ((2 * 
d
) % c->count);

85 
couÁ”
 = 
c
->
couÁ
 - (
d
 % c->count);

88  
couÁ”
;

89 
	}
}

91 
	$p™_g‘_out
(
PITS‹
 *
p™
, 
chªÃl
)

93 
hvm_hw_p™_chªÃl
 *
s
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

94 
ušt64_t
 
d
;

95 
out
;

96 
vıu
 *
v
 = 
	`vp™_vıu
(
p™
);

98 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

100 
d
 = 
	`muldiv64
(
	`g‘_gue¡_time
(
v
è- 
p™
->
couÁ_lßd_time
[
chªÃl
],

101 
PIT_FREQ
, 
SYSTEM_TIME_HZ
);

103  
s
->
mode
 )

107 
out
 = (
d
 >ğ
s
->
couÁ
);

110 
out
 = (
d
 < 
s
->
couÁ
);

113 
out
 = (((
d
 % 
s
->
couÁ
) == 0) && (d != 0));

116 
out
 = ((
d
 % 
s
->
couÁ
) < ((s->count + 1) >> 1));

120 
out
 = (
d
 =ğ
s
->
couÁ
);

124  
out
;

125 
	}
}

127 
	$p™_£t_g©e
(
PITS‹
 *
p™
, 
chªÃl
, 
v®
)

129 
hvm_hw_p™_chªÃl
 *
s
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

130 
vıu
 *
v
 = 
	`vp™_vıu
(
p™
);

132 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

134  
s
->
mode
 )

146 iàĞ
s
->
g©e
 < 
v®
 )

147 
p™
->
couÁ_lßd_time
[
chªÃl
] = 
	`g‘_gue¡_time
(
v
);

151 
s
->
g©e
 = 
v®
;

152 
	}
}

154 
	$p™_g‘_g©e
(
PITS‹
 *
p™
, 
chªÃl
)

156 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

157  
p™
->
hw
.
chªÃls
[
chªÃl
].
g©e
;

158 
	}
}

160 
	$p™_time_fœed
(
vıu
 *
v
, *
´iv
)

162 
ušt64_t
 *
couÁ_lßd_time
 = 
´iv
;

163 *
couÁ_lßd_time
 = 
	`g‘_gue¡_time
(
v
);

164 
	}
}

166 
	$p™_lßd_couÁ
(
PITS‹
 *
p™
, 
chªÃl
, 
v®
)

168 
u32
 
³riod
;

169 
hvm_hw_p™_chªÃl
 *
s
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

170 
vıu
 *
v
 = 
	`vp™_vıu
(
p™
);

172 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

174 iàĞ
v®
 == 0 )

175 
v®
 = 0x10000;

177 iàĞ
v
 =ğ
NULL
 )

178 
p™
->
couÁ_lßd_time
[
chªÃl
] = 0;

180 
p™
->
couÁ_lßd_time
[
chªÃl
] = 
	`g‘_gue¡_time
(
v
);

181 
s
->
couÁ
 = 
v®
;

182 
³riod
 = 
	`DIV_ROUND
(
v®
 * 
SYSTEM_TIME_HZ
, 
PIT_FREQ
);

184 iàĞ(
v
 =ğ
NULL
è|| !
	`is_hvm_vıu
(vè|| (
chªÃl
 != 0) )

187  
s
->
mode
 )

192 
	`ü—‹_³riodic_time
(
v
, &
p™
->
±0
, 
³riod
,…”iod, 0, 
p™_time_fœed
,

193 &
p™
->
couÁ_lßd_time
[
chªÃl
]);

198 
	`ü—‹_³riodic_time
(
v
, &
p™
->
±0
, 
³riod
, 0, 0, 
p™_time_fœed
,

199 &
p™
->
couÁ_lßd_time
[
chªÃl
]);

202 
	`de¡roy_³riodic_time
(&
p™
->
±0
);

205 
	}
}

207 
	$p™_Ïtch_couÁ
(
PITS‹
 *
p™
, 
chªÃl
)

209 
hvm_hw_p™_chªÃl
 *
c
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

211 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

213 iàĞ!
c
->
couÁ_Ïtched
 )

215 
c
->
Ïtched_couÁ
 = 
	`p™_g‘_couÁ
(
p™
, 
chªÃl
);

216 
c
->
couÁ_Ïtched
 = c->
rw_mode
;

218 
	}
}

220 
	$p™_Ïtch_¡©us
(
PITS‹
 *
p™
, 
chªÃl
)

222 
hvm_hw_p™_chªÃl
 *
c
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

224 
	`ASSERT
(
	`¥š_is_locked
(&
p™
->
lock
));

226 iàĞ!
c
->
¡©us_Ïtched
 )

229 
c
->
¡©us
 = ((
	`p™_g‘_out
(
p™
, 
chªÃl
) << 7) |

230 (
c
->
rw_mode
 << 4) |

231 (
c
->
mode
 << 1) |

232 
c
->
bcd
);

233 
c
->
¡©us_Ïtched
 = 1;

235 
	}
}

237 
	$p™_iİÜt_wr™e
(
PITS‹
 *
p™
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

239 
chªÃl
, 
acûss
;

240 
hvm_hw_p™_chªÃl
 *
s
;

242 
v®
 &= 0xff;

243 
addr
 &= 3;

245 
	`¥š_lock
(&
p™
->
lock
);

247 iàĞ
addr
 == 3 )

249 
chªÃl
 = 
v®
 >> 6;

250 iàĞ
chªÃl
 == 3 )

253  
chªÃl
 = 0; channel < 3; channel++ )

255 
s
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

256 iàĞ
v®
 & (2 << 
chªÃl
) )

258 iàĞ!(
v®
 & 0x20) )

259 
	`p™_Ïtch_couÁ
(
p™
, 
chªÃl
);

260 iàĞ!(
v®
 & 0x10) )

261 
	`p™_Ïtch_¡©us
(
p™
, 
chªÃl
);

268 
s
 = &
p™
->
hw
.
chªÃls
[
chªÃl
];

269 
acûss
 = (
v®
 >> 4) & 3;

270 iàĞ
acûss
 == 0 )

272 
	`p™_Ïtch_couÁ
(
p™
, 
chªÃl
);

276 
s
->
rw_mode
 = 
acûss
;

277 
s
->
»ad_¡©e
 = 
acûss
;

278 
s
->
wr™e_¡©e
 = 
acûss
;

279 
s
->
mode
 = (
v®
 >> 1) & 7;

280 iàĞ
s
->
mode
 > 5 )

281 
s
->
mode
 -= 4;

282 
s
->
bcd
 = 
v®
 & 1;

290 
s
 = &
p™
->
hw
.
chªÃls
[
addr
];

291  
s
->
wr™e_¡©e
 )

294 
RW_STATE_LSB
:

295 
	`p™_lßd_couÁ
(
p™
, 
addr
, 
v®
);

297 
RW_STATE_MSB
:

298 
	`p™_lßd_couÁ
(
p™
, 
addr
, 
v®
 << 8);

300 
RW_STATE_WORD0
:

301 
s
->
wr™e_Ïtch
 = 
v®
;

302 
s
->
wr™e_¡©e
 = 
RW_STATE_WORD1
;

304 
RW_STATE_WORD1
:

305 
	`p™_lßd_couÁ
(
p™
, 
addr
, 
s
->
wr™e_Ïtch
 | (
v®
 << 8));

306 
s
->
wr™e_¡©e
 = 
RW_STATE_WORD0
;

311 
	`¥š_uÆock
(&
p™
->
lock
);

312 
	}
}

314 
ušt32_t
 
	$p™_iİÜt_»ad
(
PITS‹
 *
p™
, 
ušt32_t
 
addr
)

316 
»t
, 
couÁ
;

317 
hvm_hw_p™_chªÃl
 *
s
;

319 
addr
 &= 3;

320 
s
 = &
p™
->
hw
.
chªÃls
[
addr
];

322 
	`¥š_lock
(&
p™
->
lock
);

324 iàĞ
s
->
¡©us_Ïtched
 )

326 
s
->
¡©us_Ïtched
 = 0;

327 
»t
 = 
s
->
¡©us
;

329 iàĞ
s
->
couÁ_Ïtched
 )

331  
s
->
couÁ_Ïtched
 )

334 
RW_STATE_LSB
:

335 
»t
 = 
s
->
Ïtched_couÁ
 & 0xff;

336 
s
->
couÁ_Ïtched
 = 0;

338 
RW_STATE_MSB
:

339 
»t
 = 
s
->
Ïtched_couÁ
 >> 8;

340 
s
->
couÁ_Ïtched
 = 0;

342 
RW_STATE_WORD0
:

343 
»t
 = 
s
->
Ïtched_couÁ
 & 0xff;

344 
s
->
couÁ_Ïtched
 = 
RW_STATE_MSB
;

350  
s
->
»ad_¡©e
 )

353 
RW_STATE_LSB
:

354 
couÁ
 = 
	`p™_g‘_couÁ
(
p™
, 
addr
);

355 
»t
 = 
couÁ
 & 0xff;

357 
RW_STATE_MSB
:

358 
couÁ
 = 
	`p™_g‘_couÁ
(
p™
, 
addr
);

359 
»t
 = (
couÁ
 >> 8) & 0xff;

361 
RW_STATE_WORD0
:

362 
couÁ
 = 
	`p™_g‘_couÁ
(
p™
, 
addr
);

363 
»t
 = 
couÁ
 & 0xff;

364 
s
->
»ad_¡©e
 = 
RW_STATE_WORD1
;

366 
RW_STATE_WORD1
:

367 
couÁ
 = 
	`p™_g‘_couÁ
(
p™
, 
addr
);

368 
»t
 = (
couÁ
 >> 8) & 0xff;

369 
s
->
»ad_¡©e
 = 
RW_STATE_WORD0
;

374 
	`¥š_uÆock
(&
p™
->
lock
);

376  
»t
;

377 
	}
}

379 
	$p™_¡İ_chªÃl0_œq
(
PITS‹
 *
p™
)

381 
	`¥š_lock
(&
p™
->
lock
);

382 
	`de¡roy_³riodic_time
(&
p™
->
±0
);

383 
	`¥š_uÆock
(&
p™
->
lock
);

384 
	}
}

386 
	$p™_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

388 
PITS‹
 *
p™
 = 
	`domaš_vp™
(
d
);

389 
rc
;

391 
	`¥š_lock
(&
p™
->
lock
);

393 
rc
 = 
	`hvm_§ve_’Œy
(
PIT
, 0, 
h
, &
p™
->
hw
);

395 
	`¥š_uÆock
(&
p™
->
lock
);

397  
rc
;

398 
	}
}

400 
	$p™_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

402 
PITS‹
 *
p™
 = 
	`domaš_vp™
(
d
);

403 
i
;

405 
	`¥š_lock
(&
p™
->
lock
);

407 iàĞ
	`hvm_lßd_’Œy
(
PIT
, 
h
, &
p™
->
hw
) )

409 
	`¥š_uÆock
(&
p™
->
lock
);

418 
p™
->
±0
.
Ï¡_¶t_gtime
 = 
	`g‘_gue¡_time
(
d
->
vıu
[0]);

419  
i
 = 0; i < 3; i++ )

420 
	`p™_lßd_couÁ
(
p™
, 
i
,…™->
hw
.
chªÃls
[i].
couÁ
);

422 
	`¥š_uÆock
(&
p™
->
lock
);

425 
	}
}

427 
HVM_REGISTER_SAVE_RESTORE
(
PIT
, 
p™_§ve
, 
p™_lßd
, 1, 
HVMSR_PER_DOM
);

429 
	$p™_»£t
(
domaš
 *
d
)

431 
PITS‹
 *
p™
 = 
	`domaš_vp™
(
d
);

432 
hvm_hw_p™_chªÃl
 *
s
;

433 
i
;

435 
	`de¡roy_³riodic_time
(&
p™
->
±0
);

436 
p™
->
±0
.
sourû
 = 
PTSRC_i§
;

438 
	`¥š_lock
(&
p™
->
lock
);

440  
i
 = 0; i < 3; i++ )

442 
s
 = &
p™
->
hw
.
chªÃls
[
i
];

443 
s
->
mode
 = 0xff;

444 
s
->
g©e
 = (
i
 != 2);

445 
	`p™_lßd_couÁ
(
p™
, 
i
, 0);

448 
	`¥š_uÆock
(&
p™
->
lock
);

449 
	}
}

451 
	$p™_š™
(
vıu
 *
v
, 
ıu_khz
)

453 
PITS‹
 *
p™
 = 
	`vıu_vp™
(
v
);

455 
	`¥š_lock_š™
(&
p™
->
lock
);

457 
	`»gi¡”_pÜtio_hªdËr
(
v
->
domaš
, 
PIT_BASE
, 4, 
hªdË_p™_io
);

458 
	`»gi¡”_pÜtio_hªdËr
(
v
->
domaš
, 0x61, 1, 
hªdË_¥—k”_io
);

460 
	`p™_»£t
(
v
->
domaš
);

461 
	}
}

463 
	$p™_deš™
(
domaš
 *
d
)

465 
PITS‹
 *
p™
 = 
	`domaš_vp™
(
d
);

466 
	`de¡roy_³riodic_time
(&
p™
->
±0
);

467 
	}
}

470 
	$hªdË_p™_io
(

471 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

473 
PITS‹
 *
vp™
 = 
	`vıu_vp™
(
cu¼’t
);

475 iàĞ
by‹s
 != 1 )

477 
	`gd´štk
(
XENLOG_WARNING
, "PIT bad‡ccess\n");

478  
X86EMUL_OKAY
;

481 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

483 
	`p™_iİÜt_wr™e
(
vp™
, 
pÜt
, *
v®
);

487 iàĞ(
pÜt
 & 3) != 3 )

488 *
v®
 = 
	`p™_iİÜt_»ad
(
vp™
, 
pÜt
);

490 
	`gd´štk
(
XENLOG_WARNING
, "PIT:„ead A1:A0=3!\n");

493  
X86EMUL_OKAY
;

494 
	}
}

496 
	$¥—k”_iİÜt_wr™e
(

497 
PITS‹
 *
p™
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

499 
p™
->
hw
.
¥—k”_d©a_Ú
 = (
v®
 >> 1) & 1;

500 
	`p™_£t_g©e
(
p™
, 2, 
v®
 & 1);

501 
	}
}

503 
ušt32_t
 
	$¥—k”_iİÜt_»ad
(

504 
PITS‹
 *
p™
, 
ušt32_t
 
addr
)

507 
»äesh_şock
 = (()
	`NOW
() >> 14) & 1;

508  ((
p™
->
hw
.
¥—k”_d©a_Ú
 << 1è| 
	`p™_g‘_g©e
(pit, 2) |

509 (
	`p™_g‘_out
(
p™
, 2è<< 5è| (
»äesh_şock
 << 4));

510 
	}
}

512 
	$hªdË_¥—k”_io
(

513 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

515 
PITS‹
 *
vp™
 = 
	`vıu_vp™
(
cu¼’t
);

517 
	`BUG_ON
(
by‹s
 != 1);

519 
	`¥š_lock
(&
vp™
->
lock
);

521 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

522 
	`¥—k”_iİÜt_wr™e
(
vp™
, 
pÜt
, *
v®
);

524 *
v®
 = 
	`¥—k”_iİÜt_»ad
(
vp™
, 
pÜt
);

526 
	`¥š_uÆock
(&
vp™
->
lock
);

528  
X86EMUL_OKAY
;

529 
	}
}

531 
	$pv_p™_hªdËr
(
pÜt
, 
d©a
, 
wr™e
)

533 
iÜeq_t
 
iÜeq
 = {

534 .
size
 = 1,

535 .
ty³
 = 
IOREQ_TYPE_PIO
,

536 .
addr
 = 
pÜt
,

537 .
dœ
 = 
wr™e
 ? 
IOREQ_WRITE
 : 
IOREQ_READ
,

538 .
d©a
 = data

541 iàĞ(
cu¼’t
->
domaš
->
domaš_id
 =ğ0è&& 
	`dom0_p™_acûss
(&
iÜeq
) )

547 
ušt32_t
 
v®
 = 
d©a
;

548 iàĞ
pÜt
 == 0x61 )

549 
	`hªdË_¥—k”_io
(
iÜeq
.
dœ
, 
pÜt
, 1, &
v®
);

551 
	`hªdË_p™_io
(
iÜeq
.
dœ
, 
pÜt
, 1, &
v®
);

552 
iÜeq
.
d©a
 = 
v®
;

555  !
wr™e
 ? 
iÜeq
.
d©a
 : 0;

556 
	}
}

	@hvm/intercept.c

21 
	~<x’/cÚfig.h
>

22 
	~<x’/ty³s.h
>

23 
	~<x’/sched.h
>

24 
	~<asm/»gs.h
>

25 
	~<asm/hvm/hvm.h
>

26 
	~<asm/hvm/suµÜt.h
>

27 
	~<asm/hvm/domaš.h
>

28 
	~<x’/lib.h
>

29 
	~<x’/sched.h
>

30 
	~<asm/cu¼’t.h
>

31 
	~<io_pÜts.h
>

32 
	~<x’/ev’t.h
>

33 
	~<x’/iommu.h
>

35 cÚ¡ 
hvm_mmio_hªdËr
 
h³t_mmio_hªdËr
;

36 cÚ¡ 
hvm_mmio_hªdËr
 
vÏpic_mmio_hªdËr
;

37 cÚ¡ 
hvm_mmio_hªdËr
 
vißpic_mmio_hªdËr
;

38 cÚ¡ 
hvm_mmio_hªdËr
 
msixtbl_mmio_hªdËr
;

40 
	#HVM_MMIO_HANDLER_NR
 4

	)

42 cÚ¡ 
hvm_mmio_hªdËr
 *const

43 
	ghvm_mmio_hªdËrs
[
HVM_MMIO_HANDLER_NR
] =

45 &
h³t_mmio_hªdËr
,

46 &
vÏpic_mmio_hªdËr
,

47 &
vißpic_mmio_hªdËr
,

48 &
msixtbl_mmio_hªdËr


51 
	$hvm_mmio_acûss
(
vıu
 *
v
,

52 
iÜeq_t
 *
p
,

53 
hvm_mmio_»ad_t
 
»ad_hªdËr
,

54 
hvm_mmio_wr™e_t
 
wr™e_hªdËr
)

56 
d©a
;

57 
rc
 = 
X86EMUL_OKAY
, 
i
, 
sign
 = 
p
->
df
 ? -1 : 1;

59 iàĞ!
p
->
d©a_is_±r
 )

61 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

63 
rc
 = 
	`»ad_hªdËr
(
v
, 
p
->
addr
,…->
size
, &
d©a
);

64 
p
->
d©a
 = data;

67 
rc
 = 
	`wr™e_hªdËr
(
v
, 
p
->
addr
,…->
size
,…->
d©a
);

68  
rc
;

71 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

73  
i
 = 0; i < 
p
->
couÁ
; i++ )

75 
»t
;

77 
rc
 = 
	`»ad_hªdËr
(
v
, 
p
->
addr
 + (
sign
 * 
i
 *…->
size
),…->size,

78 &
d©a
);

79 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

81 
»t
 = 
	`hvm_cİy_to_gue¡_phys
(
p
->
d©a
 + (
sign
 * 
i
 *…->
size
),

82 &
d©a
,

83 
p
->
size
);

84 iàĞ(
»t
 =ğ
HVMCOPY_gâ_·ged_out
) ||

85 (
»t
 =ğ
HVMCOPY_gâ_sh¬ed
) )

87 
rc
 = 
X86EMUL_RETRY
;

94  
i
 = 0; i < 
p
->
couÁ
; i++ )

96 
»t
;

98 
»t
 = 
	`hvm_cİy_äom_gue¡_phys
(&
d©a
,

99 
p
->
d©a
 + (
sign
 * 
i
 *…->
size
),

100 
p
->
size
);

101 iàĞ(
»t
 =ğ
HVMCOPY_gâ_·ged_out
) ||

102 (
»t
 =ğ
HVMCOPY_gâ_sh¬ed
) )

104 
rc
 = 
X86EMUL_RETRY
;

107 
rc
 = 
	`wr™e_hªdËr
(
v
, 
p
->
addr
 + (
sign
 * 
i
 *…->
size
),…->size,

108 
d©a
);

109 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

114 iàĞ
i
 != 0 )

116 
p
->
couÁ
 = 
i
;

117 
rc
 = 
X86EMUL_OKAY
;

120  
rc
;

121 
	}
}

123 
	$hvm_mmio_š‹rû±
(
iÜeq_t
 *
p
)

125 
vıu
 *
v
 = 
cu¼’t
;

126 
i
;

128  
i
 = 0; i < 
HVM_MMIO_HANDLER_NR
; i++ )

129 iàĞ
hvm_mmio_hªdËrs
[
i
]->
	`check_hªdËr
(
v
, 
p
->
addr
) )

130  
	`hvm_mmio_acûss
(

131 
v
, 
p
,

132 
hvm_mmio_hªdËrs
[
i
]->
»ad_hªdËr
,

133 
hvm_mmio_hªdËrs
[
i
]->
wr™e_hªdËr
);

135  
X86EMUL_UNHANDLEABLE
;

136 
	}
}

138 
	$´oûss_pÜtio_š‹rû±
(
pÜtio_aùiÚ_t
 
aùiÚ
, 
iÜeq_t
 *
p
)

140 
rc
 = 
X86EMUL_OKAY
, 
i
, 
sign
 = 
p
->
df
 ? -1 : 1;

141 
ušt32_t
 
d©a
;

143 iàĞ!
p
->
d©a_is_±r
 )

145 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

147 
rc
 = 
	`aùiÚ
(
IOREQ_READ
, 
p
->
addr
,…->
size
, &
d©a
);

148 
p
->
d©a
 = data;

152 
d©a
 = 
p
->data;

153 
rc
 = 
	`aùiÚ
(
IOREQ_WRITE
, 
p
->
addr
,…->
size
, &
d©a
);

155  
rc
;

158 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

160  
i
 = 0; i < 
p
->
couÁ
; i++ )

162 
rc
 = 
	`aùiÚ
(
IOREQ_READ
, 
p
->
addr
,…->
size
, &
d©a
);

163 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

165 ()
	`hvm_cİy_to_gue¡_phys
(
p
->
d©a
 + 
sign
*
i
*p->
size
,

166 &
d©a
, 
p
->
size
);

171  
i
 = 0; i < 
p
->
couÁ
; i++ )

173 
d©a
 = 0;

174 ()
	`hvm_cİy_äom_gue¡_phys
(&
d©a
, 
p
->d©¨+ 
sign
*
i
*p->
size
,

175 
p
->
size
);

176 
rc
 = 
	`aùiÚ
(
IOREQ_WRITE
, 
p
->
addr
,…->
size
, &
d©a
);

177 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

182 iàĞ
i
 != 0 )

184 
p
->
couÁ
 = 
i
;

185 
rc
 = 
X86EMUL_OKAY
;

188  
rc
;

189 
	}
}

195 
	$hvm_io_š‹rû±
(
iÜeq_t
 *
p
, 
ty³
)

197 
vıu
 *
v
 = 
cu¼’t
;

198 
hvm_io_hªdËr
 *
hªdËr
 =

199 &
v
->
domaš
->
¬ch
.
hvm_domaš
.
io_hªdËr
;

200 
i
;

201 
addr
, 
size
;

203 iàĞ
ty³
 =ğ
HVM_PORTIO
 )

205 
rc
 = 
	`dpci_iİÜt_š‹rû±
(
p
);

206 iàĞ(
rc
 =ğ
X86EMUL_OKAY
è|| (rø=ğ
X86EMUL_RETRY
) )

207  
rc
;

210  
i
 = 0; i < 
hªdËr
->
num_¦Ù
; i++ )

212 iàĞ
ty³
 !ğ
hªdËr
->
hdl_li¡
[
i
].type )

214 
addr
 = 
hªdËr
->
hdl_li¡
[
i
].addr;

215 
size
 = 
hªdËr
->
hdl_li¡
[
i
].size;

216 iàĞ(
p
->
addr
 >=‡ddr) &&

217 ((
p
->
addr
 +…->
size
) <= (addr + size)) )

219 iàĞ
ty³
 =ğ
HVM_PORTIO
 )

220  
	`´oûss_pÜtio_š‹rû±
(

221 
hªdËr
->
hdl_li¡
[
i
].
aùiÚ
.
pÜtio
, 
p
);

222  
hªdËr
->
hdl_li¡
[
i
].
aùiÚ
.
	`mmio
(
p
);

226  
X86EMUL_UNHANDLEABLE
;

227 
	}
}

229 
	$»gi¡”_io_hªdËr
(

230 
domaš
 *
d
, 
addr
, 
size
,

231 *
aùiÚ
, 
ty³
)

233 
hvm_io_hªdËr
 *
hªdËr
 = &
d
->
¬ch
.
hvm_domaš
.
io_hªdËr
;

234 
num
 = 
hªdËr
->
num_¦Ù
;

236 
	`BUG_ON
(
num
 >ğ
MAX_IO_HANDLER
);

238 
hªdËr
->
hdl_li¡
[
num
].
addr
 =‡ddr;

239 
hªdËr
->
hdl_li¡
[
num
].
size
 = size;

240 
hªdËr
->
hdl_li¡
[
num
].
aùiÚ
.
±r
 =‡ction;

241 
hªdËr
->
hdl_li¡
[
num
].
ty³
 =ype;

242 
hªdËr
->
num_¦Ù
++;

243 
	}
}

245 
	$»loÿ‹_io_hªdËr
(

246 
domaš
 *
d
, 
Şd_addr
, 
Ãw_addr
,

247 
size
, 
ty³
)

249 
hvm_io_hªdËr
 *
hªdËr
 = &
d
->
¬ch
.
hvm_domaš
.
io_hªdËr
;

250 
i
;

252  
i
 = 0; i < 
hªdËr
->
num_¦Ù
; i++ )

253 iàĞ(
hªdËr
->
hdl_li¡
[
i
].
addr
 =ğ
Şd_addr
) &&

254 (
hªdËr
->
hdl_li¡
[
i
].
size
 == size) &&

255 (
hªdËr
->
hdl_li¡
[
i
].
ty³
 ==ype) )

256 
hªdËr
->
hdl_li¡
[
i
].
addr
 = 
Ãw_addr
;

257 
	}
}

	@hvm/io.c

22 
	~<x’/cÚfig.h
>

23 
	~<x’/š™.h
>

24 
	~<x’/mm.h
>

25 
	~<x’/lib.h
>

26 
	~<x’/”ºo.h
>

27 
	~<x’/Œaû.h
>

28 
	~<x’/ev’t.h
>

29 
	~<x’/hy³rÿÎ.h
>

30 
	~<asm/cu¼’t.h
>

31 
	~<asm/ıuã©u».h
>

32 
	~<asm/´oûssÜ.h
>

33 
	~<asm/m¤.h
>

34 
	~<asm/­ic.h
>

35 
	~<asm/·gšg.h
>

36 
	~<asm/shadow.h
>

37 
	~<asm/p2m.h
>

38 
	~<asm/hvm/hvm.h
>

39 
	~<asm/hvm/suµÜt.h
>

40 
	~<asm/hvm/v±.h
>

41 
	~<asm/hvm/vpic.h
>

42 
	~<asm/hvm/vÏpic.h
>

43 
	~<asm/hvm/Œaû.h
>

44 
	~<asm/hvm/emuÏ‹.h
>

45 
	~<public/sched.h
>

46 
	~<x’/ioÿp.h
>

47 
	~<public/hvm/iÜeq.h
>

49 
	$hvm_bufã»d_io_£nd
(
iÜeq_t
 *
p
)

51 
vıu
 *
v
 = 
cu¼’t
;

52 
hvm_iÜeq_·ge
 *
iÜp
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.
buf_iÜeq
;

53 
bufã»d_iİage_t
 *
pg
 = 
iÜp
->
va
;

54 
buf_iÜeq_t
 
bp
;

56 
qw
 = 0;

59 
	`BUILD_BUG_ON
((
bufã»d_iİage_t
è> 
PAGE_SIZE
);

69 iàĞ(
p
->
addr
 > 0xfffffulè||…->
d©a_is_±r
 || (p->
couÁ
 != 1) )

72 
bp
.
ty³
 = 
p
->type;

73 
bp
.
dœ
 = 
p
->dir;

74  
p
->
size
 )

77 
bp
.
size
 = 0;

80 
bp
.
size
 = 1;

83 
bp
.
size
 = 2;

86 
bp
.
size
 = 3;

87 
qw
 = 1;

90 
	`gd´štk
(
XENLOG_WARNING
, "uÃx³ùed iÜeq size: %u\n", 
p
->
size
);

94 
bp
.
d©a
 = 
p
->data;

95 
bp
.
addr
 = 
p
->addr;

97 
	`¥š_lock
(&
iÜp
->
lock
);

99 iàĞ(
pg
->
wr™e_poš‹r
 -…g->
»ad_poš‹r
) >=

100 (
IOREQ_BUFFER_SLOT_NUM
 - 
qw
) )

103 
	`¥š_uÆock
(&
iÜp
->
lock
);

107 
	`memıy
(&
pg
->
buf_iÜeq
[pg->
wr™e_poš‹r
 % 
IOREQ_BUFFER_SLOT_NUM
],

108 &
bp
, (bp));

110 iàĞ
qw
 )

112 
bp
.
d©a
 = 
p
->data >> 32;

113 
	`memıy
(&
pg
->
buf_iÜeq
[Õg->
wr™e_poš‹r
+1è% 
IOREQ_BUFFER_SLOT_NUM
],

114 &
bp
, (bp));

118 
	`wmb
();

119 
pg
->
wr™e_poš‹r
 +ğ
qw
 ? 2 : 1;

121 
	`¥š_uÆock
(&
iÜp
->
lock
);

124 
	}
}

126 
	$£nd_timeoff£t_»q
(
timeoff
)

128 
iÜeq_t
 
p
[1];

130 iàĞ
timeoff
 == 0 )

133 
	`mem£t
(
p
, 0, (*p));

135 
p
->
ty³
 = 
IOREQ_TYPE_TIMEOFFSET
;

136 
p
->
size
 = 8;

137 
p
->
couÁ
 = 1;

138 
p
->
dœ
 = 
IOREQ_WRITE
;

139 
p
->
d©a
 = 
timeoff
;

141 
p
->
¡©e
 = 
STATE_IOREQ_READY
;

143 iàĞ!
	`hvm_bufã»d_io_£nd
(
p
) )

144 
	`´štk
("Unsuccessfulimeoffset update\n");

145 
	}
}

148 
	$£nd_šv®id©e_»q
()

150 
vıu
 *
v
 = 
cu¼’t
;

151 
iÜeq_t
 *
p
 = 
	`g‘_iÜeq
(
v
);

153 iàĞ
p
->
¡©e
 !ğ
STATE_IOREQ_NONE
 )

155 
	`gd´štk
(
XENLOG_ERR
, "WARNING: send invalidate„eq with something "

156 "®»ady…’dšg (%d)?\n", 
p
->
¡©e
);

157 
	`domaš_üash
(
v
->
domaš
);

161 
p
->
ty³
 = 
IOREQ_TYPE_INVALIDATE
;

162 
p
->
size
 = 4;

163 
p
->
dœ
 = 
IOREQ_WRITE
;

164 
p
->
d©a
 = ~0UL;

166 ()
	`hvm_£nd_assi¡_»q
(
v
);

167 
	}
}

169 
	$hªdË_mmio
()

171 
hvm_emuÏ‹_ùxt
 
ùxt
;

172 
vıu
 *
cu¼
 = 
cu¼’t
;

173 
rc
;

175 
	`hvm_emuÏ‹_´•¬e
(&
ùxt
, 
	`gue¡_ıu_u£r_»gs
());

177 
rc
 = 
	`hvm_emuÏ‹_Úe
(&
ùxt
);

179 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 =ğ
HVMIO_awa™šg_com¶‘iÚ
 )

180 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_hªdË_mmio_awa™šg_com¶‘iÚ
;

182 
cu¼
->
¬ch
.
hvm_vıu
.
mmio_gva
 = 0;

184  
rc
 )

186 
X86EMUL_UNHANDLEABLE
:

187 
	`gd´štk
(
XENLOG_WARNING
,

190 
	`hvmemul_g‘_£g_»g
(
x86_£g_cs
, &
ùxt
)->
£l
,

191 
ùxt
.
š¢_buf_e
,

192 
ùxt
.
š¢_buf
[0], ctxt.insn_buf[1],

193 
ùxt
.
š¢_buf
[2], ctxt.insn_buf[3],

194 
ùxt
.
š¢_buf
[4], ctxt.insn_buf[5]);

196 
X86EMUL_EXCEPTION
:

197 iàĞ
ùxt
.
exn_³ndšg
 )

198 
	`hvm_šjeù_exû±iÚ
(
ùxt
.
exn_veùÜ
, ctxt.
exn_”rÜ_code
, 0);

204 
	`hvm_emuÏ‹_wr™eback
(&
ùxt
);

207 
	}
}

209 
	$hªdË_mmio_w™h_Œª¦©iÚ
(
gva
, 
gpâ
)

211 
cu¼’t
->
¬ch
.
hvm_vıu
.
mmio_gva
 = 
gva
 & 
PAGE_MASK
;

212 
cu¼’t
->
¬ch
.
hvm_vıu
.
mmio_gpâ
 = 
gpâ
;

213  
	`hªdË_mmio
();

214 
	}
}

216 
	$hªdË_pio
(
ušt16_t
 
pÜt
, 
size
, 
dœ
)

218 
vıu
 *
cu¼
 = 
cu¼’t
;

219 
d©a
, 
»ps
 = 1;

220 
rc
;

222 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

223 
d©a
 = 
	`gue¡_ıu_u£r_»gs
()->
—x
;

225 
rc
 = 
	`hvmemul_do_pio
(
pÜt
, &
»ps
, 
size
, 0, 
dœ
, 0, &
d©a
);

227  
rc
 )

229 
X86EMUL_OKAY
:

230 iàĞ
dœ
 =ğ
IOREQ_READ
 )

231 
	`memıy
(&
	`gue¡_ıu_u£r_»gs
()->
—x
,

232 &
d©a
, 
cu¼
->
¬ch
.
hvm_vıu
.
io_size
);

234 
X86EMUL_RETRY
:

235 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 !ğ
HVMIO_awa™šg_com¶‘iÚ
 )

238 
	`ASSERT
(
dœ
 =ğ
IOREQ_READ
);

239 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_hªdË_pio_awa™šg_com¶‘iÚ
;

242 
	`BUG
();

246 
	}
}

248 
	$hvm_io_assi¡
()

250 
vıu
 *
cu¼
 = 
cu¼’t
;

251 
iÜeq_t
 *
p
 = 
	`g‘_iÜeq
(
cu¼
);

252 
hvm_io_¡©e
 
io_¡©e
;

254 
	`rmb
();

256 
p
->
¡©e
 = 
STATE_IOREQ_NONE
;

258 
io_¡©e
 = 
cu¼
->
¬ch
.
hvm_vıu
.io_state;

259 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_nÚe
;

261  
io_¡©e
 )

263 
HVMIO_awa™šg_com¶‘iÚ
:

264 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_com¶‘ed
;

265 
cu¼
->
¬ch
.
hvm_vıu
.
io_d©a
 = 
p
->
d©a
;

267 
HVMIO_hªdË_mmio_awa™šg_com¶‘iÚ
:

268 
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 = 
HVMIO_com¶‘ed
;

269 
cu¼
->
¬ch
.
hvm_vıu
.
io_d©a
 = 
p
->
d©a
;

270 ()
	`hªdË_mmio
();

272 
HVMIO_hªdË_pio_awa™šg_com¶‘iÚ
:

273 
	`memıy
(&
	`gue¡_ıu_u£r_»gs
()->
—x
,

274 &
p
->
d©a
, 
cu¼
->
¬ch
.
hvm_vıu
.
io_size
);

280 iàĞ
p
->
¡©e
 =ğ
STATE_IOREQ_NONE
 )

281 
	`vıu_’d_shutdown_deã¼®
(
cu¼
);

282 
	}
}

284 
	$dpci_iİÜt_»ad
(
ušt32_t
 
mpÜt
, 
iÜeq_t
 *
p
)

286 
i
, 
sign
 = 
p
->
df
 ? -1 : 1;

287 
ušt32_t
 
d©a
 = 0;

289  
i
 = 0; i < 
p
->
couÁ
; i++ )

291  
p
->
size
 )

294 
d©a
 = 
	`šb
(
mpÜt
);

297 
d©a
 = 
	`šw
(
mpÜt
);

300 
d©a
 = 
	`šl
(
mpÜt
);

303 
	`BUG
();

306 iàĞ
p
->
d©a_is_±r
 )

308 
»t
;

309 
»t
 = 
	`hvm_cİy_to_gue¡_phys
(
p
->
d©a
 + (
sign
 * 
i
 *…->
size
), &data,

310 
p
->
size
);

311 iàĞ(
»t
 =ğ
HVMCOPY_gâ_·ged_out
) ||

312 (
»t
 =ğ
HVMCOPY_gâ_sh¬ed
) )

313  
X86EMUL_RETRY
;

316 
p
->
d©a
 = data;

319  
X86EMUL_OKAY
;

320 
	}
}

322 
	$dpci_iİÜt_wr™e
(
ušt32_t
 
mpÜt
, 
iÜeq_t
 *
p
)

324 
i
, 
sign
 = 
p
->
df
 ? -1 : 1;

325 
ušt32_t
 
d©a
;

327  
i
 = 0; i < 
p
->
couÁ
; i++ )

329 
d©a
 = 
p
->data;

330 iàĞ
p
->
d©a_is_±r
 )

332 
»t
;

334 
»t
 = 
	`hvm_cİy_äom_gue¡_phys
(&
d©a
,

335 
p
->
d©a
 + (
sign
 * 
i
 *…->
size
),

336 
p
->
size
);

337 iàĞ(
»t
 =ğ
HVMCOPY_gâ_·ged_out
) &&

338 (
»t
 =ğ
HVMCOPY_gâ_sh¬ed
) )

339  
X86EMUL_RETRY
;

342  
p
->
size
 )

345 
	`outb
(
d©a
, 
mpÜt
);

348 
	`outw
(
d©a
, 
mpÜt
);

351 
	`ou
(
d©a
, 
mpÜt
);

354 
	`BUG
();

358  
X86EMUL_OKAY
;

359 
	}
}

361 
	$dpci_iİÜt_š‹rû±
(
iÜeq_t
 *
p
)

363 
domaš
 *
d
 = 
cu¼’t
->domain;

364 
hvm_iommu
 *
hd
 = 
	`domaš_hvm_iommu
(
d
);

365 
g2m_iİÜt
 *g2m_ioport;

366 
mpÜt
, 
gpÜt
 = 
p
->
addr
;

367 
s
 = 0, 
e
 = 0;

368 
rc
;

370 
	`li¡_fÜ_—ch_’Œy
Ğ
g2m_iİÜt
, &
hd
->
g2m_iİÜt_li¡
, 
li¡
 )

372 
s
 = 
g2m_iİÜt
->
gpÜt
;

373 
e
 = 
s
 + 
g2m_iİÜt
->
Å
;

374 iàĞ(
gpÜt
 >ğ
s
è&& (gpÜˆ< 
e
) )

375 
found
;

378  
X86EMUL_UNHANDLEABLE
;

380 
found
:

381 
mpÜt
 = (
gpÜt
 - 
s
è+ 
g2m_iİÜt
->mport;

383 iàĞ!
	`iİÜts_acûss_³rm™‹d
(
d
, 
mpÜt
, mpÜˆ+ 
p
->
size
 - 1) )

385 
	`gd´štk
(
XENLOG_ERR
, "Error:‡ccesso gport=0x%x denied!\n",

386 (
ušt32_t
)
p
->
addr
);

387  
X86EMUL_UNHANDLEABLE
;

390  
p
->
dœ
 )

392 
IOREQ_READ
:

393 
rc
 = 
	`dpci_iİÜt_»ad
(
mpÜt
, 
p
);

395 
IOREQ_WRITE
:

396 
rc
 = 
	`dpci_iİÜt_wr™e
(
mpÜt
, 
p
);

399 
	`gd´štk
(
XENLOG_ERR
, "E¼Ü: couldn'ˆhªdË…->dœ = %d", 
p
->
dœ
);

400 
rc
 = 
X86EMUL_UNHANDLEABLE
;

403  
rc
;

404 
	}
}

	@hvm/irq.c

22 
	~<x’/cÚfig.h
>

23 
	~<x’/ty³s.h
>

24 
	~<x’/ev’t.h
>

25 
	~<x’/sched.h
>

26 
	~<x’/œq.h
>

27 
	~<asm/hvm/domaš.h
>

28 
	~<asm/hvm/suµÜt.h
>

31 
	$as£¹_œq
(
domaš
 *
d
, 
ißpic_gsi
, 
pic_œq
)

33 
pœq
 = 
	`domaš_emuœq_to_pœq
(
d
, 
ißpic_gsi
);

34 iàĞ
	`hvm_domaš_u£_pœq
(
d
, 
pœq
) )

36 
	`£nd_gue¡_pœq
(
d
, 
pœq
);

39 
	`vißpic_œq_pos™ive_edge
(
d
, 
ißpic_gsi
);

40 
	`vpic_œq_pos™ive_edge
(
d
, 
pic_œq
);

41 
	}
}

44 
	$d—s£¹_œq
(
domaš
 *
d
, 
i§_œq
)

46 
pœq
 = 
	`domaš_emuœq_to_pœq
(
d
, 
i§_œq
);

47 iàĞ!
	`hvm_domaš_u£_pœq
(
d
, 
pœq
) )

48 
	`vpic_œq_Ãg©ive_edge
(
d
, 
i§_œq
);

49 
	}
}

51 
	$__hvm_pci_štx_as£¹
(

52 
domaš
 *
d
, 
deviû
, 
štx
)

54 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

55 
gsi
, 
lšk
, 
i§_œq
;

57 
	`ASSERT
((
deviû
 <ğ31è&& (
štx
 <= 3));

59 iàĞ
	`__‹¡_ªd_£t_b™
(
deviû
*4 + 
štx
, &
hvm_œq
->
pci_štx
.
i
) )

62 
gsi
 = 
	`hvm_pci_štx_gsi
(
deviû
, 
štx
);

63 iàĞ
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++ == 0 )

64 
	`vißpic_œq_pos™ive_edge
(
d
, 
gsi
);

66 
lšk
 = 
	`hvm_pci_štx_lšk
(
deviû
, 
štx
);

67 
i§_œq
 = 
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
];

68 iàĞ(
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
]++ =ğ0è&& 
i§_œq
 &&

69 (
hvm_œq
->
gsi_as£¹_couÁ
[
i§_œq
]++ == 0) )

70 
	`as£¹_œq
(
d
, 
i§_œq
, isa_irq);

71 
	}
}

73 
	$hvm_pci_štx_as£¹
(

74 
domaš
 *
d
, 
deviû
, 
štx
)

76 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

77 
	`__hvm_pci_štx_as£¹
(
d
, 
deviû
, 
štx
);

78 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

79 
	}
}

81 
	$__hvm_pci_štx_d—s£¹
(

82 
domaš
 *
d
, 
deviû
, 
štx
)

84 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

85 
gsi
, 
lšk
, 
i§_œq
;

87 
	`ASSERT
((
deviû
 <ğ31è&& (
štx
 <= 3));

89 iàĞ!
	`__‹¡_ªd_ş—r_b™
(
deviû
*4 + 
štx
, &
hvm_œq
->
pci_štx
.
i
) )

92 
gsi
 = 
	`hvm_pci_štx_gsi
(
deviû
, 
štx
);

93 --
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
];

95 
lšk
 = 
	`hvm_pci_štx_lšk
(
deviû
, 
štx
);

96 
i§_œq
 = 
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
];

97 iàĞ(--
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
] =ğ0è&& 
i§_œq
 &&

98 (--
hvm_œq
->
gsi_as£¹_couÁ
[
i§_œq
] == 0) )

99 
	`d—s£¹_œq
(
d
, 
i§_œq
);

100 
	}
}

102 
	$hvm_pci_štx_d—s£¹
(

103 
domaš
 *
d
, 
deviû
, 
štx
)

105 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

106 
	`__hvm_pci_štx_d—s£¹
(
d
, 
deviû
, 
štx
);

107 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

108 
	}
}

110 
	$hvm_i§_œq_as£¹
(

111 
domaš
 *
d
, 
i§_œq
)

113 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

114 
gsi
 = 
	`hvm_i§_œq_to_gsi
(
i§_œq
);

116 
	`ASSERT
(
i§_œq
 <= 15);

118 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

120 iàĞ!
	`__‹¡_ªd_£t_b™
(
i§_œq
, &
hvm_œq
->i§_œq.
i
) &&

121 (
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++ == 0) )

122 
	`as£¹_œq
(
d
, 
gsi
, 
i§_œq
);

124 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

125 
	}
}

127 
	$hvm_i§_œq_d—s£¹
(

128 
domaš
 *
d
, 
i§_œq
)

130 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

131 
gsi
 = 
	`hvm_i§_œq_to_gsi
(
i§_œq
);

133 
	`ASSERT
(
i§_œq
 <= 15);

135 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

137 iàĞ
	`__‹¡_ªd_ş—r_b™
(
i§_œq
, &
hvm_œq
->i§_œq.
i
) &&

138 (--
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
] == 0) )

139 
	`d—s£¹_œq
(
d
, 
i§_œq
);

141 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

142 
	}
}

144 
	$hvm_£t_ÿÎback_œq_Ëv–
(
vıu
 *
v
)

146 
domaš
 *
d
 = 
v
->domain;

147 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

148 
gsi
, 
pdev
, 
pštx
, 
as£¹ed
;

150 
	`ASSERT
(
v
->
vıu_id
 == 0);

152 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

155 
as£¹ed
 = !!
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_³ndšg
);

156 iàĞ
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 =ğ
as£¹ed
 )

157 
out
;

158 
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 = 
as£¹ed
;

161  
hvm_œq
->
ÿÎback_vŸ_ty³
 )

163 
HVMIRQ_ÿÎback_gsi
:

164 
gsi
 = 
hvm_œq
->
ÿÎback_vŸ
.gsi;

165 iàĞ
as£¹ed
 && (
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++ == 0) )

167 
	`vißpic_œq_pos™ive_edge
(
d
, 
gsi
);

168 iàĞ
gsi
 <= 15 )

169 
	`vpic_œq_pos™ive_edge
(
d
, 
gsi
);

171 iàĞ!
as£¹ed
 && (--
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
] == 0) )

173 iàĞ
gsi
 <= 15 )

174 
	`vpic_œq_Ãg©ive_edge
(
d
, 
gsi
);

177 
HVMIRQ_ÿÎback_pci_štx
:

178 
pdev
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
dev
;

179 
pštx
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
štx
;

180 iàĞ
as£¹ed
 )

181 
	`__hvm_pci_štx_as£¹
(
d
, 
pdev
, 
pštx
);

183 
	`__hvm_pci_štx_d—s£¹
(
d
, 
pdev
, 
pštx
);

188 
out
:

189 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

190 
	}
}

192 
	$hvm_maybe_d—s£¹_evtchn_œq
()

194 
domaš
 *
d
 = 
cu¼’t
->domain;

195 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

197 iàĞ
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 &&

198 !
	`vıu_šfo
(
d
->
vıu
[0], 
evtchn_upÿÎ_³ndšg
) )

199 
	`hvm_£t_ÿÎback_œq_Ëv–
(
d
->
vıu
[0]);

200 
	}
}

202 
	$hvm_as£¹_evtchn_œq
(
vıu
 *
v
)

204 iàĞ
	`uÆik–y
(
	`š_œq
(è|| !
	`loÿl_œq_is_’abËd
()) )

206 
	`skËt_scheduË
(&
v
->
¬ch
.
hvm_vıu
.
as£¹_evtchn_œq_skËt
);

210 iàĞ
	`is_hvm_pv_evtchn_vıu
(
v
) )

211 
	`vıu_kick
(
v
);

212 iàĞ
v
->
vıu_id
 == 0 )

213 
	`hvm_£t_ÿÎback_œq_Ëv–
(
v
);

214 
	}
}

216 
	$hvm_£t_pci_lšk_rou‹
(
domaš
 *
d
, 
u8
 
lšk
, u8 
i§_œq
)

218 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

219 
u8
 
Şd_i§_œq
;

220 
i
;

222 
	`ASSERT
((
lšk
 <ğ3è&& (
i§_œq
 <= 15));

224 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

226 
Şd_i§_œq
 = 
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
];

227 iàĞ
Şd_i§_œq
 =ğ
i§_œq
 )

228 
out
;

229 
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
] = 
i§_œq
;

232 iàĞ
hvm_œq
->
dpci
 )

234 iàĞ
Şd_i§_œq
 )

235 
	`ş—r_b™
(
Şd_i§_œq
, &
hvm_œq
->
dpci
->
i§œq_m­
);

237  
i
 = 0; i < 
NR_LINK
; i++ )

238 iàĞ
hvm_œq
->
dpci
->
lšk_út
[
i
] && hvm_œq->
pci_lšk
.
rou‹
[i] )

239 
	`£t_b™
(
hvm_œq
->
pci_lšk
.
rou‹
[
i
],

240 &
hvm_œq
->
dpci
->
i§œq_m­
);

243 iàĞ
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
] == 0 )

244 
out
;

246 iàĞ
Şd_i§_œq
 && (--
hvm_œq
->
gsi_as£¹_couÁ
[old_isa_irq] == 0) )

247 
	`vpic_œq_Ãg©ive_edge
(
d
, 
Şd_i§_œq
);

249 iàĞ
i§_œq
 && (
hvm_œq
->
gsi_as£¹_couÁ
[isa_irq]++ == 0) )

251 
	`vißpic_œq_pos™ive_edge
(
d
, 
i§_œq
);

252 
	`vpic_œq_pos™ive_edge
(
d
, 
i§_œq
);

255 
out
:

256 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

258 
	`d´štk
(
XENLOG_G_INFO
, "Dom%u PCI†ink %u changed %u -> %u\n",

259 
d
->
domaš_id
, 
lšk
, 
Şd_i§_œq
, 
i§_œq
);

260 
	}
}

262 
	$hvm_£t_ÿÎback_vŸ
(
domaš
 *
d
, 
ušt64_t
 
vŸ
)

264 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

265 
gsi
=0, 
pdev
=0, 
pštx
=0;

266 
ušt8_t
 
vŸ_ty³
;

268 
vŸ_ty³
 = (
ušt8_t
)(
vŸ
 >> 56) + 1;

269 iàĞ((
vŸ_ty³
 =ğ
HVMIRQ_ÿÎback_gsi
è&& (
vŸ
 == 0)) ||

270 (
vŸ_ty³
 > 
HVMIRQ_ÿÎback_veùÜ
) )

271 
vŸ_ty³
 = 
HVMIRQ_ÿÎback_nÚe
;

273 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

276 iàĞ
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 )

278  
hvm_œq
->
ÿÎback_vŸ_ty³
 )

280 
HVMIRQ_ÿÎback_gsi
:

281 
gsi
 = 
hvm_œq
->
ÿÎback_vŸ
.gsi;

282 iàĞ(--
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
] == 0) && (gsi <= 15) )

283 
	`vpic_œq_Ãg©ive_edge
(
d
, 
gsi
);

285 
HVMIRQ_ÿÎback_pci_štx
:

286 
pdev
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
dev
;

287 
pštx
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
štx
;

288 
	`__hvm_pci_štx_d—s£¹
(
d
, 
pdev
, 
pštx
);

296  
hvm_œq
->
ÿÎback_vŸ_ty³
 = 
vŸ_ty³
 )

298 
HVMIRQ_ÿÎback_gsi
:

299 
gsi
 = 
hvm_œq
->
ÿÎback_vŸ
.gs˜ğ(
ušt8_t
)
vŸ
;

300 iàĞ(
gsi
 =ğ0è|| (gs˜>ğ
	`ARRAY_SIZE
(
hvm_œq
->
gsi_as£¹_couÁ
)) )

301 
hvm_œq
->
ÿÎback_vŸ_ty³
 = 
HVMIRQ_ÿÎback_nÚe
;

302 iàĞ
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 &&

303 (
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++ == 0) )

305 
	`vißpic_œq_pos™ive_edge
(
d
, 
gsi
);

306 iàĞ
gsi
 <= 15 )

307 
	`vpic_œq_pos™ive_edge
(
d
, 
gsi
);

310 
HVMIRQ_ÿÎback_pci_štx
:

311 
pdev
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
dev
 = (
ušt8_t
)(
vŸ
 >> 11) & 31;

312 
pštx
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
štx
 = (
ušt8_t
)
vŸ
 & 3;

313 iàĞ
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 )

314 
	`__hvm_pci_štx_as£¹
(
d
, 
pdev
, 
pštx
);

316 
HVMIRQ_ÿÎback_veùÜ
:

317 
hvm_œq
->
ÿÎback_vŸ
.
veùÜ
 = (
ušt8_t
)
vŸ
;

323 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

325 
	`d´štk
(
XENLOG_G_INFO
, "Dom%u c®lback vŸ chªgedØ", 
d
->
domaš_id
);

326  
vŸ_ty³
 )

328 
HVMIRQ_ÿÎback_gsi
:

329 
	`´štk
("GSI %u\n", 
gsi
);

331 
HVMIRQ_ÿÎback_pci_štx
:

332 
	`´štk
("PCI INTx Dev 0x%02x IÁ%c\n", 
pdev
, 'A' + 
pštx
);

334 
HVMIRQ_ÿÎback_veùÜ
:

335 
	`´štk
("Dœeù VeùÜ 0x%02x\n", (
ušt8_t
)
vŸ
);

338 
	`´štk
("None\n");

341 
	}
}

343 
hvm_šck
 
	$hvm_vıu_has_³ndšg_œq
(
vıu
 *
v
)

345 
hvm_domaš
 *
¶©
 = &
v
->
domaš
->
¬ch
.hvm_domain;

346 
veùÜ
;

348 iàĞ(
¶©
->
œq
.
ÿÎback_vŸ_ty³
 =ğ
HVMIRQ_ÿÎback_veùÜ
)

349 && 
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_³ndšg
) )

350  
	`hvm_šck_veùÜ
(
¶©
->
œq
.
ÿÎback_vŸ
.
veùÜ
);

352 iàĞ
	`uÆik–y
(
v
->
nmi_³ndšg
) )

353  
hvm_šck_nmi
;

355 iàĞ
	`uÆik–y
(
v
->
mû_³ndšg
) )

356  
hvm_šck_mû
;

358 iàĞ
	`vÏpic_acû±_pic_šŒ
(
v
è&& 
¶©
->
vpic
[0].
št_ouut
 )

359  
	`hvm_šck_pic
(0);

361 
veùÜ
 = 
	`vÏpic_has_³ndšg_œq
(
v
);

362 iàĞ
veùÜ
 != -1 )

363  
	`hvm_šck_Ïpic
(
veùÜ
);

365  
hvm_šck_nÚe
;

366 
	}
}

368 
hvm_šck
 
	$hvm_vıu_ack_³ndšg_œq
(

369 
vıu
 *
v
, 
hvm_šck
 
šck
)

371 
veùÜ
;

373  
šck
.
sourû
 )

375 
hvm_št¤c_nmi
:

376 iàĞ!
	`‹¡_ªd_ş—r_boŞ
(
v
->
nmi_³ndšg
) )

377 
šck
 = 
hvm_šck_nÚe
;

379 
hvm_št¤c_mû
:

380 iàĞ!
	`‹¡_ªd_ş—r_boŞ
(
v
->
mû_³ndšg
) )

381 
šck
 = 
hvm_šck_nÚe
;

383 
hvm_št¤c_pic
:

384 iàĞ(
veùÜ
 = 
	`vpic_ack_³ndšg_œq
(
v
)) == -1 )

385 
šck
 = 
hvm_šck_nÚe
;

387 
šck
.
veùÜ
 = (
ušt8_t
)vector;

389 
hvm_št¤c_Ïpic
:

390 iàĞ!
	`vÏpic_ack_³ndšg_œq
(
v
, 
šck
.
veùÜ
) )

391 
šck
 = 
hvm_šck_nÚe
;

393 
hvm_št¤c_veùÜ
:

396 
šck
 = 
hvm_šck_nÚe
;

400  
šck
;

401 
	}
}

403 
	$hvm_loÿl_ev’ts_Ãed_d–iv”y
(
vıu
 *
v
)

405 
hvm_šck
 
šck
 = 
	`hvm_vıu_has_³ndšg_œq
(
v
);

407 iàĞ
	`lik–y
(
šck
.
sourû
 =ğ
hvm_št¤c_nÚe
) )

410  !
	`hvm_š‹¼u±_blocked
(
v
, 
šck
);

411 
	}
}

414 
	$œq_dump
(
domaš
 *
d
)

416 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

417 
i
;

418 
	`´štk
("PCI 0x%16.16"
PRIx64
"%16.16"PRIx64

419 " ISA 0x%8.8"
PRIx32
" ROUTE %u %u %u %u\n",

420 
hvm_œq
->
pci_štx
.
·d
[0], hvm_irq->pci_intx.pad[1],

421 (
ušt32_t
è
hvm_œq
->
i§_œq
.
·d
[0],

422 
hvm_œq
->
pci_lšk
.
rou‹
[0], hvm_irq->pci_link.route[1],

423 
hvm_œq
->
pci_lšk
.
rou‹
[2], hvm_irq->pci_link.route[3]);

424  
i
 = 0 ; i < 
VIOAPIC_NUM_PINS
; i += 8 )

425 
	`´štk
("GSI %2.2"
PRIu8
" %2.2"PRIu8" %2.2"PRIu8" %2.2"PRIu8

426 " %2.2"
PRIu8
" %2.2"PRIu8" %2.2"PRIu8" %2.2"PRIu8"\n",

427 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+0],

428 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+1],

429 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+2],

430 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+3],

431 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+4],

432 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+5],

433 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+6],

434 
hvm_œq
->
gsi_as£¹_couÁ
[
i
+7]);

435 
	`´štk
("Lšk %2.2"
PRIu8
" %2.2"PRIu8" %2.2"PRIu8" %2.2"PRIu8"\n",

436 
hvm_œq
->
pci_lšk_as£¹_couÁ
[0],

437 
hvm_œq
->
pci_lšk_as£¹_couÁ
[1],

438 
hvm_œq
->
pci_lšk_as£¹_couÁ
[2],

439 
hvm_œq
->
pci_lšk_as£¹_couÁ
[3]);

440 
	`´štk
("C®lback vŸ %i:0x%"
PRIx32
",%s‡sserted\n",

441 
hvm_œq
->
ÿÎback_vŸ_ty³
, hvm_œq->
ÿÎback_vŸ
.
gsi
,

442 
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 ? "" : "‚ot");

443 
	}
}

446 
	$œq_§ve_pci
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

448 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

449 
as£¹ed
, 
pdev
, 
pštx
;

450 
rc
;

452 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

454 
pdev
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
dev
;

455 
pštx
 = 
hvm_œq
->
ÿÎback_vŸ
.
pci
.
štx
;

456 
as£¹ed
 = (
hvm_œq
->
ÿÎback_vŸ_as£¹ed
 &&

457 (
hvm_œq
->
ÿÎback_vŸ_ty³
 =ğ
HVMIRQ_ÿÎback_pci_štx
));

464 iàĞ
as£¹ed
 )

465 
	`__hvm_pci_štx_d—s£¹
(
d
, 
pdev
, 
pštx
);

468 
rc
 = 
	`hvm_§ve_’Œy
(
PCI_IRQ
, 0, 
h
, &
hvm_œq
->
pci_štx
);

470 iàĞ
as£¹ed
 )

471 
	`__hvm_pci_štx_as£¹
(
d
, 
pdev
, 
pštx
);

473 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

475  
rc
;

476 
	}
}

478 
	$œq_§ve_i§
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

480 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

483  ( 
	`hvm_§ve_’Œy
(
ISA_IRQ
, 0, 
h
, &
hvm_œq
->
i§_œq
) );

484 
	}
}

486 
	$œq_§ve_lšk
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

488 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

491  ( 
	`hvm_§ve_’Œy
(
PCI_LINK
, 0, 
h
, &
hvm_œq
->
pci_lšk
) );

492 
	}
}

494 
	$œq_lßd_pci
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

496 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

497 
lšk
, 
dev
, 
štx
, 
gsi
;

500 iàĞ
	`hvm_lßd_’Œy
(
PCI_IRQ
, 
h
, &
hvm_œq
->
pci_štx
) != 0 )

501  -
EINVAL
;

504  
lšk
 = 0;†ink < 4;†ink++ )

505 
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
] = 0;

508  
gsi
 = 0; gs˜< 
VIOAPIC_NUM_PINS
; gsi++ )

509 
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
] = 0;

512  
dev
 = 0; dev < 32; dev++ )

513  
štx
 = 0; intx < 4; intx++ )

514 iàĞ
	`‹¡_b™
(
dev
*4 + 
štx
, &
hvm_œq
->
pci_štx
.
i
) )

517 
gsi
 = 
	`hvm_pci_štx_gsi
(
dev
, 
štx
);

518 
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++;

520 
lšk
 = 
	`hvm_pci_štx_lšk
(
dev
, 
štx
);

521 
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
]++;

525 
	}
}

527 
	$œq_lßd_i§
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

529 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

530 
œq
;

533 iàĞ
	`hvm_lßd_’Œy
(
ISA_IRQ
, 
h
, &
hvm_œq
->
i§_œq
) != 0 )

534  -
EINVAL
;

538  
œq
 = 0; 
	`¶©fÜm_Ëgacy_œq
(irq); irq++ )

539 iàĞ
	`‹¡_b™
(
œq
, &
hvm_œq
->
i§_œq
.
i
) )

540 
hvm_œq
->
gsi_as£¹_couÁ
[
	`hvm_i§_œq_to_gsi
(
œq
)]++;

543 
	}
}

546 
	$œq_lßd_lšk
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

548 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

549 
lšk
, 
gsi
;

552 iàĞ
	`hvm_lßd_’Œy
(
PCI_LINK
, 
h
, &
hvm_œq
->
pci_lšk
) != 0 )

553  -
EINVAL
;

556  
lšk
 = 0;†ink < 4;†ink++ )

557 iàĞ
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
] > 15 )

559 
	`gd´štk
(
XENLOG_ERR
,

561 
lšk
, 
hvm_œq
->
pci_lšk
.
rou‹
[link]);

562  -
EINVAL
;

567  
lšk
 = 0;†ink < 4;†ink++ )

569 iàĞ
hvm_œq
->
pci_lšk_as£¹_couÁ
[
lšk
] != 0 )

571 
gsi
 = 
hvm_œq
->
pci_lšk
.
rou‹
[
lšk
];

572 iàĞ
gsi
 != 0 )

573 
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
]++;

578 
	}
}

580 
HVM_REGISTER_SAVE_RESTORE
(
PCI_IRQ
, 
œq_§ve_pci
, 
œq_lßd_pci
,

581 1, 
HVMSR_PER_DOM
);

582 
HVM_REGISTER_SAVE_RESTORE
(
ISA_IRQ
, 
œq_§ve_i§
, 
œq_lßd_i§
,

583 1, 
HVMSR_PER_DOM
);

584 
HVM_REGISTER_SAVE_RESTORE
(
PCI_LINK
, 
œq_§ve_lšk
, 
œq_lßd_lšk
,

585 1, 
HVMSR_PER_DOM
);

	@hvm/mtrr.c

20 
	~<public/hvm/e820.h
>

21 
	~<x’/ty³s.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/mm.h
>

24 
	~<asm/·gšg.h
>

25 
	~<asm/p2m.h
>

26 
	~<x’/domaš_·ge.h
>

27 
	~<asm/mŒr.h
>

28 
	~<asm/hvm/suµÜt.h
>

29 
	~<asm/hvm/ÿch—‰r.h
>

31 
mŒr_¡©e
 mtrr_state;

33 
ušt32_t
 
	gsize_Ü_mask
;

36 
	#·t_ü_2_·f
(
·t_ü
,
n
è((((
ušt64_t
í©_üè>> (Ò)<<3)è& 0xff)

	)

39 
ušt8_t
 
	g·t_’Œy_2_±e_æags
[8] = {

40 0, 
_PAGE_PWT
,

41 
_PAGE_PCD
, _PAGE_PCD | 
_PAGE_PWT
,

42 
_PAGE_PAT
, _PAGE_PAT | 
_PAGE_PWT
,

43 
_PAGE_PAT
 | 
_PAGE_PCD
, _PAGE_PAT | _PAGE_PCD | 
_PAGE_PWT
 };

46 
ušt8_t
 
	gmm_ty³_tbl
[
MTRR_NUM_TYPES
][
PAT_TYPE_NUMS
] = {

69 
ušt8_t
 
	gmŒr_•©_tbl
[
MTRR_NUM_TYPES
][
MEMORY_NUM_TYPES
];

72 
ušt8_t
 
	g·t_’Œy_tbl
[
PAT_TYPE_NUMS
];

74 
	$g‘_mŒr_¿nge
(
ušt64_t
 
ba£_m¤
, ušt64_ˆ
mask_m¤
,

75 
ušt64_t
 *
ba£
, ušt64_ˆ*
’d
)

77 
ušt32_t
 
mask_lo
 = (ušt32_t)
mask_m¤
;

78 
ušt32_t
 
mask_hi
 = (ušt32_t)(
mask_m¤
 >> 32);

79 
ušt32_t
 
ba£_lo
 = (ušt32_t)
ba£_m¤
;

80 
ušt32_t
 
ba£_hi
 = (ušt32_t)(
ba£_m¤
 >> 32);

81 
ušt32_t
 
size
;

83 iàĞ(
mask_lo
 & 0x800) == 0 )

86 *
ba£
 = 0;

87 *
’d
 = 0;

92 
mask_lo
 = (
size_Ü_mask
 | (
mask_hi
 << (32 - 
PAGE_SHIFT
)) |

93 (
mask_lo
 >> 
PAGE_SHIFT
));

96 
size
 = -
mask_lo
;

97 *
ba£
 = 
ba£_hi
 << (32 - 
PAGE_SHIFT
è| 
ba£_lo
 >> PAGE_SHIFT;

98 *
’d
 = *
ba£
 + 
size
 - 1;

99 
	}
}

101 
boŞ_t
 
	$is_v¬_mŒr_ov”Ïµed
(
mŒr_¡©e
 *
m
)

103 
št32_t
 
£g
, 
i
;

104 
ušt64_t
 
phys_ba£
, 
phys_mask
, 
phys_ba£_´e
, 
phys_mask_´e
;

105 
ušt64_t
 
ba£_´e
, 
’d_´e
, 
ba£
, 
’d
;

106 
ušt8_t
 
num_v¬_¿nges
 = (ušt8_t)
m
->
mŒr_ÿp
;

108  
i
 = 0; i < 
num_v¬_¿nges
; i++ )

110 
phys_ba£_´e
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
i
*2];

111 
phys_mask_´e
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
i
*2 + 1];

113 
	`g‘_mŒr_¿nge
(
phys_ba£_´e
, 
phys_mask_´e
,

114 &
ba£_´e
, &
’d_´e
);

116  
£g
 = 
i
 + 1; seg < 
num_v¬_¿nges
; seg ++ )

118 
phys_ba£
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
£g
*2];

119 
phys_mask
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
£g
*2 + 1];

121 
	`g‘_mŒr_¿nge
(
phys_ba£
, 
phys_mask
,

122 &
ba£
, &
’d
);

124 iàĞ((
ba£_´e
 !ğ
’d_´e
è&& (
ba£
 !ğ
’d
))

125 || ((
ba£
 >ğ
ba£_´e
è&& (ba£ <ğ
’d_´e
))

126 || ((
’d
 >ğ
ba£_´e
è&& (’d <ğ
’d_´e
))

127 || ((
ba£_´e
 >ğ
ba£
è&& (ba£_´<ğ
’d
))

128 || ((
’d_´e
 >ğ
ba£
è&& (’d_´<ğ
’d
)) )

136 
	}
}

138 
	#MTRR_PHYSMASK_VALID_BIT
 11

	)

139 
	#MTRR_PHYSMASK_SHIFT
 12

	)

141 
	#MTRR_PHYSBASE_TYPE_MASK
 0xfà

	)

142 
	#MTRR_PHYSBASE_SHIFT
 12

	)

143 
	#MTRR_VCNT
 8

	)

145 
	#MTRRphysBa£_MSR
(
»g
è(0x200 + 2 * (»g))

	)

146 
	#MTRRphysMask_MSR
(
»g
è(0x200 + 2 * (»gè+ 1)

	)

148 
	$hvm_mŒr_·t_š™
()

150 
i
, 
j
, 
phys_addr
;

152 
	`mem£t
(&
mŒr_•©_tbl
, 
INVALID_MEM_TYPE
, (mtrr_epat_tbl));

153  
i
 = 0; i < 
MTRR_NUM_TYPES
; i++ )

155  
j
 = 0; j < 
PAT_TYPE_NUMS
; j++ )

157 
št32_t
 
tmp
 = 
mm_ty³_tbl
[
i
][
j
];

158 iàĞ(
tmp
 >ğ0è&& (tm°< 
MEMORY_NUM_TYPES
) )

159 
mŒr_•©_tbl
[
i
][
tmp
] = 
j
;

163 
	`mem£t
(&
·t_’Œy_tbl
, 
INVALID_MEM_TYPE
,

164 
PAT_TYPE_NUMS
 * (
·t_’Œy_tbl
[0]));

165  
i
 = 0; i < 
PAT_TYPE_NUMS
; i++ )

167  
j
 = 0; j < 
PAT_TYPE_NUMS
; j++ )

169 iàĞ
	`·t_ü_2_·f
(
ho¡_·t
, 
j
è=ğ
i
 )

171 
·t_’Œy_tbl
[
i
] = 
j
;

177 
phys_addr
 = 36;

178 iàĞ
	`ıuid_—x
(0x80000000) >= 0x80000008 )

179 
phys_addr
 = (
ušt8_t
)
	`ıuid_—x
(0x80000008);

181 
size_Ü_mask
 = ~((1 << (
phys_addr
 - 
PAGE_SHIFT
)) - 1);

184 
	}
}

185 
__š™ÿÎ
(
hvm_mŒr_·t_š™
);

187 
ušt8_t
 
	$·t_ty³_2_±e_æags
(
ušt8_t
 
·t_ty³
)

189 
št32_t
 
·t_’Œy
 = 
·t_’Œy_tbl
[
·t_ty³
];

195 iàĞ
	`lik–y
(
·t_’Œy
 !ğ
INVALID_MEM_TYPE
) )

196  
·t_’Œy_2_±e_æags
[
·t_’Œy
];

198  
·t_’Œy_2_±e_æags
[
·t_’Œy_tbl
[
PAT_TYPE_UNCACHABLE
]];

199 
	}
}

201 
	$hvm_vıu_ÿch—‰r_š™
(
vıu
 *
v
)

203 
mŒr_¡©e
 *
m
 = &
v
->
¬ch
.
hvm_vıu
.
mŒr
;

205 
	`mem£t
(
m
, 0, (*m));

207 
m
->
v¬_¿nges
 = 
	`xm®loc_¬¿y
(
mŒr_v¬_¿nge
, 
MTRR_VCNT
);

208 iàĞ
m
->
v¬_¿nges
 =ğ
NULL
 )

209  -
ENOMEM
;

210 
	`mem£t
(
m
->
v¬_¿nges
, 0, 
MTRR_VCNT
 * (
mŒr_v¬_¿nge
));

212 
m
->
mŒr_ÿp
 = (1u << 10è| (1u << 8è| 
MTRR_VCNT
;

214 
v
->
¬ch
.
hvm_vıu
.
·t_ü
 =

215 ((
ušt64_t
)
PAT_TYPE_WRBACK
) |

216 ((
ušt64_t
)
PAT_TYPE_WRTHROUGH
 << 8) |

217 ((
ušt64_t
)
PAT_TYPE_UC_MINUS
 << 16) |

218 ((
ušt64_t
)
PAT_TYPE_UNCACHABLE
 << 24) |

219 ((
ušt64_t
)
PAT_TYPE_WRBACK
 << 32) |

220 ((
ušt64_t
)
PAT_TYPE_WRTHROUGH
 << 40) |

221 ((
ušt64_t
)
PAT_TYPE_UC_MINUS
 << 48) |

222 ((
ušt64_t
)
PAT_TYPE_UNCACHABLE
 << 56);

225 
	}
}

227 
	$hvm_vıu_ÿch—‰r_de¡roy
(
vıu
 *
v
)

229 
	`xä“
(
v
->
¬ch
.
hvm_vıu
.
mŒr
.
v¬_¿nges
);

230 
	}
}

235 
ušt8_t
 
	$g‘_mŒr_ty³
(
mŒr_¡©e
 *
m
, 
·ddr_t
 
·
)

237 
št32_t
 
addr
, 
£g
, 
šdex
;

238 
ušt8_t
 
ov”Ïp_mŒr
 = 0;

239 
ušt8_t
 
ov”Ïp_mŒr_pos
 = 0;

240 
ušt64_t
 
phys_ba£
;

241 
ušt64_t
 
phys_mask
;

242 
ušt8_t
 
num_v¬_¿nges
 = 
m
->
mŒr_ÿp
 & 0xff;

244 iàĞ
	`uÆik–y
(!(
m
->
’abËd
 & 0x2)) )

245  
MTRR_TYPE_UNCACHABLE
;

247 iàĞ(
·
 < 0x100000è&& (
m
->
’abËd
 & 1) )

250 
addr
 = (
ušt32_t
è
·
;

251 iàĞ
addr
 < 0x80000 )

253 
£g
 = (
addr
 >> 16);

254  
m
->
fixed_¿nges
[
£g
];

256 iàĞ
addr
 < 0xc0000 )

258 
£g
 = (
addr
 - 0x80000) >> 14;

259 
šdex
 = (
£g
 >> 3) + 1;

260 
£g
 &= 7;

261  
m
->
fixed_¿nges
[
šdex
*8 + 
£g
];

266 
£g
 = (
addr
 - 0xc0000) >> 12;

267 
šdex
 = (
£g
 >> 3) + 3;

268 
£g
 &= 7;

269  
m
->
fixed_¿nges
[
šdex
*8 + 
£g
];

274  
£g
 = 0; seg < 
num_v¬_¿nges
; seg++ )

276 
phys_ba£
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
£g
*2];

277 
phys_mask
 = ((
ušt64_t
*)
m
->
v¬_¿nges
)[
£g
*2 + 1];

278 iàĞ
phys_mask
 & (1 << 
MTRR_PHYSMASK_VALID_BIT
) )

280 iàĞ((
ušt64_t
è
·
 & 
phys_mask
è>> 
MTRR_PHYSMASK_SHIFT
 ==

281 (
phys_ba£
 & 
phys_mask
è>> 
MTRR_PHYSMASK_SHIFT
 )

283 iàĞ
	`uÆik–y
(
m
->
ov”Ïµed
) )

285 
ov”Ïp_mŒr
 |ğ1 << (
phys_ba£
 & 
MTRR_PHYSBASE_TYPE_MASK
);

286 
ov”Ïp_mŒr_pos
 = 
phys_ba£
 & 
MTRR_PHYSBASE_TYPE_MASK
;

291  (
phys_ba£
 & 
MTRR_PHYSBASE_TYPE_MASK
);

298 iàĞ
	`uÆik–y
(
ov”Ïp_mŒr
 == 0) )

299  
m
->
def_ty³
;

301 iàĞ
	`lik–y
(!(
ov”Ïp_mŒr
 & ~Ğ((
ušt8_t
)1è<< 
ov”Ïp_mŒr_pos
 ))) )

305  
ov”Ïp_mŒr_pos
;

307 iàĞ
ov”Ïp_mŒr
 & 0x1 )

309  
MTRR_TYPE_UNCACHABLE
;

311 iàĞ!(
ov”Ïp_mŒr
 & 0xaf) )

313  
MTRR_TYPE_WRTHROUGH
;

316  
ov”Ïp_mŒr_pos
;

317 
	}
}

324 
ušt8_t
 
	$·ge_·t_ty³
(
ušt64_t
 
·t_ü
, 
ušt32_t
 
±e_æags
)

326 
št32_t
 
·t_’Œy
;

329 
·t_’Œy
 = ( 
±e_æags
 >> 3 ) & 0x3;

331 iàĞ
±e_æags
 & 
_PAGE_PAT
 )

332 
·t_’Œy
 |= 4;

334  (
ušt8_t
)
	`·t_ü_2_·f
(
·t_ü
, 
·t_’Œy
);

335 
	}
}

340 
ušt8_t
 
	$efãùive_mm_ty³
(
mŒr_¡©e
 *
m
,

341 
ušt64_t
 
·t
,

342 
·ddr_t
 
g·
,

343 
ušt32_t
 
±e_æags
,

344 
ušt8_t
 
gmŒr_mty³
)

346 
ušt8_t
 
mŒr_mty³
, 
·t_v®ue
, 
efãùive
;

351 iàĞ
gmŒr_mty³
 =ğ
NO_HARDCODE_MEM_TYPE
 )

352 
mŒr_mty³
 = 
	`g‘_mŒr_ty³
(
m
, 
g·
);

354 
mŒr_mty³
 = 
gmŒr_mty³
;

356 
·t_v®ue
 = 
	`·ge_·t_ty³
(
·t
, 
±e_æags
);

358 
efãùive
 = 
mm_ty³_tbl
[
mŒr_mty³
][
·t_v®ue
];

360  
efãùive
;

361 
	}
}

363 
ušt32_t
 
	$g‘_·t_æags
(
vıu
 *
v
,

364 
ušt32_t
 
gl1e_æags
,

365 
·ddr_t
 
g·ddr
,

366 
·ddr_t
 
¥addr
,

367 
ušt8_t
 
gmŒr_mty³
)

369 
ušt8_t
 
gue¡_eff_mm_ty³
;

370 
ušt8_t
 
shadow_mŒr_ty³
;

371 
ušt8_t
 
·t_’Œy_v®ue
;

372 
ušt64_t
 
·t
 = 
v
->
¬ch
.
hvm_vıu
.
·t_ü
;

373 
mŒr_¡©e
 *
g
 = &
v
->
¬ch
.
hvm_vıu
.
mŒr
;

378 
gue¡_eff_mm_ty³
 = 
	`efãùive_mm_ty³
(
g
, 
·t
, 
g·ddr
,

379 
gl1e_æags
, 
gmŒr_mty³
);

381 
shadow_mŒr_ty³
 = 
	`g‘_mŒr_ty³
(&
mŒr_¡©e
, 
¥addr
);

386 
·t_’Œy_v®ue
 = 
mŒr_•©_tbl
[
shadow_mŒr_ty³
][
gue¡_eff_mm_ty³
];

391 iàĞ
·t_’Œy_v®ue
 =ğ
INVALID_MEM_TYPE
 )

393 
domaš
 *
d
 = 
v
->domain;

394 
p2m_ty³_t
 
p2mt
;

395 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
d
), 
	`·ddr_to_pâ
(
g·ddr
), &
p2mt
);

396 ià(
	`p2m_is_¿m
(
p2mt
))

397 
	`gd´štk
(
XENLOG_WARNING
,

399 "© %"
PRIx64
" (theƒffective mmype:%d), "

401 
gl1e_æags
, (
ušt64_t
)
g·ddr
, 
gue¡_eff_mm_ty³
,

402 
shadow_mŒr_ty³
);

403 
·t_’Œy_v®ue
 = 
PAT_TYPE_UNCACHABLE
;

406  
	`·t_ty³_2_±e_æags
(
·t_’Œy_v®ue
);

407 
	}
}

410 
boŞ_t
 
	$·t_m¤_£t
(
ušt64_t
 *
·t
, ušt64_ˆ
m¤_cÚ‹Á
)

412 
ušt8_t
 *
v®ue
 = (ušt8_t*)&
m¤_cÚ‹Á
;

413 
št32_t
 
i
;

415 iàĞ*
·t
 !ğ
m¤_cÚ‹Á
 )

417  
i
 = 0; i < 8; i++ )

418 iàĞ
	`uÆik–y
(!(
v®ue
[
i
] == 0 || value[i] == 1 ||

419 
v®ue
[
i
] == 4 || value[i] == 5 ||

420 
v®ue
[
i
] == 6 || value[i] == 7)) )

423 *
·t
 = 
m¤_cÚ‹Á
;

427 
	}
}

429 
boŞ_t
 
	$mŒr_def_ty³_m¤_£t
(
mŒr_¡©e
 *
m
, 
ušt64_t
 
m¤_cÚ‹Á
)

431 
ušt8_t
 
def_ty³
 = 
m¤_cÚ‹Á
 & 0xff;

432 
ušt8_t
 
’abËd
 = (
m¤_cÚ‹Á
 >> 10) & 0x3;

434 iàĞ
	`uÆik–y
(!(
def_ty³
 == 0 || def_type == 1 || def_type == 4 ||

435 
def_ty³
 == 5 || def_type == 6)) )

437 
	`HVM_DBG_LOG
(
DBG_LEVEL_MSR
, "šv®id MTRR deàty³:%x\n", 
def_ty³
);

441 iàĞ
	`uÆik–y
(
m¤_cÚ‹Á
 && (msr_content & ~0xcffUL)) )

443 
	`HVM_DBG_LOG
(
DBG_LEVEL_MSR
, "šv®id m¤ cÚ‹Á:%"
PRIx64
"\n",

444 
m¤_cÚ‹Á
);

448 
m
->
’abËd
 =ƒnabled;

449 
m
->
def_ty³
 = def_type;

452 
	}
}

454 
boŞ_t
 
	$mŒr_fix_¿nge_m¤_£t
(
mŒr_¡©e
 *
m
, 
ušt32_t
 
row
,

455 
ušt64_t
 
m¤_cÚ‹Á
)

457 
ušt64_t
 *
fixed_¿nge_ba£
 = (ušt64_ˆ*)
m
->
fixed_¿nges
;

459 iàĞ
fixed_¿nge_ba£
[
row
] !ğ
m¤_cÚ‹Á
 )

461 
ušt8_t
 *
¿nge
 = (ušt8_t*)&
m¤_cÚ‹Á
;

462 
št32_t
 
i
, 
ty³
;

464  
i
 = 0; i < 8; i++ )

466 
ty³
 = 
¿nge
[
i
];

467 iàĞ
	`uÆik–y
(!(
ty³
 == 0 ||ype == 1 ||

468 
ty³
 == 4 ||ype == 5 ||ype == 6)) )

472 
fixed_¿nge_ba£
[
row
] = 
m¤_cÚ‹Á
;

476 
	}
}

478 
boŞ_t
 
	$mŒr_v¬_¿nge_m¤_£t
(

479 
domaš
 *
d
, 
mŒr_¡©e
 *
m
, 
ušt32_t
 
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

481 
ušt32_t
 
šdex
, 
ty³
, 
phys_addr
, 
—x
, 
ebx
, 
ecx
, 
edx
;

482 
ušt64_t
 
m¤_mask
;

483 
ušt64_t
 *
v¬_¿nge_ba£
 = (ušt64_t*)
m
->
v¬_¿nges
;

485 
šdex
 = 
m¤
 - 
MSR_IA32_MTRR_PHYSBASE0
;

486 iàĞ
v¬_¿nge_ba£
[
šdex
] =ğ
m¤_cÚ‹Á
 )

489 
ty³
 = (
ušt8_t
)
m¤_cÚ‹Á
;

490 iàĞ
	`uÆik–y
(!(
ty³
 == 0 ||ype == 1 ||

491 
ty³
 == 4 ||ype == 5 ||ype == 6)) )

494 
phys_addr
 = 36;

495 
	`domaš_ıuid
(
d
, 0x80000000, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

496 iàĞ
—x
 >= 0x80000008 )

498 
	`domaš_ıuid
(
d
, 0x80000008, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

499 
phys_addr
 = (
ušt8_t
)
—x
;

501 
m¤_mask
 = ~((((
ušt64_t
)1è<< 
phys_addr
) - 1);

502 
m¤_mask
 |ğ(
šdex
 & 1) ? 0x7ffUL : 0xf00UL;

503 iàĞ
	`uÆik–y
(
m¤_cÚ‹Á
 && (m¤_cÚ‹Á & 
m¤_mask
)) )

505 
	`HVM_DBG_LOG
(
DBG_LEVEL_MSR
, "šv®id m¤ cÚ‹Á:%"
PRIx64
"\n",

506 
m¤_cÚ‹Á
);

510 
v¬_¿nge_ba£
[
šdex
] = 
m¤_cÚ‹Á
;

512 
m
->
ov”Ïµed
 = 
	`is_v¬_mŒr_ov”Ïµed
(m);

515 
	}
}

517 
boŞ_t
 
	$mŒr_·t_nÙ_equ®
(
vıu
 *
vd
, vıu *
vs
)

519 
mŒr_¡©e
 *
md
 = &
vd
->
¬ch
.
hvm_vıu
.
mŒr
;

520 
mŒr_¡©e
 *
ms
 = &
vs
->
¬ch
.
hvm_vıu
.
mŒr
;

521 
št32_t
 
»s
;

522 
ušt8_t
 
num_v¬_¿nges
 = (ušt8_t)
md
->
mŒr_ÿp
;

525 
»s
 = 
	`memcmp
(
md
->
fixed_¿nges
, 
ms
->fixed_ranges,

526 
NUM_FIXED_RANGES
*(
mŒr_ty³
));

527 iàĞ
»s
 )

531 
»s
 = 
	`memcmp
(
md
->
v¬_¿nges
, 
ms
->var_ranges,

532 
num_v¬_¿nges
*(
mŒr_v¬_¿nge
));

533 iàĞ
»s
 )

537 iàĞ(
md
->
def_ty³
 !ğ
ms
->def_type)

538 && (
md
->
’abËd
 !ğ
ms
->enabled) )

542 iàĞ
vd
->
¬ch
.
hvm_vıu
.
·t_ü
 !ğ
vs
->arch.hvm_vcpu.pat_cr )

546 
	}
}

548 
	$hvm_š™_ÿch—‰r_»giÚ_li¡
(

549 
domaš
 *
d
)

551 
	`INIT_LIST_HEAD
(&
d
->
¬ch
.
hvm_domaš
.
pšÃd_ÿch—‰r_¿nges
);

552 
	}
}

554 
	$hvm_de¡roy_ÿch—‰r_»giÚ_li¡
(

555 
domaš
 *
d
)

557 
li¡_h—d
 *
h—d
 = &
d
->
¬ch
.
hvm_domaš
.
pšÃd_ÿch—‰r_¿nges
;

558 
hvm_mem_pšÃd_ÿch—‰r_¿nge
 *
¿nge
;

560  !
	`li¡_em±y
(
h—d
) )

562 
¿nge
 = 
	`li¡_’Œy
(
h—d
->
Ãxt
,

563 
hvm_mem_pšÃd_ÿch—‰r_¿nge
,

564 
li¡
);

565 
	`li¡_d–
(&
¿nge
->
li¡
);

566 
	`xä“
(
¿nge
);

568 
	}
}

570 
št32_t
 
	$hvm_g‘_mem_pšÃd_ÿch—‰r
(

571 
domaš
 *
d
,

572 
ušt64_t
 
gue¡_â
,

573 
ušt32_t
 *
ty³
)

575 
hvm_mem_pšÃd_ÿch—‰r_¿nge
 *
¿nge
;

577 *
ty³
 = 0;

579 iàĞ!
	`is_hvm_domaš
(
d
) )

582 
	`li¡_fÜ_—ch_’Œy_rcu
 ( 
¿nge
,

583 &
d
->
¬ch
.
hvm_domaš
.
pšÃd_ÿch—‰r_¿nges
,

584 
li¡
 )

586 iàĞ(
gue¡_â
 >ğ
¿nge
->
¡¬t
è&& (gue¡_â <ğ¿nge->
’d
) )

588 *
ty³
 = 
¿nge
->type;

594 
	}
}

596 
št32_t
 
	$hvm_£t_mem_pšÃd_ÿch—‰r
(

597 
domaš
 *
d
,

598 
ušt64_t
 
gâ_¡¬t
,

599 
ušt64_t
 
gâ_’d
,

600 
ušt32_t
 
ty³
)

602 
hvm_mem_pšÃd_ÿch—‰r_¿nge
 *
¿nge
;

604 iàĞ!((
ty³
 =ğ
PAT_TYPE_UNCACHABLE
) ||

605 (
ty³
 =ğ
PAT_TYPE_WRCOMB
) ||

606 (
ty³
 =ğ
PAT_TYPE_WRTHROUGH
) ||

607 (
ty³
 =ğ
PAT_TYPE_WRPROT
) ||

608 (
ty³
 =ğ
PAT_TYPE_WRBACK
) ||

609 (
ty³
 =ğ
PAT_TYPE_UC_MINUS
)) ||

610 !
	`is_hvm_domaš
(
d
) )

611  -
EINVAL
;

613 
¿nge
 = 
	`xm®loc
(
hvm_mem_pšÃd_ÿch—‰r_¿nge
);

614 iàĞ
¿nge
 =ğ
NULL
 )

615  -
ENOMEM
;

617 
	`mem£t
(
¿nge
, 0, (*range));

619 
¿nge
->
¡¬t
 = 
gâ_¡¬t
;

620 
¿nge
->
’d
 = 
gâ_’d
;

621 
¿nge
->
ty³
 =ype;

623 
	`li¡_add_rcu
(&
¿nge
->
li¡
, &
d
->
¬ch
.
hvm_domaš
.
pšÃd_ÿch—‰r_¿nges
);

626 
	}
}

628 
	$hvm_§ve_mŒr_m¤
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

630 
i
;

631 
vıu
 *
v
;

632 
hvm_hw_mŒr
 
hw_mŒr
;

633 
mŒr_¡©e
 *mtrr_state;

635 
	`fÜ_—ch_vıu
(
d
, 
v
)

637 
mŒr_¡©e
 = &
v
->
¬ch
.
hvm_vıu
.
mŒr
;

639 
hw_mŒr
.
m¤_·t_ü
 = 
v
->
¬ch
.
hvm_vıu
.
·t_ü
;

641 
hw_mŒr
.
m¤_mŒr_def_ty³
 = 
mŒr_¡©e
->
def_ty³


642 | (
mŒr_¡©e
->
’abËd
 << 10);

643 
hw_mŒr
.
m¤_mŒr_ÿp
 = 
mŒr_¡©e
->
mŒr_ÿp
;

645  
i
 = 0; i < 
MTRR_VCNT
; i++ )

648 
hw_mŒr
.
m¤_mŒr_v¬
[
i
*2] =

649 ((
ušt64_t
*)
mŒr_¡©e
->
v¬_¿nges
)[
i
*2];

651 
hw_mŒr
.
m¤_mŒr_v¬
[
i
*2+1] =

652 ((
ušt64_t
*)
mŒr_¡©e
->
v¬_¿nges
)[
i
*2+1];

655  
i
 = 0; i < 
NUM_FIXED_MSR
; i++ )

656 
hw_mŒr
.
m¤_mŒr_fixed
[
i
] =

657 ((
ušt64_t
*)
mŒr_¡©e
->
fixed_¿nges
)[
i
];

659 iàĞ
	`hvm_§ve_’Œy
(
MTRR
, 
v
->
vıu_id
, 
h
, &
hw_mŒr
) != 0 )

663 
	}
}

665 
	$hvm_lßd_mŒr_m¤
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

667 
vıuid
, 
i
;

668 
vıu
 *
v
;

669 
mŒr_¡©e
 *mtrr_state;

670 
hvm_hw_mŒr
 
hw_mŒr
;

672 
vıuid
 = 
	`hvm_lßd_š¡ªû
(
h
);

673 iàĞ
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[vıuid]è=ğ
NULL
 )

675 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: domaš ha nØvıu %u\n", 
vıuid
);

676  -
EINVAL
;

679 iàĞ
	`hvm_lßd_’Œy
(
MTRR
, 
h
, &
hw_mŒr
) != 0 )

680  -
EINVAL
;

682 
mŒr_¡©e
 = &
v
->
¬ch
.
hvm_vıu
.
mŒr
;

684 
	`·t_m¤_£t
(&
v
->
¬ch
.
hvm_vıu
.
·t_ü
, 
hw_mŒr
.
m¤_·t_ü
);

686 
mŒr_¡©e
->
mŒr_ÿp
 = 
hw_mŒr
.
m¤_mŒr_ÿp
;

688  
i
 = 0; i < 
NUM_FIXED_MSR
; i++ )

689 
	`mŒr_fix_¿nge_m¤_£t
(
mŒr_¡©e
, 
i
, 
hw_mŒr
.
m¤_mŒr_fixed
[i]);

691  
i
 = 0; i < 
MTRR_VCNT
; i++ )

693 
	`mŒr_v¬_¿nge_m¤_£t
(
d
, 
mŒr_¡©e
,

694 
	`MTRRphysBa£_MSR
(
i
), 
hw_mŒr
.
m¤_mŒr_v¬
[i*2]);

695 
	`mŒr_v¬_¿nge_m¤_£t
(
d
, 
mŒr_¡©e
,

696 
	`MTRRphysMask_MSR
(
i
), 
hw_mŒr
.
m¤_mŒr_v¬
[i*2+1]);

699 
	`mŒr_def_ty³_m¤_£t
(
mŒr_¡©e
, 
hw_mŒr
.
m¤_mŒr_def_ty³
);

702 
	}
}

704 
HVM_REGISTER_SAVE_RESTORE
(
MTRR
, 
hvm_§ve_mŒr_m¤
, 
hvm_lßd_mŒr_m¤
,

705 1, 
HVMSR_PER_VCPU
);

707 
ušt8_t
 
	$•‹_g‘_’Œy_emt
(
domaš
 *
d
, 
gâ
, 
mâ_t
 
mâ
,

708 
ušt8_t
 *
©
, 
boŞ_t
 
dœeù_mmio
)

710 
ušt8_t
 
gmŒr_mty³
, 
hmŒr_mty³
;

711 
ušt32_t
 
ty³
;

712 
vıu
 *
v
 = 
cu¼’t
;

714 *
©
 = 0;

716 iàĞ(
cu¼’t
->
domaš
 !ğ
d
) &&

717 ((
d
->
vıu
 =ğ
NULL
è|| ((
v
 = d->vcpu[0]) == NULL)) )

718  
MTRR_TYPE_WRBACK
;

720 iàĞ!
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_IDENT_PT
] )

721  
MTRR_TYPE_WRBACK
;

723 iàĞ(
v
 =ğ
cu¼’t
è&& v->
domaš
->
¬ch
.
hvm_domaš
.
is_š_uc_mode
 )

724  
MTRR_TYPE_UNCACHABLE
;

726 iàĞ!
	`mâ_v®id
(
	`mâ_x
(
mâ
)) )

727  
MTRR_TYPE_UNCACHABLE
;

729 iàĞ
	`hvm_g‘_mem_pšÃd_ÿch—‰r
(
d
, 
gâ
, &
ty³
) )

730  
ty³
;

732 iàĞ!
iommu_’abËd
 )

734 *
©
 = 1;

735  
MTRR_TYPE_WRBACK
;

738 iàĞ
dœeù_mmio
 )

739  
MTRR_TYPE_UNCACHABLE
;

741 iàĞ
iommu_¢oİ
 )

743 *
©
 = 1;

744  
MTRR_TYPE_WRBACK
;

747 
gmŒr_mty³
 = 
	`g‘_mŒr_ty³
(&
v
->
¬ch
.
hvm_vıu
.
mŒr
, (
gâ
 << 
PAGE_SHIFT
));

748 
hmŒr_mty³
 = 
	`g‘_mŒr_ty³
(&
mŒr_¡©e
, (
	`mâ_x
(
mâ
è<< 
PAGE_SHIFT
));

749  ((
gmŒr_mty³
 <ğ
hmŒr_mty³
) ? gmtrr_mtype : hmtrr_mtype);

750 
	}
}

	@hvm/pmtimer.c

21 
	~<asm/hvm/v±.h
>

22 
	~<asm/hvm/io.h
>

23 
	~<asm/hvm/suµÜt.h
>

24 
	~<asm/aıi.h
>

25 
	~<public/hvm/·¿ms.h
>

28 
	#PM1a_STS_ADDR_V0
 (
ACPI_PM1A_EVT_BLK_ADDRESS_V0
)

	)

29 
	#PM1a_EN_ADDR_V0
 (
ACPI_PM1A_EVT_BLK_ADDRESS_V0
 + 2)

	)

30 
	#TMR_VAL_ADDR_V0
 (
ACPI_PM_TMR_BLK_ADDRESS_V0
)

	)

31 
	#PM1a_STS_ADDR_V1
 (
ACPI_PM1A_EVT_BLK_ADDRESS_V1
)

	)

32 
	#PM1a_EN_ADDR_V1
 (
ACPI_PM1A_EVT_BLK_ADDRESS_V1
 + 2)

	)

33 
	#TMR_VAL_ADDR_V1
 (
ACPI_PM_TMR_BLK_ADDRESS_V1
)

	)

36 
	#TMR_STS
 (1 << 0)

	)

37 
	#GBL_STS
 (1 << 5)

	)

38 
	#PWRBTN_STS
 (1 << 8)

	)

39 
	#SLPBTN_STS
 (1 << 9)

	)

42 
	#TMR_EN
 (1 << 0)

	)

43 
	#GBL_EN
 (1 << 5)

	)

44 
	#PWRBTN_EN
 (1 << 8)

	)

45 
	#SLPBTN_EN
 (1 << 9)

	)

48 
	#SCI_MASK
 (
TMR_STS
|
PWRBTN_STS
|
SLPBTN_STS
|
GBL_STS
)

	)

51 
	#SCI_IRQ
 9

	)

54 
	#TMR_VAL_MASK
 (0xffffffff)

	)

55 
	#TMR_VAL_MSB
 (0x80000000)

	)

58 
	$pmt_upd©e_sci
(
PMTS‹
 *
s
)

60 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

62 iàĞ
s
->
pm
.
pm1a_’
 & s->pm.
pm1a_¡s
 & 
SCI_MASK
 )

63 
	`hvm_i§_œq_as£¹
(
s
->
vıu
->
domaš
, 
SCI_IRQ
);

65 
	`hvm_i§_œq_d—s£¹
(
s
->
vıu
->
domaš
, 
SCI_IRQ
);

66 
	}
}

68 
	$hvm_aıi_pow”_bu‰Ú
(
domaš
 *
d
)

70 
PMTS‹
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

71 
	`¥š_lock
(&
s
->
lock
);

72 
s
->
pm
.
pm1a_¡s
 |ğ
PWRBTN_STS
;

73 
	`pmt_upd©e_sci
(
s
);

74 
	`¥š_uÆock
(&
s
->
lock
);

75 
	}
}

77 
	$hvm_aıi_¦“p_bu‰Ú
(
domaš
 *
d
)

79 
PMTS‹
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

80 
	`¥š_lock
(&
s
->
lock
);

81 
s
->
pm
.
pm1a_¡s
 |ğ
SLPBTN_STS
;

82 
	`pmt_upd©e_sci
(
s
);

83 
	`¥š_uÆock
(&
s
->
lock
);

84 
	}
}

88 
	$pmt_upd©e_time
(
PMTS‹
 *
s
)

90 
ušt64_t
 
cu¼_gtime
, 
tmp
;

91 
ušt32_t
 
tmr_v®
 = 
s
->
pm
.tmr_v®, 
msb
 =mr_v® & 
TMR_VAL_MSB
;

93 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

96 
cu¼_gtime
 = 
	`hvm_g‘_gue¡_time
(
s
->
vıu
);

97 
tmp
 = ((
cu¼_gtime
 - 
s
->
Ï¡_gtime
è* s->
sÿË
è+ s->
nÙ_accouÁed
;

98 
s
->
nÙ_accouÁed
 = (
ušt32_t
)
tmp
;

99 
tmr_v®
 +ğ
tmp
 >> 32;

100 
tmr_v®
 &ğ
TMR_VAL_MASK
;

101 
s
->
Ï¡_gtime
 = 
cu¼_gtime
;

104 *(vŞ©
ušt32_t
 *)&
s
->
pm
.
tmr_v®
 =mr_val;

107 iàĞ(
tmr_v®
 & 
TMR_VAL_MSB
è!ğ
msb
 )

109 
s
->
pm
.
pm1a_¡s
 |ğ
TMR_STS
;

110 
	`pmt_upd©e_sci
(
s
);

112 
	}
}

117 
	$pmt_tim”_ÿÎback
(*
İaque
)

119 
PMTS‹
 *
s
 = 
İaque
;

120 
ušt32_t
 
pmt_cyşes_uÁ_æ
;

121 
ušt64_t
 
time_uÁ_æ
;

123 
	`¥š_lock
(&
s
->
lock
);

126 
	`pmt_upd©e_time
(
s
);

129 
pmt_cyşes_uÁ_æ
 = 
TMR_VAL_MSB
 - (
s
->
pm
.
tmr_v®
 & (TMR_VAL_MSB - 1));

132 
time_uÁ_æ
 = (1000000000ULL << 23è/ 
FREQUENCE_PMTIMER
;

135 
time_uÁ_æ
 = (time_uÁ_æ * 
pmt_cyşes_uÁ_æ
) >> 23;

138 
	`£t_tim”
(&
s
->
tim”
, 
	`NOW
(è+ 
time_uÁ_æ
 + 
	`MILLISECS
(1));

140 
	`¥š_uÆock
(&
s
->
lock
);

141 
	}
}

144 
	$hªdË_evt_io
(

145 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

147 
vıu
 *
v
 = 
cu¼’t
;

148 
PMTS‹
 *
s
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

149 
ušt32_t
 
addr
, 
d©a
, 
by‹
;

150 
i
;

152 
addr
 = 
pÜt
 -

153 ((
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[

154 
HVM_PARAM_ACPI_IOPORTS_LOCATION
] == 0) ?

155 
PM1a_STS_ADDR_V0
 : 
PM1a_STS_ADDR_V1
);

157 
	`¥š_lock
(&
s
->
lock
);

159 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

162  
i
 = 
by‹s
, 
d©a
 = *
v®
;

163 
i
 > 0;

164 
i
--, 
addr
++, 
d©a
 >>= 8 )

166 
by‹
 = 
d©a
 & 0xff;

167  
addr
 )

171 
s
->
pm
.
pm1a_¡s
 &ğ~
by‹
;

174 
s
->
pm
.
pm1a_¡s
 &ğ~(
by‹
 << 8);

177 
s
->
pm
.
pm1a_’
 = (s->pm.pm1a_’ & 0xff00è| 
by‹
;

180 
s
->
pm
.
pm1a_’
 = (s->pm.pm1a_’ & 0xffè| (
by‹
 << 8);

183 
	`gd´štk
(
XENLOG_WARNING
,

185 
by‹s
, *
v®
, 
pÜt
);

189 
	`pmt_upd©e_sci
(
s
);

193 
d©a
 = 
s
->
pm
.
pm1a_¡s
 | (((
ušt32_t
ès->pm.
pm1a_’
) << 16);

194 
d©a
 >>ğ8 * 
addr
;

195 iàĞ
by‹s
 =ğ1 ) 
d©a
 &= 0xff;

196 iàĞ
by‹s
 =ğ2 ) 
d©a
 &= 0xffff;

197 *
v®
 = 
d©a
;

200 
	`¥š_uÆock
(&
s
->
lock
);

202  
X86EMUL_OKAY
;

203 
	}
}

207 
	$hªdË_pmt_io
(

208 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

210 
vıu
 *
v
 = 
cu¼’t
;

211 
PMTS‹
 *
s
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

213 iàĞ
by‹s
 != 4 )

215 
	`gd´štk
(
XENLOG_WARNING
, "HVM_PMT bad‡ccess\n");

216  
X86EMUL_OKAY
;

219 iàĞ
dœ
 =ğ
IOREQ_READ
 )

221 iàĞ
	`¥š_Œylock
(&
s
->
lock
) )

224 
	`pmt_upd©e_time
(
s
);

225 *
v®
 = 
s
->
pm
.
tmr_v®
;

226 
	`¥š_uÆock
(&
s
->
lock
);

235 
	`¥š_b¬r›r
(&
s
->
lock
);

236 *
v®
 = *(vŞ©
ušt32_t
 *)&
s
->
pm
.
tmr_v®
;

238  
X86EMUL_OKAY
;

241  
X86EMUL_UNHANDLEABLE
;

242 
	}
}

244 
	$pmtim”_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

246 
PMTS‹
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

247 
ušt32_t
 
x
, 
msb
 = 
s
->
pm
.
tmr_v®
 & 
TMR_VAL_MSB
;

248 
rc
;

250 
	`¥š_lock
(&
s
->
lock
);

255 
x
 = ((
s
->
vıu
->
¬ch
.
hvm_vıu
.
gue¡_time
 - s->
Ï¡_gtime
è* s->
sÿË
) >> 32;

256 iàĞ
x
 < 1UL<<31 )

257 
s
->
pm
.
tmr_v®
 +ğ
x
;

258 iàĞ(
s
->
pm
.
tmr_v®
 & 
TMR_VAL_MSB
è!ğ
msb
 )

259 
s
->
pm
.
pm1a_¡s
 |ğ
TMR_STS
;

263 
rc
 = 
	`hvm_§ve_’Œy
(
PMTIMER
, 0, 
h
, &
s
->
pm
);

265 
	`¥š_uÆock
(&
s
->
lock
);

267  
rc
;

268 
	}
}

270 
	$pmtim”_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

272 
PMTS‹
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

274 
	`¥š_lock
(&
s
->
lock
);

277 iàĞ
	`hvm_lßd_’Œy
(
PMTIMER
, 
h
, &
s
->
pm
) )

279 
	`¥š_uÆock
(&
s
->
lock
);

280  -
EINVAL
;

284 
s
->
Ï¡_gtime
 = 
	`hvm_g‘_gue¡_time
(s->
vıu
);

285 
s
->
nÙ_accouÁed
 = 0;

288 
	`pmt_upd©e_sci
(
s
);

290 
	`¥š_uÆock
(&
s
->
lock
);

293 
	}
}

295 
HVM_REGISTER_SAVE_RESTORE
(
PMTIMER
, 
pmtim”_§ve
, 
pmtim”_lßd
,

296 1, 
HVMSR_PER_DOM
);

298 
	$pmtim”_chªge_iİÜt
(
domaš
 *
d
, 
v”siÚ
)

300 
Şd_v”siÚ
;

303 
Şd_v”siÚ
 = 
d
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_ACPI_IOPORTS_LOCATION
];

304 iàĞ
v”siÚ
 =ğ
Şd_v”siÚ
 )

308 iàĞ(
v”siÚ
 ^ 
Şd_v”siÚ
) != 1 )

309  -
EINVAL
;

311 iàĞ
v”siÚ
 == 1 )

314 
	`»loÿ‹_pÜtio_hªdËr
(
d
, 
TMR_VAL_ADDR_V0
, 
TMR_VAL_ADDR_V1
, 4);

315 
	`»loÿ‹_pÜtio_hªdËr
(
d
, 
PM1a_STS_ADDR_V0
, 
PM1a_STS_ADDR_V1
, 4);

320 
	`»loÿ‹_pÜtio_hªdËr
(
d
, 
TMR_VAL_ADDR_V1
, 
TMR_VAL_ADDR_V0
, 4);

321 
	`»loÿ‹_pÜtio_hªdËr
(
d
, 
PM1a_STS_ADDR_V1
, 
PM1a_STS_ADDR_V0
, 4);

325 
	}
}

327 
	$pmtim”_š™
(
vıu
 *
v
)

329 
PMTS‹
 *
s
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

331 
	`¥š_lock_š™
(&
s
->
lock
);

333 
s
->
sÿË
 = ((
ušt64_t
)
FREQUENCE_PMTIMER
 << 32è/ 
SYSTEM_TIME_HZ
;

334 
s
->
nÙ_accouÁed
 = 0;

335 
s
->
vıu
 = 
v
;

339 
	`»gi¡”_pÜtio_hªdËr
(
v
->
domaš
, 
TMR_VAL_ADDR_V0
, 4, 
hªdË_pmt_io
);

340 
	`»gi¡”_pÜtio_hªdËr
(
v
->
domaš
, 
PM1a_STS_ADDR_V0
, 4, 
hªdË_evt_io
);

343 
	`š™_tim”
(&
s
->
tim”
, 
pmt_tim”_ÿÎback
, s, 
v
->
´oûssÜ
);

344 
	`pmt_tim”_ÿÎback
(
s
);

345 
	}
}

348 
	$pmtim”_deš™
(
domaš
 *
d
)

350 
PMTS‹
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
;

351 
	`kl_tim”
(&
s
->
tim”
);

352 
	}
}

354 
	$pmtim”_»£t
(
domaš
 *
d
)

357 
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vpmt
.
pm
.
tmr_v®
 = 0;

358 
	}
}

	@hvm/quirks.c

18 
	~<x’/cÚfig.h
>

19 
	~<x’/ty³s.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/lib.h
>

22 
	~<x’/dmi.h
>

23 
	~<x’/b™m­.h
>

24 
	~<asm/hvm/suµÜt.h
>

26 
s8
 
__»ad_mo¡ly
 
	ghvm_pÜt80_®lowed
 = -1;

27 
boŞ—n_·¿m
("hvm_pÜt80", 
hvm_pÜt80_®lowed
);

29 
__š™
 
	$dmi_hvm_d’y_pÜt80
Ğ
dmi_sy¡em_id
 *
id
)

31 
	`´štk
(
XENLOG_WARNING
 "%s:…ort 0x80‡ccess %s‡llowed for HVM guests\n",

32 
id
->
id’t
, 
hvm_pÜt80_®lowed
 > 0 ? "forcibly" : "not");

34 iàĞ
hvm_pÜt80_®lowed
 < 0 )

35 
hvm_pÜt80_®lowed
 = 0;

38 
	}
}

40 
__š™
 
	$check_pÜt80
()

46 
dmi_sy¡em_id
 
__š™d©a
 
hvm_no_pÜt80_dmi_bË
[] =

49 .
ÿÎback
 = 
dmi_hvm_d’y_pÜt80
,

50 .
id’t
 = "Compaq Presario V6000",

51 .
m©ches
 = {

52 
	`DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

53 
	`DMI_MATCH
(
DMI_BOARD_NAME
, "30B7")

57 .
ÿÎback
 = 
dmi_hvm_d’y_pÜt80
,

58 .
id’t
 = "HP Pavilion dv9000z",

59 .
m©ches
 = {

60 
	`DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

61 
	`DMI_MATCH
(
DMI_BOARD_NAME
, "30B9")

65 .
ÿÎback
 = 
dmi_hvm_d’y_pÜt80
,

66 .
id’t
 = "HP Pavilion dv6000",

67 .
m©ches
 = {

68 
	`DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

69 
	`DMI_MATCH
(
DMI_BOARD_NAME
, "30B8")

73 .
ÿÎback
 = 
dmi_hvm_d’y_pÜt80
,

74 .
id’t
 = "HP Pavilionx1000",

75 .
m©ches
 = {

76 
	`DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

77 
	`DMI_MATCH
(
DMI_BOARD_NAME
, "30BF")

81 .
ÿÎback
 = 
dmi_hvm_d’y_pÜt80
,

82 .
id’t
 = "Presario F700",

83 .
m©ches
 = {

84 
	`DMI_MATCH
(
DMI_BOARD_VENDOR
, "Quanta"),

85 
	`DMI_MATCH
(
DMI_BOARD_NAME
, "30D3")

91 
	`dmi_check_sy¡em
(
hvm_no_pÜt80_dmi_bË
);

93 iàĞ!
hvm_pÜt80_®lowed
 )

94 
	`__£t_b™
(0x80, 
hvm_io_b™m­
);

97 
	}
}

98 
__š™ÿÎ
(
check_pÜt80
);

	@hvm/rtc.c

25 
	~<asm/mc146818¹c.h
>

26 
	~<asm/hvm/v±.h
>

27 
	~<asm/hvm/io.h
>

28 
	~<asm/hvm/suµÜt.h
>

29 
	~<asm/cu¼’t.h
>

31 
	#domaš_v¹c
(
x
è(&(x)->
¬ch
.
hvm_domaš
.
¶_time
.
v¹c
)

	)

32 
	#vıu_v¹c
(
x
è(
	`domaš_v¹c
((x)->
domaš
))

	)

33 
	#v¹c_domaš
(
x
è(
	`cÚš”_of
((x), 
domaš
, \

34 
¬ch
.
hvm_domaš
.
¶_time
.
v¹c
))

	)

35 
	#v¹c_vıu
(
x
è(
	`±_glob®_vıu_rg‘
(
	`v¹c_domaš
(x)))

	)

37 
	$¹c_³riodic_cb
(
vıu
 *
v
, *
İaque
)

39 
RTCS‹
 *
s
 = 
İaque
;

40 
	`¥š_lock
(&
s
->
lock
);

41 
s
->
hw
.
cmos_d©a
[
RTC_REG_C
] |= 0xc0;

42 
	`¥š_uÆock
(&
s
->
lock
);

43 
	}
}

47 
	$¹c_tim”_upd©e
(
RTCS‹
 *
s
)

49 
³riod_code
, 
³riod
;

50 
vıu
 *
v
 = 
	`v¹c_vıu
(
s
);

52 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

54 
³riod_code
 = 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] & 
RTC_RATE_SELECT
;

55 iàĞ(
³riod_code
 !ğ0è&& (
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_PIE
) )

57 iàĞ
³riod_code
 <= 2 )

58 
³riod_code
 += 7;

60 
³riod
 = 1 << (
³riod_code
 - 1);

61 
³riod
 = 
	`DIV_ROUND
((period * 1000000000ULL), 32768);

62 
	`ü—‹_³riodic_time
(
v
, &
s
->
±
, 
³riod
,…”iod, 
RTC_IRQ
,

63 
¹c_³riodic_cb
, 
s
);

67 
	`de¡roy_³riodic_time
(&
s
->
±
);

69 
	}
}

71 
¹c_£t_time
(
RTCS‹
 *
s
);

73 
	$¹c_iİÜt_wr™e
(*
İaque
, 
ušt32_t
 
addr
, ušt32_ˆ
d©a
)

75 
RTCS‹
 *
s
 = 
İaque
;

77 
	`¥š_lock
(&
s
->
lock
);

79 iàĞ(
addr
 & 1) == 0 )

81 
d©a
 &= 0x7f;

82 
s
->
hw
.
cmos_šdex
 = 
d©a
;

83 
	`¥š_uÆock
(&
s
->
lock
);

84  (
d©a
 < 
RTC_CMOS_SIZE
);

87 iàĞ
s
->
hw
.
cmos_šdex
 >ğ
RTC_CMOS_SIZE
 )

89 
	`¥š_uÆock
(&
s
->
lock
);

93  
s
->
hw
.
cmos_šdex
 )

95 
RTC_SECONDS_ALARM
:

96 
RTC_MINUTES_ALARM
:

97 
RTC_HOURS_ALARM
:

98 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
] = 
d©a
;

100 
RTC_SECONDS
:

101 
RTC_MINUTES
:

102 
RTC_HOURS
:

103 
RTC_DAY_OF_WEEK
:

104 
RTC_DAY_OF_MONTH
:

105 
RTC_MONTH
:

106 
RTC_YEAR
:

107 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
] = 
d©a
;

109 iàĞ!(
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_SET
) )

110 
	`¹c_£t_time
(
s
);

112 
RTC_REG_A
:

114 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] = (
d©a
 & ~
RTC_UIP
) |

115 (
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] & 
RTC_UIP
);

116 
	`¹c_tim”_upd©e
(
s
);

118 
RTC_REG_B
:

119 iàĞ
d©a
 & 
RTC_SET
 )

122 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] &ğ~
RTC_UIP
;

127 iàĞ
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_SET
 )

128 
	`¹c_£t_time
(
s
);

130 
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] = 
d©a
;

131 
	`¹c_tim”_upd©e
(
s
);

133 
RTC_REG_C
:

134 
RTC_REG_D
:

139 
	`¥š_uÆock
(&
s
->
lock
);

142 
	}
}

144 
šlše
 
	$to_bcd
(
RTCS‹
 *
s
, 
a
)

146 iàĞ
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 0x04 )

147  
a
;

149  ((
a
 / 10) << 4) | (a % 10);

150 
	}
}

152 
šlše
 
	$äom_bcd
(
RTCS‹
 *
s
, 
a
)

154 iàĞ
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 0x04 )

155  
a
;

157  ((
a
 >> 4) * 10) + (a & 0x0f);

158 
	}
}

160 
	$¹c_£t_time
(
RTCS‹
 *
s
)

162 
tm
 *tm = &
s
->
cu¼’t_tm
;

163 
domaš
 *
d
 = 
	`v¹c_domaš
(
s
);

164 
befÜe
, 
aá”
;

166 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

168 
befÜe
 = 
	`mktime
(
tm
->
tm_y—r
,m->
tm_mÚ
 + 1,m->
tm_mday
,

169 
tm
->
tm_hour
,m->
tm_mš
,m->
tm_£c
);

171 
tm
->
tm_£c
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_SECONDS
]);

172 
tm
->
tm_mš
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_MINUTES
]);

173 
tm
->
tm_hour
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_HOURS
] & 0x7f);

174 iàĞ!(
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 0x02) &&

175 (
s
->
hw
.
cmos_d©a
[
RTC_HOURS
] & 0x80) )

176 
tm
->
tm_hour
 += 12;

177 
tm
->
tm_wday
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_DAY_OF_WEEK
]);

178 
tm
->
tm_mday
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_DAY_OF_MONTH
]);

179 
tm
->
tm_mÚ
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_MONTH
]) - 1;

180 
tm
->
tm_y—r
 = 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_YEAR
]) + 100;

182 
aá”
 = 
	`mktime
(
tm
->
tm_y—r
,m->
tm_mÚ
 + 1,m->
tm_mday
,

183 
tm
->
tm_hour
,m->
tm_mš
,m->
tm_£c
);

187 
d
->
time_off£t_£cÚds
 +ğ(
aá”
 - 
befÜe
);

188 
	`upd©e_domaš_w®lşock_time
(
d
);

190 
	`£nd_timeoff£t_»q
(
aá”
 - 
befÜe
);

191 
	}
}

193 
	$¹c_cİy_d©e
(
RTCS‹
 *
s
)

195 cÚ¡ 
tm
 *tm = &
s
->
cu¼’t_tm
;

197 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

199 
s
->
hw
.
cmos_d©a
[
RTC_SECONDS
] = 
	`to_bcd
(s, 
tm
->
tm_£c
);

200 
s
->
hw
.
cmos_d©a
[
RTC_MINUTES
] = 
	`to_bcd
(s, 
tm
->
tm_mš
);

201 iàĞ
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_24H
 )

204 
s
->
hw
.
cmos_d©a
[
RTC_HOURS
] = 
	`to_bcd
(s, 
tm
->
tm_hour
);

209 
s
->
hw
.
cmos_d©a
[
RTC_HOURS
] = 
	`to_bcd
(s, 
tm
->
tm_hour
 % 12);

210 iàĞ
tm
->
tm_hour
 >= 12 )

211 
s
->
hw
.
cmos_d©a
[
RTC_HOURS
] |= 0x80;

213 
s
->
hw
.
cmos_d©a
[
RTC_DAY_OF_WEEK
] = 
	`to_bcd
(s, 
tm
->
tm_wday
);

214 
s
->
hw
.
cmos_d©a
[
RTC_DAY_OF_MONTH
] = 
	`to_bcd
(s, 
tm
->
tm_mday
);

215 
s
->
hw
.
cmos_d©a
[
RTC_MONTH
] = 
	`to_bcd
(s, 
tm
->
tm_mÚ
 + 1);

216 
s
->
hw
.
cmos_d©a
[
RTC_YEAR
] = 
	`to_bcd
(s, 
tm
->
tm_y—r
 % 100);

217 
	}
}

220 
	$g‘_days_š_mÚth
(
mÚth
, 
y—r
)

222 cÚ¡ 
days_b
[12] = {

225 
d
;

226 iàĞ()
mÚth
 >= 12 )

228 
d
 = 
days_b
[
mÚth
];

229 iàĞ
mÚth
 == 1 )

230 iàĞ(
y—r
 % 4) == 0 && ((year % 100) != 0 || (year % 400) == 0) )

231 
d
++;

232  
d
;

233 
	}
}

236 
	$¹c_Ãxt_£cÚd
(
RTCS‹
 *
s
)

238 
tm
 *tm = &
s
->
cu¼’t_tm
;

239 
days_š_mÚth
;

241 
	`ASSERT
(
	`¥š_is_locked
(&
s
->
lock
));

243 
tm
->
tm_£c
++;

244 iàĞ()
tm
->
tm_£c
 >= 60 )

246 
tm
->
tm_£c
 = 0;

247 
tm
->
tm_mš
++;

248 iàĞ()
tm
->
tm_mš
 >= 60 )

250 
tm
->
tm_mš
 = 0;

251 
tm
->
tm_hour
++;

252 iàĞ()
tm
->
tm_hour
 >= 24 )

254 
tm
->
tm_hour
 = 0;

256 
tm
->
tm_wday
++;

257 iàĞ()
tm
->
tm_wday
 >= 7 )

258 
tm
->
tm_wday
 = 0;

259 
days_š_mÚth
 = 
	`g‘_days_š_mÚth
(
tm
->
tm_mÚ
,

260 
tm
->
tm_y—r
 + 1900);

261 
tm
->
tm_mday
++;

262 iàĞ
tm
->
tm_mday
 < 1 )

264 
tm
->
tm_mday
 = 1;

266 iàĞ
tm
->
tm_mday
 > 
days_š_mÚth
 )

268 
tm
->
tm_mday
 = 1;

269 
tm
->
tm_mÚ
++;

270 iàĞ
tm
->
tm_mÚ
 >= 12 )

272 
tm
->
tm_mÚ
 = 0;

273 
tm
->
tm_y—r
++;

279 
	}
}

281 
	$¹c_upd©e_£cÚd
(*
İaque
)

283 
RTCS‹
 *
s
 = 
İaque
;

284 
s_time_t
 
now
 = 
	`NOW
();

286 
	`¥š_lock
(&
s
->
lock
);

292 iàĞ
	`uÆik–y
(
now
 - 
s
->
Ãxt_£cÚd_time
 > 
	`SECONDS
(86400)) )

294 
	`d´štk
(
XENLOG_WARNING
, "HVM RTC: dom %u skpšg %"
PRId64
" seconds\n",

295 
	`v¹c_domaš
(
s
)->
domaš_id
,

296 (
št64_t
)((
now
 - 
s
->
Ãxt_£cÚd_time
è/ 
SYSTEM_TIME_HZ
));

297 
s
->
Ãxt_£cÚd_time
 = 
now
;

301 iàĞ(
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] & 
RTC_DIV_CTL
è!ğ
RTC_REF_CLCK_32KHZ
 )

303 
s
->
Ãxt_£cÚd_time
 += 1000000000ULL;

304 
	`£t_tim”
(&
s
->
£cÚd_tim”
, s->
Ãxt_£cÚd_time
);

308 
	`¹c_Ãxt_£cÚd
(
s
);

310 iàĞ!(
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_SET
) )

311 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] |ğ
RTC_UIP
;

314 
	`£t_tim”
(&
s
->
£cÚd_tim”2
, s->
Ãxt_£cÚd_time
 + 244000);

317 
	`¥š_uÆock
(&
s
->
lock
);

318 
	}
}

320 
	$¹c_upd©e_£cÚd2
(*
İaque
)

322 
RTCS‹
 *
s
 = 
İaque
;

323 
domaš
 *
d
 = 
	`v¹c_domaš
(
s
);

325 
	`¥š_lock
(&
s
->
lock
);

327 iàĞ!(
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_SET
) )

328 
	`¹c_cİy_d©e
(
s
);

331 iàĞ
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & 
RTC_AIE
 )

333 iàĞ((
s
->
hw
.
cmos_d©a
[
RTC_SECONDS_ALARM
] & 0xc0) == 0xc0 ||

334 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_SECONDS_ALARM
]) ==

335 
s
->
cu¼’t_tm
.
tm_£c
) &&

336 ((
s
->
hw
.
cmos_d©a
[
RTC_MINUTES_ALARM
] & 0xc0) == 0xc0 ||

337 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_MINUTES_ALARM
]) ==

338 
s
->
cu¼’t_tm
.
tm_mš
) &&

339 ((
s
->
hw
.
cmos_d©a
[
RTC_HOURS_ALARM
] & 0xc0) == 0xc0 ||

340 
	`äom_bcd
(
s
, s->
hw
.
cmos_d©a
[
RTC_HOURS_ALARM
]) ==

341 
s
->
cu¼’t_tm
.
tm_hour
) )

343 
s
->
hw
.
cmos_d©a
[
RTC_REG_C
] |= 0xa0;

344 
	`hvm_i§_œq_d—s£¹
(
d
, 
RTC_IRQ
);

345 
	`hvm_i§_œq_as£¹
(
d
, 
RTC_IRQ
);

350 iàĞ(
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] & (
RTC_UIE
|
RTC_SET
)) == RTC_UIE )

352 
s
->
hw
.
cmos_d©a
[
RTC_REG_C
] |= 0x90;

353 
	`hvm_i§_œq_d—s£¹
(
d
, 
RTC_IRQ
);

354 
	`hvm_i§_œq_as£¹
(
d
, 
RTC_IRQ
);

358 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] &ğ~
RTC_UIP
;

360 
s
->
Ãxt_£cÚd_time
 += 1000000000ULL;

361 
	`£t_tim”
(&
s
->
£cÚd_tim”
, s->
Ãxt_£cÚd_time
);

363 
	`¥š_uÆock
(&
s
->
lock
);

364 
	}
}

366 
ušt32_t
 
	$¹c_iİÜt_»ad
(
RTCS‹
 *
s
, 
ušt32_t
 
addr
)

368 
»t
;

370 iàĞ(
addr
 & 1) == 0 )

373 
	`¥š_lock
(&
s
->
lock
);

375  
s
->
hw
.
cmos_šdex
 )

377 
RTC_SECONDS
:

378 
RTC_MINUTES
:

379 
RTC_HOURS
:

380 
RTC_DAY_OF_WEEK
:

381 
RTC_DAY_OF_MONTH
:

382 
RTC_MONTH
:

383 
RTC_YEAR
:

384 
»t
 = 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
];

386 
RTC_REG_A
:

387 
»t
 = 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
];

389 
RTC_REG_C
:

390 
»t
 = 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
];

391 
	`hvm_i§_œq_d—s£¹
(
	`v¹c_domaš
(
s
), 
RTC_IRQ
);

392 
s
->
hw
.
cmos_d©a
[
RTC_REG_C
] = 0x00;

395 
»t
 = 
s
->
hw
.
cmos_d©a
[s->hw.
cmos_šdex
];

399 
	`¥š_uÆock
(&
s
->
lock
);

401  
»t
;

402 
	}
}

404 
	$hªdË_¹c_io
(

405 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

407 
RTCS‹
 *
v¹c
 = 
	`vıu_v¹c
(
cu¼’t
);

409 iàĞ
by‹s
 != 1 )

411 
	`gd´štk
(
XENLOG_WARNING
, "HVM_RTC bas‡ccess\n");

412  
X86EMUL_OKAY
;

415 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

417 iàĞ
	`¹c_iİÜt_wr™e
(
v¹c
, 
pÜt
, (
ušt8_t
)*
v®
) )

418  
X86EMUL_OKAY
;

420 iàĞ
v¹c
->
hw
.
cmos_šdex
 < 
RTC_CMOS_SIZE
 )

422 *
v®
 = 
	`¹c_iİÜt_»ad
(
v¹c
, 
pÜt
);

423  
X86EMUL_OKAY
;

426  
X86EMUL_UNHANDLEABLE
;

427 
	}
}

429 
	$¹c_mig¿‹_tim”s
(
vıu
 *
v
)

431 
RTCS‹
 *
s
 = 
	`vıu_v¹c
(
v
);

433 iàĞ
v
->
vıu_id
 == 0 )

435 
	`mig¿‹_tim”
(&
s
->
£cÚd_tim”
, 
v
->
´oûssÜ
);

436 
	`mig¿‹_tim”
(&
s
->
£cÚd_tim”2
, 
v
->
´oûssÜ
);

438 
	}
}

441 
	$¹c_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

443 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

444 
rc
;

445 
	`¥š_lock
(&
s
->
lock
);

446 
rc
 = 
	`hvm_§ve_’Œy
(
RTC
, 0, 
h
, &
s
->
hw
);

447 
	`¥š_uÆock
(&
s
->
lock
);

448  
rc
;

449 
	}
}

452 
	$¹c_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

454 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

456 
	`¥š_lock
(&
s
->
lock
);

459 iàĞ
	`hvm_lßd_’Œy
(
RTC
, 
h
, &
s
->
hw
) != 0 )

461 
	`¥š_uÆock
(&
s
->
lock
);

462  -
EINVAL
;

467 
s
->
cu¼’t_tm
 = 
	`gmtime
(
	`g‘_loÿÉime
(
d
));

468 
	`¹c_cİy_d©e
(
s
);

469 
s
->
Ãxt_£cÚd_time
 = 
	`NOW
() + 1000000000ULL;

470 
	`¡İ_tim”
(&
s
->
£cÚd_tim”
);

471 
	`£t_tim”
(&
s
->
£cÚd_tim”2
, s->
Ãxt_£cÚd_time
);

474 
	`¹c_tim”_upd©e
(
s
);

476 
	`¥š_uÆock
(&
s
->
lock
);

479 
	}
}

481 
HVM_REGISTER_SAVE_RESTORE
(
RTC
, 
¹c_§ve
, 
¹c_lßd
, 1, 
HVMSR_PER_DOM
);

483 
	$¹c_»£t
(
domaš
 *
d
)

485 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

487 
	`de¡roy_³riodic_time
(&
s
->
±
);

488 
s
->
±
.
sourû
 = 
PTSRC_i§
;

489 
	}
}

491 
	$¹c_š™
(
domaš
 *
d
)

493 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

495 
	`¥š_lock_š™
(&
s
->
lock
);

497 
	`š™_tim”
(&
s
->
£cÚd_tim”
, 
¹c_upd©e_£cÚd
, s, 
	`smp_´oûssÜ_id
());

498 
	`š™_tim”
(&
s
->
£cÚd_tim”2
, 
¹c_upd©e_£cÚd2
, s, 
	`smp_´oûssÜ_id
());

500 
	`»gi¡”_pÜtio_hªdËr
(
d
, 
	`RTC_PORT
(0), 2, 
hªdË_¹c_io
);

502 
	`¹c_»£t
(
d
);

504 
	`¥š_lock
(&
s
->
lock
);

506 
s
->
hw
.
cmos_d©a
[
RTC_REG_A
] = 
RTC_REF_CLCK_32KHZ
 | 6;

507 
s
->
hw
.
cmos_d©a
[
RTC_REG_B
] = 
RTC_24H
;

508 
s
->
hw
.
cmos_d©a
[
RTC_REG_C
] = 0;

509 
s
->
hw
.
cmos_d©a
[
RTC_REG_D
] = 
RTC_VRT
;

511 
s
->
cu¼’t_tm
 = 
	`gmtime
(
	`g‘_loÿÉime
(
d
));

513 
	`¹c_cİy_d©e
(
s
);

515 
s
->
Ãxt_£cÚd_time
 = 
	`NOW
() + 1000000000ULL;

516 
	`¡İ_tim”
(&
s
->
£cÚd_tim”
);

517 
	`£t_tim”
(&
s
->
£cÚd_tim”2
, s->
Ãxt_£cÚd_time
);

519 
	`¥š_uÆock
(&
s
->
lock
);

520 
	}
}

522 
	$¹c_deš™
(
domaš
 *
d
)

524 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

526 
	`¥š_b¬r›r
(&
s
->
lock
);

528 
	`de¡roy_³riodic_time
(&
s
->
±
);

529 
	`kl_tim”
(&
s
->
£cÚd_tim”
);

530 
	`kl_tim”
(&
s
->
£cÚd_tim”2
);

531 
	}
}

533 
	$¹c_upd©e_şock
(
domaš
 *
d
)

535 
RTCS‹
 *
s
 = 
	`domaš_v¹c
(
d
);

537 
	`¥š_lock
(&
s
->
lock
);

538 
s
->
cu¼’t_tm
 = 
	`gmtime
(
	`g‘_loÿÉime
(
d
));

539 
	`¥š_uÆock
(&
s
->
lock
);

540 
	}
}

	@hvm/save.c

24 
	~<asm/hvm/suµÜt.h
>

25 
	~<public/hvm/§ve.h
>

27 
	$¬ch_hvm_§ve
(
domaš
 *
d
, 
hvm_§ve_h—d”
 *
hdr
)

29 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

32 
	`ıuid
(1, &
—x
, &
ebx
, &
ecx
, &
edx
);

33 
hdr
->
ıuid
 = 
—x
;

36 
hdr
->
gtsc_khz
 = 
d
->
¬ch
.
tsc_khz
;

37 
	}
}

39 
	$¬ch_hvm_lßd
(
domaš
 *
d
, 
hvm_§ve_h—d”
 *
hdr
)

41 
ušt32_t
 
—x
, 
ebx
, 
ecx
, 
edx
;

43 iàĞ
hdr
->
magic
 !ğ
HVM_FILE_MAGIC
 )

45 
	`gd´štk
(
XENLOG_ERR
,

46 "HVM„e¡Üe: bad magiønumb” %#"
PRIx32
"\n", 
hdr
->
magic
);

50 iàĞ
hdr
->
v”siÚ
 !ğ
HVM_FILE_VERSION
 )

52 
	`gd´štk
(
XENLOG_ERR
,

53 "HVM„e¡Üe: unsuµÜ‹d v”siÚ %u\n", 
hdr
->
v”siÚ
);

57 
	`ıuid
(1, &
—x
, &
ebx
, &
ecx
, &
edx
);

59 iàĞ(
hdr
->
ıuid
 & ~0x0fULè!ğ(
—x
 & ~0x0fUL) )

60 
	`gd´štk
(
XENLOG_INFO
, "HVM„estore (%u): VM saved on one CPU "

61 "(%#"
PRIx32
")‡nd„estored on‡nother (%#"PRIx32").\n",

62 
d
->
domaš_id
, 
hdr
->
ıuid
, 
—x
);

65 iàĞ
hdr
->
gtsc_khz
 )

66 
d
->
¬ch
.
tsc_khz
 = 
hdr
->
gtsc_khz
;

67 iàĞ
d
->
¬ch
.
vtsc
 )

68 
	`hvm_£t_rdtsc_ex™šg
(
d
, 1);

71 
d
->
¬ch
.
hvm_domaš
.
¡dvga
.
ÿche
 = 0;

74 
	}
}

	@hvm/stdvga.c

30 
	~<x’/cÚfig.h
>

31 
	~<x’/ty³s.h
>

32 
	~<x’/sched.h
>

33 
	~<x’/domaš_·ge.h
>

34 
	~<asm/hvm/suµÜt.h
>

35 
	~<x’/numa.h
>

36 
	~<x’/·gšg.h
>

38 
	#VGA_MEM_BASE
 0xa0000

	)

39 
	#VGA_MEM_SIZE
 0x20000

	)

41 
	#PAT
(
x
è(x)

	)

42 cÚ¡ 
ušt32_t
 
	gmask16
[16] = {

43 
PAT
(0x00000000),

44 
PAT
(0x000000ff),

45 
PAT
(0x0000ff00),

46 
PAT
(0x0000ffff),

47 
PAT
(0x00ff0000),

48 
PAT
(0x00ff00ff),

49 
PAT
(0x00ffff00),

50 
PAT
(0x00ffffff),

51 
PAT
(0xff000000),

52 
PAT
(0xff0000ff),

53 
PAT
(0xff00ff00),

54 
PAT
(0xff00ffff),

55 
PAT
(0xffff0000),

56 
PAT
(0xffff00ff),

57 
PAT
(0xffffff00),

58 
PAT
(0xffffffff),

62 cÚ¡ 
ušt8_t
 
	g¤_mask
[8] = {

63 (
ušt8_t
)~0xfc,

64 (
ušt8_t
)~0xc2,

65 (
ušt8_t
)~0xf0,

66 (
ušt8_t
)~0xc0,

67 (
ušt8_t
)~0xf1,

68 (
ušt8_t
)~0xff,

69 (
ušt8_t
)~0xff,

70 (
ušt8_t
)~0x00,

73 cÚ¡ 
ušt8_t
 
	ggr_mask
[9] = {

74 (
ušt8_t
)~0xf0,

75 (
ušt8_t
)~0xf0,

76 (
ušt8_t
)~0xf0,

77 (
ušt8_t
)~0xe0,

78 (
ušt8_t
)~0xfc,

79 (
ušt8_t
)~0x84,

80 (
ušt8_t
)~0xf0,

81 (
ušt8_t
)~0xf0,

82 (
ušt8_t
)~0x00,

85 
ušt8_t
 *
	$v¿m_g‘b
(
hvm_hw_¡dvga
 *
s
, 
a
)

87 
·ge_šfo
 *
pg
 = 
s
->
v¿m_·ge
[(
a
 >> 12) & 0x3f];

88 
ušt8_t
 *
p
 = 
	`__m­_domaš_·ge
(
pg
);

89  &
p
[
a
 & 0xfff];

90 
	}
}

92 
ušt32_t
 *
	$v¿m_g‘l
(
hvm_hw_¡dvga
 *
s
, 
a
)

94 
·ge_šfo
 *
pg
 = 
s
->
v¿m_·ge
[(
a
 >> 10) & 0x3f];

95 
ušt32_t
 *
p
 = 
	`__m­_domaš_·ge
(
pg
);

96  &
p
[
a
 & 0x3ff];

97 
	}
}

99 
	$v¿m_put
(
hvm_hw_¡dvga
 *
s
, *
p
)

101 
	`unm­_domaš_·ge
(
p
);

102 
	}
}

104 
	$¡dvga_outb
(
ušt64_t
 
addr
, 
ušt8_t
 
v®
)

106 
hvm_hw_¡dvga
 *
s
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
¡dvga
;

107 
rc
 = 1, 
´ev_¡dvga
 = 
s
->
¡dvga
;

109  
addr
 )

112 
s
->
¤_šdex
 = 
v®
;

116 
rc
 = (
s
->
¤_šdex
 < (s->
¤
));

117 iàĞ
rc
 )

118 
s
->
¤
[s->
¤_šdex
] = 
v®
 & 
¤_mask
[s->sr_index] ;

122 
s
->
gr_šdex
 = 
v®
;

126 
rc
 = (
s
->
gr_šdex
 < (s->
gr
));

127 iàĞ
rc
 )

128 
s
->
gr
[s->
gr_šdex
] = 
v®
 & 
gr_mask
[s->gr_index];

132 
rc
 = 0;

138 
s
->
¡dvga
 = (s->
¤
[7] == 0x00);

140 iàĞ!
´ev_¡dvga
 && 
s
->
¡dvga
 )

146 
s
->
ÿche
 = 1;

147 
	`gd´štk
(
XENLOG_INFO
, "entering stdvga‡nd caching modes\n");

149 iàĞ
´ev_¡dvga
 && !
s
->
¡dvga
 )

151 
	`gd´štk
(
XENLOG_INFO
, "leaving stdvga\n");

154  
rc
;

155 
	}
}

157 
	$¡dvga_out
(
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ
v®
)

159  
by‹s
 )

162 
	`¡dvga_outb
(
pÜt
, 
v®
);

166 
	`¡dvga_outb
(
pÜt
 + 0, 
v®
 >> 0);

167 
	`¡dvga_outb
(
pÜt
 + 1, 
v®
 >> 8);

173 
	}
}

175 
	$¡dvga_š‹rû±_pio
(

176 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

178 
hvm_hw_¡dvga
 *
s
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
¡dvga
;

180 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

182 
	`¥š_lock
(&
s
->
lock
);

183 
	`¡dvga_out
(
pÜt
, 
by‹s
, *
v®
);

184 
	`¥š_uÆock
(&
s
->
lock
);

187  
X86EMUL_UNHANDLEABLE
;

188 
	}
}

190 
	$¡dvga_mem_off£t
(

191 
hvm_hw_¡dvga
 *
s
, 
mmio_addr
)

193 
memÜy_m­_mode
 = (
s
->
gr
[6] >> 2) & 3;

194 
off£t
 = 
mmio_addr
 & 0x1ffff;

196  
memÜy_m­_mode
 )

201 iàĞ
off£t
 >= 0x10000 )

202 
ç
;

203 
off£t
 += 0;

206 
off£t
 -= 0x10000;

207 iàĞ
off£t
 >= 0x8000 )

208 
ç
;

212 
off£t
 -= 0x18000;

213 iàĞ
off£t
 >= 0x8000 )

214 
ç
;

218  
off£t
;

220 
ç
:

222 
	}
}

224 
	#GET_PLANE
(
d©a
, 
p
è(((d©aè>> (Õè* 8)è& 0xff)

	)

226 
ušt8_t
 
	$¡dvga_mem_»adb
(
ušt64_t
 
addr
)

228 
hvm_hw_¡dvga
 *
s
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
¡dvga
;

229 
¶ªe
;

230 
ušt32_t
 
»t
, *
v¿m_l
;

231 
ušt8_t
 *
v¿m_b
;

233 
addr
 = 
	`¡dvga_mem_off£t
(
s
,‡ddr);

234 iàĞ
addr
 == ~0u )

237 iàĞ
s
->
¤
[4] & 0x08 )

240 
v¿m_b
 = 
	`v¿m_g‘b
(
s
, 
addr
);

241 
»t
 = *
v¿m_b
;

242 
	`v¿m_put
(
s
, 
v¿m_b
);

244 iàĞ
s
->
gr
[5] & 0x10 )

247 
¶ªe
 = (
s
->
gr
[4] & 2è| (
addr
 & 1);

248 
v¿m_b
 = 
	`v¿m_g‘b
(
s
, ((
addr
 & ~1è<< 1è| 
¶ªe
);

249 
»t
 = *
v¿m_b
;

250 
	`v¿m_put
(
s
, 
v¿m_b
);

255 
v¿m_l
 = 
	`v¿m_g‘l
(
s
, 
addr
);

256 
s
->
Ïtch
 = *
v¿m_l
;

257 
	`v¿m_put
(
s
, 
v¿m_l
);

259 iàĞ!(
s
->
gr
[5] & 0x08) )

262 
¶ªe
 = 
s
->
gr
[4];

263 
»t
 = 
	`GET_PLANE
(
s
->
Ïtch
, 
¶ªe
);

268 
»t
 = (
s
->
Ïtch
 ^ 
mask16
[s->
gr
[2]]) & mask16[s->gr[7]];

269 
»t
 |=„et >> 16;

270 
»t
 |=„et >> 8;

271 
»t
 = (~ret) & 0xff;

275  
»t
;

276 
	}
}

278 
ušt64_t
 
	$¡dvga_mem_»ad
(
ušt64_t
 
addr
, ušt64_ˆ
size
)

280 
ušt64_t
 
d©a
 = 0;

282  
size
 )

285 
d©a
 = 
	`¡dvga_mem_»adb
(
addr
);

289 
d©a
 = 
	`¡dvga_mem_»adb
(
addr
);

290 
d©a
 |ğ
	`¡dvga_mem_»adb
(
addr
 + 1) << 8;

294 
d©a
 = 
	`¡dvga_mem_»adb
(
addr
);

295 
d©a
 |ğ
	`¡dvga_mem_»adb
(
addr
 + 1) << 8;

296 
d©a
 |ğ
	`¡dvga_mem_»adb
(
addr
 + 2) << 16;

297 
d©a
 |ğ
	`¡dvga_mem_»adb
(
addr
 + 3) << 24;

301 
d©a
 = (
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
));

302 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 1)) << 8;

303 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 2)) << 16;

304 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 3)) << 24;

305 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 4)) << 32;

306 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 5)) << 40;

307 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 6)) << 48;

308 
d©a
 |ğ(
ušt64_t
)(
	`¡dvga_mem_»adb
(
addr
 + 7)) << 56;

312 
	`gd´štk
(
XENLOG_WARNING
, "šv®id iØsize: %"
PRId64
"\n", 
size
);

316  
d©a
;

317 
	}
}

319 
	$¡dvga_mem_wr™eb
(
ušt64_t
 
addr
, 
ušt32_t
 
v®
)

321 
hvm_hw_¡dvga
 *
s
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
¡dvga
;

322 
¶ªe
, 
wr™e_mode
, 
b
, 
func_£Ëù
, 
mask
;

323 
ušt32_t
 
wr™e_mask
, 
b™_mask
, 
£t_mask
, *
v¿m_l
;

324 
ušt8_t
 *
v¿m_b
;

326 
addr
 = 
	`¡dvga_mem_off£t
(
s
,‡ddr);

327 iàĞ
addr
 == ~0u )

330 iàĞ
s
->
¤
[4] & 0x08 )

333 
¶ªe
 = 
addr
 & 3;

334 
mask
 = (1 << 
¶ªe
);

335 iàĞ
s
->
¤
[2] & 
mask
 )

337 
v¿m_b
 = 
	`v¿m_g‘b
(
s
, 
addr
);

338 *
v¿m_b
 = 
v®
;

339 
	`v¿m_put
(
s
, 
v¿m_b
);

342 iàĞ
s
->
gr
[5] & 0x10 )

345 
¶ªe
 = (
s
->
gr
[4] & 2è| (
addr
 & 1);

346 
mask
 = (1 << 
¶ªe
);

347 iàĞ
s
->
¤
[2] & 
mask
 )

349 
addr
 = (×dd¸& ~1è<< 1è| 
¶ªe
;

350 
v¿m_b
 = 
	`v¿m_g‘b
(
s
, 
addr
);

351 *
v¿m_b
 = 
v®
;

352 
	`v¿m_put
(
s
, 
v¿m_b
);

357 
wr™e_mode
 = 
s
->
gr
[5] & 3;

358  
wr™e_mode
 )

363 
b
 = 
s
->
gr
[3] & 7;

364 
v®
 = ((v® >> 
b
) | (val << (8 - b))) & 0xff;

365 
v®
 |= val << 8;

366 
v®
 |= val << 16;

369 
£t_mask
 = 
mask16
[
s
->
gr
[1]];

370 
v®
 = (v® & ~
£t_mask
è| (
mask16
[
s
->
gr
[0]] & set_mask);

371 
b™_mask
 = 
s
->
gr
[8];

374 
v®
 = 
s
->
Ïtch
;

375 
do_wr™e
;

377 
v®
 = 
mask16
[val & 0x0f];

378 
b™_mask
 = 
s
->
gr
[8];

382 
b
 = 
s
->
gr
[3] & 7;

383 
v®
 = (v® >> 
b
) | (val << (8 - b));

385 
b™_mask
 = 
s
->
gr
[8] & 
v®
;

386 
v®
 = 
mask16
[
s
->
gr
[0]];

391 
func_£Ëù
 = 
s
->
gr
[3] >> 3;

392  
func_£Ëù
 )

400 
v®
 &ğ
s
->
Ïtch
;

404 
v®
 |ğ
s
->
Ïtch
;

408 
v®
 ^ğ
s
->
Ïtch
;

413 
b™_mask
 |= bit_mask << 8;

414 
b™_mask
 |= bit_mask << 16;

415 
v®
 = (v® & 
b™_mask
è| (
s
->
Ïtch
 & ~bit_mask);

417 
do_wr™e
:

419 
mask
 = 
s
->
¤
[2];

420 
wr™e_mask
 = 
mask16
[
mask
];

421 
v¿m_l
 = 
	`v¿m_g‘l
(
s
, 
addr
);

422 *
v¿m_l
 = (*v¿m_È& ~
wr™e_mask
è| (
v®
 & write_mask);

423 
	`v¿m_put
(
s
, 
v¿m_l
);

425 
	}
}

427 
	$¡dvga_mem_wr™e
(
ušt64_t
 
addr
, ušt64_ˆ
d©a
, ušt64_ˆ
size
)

430  
size
 )

433 
	`¡dvga_mem_wr™eb
(
addr
, (
d©a
 >> 0) & 0xff);

437 
	`¡dvga_mem_wr™eb
(
addr
+0, (
d©a
 >> 0) & 0xff);

438 
	`¡dvga_mem_wr™eb
(
addr
+1, (
d©a
 >> 8) & 0xff);

442 
	`¡dvga_mem_wr™eb
(
addr
+0, (
d©a
 >> 0) & 0xff);

443 
	`¡dvga_mem_wr™eb
(
addr
+1, (
d©a
 >> 8) & 0xff);

444 
	`¡dvga_mem_wr™eb
(
addr
+2, (
d©a
 >> 16) & 0xff);

445 
	`¡dvga_mem_wr™eb
(
addr
+3, (
d©a
 >> 24) & 0xff);

449 
	`¡dvga_mem_wr™eb
(
addr
+0, (
d©a
 >> 0) & 0xff);

450 
	`¡dvga_mem_wr™eb
(
addr
+1, (
d©a
 >> 8) & 0xff);

451 
	`¡dvga_mem_wr™eb
(
addr
+2, (
d©a
 >> 16) & 0xff);

452 
	`¡dvga_mem_wr™eb
(
addr
+3, (
d©a
 >> 24) & 0xff);

453 
	`¡dvga_mem_wr™eb
(
addr
+4, (
d©a
 >> 32) & 0xff);

454 
	`¡dvga_mem_wr™eb
(
addr
+5, (
d©a
 >> 40) & 0xff);

455 
	`¡dvga_mem_wr™eb
(
addr
+6, (
d©a
 >> 48) & 0xff);

456 
	`¡dvga_mem_wr™eb
(
addr
+7, (
d©a
 >> 56) & 0xff);

460 
	`gd´štk
(
XENLOG_WARNING
, "šv®id iØsize: %"
PRId64
"\n", 
size
);

463 
	}
}

465 
ušt32_t
 
	g»ad_d©a
;

467 
	$mmio_move
(
hvm_hw_¡dvga
 *
s
, 
iÜeq_t
 *
p
)

469 
i
;

470 
sign
 = 
p
->
df
 ? -1 : 1;

471 
p2m_ty³_t
 
p2mt
;

472 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
);

474 iàĞ
p
->
d©a_is_±r
 )

476 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

478 
ušt64_t
 
addr
 = 
p
->addr, 
d©a
 =…->d©a, 
tmp
;

479  
i
 = 0; i < 
p
->
couÁ
; i++ )

481 
tmp
 = 
	`¡dvga_mem_»ad
(
addr
, 
p
->
size
);

482 iàĞ
	`hvm_cİy_to_gue¡_phys
(
d©a
, &
tmp
, 
p
->
size
) !=

483 
HVMCOPY_okay
 )

485 ()
	`gâ_to_mâ
(
p2m
, 
d©a
 >> 
PAGE_SHIFT
, &
p2mt
);

490 iàĞ(
p2mt
 !ğ
p2m_mmio_dm
è|| (
d©a
 < 
VGA_MEM_BASE
) ||

491 ((
d©a
 + 
p
->
size
è> (
VGA_MEM_BASE
 + 
VGA_MEM_SIZE
)) )

493 
	`¡dvga_mem_wr™e
(
d©a
, 
tmp
, 
p
->
size
);

495 
d©a
 +ğ
sign
 * 
p
->
size
;

496 
addr
 +ğ
sign
 * 
p
->
size
;

501 
ušt32_t
 
addr
 = 
p
->addr, 
d©a
 =…->d©a, 
tmp
;

502  
i
 = 0; i < 
p
->
couÁ
; i++ )

504 iàĞ
	`hvm_cİy_äom_gue¡_phys
(&
tmp
, 
d©a
, 
p
->
size
) !=

505 
HVMCOPY_okay
 )

507 ()
	`gâ_to_mâ
(
p2m
, 
d©a
 >> 
PAGE_SHIFT
, &
p2mt
);

508 iàĞ(
p2mt
 !ğ
p2m_mmio_dm
è|| (
d©a
 < 
VGA_MEM_BASE
) ||

509 ((
d©a
 + 
p
->
size
è> (
VGA_MEM_BASE
 + 
VGA_MEM_SIZE
)) )

511 
tmp
 = 
	`¡dvga_mem_»ad
(
d©a
, 
p
->
size
);

513 
	`¡dvga_mem_wr™e
(
addr
, 
tmp
, 
p
->
size
);

514 
d©a
 +ğ
sign
 * 
p
->
size
;

515 
addr
 +ğ
sign
 * 
p
->
size
;

521 iàĞ
p
->
dœ
 =ğ
IOREQ_READ
 )

523 
ušt32_t
 
addr
 = 
p
->addr;

524  
i
 = 0; i < 
p
->
couÁ
; i++ )

526 
p
->
d©a
 = 
	`¡dvga_mem_»ad
(
addr
,…->
size
);

527 
addr
 +ğ
sign
 * 
p
->
size
;

532 
ušt32_t
 
addr
 = 
p
->addr;

533  
i
 = 0; i < 
p
->
couÁ
; i++ )

535 
	`¡dvga_mem_wr™e
(
addr
, 
p
->
d©a
,…->
size
);

536 
addr
 +ğ
sign
 * 
p
->
size
;

541 
»ad_d©a
 = 
p
->
d©a
;

543 
	}
}

545 
	$¡dvga_š‹rû±_mmio
(
iÜeq_t
 *
p
)

547 
domaš
 *
d
 = 
cu¼’t
->domain;

548 
hvm_hw_¡dvga
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¡dvga
;

549 
buf
 = 0, 
rc
;

551 iàĞ
p
->
size
 > 8 )

553 
	`gd´štk
(
XENLOG_WARNING
, "šv®id mmiØsiz%d\n", ()
p
->
size
);

554  
X86EMUL_UNHANDLEABLE
;

557 
	`¥š_lock
(&
s
->
lock
);

559 iàĞ
s
->
¡dvga
 && s->
ÿche
 )

561  
p
->
ty³
 )

563 
IOREQ_TYPE_COPY
:

564 
buf
 = 
	`mmio_move
(
s
, 
p
);

565 iàĞ!
buf
 )

566 
s
->
ÿche
 = 0;

569 
	`gd´štk
(
XENLOG_WARNING
, "unsupported mmio„equestype:%d "

572 
p
->
ty³
, (í->
addr
, (í->
d©a
, (í->
size
,

573 ()
p
->
couÁ
,…->
¡©e
,

574 
p
->
d©a_is_±r
,…->
dœ
,…->
df
);

575 
s
->
ÿche
 = 0;

580 
buf
 = (
p
->
dœ
 =ğ
IOREQ_WRITE
);

583 
rc
 = (
buf
 && 
	`hvm_bufã»d_io_£nd
(
p
));

585 
	`¥š_uÆock
(&
s
->
lock
);

587  
rc
 ? 
X86EMUL_OKAY
 : 
X86EMUL_UNHANDLEABLE
;

588 
	}
}

590 
	$¡dvga_š™
(
domaš
 *
d
)

592 
hvm_hw_¡dvga
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¡dvga
;

593 
·ge_šfo
 *
pg
;

594 *
p
;

595 
i
;

597 
	`mem£t
(
s
, 0, (*s));

598 
	`¥š_lock_š™
(&
s
->
lock
);

600  
i
 = 0; i !ğ
	`ARRAY_SIZE
(
s
->
v¿m_·ge
); i++ )

602 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

603 iàĞ
pg
 =ğ
NULL
 )

605 
s
->
v¿m_·ge
[
i
] = 
pg
;

606 
p
 = 
	`__m­_domaš_·ge
(
pg
);

607 
	`ş—r_·ge
(
p
);

608 
	`unm­_domaš_·ge
(
p
);

611 iàĞ
i
 =ğ
	`ARRAY_SIZE
(
s
->
v¿m_·ge
) )

614 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0x3c4, 2, 
¡dvga_š‹rû±_pio
);

616 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0x3û, 2, 
¡dvga_š‹rû±_pio
);

618 
	`»gi¡”_bufã»d_io_hªdËr
(

619 
d
, 
VGA_MEM_BASE
, 
VGA_MEM_SIZE
, 
¡dvga_š‹rû±_mmio
);

621 
	}
}

623 
	$¡dvga_deš™
(
domaš
 *
d
)

625 
hvm_hw_¡dvga
 *
s
 = &
d
->
¬ch
.
hvm_domaš
.
¡dvga
;

626 
i
;

628  
i
 = 0; i !ğ
	`ARRAY_SIZE
(
s
->
v¿m_·ge
); i++ )

630 iàĞ
s
->
v¿m_·ge
[
i
] =ğ
NULL
 )

632 
	`ä“_domh—p_·ge
(
s
->
v¿m_·ge
[
i
]);

633 
s
->
v¿m_·ge
[
i
] = 
NULL
;

635 
	}
}

	@hvm/svm/asid.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/lib.h
>

22 
	~<x’/³rfc.h
>

23 
	~<asm/hvm/svm/asid.h
>

24 
	~<asm/amd.h
>

26 
	$svm_asid_š™
(
ıušfo_x86
 *
c
)

28 
Çsids
 = 0;

31 iàĞ!
	`ıu_has_amd_”¿tum
(
c
, 
AMD_ERRATUM_170
) )

32 
Çsids
 = 
	`ıuid_ebx
(0x8000000A);

34 
	`hvm_asid_š™
(
Çsids
);

35 
	}
}

41 
asmlškage
 
	$svm_asid_hªdË_vmrun
()

43 
vıu
 *
cu¼
 = 
cu¼’t
;

44 
vmcb_¡ruù
 *
vmcb
 = 
cu¼
->
¬ch
.
hvm_svm
.vmcb;

45 
boŞ_t
 
Ãed_æush
 = 
	`hvm_asid_hªdË_vm’‹r
();

48 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
asid
 == 0 )

50 
	`vmcb_£t_gue¡_asid
(
vmcb
, 1);

51 
vmcb
->
b_cÚŒŞ
 = 1;

55 
	`vmcb_£t_gue¡_asid
(
vmcb
, 
cu¼
->
¬ch
.
hvm_vıu
.
asid
);

56 
vmcb
->
b_cÚŒŞ
 = 
Ãed_æush
;

57 
	}
}

	@hvm/svm/emulate.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/lib.h
>

22 
	~<x’/Œaû.h
>

23 
	~<asm/m¤.h
>

24 
	~<asm/hvm/hvm.h
>

25 
	~<asm/hvm/suµÜt.h
>

26 
	~<asm/hvm/svm/svm.h
>

27 
	~<asm/hvm/svm/vmcb.h
>

28 
	~<asm/hvm/svm/emuÏ‹.h
>

30 
	#MAX_INST_LEN
 15

	)

32 
	$is_´efix
(
u8
 
İc
)

34  
İc
 )

47 #ià
__x86_64__


53 
	}
}

55 
	$svm_r2poš‹r
(
vıu
 *
v
)

57 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

58 
p
 = 
vmcb
->
cs
.
ba£
 + 
	`gue¡_ıu_u£r_»gs
()->
e
;

59 iàĞ!(
vmcb
->
cs
.
©Œ
.
f›lds
.
l
 && 
	`hvm_lÚg_mode_’abËd
(
v
)) )

60  (
u32
)
p
;

61  
p
;

62 
	}
}

64 
	$svm_ÃxŒ_š¢_Ëngth
(
vıu
 *
v
)

66 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

68 iàĞ!
ıu_has_svm_Äs
 || (
vmcb
->
ÃxŒ
 <ğvmcb->
r
) )

71 #iâdeà
NDEBUG


72  
vmcb
->
ex™code
 )

74 
VMEXIT_CR0_READ
... 
VMEXIT_DR15_WRITE
:

77 
VMEXIT_IDTR_READ
 ... 
VMEXIT_TR_WRITE
:

78 
VMEXIT_RDTSC
 ... 
VMEXIT_MSR
:

79 
VMEXIT_VMRUN
 ... 
VMEXIT_XSETBV
:

81 
VMEXIT_CR0_SEL_WRITE
:

82 
VMEXIT_EXCEPTION_BP
:

85 
	`BUG
();

89  
vmcb
->
ÃxŒ
 - vmcb->
r
;

90 
	}
}

93 
	#MAKE_INSTR
(
nm
, ...ècÚ¡ 
u8
 
OPCODE_
##nm[] = { 
__VA_ARGS__
 }

	)

94 
MAKE_INSTR
(
INVD
, 2, 0x0f, 0x08);

95 
MAKE_INSTR
(
WBINVD
, 2, 0x0f, 0x09);

96 
MAKE_INSTR
(
CPUID
, 2, 0x0f, 0xa2);

97 
MAKE_INSTR
(
RDMSR
, 2, 0x0f, 0x32);

98 
MAKE_INSTR
(
WRMSR
, 2, 0x0f, 0x30);

99 
MAKE_INSTR
(
VMCALL
, 3, 0x0f, 0x01, 0xd9);

100 
MAKE_INSTR
(
HLT
, 1, 0xf4);

101 
MAKE_INSTR
(
INT3
, 1, 0xcc);

102 
MAKE_INSTR
(
RDTSC
, 2, 0x0f, 0x31);

103 
MAKE_INSTR
(
PAUSE
, 1, 0x90);

104 
MAKE_INSTR
(
XSETBV
, 3, 0x0f, 0x01, 0xd1);

106 cÚ¡ 
u8
 *
	gİc_by‹s
[
INSTR_MAX_COUNT
] =

108 [
INSTR_INVD
] = 
OPCODE_INVD
,

109 [
INSTR_WBINVD
] = 
OPCODE_WBINVD
,

110 [
INSTR_CPUID
] = 
OPCODE_CPUID
,

111 [
INSTR_RDMSR
] = 
OPCODE_RDMSR
,

112 [
INSTR_WRMSR
] = 
OPCODE_WRMSR
,

113 [
INSTR_VMCALL
] = 
OPCODE_VMCALL
,

114 [
INSTR_HLT
] = 
OPCODE_HLT
,

115 [
INSTR_INT3
] = 
OPCODE_INT3
,

116 [
INSTR_RDTSC
] = 
OPCODE_RDTSC
,

117 [
INSTR_PAUSE
] = 
OPCODE_PAUSE
,

118 [
INSTR_XSETBV
] = 
OPCODE_XSETBV
,

121 
	$ãtch
(
vıu
 *
v
, 
u8
 *
buf
, 
addr
, 
Ën
)

123 
ušt32_t
 
pãc
;

125 
pãc
 = (
	`vmcb_g‘_ıl
(
v
->
¬ch
.
hvm_svm
.
vmcb
è=ğ3è? 
PFEC_u£r_mode
 : 0;

127  
	`hvm_ãtch_äom_gue¡_vœt
(
buf
, 
addr
, 
Ën
, 
pãc
) )

129 
HVMCOPY_okay
:

131 
HVMCOPY_bad_gva_to_gâ
:

136 
	`gd´štk
(
XENLOG_WARNING
, "Bad instruction fetch‡t %#lx (%#lx)\n",

137 (è
	`gue¡_ıu_u£r_»gs
()->
e
, 
addr
);

138 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

142 
	}
}

144 
	$__g‘_š¡ruùiÚ_Ëngth_äom_li¡
(
vıu
 *
v
,

145 
š¡ruùiÚ_šdex
 *
li¡
, 
li¡_couÁ
)

147 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

148 
i
, 
j
, 
š¡_Ën
 = 0;

149 
š¡ruùiÚ_šdex
 
š¡r
 = 0;

150 
u8
 
buf
[
MAX_INST_LEN
];

151 cÚ¡ 
u8
 *
İcode
 = 
NULL
;

152 
ãtch_addr
;

153 
ãtch_Ën
;

155 iàĞ(
š¡_Ën
 = 
	`svm_ÃxŒ_š¢_Ëngth
(
v
)) != 0 )

156  
š¡_Ën
;

158 iàĞ
vmcb
->
ex™code
 =ğ
VMEXIT_IOIO
 )

159  
vmcb
->
ex™šfo2
 - vmcb->
r
;

163 
ãtch_addr
 = 
	`svm_r2poš‹r
(
v
);

164 
ãtch_Ën
 = 
	`mš_t
(, 
MAX_INST_LEN
,

165 
PAGE_SIZE
 - (
ãtch_addr
 & ~
PAGE_MASK
));

166 iàĞ!
	`ãtch
(
v
, 
buf
, 
ãtch_addr
, 
ãtch_Ën
) )

169  (
š¡_Ën
 < 
MAX_INST_LEN
è&& 
	`is_´efix
(
buf
[inst_len]) )

171 
š¡_Ën
++;

172 iàĞ
š¡_Ën
 >ğ
ãtch_Ën
 )

174 iàĞ!
	`ãtch
(
v
, 
buf
 + 
ãtch_Ën
, 
ãtch_addr
 + fetch_len,

175 
MAX_INST_LEN
 - 
ãtch_Ën
) )

177 
ãtch_Ën
 = 
MAX_INST_LEN
;

181  
j
 = 0; j < 
li¡_couÁ
; j++ )

183 
š¡r
 = 
li¡
[
j
];

184 
İcode
 = 
İc_by‹s
[
š¡r
];

186  
i
 = 0; (˜< 
İcode
[0]è&& ((
š¡_Ën
 + iè< 
MAX_INST_LEN
); i++ )

188 iàĞ(
š¡_Ën
 + 
i
è>ğ
ãtch_Ën
 )

190 iàĞ!
	`ãtch
(
v
, 
buf
 + 
ãtch_Ën
,

191 
ãtch_addr
 + 
ãtch_Ën
,

192 
MAX_INST_LEN
 - 
ãtch_Ën
) )

194 
ãtch_Ën
 = 
MAX_INST_LEN
;

197 iàĞ
buf
[
š¡_Ën
+
i
] !ğ
İcode
[i+1] )

198 
mism©ch
;

200 
dÚe
;

201 
mism©ch
: ;

204 
	`gd´štk
(
XENLOG_WARNING
,

206 "e = %lx\n", 
__func__
, ()
vmcb
->
r
);

207 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

210 
dÚe
:

211 
š¡_Ën
 +ğ
İcode
[0];

212 
	`ASSERT
(
š¡_Ën
 <ğ
MAX_INST_LEN
);

213  
š¡_Ën
;

214 
	}
}

	@hvm/svm/intr.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/š™.h
>

22 
	~<x’/mm.h
>

23 
	~<x’/lib.h
>

24 
	~<x’/Œaû.h
>

25 
	~<x’/”ºo.h
>

26 
	~<asm/ıuã©u».h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<asm/m¤.h
>

29 
	~<asm/·gšg.h
>

30 
	~<asm/hvm/hvm.h
>

31 
	~<asm/hvm/io.h
>

32 
	~<asm/hvm/suµÜt.h
>

33 
	~<asm/hvm/vÏpic.h
>

34 
	~<asm/hvm/svm/svm.h
>

35 
	~<asm/hvm/svm/šŒ.h
>

36 
	~<x’/ev’t.h
>

37 
	~<x’/k”Ãl.h
>

38 
	~<public/hvm/iÜeq.h
>

39 
	~<x’/domaš_·ge.h
>

40 
	~<asm/hvm/Œaû.h
>

42 
	$svm_šjeù_nmi
(
vıu
 *
v
)

44 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

45 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

46 
ev’tšj_t
 
ev’t
;

48 
ev’t
.
by‹s
 = 0;

49 
ev’t
.
f›lds
.
v
 = 1;

50 
ev’t
.
f›lds
.
ty³
 = 
X86_EVENTTYPE_NMI
;

51 
ev’t
.
f›lds
.
veùÜ
 = 2;

53 
	`ASSERT
(
vmcb
->
ev’tšj
.
f›lds
.
v
 == 0);

54 
vmcb
->
ev’tšj
 = 
ev’t
;

60 
	`vmcb_£t_g’”®1_š‹rû±s
(

61 
vmcb
, 
g’”®1_š‹rû±s
 | 
GENERAL1_INTERCEPT_IRET
);

62 
	}
}

64 
	$svm_šjeù_extšt
(
vıu
 *
v
, 
veùÜ
)

66 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

67 
ev’tšj_t
 
ev’t
;

69 
ev’t
.
by‹s
 = 0;

70 
ev’t
.
f›lds
.
v
 = 1;

71 
ev’t
.
f›lds
.
ty³
 = 
X86_EVENTTYPE_EXT_INTR
;

72 
ev’t
.
f›lds
.
veùÜ
 = vector;

74 
	`ASSERT
(
vmcb
->
ev’tšj
.
f›lds
.
v
 == 0);

75 
vmcb
->
ev’tšj
 = 
ev’t
;

76 
	}
}

78 
	$’abË_šŒ_wšdow
(
vıu
 *
v
, 
hvm_šck
 
šck
)

80 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

81 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

82 
všŒ_t
 
šŒ
;

84 
	`ASSERT
(
šck
.
sourû
 !ğ
hvm_št¤c_nÚe
);

86 
	`HVMTRACE_3D
(
INTR_WINDOW
, 
šck
.
veùÜ
, iÁack.
sourû
,

87 
vmcb
->
ev’tšj
.
f›lds
.
v
?vmcb->ev’tšj.f›lds.
veùÜ
:-1);

105 iàĞ(
šck
.
sourû
 =ğ
hvm_št¤c_nmi
) &&

106 (
g’”®1_š‹rû±s
 & 
GENERAL1_INTERCEPT_IRET
) )

109 
šŒ
 = 
	`vmcb_g‘_všŒ
(
vmcb
);

110 
šŒ
.
f›lds
.
œq
 = 1;

111 
šŒ
.
f›lds
.
veùÜ
 = 0;

112 
šŒ
.
f›lds
.
´io
 = 
šck
.
veùÜ
 >> 4;

113 
šŒ
.
f›lds
.
ign_r
 = (
šck
.
sourû
 !ğ
hvm_št¤c_Ïpic
);

114 
	`vmcb_£t_všŒ
(
vmcb
, 
šŒ
);

115 
	`vmcb_£t_g’”®1_š‹rû±s
(

116 
vmcb
, 
g’”®1_š‹rû±s
 | 
GENERAL1_INTERCEPT_VINTR
);

117 
	}
}

119 
asmlškage
 
	$svm_šŒ_assi¡
()

121 
vıu
 *
v
 = 
cu¼’t
;

122 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

123 
hvm_šck
 
šck
;

126 
	`±_upd©e_œq
(
v
);

129 
šck
 = 
	`hvm_vıu_has_³ndšg_œq
(
v
);

130 iàĞ
	`lik–y
(
šck
.
sourû
 =ğ
hvm_št¤c_nÚe
) )

147 iàĞ
	`uÆik–y
(
vmcb
->
ev’tšj
.
f›lds
.
v
) ||

148 
	`hvm_š‹¼u±_blocked
(
v
, 
šck
) )

150 
	`’abË_šŒ_wšdow
(
v
, 
šck
);

154 
šck
 = 
	`hvm_vıu_ack_³ndšg_œq
(
v
, intack);

155 }  
šck
.
sourû
 =ğ
hvm_št¤c_nÚe
 );

157 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_nmi
 )

159 
	`svm_šjeù_nmi
(
v
);

163 
	`HVMTRACE_2D
(
INJ_VIRQ
, 
šck
.
veùÜ
, 0);

164 
	`svm_šjeù_extšt
(
v
, 
šck
.
veùÜ
);

165 
	`±_šŒ_po¡
(
v
, 
šck
);

169 
šck
 = 
	`hvm_vıu_has_³ndšg_œq
(
v
);

170 iàĞ
	`uÆik–y
(
šck
.
sourû
 !ğ
hvm_št¤c_nÚe
) )

171 
	`’abË_šŒ_wšdow
(
v
, 
šck
);

172 
	}
}

	@hvm/svm/svm.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/š™.h
>

22 
	~<x’/lib.h
>

23 
	~<x’/Œaû.h
>

24 
	~<x’/sched.h
>

25 
	~<x’/œq.h
>

26 
	~<x’/soáœq.h
>

27 
	~<x’/hy³rÿÎ.h
>

28 
	~<x’/domaš_·ge.h
>

29 
	~<asm/cu¼’t.h
>

30 
	~<asm/io.h
>

31 
	~<asm/·gšg.h
>

32 
	~<asm/p2m.h
>

33 
	~<asm/mem_sh¬šg.h
>

34 
	~<asm/»gs.h
>

35 
	~<asm/ıuã©u».h
>

36 
	~<asm/´oûssÜ.h
>

37 
	~<asm/amd.h
>

38 
	~<asm/ty³s.h
>

39 
	~<asm/debug»g.h
>

40 
	~<asm/m¤.h
>

41 
	~<asm/¥šlock.h
>

42 
	~<asm/hvm/emuÏ‹.h
>

43 
	~<asm/hvm/hvm.h
>

44 
	~<asm/hvm/suµÜt.h
>

45 
	~<asm/hvm/io.h
>

46 
	~<asm/hvm/emuÏ‹.h
>

47 
	~<asm/hvm/svm/asid.h
>

48 
	~<asm/hvm/svm/svm.h
>

49 
	~<asm/hvm/svm/vmcb.h
>

50 
	~<asm/hvm/svm/emuÏ‹.h
>

51 
	~<asm/hvm/svm/šŒ.h
>

52 
	~<asm/x86_emuÏ‹.h
>

53 
	~<public/sched.h
>

54 
	~<asm/hvm/v±.h
>

55 
	~<asm/hvm/Œaû.h
>

56 
	~<asm/h­.h
>

57 
	~<asm/­ic.h
>

58 
	~<asm/debugg”.h
>

60 
u32
 
	gsvm_ã©u»_æags
;

63 
boŞ_t
 
	gıu_has_lm¦
;

65 
	#£t_£gm’t_»gi¡”
(
Çme
, 
v®ue
) \

66 
asm
 vŞ©Ğ"movw %%ax ,%%" 
	`STR
(
Çme
è"" : : "a" (
v®ue
è)

	)

68 
hvm_funùiÚ_bË
 
	gsvm_funùiÚ_bË
;

71 
DEFINE_PER_CPU_READ_MOSTLY
(*, 
h§
);

74 
DEFINE_PER_CPU_READ_MOSTLY
(*, 
roÙ_vmcb
);

76 
boŞ_t
 
amd_”¿tum383_found
 
	g__»ad_mo¡ly
;

78 
šlše
 
	$__upd©e_gue¡_e
(

79 
ıu_u£r_»gs
 *
»gs
, 
š¡_Ën
)

81 
vıu
 *
cu¼
 = 
cu¼’t
;

83 iàĞ
	`uÆik–y
(
š¡_Ën
 == 0) )

86 iàĞ
	`uÆik–y
(
š¡_Ën
 > 15) )

88 
	`gd´štk
(
XENLOG_ERR
, "Bad in¡ruùiÚ†’gth %u\n", 
š¡_Ën
);

89 
	`domaš_üash
(
cu¼
->
domaš
);

93 
	`ASSERT
(
»gs
 =ğ
	`gue¡_ıu_u£r_»gs
());

95 
»gs
->
e
 +ğ
š¡_Ën
;

96 
»gs
->
eæags
 &ğ~
X86_EFLAGS_RF
;

98 
cu¼
->
¬ch
.
hvm_svm
.
vmcb
->
š‹¼u±_shadow
 = 0;

100 iàĞ
»gs
->
eæags
 & 
X86_EFLAGS_TF
 )

101 
	`hvm_šjeù_exû±iÚ
(
TRAP_debug
, 
HVM_DELIVER_NO_ERROR_CODE
, 0);

102 
	}
}

104 
	$svm_ıu_down
()

106 
	`wr™e_eãr
(
	`»ad_eãr
(è& ~
EFER_SVME
);

107 
	}
}

109 
	$svm_§ve_dr
(
vıu
 *
v
)

111 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

113 iàĞ!
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 )

117 
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 = 0;

118 
	`vmcb_£t_dr_š‹rû±s
(
vmcb
, ~0u);

120 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0] = 
	`»ad_debug»g
(0);

121 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1] = 
	`»ad_debug»g
(1);

122 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2] = 
	`»ad_debug»g
(2);

123 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3] = 
	`»ad_debug»g
(3);

124 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6] = 
	`vmcb_g‘_dr6
(
vmcb
);

125 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] = 
	`vmcb_g‘_dr7
(
vmcb
);

126 
	}
}

128 
	$__»¡Üe_debug_»gi¡”s
(
vıu
 *
v
)

130 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

132 iàĞ
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 )

135 
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 = 1;

136 
	`vmcb_£t_dr_š‹rû±s
(
vmcb
, 0);

138 
	`wr™e_debug»g
(0, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0]);

139 
	`wr™e_debug»g
(1, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1]);

140 
	`wr™e_debug»g
(2, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2]);

141 
	`wr™e_debug»g
(3, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3]);

142 
	`vmcb_£t_dr6
(
vmcb
, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6]);

143 
	`vmcb_£t_dr7
(
vmcb
, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7]);

144 
	}
}

152 
	$svm_»¡Üe_dr
(
vıu
 *
v
)

154 iàĞ
	`uÆik–y
(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] & 
DR7_ACTIVE_MASK
) )

155 
	`__»¡Üe_debug_»gi¡”s
(
v
);

156 
	}
}

158 
	$svm_vmcb_§ve
(
vıu
 *
v
, 
hvm_hw_ıu
 *
c
)

160 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

162 
c
->
ü0
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

163 
c
->
ü2
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2];

164 
c
->
ü3
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

165 
c
->
ü4
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

167 
c
->
sy£Á”_cs
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_cs
;

168 
c
->
sy£Á”_e¥
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e¥
;

169 
c
->
sy£Á”_e
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e
;

171 
c
->
³ndšg_ev’t
 = 0;

172 
c
->
”rÜ_code
 = 0;

173 iàĞ
vmcb
->
ev’tšj
.
f›lds
.
v
 &&

174 
	`hvm_ev’t_Ãeds_»šjeùiÚ
(
vmcb
->
ev’tšj
.
f›lds
.
ty³
,

175 
vmcb
->
ev’tšj
.
f›lds
.
veùÜ
) )

177 
c
->
³ndšg_ev’t
 = (
ušt32_t
)
vmcb
->
ev’tšj
.
by‹s
;

178 
c
->
”rÜ_code
 = 
vmcb
->
ev’tšj
.
f›lds
.
”rÜcode
;

182 
	}
}

184 
	$svm_vmcb_»¡Üe
(
vıu
 *
v
, 
hvm_hw_ıu
 *
c
)

186 
mâ
 = 0;

187 
p2m_ty³_t
 
p2mt
;

188 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

189 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

191 iàĞ
c
->
³ndšg_v®id
 &&

192 ((
c
->
³ndšg_ty³
 == 1) || (c->pending_type > 6) ||

193 (
c
->
³ndšg_»£rved
 != 0)) )

195 
	`gd´štk
(
XENLOG_ERR
, "Inv®id…’dšgƒv’ˆ0x%"
PRIx32
".\n",

196 
c
->
³ndšg_ev’t
);

197  -
EINVAL
;

200 iàĞ!
	`·gšg_mode_h­
(
v
->
domaš
) )

202 iàĞ
c
->
ü0
 & 
X86_CR0_PG
 )

204 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
p2m
, 
c
->
ü3
 >> 
PAGE_SHIFT
, &
p2mt
));

205 iàĞ!
	`p2m_is_¿m
(
p2mt
è|| !
	`g‘_·ge
(
	`mâ_to_·ge
(
mâ
), 
v
->
domaš
) )

207 
	`gd´štk
(
XENLOG_ERR
, "Inv®id CR3 v®ue=0x%"
PRIx64
"\n",

208 
c
->
ü3
);

209  -
EINVAL
;

213 iàĞ
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PG
 )

214 
	`put_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

216 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
mâ
);

219 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
c
->
ü0
 | 
X86_CR0_ET
;

220 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
c
->
ü2
;

221 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = 
c
->
ü3
;

222 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 
c
->
ü4
;

223 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

224 
	`hvm_upd©e_gue¡_ü
(
v
, 2);

225 
	`hvm_upd©e_gue¡_ü
(
v
, 4);

228 
vmcb
->
sy£Á”_cs
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_cs
 = 
c
->sysenter_cs;

229 
vmcb
->
sy£Á”_e¥
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e¥
 = 
c
->sysenter_esp;

230 
vmcb
->
sy£Á”_e
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e
 = 
c
->sysenter_eip;

232 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

234 
	`vmcb_£t_Å_’abË
(
vmcb
, 1);

235 
	`vmcb_£t_g_·t
(
vmcb
, 
MSR_IA32_CR_PAT_RESET
 );

236 
	`vmcb_£t_h_ü3
(
vmcb
, 
	`·g‘abË_g‘_·ddr
(
	`p2m_g‘_·g‘abË
(
p2m
)));

239 iàĞ
c
->
³ndšg_v®id
 )

241 
	`gd´štk
(
XENLOG_INFO
, "Re-šjeùšg 0x%"
PRIx32
", 0x%"PRIx32"\n",

242 
c
->
³ndšg_ev’t
, c->
”rÜ_code
);

244 iàĞ
	`hvm_ev’t_Ãeds_»šjeùiÚ
(
c
->
³ndšg_ty³
, c->
³ndšg_veùÜ
) )

246 
vmcb
->
ev’tšj
.
by‹s
 = 
c
->
³ndšg_ev’t
;

247 
vmcb
->
ev’tšj
.
f›lds
.
”rÜcode
 = 
c
->
”rÜ_code
;

251 
vmcb
->
ş—nb™s
.
by‹s
 = 0;

252 
	`·gšg_upd©e_·gšg_modes
(
v
);

255 
	}
}

258 
	$svm_§ve_ıu_¡©e
(
vıu
 *
v
, 
hvm_hw_ıu
 *
d©a
)

260 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

262 
d©a
->
shadow_gs
 = 
vmcb
->
k”ngsba£
;

263 
d©a
->
m¤_l¡¬
 = 
vmcb
->
l¡¬
;

264 
d©a
->
m¤_¡¬
 = 
vmcb
->
¡¬
;

265 
d©a
->
m¤_c¡¬
 = 
vmcb
->
c¡¬
;

266 
d©a
->
m¤_sysÿÎ_mask
 = 
vmcb
->
sfmask
;

267 
d©a
->
m¤_eãr
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
;

268 
d©a
->
m¤_æags
 = -1ULL;

270 
d©a
->
tsc
 = 
	`hvm_g‘_gue¡_tsc
(
v
);

271 
	}
}

274 
	$svm_lßd_ıu_¡©e
(
vıu
 *
v
, 
hvm_hw_ıu
 *
d©a
)

276 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

278 
vmcb
->
k”ngsba£
 = 
d©a
->
shadow_gs
;

279 
vmcb
->
l¡¬
 = 
d©a
->
m¤_l¡¬
;

280 
vmcb
->
¡¬
 = 
d©a
->
m¤_¡¬
;

281 
vmcb
->
c¡¬
 = 
d©a
->
m¤_c¡¬
;

282 
vmcb
->
sfmask
 = 
d©a
->
m¤_sysÿÎ_mask
;

283 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 = 
d©a
->
m¤_eãr
;

284 
	`hvm_upd©e_gue¡_eãr
(
v
);

286 
	`hvm_£t_gue¡_tsc
(
v
, 
d©a
->
tsc
);

287 
	}
}

289 
	$svm_§ve_vmcb_ùxt
(
vıu
 *
v
, 
hvm_hw_ıu
 *
ùxt
)

291 
	`svm_§ve_ıu_¡©e
(
v
, 
ùxt
);

292 
	`svm_vmcb_§ve
(
v
, 
ùxt
);

293 
	}
}

295 
	$svm_lßd_vmcb_ùxt
(
vıu
 *
v
, 
hvm_hw_ıu
 *
ùxt
)

297 
	`svm_lßd_ıu_¡©e
(
v
, 
ùxt
);

298 ià(
	`svm_vmcb_»¡Üe
(
v
, 
ùxt
)) {

299 
	`´štk
("svm_vmcb„estore failed!\n");

300 
	`domaš_üash
(
v
->
domaš
);

301  -
EINVAL
;

305 
	}
}

307 
	$svm_åu_’‹r
(
vıu
 *
v
)

309 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

311 
	`£tup_åu
(
v
);

312 
	`vmcb_£t_exû±iÚ_š‹rû±s
(

313 
vmcb
, 
	`vmcb_g‘_exû±iÚ_š‹rû±s
(vmcbè& ~(1U << 
TRAP_no_deviû
));

314 
	}
}

316 
	$svm_åu_Ëave
(
vıu
 *
v
)

318 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

320 
	`ASSERT
(!
v
->
åu_dœt›d
);

321 
	`ASSERT
(
	`»ad_ü0
(è& 
X86_CR0_TS
);

329 iàĞ!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

331 
	`vmcb_£t_exû±iÚ_š‹rû±s
(

332 
vmcb
,

333 
	`vmcb_g‘_exû±iÚ_š‹rû±s
(
vmcb
è| (1U << 
TRAP_no_deviû
));

334 
	`vmcb_£t_ü0
(
vmcb
, 
	`vmcb_g‘_ü0
(vmcbè| 
X86_CR0_TS
);

336 
	}
}

338 
	$svm_g‘_š‹¼u±_shadow
(
vıu
 *
v
)

340 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

341 
šŒ_shadow
 = 0;

343 iàĞ
vmcb
->
š‹¼u±_shadow
 )

344 
šŒ_shadow
 |ğ
HVM_INTR_SHADOW_MOV_SS
 | 
HVM_INTR_SHADOW_STI
;

346 iàĞ
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
è& 
GENERAL1_INTERCEPT_IRET
 )

347 
šŒ_shadow
 |ğ
HVM_INTR_SHADOW_NMI
;

349  
šŒ_shadow
;

350 
	}
}

352 
	$svm_£t_š‹¼u±_shadow
(
vıu
 *
v
, 
šŒ_shadow
)

354 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

355 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

357 
vmcb
->
š‹¼u±_shadow
 =

358 !!(
šŒ_shadow
 & (
HVM_INTR_SHADOW_MOV_SS
|
HVM_INTR_SHADOW_STI
));

360 
g’”®1_š‹rû±s
 &ğ~
GENERAL1_INTERCEPT_IRET
;

361 iàĞ
šŒ_shadow
 & 
HVM_INTR_SHADOW_NMI
 )

362 
g’”®1_š‹rû±s
 |ğ
GENERAL1_INTERCEPT_IRET
;

363 
	`vmcb_£t_g’”®1_š‹rû±s
(
vmcb
, 
g’”®1_š‹rû±s
);

364 
	}
}

366 
	$svm_gue¡_x86_mode
(
vıu
 *
v
)

368 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

370 iàĞ
	`uÆik–y
(!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
)) )

372 iàĞ
	`uÆik–y
(
	`gue¡_ıu_u£r_»gs
()->
eæags
 & 
X86_EFLAGS_VM
) )

374 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
è&& 
	`lik–y
(
vmcb
->
cs
.
©Œ
.
f›lds
.
l
) )

376  (
	`lik–y
(
vmcb
->
cs
.
©Œ
.
f›lds
.
db
) ? 4 : 2);

377 
	}
}

379 
	$svm_upd©e_ho¡_ü3
(
vıu
 *
v
)

382 
	}
}

384 
	$svm_upd©e_gue¡_ü
(
vıu
 *
v
, 
ü
)

386 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

387 
ušt64_t
 
v®ue
;

389  
ü
 )

392 
hw_ü0_mask
 = 0;

394 iàĞ!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

396 iàĞ
v
 !ğ
cu¼’t
 )

397 
hw_ü0_mask
 |ğ
X86_CR0_TS
;

398 iàĞ
	`vmcb_g‘_ü0
(
vmcb
è& 
X86_CR0_TS
 )

399 
	`svm_åu_’‹r
(
v
);

402 
v®ue
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] | 
hw_ü0_mask
;

403 iàĞ!
	`·gšg_mode_h­
(
v
->
domaš
) )

404 
v®ue
 |ğ
X86_CR0_PG
 | 
X86_CR0_WP
;

405 
	`vmcb_£t_ü0
(
vmcb
, 
v®ue
);

409 
	`vmcb_£t_ü2
(
vmcb
, 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2]);

412 
	`vmcb_£t_ü3
(
vmcb
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3]);

413 
	`hvm_asid_æush_vıu
(
v
);

416 
v®ue
 = 
HVM_CR4_HOST_MASK
;

417 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

418 
v®ue
 &ğ~
X86_CR4_PAE
;

419 
v®ue
 |ğ
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

420 
	`vmcb_£t_ü4
(
vmcb
, 
v®ue
);

423 
	`BUG
();

425 
	}
}

427 
	$svm_upd©e_gue¡_eãr
(
vıu
 *
v
)

429 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

430 
boŞ_t
 
lma
 = !!(
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_LMA
);

431 
ušt64_t
 
Ãw_eãr
;

433 
Ãw_eãr
 = (
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 | 
EFER_SVME
è& ~
EFER_LME
;

434 iàĞ
lma
 )

435 
Ãw_eãr
 |ğ
EFER_LME
;

436 
	`vmcb_£t_eãr
(
vmcb
, 
Ãw_eãr
);

437 
	}
}

439 
	$svm_sync_vmcb
(
vıu
 *
v
)

441 
¬ch_svm_¡ruù
 *
¬ch_svm
 = &
v
->
¬ch
.
hvm_svm
;

443 iàĞ
¬ch_svm
->
vmcb_š_sync
 )

446 
¬ch_svm
->
vmcb_š_sync
 = 1;

448 
	`svm_vm§ve
(
¬ch_svm
->
vmcb
);

449 
	}
}

451 
	$svm_g‘_£gm’t_»gi¡”
(
vıu
 *
v
, 
x86_£gm’t
 
£g
,

452 
£gm’t_»gi¡”
 *
»g
)

454 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

456 
	`ASSERT
((
v
 =ğ
cu¼’t
è|| !
	`vıu_ruÂabË
(v));

458  
£g
 )

460 
x86_£g_cs
:

461 
	`memıy
(
»g
, &
vmcb
->
cs
, (*reg));

462 
»g
->
©Œ
.
f›lds
.
g
 =„eg->
lim™
 > 0xFFFFF;

464 
x86_£g_ds
:

465 
	`memıy
(
»g
, &
vmcb
->
ds
, (*reg));

466 iàĞ
»g
->
©Œ
.
f›lds
.
ty³
 != 0 )

467 
»g
->
©Œ
.
f›lds
.
ty³
 |= 0x1;

469 
x86_£g_es
:

470 
	`memıy
(
»g
, &
vmcb
->
es
, (*reg));

471 iàĞ
»g
->
©Œ
.
f›lds
.
ty³
 != 0 )

472 
»g
->
©Œ
.
f›lds
.
ty³
 |= 0x1;

474 
x86_£g_fs
:

475 
	`svm_sync_vmcb
(
v
);

476 
	`memıy
(
»g
, &
vmcb
->
fs
, (*reg));

477 iàĞ
»g
->
©Œ
.
f›lds
.
ty³
 != 0 )

478 
»g
->
©Œ
.
f›lds
.
ty³
 |= 0x1;

480 
x86_£g_gs
:

481 
	`svm_sync_vmcb
(
v
);

482 
	`memıy
(
»g
, &
vmcb
->
gs
, (*reg));

483 iàĞ
»g
->
©Œ
.
f›lds
.
ty³
 != 0 )

484 
»g
->
©Œ
.
f›lds
.
ty³
 |= 0x1;

486 
x86_£g_ss
:

487 
	`memıy
(
»g
, &
vmcb
->
ss
, (*reg));

488 
»g
->
©Œ
.
f›lds
.
d¶
 = 
vmcb
->
_ıl
;

489 iàĞ
»g
->
©Œ
.
f›lds
.
ty³
 == 0 )

490 
»g
->
©Œ
.
f›lds
.
db
 = 0;

492 
x86_£g_Œ
:

493 
	`svm_sync_vmcb
(
v
);

494 
	`memıy
(
»g
, &
vmcb
->
Œ
, (*reg));

495 
»g
->
©Œ
.
f›lds
.
ty³
 |= 0x2;

497 
x86_£g_gdŒ
:

498 
	`memıy
(
»g
, &
vmcb
->
gdŒ
, (*reg));

500 
x86_£g_idŒ
:

501 
	`memıy
(
»g
, &
vmcb
->
idŒ
, (*reg));

503 
x86_£g_ldŒ
:

504 
	`svm_sync_vmcb
(
v
);

505 
	`memıy
(
»g
, &
vmcb
->
ldŒ
, (*reg));

508 
	`BUG
();

510 
	}
}

512 
	$svm_£t_£gm’t_»gi¡”
(
vıu
 *
v
, 
x86_£gm’t
 
£g
,

513 
£gm’t_»gi¡”
 *
»g
)

515 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

516 
sync
 = 0;

518 
	`ASSERT
((
v
 =ğ
cu¼’t
è|| !
	`vıu_ruÂabË
(v));

520  
£g
 )

522 
x86_£g_cs
:

523 
x86_£g_ds
:

524 
x86_£g_es
:

525 
x86_£g_ss
:

526 
vmcb
->
ş—nb™s
.
f›lds
.
£g
 = 0;

528 
x86_£g_gdŒ
:

529 
x86_£g_idŒ
:

530 
vmcb
->
ş—nb™s
.
f›lds
.
dt
 = 0;

532 
x86_£g_fs
:

533 
x86_£g_gs
:

534 
x86_£g_Œ
:

535 
x86_£g_ldŒ
:

536 
sync
 = (
v
 =ğ
cu¼’t
);

542 iàĞ
sync
 )

543 
	`svm_sync_vmcb
(
v
);

545  
£g
 )

547 
x86_£g_cs
:

548 
	`memıy
(&
vmcb
->
cs
, 
»g
, (*reg));

550 
x86_£g_ds
:

551 
	`memıy
(&
vmcb
->
ds
, 
»g
, (*reg));

553 
x86_£g_es
:

554 
	`memıy
(&
vmcb
->
es
, 
»g
, (*reg));

556 
x86_£g_fs
:

557 
	`memıy
(&
vmcb
->
fs
, 
»g
, (*reg));

559 
x86_£g_gs
:

560 
	`memıy
(&
vmcb
->
gs
, 
»g
, (*reg));

562 
x86_£g_ss
:

563 
	`memıy
(&
vmcb
->
ss
, 
»g
, (*reg));

564 
vmcb
->
_ıl
 = vmcb->
ss
.
©Œ
.
f›lds
.
d¶
;

566 
x86_£g_Œ
:

567 
	`memıy
(&
vmcb
->
Œ
, 
»g
, (*reg));

569 
x86_£g_gdŒ
:

570 
vmcb
->
gdŒ
.
ba£
 = 
»g
->base;

571 
vmcb
->
gdŒ
.
lim™
 = (
ušt16_t
)
»g
->limit;

573 
x86_£g_idŒ
:

574 
vmcb
->
idŒ
.
ba£
 = 
»g
->base;

575 
vmcb
->
idŒ
.
lim™
 = (
ušt16_t
)
»g
->limit;

577 
x86_£g_ldŒ
:

578 
	`memıy
(&
vmcb
->
ldŒ
, 
»g
, (*reg));

581 
	`BUG
();

584 iàĞ
sync
 )

585 
	`svm_vmlßd
(
vmcb
);

586 
	}
}

588 
	$svm_£t_tsc_off£t
(
vıu
 *
v
, 
u64
 
off£t
)

590 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

591 
	`vmcb_£t_tsc_off£t
(
vmcb
, 
off£t
);

592 
	}
}

594 
	$svm_£t_rdtsc_ex™šg
(
vıu
 *
v
, 
boŞ_t
 
’abË
)

596 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

597 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

599 
g’”®1_š‹rû±s
 &ğ~
GENERAL1_INTERCEPT_RDTSC
;

600 iàĞ
’abË
 )

601 
g’”®1_š‹rû±s
 |ğ
GENERAL1_INTERCEPT_RDTSC
;

603 
	`vmcb_£t_g’”®1_š‹rû±s
(
vmcb
, 
g’”®1_š‹rû±s
);

604 
	}
}

606 
	$svm_š™_hy³rÿÎ_·ge
(
domaš
 *
d
, *
hy³rÿÎ_·ge
)

608 *
p
;

609 
i
;

611  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

613 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

614 *(
u8
 *)(
p
 + 0) = 0xb8;

615 *(
u32
 *)(
p
 + 1èğ
i
;

616 *(
u8
 *)(
p
 + 5) = 0x0f;

617 *(
u8
 *)(
p
 + 6) = 0x01;

618 *(
u8
 *)(
p
 + 7) = 0xd9;

619 *(
u8
 *)(
p
 + 8) = 0xc3;

623 *(
u16
 *)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32)) = 0x0b0f;

624 
	}
}

626 
	$svm_ùxt_sw™ch_äom
(
vıu
 *
v
)

628 
ıu
 = 
	`smp_´oûssÜ_id
();

630 
	`svm_åu_Ëave
(
v
);

632 
	`svm_§ve_dr
(
v
);

633 
	`vpmu_§ve
(
v
);

635 
	`svm_sync_vmcb
(
v
);

636 
	`svm_vmlßd
(
	`³r_ıu
(
roÙ_vmcb
, 
ıu
));

638 #ifdeà
__x86_64__


640 
idt_bËs
[
ıu
][
TRAP_doubË_çuÉ
].
a
 |ğ
IST_DF
 << 32;

641 
idt_bËs
[
ıu
][
TRAP_nmi
].
a
 |ğ
IST_NMI
 << 32;

642 
idt_bËs
[
ıu
][
TRAP_machše_check
].
a
 |ğ
IST_MCE
 << 32;

644 
	}
}

646 
	$svm_ùxt_sw™ch_to
(
vıu
 *
v
)

648 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

649 
ıu
 = 
	`smp_´oûssÜ_id
();

651 #ifdeà 
__x86_64__


658 
	`£t_£gm’t_»gi¡”
(
ds
, 0);

659 
	`£t_£gm’t_»gi¡”
(
es
, 0);

660 
	`£t_£gm’t_»gi¡”
(
ss
, 0);

666 
idt_bËs
[
ıu
][
TRAP_doubË_çuÉ
].
a
 &= ~(7UL << 32);

667 
idt_bËs
[
ıu
][
TRAP_nmi
].
a
 &= ~(7UL << 32);

668 
idt_bËs
[
ıu
][
TRAP_machše_check
].
a
 &= ~(7UL << 32);

671 
	`svm_»¡Üe_dr
(
v
);

673 
	`svm_vm§ve
(
	`³r_ıu
(
roÙ_vmcb
, 
ıu
));

674 
	`svm_vmlßd
(
vmcb
);

675 
vmcb
->
ş—nb™s
.
by‹s
 = 0;

676 
	`vpmu_lßd
(
v
);

678 iàĞ
ıu_has_rdtsı
 )

679 
	`wrm¤l
(
MSR_TSC_AUX
, 
	`hvm_m¤_tsc_aux
(
v
));

680 
	}
}

682 
	$svm_do_»sume
(
vıu
 *
v
)

684 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

685 
boŞ_t
 
debug_¡©e
 = 
v
->
domaš
->
debugg”_©ched
;

686 
všŒ_t
 
šŒ
;

688 iàĞ
	`uÆik–y
(
v
->
¬ch
.
hvm_vıu
.
debug_¡©e_Ïtch
 !ğ
debug_¡©e
) )

690 
ušt32_t
 
š‹rû±s
 = 
	`vmcb_g‘_exû±iÚ_š‹rû±s
(
vmcb
);

691 
ušt32_t
 
mask
 = (1U << 
TRAP_debug
è| (1U << 
TRAP_št3
);

692 
v
->
¬ch
.
hvm_vıu
.
debug_¡©e_Ïtch
 = 
debug_¡©e
;

693 
	`vmcb_£t_exû±iÚ_š‹rû±s
(

694 
vmcb
, 
debug_¡©e
 ? (
š‹rû±s
 | 
mask
) : (intercepts & ~mask));

697 iàĞ
v
->
¬ch
.
hvm_svm
.
Ïunch_cÜe
 !ğ
	`smp_´oûssÜ_id
() )

699 
v
->
¬ch
.
hvm_svm
.
Ïunch_cÜe
 = 
	`smp_´oûssÜ_id
();

700 
	`hvm_mig¿‹_tim”s
(
v
);

701 
	`hvm_mig¿‹_pœqs
(
v
);

703 
	`hvm_asid_æush_vıu
(
v
);

707 
šŒ
 = 
	`vmcb_g‘_všŒ
(
vmcb
);

708 
šŒ
.
f›lds
.
r
 =

709 (
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
) & 0xFF) >> 4;

710 
	`vmcb_£t_všŒ
(
vmcb
, 
šŒ
);

712 
	`hvm_do_»sume
(
v
);

713 
	`»£t_¡ack_ªd_jump
(
svm_asm_do_»sume
);

714 
	}
}

716 
	$svm_domaš_š™Ÿli£
(
domaš
 *
d
)

719 
	}
}

721 
	$svm_domaš_de¡roy
(
domaš
 *
d
)

723 
	}
}

725 
	$svm_vıu_š™Ÿli£
(
vıu
 *
v
)

727 
rc
;

729 
v
->
¬ch
.
scheduË_
 = 
svm_do_»sume
;

730 
v
->
¬ch
.
ùxt_sw™ch_äom
 = 
svm_ùxt_sw™ch_äom
;

731 
v
->
¬ch
.
ùxt_sw™ch_to
 = 
svm_ùxt_sw™ch_to
;

733 
v
->
¬ch
.
hvm_svm
.
Ïunch_cÜe
 = -1;

735 iàĞ(
rc
 = 
	`svm_ü—‹_vmcb
(
v
)) != 0 )

737 
	`d´štk
(
XENLOG_WARNING
,

739 
v
->
vıu_id
, 
rc
);

740  
rc
;

743 
	`vpmu_š™Ÿli£
(
v
);

745 
	}
}

747 
	$svm_vıu_de¡roy
(
vıu
 *
v
)

749 
	`svm_de¡roy_vmcb
(
v
);

750 
	`vpmu_de¡roy
(
v
);

751 
	`·ssive_domaš_de¡roy
(
v
);

752 
	}
}

754 
	$svm_šjeù_exû±iÚ
(

755 
Œ­Ä
, 
”rcode
, 
ü2
)

757 
vıu
 *
cu¼
 = 
cu¼’t
;

758 
vmcb_¡ruù
 *
vmcb
 = 
cu¼
->
¬ch
.
hvm_svm
.vmcb;

759 
ev’tšj_t
 
ev’t
 = 
vmcb
->
ev’tšj
;

761  
Œ­Ä
 )

763 
TRAP_debug
:

764 iàĞ
	`gue¡_ıu_u£r_»gs
()->
eæags
 & 
X86_EFLAGS_TF
 )

766 
	`__»¡Üe_debug_»gi¡”s
(
cu¼
);

767 
	`vmcb_£t_dr6
(
vmcb
, 
	`vmcb_g‘_dr6
(vmcb) | 0x4000);

769 
TRAP_št3
:

770 iàĞ
cu¼
->
domaš
->
debugg”_©ched
 )

773 
	`domaš_·u£_fÜ_debugg”
();

778 iàĞ
	`uÆik–y
(
ev’t
.
f›lds
.
v
) &&

779 (
ev’t
.
f›lds
.
ty³
 =ğ
X86_EVENTTYPE_HW_EXCEPTION
) )

781 
Œ­Ä
 = 
	`hvm_combše_hw_exû±iÚs
(
ev’t
.
f›lds
.
veùÜ
,rapnr);

782 iàĞ
Œ­Ä
 =ğ
TRAP_doubË_çuÉ
 )

783 
”rcode
 = 0;

786 
ev’t
.
by‹s
 = 0;

787 
ev’t
.
f›lds
.
v
 = 1;

788 
ev’t
.
f›lds
.
ty³
 = 
X86_EVENTTYPE_HW_EXCEPTION
;

789 
ev’t
.
f›lds
.
veùÜ
 = 
Œ­Ä
;

790 
ev’t
.
f›lds
.
ev
 = (
”rcode
 !ğ
HVM_DELIVER_NO_ERROR_CODE
);

791 
ev’t
.
f›lds
.
”rÜcode
 = 
”rcode
;

793 
vmcb
->
ev’tšj
 = 
ev’t
;

795 iàĞ
Œ­Ä
 =ğ
TRAP_·ge_çuÉ
 )

797 
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
ü2
;

798 
	`vmcb_£t_ü2
(
vmcb
, 
ü2
);

799 
	`HVMTRACE_LONG_2D
(
PF_INJECT
, 
”rcode
, 
	`TRC_PAR_LONG
(
ü2
));

803 
	`HVMTRACE_2D
(
INJ_EXC
, 
Œ­Ä
, 
”rcode
);

805 
	}
}

807 
	$svm_ev’t_³ndšg
(
vıu
 *
v
)

809 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

810  
vmcb
->
ev’tšj
.
f›lds
.
v
;

811 
	}
}

813 
	$svm_do_pmu_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

815  
	`vpmu_do_š‹¼u±
(
»gs
);

816 
	}
}

818 
	$svm_ıu_d—d
(
ıu
)

820 
	`ä“_x’h—p_·ge
(
	`³r_ıu
(
h§
, 
ıu
));

821 
	`³r_ıu
(
h§
, 
ıu
èğ
NULL
;

822 
	`ä“_vmcb
(
	`³r_ıu
(
roÙ_vmcb
, 
ıu
));

823 
	`³r_ıu
(
roÙ_vmcb
, 
ıu
èğ
NULL
;

824 
	}
}

826 
	$svm_ıu_up_´•¬e
(
ıu
)

828 iàĞ((
	`³r_ıu
(
h§
, 
ıu
è=ğ
NULL
) &&

829 ((
	`³r_ıu
(
h§
, 
ıu
èğ
	`®loc_ho¡_§ve_¬—
()è=ğ
NULL
)) ||

830 ((
	`³r_ıu
(
roÙ_vmcb
, 
ıu
è=ğ
NULL
) &&

831 ((
	`³r_ıu
(
roÙ_vmcb
, 
ıu
èğ
	`®loc_vmcb
()è=ğ
NULL
)) )

833 
	`svm_ıu_d—d
(
ıu
);

834  -
ENOMEM
;

838 
	}
}

840 
	$svm_š™_”¿tum_383
(
ıušfo_x86
 *
c
)

842 
ušt64_t
 
m¤_cÚ‹Á
;

845 iàĞ!
	`ıu_has_amd_”¿tum
(
c
, 
AMD_ERRATUM_383
) )

849 ià(
	`rdm¤_§ã
(
MSR_AMD64_DC_CFG
, 
m¤_cÚ‹Á
) == 0 &&

850 
	`wrm¤_§ã
(
MSR_AMD64_DC_CFG
, 
m¤_cÚ‹Á
 | (1ULL << 47)) == 0)

852 
amd_”¿tum383_found
 = 1;

854 
	`´štk
("Failedoƒnableƒrratum 383\n");

856 
	}
}

858 
	$svm_ıu_up
()

860 
ušt64_t
 
m¤_cÚ‹Á
;

861 
rc
, 
ıu
 = 
	`smp_´oûssÜ_id
();

862 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
ıu
];

865 
	`rdm¤l
(
MSR_K8_VM_CR
, 
m¤_cÚ‹Á
);

866 iàĞ
m¤_cÚ‹Á
 & 
K8_VMCR_SVME_DISABLE
 )

868 
	`´štk
("CPU%d: AMD SVM Ex‹nsiÚ i di§bËd iÀBIOS.\n", 
ıu
);

869  -
EINVAL
;

872 iàĞ(
rc
 = 
	`svm_ıu_up_´•¬e
(
ıu
)) != 0 )

873  
rc
;

875 
	`wr™e_eãr
(
	`»ad_eãr
(è| 
EFER_SVME
);

878 
	`wrm¤l
(
MSR_K8_VM_HSAVE_PA
, (
ušt64_t
)
	`vœt_to_maddr
(
	`³r_ıu
(
h§
, 
ıu
)));

881 
	`svm_š™_”¿tum_383
(
c
);

884 
	`svm_asid_š™
(
c
);

886 #ifdeà
__x86_64__


891 
m¤_cÚ‹Á
 = 
	`»ad_eãr
();

892 iàĞ
	`wrm¤_§ã
(
MSR_EFER
, 
m¤_cÚ‹Á
 | 
EFER_LMSLE
) == 0 )

893 
	`rdm¤l
(
MSR_EFER
, 
m¤_cÚ‹Á
);

894 iàĞ
m¤_cÚ‹Á
 & 
EFER_LMSLE
 )

896 iàĞ
c
 =ğ&
boÙ_ıu_d©a
 )

897 
ıu_has_lm¦
 = 1;

898 
	`wrm¤l
(
MSR_EFER
, 
m¤_cÚ‹Á
 ^ 
EFER_LMSLE
);

902 iàĞ
ıu_has_lm¦
 )

903 
	`´štk
(
XENLOG_WARNING
 "Inconsistent LMSLE support‡cross CPUs!\n");

904 
ıu_has_lm¦
 = 0;

909 
	}
}

911 
hvm_funùiÚ_bË
 * 
__š™
 
	$¡¬t_svm
()

913 
boŞ_t
 
´š‹d
 = 0;

915 iàĞ!
	`‹¡_b™
(
X86_FEATURE_SVM
, &
boÙ_ıu_d©a
.
x86_ÿ·b™y
) )

916  
NULL
;

918 iàĞ
	`svm_ıu_up
() )

920 
	`´štk
("SVM: failedo initialise.\n");

921  
NULL
;

924 
	`£tup_vmcb_dump
();

926 
svm_ã©u»_æags
 = ((
	`ıuid_—x
(0x80000000) >= 0x8000000A) ?

927 
	`ıuid_edx
(0x8000000A) : 0);

929 
	`´štk
("SVM: Supported‡dvanced features:\n");

931 
	#P
(
p
,
s
èiàĞ°è{ 
	`´štk
(" - %s\n", s); 
´š‹d
 = 1; }

	)

932 
	`P
(
ıu_has_svm_Åt
, "Nested Page Tables (NPT)");

933 
	`P
(
ıu_has_svm_lbrv
, "Last Branch Record (LBR) Virtualisation");

934 
	`P
(
ıu_has_svm_Äs
, "Next-RIP Saved on #VMEXIT");

935 
	`P
(
ıu_has_svm_ş—nb™s
, "VMCB Clean Bits");

936 
	`P
(
ıu_has_·u£_f‹r
, "Pause-Intercept Filter");

937 #undeà
P


939 iàĞ!
´š‹d
 )

940 
	`´štk
(" -‚one\n");

942 
svm_funùiÚ_bË
.
h­_suµÜ‹d
 = 
ıu_has_svm_Åt
;

943 
svm_funùiÚ_bË
.
h­_ÿ·b™›s
 = 
HVM_HAP_SUPERPAGE_2MB
 |

944 (((
CONFIG_PAGING_LEVELS
 =ğ4è&& (
	`ıuid_edx
(0x80000001) & 0x04000000)) ?

945 
HVM_HAP_SUPERPAGE_1GB
 : 0);

947  &
svm_funùiÚ_bË
;

948 
	}
}

950 
	$svm_do_Ã¡ed_pgçuÉ
(
·ddr_t
 
g·
)

952 
gâ
 = 
g·
 >> 
PAGE_SHIFT
;

953 
mâ_t
 
mâ
;

954 
p2m_ty³_t
 
p2mt
;

955 
p2m_domaš
 *
p2m
;

957 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
);

959 iàĞ
tb_š™_dÚe
 )

962 
ušt64_t
 
g·
;

963 
ušt64_t
 
mâ
;

964 
u32
 
qu®ifiÿtiÚ
;

965 
u32
 
p2mt
;

966 } 
_d
;

968 
_d
.
g·
 = gpa;

969 
_d
.
qu®ifiÿtiÚ
 = 0;

970 
_d
.
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &_d.
p2mt
));

972 
	`__Œaû_v¬
(
TRC_HVM_NPF
, 0, (
_d
), &_d);

975 iàĞ
	`hvm_h­_Ã¡ed_·ge_çuÉ
(
g·
, 0, ~0ul, 0, 0, 0, 0) )

979 
mâ
 = 
	`gâ_to_mâ_gue¡
(
p2m
, 
gâ
, &
p2mt
);

980 
	`gd´štk
(
XENLOG_ERR
, "SVM viŞ©iÚ g· %#"
PRI·ddr
", mfn %#lx,ype %i\n",

981 
g·
, 
	`mâ_x
(
mâ
), 
p2mt
);

982 
	`domaš_üash
(
cu¼’t
->
domaš
);

983 
	}
}

985 
	$svm_åu_dœty_š‹rû±
()

987 
vıu
 *
cu¼
 = 
cu¼’t
;

988 
vmcb_¡ruù
 *
vmcb
 = 
cu¼
->
¬ch
.
hvm_svm
.vmcb;

990 
	`svm_åu_’‹r
(
cu¼
);

992 iàĞ!(
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

993 
	`vmcb_£t_ü0
(
vmcb
, 
	`vmcb_g‘_ü0
(vmcbè& ~
X86_CR0_TS
);

994 
	}
}

996 
	$svm_ıuid_š‹rû±
(

997 *
—x
, *
ebx
,

998 *
ecx
, *
edx
)

1000 
šput
 = *
—x
;

1001 
vıu
 *
v
 = 
cu¼’t
;

1003 
	`hvm_ıuid
(
šput
, 
—x
, 
ebx
, 
ecx
, 
edx
);

1005 iàĞ
šput
 == 0x80000001 )

1008 iàĞ
	`vÏpic_hw_di§bËd
(
	`vıu_vÏpic
(
v
)) )

1009 
	`__ş—r_b™
(
X86_FEATURE_APIC
 & 31, 
edx
);

1012 
	`HVMTRACE_5D
 (
CPUID
, 
šput
, *
—x
, *
ebx
, *
ecx
, *
edx
);

1013 
	}
}

1015 
	$svm_vmex™_do_ıuid
(
ıu_u£r_»gs
 *
»gs
)

1017 
—x
, 
ebx
, 
ecx
, 
edx
, 
š¡_Ën
;

1019 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
cu¼’t
, 
INSTR_CPUID
)) == 0 )

1022 
—x
 = 
»gs
->eax;

1023 
ebx
 = 
»gs
->ebx;

1024 
ecx
 = 
»gs
->ecx;

1025 
edx
 = 
»gs
->edx;

1027 
	`svm_ıuid_š‹rû±
(&
—x
, &
ebx
, &
ecx
, &
edx
);

1029 
»gs
->
—x
 =ƒax;

1030 
»gs
->
ebx
 =ƒbx;

1031 
»gs
->
ecx
 =ƒcx;

1032 
»gs
->
edx
 =ƒdx;

1034 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1035 
	}
}

1037 
	$svm_dr_acûss
(
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1039 
	`HVMTRACE_0D
(
DR_WRITE
);

1040 
	`__»¡Üe_debug_»gi¡”s
(
v
);

1041 
	}
}

1043 
	$svm_m¤_»ad_š‹rû±
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

1045 
vıu
 *
v
 = 
cu¼’t
;

1046 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

1048  
m¤
 )

1050 
MSR_IA32_SYSENTER_CS
:

1051 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_cs
;

1053 
MSR_IA32_SYSENTER_ESP
:

1054 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e¥
;

1056 
MSR_IA32_SYSENTER_EIP
:

1057 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e
;

1060 
MSR_IA32_MC4_MISC
:

1061 
MSR_F10_MC4_MISC1
 ... 
MSR_F10_MC4_MISC3
:

1066 *
m¤_cÚ‹Á
 = 1ULL << 61;

1069 
MSR_IA32_EBC_FREQUENCY_ID
:

1075 *
m¤_cÚ‹Á
 = 0;

1078 
MSR_K8_VM_HSAVE_PA
:

1079 
gpf
;

1081 
MSR_IA32_DEBUGCTLMSR
:

1082 *
m¤_cÚ‹Á
 = 
	`vmcb_g‘_debugùlm¤
(
vmcb
);

1085 
MSR_IA32_LASTBRANCHFROMIP
:

1086 *
m¤_cÚ‹Á
 = 
	`vmcb_g‘_Ï¡b¿nchäom
(
vmcb
);

1089 
MSR_IA32_LASTBRANCHTOIP
:

1090 *
m¤_cÚ‹Á
 = 
	`vmcb_g‘_Ï¡b¿nchto
(
vmcb
);

1093 
MSR_IA32_LASTINTFROMIP
:

1094 *
m¤_cÚ‹Á
 = 
	`vmcb_g‘_Ï¡štäom
(
vmcb
);

1097 
MSR_IA32_LASTINTTOIP
:

1098 *
m¤_cÚ‹Á
 = 
	`vmcb_g‘_Ï¡š‰o
(
vmcb
);

1101 
MSR_K7_PERFCTR0
:

1102 
MSR_K7_PERFCTR1
:

1103 
MSR_K7_PERFCTR2
:

1104 
MSR_K7_PERFCTR3
:

1105 
MSR_K7_EVNTSEL0
:

1106 
MSR_K7_EVNTSEL1
:

1107 
MSR_K7_EVNTSEL2
:

1108 
MSR_K7_EVNTSEL3
:

1109 
	`vpmu_do_rdm¤
(
m¤
, 
m¤_cÚ‹Á
);

1114 iàĞ
	`rdm¤_vœidŸn_»gs
(
m¤
, 
m¤_cÚ‹Á
) ||

1115 
	`rdm¤_hy³rvisÜ_»gs
(
m¤
, 
m¤_cÚ‹Á
) )

1118 iàĞ
	`rdm¤_§ã
(
m¤
, *
m¤_cÚ‹Á
) == 0 )

1121 
gpf
;

1124 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "»tuºs:ƒcx=%x, m¤_v®ue=%"
PRIx64
,

1125 
m¤
, *
m¤_cÚ‹Á
);

1126  
X86EMUL_OKAY
;

1128 
gpf
:

1129 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1130  
X86EMUL_EXCEPTION
;

1131 
	}
}

1133 
	$svm_m¤_wr™e_š‹rû±
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

1135 
vıu
 *
v
 = 
cu¼’t
;

1136 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

1137 
sync
 = 0;

1139  
m¤
 )

1141 
MSR_IA32_SYSENTER_CS
:

1142 
MSR_IA32_SYSENTER_ESP
:

1143 
MSR_IA32_SYSENTER_EIP
:

1144 
sync
 = 1;

1150 iàĞ
sync
 )

1151 
	`svm_sync_vmcb
(
v
);

1153  
m¤
 )

1155 
MSR_K8_VM_HSAVE_PA
:

1156 
gpf
;

1158 
MSR_IA32_SYSENTER_CS
:

1159 
vmcb
->
sy£Á”_cs
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_cs
 = 
m¤_cÚ‹Á
;

1161 
MSR_IA32_SYSENTER_ESP
:

1162 
vmcb
->
sy£Á”_e¥
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e¥
 = 
m¤_cÚ‹Á
;

1164 
MSR_IA32_SYSENTER_EIP
:

1165 
vmcb
->
sy£Á”_e
 = 
v
->
¬ch
.
hvm_svm
.
gue¡_sy£Á”_e
 = 
m¤_cÚ‹Á
;

1168 
MSR_IA32_DEBUGCTLMSR
:

1169 
	`vmcb_£t_debugùlm¤
(
vmcb
, 
m¤_cÚ‹Á
);

1170 iàĞ!
m¤_cÚ‹Á
 || !
ıu_has_svm_lbrv
 )

1172 
vmcb
->
lbr_cÚŒŞ
.
f›lds
.
’abË
 = 1;

1173 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_DEBUGCTLMSR
);

1174 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_LASTBRANCHFROMIP
);

1175 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_LASTBRANCHTOIP
);

1176 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_LASTINTFROMIP
);

1177 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_LASTINTTOIP
);

1180 
MSR_IA32_LASTBRANCHFROMIP
:

1181 
	`vmcb_£t_Ï¡b¿nchäom
(
vmcb
, 
m¤_cÚ‹Á
);

1184 
MSR_IA32_LASTBRANCHTOIP
:

1185 
	`vmcb_£t_Ï¡b¿nchto
(
vmcb
, 
m¤_cÚ‹Á
);

1188 
MSR_IA32_LASTINTFROMIP
:

1189 
	`vmcb_£t_Ï¡štäom
(
vmcb
, 
m¤_cÚ‹Á
);

1192 
MSR_IA32_LASTINTTOIP
:

1193 
	`vmcb_£t_Ï¡š‰o
(
vmcb
, 
m¤_cÚ‹Á
);

1196 
MSR_K7_PERFCTR0
:

1197 
MSR_K7_PERFCTR1
:

1198 
MSR_K7_PERFCTR2
:

1199 
MSR_K7_PERFCTR3
:

1200 
MSR_K7_EVNTSEL0
:

1201 
MSR_K7_EVNTSEL1
:

1202 
MSR_K7_EVNTSEL2
:

1203 
MSR_K7_EVNTSEL3
:

1204 
	`vpmu_do_wrm¤
(
m¤
, 
m¤_cÚ‹Á
);

1207 
MSR_IA32_MC4_MISC
:

1208 
MSR_F10_MC4_MISC1
 ... 
MSR_F10_MC4_MISC3
:

1217 iàĞ
	`wrm¤_vœidŸn_»gs
(
m¤
, 
m¤_cÚ‹Á
) )

1220 
	`wrm¤_hy³rvisÜ_»gs
(
m¤
, 
m¤_cÚ‹Á
);

1224 iàĞ
sync
 )

1225 
	`svm_vmlßd
(
vmcb
);

1227  
X86EMUL_OKAY
;

1229 
gpf
:

1230 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1231  
X86EMUL_EXCEPTION
;

1232 
	}
}

1234 
	$svm_do_m¤_acûss
(
ıu_u£r_»gs
 *
»gs
)

1236 
rc
, 
š¡_Ën
;

1237 
vıu
 *
v
 = 
cu¼’t
;

1238 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

1239 
ušt64_t
 
m¤_cÚ‹Á
;

1241 iàĞ
vmcb
->
ex™šfo1
 == 0 )

1243 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
v
, 
INSTR_RDMSR
)) == 0 )

1245 
rc
 = 
	`hvm_m¤_»ad_š‹rû±
(
»gs
->
ecx
, &
m¤_cÚ‹Á
);

1246 
»gs
->
—x
 = (
ušt32_t
)
m¤_cÚ‹Á
;

1247 
»gs
->
edx
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

1251 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
v
, 
INSTR_WRMSR
)) == 0 )

1253 
m¤_cÚ‹Á
 = ((
ušt64_t
)
»gs
->
edx
 << 32è| (
ušt32_t
ìegs->
—x
;

1254 
rc
 = 
	`hvm_m¤_wr™e_š‹rû±
(
»gs
->
ecx
, 
m¤_cÚ‹Á
);

1257 iàĞ
rc
 =ğ
X86EMUL_OKAY
 )

1258 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1259 
	}
}

1261 
	$svm_vmex™_do_hÉ
(
vmcb_¡ruù
 *
vmcb
,

1262 
ıu_u£r_»gs
 *
»gs
)

1264 
š¡_Ën
;

1266 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
cu¼’t
, 
INSTR_HLT
)) == 0 )

1268 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1270 
	`hvm_hÉ
(
»gs
->
eæags
);

1271 
	}
}

1273 
	$svm_vmex™_do_rdtsc
(
ıu_u£r_»gs
 *
»gs
)

1275 
š¡_Ën
;

1277 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
cu¼’t
, 
INSTR_RDTSC
)) == 0 )

1279 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1281 
	`hvm_rdtsc_š‹rû±
(
»gs
);

1282 
	}
}

1284 
	$svm_vmex™_do_·u£
(
ıu_u£r_»gs
 *
»gs
)

1286 
š¡_Ën
;

1288 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
cu¼’t
, 
INSTR_PAUSE
)) == 0 )

1290 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1296 
	`³rfc_šü
(
·u£loİ_ex™s
);

1297 
	`do_sched_İ_com·t
(
SCHEDOP_y›ld
, 0);

1298 
	}
}

1300 
	$svm_vmex™_ud_š‹rû±
(
ıu_u£r_»gs
 *
»gs
)

1302 
hvm_emuÏ‹_ùxt
 
ùxt
;

1303 
rc
;

1305 
	`hvm_emuÏ‹_´•¬e
(&
ùxt
, 
»gs
);

1307 
rc
 = 
	`hvm_emuÏ‹_Úe
(&
ùxt
);

1309  
rc
 )

1311 
X86EMUL_UNHANDLEABLE
:

1312 
	`hvm_šjeù_exû±iÚ
(
TRAP_šv®id_İ
, 
HVM_DELIVER_NO_ERROR_CODE
, 0);

1314 
X86EMUL_EXCEPTION
:

1315 iàĞ
ùxt
.
exn_³ndšg
 )

1316 
	`hvm_šjeù_exû±iÚ
(
ùxt
.
exn_veùÜ
, ctxt.
exn_”rÜ_code
, 0);

1319 
	`hvm_emuÏ‹_wr™eback
(&
ùxt
);

1322 
	}
}

1324 
Ä_mû_bªks
;

1326 
	$svm_is_”¿tum_383
(
ıu_u£r_»gs
 *
»gs
)

1328 
ušt64_t
 
m¤_cÚ‹Á
;

1329 
ušt32_t
 
i
;

1330 
vıu
 *
v
 = 
cu¼’t
;

1332 iàĞ!
amd_”¿tum383_found
 )

1335 
	`rdm¤l
(
MSR_IA32_MC0_STATUS
, 
m¤_cÚ‹Á
);

1337 
m¤_cÚ‹Á
 &= ~(1ULL << 62);

1339 iàĞ
m¤_cÚ‹Á
 != 0xb600000000010015ULL )

1343 
i
 = 0; i < 
Ä_mû_bªks
; i++)

1344 
	`wrm¤l
(
	`MSR_IA32_MCx_STATUS
(
i
), 0ULL);

1346 
	`rdm¤l
(
MSR_IA32_MCG_STATUS
, 
m¤_cÚ‹Á
);

1347 
	`wrm¤l
(
MSR_IA32_MCG_STATUS
, 
m¤_cÚ‹Á
 & ~(1ULL << 2));

1350 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

1353 
	}
}

1355 
	$svm_vmex™_mû_š‹rû±
(

1356 
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1358 iàĞ
	`svm_is_”¿tum_383
(
»gs
) )

1360 
	`gd´štk
(
XENLOG_ERR
, "SVM hits AMDƒrratum 383\n");

1361 
	`domaš_üash
(
v
->
domaš
);

1363 
	}
}

1365 
	$wbšvd_i
(*
šfo
)

1367 
	`wbšvd
();

1368 
	}
}

1370 
	$svm_wbšvd_š‹rû±
()

1372 iàĞ
	`has_¬ch_mmios
(
cu¼’t
->
domaš
) )

1373 
	`Ú_—ch_ıu
(
wbšvd_i
, 
NULL
, 1);

1374 
	}
}

1376 
	$svm_vmex™_do_šv®id©e_ÿche
(
ıu_u£r_»gs
 *
»gs
)

1378 
š¡ruùiÚ_šdex
 
li¡
[] = { 
INSTR_INVD
, 
INSTR_WBINVD
 };

1379 
š¡_Ën
;

1381 
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth_äom_li¡
(

1382 
cu¼’t
, 
li¡
, 
	`ARRAY_SIZE
(list));

1383 iàĞ
š¡_Ën
 == 0 )

1386 
	`svm_wbšvd_š‹rû±
();

1388 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1389 
	}
}

1391 
	$svm_švÍg_š‹rû±
(
vaddr
)

1393 
vıu
 *
cu¼
 = 
cu¼’t
;

1394 
	`HVMTRACE_LONG_2D
(
INVLPG
, 0, 
	`TRC_PAR_LONG
(
vaddr
));

1395 
	`·gšg_švÍg
(
cu¼
, 
vaddr
);

1396 
	`svm_asid_g_švÍg
(
cu¼
, 
vaddr
);

1397 
	}
}

1399 
hvm_funùiÚ_bË
 
__»ad_mo¡ly
 
	gsvm_funùiÚ_bË
 = {

1400 .
Çme
 = "SVM",

1401 .
	gıu_up_´•¬e
 = 
svm_ıu_up_´•¬e
,

1402 .
	gıu_d—d
 = 
svm_ıu_d—d
,

1403 .
	gıu_up
 = 
svm_ıu_up
,

1404 .
	gıu_down
 = 
svm_ıu_down
,

1405 .
	gdomaš_š™Ÿli£
 = 
svm_domaš_š™Ÿli£
,

1406 .
	gdomaš_de¡roy
 = 
svm_domaš_de¡roy
,

1407 .
	gvıu_š™Ÿli£
 = 
svm_vıu_š™Ÿli£
,

1408 .
	gvıu_de¡roy
 = 
svm_vıu_de¡roy
,

1409 .
	g§ve_ıu_ùxt
 = 
svm_§ve_vmcb_ùxt
,

1410 .
	glßd_ıu_ùxt
 = 
svm_lßd_vmcb_ùxt
,

1411 .
	gg‘_š‹¼u±_shadow
 = 
svm_g‘_š‹¼u±_shadow
,

1412 .
	g£t_š‹¼u±_shadow
 = 
svm_£t_š‹¼u±_shadow
,

1413 .
	ggue¡_x86_mode
 = 
svm_gue¡_x86_mode
,

1414 .
	gg‘_£gm’t_»gi¡”
 = 
svm_g‘_£gm’t_»gi¡”
,

1415 .
	g£t_£gm’t_»gi¡”
 = 
svm_£t_£gm’t_»gi¡”
,

1416 .
	gupd©e_ho¡_ü3
 = 
svm_upd©e_ho¡_ü3
,

1417 .
	gupd©e_gue¡_ü
 = 
svm_upd©e_gue¡_ü
,

1418 .
	gupd©e_gue¡_eãr
 = 
svm_upd©e_gue¡_eãr
,

1419 .
	g£t_tsc_off£t
 = 
svm_£t_tsc_off£t
,

1420 .
	gšjeù_exû±iÚ
 = 
svm_šjeù_exû±iÚ
,

1421 .
	gš™_hy³rÿÎ_·ge
 = 
svm_š™_hy³rÿÎ_·ge
,

1422 .
	gev’t_³ndšg
 = 
svm_ev’t_³ndšg
,

1423 .
	gdo_pmu_š‹¼u±
 = 
svm_do_pmu_š‹¼u±
,

1424 .
	gıuid_š‹rû±
 = 
svm_ıuid_š‹rû±
,

1425 .
	gwbšvd_š‹rû±
 = 
svm_wbšvd_š‹rû±
,

1426 .
	gåu_dœty_š‹rû±
 = 
svm_åu_dœty_š‹rû±
,

1427 .
	gm¤_»ad_š‹rû±
 = 
svm_m¤_»ad_š‹rû±
,

1428 .
	gm¤_wr™e_š‹rû±
 = 
svm_m¤_wr™e_š‹rû±
,

1429 .
	gšvÍg_š‹rû±
 = 
svm_švÍg_š‹rû±
,

1430 .
	g£t_rdtsc_ex™šg
 = 
svm_£t_rdtsc_ex™šg


1433 
asmlškage
 
	$svm_vmex™_hªdËr
(
ıu_u£r_»gs
 *
»gs
)

1435 
ex™_»asÚ
;

1436 
vıu
 *
v
 = 
cu¼’t
;

1437 
vmcb_¡ruù
 *
vmcb
 = 
v
->
¬ch
.
hvm_svm
.vmcb;

1438 
ev’tšj_t
 
ev’tšj
;

1439 
š¡_Ën
, 
rc
;

1440 
všŒ_t
 
šŒ
;

1442 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

1443 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = v->¬ch.hvm_vıu.
hw_ü
[3] =

1444 
	`vmcb_g‘_ü3
(
vmcb
);

1453 
šŒ
 = 
	`vmcb_g‘_všŒ
(
vmcb
);

1454 
	`vÏpic_£t_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
,

1455 ((
šŒ
.
f›lds
.
r
 & 0x0F) << 4) |

1456 (
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
) & 0x0F));

1458 
ex™_»asÚ
 = 
vmcb
->
ex™code
;

1460 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

1461 
	`HVMTRACE_ND
(
VMEXIT64
, 1 , 3, 
ex™_»asÚ
,

1462 (
ušt32_t
)
»gs
->
e
, (ušt32_t)((
ušt64_t
)regs->eip >> 32),

1465 
	`HVMTRACE_ND
(
VMEXIT
, 1 , 2, 
ex™_»asÚ
,

1466 (
ušt32_t
)
»gs
->
e
,

1469 iàĞ
	`uÆik–y
(
ex™_»asÚ
 =ğ
VMEXIT_INVALID
) )

1471 
	`svm_dump_vmcb
(
__func__
, 
vmcb
);

1472 
ex™_ªd_üash
;

1475 
	`³rfc_šüa
(
svmex™s
, 
ex™_»asÚ
);

1477 
	`hvm_maybe_d—s£¹_evtchn_œq
();

1479 
vmcb
->
ş—nb™s
.
by‹s
 = 
ıu_has_svm_ş—nb™s
 ? ~0u : 0u;

1482 
ev’tšj
 = 
vmcb
->
ex™štšfo
;

1483 iàĞ
	`uÆik–y
(
ev’tšj
.
f›lds
.
v
) &&

1484 
	`hvm_ev’t_Ãeds_»šjeùiÚ
(
ev’tšj
.
f›lds
.
ty³
,

1485 
ev’tšj
.
f›lds
.
veùÜ
) )

1486 
vmcb
->
ev’tšj
 =ƒventinj;

1488  
ex™_»asÚ
 )

1490 
VMEXIT_INTR
:

1492 
	`HVMTRACE_0D
(
INTR
);

1495 
VMEXIT_NMI
:

1497 
	`HVMTRACE_0D
(
NMI
);

1500 
VMEXIT_SMI
:

1502 
	`HVMTRACE_0D
(
SMI
);

1505 
VMEXIT_EXCEPTION_DB
:

1506 iàĞ!
v
->
domaš
->
debugg”_©ched
 )

1507 
ex™_ªd_üash
;

1508 
	`domaš_·u£_fÜ_debugg”
();

1511 
VMEXIT_EXCEPTION_BP
:

1512 iàĞ!
v
->
domaš
->
debugg”_©ched
 )

1513 
ex™_ªd_üash
;

1515 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
v
, 
INSTR_INT3
)) == 0 )

1517 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1518 
cu¼’t
->
¬ch
.
gdbsx_vıu_ev’t
 = 
TRAP_št3
;

1519 
	`domaš_·u£_fÜ_debugg”
();

1522 
VMEXIT_EXCEPTION_NM
:

1523 
	`svm_åu_dœty_š‹rû±
();

1526 
VMEXIT_EXCEPTION_PF
: {

1527 
va
;

1528 
va
 = 
vmcb
->
ex™šfo2
;

1529 
»gs
->
”rÜ_code
 = 
vmcb
->
ex™šfo1
;

1530 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
,

1532 ()
»gs
->
—x
, (ìegs->
ebx
,

1533 ()
»gs
->
ecx
, (ìegs->
edx
,

1534 ()
»gs
->
esi
, (ìegs->
edi
);

1536 iàĞ
	`·gšg_çuÉ
(
va
, 
»gs
) )

1538 iàĞ
	`Œaû_wl_Œaû_ev’t
(
TRC_SHADOW
) )

1540 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

1541 
	`HVMTRACE_LONG_2D
(
PF_XEN
, 
»gs
->
”rÜ_code
, 
	`TRC_PAR_LONG
(
va
));

1543 
	`HVMTRACE_2D
(
PF_XEN
, 
»gs
->
”rÜ_code
, 
va
);

1547 
	`hvm_šjeù_exû±iÚ
(
TRAP_·ge_çuÉ
, 
»gs
->
”rÜ_code
, 
va
);

1551 
VMEXIT_EXCEPTION_UD
:

1552 
	`svm_vmex™_ud_š‹rû±
(
»gs
);

1556 
VMEXIT_EXCEPTION_MC
:

1557 
	`HVMTRACE_0D
(
MCE
);

1558 
	`svm_vmex™_mû_š‹rû±
(
v
, 
»gs
);

1561 
VMEXIT_VINTR
: {

1562 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

1563 
šŒ
 = 
	`vmcb_g‘_všŒ
(
vmcb
);

1565 
šŒ
.
f›lds
.
œq
 = 0;

1566 
g’”®1_š‹rû±s
 &ğ~
GENERAL1_INTERCEPT_VINTR
;

1568 
	`vmcb_£t_všŒ
(
vmcb
, 
šŒ
);

1569 
	`vmcb_£t_g’”®1_š‹rû±s
(
vmcb
, 
g’”®1_š‹rû±s
);

1573 
VMEXIT_INVD
:

1574 
VMEXIT_WBINVD
:

1575 
	`svm_vmex™_do_šv®id©e_ÿche
(
»gs
);

1578 
VMEXIT_TASK_SWITCH
: {

1579 
hvm_sk_sw™ch_»asÚ
 
»asÚ
;

1580 
št32_t
 
”rcode
 = -1;

1581 iàĞ(
vmcb
->
ex™šfo2
 >> 36) & 1 )

1582 
»asÚ
 = 
TSW_œ‘
;

1583 iàĞ(
vmcb
->
ex™šfo2
 >> 38) & 1 )

1584 
»asÚ
 = 
TSW_jmp
;

1586 
»asÚ
 = 
TSW_ÿÎ_Ü_št
;

1587 iàĞ(
vmcb
->
ex™šfo2
 >> 44) & 1 )

1588 
”rcode
 = (
ušt32_t
)
vmcb
->
ex™šfo2
;

1596 
vmcb
->
ev’tšj
.
by‹s
 = 0;

1598 
	`hvm_sk_sw™ch
((
ušt16_t
)
vmcb
->
ex™šfo1
, 
»asÚ
, 
”rcode
);

1602 
VMEXIT_CPUID
:

1603 
	`svm_vmex™_do_ıuid
(
»gs
);

1606 
VMEXIT_HLT
:

1607 
	`svm_vmex™_do_hÉ
(
vmcb
, 
»gs
);

1610 
VMEXIT_IOIO
:

1611 iàĞ(
vmcb
->
ex™šfo1
 & (1u<<2)) == 0 )

1613 
ušt16_t
 
pÜt
 = (
vmcb
->
ex™šfo1
 >> 16) & 0xFFFF;

1614 
by‹s
 = ((
vmcb
->
ex™šfo1
 >> 4) & 0x07);

1615 
dœ
 = (
vmcb
->
ex™šfo1
 & 1è? 
IOREQ_READ
 : 
IOREQ_WRITE
;

1616 iàĞ
	`hªdË_pio
(
pÜt
, 
by‹s
, 
dœ
) )

1617 
	`__upd©e_gue¡_e
(
»gs
, 
vmcb
->
ex™šfo2
 - vmcb->
r
);

1621 
VMEXIT_CR0_READ
 ... 
VMEXIT_CR15_READ
:

1622 
VMEXIT_CR0_WRITE
 ... 
VMEXIT_CR15_WRITE
:

1623 
VMEXIT_INVLPG
:

1624 
VMEXIT_INVLPGA
:

1625 iàĞ!
	`hªdË_mmio
() )

1626 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

1629 
VMEXIT_VMMCALL
:

1630 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
v
, 
INSTR_VMCALL
)) == 0 )

1632 
	`HVMTRACE_1D
(
VMMCALL
, 
»gs
->
—x
);

1633 
rc
 = 
	`hvm_do_hy³rÿÎ
(
»gs
);

1634 iàĞ
rc
 !ğ
HVM_HCALL_´“m±ed
 )

1636 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1637 iàĞ
rc
 =ğ
HVM_HCALL_šv®id©e
 )

1638 
	`£nd_šv®id©e_»q
();

1642 
VMEXIT_DR0_READ
 ... 
VMEXIT_DR7_READ
:

1643 
VMEXIT_DR0_WRITE
 ... 
VMEXIT_DR7_WRITE
:

1644 
	`svm_dr_acûss
(
v
, 
»gs
);

1647 
VMEXIT_MSR
:

1648 
	`svm_do_m¤_acûss
(
»gs
);

1651 
VMEXIT_SHUTDOWN
:

1652 
	`hvm_ŒË_çuÉ
();

1655 
VMEXIT_RDTSCP
:

1656 
»gs
->
ecx
 = 
	`hvm_m¤_tsc_aux
(
v
);

1658 
VMEXIT_RDTSC
:

1659 
	`svm_vmex™_do_rdtsc
(
»gs
);

1662 
VMEXIT_MONITOR
:

1663 
VMEXIT_MWAIT
:

1664 
VMEXIT_VMRUN
:

1665 
VMEXIT_VMLOAD
:

1666 
VMEXIT_VMSAVE
:

1667 
VMEXIT_STGI
:

1668 
VMEXIT_CLGI
:

1669 
VMEXIT_SKINIT
:

1670 
	`hvm_šjeù_exû±iÚ
(
TRAP_šv®id_İ
, 
HVM_DELIVER_NO_ERROR_CODE
, 0);

1673 
VMEXIT_XSETBV
:

1674 iàĞ(
š¡_Ën
 = 
	`__g‘_š¡ruùiÚ_Ëngth
(
cu¼’t
, 
INSTR_XSETBV
))==0 )

1676 iàĞ
	`hvm_hªdË_x£tbv
((((
u64
)
»gs
->
edx
è<< 32è|„egs->
—x
) == 0 )

1677 
	`__upd©e_gue¡_e
(
»gs
, 
š¡_Ën
);

1680 
VMEXIT_NPF
:

1681 
	`³rfc_šüa
(
svmex™s
, 
VMEXIT_NPF_PERFC
);

1682 
»gs
->
”rÜ_code
 = 
vmcb
->
ex™šfo1
;

1683 
	`svm_do_Ã¡ed_pgçuÉ
(
vmcb
->
ex™šfo2
);

1686 
VMEXIT_IRET
: {

1687 
u32
 
g’”®1_š‹rû±s
 = 
	`vmcb_g‘_g’”®1_š‹rû±s
(
vmcb
);

1697 
g’”®1_š‹rû±s
 &ğ~
GENERAL1_INTERCEPT_IRET
;

1698 
vmcb
->
š‹¼u±_shadow
 = 1;

1700 
	`vmcb_£t_g’”®1_š‹rû±s
(
vmcb
, 
g’”®1_š‹rû±s
);

1704 
VMEXIT_PAUSE
:

1705 
	`svm_vmex™_do_·u£
(
»gs
);

1709 
ex™_ªd_üash
:

1710 
	`gd´štk
(
XENLOG_ERR
, "unexpected VMEXIT:ƒxit„eason = 0x%x, "

1711 "ex™šfo1 = %"
PRIx64
",ƒxitinfo2 = %"PRIx64"\n",

1712 
ex™_»asÚ
,

1713 (
u64
)
vmcb
->
ex™šfo1
, (u64)vmcb->
ex™šfo2
);

1714 
	`domaš_üash
(
v
->
domaš
);

1719 
šŒ
 = 
	`vmcb_g‘_všŒ
(
vmcb
);

1720 
šŒ
.
f›lds
.
r
 =

1721 (
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
) & 0xFF) >> 4;

1722 
	`vmcb_£t_všŒ
(
vmcb
, 
šŒ
);

1723 
	}
}

1725 
asmlškage
 
	$svm_Œaû_vm’Œy
()

1727 
	`HVMTRACE_ND
 (
VMENTRY
, 1 , 0, 0, 0, 0, 0, 0, 0);

1728 
	}
}

	@hvm/svm/vmcb.c

21 
	~<x’/cÚfig.h
>

22 
	~<x’/š™.h
>

23 
	~<x’/mm.h
>

24 
	~<x’/lib.h
>

25 
	~<x’/”ºo.h
>

26 
	~<asm/ıuã©u».h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<asm/m¤.h
>

29 
	~<asm/p2m.h
>

30 
	~<asm/hvm/hvm.h
>

31 
	~<asm/hvm/io.h
>

32 
	~<asm/hvm/suµÜt.h
>

33 
	~<asm/hvm/svm/svm.h
>

34 
	~<asm/hvm/svm/šŒ.h
>

35 
	~<asm/hvm/svm/asid.h
>

36 
	~<x’/ev’t.h
>

37 
	~<x’/k”Ãl.h
>

38 
	~<x’/domaš_·ge.h
>

39 
	~<x’/keyhªdËr.h
>

41 
svm_dbg_Ú
;

43 
	#IOPM_SIZE
 (12 * 1024)

	)

44 
	#MSRPM_SIZE
 (8 * 1024)

	)

46 
vmcb_¡ruù
 *
	$®loc_vmcb
()

48 
vmcb_¡ruù
 *
vmcb
;

50 
vmcb
 = 
	`®loc_x’h—p_·ge
();

51 iàĞ
vmcb
 =ğ
NULL
 )

53 
	`´štk
(
XENLOG_WARNING
 "Warning: failedo‡llocate vmcb.\n");

54  
NULL
;

57 
	`ş—r_·ge
(
vmcb
);

58  
vmcb
;

59 
	}
}

61 
	$ä“_vmcb
(
vmcb_¡ruù
 *
vmcb
)

63 
	`ä“_x’h—p_·ge
(
vmcb
);

64 
	}
}

66 
ho¡_§ve_¬—
 *
	$®loc_ho¡_§ve_¬—
()

68 
ho¡_§ve_¬—
 *
h§
;

70 
h§
 = 
	`®loc_x’h—p_·ge
();

71 iàĞ
h§
 =ğ
NULL
 )

73 
	`´štk
(
XENLOG_WARNING
 "Warning: failedo‡llocate hsa.\n");

74  
NULL
;

77 
	`ş—r_·ge
(
h§
);

78  
h§
;

79 
	}
}

81 
	$svm_š‹rû±_m¤
(
vıu
 *
v
, 
ušt32_t
 
m¤
, 
’abË
)

83 *
m¤_b™m­
 = 
v
->
¬ch
.
hvm_svm
.
m¤pm
;

84 *
m¤_b™
 = 
NULL
;

89 iàĞ
m¤
 <= 0x1fff )

90 
m¤_b™
 = 
m¤_b™m­
 + 0x0000 / 
BYTES_PER_LONG
;

91 iàĞ(
m¤
 >= 0xc0000000) && (msr <= 0xc0001fff) )

92 
m¤_b™
 = 
m¤_b™m­
 + 0x0800 / 
BYTES_PER_LONG
;

93 iàĞ(
m¤
 >= 0xc0010000) && (msr <= 0xc0011fff) )

94 
m¤_b™
 = 
m¤_b™m­
 + 0x1000 / 
BYTES_PER_LONG
;

96 
	`BUG_ON
(
m¤_b™
 =ğ
NULL
);

98 
m¤
 &= 0x1fff;

100 iàĞ
’abË
 )

102 
	`__£t_b™
(
m¤
 * 2, 
m¤_b™
);

103 
	`__£t_b™
(
m¤
 * 2 + 1, 
m¤_b™
);

107 
	`__ş—r_b™
(
m¤
 * 2, 
m¤_b™
);

108 
	`__ş—r_b™
(
m¤
 * 2 + 1, 
m¤_b™
);

110 
	}
}

113 
	$cÚ¡ruù_vmcb
(
vıu
 *
v
)

115 
¬ch_svm_¡ruù
 *
¬ch_svm
 = &
v
->
¬ch
.
hvm_svm
;

116 
vmcb_¡ruù
 *
vmcb
 = 
¬ch_svm
->vmcb;

118 
vmcb
->
_g’”®1_š‹rû±s
 =

119 
GENERAL1_INTERCEPT_INTR
 | 
GENERAL1_INTERCEPT_NMI
 |

120 
GENERAL1_INTERCEPT_SMI
 | 
GENERAL1_INTERCEPT_INIT
 |

121 
GENERAL1_INTERCEPT_CPUID
 | 
GENERAL1_INTERCEPT_INVD
 |

122 
GENERAL1_INTERCEPT_HLT
 | 
GENERAL1_INTERCEPT_INVLPG
 |

123 
GENERAL1_INTERCEPT_INVLPGA
 | 
GENERAL1_INTERCEPT_IOIO_PROT
 |

124 
GENERAL1_INTERCEPT_MSR_PROT
 | 
GENERAL1_INTERCEPT_SHUTDOWN_EVT
|

125 
GENERAL1_INTERCEPT_TASK_SWITCH
;

126 
vmcb
->
_g’”®2_š‹rû±s
 =

127 
GENERAL2_INTERCEPT_VMRUN
 | 
GENERAL2_INTERCEPT_VMMCALL
 |

128 
GENERAL2_INTERCEPT_VMLOAD
 | 
GENERAL2_INTERCEPT_VMSAVE
 |

129 
GENERAL2_INTERCEPT_STGI
 | 
GENERAL2_INTERCEPT_CLGI
 |

130 
GENERAL2_INTERCEPT_SKINIT
 | 
GENERAL2_INTERCEPT_MWAIT
 |

131 
GENERAL2_INTERCEPT_WBINVD
 | 
GENERAL2_INTERCEPT_MONITOR
 |

132 
GENERAL2_INTERCEPT_XSETBV
;

135 
vmcb
->
_dr_š‹rû±s
 = ~0u;

138 
vmcb
->
_ü_š‹rû±s
 = ~(
CR_INTERCEPT_CR2_READ
 |

139 
CR_INTERCEPT_CR2_WRITE
 |

140 
CR_INTERCEPT_CR8_READ
 |

141 
CR_INTERCEPT_CR8_WRITE
);

144 
¬ch_svm
->
m¤pm
 = 
	`®loc_x’h—p_·ges
(
	`g‘_Üd”_äom_by‹s
(
MSRPM_SIZE
), 0);

145 iàĞ
¬ch_svm
->
m¤pm
 =ğ
NULL
 )

146  -
ENOMEM
;

147 
	`mem£t
(
¬ch_svm
->
m¤pm
, 0xff, 
MSRPM_SIZE
);

149 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_FS_BASE
);

150 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_GS_BASE
);

151 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_SHADOW_GS_BASE
);

152 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_CSTAR
);

153 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_LSTAR
);

154 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_STAR
);

155 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_SYSCALL_MASK
);

157 
vmcb
->
_m¤pm_ba£_·
 = (
u64
)
	`vœt_to_maddr
(
¬ch_svm
->
m¤pm
);

158 
vmcb
->
_iİm_ba£_·
 = (
u64
)
	`vœt_to_maddr
(
hvm_io_b™m­
);

161 
vmcb
->
_všŒ
.
f›lds
.
šŒ_maskšg
 = 1;

164 
vmcb
->
ev’tšj
.
by‹s
 = 0;

167 
vmcb
->
_tsc_off£t
 = 0;

168 iàĞ
v
->
domaš
->
¬ch
.
vtsc
 )

170 
vmcb
->
_g’”®1_š‹rû±s
 |ğ
GENERAL1_INTERCEPT_RDTSC
;

171 
vmcb
->
_g’”®2_š‹rû±s
 |ğ
GENERAL2_INTERCEPT_RDTSCP
;

175 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 = 0;

176 
	`hvm_upd©e_gue¡_eãr
(
v
);

179 
vmcb
->
cs
.
lim™
 = ~0u;

180 
vmcb
->
es
.
lim™
 = ~0u;

181 
vmcb
->
ss
.
lim™
 = ~0u;

182 
vmcb
->
ds
.
lim™
 = ~0u;

183 
vmcb
->
fs
.
lim™
 = ~0u;

184 
vmcb
->
gs
.
lim™
 = ~0u;

187 
vmcb
->
cs
.
ba£
 = 0;

188 
vmcb
->
es
.
ba£
 = 0;

189 
vmcb
->
ss
.
ba£
 = 0;

190 
vmcb
->
ds
.
ba£
 = 0;

191 
vmcb
->
fs
.
ba£
 = 0;

192 
vmcb
->
gs
.
ba£
 = 0;

195 
vmcb
->
es
.
©Œ
.
by‹s
 = 0xc93;

196 
vmcb
->
ss
.
©Œ
.
by‹s
 = 0xc93;

197 
vmcb
->
ds
.
©Œ
.
by‹s
 = 0xc93;

198 
vmcb
->
fs
.
©Œ
.
by‹s
 = 0xc93;

199 
vmcb
->
gs
.
©Œ
.
by‹s
 = 0xc93;

200 
vmcb
->
cs
.
©Œ
.
by‹s
 = 0xc9b;

203 
vmcb
->
idŒ
.
ba£
 = 0;

204 
vmcb
->
idŒ
.
lim™
 = 0;

207 
vmcb
->
gdŒ
.
ba£
 = 0;

208 
vmcb
->
gdŒ
.
lim™
 = 0;

211 
vmcb
->
ldŒ
.
£l
 = 0;

212 
vmcb
->
ldŒ
.
ba£
 = 0;

213 
vmcb
->
ldŒ
.
lim™
 = 0;

214 
vmcb
->
ldŒ
.
©Œ
.
by‹s
 = 0;

217 
vmcb
->
Œ
.
©Œ
.
by‹s
 = 0x08b;

218 
vmcb
->
Œ
.
ba£
 = 0;

219 
vmcb
->
Œ
.
lim™
 = 0xff;

221 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
X86_CR0_PE
 | 
X86_CR0_ET
;

222 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

224 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 0;

225 
	`hvm_upd©e_gue¡_ü
(
v
, 4);

227 
	`·gšg_upd©e_·gšg_modes
(
v
);

229 
vmcb
->
_exû±iÚ_š‹rû±s
 =

230 
HVM_TRAP_MASK


231 | (1U << 
TRAP_no_deviû
);

233 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

235 
vmcb
->
_Å_’abË
 = 1;

236 
vmcb
->
_g_·t
 = 
MSR_IA32_CR_PAT_RESET
;

237 
vmcb
->
_h_ü3
 = 
	`·g‘abË_g‘_·ddr
(

238 
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
)));

241 
vmcb
->
_ü_š‹rû±s
 &=

242 ~(
CR_INTERCEPT_CR3_READ
|
CR_INTERCEPT_CR3_WRITE
);

248 
vmcb
->
_g’”®1_š‹rû±s
 &ğ~
GENERAL1_INTERCEPT_INVLPG
;

251 
	`svm_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_CR_PAT
);

255 
vmcb
->
_exû±iÚ_š‹rû±s
 |ğ(1U << 
TRAP_·ge_çuÉ
);

258 iàĞ
ıu_has_·u£_f‹r
 )

260 
vmcb
->
_·u£_f‹r_couÁ
 = 3000;

261 
vmcb
->
_g’”®1_š‹rû±s
 |ğ
GENERAL1_INTERCEPT_PAUSE
;

264 
vmcb
->
ş—nb™s
.
by‹s
 = 0;

267 
	}
}

269 
	$svm_ü—‹_vmcb
(
vıu
 *
v
)

271 
¬ch_svm_¡ruù
 *
¬ch_svm
 = &
v
->
¬ch
.
hvm_svm
;

272 
rc
;

274 iàĞ(
¬ch_svm
->
vmcb
 =ğ
NULL
) &&

275 (
¬ch_svm
->
vmcb
 = 
	`®loc_vmcb
()è=ğ
NULL
 )

277 
	`´štk
("Failedo create‡‚ew VMCB\n");

278  -
ENOMEM
;

281 iàĞ(
rc
 = 
	`cÚ¡ruù_vmcb
(
v
)) != 0 )

283 
	`ä“_vmcb
(
¬ch_svm
->
vmcb
);

284 
¬ch_svm
->
vmcb
 = 
NULL
;

285  
rc
;

288 
¬ch_svm
->
vmcb_·
 = 
	`vœt_to_maddr
×rch_svm->
vmcb
);

291 
	}
}

293 
	$svm_de¡roy_vmcb
(
vıu
 *
v
)

295 
¬ch_svm_¡ruù
 *
¬ch_svm
 = &
v
->
¬ch
.
hvm_svm
;

297 iàĞ
¬ch_svm
->
vmcb
 !ğ
NULL
 )

298 
	`ä“_vmcb
(
¬ch_svm
->
vmcb
);

300 iàĞ
¬ch_svm
->
m¤pm
 !ğ
NULL
 )

302 
	`ä“_x’h—p_·ges
(

303 
¬ch_svm
->
m¤pm
, 
	`g‘_Üd”_äom_by‹s
(
MSRPM_SIZE
));

304 
¬ch_svm
->
m¤pm
 = 
NULL
;

307 
¬ch_svm
->
vmcb
 = 
NULL
;

308 
	}
}

310 
	$svm_dump_£l
(*
Çme
, 
svm_£gm’t_»gi¡”_t
 *
s
)

312 
	`´štk
("%s: sel=0x%04x,‡ttr=0x%04x,†imit=0x%08x, base=0x%016llx\n",

313 
Çme
, 
s
->
£l
, s->
©Œ
.
by‹s
, s->
lim™
,

314 ()
s
->
ba£
);

315 
	}
}

318 
	$svm_dump_vmcb
(cÚ¡ *
äom
, 
vmcb_¡ruù
 *
vmcb
)

320 
	`´štk
("Dumpšg gue¡' cu¼’ˆ¡©© %s...\n", 
äom
);

321 
	`´štk
("Size of VMCB = %d,…addr = 0x%016lx, vaddr = %p\n",

322 (è(
vmcb_¡ruù
), 
	`vœt_to_maddr
(
vmcb
), vmcb);

324 
	`´štk
("cr_intercepts = 0x%08x dr_intercepts = 0x%08x "

326 
vmcb
->
_ü_š‹rû±s
, vmcb->
_dr_š‹rû±s
,

327 
vmcb
->
_exû±iÚ_š‹rû±s
);

328 
	`´štk
("general1_intercepts = 0x%08x general2_intercepts = 0x%08x\n",

329 
vmcb
->
_g’”®1_š‹rû±s
, vmcb->
_g’”®2_š‹rû±s
);

330 
	`´štk
("iopm_base_pa = 0x%016llx msrpm_base_pa = 0x%016llxsc_offset = "

332 ()
vmcb
->
_iİm_ba£_·
,

333 ()
vmcb
->
_m¤pm_ba£_·
,

334 ()
vmcb
->
_tsc_off£t
);

335 
	`´štk
("tlb_control = 0x%08x vintr = 0x%016llx interrupt_shadow = "

336 "0x%016Îx\n", 
vmcb
->
b_cÚŒŞ
,

337 ()
vmcb
->
_všŒ
.
by‹s
,

338 ()
vmcb
->
š‹¼u±_shadow
);

339 
	`´štk
("exitcode = 0x%016llxƒxitintinfo = 0x%016llx\n",

340 ()
vmcb
->
ex™code
,

341 ()
vmcb
->
ex™štšfo
.
by‹s
);

342 
	`´štk
("exitinfo1 = 0x%016llxƒxitinfo2 = 0x%016llx \n",

343 ()
vmcb
->
ex™šfo1
,

344 ()
vmcb
->
ex™šfo2
);

345 
	`´štk
("np_enable = 0x%016llx guest_asid = 0x%03x\n",

346 ()
vmcb
->
_Å_’abË
, vmcb->
_gue¡_asid
);

347 
	`´štk
("cpl = %dƒfer = 0x%016llx star = 0x%016llx†star = 0x%016llx\n",

348 
vmcb
->
_ıl
, ()vmcb->
_eãr
,

349 ()
vmcb
->
¡¬
, ()vmcb->
l¡¬
);

350 
	`´štk
("CR0 = 0x%016llx CR2 = 0x%016llx\n",

351 ()
vmcb
->
_ü0
, ()vmcb->
_ü2
);

352 
	`´štk
("CR3 = 0x%016llx CR4 = 0x%016llx\n",

353 ()
vmcb
->
_ü3
, ()vmcb->
_ü4
);

354 
	`´štk
("RSP = 0x%016llx RIP = 0x%016llx\n",

355 ()
vmcb
->
r¥
, ()vmcb->
r
);

356 
	`´štk
("RAX = 0x%016llx RFLAGS=0x%016llx\n",

357 ()
vmcb
->
¿x
, ()vmcb->
ræags
);

358 
	`´štk
("DR6 = 0x%016llx, DR7 = 0x%016llx\n",

359 ()
vmcb
->
_dr6
, ()vmcb->
_dr7
);

360 
	`´štk
("CSTAR = 0x%016llx SFMask = 0x%016llx\n",

361 ()
vmcb
->
c¡¬
,

362 ()
vmcb
->
sfmask
);

363 
	`´štk
("KernGSBase = 0x%016llx PAT = 0x%016llx \n",

364 ()
vmcb
->
k”ngsba£
,

365 ()
vmcb
->
_g_·t
);

366 
	`´štk
("H_CR3 = 0x%016llx CleanBits = 0x%08x\n",

367 ()
vmcb
->
_h_ü3
, vmcb->
ş—nb™s
.
by‹s
);

370 
	`svm_dump_£l
("CS", &
vmcb
->
cs
);

371 
	`svm_dump_£l
("DS", &
vmcb
->
ds
);

372 
	`svm_dump_£l
("SS", &
vmcb
->
ss
);

373 
	`svm_dump_£l
("ES", &
vmcb
->
es
);

374 
	`svm_dump_£l
("FS", &
vmcb
->
fs
);

375 
	`svm_dump_£l
("GS", &
vmcb
->
gs
);

376 
	`svm_dump_£l
("GDTR", &
vmcb
->
gdŒ
);

377 
	`svm_dump_£l
("LDTR", &
vmcb
->
ldŒ
);

378 
	`svm_dump_£l
("IDTR", &
vmcb
->
idŒ
);

379 
	`svm_dump_£l
("TR", &
vmcb
->
Œ
);

380 
	}
}

382 
	$vmcb_dump
(
ch
)

384 
domaš
 *
d
;

385 
vıu
 *
v
;

387 
	`´štk
("*********** VMCB Areas **************\n");

389 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

391 
	`fÜ_—ch_domaš
 ( 
d
 )

393 iàĞ!
	`is_hvm_domaš
(
d
) )

395 
	`´štk
("\n>>> Domaš %d <<<\n", 
d
->
domaš_id
);

396 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

398 
	`´štk
("\tVCPU %d\n", 
v
->
vıu_id
);

399 
	`svm_dump_vmcb
("key_hªdËr", 
v
->
¬ch
.
hvm_svm
.
vmcb
);

403 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

405 
	`´štk
("**************************************\n");

406 
	}
}

408 
keyhªdËr
 
	gvmcb_dump_keyhªdËr
 = {

409 .
dŸgno¡ic
 = 1,

410 .
	gu
.
	gâ
 = 
vmcb_dump
,

411 .
	gdesc
 = "dump AMD-V VMCBs"

414 
	$£tup_vmcb_dump
()

416 
	`»gi¡”_keyhªdËr
('v', &
vmcb_dump_keyhªdËr
);

417 
	}
}

	@hvm/svm/vpmu.c

25 
	~<x’/cÚfig.h
>

26 
	~<x’/sched.h
>

27 
	~<asm/sy¡em.h
>

28 
	~<asm/»gs.h
>

29 
	~<asm/ty³s.h
>

30 
	~<asm/­ic.h
>

31 
	~<asm/m¤.h
>

32 
	~<asm/m¤-šdex.h
>

33 
	~<asm/hvm/suµÜt.h
>

34 
	~<asm/hvm/vÏpic.h
>

35 
	~<public/sched.h
>

36 
	~<public/hvm/§ve.h
>

37 
	~<asm/hvm/vpmu.h
>

39 
	#NUM_COUNTERS
 4

	)

41 
	#MSR_F10H_EVNTSEL_GO_SHIFT
 40

	)

42 
	#MSR_F10H_EVNTSEL_EN_SHIFT
 22

	)

43 
	#MSR_F10H_COUNTER_LENGTH
 48

	)

45 
	#is_gue¡_mode
(
m¤
è((m¤è& (1ULL << 
MSR_F10H_EVNTSEL_GO_SHIFT
))

	)

46 
	#is_pmu_’abËd
(
m¤
è((m¤è& (1ULL << 
MSR_F10H_EVNTSEL_EN_SHIFT
))

	)

47 
	#£t_gue¡_mode
(
m¤
è(m¤ |ğ(1ULL << 
MSR_F10H_EVNTSEL_GO_SHIFT
))

	)

48 
	#is_ov”æowed
(
m¤
è(!((m¤è& (1ULL << (
MSR_F10H_COUNTER_LENGTH
-1))))

	)

51 
u32
 
	gAMD_F10H_COUNTERS
[] = {

52 
MSR_K7_PERFCTR0
,

53 
MSR_K7_PERFCTR1
,

54 
MSR_K7_PERFCTR2
,

55 
MSR_K7_PERFCTR3


59 
u32
 
	gAMD_F10H_CTRLS
[] = {

60 
MSR_K7_EVNTSEL0
,

61 
MSR_K7_EVNTSEL1
,

62 
MSR_K7_EVNTSEL2
,

63 
MSR_K7_EVNTSEL3


67 
	samd_vpmu_cÚ‹xt
 {

68 
u64
 
	mcouÁ”s
[
NUM_COUNTERS
];

69 
u64
 
	mù¾s
[
NUM_COUNTERS
];

70 
u32
 
	mhw_Ïpic_lvc
;

73 
šlše
 
	$g‘_pmu_»g_ty³
(
u32
 
addr
)

75 iàĞ(
addr
 >ğ
MSR_K7_EVNTSEL0
è&& (add¸<ğ
MSR_K7_EVNTSEL3
) )

76  
MSR_TYPE_CTRL
;

78 iàĞ(
addr
 >ğ
MSR_K7_PERFCTR0
è&& (add¸<ğ
MSR_K7_PERFCTR3
) )

79  
MSR_TYPE_COUNTER
;

83 
	}
}

86 
	$amd_vpmu_do_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

88 
vıu
 *
v
 = 
cu¼’t
;

89 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

90 
u32
 
vÏpic_lvc
;

91 
št_vec
;

93 iàĞ!
	`is_vÏpic_lvc_’abËd
(
vÏpic
) )

96 
vÏpic_lvc
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTPC
);

97 
št_vec
 = 
vÏpic_lvc
 & 
APIC_VECTOR_MASK
;

99 iàĞ
	`GET_APIC_DELIVERY_MODE
(
vÏpic_lvc
è=ğ
APIC_MODE_FIXED
 )

100 
	`vÏpic_£t_œq
(
	`vıu_vÏpic
(
v
), 
št_vec
, 0);

102 
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
);

105 
	}
}

107 
šlše
 
	$cÚ‹xt_»¡Üe
(
vıu
 *
v
)

109 
u64
 
i
;

110 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

111 
amd_vpmu_cÚ‹xt
 *
ùxt
 = 
vpmu
->
cÚ‹xt
;

113  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

114 
	`wrm¤l
(
AMD_F10H_CTRLS
[
i
], 
ùxt
->
ù¾s
[i]);

116  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

118 
	`wrm¤l
(
AMD_F10H_COUNTERS
[
i
], 
ùxt
->
couÁ”s
[i]);

122 iàĞ
	`is_ov”æowed
(
ùxt
->
couÁ”s
[
i
]) && (ctxt->counters[i] > 0) )

124 
	`gd´štk
(
XENLOG_WARNING
, "VPMU: Force‡…erformance counter "

126 
	`amd_vpmu_do_š‹¼u±
(0);

129 
	}
}

131 
	$amd_vpmu_»¡Üe
(
vıu
 *
v
)

133 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

134 
amd_vpmu_cÚ‹xt
 *
ùxt
 = 
vpmu
->
cÚ‹xt
;

136 iàĞ!((
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) &&

137 (
vpmu
->
æags
 & 
VPMU_RUNNING
)) )

140 
	`cÚ‹xt_»¡Üe
(
v
);

141 
	`­ic_wr™e
(
APIC_LVTPC
, 
ùxt
->
hw_Ïpic_lvc
);

142 
	}
}

144 
šlše
 
	$cÚ‹xt_§ve
(
vıu
 *
v
)

146 
i
;

147 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

148 
amd_vpmu_cÚ‹xt
 *
ùxt
 = 
vpmu
->
cÚ‹xt
;

150  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

151 
	`rdm¤l
(
AMD_F10H_COUNTERS
[
i
], 
ùxt
->
couÁ”s
[i]);

153  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

154 
	`rdm¤l
(
AMD_F10H_CTRLS
[
i
], 
ùxt
->
ù¾s
[i]);

155 
	}
}

157 
	$amd_vpmu_§ve
(
vıu
 *
v
)

159 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

160 
amd_vpmu_cÚ‹xt
 *
ùx
 = 
vpmu
->
cÚ‹xt
;

162 iàĞ!((
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) &&

163 (
vpmu
->
æags
 & 
VPMU_RUNNING
)) )

166 
	`cÚ‹xt_§ve
(
v
);

167 
ùx
->
hw_Ïpic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

168 
	`­ic_wr™e
(
APIC_LVTPC
, 
ùx
->
hw_Ïpic_lvc
 | 
APIC_LVT_MASKED
);

169 
	}
}

171 
	$cÚ‹xt_upd©e
(
m¤
, 
u64
 
m¤_cÚ‹Á
)

173 
i
;

174 
vıu
 *
v
 = 
cu¼’t
;

175 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

176 
amd_vpmu_cÚ‹xt
 *
ùxt
 = 
vpmu
->
cÚ‹xt
;

178  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

179 iàĞ
m¤
 =ğ
AMD_F10H_COUNTERS
[
i
] )

180 
ùxt
->
couÁ”s
[
i
] = 
m¤_cÚ‹Á
;

182  
i
 = 0; i < 
NUM_COUNTERS
; i++ )

183 iàĞ
m¤
 =ğ
AMD_F10H_CTRLS
[
i
] )

184 
ùxt
->
ù¾s
[
i
] = 
m¤_cÚ‹Á
;

186 
ùxt
->
hw_Ïpic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

187 
	}
}

189 
	$amd_vpmu_do_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

191 
vıu
 *
v
 = 
cu¼’t
;

192 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

195 iàĞ(
	`g‘_pmu_»g_ty³
(
m¤
è=ğ
MSR_TYPE_CTRL
) &&

196 !(
	`is_gue¡_mode
(
m¤_cÚ‹Á
)) )

198 
	`£t_gue¡_mode
(
m¤_cÚ‹Á
);

202 iàĞ(
	`g‘_pmu_»g_ty³
(
m¤
è=ğ
MSR_TYPE_CTRL
) &&

203 
	`is_pmu_’abËd
(
m¤_cÚ‹Á
è&& !(
vpmu
->
æags
 & 
VPMU_RUNNING
) )

205 iàĞ!
	`acquœe_pmu_owÃrsh
(
PMU_OWNER_HVM
) )

207 
vpmu
->
æags
 |ğ
VPMU_RUNNING
;

208 
	`­ic_wr™e
(
APIC_LVTPC
, 
PMU_APIC_VECTOR
);

212 iàĞ(
	`g‘_pmu_»g_ty³
(
m¤
è=ğ
MSR_TYPE_CTRL
) &&

213 (
	`is_pmu_’abËd
(
m¤_cÚ‹Á
è=ğ0è&& (
vpmu
->
æags
 & 
VPMU_RUNNING
) )

215 
	`­ic_wr™e
(
APIC_LVTPC
, 
PMU_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

216 
vpmu
->
æags
 &ğ~
VPMU_RUNNING
;

217 
	`»Ëa£_pmu_ownsh
(
PMU_OWNER_HVM
);

221 
	`cÚ‹xt_upd©e
(
m¤
, 
m¤_cÚ‹Á
);

224 
	`wrm¤l
(
m¤
, 
m¤_cÚ‹Á
);

226 
	}
}

228 
	$amd_vpmu_do_rdm¤
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

230 
	`rdm¤l
(
m¤
, *
m¤_cÚ‹Á
);

232 
	}
}

234 
	$amd_vpmu_š™Ÿli£
(
vıu
 *
v
)

236 
amd_vpmu_cÚ‹xt
 *
ùxt
 = 
NULL
;

237 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

239 iàĞ
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
 )

242 
ùxt
 = 
	`xm®loc_by‹s
((
amd_vpmu_cÚ‹xt
));

244 iàĞ!
ùxt
 )

246 
	`gd´štk
(
XENLOG_WARNING
, "Insufficient memory for PMU, "

248 
v
->
vıu_id
, v->
domaš
->
domaš_id
);

252 
	`mem£t
(
ùxt
, 0, (
amd_vpmu_cÚ‹xt
));

253 
vpmu
->
cÚ‹xt
 = (*)
ùxt
;

254 
vpmu
->
æags
 |ğ
VPMU_CONTEXT_ALLOCATED
;

255 
	}
}

257 
	$amd_vpmu_de¡roy
(
vıu
 *
v
)

259 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

261 iàĞ!(
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) )

264 
	`xä“
(
vpmu
->
cÚ‹xt
);

265 
vpmu
->
æags
 &ğ~
VPMU_CONTEXT_ALLOCATED
;

267 iàĞ
vpmu
->
æags
 & 
VPMU_RUNNING
 )

269 
vpmu
->
æags
 &ğ~
VPMU_RUNNING
;

270 
	`»Ëa£_pmu_ownsh
(
PMU_OWNER_HVM
);

272 
	}
}

274 
¬ch_vpmu_İs
 
	gamd_vpmu_İs
 = {

275 .
do_wrm¤
 = 
amd_vpmu_do_wrm¤
,

276 .
	gdo_rdm¤
 = 
amd_vpmu_do_rdm¤
,

277 .
	gdo_š‹¼u±
 = 
amd_vpmu_do_š‹¼u±
,

278 .
	g¬ch_vpmu_š™Ÿli£
 = 
amd_vpmu_š™Ÿli£
,

279 .
	g¬ch_vpmu_de¡roy
 = 
amd_vpmu_de¡roy
,

280 .
	g¬ch_vpmu_§ve
 = 
amd_vpmu_§ve
,

281 .
	g¬ch_vpmu_lßd
 = 
amd_vpmu_»¡Üe


	@hvm/vioapic.c

28 
	~<x’/cÚfig.h
>

29 
	~<x’/ty³s.h
>

30 
	~<x’/mm.h
>

31 
	~<x’/xm®loc.h
>

32 
	~<x’/lib.h
>

33 
	~<x’/”ºo.h
>

34 
	~<x’/sched.h
>

35 
	~<public/hvm/iÜeq.h
>

36 
	~<asm/hvm/io.h
>

37 
	~<asm/hvm/vpic.h
>

38 
	~<asm/hvm/vÏpic.h
>

39 
	~<asm/hvm/suµÜt.h
>

40 
	~<asm/cu¼’t.h
>

41 
	~<asm/ev’t.h
>

42 
	~<asm/io_­ic.h
>

45 
	#IRQ0_SPECIAL_ROUTING
 1

	)

47 
vißpic_d–iv”
(
hvm_hw_vißpic
 *
vißpic
, 
œq
);

49 
	$vißpic_»ad_šdœeù
(
hvm_hw_vißpic
 *
vißpic
,

50 
addr
,

51 
Ëngth
)

53 
»suÉ
 = 0;

55  
vißpic
->
iÜeg£l
 )

57 
VIOAPIC_REG_VERSION
:

58 
»suÉ
 = ((((
VIOAPIC_NUM_PINS
-1) & 0xff) << 16)

59 | (
VIOAPIC_VERSION_ID
 & 0xff));

62 #ià!
VIOAPIC_IS_IOSAPIC


63 
VIOAPIC_REG_APIC_ID
:

64 
VIOAPIC_REG_ARB_ID
:

65 
»suÉ
 = ((
vißpic
->
id
 & 0xf) << 24);

71 
ušt32_t
 
»dœ_šdex
 = (
vißpic
->
iÜeg£l
 - 0x10) >> 1;

72 
ušt64_t
 
»dœ_cÚ‹Á
;

74 iàĞ
»dœ_šdex
 >ğ
VIOAPIC_NUM_PINS
 )

76 
	`gd´štk
(
XENLOG_WARNING
, "apic_mem_readl:undefined ioregsel %x\n",

77 
vißpic
->
iÜeg£l
);

81 
»dœ_cÚ‹Á
 = 
vißpic
->
»dœtbl
[
»dœ_šdex
].
b™s
;

82 
»suÉ
 = (
vißpic
->
iÜeg£l
 & 0x1)?

83 (
»dœ_cÚ‹Á
 >> 32) & 0xffffffff :

84 
»dœ_cÚ‹Á
 & 0xffffffff;

89  
»suÉ
;

90 
	}
}

92 
	$vißpic_»ad
(

93 
vıu
 *
v
, 
addr
,

94 
Ëngth
, *
pv®
)

96 
hvm_hw_vißpic
 *
vißpic
 = 
	`domaš_vißpic
(
v
->
domaš
);

97 
ušt32_t
 
»suÉ
;

99 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "add¸%lx", 
addr
);

101 
addr
 &= 0xff;

103  
addr
 )

105 
VIOAPIC_REG_SELECT
:

106 
»suÉ
 = 
vißpic
->
iÜeg£l
;

109 
VIOAPIC_REG_WINDOW
:

110 
»suÉ
 = 
	`vißpic_»ad_šdœeù
(
vißpic
, 
addr
, 
Ëngth
);

114 
»suÉ
 = 0;

118 *
pv®
 = 
»suÉ
;

119  
X86EMUL_OKAY
;

120 
	}
}

122 
	$vißpic_wr™e_»dœ’t
(

123 
hvm_hw_vißpic
 *
vißpic
, 
idx
,

124 
tİ_wÜd
, 
ušt32_t
 
v®
)

126 
domaš
 *
d
 = 
	`vißpic_domaš
(
vißpic
);

127 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

128 
vißpic_»dœ_’Œy
 *
³Á
, 
’t
;

129 
unmasked
 = 0;

131 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

133 
³Á
 = &
vißpic
->
»dœtbl
[
idx
];

134 
’t
 = *
³Á
;

136 iàĞ
tİ_wÜd
 )

139 
’t
.
b™s
 = (
ušt32_t
ëÁ.b™ | ((
ušt64_t
)
v®
 << 32);

143 
unmasked
 = 
’t
.
f›lds
.
mask
;

145 
’t
.
b™s
 = (ÓÁ.b™ >> 32è<< 32è| 
v®
;

146 
’t
.
f›lds
.
d–iv”y_¡©us
 = 0;

147 
’t
.
f›lds
.
»mÙe_œr
 = 
³Á
->fields.remote_irr;

148 
unmasked
 = unmasked && !
’t
.
f›lds
.
mask
;

151 *
³Á
 = 
’t
;

153 iàĞ
idx
 == 0 )

155 
	`vÏpic_adju¡_i8259_rg‘
(
d
);

157 iàĞ(
’t
.
f›lds
.
Œig_mode
 =ğ
VIOAPIC_LEVEL_TRIG
) &&

158 !
’t
.
f›lds
.
mask
 &&

159 !
’t
.
f›lds
.
»mÙe_œr
 &&

160 
hvm_œq
->
gsi_as£¹_couÁ
[
idx
] )

162 
³Á
->
f›lds
.
»mÙe_œr
 = 1;

163 
	`vißpic_d–iv”
(
vißpic
, 
idx
);

166 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

168 iàĞ
idx
 =ğ0 || 
unmasked
 )

169 
	`±_may_unmask_œq
(
d
, 
NULL
);

170 
	}
}

172 
	$vißpic_wr™e_šdœeù
(

173 
hvm_hw_vißpic
 *
vißpic
, 
Ëngth
, 
v®
)

175  
vißpic
->
iÜeg£l
 )

177 
VIOAPIC_REG_VERSION
:

181 #ià!
VIOAPIC_IS_IOSAPIC


182 
VIOAPIC_REG_APIC_ID
:

183 
vißpic
->
id
 = (
v®
 >> 24) & 0xf;

186 
VIOAPIC_REG_ARB_ID
:

192 
ušt32_t
 
»dœ_šdex
 = (
vißpic
->
iÜeg£l
 - 0x10) >> 1;

194 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "change„edir index %x val %lx",

195 
»dœ_šdex
, 
v®
);

197 iàĞ
»dœ_šdex
 >ğ
VIOAPIC_NUM_PINS
 )

199 
	`gd´štk
(
XENLOG_WARNING
, "vioapic_write_indirect "

200 "”rÜ„egi¡” %x\n", 
vißpic
->
iÜeg£l
);

204 
	`vißpic_wr™e_»dœ’t
(

205 
vißpic
, 
»dœ_šdex
, vißpic->
iÜeg£l
&1, 
v®
);

209 
	}
}

211 
	$vißpic_wr™e
(

212 
vıu
 *
v
, 
addr
,

213 
Ëngth
, 
v®
)

215 
hvm_hw_vißpic
 *
vißpic
 = 
	`domaš_vißpic
(
v
->
domaš
);

217 
addr
 &= 0xff;

219  
addr
 )

221 
VIOAPIC_REG_SELECT
:

222 
vißpic
->
iÜeg£l
 = 
v®
;

225 
VIOAPIC_REG_WINDOW
:

226 
	`vißpic_wr™e_šdœeù
(
vißpic
, 
Ëngth
, 
v®
);

229 #ià
VIOAPIC_IS_IOSAPIC


230 
VIOAPIC_REG_EOI
:

231 
	`vißpic_upd©e_EOI
(
v
->
domaš
, 
v®
);

239  
X86EMUL_OKAY
;

240 
	}
}

242 
	$vißpic_¿nge
(
vıu
 *
v
, 
addr
)

244 
hvm_hw_vißpic
 *
vißpic
 = 
	`domaš_vißpic
(
v
->
domaš
);

246  ((
addr
 >ğ
vißpic
->
ba£_add»ss
 &&

247 (
addr
 < 
vißpic
->
ba£_add»ss
 + 
VIOAPIC_MEM_LENGTH
)));

248 
	}
}

250 cÚ¡ 
hvm_mmio_hªdËr
 
	gvißpic_mmio_hªdËr
 = {

251 .
check_hªdËr
 = 
vißpic_¿nge
,

252 .
	g»ad_hªdËr
 = 
vißpic_»ad
,

253 .
	gwr™e_hªdËr
 = 
vißpic_wr™e


256 
	$ißpic_šj_œq
(

257 
hvm_hw_vißpic
 *
vißpic
,

258 
vÏpic
 *
rg‘
,

259 
ušt8_t
 
veùÜ
,

260 
ušt8_t
 
Œig_mode
,

261 
ušt8_t
 
d–iv”y_mode
)

263 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "irq %drig %d deliv %d",

264 
veùÜ
, 
Œig_mode
, 
d–iv”y_mode
);

266 
	`ASSERT
((
d–iv”y_mode
 =ğ
de¡_Fixed
) ||

267 (
d–iv”y_mode
 =ğ
de¡_Lowe¡Prio
));

269 iàĞ
	`vÏpic_£t_œq
(
rg‘
, 
veùÜ
, 
Œig_mode
) )

270 
	`vıu_kick
(
	`vÏpic_vıu
(
rg‘
));

271 
	}
}

273 
šlše
 
	$p™_chªÃl0_’abËd
()

275 
PITS‹
 *
p™
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.
¶_time
.
vp™
;

276  
	`±_aùive
(&
p™
->
±0
);

277 
	}
}

279 
	$vißpic_d–iv”
(
hvm_hw_vißpic
 *
vißpic
, 
œq
)

281 
ušt16_t
 
de¡
 = 
vißpic
->
»dœtbl
[
œq
].
f›lds
.
de¡_id
;

282 
ušt8_t
 
de¡_mode
 = 
vißpic
->
»dœtbl
[
œq
].
f›lds
.dest_mode;

283 
ušt8_t
 
d–iv”y_mode
 = 
vißpic
->
»dœtbl
[
œq
].
f›lds
.delivery_mode;

284 
ušt8_t
 
veùÜ
 = 
vißpic
->
»dœtbl
[
œq
].
f›lds
.vector;

285 
ušt8_t
 
Œig_mode
 = 
vißpic
->
»dœtbl
[
œq
].
f›lds
.trig_mode;

286 
domaš
 *
d
 = 
	`vißpic_domaš
(
vißpic
);

287 
vÏpic
 *
rg‘
;

288 
vıu
 *
v
;

290 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
));

292 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
,

295 
de¡
, 
de¡_mode
, 
d–iv”y_mode
, 
veùÜ
, 
Œig_mode
);

297  
d–iv”y_mode
 )

299 
de¡_Lowe¡Prio
:

301 #ifdeà
IRQ0_SPECIAL_ROUTING


303 iàĞ(
œq
 =ğ
	`hvm_i§_œq_to_gsi
(0)è&& 
	`p™_chªÃl0_’abËd
() )

305 
v
 = 
d
->
vıu
 ? d->vıu[0] : 
NULL
;

306 
rg‘
 = 
v
 ? 
	`vıu_vÏpic
(vè: 
NULL
;

310 
rg‘
 = 
	`vÏpic_lowe¡_´io
(
d
, 
NULL
, 0, 
de¡
, 
de¡_mode
);

311 iàĞ
rg‘
 !ğ
NULL
 )

313 
	`ißpic_šj_œq
(
vißpic
, 
rg‘
, 
veùÜ
, 
Œig_mode
, 
d–iv”y_mode
);

317 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "null„ound„obin: "

319 
veùÜ
, 
de¡_Lowe¡Prio
);

324 
de¡_Fixed
:

326 #ifdeà
IRQ0_SPECIAL_ROUTING


328 iàĞ(
œq
 =ğ
	`hvm_i§_œq_to_gsi
(0)è&& 
	`p™_chªÃl0_’abËd
() )

330 iàĞ(
v
 = 
d
->
vıu
 ? d->vıu[0] : 
NULL
) != NULL )

331 
	`ißpic_šj_œq
(
vißpic
, 
	`vıu_vÏpic
(
v
), 
veùÜ
,

332 
Œig_mode
, 
d–iv”y_mode
);

337 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

338 iàĞ
	`vÏpic_m©ch_de¡
(
	`vıu_vÏpic
(
v
), 
NULL
,

339 0, 
de¡
, 
de¡_mode
) )

340 
	`ißpic_šj_œq
(
vißpic
, 
	`vıu_vÏpic
(
v
), 
veùÜ
,

341 
Œig_mode
, 
d–iv”y_mode
);

346 
de¡_NMI
:

348 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

349 iàĞ
	`vÏpic_m©ch_de¡
(
	`vıu_vÏpic
(
v
), 
NULL
,

350 0, 
de¡
, 
de¡_mode
) &&

351 !
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
) )

352 
	`vıu_kick
(
v
);

357 
	`gd´štk
(
XENLOG_WARNING
, "Unsupported delivery mode %d\n",

358 
d–iv”y_mode
);

361 
	}
}

363 
	$vißpic_œq_pos™ive_edge
(
domaš
 *
d
, 
œq
)

365 
hvm_hw_vißpic
 *
vißpic
 = 
	`domaš_vißpic
(
d
);

366 
vißpic_»dœ_’Œy
 *
’t
;

368 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "œq %x", 
œq
);

370 
	`ASSERT
(
œq
 < 
VIOAPIC_NUM_PINS
);

371 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
));

373 
’t
 = &
vißpic
->
»dœtbl
[
œq
];

374 iàĞ
’t
->
f›lds
.
mask
 )

377 iàĞ
’t
->
f›lds
.
Œig_mode
 =ğ
VIOAPIC_EDGE_TRIG
 )

379 
	`vißpic_d–iv”
(
vißpic
, 
œq
);

381 iàĞ!
’t
->
f›lds
.
»mÙe_œr
 )

383 
’t
->
f›lds
.
»mÙe_œr
 = 1;

384 
	`vißpic_d–iv”
(
vißpic
, 
œq
);

386 
	}
}

388 
	$vißpic_upd©e_EOI
(
domaš
 *
d
, 
veùÜ
)

390 
hvm_hw_vißpic
 *
vißpic
 = 
	`domaš_vißpic
(
d
);

391 
hvm_œq
 *hvm_œq = &
d
->
¬ch
.
hvm_domaš
.
œq
;

392 
vißpic_»dœ_’Œy
 *
’t
;

393 
gsi
;

395 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

397  
gsi
 = 0; gs˜< 
VIOAPIC_NUM_PINS
; gsi++ )

399 
’t
 = &
vißpic
->
»dœtbl
[
gsi
];

400 iàĞ
’t
->
f›lds
.
veùÜ
 != vector )

403 
’t
->
f›lds
.
»mÙe_œr
 = 0;

405 iàĞ
iommu_’abËd
 )

407 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

408 
	`hvm_dpci_eoi
(
d
, 
gsi
, 
’t
);

409 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

412 iàĞ(
’t
->
f›lds
.
Œig_mode
 =ğ
VIOAPIC_LEVEL_TRIG
) &&

413 !
’t
->
f›lds
.
mask
 &&

414 
hvm_œq
->
gsi_as£¹_couÁ
[
gsi
] )

416 
’t
->
f›lds
.
»mÙe_œr
 = 1;

417 
	`vißpic_d–iv”
(
vißpic
, 
gsi
);

421 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
œq_lock
);

422 
	}
}

424 
	$ißpic_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

426 
hvm_hw_vißpic
 *
s
 = 
	`domaš_vißpic
(
d
);

427  
	`hvm_§ve_’Œy
(
IOAPIC
, 0, 
h
, 
s
);

428 
	}
}

430 
	$ißpic_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

432 
hvm_hw_vißpic
 *
s
 = 
	`domaš_vißpic
(
d
);

433  
	`hvm_lßd_’Œy
(
IOAPIC
, 
h
, 
s
);

434 
	}
}

436 
HVM_REGISTER_SAVE_RESTORE
(
IOAPIC
, 
ißpic_§ve
, 
ißpic_lßd
, 1, 
HVMSR_PER_DOM
);

438 
	$vißpic_»£t
(
domaš
 *
d
)

440 
hvm_vißpic
 *
vißpic
 = 
d
->
¬ch
.
hvm_domaš
.vioapic;

441 
i
;

443 
	`mem£t
(&
vißpic
->
hvm_hw_vißpic
, 0, (vioapic->hvm_hw_vioapic));

444  
i
 = 0; i < 
VIOAPIC_NUM_PINS
; i++ )

445 
vißpic
->
hvm_hw_vißpic
.
»dœtbl
[
i
].
f›lds
.
mask
 = 1;

446 
vißpic
->
hvm_hw_vißpic
.
ba£_add»ss
 = 
VIOAPIC_DEFAULT_BASE_ADDRESS
;

447 
	}
}

449 
	$vißpic_š™
(
domaš
 *
d
)

451 iàĞ(
d
->
¬ch
.
hvm_domaš
.
vißpic
 =ğ
NULL
) &&

452 ((
d
->
¬ch
.
hvm_domaš
.
vißpic
 = 
	`xm®loc
(
hvm_vißpic
)è=ğ
NULL
) )

453  -
ENOMEM
;

455 
d
->
¬ch
.
hvm_domaš
.
vißpic
->
domaš
 = d;

456 
	`vißpic_»£t
(
d
);

459 
	}
}

461 
	$vißpic_deš™
(
domaš
 *
d
)

463 
	`xä“
(
d
->
¬ch
.
hvm_domaš
.
vißpic
);

464 
d
->
¬ch
.
hvm_domaš
.
vißpic
 = 
NULL
;

465 
	}
}

	@hvm/viridian.c

7 
	~<x’/sched.h
>

8 
	~<x’/v”siÚ.h
>

9 
	~<x’/³rfc.h
>

10 
	~<x’/hy³rÿÎ.h
>

11 
	~<x’/domaš_·ge.h
>

12 
	~<asm/·gšg.h
>

13 
	~<asm/p2m.h
>

14 
	~<asm/­ic.h
>

15 
	~<asm/hvm/suµÜt.h
>

16 
	~<public/sched.h
>

17 
	~<public/hvm/hvm_İ.h
>

20 
	#VIRIDIAN_MSR_GUEST_OS_ID
 0x40000000

	)

21 
	#VIRIDIAN_MSR_HYPERCALL
 0x40000001

	)

22 
	#VIRIDIAN_MSR_VP_INDEX
 0x40000002

	)

23 
	#VIRIDIAN_MSR_EOI
 0x40000070

	)

24 
	#VIRIDIAN_MSR_ICR
 0x40000071

	)

25 
	#VIRIDIAN_MSR_TPR
 0x40000072

	)

26 
	#VIRIDIAN_MSR_APIC_ASSIST
 0x40000073

	)

29 
	#HV_STATUS_SUCCESS
 0x0000

	)

30 
	#HV_STATUS_INVALID_HYPERCALL_CODE
 0x0002

	)

33 
	#HvNÙifyLÚgSpšWa™
 8

	)

36 
	#CPUID3A_MSR_APIC_ACCESS
 (1 << 4)

	)

37 
	#CPUID3A_MSR_HYPERCALL
 (1 << 5)

	)

38 
	#CPUID3A_MSR_VP_INDEX
 (1 << 6)

	)

41 
	#CPUID4A_MSR_BASED_APIC
 (1 << 3)

	)

42 
	#CPUID4A_RELAX_TIMER_INT
 (1 << 5)

	)

44 
	$ıuid_vœidŸn_Ëaves
(
Ëaf
, *
—x
,

45 *
ebx
, *
ecx
,

46 *
edx
)

48 
domaš
 *
d
 = 
cu¼’t
->domain;

50 iàĞ!
	`is_vœidŸn_domaš
(
d
) )

53 
Ëaf
 -= 0x40000000;

54 iàĞ
Ëaf
 > 6 )

57 *
—x
 = *
ebx
 = *
ecx
 = *
edx
 = 0;

58  
Ëaf
 )

61 *
—x
 = 0x40000006;

62 *
ebx
 = 0x7263694d;

63 *
ecx
 = 0x666F736F;

64 *
edx
 = 0x76482074;

67 *
—x
 = 0x31237648;

72 iàĞ
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
 == 0 )

74 *
—x
 = 1;

75 *
ebx
 = (
	`x’_majÜ_v”siÚ
(è<< 16è| 
	`x’_mšÜ_v”siÚ
();

76 *
ecx
 = 0;

77 *
edx
 = 0;

81 *
—x
 = (
CPUID3A_MSR_APIC_ACCESS
 |

82 
CPUID3A_MSR_HYPERCALL
 |

83 
CPUID3A_MSR_VP_INDEX
);

87 iàĞ(
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
 == 0) ||

88 (
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
os
 < 4) )

90 *
—x
 = (
CPUID4A_MSR_BASED_APIC
 |

91 
CPUID4A_RELAX_TIMER_INT
);

92 *
ebx
 = 2047;

97 
	}
}

99 
	$’abË_hy³rÿÎ_·ge
()

101 
domaš
 *
d
 = 
cu¼’t
->domain;

102 
gmâ
 = 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
hy³rÿÎ_g·
.
f›lds
.
pâ
;

103 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

104 
ušt8_t
 *
p
;

106 iàĞ!
	`mâ_v®id
(
mâ
) ||

107 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_wr™abË_·ge
) )

109 
	`gd´štk
(
XENLOG_WARNING
, "Bad GMFN %lx (MFN %lx)\n", 
gmâ
, 
mâ
);

113 
p
 = 
	`m­_domaš_·ge
(
mâ
);

119 *(
u8
 *)(
p
 + 0) = 0x0d;

120 *(
u32
 *)(
p
 + 1) = 0x80000000;

121 *(
u8
 *)(
p
 + 5) = 0x0f;

122 *(
u8
 *)(
p
 + 6) = 0x01;

123 *(
u8
 *)(
p
 + 7èğ((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

125 *(
u8
 *)(
p
 + 8) = 0xc3;

126 
	`mem£t
(
p
 + 9, 0xcc, 
PAGE_SIZE
 - 9);

128 
	`unm­_domaš_·ge
(
p
);

130 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

131 
	}
}

133 
	$wrm¤_vœidŸn_»gs
(
ušt32_t
 
idx
, 
ušt64_t
 
v®
)

135 
domaš
 *
d
 = 
cu¼’t
->domain;

137 iàĞ!
	`is_vœidŸn_domaš
(
d
) )

140  
idx
 )

142 
VIRIDIAN_MSR_GUEST_OS_ID
:

143 
	`³rfc_šü
(
mshv_wrm¤_osid
);

144 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
 = 
v®
;

145 
	`gd´štk
(
XENLOG_INFO
, "Guest os:\n");

146 
	`gd´štk
(
XENLOG_INFO
, "\tvendor: %x\n",

147 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
v’dÜ
);

148 
	`gd´štk
(
XENLOG_INFO
, "\tos: %x\n",

149 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
os
);

150 
	`gd´štk
(
XENLOG_INFO
, "\tmajor: %x\n",

151 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
majÜ
);

152 
	`gd´štk
(
XENLOG_INFO
, "\tminor: %x\n",

153 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
mšÜ
);

154 
	`gd´štk
(
XENLOG_INFO
, "\tsp: %x\n",

155 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
£rviû_·ck
);

156 
	`gd´štk
(
XENLOG_INFO
, "\tbuild: %x\n",

157 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
f›lds
.
bud_numb”
);

160 
VIRIDIAN_MSR_HYPERCALL
:

161 
	`³rfc_šü
(
mshv_wrm¤_hc_·ge
);

162 
	`gd´štk
(
XENLOG_INFO
, "S‘ hy³rÿÎ…ag%"
PRIx64
".\n", 
v®
);

163 iàĞ
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
 == 0 )

165 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
hy³rÿÎ_g·
.
¿w
 = 
v®
;

166 iàĞ
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
hy³rÿÎ_g·
.
f›lds
.
’abËd
 )

167 
	`’abË_hy³rÿÎ_·ge
();

170 
VIRIDIAN_MSR_VP_INDEX
:

171 
	`³rfc_šü
(
mshv_wrm¤_vp_šdex
);

172 
	`gd´štk
(
XENLOG_INFO
, "S‘ VP index %"
PRIu64
".\n", 
v®
);

175 
VIRIDIAN_MSR_EOI
:

176 
	`³rfc_šü
(
mshv_wrm¤_eoi
);

177 
	`vÏpic_EOI_£t
(
	`vıu_vÏpic
(
cu¼’t
));

180 
VIRIDIAN_MSR_ICR
: {

181 
u32
 
—x
 = (u32)
v®
, 
edx
 = (u32)(val >> 32);

182 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
cu¼’t
);

183 
	`³rfc_šü
(
mshv_wrm¤_iü
);

184 
—x
 &= ~(1 << 12);

185 
edx
 &= 0xff000000;

186 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR2
, 
edx
);

187 iàĞ
	`vÏpic_i
(
vÏpic
, 
—x
, 
edx
è=ğ
X86EMUL_OKAY
 )

188 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR
, 
—x
);

192 
VIRIDIAN_MSR_TPR
:

193 
	`³rfc_šü
(
mshv_wrm¤_r
);

194 
	`vÏpic_£t_»g
(
	`vıu_vÏpic
(
cu¼’t
), 
APIC_TASKPRI
, (
ušt8_t
)
v®
);

197 
VIRIDIAN_MSR_APIC_ASSIST
:

213 iàĞ
v®
 & 1 )

215 
ušt32_t
 
wÜd
 = 0;

216 
·ddr_t
 
·ge_¡¬t
 = 
v®
 & ~1ul;

217 ()
	`hvm_cİy_to_gue¡_phys
(
·ge_¡¬t
, &
wÜd
, (word));

226 
	}
}

228 
	$rdm¤_vœidŸn_»gs
(
ušt32_t
 
idx
, 
ušt64_t
 *
v®
)

230 
vıu
 *
v
 = 
cu¼’t
;

232 iàĞ!
	`is_vœidŸn_domaš
(
v
->
domaš
) )

235  
idx
 )

237 
VIRIDIAN_MSR_GUEST_OS_ID
:

238 
	`³rfc_šü
(
mshv_rdm¤_osid
);

239 *
v®
 = 
v
->
domaš
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
;

242 
VIRIDIAN_MSR_HYPERCALL
:

243 
	`³rfc_šü
(
mshv_rdm¤_hc_·ge
);

244 *
v®
 = 
v
->
domaš
->
¬ch
.
hvm_domaš
.
vœidŸn
.
hy³rÿÎ_g·
.
¿w
;

247 
VIRIDIAN_MSR_VP_INDEX
:

248 
	`³rfc_šü
(
mshv_rdm¤_vp_šdex
);

249 *
v®
 = 
v
->
vıu_id
;

252 
VIRIDIAN_MSR_ICR
:

253 
	`³rfc_šü
(
mshv_rdm¤_iü
);

254 *
v®
 = (((
ušt64_t
)
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_ICR2
) << 32) |

255 
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_ICR
));

258 
VIRIDIAN_MSR_TPR
:

259 
	`³rfc_šü
(
mshv_rdm¤_r
);

260 *
v®
 = 
	`vÏpic_g‘_»g
(
	`vıu_vÏpic
(
v
), 
APIC_TASKPRI
);

268 
	}
}

270 
	$vœidŸn_hy³rÿÎ
(
ıu_u£r_»gs
 *
»gs
)

272 
mode
 = 
	`hvm_gue¡_x86_mode
(
cu¼’t
);

273 
šput_·¿ms_g·
, 
ouut_·¿ms_g·
;

274 
ušt16_t
 
¡©us
 = 
HV_STATUS_SUCCESS
;

276 
	uhy³rÿÎ_šput
 {

277 
ušt64_t
 
¿w
;

279 
ušt16_t
 
ÿÎ_code
;

280 
ušt16_t
 
rsvd1
;

281 
»p_couÁ
:12;

282 
rsvd2
:4;

283 
»p_¡¬t
:12;

284 
rsvd3
:4;

286 } 
šput
;

288 
	uhy³rÿÎ_ouut
 {

289 
ušt64_t
 
¿w
;

291 
ušt16_t
 
»suÉ
;

292 
ušt16_t
 
rsvd1
;

293 
»p_com¶‘e
:12;

294 
rsvd2
:20;

296 } 
ouut
 = { 0 };

298 
	`ASSERT
(
	`is_vœidŸn_domaš
(
cu¼’t
->
domaš
));

300  
mode
 )

302 #ifdeà
__x86_64__


304 
šput
.
¿w
 = 
»gs
->
rcx
;

305 
šput_·¿ms_g·
 = 
»gs
->
rdx
;

306 
ouut_·¿ms_g·
 = 
»gs
->
r8
;

310 
šput
.
¿w
 = ((
ušt64_t
)
»gs
->
edx
 << 32è|„egs->
—x
;

311 
šput_·¿ms_g·
 = ((
ušt64_t
)
»gs
->
ebx
 << 32è|„egs->
ecx
;

312 
ouut_·¿ms_g·
 = ((
ušt64_t
)
»gs
->
edi
 << 32è|„egs->
esi
;

315 
out
;

318  
šput
.
ÿÎ_code
 )

320 
HvNÙifyLÚgSpšWa™
:

321 
	`³rfc_šü
(
mshv_ÿÎ_lÚg_wa™
);

322 
	`do_sched_İ_com·t
(
SCHEDOP_y›ld
, 0);

323 
¡©us
 = 
HV_STATUS_SUCCESS
;

326 
¡©us
 = 
HV_STATUS_INVALID_HYPERCALL_CODE
;

330 
out
:

331 
ouut
.
»suÉ
 = 
¡©us
;

332 
mode
) {

333 #ifdeà
__x86_64__


335 
»gs
->
¿x
 = 
ouut
.
¿w
;

339 
»gs
->
edx
 = 
ouut
.
¿w
 >> 32;

340 
»gs
->
—x
 = 
ouut
.
¿w
;

344  
HVM_HCALL_com¶‘ed
;

345 
	}
}

347 
	$vœidŸn_§ve_ıu_ùxt
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

349 
hvm_vœidŸn_cÚ‹xt
 
ùxt
;

351 iàĞ!
	`is_vœidŸn_domaš
(
d
) )

354 
ùxt
.
hy³rÿÎ_g·
 = 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.hy³rÿÎ_g·.
¿w
;

355 
ùxt
.
gue¡_os_id
 = 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.gue¡_os_id.
¿w
;

357  (
	`hvm_§ve_’Œy
(
VIRIDIAN
, 0, 
h
, &
ùxt
) != 0);

358 
	}
}

360 
	$vœidŸn_lßd_ıu_ùxt
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

362 
hvm_vœidŸn_cÚ‹xt
 
ùxt
;

364 iàĞ
	`hvm_lßd_’Œy
(
VIRIDIAN
, 
h
, &
ùxt
) != 0 )

365  -
EINVAL
;

367 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
hy³rÿÎ_g·
.
¿w
 = 
ùxt
.hypercall_gpa;

368 
d
->
¬ch
.
hvm_domaš
.
vœidŸn
.
gue¡_os_id
.
¿w
 = 
ùxt
.guest_os_id;

371 
	}
}

373 
HVM_REGISTER_SAVE_RESTORE
(
VIRIDIAN
, 
vœidŸn_§ve_ıu_ùxt
,

374 
vœidŸn_lßd_ıu_ùxt
, 1, 
HVMSR_PER_DOM
);

	@hvm/vlapic.c

21 
	~<x’/cÚfig.h
>

22 
	~<x’/ty³s.h
>

23 
	~<x’/mm.h
>

24 
	~<x’/xm®loc.h
>

25 
	~<x’/domaš.h
>

26 
	~<x’/domaš_·ge.h
>

27 
	~<x’/ev’t.h
>

28 
	~<x’/Œaû.h
>

29 
	~<x’/lib.h
>

30 
	~<x’/sched.h
>

31 
	~<x’/numa.h
>

32 
	~<asm/cu¼’t.h
>

33 
	~<asm/·ge.h
>

34 
	~<asm/­ic.h
>

35 
	~<asm/io_­ic.h
>

36 
	~<asm/hvm/hvm.h
>

37 
	~<asm/hvm/io.h
>

38 
	~<asm/hvm/suµÜt.h
>

39 
	~<asm/hvm/vmx/vmx.h
>

40 
	~<public/hvm/iÜeq.h
>

41 
	~<public/hvm/·¿ms.h
>

43 
	#VLAPIC_VERSION
 0x00050014

	)

44 
	#VLAPIC_LVT_NUM
 6

	)

47 
	#APIC_BUS_CYCLE_NS
 10

	)

49 
	#LVT_MASK
 \

50 
APIC_LVT_MASKED
 | 
APIC_SEND_PENDING
 | 
APIC_VECTOR_MASK


	)

52 
	#LINT_MASK
 \

53 
LVT_MASK
 | 
APIC_MODE_MASK
 | 
APIC_INPUT_POLARITY
 |\

54 
APIC_LVT_REMOTE_IRR
 | 
APIC_LVT_LEVEL_TRIGGER


	)

56 
	gvÏpic_lvt_mask
[
VLAPIC_LVT_NUM
] =

59 
LVT_MASK
 | 
APIC_TIMER_MODE_MASK
,

61 
LVT_MASK
 | 
APIC_MODE_MASK
,

63 
LVT_MASK
 | 
APIC_MODE_MASK
,

65 
LINT_MASK
, LINT_MASK,

67 
LVT_MASK


71 
	#APIC_SHORT_MASK
 0xc0000

	)

72 
	#APIC_DEST_NOSHORT
 0x0

	)

73 
	#APIC_DEST_MASK
 0x800

	)

75 
	#vÏpic_lvt_veùÜ
(
vÏpic
, 
lvt_ty³
) \

76 (
	`vÏpic_g‘_»g
(
vÏpic
, 
lvt_ty³
è& 
APIC_VECTOR_MASK
)

	)

78 
	#vÏpic_lvt_dm
(
vÏpic
, 
lvt_ty³
) \

79 (
	`vÏpic_g‘_»g
(
vÏpic
, 
lvt_ty³
è& 
APIC_MODE_MASK
)

	)

81 
	#vÏpic_lv‰_³riod
(
vÏpic
) \

82 ((
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTT
è& 
APIC_TIMER_MODE_MASK
) \

83 =ğ
APIC_TIMER_MODE_PERIODIC
)

	)

85 
	#vÏpic_lv‰_ÚeshÙ
(
vÏpic
) \

86 ((
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTT
è& 
APIC_TIMER_MODE_MASK
) \

87 =ğ
APIC_TIMER_MODE_ONESHOT
)

	)

89 
	#vÏpic_lv‰_tdt
(
vÏpic
) \

90 ((
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTT
è& 
APIC_TIMER_MODE_MASK
) \

91 =ğ
APIC_TIMER_MODE_TSC_DEADLINE
)

	)

98 
	#VEC_POS
(
v
è((v)%32)

	)

99 
	#REG_POS
(
v
è(((v)/32è* 0x10)

	)

100 
	#vÏpic_‹¡_ªd_£t_veùÜ
(
vec
, 
b™m­
) \

101 
	`‹¡_ªd_£t_b™
(
	`VEC_POS
(
vec
), \

102 (*)((
b™m­
è+ 
	`REG_POS
(
vec
)))

	)

103 
	#vÏpic_‹¡_ªd_ş—r_veùÜ
(
vec
, 
b™m­
) \

104 
	`‹¡_ªd_ş—r_b™
(
	`VEC_POS
(
vec
), \

105 (*)((
b™m­
è+ 
	`REG_POS
(
vec
)))

	)

106 
	#vÏpic_£t_veùÜ
(
vec
, 
b™m­
) \

107 
	`£t_b™
(
	`VEC_POS
(
vec
), (*)((
b™m­
è+ 
	`REG_POS
(vec)))

	)

108 
	#vÏpic_ş—r_veùÜ
(
vec
, 
b™m­
) \

109 
	`ş—r_b™
(
	`VEC_POS
(
vec
), (*)((
b™m­
è+ 
	`REG_POS
(vec)))

	)

111 
	$vÏpic_fšd_highe¡_veùÜ
(*
b™m­
)

113 
ušt32_t
 *
wÜd
 = 
b™m­
;

114 
wÜd_off£t
 = 
MAX_VECTOR
 / 32;

117  (
wÜd_off£t
 !ğ0è&& (
wÜd
[(--word_offset)*4] == 0) )

120  (
	`æs
(
wÜd
[
wÜd_off£t
*4]) - 1) + (word_offset * 32);

121 
	}
}

128 
	$vÏpic_‹¡_ªd_£t_œr
(
veùÜ
, 
vÏpic
 *vlapic)

130  
	`vÏpic_‹¡_ªd_£t_veùÜ
(
veùÜ
, &
vÏpic
->
»gs
->
d©a
[
APIC_IRR
]);

131 
	}
}

133 
	$vÏpic_ş—r_œr
(
veùÜ
, 
vÏpic
 *vlapic)

135 
	`vÏpic_ş—r_veùÜ
(
veùÜ
, &
vÏpic
->
»gs
->
d©a
[
APIC_IRR
]);

136 
	}
}

138 
	$vÏpic_fšd_highe¡_œr
(
vÏpic
 *vlapic)

140  
	`vÏpic_fšd_highe¡_veùÜ
(&
vÏpic
->
»gs
->
d©a
[
APIC_IRR
]);

141 
	}
}

143 
	$vÏpic_£t_œq
(
vÏpic
 *vÏpic, 
ušt8_t
 
vec
, ušt8_ˆ
Œig
)

145 
»t
;

147 
»t
 = !
	`vÏpic_‹¡_ªd_£t_œr
(
vec
, 
vÏpic
);

148 iàĞ
Œig
 )

149 
	`vÏpic_£t_veùÜ
(
vec
, &
vÏpic
->
»gs
->
d©a
[
APIC_TMR
]);

152  
»t
;

153 
	}
}

155 
	$vÏpic_fšd_highe¡_i¤
(
vÏpic
 *vlapic)

157  
	`vÏpic_fšd_highe¡_veùÜ
(&
vÏpic
->
»gs
->
d©a
[
APIC_ISR
]);

158 
	}
}

160 
ušt32_t
 
	$vÏpic_g‘_µr
(
vÏpic
 *vlapic)

162 
ušt32_t
 
r
, 
i¤v
, 
µr
;

163 
i¤
;

165 
r
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_TASKPRI
);

166 
i¤
 = 
	`vÏpic_fšd_highe¡_i¤
(
vÏpic
);

167 
i¤v
 = (
i¤
 != -1) ? isr : 0;

169 iàĞ(
r
 & 0xf0è>ğ(
i¤v
 & 0xf0) )

170 
µr
 = 
r
 & 0xff;

172 
µr
 = 
i¤v
 & 0xf0;

174 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_INTERRUPT
,

176 
vÏpic
, 
µr
, 
i¤
, 
i¤v
);

178  
µr
;

179 
	}
}

181 
	$vÏpic_m©ch_logiÿl_addr
(
vÏpic
 *vÏpic, 
ušt8_t
 
mda
)

183 
»suÉ
 = 0;

184 
ušt32_t
 
logiÿl_id
;

186 iàĞ
	`vÏpic_x2­ic_mode
(
vÏpic
) )

188 
logiÿl_id
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LDR
);

189  !!(
logiÿl_id
 & 
mda
);

192 
logiÿl_id
 = 
	`GET_xAPIC_LOGICAL_ID
(
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LDR
));

194  
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_DFR
) )

196 
APIC_DFR_FLAT
:

197 iàĞ
logiÿl_id
 & 
mda
 )

198 
»suÉ
 = 1;

200 
APIC_DFR_CLUSTER
:

201 iàĞ((
logiÿl_id
 >> 4è=ğ(
mda
 >> 0x4)) && (logical_id & mda & 0xf) )

202 
»suÉ
 = 1;

205 
	`gd´štk
(
XENLOG_WARNING
, "Bad DFR value for†apic of vcpu %d: %08x\n",

206 
	`vÏpic_vıu
(
vÏpic
)->
vıu_id
,

207 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_DFR
));

211  
»suÉ
;

212 
	}
}

214 
boŞ_t
 
	$vÏpic_m©ch_de¡
(

215 
vÏpic
 *
rg‘
, vÏpiø*
sourû
,

216 
shÜt_hªd
, 
ušt8_t
 
de¡
, ušt8_ˆ
de¡_mode
)

218 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
, "target %p, source %p, dest 0x%x, "

220 
rg‘
, 
sourû
, 
de¡
, 
de¡_mode
, 
shÜt_hªd
);

222  
shÜt_hªd
 )

224 
APIC_DEST_NOSHORT
:

225 iàĞ
de¡_mode
 )

226  
	`vÏpic_m©ch_logiÿl_addr
(
rg‘
, 
de¡
);

227  ((
de¡
 =ğ0xFFè|| (de¡ =ğ
	`VLAPIC_ID
(
rg‘
)));

229 
APIC_DEST_SELF
:

230  (
rg‘
 =ğ
sourû
);

232 
APIC_DEST_ALLINC
:

235 
APIC_DEST_ALLBUT
:

236  (
rg‘
 !ğ
sourû
);

239 
	`gd´štk
(
XENLOG_WARNING
, "Bad de¡ shÜthªd v®u%x\n", 
shÜt_hªd
);

244 
	}
}

246 
	$vÏpic_š™_si_aùiÚ
(
_vıu
)

248 
vıu
 *
Üigš
 = (vıu *)
_vıu
;

249 
vıu
 *
rg‘
 = 
	`vıu_vÏpic
(
Üigš
)->
š™_si
.target;

250 
ušt32_t
 
iü
 = 
	`vıu_vÏpic
(
Üigš
)->
š™_si
.icr;

252 
	`vıu_·u£
(
rg‘
);

254  
iü
 & 
APIC_MODE_MASK
 )

256 
APIC_DM_INIT
: {

257 
boŞ_t
 
åu_š™Ÿli£d
;

258 
	`domaš_lock
(
rg‘
->
domaš
);

260 
åu_š™Ÿli£d
 = 
rg‘
->fpu_initialised;

261 
	`vıu_»£t
(
rg‘
);

262 
rg‘
->
åu_š™Ÿli£d
 = fpu_initialised;

263 
	`vÏpic_»£t
(
	`vıu_vÏpic
(
rg‘
));

264 
	`domaš_uÆock
(
rg‘
->
domaš
);

268 
APIC_DM_STARTUP
: {

269 
ušt16_t
 
»£t_cs
 = (
iü
 & 0xffu) << 8;

270 
	`hvm_vıu_»£t_¡©e
(
rg‘
, 
»£t_cs
, 0);

275 
	`BUG
();

278 
	`vıu_uÅau£
(
rg‘
);

280 
	`vıu_vÏpic
(
Üigš
)->
š™_si
.
rg‘
 = 
NULL
;

281 
	`vıu_uÅau£
(
Üigš
);

282 
	}
}

284 
	$vÏpic_scheduË_š™_si_skËt
(
vıu
 *
rg‘
, 
ušt32_t
 
iü
)

286 
vıu
 *
Üigš
 = 
cu¼’t
;

288 iàĞ
	`vıu_vÏpic
(
Üigš
)->
š™_si
.
rg‘
 !ğ
NULL
 )

290 
	`WARN
();

291  
X86EMUL_UNHANDLEABLE
;

294 
	`vıu_·u£_nosync
(
Üigš
);

296 
	`vıu_vÏpic
(
Üigš
)->
š™_si
.
rg‘
 =arget;

297 
	`vıu_vÏpic
(
Üigš
)->
š™_si
.
iü
 = icr;

298 
	`skËt_scheduË
(&
	`vıu_vÏpic
(
Üigš
)->
š™_si
.
skËt
);

300  
X86EMUL_RETRY
;

301 
	}
}

304 
	$vÏpic_acû±_œq
(
vıu
 *
v
, 
ušt32_t
 
iü_low
)

306 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

307 
ušt8_t
 
veùÜ
 = (ušt8_t)
iü_low
;

308 
rc
 = 
X86EMUL_OKAY
;

310  
iü_low
 & 
APIC_MODE_MASK
 )

312 
APIC_DM_FIXED
:

313 
APIC_DM_LOWEST
:

314 iàĞ
	`vÏpic_’abËd
(
vÏpic
) &&

315 !
	`vÏpic_‹¡_ªd_£t_œr
(
veùÜ
, 
vÏpic
) )

316 
	`vıu_kick
(
v
);

319 
APIC_DM_REMRD
:

320 
	`gd´štk
(
XENLOG_WARNING
, "Ignoring delivery mode 3\n");

323 
APIC_DM_SMI
:

324 
	`gd´štk
(
XENLOG_WARNING
, "Ignoring guest SMI\n");

327 
APIC_DM_NMI
:

328 iàĞ!
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
) )

329 
	`vıu_kick
(
v
);

332 
APIC_DM_INIT
:

334 iàĞ(
iü_low
 & (
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
)) ==

335 
APIC_INT_LEVELTRIG
 )

338 iàĞ!
v
->
is_š™Ÿli£d
 )

340 
	`hvm_vıu_down
(
v
);

341 
rc
 = 
	`vÏpic_scheduË_š™_si_skËt
(
v
, 
iü_low
);

344 
APIC_DM_STARTUP
:

346 iàĞ
v
->
is_š™Ÿli£d
 )

348 
rc
 = 
	`vÏpic_scheduË_š™_si_skËt
(
v
, 
iü_low
);

352 
	`gd´štk
(
XENLOG_ERR
, "TODO: unsupported delivery mode in ICR %x\n",

353 
iü_low
);

354 
	`domaš_üash
(
v
->
domaš
);

357  
rc
;

358 
	}
}

360 
vÏpic
 *
	$vÏpic_lowe¡_´io
(

361 
domaš
 *
d
, 
vÏpic
 *
sourû
,

362 
shÜt_hªd
, 
ušt8_t
 
de¡
, ušt8_ˆ
de¡_mode
)

364 
Şd
 = 
d
->
¬ch
.
hvm_domaš
.
œq
.
round_robš_´ev_vıu
;

365 
ušt32_t
 
µr
, 
rg‘_µr
 = 
UINT_MAX
;

366 
vÏpic
 *vÏpic, *
rg‘
 = 
NULL
;

367 
vıu
 *
v
;

369 iàĞ
	`uÆik–y
(!
d
->
vıu
è|| uÆik–y((
v
 = d->vıu[
Şd
]è=ğ
NULL
) )

370  
NULL
;

373 
v
 = v->
Ãxt_š_li¡
 ? : 
d
->
vıu
[0];

374 
vÏpic
 = 
	`vıu_vÏpic
(
v
);

375 iàĞ
	`vÏpic_m©ch_de¡
(
vÏpic
, 
sourû
, 
shÜt_hªd
, 
de¡
, 
de¡_mode
) &&

376 
	`vÏpic_’abËd
(
vÏpic
) &&

377 ((
µr
 = 
	`vÏpic_g‘_µr
(
vÏpic
)è< 
rg‘_µr
) )

379 
rg‘
 = 
vÏpic
;

380 
rg‘_µr
 = 
µr
;

382 }  
v
->
vıu_id
 !ğ
Şd
 );

384 iàĞ
rg‘
 !ğ
NULL
 )

385 
d
->
¬ch
.
hvm_domaš
.
œq
.
round_robš_´ev_vıu
 =

386 
	`vÏpic_vıu
(
rg‘
)->
vıu_id
;

388  
rg‘
;

389 
	}
}

391 
	$vÏpic_EOI_£t
(
vÏpic
 *vlapic)

393 
veùÜ
 = 
	`vÏpic_fšd_highe¡_i¤
(
vÏpic
);

396 iàĞ
veùÜ
 == -1 )

399 
	`vÏpic_ş—r_veùÜ
(
veùÜ
, &
vÏpic
->
»gs
->
d©a
[
APIC_ISR
]);

401 iàĞ
	`vÏpic_‹¡_ªd_ş—r_veùÜ
(
veùÜ
, &
vÏpic
->
»gs
->
d©a
[
APIC_TMR
]) )

402 
	`vißpic_upd©e_EOI
(
	`vÏpic_domaš
(
vÏpic
), 
veùÜ
);

404 
	`hvm_dpci_msi_eoi
(
cu¼’t
->
domaš
, 
veùÜ
);

405 
	}
}

407 
	$vÏpic_i
(

408 
vÏpic
 *vÏpic, 
ušt32_t
 
iü_low
, ušt32_ˆ
iü_high
)

410 
de¡
;

411 
shÜt_hªd
 = 
iü_low
 & 
APIC_SHORT_MASK
;

412 
de¡_mode
 = !!(
iü_low
 & 
APIC_DEST_MASK
);

413 
vÏpic
 *
rg‘
;

414 
vıu
 *
v
;

415 
rc
 = 
X86EMUL_OKAY
;

417 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
, "iü = 0x%08x:%08x", 
iü_high
, 
iü_low
);

419 
de¡
 = (
	`vÏpic_x2­ic_mode
(
vÏpic
)

420 ? 
iü_high


421 : 
	`GET_xAPIC_DEST_FIELD
(
iü_high
));

423 iàĞ(
iü_low
 & 
APIC_MODE_MASK
è=ğ
APIC_DM_LOWEST
 )

425 
rg‘
 = 
	`vÏpic_lowe¡_´io
(
	`vÏpic_domaš
(
vÏpic
), vlapic,

426 
shÜt_hªd
, 
de¡
, 
de¡_mode
);

427 iàĞ
rg‘
 !ğ
NULL
 )

428 
rc
 = 
	`vÏpic_acû±_œq
(
	`vÏpic_vıu
(
rg‘
), 
iü_low
);

429  
rc
;

432 
	`fÜ_—ch_vıu
 ( 
	`vÏpic_domaš
(
vÏpic
), 
v
 )

434 iàĞ
	`vÏpic_m©ch_de¡
(
	`vıu_vÏpic
(
v
), 
vÏpic
,

435 
shÜt_hªd
, 
de¡
, 
de¡_mode
) )

436 
rc
 = 
	`vÏpic_acû±_œq
(
v
, 
iü_low
);

437 iàĞ
rc
 !ğ
X86EMUL_OKAY
 )

441  
rc
;

442 
	}
}

444 
ušt32_t
 
	$vÏpic_g‘_tmcù
(
vÏpic
 *vlapic)

446 
vıu
 *
v
 = 
cu¼’t
;

447 
ušt32_t
 
tmcù
 = 0, 
tmiù
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_TMICT
);

448 
ušt64_t
 
couÁ”_·s£d
;

450 
couÁ”_·s£d
 = ((
	`hvm_g‘_gue¡_time
(
v
è- 
vÏpic
->
tim”_Ï¡_upd©e
)

451 / (
APIC_BUS_CYCLE_NS
 * 
vÏpic
->
hw
.
tim”_divisÜ
));

453 iàĞ
tmiù
 != 0 )

455 iàĞ
	`vÏpic_lv‰_³riod
(
vÏpic
) )

456 
couÁ”_·s£d
 %ğ
tmiù
;

457 iàĞ
couÁ”_·s£d
 < 
tmiù
 )

458 
tmcù
 = 
tmiù
 - 
couÁ”_·s£d
;

461 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
,

463 "off£ˆ%"
PRId64
,

464 
tmiù
, 
tmcù
, 
couÁ”_·s£d
);

466  
tmcù
;

467 
	}
}

469 
	$vÏpic_£t_tdü
(
vÏpic
 *vÏpic, 
v®
)

472 
v®
 &= 0xb;

473 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TDCR
, 
v®
);

476 
v®
 = ((val & 3) | ((val & 8) >> 1)) + 1;

477 
vÏpic
->
hw
.
tim”_divisÜ
 = 1 << (
v®
 & 7);

479 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
,

480 "tim”_divisÜ: %d", 
vÏpic
->
hw
.
tim”_divisÜ
);

481 
	}
}

483 
	$vÏpic_»ad_®igÃd
(

484 
vÏpic
 *vÏpic, 
off£t
, *
»suÉ
)

486  
off£t
 )

488 
APIC_PROCPRI
:

489 *
»suÉ
 = 
	`vÏpic_g‘_µr
(
vÏpic
);

492 
APIC_TMCCT
:

493 iàĞ!
	`vÏpic_lv‰_ÚeshÙ
(
vÏpic
è&& !
	`vÏpic_lv‰_³riod
(vlapic) )

495 *
»suÉ
 = 0;

498 *
»suÉ
 = 
	`vÏpic_g‘_tmcù
(
vÏpic
);

501 
APIC_TMICT
:

502 iàĞ!
	`vÏpic_lv‰_ÚeshÙ
(
vÏpic
è&& !
	`vÏpic_lv‰_³riod
(vlapic) )

504 *
»suÉ
 = 0;

508 *
»suÉ
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
off£t
);

511 
	}
}

513 
	$vÏpic_»ad
(

514 
vıu
 *
v
, 
add»ss
,

515 
Ën
, *
pv®
)

517 
®ignm’t
;

518 
tmp
;

519 
»suÉ
 = 0;

520 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

521 
off£t
 = 
add»ss
 - 
	`vÏpic_ba£_add»ss
(
vÏpic
);

523 iàĞ
off£t
 > (
APIC_TDCR
 + 0x3) )

524 
out
;

526 
®ignm’t
 = 
off£t
 & 0x3;

528 
	`vÏpic_»ad_®igÃd
(
vÏpic
, 
off£t
 & ~0x3, &
tmp
);

529  
Ën
 )

532 
»suÉ
 = *((*)&
tmp
 + 
®ignm’t
);

536 iàĞ
®ignm’t
 == 3 )

537 
uÇligÃd_ex™_ªd_üash
;

538 
»suÉ
 = *(*)((*)&
tmp
 + 
®ignm’t
);

542 iàĞ
®ignm’t
 != 0 )

543 
uÇligÃd_ex™_ªd_üash
;

544 
»suÉ
 = *(*)((*)&
tmp
 + 
®ignm’t
);

548 
	`gd´štk
(
XENLOG_ERR
, "Local APIC„ead with†en=0x%lx, "

549 "should b4 in¡—d.\n", 
Ën
);

550 
ex™_ªd_üash
;

553 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
, "offset 0x%x with†ength 0x%lx, "

554 "ªdh»suÉ i 0x%lx", 
off£t
, 
Ën
, 
»suÉ
);

556 
out
:

557 *
pv®
 = 
»suÉ
;

558  
X86EMUL_OKAY
;

560 
uÇligÃd_ex™_ªd_üash
:

561 
	`gd´štk
(
XENLOG_ERR
, "Unaligned LAPIC„ead†en=0x%lx‡t offset=0x%x.\n",

562 
Ën
, 
off£t
);

563 
ex™_ªd_üash
:

564 
	`domaš_üash
(
v
->
domaš
);

565  
X86EMUL_OKAY
;

566 
	}
}

568 
	$hvm_x2­ic_m¤_»ad
(
vıu
 *
v
, 
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

570 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

571 
ušt32_t
 
low
, 
high
 = 0, 
off£t
 = (
m¤
 - 
MSR_IA32_APICBASE_MSR
) << 4;

573 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

576 
	`vÏpic_»ad_®igÃd
(
vÏpic
, 
off£t
, &
low
);

577 iàĞ
off£t
 =ğ
APIC_ICR
 )

578 
	`vÏpic_»ad_®igÃd
(
vÏpic
, 
APIC_ICR2
, &
high
);

580 *
m¤_cÚ‹Á
 = (((
ušt64_t
)
high
è<< 32è| 
low
;

582 
	}
}

584 
	$vÏpic_±_cb
(
vıu
 *
v
, *
d©a
)

586 *(
s_time_t
 *)
d©a
 = 
	`hvm_g‘_gue¡_time
(
v
);

587 
	}
}

589 
	$vÏpic_tdt_±_cb
(
vıu
 *
v
, *
d©a
)

591 *(
s_time_t
 *)
d©a
 = 
	`hvm_g‘_gue¡_time
(
v
);

592 
	`vıu_vÏpic
(
v
)->
hw
.
tdt_m¤
 = 0;

593 
	}
}

595 
	$vÏpic_»g_wr™e
(
vıu
 *
v
,

596 
off£t
, 
v®
)

598 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

599 
rc
 = 
X86EMUL_OKAY
;

601  
off£t
 )

603 
APIC_ID
:

604 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

605 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ID
, 
v®
);

607 
rc
 = 
X86EMUL_UNHANDLEABLE
;

610 
APIC_TASKPRI
:

611 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TASKPRI
, 
v®
 & 0xff);

614 
APIC_EOI
:

615 
	`vÏpic_EOI_£t
(
vÏpic
);

618 
APIC_LDR
:

619 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

620 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LDR
, 
v®
 & 
APIC_LDR_MASK
);

622 
rc
 = 
X86EMUL_UNHANDLEABLE
;

625 
APIC_DFR
:

626 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

627 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_DFR
, 
v®
 | 0x0FFFFFFF);

629 
rc
 = 
X86EMUL_UNHANDLEABLE
;

632 
APIC_SPIV
:

633 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_SPIV
, 
v®
 & 0x3ff);

635 iàĞ!(
v®
 & 
APIC_SPIV_APIC_ENABLED
) )

637 
i
;

638 
ušt32_t
 
lvt_v®
;

640 
vÏpic
->
hw
.
di§bËd
 |ğ
VLAPIC_SW_DISABLED
;

642  
i
 = 0; i < 
VLAPIC_LVT_NUM
; i++ )

644 
lvt_v®
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTT
 + 0x10 * 
i
);

645 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LVTT
 + 0x10 * 
i
,

646 
lvt_v®
 | 
APIC_LVT_MASKED
);

651 
vÏpic
->
hw
.
di§bËd
 &ğ~
VLAPIC_SW_DISABLED
;

652 
	`±_may_unmask_œq
(
	`vÏpic_domaš
(
vÏpic
), &vÏpic->
±
);

656 
APIC_ESR
:

657 iàĞ
	`vÏpic_x2­ic_mode
(
vÏpic
è&& (
v®
 != 0) )

659 
	`gd´štk
(
XENLOG_ERR
, "Local APIC write ESR with‚on-zero %lx\n",

660 
v®
);

661 
rc
 = 
X86EMUL_UNHANDLEABLE
;

665 
APIC_SELF_IPI
:

666 iàĞ
	`vÏpic_x2­ic_mode
(
vÏpic
) )

667 
	`vÏpic_»g_wr™e
(
v
, 
APIC_ICR
, 0x40000 | (
v®
 & 0xff));

669 
rc
 = 
X86EMUL_UNHANDLEABLE
;

672 
APIC_ICR
:

673 
v®
 &= ~(1 << 12);

674 
rc
 = 
	`vÏpic_i
(
vÏpic
, 
v®
, 
	`vÏpic_g‘_»g
(vÏpic, 
APIC_ICR2
));

675 iàĞ
rc
 =ğ
X86EMUL_OKAY
 )

676 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR
, 
v®
);

679 
APIC_ICR2
:

680 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

681 
v®
 &= 0xff000000;

682 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR2
, 
v®
);

685 
APIC_LVTT
:

686 iàĞ(
	`vÏpic_g‘_»g
(
vÏpic
, 
off£t
è& 
APIC_TIMER_MODE_MASK
) !=

687 (
v®
 & 
APIC_TIMER_MODE_MASK
) )

689 
	`de¡roy_³riodic_time
(&
vÏpic
->
±
);

690 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMICT
, 0);

691 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMCCT
, 0);

692 
vÏpic
->
hw
.
tdt_m¤
 = 0;

694 
vÏpic
->
±
.
œq
 = 
v®
 & 
APIC_VECTOR_MASK
;

695 
APIC_LVTTHMR
:

696 
APIC_LVTPC
:

697 
APIC_LVT0
:

698 
APIC_LVT1
:

699 
APIC_LVTERR
:

700 iàĞ
	`vÏpic_sw_di§bËd
(
vÏpic
) )

701 
v®
 |ğ
APIC_LVT_MASKED
;

702 
v®
 &ğ
vÏpic_lvt_mask
[(
off£t
 - 
APIC_LVTT
) >> 4];

703 
	`vÏpic_£t_»g
(
vÏpic
, 
off£t
, 
v®
);

704 iàĞ
off£t
 =ğ
APIC_LVT0
 )

706 
	`vÏpic_adju¡_i8259_rg‘
(
v
->
domaš
);

707 
	`±_may_unmask_œq
(
v
->
domaš
, 
NULL
);

709 iàĞ(
off£t
 =ğ
APIC_LVTT
è&& !(
v®
 & 
APIC_LVT_MASKED
) )

710 
	`±_may_unmask_œq
(
NULL
, &
vÏpic
->
±
);

713 
APIC_TMICT
:

715 
ušt64_t
 
³riod
;

717 iàĞ!
	`vÏpic_lv‰_ÚeshÙ
(
vÏpic
è&& !
	`vÏpic_lv‰_³riod
(vlapic) )

720 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMICT
, 
v®
);

721 iàĞ
v®
 == 0 )

723 
	`de¡roy_³riodic_time
(&
vÏpic
->
±
);

727 
³riod
 = ((
ušt64_t
)
APIC_BUS_CYCLE_NS
 *

728 (
ušt32_t
)
v®
 * 
vÏpic
->
hw
.
tim”_divisÜ
);

729 
	`ü—‹_³riodic_time
(
cu¼’t
, &
vÏpic
->
±
, 
³riod
,

730 
	`vÏpic_lv‰_³riod
(
vÏpic
è? 
³riod
 : 0,

731 
vÏpic
->
±
.
œq
,

732 
	`vÏpic_lv‰_³riod
(
vÏpic
è? 
vÏpic_±_cb
 : 
NULL
,

733 &
vÏpic
->
tim”_Ï¡_upd©e
);

734 
vÏpic
->
tim”_Ï¡_upd©e
 = vÏpic->
±
.
Ï¡_¶t_gtime
;

736 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
,

738 "š™ŸÈcouÁ %lu,…”iod %"
PRIu64
"ns",

739 
APIC_BUS_CYCLE_NS
, 
v®
, 
³riod
);

743 
APIC_TDCR
:

744 
	`vÏpic_£t_tdü
(
vÏpic
, 
v®
 & 0xb);

745 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
, "timer divisor is 0x%x",

746 
vÏpic
->
hw
.
tim”_divisÜ
);

752 ià(
rc
 =ğ
X86EMUL_UNHANDLEABLE
)

753 
	`gd´štk
(
XENLOG_DEBUG
,

754 "LoÿÈAPIC Wr™wrÚgØ»gi¡” 0x%x\n", 
off£t
);

755  
rc
;

756 
	}
}

758 
	$vÏpic_wr™e
(
vıu
 *
v
, 
add»ss
,

759 
Ën
, 
v®
)

761 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

762 
off£t
 = 
add»ss
 - 
	`vÏpic_ba£_add»ss
(
vÏpic
);

763 
rc
 = 
X86EMUL_OKAY
;

765 iàĞ
off£t
 != 0xb0 )

766 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
,

768 
off£t
, 
Ën
, 
v®
);

774 
v®
 = (
ušt32_t
)val;

775 iàĞ
Ën
 != 4 )

777 
tmp
;

778 
®ignm’t
;

780 
	`gd´štk
(
XENLOG_INFO
, "NÙiû: LoÿÈAPIC wr™w™h†’ = %lx\n",
Ën
);

782 
®ignm’t
 = 
off£t
 & 0x3;

783 ()
	`vÏpic_»ad_®igÃd
(
vÏpic
, 
off£t
 & ~0x3, &
tmp
);

785  
Ën
 )

788 
v®
 = ((
tmp
 & ~(0xfà<< (8*
®ignm’t
))) |

789 ((
v®
 & 0xffè<< (8*
®ignm’t
)));

793 iàĞ
®ignm’t
 & 1 )

794 
uÇligÃd_ex™_ªd_üash
;

795 
v®
 = ((
tmp
 & ~(0xfffà<< (8*
®ignm’t
))) |

796 ((
v®
 & 0xffffè<< (8*
®ignm’t
)));

800 
	`gd´štk
(
XENLOG_ERR
, "Local APIC write with†en = %lx, "

801 "should b4 in¡—d\n", 
Ën
);

802 
ex™_ªd_üash
;

805 iàĞ(
off£t
 & 0x3) != 0 )

806 
uÇligÃd_ex™_ªd_üash
;

808 
off£t
 &= ~0x3;

810  
	`vÏpic_»g_wr™e
(
v
, 
off£t
, 
v®
);

812 
uÇligÃd_ex™_ªd_üash
:

813 
	`gd´štk
(
XENLOG_ERR
, "Unaligned LAPIC write†en=0x%lx‡t offset=0x%x.\n",

814 
Ën
, 
off£t
);

815 
ex™_ªd_üash
:

816 
	`domaš_üash
(
v
->
domaš
);

817  
rc
;

818 
	}
}

820 
	$hvm_x2­ic_m¤_wr™e
(
vıu
 *
v
, 
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

822 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

823 
ušt32_t
 
off£t
 = (
m¤
 - 
MSR_IA32_APICBASE_MSR
) << 4;

824 
rc
;

826 iàĞ!
	`vÏpic_x2­ic_mode
(
vÏpic
) )

829 iàĞ
off£t
 =ğ
APIC_ICR
 )

830 iàĞ
	`vÏpic_»g_wr™e
(
v
, 
APIC_ICR2
 , (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32)) )

833 
rc
 = 
	`vÏpic_»g_wr™e
(
v
, 
off£t
, (
ušt32_t
)
m¤_cÚ‹Á
);

836  ((
rc
 !ğ
X86EMUL_OKAY
è&& (rø!ğ
X86EMUL_RETRY
));

837 
	}
}

839 
	$vÏpic_¿nge
(
vıu
 *
v
, 
addr
)

841 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

842 
off£t
 = 
addr
 - 
	`vÏpic_ba£_add»ss
(
vÏpic
);

843  (!
	`vÏpic_hw_di§bËd
(
vÏpic
è&& (
off£t
 < 
PAGE_SIZE
));

844 
	}
}

846 cÚ¡ 
hvm_mmio_hªdËr
 
	gvÏpic_mmio_hªdËr
 = {

847 .
check_hªdËr
 = 
vÏpic_¿nge
,

848 .
	g»ad_hªdËr
 = 
vÏpic_»ad
,

849 .
	gwr™e_hªdËr
 = 
vÏpic_wr™e


852 
	$vÏpic_m¤_£t
(
vÏpic
 *vÏpic, 
ušt64_t
 
v®ue
)

854 iàĞ(
vÏpic
->
hw
.
­ic_ba£_m¤
 ^ 
v®ue
è& 
MSR_IA32_APICBASE_ENABLE
 )

856 iàĞ
v®ue
 & 
MSR_IA32_APICBASE_ENABLE
 )

858 
	`vÏpic_»£t
(
vÏpic
);

859 
vÏpic
->
hw
.
di§bËd
 &ğ~
VLAPIC_HW_DISABLED
;

860 
	`±_may_unmask_œq
(
	`vÏpic_domaš
(
vÏpic
), &vÏpic->
±
);

864 
vÏpic
->
hw
.
di§bËd
 |ğ
VLAPIC_HW_DISABLED
;

865 
	`±_may_unmask_œq
(
	`vÏpic_domaš
(
vÏpic
), 
NULL
);

869 
vÏpic
->
hw
.
­ic_ba£_m¤
 = 
v®ue
;

871 iàĞ
	`vÏpic_x2­ic_mode
(
vÏpic
) )

873 
u32
 
id
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_ID
);

874 
u32
 
ldr
 = ((
id
 & ~0xf) << 16) | (1 << (id & 0xf));

875 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LDR
, 
ldr
);

878 
	`vmx_vÏpic_m¤_chªged
(
	`vÏpic_vıu
(
vÏpic
));

880 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
,

881 "­iøba£ m¤ i 0x%016"
PRIx64
, 
vÏpic
->
hw
.
­ic_ba£_m¤
);

882 
	}
}

884 
ušt64_t
 
	$vÏpic_tdt_m¤_g‘
(
vÏpic
 *vlapic)

886 iàĞ!
	`vÏpic_lv‰_tdt
(
vÏpic
) )

889  
vÏpic
->
hw
.
tdt_m¤
;

890 
	}
}

892 
	$vÏpic_tdt_m¤_£t
(
vÏpic
 *vÏpic, 
ušt64_t
 
v®ue
)

894 
ušt64_t
 
gue¡_tsc
;

895 
ušt64_t
 
gue¡_time
;

896 
vıu
 *
v
 = 
	`vÏpic_vıu
(
vÏpic
);

899 iàĞ!
	`vÏpic_lv‰_tdt
(
vÏpic
) )

901 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
, "ignoresc deadline msr write");

906 
gue¡_tsc
 = 
	`hvm_g‘_gue¡_tsc
(
v
);

907 
gue¡_time
 = 
	`hvm_g‘_gue¡_time
(
v
);

908 iàĞ
v®ue
 > 
gue¡_tsc
 )

910 
ušt64_t
 
d–
 = 
v®ue
 - 
v
->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
;

911 
d–
 = 
	`gtsc_to_gtime
(
v
->
domaš
, delta);

912 
d–
 = 
	`max_t
(
s64
, d– - 
gue¡_time
, 0);

914 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
, "d–[0x%016"
PRIx64
"]", 
d–
);

916 
vÏpic
->
hw
.
tdt_m¤
 = 
v®ue
;

918 
	`ü—‹_³riodic_time
(
v
, &
vÏpic
->
±
, 
d–
, 0,

919 
vÏpic
->
±
.
œq
, 
vÏpic_tdt_±_cb
,

920 &
vÏpic
->
tim”_Ï¡_upd©e
);

921 
vÏpic
->
tim”_Ï¡_upd©e
 = vÏpic->
±
.
Ï¡_¶t_gtime
;

925 
vÏpic
->
hw
.
tdt_m¤
 = 0;

928 iàĞ
v®ue
 > 0 )

930 
	`ü—‹_³riodic_time
(
v
, &
vÏpic
->
±
, 0, 0,

931 
vÏpic
->
±
.
œq
, 
vÏpic_tdt_±_cb
,

932 &
vÏpic
->
tim”_Ï¡_upd©e
);

933 
vÏpic
->
tim”_Ï¡_upd©e
 = vÏpic->
±
.
Ï¡_¶t_gtime
;

938 
	`de¡roy_³riodic_time
(&
vÏpic
->
±
);

941 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
, "v®ue[0x%016"
PRIx64
"]", 
v®ue
);

944 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC_TIMER
,

945 "tdt_m¤[0x%016"
PRIx64
"],"

946 " gtsc[0x%016"
PRIx64
"],"

947 " gtime[0x%016"
PRIx64
"]",

948 
vÏpic
->
hw
.
tdt_m¤
, 
gue¡_tsc
, 
gue¡_time
);

949 
	}
}

951 
	$__vÏpic_acû±_pic_šŒ
(
vıu
 *
v
)

953 
domaš
 *
d
 = 
v
->domain;

954 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

955 
ušt32_t
 
lvt0
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVT0
);

956 
vißpic_»dœ_’Œy
 
»dœ0
 = 
	`domaš_vißpic
(
d
)->
»dœtbl
[0];

960 ((
»dœ0
.
f›lds
.
d–iv”y_mode
 =ğ
de¡_ExtINT
) &&

961 !
»dœ0
.
f›lds
.
mask
 &&

962 
»dœ0
.
f›lds
.
de¡_id
 =ğ
	`VLAPIC_ID
(
vÏpic
) &&

963 !
	`vÏpic_di§bËd
(
vÏpic
)) ||

965 ((
lvt0
 & (
APIC_MODE_MASK
|
APIC_LVT_MASKED
)è=ğ
APIC_DM_EXTINT
) ||

967 
	`vÏpic_hw_di§bËd
(
vÏpic
)));

968 
	}
}

970 
	$vÏpic_acû±_pic_šŒ
(
vıu
 *
v
)

972  ((
v
 =ğv->
domaš
->
¬ch
.
hvm_domaš
.
i8259_rg‘
) &&

973 
	`__vÏpic_acû±_pic_šŒ
(
v
));

974 
	}
}

976 
	$vÏpic_adju¡_i8259_rg‘
(
domaš
 *
d
)

978 
vıu
 *
v
;

980 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

981 iàĞ
	`__vÏpic_acû±_pic_šŒ
(
v
) )

982 
found
;

984 
v
 = 
d
->
vıu
 ? d->vıu[0] : 
NULL
;

986 
found
:

987 iàĞ
d
->
¬ch
.
hvm_domaš
.
i8259_rg‘
 =ğ
v
 )

989 
d
->
¬ch
.
hvm_domaš
.
i8259_rg‘
 = 
v
;

990 
	`±_adju¡_glob®_vıu_rg‘
(
v
);

991 
	}
}

993 
	$vÏpic_has_³ndšg_œq
(
vıu
 *
v
)

995 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

996 
œr
, 
i¤
;

998 iàĞ!
	`vÏpic_’abËd
(
vÏpic
) )

1001 
œr
 = 
	`vÏpic_fšd_highe¡_œr
(
vÏpic
);

1002 iàĞ
œr
 == -1 )

1005 
i¤
 = 
	`vÏpic_fšd_highe¡_i¤
(
vÏpic
);

1006 
i¤
 = (isr != -1) ? isr : 0;

1007 iàĞ(
i¤
 & 0xf0è>ğ(
œr
 & 0xf0) )

1010  
œr
;

1011 
	}
}

1013 
	$vÏpic_ack_³ndšg_œq
(
vıu
 *
v
, 
veùÜ
)

1015 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1017 
	`vÏpic_£t_veùÜ
(
veùÜ
, &
vÏpic
->
»gs
->
d©a
[
APIC_ISR
]);

1018 
	`vÏpic_ş—r_œr
(
veùÜ
, 
vÏpic
);

1021 
	}
}

1023 
boŞ_t
 
	$is_vÏpic_lvc_’abËd
(
vÏpic
 *vlapic)

1025  (
	`vÏpic_’abËd
(
vÏpic
) &&

1026 !(
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTPC
è& 
APIC_LVT_MASKED
));

1027 
	}
}

1030 
	$vÏpic_»£t
(
vÏpic
 *vlapic)

1032 
vıu
 *
v
 = 
	`vÏpic_vıu
(
vÏpic
);

1033 
i
;

1035 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ID
, (
v
->
vıu_id
 * 2) << 24);

1036 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LVR
, 
VLAPIC_VERSION
);

1038  
i
 = 0; i < 8; i++ )

1040 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_IRR
 + 0x10 * 
i
, 0);

1041 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ISR
 + 0x10 * 
i
, 0);

1042 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMR
 + 0x10 * 
i
, 0);

1044 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR
, 0);

1045 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_ICR2
, 0);

1046 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LDR
, 0);

1047 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TASKPRI
, 0);

1048 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMICT
, 0);

1049 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TMCCT
, 0);

1050 
	`vÏpic_£t_tdü
(
vÏpic
, 0);

1052 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_DFR
, 0xffffffffU);

1054  
i
 = 0; i < 
VLAPIC_LVT_NUM
; i++ )

1055 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LVTT
 + 0x10 * 
i
, 
APIC_LVT_MASKED
);

1057 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_SPIV
, 0xff);

1058 
vÏpic
->
hw
.
di§bËd
 |ğ
VLAPIC_SW_DISABLED
;

1060 
	`de¡roy_³riodic_time
(&
vÏpic
->
±
);

1061 
	}
}

1064 
	$Ïpic_»¬m
(
vÏpic
 *
s
)

1066 
tmiù
;

1067 
ušt64_t
 
³riod
, 
tdt_m¤
;

1069 
s
->
±
.
œq
 = 
	`vÏpic_g‘_»g
(s, 
APIC_LVTT
è& 
APIC_VECTOR_MASK
;

1071 iàĞ
	`vÏpic_lv‰_tdt
(
s
) )

1073 iàĞ(
tdt_m¤
 = 
	`vÏpic_tdt_m¤_g‘
(
s
)) != 0 )

1074 
	`vÏpic_tdt_m¤_£t
(
s
, 
tdt_m¤
);

1078 iàĞ(
tmiù
 = 
	`vÏpic_g‘_»g
(
s
, 
APIC_TMICT
)) == 0 )

1081 
³riod
 = ((
ušt64_t
)
APIC_BUS_CYCLE_NS
 *

1082 (
ušt32_t
)
tmiù
 * 
s
->
hw
.
tim”_divisÜ
);

1083 
	`ü—‹_³riodic_time
(
	`vÏpic_vıu
(
s
), &s->
±
, 
³riod
,

1084 
	`vÏpic_lv‰_³riod
(
s
è? 
³riod
 : 0,

1085 
s
->
±
.
œq
,

1086 
	`vÏpic_lv‰_³riod
(
s
è? 
vÏpic_±_cb
 : 
NULL
,

1087 &
s
->
tim”_Ï¡_upd©e
);

1088 
s
->
tim”_Ï¡_upd©e
 = s->
±
.
Ï¡_¶t_gtime
;

1089 
	}
}

1091 
	$Ïpic_§ve_hidd’
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

1093 
vıu
 *
v
;

1094 
vÏpic
 *
s
;

1095 
rc
 = 0;

1097 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1099 
s
 = 
	`vıu_vÏpic
(
v
);

1100 iàĞ(
rc
 = 
	`hvm_§ve_’Œy
(
LAPIC
, 
v
->
vıu_id
, 
h
, &
s
->
hw
)) != 0 )

1104  
rc
;

1105 
	}
}

1107 
	$Ïpic_§ve_»gs
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

1109 
vıu
 *
v
;

1110 
vÏpic
 *
s
;

1111 
rc
 = 0;

1113 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1115 
s
 = 
	`vıu_vÏpic
(
v
);

1116 iàĞ(
rc
 = 
	`hvm_§ve_’Œy
(
LAPIC_REGS
, 
v
->
vıu_id
, 
h
, 
s
->
»gs
)) != 0 )

1120  
rc
;

1121 
	}
}

1123 
	$Ïpic_lßd_hidd’
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

1125 
ušt16_t
 
vıuid
;

1126 
vıu
 *
v
;

1127 
vÏpic
 *
s
;

1130 
vıuid
 = 
	`hvm_lßd_š¡ªû
(
h
);

1131 iàĞ
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[vıuid]è=ğ
NULL
 )

1133 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: domaš ha nØvÏpiø%u\n", 
vıuid
);

1134  -
EINVAL
;

1136 
s
 = 
	`vıu_vÏpic
(
v
);

1138 iàĞ
	`hvm_lßd_’Œy_z”Ûx‹nd
(
LAPIC
, 
h
, &
s
->
hw
) != 0 )

1139  -
EINVAL
;

1141 
	`vmx_vÏpic_m¤_chªged
(
v
);

1144 
	}
}

1146 
	$Ïpic_lßd_»gs
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

1148 
ušt16_t
 
vıuid
;

1149 
vıu
 *
v
;

1150 
vÏpic
 *
s
;

1153 
vıuid
 = 
	`hvm_lßd_š¡ªû
(
h
);

1154 iàĞ
vıuid
 >ğ
d
->
max_vıus
 || (
v
 = d->
vıu
[vıuid]è=ğ
NULL
 )

1156 
	`gd´štk
(
XENLOG_ERR
, "HVM„e¡Üe: domaš ha nØvÏpiø%u\n", 
vıuid
);

1157  -
EINVAL
;

1159 
s
 = 
	`vıu_vÏpic
(
v
);

1161 iàĞ
	`hvm_lßd_’Œy
(
LAPIC_REGS
, 
h
, 
s
->
»gs
) != 0 )

1162  -
EINVAL
;

1164 
	`vÏpic_adju¡_i8259_rg‘
(
d
);

1165 
	`Ïpic_»¬m
(
s
);

1167 
	}
}

1169 
HVM_REGISTER_SAVE_RESTORE
(
LAPIC
, 
Ïpic_§ve_hidd’
, 
Ïpic_lßd_hidd’
,

1170 1, 
HVMSR_PER_VCPU
);

1171 
HVM_REGISTER_SAVE_RESTORE
(
LAPIC_REGS
, 
Ïpic_§ve_»gs
, 
Ïpic_lßd_»gs
,

1172 1, 
HVMSR_PER_VCPU
);

1174 
	$vÏpic_š™
(
vıu
 *
v
)

1176 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1177 
memæags
 = 
	`MEMF_node
(
	`vıu_to_node
(
v
));

1179 
	`HVM_DBG_LOG
(
DBG_LEVEL_VLAPIC
, "%d", 
v
->
vıu_id
);

1181 
vÏpic
->
±
.
sourû
 = 
PTSRC_Ïpic
;

1183 #ifdeà
__i386__


1185 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

1186 
memæags
 |ğ
	`MEMF_b™s
(32);

1188 ià(
vÏpic
->
»gs_·ge
 =ğ
NULL
)

1190 
vÏpic
->
»gs_·ge
 = 
	`®loc_domh—p_·ge
(
NULL
, 
memæags
);

1191 iàĞ
vÏpic
->
»gs_·ge
 =ğ
NULL
 )

1193 
	`d´štk
(
XENLOG_ERR
, "alloc vlapic„egsƒrror: %d/%d\n",

1194 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

1195  -
ENOMEM
;

1198 ià(
vÏpic
->
»gs
 =ğ
NULL
)

1200 
vÏpic
->
»gs
 = 
	`__m­_domaš_·ge_glob®
(vÏpic->
»gs_·ge
);

1201 iàĞ
vÏpic
->
»gs
 =ğ
NULL
 )

1203 
	`d´štk
(
XENLOG_ERR
, "map vlapic„egsƒrror: %d/%d\n",

1204 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

1205  -
ENOMEM
;

1208 
	`ş—r_·ge
(
vÏpic
->
»gs
);

1210 
	`vÏpic_»£t
(
vÏpic
);

1212 
vÏpic
->
hw
.
­ic_ba£_m¤
 = (
MSR_IA32_APICBASE_ENABLE
 |

1213 
APIC_DEFAULT_PHYS_BASE
);

1214 iàĞ
v
->
vıu_id
 == 0 )

1215 
vÏpic
->
hw
.
­ic_ba£_m¤
 |ğ
MSR_IA32_APICBASE_BSP
;

1217 
	`skËt_š™
(&
vÏpic
->
š™_si
.
skËt
,

1218 
vÏpic_š™_si_aùiÚ
,

1219 ()
v
);

1222 
	}
}

1224 
	$vÏpic_de¡roy
(
vıu
 *
v
)

1226 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1228 
	`skËt_kl
(&
vÏpic
->
š™_si
.
skËt
);

1229 
	`de¡roy_³riodic_time
(&
vÏpic
->
±
);

1230 
	`unm­_domaš_·ge_glob®
(
vÏpic
->
»gs
);

1231 
	`ä“_domh—p_·ge
(
vÏpic
->
»gs_·ge
);

1232 
	}
}

	@hvm/vmsi.c

28 
	~<x’/cÚfig.h
>

29 
	~<x’/ty³s.h
>

30 
	~<x’/mm.h
>

31 
	~<x’/xm®loc.h
>

32 
	~<x’/lib.h
>

33 
	~<x’/”ºo.h
>

34 
	~<x’/sched.h
>

35 
	~<public/hvm/iÜeq.h
>

36 
	~<asm/hvm/io.h
>

37 
	~<asm/hvm/vpic.h
>

38 
	~<asm/hvm/vÏpic.h
>

39 
	~<asm/hvm/suµÜt.h
>

40 
	~<asm/cu¼’t.h
>

41 
	~<asm/ev’t.h
>

42 
	~<asm/io_­ic.h
>

44 
	$vmsi_šj_œq
(

45 
domaš
 *
d
,

46 
vÏpic
 *
rg‘
,

47 
ušt8_t
 
veùÜ
,

48 
ušt8_t
 
Œig_mode
,

49 
ušt8_t
 
d–iv”y_mode
)

51 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "vmsi_inj_irq "

53 
veùÜ
, 
Œig_mode
, 
d–iv”y_mode
);

55  
d–iv”y_mode
 )

57 
de¡_Fixed
:

58 
de¡_Lowe¡Prio
:

59 iàĞ
	`vÏpic_£t_œq
(
rg‘
, 
veùÜ
, 
Œig_mode
) )

60 
	`vıu_kick
(
	`vÏpic_vıu
(
rg‘
));

63 
	`gd´štk
(
XENLOG_WARNING
, "”rÜ d–iv”y mod%d\n", 
d–iv”y_mode
);

66 
	}
}

68 
	$vmsi_d–iv”
(
domaš
 *
d
, 
pœq
)

70 
hvm_œq_dpci
 *hvm_œq_dpc˜ğ
d
->
¬ch
.
hvm_domaš
.
œq
.
dpci
;

71 
ušt32_t
 
æags
 = 
hvm_œq_dpci
->
mœq
[
pœq
].
gmsi
.
gæags
;

72 
veùÜ
 = 
hvm_œq_dpci
->
mœq
[
pœq
].
gmsi
.
gvec
;

73 
ušt8_t
 
de¡
 = (ušt8_t)
æags
;

74 
ušt8_t
 
de¡_mode
 = !!(
æags
 & 
VMSI_DM_MASK
);

75 
ušt8_t
 
d–iv”y_mode
 = (
æags
 & 
VMSI_DELIV_MASK
è>> 
GLFAGS_SHIFT_DELIV_MODE
;

76 
ušt8_t
 
Œig_mode
 = (
æags
 & 
VMSI_TRIG_MODE
è>> 
GLFAGS_SHIFT_TRG_MODE
;

77 
vÏpic
 *
rg‘
;

78 
vıu
 *
v
;

80 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
,

83 
de¡
, 
de¡_mode
, 
d–iv”y_mode
, 
veùÜ
, 
Œig_mode
);

85 iàĞ!Ğ
hvm_œq_dpci
->
mœq
[
pœq
].
æags
 & 
HVM_IRQ_DPCI_GUEST_MSI
 ) )

87 
	`gd´štk
(
XENLOG_WARNING
, "pœq %x‚Ù ms˜\n", 
pœq
);

91  
d–iv”y_mode
 )

93 
de¡_Lowe¡Prio
:

95 
rg‘
 = 
	`vÏpic_lowe¡_´io
(
d
, 
NULL
, 0, 
de¡
, 
de¡_mode
);

96 iàĞ
rg‘
 !ğ
NULL
 )

97 
	`vmsi_šj_œq
(
d
, 
rg‘
, 
veùÜ
, 
Œig_mode
, 
d–iv”y_mode
);

99 
	`HVM_DBG_LOG
(
DBG_LEVEL_IOAPIC
, "null„ound„obin: "

101 
veùÜ
, 
de¡_Lowe¡Prio
);

105 
de¡_Fixed
:

106 
de¡_ExtINT
:

108 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

109 iàĞ
	`vÏpic_m©ch_de¡
(
	`vıu_vÏpic
(
v
), 
NULL
,

110 0, 
de¡
, 
de¡_mode
) )

111 
	`vmsi_šj_œq
(
d
, 
	`vıu_vÏpic
(
v
),

112 
veùÜ
, 
Œig_mode
, 
d–iv”y_mode
);

116 
de¡_SMI
:

117 
de¡_NMI
:

118 
de¡_INIT
:

119 
de¡__»£rved_2
:

121 
	`gd´štk
(
XENLOG_WARNING
, "Unsupported delivery mode %d\n",

122 
d–iv”y_mode
);

126 
	}
}

129 
	$hvm_gœq_de¡_2_vıu_id
(
domaš
 *
d
, 
ušt8_t
 
de¡
, ušt8_ˆ
de¡_mode
)

131 
de¡_vıu_id
 = -1, 
w
 = 0;

132 
vıu
 *
v
;

134 iàĞ
d
->
max_vıus
 == 1 )

137 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

139 iàĞ
	`vÏpic_m©ch_de¡
(
	`vıu_vÏpic
(
v
), 
NULL
, 0, 
de¡
, 
de¡_mode
) )

141 
w
++;

142 
de¡_vıu_id
 = 
v
->
vıu_id
;

145 iàĞ
w
 > 1 )

148  
de¡_vıu_id
;

149 
	}
}

152 
	smsixtbl_’Œy


154 
li¡_h—d
 
	mli¡
;

155 
©omic_t
 
	m»fút
;

158 
pci_dev
 *
	mpdev
;

159 
	mgbË
;

160 
	mbË_Ën
;

161 
	mbË_æags
[
MAX_MSIX_TABLE_ENTRIES
 / 
BITS_PER_LONG
 + 1];

162 
	#MAX_MSIX_ACC_ENTRIES
 3

	)

164 
ušt32_t
 
	mmsi_ad
[3];

165 } 
	mg’Œ›s
[
MAX_MSIX_ACC_ENTRIES
];

166 
rcu_h—d
 
	mrcu
;

169 
DEFINE_RCU_READ_LOCK
(
msixtbl_rcu_lock
);

171 
msixtbl_’Œy
 *
	$msixtbl_fšd_’Œy
(

172 
vıu
 *
v
, 
addr
)

174 
msixtbl_’Œy
 *
’Œy
;

175 
domaš
 *
d
 = 
v
->domain;

177 
	`li¡_fÜ_—ch_’Œy
Ğ
’Œy
, &
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
, 
li¡
 )

178 iàĞ
addr
 >ğ
’Œy
->
gbË
 &&

179 
addr
 < 
’Œy
->
gbË
 +ƒÁry->
bË_Ën
 )

180  
’Œy
;

182  
NULL
;

183 
	}
}

185 
__iomem
 *
	$msixtbl_addr_to_vœt
(

186 
msixtbl_’Œy
 *
’Œy
, 
addr
)

188 
idx
, 
Ä_·ge
;

190 iàĞ!
’Œy
 )

191  
NULL
;

193 
Ä_·ge
 = (
addr
 >> 
PAGE_SHIFT
) -

194 (
’Œy
->
gbË
 >> 
PAGE_SHIFT
);

196 iàĞ!
’Œy
->
pdev
 )

197  
NULL
;

199 
idx
 = 
’Œy
->
pdev
->
msix_bË_idx
[
Ä_·ge
];

200 iàĞ!
idx
 )

201  
NULL
;

203  (*)(
	`fix_to_vœt
(
idx
) +

204 (
addr
 & ((1UL << 
PAGE_SHIFT
) - 1)));

205 
	}
}

207 
	$msixtbl_»ad
(

208 
vıu
 *
v
, 
add»ss
,

209 
Ën
, *
pv®
)

211 
off£t
, 
v®
;

212 
msixtbl_’Œy
 *
’Œy
;

213 *
vœt
;

214 
Ä_’Œy
, 
šdex
;

215 
r
 = 
X86EMUL_UNHANDLEABLE
;

217 
	`rcu_»ad_lock
(&
msixtbl_rcu_lock
);

219 iàĞ
Ën
 != 4 )

220 
out
;

222 
’Œy
 = 
	`msixtbl_fšd_’Œy
(
v
, 
add»ss
);

223 
vœt
 = 
	`msixtbl_addr_to_vœt
(
’Œy
, 
add»ss
);

224 iàĞ!
vœt
 )

225 
out
;

227 
Ä_’Œy
 = (
add»ss
 - 
’Œy
->
gbË
è/ 
PCI_MSIX_ENTRY_SIZE
;

228 
off£t
 = 
add»ss
 & (
PCI_MSIX_ENTRY_SIZE
 - 1);

229 iàĞ
Ä_’Œy
 >ğ
MAX_MSIX_ACC_ENTRIES
 &&

230 
off£t
 !ğ
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
 )

231 
out
;

233 
v®
 = 
	`»adl
(
vœt
);

234 iàĞ
off£t
 !ğ
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
 )

236 
šdex
 = 
off£t
 / (
ušt32_t
);

237 *
pv®
 = 
’Œy
->
g’Œ›s
[
Ä_’Œy
].
msi_ad
[
šdex
];

241 *
pv®
 = 
v®
;

244 
r
 = 
X86EMUL_OKAY
;

245 
out
:

246 
	`rcu_»ad_uÆock
(&
msixtbl_rcu_lock
);

247  
r
;

248 
	}
}

250 
	$msixtbl_wr™e
(
vıu
 *
v
, 
add»ss
,

251 
Ën
, 
v®
)

253 
off£t
;

254 
msixtbl_’Œy
 *
’Œy
;

255 *
vœt
;

256 
Ä_’Œy
, 
šdex
;

257 
r
 = 
X86EMUL_UNHANDLEABLE
;

259 
	`rcu_»ad_lock
(&
msixtbl_rcu_lock
);

261 iàĞ
Ën
 != 4 )

262 
out
;

264 
’Œy
 = 
	`msixtbl_fšd_’Œy
(
v
, 
add»ss
);

265 
Ä_’Œy
 = (
add»ss
 - 
’Œy
->
gbË
è/ 
PCI_MSIX_ENTRY_SIZE
;

267 
off£t
 = 
add»ss
 & (
PCI_MSIX_ENTRY_SIZE
 - 1);

268 iàĞ
off£t
 !ğ
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
)

270 iàĞ
Ä_’Œy
 < 
MAX_MSIX_ACC_ENTRIES
 )

272 
šdex
 = 
off£t
 / (
ušt32_t
);

273 
’Œy
->
g’Œ›s
[
Ä_’Œy
].
msi_ad
[
šdex
] = 
v®
;

275 
	`£t_b™
(
Ä_’Œy
, &
’Œy
->
bË_æags
);

276 
out
;

280 iàĞ
	`‹¡_ªd_ş—r_b™
(
Ä_’Œy
, &
’Œy
->
bË_æags
) )

281 
out
;

283 
vœt
 = 
	`msixtbl_addr_to_vœt
(
’Œy
, 
add»ss
);

284 iàĞ!
vœt
 )

285 
out
;

287 
	`wr™–
(
v®
, 
vœt
);

288 
r
 = 
X86EMUL_OKAY
;

290 
out
:

291 
	`rcu_»ad_uÆock
(&
msixtbl_rcu_lock
);

292  
r
;

293 
	}
}

295 
	$msixtbl_¿nge
(
vıu
 *
v
, 
addr
)

297 
msixtbl_’Œy
 *
’Œy
;

298 *
vœt
;

300 
	`rcu_»ad_lock
(&
msixtbl_rcu_lock
);

302 
’Œy
 = 
	`msixtbl_fšd_’Œy
(
v
, 
addr
);

303 
vœt
 = 
	`msixtbl_addr_to_vœt
(
’Œy
, 
addr
);

305 
	`rcu_»ad_uÆock
(&
msixtbl_rcu_lock
);

307  !!
vœt
;

308 
	}
}

310 cÚ¡ 
hvm_mmio_hªdËr
 
	gmsixtbl_mmio_hªdËr
 = {

311 .
check_hªdËr
 = 
msixtbl_¿nge
,

312 .
	g»ad_hªdËr
 = 
msixtbl_»ad
,

313 .
	gwr™e_hªdËr
 = 
msixtbl_wr™e


316 
	$add_msixtbl_’Œy
(
domaš
 *
d
,

317 
pci_dev
 *
pdev
,

318 
ušt64_t
 
gbË
,

319 
msixtbl_’Œy
 *
’Œy
)

321 
u32
 
Ën
;

323 
	`mem£t
(
’Œy
, 0, (
msixtbl_’Œy
));

325 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

326 
	`INIT_RCU_HEAD
(&
’Œy
->
rcu
);

327 
	`©omic_£t
(&
’Œy
->
»fút
, 0);

329 
Ën
 = 
	`pci_msix_g‘_bË_Ën
(
pdev
);

330 
’Œy
->
bË_Ën
 = 
Ën
;

331 
’Œy
->
pdev
 =…dev;

332 
’Œy
->
gbË
 = () gtable;

334 
	`li¡_add_rcu
(&
’Œy
->
li¡
, &
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
);

335 
	}
}

337 
	$ä“_msixtbl_’Œy
(
rcu_h—d
 *
rcu
)

339 
msixtbl_’Œy
 *
’Œy
;

341 
’Œy
 = 
	`cÚš”_of
 (
rcu
, 
msixtbl_’Œy
,„cu);

343 
	`xä“
(
’Œy
);

344 
	}
}

346 
	$d–_msixtbl_’Œy
(
msixtbl_’Œy
 *
’Œy
)

348 
	`li¡_d–_rcu
(&
’Œy
->
li¡
);

349 
	`ÿÎ_rcu
(&
’Œy
->
rcu
, 
ä“_msixtbl_’Œy
);

350 
	}
}

352 
	$msixtbl_±_»gi¡”
(
domaš
 *
d
, 
pœq
, 
ušt64_t
 
gbË
)

354 
œq_desc
 *irq_desc;

355 
msi_desc
 *msi_desc;

356 
pci_dev
 *
pdev
;

357 
msixtbl_’Œy
 *
’Œy
, *
Ãw_’Œy
;

358 
r
 = -
EINVAL
;

360 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

366 
Ãw_’Œy
 = 
	`xm®loc
(
msixtbl_’Œy
);

367 iàĞ!
Ãw_’Œy
 )

368  -
ENOMEM
;

370 
œq_desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, 
NULL
);

371 iàĞ!
œq_desc
 )

373 
	`xä“
(
Ãw_’Œy
);

374  
r
;

377 iàĞ
œq_desc
->
hªdËr
 !ğ&
pci_msi_ty³
 )

378 
out
;

380 
msi_desc
 = 
œq_desc
->msi_desc;

381 iàĞ!
msi_desc
 )

382 
out
;

384 
pdev
 = 
msi_desc
->
dev
;

386 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

388 
	`li¡_fÜ_—ch_’Œy
Ğ
’Œy
, &
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
, 
li¡
 )

389 iàĞ
pdev
 =ğ
’Œy
->pdev )

390 
found
;

392 
’Œy
 = 
Ãw_’Œy
;

393 
Ãw_’Œy
 = 
NULL
;

394 
	`add_msixtbl_’Œy
(
d
, 
pdev
, 
gbË
, 
’Œy
);

396 
found
:

397 
	`©omic_šc
(&
’Œy
->
»fút
);

398 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

399 
r
 = 0;

401 
out
:

402 
	`¥š_uÆock_œq
(&
œq_desc
->
lock
);

403 
	`xä“
(
Ãw_’Œy
);

404  
r
;

405 
	}
}

407 
	$msixtbl_±_uÄegi¡”
(
domaš
 *
d
, 
pœq
)

409 
œq_desc
 *irq_desc;

410 
msi_desc
 *msi_desc;

411 
pci_dev
 *
pdev
;

412 
msixtbl_’Œy
 *
’Œy
;

414 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

416 
œq_desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, 
NULL
);

417 iàĞ!
œq_desc
 )

420 iàĞ
œq_desc
->
hªdËr
 !ğ&
pci_msi_ty³
 )

421 
out
;

423 
msi_desc
 = 
œq_desc
->msi_desc;

424 iàĞ!
msi_desc
 )

425 
out
;

427 
pdev
 = 
msi_desc
->
dev
;

429 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

431 
	`li¡_fÜ_—ch_’Œy
Ğ
’Œy
, &
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
, 
li¡
 )

432 iàĞ
pdev
 =ğ
’Œy
->pdev )

433 
found
;

435 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

438 
out
:

439 
	`¥š_uÆock_œq
(&
œq_desc
->
lock
);

442 
found
:

443 iàĞ!
	`©omic_dec_ªd_‹¡
(&
’Œy
->
»fút
) )

444 
	`d–_msixtbl_’Œy
(
’Œy
);

446 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

447 
	`¥š_uÆock_œq
(&
œq_desc
->
lock
);

448 
	}
}

450 
	$msixtbl_±_ş—nup
(
domaš
 *
d
, 
pœq
)

452 
msixtbl_’Œy
 *
’Œy
, *
‹mp
;

453 
æags
;

456 
	`loÿl_œq_§ve
(
æags
);

457 
	`¥š_lock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

459 
	`li¡_fÜ_—ch_’Œy_§ã
Ğ
’Œy
, 
‹mp
,

460 &
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡
, 
li¡
 )

461 
	`d–_msixtbl_’Œy
(
’Œy
);

463 
	`¥š_uÆock
(&
d
->
¬ch
.
hvm_domaš
.
msixtbl_li¡_lock
);

464 
	`loÿl_œq_»¡Üe
(
æags
);

465 
	}
}

	@hvm/vmx/intr.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/š™.h
>

22 
	~<x’/mm.h
>

23 
	~<x’/lib.h
>

24 
	~<x’/”ºo.h
>

25 
	~<x’/Œaû.h
>

26 
	~<x’/ev’t.h
>

27 
	~<asm/cu¼’t.h
>

28 
	~<asm/ıuã©u».h
>

29 
	~<asm/´oûssÜ.h
>

30 
	~<asm/m¤.h
>

31 
	~<asm/hvm/hvm.h
>

32 
	~<asm/hvm/io.h
>

33 
	~<asm/hvm/suµÜt.h
>

34 
	~<asm/hvm/vmx/vmx.h
>

35 
	~<asm/hvm/vmx/vmcs.h
>

36 
	~<asm/hvm/vpic.h
>

37 
	~<asm/hvm/vÏpic.h
>

38 
	~<public/hvm/iÜeq.h
>

39 
	~<asm/hvm/Œaû.h
>

70 
	$’abË_šŒ_wšdow
(
vıu
 *
v
, 
hvm_šck
 
šck
)

72 
u32
 
ùl
 = 
CPU_BASED_VIRTUAL_INTR_PENDING
;

74 
	`ASSERT
(
šck
.
sourû
 !ğ
hvm_št¤c_nÚe
);

76 iàĞ
	`uÆik–y
(
tb_š™_dÚe
) )

78 
šŒ
 = 
	`__vm»ad
(
VM_ENTRY_INTR_INFO
);

79 
	`HVMTRACE_3D
(
INTR_WINDOW
, 
šck
.
veùÜ
, iÁack.
sourû
,

80 (
šŒ
 & 
INTR_INFO_VALID_MASK
) ? intr & 0xff : -1);

83 iàĞ(
šck
.
sourû
 =ğ
hvm_št¤c_nmi
è&& 
ıu_has_vmx_vnmi
 )

94 
u32
 
šŒ_shadow
 = 
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
);

95 iàĞ
šŒ_shadow
 & 
VMX_INTR_SHADOW_STI
 )

98 
šŒ_shadow
 &ğ~
VMX_INTR_SHADOW_STI
;

99 
šŒ_shadow
 |ğ
VMX_INTR_SHADOW_MOV_SS
;

100 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 
šŒ_shadow
);

102 
ùl
 = 
CPU_BASED_VIRTUAL_NMI_PENDING
;

105 iàĞ!(
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 & 
ùl
) )

107 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
ùl
;

108 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

110 
	}
}

112 
asmlškage
 
	$vmx_šŒ_assi¡
()

114 
hvm_šck
 
šck
;

115 
vıu
 *
v
 = 
cu¼’t
;

116 
r_th»shŞd
 = 0;

117 
hvm_štblk
 
štblk
;

120 iàĞ
	`uÆik–y
(
v
->
¬ch
.
hvm_vıu
.
sšgË_¡•
) )

122 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
CPU_BASED_MONITOR_TRAP_FLAG
;

123 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

128 
	`±_upd©e_œq
(
v
);

131 
šck
 = 
	`hvm_vıu_has_³ndšg_œq
(
v
);

132 iàĞ
	`lik–y
(
šck
.
sourû
 =ğ
hvm_št¤c_nÚe
) )

133 
out
;

135 
štblk
 = 
	`hvm_š‹¼u±_blocked
(
v
, 
šck
);

136 iàĞ
štblk
 =ğ
hvm_štblk_r
 )

138 
	`ASSERT
(
	`vÏpic_’abËd
(
	`vıu_vÏpic
(
v
)));

139 
	`ASSERT
(
šck
.
sourû
 =ğ
hvm_št¤c_Ïpic
);

140 
r_th»shŞd
 = 
šck
.
veùÜ
 >> 4;

141 
out
;

144 iàĞ(
štblk
 !ğ
hvm_štblk_nÚe
) ||

145 (
	`__vm»ad
(
VM_ENTRY_INTR_INFO
è& 
INTR_INFO_VALID_MASK
) )

147 
	`’abË_šŒ_wšdow
(
v
, 
šck
);

148 
out
;

151 
šck
 = 
	`hvm_vıu_ack_³ndšg_œq
(
v
, intack);

152 }  
šck
.
sourû
 =ğ
hvm_št¤c_nÚe
 );

154 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_nmi
 )

156 
	`vmx_šjeù_nmi
();

158 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_mû
 )

160 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_machše_check
, 
HVM_DELIVER_NO_ERROR_CODE
);

164 
	`HVMTRACE_2D
(
INJ_VIRQ
, 
šck
.
veùÜ
, 0);

165 
	`vmx_šjeù_extšt
(
šck
.
veùÜ
);

166 
	`±_šŒ_po¡
(
v
, 
šck
);

170 
šck
 = 
	`hvm_vıu_has_³ndšg_œq
(
v
);

171 iàĞ
	`uÆik–y
(
šck
.
sourû
 !ğ
hvm_št¤c_nÚe
) )

172 
	`’abË_šŒ_wšdow
(
v
, 
šck
);

174 
out
:

175 iàĞ
ıu_has_vmx_r_shadow
 )

176 
	`__vmwr™e
(
TPR_THRESHOLD
, 
r_th»shŞd
);

177 
	}
}

	@hvm/vmx/realmode.c

12 
	~<x’/cÚfig.h
>

13 
	~<x’/š™.h
>

14 
	~<x’/lib.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/·gšg.h
>

17 
	~<asm/ev’t.h
>

18 
	~<asm/hvm/emuÏ‹.h
>

19 
	~<asm/hvm/hvm.h
>

20 
	~<asm/hvm/suµÜt.h
>

21 
	~<asm/hvm/vmx/vmx.h
>

22 
	~<asm/hvm/vmx/vmcs.h
>

24 
	$»®mode_d–iv”_exû±iÚ
(

25 
veùÜ
,

26 
š¢_Ën
,

27 
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

29 
£gm’t_»gi¡”
 *
idŒ
, *
c¤
;

30 
ıu_u£r_»gs
 *
»gs
 = 
hvmemul_ùxt
->
ùxt
.regs;

31 
ušt32_t
 
cs_e
, 
p¡k
;

32 
ušt16_t
 
äame
[3];

33 
Ï¡_by‹
;

35 
idŒ
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_idŒ
, 
hvmemul_ùxt
);

36 
c¤
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_cs
, 
hvmemul_ùxt
);

37 
	`__£t_b™
(
x86_£g_cs
, &
hvmemul_ùxt
->
£g_»g_dœty
);

39 
agaš
:

40 
Ï¡_by‹
 = (
veùÜ
 * 4) + 3;

41 iàĞ
idŒ
->
lim™
 < 
Ï¡_by‹
 )

44 iàĞ
š¢_Ën
 != 0 )

46 
š¢_Ën
 = 0;

47 
veùÜ
 = 
TRAP_gp_çuÉ
;

48 
agaš
;

52  
veùÜ
 )

54 
TRAP_doubË_çuÉ
:

55 
	`hvm_ŒË_çuÉ
();

57 
TRAP_gp_çuÉ
:

58 
veùÜ
 = 
TRAP_doubË_çuÉ
;

59 
agaš
;

61 
veùÜ
 = 
TRAP_gp_çuÉ
;

62 
agaš
;

66 ()
	`hvm_cİy_äom_gue¡_phys
(&
cs_e
, 
idŒ
->
ba£
 + 
veùÜ
 * 4, 4);

68 
äame
[0] = 
»gs
->
e
 + 
š¢_Ën
;

69 
äame
[1] = 
c¤
->
£l
;

70 
äame
[2] = 
»gs
->
eæags
 & ~
X86_EFLAGS_RF
;

73 iàĞ
hvmemul_ùxt
->
£g_»g
[
x86_£g_ss
].
©Œ
.
f›lds
.
db
 )

75 
»gs
->
e¥
 -= 6;

76 
p¡k
 = 
»gs
->
e¥
;

80 
p¡k
 = (
ušt16_t
)(
»gs
->
e¥
 - 6);

81 
»gs
->
e¥
 &= ~0xffff;

82 
»gs
->
e¥
 |ğ
p¡k
;

85 
p¡k
 +ğ
	`hvmemul_g‘_£g_»g
(
x86_£g_ss
, 
hvmemul_ùxt
)->
ba£
;

86 ()
	`hvm_cİy_to_gue¡_phys
(
p¡k
, 
äame
, (frame));

88 
c¤
->
£l
 = 
cs_e
 >> 16;

89 
c¤
->
ba£
 = (
ušt32_t
)c¤->
£l
 << 4;

90 
»gs
->
e
 = (
ušt16_t
)
cs_e
;

91 
»gs
->
eæags
 &ğ~(
X86_EFLAGS_TF
 | 
X86_EFLAGS_IF
 | 
X86_EFLAGS_RF
);

94 iàĞ
hvmemul_ùxt
->
šŒ_shadow
 &

95 (
VMX_INTR_SHADOW_STI
|
VMX_INTR_SHADOW_MOV_SS
) )

97 
hvmemul_ùxt
->
šŒ_shadow
 &=

98 ~(
VMX_INTR_SHADOW_STI
|
VMX_INTR_SHADOW_MOV_SS
);

99 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 
hvmemul_ùxt
->
šŒ_shadow
);

101 
	}
}

103 
	$»®mode_emuÏ‹_Úe
(
hvm_emuÏ‹_ùxt
 *
hvmemul_ùxt
)

105 
vıu
 *
cu¼
 = 
cu¼’t
;

106 
ušt32_t
 
šŒ_šfo
;

107 
rc
;

109 
	`³rfc_šü
(
»®mode_emuÏtiÚs
);

111 
rc
 = 
	`hvm_emuÏ‹_Úe
(
hvmemul_ùxt
);

113 iàĞ
rc
 =ğ
X86EMUL_UNHANDLEABLE
 )

115 
	`gd´štk
(
XENLOG_ERR
, "Failedoƒmulate insn.\n");

116 
ç
;

119 iàĞ
rc
 =ğ
X86EMUL_EXCEPTION
 )

121 iàĞ!
hvmemul_ùxt
->
exn_³ndšg
 )

123 
šŒ_šfo
 = 
	`__vm»ad
(
VM_ENTRY_INTR_INFO
);

124 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 0);

125 iàĞ!(
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
) )

127 
	`gd´štk
(
XENLOG_ERR
, "Exception…ending but‚o info.\n");

128 
ç
;

130 
hvmemul_ùxt
->
exn_veùÜ
 = (
ušt8_t
)
šŒ_šfo
;

131 
hvmemul_ùxt
->
exn_š¢_Ën
 = 0;

134 iàĞ
	`uÆik–y
(
cu¼
->
domaš
->
debugg”_©ched
) &&

135 ((
hvmemul_ùxt
->
exn_veùÜ
 =ğ
TRAP_debug
) ||

136 (
hvmemul_ùxt
->
exn_veùÜ
 =ğ
TRAP_št3
)) )

138 
	`domaš_·u£_fÜ_debugg”
();

140 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
 )

142 
	`gd´štk
(
XENLOG_ERR
, "Exception %02x in…rotected mode.\n",

143 
hvmemul_ùxt
->
exn_veùÜ
);

144 
ç
;

148 
	`»®mode_d–iv”_exû±iÚ
(

149 
hvmemul_ùxt
->
exn_veùÜ
,

150 
hvmemul_ùxt
->
exn_š¢_Ën
,

151 
hvmemul_ùxt
);

157 
ç
:

158 
	`gd´štk
(
XENLOG_ERR
,

161 
	`hvmemul_g‘_£g_»g
(
x86_£g_cs
, 
hvmemul_ùxt
)->
£l
,

162 
hvmemul_ùxt
->
š¢_buf_e
,

163 
hvmemul_ùxt
->
š¢_buf
[0], hvmemul_ctxt->insn_buf[1],

164 
hvmemul_ùxt
->
š¢_buf
[2], hvmemul_ctxt->insn_buf[3],

165 
hvmemul_ùxt
->
š¢_buf
[4], hvmemul_ctxt->insn_buf[5]);

166 
	`domaš_üash
(
cu¼
->
domaš
);

167 
	}
}

169 
	$vmx_»®mode
(
ıu_u£r_»gs
 *
»gs
)

171 
vıu
 *
cu¼
 = 
cu¼’t
;

172 
hvm_emuÏ‹_ùxt
 
hvmemul_ùxt
;

173 
£gm’t_»gi¡”
 *
¤eg
;

174 
šŒ_šfo
;

175 
emuÏtiÚs
 = 0;

178 
šŒ_šfo
 = 
	`__vm»ad
(
VM_ENTRY_INTR_INFO
);

179 iàĞ
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
 )

180 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 0);

182 
	`hvm_emuÏ‹_´•¬e
(&
hvmemul_ùxt
, 
»gs
);

184 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 =ğ
HVMIO_com¶‘ed
 )

185 
	`»®mode_emuÏ‹_Úe
(&
hvmemul_ùxt
);

188 iàĞ!(
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
) &&

189 (
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
) )

191 
	`»®mode_d–iv”_exû±iÚ
((
ušt8_t
)
šŒ_šfo
, 0, &
hvmemul_ùxt
);

192 
šŒ_šfo
 = 0;

195 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 = 1;

196  
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 &&

197 !
	`soáœq_³ndšg
(
	`smp_´oûssÜ_id
()) &&

198 (
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 =ğ
HVMIO_nÚe
) )

205 iàĞ
	`uÆik–y
(!(++
emuÏtiÚs
 & 15)) &&

206 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 &&

207 
	`hvm_loÿl_ev’ts_Ãed_d–iv”y
(
cu¼
) )

210 
	`»®mode_emuÏ‹_Úe
(&
hvmemul_ùxt
);

213 iàĞ
cu¼
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 )

214 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 =

215 (
cu¼
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 != 0);

217 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 =

218 ((
hvmemul_ùxt
.
£g_»g
[
x86_£g_cs
].
£l
 & 3)

219 || (
hvmemul_ùxt
.
£g_»g
[
x86_£g_ss
].
£l
 & 3));

223 iàĞ
cu¼
->
¬ch
.
hvm_vıu
.
io_¡©e
 !ğ
HVMIO_nÚe
 )

224 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 = 1;

226 iàĞ!
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 && !cu¼->¬ch.hvm_vmx.
vmx_»®mode
 )

233 
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_ds
, &
hvmemul_ùxt
);

234 
¤eg
->
©Œ
.
f›lds
.
d¶
 = s»g->
£l
 & 3;

235 
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_es
, &
hvmemul_ùxt
);

236 
¤eg
->
©Œ
.
f›lds
.
d¶
 = s»g->
£l
 & 3;

237 
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_fs
, &
hvmemul_ùxt
);

238 
¤eg
->
©Œ
.
f›lds
.
d¶
 = s»g->
£l
 & 3;

239 
¤eg
 = 
	`hvmemul_g‘_£g_»g
(
x86_£g_gs
, &
hvmemul_ùxt
);

240 
¤eg
->
©Œ
.
f›lds
.
d¶
 = s»g->
£l
 & 3;

241 
hvmemul_ùxt
.
£g_»g_dœty
 |=

242 (1uÈ<< 
x86_£g_ds
è| (1uÈ<< 
x86_£g_es
) |

243 (1uÈ<< 
x86_£g_fs
è| (1uÈ<< 
x86_£g_gs
);

246 
	`hvm_emuÏ‹_wr™eback
(&
hvmemul_ùxt
);

249 iàĞ
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
 )

250 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 
šŒ_šfo
);

251 
	}
}

	@hvm/vmx/vmcs.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/mm.h
>

22 
	~<x’/lib.h
>

23 
	~<x’/”ºo.h
>

24 
	~<x’/domaš_·ge.h
>

25 
	~<asm/cu¼’t.h
>

26 
	~<asm/ıuã©u».h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<asm/m¤.h
>

29 
	~<asm/hvm/hvm.h
>

30 
	~<asm/hvm/io.h
>

31 
	~<asm/hvm/suµÜt.h
>

32 
	~<asm/hvm/vmx/vmx.h
>

33 
	~<asm/hvm/vmx/vmcs.h
>

34 
	~<asm/æushb.h
>

35 
	~<x’/ev’t.h
>

36 
	~<x’/k”Ãl.h
>

37 
	~<x’/keyhªdËr.h
>

38 
	~<asm/shadow.h
>

39 
	~<asm/tboÙ.h
>

41 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_vpid_’abËd
 = 1;

42 
boŞ—n_·¿m
("vpid", 
İt_vpid_’abËd
);

44 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_uÄe¡riùed_gue¡_’abËd
 = 1;

45 
boŞ—n_·¿m
("uÄe¡riùed_gue¡", 
İt_uÄe¡riùed_gue¡_’abËd
);

56 
__»ad_mo¡ly
 
	g¶e_g­
 = 128;

57 
š‹g”_·¿m
("¶e_g­", 
¶e_g­
);

58 
__»ad_mo¡ly
 
	g¶e_wšdow
 = 4096;

59 
š‹g”_·¿m
("¶e_wšdow", 
¶e_wšdow
);

62 
u32
 
vmx_pš_ba£d_exec_cÚŒŞ
 
	g__»ad_mo¡ly
;

63 
u32
 
vmx_ıu_ba£d_exec_cÚŒŞ
 
	g__»ad_mo¡ly
;

64 
u32
 
vmx_£cÚd¬y_exec_cÚŒŞ
 
	g__»ad_mo¡ly
;

65 
u32
 
vmx_vmex™_cÚŒŞ
 
	g__»ad_mo¡ly
;

66 
u32
 
vmx_vm’Œy_cÚŒŞ
 
	g__»ad_mo¡ly
;

67 
u64
 
vmx_•t_vpid_ÿp
 
	g__»ad_mo¡ly
;

68 
boŞ_t
 
ıu_has_vmx_šs_outs_š¡r_šfo
 
	g__»ad_mo¡ly
;

70 
DEFINE_PER_CPU_READ_MOSTLY
(
vmcs_¡ruù
 *, 
vmxÚ_»giÚ
);

71 
DEFINE_PER_CPU
(
vmcs_¡ruù
 *, 
cu¼’t_vmcs
);

72 
DEFINE_PER_CPU
(
li¡_h—d
, 
aùive_vmcs_li¡
);

74 
u32
 
vmcs_»visiÚ_id
 
	g__»ad_mo¡ly
;

76 
__š™
 
	$vmx_di¥Ïy_ã©u»s
()

78 
´š‹d
 = 0;

80 
	`´štk
("VMX: Supported‡dvanced features:\n");

82 
	#P
(
p
,
s
èiàĞ°è{ 
	`´štk
(" - %s\n", s); 
´š‹d
 = 1; }

	)

83 
	`P
(
ıu_has_vmx_vœtu®ize_­ic_acûs£s
, "APIC MMIO‡ccess virtualisation");

84 
	`P
(
ıu_has_vmx_r_shadow
, "APIC TPR shadow");

85 
	`P
(
ıu_has_vmx_•t
, "Extended Page Tables (EPT)");

86 
	`P
(
ıu_has_vmx_vpid
, "Virtual-Processor Identifiers (VPID)");

87 
	`P
(
ıu_has_vmx_vnmi
, "Virtual NMI");

88 
	`P
(
ıu_has_vmx_m¤_b™m­
, "MSR direct-access bitmap");

89 
	`P
(
ıu_has_vmx_uÄe¡riùed_gue¡
, "Unrestricted Guest");

90 #undeà
P


92 iàĞ!
´š‹d
 )

93 
	`´štk
(" -‚one\n");

95 iàĞ
ıu_has_vmx_•t_1gb
 )

96 
	`´štk
("EPT supports 1GB super…age.\n");

97 iàĞ
ıu_has_vmx_•t_2mb
 )

98 
	`´štk
("EPT supports 2MB super…age.\n");

99 
	}
}

101 
u32
 
	$adju¡_vmx_cÚŒŞs
(

102 cÚ¡ *
Çme
, 
u32
 
ùl_mš
, u32 
ùl_İt
, u32 
m¤
, 
boŞ_t
 *
mism©ch
)

104 
u32
 
vmx_m¤_low
, 
vmx_m¤_high
, 
ùl
 = 
ùl_mš
 | 
ùl_İt
;

106 
	`rdm¤
(
m¤
, 
vmx_m¤_low
, 
vmx_m¤_high
);

108 
ùl
 &ğ
vmx_m¤_high
;

109 
ùl
 |ğ
vmx_m¤_low
;

112 iàĞ
ùl_mš
 & ~
ùl
 )

114 *
mism©ch
 = 1;

115 
	`´štk
("VMX: CPU%d has insufficent %s (%08x but„equires min %08x)\n",

116 
	`smp_´oûssÜ_id
(), 
Çme
, 
ùl
, 
ùl_mš
);

119  
ùl
;

120 
	}
}

122 
boŞ_t
 
	$ÿp_check
(cÚ¡ *
Çme
, 
u32
 
ex³ùed
, u32 
§w
)

124 iàĞ
§w
 !ğ
ex³ùed
 )

125 
	`´štk
("VMX %s: saw 0x%08xƒx³ùed 0x%08x\n", 
Çme
, 
§w
, 
ex³ùed
);

126  
§w
 !ğ
ex³ùed
;

127 
	}
}

129 
	$vmx_š™_vmcs_cÚfig
()

131 
u32
 
vmx_basic_m¤_low
, 
vmx_basic_m¤_high
, 
mš
, 
İt
;

132 
u32
 
_vmx_pš_ba£d_exec_cÚŒŞ
;

133 
u32
 
_vmx_ıu_ba£d_exec_cÚŒŞ
;

134 
u32
 
_vmx_£cÚd¬y_exec_cÚŒŞ
 = 0;

135 
u64
 
_vmx_•t_vpid_ÿp
 = 0;

136 
u32
 
_vmx_vmex™_cÚŒŞ
;

137 
u32
 
_vmx_vm’Œy_cÚŒŞ
;

138 
boŞ_t
 
mism©ch
 = 0;

140 
	`rdm¤
(
MSR_IA32_VMX_BASIC
, 
vmx_basic_m¤_low
, 
vmx_basic_m¤_high
);

142 
mš
 = (
PIN_BASED_EXT_INTR_MASK
 |

143 
PIN_BASED_NMI_EXITING
);

144 
İt
 = 
PIN_BASED_VIRTUAL_NMIS
;

145 
_vmx_pš_ba£d_exec_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

146 "Pš-Ba£d ExeøCÚŒŞ", 
mš
, 
İt
,

147 
MSR_IA32_VMX_PINBASED_CTLS
, &
mism©ch
);

149 
mš
 = (
CPU_BASED_HLT_EXITING
 |

150 
CPU_BASED_INVLPG_EXITING
 |

151 
CPU_BASED_CR3_LOAD_EXITING
 |

152 
CPU_BASED_CR3_STORE_EXITING
 |

153 
CPU_BASED_MONITOR_EXITING
 |

154 
CPU_BASED_MWAIT_EXITING
 |

155 
CPU_BASED_MOV_DR_EXITING
 |

156 
CPU_BASED_ACTIVATE_IO_BITMAP
 |

157 
CPU_BASED_USE_TSC_OFFSETING
 |

158 
CPU_BASED_RDTSC_EXITING
);

159 
İt
 = (
CPU_BASED_ACTIVATE_MSR_BITMAP
 |

160 
CPU_BASED_TPR_SHADOW
 |

161 
CPU_BASED_MONITOR_TRAP_FLAG
 |

162 
CPU_BASED_ACTIVATE_SECONDARY_CONTROLS
);

163 
_vmx_ıu_ba£d_exec_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

164 "CPU-Ba£d ExeøCÚŒŞ", 
mš
, 
İt
,

165 
MSR_IA32_VMX_PROCBASED_CTLS
, &
mism©ch
);

166 
_vmx_ıu_ba£d_exec_cÚŒŞ
 &ğ~
CPU_BASED_RDTSC_EXITING
;

167 #ifdeà
__x86_64__


168 iàĞ!(
_vmx_ıu_ba£d_exec_cÚŒŞ
 & 
CPU_BASED_TPR_SHADOW
) )

170 
mš
 |ğ
CPU_BASED_CR8_LOAD_EXITING
 | 
CPU_BASED_CR8_STORE_EXITING
;

171 
_vmx_ıu_ba£d_exec_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

172 "CPU-Ba£d ExeøCÚŒŞ", 
mš
, 
İt
,

173 
MSR_IA32_VMX_PROCBASED_CTLS
, &
mism©ch
);

177 iàĞ
_vmx_ıu_ba£d_exec_cÚŒŞ
 & 
CPU_BASED_ACTIVATE_SECONDARY_CONTROLS
 )

179 
mš
 = 0;

180 
İt
 = (
SECONDARY_EXEC_VIRTUALIZE_APIC_ACCESSES
 |

181 
SECONDARY_EXEC_WBINVD_EXITING
 |

182 
SECONDARY_EXEC_ENABLE_EPT
 |

183 
SECONDARY_EXEC_ENABLE_RDTSCP
 |

184 
SECONDARY_EXEC_PAUSE_LOOP_EXITING
);

185 iàĞ
İt_vpid_’abËd
 )

186 
İt
 |ğ
SECONDARY_EXEC_ENABLE_VPID
;

187 iàĞ
İt_uÄe¡riùed_gue¡_’abËd
 )

188 
İt
 |ğ
SECONDARY_EXEC_UNRESTRICTED_GUEST
;

190 
_vmx_£cÚd¬y_exec_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

191 "SecÚd¬y ExeøCÚŒŞ", 
mš
, 
İt
,

192 
MSR_IA32_VMX_PROCBASED_CTLS2
, &
mism©ch
);

196 iàĞ
_vmx_£cÚd¬y_exec_cÚŒŞ
 & (
SECONDARY_EXEC_ENABLE_EPT
 |

197 
SECONDARY_EXEC_ENABLE_VPID
) )

199 
	`rdm¤l
(
MSR_IA32_VMX_EPT_VPID_CAP
, 
_vmx_•t_vpid_ÿp
);

212 iàĞ!(
_vmx_•t_vpid_ÿp
 & 
VMX_EPT_MEMORY_TYPE_WB
) ||

213 !(
_vmx_•t_vpid_ÿp
 & 
VMX_EPT_WALK_LENGTH_4_SUPPORTED
) ||

214 !(
_vmx_•t_vpid_ÿp
 & 
VMX_EPT_INVEPT_ALL_CONTEXT
) )

215 
_vmx_£cÚd¬y_exec_cÚŒŞ
 &ğ~
SECONDARY_EXEC_ENABLE_EPT
;

223 iàĞ!(
_vmx_•t_vpid_ÿp
 & 
VMX_VPID_INVVPID_ALL_CONTEXT
) )

224 
_vmx_£cÚd¬y_exec_cÚŒŞ
 &ğ~
SECONDARY_EXEC_ENABLE_VPID
;

227 iàĞ
_vmx_£cÚd¬y_exec_cÚŒŞ
 & 
SECONDARY_EXEC_ENABLE_EPT
 )

233 
ušt32_t
 
mu¡_be_Úe
, 
mu¡_be_z”o
, 
m¤
 = 
MSR_IA32_VMX_PROCBASED_CTLS
;

234 iàĞ
vmx_basic_m¤_high
 & (1u << 23) )

235 
m¤
 = 
MSR_IA32_VMX_TRUE_PROCBASED_CTLS
;

236 
	`rdm¤
(
m¤
, 
mu¡_be_Úe
, 
mu¡_be_z”o
);

237 iàĞ
mu¡_be_Úe
 & (
CPU_BASED_INVLPG_EXITING
 |

238 
CPU_BASED_CR3_LOAD_EXITING
 |

239 
CPU_BASED_CR3_STORE_EXITING
) )

240 
_vmx_£cÚd¬y_exec_cÚŒŞ
 &=

241 ~(
SECONDARY_EXEC_ENABLE_EPT
 |

242 
SECONDARY_EXEC_UNRESTRICTED_GUEST
);

245 iàĞ(
_vmx_£cÚd¬y_exec_cÚŒŞ
 & 
SECONDARY_EXEC_PAUSE_LOOP_EXITING
) &&

246 
¶e_g­
 == 0 )

248 
	`´štk
("Disable Pause-Loop Exiting.\n");

249 
_vmx_£cÚd¬y_exec_cÚŒŞ
 &ğ~ 
SECONDARY_EXEC_PAUSE_LOOP_EXITING
;

252 #ià
	`defšed
(
__i386__
)

254 iàĞ!(
_vmx_£cÚd¬y_exec_cÚŒŞ
 &

255 
SECONDARY_EXEC_VIRTUALIZE_APIC_ACCESSES
) )

256 
_vmx_ıu_ba£d_exec_cÚŒŞ
 &ğ~
CPU_BASED_TPR_SHADOW
;

259 
mš
 = 
VM_EXIT_ACK_INTR_ON_EXIT
;

260 
İt
 = 
VM_EXIT_SAVE_GUEST_PAT
 | 
VM_EXIT_LOAD_HOST_PAT
;

261 #ifdeà
__x86_64__


262 
mš
 |ğ
VM_EXIT_IA32E_MODE
;

264 
_vmx_vmex™_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

265 "VMEx™ CÚŒŞ", 
mš
, 
İt
, 
MSR_IA32_VMX_EXIT_CTLS
, &
mism©ch
);

267 
mš
 = 0;

268 
İt
 = 
VM_ENTRY_LOAD_GUEST_PAT
;

269 
_vmx_vm’Œy_cÚŒŞ
 = 
	`adju¡_vmx_cÚŒŞs
(

270 "VMEÁry CÚŒŞ", 
mš
, 
İt
, 
MSR_IA32_VMX_ENTRY_CTLS
, &
mism©ch
);

272 iàĞ
mism©ch
 )

273  -
EINVAL
;

275 iàĞ!
vmx_pš_ba£d_exec_cÚŒŞ
 )

278 
vmcs_»visiÚ_id
 = 
vmx_basic_m¤_low
;

279 
vmx_pš_ba£d_exec_cÚŒŞ
 = 
_vmx_pš_ba£d_exec_cÚŒŞ
;

280 
vmx_ıu_ba£d_exec_cÚŒŞ
 = 
_vmx_ıu_ba£d_exec_cÚŒŞ
;

281 
vmx_£cÚd¬y_exec_cÚŒŞ
 = 
_vmx_£cÚd¬y_exec_cÚŒŞ
;

282 
vmx_•t_vpid_ÿp
 = 
_vmx_•t_vpid_ÿp
;

283 
vmx_vmex™_cÚŒŞ
 = 
_vmx_vmex™_cÚŒŞ
;

284 
vmx_vm’Œy_cÚŒŞ
 = 
_vmx_vm’Œy_cÚŒŞ
;

285 
ıu_has_vmx_šs_outs_š¡r_šfo
 = !!(
vmx_basic_m¤_high
 & (1U<<22));

286 
	`vmx_di¥Ïy_ã©u»s
();

291 
mism©ch
 |ğ
	`ÿp_check
(

293 
vmcs_»visiÚ_id
, 
vmx_basic_m¤_low
);

294 
mism©ch
 |ğ
	`ÿp_check
(

296 
vmx_pš_ba£d_exec_cÚŒŞ
, 
_vmx_pš_ba£d_exec_cÚŒŞ
);

297 
mism©ch
 |ğ
	`ÿp_check
(

299 
vmx_ıu_ba£d_exec_cÚŒŞ
, 
_vmx_ıu_ba£d_exec_cÚŒŞ
);

300 
mism©ch
 |ğ
	`ÿp_check
(

302 
vmx_£cÚd¬y_exec_cÚŒŞ
, 
_vmx_£cÚd¬y_exec_cÚŒŞ
);

303 
mism©ch
 |ğ
	`ÿp_check
(

305 
vmx_vmex™_cÚŒŞ
, 
_vmx_vmex™_cÚŒŞ
);

306 
mism©ch
 |ğ
	`ÿp_check
(

308 
vmx_vm’Œy_cÚŒŞ
, 
_vmx_vm’Œy_cÚŒŞ
);

309 
mism©ch
 |ğ
	`ÿp_check
(

311 
vmx_•t_vpid_ÿp
, 
_vmx_•t_vpid_ÿp
);

312 iàĞ
ıu_has_vmx_šs_outs_š¡r_šfo
 !=

313 !!(
vmx_basic_m¤_high
 & (1U<<22)) )

315 
	`´štk
("VMX INS/OUTS Instruction Info: saw %dƒxpected %d\n",

316 !!(
vmx_basic_m¤_high
 & (1U<<22)),

317 
ıu_has_vmx_šs_outs_š¡r_šfo
);

318 
mism©ch
 = 1;

320 iàĞ
mism©ch
 )

322 
	`´štk
("VMX: Capabilities fatally differ between CPU%d‡nd CPU0\n",

323 
	`smp_´oûssÜ_id
());

324  -
EINVAL
;

329 iàĞ(
vmx_basic_m¤_high
 & 0x1fffè> 
PAGE_SIZE
 )

331 
	`´štk
("VMX: CPU%d VMCS size isoo big (%u bytes)\n",

332 
	`smp_´oûssÜ_id
(), 
vmx_basic_m¤_high
 & 0x1fff);

333  -
EINVAL
;

336 #ifdeà
__x86_64__


338 iàĞ
vmx_basic_m¤_high
 & (1u<<16) )

340 
	`´štk
("VMX: CPU%d†imits VMX structure…ointerso 32 bits\n",

341 
	`smp_´oûssÜ_id
());

342  -
EINVAL
;

347 iàĞ((
vmx_basic_m¤_high
 >> 18) & 15) != 6 )

349 
	`´štk
("VMX: CPU%d has unexpected VMCS‡ccessype %u\n",

350 
	`smp_´oûssÜ_id
(), (
vmx_basic_m¤_high
 >> 18) & 15);

351  -
EINVAL
;

355 
	}
}

357 
vmcs_¡ruù
 *
	$vmx_®loc_vmcs
()

359 
vmcs_¡ruù
 *
vmcs
;

361 iàĞ(
vmcs
 = 
	`®loc_x’h—p_·ge
()è=ğ
NULL
 )

363 
	`gd´štk
(
XENLOG_WARNING
, "Failedo‡llocate VMCS.\n");

364  
NULL
;

367 
	`ş—r_·ge
(
vmcs
);

368 
vmcs
->
vmcs_»visiÚ_id
 = vmcs_revision_id;

370  
vmcs
;

371 
	}
}

373 
	$vmx_ä“_vmcs
(
vmcs_¡ruù
 *
vmcs
)

375 
	`ä“_x’h—p_·ge
(
vmcs
);

376 
	}
}

378 
	$__vmx_ş—r_vmcs
(*
šfo
)

380 
vıu
 *
v
 = 
šfo
;

381 
¬ch_vmx_¡ruù
 *
¬ch_vmx
 = &
v
->
¬ch
.
hvm_vmx
;

384 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

386 iàĞ
¬ch_vmx
->
aùive_ıu
 =ğ
	`smp_´oûssÜ_id
() )

388 
	`__vmpş—r
(
	`vœt_to_maddr
(
¬ch_vmx
->
vmcs
));

390 
¬ch_vmx
->
aùive_ıu
 = -1;

391 
¬ch_vmx
->
Ïunched
 = 0;

393 
	`li¡_d–
(&
¬ch_vmx
->
aùive_li¡
);

395 iàĞ
¬ch_vmx
->
vmcs
 =ğ
	`this_ıu
(
cu¼’t_vmcs
) )

396 
	`this_ıu
(
cu¼’t_vmcs
èğ
NULL
;

398 
	}
}

400 
	$vmx_ş—r_vmcs
(
vıu
 *
v
)

402 
ıu
 = 
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
;

404 iàĞ
ıu
 != -1 )

405 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
), 
__vmx_ş—r_vmcs
, 
v
, 1);

406 
	}
}

408 
	$vmx_lßd_vmcs
(
vıu
 *
v
)

410 
æags
;

412 
	`loÿl_œq_§ve
(
æags
);

414 iàĞ
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
 == -1 )

416 
	`li¡_add
(&
v
->
¬ch
.
hvm_vmx
.
aùive_li¡
, &
	`this_ıu
(
aùive_vmcs_li¡
));

417 
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
 = 
	`smp_´oûssÜ_id
();

420 
	`ASSERT
(
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
 =ğ
	`smp_´oûssÜ_id
());

422 
	`__vm±¾d
(
	`vœt_to_maddr
(
v
->
¬ch
.
hvm_vmx
.
vmcs
));

423 
	`this_ıu
(
cu¼’t_vmcs
èğ
v
->
¬ch
.
hvm_vmx
.
vmcs
;

425 
	`loÿl_œq_»¡Üe
(
æags
);

426 
	}
}

428 
	$vmx_ıu_up_´•¬e
(
ıu
)

430 iàĞ
	`³r_ıu
(
vmxÚ_»giÚ
, 
ıu
è!ğ
NULL
 )

433 
	`³r_ıu
(
vmxÚ_»giÚ
, 
ıu
èğ
	`vmx_®loc_vmcs
();

434 iàĞ
	`³r_ıu
(
vmxÚ_»giÚ
, 
ıu
è!ğ
NULL
 )

437 
	`´štk
("CPU%d: Could‚Ù‡Îoÿ‹ ho¡ VMCS\n", 
ıu
);

438  -
ENOMEM
;

439 
	}
}

441 
	$vmx_ıu_d—d
(
ıu
)

443 
	`vmx_ä“_vmcs
(
	`³r_ıu
(
vmxÚ_»giÚ
, 
ıu
));

444 
	`³r_ıu
(
vmxÚ_»giÚ
, 
ıu
èğ
NULL
;

445 
	}
}

447 
	$vmx_ıu_up
()

449 
u32
 
—x
, 
edx
;

450 
rc
, 
bios_locked
, 
ıu
 = 
	`smp_´oûssÜ_id
();

451 
u64
 
ü0
, 
vmx_ü0_fixed0
, 
vmx_ü0_fixed1
;

453 
	`BUG_ON
(!(
	`»ad_ü4
(è& 
X86_CR4_VMXE
));

455 
	`vmx_§ve_ho¡_m¤s
();

461 
ü0
 = 
	`»ad_ü0
();

462 
	`rdm¤l
(
MSR_IA32_VMX_CR0_FIXED0
, 
vmx_ü0_fixed0
);

463 
	`rdm¤l
(
MSR_IA32_VMX_CR0_FIXED1
, 
vmx_ü0_fixed1
);

464 iàĞ(~
ü0
 & 
vmx_ü0_fixed0
è|| (ü0 & ~
vmx_ü0_fixed1
) )

466 
	`´štk
("CPU%d: some settings of host CR0‡re "

467 "nÙ‡Îowed iÀVMX o³¿tiÚ.\n", 
ıu
);

468  -
EINVAL
;

471 
	`rdm¤
(
IA32_FEATURE_CONTROL_MSR
, 
—x
, 
edx
);

473 
bios_locked
 = !!(
—x
 & 
IA32_FEATURE_CONTROL_MSR_LOCK
);

474 iàĞ
bios_locked
 )

476 iàĞ!(
—x
 & (
	`tboÙ_š_m—su»d_’v
()

477 ? 
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_INSIDE_SMX


478 : 
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_OUTSIDE_SMX
)) )

480 
	`´štk
("CPU%d: VMX di§bËd by BIOS.\n", 
ıu
);

481  -
EINVAL
;

486 
—x
 = 
IA32_FEATURE_CONTROL_MSR_LOCK
;

487 
—x
 |ğ
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_OUTSIDE_SMX
;

488 iàĞ
	`‹¡_b™
(
X86_FEATURE_SMXE
, &
boÙ_ıu_d©a
.
x86_ÿ·b™y
) )

489 
—x
 |ğ
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_INSIDE_SMX
;

490 
	`wrm¤
(
IA32_FEATURE_CONTROL_MSR
, 
—x
, 0);

493 iàĞ(
rc
 = 
	`vmx_š™_vmcs_cÚfig
()) != 0 )

494  
rc
;

496 
	`INIT_LIST_HEAD
(&
	`this_ıu
(
aùive_vmcs_li¡
));

498 iàĞ(
rc
 = 
	`vmx_ıu_up_´•¬e
(
ıu
)) != 0 )

499  
rc
;

501  
	`__vmxÚ
(
	`vœt_to_maddr
(
	`this_ıu
(
vmxÚ_»giÚ
))) )

504 iàĞ
bios_locked
 &&

505 
	`‹¡_b™
(
X86_FEATURE_SMXE
, &
boÙ_ıu_d©a
.
x86_ÿ·b™y
) &&

506 (!(
—x
 & 
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_OUTSIDE_SMX
) ||

507 !(
—x
 & 
IA32_FEATURE_CONTROL_MSR_ENABLE_VMXON_INSIDE_SMX
)) )

509 
	`´štk
("CPU%d: VMXON failed:…erhaps because of TXT settings "

510 "š you¸BIOS cÚfigu¿tiÚ?\n", 
ıu
);

511 
	`´štk
(" --> Disable TXT in your BIOS unless using‡ secure "

513  -
EINVAL
;

517 
	`´štk
("CPU%d: uÃx³ùed VMXON fau»\n", 
ıu
);

518  -
EINVAL
;

522 
	`BUG
();

525 
	`hvm_asid_š™
(
ıu_has_vmx_vpid
 ? (1u << 
VMCS_VPID_WIDTH
) : 0);

527 iàĞ
ıu_has_vmx_•t
 )

528 
	`•t_sync_®l
();

530 iàĞ
ıu_has_vmx_vpid
 )

531 
	`vpid_sync_®l
();

534 
	}
}

536 
	$vmx_ıu_down
()

538 
li¡_h—d
 *
aùive_vmcs_li¡
 = &
	`this_ıu
(active_vmcs_list);

539 
æags
;

541 
	`loÿl_œq_§ve
(
æags
);

543  !
	`li¡_em±y
(
aùive_vmcs_li¡
) )

544 
	`__vmx_ş—r_vmcs
(
	`li¡_’Œy
(
aùive_vmcs_li¡
->
Ãxt
,

545 
vıu
, 
¬ch
.
hvm_vmx
.
aùive_li¡
));

547 
	`BUG_ON
(!(
	`»ad_ü4
(è& 
X86_CR4_VMXE
));

548 
	`__vmxoff
();

550 
	`loÿl_œq_»¡Üe
(
æags
);

551 
	}
}

553 
	sfÜeign_vmcs
 {

554 
vıu
 *
	mv
;

555 
	mcouÁ
;

557 
DEFINE_PER_CPU
(
fÜeign_vmcs
, foreign_vmcs);

559 
	$vmx_vmcs_’‹r
(
vıu
 *
v
)

561 
fÜeign_vmcs
 *
fv
;

567 iàĞ
	`lik–y
(
v
 =ğ
cu¼’t
) )

570 
fv
 = &
	`this_ıu
(
fÜeign_vmcs
);

572 iàĞ
fv
->
v
 == v )

574 
	`BUG_ON
(
fv
->
couÁ
 == 0);

578 
	`BUG_ON
(
fv
->
v
 !ğ
NULL
);

579 
	`BUG_ON
(
fv
->
couÁ
 != 0);

581 
	`vıu_·u£
(
v
);

582 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vmx
.
vmcs_lock
);

584 
	`vmx_ş—r_vmcs
(
v
);

585 
	`vmx_lßd_vmcs
(
v
);

587 
fv
->
v
 = v;

590 
fv
->
couÁ
++;

591 
	}
}

593 
	$vmx_vmcs_ex™
(
vıu
 *
v
)

595 
fÜeign_vmcs
 *
fv
;

597 iàĞ
	`lik–y
(
v
 =ğ
cu¼’t
) )

600 
fv
 = &
	`this_ıu
(
fÜeign_vmcs
);

601 
	`BUG_ON
(
fv
->
v
 != v);

602 
	`BUG_ON
(
fv
->
couÁ
 == 0);

604 iàĞ--
fv
->
couÁ
 == 0 )

607 
	`vmx_ş—r_vmcs
(
v
);

608 iàĞ
	`is_hvm_vıu
(
cu¼’t
) )

609 
	`vmx_lßd_vmcs
(
cu¼’t
);

611 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vmx
.
vmcs_lock
);

612 
	`vıu_uÅau£
(
v
);

614 
fv
->
v
 = 
NULL
;

616 
	}
}

618 
	sxgt_desc
 {

619 
	msize
;

620 
add»ss
 
__©Œibu‹__
((
·cked
));

623 
	$vmx_£t_ho¡_’v
(
vıu
 *
v
)

625 
ıu
 = 
	`smp_´oûssÜ_id
();

627 
	`__vmwr™e
(
HOST_GDTR_BASE
,

628 ()(
	`this_ıu
(
gdt_bË
è- 
FIRST_RESERVED_GDT_ENTRY
));

629 
	`__vmwr™e
(
HOST_IDTR_BASE
, ()
idt_bËs
[
ıu
]);

631 
	`__vmwr™e
(
HOST_TR_SELECTOR
, 
TSS_ENTRY
 << 3);

632 
	`__vmwr™e
(
HOST_TR_BASE
, ()&
	`³r_ıu
(
š™_tss
, 
ıu
));

634 
	`__vmwr™e
(
HOST_SYSENTER_ESP
, 
	`g‘_¡ack_bÙtom
());

641 
	`__vmwr™e
(
HOST_RSP
,

642 ()&
	`g‘_ıu_šfo
()->
gue¡_ıu_u£r_»gs
.
”rÜ_code
);

643 
	}
}

645 
	$vmx_di§bË_š‹rû±_fÜ_m¤
(
vıu
 *
v
, 
u32
 
m¤
)

647 *
m¤_b™m­
 = 
v
->
¬ch
.
hvm_vmx
.msr_bitmap;

650 iàĞ
m¤_b™m­
 =ğ
NULL
 )

658 iàĞ
m¤
 <= 0x1fff )

660 
	`__ş—r_b™
(
m¤
, 
m¤_b™m­
 + 0x000/
BYTES_PER_LONG
);

661 
	`__ş—r_b™
(
m¤
, 
m¤_b™m­
 + 0x800/
BYTES_PER_LONG
);

663 iàĞ(
m¤
 >= 0xc0000000) && (msr <= 0xc0001fff) )

665 
m¤
 &= 0x1fff;

666 
	`__ş—r_b™
(
m¤
, 
m¤_b™m­
 + 0x400/
BYTES_PER_LONG
);

667 
	`__ş—r_b™
(
m¤
, 
m¤_b™m­
 + 0xc00/
BYTES_PER_LONG
);

669 
	}
}

671 
	$cÚ¡ruù_vmcs
(
vıu
 *
v
)

673 
domaš
 *
d
 = 
v
->domain;

674 
ušt16_t
 
sy£Á”_cs
;

675 
sy£Á”_e
;

676 
u32
 
vmex™_ùl
 = 
vmx_vmex™_cÚŒŞ
;

677 
u32
 
vm’Œy_ùl
 = 
vmx_vm’Œy_cÚŒŞ
;

679 
	`vmx_vmcs_’‹r
(
v
);

682 
	`__vmwr™e
(
PIN_BASED_VM_EXEC_CONTROL
, 
vmx_pš_ba£d_exec_cÚŒŞ
);

684 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 = 
vmx_ıu_ba£d_exec_cÚŒŞ
;

685 iàĞ
d
->
¬ch
.
vtsc
 )

686 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
CPU_BASED_RDTSC_EXITING
;

688 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 = 
vmx_£cÚd¬y_exec_cÚŒŞ
;

691 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 &ğ~
SECONDARY_EXEC_ENABLE_VPID
;

693 iàĞ
	`·gšg_mode_h­
(
d
) )

695 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~(
CPU_BASED_INVLPG_EXITING
 |

696 
CPU_BASED_CR3_LOAD_EXITING
 |

697 
CPU_BASED_CR3_STORE_EXITING
);

701 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 &=

702 ~(
SECONDARY_EXEC_ENABLE_EPT
 |

703 
SECONDARY_EXEC_UNRESTRICTED_GUEST
);

704 
vmex™_ùl
 &ğ~(
VM_EXIT_SAVE_GUEST_PAT
 |

705 
VM_EXIT_LOAD_HOST_PAT
);

706 
vm’Œy_ùl
 &ğ~
VM_ENTRY_LOAD_GUEST_PAT
;

710 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_MONITOR_TRAP_FLAG
;

712 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

713 
	`__vmwr™e
(
VM_EXIT_CONTROLS
, 
vmex™_ùl
);

714 
	`__vmwr™e
(
VM_ENTRY_CONTROLS
, 
vm’Œy_ùl
);

716 iàĞ
ıu_has_vmx_¶e
 )

718 
	`__vmwr™e
(
PLE_GAP
, 
¶e_g­
);

719 
	`__vmwr™e
(
PLE_WINDOW
, 
¶e_wšdow
);

722 iàĞ
ıu_has_vmx_£cÚd¬y_exec_cÚŒŞ
 )

723 
	`__vmwr™e
(
SECONDARY_VM_EXEC_CONTROL
,

724 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
);

727 iàĞ
ıu_has_vmx_m¤_b™m­
 )

729 *
m¤_b™m­
 = 
	`®loc_x’h—p_·ge
();

731 iàĞ
m¤_b™m­
 =ğ
NULL
 )

732  -
ENOMEM
;

734 
	`mem£t
(
m¤_b™m­
, ~0, 
PAGE_SIZE
);

735 
v
->
¬ch
.
hvm_vmx
.
m¤_b™m­
 = msr_bitmap;

736 
	`__vmwr™e
(
MSR_BITMAP
, 
	`vœt_to_maddr
(
m¤_b™m­
));

738 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_FS_BASE
);

739 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_GS_BASE
);

740 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_SYSENTER_CS
);

741 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_SYSENTER_ESP
);

742 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_SYSENTER_EIP
);

743 iàĞ
ıu_has_vmx_·t
 && 
	`·gšg_mode_h­
(
d
) )

744 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
MSR_IA32_CR_PAT
);

748 
	`__vmwr™e
(
IO_BITMAP_A
, 
	`vœt_to_maddr
((*)
hvm_io_b™m­
 + 0));

749 
	`__vmwr™e
(
IO_BITMAP_B
, 
	`vœt_to_maddr
((*)
hvm_io_b™m­
 + 
PAGE_SIZE
));

752 
	`__vmwr™e
(
HOST_SS_SELECTOR
, 
__HYPERVISOR_DS
);

753 
	`__vmwr™e
(
HOST_DS_SELECTOR
, 
__HYPERVISOR_DS
);

754 
	`__vmwr™e
(
HOST_ES_SELECTOR
, 
__HYPERVISOR_DS
);

755 
	`__vmwr™e
(
HOST_FS_SELECTOR
, 0);

756 
	`__vmwr™e
(
HOST_GS_SELECTOR
, 0);

757 
	`__vmwr™e
(
HOST_FS_BASE
, 0);

758 
	`__vmwr™e
(
HOST_GS_BASE
, 0);

761 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
 = 
	`»ad_ü0
(è| 
X86_CR0_TS
;

762 
	`__vmwr™e
(
HOST_CR0
, 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
);

763 
	`__vmwr™e
(
HOST_CR4
,

764 
mmu_ü4_ã©u»s
 | (
	`x§ve_’abËd
(
v
è? 
X86_CR4_OSXSAVE
 : 0));

767 
	`__vmwr™e
(
HOST_CS_SELECTOR
, 
__HYPERVISOR_CS
);

768 
	`__vmwr™e
(
HOST_RIP
, ()
vmx_asm_vmex™_hªdËr
);

771 
	`rdm¤l
(
MSR_IA32_SYSENTER_CS
, 
sy£Á”_cs
);

772 
	`__vmwr™e
(
HOST_SYSENTER_CS
, 
sy£Á”_cs
);

773 
	`rdm¤l
(
MSR_IA32_SYSENTER_EIP
, 
sy£Á”_e
);

774 
	`__vmwr™e
(
HOST_SYSENTER_EIP
, 
sy£Á”_e
);

777 
	`__vmwr™e
(
VM_EXIT_MSR_LOAD_COUNT
, 0);

778 
	`__vmwr™e
(
VM_EXIT_MSR_STORE_COUNT
, 0);

779 
	`__vmwr™e
(
VM_ENTRY_MSR_LOAD_COUNT
, 0);

781 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 0);

783 
	`__vmwr™e
(
CR0_GUEST_HOST_MASK
, ~0UL);

784 
	`__vmwr™e
(
CR4_GUEST_HOST_MASK
, ~0UL);

786 
	`__vmwr™e
(
PAGE_FAULT_ERROR_CODE_MASK
, 0);

787 
	`__vmwr™e
(
PAGE_FAULT_ERROR_CODE_MATCH
, 0);

789 
	`__vmwr™e
(
CR3_TARGET_COUNT
, 0);

791 
	`__vmwr™e
(
GUEST_ACTIVITY_STATE
, 0);

794 
	`__vmwr™e
(
GUEST_ES_BASE
, 0);

795 
	`__vmwr™e
(
GUEST_SS_BASE
, 0);

796 
	`__vmwr™e
(
GUEST_DS_BASE
, 0);

797 
	`__vmwr™e
(
GUEST_FS_BASE
, 0);

798 
	`__vmwr™e
(
GUEST_GS_BASE
, 0);

799 
	`__vmwr™e
(
GUEST_CS_BASE
, 0);

802 
	`__vmwr™e
(
GUEST_ES_LIMIT
, ~0u);

803 
	`__vmwr™e
(
GUEST_SS_LIMIT
, ~0u);

804 
	`__vmwr™e
(
GUEST_DS_LIMIT
, ~0u);

805 
	`__vmwr™e
(
GUEST_FS_LIMIT
, ~0u);

806 
	`__vmwr™e
(
GUEST_GS_LIMIT
, ~0u);

807 
	`__vmwr™e
(
GUEST_CS_LIMIT
, ~0u);

810 
	`__vmwr™e
(
GUEST_ES_AR_BYTES
, 0xc093);

811 
	`__vmwr™e
(
GUEST_SS_AR_BYTES
, 0xc093);

812 
	`__vmwr™e
(
GUEST_DS_AR_BYTES
, 0xc093);

813 
	`__vmwr™e
(
GUEST_FS_AR_BYTES
, 0xc093);

814 
	`__vmwr™e
(
GUEST_GS_AR_BYTES
, 0xc093);

815 
	`__vmwr™e
(
GUEST_CS_AR_BYTES
, 0xc09b);

818 
	`__vmwr™e
(
GUEST_IDTR_BASE
, 0);

819 
	`__vmwr™e
(
GUEST_IDTR_LIMIT
, 0);

822 
	`__vmwr™e
(
GUEST_GDTR_BASE
, 0);

823 
	`__vmwr™e
(
GUEST_GDTR_LIMIT
, 0);

826 
	`__vmwr™e
(
GUEST_LDTR_AR_BYTES
, 0x0082);

827 
	`__vmwr™e
(
GUEST_LDTR_SELECTOR
, 0);

828 
	`__vmwr™e
(
GUEST_LDTR_BASE
, 0);

829 
	`__vmwr™e
(
GUEST_LDTR_LIMIT
, 0);

832 
	`__vmwr™e
(
GUEST_TR_AR_BYTES
, 0x008b);

833 
	`__vmwr™e
(
GUEST_TR_BASE
, 0);

834 
	`__vmwr™e
(
GUEST_TR_LIMIT
, 0xff);

836 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 0);

837 
	`__vmwr™e
(
GUEST_DR7
, 0);

838 
	`__vmwr™e
(
VMCS_LINK_POINTER
, ~0UL);

839 #ià
	`defšed
(
__i386__
)

840 
	`__vmwr™e
(
VMCS_LINK_POINTER_HIGH
, ~0UL);

843 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 = 
HVM_TRAP_MASK


844 | (
	`·gšg_mode_h­
(
d
è? 0 : (1U << 
TRAP_·ge_çuÉ
))

845 | (1U << 
TRAP_no_deviû
);

846 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

848 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
X86_CR0_PE
 | 
X86_CR0_ET
;

849 
	`hvm_upd©e_gue¡_ü
(
v
, 0);

851 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 0;

852 
	`hvm_upd©e_gue¡_ü
(
v
, 4);

854 iàĞ
ıu_has_vmx_r_shadow
 )

856 
	`__vmwr™e
(
VIRTUAL_APIC_PAGE_ADDR
,

857 
	`·ge_to_maddr
(
	`vıu_vÏpic
(
v
)->
»gs_·ge
));

858 
	`__vmwr™e
(
TPR_THRESHOLD
, 0);

861 iàĞ
	`·gšg_mode_h­
(
d
) )

863 
	`__vmwr™e
(
EPT_POINTER
, 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_cÚŒŞ
.
•
);

864 #ifdeà
__i386__


865 
	`__vmwr™e
(
EPT_POINTER_HIGH
,

866 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_cÚŒŞ
.
•
 >> 32);

870 iàĞ
ıu_has_vmx_vpid
 )

871 
	`__vmwr™e
(
VIRTUAL_PROCESSOR_ID
, 
v
->
¬ch
.
hvm_vıu
.
asid
);

873 iàĞ
ıu_has_vmx_·t
 && 
	`·gšg_mode_h­
(
d
) )

875 
u64
 
ho¡_·t
, 
gue¡_·t
;

877 
	`rdm¤l
(
MSR_IA32_CR_PAT
, 
ho¡_·t
);

878 
gue¡_·t
 = 
MSR_IA32_CR_PAT_RESET
;

880 
	`__vmwr™e
(
HOST_PAT
, 
ho¡_·t
);

881 
	`__vmwr™e
(
GUEST_PAT
, 
gue¡_·t
);

882 #ifdeà
__i386__


883 
	`__vmwr™e
(
HOST_PAT_HIGH
, 
ho¡_·t
 >> 32);

884 
	`__vmwr™e
(
GUEST_PAT_HIGH
, 
gue¡_·t
 >> 32);

888 
	`vmx_vmcs_ex™
(
v
);

890 
	`·gšg_upd©e_·gšg_modes
(
v
);

892 
	`vmx_vÏpic_m¤_chªged
(
v
);

895 
	}
}

897 
	$vmx_»ad_gue¡_m¤
(
u32
 
m¤
, 
u64
 *
v®
)

899 
vıu
 *
cu¼
 = 
cu¼’t
;

900 
i
, 
m¤_couÁ
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_count;

901 cÚ¡ 
vmx_m¤_’Œy
 *
m¤_¬—
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_area;

903  
i
 = 0; i < 
m¤_couÁ
; i++ )

905 iàĞ
m¤_¬—
[
i
].
šdex
 =ğ
m¤
 )

907 *
v®
 = 
m¤_¬—
[
i
].
d©a
;

912  -
ESRCH
;

913 
	}
}

915 
	$vmx_wr™e_gue¡_m¤
(
u32
 
m¤
, 
u64
 
v®
)

917 
vıu
 *
cu¼
 = 
cu¼’t
;

918 
i
, 
m¤_couÁ
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_count;

919 
vmx_m¤_’Œy
 *
m¤_¬—
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_area;

921  
i
 = 0; i < 
m¤_couÁ
; i++ )

923 iàĞ
m¤_¬—
[
i
].
šdex
 =ğ
m¤
 )

925 
m¤_¬—
[
i
].
d©a
 = 
v®
;

930  -
ESRCH
;

931 
	}
}

933 
	$vmx_add_gue¡_m¤
(
u32
 
m¤
)

935 
vıu
 *
cu¼
 = 
cu¼’t
;

936 
i
, 
m¤_couÁ
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_count;

937 
vmx_m¤_’Œy
 *
m¤_¬—
 = 
cu¼
->
¬ch
.
hvm_vmx
.msr_area;

939 iàĞ
m¤_¬—
 =ğ
NULL
 )

941 iàĞ(
m¤_¬—
 = 
	`®loc_x’h—p_·ge
()è=ğ
NULL
 )

942  -
ENOMEM
;

943 
cu¼
->
¬ch
.
hvm_vmx
.
m¤_¬—
 = msr_area;

944 
	`__vmwr™e
(
VM_EXIT_MSR_STORE_ADDR
, 
	`vœt_to_maddr
(
m¤_¬—
));

945 
	`__vmwr™e
(
VM_ENTRY_MSR_LOAD_ADDR
, 
	`vœt_to_maddr
(
m¤_¬—
));

948  
i
 = 0; i < 
m¤_couÁ
; i++ )

949 iàĞ
m¤_¬—
[
i
].
šdex
 =ğ
m¤
 )

952 iàĞ
m¤_couÁ
 =ğ(
PAGE_SIZE
 / (
vmx_m¤_’Œy
)) )

953  -
ENOSPC
;

955 
m¤_¬—
[
m¤_couÁ
].
šdex
 = 
m¤
;

956 
m¤_¬—
[
m¤_couÁ
].
mbz
 = 0;

957 
m¤_¬—
[
m¤_couÁ
].
d©a
 = 0;

958 
cu¼
->
¬ch
.
hvm_vmx
.
m¤_couÁ
 = ++msr_count;

959 
	`__vmwr™e
(
VM_EXIT_MSR_STORE_COUNT
, 
m¤_couÁ
);

960 
	`__vmwr™e
(
VM_ENTRY_MSR_LOAD_COUNT
, 
m¤_couÁ
);

963 
	}
}

965 
	$vmx_add_ho¡_lßd_m¤
(
u32
 
m¤
)

967 
vıu
 *
cu¼
 = 
cu¼’t
;

968 
i
, 
m¤_couÁ
 = 
cu¼
->
¬ch
.
hvm_vmx
.
ho¡_m¤_couÁ
;

969 
vmx_m¤_’Œy
 *
m¤_¬—
 = 
cu¼
->
¬ch
.
hvm_vmx
.
ho¡_m¤_¬—
;

971 iàĞ
m¤_¬—
 =ğ
NULL
 )

973 iàĞ(
m¤_¬—
 = 
	`®loc_x’h—p_·ge
()è=ğ
NULL
 )

974  -
ENOMEM
;

975 
cu¼
->
¬ch
.
hvm_vmx
.
ho¡_m¤_¬—
 = 
m¤_¬—
;

976 
	`__vmwr™e
(
VM_EXIT_MSR_LOAD_ADDR
, 
	`vœt_to_maddr
(
m¤_¬—
));

979  
i
 = 0; i < 
m¤_couÁ
; i++ )

980 iàĞ
m¤_¬—
[
i
].
šdex
 =ğ
m¤
 )

983 iàĞ
m¤_couÁ
 =ğ(
PAGE_SIZE
 / (
vmx_m¤_’Œy
)) )

984  -
ENOSPC
;

986 
m¤_¬—
[
m¤_couÁ
].
šdex
 = 
m¤
;

987 
m¤_¬—
[
m¤_couÁ
].
mbz
 = 0;

988 
	`rdm¤l
(
m¤
, 
m¤_¬—
[
m¤_couÁ
].
d©a
);

989 
cu¼
->
¬ch
.
hvm_vmx
.
ho¡_m¤_couÁ
 = ++
m¤_couÁ
;

990 
	`__vmwr™e
(
VM_EXIT_MSR_LOAD_COUNT
, 
m¤_couÁ
);

993 
	}
}

995 
	$vmx_ü—‹_vmcs
(
vıu
 *
v
)

997 
¬ch_vmx_¡ruù
 *
¬ch_vmx
 = &
v
->
¬ch
.
hvm_vmx
;

998 
rc
;

1000 iàĞ(
¬ch_vmx
->
vmcs
 = 
	`vmx_®loc_vmcs
()è=ğ
NULL
 )

1001  -
ENOMEM
;

1003 
	`INIT_LIST_HEAD
(&
¬ch_vmx
->
aùive_li¡
);

1004 
	`__vmpş—r
(
	`vœt_to_maddr
(
¬ch_vmx
->
vmcs
));

1005 
¬ch_vmx
->
aùive_ıu
 = -1;

1006 
¬ch_vmx
->
Ïunched
 = 0;

1008 iàĞ(
rc
 = 
	`cÚ¡ruù_vmcs
(
v
)) != 0 )

1010 
	`vmx_ä“_vmcs
(
¬ch_vmx
->
vmcs
);

1011  
rc
;

1015 
	}
}

1017 
	$vmx_de¡roy_vmcs
(
vıu
 *
v
)

1019 
¬ch_vmx_¡ruù
 *
¬ch_vmx
 = &
v
->
¬ch
.
hvm_vmx
;

1021 
	`vmx_ş—r_vmcs
(
v
);

1023 
	`vmx_ä“_vmcs
(
¬ch_vmx
->
vmcs
);

1025 
	`ä“_x’h—p_·ge
(
v
->
¬ch
.
hvm_vmx
.
ho¡_m¤_¬—
);

1026 
	`ä“_x’h—p_·ge
(
v
->
¬ch
.
hvm_vmx
.
m¤_¬—
);

1027 
	`ä“_x’h—p_·ge
(
v
->
¬ch
.
hvm_vmx
.
m¤_b™m­
);

1028 
	}
}

1030 
	$vm_Ïunch_ç
()

1032 
”rÜ
 = 
	`__vm»ad
(
VM_INSTRUCTION_ERROR
);

1033 
	`´štk
("<vm_Ïunch_ç>ƒ¼Ü cod%lx\n", 
”rÜ
);

1034 
	`domaš_üash_synchrÚous
();

1035 
	}
}

1037 
	$vm_»sume_ç
()

1039 
”rÜ
 = 
	`__vm»ad
(
VM_INSTRUCTION_ERROR
);

1040 
	`´štk
("<vm_»sume_ç>ƒ¼Ü cod%lx\n", 
”rÜ
);

1041 
	`domaš_üash_synchrÚous
();

1042 
	}
}

1044 
	$wbšvd_i
(*
šfo
)

1046 
	`wbšvd
();

1047 
	}
}

1049 
	$vmx_do_»sume
(
vıu
 *
v
)

1051 
boŞ_t
 
debug_¡©e
;

1053 iàĞ
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
 =ğ
	`smp_´oûssÜ_id
() )

1055 iàĞ
v
->
¬ch
.
hvm_vmx
.
vmcs
 !ğ
	`this_ıu
(
cu¼’t_vmcs
) )

1056 
	`vmx_lßd_vmcs
(
v
);

1070 iàĞ
	`has_¬ch_pdevs
(
v
->
domaš
è&& !
iommu_¢oİ


1071 && !
ıu_has_wbšvd_ex™šg
 )

1073 
ıu
 = 
v
->
¬ch
.
hvm_vmx
.
aùive_ıu
;

1074 iàĞ
ıu
 != -1 )

1075 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(
ıu
), 
wbšvd_i
, 
NULL
, 1);

1078 
	`vmx_ş—r_vmcs
(
v
);

1079 
	`vmx_lßd_vmcs
(
v
);

1080 
	`hvm_mig¿‹_tim”s
(
v
);

1081 
	`hvm_mig¿‹_pœqs
(
v
);

1082 
	`vmx_£t_ho¡_’v
(
v
);

1083 
	`hvm_asid_æush_vıu
(
v
);

1086 
debug_¡©e
 = 
v
->
domaš
->
debugg”_©ched


1087 || 
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_MEMORY_EVENT_INT3
]

1088 || 
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_MEMORY_EVENT_SINGLE_STEP
];

1090 iàĞ
	`uÆik–y
(
v
->
¬ch
.
hvm_vıu
.
debug_¡©e_Ïtch
 !ğ
debug_¡©e
) )

1092 
v
->
¬ch
.
hvm_vıu
.
debug_¡©e_Ïtch
 = 
debug_¡©e
;

1093 
	`vmx_upd©e_debug_¡©e
(
v
);

1096 
	`hvm_do_»sume
(
v
);

1097 
	`»£t_¡ack_ªd_jump
(
vmx_asm_do_vm’Œy
);

1098 
	}
}

1100 
	$vmr
(
f›ld
)

1102 
rc
;

1103 
v®
;

1104 
v®
 = 
	`__vm»ad_§ã
(
f›ld
, &
rc
);

1105  
rc
 ? 0 : 
v®
;

1106 
	}
}

1108 
	$vmx_dump_£l
(*
Çme
, 
ušt32_t
 
£ËùÜ
)

1110 
ušt32_t
 
£l
, 
©Œ
, 
lim™
;

1111 
ušt64_t
 
ba£
;

1112 
£l
 = 
	`vmr
(
£ËùÜ
);

1113 
©Œ
 = 
	`vmr
(
£ËùÜ
 + (
GUEST_ES_AR_BYTES
 - 
GUEST_ES_SELECTOR
));

1114 
lim™
 = 
	`vmr
(
£ËùÜ
 + (
GUEST_ES_LIMIT
 - 
GUEST_ES_SELECTOR
));

1115 
ba£
 = 
	`vmr
(
£ËùÜ
 + (
GUEST_ES_BASE
 - 
GUEST_ES_SELECTOR
));

1116 
	`´štk
("%s: s–=0x%04x,‡‰r=0x%05x,†im™=0x%08x, ba£=0x%016"
PRIx64
"\n",

1117 
Çme
, 
£l
, 
©Œ
, 
lim™
, 
ba£
);

1118 
	}
}

1120 
	$vmx_dump_£l2
(*
Çme
, 
ušt32_t
 
lim
)

1122 
ušt32_t
 
lim™
;

1123 
ušt64_t
 
ba£
;

1124 
lim™
 = 
	`vmr
(
lim
);

1125 
ba£
 = 
	`vmr
(
lim
 + (
GUEST_GDTR_BASE
 - 
GUEST_GDTR_LIMIT
));

1126 
	`´štk
("%s:†im™=0x%08x, ba£=0x%016"
PRIx64
"\n",

1127 
Çme
, 
lim™
, 
ba£
);

1128 
	}
}

1130 
	$vmcs_dump_vıu
(
vıu
 *
v
)

1132 
ıu_u£r_»gs
 *
»gs
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
;

1133 
x
;

1135 iàĞ
v
 =ğ
cu¼’t
 )

1136 
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1138 
	`vmx_vmcs_’‹r
(
v
);

1140 
	`´štk
("*** Guest State ***\n");

1141 
	`´štk
("CR0:‡ctual=0x%016llx, shadow=0x%016llx, gh_mask=%016llx\n",

1142 ()
	`vmr
(
GUEST_CR0
),

1143 ()
	`vmr
(
CR0_READ_SHADOW
),

1144 ()
	`vmr
(
CR0_GUEST_HOST_MASK
));

1145 
	`´štk
("CR4:‡ctual=0x%016llx, shadow=0x%016llx, gh_mask=%016llx\n",

1146 ()
	`vmr
(
GUEST_CR4
),

1147 ()
	`vmr
(
CR4_READ_SHADOW
),

1148 ()
	`vmr
(
CR4_GUEST_HOST_MASK
));

1149 
	`´štk
("CR3:‡ctual=0x%016llx,arget_count=%d\n",

1150 ()
	`vmr
(
GUEST_CR3
),

1151 ()
	`vmr
(
CR3_TARGET_COUNT
));

1152 
	`´štk
("arget0=%016llx,arget1=%016llx\n",

1153 ()
	`vmr
(
CR3_TARGET_VALUE0
),

1154 ()
	`vmr
(
CR3_TARGET_VALUE1
));

1155 
	`´štk
("arget2=%016llx,arget3=%016llx\n",

1156 ()
	`vmr
(
CR3_TARGET_VALUE2
),

1157 ()
	`vmr
(
CR3_TARGET_VALUE3
));

1158 
	`´štk
("RSP = 0x%016llx (0x%016llx) RIP = 0x%016llx (0x%016llx)\n",

1159 ()
	`vmr
(
GUEST_RSP
),

1160 ()
»gs
->
e¥
,

1161 ()
	`vmr
(
GUEST_RIP
),

1162 ()
»gs
->
e
);

1163 
	`´štk
("RFLAGS=0x%016llx (0x%016llx) DR7 = 0x%016llx\n",

1164 ()
	`vmr
(
GUEST_RFLAGS
),

1165 ()
»gs
->
eæags
,

1166 ()
	`vmr
(
GUEST_DR7
));

1167 
	`´štk
("Sysenter RSP=%016llx CS:RIP=%04x:%016llx\n",

1168 ()
	`vmr
(
GUEST_SYSENTER_ESP
),

1169 ()
	`vmr
(
GUEST_SYSENTER_CS
),

1170 ()
	`vmr
(
GUEST_SYSENTER_EIP
));

1171 
	`vmx_dump_£l
("CS", 
GUEST_CS_SELECTOR
);

1172 
	`vmx_dump_£l
("DS", 
GUEST_DS_SELECTOR
);

1173 
	`vmx_dump_£l
("SS", 
GUEST_SS_SELECTOR
);

1174 
	`vmx_dump_£l
("ES", 
GUEST_ES_SELECTOR
);

1175 
	`vmx_dump_£l
("FS", 
GUEST_FS_SELECTOR
);

1176 
	`vmx_dump_£l
("GS", 
GUEST_GS_SELECTOR
);

1177 
	`vmx_dump_£l2
("GDTR", 
GUEST_GDTR_LIMIT
);

1178 
	`vmx_dump_£l
("LDTR", 
GUEST_LDTR_SELECTOR
);

1179 
	`vmx_dump_£l2
("IDTR", 
GUEST_IDTR_LIMIT
);

1180 
	`vmx_dump_£l
("TR", 
GUEST_TR_SELECTOR
);

1181 
	`´štk
("Guest PAT = 0x%08x%08x\n",

1182 (
ušt32_t
)
	`vmr
(
GUEST_PAT_HIGH
), (ušt32_t)vmr(
GUEST_PAT
));

1183 
x
 = ()
	`vmr
(
TSC_OFFSET_HIGH
) << 32;

1184 
x
 |ğ(
ušt32_t
)
	`vmr
(
TSC_OFFSET
);

1185 
	`´štk
("TSC Off£ˆğ%016Îx\n", 
x
);

1186 
x
 = ()
	`vmr
(
GUEST_IA32_DEBUGCTL_HIGH
) << 32;

1187 
x
 |ğ(
ušt32_t
)
	`vmr
(
GUEST_IA32_DEBUGCTL
);

1188 
	`´štk
("DebugC=%016Îx DebugExû±iÚs=%016Îx\n", 
x
,

1189 ()
	`vmr
(
GUEST_PENDING_DBG_EXCEPTIONS
));

1190 
	`´štk
("Interruptibility=%04x ActivityState=%04x\n",

1191 ()
	`vmr
(
GUEST_INTERRUPTIBILITY_INFO
),

1192 ()
	`vmr
(
GUEST_ACTIVITY_STATE
));

1194 
	`´štk
("*** Host State ***\n");

1195 
	`´štk
("RSP = 0x%016llx RIP = 0x%016llx\n",

1196 ()
	`vmr
(
HOST_RSP
),

1197 ()
	`vmr
(
HOST_RIP
));

1198 
	`´štk
("CS=%04x DS=%04x ES=%04x FS=%04x GS=%04x SS=%04x TR=%04x\n",

1199 (
ušt16_t
)
	`vmr
(
HOST_CS_SELECTOR
),

1200 (
ušt16_t
)
	`vmr
(
HOST_DS_SELECTOR
),

1201 (
ušt16_t
)
	`vmr
(
HOST_ES_SELECTOR
),

1202 (
ušt16_t
)
	`vmr
(
HOST_FS_SELECTOR
),

1203 (
ušt16_t
)
	`vmr
(
HOST_GS_SELECTOR
),

1204 (
ušt16_t
)
	`vmr
(
HOST_SS_SELECTOR
),

1205 (
ušt16_t
)
	`vmr
(
HOST_TR_SELECTOR
));

1206 
	`´štk
("FSBase=%016llx GSBase=%016llx TRBase=%016llx\n",

1207 ()
	`vmr
(
HOST_FS_BASE
),

1208 ()
	`vmr
(
HOST_GS_BASE
),

1209 ()
	`vmr
(
HOST_TR_BASE
));

1210 
	`´štk
("GDTBase=%016llx IDTBase=%016llx\n",

1211 ()
	`vmr
(
HOST_GDTR_BASE
),

1212 ()
	`vmr
(
HOST_IDTR_BASE
));

1213 
	`´štk
("CR0=%016llx CR3=%016llx CR4=%016llx\n",

1214 ()
	`vmr
(
HOST_CR0
),

1215 ()
	`vmr
(
HOST_CR3
),

1216 ()
	`vmr
(
HOST_CR4
));

1217 
	`´štk
("Sysenter RSP=%016llx CS:RIP=%04x:%016llx\n",

1218 ()
	`vmr
(
HOST_SYSENTER_ESP
),

1219 ()
	`vmr
(
HOST_SYSENTER_CS
),

1220 ()
	`vmr
(
HOST_SYSENTER_EIP
));

1221 
	`´štk
("Host PAT = 0x%08x%08x\n",

1222 (
ušt32_t
)
	`vmr
(
HOST_PAT_HIGH
), (ušt32_t)vmr(
HOST_PAT
));

1224 
	`´štk
("*** Control State ***\n");

1225 
	`´štk
("PinBased=%08x CPUBased=%08x SecondaryExec=%08x\n",

1226 (
ušt32_t
)
	`vmr
(
PIN_BASED_VM_EXEC_CONTROL
),

1227 (
ušt32_t
)
	`vmr
(
CPU_BASED_VM_EXEC_CONTROL
),

1228 (
ušt32_t
)
	`vmr
(
SECONDARY_VM_EXEC_CONTROL
));

1229 
	`´štk
("EntryControls=%08x ExitControls=%08x\n",

1230 (
ušt32_t
)
	`vmr
(
VM_ENTRY_CONTROLS
),

1231 (
ušt32_t
)
	`vmr
(
VM_EXIT_CONTROLS
));

1232 
	`´štk
("ExceptionBitmap=%08x\n",

1233 (
ušt32_t
)
	`vmr
(
EXCEPTION_BITMAP
));

1234 
	`´štk
("VMEntry: intr_info=%08xƒrrcode=%08x ilen=%08x\n",

1235 (
ušt32_t
)
	`vmr
(
VM_ENTRY_INTR_INFO
),

1236 (
ušt32_t
)
	`vmr
(
VM_ENTRY_EXCEPTION_ERROR_CODE
),

1237 (
ušt32_t
)
	`vmr
(
VM_ENTRY_INSTRUCTION_LEN
));

1238 
	`´štk
("VMExit: intr_info=%08xƒrrcode=%08x ilen=%08x\n",

1239 (
ušt32_t
)
	`vmr
(
VM_EXIT_INTR_INFO
),

1240 (
ušt32_t
)
	`vmr
(
VM_EXIT_INTR_ERROR_CODE
),

1241 (
ušt32_t
)
	`vmr
(
VM_ENTRY_INSTRUCTION_LEN
));

1242 
	`´štk
("„eason=%08x qualification=%08x\n",

1243 (
ušt32_t
)
	`vmr
(
VM_EXIT_REASON
),

1244 (
ušt32_t
)
	`vmr
(
EXIT_QUALIFICATION
));

1245 
	`´štk
("IDTVectoring: info=%08xƒrrcode=%08x\n",

1246 (
ušt32_t
)
	`vmr
(
IDT_VECTORING_INFO
),

1247 (
ušt32_t
)
	`vmr
(
IDT_VECTORING_ERROR_CODE
));

1248 
	`´štk
("TPR Threshold = 0x%02x\n",

1249 (
ušt32_t
)
	`vmr
(
TPR_THRESHOLD
));

1250 
	`´štk
("EPT…ointer = 0x%08x%08x\n",

1251 (
ušt32_t
)
	`vmr
(
EPT_POINTER_HIGH
), (ušt32_t)vmr(
EPT_POINTER
));

1252 
	`´štk
("Virtual…rocessor ID = 0x%04x\n",

1253 (
ušt32_t
)
	`vmr
(
VIRTUAL_PROCESSOR_ID
));

1255 
	`vmx_vmcs_ex™
(
v
);

1256 
	}
}

1258 
	$vmcs_dump
(
ch
)

1260 
domaš
 *
d
;

1261 
vıu
 *
v
;

1263 
	`´štk
("*********** VMCS Areas **************\n");

1265 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1267 
	`fÜ_—ch_domaš
 ( 
d
 )

1269 iàĞ!
	`is_hvm_domaš
(
d
) )

1271 
	`´štk
("\n>>> Domaš %d <<<\n", 
d
->
domaš_id
);

1272 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1274 
	`´štk
("\tVCPU %d\n", 
v
->
vıu_id
);

1275 
	`vmcs_dump_vıu
(
v
);

1279 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1281 
	`´štk
("**************************************\n");

1282 
	}
}

1284 
keyhªdËr
 
	gvmcs_dump_keyhªdËr
 = {

1285 .
dŸgno¡ic
 = 1,

1286 .
	gu
.
	gâ
 = 
vmcs_dump
,

1287 .
	gdesc
 = "dump Intel's VMCS"

1290 
	$£tup_vmcs_dump
()

1292 
	`»gi¡”_keyhªdËr
('v', &
vmcs_dump_keyhªdËr
);

1293 
	}
}

	@hvm/vmx/vmx.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/lib.h
>

22 
	~<x’/Œaû.h
>

23 
	~<x’/sched.h
>

24 
	~<x’/œq.h
>

25 
	~<x’/soáœq.h
>

26 
	~<x’/domaš_·ge.h
>

27 
	~<x’/hy³rÿÎ.h
>

28 
	~<x’/³rfc.h
>

29 
	~<asm/cu¼’t.h
>

30 
	~<asm/io.h
>

31 
	~<asm/»gs.h
>

32 
	~<asm/ıuã©u».h
>

33 
	~<asm/´oûssÜ.h
>

34 
	~<asm/ty³s.h
>

35 
	~<asm/debug»g.h
>

36 
	~<asm/m¤.h
>

37 
	~<asm/¥šlock.h
>

38 
	~<asm/·gšg.h
>

39 
	~<asm/p2m.h
>

40 
	~<asm/mem_sh¬šg.h
>

41 
	~<asm/hvm/emuÏ‹.h
>

42 
	~<asm/hvm/hvm.h
>

43 
	~<asm/hvm/suµÜt.h
>

44 
	~<asm/hvm/vmx/vmx.h
>

45 
	~<asm/hvm/vmx/vmcs.h
>

46 
	~<public/sched.h
>

47 
	~<public/hvm/iÜeq.h
>

48 
	~<asm/hvm/vpic.h
>

49 
	~<asm/hvm/vÏpic.h
>

50 
	~<asm/x86_emuÏ‹.h
>

51 
	~<asm/hvm/v±.h
>

52 
	~<public/hvm/§ve.h
>

53 
	~<asm/hvm/Œaû.h
>

54 
	~<asm/x’İrof.h
>

55 
	~<asm/debugg”.h
>

56 
	~<asm/­ic.h
>

58 
	ehªdËr_»tuº
 { 
	mHNDL_dÚe
, 
	mHNDL_unhªdËd
, 
	mHNDL_exû±iÚ_¿i£d
 };

60 
vmx_ùxt_sw™ch_äom
(
vıu
 *
v
);

61 
vmx_ùxt_sw™ch_to
(
vıu
 *
v
);

63 
vmx_®loc_vÏpic_m­pšg
(
domaš
 *
d
);

64 
vmx_ä“_vÏpic_m­pšg
(
domaš
 *
d
);

65 
vmx_š¡®l_vÏpic_m­pšg
(
vıu
 *
v
);

66 
vmx_upd©e_gue¡_ü
(
vıu
 *
v
, 
ü
);

67 
vmx_upd©e_gue¡_eãr
(
vıu
 *
v
);

68 
vmx_ıuid_š‹rû±
(

69 *
—x
, *
ebx
,

70 *
ecx
, *
edx
);

71 
vmx_wbšvd_š‹rû±
();

72 
vmx_åu_dœty_š‹rû±
();

73 
vmx_m¤_»ad_š‹rû±
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
);

74 
vmx_m¤_wr™e_š‹rû±
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
);

75 
vmx_švÍg_š‹rû±
(
vaddr
);

76 
__•t_sync_domaš
(*
šfo
);

78 
	$vmx_domaš_š™Ÿli£
(
domaš
 *
d
)

80 
rc
;

83 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_cÚŒŞ
.
•t_mt
 = 
EPT_DEFAULT_MT
;

86 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_cÚŒŞ
.
•t_wl
 = 3;

88 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_cÚŒŞ
.
a¤
 =

89 
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
d
)));

91 iàĞ(
rc
 = 
	`vmx_®loc_vÏpic_m­pšg
(
d
)) != 0 )

92  
rc
;

95 
	}
}

97 
	$vmx_domaš_de¡roy
(
domaš
 *
d
)

99 iàĞ
	`·gšg_mode_h­
(
d
) )

100 
	`Ú_—ch_ıu
(
__•t_sync_domaš
, 
d
, 1);

101 
	`vmx_ä“_vÏpic_m­pšg
(
d
);

102 
	}
}

104 
	$vmx_vıu_š™Ÿli£
(
vıu
 *
v
)

106 
rc
;

108 
	`¥š_lock_š™
(&
v
->
¬ch
.
hvm_vmx
.
vmcs_lock
);

110 
v
->
¬ch
.
scheduË_
 = 
vmx_do_»sume
;

111 
v
->
¬ch
.
ùxt_sw™ch_äom
 = 
vmx_ùxt_sw™ch_äom
;

112 
v
->
¬ch
.
ùxt_sw™ch_to
 = 
vmx_ùxt_sw™ch_to
;

114 iàĞ(
rc
 = 
	`vmx_ü—‹_vmcs
(
v
)) != 0 )

116 
	`d´štk
(
XENLOG_WARNING
,

118 
v
->
vıu_id
, 
rc
);

119  
rc
;

122 
	`vpmu_š™Ÿli£
(
v
);

124 
	`vmx_š¡®l_vÏpic_m­pšg
(
v
);

127 iàĞ
v
->
vıu_id
 == 0 )

128 
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
—x
 = 1;

131 
	}
}

133 
	$vmx_vıu_de¡roy
(
vıu
 *
v
)

135 
	`vmx_de¡roy_vmcs
(
v
);

136 
	`vpmu_de¡roy
(
v
);

137 
	`·ssive_domaš_de¡roy
(
v
);

138 
	}
}

140 #ifdeà
__x86_64__


142 
DEFINE_PER_CPU
(
vmx_m¤_¡©e
, 
ho¡_m¤_¡©e
);

144 
u32
 
	gm¤_šdex
[] =

146 
MSR_LSTAR
, 
MSR_STAR
, 
MSR_SYSCALL_MASK


149 
	#MSR_INDEX_SIZE
 (
	`ARRAY_SIZE
(
m¤_šdex
))

	)

151 
	$vmx_§ve_ho¡_m¤s
()

153 
vmx_m¤_¡©e
 *
ho¡_m¤_¡©e
 = &
	`this_ıu
(host_msr_state);

154 
i
;

156  
i
 = 0; i < 
MSR_INDEX_SIZE
; i++ )

157 
	`rdm¤l
(
m¤_šdex
[
i
], 
ho¡_m¤_¡©e
->
m¤s
[i]);

158 
	}
}

160 
	#WRITE_MSR
(
add»ss
) \

161 
gue¡_m¤_¡©e
->
m¤s
[
VMX_INDEX_MSR_
 ## 
add»ss
] = 
m¤_cÚ‹Á
; \

162 
	`£t_b™
(
VMX_INDEX_MSR_
 ## 
add»ss
, &
gue¡_m¤_¡©e
->
æags
); \

163 
	`wrm¤l
(
MSR_
 ## 
add»ss
, 
m¤_cÚ‹Á
); \

164 
	`£t_b™
(
VMX_INDEX_MSR_
 ## 
add»ss
, &
ho¡_m¤_¡©e
->
æags
); \

165 

	)

167 
hªdËr_»tuº


168 
	$lÚg_mode_do_m¤_»ad
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

170 
vıu
 *
v
 = 
cu¼’t
;

171 
vmx_m¤_¡©e
 *
gue¡_m¤_¡©e
 = &
v
->
¬ch
.
hvm_vmx
.
m¤_¡©e
;

173  
m¤
 )

175 
MSR_FS_BASE
:

176 *
m¤_cÚ‹Á
 = 
	`__vm»ad
(
GUEST_FS_BASE
);

179 
MSR_GS_BASE
:

180 *
m¤_cÚ‹Á
 = 
	`__vm»ad
(
GUEST_GS_BASE
);

183 
MSR_SHADOW_GS_BASE
:

184 
	`rdm¤l
(
MSR_SHADOW_GS_BASE
, *
m¤_cÚ‹Á
);

187 
MSR_STAR
:

188 *
m¤_cÚ‹Á
 = 
gue¡_m¤_¡©e
->
m¤s
[
VMX_INDEX_MSR_STAR
];

191 
MSR_LSTAR
:

192 *
m¤_cÚ‹Á
 = 
gue¡_m¤_¡©e
->
m¤s
[
VMX_INDEX_MSR_LSTAR
];

195 
MSR_CSTAR
:

196 *
m¤_cÚ‹Á
 = 
v
->
¬ch
.
hvm_vmx
.
c¡¬
;

199 
MSR_SYSCALL_MASK
:

200 *
m¤_cÚ‹Á
 = 
gue¡_m¤_¡©e
->
m¤s
[
VMX_INDEX_MSR_SYSCALL_MASK
];

204  
HNDL_unhªdËd
;

207 
	`HVM_DBG_LOG
(
DBG_LEVEL_0
, "m¤ 0x%x cÚ‹Á 0x%"
PRIx64
, 
m¤
, *
m¤_cÚ‹Á
);

209  
HNDL_dÚe
;

210 
	}
}

212 
hªdËr_»tuº


213 
	$lÚg_mode_do_m¤_wr™e
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

215 
vıu
 *
v
 = 
cu¼’t
;

216 
vmx_m¤_¡©e
 *
gue¡_m¤_¡©e
 = &
v
->
¬ch
.
hvm_vmx
.
m¤_¡©e
;

217 
vmx_m¤_¡©e
 *
ho¡_m¤_¡©e
 = &
	`this_ıu
(host_msr_state);

219 
	`HVM_DBG_LOG
(
DBG_LEVEL_0
, "m¤ 0x%x cÚ‹Á 0x%"
PRIx64
, 
m¤
, 
m¤_cÚ‹Á
);

221  
m¤
 )

223 
MSR_FS_BASE
:

224 
MSR_GS_BASE
:

225 
MSR_SHADOW_GS_BASE
:

226 iàĞ!
	`is_ÿnÚiÿl_add»ss
(
m¤_cÚ‹Á
) )

227 
unÿnÚiÿl_add»ss
;

229 iàĞ
m¤
 =ğ
MSR_FS_BASE
 )

230 
	`__vmwr™e
(
GUEST_FS_BASE
, 
m¤_cÚ‹Á
);

231 iàĞ
m¤
 =ğ
MSR_GS_BASE
 )

232 
	`__vmwr™e
(
GUEST_GS_BASE
, 
m¤_cÚ‹Á
);

234 
	`wrm¤l
(
MSR_SHADOW_GS_BASE
, 
m¤_cÚ‹Á
);

238 
MSR_STAR
:

239 
	`WRITE_MSR
(
STAR
);

241 
MSR_LSTAR
:

242 iàĞ!
	`is_ÿnÚiÿl_add»ss
(
m¤_cÚ‹Á
) )

243 
unÿnÚiÿl_add»ss
;

244 
	`WRITE_MSR
(
LSTAR
);

246 
MSR_CSTAR
:

247 iàĞ!
	`is_ÿnÚiÿl_add»ss
(
m¤_cÚ‹Á
) )

248 
unÿnÚiÿl_add»ss
;

249 
v
->
¬ch
.
hvm_vmx
.
c¡¬
 = 
m¤_cÚ‹Á
;

252 
MSR_SYSCALL_MASK
:

253 
	`WRITE_MSR
(
SYSCALL_MASK
);

256  
HNDL_unhªdËd
;

259  
HNDL_dÚe
;

261 
unÿnÚiÿl_add»ss
:

262 
	`HVM_DBG_LOG
(
DBG_LEVEL_0
, "NÙ cªØadd»s oàm¤ wr™%x", 
m¤
);

263 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

264  
HNDL_exû±iÚ_¿i£d
;

265 
	}
}

273 
	$vmx_»¡Üe_ho¡_m¤s
()

275 
vmx_m¤_¡©e
 *
ho¡_m¤_¡©e
 = &
	`this_ıu
(host_msr_state);

276 
i
;

278  
ho¡_m¤_¡©e
->
æags
 )

280 
i
 = 
	`fšd_fœ¡_£t_b™
(
ho¡_m¤_¡©e
->
æags
);

281 
	`wrm¤l
(
m¤_šdex
[
i
], 
ho¡_m¤_¡©e
->
m¤s
[i]);

282 
	`ş—r_b™
(
i
, &
ho¡_m¤_¡©e
->
æags
);

284 
	}
}

286 
	$vmx_§ve_gue¡_m¤s
(
vıu
 *
v
)

292 
	`rdm¤l
(
MSR_SHADOW_GS_BASE
, 
v
->
¬ch
.
hvm_vmx
.
shadow_gs
);

293 
	}
}

295 
	$vmx_»¡Üe_gue¡_m¤s
(
vıu
 *
v
)

297 
vmx_m¤_¡©e
 *
gue¡_m¤_¡©e
, *
ho¡_m¤_¡©e
;

298 
gue¡_æags
;

299 
i
;

301 
gue¡_m¤_¡©e
 = &
v
->
¬ch
.
hvm_vmx
.
m¤_¡©e
;

302 
ho¡_m¤_¡©e
 = &
	`this_ıu
(host_msr_state);

304 
	`wrm¤l
(
MSR_SHADOW_GS_BASE
, 
v
->
¬ch
.
hvm_vmx
.
shadow_gs
);

306 
gue¡_æags
 = 
gue¡_m¤_¡©e
->
æags
;

308  
gue¡_æags
 )

310 
i
 = 
	`fšd_fœ¡_£t_b™
(
gue¡_æags
);

312 
	`HVM_DBG_LOG
(
DBG_LEVEL_2
,

314 
i
, 
m¤_šdex
[i], 
gue¡_m¤_¡©e
->
m¤s
[i]);

315 
	`£t_b™
(
i
, &
ho¡_m¤_¡©e
->
æags
);

316 
	`wrm¤l
(
m¤_šdex
[
i
], 
gue¡_m¤_¡©e
->
m¤s
[i]);

317 
	`ş—r_b™
(
i
, &
gue¡_æags
);

320 iàĞ(
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 ^ 
	`»ad_eãr
()è& 
EFER_SCE
 )

322 
	`HVM_DBG_LOG
(
DBG_LEVEL_2
,

324 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
);

325 
	`wr™e_eãr
((
	`»ad_eãr
(è& ~
EFER_SCE
) |

326 (
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_SCE
));

329 iàĞ
ıu_has_rdtsı
 )

330 
	`wrm¤l
(
MSR_TSC_AUX
, 
	`hvm_m¤_tsc_aux
(
v
));

331 
	}
}

335 
	$vmx_§ve_ho¡_m¤s
(è{
	}
}

336 
	#vmx_»¡Üe_ho¡_m¤s
(è(()0)

	)

338 
	#vmx_§ve_gue¡_m¤s
(
v
è(()0)

	)

339 
	#vmx_»¡Üe_gue¡_m¤s
(
v
è(()0)

	)

341 
hªdËr_»tuº


342 
	$lÚg_mode_do_m¤_»ad
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

344  
HNDL_unhªdËd
;

345 
	}
}

347 
hªdËr_»tuº


348 
	$lÚg_mode_do_m¤_wr™e
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

350  
HNDL_unhªdËd
;

351 
	}
}

355 
	$vmx_upd©e_ıu_exec_cÚŒŞ
(
vıu
 *
v
)

357 
	`__vmwr™e
(
CPU_BASED_VM_EXEC_CONTROL
, 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
);

358 
	}
}

360 
	$vmx_upd©e_£cÚd¬y_exec_cÚŒŞ
(
vıu
 *
v
)

362 
	`__vmwr™e
(
SECONDARY_VM_EXEC_CONTROL
,

363 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
);

364 
	}
}

366 
	$vmx_upd©e_exû±iÚ_b™m­
(
vıu
 *
v
)

368 
	`__vmwr™e
(
EXCEPTION_BITMAP
, 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
);

369 
	}
}

371 
	$vmx_gue¡_x86_mode
(
vıu
 *
v
)

373 
cs_¬_by‹s
;

375 iàĞ
	`uÆik–y
(!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
)) )

377 iàĞ
	`uÆik–y
(
	`gue¡_ıu_u£r_»gs
()->
eæags
 & 
X86_EFLAGS_VM
) )

379 
cs_¬_by‹s
 = 
	`__vm»ad
(
GUEST_CS_AR_BYTES
);

380 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) &&

381 
	`lik–y
(
cs_¬_by‹s
 & 
X86_SEG_AR_CS_LM_ACTIVE
) )

383  (
	`lik–y
(
cs_¬_by‹s
 & 
X86_SEG_AR_DEF_OP_SIZE
) ? 4 : 2);

384 
	}
}

386 
	$vmx_§ve_dr
(
vıu
 *
v
)

388 iàĞ!
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 )

392 
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 = 0;

393 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
CPU_BASED_MOV_DR_EXITING
;

394 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

396 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0] = 
	`»ad_debug»g
(0);

397 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1] = 
	`»ad_debug»g
(1);

398 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2] = 
	`»ad_debug»g
(2);

399 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3] = 
	`»ad_debug»g
(3);

400 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6] = 
	`»ad_debug»g
(6);

402 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] = 
	`__vm»ad
(
GUEST_DR7
);

403 
	}
}

405 
	$__»¡Üe_debug_»gi¡”s
(
vıu
 *
v
)

407 iàĞ
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 )

410 
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 = 1;

412 
	`wr™e_debug»g
(0, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0]);

413 
	`wr™e_debug»g
(1, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1]);

414 
	`wr™e_debug»g
(2, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2]);

415 
	`wr™e_debug»g
(3, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3]);

416 
	`wr™e_debug»g
(6, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6]);

418 
	}
}

426 
	$vmx_»¡Üe_dr
(
vıu
 *
v
)

429 iàĞ
	`uÆik–y
(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] & 
DR7_ACTIVE_MASK
) )

430 
	`__»¡Üe_debug_»gi¡”s
(
v
);

431 
	}
}

433 
	$vmx_vmcs_§ve
(
vıu
 *
v
, 
hvm_hw_ıu
 *
c
)

435 
ušt32_t
 
ev
;

437 
	`vmx_vmcs_’‹r
(
v
);

439 
c
->
ü0
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

440 
c
->
ü2
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2];

441 
c
->
ü3
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

442 
c
->
ü4
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

444 
c
->
m¤_eãr
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
;

446 
c
->
sy£Á”_cs
 = 
	`__vm»ad
(
GUEST_SYSENTER_CS
);

447 
c
->
sy£Á”_e¥
 = 
	`__vm»ad
(
GUEST_SYSENTER_ESP
);

448 
c
->
sy£Á”_e
 = 
	`__vm»ad
(
GUEST_SYSENTER_EIP
);

450 
c
->
³ndšg_ev’t
 = 0;

451 
c
->
”rÜ_code
 = 0;

452 iàĞ((
ev
 = 
	`__vm»ad
(
VM_ENTRY_INTR_INFO
)è& 
INTR_INFO_VALID_MASK
) &&

453 
	`hvm_ev’t_Ãeds_»šjeùiÚ
((
ev
 >> 8) & 7,ƒv & 0xff) )

455 
c
->
³ndšg_ev’t
 = 
ev
;

456 
c
->
”rÜ_code
 = 
	`__vm»ad
(
VM_ENTRY_EXCEPTION_ERROR_CODE
);

459 
	`vmx_vmcs_ex™
(
v
);

460 
	}
}

462 
	$vmx_»¡Üe_ü0_ü3
(

463 
vıu
 *
v
, 
ü0
, 
ü3
)

465 
mâ
 = 0;

466 
p2m_ty³_t
 
p2mt
;

468 iàĞ
	`·gšg_mode_shadow
(
v
->
domaš
) )

470 iàĞ
ü0
 & 
X86_CR0_PG
 )

472 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
),

473 
ü3
 >> 
PAGE_SHIFT
, &
p2mt
));

474 iàĞ!
	`p2m_is_¿m
(
p2mt
è|| !
	`g‘_·ge
(
	`mâ_to_·ge
(
mâ
), 
v
->
domaš
) )

476 
	`gd´štk
(
XENLOG_ERR
, "Inv®id CR3 v®ue=0x%lx\n", 
ü3
);

477  -
EINVAL
;

481 iàĞ
	`hvm_·gšg_’abËd
(
v
) )

482 
	`put_·ge
(
	`·g‘abË_g‘_·ge
(
v
->
¬ch
.
gue¡_bË
));

484 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
mâ
);

487 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] = 
ü0
 | 
X86_CR0_ET
;

488 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = 
ü3
;

491 
	}
}

493 
	$vmx_vmcs_»¡Üe
(
vıu
 *
v
, 
hvm_hw_ıu
 *
c
)

495 
rc
;

497 iàĞ
c
->
³ndšg_v®id
 &&

498 ((
c
->
³ndšg_ty³
 == 1) || (c->pending_type > 6) ||

499 (
c
->
³ndšg_»£rved
 != 0)) )

501 
	`gd´štk
(
XENLOG_ERR
, "Inv®id…’dšgƒv’ˆ0x%"
PRIx32
".\n",

502 
c
->
³ndšg_ev’t
);

503  -
EINVAL
;

506 
rc
 = 
	`vmx_»¡Üe_ü0_ü3
(
v
, 
c
->
ü0
, c->
ü3
);

507 iàĞ
rc
 )

508  
rc
;

510 
	`vmx_vmcs_’‹r
(
v
);

512 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
c
->
ü2
;

513 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] = 
c
->
ü4
;

514 
	`vmx_upd©e_gue¡_ü
(
v
, 0);

515 
	`vmx_upd©e_gue¡_ü
(
v
, 2);

516 
	`vmx_upd©e_gue¡_ü
(
v
, 4);

518 
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 = 
c
->
m¤_eãr
;

519 
	`vmx_upd©e_gue¡_eãr
(
v
);

521 
	`__vmwr™e
(
GUEST_SYSENTER_CS
, 
c
->
sy£Á”_cs
);

522 
	`__vmwr™e
(
GUEST_SYSENTER_ESP
, 
c
->
sy£Á”_e¥
);

523 
	`__vmwr™e
(
GUEST_SYSENTER_EIP
, 
c
->
sy£Á”_e
);

525 
	`__vmwr™e
(
GUEST_DR7
, 
c
->
dr7
);

527 
	`vmx_vmcs_ex™
(
v
);

529 
	`·gšg_upd©e_·gšg_modes
(
v
);

531 iàĞ
c
->
³ndšg_v®id
 )

533 
	`gd´štk
(
XENLOG_INFO
, "Re-šjeùšg 0x%"
PRIx32
", 0x%"PRIx32"\n",

534 
c
->
³ndšg_ev’t
, c->
”rÜ_code
);

536 iàĞ
	`hvm_ev’t_Ãeds_»šjeùiÚ
(
c
->
³ndšg_ty³
, c->
³ndšg_veùÜ
) )

538 
	`vmx_vmcs_’‹r
(
v
);

539 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 
c
->
³ndšg_ev’t
);

540 
	`__vmwr™e
(
VM_ENTRY_EXCEPTION_ERROR_CODE
, 
c
->
”rÜ_code
);

541 
	`vmx_vmcs_ex™
(
v
);

546 
	}
}

548 
	$vmx_§ve_ıu_¡©e
(
vıu
 *
v
, 
hvm_hw_ıu
 *
d©a
)

550 #ifdeà
__x86_64__


551 
vmx_m¤_¡©e
 *
gue¡_¡©e
 = &
v
->
¬ch
.
hvm_vmx
.
m¤_¡©e
;

552 
gue¡_æags
 = 
gue¡_¡©e
->
æags
;

554 
d©a
->
shadow_gs
 = 
v
->
¬ch
.
hvm_vmx
.shadow_gs;

555 
d©a
->
m¤_c¡¬
 = 
v
->
¬ch
.
hvm_vmx
.
c¡¬
;

558 
d©a
->
m¤_æags
 = 
gue¡_æags
;

559 
d©a
->
m¤_l¡¬
 = 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_LSTAR
];

560 
d©a
->
m¤_¡¬
 = 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_STAR
];

561 
d©a
->
m¤_sysÿÎ_mask
 = 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_SYSCALL_MASK
];

564 
d©a
->
tsc
 = 
	`hvm_g‘_gue¡_tsc
(
v
);

565 
	}
}

567 
	$vmx_lßd_ıu_¡©e
(
vıu
 *
v
, 
hvm_hw_ıu
 *
d©a
)

569 #ifdeà
__x86_64__


570 
vmx_m¤_¡©e
 *
gue¡_¡©e
 = &
v
->
¬ch
.
hvm_vmx
.
m¤_¡©e
;

573 
gue¡_¡©e
->
æags
 = 
d©a
->
m¤_æags
 & 7;

574 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_LSTAR
] = 
d©a
->
m¤_l¡¬
;

575 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_STAR
] = 
d©a
->
m¤_¡¬
;

576 
gue¡_¡©e
->
m¤s
[
VMX_INDEX_MSR_SYSCALL_MASK
] = 
d©a
->
m¤_sysÿÎ_mask
;

578 
v
->
¬ch
.
hvm_vmx
.
c¡¬
 = 
d©a
->
m¤_c¡¬
;

579 
v
->
¬ch
.
hvm_vmx
.
shadow_gs
 = 
d©a
->shadow_gs;

582 
	`hvm_£t_gue¡_tsc
(
v
, 
d©a
->
tsc
);

583 
	}
}

586 
	$vmx_§ve_vmcs_ùxt
(
vıu
 *
v
, 
hvm_hw_ıu
 *
ùxt
)

588 
	`vmx_§ve_ıu_¡©e
(
v
, 
ùxt
);

589 
	`vmx_vmcs_§ve
(
v
, 
ùxt
);

590 
	}
}

592 
	$vmx_lßd_vmcs_ùxt
(
vıu
 *
v
, 
hvm_hw_ıu
 *
ùxt
)

594 
	`vmx_lßd_ıu_¡©e
(
v
, 
ùxt
);

596 iàĞ
	`vmx_vmcs_»¡Üe
(
v
, 
ùxt
) )

598 
	`gd´štk
(
XENLOG_ERR
, "vmx_vmcs„estore failed!\n");

599 
	`domaš_üash
(
v
->
domaš
);

600  -
EINVAL
;

604 
	}
}

606 
	$vmx_åu_’‹r
(
vıu
 *
v
)

608 
	`£tup_åu
(
v
);

609 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 &ğ~(1u << 
TRAP_no_deviû
);

610 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

611 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
 &ğ~
X86_CR0_TS
;

612 
	`__vmwr™e
(
HOST_CR0
, 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
);

613 
	}
}

615 
	$vmx_åu_Ëave
(
vıu
 *
v
)

617 
	`ASSERT
(!
v
->
åu_dœt›d
);

618 
	`ASSERT
(
	`»ad_ü0
(è& 
X86_CR0_TS
);

620 iàĞ!(
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
 & 
X86_CR0_TS
) )

622 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
 |ğ
X86_CR0_TS
;

623 
	`__vmwr™e
(
HOST_CR0
, 
v
->
¬ch
.
hvm_vmx
.
ho¡_ü0
);

632 iàĞ!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

634 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[0] |ğ
X86_CR0_TS
;

635 
	`__vmwr™e
(
GUEST_CR0
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[0]);

636 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 |ğ(1u << 
TRAP_no_deviû
);

637 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

639 
	}
}

641 
	$vmx_ùxt_sw™ch_äom
(
vıu
 *
v
)

643 
	`vmx_åu_Ëave
(
v
);

644 
	`vmx_§ve_gue¡_m¤s
(
v
);

645 
	`vmx_»¡Üe_ho¡_m¤s
();

646 
	`vmx_§ve_dr
(
v
);

647 
	`vpmu_§ve
(
v
);

648 
	}
}

650 
	$vmx_ùxt_sw™ch_to
(
vıu
 *
v
)

652 
domaš
 *
d
 = 
v
->domain;

653 
Şd_ü4
 = 
	`»ad_ü4
(), 
Ãw_ü4
 = 
mmu_ü4_ã©u»s
;

656 iàĞ
Şd_ü4
 !ğ
Ãw_ü4
 )

657 
	`wr™e_ü4
(
Ãw_ü4
);

659 iàĞ
	`·gšg_mode_h­
(
d
) )

661 
ıu
 = 
	`smp_´oûssÜ_id
();

663 iàĞ!
	`ıu_is£t
(
ıu
, 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_synûd
) &&

664 !
	`ıu_‹¡_ªd_£t
(
ıu
, 
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_synûd
) )

665 
	`__šv•t
(
INVEPT_SINGLE_CONTEXT
, 
	`•t_g‘_•
(
d
), 0);

668 
	`vmx_»¡Üe_gue¡_m¤s
(
v
);

669 
	`vmx_»¡Üe_dr
(
v
);

670 
	`vpmu_lßd
(
v
);

671 
	}
}

680 
	#rm_cs_©Œ
 (((
£gm’t_©Œibu‹s
) { \

681 .
f›lds
 = { .
ty³
 = 0xb, .
s
 = 1, .
d¶
 = 0, .
p
 = 1, .
avl
 = 0, \

682 .
l
 = 0, .
db
 = 0, .
g
 = 0, .
·d
 = 0 } }).
by‹s
)

	)

683 
	#rm_ds_©Œ
 (((
£gm’t_©Œibu‹s
) { \

684 .
f›lds
 = { .
ty³
 = 0x3, .
s
 = 1, .
d¶
 = 0, .
p
 = 1, .
avl
 = 0, \

685 .
l
 = 0, .
db
 = 0, .
g
 = 0, .
·d
 = 0 } }).
by‹s
)

	)

686 
	#vm86_ds_©Œ
 (((
£gm’t_©Œibu‹s
) { \

687 .
f›lds
 = { .
ty³
 = 0x3, .
s
 = 1, .
d¶
 = 3, .
p
 = 1, .
avl
 = 0, \

688 .
l
 = 0, .
db
 = 0, .
g
 = 0, .
·d
 = 0 } }).
by‹s
)

	)

689 
	#vm86_Œ_©Œ
 (((
£gm’t_©Œibu‹s
) { \

690 .
f›lds
 = { .
ty³
 = 0xb, .
s
 = 0, .
d¶
 = 0, .
p
 = 1, .
avl
 = 0, \

691 .
l
 = 0, .
db
 = 0, .
g
 = 0, .
·d
 = 0 } }).
by‹s
)

	)

693 
	$vmx_g‘_£gm’t_»gi¡”
(
vıu
 *
v
, 
x86_£gm’t
 
£g
,

694 
£gm’t_»gi¡”
 *
»g
)

696 
ušt32_t
 
©Œ
 = 0;

698 
	`vmx_vmcs_’‹r
(
v
);

700  
£g
 )

702 
x86_£g_cs
:

703 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_CS_SELECTOR
);

704 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_CS_LIMIT
);

705 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_CS_BASE
);

706 
©Œ
 = 
	`__vm»ad
(
GUEST_CS_AR_BYTES
);

708 
x86_£g_ds
:

709 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_DS_SELECTOR
);

710 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_DS_LIMIT
);

711 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_DS_BASE
);

712 
©Œ
 = 
	`__vm»ad
(
GUEST_DS_AR_BYTES
);

714 
x86_£g_es
:

715 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_ES_SELECTOR
);

716 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_ES_LIMIT
);

717 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_ES_BASE
);

718 
©Œ
 = 
	`__vm»ad
(
GUEST_ES_AR_BYTES
);

720 
x86_£g_fs
:

721 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_FS_SELECTOR
);

722 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_FS_LIMIT
);

723 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_FS_BASE
);

724 
©Œ
 = 
	`__vm»ad
(
GUEST_FS_AR_BYTES
);

726 
x86_£g_gs
:

727 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_GS_SELECTOR
);

728 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_GS_LIMIT
);

729 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_GS_BASE
);

730 
©Œ
 = 
	`__vm»ad
(
GUEST_GS_AR_BYTES
);

732 
x86_£g_ss
:

733 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_SS_SELECTOR
);

734 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_SS_LIMIT
);

735 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_SS_BASE
);

736 
©Œ
 = 
	`__vm»ad
(
GUEST_SS_AR_BYTES
);

738 
x86_£g_Œ
:

739 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_TR_SELECTOR
);

740 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_TR_LIMIT
);

741 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_TR_BASE
);

742 
©Œ
 = 
	`__vm»ad
(
GUEST_TR_AR_BYTES
);

744 
x86_£g_gdŒ
:

745 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_GDTR_LIMIT
);

746 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_GDTR_BASE
);

748 
x86_£g_idŒ
:

749 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_IDTR_LIMIT
);

750 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_IDTR_BASE
);

752 
x86_£g_ldŒ
:

753 
»g
->
£l
 = 
	`__vm»ad
(
GUEST_LDTR_SELECTOR
);

754 
»g
->
lim™
 = 
	`__vm»ad
(
GUEST_LDTR_LIMIT
);

755 
»g
->
ba£
 = 
	`__vm»ad
(
GUEST_LDTR_BASE
);

756 
©Œ
 = 
	`__vm»ad
(
GUEST_LDTR_AR_BYTES
);

759 
	`BUG
();

762 
	`vmx_vmcs_ex™
(
v
);

764 
»g
->
©Œ
.
by‹s
 = (attr & 0xff) | ((attr >> 4) & 0xf00);

766 iàĞ
©Œ
 & (1u<<16) )

767 
»g
->
©Œ
.
f›lds
.
p
 = 0;

770 iàĞ
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 && 
£g
 <ğ
x86_£g_Œ


771 && !(
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 & (1u << 
£g
)) )

773 
£gm’t_»gi¡”
 *
¤eg
 = &
v
->
¬ch
.
hvm_vmx
.
vm86_§ved_£g
[
£g
];

774 iàĞ
£g
 =ğ
x86_£g_Œ
 )

775 *
»g
 = *
¤eg
;

776 iàĞ
»g
->
ba£
 !ğ
¤eg
->ba£ || 
£g
 =ğ
x86_£g_ss
 )

785 
»g
->
©Œ
.
by‹s
 = (
£g
 =ğ
x86_£g_cs
 ? 
rm_cs_©Œ
 : 
rm_ds_©Œ
);

786 *
¤eg
 = *
»g
;

792 *
»g
 = *
¤eg
;

793 
»g
->
£l
 =„eg->
ba£
 >> 4;

796 
	}
}

798 
	$vmx_£t_£gm’t_»gi¡”
(
vıu
 *
v
, 
x86_£gm’t
 
£g
,

799 
£gm’t_»gi¡”
 *
»g
)

801 
ušt32_t
 
©Œ
, 
£l
, 
lim™
;

802 
ušt64_t
 
ba£
;

804 
£l
 = 
»g
->sel;

805 
©Œ
 = 
»g
->©Œ.
by‹s
;

806 
lim™
 = 
»g
->limit;

807 
ba£
 = 
»g
->base;

810 iàĞ
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 && 
£g
 <ğ
x86_£g_Œ
 )

813 
v
->
¬ch
.
hvm_vmx
.
vm86_§ved_£g
[
£g
] = *
»g
;

815 iàĞ
£g
 =ğ
x86_£g_Œ
 )

817 iàĞ
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_VM86_TSS
] )

819 
£l
 = 0;

820 
©Œ
 = 
vm86_Œ_©Œ
;

821 
lim™
 = 0xff;

822 
ba£
 = 
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_VM86_TSS
];

823 
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 &ğ~(1u << 
£g
);

826 
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 |ğ(1u << 
£g
);

834 iàĞ
ba£
 < 0x100000 && !(ba£ & 0xfè&& 
lim™
 >= 0xffff

835 && 
»g
->
©Œ
.
f›lds
.
p
 )

837 
£l
 = 
ba£
 >> 4;

838 
©Œ
 = 
vm86_ds_©Œ
;

839 
lim™
 = 0xffff;

840 
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 &ğ~(1u << 
£g
);

843 
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 |ğ(1u << 
£g
);

847 
©Œ
 = ((attr & 0xf00) << 4) | (attr & 0xff);

850 iàĞ!
»g
->
©Œ
.
f›lds
.
p
 )

851 
©Œ
 |= (1u << 16);

854 
©Œ
 |ğ!!(
lim™
 >> 20) << 15;

856 
	`vmx_vmcs_’‹r
(
v
);

858  
£g
 )

860 
x86_£g_cs
:

861 
	`__vmwr™e
(
GUEST_CS_SELECTOR
, 
£l
);

862 
	`__vmwr™e
(
GUEST_CS_LIMIT
, 
lim™
);

863 
	`__vmwr™e
(
GUEST_CS_BASE
, 
ba£
);

864 
	`__vmwr™e
(
GUEST_CS_AR_BYTES
, 
©Œ
);

866 
x86_£g_ds
:

867 
	`__vmwr™e
(
GUEST_DS_SELECTOR
, 
£l
);

868 
	`__vmwr™e
(
GUEST_DS_LIMIT
, 
lim™
);

869 
	`__vmwr™e
(
GUEST_DS_BASE
, 
ba£
);

870 
	`__vmwr™e
(
GUEST_DS_AR_BYTES
, 
©Œ
);

872 
x86_£g_es
:

873 
	`__vmwr™e
(
GUEST_ES_SELECTOR
, 
£l
);

874 
	`__vmwr™e
(
GUEST_ES_LIMIT
, 
lim™
);

875 
	`__vmwr™e
(
GUEST_ES_BASE
, 
ba£
);

876 
	`__vmwr™e
(
GUEST_ES_AR_BYTES
, 
©Œ
);

878 
x86_£g_fs
:

879 
	`__vmwr™e
(
GUEST_FS_SELECTOR
, 
£l
);

880 
	`__vmwr™e
(
GUEST_FS_LIMIT
, 
lim™
);

881 
	`__vmwr™e
(
GUEST_FS_BASE
, 
ba£
);

882 
	`__vmwr™e
(
GUEST_FS_AR_BYTES
, 
©Œ
);

884 
x86_£g_gs
:

885 
	`__vmwr™e
(
GUEST_GS_SELECTOR
, 
£l
);

886 
	`__vmwr™e
(
GUEST_GS_LIMIT
, 
lim™
);

887 
	`__vmwr™e
(
GUEST_GS_BASE
, 
ba£
);

888 
	`__vmwr™e
(
GUEST_GS_AR_BYTES
, 
©Œ
);

890 
x86_£g_ss
:

891 
	`__vmwr™e
(
GUEST_SS_SELECTOR
, 
£l
);

892 
	`__vmwr™e
(
GUEST_SS_LIMIT
, 
lim™
);

893 
	`__vmwr™e
(
GUEST_SS_BASE
, 
ba£
);

894 
	`__vmwr™e
(
GUEST_SS_AR_BYTES
, 
©Œ
);

896 
x86_£g_Œ
:

897 
	`__vmwr™e
(
GUEST_TR_SELECTOR
, 
£l
);

898 
	`__vmwr™e
(
GUEST_TR_LIMIT
, 
lim™
);

899 
	`__vmwr™e
(
GUEST_TR_BASE
, 
ba£
);

901 
	`__vmwr™e
(
GUEST_TR_AR_BYTES
, 
©Œ
 | 2);

903 
x86_£g_gdŒ
:

904 
	`__vmwr™e
(
GUEST_GDTR_LIMIT
, 
lim™
);

905 
	`__vmwr™e
(
GUEST_GDTR_BASE
, 
ba£
);

907 
x86_£g_idŒ
:

908 
	`__vmwr™e
(
GUEST_IDTR_LIMIT
, 
lim™
);

909 
	`__vmwr™e
(
GUEST_IDTR_BASE
, 
ba£
);

911 
x86_£g_ldŒ
:

912 
	`__vmwr™e
(
GUEST_LDTR_SELECTOR
, 
£l
);

913 
	`__vmwr™e
(
GUEST_LDTR_LIMIT
, 
lim™
);

914 
	`__vmwr™e
(
GUEST_LDTR_BASE
, 
ba£
);

915 
	`__vmwr™e
(
GUEST_LDTR_AR_BYTES
, 
©Œ
);

918 
	`BUG
();

921 
	`vmx_vmcs_ex™
(
v
);

922 
	}
}

924 
	$vmx_£t_tsc_off£t
(
vıu
 *
v
, 
u64
 
off£t
)

926 
	`vmx_vmcs_’‹r
(
v
);

927 
	`__vmwr™e
(
TSC_OFFSET
, 
off£t
);

928 #ià
	`defšed
 (
__i386__
)

929 
	`__vmwr™e
(
TSC_OFFSET_HIGH
, 
off£t
 >> 32);

931 
	`vmx_vmcs_ex™
(
v
);

932 
	}
}

934 
	$vmx_£t_rdtsc_ex™šg
(
vıu
 *
v
, 
boŞ_t
 
’abË
)

936 
	`vmx_vmcs_’‹r
(
v
);

937 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_RDTSC_EXITING
;

938 iàĞ
’abË
 )

939 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
CPU_BASED_RDTSC_EXITING
;

940 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

941 
	`vmx_vmcs_ex™
(
v
);

942 
	}
}

944 
	$vmx_š™_hy³rÿÎ_·ge
(
domaš
 *
d
, *
hy³rÿÎ_·ge
)

946 *
p
;

947 
i
;

949  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

951 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

952 *(
u8
 *)(
p
 + 0) = 0xb8;

953 *(
u32
 *)(
p
 + 1èğ
i
;

954 *(
u8
 *)(
p
 + 5) = 0x0f;

955 *(
u8
 *)(
p
 + 6) = 0x01;

956 *(
u8
 *)(
p
 + 7) = 0xc1;

957 *(
u8
 *)(
p
 + 8) = 0xc3;

961 *(
u16
 *)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32)) = 0x0b0f;

962 
	}
}

964 
	$vmx_g‘_š‹¼u±_shadow
(
vıu
 *
v
)

966  
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
);

967 
	}
}

969 
	$vmx_£t_š‹¼u±_shadow
(
vıu
 *
v
, 
šŒ_shadow
)

971 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 
šŒ_shadow
);

972 
	}
}

974 
	$vmx_lßd_pd±rs
(
vıu
 *
v
)

976 
ü3
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3], 
mâ
;

977 
ušt64_t
 *
gue¡_pd±rs
;

978 
p2m_ty³_t
 
p2mt
;

979 *
p
;

982 iàĞ!
	`hvm_·e_’abËd
(
v
è|| (v->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_LMA
) )

985 iàĞ
ü3
 & 0x1fUL )

986 
üash
;

988 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
),

989 
ü3
 >> 
PAGE_SHIFT
, &
p2mt
));

990 iàĞ!
	`p2m_is_¿m
(
p2mt
) )

991 
üash
;

993 
p
 = 
	`m­_domaš_·ge
(
mâ
);

995 
gue¡_pd±rs
 = (
ušt64_t
 *)(
p
 + (
ü3
 & ~
PAGE_MASK
));

1003 
	`vmx_vmcs_’‹r
(
v
);

1005 
	`__vmwr™e
(
GUEST_PDPTR0
, 
gue¡_pd±rs
[0]);

1006 
	`__vmwr™e
(
GUEST_PDPTR1
, 
gue¡_pd±rs
[1]);

1007 
	`__vmwr™e
(
GUEST_PDPTR2
, 
gue¡_pd±rs
[2]);

1008 
	`__vmwr™e
(
GUEST_PDPTR3
, 
gue¡_pd±rs
[3]);

1009 #ifdeà
__i386__


1010 
	`__vmwr™e
(
GUEST_PDPTR0_HIGH
, 
gue¡_pd±rs
[0] >> 32);

1011 
	`__vmwr™e
(
GUEST_PDPTR1_HIGH
, 
gue¡_pd±rs
[1] >> 32);

1012 
	`__vmwr™e
(
GUEST_PDPTR2_HIGH
, 
gue¡_pd±rs
[2] >> 32);

1013 
	`__vmwr™e
(
GUEST_PDPTR3_HIGH
, 
gue¡_pd±rs
[3] >> 32);

1016 
	`vmx_vmcs_ex™
(
v
);

1018 
	`unm­_domaš_·ge
(
p
);

1021 
üash
:

1022 
	`domaš_üash
(
v
->
domaš
);

1023 
	}
}

1025 
	$vmx_upd©e_ho¡_ü3
(
vıu
 *
v
)

1027 
	`vmx_vmcs_’‹r
(
v
);

1028 
	`__vmwr™e
(
HOST_CR3
, 
v
->
¬ch
.
ü3
);

1029 
	`vmx_vmcs_ex™
(
v
);

1030 
	}
}

1032 
	$vmx_upd©e_debug_¡©e
(
vıu
 *
v
)

1034 
mask
;

1036 
	`ASSERT
(
v
 =ğ
cu¼’t
);

1038 
mask
 = 1u << 
TRAP_št3
;

1039 iàĞ!
ıu_has_mÚ™Ü_Œ­_æag
 )

1040 
mask
 |ğ1u << 
TRAP_debug
;

1042 iàĞ
v
->
¬ch
.
hvm_vıu
.
debug_¡©e_Ïtch
 )

1043 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 |ğ
mask
;

1045 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 &ğ~
mask
;

1046 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

1047 
	}
}

1049 
	$vmx_upd©e_gue¡_ü
(
vıu
 *
v
, 
ü
)

1051 
	`vmx_vmcs_’‹r
(
v
);

1053  
ü
 )

1056 
»®mode
;

1057 
hw_ü0_mask
 = 
X86_CR0_NE
;

1059 iàĞ!
	`vmx_uÄe¡riùed_gue¡
(
v
) )

1060 
hw_ü0_mask
 |ğ
X86_CR0_PG
 | 
X86_CR0_PE
;

1062 iàĞ
	`·gšg_mode_shadow
(
v
->
domaš
) )

1063 
hw_ü0_mask
 |ğ
X86_CR0_WP
;

1065 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

1068 
ušt32_t
 
ü3_ùls
 = (
CPU_BASED_CR3_LOAD_EXITING
 |

1069 
CPU_BASED_CR3_STORE_EXITING
);

1070 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
ü3_ùls
;

1071 iàĞ!
	`hvm_·gšg_’abËd
(
v
) )

1072 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
ü3_ùls
;

1074 iàĞ
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_MEMORY_EVENT_CR3
] )

1075 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 |ğ
CPU_BASED_CR3_LOAD_EXITING
;

1077 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

1080 
	`vmx_upd©e_gue¡_ü
(
v
, 4);

1083 iàĞ!(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

1085 iàĞ
v
 !ğ
cu¼’t
 )

1086 
hw_ü0_mask
 |ğ
X86_CR0_TS
;

1087 iàĞ
v
->
¬ch
.
hvm_vıu
.
hw_ü
[0] & 
X86_CR0_TS
 )

1088 
	`vmx_åu_’‹r
(
v
);

1091 
»®mode
 = !(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_PE
);

1093 iàĞ(!
	`vmx_uÄe¡riùed_gue¡
(
v
)) &&

1094 (
»®mode
 !ğ
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
) )

1096 
x86_£gm’t
 
s
;

1097 
£gm’t_»gi¡”
 
»g
[
x86_£g_Œ
 + 1];

1102  
s
 = 
x86_£g_cs
 ; s <ğ
x86_£g_Œ
 ; s++ )

1103 
	`vmx_g‘_£gm’t_»gi¡”
(
v
, 
s
, &
»g
[s]);

1104 
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 = 
»®mode
;

1106 iàĞ
»®mode
 )

1108  
s
 = 
x86_£g_cs
 ; s <ğ
x86_£g_Œ
 ; s++ )

1109 
	`vmx_£t_£gm’t_»gi¡”
(
v
, 
s
, &
»g
[s]);

1110 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] |ğ
X86_CR4_VME
;

1111 
	`__vmwr™e
(
GUEST_CR4
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4]);

1112 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 = 0xffffffff;

1113 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

1117  
s
 = 
x86_£g_cs
 ; s <ğ
x86_£g_Œ
 ; s++ )

1118 iàĞ!(
v
->
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
 & (1<<
s
)) )

1119 
	`vmx_£t_£gm’t_»gi¡”
(

1120 
v
, 
s
, &v->
¬ch
.
hvm_vmx
.
vm86_§ved_£g
[s]);

1121 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] =

1122 ((
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] & ~
X86_CR4_VME
)

1123 |(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4] & 
X86_CR4_VME
));

1124 
	`__vmwr™e
(
GUEST_CR4
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4]);

1125 
v
->
¬ch
.
hvm_vmx
.
exû±iÚ_b™m­
 = 
HVM_TRAP_MASK


1126 | (
	`·gšg_mode_h­
(
v
->
domaš
) ?

1127 0 : (1U << 
TRAP_·ge_çuÉ
))

1128 | (1U << 
TRAP_no_deviû
);

1129 
	`vmx_upd©e_exû±iÚ_b™m­
(
v
);

1130 
	`vmx_upd©e_debug_¡©e
(
v
);

1134 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[0] =

1135 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] | 
hw_ü0_mask
;

1136 
	`__vmwr™e
(
GUEST_CR0
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[0]);

1137 
	`__vmwr™e
(
CR0_READ_SHADOW
, 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0]);

1144 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

1146 iàĞ!
	`hvm_·gšg_’abËd
(
v
) )

1147 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3] =

1148 
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_IDENT_PT
];

1149 
	`vmx_lßd_pd±rs
(
v
);

1152 
	`__vmwr™e
(
GUEST_CR3
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3]);

1153 
	`hvm_asid_æush_vıu
(
v
);

1156 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] = 
HVM_CR4_HOST_MASK
;

1157 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

1158 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] &ğ~
X86_CR4_PAE
;

1159 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] |ğv->¬ch.hvm_vıu.
gue¡_ü
[4];

1160 iàĞ
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 )

1161 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] |ğ
X86_CR4_VME
;

1162 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
è&& !
	`hvm_·gšg_’abËd
(v) )

1164 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] |ğ
X86_CR4_PSE
;

1165 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4] &ğ~
X86_CR4_PAE
;

1167 
	`__vmwr™e
(
GUEST_CR4
, 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[4]);

1168 
	`__vmwr™e
(
CR4_READ_SHADOW
, 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4]);

1171 
	`BUG
();

1174 
	`vmx_vmcs_ex™
(
v
);

1175 
	}
}

1177 
	$vmx_upd©e_gue¡_eãr
(
vıu
 *
v
)

1179 #ifdeà
__x86_64__


1180 
vm_’Œy_v®ue
;

1182 
	`vmx_vmcs_’‹r
(
v
);

1184 
vm_’Œy_v®ue
 = 
	`__vm»ad
(
VM_ENTRY_CONTROLS
);

1185 iàĞ
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_LMA
 )

1186 
vm_’Œy_v®ue
 |ğ
VM_ENTRY_IA32E_MODE
;

1188 
vm_’Œy_v®ue
 &ğ~
VM_ENTRY_IA32E_MODE
;

1189 
	`__vmwr™e
(
VM_ENTRY_CONTROLS
, 
vm_’Œy_v®ue
);

1191 
	`vmx_vmcs_ex™
(
v
);

1194 iàĞ
v
 =ğ
cu¼’t
 )

1195 
	`wr™e_eãr
((
	`»ad_eãr
(è& ~
EFER_SCE
) |

1196 (
v
->
¬ch
.
hvm_vıu
.
gue¡_eãr
 & 
EFER_SCE
));

1197 
	}
}

1199 
	$__•t_sync_domaš
(*
šfo
)

1201 
domaš
 *
d
 = 
šfo
;

1202 
	`__šv•t
(
INVEPT_SINGLE_CONTEXT
, 
	`•t_g‘_•
(
d
), 0);

1203 
	}
}

1205 
	$•t_sync_domaš
(
domaš
 *
d
)

1208 iàĞ!
	`·gšg_mode_h­
(
d
è|| !d->
vıu
 || !d->vcpu[0] )

1211 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

1212 
	`ASSERT
(
	`p2m_locked_by_me
(
	`p2m_g‘_ho¡p2m
(
d
)));

1220 
	`ıus_ªd
(
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_synûd
,

1221 
d
->
domaš_dœty_ıumask
, 
ıu_Úlše_m­
);

1223 
	`Ú_£Ëùed_ıus
(&
d
->
¬ch
.
hvm_domaš
.
vmx
.
•t_synûd
,

1224 
__•t_sync_domaš
, 
d
, 1);

1225 
	}
}

1227 
	$__vmx_šjeù_exû±iÚ
(
Œ­
, 
ty³
, 
”rÜ_code
)

1229 
šŒ_f›lds
;

1230 
vıu
 *
cu¼
 = 
cu¼’t
;

1240 
šŒ_f›lds
 = (
INTR_INFO_VALID_MASK
 | (
ty³
<<8è| 
Œ­
);

1241 iàĞ
”rÜ_code
 !ğ
HVM_DELIVER_NO_ERROR_CODE
 ) {

1242 
	`__vmwr™e
(
VM_ENTRY_EXCEPTION_ERROR_CODE
, 
”rÜ_code
);

1243 
šŒ_f›lds
 |ğ
INTR_INFO_DELIVER_CODE_MASK
;

1246 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
, 
šŒ_f›lds
);

1250 iàĞ
cu¼
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 )

1251 
cu¼
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 = 1;

1252 
	}
}

1254 
	$vmx_šjeù_hw_exû±iÚ
(
Œ­
, 
”rÜ_code
)

1256 
šŒ_šfo
 = 
	`__vm»ad
(
VM_ENTRY_INTR_INFO
);

1257 
vıu
 *
cu¼
 = 
cu¼’t
;

1259 
ty³
 = 
X86_EVENTTYPE_HW_EXCEPTION
;

1261  
Œ­
 )

1263 
TRAP_debug
:

1264 
ty³
 = 
X86_EVENTTYPE_SW_EXCEPTION
;

1265 iàĞ
	`gue¡_ıu_u£r_»gs
()->
eæags
 & 
X86_EFLAGS_TF
 )

1267 
	`__»¡Üe_debug_»gi¡”s
(
cu¼
);

1268 
	`wr™e_debug»g
(6, 
	`»ad_debug»g
(6) | 0x4000);

1270 iàĞ
ıu_has_mÚ™Ü_Œ­_æag
 )

1272 
TRAP_št3
:

1273 iàĞ
cu¼
->
domaš
->
debugg”_©ched
 )

1276 
	`domaš_·u£_fÜ_debugg”
();

1280 
ty³
 = 
X86_EVENTTYPE_SW_EXCEPTION
;

1281 
	`__vmwr™e
(
VM_ENTRY_INSTRUCTION_LEN
, 1);

1284 iàĞ
	`uÆik–y
(
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
) &&

1285 (((
šŒ_šfo
 >> 8è& 7è=ğ
X86_EVENTTYPE_HW_EXCEPTION
) )

1287 
Œ­
 = 
	`hvm_combše_hw_exû±iÚs
((
ušt8_t
)
šŒ_šfo
,rap);

1288 iàĞ
Œ­
 =ğ
TRAP_doubË_çuÉ
 )

1289 
”rÜ_code
 = 0;

1292 
	`__vmx_šjeù_exû±iÚ
(
Œ­
, 
ty³
, 
”rÜ_code
);

1294 iàĞ
Œ­
 =ğ
TRAP_·ge_çuÉ
 )

1295 
	`HVMTRACE_LONG_2D
(
PF_INJECT
, 
”rÜ_code
,

1296 
	`TRC_PAR_LONG
(
cu¼’t
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2]));

1298 
	`HVMTRACE_2D
(
INJ_EXC
, 
Œ­
, 
”rÜ_code
);

1299 
	}
}

1301 
	$vmx_šjeù_extšt
(
Œ­
)

1303 
	`__vmx_šjeù_exû±iÚ
(
Œ­
, 
X86_EVENTTYPE_EXT_INTR
,

1304 
HVM_DELIVER_NO_ERROR_CODE
);

1305 
	}
}

1307 
	$vmx_šjeù_nmi
()

1309 
	`__vmx_šjeù_exû±iÚ
(2, 
X86_EVENTTYPE_NMI
,

1310 
HVM_DELIVER_NO_ERROR_CODE
);

1311 
	}
}

1313 
	$vmx_šjeù_exû±iÚ
(

1314 
Œ­Ä
, 
”rcode
, 
ü2
)

1316 iàĞ
Œ­Ä
 =ğ
TRAP_·ge_çuÉ
 )

1317 
cu¼’t
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
ü2
;

1319 
	`vmx_šjeù_hw_exû±iÚ
(
Œ­Ä
, 
”rcode
);

1320 
	}
}

1322 
	$vmx_ev’t_³ndšg
(
vıu
 *
v
)

1324 
	`ASSERT
(
v
 =ğ
cu¼’t
);

1325  (
	`__vm»ad
(
VM_ENTRY_INTR_INFO
è& 
INTR_INFO_VALID_MASK
);

1326 
	}
}

1328 
	$vmx_do_pmu_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

1330  
	`vpmu_do_š‹¼u±
(
»gs
);

1331 
	}
}

1333 
	$vmx_£t_uc_mode
(
vıu
 *
v
)

1335 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
) )

1336 
	`•t_chªge_’Œy_emt_w™h_¿nge
(

1337 
v
->
domaš
, 0, 
	`p2m_g‘_ho¡p2m
(v->domaš)->
max_m­³d_pâ
);

1338 
	`hvm_asid_æush_vıu
(
v
);

1339 
	}
}

1341 
	$vmx_£t_šfo_gue¡
(
vıu
 *
v
)

1343 
šŒ_shadow
;

1345 
	`vmx_vmcs_’‹r
(
v
);

1347 
	`__vmwr™e
(
GUEST_DR7
, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7]);

1357 
šŒ_shadow
 = 
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
);

1358 iàĞ
v
->
domaš
->
debugg”_©ched
 &&

1359 (
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
.
eæags
 & 
X86_EFLAGS_TF
) &&

1360 (
šŒ_shadow
 & 
VMX_INTR_SHADOW_STI
) )

1362 
šŒ_shadow
 &ğ~
VMX_INTR_SHADOW_STI
;

1363 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 
šŒ_shadow
);

1366 
	`vmx_vmcs_ex™
(
v
);

1367 
	}
}

1369 
hvm_funùiÚ_bË
 
__»ad_mo¡ly
 
	gvmx_funùiÚ_bË
 = {

1370 .
Çme
 = "VMX",

1371 .
	gıu_up_´•¬e
 = 
vmx_ıu_up_´•¬e
,

1372 .
	gıu_d—d
 = 
vmx_ıu_d—d
,

1373 .
	gdomaš_š™Ÿli£
 = 
vmx_domaš_š™Ÿli£
,

1374 .
	gdomaš_de¡roy
 = 
vmx_domaš_de¡roy
,

1375 .
	gvıu_š™Ÿli£
 = 
vmx_vıu_š™Ÿli£
,

1376 .
	gvıu_de¡roy
 = 
vmx_vıu_de¡roy
,

1377 .
	g§ve_ıu_ùxt
 = 
vmx_§ve_vmcs_ùxt
,

1378 .
	glßd_ıu_ùxt
 = 
vmx_lßd_vmcs_ùxt
,

1379 .
	gg‘_š‹¼u±_shadow
 = 
vmx_g‘_š‹¼u±_shadow
,

1380 .
	g£t_š‹¼u±_shadow
 = 
vmx_£t_š‹¼u±_shadow
,

1381 .
	ggue¡_x86_mode
 = 
vmx_gue¡_x86_mode
,

1382 .
	gg‘_£gm’t_»gi¡”
 = 
vmx_g‘_£gm’t_»gi¡”
,

1383 .
	g£t_£gm’t_»gi¡”
 = 
vmx_£t_£gm’t_»gi¡”
,

1384 .
	gupd©e_ho¡_ü3
 = 
vmx_upd©e_ho¡_ü3
,

1385 .
	gupd©e_gue¡_ü
 = 
vmx_upd©e_gue¡_ü
,

1386 .
	gupd©e_gue¡_eãr
 = 
vmx_upd©e_gue¡_eãr
,

1387 .
	g£t_tsc_off£t
 = 
vmx_£t_tsc_off£t
,

1388 .
	gšjeù_exû±iÚ
 = 
vmx_šjeù_exû±iÚ
,

1389 .
	gš™_hy³rÿÎ_·ge
 = 
vmx_š™_hy³rÿÎ_·ge
,

1390 .
	gev’t_³ndšg
 = 
vmx_ev’t_³ndšg
,

1391 .
	gdo_pmu_š‹¼u±
 = 
vmx_do_pmu_š‹¼u±
,

1392 .
	gıu_up
 = 
vmx_ıu_up
,

1393 .
	gıu_down
 = 
vmx_ıu_down
,

1394 .
	gıuid_š‹rû±
 = 
vmx_ıuid_š‹rû±
,

1395 .
	gwbšvd_š‹rû±
 = 
vmx_wbšvd_š‹rû±
,

1396 .
	gåu_dœty_š‹rû±
 = 
vmx_åu_dœty_š‹rû±
,

1397 .
	gm¤_»ad_š‹rû±
 = 
vmx_m¤_»ad_š‹rû±
,

1398 .
	gm¤_wr™e_š‹rû±
 = 
vmx_m¤_wr™e_š‹rû±
,

1399 .
	gšvÍg_š‹rû±
 = 
vmx_švÍg_š‹rû±
,

1400 .
	g£t_uc_mode
 = 
vmx_£t_uc_mode
,

1401 .
	g£t_šfo_gue¡
 = 
vmx_£t_šfo_gue¡
,

1402 .
	g£t_rdtsc_ex™šg
 = 
vmx_£t_rdtsc_ex™šg


1405 
hvm_funùiÚ_bË
 * 
__š™
 
	$¡¬t_vmx
()

1407 iàĞ!
	`‹¡_b™
(
X86_FEATURE_VMXE
, &
boÙ_ıu_d©a
.
x86_ÿ·b™y
) )

1408  
NULL
;

1410 
	`£t_š_ü4
(
X86_CR4_VMXE
);

1412 iàĞ
	`vmx_ıu_up
() )

1414 
	`´štk
("VMX: failedo initialise.\n");

1415  
NULL
;

1418 iàĞ
ıu_has_vmx_•t
 )

1420 
vmx_funùiÚ_bË
.
h­_suµÜ‹d
 = 1;

1422 
vmx_funùiÚ_bË
.
h­_ÿ·b™›s
 = 0;

1424 iàĞ
ıu_has_vmx_•t_2mb
 )

1425 
vmx_funùiÚ_bË
.
h­_ÿ·b™›s
 |ğ
HVM_HAP_SUPERPAGE_2MB
;

1426 iàĞ
ıu_has_vmx_•t_1gb
 )

1427 
vmx_funùiÚ_bË
.
h­_ÿ·b™›s
 |ğ
HVM_HAP_SUPERPAGE_1GB
;

1429 
	`£tup_•t_dump
();

1432 
	`£tup_vmcs_dump
();

1434  &
vmx_funùiÚ_bË
;

1435 
	}
}

1441 
	$g‘_š¡ruùiÚ_Ëngth
()

1443 
Ën
;

1444 
Ën
 = 
	`__vm»ad
(
VM_EXIT_INSTRUCTION_LEN
);

1445 
	`BUG_ON
((
Ën
 < 1) || (len > 15));

1446  
Ën
;

1447 
	}
}

1449 
	$upd©e_gue¡_e
()

1451 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

1452 
x
;

1454 
»gs
->
e
 +ğ
	`g‘_š¡ruùiÚ_Ëngth
();

1455 
»gs
->
eæags
 &ğ~
X86_EFLAGS_RF
;

1457 
x
 = 
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
);

1458 iàĞ
x
 & (
VMX_INTR_SHADOW_STI
 | 
VMX_INTR_SHADOW_MOV_SS
) )

1460 
x
 &ğ~(
VMX_INTR_SHADOW_STI
 | 
VMX_INTR_SHADOW_MOV_SS
);

1461 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
, 
x
);

1464 iàĞ
»gs
->
eæags
 & 
X86_EFLAGS_TF
 )

1465 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_debug
, 
HVM_DELIVER_NO_ERROR_CODE
);

1466 
	}
}

1468 
	$vmx_åu_dœty_š‹rû±
()

1470 
vıu
 *
cu¼
 = 
cu¼’t
;

1472 
	`vmx_åu_’‹r
(
cu¼
);

1475 iàĞ!(
cu¼
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] & 
X86_CR0_TS
) )

1477 
cu¼
->
¬ch
.
hvm_vıu
.
hw_ü
[0] &ğ~
X86_CR0_TS
;

1478 
	`__vmwr™e
(
GUEST_CR0
, 
cu¼
->
¬ch
.
hvm_vıu
.
hw_ü
[0]);

1480 
	}
}

1482 
	$vmx_ıuid_š‹rû±
(

1483 *
—x
, *
ebx
,

1484 *
ecx
, *
edx
)

1486 
šput
 = *
—x
;

1487 
£gm’t_»gi¡”
 
cs
;

1488 
vıu
 *
v
 = 
cu¼’t
;

1490 
	`hvm_ıuid
(
šput
, 
—x
, 
ebx
, 
ecx
, 
edx
);

1492  
šput
 )

1496 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
cs
);

1497 iàĞ
cs
.
©Œ
.
f›lds
.
l
 )

1498 *
edx
 |ğ
	`ıuã©_mask
(
X86_FEATURE_SYSCALL
);

1500 *
edx
 &ğ~(
	`ıuã©_mask
(
X86_FEATURE_SYSCALL
));

1505 
	`HVMTRACE_5D
 (
CPUID
, 
šput
, *
—x
, *
ebx
, *
ecx
, *
edx
);

1506 
	}
}

1508 
	$vmx_do_ıuid
(
ıu_u£r_»gs
 *
»gs
)

1510 
—x
, 
ebx
, 
ecx
, 
edx
;

1512 
—x
 = 
»gs
->eax;

1513 
ebx
 = 
»gs
->ebx;

1514 
ecx
 = 
»gs
->ecx;

1515 
edx
 = 
»gs
->edx;

1517 
	`vmx_ıuid_š‹rû±
(&
—x
, &
ebx
, &
ecx
, &
edx
);

1519 
»gs
->
—x
 =ƒax;

1520 
»gs
->
ebx
 =ƒbx;

1521 
»gs
->
ecx
 =ƒcx;

1522 
»gs
->
edx
 =ƒdx;

1523 
	}
}

1525 
	$vmx_dr_acûss
(
ex™_qu®ifiÿtiÚ
,

1526 
ıu_u£r_»gs
 *
»gs
)

1528 
vıu
 *
v
 = 
cu¼’t
;

1530 
	`HVMTRACE_0D
(
DR_WRITE
);

1532 iàĞ!
v
->
¬ch
.
hvm_vıu
.
æag_dr_dœty
 )

1533 
	`__»¡Üe_debug_»gi¡”s
(
v
);

1536 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_MOV_DR_EXITING
;

1537 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

1538 
	}
}

1540 
	$vmx_švÍg_š‹rû±
(
vaddr
)

1542 
vıu
 *
cu¼
 = 
cu¼’t
;

1543 
	`HVMTRACE_LONG_2D
(
INVLPG
, 0, 
	`TRC_PAR_LONG
(
vaddr
));

1544 iàĞ
	`·gšg_švÍg
(
cu¼
, 
vaddr
è&& 
ıu_has_vmx_vpid
 )

1545 
	`vpid_sync_vıu_gva
(
cu¼
, 
vaddr
);

1546 
	}
}

1548 
	#CASE_SET_REG
(
REG
, 
»g
) \

1549 
VMX_CONTROL_REG_ACCESS_GPR_
 ## 
REG
: 
»gs
->
»g
 = 
v®ue
; 

	)

1550 
	#CASE_GET_REG
(
REG
, 
»g
) \

1551 
VMX_CONTROL_REG_ACCESS_GPR_
 ## 
REG
: 
v®ue
 = 
»gs
->
»g
; 

	)

1553 
	#CASE_EXTEND_SET_REG
 \

1554 
	`CASE_EXTEND_REG
(
S
)

	)

1555 
	#CASE_EXTEND_GET_REG
 \

1556 
	`CASE_EXTEND_REG
(
G
)

	)

1558 #ifdeà
__i386__


1559 
	#CASE_EXTEND_REG
(
T
)

	)

1561 
	#CASE_EXTEND_REG
(
T
) \

1562 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R8
, 
r8
); \

1563 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R9
, 
r9
); \

1564 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R10
, 
r10
); \

1565 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R11
, 
r11
); \

1566 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R12
, 
r12
); \

1567 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R13
, 
r13
); \

1568 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R14
, 
r14
); \

1569 
CASE_
 ## 
T
 ## 
	`ET_REG
(
R15
, 
r15
)

	)

1572 
	$mov_to_ü
(
gp
, 
ü
, 
ıu_u£r_»gs
 *
»gs
)

1574 
v®ue
;

1575 
vıu
 *
v
 = 
cu¼’t
;

1576 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1577 
rc
 = 0;

1578 
Şd
;

1580  
gp
 )

1582 
	`CASE_GET_REG
(
EAX
, 
—x
);

1583 
	`CASE_GET_REG
(
ECX
, 
ecx
);

1584 
	`CASE_GET_REG
(
EDX
, 
edx
);

1585 
	`CASE_GET_REG
(
EBX
, 
ebx
);

1586 
	`CASE_GET_REG
(
EBP
, 
ebp
);

1587 
	`CASE_GET_REG
(
ESI
, 
esi
);

1588 
	`CASE_GET_REG
(
EDI
, 
edi
);

1589 
	`CASE_GET_REG
(
ESP
, 
e¥
);

1590 
CASE_EXTEND_GET_REG
;

1592 
	`gd´štk
(
XENLOG_ERR
, "šv®id gp: %d\n", 
gp
);

1593 
ex™_ªd_üash
;

1596 
	`HVMTRACE_LONG_2D
(
CR_WRITE
, 
ü
, 
	`TRC_PAR_LONG
(
v®ue
));

1598 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "CR%d, v®uğ%lx", 
ü
, 
v®ue
);

1600  
ü
 )

1603 
Şd
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

1604 
rc
 = !
	`hvm_£t_ü0
(
v®ue
);

1605 ià(
rc
)

1606 
	`hvm_memÜy_ev’t_ü0
(
v®ue
, 
Şd
);

1607  
rc
;

1610 
Şd
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

1611 
rc
 = !
	`hvm_£t_ü3
(
v®ue
);

1612 ià(
rc
)

1613 
	`hvm_memÜy_ev’t_ü3
(
v®ue
, 
Şd
);

1614  
rc
;

1617 
Şd
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

1618 
rc
 = !
	`hvm_£t_ü4
(
v®ue
);

1619 ià(
rc
)

1620 
	`hvm_memÜy_ev’t_ü4
(
v®ue
, 
Şd
);

1621  
rc
;

1624 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_TASKPRI
, ((
v®ue
 & 0x0F) << 4));

1628 
	`gd´štk
(
XENLOG_ERR
, "šv®id cr: %d\n", 
ü
);

1629 
ex™_ªd_üash
;

1634 
ex™_ªd_üash
:

1635 
	`domaš_üash
(
v
->
domaš
);

1637 
	}
}

1642 
	$mov_äom_ü
(
ü
, 
gp
, 
ıu_u£r_»gs
 *
»gs
)

1644 
v®ue
 = 0;

1645 
vıu
 *
v
 = 
cu¼’t
;

1646 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1648  
ü
 )

1651 
v®ue
 = ()
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

1654 
v®ue
 = ()
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_TASKPRI
);

1655 
v®ue
 = (value & 0xF0) >> 4;

1658 
	`gd´štk
(
XENLOG_ERR
, "šv®id cr: %d\n", 
ü
);

1659 
	`domaš_üash
(
v
->
domaš
);

1663  
gp
 ) {

1664 
	`CASE_SET_REG
(
EAX
, 
—x
);

1665 
	`CASE_SET_REG
(
ECX
, 
ecx
);

1666 
	`CASE_SET_REG
(
EDX
, 
edx
);

1667 
	`CASE_SET_REG
(
EBX
, 
ebx
);

1668 
	`CASE_SET_REG
(
EBP
, 
ebp
);

1669 
	`CASE_SET_REG
(
ESI
, 
esi
);

1670 
	`CASE_SET_REG
(
EDI
, 
edi
);

1671 
	`CASE_SET_REG
(
ESP
, 
e¥
);

1672 
CASE_EXTEND_SET_REG
;

1674 
	`´štk
("šv®id gp: %d\n", 
gp
);

1675 
	`domaš_üash
(
v
->
domaš
);

1679 
	`HVMTRACE_LONG_2D
(
CR_READ
, 
ü
, 
	`TRC_PAR_LONG
(
v®ue
));

1681 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
, "CR%d, v®uğ%lx", 
ü
, 
v®ue
);

1682 
	}
}

1684 
	$vmx_ü_acûss
(
ex™_qu®ifiÿtiÚ
,

1685 
ıu_u£r_»gs
 *
»gs
)

1687 
gp
, 
ü
;

1688 
v®ue
;

1689 
vıu
 *
v
 = 
cu¼’t
;

1691  
ex™_qu®ifiÿtiÚ
 & 
VMX_CONTROL_REG_ACCESS_TYPE
 )

1693 
VMX_CONTROL_REG_ACCESS_TYPE_MOV_TO_CR
:

1694 
gp
 = 
ex™_qu®ifiÿtiÚ
 & 
VMX_CONTROL_REG_ACCESS_GPR
;

1695 
ü
 = 
ex™_qu®ifiÿtiÚ
 & 
VMX_CONTROL_REG_ACCESS_NUM
;

1696  
	`mov_to_ü
(
gp
, 
ü
, 
»gs
);

1697 
VMX_CONTROL_REG_ACCESS_TYPE_MOV_FROM_CR
:

1698 
gp
 = 
ex™_qu®ifiÿtiÚ
 & 
VMX_CONTROL_REG_ACCESS_GPR
;

1699 
ü
 = 
ex™_qu®ifiÿtiÚ
 & 
VMX_CONTROL_REG_ACCESS_NUM
;

1700 
	`mov_äom_ü
(
ü
, 
gp
, 
»gs
);

1702 
VMX_CONTROL_REG_ACCESS_TYPE_CLTS
:

1704 
Şd
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

1705 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0] &ğ~
X86_CR0_TS
;

1706 
	`vmx_upd©e_gue¡_ü
(
v
, 0);

1708 
	`hvm_memÜy_ev’t_ü0
(
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0], 
Şd
);

1710 
	`HVMTRACE_0D
(
CLTS
);

1713 
VMX_CONTROL_REG_ACCESS_TYPE_LMSW
:

1714 
v®ue
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

1716 
v®ue
 = (v®u& ~0xeè| ((
ex™_qu®ifiÿtiÚ
 >> 16) & 0xf);

1717 
	`HVMTRACE_LONG_1D
(
LMSW
, 
v®ue
);

1718  !
	`hvm_£t_ü0
(
v®ue
);

1720 
	`BUG
();

1724 
	}
}

1726 cÚ¡ 
	slbr_šfo
 {

1727 
u32
 
	mba£
, 
	mcouÁ
;

1728 } 
	gp4_lbr
[] = {

1729 { 
MSR_P4_LER_FROM_LIP
, 1 },

1730 { 
MSR_P4_LER_TO_LIP
, 1 },

1731 { 
MSR_P4_LASTBRANCH_TOS
, 1 },

1732 { 
MSR_P4_LASTBRANCH_0_FROM_LIP
, 
NUM_MSR_P4_LASTBRANCH_FROM_TO
 },

1733 { 
MSR_P4_LASTBRANCH_0_TO_LIP
, 
NUM_MSR_P4_LASTBRANCH_FROM_TO
 },

1735 }, 
	gc2_lbr
[] = {

1736 { 
MSR_IA32_LASTINTFROMIP
, 1 },

1737 { 
MSR_IA32_LASTINTTOIP
, 1 },

1738 { 
MSR_C2_LASTBRANCH_TOS
, 1 },

1739 { 
MSR_C2_LASTBRANCH_0_FROM_IP
, 
NUM_MSR_C2_LASTBRANCH_FROM_TO
 },

1740 { 
MSR_C2_LASTBRANCH_0_TO_IP
, 
NUM_MSR_C2_LASTBRANCH_FROM_TO
 },

1742 #ifdeà
__i386__


1743 }, 
	gpm_lbr
[] = {

1744 { 
MSR_IA32_LASTINTFROMIP
, 1 },

1745 { 
MSR_IA32_LASTINTTOIP
, 1 },

1746 { 
MSR_PM_LASTBRANCH_TOS
, 1 },

1747 { 
MSR_PM_LASTBRANCH_0
, 
NUM_MSR_PM_LASTBRANCH
 },

1752 cÚ¡ 
lbr_šfo
 *
	$Ï¡_b¿nch_m¤_g‘
()

1754  
boÙ_ıu_d©a
.
x86
 )

1757  
boÙ_ıu_d©a
.
x86_mod–
 )

1759 #ifdeà
__i386__


1764  
pm_lbr
;

1769  
c2_lbr
;

1775  
boÙ_ıu_d©a
.
x86_mod–
 )

1779  
p4_lbr
;

1785  
NULL
;

1786 
	}
}

1788 
	$is_Ï¡_b¿nch_m¤
(
u32
 
ecx
)

1790 cÚ¡ 
lbr_šfo
 *
lbr
 = 
	`Ï¡_b¿nch_m¤_g‘
();

1792 iàĞ
lbr
 =ğ
NULL
 )

1795  ; 
lbr
->
couÁ
;†br++ )

1796 iàĞ(
ecx
 >ğ
lbr
->
ba£
è&& (ecx < (lbr->ba£ +†br->
couÁ
)) )

1800 
	}
}

1802 
	$vmx_m¤_»ad_š‹rû±
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

1804 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "ecx=%x", 
m¤
);

1806  
m¤
 )

1808 
MSR_IA32_SYSENTER_CS
:

1809 *
m¤_cÚ‹Á
 = (
u32
)
	`__vm»ad
(
GUEST_SYSENTER_CS
);

1811 
MSR_IA32_SYSENTER_ESP
:

1812 *
m¤_cÚ‹Á
 = 
	`__vm»ad
(
GUEST_SYSENTER_ESP
);

1814 
MSR_IA32_SYSENTER_EIP
:

1815 *
m¤_cÚ‹Á
 = 
	`__vm»ad
(
GUEST_SYSENTER_EIP
);

1817 
MSR_IA32_DEBUGCTLMSR
:

1818 *
m¤_cÚ‹Á
 = 
	`__vm»ad
(
GUEST_IA32_DEBUGCTL
);

1819 #ifdeà
__i386__


1820 *
m¤_cÚ‹Á
 |ğ(
u64
)
	`__vm»ad
(
GUEST_IA32_DEBUGCTL_HIGH
) << 32;

1823 
MSR_IA32_VMX_BASIC
...
MSR_IA32_VMX_PROCBASED_CTLS2
:

1824 
gp_çuÉ
;

1825 
MSR_IA32_MISC_ENABLE
:

1826 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, *
m¤_cÚ‹Á
);

1828 *
m¤_cÚ‹Á
 |ğ
MSR_IA32_MISC_ENABLE_BTS_UNAVAIL
 |

1829 
MSR_IA32_MISC_ENABLE_PEBS_UNAVAIL
;

1832 iàĞ
	`vpmu_do_rdm¤
(
m¤
, 
m¤_cÚ‹Á
) )

1834 iàĞ
	`·ssive_domaš_do_rdm¤
(
m¤
, 
m¤_cÚ‹Á
) )

1835 
dÚe
;

1836  
	`lÚg_mode_do_m¤_»ad
(
m¤
, 
m¤_cÚ‹Á
) )

1838 
HNDL_unhªdËd
:

1840 
HNDL_exû±iÚ_¿i£d
:

1841  
X86EMUL_EXCEPTION
;

1842 
HNDL_dÚe
:

1843 
dÚe
;

1846 iàĞ
	`vmx_»ad_gue¡_m¤
(
m¤
, 
m¤_cÚ‹Á
) == 0 )

1849 iàĞ
	`is_Ï¡_b¿nch_m¤
(
m¤
) )

1851 *
m¤_cÚ‹Á
 = 0;

1855 iàĞ
	`rdm¤_vœidŸn_»gs
(
m¤
, 
m¤_cÚ‹Á
) ||

1856 
	`rdm¤_hy³rvisÜ_»gs
(
m¤
, 
m¤_cÚ‹Á
) )

1859 iàĞ
	`rdm¤_§ã
(
m¤
, *
m¤_cÚ‹Á
) == 0 )

1862 
gp_çuÉ
;

1865 
dÚe
:

1866 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "»tuºs:ƒcx=%x, m¤_v®ue=0x%"
PRIx64
,

1867 
m¤
, *
m¤_cÚ‹Á
);

1868  
X86EMUL_OKAY
;

1870 
gp_çuÉ
:

1871 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

1872  
X86EMUL_EXCEPTION
;

1873 
	}
}

1875 
	$vmx_®loc_vÏpic_m­pšg
(
domaš
 *
d
)

1877 *
­ic_va
;

1879 iàĞ!
ıu_has_vmx_vœtu®ize_­ic_acûs£s
 )

1882 
­ic_va
 = 
	`®loc_x’h—p_·ge
();

1883 iàĞ
­ic_va
 =ğ
NULL
 )

1884  -
ENOMEM
;

1885 
	`sh¬e_x’_·ge_w™h_gue¡
(
	`vœt_to_·ge
(
­ic_va
), 
d
, 
XENSHARE_wr™abË
);

1886 
	`£t_mmio_p2m_’Œy
(

1887 
	`p2m_g‘_ho¡p2m
(
d
), 
	`·ddr_to_pâ
(
APIC_DEFAULT_PHYS_BASE
),

1888 
	`_mâ
(
	`vœt_to_mâ
(
­ic_va
)));

1889 
d
->
¬ch
.
hvm_domaš
.
vmx
.
­ic_acûss_mâ
 = 
	`vœt_to_mâ
(
­ic_va
);

1892 
	}
}

1894 
	$vmx_ä“_vÏpic_m­pšg
(
domaš
 *
d
)

1896 
mâ
 = 
d
->
¬ch
.
hvm_domaš
.
vmx
.
­ic_acûss_mâ
;

1897 iàĞ
mâ
 != 0 )

1898 
	`ä“_x’h—p_·ge
(
	`mâ_to_vœt
(
mâ
));

1899 
	}
}

1901 
	$vmx_š¡®l_vÏpic_m­pšg
(
vıu
 *
v
)

1903 
·ddr_t
 
vœt_·ge_ma
, 
­ic_·ge_ma
;

1905 iàĞ!
ıu_has_vmx_vœtu®ize_­ic_acûs£s
 )

1908 
vœt_·ge_ma
 = 
	`·ge_to_maddr
(
	`vıu_vÏpic
(
v
)->
»gs_·ge
);

1909 
­ic_·ge_ma
 = 
v
->
domaš
->
¬ch
.
hvm_domaš
.
vmx
.
­ic_acûss_mâ
;

1910 
­ic_·ge_ma
 <<ğ
PAGE_SHIFT
;

1912 
	`vmx_vmcs_’‹r
(
v
);

1913 
	`__vmwr™e
(
VIRTUAL_APIC_PAGE_ADDR
, 
vœt_·ge_ma
);

1914 
	`__vmwr™e
(
APIC_ACCESS_ADDR
, 
­ic_·ge_ma
);

1915 
	`vmx_vmcs_ex™
(
v
);

1916 
	}
}

1918 
	$vmx_vÏpic_m¤_chªged
(
vıu
 *
v
)

1920 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

1922 iàĞ!
ıu_has_vmx_vœtu®ize_­ic_acûs£s
 )

1925 
	`vmx_vmcs_’‹r
(
v
);

1926 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 &=

1927 ~
SECONDARY_EXEC_VIRTUALIZE_APIC_ACCESSES
;

1928 iàĞ!
	`vÏpic_hw_di§bËd
(
vÏpic
) &&

1929 (
	`vÏpic_ba£_add»ss
(
vÏpic
è=ğ
APIC_DEFAULT_PHYS_BASE
) )

1930 
v
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 |=

1931 
SECONDARY_EXEC_VIRTUALIZE_APIC_ACCESSES
;

1932 
	`vmx_upd©e_£cÚd¬y_exec_cÚŒŞ
(
v
);

1933 
	`vmx_vmcs_ex™
(
v
);

1934 
	}
}

1936 
	$vmx_m¤_wr™e_š‹rû±
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

1938 
vıu
 *
v
 = 
cu¼’t
;

1940 
	`HVM_DBG_LOG
(
DBG_LEVEL_1
, "ecx=%x, m¤_v®ue=0x%"
PRIx64
,

1941 
m¤
, 
m¤_cÚ‹Á
);

1943  
m¤
 )

1945 
MSR_IA32_SYSENTER_CS
:

1946 
	`__vmwr™e
(
GUEST_SYSENTER_CS
, 
m¤_cÚ‹Á
);

1948 
MSR_IA32_SYSENTER_ESP
:

1949 
	`__vmwr™e
(
GUEST_SYSENTER_ESP
, 
m¤_cÚ‹Á
);

1951 
MSR_IA32_SYSENTER_EIP
:

1952 
	`__vmwr™e
(
GUEST_SYSENTER_EIP
, 
m¤_cÚ‹Á
);

1954 
MSR_IA32_DEBUGCTLMSR
: {

1955 
i
, 
rc
 = 0;

1957 iàĞ!
m¤_cÚ‹Á
 || (msr_content & ~3) )

1960 iàĞ
m¤_cÚ‹Á
 & 1 )

1962 cÚ¡ 
lbr_šfo
 *
lbr
 = 
	`Ï¡_b¿nch_m¤_g‘
();

1963 iàĞ
lbr
 =ğ
NULL
 )

1966  ; (
rc
 =ğ0è&& 
lbr
->
couÁ
;†br++ )

1967  
i
 = 0; (
rc
 =ğ0è&& (˜< 
lbr
->
couÁ
); i++ )

1968 iàĞ(
rc
 = 
	`vmx_add_gue¡_m¤
(
lbr
->
ba£
 + 
i
)) == 0 )

1969 
	`vmx_di§bË_š‹rû±_fÜ_m¤
(
v
, 
lbr
->
ba£
 + 
i
);

1972 iàĞ(
rc
 < 0) ||

1973 (
	`vmx_add_ho¡_lßd_m¤
(
m¤
) < 0) )

1974 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_machše_check
, 0);

1977 
	`__vmwr™e
(
GUEST_IA32_DEBUGCTL
, 
m¤_cÚ‹Á
);

1978 #ifdeà
__i386__


1979 
	`__vmwr™e
(
GUEST_IA32_DEBUGCTL_HIGH
, 
m¤_cÚ‹Á
 >> 32);

1985 
MSR_IA32_VMX_BASIC
...
MSR_IA32_VMX_PROCBASED_CTLS2
:

1986 
gp_çuÉ
;

1988 iàĞ
	`vpmu_do_wrm¤
(
m¤
, 
m¤_cÚ‹Á
) )

1989  
X86EMUL_OKAY
;

1990 iàĞ
	`·ssive_domaš_do_wrm¤
(
m¤
, 
m¤_cÚ‹Á
) )

1991  
X86EMUL_OKAY
;

1993 iàĞ
	`wrm¤_vœidŸn_»gs
(
m¤
, 
m¤_cÚ‹Á
) )

1996  
	`lÚg_mode_do_m¤_wr™e
(
m¤
, 
m¤_cÚ‹Á
) )

1998 
HNDL_unhªdËd
:

1999 iàĞ(
	`vmx_wr™e_gue¡_m¤
(
m¤
, 
m¤_cÚ‹Á
) != 0) &&

2000 !
	`is_Ï¡_b¿nch_m¤
(
m¤
) )

2001 
	`wrm¤_hy³rvisÜ_»gs
(
m¤
, 
m¤_cÚ‹Á
);

2003 
HNDL_exû±iÚ_¿i£d
:

2004  
X86EMUL_EXCEPTION
;

2005 
HNDL_dÚe
:

2011  
X86EMUL_OKAY
;

2013 
gp_çuÉ
:

2014 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

2015  
X86EMUL_EXCEPTION
;

2016 
	}
}

2018 
	$vmx_do_extšt
(
ıu_u£r_»gs
 *
»gs
)

2020 
veùÜ
;

2022 
veùÜ
 = 
	`__vm»ad
(
VM_EXIT_INTR_INFO
);

2023 
	`BUG_ON
(!(
veùÜ
 & 
INTR_INFO_VALID_MASK
));

2025 
veùÜ
 &ğ
INTR_INFO_VECTOR_MASK
;

2026 
	`HVMTRACE_1D
(
INTR
, 
veùÜ
);

2028  
veùÜ
 )

2030 
IRQ_MOVE_CLEANUP_VECTOR
:

2031 
	`smp_œq_move_ş—nup_š‹¼u±
(
»gs
);

2033 
LOCAL_TIMER_VECTOR
:

2034 
	`smp_­ic_tim”_š‹¼u±
(
»gs
);

2036 
EVENT_CHECK_VECTOR
:

2037 
	`smp_ev’t_check_š‹¼u±
(
»gs
);

2039 
INVALIDATE_TLB_VECTOR
:

2040 
	`smp_šv®id©e_š‹¼u±
();

2042 
CALL_FUNCTION_VECTOR
:

2043 
	`smp_ÿÎ_funùiÚ_š‹¼u±
(
»gs
);

2045 
SPURIOUS_APIC_VECTOR
:

2046 
	`smp_¥urious_š‹¼u±
(
»gs
);

2048 
ERROR_APIC_VECTOR
:

2049 
	`smp_”rÜ_š‹¼u±
(
»gs
);

2051 
CMCI_APIC_VECTOR
:

2052 
	`smp_cmci_š‹¼u±
(
»gs
);

2054 
PMU_APIC_VECTOR
:

2055 
	`smp_pmu_­ic_š‹¼u±
(
»gs
);

2057 #ifdeà
CONFIG_X86_MCE_THERMAL


2058 
THERMAL_APIC_VECTOR
:

2059 
	`smp_th”m®_š‹¼u±
(
»gs
);

2063 
»gs
->
’Œy_veùÜ
 = 
veùÜ
;

2064 
	`do_IRQ
(
»gs
);

2067 
	}
}

2069 
	$wbšvd_i
(*
šfo
)

2071 
	`wbšvd
();

2072 
	}
}

2074 
	$vmx_wbšvd_š‹rû±
()

2076 iàĞ!
	`has_¬ch_mmios
(
cu¼’t
->
domaš
) )

2079 iàĞ
iommu_¢oİ
 )

2082 iàĞ
ıu_has_wbšvd_ex™šg
 )

2083 
	`Ú_—ch_ıu
(
wbšvd_i
, 
NULL
, 1);

2085 
	`wbšvd
();

2086 
	}
}

2088 
	$•t_hªdË_viŞ©iÚ
(
qu®ifiÿtiÚ
, 
·ddr_t
 
g·
)

2090 
gÏ
, 
gâ
 = 
g·
 >> 
PAGE_SHIFT
;

2091 
mâ_t
 
mâ
;

2092 
p2m_ty³_t
 
p2mt
;

2093 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
);

2095 iàĞ
tb_š™_dÚe
 )

2098 
ušt64_t
 
g·
;

2099 
ušt64_t
 
mâ
;

2100 
u32
 
qu®ifiÿtiÚ
;

2101 
u32
 
p2mt
;

2102 } 
_d
;

2104 
_d
.
g·
 = gpa;

2105 
_d
.
qu®ifiÿtiÚ
 = qualification;

2106 
_d
.
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &_d.
p2mt
));

2108 
	`__Œaû_v¬
(
TRC_HVM_NPF
, 0, (
_d
), &_d);

2111 iàĞ
	`hvm_h­_Ã¡ed_·ge_çuÉ
(
g·
,

2112 
qu®ifiÿtiÚ
 & 
EPT_GLA_VALID
 ? 1 : 0,

2113 
qu®ifiÿtiÚ
 & 
EPT_GLA_VALID


2114 ? 
	`__vm»ad
(
GUEST_LINEAR_ADDRESS
) : ~0ull,

2116 
qu®ifiÿtiÚ
 & 
EPT_READ_VIOLATION
 ? 1 : 0,

2117 
qu®ifiÿtiÚ
 & 
EPT_WRITE_VIOLATION
 ? 1 : 0,

2118 
qu®ifiÿtiÚ
 & 
EPT_EXEC_VIOLATION
 ? 1 : 0) )

2122 
mâ
 = 
	`gâ_to_mâ_gue¡
(
p2m
, 
gâ
, &
p2mt
);

2123 
	`gd´štk
(
XENLOG_ERR
, "EPT violation %#lx (%c%c%c/%c%c%c), "

2124 "g· %#"
PRI·ddr
", mfn %#lx,ype %i.\n",

2125 
qu®ifiÿtiÚ
,

2126 (
qu®ifiÿtiÚ
 & 
EPT_READ_VIOLATION
) ? 'r' : '-',

2127 (
qu®ifiÿtiÚ
 & 
EPT_WRITE_VIOLATION
) ? 'w' : '-',

2128 (
qu®ifiÿtiÚ
 & 
EPT_EXEC_VIOLATION
) ? 'x' : '-',

2129 (
qu®ifiÿtiÚ
 & 
EPT_EFFECTIVE_READ
) ? 'r' : '-',

2130 (
qu®ifiÿtiÚ
 & 
EPT_EFFECTIVE_WRITE
) ? 'w' : '-',

2131 (
qu®ifiÿtiÚ
 & 
EPT_EFFECTIVE_EXEC
) ? 'x' : '-',

2132 
g·
, 
	`mâ_x
(
mâ
), 
p2mt
);

2134 
	`•t_w®k_bË
(
cu¼’t
->
domaš
, 
gâ
);

2136 iàĞ
qu®ifiÿtiÚ
 & 
EPT_GLA_VALID
 )

2138 
gÏ
 = 
	`__vm»ad
(
GUEST_LINEAR_ADDRESS
);

2139 
	`gd´štk
(
XENLOG_ERR
, " --- GLA %#lx\n", 
gÏ
);

2142 
	`domaš_üash
(
cu¼’t
->
domaš
);

2143 
	}
}

2145 
	$vmx_çed_vm’Œy
(
ex™_»asÚ
,

2146 
ıu_u£r_»gs
 *
»gs
)

2148 
çed_vm’Œy_»asÚ
 = (
ušt16_t
)
ex™_»asÚ
;

2149 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2150 
vıu
 *
cu¼
 = 
cu¼’t
;

2152 
	`´štk
("Faed vmƒÁry (ex™„—sÚ 0x%xè", 
ex™_»asÚ
);

2153  
çed_vm’Œy_»asÚ
 )

2155 
EXIT_REASON_INVALID_GUEST_STATE
:

2156 
	`´štk
("ÿu£d by inv®id gue¡ s‹ (%ld).\n", 
ex™_qu®ifiÿtiÚ
);

2158 
EXIT_REASON_MSR_LOADING
:

2159 
	`´štk
("ÿu£d by MSRƒÁry %ld†ßdšg.\n", 
ex™_qu®ifiÿtiÚ
);

2161 
EXIT_REASON_MCE_DURING_VMENTRY
:

2162 
	`´štk
("caused by machine check.\n");

2163 
	`HVMTRACE_0D
(
MCE
);

2167 
	`´štk
("reason‚ot known yet!");

2171 
	`´štk
("************* VMCS Area **************\n");

2172 
	`vmcs_dump_vıu
(
cu¼
);

2173 
	`´štk
("**************************************\n");

2175 
	`domaš_üash
(
cu¼
->
domaš
);

2176 
	}
}

2178 
asmlškage
 
	$vmx_’‹r_»®mode
(
ıu_u£r_»gs
 *
»gs
)

2180 
vıu
 *
v
 = 
cu¼’t
;

2185 
v
->
¬ch
.
hvm_vmx
.
vm86_§ved_eæags
 = 
»gs
->
eæags
;

2186 
»gs
->
eæags
 |ğ(
X86_EFLAGS_VM
 | 
X86_EFLAGS_IOPL
);

2187 
	}
}

2189 
	$vmx_vmex™_ud_š‹rû±
(
ıu_u£r_»gs
 *
»gs
)

2191 
hvm_emuÏ‹_ùxt
 
ùxt
;

2192 
rc
;

2194 
	`hvm_emuÏ‹_´•¬e
(&
ùxt
, 
»gs
);

2196 
rc
 = 
	`hvm_emuÏ‹_Úe
(&
ùxt
);

2198  
rc
 )

2200 
X86EMUL_UNHANDLEABLE
:

2201 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_šv®id_İ
, 
HVM_DELIVER_NO_ERROR_CODE
);

2203 
X86EMUL_EXCEPTION
:

2204 iàĞ
ùxt
.
exn_³ndšg
 )

2205 
	`hvm_šjeù_exû±iÚ
(
ùxt
.
exn_veùÜ
, ctxt.
exn_”rÜ_code
, 0);

2208 
	`hvm_emuÏ‹_wr™eback
(&
ùxt
);

2211 
	}
}

2213 
	$vmx_hªdË_eoi_wr™e
()

2215 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2221 iàĞ(((
ex™_qu®ifiÿtiÚ
 >> 12) & 0xf) == 1) &&

2222 ((
ex™_qu®ifiÿtiÚ
 & 0xfffè=ğ
APIC_EOI
) )

2224 
	`upd©e_gue¡_e
();

2225 
	`vÏpic_EOI_£t
(
	`vıu_vÏpic
(
cu¼’t
));

2230 
	}
}

2232 
asmlškage
 
	$vmx_vmex™_hªdËr
(
ıu_u£r_»gs
 *
»gs
)

2234 
ex™_»asÚ
, 
idtv_šfo
, 
šŒ_šfo
 = 0, 
veùÜ
 = 0;

2235 
ex™_qu®ifiÿtiÚ
, 
š¡_Ën
 = 0;

2236 
vıu
 *
v
 = 
cu¼’t
;

2238 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
è&& 
	`hvm_·gšg_’abËd
(v) )

2239 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3] = v->¬ch.hvm_vıu.
hw_ü
[3] =

2240 
	`__vm»ad
(
GUEST_CR3
);

2242 
ex™_»asÚ
 = 
	`__vm»ad
(
VM_EXIT_REASON
);

2244 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

2245 
	`HVMTRACE_ND
(
VMEXIT64
, 1 , 3, 
ex™_»asÚ
,

2246 (
ušt32_t
)
»gs
->
e
, (ušt32_t)((
ušt64_t
)regs->eip >> 32),

2249 
	`HVMTRACE_ND
(
VMEXIT
, 1 , 2, 
ex™_»asÚ
,

2250 (
ušt32_t
)
»gs
->
e
,

2253 
	`³rfc_šüa
(
vmex™s
, 
ex™_»asÚ
);

2256  (
ušt16_t
)
ex™_»asÚ
 )

2258 
EXIT_REASON_EXTERNAL_INTERRUPT
:

2259 
	`vmx_do_extšt
(
»gs
);

2261 
EXIT_REASON_EXCEPTION_NMI
:

2262 
šŒ_šfo
 = 
	`__vm»ad
(
VM_EXIT_INTR_INFO
);

2263 
	`BUG_ON
(!(
šŒ_šfo
 & 
INTR_INFO_VALID_MASK
));

2264 
veùÜ
 = 
šŒ_šfo
 & 
INTR_INFO_VECTOR_MASK
;

2265 iàĞ
veùÜ
 =ğ
TRAP_machše_check
 )

2266 
	`do_machše_check
(
»gs
);

2268 
EXIT_REASON_MCE_DURING_VMENTRY
:

2269 
	`do_machše_check
(
»gs
);

2274 
	`loÿl_œq_’abË
();

2276 iàĞ
	`uÆik–y
(
ex™_»asÚ
 & 
VMX_EXIT_REASONS_FAILED_VMENTRY
) )

2277  
	`vmx_çed_vm’Œy
(
ex™_»asÚ
, 
»gs
);

2279 iàĞ
v
->
¬ch
.
hvm_vmx
.
vmx_»®mode
 )

2282 
»gs
->
eæags
 &ğ~(
X86_EFLAGS_VM
 | 
X86_EFLAGS_IOPL
);

2283 
»gs
->
eæags
 |ğ(
v
->
¬ch
.
hvm_vmx
.
vm86_§ved_eæags
 & 
X86_EFLAGS_IOPL
);

2287  
ex™_»asÚ
 )

2289 
EXIT_REASON_EXCEPTION_NMI
:

2290 iàĞ
veùÜ
 !ğ
TRAP_·ge_çuÉ


2291 && 
veùÜ
 !ğ
TRAP_nmi


2292 && 
veùÜ
 !ğ
TRAP_machše_check
 )

2294 
	`³rfc_šü
(
»®mode_ex™s
);

2295 
v
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 = 1;

2298 
EXIT_REASON_EXTERNAL_INTERRUPT
:

2299 
EXIT_REASON_INIT
:

2300 
EXIT_REASON_SIPI
:

2301 
EXIT_REASON_PENDING_VIRT_INTR
:

2302 
EXIT_REASON_PENDING_VIRT_NMI
:

2303 
EXIT_REASON_MCE_DURING_VMENTRY
:

2304 
EXIT_REASON_GETSEC
:

2305 
EXIT_REASON_ACCESS_GDTR_OR_IDTR
:

2306 
EXIT_REASON_ACCESS_LDTR_OR_TR
:

2307 
EXIT_REASON_VMX_PREEMPTION_TIMER_EXPIRED
:

2308 
EXIT_REASON_INVEPT
:

2309 
EXIT_REASON_INVVPID
:

2313 
v
->
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
 = 1;

2314 
	`³rfc_šü
(
»®mode_ex™s
);

2319 
	`hvm_maybe_d—s£¹_evtchn_œq
();

2322 
idtv_šfo
 = 
	`__vm»ad
(
IDT_VECTORING_INFO
);

2323 iàĞ
	`uÆik–y
(
idtv_šfo
 & 
INTR_INFO_VALID_MASK
) &&

2324 (
ex™_»asÚ
 !ğ
EXIT_REASON_TASK_SWITCH
) )

2326 iàĞ
	`hvm_ev’t_Ãeds_»šjeùiÚ
((
idtv_šfo
>>8)&7, idtv_info&0xff) )

2329 
	`__vmwr™e
(
VM_ENTRY_INTR_INFO
,

2330 
idtv_šfo
 & ~
INTR_INFO_RESVD_BITS_MASK
);

2331 iàĞ
idtv_šfo
 & 
INTR_INFO_DELIVER_CODE_MASK
 )

2332 
	`__vmwr™e
(
VM_ENTRY_EXCEPTION_ERROR_CODE
,

2333 
	`__vm»ad
(
IDT_VECTORING_ERROR_CODE
));

2340 iàĞ(
idtv_šfo
 & 
INTR_INFO_INTR_TYPE_MASK
è=ğ(
X86_EVENTTYPE_NMI
<<8) )

2341 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
,

2342 
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
) &

2343 ~
VMX_INTR_SHADOW_NMI
);

2346  
ex™_»asÚ
 )

2348 
EXIT_REASON_EXCEPTION_NMI
:

2361 iàĞ
	`uÆik–y
(
šŒ_šfo
 & 
INTR_INFO_NMI_UNBLOCKED_BY_IRET
) &&

2362 !(
idtv_šfo
 & 
INTR_INFO_VALID_MASK
) &&

2363 (
veùÜ
 !ğ
TRAP_doubË_çuÉ
) )

2364 
	`__vmwr™e
(
GUEST_INTERRUPTIBILITY_INFO
,

2365 
	`__vm»ad
(
GUEST_INTERRUPTIBILITY_INFO
)

2366 | 
VMX_INTR_SHADOW_NMI
);

2368 
	`³rfc_šüa
(
ÿu£_veùÜ
, 
veùÜ
);

2370  
veùÜ
 )

2372 
TRAP_debug
:

2377 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2378 
	`wr™e_debug»g
(6, 
ex™_qu®ifiÿtiÚ
 | 0xffff0ff0);

2379 iàĞ!
v
->
domaš
->
debugg”_©ched
 || 
ıu_has_mÚ™Ü_Œ­_æag
 )

2380 
ex™_ªd_üash
;

2381 
	`domaš_·u£_fÜ_debugg”
();

2383 
TRAP_št3
:

2385 iàĞ
v
->
domaš
->
debugg”_©ched
 )

2387 
	`upd©e_gue¡_e
();

2388 
cu¼’t
->
¬ch
.
gdbsx_vıu_ev’t
 = 
TRAP_št3
;

2389 
	`domaš_·u£_fÜ_debugg”
();

2393 
hªdËd
 = 
	`hvm_memÜy_ev’t_št3
(
»gs
->
e
);

2395 iàĞ
hªdËd
 < 0 )

2397 
	`vmx_šjeù_exû±iÚ
(
TRAP_št3
, 
HVM_DELIVER_NO_ERROR_CODE
, 0);

2400 iàĞ
hªdËd
 )

2404 
ex™_ªd_üash
;

2406 
TRAP_no_deviû
:

2407 
	`vmx_åu_dœty_š‹rû±
();

2409 
TRAP_·ge_çuÉ
:

2410 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2411 
»gs
->
”rÜ_code
 = 
	`__vm»ad
(
VM_EXIT_INTR_ERROR_CODE
);

2413 
	`HVM_DBG_LOG
(
DBG_LEVEL_VMMU
,

2415 ()
»gs
->
—x
, (ìegs->
ebx
,

2416 ()
»gs
->
ecx
, (ìegs->
edx
,

2417 ()
»gs
->
esi
, (ìegs->
edi
);

2419 iàĞ
	`·gšg_çuÉ
(
ex™_qu®ifiÿtiÚ
, 
»gs
) )

2421 iàĞ
	`Œaû_wl_Œaû_ev’t
(
TRC_SHADOW
) )

2423 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

2424 
	`HVMTRACE_LONG_2D
(
PF_XEN
, 
»gs
->
”rÜ_code
,

2425 
	`TRC_PAR_LONG
(
ex™_qu®ifiÿtiÚ
) );

2427 
	`HVMTRACE_2D
(
PF_XEN
,

2428 
»gs
->
”rÜ_code
, 
ex™_qu®ifiÿtiÚ
 );

2432 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2] = 
ex™_qu®ifiÿtiÚ
;

2433 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_·ge_çuÉ
, 
»gs
->
”rÜ_code
);

2435 
TRAP_nmi
:

2436 iàĞ(
šŒ_šfo
 & 
INTR_INFO_INTR_TYPE_MASK
) !=

2437 (
X86_EVENTTYPE_NMI
 << 8) )

2438 
ex™_ªd_üash
;

2439 
	`HVMTRACE_0D
(
NMI
);

2440 
	`£lf_nmi
();

2442 
TRAP_machše_check
:

2443 
	`HVMTRACE_0D
(
MCE
);

2446 
TRAP_šv®id_İ
:

2447 
	`vmx_vmex™_ud_š‹rû±
(
»gs
);

2450 
ex™_ªd_üash
;

2454 
EXIT_REASON_EXTERNAL_INTERRUPT
:

2457 
EXIT_REASON_TRIPLE_FAULT
:

2458 
	`hvm_ŒË_çuÉ
();

2460 
EXIT_REASON_PENDING_VIRT_INTR
:

2462 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_VIRTUAL_INTR_PENDING
;

2463 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

2465 
EXIT_REASON_PENDING_VIRT_NMI
:

2467 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_VIRTUAL_NMI_PENDING
;

2468 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

2470 
EXIT_REASON_TASK_SWITCH
: {

2471 cÚ¡ 
hvm_sk_sw™ch_»asÚ
 
»asÚs
[] = {

2472 
TSW_ÿÎ_Ü_št
, 
TSW_œ‘
, 
TSW_jmp
, TSW_call_or_int };

2473 
št32_t
 
ecode
 = -1, 
sourû
;

2474 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2475 
sourû
 = (
ex™_qu®ifiÿtiÚ
 >> 30) & 3;

2477 
	`WARN_ON
((
sourû
 =ğ3è&& !(
idtv_šfo
 & 
INTR_INFO_VALID_MASK
));

2483 
š¡_Ën
 = ((
sourû
 != 3) ||

2484 (
idtv_šfo
 & (1u<<10)))

2485 ? 
	`g‘_š¡ruùiÚ_Ëngth
() : 0;

2486 iàĞ(
sourû
 =ğ3è&& (
idtv_šfo
 & 
INTR_INFO_DELIVER_CODE_MASK
) )

2487 
ecode
 = 
	`__vm»ad
(
IDT_VECTORING_ERROR_CODE
);

2488 
»gs
->
e
 +ğ
š¡_Ën
;

2489 
	`hvm_sk_sw™ch
((
ušt16_t
)
ex™_qu®ifiÿtiÚ
, 
»asÚs
[
sourû
], 
ecode
);

2492 
EXIT_REASON_CPUID
:

2493 
	`upd©e_gue¡_e
();

2494 
	`vmx_do_ıuid
(
»gs
);

2496 
EXIT_REASON_HLT
:

2497 
	`upd©e_gue¡_e
();

2498 
	`hvm_hÉ
(
»gs
->
eæags
);

2500 
EXIT_REASON_INVLPG
:

2501 
	`upd©e_gue¡_e
();

2502 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2503 
	`vmx_švÍg_š‹rû±
(
ex™_qu®ifiÿtiÚ
);

2505 
EXIT_REASON_RDTSCP
:

2506 
»gs
->
ecx
 = 
	`hvm_m¤_tsc_aux
(
v
);

2508 
EXIT_REASON_RDTSC
:

2509 
	`upd©e_gue¡_e
();

2510 
	`hvm_rdtsc_š‹rû±
(
»gs
);

2512 
EXIT_REASON_VMCALL
:

2514 
rc
;

2515 
	`HVMTRACE_1D
(
VMMCALL
, 
»gs
->
—x
);

2516 
rc
 = 
	`hvm_do_hy³rÿÎ
(
»gs
);

2517 iàĞ
rc
 !ğ
HVM_HCALL_´“m±ed
 )

2519 
	`upd©e_gue¡_e
();

2520 iàĞ
rc
 =ğ
HVM_HCALL_šv®id©e
 )

2521 
	`£nd_šv®id©e_»q
();

2525 
EXIT_REASON_CR_ACCESS
:

2527 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2528 iàĞ
	`vmx_ü_acûss
(
ex™_qu®ifiÿtiÚ
, 
»gs
) )

2529 
	`upd©e_gue¡_e
();

2532 
EXIT_REASON_DR_ACCESS
:

2533 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2534 
	`vmx_dr_acûss
(
ex™_qu®ifiÿtiÚ
, 
»gs
);

2536 
EXIT_REASON_MSR_READ
:

2538 
ušt64_t
 
m¤_cÚ‹Á
;

2539 iàĞ
	`hvm_m¤_»ad_š‹rû±
(
»gs
->
ecx
, &
m¤_cÚ‹Á
è=ğ
X86EMUL_OKAY
 )

2541 
»gs
->
—x
 = (
ušt32_t
)
m¤_cÚ‹Á
;

2542 
»gs
->
edx
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

2543 
	`upd©e_gue¡_e
();

2547 
EXIT_REASON_MSR_WRITE
:

2549 
ušt64_t
 
m¤_cÚ‹Á
;

2550 
m¤_cÚ‹Á
 = ((
ušt64_t
)
»gs
->
edx
 << 32è| (
ušt32_t
ìegs->
—x
;

2551 iàĞ
	`hvm_m¤_wr™e_š‹rû±
(
»gs
->
ecx
, 
m¤_cÚ‹Á
è=ğ
X86EMUL_OKAY
 )

2552 
	`upd©e_gue¡_e
();

2556 
EXIT_REASON_MWAIT_INSTRUCTION
:

2557 
EXIT_REASON_MONITOR_INSTRUCTION
:

2558 
EXIT_REASON_VMCLEAR
:

2559 
EXIT_REASON_VMLAUNCH
:

2560 
EXIT_REASON_VMPTRLD
:

2561 
EXIT_REASON_VMPTRST
:

2562 
EXIT_REASON_VMREAD
:

2563 
EXIT_REASON_VMRESUME
:

2564 
EXIT_REASON_VMWRITE
:

2565 
EXIT_REASON_VMXOFF
:

2566 
EXIT_REASON_VMXON
:

2567 
EXIT_REASON_GETSEC
:

2568 
EXIT_REASON_INVEPT
:

2569 
EXIT_REASON_INVVPID
:

2575 
	`WARN_ON
(
ex™_»asÚ
 =ğ
EXIT_REASON_GETSEC
);

2576 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_šv®id_İ
, 
HVM_DELIVER_NO_ERROR_CODE
);

2579 
EXIT_REASON_TPR_BELOW_THRESHOLD
:

2582 
EXIT_REASON_APIC_ACCESS
:

2583 iàĞ!
	`vmx_hªdË_eoi_wr™e
(è&& !
	`hªdË_mmio
() )

2584 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

2587 
EXIT_REASON_IO_INSTRUCTION
:

2588 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2589 iàĞ
ex™_qu®ifiÿtiÚ
 & 0x10 )

2592 iàĞ!
	`hªdË_mmio
() )

2593 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

2598 
ušt16_t
 
pÜt
 = (
ex™_qu®ifiÿtiÚ
 >> 16) & 0xFFFF;

2599 
by‹s
 = (
ex™_qu®ifiÿtiÚ
 & 0x07) + 1;

2600 
dœ
 = (
ex™_qu®ifiÿtiÚ
 & 0x08è? 
IOREQ_READ
 : 
IOREQ_WRITE
;

2601 iàĞ
	`hªdË_pio
(
pÜt
, 
by‹s
, 
dœ
) )

2602 
	`upd©e_gue¡_e
();

2606 
EXIT_REASON_INVD
:

2607 
EXIT_REASON_WBINVD
:

2609 
	`upd©e_gue¡_e
();

2610 
	`vmx_wbšvd_š‹rû±
();

2614 
EXIT_REASON_EPT_VIOLATION
:

2616 
·ddr_t
 
g·
 = 
	`__vm»ad
(
GUEST_PHYSICAL_ADDRESS
);

2617 #ifdeà
__i386__


2618 
g·
 |ğ(
·ddr_t
)
	`__vm»ad
(
GUEST_PHYSICAL_ADDRESS_HIGH
) << 32;

2620 
ex™_qu®ifiÿtiÚ
 = 
	`__vm»ad
(
EXIT_QUALIFICATION
);

2621 
	`•t_hªdË_viŞ©iÚ
(
ex™_qu®ifiÿtiÚ
, 
g·
);

2625 
EXIT_REASON_MONITOR_TRAP_FLAG
:

2626 
v
->
¬ch
.
hvm_vmx
.
exec_cÚŒŞ
 &ğ~
CPU_BASED_MONITOR_TRAP_FLAG
;

2627 
	`vmx_upd©e_ıu_exec_cÚŒŞ
(
v
);

2628 iàĞ
v
->
¬ch
.
hvm_vıu
.
sšgË_¡•
 ) {

2629 
	`hvm_memÜy_ev’t_sšgË_¡•
(
»gs
->
e
);

2630 iàĞ
v
->
domaš
->
debugg”_©ched
 )

2631 
	`domaš_·u£_fÜ_debugg”
();

2636 
EXIT_REASON_PAUSE_INSTRUCTION
:

2637 
	`³rfc_šü
(
·u£loİ_ex™s
);

2638 
	`do_sched_İ_com·t
(
SCHEDOP_y›ld
, 0);

2641 
EXIT_REASON_XSETBV
:

2643 
u64
 
Ãw_bv
 = (((u64)
»gs
->
edx
è<< 32è|„egs->
—x
;

2644 iàĞ
	`hvm_hªdË_x£tbv
(
Ãw_bv
) == 0 )

2645 
	`upd©e_gue¡_e
();

2649 
EXIT_REASON_ACCESS_GDTR_OR_IDTR
:

2650 
EXIT_REASON_ACCESS_LDTR_OR_TR
:

2651 
EXIT_REASON_VMX_PREEMPTION_TIMER_EXPIRED
:

2654 
ex™_ªd_üash
:

2655 
	`gd´štk
(
XENLOG_ERR
, "Bad vmex™ (»asÚ %x)\n", 
ex™_»asÚ
);

2656 
	`domaš_üash
(
v
->
domaš
);

2659 
	}
}

2661 
asmlškage
 
	$vmx_vm’‹r_h–³r
()

2663 
vıu
 *
cu¼
 = 
cu¼’t
;

2664 
u32
 
Ãw_asid
, 
Şd_asid
;

2665 
boŞ_t
 
Ãed_æush
;

2667 iàĞ!
ıu_has_vmx_vpid
 )

2668 
out
;

2670 
Şd_asid
 = 
cu¼
->
¬ch
.
hvm_vıu
.
asid
;

2671 
Ãed_æush
 = 
	`hvm_asid_hªdË_vm’‹r
();

2672 
Ãw_asid
 = 
cu¼
->
¬ch
.
hvm_vıu
.
asid
;

2674 iàĞ
	`uÆik–y
(
Ãw_asid
 !ğ
Şd_asid
) )

2676 
	`__vmwr™e
(
VIRTUAL_PROCESSOR_ID
, 
Ãw_asid
);

2677 iàĞ!
Şd_asid
 && 
Ãw_asid
 )

2680 
cu¼
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 |=

2681 
SECONDARY_EXEC_ENABLE_VPID
;

2682 
	`vmx_upd©e_£cÚd¬y_exec_cÚŒŞ
(
cu¼
);

2684 iàĞ
Şd_asid
 && !
Ãw_asid
 )

2687 
cu¼
->
¬ch
.
hvm_vmx
.
£cÚd¬y_exec_cÚŒŞ
 &=

2688 ~
SECONDARY_EXEC_ENABLE_VPID
;

2689 
	`vmx_upd©e_£cÚd¬y_exec_cÚŒŞ
(
cu¼
);

2693 iàĞ
	`uÆik–y
(
Ãed_æush
) )

2694 
	`vpid_sync_®l
();

2696 
out
:

2697 
	`HVMTRACE_ND
 (
VMENTRY
, 1 , 0, 0, 0, 0, 0, 0, 0);

2698 
	}
}

	@hvm/vmx/vpmu_core2.c

22 
	~<x’/cÚfig.h
>

23 
	~<x’/sched.h
>

24 
	~<asm/sy¡em.h
>

25 
	~<asm/»gs.h
>

26 
	~<asm/ty³s.h
>

27 
	~<asm/­ic.h
>

28 
	~<asm/m¤.h
>

29 
	~<asm/m¤-šdex.h
>

30 
	~<asm/hvm/suµÜt.h
>

31 
	~<asm/hvm/vÏpic.h
>

32 
	~<asm/hvm/vmx/vmx.h
>

33 
	~<asm/hvm/vmx/vmcs.h
>

34 
	~<public/sched.h
>

35 
	~<public/hvm/§ve.h
>

36 
	~<asm/hvm/vpmu.h
>

37 
	~<asm/hvm/vmx/vpmu_cÜe2.h
>

50 
boŞ_t
 
__»ad_mo¡ly
 
	gis_pmc_quœk
;

52 
	$check_pmc_quœk
()

54 
u8
 
çmy
 = 
cu¼’t_ıu_d©a
.
x86
;

55 
u8
 
ıu_mod–
 = 
cu¼’t_ıu_d©a
.
x86_mod–
;

56 
is_pmc_quœk
 = 0;

57 iàĞ
çmy
 == 6 )

59 iàĞ
ıu_mod–
 == 46 || cpu_model == 26 )

60 
is_pmc_quœk
 = 1;

62 
	}
}

64 
cÜe2_g‘_pmc_couÁ
();

65 
	$hªdË_pmc_quœk
(
u64
 
m¤_cÚ‹Á
)

67 
num_g’_pmc
 = 
	`cÜe2_g‘_pmc_couÁ
();

68 
num_fix_pmc
 = 3;

69 
i
;

70 
u64
 
v®
;

72 iàĞ!
is_pmc_quœk
 )

75 
v®
 = 
m¤_cÚ‹Á
;

76  
i
 = 0; i < 
num_g’_pmc
; i++ )

78 iàĞ
v®
 & 0x1 )

80 
u64
 
út
;

81 
	`rdm¤l
(
MSR_P6_PERFCTR0
 + 
i
, 
út
);

82 iàĞ
út
 == 0 )

83 
	`wrm¤l
(
MSR_P6_PERFCTR0
 + 
i
, 1);

85 
v®
 >>= 1;

87 
v®
 = 
m¤_cÚ‹Á
 >> 32;

88  
i
 = 0; i < 
num_fix_pmc
; i++ )

90 iàĞ
v®
 & 0x1 )

92 
u64
 
út
;

93 
	`rdm¤l
(
MSR_CORE_PERF_FIXED_CTR0
 + 
i
, 
út
);

94 iàĞ
út
 == 0 )

95 
	`wrm¤l
(
MSR_CORE_PERF_FIXED_CTR0
 + 
i
, 1);

97 
v®
 >>= 1;

99 
	}
}

101 
u32
 
	gcÜe2_couÁ”s_m¤
[] = {

102 
MSR_CORE_PERF_FIXED_CTR0
,

103 
MSR_CORE_PERF_FIXED_CTR1
,

104 
MSR_CORE_PERF_FIXED_CTR2
};

107 
u32
 
	gcÜe2_ù¾s_m¤
[] = {

108 
MSR_CORE_PERF_FIXED_CTR_CTRL
,

109 
MSR_IA32_PEBS_ENABLE
,

110 
MSR_IA32_DS_AREA
};

112 
pmum¤
 
	gcÜe2_couÁ”s
 = {

114 
cÜe2_couÁ”s_m¤


117 
pmum¤
 
	gcÜe2_ù¾s
 = {

119 
cÜe2_ù¾s_m¤


121 
	g¬ch_pmc_út
;

123 
	$cÜe2_g‘_pmc_couÁ
()

125 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

127 iàĞ
¬ch_pmc_út
 == 0 )

129 
	`ıuid
(0xa, &
—x
, &
ebx
, &
ecx
, &
edx
);

130 
¬ch_pmc_út
 = (
—x
 & 0xff00) >> 8;

133  
¬ch_pmc_út
;

134 
	}
}

136 
u64
 
	$cÜe2_ÿlc_štŸl_glb_ù¾_m¤
()

138 
¬ch_pmc_b™s
 = (1 << 
	`cÜe2_g‘_pmc_couÁ
()) - 1;

139 
u64
 
fix_pmc_b™s
 = (1 << 3) - 1;

140  ((
fix_pmc_b™s
 << 32è| 
¬ch_pmc_b™s
);

141 
	}
}

144 
	$cÜe2_g‘_b™width_fix_couÁ
()

146 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

147 
	`ıuid
(0xa, &
—x
, &
ebx
, &
ecx
, &
edx
);

148  ((
edx
 & 0x1fe0) >> 5);

149 
	}
}

151 
	$is_cÜe2_vpmu_m¤
(
u32
 
m¤_šdex
, *
ty³
, *
šdex
)

153 
i
;

155  
i
 = 0; i < 
cÜe2_couÁ”s
.
num
; i++ )

157 iàĞ
cÜe2_couÁ”s
.
m¤
[
i
] =ğ
m¤_šdex
 )

159 *
ty³
 = 
MSR_TYPE_COUNTER
;

160 *
šdex
 = 
i
;

165  
i
 = 0; i < 
cÜe2_ù¾s
.
num
; i++ )

167 iàĞ
cÜe2_ù¾s
.
m¤
[
i
] =ğ
m¤_šdex
 )

169 *
ty³
 = 
MSR_TYPE_CTRL
;

170 *
šdex
 = 
i
;

175 iàĞ(
m¤_šdex
 =ğ
MSR_CORE_PERF_GLOBAL_CTRL
) ||

176 (
m¤_šdex
 =ğ
MSR_CORE_PERF_GLOBAL_STATUS
) ||

177 (
m¤_šdex
 =ğ
MSR_CORE_PERF_GLOBAL_OVF_CTRL
) )

179 *
ty³
 = 
MSR_TYPE_GLOBAL
;

183 iàĞ(
m¤_šdex
 >ğ
MSR_IA32_PERFCTR0
) &&

184 (
m¤_šdex
 < (
MSR_IA32_PERFCTR0
 + 
	`cÜe2_g‘_pmc_couÁ
())) )

186 *
ty³
 = 
MSR_TYPE_ARCH_COUNTER
;

187 *
šdex
 = 
m¤_šdex
 - 
MSR_IA32_PERFCTR0
;

191 iàĞ(
m¤_šdex
 >ğ
MSR_P6_EVNTSEL0
) &&

192 (
m¤_šdex
 < (
MSR_P6_EVNTSEL0
 + 
	`cÜe2_g‘_pmc_couÁ
())) )

194 *
ty³
 = 
MSR_TYPE_ARCH_CTRL
;

195 *
šdex
 = 
m¤_šdex
 - 
MSR_P6_EVNTSEL0
;

200 
	}
}

202 
	$cÜe2_vpmu_£t_m¤_b™m­
(*
m¤_b™m­
)

204 
i
;

207  
i
 = 0; i < 
cÜe2_couÁ”s
.
num
; i++ )

209 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
cÜe2_couÁ”s
.
m¤
[
i
]), 
m¤_b™m­
);

210 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
cÜe2_couÁ”s
.
m¤
[
i
]),

211 
m¤_b™m­
 + 0x800/
BYTES_PER_LONG
);

213  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

215 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
MSR_IA32_PERFCTR0
+
i
), 
m¤_b™m­
);

216 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
MSR_IA32_PERFCTR0
+
i
),

217 
m¤_b™m­
 + 0x800/
BYTES_PER_LONG
);

221  
i
 = 0; i < 
cÜe2_ù¾s
.
num
; i++ )

222 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
cÜe2_ù¾s
.
m¤
[
i
]), 
m¤_b™m­
);

223  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

224 
	`ş—r_b™
(
	`m¤addr_to_b™pos
(
MSR_P6_EVNTSEL0
+
i
), 
m¤_b™m­
);

225 
	}
}

227 
	$cÜe2_vpmu_un£t_m¤_b™m­
(*
m¤_b™m­
)

229 
i
;

231  
i
 = 0; i < 
cÜe2_couÁ”s
.
num
; i++ )

233 
	`£t_b™
(
	`m¤addr_to_b™pos
(
cÜe2_couÁ”s
.
m¤
[
i
]), 
m¤_b™m­
);

234 
	`£t_b™
(
	`m¤addr_to_b™pos
(
cÜe2_couÁ”s
.
m¤
[
i
]),

235 
m¤_b™m­
 + 0x800/
BYTES_PER_LONG
);

237  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

239 
	`£t_b™
(
	`m¤addr_to_b™pos
(
MSR_IA32_PERFCTR0
+
i
), 
m¤_b™m­
);

240 
	`£t_b™
(
	`m¤addr_to_b™pos
(
MSR_IA32_PERFCTR0
+
i
),

241 
m¤_b™m­
 + 0x800/
BYTES_PER_LONG
);

243  
i
 = 0; i < 
cÜe2_ù¾s
.
num
; i++ )

244 
	`£t_b™
(
	`m¤addr_to_b™pos
(
cÜe2_ù¾s
.
m¤
[
i
]), 
m¤_b™m­
);

245  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

246 
	`£t_b™
(
	`m¤addr_to_b™pos
(
MSR_P6_EVNTSEL0
+
i
), 
m¤_b™m­
);

247 
	}
}

249 
šlše
 
	$__cÜe2_vpmu_§ve
(
vıu
 *
v
)

251 
i
;

252 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
	`vıu_vpmu
(
v
)->
cÚ‹xt
;

254  
i
 = 0; i < 
cÜe2_couÁ”s
.
num
; i++ )

255 
	`rdm¤l
(
cÜe2_couÁ”s
.
m¤
[
i
], 
cÜe2_vpmu_cxt
->
couÁ”s
[i]);

256  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

257 
	`rdm¤l
(
MSR_IA32_PERFCTR0
+
i
, 
cÜe2_vpmu_cxt
->
¬ch_m¤_·œ
[i].
couÁ”
);

258 
cÜe2_vpmu_cxt
->
hw_Ïpic_lvc
 = 
	`­ic_»ad
(
APIC_LVTPC
);

259 
	`­ic_wr™e
(
APIC_LVTPC
, 
PMU_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

260 
	}
}

262 
	$cÜe2_vpmu_§ve
(
vıu
 *
v
)

264 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

266 iàĞ!((
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) &&

267 (
vpmu
->
æags
 & 
VPMU_CONTEXT_LOADED
)) )

270 
	`__cÜe2_vpmu_§ve
(
v
);

273 iàĞ!(
vpmu
->
æags
 & 
VPMU_RUNNING
è&& 
ıu_has_vmx_m¤_b™m­
 )

274 
	`cÜe2_vpmu_un£t_m¤_b™m­
(
v
->
¬ch
.
hvm_vmx
.
m¤_b™m­
);

276 
vpmu
->
æags
 &ğ~
VPMU_CONTEXT_LOADED
;

278 
	}
}

280 
šlše
 
	$__cÜe2_vpmu_lßd
(
vıu
 *
v
)

282 
i
;

283 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
	`vıu_vpmu
(
v
)->
cÚ‹xt
;

285  
i
 = 0; i < 
cÜe2_couÁ”s
.
num
; i++ )

286 
	`wrm¤l
(
cÜe2_couÁ”s
.
m¤
[
i
], 
cÜe2_vpmu_cxt
->
couÁ”s
[i]);

287  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

288 
	`wrm¤l
(
MSR_IA32_PERFCTR0
+
i
, 
cÜe2_vpmu_cxt
->
¬ch_m¤_·œ
[i].
couÁ”
);

290  
i
 = 0; i < 
cÜe2_ù¾s
.
num
; i++ )

291 
	`wrm¤l
(
cÜe2_ù¾s
.
m¤
[
i
], 
cÜe2_vpmu_cxt
->
ù¾s
[i]);

292  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

293 
	`wrm¤l
(
MSR_P6_EVNTSEL0
+
i
, 
cÜe2_vpmu_cxt
->
¬ch_m¤_·œ
[i].
cÚŒŞ
);

295 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
cÜe2_vpmu_cxt
->
hw_Ïpic_lvc
);

296 
	}
}

298 
	$cÜe2_vpmu_lßd
(
vıu
 *
v
)

300 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

303 iàĞ!((
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) &&

304 (
vpmu
->
æags
 & 
VPMU_RUNNING
)) )

306 
	`__cÜe2_vpmu_lßd
(
v
);

307 
vpmu
->
æags
 |ğ
VPMU_CONTEXT_LOADED
;

308 
	}
}

310 
	$cÜe2_vpmu_®loc_»sourû
(
vıu
 *
v
)

312 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

313 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
;

314 
cÜe2_pmu_’abË
 *
pmu_’abË
;

316 iàĞ!
	`acquœe_pmu_owÃrsh
(
PMU_OWNER_HVM
) )

319 
	`wrm¤l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 0);

320 iàĞ
	`vmx_add_ho¡_lßd_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
) )

323 iàĞ
	`vmx_add_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
) )

325 
	`vmx_wr™e_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
,

326 
	`cÜe2_ÿlc_štŸl_glb_ù¾_m¤
());

328 
pmu_’abË
 = 
	`xm®loc_by‹s
((
cÜe2_pmu_’abË
) +

329 (
	`cÜe2_g‘_pmc_couÁ
()-1)*());

330 iàĞ!
pmu_’abË
 )

331 
out1
;

332 
	`mem£t
(
pmu_’abË
, 0, (
cÜe2_pmu_’abË
) +

333 (
	`cÜe2_g‘_pmc_couÁ
()-1)*());

335 
cÜe2_vpmu_cxt
 = 
	`xm®loc_by‹s
((
cÜe2_vpmu_cÚ‹xt
) +

336 (
	`cÜe2_g‘_pmc_couÁ
()-1)*(
¬ch_m¤_·œ
));

337 iàĞ!
cÜe2_vpmu_cxt
 )

338 
out2
;

339 
	`mem£t
(
cÜe2_vpmu_cxt
, 0, (
cÜe2_vpmu_cÚ‹xt
) +

340 (
	`cÜe2_g‘_pmc_couÁ
()-1)*(
¬ch_m¤_·œ
));

341 
cÜe2_vpmu_cxt
->
pmu_’abË
 =…mu_enable;

342 
vpmu
->
cÚ‹xt
 = (*)
cÜe2_vpmu_cxt
;

345 
out2
:

346 
	`xä“
(
pmu_’abË
);

347 
out1
:

348 
	`gd´štk
(
XENLOG_WARNING
, "Insufficient memory for PMU, PMU feature is "

350 
v
->
vıu_id
, v->
domaš
->
domaš_id
);

352 
	}
}

354 
	$cÜe2_vpmu_§ve_m¤_cÚ‹xt
(
vıu
 *
v
, 
ty³
,

355 
šdex
, 
u64
 
m¤_d©a
)

357 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
	`vıu_vpmu
(
v
)->
cÚ‹xt
;

359  
ty³
 )

361 
MSR_TYPE_CTRL
:

362 
cÜe2_vpmu_cxt
->
ù¾s
[
šdex
] = 
m¤_d©a
;

364 
MSR_TYPE_ARCH_CTRL
:

365 
cÜe2_vpmu_cxt
->
¬ch_m¤_·œ
[
šdex
].
cÚŒŞ
 = 
m¤_d©a
;

368 
	}
}

370 
	$cÜe2_vpmu_m¤_commÚ_check
(
u32
 
m¤_šdex
, *
ty³
, *
šdex
)

372 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
cu¼’t
);

374 iàĞ!
	`is_cÜe2_vpmu_m¤
(
m¤_šdex
, 
ty³
, 
šdex
) )

377 iàĞ
	`uÆik–y
(!(
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
)) &&

378 (
vpmu
->
cÚ‹xt
 !ğ
NULL
 ||

379 !
	`cÜe2_vpmu_®loc_»sourû
(
cu¼’t
)) )

381 
vpmu
->
æags
 |ğ
VPMU_CONTEXT_ALLOCATED
;

384 iàĞ!(
vpmu
->
æags
 & 
VPMU_CONTEXT_LOADED
) )

386 
	`__cÜe2_vpmu_lßd
(
cu¼’t
);

387 
vpmu
->
æags
 |ğ
VPMU_CONTEXT_LOADED
;

388 iàĞ
ıu_has_vmx_m¤_b™m­
 )

389 
	`cÜe2_vpmu_£t_m¤_b™m­
(
cu¼’t
->
¬ch
.
hvm_vmx
.
m¤_b™m­
);

392 
	}
}

394 
	$cÜe2_vpmu_do_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

396 
u64
 
glob®_ù¾
, 
nÚ_glob®_ù¾
;

397 
pmu_’abË
 = 0;

398 
i
, 
tmp
;

399 
ty³
 = -1, 
šdex
 = -1;

400 
vıu
 *
v
 = 
cu¼’t
;

401 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

402 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
NULL
;

404 iàĞ!
	`cÜe2_vpmu_m¤_commÚ_check
(
m¤
, &
ty³
, &
šdex
) )

407 
cÜe2_vpmu_cxt
 = 
vpmu
->
cÚ‹xt
;

408  
m¤
 )

410 
MSR_CORE_PERF_GLOBAL_OVF_CTRL
:

411 
cÜe2_vpmu_cxt
->
glob®_ovf_¡©us
 &ğ~
m¤_cÚ‹Á
;

413 
MSR_CORE_PERF_GLOBAL_STATUS
:

414 
	`gd´štk
(
XENLOG_INFO
, "Can‚ot write„eadonly MSR: "

416 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

418 
MSR_IA32_PEBS_ENABLE
:

419 iàĞ
m¤_cÚ‹Á
 & 1 )

420 
	`gd´štk
(
XENLOG_WARNING
, "Guest isryingoƒnable PEBS, "

423 
MSR_IA32_DS_AREA
:

424 
	`gd´štk
(
XENLOG_WARNING
, "Guest setting of DTS is ignored.\n");

426 
MSR_CORE_PERF_GLOBAL_CTRL
:

427 
glob®_ù¾
 = 
m¤_cÚ‹Á
;

428  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

430 
	`rdm¤l
(
MSR_P6_EVNTSEL0
+
i
, 
nÚ_glob®_ù¾
);

431 
cÜe2_vpmu_cxt
->
pmu_’abË
->
¬ch_pmc_’abË
[
i
] =

432 
glob®_ù¾
 & (
nÚ_glob®_ù¾
 >> 22) & 1;

433 
glob®_ù¾
 >>= 1;

436 
	`rdm¤l
(
MSR_CORE_PERF_FIXED_CTR_CTRL
, 
nÚ_glob®_ù¾
);

437 
glob®_ù¾
 = 
m¤_cÚ‹Á
 >> 32;

438  
i
 = 0; i < 3; i++ )

440 
cÜe2_vpmu_cxt
->
pmu_’abË
->
fixed_ùr_’abË
[
i
] =

441 (
glob®_ù¾
 & 1è& ((
nÚ_glob®_ù¾
 & 0x3)? 1: 0);

442 
nÚ_glob®_ù¾
 >>= 4;

443 
glob®_ù¾
 >>= 1;

446 
MSR_CORE_PERF_FIXED_CTR_CTRL
:

447 
nÚ_glob®_ù¾
 = 
m¤_cÚ‹Á
;

448 
	`vmx_»ad_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
, &
glob®_ù¾
);

449 
glob®_ù¾
 >>= 32;

450  
i
 = 0; i < 3; i++ )

452 
cÜe2_vpmu_cxt
->
pmu_’abË
->
fixed_ùr_’abË
[
i
] =

453 (
glob®_ù¾
 & 1è& ((
nÚ_glob®_ù¾
 & 0x3)? 1: 0);

454 
nÚ_glob®_ù¾
 >>= 4;

455 
glob®_ù¾
 >>= 1;

459 
tmp
 = 
m¤
 - 
MSR_P6_EVNTSEL0
;

460 
	`vmx_»ad_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
, &
glob®_ù¾
);

461 iàĞ
tmp
 >ğ0 &&m°< 
	`cÜe2_g‘_pmc_couÁ
() )

462 
cÜe2_vpmu_cxt
->
pmu_’abË
->
¬ch_pmc_’abË
[
tmp
] =

463 (
glob®_ù¾
 >> 
tmp
è& (
m¤_cÚ‹Á
 >> 22) & 1;

466  
i
 = 0; i < 3; i++ )

467 
pmu_’abË
 |ğ
cÜe2_vpmu_cxt
->pmu_’abË->
fixed_ùr_’abË
[
i
];

468  
i
 = 0; i < 
	`cÜe2_g‘_pmc_couÁ
(); i++ )

469 
pmu_’abË
 |ğ
cÜe2_vpmu_cxt
->pmu_’abË->
¬ch_pmc_’abË
[
i
];

470 iàĞ
pmu_’abË
 )

471 
vpmu
->
æags
 |ğ
VPMU_RUNNING
;

473 
vpmu
->
æags
 &ğ~
VPMU_RUNNING
;

476 iàĞ
vpmu
->
æags
 & 
VPMU_RUNNING
 &&

477 
	`is_vÏpic_lvc_’abËd
(
	`vıu_vÏpic
(
v
)) )

478 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
PMU_APIC_VECTOR
);

480 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
PMU_APIC_VECTOR
 | 
APIC_LVT_MASKED
);

482 
	`cÜe2_vpmu_§ve_m¤_cÚ‹xt
(
v
, 
ty³
, 
šdex
, 
m¤_cÚ‹Á
);

483 iàĞ
ty³
 !ğ
MSR_TYPE_GLOBAL
 )

485 
u64
 
mask
;

486 
šjeù_gp
 = 0;

487  
ty³
 )

489 
MSR_TYPE_ARCH_CTRL
:

490 
mask
 = ~((1ull << 32) - 1);

491 ià(
m¤_cÚ‹Á
 & 
mask
)

492 
šjeù_gp
 = 1;

494 
MSR_TYPE_CTRL
:

496 
mask
 = ~((1ull << (3 * 4)) - 1);

497 ià(
m¤_cÚ‹Á
 & 
mask
)

498 
šjeù_gp
 = 1;

500 
MSR_TYPE_COUNTER
:

501 
mask
 = ~((1uÎ << 
	`cÜe2_g‘_b™width_fix_couÁ
()) - 1);

502 ià(
m¤_cÚ‹Á
 & 
mask
)

503 
šjeù_gp
 = 1;

506 ià(
šjeù_gp
)

507 
	`vmx_šjeù_hw_exû±iÚ
(
TRAP_gp_çuÉ
, 0);

509 
	`wrm¤l
(
m¤
, 
m¤_cÚ‹Á
);

512 
	`vmx_wr™e_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
m¤_cÚ‹Á
);

515 
	}
}

517 
	$cÜe2_vpmu_do_rdm¤
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

519 
ty³
 = -1, 
šdex
 = -1;

520 
vıu
 *
v
 = 
cu¼’t
;

521 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

522 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
NULL
;

524 iàĞ!
	`cÜe2_vpmu_m¤_commÚ_check
(
m¤
, &
ty³
, &
šdex
) )

527 
cÜe2_vpmu_cxt
 = 
vpmu
->
cÚ‹xt
;

528  
m¤
 )

530 
MSR_CORE_PERF_GLOBAL_OVF_CTRL
:

531 *
m¤_cÚ‹Á
 = 0;

533 
MSR_CORE_PERF_GLOBAL_STATUS
:

534 *
m¤_cÚ‹Á
 = 
cÜe2_vpmu_cxt
->
glob®_ovf_¡©us
;

536 
MSR_CORE_PERF_GLOBAL_CTRL
:

537 
	`vmx_»ad_gue¡_m¤
(
MSR_CORE_PERF_GLOBAL_CTRL
, 
m¤_cÚ‹Á
);

540 
	`rdm¤l
(
m¤
, *
m¤_cÚ‹Á
);

544 
	}
}

546 
	$cÜe2_vpmu_do_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

548 
vıu
 *
v
 = 
cu¼’t
;

549 
u64
 
m¤_cÚ‹Á
;

550 
u32
 
vÏpic_lvc
;

551 
št_vec
;

552 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

553 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
vpmu
->
cÚ‹xt
;

554 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

556 
	`rdm¤l
(
MSR_CORE_PERF_GLOBAL_STATUS
, 
m¤_cÚ‹Á
);

557 iàĞ!
m¤_cÚ‹Á
 )

560 iàĞ
is_pmc_quœk
 )

561 
	`hªdË_pmc_quœk
(
m¤_cÚ‹Á
);

563 
cÜe2_vpmu_cxt
->
glob®_ovf_¡©us
 |ğ
m¤_cÚ‹Á
;

564 
m¤_cÚ‹Á
 = 0xC000000700000000 | ((1 << 
	`cÜe2_g‘_pmc_couÁ
()) - 1);

565 
	`wrm¤l
(
MSR_CORE_PERF_GLOBAL_OVF_CTRL
, 
m¤_cÚ‹Á
);

567 
	`­ic_wr™e_¬ound
(
APIC_LVTPC
, 
	`­ic_»ad
(APIC_LVTPCè& ~
APIC_LVT_MASKED
);

569 iàĞ!
	`is_vÏpic_lvc_’abËd
(
vÏpic
) )

572 
vÏpic_lvc
 = 
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTPC
);

573 
št_vec
 = 
vÏpic_lvc
 & 
APIC_VECTOR_MASK
;

574 
	`vÏpic_£t_»g
(
vÏpic
, 
APIC_LVTPC
, 
vÏpic_lvc
 | 
APIC_LVT_MASKED
);

575 iàĞ
	`GET_APIC_DELIVERY_MODE
(
vÏpic_lvc
è=ğ
APIC_MODE_FIXED
 )

576 
	`vÏpic_£t_œq
(
	`vıu_vÏpic
(
v
), 
št_vec
, 0);

578 
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
);

580 
	}
}

582 
	$cÜe2_vpmu_š™Ÿli£
(
vıu
 *
v
)

584 
	`check_pmc_quœk
();

585 
	}
}

587 
	$cÜe2_vpmu_de¡roy
(
vıu
 *
v
)

589 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

590 
cÜe2_vpmu_cÚ‹xt
 *
cÜe2_vpmu_cxt
 = 
vpmu
->
cÚ‹xt
;

592 iàĞ!(
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
) )

594 
	`xä“
(
cÜe2_vpmu_cxt
->
pmu_’abË
);

595 
	`xä“
(
vpmu
->
cÚ‹xt
);

596 iàĞ
ıu_has_vmx_m¤_b™m­
 )

597 
	`cÜe2_vpmu_un£t_m¤_b™m­
(
v
->
¬ch
.
hvm_vmx
.
m¤_b™m­
);

598 
	`»Ëa£_pmu_ownsh
(
PMU_OWNER_HVM
);

599 
vpmu
->
æags
 &ğ~
VPMU_CONTEXT_ALLOCATED
;

600 
	}
}

602 
¬ch_vpmu_İs
 
	gcÜe2_vpmu_İs
 = {

603 .
do_wrm¤
 = 
cÜe2_vpmu_do_wrm¤
,

604 .
	gdo_rdm¤
 = 
cÜe2_vpmu_do_rdm¤
,

605 .
	gdo_š‹¼u±
 = 
cÜe2_vpmu_do_š‹¼u±
,

606 .
	g¬ch_vpmu_š™Ÿli£
 = 
cÜe2_vpmu_š™Ÿli£
,

607 .
	g¬ch_vpmu_de¡roy
 = 
cÜe2_vpmu_de¡roy
,

608 .
	g¬ch_vpmu_§ve
 = 
cÜe2_vpmu_§ve
,

609 .
	g¬ch_vpmu_lßd
 = 
cÜe2_vpmu_lßd


	@hvm/vpic.c

27 
	~<x’/cÚfig.h
>

28 
	~<x’/ty³s.h
>

29 
	~<x’/ev’t.h
>

30 
	~<x’/lib.h
>

31 
	~<x’/”ºo.h
>

32 
	~<x’/sched.h
>

33 
	~<asm/hvm/hvm.h
>

34 
	~<asm/hvm/io.h
>

35 
	~<asm/hvm/suµÜt.h
>

37 
	#vpic_domaš
(
v
è(
	`cÚš”_of
((v), 
domaš
, \

38 
¬ch
.
hvm_domaš
.
vpic
[!vpic->
is_ma¡”
]))

	)

39 
	#__vpic_lock
(
v
è&
	`cÚš”_of
((v), 
hvm_domaš
, \

40 
vpic
[!(
v
)->
is_ma¡”
])->
œq_lock


	)

41 
	#vpic_lock
(
v
è
	`¥š_lock
(
	`__vpic_lock
(v))

	)

42 
	#vpic_uÆock
(
v
è
	`¥š_uÆock
(
	`__vpic_lock
(v))

	)

43 
	#vpic_is_locked
(
v
è
	`¥š_is_locked
(
	`__vpic_lock
(v))

	)

44 
	#vpic_–ü_mask
(
v
è(
vpic
->
is_ma¡”
 ? (
ušt8_t
)0xf8 : (ušt8_t)0xde);

	)

47 
	#VPIC_PRIO_NONE
 8

	)

48 
	$vpic_g‘_´iÜ™y
(
hvm_hw_vpic
 *
vpic
, 
ušt8_t
 
mask
)

50 
´io
;

52 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

54 iàĞ
mask
 == 0 )

55  
VPIC_PRIO_NONE
;

58 
	`asm
 ( "ror %%cl,%b1 ; bsf %1,%0"

59 : "ô" (
´io
è: "q" ((
ušt32_t
)
mask
), "c" (
vpic
->
´iÜ™y_add
) );

60  
´io
;

61 
	}
}

64 
	$vpic_g‘_highe¡_´iÜ™y_œq
(
hvm_hw_vpic
 *
vpic
)

66 
cur_´iÜ™y
, 
´iÜ™y
, 
œq
;

67 
ušt8_t
 
mask
;

69 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

71 
mask
 = 
vpic
->
œr
 & ~vpic->
imr
;

72 
´iÜ™y
 = 
	`vpic_g‘_´iÜ™y
(
vpic
, 
mask
);

73 iàĞ
´iÜ™y
 =ğ
VPIC_PRIO_NONE
 )

76 
œq
 = (
´iÜ™y
 + 
vpic
->
´iÜ™y_add
) & 7;

84 
mask
 = 
vpic
->
i¤
;

85 iàĞ
vpic
->
¥ecŸl_fuÎy_Ã¡ed_mode
 && vpic->
is_ma¡”
 && (
œq
 == 2) )

86 
mask
 &= ~(1 << 2);

87 iàĞ
vpic
->
¥ecŸl_mask_mode
 )

88 
mask
 &ğ~
vpic
->
imr
;

89 
cur_´iÜ™y
 = 
	`vpic_g‘_´iÜ™y
(
vpic
, 
mask
);

92  (
´iÜ™y
 < 
cur_´iÜ™y
è? 
œq
 : -1;

93 
	}
}

95 
	$vpic_upd©e_št_ouut
(
hvm_hw_vpic
 *
vpic
)

97 
œq
;

99 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

101 
œq
 = 
	`vpic_g‘_highe¡_´iÜ™y_œq
(
vpic
);

102 iàĞ
vpic
->
št_ouut
 =ğ(
œq
 >= 0) )

106 
vpic
->
št_ouut
 = !vpic->int_output;

108 iàĞ
vpic
->
št_ouut
 )

110 iàĞ
vpic
->
is_ma¡”
 )

113 
vıu
 *
v
 = 
	`vpic_domaš
(
vpic
)->
¬ch
.
hvm_domaš
.
i8259_rg‘
;

114 iàĞ
v
 !ğ
NULL
 )

115 
	`vıu_kick
(
v
);

120 (--
vpic
)->
œr
 |= 1 << 2;

121 
	`vpic_upd©e_št_ouut
(
vpic
);

124 iàĞ!
vpic
->
is_ma¡”
 )

127 (--
vpic
)->
œr
 &= ~(1 << 2);

128 
	`vpic_upd©e_št_ouut
(
vpic
);

130 
	}
}

132 
	$__vpic_šck
(
hvm_hw_vpic
 *
vpic
, 
œq
)

134 
ušt8_t
 
mask
 = 1 << 
œq
;

136 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

139 iàĞ!(
vpic
->
–ü
 & 
mask
) )

140 
vpic
->
œr
 &ğ~
mask
;

142 iàĞ!
vpic
->
auto_eoi
 )

143 
vpic
->
i¤
 |ğ
mask
;

144 iàĞ
vpic
->
rÙ©e_Ú_auto_eoi
 )

145 
vpic
->
´iÜ™y_add
 = (
œq
 + 1) & 7;

147 
	`vpic_upd©e_št_ouut
(
vpic
);

148 
	}
}

150 
	$vpic_šck
(
hvm_hw_vpic
 *
vpic
)

152 
œq
 = -1;

154 
	`vpic_lock
(
vpic
);

156 iàĞ!
vpic
->
št_ouut
 )

157 
out
;

159 
œq
 = 
	`vpic_g‘_highe¡_´iÜ™y_œq
(
vpic
);

160 
	`BUG_ON
(
œq
 < 0);

161 
	`__vpic_šck
(
vpic
, 
œq
);

163 iàĞ(
œq
 =ğ2è&& 
vpic
->
is_ma¡”
 )

165 
vpic
++;

166 
œq
 = 
	`vpic_g‘_highe¡_´iÜ™y_œq
(
vpic
);

167 
	`BUG_ON
(
œq
 < 0);

168 
	`__vpic_šck
(
vpic
, 
œq
);

169 
œq
 += 8;

172 
out
:

173 
	`vpic_uÆock
(
vpic
);

174  
œq
;

175 
	}
}

177 
	$vpic_iİÜt_wr™e
(

178 
hvm_hw_vpic
 *
vpic
, 
ušt32_t
 
addr
, ušt32_ˆ
v®
)

180 
´iÜ™y
, 
cmd
, 
œq
;

181 
ušt8_t
 
mask
, 
unmasked
 = 0;

183 
	`vpic_lock
(
vpic
);

185 iàĞ(
addr
 & 1) == 0 )

187 iàĞ
v®
 & 0x10 )

191 
vpic
->
œr
 &ğvpic->
–ü
;

193 
unmasked
 = 
vpic
->
imr
;

195 
vpic
->
imr
 = vpic->
i¤
 = 0;

198 
vpic
->
´iÜ™y_add
 = 0;

199 
vpic
->
rÙ©e_Ú_auto_eoi
 = 0;

201 
vpic
->
¥ecŸl_mask_mode
 = 0;

202 
vpic
->
»ad£l_i¤
 = 0;

203 
vpic
->
pŞl
 = 0;

205 iàĞ!(
v®
 & 1) )

208 
vpic
->
auto_eoi
 = 0;

209 
vpic
->
¥ecŸl_fuÎy_Ã¡ed_mode
 = 0;

212 
vpic
->
š™_¡©e
 = ((
v®
 & 3) << 2) | 1;

214 iàĞ
v®
 & 0x08 )

217 iàĞ
v®
 & 0x04 )

218 
vpic
->
pŞl
 = 1;

219 iàĞ
v®
 & 0x02 )

220 
vpic
->
»ad£l_i¤
 = 
v®
 & 1;

221 iàĞ
v®
 & 0x40 )

222 
vpic
->
¥ecŸl_mask_mode
 = (
v®
 >> 5) & 1;

227 
cmd
 = 
v®
 >> 5;

228  
cmd
 )

232 
vpic
->
rÙ©e_Ú_auto_eoi
 = 
cmd
 >> 2;

236 
mask
 = 
vpic
->
i¤
;

237 iàĞ
vpic
->
¥ecŸl_mask_mode
 )

238 
mask
 &ğ~
vpic
->
imr
;

239 
´iÜ™y
 = 
	`vpic_g‘_´iÜ™y
(
vpic
, 
mask
);

240 iàĞ
´iÜ™y
 =ğ
VPIC_PRIO_NONE
 )

242 
œq
 = (
´iÜ™y
 + 
vpic
->
´iÜ™y_add
) & 7;

243 
vpic
->
i¤
 &ğ~(1 << 
œq
);

244 iàĞ
cmd
 == 5 )

245 
vpic
->
´iÜ™y_add
 = (
œq
 + 1) & 7;

249 
œq
 = 
v®
 & 7;

250 
vpic
->
i¤
 &ğ~(1 << 
œq
);

251 iàĞ
cmd
 == 7 )

252 
vpic
->
´iÜ™y_add
 = (
œq
 + 1) & 7;

254 
	`vpic_upd©e_št_ouut
(
vpic
);

255 
	`vpic_uÆock
(
vpic
);

256 
	`hvm_dpci_eoi
(
cu¼’t
->
domaš
,

257 
	`hvm_i§_œq_to_gsi
((
addr
 >> 7è? (
œq
|8) : irq),

258 
NULL
);

261 
vpic
->
´iÜ™y_add
 = (
v®
 + 1) & 7;

268  
vpic
->
š™_¡©e
 & 3 )

272 
unmasked
 = 
vpic
->
imr
 & (~
v®
);

273 
vpic
->
imr
 = 
v®
;

277 
vpic
->
œq_ba£
 = 
v®
 & 0xf8;

278 
vpic
->
š™_¡©e
++;

279 iàĞ!(
vpic
->
š™_¡©e
 & 8) )

284 
vpic
->
š™_¡©e
++;

285 iàĞ!(
vpic
->
š™_¡©e
 & 4) )

286 
vpic
->
š™_¡©e
 = 0;

290 
vpic
->
¥ecŸl_fuÎy_Ã¡ed_mode
 = (
v®
 >> 4) & 1;

291 
vpic
->
auto_eoi
 = (
v®
 >> 1) & 1;

292 
vpic
->
š™_¡©e
 = 0;

297 
	`vpic_upd©e_št_ouut
(
vpic
);

299 
	`vpic_uÆock
(
vpic
);

301 iàĞ
unmasked
 )

302 
	`±_may_unmask_œq
(
	`vpic_domaš
(
vpic
), 
NULL
);

303 
	}
}

305 
ušt32_t
 
	$vpic_iİÜt_»ad
(
hvm_hw_vpic
 *
vpic
, 
ušt32_t
 
addr
)

307 iàĞ
vpic
->
pŞl
 )

309 
vpic
->
pŞl
 = 0;

310  
	`vpic_šck
(
vpic
);

313 iàĞ(
addr
 & 1) == 0 )

314  (
vpic
->
»ad£l_i¤
 ? vpic->
i¤
 : vpic->
œr
);

316  
vpic
->
imr
;

317 
	}
}

319 
	$vpic_š‹rû±_pic_io
(

320 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

322 
hvm_hw_vpic
 *
vpic
;

324 iàĞ
by‹s
 != 1 )

326 
	`gd´štk
(
XENLOG_WARNING
, "PIC_IO bad‡cûs siz%d\n", 
by‹s
);

327  
X86EMUL_OKAY
;

330 
vpic
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.vpic[
pÜt
 >> 7];

332 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

333 
	`vpic_iİÜt_wr™e
(
vpic
, 
pÜt
, (
ušt8_t
)*
v®
);

335 *
v®
 = (
ušt8_t
)
	`vpic_iİÜt_»ad
(
vpic
, 
pÜt
);

337  
X86EMUL_OKAY
;

338 
	}
}

340 
	$vpic_š‹rû±_–ü_io
(

341 
dœ
, 
ušt32_t
 
pÜt
, ušt32_ˆ
by‹s
, ušt32_ˆ*
v®
)

343 
hvm_hw_vpic
 *
vpic
;

344 
ušt32_t
 
d©a
;

346 
	`BUG_ON
(
by‹s
 != 1);

348 
vpic
 = &
cu¼’t
->
domaš
->
¬ch
.
hvm_domaš
.vpic[
pÜt
 & 1];

350 iàĞ
dœ
 =ğ
IOREQ_WRITE
 )

353 
d©a
 = *
v®
 & 
	`vpic_–ü_mask
(
vpic
);

354 iàĞ
vpic
->
is_ma¡”
 )

355 
d©a
 |= 1 << 2;

356 
vpic
->
–ü
 = 
d©a
;

361 *
v®
 = 
vpic
->
–ü
 & 
	`vpic_–ü_mask
(vpic);

364  
X86EMUL_OKAY
;

365 
	}
}

367 
	$vpic_§ve
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

369 
hvm_hw_vpic
 *
s
;

370 
i
;

373  
i
 = 0; i < 2 ; i++ )

375 
s
 = &
d
->
¬ch
.
hvm_domaš
.
vpic
[
i
];

376 iàĞ
	`hvm_§ve_’Œy
(
PIC
, 
i
, 
h
, 
s
) )

381 
	}
}

383 
	$vpic_lßd
(
domaš
 *
d
, 
hvm_domaš_cÚ‹xt_t
 *
h
)

385 
hvm_hw_vpic
 *
s
;

386 
ušt16_t
 
š¡
;

389 
š¡
 = 
	`hvm_lßd_š¡ªû
(
h
);

390 iàĞ
š¡
 > 1 )

391  -
EINVAL
;

392 
s
 = &
d
->
¬ch
.
hvm_domaš
.
vpic
[
š¡
];

395 iàĞ
	`hvm_lßd_’Œy
(
PIC
, 
h
, 
s
) != 0 )

396  -
EINVAL
;

399 
	}
}

401 
HVM_REGISTER_SAVE_RESTORE
(
PIC
, 
vpic_§ve
, 
vpic_lßd
, 2, 
HVMSR_PER_DOM
);

403 
	$vpic_»£t
(
domaš
 *
d
)

405 
hvm_hw_vpic
 *
vpic
;

408 
vpic
 = &
d
->
¬ch
.
hvm_domaš
.vpic[0];

409 
	`mem£t
(
vpic
, 0, (*vpic));

410 
vpic
->
is_ma¡”
 = 1;

411 
vpic
->
–ü
 = 1 << 2;

414 
vpic
++;

415 
	`mem£t
(
vpic
, 0, (*vpic));

416 
	}
}

418 
	$vpic_š™
(
domaš
 *
d
)

420 
	`vpic_»£t
(
d
);

422 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0x20, 2, 
vpic_š‹rû±_pic_io
);

423 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0xa0, 2, 
vpic_š‹rû±_pic_io
);

425 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0x4d0, 1, 
vpic_š‹rû±_–ü_io
);

426 
	`»gi¡”_pÜtio_hªdËr
(
d
, 0x4d1, 1, 
vpic_š‹rû±_–ü_io
);

427 
	}
}

429 
	$vpic_œq_pos™ive_edge
(
domaš
 *
d
, 
œq
)

431 
hvm_hw_vpic
 *
vpic
 = &
d
->
¬ch
.
hvm_domaš
.vpic[
œq
 >> 3];

432 
ušt8_t
 
mask
 = 1 << (
œq
 & 7);

434 
	`ASSERT
(
œq
 <= 15);

435 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

437 iàĞ
œq
 == 2 )

440 
vpic
->
œr
 |ğ
mask
;

441 iàĞ!(
vpic
->
imr
 & 
mask
) )

442 
	`vpic_upd©e_št_ouut
(
vpic
);

443 
	}
}

445 
	$vpic_œq_Ãg©ive_edge
(
domaš
 *
d
, 
œq
)

447 
hvm_hw_vpic
 *
vpic
 = &
d
->
¬ch
.
hvm_domaš
.vpic[
œq
 >> 3];

448 
ušt8_t
 
mask
 = 1 << (
œq
 & 7);

450 
	`ASSERT
(
œq
 <= 15);

451 
	`ASSERT
(
	`vpic_is_locked
(
vpic
));

453 iàĞ
œq
 == 2 )

456 
vpic
->
œr
 &ğ~
mask
;

457 iàĞ!(
vpic
->
imr
 & 
mask
) )

458 
	`vpic_upd©e_št_ouut
(
vpic
);

459 
	}
}

461 
	$vpic_ack_³ndšg_œq
(
vıu
 *
v
)

463 
œq
, 
veùÜ
;

464 
hvm_hw_vpic
 *
vpic
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.vpic[0];

466 iàĞ!
	`vÏpic_acû±_pic_šŒ
(
v
è|| !
vpic
->
št_ouut
 )

469 
œq
 = 
	`vpic_šck
(
vpic
);

470 iàĞ
œq
 == -1 )

473 
veùÜ
 = 
vpic
[
œq
 >> 3].
œq_ba£
 + (irq & 7);

474  
veùÜ
;

475 
	}
}

	@hvm/vpmu.c

22 
	~<x’/cÚfig.h
>

23 
	~<x’/sched.h
>

24 
	~<asm/»gs.h
>

25 
	~<asm/ty³s.h
>

26 
	~<asm/m¤.h
>

27 
	~<asm/hvm/suµÜt.h
>

28 
	~<asm/hvm/vmx/vmx.h
>

29 
	~<asm/hvm/vmx/vmcs.h
>

30 
	~<public/sched.h
>

31 
	~<public/hvm/§ve.h
>

32 
	~<asm/hvm/vpmu.h
>

33 
	~<asm/hvm/svm/svm.h
>

34 
	~<asm/hvm/svm/vmcb.h
>

36 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_vpmu_’abËd
;

37 
boŞ—n_·¿m
("vpmu", 
İt_vpmu_’abËd
);

39 
	$vpmu_do_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

41 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
cu¼’t
);

43 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

44  
vpmu
->
¬ch_vpmu_İs
->
	`do_wrm¤
(
m¤
, 
m¤_cÚ‹Á
);

46 
	}
}

48 
	$vpmu_do_rdm¤
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

50 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
cu¼’t
);

52 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

53  
vpmu
->
¬ch_vpmu_İs
->
	`do_rdm¤
(
m¤
, 
m¤_cÚ‹Á
);

55 
	}
}

57 
	$vpmu_do_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

59 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
cu¼’t
);

61 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

62  
vpmu
->
¬ch_vpmu_İs
->
	`do_š‹¼u±
(
»gs
);

64 
	}
}

66 
	$vpmu_§ve
(
vıu
 *
v
)

68 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

70 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

71 
vpmu
->
¬ch_vpmu_İs
->
	`¬ch_vpmu_§ve
(
v
);

72 
	}
}

74 
	$vpmu_lßd
(
vıu
 *
v
)

76 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

78 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

79 
vpmu
->
¬ch_vpmu_İs
->
	`¬ch_vpmu_lßd
(
v
);

80 
	}
}

82 
¬ch_vpmu_İs
 
cÜe2_vpmu_İs
;

83 
¬ch_vpmu_İs
 
amd_vpmu_İs
;

85 
	$vpmu_š™Ÿli£
(
vıu
 *
v
)

87 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

88 
__u8
 
v’dÜ
 = 
cu¼’t_ıu_d©a
.
x86_v’dÜ
;

89 
__u8
 
çmy
 = 
cu¼’t_ıu_d©a
.
x86
;

90 
__u8
 
ıu_mod–
 = 
cu¼’t_ıu_d©a
.
x86_mod–
;

92 iàĞ!
İt_vpmu_’abËd
 )

95 iàĞ
vpmu
->
æags
 & 
VPMU_CONTEXT_ALLOCATED
 )

96 
	`vpmu_de¡roy
(
v
);

98  
v’dÜ
 )

100 
X86_VENDOR_AMD
:

101  
çmy
 )

104 
vpmu
->
¬ch_vpmu_İs
 = &
amd_vpmu_İs
;

107 
	`´štk
("VPMU: Initialization failed. "

109 "b“ÀsuµÜ‹d\n", 
çmy
);

114 
X86_VENDOR_INTEL
:

115 iàĞ
çmy
 == 6 )

117  
ıu_mod–
 )

124 
vpmu
->
¬ch_vpmu_İs
 = &
cÜe2_vpmu_İs
;

128 iàĞ
vpmu
->
¬ch_vpmu_İs
 =ğ
NULL
 )

129 
	`´štk
("VPMU: Initialization failed. "

131 "b“ÀsuµÜ‹d\n", 
çmy
, 
ıu_mod–
);

135 
	`´štk
("VPMU: Initialization failed. "

136 "UnknowÀCPU v’dÜ %d\n", 
v’dÜ
);

140 iàĞ
vpmu
->
¬ch_vpmu_İs
 !ğ
NULL
 )

142 
vpmu
->
æags
 = 0;

143 
vpmu
->
cÚ‹xt
 = 
NULL
;

144 
vpmu
->
¬ch_vpmu_İs
->
	`¬ch_vpmu_š™Ÿli£
(
v
);

146 
	}
}

148 
	$vpmu_de¡roy
(
vıu
 *
v
)

150 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

152 iàĞ
vpmu
->
¬ch_vpmu_İs
 )

153 
vpmu
->
¬ch_vpmu_İs
->
	`¬ch_vpmu_de¡roy
(
v
);

154 
	}
}

	@hvm/vpt.c

20 
	~<x’/time.h
>

21 
	~<asm/hvm/suµÜt.h
>

22 
	~<asm/hvm/v±.h
>

23 
	~<asm/ev’t.h
>

24 
	~<asm/­ic.h
>

26 
	#mode_is
(
d
, 
Çme
) \

27 ((
d
)->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_TIMER_MODE
] =ğ
HVMPTM_
##
Çme
)

	)

29 
	$hvm_š™_gue¡_time
(
domaš
 *
d
)

31 
¶_time
 *
¶
 = &
d
->
¬ch
.
hvm_domaš
.pl_time;

33 
	`¥š_lock_š™
(&
¶
->
¶_time_lock
);

34 
¶
->
¡ime_off£t
 = -(
u64
)
	`g‘_s_time
();

35 
¶
->
Ï¡_gue¡_time
 = 0;

36 
	}
}

38 
u64
 
	$hvm_g‘_gue¡_time
(
vıu
 *
v
)

40 
¶_time
 *
¶
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.pl_time;

41 
u64
 
now
;

44 
	`ASSERT
(
	`is_hvm_vıu
(
v
));

46 
	`¥š_lock
(&
¶
->
¶_time_lock
);

47 
now
 = 
	`g‘_s_time
(è+ 
¶
->
¡ime_off£t
;

48 iàĞ(
št64_t
)(
now
 - 
¶
->
Ï¡_gue¡_time
) > 0 )

49 
¶
->
Ï¡_gue¡_time
 = 
now
;

51 
now
 = ++
¶
->
Ï¡_gue¡_time
;

52 
	`¥š_uÆock
(&
¶
->
¶_time_lock
);

54  
now
 + 
v
->
¬ch
.
hvm_vıu
.
¡ime_off£t
;

55 
	}
}

57 
	$hvm_£t_gue¡_time
(
vıu
 *
v
, 
u64
 
gue¡_time
)

59 
v
->
¬ch
.
hvm_vıu
.
¡ime_off£t
 +ğ
gue¡_time
 - 
	`hvm_g‘_gue¡_time
(v);

60 
	}
}

62 
	$±_œq_veùÜ
(
³riodic_time
 *
±
, 
hvm_št¤c
 
¤c
)

64 
vıu
 *
v
 = 
±
->vcpu;

65 
gsi
, 
i§_œq
;

67 iàĞ
±
->
sourû
 =ğ
PTSRC_Ïpic
 )

68  
±
->
œq
;

70 
i§_œq
 = 
±
->
œq
;

71 
gsi
 = 
	`hvm_i§_œq_to_gsi
(
i§_œq
);

73 iàĞ
¤c
 =ğ
hvm_št¤c_pic
 )

74  (
v
->
domaš
->
¬ch
.
hvm_domaš
.
vpic
[
i§_œq
 >> 3].
œq_ba£


75 + (
i§_œq
 & 7));

77 
	`ASSERT
(
¤c
 =ğ
hvm_št¤c_Ïpic
);

78  
	`domaš_vißpic
(
v
->
domaš
)->
»dœtbl
[
gsi
].
f›lds
.
veùÜ
;

79 
	}
}

81 
	$±_œq_masked
(
³riodic_time
 *
±
)

83 
vıu
 *
v
 = 
±
->vcpu;

84 
gsi
, 
i§_œq
;

85 
ušt8_t
 
pic_imr
;

87 iàĞ
±
->
sourû
 =ğ
PTSRC_Ïpic
 )

89 
vÏpic
 *vÏpiøğ
	`vıu_vÏpic
(
v
);

90  (!
	`vÏpic_’abËd
(
vÏpic
) ||

91 (
	`vÏpic_g‘_»g
(
vÏpic
, 
APIC_LVTT
è& 
APIC_LVT_MASKED
));

94 
i§_œq
 = 
±
->
œq
;

95 
gsi
 = 
	`hvm_i§_œq_to_gsi
(
i§_œq
);

96 
pic_imr
 = 
v
->
domaš
->
¬ch
.
hvm_domaš
.
vpic
[
i§_œq
 >> 3].
imr
;

98  (((
pic_imr
 & (1 << (
i§_œq
 & 7))è|| !
	`vÏpic_acû±_pic_šŒ
(
v
)) &&

99 
	`domaš_vißpic
(
v
->
domaš
)->
»dœtbl
[
gsi
].
f›lds
.
mask
);

100 
	}
}

102 
	$±_lock
(
³riodic_time
 *
±
)

104 
vıu
 *
v
;

108 
v
 = 
±
->
vıu
;

109 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

110 iàĞ
	`lik–y
(
±
->
vıu
 =ğ
v
) )

112 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

114 
	}
}

116 
	$±_uÆock
(
³riodic_time
 *
±
)

118 
	`¥š_uÆock
(&
±
->
vıu
->
¬ch
.
hvm_vıu
.
tm_lock
);

119 
	}
}

121 
	$±_´oûss_mis£d_ticks
(
³riodic_time
 *
±
)

123 
s_time_t
 
mis£d_ticks
, 
now
 = 
	`NOW
();

125 iàĞ
±
->
Úe_shÙ
 )

128 
mis£d_ticks
 = 
now
 - 
±
->
scheduËd
;

129 iàĞ
mis£d_ticks
 <= 0 )

132 
mis£d_ticks
 = mis£d_tick / (
s_time_t
è
±
->
³riod
 + 1;

133 iàĞ
	`mode_is
(
±
->
vıu
->
domaš
, 
no_mis£d_ticks_³ndšg
) )

134 
±
->
do_nÙ_ä“ze
 = !±->
³ndšg_šŒ_Ä
;

136 
±
->
³ndšg_šŒ_Ä
 +ğ
mis£d_ticks
;

137 
±
->
scheduËd
 +ğ
mis£d_ticks
 *…t->
³riod
;

138 
	}
}

140 
	$±_ä“ze_time
(
vıu
 *
v
)

142 iàĞ!
	`mode_is
(
v
->
domaš
, 
d–ay_fÜ_mis£d_ticks
) )

145 
v
->
¬ch
.
hvm_vıu
.
gue¡_time
 = 
	`hvm_g‘_gue¡_time
(v);

146 
	}
}

148 
	$±_thaw_time
(
vıu
 *
v
)

150 iàĞ!
	`mode_is
(
v
->
domaš
, 
d–ay_fÜ_mis£d_ticks
) )

153 iàĞ
v
->
¬ch
.
hvm_vıu
.
gue¡_time
 == 0 )

156 
	`hvm_£t_gue¡_time
(
v
, v->
¬ch
.
hvm_vıu
.
gue¡_time
);

157 
v
->
¬ch
.
hvm_vıu
.
gue¡_time
 = 0;

158 
	}
}

160 
	$±_§ve_tim”
(
vıu
 *
v
)

162 
li¡_h—d
 *
h—d
 = &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
;

163 
³riodic_time
 *
±
;

165 iàĞ
	`‹¡_b™
(
_VPF_blocked
, &
v
->
·u£_æags
) )

168 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

170 
	`li¡_fÜ_—ch_’Œy
 ( 
±
, 
h—d
, 
li¡
 )

171 iàĞ!
±
->
do_nÙ_ä“ze
 )

172 
	`¡İ_tim”
(&
±
->
tim”
);

174 
	`±_ä“ze_time
(
v
);

176 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

177 
	}
}

179 
	$±_»¡Üe_tim”
(
vıu
 *
v
)

181 
li¡_h—d
 *
h—d
 = &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
;

182 
³riodic_time
 *
±
;

184 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

186 
	`li¡_fÜ_—ch_’Œy
 ( 
±
, 
h—d
, 
li¡
 )

188 iàĞ
±
->
³ndšg_šŒ_Ä
 == 0 )

190 
	`±_´oûss_mis£d_ticks
(
±
);

191 
	`£t_tim”
(&
±
->
tim”
,…t->
scheduËd
);

195 
	`±_thaw_time
(
v
);

197 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

198 
	}
}

200 
	$±_tim”_â
(*
d©a
)

202 
³riodic_time
 *
±
 = 
d©a
;

204 
	`±_lock
(
±
);

206 
±
->
³ndšg_šŒ_Ä
++;

207 
±
->
scheduËd
 +ğ±->
³riod
;

208 
±
->
do_nÙ_ä“ze
 = 0;

210 
	`vıu_kick
(
±
->
vıu
);

212 
	`±_uÆock
(
±
);

213 
	}
}

215 
	$±_upd©e_œq
(
vıu
 *
v
)

217 
li¡_h—d
 *
h—d
 = &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
;

218 
³riodic_time
 *
±
, *
‹mp
, *
—¾›¡_±
 = 
NULL
;

219 
ušt64_t
 
max_Ïg
 = -1ULL;

220 
œq
, 
is_Ïpic
;

222 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

224 
	`li¡_fÜ_—ch_’Œy_§ã
 ( 
±
, 
‹mp
, 
h—d
, 
li¡
 )

226 iàĞ
±
->
³ndšg_šŒ_Ä
 )

228 iàĞ
	`±_œq_masked
(
±
) )

231 
	`li¡_d–
(&
±
->
li¡
);

232 
±
->
Ú_li¡
 = 0;

236 iàĞ(
±
->
Ï¡_¶t_gtime
 +…t->
³riod
è< 
max_Ïg
 )

238 
max_Ïg
 = 
±
->
Ï¡_¶t_gtime
 +…t->
³riod
;

239 
—¾›¡_±
 = 
±
;

245 iàĞ
—¾›¡_±
 =ğ
NULL
 )

247 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

251 
—¾›¡_±
->
œq_issued
 = 1;

252 
œq
 = 
—¾›¡_±
->irq;

253 
is_Ïpic
 = (
—¾›¡_±
->
sourû
 =ğ
PTSRC_Ïpic
);

255 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

257 iàĞ
is_Ïpic
 )

259 
	`vÏpic_£t_œq
(
	`vıu_vÏpic
(
v
), 
œq
, 0);

263 
	`hvm_i§_œq_d—s£¹
(
v
->
domaš
, 
œq
);

264 
	`hvm_i§_œq_as£¹
(
v
->
domaš
, 
œq
);

266 
	}
}

268 
³riodic_time
 *
	$is_±_œq
(

269 
vıu
 *
v
, 
hvm_šck
 
šck
)

271 
li¡_h—d
 *
h—d
 = &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
;

272 
³riodic_time
 *
±
;

274 
	`li¡_fÜ_—ch_’Œy
 ( 
±
, 
h—d
, 
li¡
 )

276 iàĞ
±
->
³ndšg_šŒ_Ä
 &&…t->
œq_issued
 &&

277 (
šck
.
veùÜ
 =ğ
	`±_œq_veùÜ
(
±
, iÁack.
sourû
)) )

278  
±
;

281  
NULL
;

282 
	}
}

284 
	$±_šŒ_po¡
(
vıu
 *
v
, 
hvm_šck
 
šck
)

286 
³riodic_time
 *
±
;

287 
time_cb
 *
cb
;

288 *
cb_´iv
;

290 iàĞ
šck
.
sourû
 =ğ
hvm_št¤c_veùÜ
 )

293 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

295 
±
 = 
	`is_±_œq
(
v
, 
šck
);

296 iàĞ
±
 =ğ
NULL
 )

298 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

302 
±
->
œq_issued
 = 0;

304 iàĞ
±
->
Úe_shÙ
 )

306 iàĞ
±
->
Ú_li¡
 )

307 
	`li¡_d–
(&
±
->
li¡
);

308 
±
->
Ú_li¡
 = 0;

309 
±
->
³ndšg_šŒ_Ä
 = 0;

311 iàĞ
	`mode_is
(
v
->
domaš
, 
Úe_mis£d_tick_³ndšg
) ||

312 
	`mode_is
(
v
->
domaš
, 
no_mis£d_ticks_³ndšg
) )

314 
±
->
Ï¡_¶t_gtime
 = 
	`hvm_g‘_gue¡_time
(
v
);

315 
	`±_´oûss_mis£d_ticks
(
±
);

316 
±
->
³ndšg_šŒ_Ä
 = 0;

317 
	`£t_tim”
(&
±
->
tim”
,…t->
scheduËd
);

321 
±
->
Ï¡_¶t_gtime
 +ğ±->
³riod
;

322 iàĞ--
±
->
³ndšg_šŒ_Ä
 == 0 )

324 
	`±_´oûss_mis£d_ticks
(
±
);

325 iàĞ
±
->
³ndšg_šŒ_Ä
 == 0 )

326 
	`£t_tim”
(&
±
->
tim”
,…t->
scheduËd
);

330 iàĞ
	`mode_is
(
v
->
domaš
, 
d–ay_fÜ_mis£d_ticks
) &&

331 (
	`hvm_g‘_gue¡_time
(
v
è< 
±
->
Ï¡_¶t_gtime
) )

332 
	`hvm_£t_gue¡_time
(
v
, 
±
->
Ï¡_¶t_gtime
);

334 
cb
 = 
±
->cb;

335 
cb_´iv
 = 
±
->
´iv
;

337 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

339 iàĞ
cb
 !ğ
NULL
 )

340 
	`cb
(
v
, 
cb_´iv
);

341 
	}
}

343 
	$±_mig¿‹
(
vıu
 *
v
)

345 
li¡_h—d
 *
h—d
 = &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
;

346 
³riodic_time
 *
±
;

348 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

350 
	`li¡_fÜ_—ch_’Œy
 ( 
±
, 
h—d
, 
li¡
 )

351 
	`mig¿‹_tim”
(&
±
->
tim”
, 
v
->
´oûssÜ
);

353 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

354 
	}
}

356 
	$ü—‹_³riodic_time
(

357 
vıu
 *
v
, 
³riodic_time
 *
±
, 
ušt64_t
 
d–
,

358 
ušt64_t
 
³riod
, 
ušt8_t
 
œq
, 
time_cb
 *
cb
, *
d©a
)

360 
	`ASSERT
(
±
->
sourû
 != 0);

362 
	`de¡roy_³riodic_time
(
±
);

364 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

366 
±
->
³ndšg_šŒ_Ä
 = 0;

367 
±
->
do_nÙ_ä“ze
 = 0;

368 
±
->
œq_issued
 = 0;

371 iàĞ(
³riod
 < 100000) &&…eriod )

373 iàĞ!
	`‹¡_ªd_£t_boŞ
(
±
->
w¬Ãd_timeout_too_shÜt
) )

374 
	`gd´štk
(
XENLOG_WARNING
, "HVM_PlatformTime:…rogramoo "

375 "sm®È³riod %"
PRIu64
"\n", 
³riod
);

376 
³riod
 = 100000;

379 
±
->
³riod
 =…eriod;

380 
±
->
vıu
 = 
v
;

381 
±
->
Ï¡_¶t_gtime
 = 
	`hvm_g‘_gue¡_time
Õt->
vıu
);

382 
±
->
œq
 = irq;

383 
±
->
Úe_shÙ
 = !
³riod
;

384 
±
->
scheduËd
 = 
	`NOW
(è+ 
d–
;

386 iàĞ!
±
->
Úe_shÙ
 )

388 iàĞ
v
->
domaš
->
¬ch
.
hvm_domaš
.
·¿ms
[
HVM_PARAM_VPT_ALIGN
] )

390 
±
->
scheduËd
 = 
	`®ign_tim”
Õt->scheduËd,…t->
³riod
);

392 iàĞ
±
->
sourû
 =ğ
PTSRC_Ïpic
 )

400 
±
->
scheduËd
 +ğ
d–
 >> 1;

404 
±
->
cb
 = cb;

405 
±
->
´iv
 = 
d©a
;

407 
±
->
Ú_li¡
 = 1;

408 
	`li¡_add
(&
±
->
li¡
, &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
);

410 
	`š™_tim”
(&
±
->
tim”
, 
±_tim”_â
,…t, 
v
->
´oûssÜ
);

411 
	`£t_tim”
(&
±
->
tim”
,…t->
scheduËd
);

413 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

414 
	}
}

416 
	$de¡roy_³riodic_time
(
³riodic_time
 *
±
)

419 iàĞ
±
->
vıu
 =ğ
NULL
 )

422 
	`±_lock
(
±
);

423 iàĞ
±
->
Ú_li¡
 )

424 
	`li¡_d–
(&
±
->
li¡
);

425 
±
->
Ú_li¡
 = 0;

426 
±
->
³ndšg_šŒ_Ä
 = 0;

427 
	`±_uÆock
(
±
);

433 
	`kl_tim”
(&
±
->
tim”
);

434 
	}
}

436 
	$±_adju¡_vıu
(
³riodic_time
 *
±
, 
vıu
 *
v
)

438 
Ú_li¡
;

440 
	`ASSERT
(
±
->
sourû
 =ğ
PTSRC_i§
);

442 iàĞ
±
->
vıu
 =ğ
NULL
 )

445 
	`±_lock
(
±
);

446 
Ú_li¡
 = 
±
->on_list;

447 iàĞ
±
->
Ú_li¡
 )

448 
	`li¡_d–
(&
±
->
li¡
);

449 
±
->
Ú_li¡
 = 0;

450 
	`±_uÆock
(
±
);

452 
	`¥š_lock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

453 
±
->
vıu
 = 
v
;

454 iàĞ
Ú_li¡
 )

456 
±
->
Ú_li¡
 = 1;

457 
	`li¡_add
(&
±
->
li¡
, &
v
->
¬ch
.
hvm_vıu
.
tm_li¡
);

459 
	`mig¿‹_tim”
(&
±
->
tim”
, 
v
->
´oûssÜ
);

461 
	`¥š_uÆock
(&
v
->
¬ch
.
hvm_vıu
.
tm_lock
);

462 
	}
}

464 
	$±_adju¡_glob®_vıu_rg‘
(
vıu
 *
v
)

466 
¶_time
 *pl_time;

467 
i
;

469 iàĞ
v
 =ğ
NULL
 )

472 
¶_time
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.pl_time;

474 
	`¥š_lock
(&
¶_time
->
vp™
.
lock
);

475 
	`±_adju¡_vıu
(&
¶_time
->
vp™
.
±0
, 
v
);

476 
	`¥š_uÆock
(&
¶_time
->
vp™
.
lock
);

478 
	`¥š_lock
(&
¶_time
->
v¹c
.
lock
);

479 
	`±_adju¡_vıu
(&
¶_time
->
v¹c
.
±
, 
v
);

480 
	`¥š_uÆock
(&
¶_time
->
v¹c
.
lock
);

482 
	`¥š_lock
(&
¶_time
->
vh³t
.
lock
);

483  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

484 
	`±_adju¡_vıu
(&
¶_time
->
vh³t
.
±
[
i
], 
v
);

485 
	`¥š_uÆock
(&
¶_time
->
vh³t
.
lock
);

486 
	}
}

489 
	$±_»sume
(
³riodic_time
 *
±
)

491 iàĞ
±
->
vıu
 =ğ
NULL
 )

494 
	`±_lock
(
±
);

495 iàĞ
±
->
³ndšg_šŒ_Ä
 && !±->
Ú_li¡
 )

497 
±
->
Ú_li¡
 = 1;

498 
	`li¡_add
(&
±
->
li¡
, &±->
vıu
->
¬ch
.
hvm_vıu
.
tm_li¡
);

499 
	`vıu_kick
(
±
->
vıu
);

501 
	`±_uÆock
(
±
);

502 
	}
}

504 
	$±_may_unmask_œq
(
domaš
 *
d
, 
³riodic_time
 *
vÏpic_±
)

506 
i
;

508 iàĞ
d
 )

510 
	`±_»sume
(&
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vp™
.
±0
);

511 
	`±_»sume
(&
d
->
¬ch
.
hvm_domaš
.
¶_time
.
v¹c
.
±
);

512  
i
 = 0; i < 
HPET_TIMER_NUM
; i++ )

513 
	`±_»sume
(&
d
->
¬ch
.
hvm_domaš
.
¶_time
.
vh³t
.
±
[
i
]);

516 iàĞ
vÏpic_±
 )

517 
	`±_»sume
(
vÏpic_±
);

518 
	}
}

	@i387.c

11 
	~<x’/cÚfig.h
>

12 
	~<x’/sched.h
>

13 
	~<asm/cu¼’t.h
>

14 
	~<asm/´oûssÜ.h
>

15 
	~<asm/hvm/suµÜt.h
>

16 
	~<asm/i387.h
>

17 
	~<asm/asm_deâs.h
>

19 
boŞ_t
 
__»ad_mo¡ly
 
	gıu_has_x§veİt
;

21 
	$x§ve
(
vıu
 *
v
)

23 
x§ve_¡ruù
 *
±r
 = 
v
->
¬ch
.
x§ve_¬—
;

25 
asm
 volatile (

26 ".by‹ " 
REX_PREFIX
 "0x0f,0xae,0x27"

28 : "a" (-1), "d" (-1), "D"(
±r
)

30 
	}
}

32 
	$x§veİt
(
vıu
 *
v
)

34 
x§ve_¡ruù
 *
±r
 = 
v
->
¬ch
.
x§ve_¬—
;

36 
asm
 volatile (

37 ".by‹ " 
REX_PREFIX
 "0x0f,0xae,0x37"

39 : "a" (-1), "d" (-1), "D"(
±r
)

41 
	}
}

43 
	$xr¡Ü
(
vıu
 *
v
)

45 
x§ve_¡ruù
 *
±r
 = 
v
->
¬ch
.
x§ve_¬—
;

47 
asm
 volatile (

48 ".by‹ " 
REX_PREFIX
 "0x0f,0xae,0x2f"

50 : "m" (*
±r
), "a" (-1), "d" (-1), "D"(ptr) );

51 
	}
}

53 
	$lßd_mxc¤
(
v®
)

55 
v®
 &= 0xffbf;

56 
asm
 vŞ©Ğ"ldmxc¤ %0" : : "m" (
v®
) );

57 
	}
}

59 
š™_åu
();

60 
»¡Üe_åu
(
vıu
 *
v
);

62 
	$£tup_åu
(
vıu
 *
v
)

64 
	`ASSERT
(!
	`is_idË_vıu
(
v
));

67 
	`şts
();

69 iàĞ
v
->
åu_dœt›d
 )

72 iàĞ
	`x§ve_’abËd
(
v
) )

78 
	`£t_xü0
(
v
->
¬ch
.
xü0_accum
);

79 
	`xr¡Ü
(
v
);

80 
	`£t_xü0
(
v
->
¬ch
.
xü0
);

82 iàĞ
v
->
åu_š™Ÿli£d
 )

84 
	`»¡Üe_åu
(
v
);

88 
	`š™_åu
();

91 
v
->
åu_š™Ÿli£d
 = 1;

92 
v
->
åu_dœt›d
 = 1;

93 
	}
}

95 
	$š™_åu
()

97 
asm
 volatile ( "fninit" );

98 iàĞ
ıu_has_xmm
 )

99 
	`lßd_mxc¤
(0x1f80);

100 
	}
}

102 
	$§ve_š™_åu
(
vıu
 *
v
)

104 
ü0
;

105 *
åu_ùxt
;

107 iàĞ!
v
->
åu_dœt›d
 )

110 
	`ASSERT
(!
	`is_idË_vıu
(
v
));

112 
ü0
 = 
	`»ad_ü0
();

113 
åu_ùxt
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.åu_ùxt.
x
;

116 iàĞ
ü0
 & 
X86_CR0_TS
 )

117 
	`şts
();

119 iàĞ
	`x§ve_’abËd
(
v
) )

124 
	`£t_xü0
(
v
->
¬ch
.
xü0_accum
);

125 iàĞ
ıu_has_x§veİt
 )

126 
	`x§veİt
(
v
);

128 
	`x§ve
(
v
);

129 
	`£t_xü0
(
v
->
¬ch
.
xü0
);

131 iàĞ
ıu_has_fx¤
 )

133 #ifdeà
__i386__


134 
asm
 volatile (

136 : "=m" (*
åu_ùxt
) );

143 
asm
 volatile (

144 
REX64_PREFIX
 "fxsave (%1)"

145 : "=m" (*
åu_ùxt
) : "cdaSDb" (fpu_ctxt) );

149 iàĞ
	`uÆik–y
(
åu_ùxt
[2] & 0x80) )

150 
asm
 volatile ("fnclex");

159 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 )

161 
asm
 volatile (

164 : : "m" (*
åu_ùxt
) );

170 
asm
 vŞ©Ğ"â§v%0 ; fwa™" : "=m" (*
åu_ùxt
) );

173 
v
->
åu_dœt›d
 = 0;

174 
	`wr™e_ü0
(
ü0
|
X86_CR0_TS
);

175 
	}
}

177 
	$»¡Üe_åu
(
vıu
 *
v
)

179 *
åu_ùxt
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.åu_ùxt.
x
;

186 iàĞ
ıu_has_fx¤
 )

188 
asm
 volatile (

189 #ifdeà
__i386__


193 "1: " 
REX64_PREFIX
 "fxrstor (%2)\n"

196 "2:…ush %%"
__OP
"ax \n"

197 "…ush %%"
__OP
"cx \n"

198 "…ush %%"
__OP
"di \n"

199 "†— %0,%%"
__OP
"di \n"

203 "…İ %%"
__OP
"di \n"

204 "…İ %%"
__OP
"cx \n"

205 "…İ %%"
__OP
"ax \n"

208 
	`_ASM_EXTABLE
(1b, 2b)

210 : "m" (*
åu_ùxt
),

211 "i" ((
v
->
¬ch
.
gue¡_cÚ‹xt
.
åu_ùxt
)/4)

212 #ifdeà
__x86_64__


213 ,"cdaSDb" (
åu_ùxt
)

219 
asm
 vŞ©Ğ"ä¡Ü %0" : : "m" (
v
->
¬ch
.
gue¡_cÚ‹xt
.
åu_ùxt
) );

221 
	}
}

223 
	#XSTATE_CPUID
 0xd

	)

230 
u32
 
	gx§ve_útxt_size
;

233 
u64
 
	gxã©u»_mask
;

236 
DEFINE_PER_CPU
(
ušt64_t
, 
xü0
);

238 
	$x§ve_š™
()

240 
u32
 
—x
, 
ebx
, 
ecx
, 
edx
;

241 
ıu
 = 
	`smp_´oûssÜ_id
();

242 
u32
 
mš_size
;

244 iàĞ
boÙ_ıu_d©a
.
ıuid_Ëv–
 < 
XSTATE_CPUID
 )

247 
	`ıuid_couÁ
(
XSTATE_CPUID
, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

249 
	`BUG_ON
((
—x
 & 
XSTATE_FP_SSE
) != XSTATE_FP_SSE);

250 
	`BUG_ON
((
—x
 & 
XSTATE_YMM
è&& !Óax & 
XSTATE_SSE
));

253 
mš_size
 = 
XSAVE_AREA_MIN_SIZE
;

254 iàĞ
—x
 & 
XSTATE_YMM
 )

255 
mš_size
 +ğ
XSTATE_YMM_SIZE
;

256 
	`BUG_ON
(
ecx
 < 
mš_size
);

261 
	`£t_š_ü4
(
X86_CR4_OSXSAVE
);

262 
	`£t_xü0
((((
u64
)
edx
 << 32è| 
—x
è& 
XCNTXT_MASK
);

263 
	`ıuid_couÁ
(
XSTATE_CPUID
, 0, &
—x
, &
ebx
, &
ecx
, &
edx
);

265 iàĞ
ıu
 == 0 )

271 
x§ve_útxt_size
 = 
ebx
;

272 
xã©u»_mask
 = 
—x
 + ((
u64
)
edx
 << 32);

273 
xã©u»_mask
 &ğ
XCNTXT_MASK
;

274 
	`´štk
("%s: usšg cÁxt_size: 0x%x‡nd s‹s: 0x%"
PRIx64
"\n",

275 
__func__
, 
x§ve_útxt_size
, 
xã©u»_mask
);

278 
	`ıuid_couÁ
(
XSTATE_CPUID
, 1, &
—x
, &
ebx
, &
ecx
, &
edx
);

279 
ıu_has_x§veİt
 = !!(
—x
 & 
XSAVEOPT
);

283 
	`BUG_ON
(
x§ve_útxt_size
 !ğ
ebx
);

284 
	`BUG_ON
(
xã©u»_mask
 !ğ(xã©u»_mask & 
XCNTXT_MASK
));

286 
	}
}

288 
	$x§ve_®loc_§ve_¬—
(
vıu
 *
v
)

290 *
§ve_¬—
;

292 iàĞ!
ıu_has_x§ve
 || 
	`is_idË_vıu
(
v
) )

295 
	`BUG_ON
(
x§ve_útxt_size
 < 
XSAVE_AREA_MIN_SIZE
);

298 
§ve_¬—
 = 
	`_xm®loc
(
x§ve_útxt_size
, 64);

299 iàĞ
§ve_¬—
 =ğ
NULL
 )

300  -
ENOMEM
;

302 
	`mem£t
(
§ve_¬—
, 0, 
x§ve_útxt_size
);

303 ((
u32
 *)
§ve_¬—
)[6] = 0x1f80;

304 *(
ušt64_t
 *)(
§ve_¬—
 + 512èğ
XSTATE_FP_SSE
;

306 
v
->
¬ch
.
x§ve_¬—
 = 
§ve_¬—
;

307 
v
->
¬ch
.
xü0
 = 
XSTATE_FP_SSE
;

308 
v
->
¬ch
.
xü0_accum
 = 
XSTATE_FP_SSE
;

311 
	}
}

313 
	$x§ve_ä“_§ve_¬—
(
vıu
 *
v
)

315 
	`xä“
(
v
->
¬ch
.
x§ve_¬—
);

316 
v
->
¬ch
.
x§ve_¬—
 = 
NULL
;

317 
	}
}

319 
boŞ_t
 
	$x§ve_’abËd
(cÚ¡ 
vıu
 *
v
)

321 iàĞ
ıu_has_x§ve
 )

323 
	`ASSERT
(
x§ve_útxt_size
 >ğ
XSAVE_AREA_MIN_SIZE
);

324 
	`ASSERT
(
v
->
¬ch
.
x§ve_¬—
);

327  
ıu_has_x§ve
;

328 
	}
}

	@i8259.c

8 
	~<x’/cÚfig.h
>

9 
	~<x’/š™.h
>

10 
	~<x’/ty³s.h
>

11 
	~<asm/»gs.h
>

12 
	~<x’/”ºo.h
>

13 
	~<x’/sched.h
>

14 
	~<x’/œq.h
>

15 
	~<asm/©omic.h
>

16 
	~<asm/sy¡em.h
>

17 
	~<asm/io.h
>

18 
	~<asm/desc.h
>

19 
	~<asm/b™İs.h
>

20 
	~<x’/d–ay.h
>

21 
	~<asm/­ic.h
>

22 
	~<asm/asm_deâs.h
>

23 
	~<io_pÜts.h
>

36 
	$BUILD_COMMON_IRQ
()

38 
	#BI
(
x
,
y
) \

39 
	`BUILD_IRQ
(
x
##
y
)

	)

41 
	#BUILD_16_IRQS
(
x
) \

42 
	`BI
(
x
,0) BI(x,1) BI(x,2) BI(x,3) \

43 
	`BI
(
x
,4) BI(x,5) BI(x,6) BI(x,7) \

44 
	`BI
(
x
,8èBI(x,9èBI(x,
a
èBI(x,
b
) \

45 
	`BI
(
x
,
c
èBI(x,
d
èBI(x,
e
èBI(x,
f
)

	)

47 
	$BUILD_16_IRQS
(0x0è
	$BUILD_16_IRQS
(0x1è
	$BUILD_16_IRQS
(0x2è
	$BUILD_16_IRQS
(0x3)

48 
	$BUILD_16_IRQS
(0x4è
	$BUILD_16_IRQS
(0x5è
	$BUILD_16_IRQS
(0x6è
	$BUILD_16_IRQS
(0x7)

49 
	$BUILD_16_IRQS
(0x8è
	$BUILD_16_IRQS
(0x9è
	$BUILD_16_IRQS
(0xaè
	$BUILD_16_IRQS
(0xb)

50 
	$BUILD_16_IRQS
(0xcè
	$BUILD_16_IRQS
(0xdè
	$BUILD_16_IRQS
(0xeè
	$BUILD_16_IRQS
(0xf)

52 #undeà
BUILD_16_IRQS


53 #undeà
BI


56 
	#IRQ
(
x
,
y
) \

57 
IRQ
##
x
##
y
##
_š‹¼u±


	)

59 
	#IRQLIST_16
(
x
) \

60 
	`IRQ
(
x
,0), IRQ(x,1), IRQ(x,2), IRQ(x,3), \

61 
	`IRQ
(
x
,4), IRQ(x,5), IRQ(x,6), IRQ(x,7), \

62 
	`IRQ
(
x
,8), IRQ(x,9), IRQ(x,
a
), IRQ(x,
b
), \

63 
	`IRQ
(
x
,
c
), IRQ(x,
d
), IRQ(x,
e
), IRQ(x,
f
)

	)

65 (*
š‹¼u±
[])() = {

66 
	`IRQLIST_16
(0x0), IRQLIST_16(0x1), IRQLIST_16(0x2), IRQLIST_16(0x3),

67 
	`IRQLIST_16
(0x4), IRQLIST_16(0x5), IRQLIST_16(0x6), IRQLIST_16(0x7),

68 
	`IRQLIST_16
(0x8), IRQLIST_16(0x9), IRQLIST_16(0xa), IRQLIST_16(0xb),

69 
	`IRQLIST_16
(0xc), IRQLIST_16(0xd), IRQLIST_16(0xe), IRQLIST_16(0xf)

70 
	}
};

72 #undeà
IRQ


73 #undeà
IRQLIST_16


84 
DEFINE_SPINLOCK
(
i8259A_lock
);

86 
mask_ªd_ack_8259A_œq
(
œq
);

88 
	$¡¬tup_8259A_œq
(
œq
)

90 
	`’abË_8259A_œq
(
œq
);

92 
	}
}

94 
	$’d_8259A_œq
(
œq
)

96 ià(!(
œq_desc
[
œq
].
¡©us
 & (
IRQ_DISABLED
|
IRQ_INPROGRESS
)))

97 
	`’abË_8259A_œq
(
œq
);

98 
	}
}

100 
hw_š‹¼u±_ty³
 
__»ad_mo¡ly
 
	gi8259A_œq_ty³
 = {

101 .
ty³Çme
 = "XT-PIC",

102 .
	g¡¬tup
 = 
¡¬tup_8259A_œq
,

103 .
	gshutdown
 = 
di§bË_8259A_œq
,

104 .
	g’abË
 = 
’abË_8259A_œq
,

105 .
	gdi§bË
 = 
di§bË_8259A_œq
,

106 .
	gack
 = 
mask_ªd_ack_8259A_œq
,

107 .
	g’d
 = 
’d_8259A_œq


117 
	gÿched_œq_mask
 = 0xffff;

119 
	#__by‹
(
x
,
y
è(((*)&(y))[x])

	)

120 
	#ÿched_21
 (
	`__by‹
(0,
ÿched_œq_mask
))

	)

121 
	#ÿched_A1
 (
	`__by‹
(1,
ÿched_œq_mask
))

	)

132 
	gio_­ic_œqs
;

134 
	$di§bË_8259A_œq
(
œq
)

136 
mask
 = 1 << 
œq
;

137 
æags
;

139 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

140 
ÿched_œq_mask
 |ğ
mask
;

141 ià(
œq
 & 8)

142 
	`outb
(
ÿched_A1
,0xA1);

144 
	`outb
(
ÿched_21
,0x21);

145 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

146 
	}
}

148 
	$’abË_8259A_œq
(
œq
)

150 
mask
 = ~(1 << 
œq
);

151 
æags
;

153 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

154 
ÿched_œq_mask
 &ğ
mask
;

155 ià(
œq
 & 8)

156 
	`outb
(
ÿched_A1
,0xA1);

158 
	`outb
(
ÿched_21
,0x21);

159 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

160 
	}
}

162 
	$i8259A_œq_³ndšg
(
œq
)

164 
mask
 = 1<<
œq
;

165 
æags
;

166 
»t
;

168 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

169 ià(
œq
 < 8)

170 
»t
 = 
	`šb
(0x20è& 
mask
;

172 
»t
 = 
	`šb
(0xA0è& (
mask
 >> 8);

173 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

175  
»t
;

176 
	}
}

178 
	$mask_8259A
()

180 
æags
;

182 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

183 
	`outb
(0xff, 0xA1);

184 
	`outb
(0xff, 0x21);

185 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

186 
	}
}

188 
	$unmask_8259A
()

190 
æags
;

192 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

193 
	`outb
(
ÿched_A1
, 0xA1);

194 
	`outb
(
ÿched_21
, 0x21);

195 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

196 
	}
}

204 
šlše
 
	$i8259A_œq_»®
(
œq
)

206 
v®ue
;

207 
œqmask
 = 1<<
œq
;

209 ià(
œq
 < 8) {

210 
	`outb
(0x0B,0x20);

211 
v®ue
 = 
	`šb
(0x20è& 
œqmask
;

212 
	`outb
(0x0A,0x20);

213  
v®ue
;

215 
	`outb
(0x0B,0xA0);

216 
v®ue
 = 
	`šb
(0xA0è& (
œqmask
 >> 8);

217 
	`outb
(0x0A,0xA0);

218  
v®ue
;

219 
	}
}

227 
	$mask_ªd_ack_8259A_œq
(
œq
)

229 
œqmask
 = 1 << 
œq
;

230 
æags
;

232 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

248 ià(
ÿched_œq_mask
 & 
œqmask
)

249 
¥urious_8259A_œq
;

250 
ÿched_œq_mask
 |ğ
œqmask
;

252 
hªdË_»®_œq
:

253 ià(
œq
 & 8) {

254 
	`šb
(0xA1);

255 
	`outb
(
ÿched_A1
,0xA1);

256 
	`outb
(0x60+(
œq
&7),0xA0);

257 
	`outb
(0x62,0x20);

259 
	`šb
(0x21);

260 
	`outb
(
ÿched_21
,0x21);

261 
	`outb
(0x60+
œq
,0x20);

263 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

266 
¥urious_8259A_œq
:

270 ià(
	`i8259A_œq_»®
(
œq
))

275 
hªdË_»®_œq
;

278 
¥urious_œq_mask
;

283 ià(!(
¥urious_œq_mask
 & 
œqmask
)) {

284 
	`´štk
("¥uriou 8259A iÁ”ru±: IRQ%d.\n", 
œq
);

285 
¥urious_œq_mask
 |ğ
œqmask
;

292 
hªdË_»®_œq
;

294 
	}
}

296 
	gœq_Œigg”
[2];

300 
	$»¡Üe_ELCR
(*
Œigg”
)

302 
	`outb
(
Œigg”
[0], 0x4d0);

303 
	`outb
(
Œigg”
[1], 0x4d1);

304 
	}
}

306 
	$§ve_ELCR
(*
Œigg”
)

309 
Œigg”
[0] = 
	`šb
(0x4d0) & 0xF8;

310 
Œigg”
[1] = 
	`šb
(0x4d1) & 0xDE;

311 
	}
}

313 
	$i8259A_»sume
()

315 
	`š™_8259A
(0);

316 
	`»¡Üe_ELCR
(
œq_Œigg”
);

318 
	}
}

320 
	$i8259A_su¥’d
()

322 
	`§ve_ELCR
(
œq_Œigg”
);

324 
	}
}

326 
__devš™
 
	$š™_8259A
(
auto_eoi
)

328 
æags
;

330 
	`¥š_lock_œq§ve
(&
i8259A_lock
, 
æags
);

332 
	`outb
(0xff, 0x21);

333 
	`outb
(0xff, 0xA1);

338 
	`outb_p
(0x11, 0x20);

339 
	`outb_p
(
FIRST_LEGACY_VECTOR
 + 0, 0x21);

340 
	`outb_p
(0x04, 0x21);

341 ià(
auto_eoi
)

342 
	`outb_p
(0x03, 0x21);

344 
	`outb_p
(0x01, 0x21);

346 
	`outb_p
(0x11, 0xA0);

347 
	`outb_p
(
FIRST_LEGACY_VECTOR
 + 8, 0xA1);

348 
	`outb_p
(0x02, 0xA1);

349 
	`outb_p
(0x01, 0xA1);

352 ià(
auto_eoi
)

357 
i8259A_œq_ty³
.
ack
 = 
di§bË_8259A_œq
;

359 
i8259A_œq_ty³
.
ack
 = 
mask_ªd_ack_8259A_œq
;

361 
	`ud–ay
(100);

363 
	`outb
(
ÿched_21
, 0x21);

364 
	`outb
(
ÿched_A1
, 0xA1);

366 
	`¥š_uÆock_œq»¡Üe
(&
i8259A_lock
, 
æags
);

367 
	}
}

369 
__š™
 
	$make_8259A_œq
(
œq
)

371 
io_­ic_œqs
 &ğ~(1 << 
œq
);

372 
	`œq_to_desc
(
œq
)->
hªdËr
 = &
i8259A_œq_ty³
;

373 
	}
}

375 
œqaùiÚ
 
__»ad_mo¡ly
 
	gÿsÿde
 = { 
no_aùiÚ
, "ÿsÿde", 
NULL
};

377 
__š™
 
	$š™_IRQ
()

379 
veùÜ
, 
œq
, 
ıu
 = 
	`smp_´oûssÜ_id
();

381 
	`š™_b¥_APIC
();

383 
	`š™_8259A
(0);

385 
	`BUG_ON
(
	`š™_œq_d©a
() < 0);

387  
veùÜ
 = 
FIRST_DYNAMIC_VECTOR
; veùÜ < 
NR_VECTORS
; vector++ )

389 ià(
veùÜ
 =ğ
HYPERCALL_VECTOR
 || veùÜ =ğ
LEGACY_SYSCALL_VECTOR
)

391 
	`£t_šŒ_g©e
(
veùÜ
, 
š‹¼u±
[vector]);

394 
œq
 = 0; 
	`¶©fÜm_Ëgacy_œq
(irq); irq++) {

395 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

396 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

398 
desc
->
hªdËr
 = &
i8259A_œq_ty³
;

399 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
FIRST_LEGACY_VECTOR
 + 
œq
] = irq;

400 
cfg
->
ıu_mask
ğ
	`ıumask_of_ıu
(
ıu
);

401 
cfg
->
veùÜ
 = 
FIRST_LEGACY_VECTOR
 + 
œq
;

404 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
FIRST_HIPRIORITY_VECTOR
] = 0;

406 
	`­ic_šŒ_š™
();

409 
	#CLOCK_TICK_RATE
 1193182

	)

410 
	#LATCH
 (((
CLOCK_TICK_RATE
)+(
HZ
/2))/HZ)

	)

411 
	`outb_p
(0x34, 
PIT_MODE
);

412 
	`outb_p
(
LATCH
 & 0xff, 
PIT_CH0
);

413 
	`outb
(
LATCH
 >> 8, 
PIT_CH0
);

415 
	`£tup_œq
(2, &
ÿsÿde
);

416 
	}
}

	@introspect.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_INTROSPECT


26 
	tk”Ãl_ÿp_t
;

27 
	tuid_t
, 
	tgid_t
;

28 
	tıutime_t
;

29 
	ttime_t
;

31 
	stime¥ec
 {

32 
time_t
 
	mtv_£c
;

33 
	mtv_n£c
;

36 
	epid_ty³


38 
	mPIDTYPE_PID
,

39 
	mPIDTYPE_PGID
,

40 
	mPIDTYPE_SID
,

41 
	mPIDTYPE_MAX


44 
	gcom¶‘iÚ
;

45 
	gpid
;

46 
	spid_lšk


48 
hli¡_node
 
	mnode
;

49 
pid
 *
	mpid
;

52 
	ssched_šfo
 {

54 
	mıu_time
,

55 
	mrun_d–ay
,

56 
	mpút
;

59 
	mÏ¡_¬riv®
,

60 
	mÏ¡_queued
;

64 
	tmm_£gm’t_t
;

69 
	s»¡¬t_block
 {

70 (*
	mâ
)(
	m»¡¬t_block
 *);

71 
	m¬g0
, 
	m¬g1
, 
	m¬g2
, 
	m¬g3
;

74 
	sth»ad_šfo
 {

75 
sk_¡ruù
 *
	msk
;

76 
exec_domaš
 *
	mexec_domaš
;

77 
	mæags
;

78 
	m¡©us
;

79 
__u32
 
	mıu
;

80 
	m´“m±_couÁ
;

83 
mm_£gm’t_t
 
	maddr_lim™
;

87 *
	msy£Á”_»tuº
;

88 
»¡¬t_block
 
	m»¡¬t_block
;

90 
	m´evious_e¥
;

93 
__u8
 
	msu³rvisÜ_¡ack
[0];

96 
	e¦“p_ty³
 {

97 
	mSLEEP_NORMAL
,

98 
	mSLEEP_NONINTERACTIVE
,

99 
	mSLEEP_INTERACTIVE
,

100 
	mSLEEP_INTERRUPTED
,

103 
	g´io_¬¿y
;

104 
	glšux_bšfmt
;

105 
	tpid_t
;

107 
	#TASK_COMM_LEN
 16

	)

108 
	ssk_¡ruù
 {

109 vŞ©
	m¡©e
;

110 
th»ad_šfo
 *
	mth»ad_šfo
;

111 
©omic_t
 
	mu§ge
;

112 
	mæags
;

113 
	m±¿û
;

115 
	mlock_d•th
;

117 
	mlßd_weight
;

118 
	m´io
, 
	m¡©ic_´io
, 
	mnÜm®_´io
;

119 
li¡_h—d
 
	mrun_li¡
;

120 
´io_¬¿y
 *
	m¬¿y
;

122 
	miİrio
;

123 
	mbŒaû_£q
;

125 
	m¦“p_avg
;

126 
	mtime¡amp
, 
	mÏ¡_¿n
;

127 
	msched_time
;

128 
¦“p_ty³
 
	m¦“p_ty³
;

130 
	mpŞicy
;

131 
ıumask_t
 
	mıus_®lowed
;

132 
	mtime_¦iû
, 
	mfœ¡_time_¦iû
;

134 
sched_šfo
 
	msched_šfo
;

136 
li¡_h—d
 
	msks
;

141 
li¡_h—d
 
	m±¿û_chd»n
;

142 
li¡_h—d
 
	m±¿û_li¡
;

144 
mm_¡ruù
 *
	mmm
, *
	maùive_mm
;

147 
lšux_bšfmt
 *
	mbšfmt
;

148 
	mex™_¡©e
;

149 
	mex™_code
, 
	mex™_sigÇl
;

150 
	mpd—th_sigÇl
;

152 
	m³rsÚ®™y
;

153 
	mdid_exec
:1;

154 
pid_t
 
	mpid
;

155 
pid_t
 
	mtgid
;

162 
sk_¡ruù
 *
	m»®_·»Á
;

163 
sk_¡ruù
 *
	m·»Á
;

168 
li¡_h—d
 
	mchd»n
;

169 
li¡_h—d
 
	msiblšg
;

170 
sk_¡ruù
 *
	mgroup_Ëad”
;

173 
pid_lšk
 
	mpids
[
PIDTYPE_MAX
];

174 
li¡_h—d
 
	mth»ad_group
;

176 
com¶‘iÚ
 *
	mvfÜk_dÚe
;

177 
__u£r
 *
	m£t_chd_tid
;

178 
__u£r
 *
	mş—r_chd_tid
;

180 
	m¹_´iÜ™y
;

181 
ıutime_t
 
	mutime
, 
	m¡ime
;

182 
	mnvcsw
, 
	mnivcsw
;

183 
time¥ec
 
	m¡¬t_time
;

185 
	mmš_æt
, 
	mmaj_æt
;

187 
ıutime_t
 
	m™_´of_expœes
, 
	m™_vœt_expœes
;

188 
	m™_sched_expœes
;

189 
li¡_h—d
 
	mıu_tim”s
[3];

192 
uid_t
 
	muid
,
	meuid
,
	msuid
,
	mfsuid
;

193 
gid_t
 
	mgid
,
	megid
,
	msgid
,
	mfsgid
;

194 
group_šfo
 *
	mgroup_šfo
;

195 
k”Ãl_ÿp_t
 
	mÿp_efãùive
, 
	mÿp_šh”™abË
, 
	mÿp_³rm™‹d
;

196 
	mk“p_ÿ·b™›s
:1;

197 
u£r_¡ruù
 *
	mu£r
;

199 
key
 *
	m»que¡_key_auth
;

200 
key
 *
	mth»ad_keyršg
;

201 
	mj™_keyršg
;

203 
	moomkÏdj
;

204 
	mcomm
[
TASK_COMM_LEN
];

217 
	#PF_ALIGNWARN
 0x00000001

	)

219 
	#PF_STARTING
 0x00000002

	)

220 
	#PF_EXITING
 0x00000004

	)

221 
	#PF_DEAD
 0x00000008

	)

222 
	#PF_FORKNOEXEC
 0x00000040

	)

223 
	#PF_SUPERPRIV
 0x00000100

	)

224 
	#PF_DUMPCORE
 0x00000200

	)

225 
	#PF_SIGNALED
 0x00000400

	)

226 
	#PF_MEMALLOC
 0x00000800

	)

227 
	#PF_FLUSHER
 0x00001000

	)

228 
	#PF_USED_MATH
 0x00002000

	)

229 
	#PF_FREEZE
 0x00004000

	)

230 
	#PF_NOFREEZE
 0x00008000

	)

231 
	#PF_FROZEN
 0x00010000

	)

232 
	#PF_FSTRANS
 0x00020000

	)

233 
	#PF_KSWAPD
 0x00040000

	)

234 
	#PF_SWAPOFF
 0x00080000

	)

235 
	#PF_LESS_THROTTLE
 0x00100000

	)

236 
	#PF_BORROWED_MM
 0x00200000

	)

237 
	#PF_RANDOMIZE
 0x00400000

	)

238 
	#PF_SWAPWRITE
 0x00800000

	)

239 
	#PF_SPREAD_PAGE
 0x01000000

	)

240 
	#PF_SPREAD_SLAB
 0x02000000

	)

241 
	#PF_MEMPOLICY
 0x10000000

	)

242 
	#PF_MUTEX_TESTER
 0x20000000

	)

247 
	#LINUX_KERNEL_STACK_MASK
 (~0x1FFF)

	)

250 
	sšŒo¥eù_guessšg
 {

255 
	$g‘_tgid
(
k¡ack
)

257 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

258 ià(!
k¡ack
)

260 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

261 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

262 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

263 
i
;

264 #ifdeà
DEBUG_ASSERT


265 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

266 
	`my·nic
("ts->thread_info !=i?!?");

268  
ts
->
tgid
;

269 
	}
}

271 
	$g‘_¡©ic_´io
(
k¡ack
)

273 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

274 ià(!
k¡ack
)

276 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

277 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

278 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

279 
i
;

280 #ifdeà
DEBUG_ASSERT


281 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

282 
	`my·nic
("ts->thread_info !=i?!?");

284  
ts
->
¡©ic_´io
;

285 
	}
}

287 
	$g‘_nÜm®_´io
(
k¡ack
)

289 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

290 ià(!
k¡ack
)

292 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

293 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

294 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

295 
i
;

296 #ifdeà
DEBUG_ASSERT


297 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

298 
	`my·nic
("ts->thread_info !=i?!?");

300  
ts
->
nÜm®_´io
;

301 
	}
}

303 
	$g‘_¹_´io
(
k¡ack
)

305 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

306 ià(!
k¡ack
)

308 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

309 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

310 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

311 
i
;

312 #ifdeà
DEBUG_ASSERT


313 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

314 
	`my·nic
("ts->thread_info !=i?!?");

316  
ts
->
¹_´iÜ™y
;

317 
	}
}

319 
	$g‘_´io
(
k¡ack
)

321 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

322 ià(!
k¡ack
)

324 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

325 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

326 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

327 
i
;

328 #ifdeà
DEBUG_ASSERT


329 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

330 
	`my·nic
("ts->thread_info !=i?!?");

332  
ts
->
´io
;

333 
	}
}

335 
	$g‘_pid
(
k¡ack
)

337 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

338 ià(!
k¡ack
)

340 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

341 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

342 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

343 
i
;

344 #ifdeà
DEBUG_ASSERT


345 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

346 
	`my·nic
("ts->thread_info !=i?!?");

348  
ts
->
pid
;

349 
	}
}

351 
	$g‘_mm
(
k¡ack
)

353 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

354 ià(!
k¡ack
)

356 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

357 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

358 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

359 
i
;

360 #ifdeà
DEBUG_ASSERT


361 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

362 
	`my·nic
("ts->thread_info !=i?!?");

364  
ts
->
mm
;

365 
	}
}

367 *
	$g‘_comm
(
k¡ack
)

369 
k¡ack
 = k¡ack & 
LINUX_KERNEL_STACK_MASK
;

370 ià(!
k¡ack
)

372 
	`MYASSERT
(
k¡ack
 >= 0xC0000000);

373 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

374 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

375 
i
;

376 #ifdeà
DEBUG_ASSERT


377 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

378 
	`my·nic
("ts->thread_info !=i?!?");

380  
ts
->
comm
;

384 
	}
}

386 
	$Œª¦©e_što_Ïx™y
(
e¥
)

388 
k¡ack
 = 
e¥
 & 
LINUX_KERNEL_STACK_MASK
;

389 
	`MYASSERT
(
e¥
 == 0 ||ƒsp >= 0xC0000000);

391 ià(!
k¡ack
)

393 
th»ad_šfo
 *
ti
 = (th»ad_šfØ*)
k¡ack
;

394 
sk_¡ruù
 *
ts
 = 
ti
->
sk
;

395 ià(!
ts
)

397 #ifdeà
DEBUG_ASSERT


398 ià(
ts
->
th»ad_šfo
 !ğ
ti
)

399 
	`my·nic
("ts->thread_info !=i?!?");

401  
ts
->
´io
;

402 
	}
}

407 
	$upd©e_gue¡_sk
(
Şd
, 
e¥
)

419 
	`TRACE_4D
(
TRC_MIN_STACK_SWITCH
, 
cu¼’t
->
domaš
->
domaš_id
, cu¼’t->
vıu_id
, 
Şd
, 
e¥
);

422 ià(
cu¼’t
->
´št_couÁdown
) {

423 #ifdeà
ENABLE_INTROSPECT


424 
	`my´štk
("[%s,%5d.%5d %d,%d,%d,%d -> %s,%5d.%5d %d,%d,%d,%d]\n", 
	`g‘_comm
(
Şd
), 
	`g‘_pid
(Şd), 
	`g‘_tgid
(Şd), 
	`g‘_´io
(Şd), 
	`g‘_¡©ic_´io
(Şd), 
	`g‘_nÜm®_´io
(Şd), 
	`g‘_¹_´io
(Şd), g‘_comm(
e¥
), get_pid(esp), get_tgid(esp), get_prio(esp), get_static_prio(esp), get_normal_prio(esp) , get_rt_prio(esp) );

426 
cu¼’t
->
´št_couÁdown
--;

444 
	}
}

447 *
	$g‘_comm
(
k¡ack
)

450 
	}
}

	@io_apic.c

23 
	~<x’/cÚfig.h
>

24 
	~<x’/lib.h
>

25 
	~<x’/š™.h
>

26 
	~<x’/œq.h
>

27 
	~<x’/d–ay.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/aıi.h
>

30 
	~<x’/pci.h
>

31 
	~<x’/pci_»gs.h
>

32 
	~<x’/keyhªdËr.h
>

33 
	~<asm/mc146818¹c.h
>

34 
	~<asm/smp.h
>

35 
	~<asm/desc.h
>

36 
	~<asm/msi.h
>

37 
	~<mach_­ic.h
>

38 
	~<io_pÜts.h
>

39 
	~<public/physdev.h
>

42 ¡ruù { 
	mpš
, 
	m­ic
; } 
	gißpic_i8259
 = { -1, -1 };

44 
DEFINE_SPINLOCK
(
ißpic_lock
);

46 
boŞ_t
 
__»ad_mo¡ly
 
	gsk_ißpic_£tup
;

48 #iâdeà
sis_­ic_bug


53 
	gsis_­ic_bug
 = -1;

59 
__»ad_mo¡ly
 
	gÄ_ißpic_»gi¡”s
[
MAX_IO_APICS
];

60 
__»ad_mo¡ly
 
	gÄ_ißpics
;

66 
	#MAX_PLUS_SHARED_IRQS
 
Ä_œqs_gsi


	)

67 
	#PIN_MAP_SIZE
 (
MAX_PLUS_SHARED_IRQS
 + 
Ä_œqs_gsi
)

	)

76 
	sœq_pš_li¡
 {

77 
	m­ic
, 
	mpš
;

78 
	mÃxt
;

79 } *
	gœq_2_pš
;

81 
	gœq_2_pš_ä“_’Œy
;

88 
	$add_pš_to_œq
(
œq
, 
­ic
, 
pš
)

90 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

92 
’Œy
->
Ãxt
) {

93 
	`BUG_ON
((
’Œy
->
­ic
 =ğ­icè&& (’Œy->
pš
 ==…in));

94 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

97 
	`BUG_ON
((
’Œy
->
­ic
 =ğ­icè&& (’Œy->
pš
 ==…in));

99 ià(
’Œy
->
pš
 != -1) {

100 ià(
œq_2_pš_ä“_’Œy
 >ğ
PIN_MAP_SIZE
)

101 
	`·nic
("io_apic.c: whoops");

102 
’Œy
->
Ãxt
 = 
œq_2_pš_ä“_’Œy
;

103 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

104 
œq_2_pš_ä“_’Œy
 = 
’Œy
->
Ãxt
;

105 
’Œy
->
Ãxt
 = 0;

107 
’Œy
->
­ic
 =‡pic;

108 
’Œy
->
pš
 =…in;

109 
	}
}

114 
__š™
 
	$»¶aû_pš_©_œq
(
œq
,

115 
Şd­ic
, 
Şdpš
,

116 
Ãw­ic
, 
Ãwpš
)

118 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

121 ià(
’Œy
->
­ic
 =ğ
Şd­ic
 &&ƒÁry->
pš
 =ğ
Şdpš
) {

122 
’Œy
->
­ic
 = 
Ãw­ic
;

123 
’Œy
->
pš
 = 
Ãwpš
;

125 ià(!
’Œy
->
Ãxt
)

127 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

129 
	}
}

131 
IO_APIC_rou‹_’Œy
 **
	$®loc_ißpic_’Œ›s
()

133 
­ic
;

134 
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
;

136 
ißpic_’Œ›s
 = 
	`xm®loc_¬¿y
(
IO_APIC_rou‹_’Œy
 *, 
Ä_ißpics
);

137 ià(!
ißpic_’Œ›s
)

140 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

141 
ißpic_’Œ›s
[
­ic
] =

142 
	`xm®loc_¬¿y
(
IO_APIC_rou‹_’Œy
,

143 
Ä_ißpic_»gi¡”s
[
­ic
]);

144 ià(!
ißpic_’Œ›s
[
­ic
])

145 
nomem
;

148  
ißpic_’Œ›s
;

150 
nomem
:

151 --
­ic
 >= 0)

152 
	`xä“
(
ißpic_’Œ›s
[
­ic
]);

153 
	`xä“
(
ißpic_’Œ›s
);

156 
	}
}

158 
	u’Œy_uniÚ
 {

159 ¡ruù { 
u32
 
	mw1
, 
	mw2
; };

160 
IO_APIC_rou‹_’Œy
 
	m’Œy
;

163 
IO_APIC_rou‹_’Œy
 
	$__ißpic_»ad_’Œy
(
­ic
, 
pš
, 
¿w
)

165 (*
»ad
)(, )

166 ğ
¿w
 ? 
__io_­ic_»ad
 : 
io_­ic_»ad
;

167 
’Œy_uniÚ
 
eu
;

168 
eu
.
w1
 = (*
»ad
)(
­ic
, 0x10 + 2 * 
pš
);

169 
eu
.
w2
 = (*
»ad
)(
­ic
, 0x11 + 2 * 
pš
);

170  
eu
.
’Œy
;

171 
	}
}

173 
IO_APIC_rou‹_’Œy
 
	$ißpic_»ad_’Œy
(
­ic
, 
pš
, 
¿w
)

175 
IO_APIC_rou‹_’Œy
 
’Œy
;

176 
æags
;

178 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

179 
’Œy
 = 
	`__ißpic_»ad_’Œy
(
­ic
, 
pš
, 
¿w
);

180 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

181  
’Œy
;

182 
	}
}

185 
	$__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
¿w
, 
IO_APIC_rou‹_’Œy
 
e
)

187 (*
wr™e
)(, , )

188 ğ
¿w
 ? 
__io_­ic_wr™e
 : 
io_­ic_wr™e
;

189 
’Œy_uniÚ
 
eu
 = {{0, 0}};

191 
eu
.
’Œy
 = 
e
;

192 (*
wr™e
)(
­ic
, 0x11 + 2*
pš
, 
eu
.
w2
);

193 (*
wr™e
)(
­ic
, 0x10 + 2*
pš
, 
eu
.
w1
);

194 
	}
}

196 
	$ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
¿w
, 
IO_APIC_rou‹_’Œy
 
e
)

198 
æags
;

199 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

200 
	`__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
¿w
, 
e
);

201 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

202 
	}
}

207 
	$§ve_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

209 
­ic
, 
pš
;

211 ià(!
ißpic_’Œ›s
)

212  -
ENOMEM
;

214 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

215 ià(!
ißpic_’Œ›s
[
­ic
])

216  -
ENOMEM
;

218 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

219 
ißpic_’Œ›s
[
­ic
][
pš
] = 
	`__ißpic_»ad_’Œy
(apic,…in, 1);

223 
	}
}

228 
	$mask_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

230 
­ic
, 
pš
;

232 ià(!
ißpic_’Œ›s
)

235 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

236 ià(!
ißpic_’Œ›s
[
­ic
])

239 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

240 
IO_APIC_rou‹_’Œy
 
’Œy
;

242 
’Œy
 = 
ißpic_’Œ›s
[
­ic
][
pš
];

243 ià(!
’Œy
.
mask
) {

244 
’Œy
.
mask
 = 1;

246 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 1, 
’Œy
);

250 
	}
}

255 
	$»¡Üe_IO_APIC_£tup
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

257 
­ic
, 
pš
;

259 ià(!
ißpic_’Œ›s
)

260  -
ENOMEM
;

262 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

263 ià(!
ißpic_’Œ›s
[
­ic
])

264  -
ENOMEM
;

266 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++)

267 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 1, 
ißpic_’Œ›s
[apic][pin]);

271 
	}
}

273 
	$ä“_ißpic_’Œ›s
(
IO_APIC_rou‹_’Œy
 **
ißpic_’Œ›s
)

275 
­ic
;

277 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++)

278 
	`xä“
(
ißpic_’Œ›s
[
­ic
]);

280 
	`xä“
(
ißpic_’Œ›s
);

281 
	}
}

283 
	$__modify_IO_APIC_œq
 (
œq
, 
’abË
, 
di§bË
)

285 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

286 
pš
, 
»g
;

289 
pš
 = 
’Œy
->pin;

290 ià(
pš
 == -1)

292 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
*2);

293 
»g
 &ğ~
di§bË
;

294 
»g
 |ğ
’abË
;

295 
	`io_­ic_modify
(
’Œy
->
­ic
, 0x10 + 
pš
*2, 
»g
);

296 ià(!
’Œy
->
Ãxt
)

298 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

300 
	}
}

303 
	$__mask_IO_APIC_œq
 (
œq
)

305 
	`__modify_IO_APIC_œq
(
œq
, 0x00010000, 0);

306 
	}
}

309 
	$__unmask_IO_APIC_œq
 (
œq
)

311 
	`__modify_IO_APIC_œq
(
œq
, 0, 0x00010000);

312 
	}
}

315 
	$__edge_IO_APIC_œq
 (
œq
)

317 
	`__modify_IO_APIC_œq
(
œq
, 0, 0x00008000);

318 
	}
}

321 
	$__Ëv–_IO_APIC_œq
 (
œq
)

323 
	`__modify_IO_APIC_œq
(
œq
, 0x00008000, 0);

324 
	}
}

326 
	$mask_IO_APIC_œq
 (
œq
)

328 
æags
;

330 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

331 
	`__mask_IO_APIC_œq
(
œq
);

332 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

333 
	}
}

335 
	$unmask_IO_APIC_œq
 (
œq
)

337 
æags
;

339 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

340 
	`__unmask_IO_APIC_œq
(
œq
);

341 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

342 
	}
}

344 
	$__eoi_IO_APIC_œq
(
œq
)

346 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
œq
;

347 
pš
, 
veùÜ
 = 
	`IO_APIC_VECTOR
(
œq
);

350 
pš
 = 
’Œy
->pin;

351 ià(
pš
 == -1)

353 
	`io_­ic_eoi
(
’Œy
->
­ic
, 
veùÜ
);

354 ià(!
’Œy
->
Ãxt
)

356 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

358 
	}
}

360 
	$eoi_IO_APIC_œq
(
œq
)

362 
æags
;

363 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

364 
	`__eoi_IO_APIC_œq
(
œq
);

365 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

366 
	}
}

368 
	#ş—r_IO_APIC_pš
(
a
,
p
è
	`__ş—r_IO_APIC_pš
×,p,0)

	)

369 
	#ş—r_IO_APIC_pš_¿w
(
a
,
p
è
	`__ş—r_IO_APIC_pš
×,p,1)

	)

370 
	$__ş—r_IO_APIC_pš
(
­ic
, 
pš
, 
¿w
)

372 
IO_APIC_rou‹_’Œy
 
’Œy
;

375 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
, 
¿w
);

376 ià(
’Œy
.
d–iv”y_mode
 =ğ
de¡_SMI
)

382 
	`mem£t
(&
’Œy
, 0, (entry));

383 
’Œy
.
mask
 = 1;

384 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 
¿w
, 
’Œy
);

385 
	}
}

387 
	$ş—r_IO_APIC
 ()

389 
­ic
, 
pš
;

391 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

392 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

393 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

394 
	`ş—r_IO_APIC_pš_¿w
(
­ic
, 
pš
);

397 
	}
}

399 #ifdeà
CONFIG_SMP


400 
ç¡ÿÎ
 
	$smp_œq_move_ş—nup_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

402 
veùÜ
, 
me
;

403 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

405 
	`ack_APIC_œq
();

406 
	`œq_’‹r
();

408 
me
 = 
	`smp_´oûssÜ_id
();

409 
veùÜ
 = 
FIRST_DYNAMIC_VECTOR
; veùÜ < 
NR_VECTORS
; vector++) {

410 
œq
;

411 
œr
;

412 
œq_desc
 *
desc
;

413 
œq_cfg
 *
cfg
;

414 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
];

416 ià(
œq
 == -1)

419 
desc
 = 
	`œq_to_desc
(
œq
);

420 ià(!
desc
)

423 
cfg
 = 
desc
->
ch_d©a
;

424 
	`¥š_lock
(&
desc
->
lock
);

425 ià(!
cfg
->
move_ş—nup_couÁ
)

426 
uÆock
;

428 ià(
veùÜ
 =ğ
cfg
->veùÜ && 
	`ıu_is£t
(
me
, cfg->
ıu_mask
))

429 
uÆock
;

431 
œr
 = 
	`­ic_»ad
(
APIC_IRR
 + (
veùÜ
 / 32 * 0x10));

439 ià(
œr
 & (1 << (
veùÜ
 % 32))) {

440 
g’­ic
->
	`£nd_IPI_£lf
(
IRQ_MOVE_CLEANUP_VECTOR
);

441 
uÆock
;

443 
	`__g‘_ıu_v¬
(
veùÜ_œq
)[
veùÜ
] = -1;

444 
cfg
->
move_ş—nup_couÁ
--;

445 
uÆock
:

446 
	`¥š_uÆock
(&
desc
->
lock
);

449 
	`œq_ex™
();

450 
	`£t_œq_»gs
(
Şd_»gs
);

451 
	}
}

453 
	$£nd_ş—nup_veùÜ
(
œq_cfg
 *
cfg
)

455 
ıumask_t
 
ş—nup_mask
;

457 
	`ıus_ªd
(
ş—nup_mask
, 
cfg
->
Şd_ıu_mask
, 
ıu_Úlše_m­
);

458 
cfg
->
move_ş—nup_couÁ
 = 
	`ıus_weight
(
ş—nup_mask
);

459 
g’­ic
->
	`£nd_IPI_mask
(&
ş—nup_mask
, 
IRQ_MOVE_CLEANUP_VECTOR
);

461 
cfg
->
move_š_´og»ss
 = 0;

462 
	}
}

464 
	$œq_com¶‘e_move
(
œq_desc
 **
desı
)

466 
œq_desc
 *
desc
 = *
desı
;

467 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

468 
veùÜ
, 
me
;

470 ià(
	`lik–y
(!
cfg
->
move_š_´og»ss
))

473 
veùÜ
 = 
	`g‘_œq_»gs
()->
’Œy_veùÜ
;

474 
me
 = 
	`smp_´oûssÜ_id
();

476 ià(
veùÜ
 =ğ
cfg
->veùÜ && 
	`ıu_is£t
(
me
, cfg->
ıu_mask
))

477 
	`£nd_ş—nup_veùÜ
(
cfg
);

478 
	}
}

480 
	$£t_desc_affš™y
(
œq_desc
 *
desc
, cÚ¡ 
ıumask_t
 *
mask
)

482 
œq_cfg
 *
cfg
;

483 
œq
;

484 
»t
;

485 
æags
;

486 
ıumask_t
 
de¡_mask
;

488 ià(!
	`ıus_š‹r£ùs
(*
mask
, 
ıu_Úlše_m­
))

489  
BAD_APICID
;

491 
œq
 = 
desc
->irq;

492 
cfg
 = 
desc
->
ch_d©a
;

494 
	`loÿl_œq_§ve
(
æags
);

495 
	`lock_veùÜ_lock
();

496 
»t
 = 
	`__assign_œq_veùÜ
(
œq
, 
cfg
, 
mask
);

497 
	`uÆock_veùÜ_lock
();

498 
	`loÿl_œq_»¡Üe
(
æags
);

500 ià(
»t
 < 0)

501  
BAD_APICID
;

503 
	`ıus_cİy
(
desc
->
affš™y
, *
mask
);

504 
	`ıus_ªd
(
de¡_mask
, *
mask
, 
cfg
->
ıu_mask
);

506  
	`ıu_mask_to_­icid
(&
de¡_mask
);

507 
	}
}

510 
	$£t_ißpic_affš™y_œq_desc
(
œq_desc
 *
desc
, cÚ¡ 
ıumask_t
 *
mask
)

512 
æags
;

513 
de¡
;

514 
pš
, 
œq
;

515 
œq_cfg
 *
cfg
;

516 
œq_pš_li¡
 *
’Œy
;

518 
œq
 = 
desc
->irq;

519 
cfg
 = 
desc
->
ch_d©a
;

521 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

522 
de¡
 = 
	`£t_desc_affš™y
(
desc
, 
mask
);

523 ià(
de¡
 !ğ
BAD_APICID
) {

524 iàĞ!
x2­ic_’abËd
 )

525 
de¡
 = 
	`SET_APIC_LOGICAL_ID
(dest);

526 
’Œy
 = 
œq_2_pš
 + 
œq
;

528 
d©a
;

529 
pš
 = 
’Œy
->pin;

530 ià(
pš
 == -1)

533 
	`io_­ic_wr™e
(
’Œy
->
­ic
, 0x10 + 1 + 
pš
*2, 
de¡
);

534 
d©a
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
*2);

535 
d©a
 &ğ~
IO_APIC_REDIR_VECTOR_MASK
;

536 
d©a
 |ğ
cfg
->
veùÜ
 & 0xFF;

537 
	`io_­ic_modify
(
’Œy
->
­ic
, 0x10 + 
pš
*2, 
d©a
);

539 ià(!
’Œy
->
Ãxt
)

541 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

544 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

546 
	}
}

549 
	$£t_ißpic_affš™y_œq
(
œq
, cÚ¡ 
ıumask
 
mask
)

551 
œq_desc
 *
desc
;

553 
desc
 = 
	`œq_to_desc
(
œq
);

555 
	`£t_ißpic_affš™y_œq_desc
(
desc
, &
mask
);

556 
	}
}

562 
	$fšd_œq_’Œy
(
­ic
, 
pš
, 
ty³
)

564 
i
;

566 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

567 ià(
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
 &&

568 (
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
mp_ißpics
[
­ic
].
mpc_­icid
 ||

569 
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
MP_APIC_ALL
) &&

570 
mp_œqs
[
i
].
mpc_d¡œq
 =ğ
pš
)

571  
i
;

574 
	}
}

579 
__š™
 
	$fšd_i§_œq_pš
(
œq
, 
ty³
)

581 
i
;

583 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

584 
lbus
 = 
mp_œqs
[
i
].
mpc_¤cbus
;

586 ià((
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_ISA
 ||

587 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_EISA
 ||

588 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_MCA
 ||

589 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_NEC98


591 (
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
) &&

592 (
mp_œqs
[
i
].
mpc_¤cbusœq
 =ğ
œq
))

594  
mp_œqs
[
i
].
mpc_d¡œq
;

597 
	}
}

599 
__š™
 
	$fšd_i§_œq_­ic
(
œq
, 
ty³
)

601 
i
;

603 
i
 = 0; i < 
mp_œq_’Œ›s
; i++) {

604 
lbus
 = 
mp_œqs
[
i
].
mpc_¤cbus
;

606 ià((
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_ISA
 ||

607 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_EISA
 ||

608 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_MCA
 ||

609 
mp_bus_id_to_ty³
[
lbus
] =ğ
MP_BUS_NEC98


611 (
mp_œqs
[
i
].
mpc_œqty³
 =ğ
ty³
) &&

612 (
mp_œqs
[
i
].
mpc_¤cbusœq
 =ğ
œq
))

615 ià(
i
 < 
mp_œq_’Œ›s
) {

616 
­ic
;

617 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

618 ià(
mp_ißpics
[
­ic
].
mpc_­icid
 =ğ
mp_œqs
[
i
].
mpc_d¡­ic
)

619  
­ic
;

624 
	}
}

630 
pš_2_œq
(
idx
, 
­ic
, 
pš
);

637 #ifdeà
CONFIG_SMP


638 
	$£tup_ißpic_de¡
()

640 
pš
, 
ißpic
, 
œq
, 
œq_’Œy
;

641 
œq_cfg
 *
cfg
;

643 ià(
sk_ißpic_£tup
)

646 
ißpic
 = 0; ißpiø< 
Ä_ißpics
; ioapic++) {

647 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
ißpic
];…in++) {

648 
œq_’Œy
 = 
	`fšd_œq_’Œy
(
ißpic
, 
pš
, 
mp_INT
);

649 ià(
œq_’Œy
 == -1)

651 
œq
 = 
	`pš_2_œq
(
œq_’Œy
, 
ißpic
, 
pš
);

652 
cfg
 = 
	`œq_cfg
(
œq
);

653 
	`BUG_ON
(
	`ıus_em±y
(
cfg
->
ıu_mask
));

654 
	`£t_ißpic_affš™y_œq
(
œq
, 
cfg
->
ıu_mask
);

658 
	}
}

664 
	$EISA_ELCR
(
œq
)

666 ià(
	`¶©fÜm_Ëgacy_œq
(
œq
)) {

667 
pÜt
 = 0x4d0 + (
œq
 >> 3);

668  (
	`šb
(
pÜt
è>> (
œq
 & 7)) & 1;

670 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


671 "Brok’ MPbË„•Üt ISA irq %d\n", 
œq
);

673 
	}
}

680 
	#deçuÉ_EISA_Œigg”
(
idx
è(
	`EISA_ELCR
(
mp_œqs
[idx].
mpc_¤cbusœq
))

	)

681 
	#deçuÉ_EISA_pŞ¬™y
(
idx
è(0)

	)

686 
	#deçuÉ_ISA_Œigg”
(
idx
è(0)

	)

687 
	#deçuÉ_ISA_pŞ¬™y
(
idx
è(0)

	)

692 
	#deçuÉ_PCI_Œigg”
(
idx
è(1)

	)

693 
	#deçuÉ_PCI_pŞ¬™y
(
idx
è(1)

	)

698 
	#deçuÉ_MCA_Œigg”
(
idx
è(1)

	)

699 
	#deçuÉ_MCA_pŞ¬™y
(
idx
è(0)

	)

704 
	#deçuÉ_NEC98_Œigg”
(
idx
è(0)

	)

705 
	#deçuÉ_NEC98_pŞ¬™y
(
idx
è(0)

	)

707 
__š™
 
	$MPBIOS_pŞ¬™y
(
idx
)

709 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

710 
pŞ¬™y
;

715 
mp_œqs
[
idx
].
mpc_œqæag
 & 3)

719 
mp_bus_id_to_ty³
[
bus
])

721 
MP_BUS_ISA
:

723 
pŞ¬™y
 = 
	`deçuÉ_ISA_pŞ¬™y
(
idx
);

726 
MP_BUS_EISA
:

728 
pŞ¬™y
 = 
	`deçuÉ_EISA_pŞ¬™y
(
idx
);

731 
MP_BUS_PCI
:

733 
pŞ¬™y
 = 
	`deçuÉ_PCI_pŞ¬™y
(
idx
);

736 
MP_BUS_MCA
:

738 
pŞ¬™y
 = 
	`deçuÉ_MCA_pŞ¬™y
(
idx
);

741 
MP_BUS_NEC98
:

743 
pŞ¬™y
 = 
	`deçuÉ_NEC98_pŞ¬™y
(
idx
);

748 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

749 
pŞ¬™y
 = 1;

757 
pŞ¬™y
 = 0;

762 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

763 
pŞ¬™y
 = 1;

768 
pŞ¬™y
 = 1;

773 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

774 
pŞ¬™y
 = 1;

778  
pŞ¬™y
;

779 
	}
}

781 
	$MPBIOS_Œigg”
(
idx
)

783 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

784 
Œigg”
;

789 (
mp_œqs
[
idx
].
mpc_œqæag
>>2) & 3)

793 
mp_bus_id_to_ty³
[
bus
])

795 
MP_BUS_ISA
:

797 
Œigg”
 = 
	`deçuÉ_ISA_Œigg”
(
idx
);

800 
MP_BUS_EISA
:

802 
Œigg”
 = 
	`deçuÉ_EISA_Œigg”
(
idx
);

805 
MP_BUS_PCI
:

807 
Œigg”
 = 
	`deçuÉ_PCI_Œigg”
(
idx
);

810 
MP_BUS_MCA
:

812 
Œigg”
 = 
	`deçuÉ_MCA_Œigg”
(
idx
);

815 
MP_BUS_NEC98
:

817 
Œigg”
 = 
	`deçuÉ_NEC98_Œigg”
(
idx
);

822 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

823 
Œigg”
 = 1;

831 
Œigg”
 = 0;

836 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

837 
Œigg”
 = 1;

842 
Œigg”
 = 1;

847 
	`´štk
(
KERN_WARNING
 "broken BIOS!!\n");

848 
Œigg”
 = 0;

852  
Œigg”
;

853 
	}
}

855 
šlše
 
	$œq_pŞ¬™y
(
idx
)

857  
	`MPBIOS_pŞ¬™y
(
idx
);

858 
	}
}

860 
šlše
 
	$œq_Œigg”
(
idx
)

862  
	`MPBIOS_Œigg”
(
idx
);

863 
	}
}

865 
	$pš_2_œq
(
idx
, 
­ic
, 
pš
)

867 
œq
, 
i
;

868 
bus
 = 
mp_œqs
[
idx
].
mpc_¤cbus
;

873 ià(
mp_œqs
[
idx
].
mpc_d¡œq
 !ğ
pš
)

874 
	`´štk
(
KERN_ERR
 "broken BIOS or MPTABLE…arser,‡yiee!!\n");

876 
mp_bus_id_to_ty³
[
bus
])

878 
MP_BUS_ISA
:

879 
MP_BUS_EISA
:

880 
MP_BUS_MCA
:

881 
MP_BUS_NEC98
:

883 
œq
 = 
mp_œqs
[
idx
].
mpc_¤cbusœq
;

886 
MP_BUS_PCI
:

891 
i
 = 
œq
 = 0;

892 
i
 < 
­ic
)

893 
œq
 +ğ
Ä_ißpic_»gi¡”s
[
i
++];

894 
œq
 +ğ
pš
;

899 
	`´štk
(
KERN_ERR
 "unknowÀbu ty³ %d.\n",
bus
);

900 
œq
 = 0;

905  
œq
;

906 
	}
}

908 
šlše
 
	$IO_APIC_œq_Œigg”
(
œq
)

910 
­ic
, 
idx
, 
pš
;

912 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

913 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

914 
idx
 = 
	`fšd_œq_’Œy
(
­ic
,
pš
,
mp_INT
);

915 ià((
idx
 !ğ-1è&& (
œq
 =ğ
	`pš_2_œq
(idx,
­ic
,
pš
)))

916  
	`œq_Œigg”
(
idx
);

923 
	}
}

925 
hw_œq_cÚŒŞËr
 
	gißpic_Ëv–_ty³
;

926 
hw_œq_cÚŒŞËr
 
	gißpic_edge_ty³
;

928 
	#IOAPIC_AUTO
 -1

	)

929 
	#IOAPIC_EDGE
 0

	)

930 
	#IOAPIC_LEVEL
 1

	)

932 
	#SET_DEST
(
x
, 
y
, 
v®ue
) \

933 dØ{ iàĞ
x2­ic_’abËd
 ) 
x
 = 
v®ue
; 
y
 = v®ue; } 0)

	)

935 
šlše
 
	$ißpic_»gi¡”_šŒ
(
œq
, 
Œigg”
)

937 ià((
Œigg”
 =ğ
IOAPIC_AUTO
 && 
	`IO_APIC_œq_Œigg”
(
œq
)) ||

938 
Œigg”
 =ğ
IOAPIC_LEVEL
)

939 
œq_desc
[
œq
].
hªdËr
 = &
ißpic_Ëv–_ty³
;

941 
œq_desc
[
œq
].
hªdËr
 = &
ißpic_edge_ty³
;

942 
	}
}

944 
__š™
 
	$£tup_IO_APIC_œqs
()

946 
IO_APIC_rou‹_’Œy
 
’Œy
;

947 
­ic
, 
pš
, 
idx
, 
œq
, 
fœ¡_nÙcÚ
 = 1, 
veùÜ
;

948 
æags
;

949 
œq_cfg
 *
cfg
;

951 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG
 "init IO_APIC IRQs\n");

953 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

954 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

959 
	`mem£t
(&
’Œy
,0,(entry));

961 
’Œy
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

962 
’Œy
.
de¡_mode
 = 
INT_DEST_MODE
;

963 
’Œy
.
mask
 = 0;

965 
idx
 = 
	`fšd_œq_’Œy
(
­ic
,
pš
,
mp_INT
);

966 ià(
idx
 == -1) {

967 ià(
fœ¡_nÙcÚ
) {

968 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_DEBUG


970 
mp_ißpics
[
­ic
].
mpc_­icid
,

971 
pš
);

972 
fœ¡_nÙcÚ
 = 0;

974 
	`­ic_´štk
(
APIC_VERBOSE
, ", %d-%d",

975 
mp_ißpics
[
­ic
].
mpc_­icid
, 
pš
);

979 
’Œy
.
Œigg”
 = 
	`œq_Œigg”
(
idx
);

980 
’Œy
.
pŞ¬™y
 = 
	`œq_pŞ¬™y
(
idx
);

982 ià(
	`œq_Œigg”
(
idx
)) {

983 
’Œy
.
Œigg”
 = 1;

984 
’Œy
.
mask
 = 1;

987 
œq
 = 
	`pš_2_œq
(
idx
, 
­ic
, 
pš
);

992 ià(
	`muÉi_tim”_check
(
­ic
, 
œq
))

995 
	`add_pš_to_œq
(
œq
, 
­ic
, 
pš
);

997 ià(!
­ic
 && !
	`IO_APIC_IRQ
(
œq
))

1000 ià(
	`IO_APIC_IRQ
(
œq
)) {

1001 
veùÜ
 = 
	`assign_œq_veùÜ
(
œq
);

1002 
	`BUG_ON
(
veùÜ
 < 0);

1003 
’Œy
.
veùÜ
 = vector;

1004 
	`ißpic_»gi¡”_šŒ
(
œq
, 
IOAPIC_AUTO
);

1006 ià(!
­ic
 && 
	`¶©fÜm_Ëgacy_œq
(
œq
))

1007 
	`di§bË_8259A_œq
(
œq
);

1009 
cfg
 = 
	`œq_cfg
(
œq
);

1010 
	`SET_DEST
(
’Œy
.
de¡
.
de¡32
,ƒÁry.de¡.
logiÿl
.
logiÿl_de¡
,

1011 
	`ıu_mask_to_­icid
(&
cfg
->
ıu_mask
));

1012 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1013 
	`__ißpic_wr™e_’Œy
(
­ic
, 
pš
, 0, 
’Œy
);

1014 
	`£t_Çtive_œq_šfo
(
œq
, 
TARGET_CPUS
);

1015 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1019 ià(!
fœ¡_nÙcÚ
)

1020 
	`­ic_´štk
(
APIC_VERBOSE
, "‚ot connected.\n");

1021 
	}
}

1026 
__š™
 
	$£tup_ExtINT_IRQ0_pš
(
­ic
, 
pš
, 
veùÜ
)

1028 
IO_APIC_rou‹_’Œy
 
’Œy
;

1030 
	`mem£t
(&
’Œy
,0,(entry));

1032 
	`di§bË_8259A_œq
(0);

1035 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

1041 
’Œy
.
de¡_mode
 = 
INT_DEST_MODE
;

1042 
’Œy
.
mask
 = 0;

1043 
	`SET_DEST
(
’Œy
.
de¡
.
de¡32
,ƒÁry.de¡.
logiÿl
.
logiÿl_de¡
,

1044 
	`ıu_mask_to_­icid
(
TARGET_CPUS
));

1045 
’Œy
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

1046 
’Œy
.
pŞ¬™y
 = 0;

1047 
’Œy
.
Œigg”
 = 0;

1048 
’Œy
.
veùÜ
 = vector;

1054 
œq_desc
[0].
hªdËr
 = &
ißpic_edge_ty³
;

1059 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 0, 
’Œy
);

1061 
	`’abË_8259A_œq
(0);

1062 
	}
}

1064 
šlše
 
	$UNEXPECTED_IO_APIC
()

1066 
	}
}

1068 
	$__´št_IO_APIC
()

1070 
­ic
, 
i
;

1071 
IO_APIC_»g_00
 
»g_00
;

1072 
IO_APIC_»g_01
 
»g_01
;

1073 
IO_APIC_»g_02
 
»g_02
;

1074 
IO_APIC_»g_03
 
»g_03
;

1075 
æags
;

1077 
	`´štk
(
KERN_DEBUG
 "numb” oàMP IRQ sourûs: %d.\n", 
mp_œq_’Œ›s
);

1078 
i
 = 0; i < 
Ä_ißpics
; i++)

1079 
	`´štk
(
KERN_DEBUG
 "number of IO-APIC #%d„egisters: %d.\n",

1080 
mp_ißpics
[
i
].
mpc_­icid
, 
Ä_ißpic_»gi¡”s
[i]);

1086 
	`´štk
(
KERN_INFO
 "testinghe IO APIC.......................\n");

1088 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1090 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1091 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 0);

1092 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 1);

1093 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x10)

1094 
»g_02
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 2);

1095 ià(
»g_01
.
b™s
.
v”siÚ
 >= 0x20)

1096 
»g_03
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 3);

1097 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1099 
	`´štk
(
KERN_DEBUG
 "IO APIC #%d......\n", 
mp_ißpics
[
­ic
].
mpc_­icid
);

1100 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #00: %08X\n", 
»g_00
.
¿w
);

1101 
	`´štk
(
KERN_DEBUG
 "....... :…hysiÿÈAPIC id: %02X\n", 
»g_00
.
b™s
.
ID
);

1102 
	`´štk
(
KERN_DEBUG
 "....... : D–iv”y Ty³: %X\n", 
»g_00
.
b™s
.
d–iv”y_ty³
);

1103 
	`´štk
(
KERN_DEBUG
 "....... : LTS : %X\n", 
»g_00
.
b™s
.
LTS
);

1104 ià(
»g_00
.
b™s
.
ID
 >ğ
	`g‘_physiÿl_brßdÿ¡
())

1105 
	`UNEXPECTED_IO_APIC
();

1106 ià(
»g_00
.
b™s
.
__»£rved_1
 ||„eg_00.b™s.
__»£rved_2
)

1107 
	`UNEXPECTED_IO_APIC
();

1109 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #01: %08X\n", 
»g_01
.
¿w
);

1110 
	`´štk
(
KERN_DEBUG
 "....... : max„edœeùiÚƒÁr›s: %04X\n", 
»g_01
.
b™s
.
’Œ›s
);

1111 iàĞ(
»g_01
.
b™s
.
’Œ›s
 != 0x0f) &&

1112 (
»g_01
.
b™s
.
’Œ›s
 != 0x17) &&

1113 (
»g_01
.
b™s
.
’Œ›s
 != 0x1b) &&

1114 (
»g_01
.
b™s
.
’Œ›s
 != 0x1f) &&

1115 (
»g_01
.
b™s
.
’Œ›s
 != 0x22) &&

1116 (
»g_01
.
b™s
.
’Œ›s
 != 0x2E) &&

1117 (
»g_01
.
b™s
.
’Œ›s
 != 0x3F)

1119 
	`UNEXPECTED_IO_APIC
();

1121 
	`´štk
(
KERN_DEBUG
 "....... : PRQ im¶em’‹d: %X\n", 
»g_01
.
b™s
.
PRQ
);

1122 
	`´štk
(
KERN_DEBUG
 "....... : IO APIC v”siÚ: %04X\n", 
»g_01
.
b™s
.
v”siÚ
);

1123 iàĞ(
»g_01
.
b™s
.
v”siÚ
 != 0x01) &&

1124 (
»g_01
.
b™s
.
v”siÚ
 != 0x10) &&

1125 (
»g_01
.
b™s
.
v”siÚ
 != 0x11) &&

1126 (
»g_01
.
b™s
.
v”siÚ
 != 0x13) &&

1127 (
»g_01
.
b™s
.
v”siÚ
 != 0x20)

1129 
	`UNEXPECTED_IO_APIC
();

1130 ià(
»g_01
.
b™s
.
__»£rved_1
 ||„eg_01.b™s.
__»£rved_2
)

1131 
	`UNEXPECTED_IO_APIC
();

1138 ià(
»g_01
.
b™s
.
v”siÚ
 >ğ0x10 && 
»g_02
.
¿w
 !=„eg_01.raw) {

1139 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #02: %08X\n", 
»g_02
.
¿w
);

1140 
	`´štk
(
KERN_DEBUG
 "....... :‡rb™¿tiÚ: %02X\n", 
»g_02
.
b™s
.
¬b™¿tiÚ
);

1141 ià(
»g_02
.
b™s
.
__»£rved_1
 ||„eg_02.b™s.
__»£rved_2
)

1142 
	`UNEXPECTED_IO_APIC
();

1150 ià(
»g_01
.
b™s
.
v”siÚ
 >ğ0x20 && 
»g_03
.
¿w
 !ğ
»g_02
.raw &&

1151 
»g_03
.
¿w
 !ğ
»g_01
.raw) {

1152 
	`´štk
(
KERN_DEBUG
 "....„egi¡” #03: %08X\n", 
»g_03
.
¿w
);

1153 
	`´štk
(
KERN_DEBUG
 "....... : BoÙ DT : %X\n", 
»g_03
.
b™s
.
boÙ_DT
);

1154 ià(
»g_03
.
b™s
.
__»£rved_1
)

1155 
	`UNEXPECTED_IO_APIC
();

1158 
	`´štk
(
KERN_DEBUG
 ".... IRQ„edirectionable:\n");

1160 
	`´štk
(
KERN_DEBUG
 " NR Log Phy Mask Trig IRR Pol"

1163 
i
 = 0; i <ğ
»g_01
.
b™s
.
’Œ›s
; i++) {

1164 
IO_APIC_rou‹_’Œy
 
’Œy
;

1166 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
i
, 0);

1168 
	`´štk
(
KERN_DEBUG
 " %02x %03X %02X ",

1169 
i
,

1170 
’Œy
.
de¡
.
logiÿl
.
logiÿl_de¡
,

1171 
’Œy
.
de¡
.
physiÿl
.
physiÿl_de¡


1174 
	`´štk
("%1d %1d %1d %1d %1d %1d %1d %02X\n",

1175 
’Œy
.
mask
,

1176 
’Œy
.
Œigg”
,

1177 
’Œy
.
œr
,

1178 
’Œy
.
pŞ¬™y
,

1179 
’Œy
.
d–iv”y_¡©us
,

1180 
’Œy
.
de¡_mode
,

1181 
’Œy
.
d–iv”y_mode
,

1182 
’Œy
.
veùÜ


1186 
	`´štk
(
KERN_INFO
 "Using vector-based indexing\n");

1187 
	`´štk
(
KERN_DEBUG
 "IRQo…in mappings:\n");

1188 
i
 = 0; i < 
Ä_œqs_gsi
; i++) {

1189 
œq_pš_li¡
 *
’Œy
 = 
œq_2_pš
 + 
i
;

1190 ià(
’Œy
->
pš
 < 0)

1192 
	`´štk
(
KERN_DEBUG
 "IRQ%d ", 
	`IO_APIC_VECTOR
(
i
));

1194 
	`´štk
("-> %d:%d", 
’Œy
->
­ic
,ƒÁry->
pš
);

1195 ià(!
’Œy
->
Ãxt
)

1197 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

1199 
	`´štk
("\n");

1202 
	`´štk
(
KERN_INFO
 ".................................... done.\n");

1205 
	}
}

1207 
	$´št_IO_APIC
()

1209 ià(
­ic_v”bos™y
 !ğ
APIC_QUIET
)

1210 
	`__´št_IO_APIC
();

1211 
	}
}

1213 
	$_´št_IO_APIC_keyhªdËr
(
key
)

1215 
	`__´št_IO_APIC
();

1216 
	}
}

1217 
keyhªdËr
 
	g´št_IO_APIC_keyhªdËr
 = {

1218 .
dŸgno¡ic
 = 1,

1219 .
	gu
.
	gâ
 = 
_´št_IO_APIC_keyhªdËr
,

1220 .
	gdesc
 = "print ioapic info"

1223 
__š™
 
	$’abË_IO_APIC
()

1225 
i8259_­ic
, 
i8259_pš
;

1226 
i
, 
­ic
;

1229 
œq_2_pš
 = 
	`xm®loc_¬¿y
(
œq_pš_li¡
, 
PIN_MAP_SIZE
);

1230 
	`mem£t
(
œq_2_pš
, 0, 
PIN_MAP_SIZE
 * (*irq_2_pin));

1232 
i
 = 0; i < 
PIN_MAP_SIZE
; i++)

1233 
œq_2_pš
[
i
].
pš
 = -1;

1234 
i
 = 
œq_2_pš_ä“_’Œy
 = 
Ä_œqs_gsi
; i < 
PIN_MAP_SIZE
; i++)

1235 
œq_2_pš
[
i
].
Ãxt
 = i + 1;

1237 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1238 
pš
;

1240 
pš
 = 0;…š < 
Ä_ißpic_»gi¡”s
[
­ic
];…in++) {

1241 
IO_APIC_rou‹_’Œy
 
’Œy
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
, 0);

1246 ià((
’Œy
.
mask
 =ğ0è&& (’Œy.
d–iv”y_mode
 =ğ
de¡_ExtINT
)) {

1247 
ißpic_i8259
.
­ic
 =‡pic;

1248 
ißpic_i8259
.
pš
 =…in;

1249 
found_i8259
;

1253 
found_i8259
:

1259 
i8259_pš
 = 
	`fšd_i§_œq_pš
(0, 
mp_ExtINT
);

1260 
i8259_­ic
 = 
	`fšd_i§_œq_­ic
(0, 
mp_ExtINT
);

1262 ià((
ißpic_i8259
.
pš
 =ğ-1è&& (
i8259_pš
 >= 0)) {

1263 
	`´štk
(
KERN_WARNING
 "ExtINT‚ot setup in hardware but„eported by MPable\n");

1264 
ißpic_i8259
.
pš
 = 
i8259_pš
;

1265 
ißpic_i8259
.
­ic
 = 
i8259_­ic
;

1268 ià(((
ißpic_i8259
.
­ic
 !ğ
i8259_­ic
è|| (ißpic_i8259.
pš
 !ğ
i8259_pš
)) &&

1269 (
i8259_pš
 >ğ0è&& (
ißpic_i8259
.
pš
 >= 0))

1271 
	`´štk
(
KERN_WARNING
 "ExtINT in hardware‡nd MPable differ\n");

1277 
	`ş—r_IO_APIC
();

1278 
	}
}

1283 
	$di§bË_IO_APIC
()

1288 
	`ş—r_IO_APIC
();

1295 ià(
ißpic_i8259
.
pš
 != -1) {

1296 
IO_APIC_rou‹_’Œy
 
’Œy
;

1298 
	`mem£t
(&
’Œy
, 0, (entry));

1299 
’Œy
.
mask
 = 0;

1300 
’Œy
.
Œigg”
 = 0;

1301 
’Œy
.
œr
 = 0;

1302 
’Œy
.
pŞ¬™y
 = 0;

1303 
’Œy
.
d–iv”y_¡©us
 = 0;

1304 
’Œy
.
de¡_mode
 = 0;

1305 
’Œy
.
d–iv”y_mode
 = 
de¡_ExtINT
;

1306 
’Œy
.
veùÜ
 = 0;

1307 
	`SET_DEST
(
’Œy
.
de¡
.
de¡32
,ƒÁry.de¡.
physiÿl
.
physiÿl_de¡
,

1308 
	`g‘_­ic_id
());

1313 
	`ißpic_wr™e_’Œy
(
ißpic_i8259
.
­ic
, ißpic_i8259.
pš
, 0, 
’Œy
);

1315 
	`discÚÃù_b¥_APIC
(
ißpic_i8259
.
pš
 != -1);

1316 
	}
}

1325 #iâdeà
CONFIG_X86_NUMAQ


1326 
__š™
 
	$£tup_ißpic_ids_äom_mpc
()

1328 
IO_APIC_»g_00
 
»g_00
;

1329 
physid_mask_t
 
phys_id_´e£Á_m­
;

1330 
­ic
;

1331 
i
;

1332 
Şd_id
;

1333 
æags
;

1339 ià(!(
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

1340 || 
	`APIC_XAPIC
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
]))

1347 
phys_id_´e£Á_m­
 = 
	`ißpic_phys_id_m­
(
phys_ıu_´e£Á_m­
);

1352 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

1355 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1356 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 0);

1357 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1359 
Şd_id
 = 
mp_ißpics
[
­ic
].
mpc_­icid
;

1361 ià(
mp_ißpics
[
­ic
].
mpc_­icid
 >ğ
	`g‘_physiÿl_brßdÿ¡
()) {

1362 
	`´štk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID is %d inhe MPCable!...\n",

1363 
­ic
, 
mp_ißpics
[­ic].
mpc_­icid
);

1364 
	`´štk
(
KERN_ERR
 "... fixing upo %d. (tell your hw vendor)\n",

1365 
»g_00
.
b™s
.
ID
);

1366 
mp_ißpics
[
­ic
].
mpc_­icid
 = 
»g_00
.
b™s
.
ID
;

1374 ià(
	`check_­icid_u£d
(
phys_id_´e£Á_m­
,

1375 
mp_ißpics
[
­ic
].
mpc_­icid
)) {

1376 
	`´štk
(
KERN_ERR
 "BIOS bug, IO-APIC#%d ID %d is‡lready used!...\n",

1377 
­ic
, 
mp_ißpics
[­ic].
mpc_­icid
);

1378 
i
 = 0; i < 
	`g‘_physiÿl_brßdÿ¡
(); i++)

1379 ià(!
	`physid_is£t
(
i
, 
phys_id_´e£Á_m­
))

1381 ià(
i
 >ğ
	`g‘_physiÿl_brßdÿ¡
())

1382 
	`·nic
("Max APIC IDƒxceeded!\n");

1383 
	`´štk
(
KERN_ERR
 "... fixing upo %d. (tell your hw vendor)\n",

1384 
i
);

1385 
	`physid_£t
(
i
, 
phys_id_´e£Á_m­
);

1386 
mp_ißpics
[
­ic
].
mpc_­icid
 = 
i
;

1388 
physid_mask_t
 
tmp
;

1389 
tmp
 = 
	`­icid_to_ıu_´e£Á
(
mp_ißpics
[
­ic
].
mpc_­icid
);

1390 
	`­ic_´štk
(
APIC_VERBOSE
, "Setting %d inhe "

1392 
mp_ißpics
[
­ic
].
mpc_­icid
);

1393 
	`physids_Ü
(
phys_id_´e£Á_m­
,…hys_id_´e£Á_m­, 
tmp
);

1401 ià(
Şd_id
 !ğ
mp_ißpics
[
­ic
].
mpc_­icid
)

1402 
i
 = 0; i < 
mp_œq_’Œ›s
; i++)

1403 ià(
mp_œqs
[
i
].
mpc_d¡­ic
 =ğ
Şd_id
)

1404 
mp_œqs
[
i
].
mpc_d¡­ic


1405 ğ
mp_ißpics
[
­ic
].
mpc_­icid
;

1411 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


1413 
mp_ißpics
[
­ic
].
mpc_­icid
);

1415 
»g_00
.
b™s
.
ID
 = 
mp_ißpics
[
­ic
].
mpc_­icid
;

1416 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1417 
	`io_­ic_wr™e
(
­ic
, 0, 
»g_00
.
¿w
);

1418 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1423 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1424 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
­ic
, 0);

1425 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1426 ià(
»g_00
.
b™s
.
ID
 !ğ
mp_ißpics
[
­ic
].
mpc_­icid
)

1427 
	`´štk
("could‚ot set ID!\n");

1429 
	`­ic_´štk
(
APIC_VERBOSE
, " ok.\n");

1431 
	}
}

1433 
__š™
 
	$£tup_ißpic_ids_äom_mpc
(è{ 
	}
}

1444 
__š™
 
	$tim”_œq_wÜks
()

1446 
p™0_ticks
;

1447 
t1
, 
æags
;

1449 
t1
 = 
p™0_ticks
;

1450 
	`mb
();

1452 
	`loÿl_§ve_æags
(
æags
);

1453 
	`loÿl_œq_’abË
();

1455 
	`md–ay
((10 * 1000è/ 
HZ
);

1456 
	`loÿl_œq_»¡Üe
(
æags
);

1465 
	`mb
();

1466 ià(
p™0_ticks
 - 
t1
 > 4)

1470 
	}
}

1494 
	$¡¬tup_edge_ißpic_œq
(
œq
)

1496 
was_³ndšg
 = 0;

1497 
æags
;

1499 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1500 ià(
	`¶©fÜm_Ëgacy_œq
(
œq
)) {

1501 
	`di§bË_8259A_œq
(
œq
);

1502 ià(
	`i8259A_œq_³ndšg
(
œq
))

1503 
was_³ndšg
 = 1;

1505 
	`__unmask_IO_APIC_œq
(
œq
);

1506 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1508  
was_³ndšg
;

1509 
	}
}

1516 
	$ack_edge_ißpic_œq
(
œq
)

1518 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

1520 
	`œq_com¶‘e_move
(&
desc
);

1521 
	`move_Çtive_œq
(
œq
);

1523 ià((
desc
->
¡©us
 & (
IRQ_PENDING
 | 
IRQ_DISABLED
))

1524 =ğ(
IRQ_PENDING
 | 
IRQ_DISABLED
))

1525 
	`mask_IO_APIC_œq
(
œq
);

1526 
	`ack_APIC_œq
();

1527 
	}
}

1543 
	$¡¬tup_Ëv–_ißpic_œq
 (
œq
)

1545 
	`unmask_IO_APIC_œq
(
œq
);

1548 
	}
}

1550 
__»ad_mo¡ly
 
	gißpic_ack_Ãw
 = 1;

1551 
	$£tup_ißpic_ack
(*
s
)

1553 iàĞ!
	`¡rcmp
(
s
, "old") )

1554 
ißpic_ack_Ãw
 = 0;

1555 iàĞ!
	`¡rcmp
(
s
, "new") )

1556 
ißpic_ack_Ãw
 = 1;

1558 
	`´štk
("UnknowÀißpic_ack v®u¥ecif›d: '%s'\n", 
s
);

1559 
	}
}

1560 
cu¡om_·¿m
("ißpic_ack", 
£tup_ißpic_ack
);

1562 
boŞ_t
 
	$io_­ic_Ëv–_ack_³ndšg
(
œq
)

1564 
œq_pš_li¡
 *
’Œy
;

1565 
æags
;

1567 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

1568 
’Œy
 = &
œq_2_pš
[
œq
];

1570 
»g
;

1571 
pš
;

1573 ià(!
’Œy
)

1576 
pš
 = 
’Œy
->pin;

1577 ià(
pš
 == -1)

1579 
»g
 = 
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 
pš
*2);

1581 ià(
»g
 & 
IO_APIC_REDIR_REMOTE_IRR
) {

1582 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1585 ià(!
’Œy
->
Ãxt
)

1587 
’Œy
 = 
œq_2_pš
 +ƒÁry->
Ãxt
;

1589 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

1592 
	}
}

1594 
	$mask_ªd_ack_Ëv–_ißpic_œq
 (
œq
)

1596 
v
;

1597 
i
;

1598 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

1600 
	`œq_com¶‘e_move
(&
desc
);

1602 iàĞ
ißpic_ack_Ãw
 )

1605 iàĞ!
dœeùed_eoi_’abËd
 )

1606 
	`mask_IO_APIC_œq
(
œq
);

1627 
i
 = 
	`IO_APIC_VECTOR
(
œq
);

1629 
v
 = 
	`­ic_»ad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

1631 
	`ack_APIC_œq
();

1633 iàĞ
dœeùed_eoi_’abËd
 )

1636 ià((
œq_desc
[
œq
].
¡©us
 & 
IRQ_MOVE_PENDING
) &&

1637 !
	`io_­ic_Ëv–_ack_³ndšg
(
œq
))

1638 
	`move_masked_œq
(
œq
);

1640 iàĞ!(
v
 & (1 << (
i
 & 0x1f))) ) {

1641 
	`¥š_lock
(&
ißpic_lock
);

1642 
	`__edge_IO_APIC_œq
(
œq
);

1643 
	`__Ëv–_IO_APIC_œq
(
œq
);

1644 
	`¥š_uÆock
(&
ißpic_lock
);

1646 
	}
}

1648 
	$’d_Ëv–_ißpic_œq
 (
œq
)

1650 
v
;

1651 
i
;

1653 iàĞ!
ißpic_ack_Ãw
 )

1655 iàĞ
dœeùed_eoi_’abËd
 )

1657 iàĞ!(
œq_desc
[
œq
].
¡©us
 & (
IRQ_DISABLED
|
IRQ_MOVE_PENDING
)) )

1659 
	`eoi_IO_APIC_œq
(
œq
);

1663 
	`mask_IO_APIC_œq
(
œq
);

1664 
	`eoi_IO_APIC_œq
(
œq
);

1665 iàĞ(
œq_desc
[
œq
].
¡©us
 & 
IRQ_MOVE_PENDING
) &&

1666 !
	`io_­ic_Ëv–_ack_³ndšg
(
œq
) )

1667 
	`move_masked_œq
(
œq
);

1670 iàĞ!(
œq_desc
[
œq
].
¡©us
 & 
IRQ_DISABLED
) )

1671 
	`unmask_IO_APIC_œq
(
œq
);

1695 
i
 = 
	`IO_APIC_VECTOR
(
œq
);

1697 
v
 = 
	`­ic_»ad
(
APIC_TMR
 + ((
i
 & ~0x1f) >> 1));

1699 
	`ack_APIC_œq
();

1701 ià((
œq_desc
[
œq
].
¡©us
 & 
IRQ_MOVE_PENDING
) &&

1702 !
	`io_­ic_Ëv–_ack_³ndšg
(
œq
))

1703 
	`move_Çtive_œq
(
œq
);

1705 ià(!(
v
 & (1 << (
i
 & 0x1f)))) {

1706 
	`¥š_lock
(&
ißpic_lock
);

1707 
	`__mask_IO_APIC_œq
(
œq
);

1708 
	`__edge_IO_APIC_œq
(
œq
);

1709 
	`__Ëv–_IO_APIC_œq
(
œq
);

1710 iàĞ!(
œq_desc
[
œq
].
¡©us
 & 
IRQ_DISABLED
) )

1711 
	`__unmask_IO_APIC_œq
(
œq
);

1712 
	`¥š_uÆock
(&
ißpic_lock
);

1714 
	}
}

1716 
	$di§bË_edge_ißpic_œq
(
œq
)

1718 
	}
}

1720 
	$’d_edge_ißpic_œq
(
œq
)

1722 
	}
}

1732 
hw_œq_cÚŒŞËr
 
	gißpic_edge_ty³
 = {

1733 .
ty³Çme
 = "IO-APIC-edge",

1734 .
	g¡¬tup
 = 
¡¬tup_edge_ißpic_œq
,

1735 .
	gshutdown
 = 
di§bË_edge_ißpic_œq
,

1736 .
	g’abË
 = 
unmask_IO_APIC_œq
,

1737 .
	gdi§bË
 = 
di§bË_edge_ißpic_œq
,

1738 .
	gack
 = 
ack_edge_ißpic_œq
,

1739 .
	g’d
 = 
’d_edge_ißpic_œq
,

1740 .
	g£t_affš™y
 = 
£t_ißpic_affš™y_œq
,

1743 
hw_œq_cÚŒŞËr
 
	gißpic_Ëv–_ty³
 = {

1744 .
ty³Çme
 = "IO-APIC-level",

1745 .
	g¡¬tup
 = 
¡¬tup_Ëv–_ißpic_œq
,

1746 .
	gshutdown
 = 
mask_IO_APIC_œq
,

1747 .
	g’abË
 = 
unmask_IO_APIC_œq
,

1748 .
	gdi§bË
 = 
mask_IO_APIC_œq
,

1749 .
	gack
 = 
mask_ªd_ack_Ëv–_ißpic_œq
,

1750 .
	g’d
 = 
’d_Ëv–_ißpic_œq
,

1751 .
	g£t_affš™y
 = 
£t_ißpic_affš™y_œq
,

1754 
	$¡¬tup_msi_œq
(
œq
)

1756 
	`unmask_msi_œq
(
œq
);

1758 
	}
}

1760 
	$ack_msi_œq
(
œq
)

1762 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

1764 
	`œq_com¶‘e_move
(&
desc
);

1765 
	`move_Çtive_œq
(
œq
);

1767 iàĞ
	`msi_maskabË_œq
(
desc
->
msi_desc
) )

1768 
	`ack_APIC_œq
();

1769 
	}
}

1771 
	$’d_msi_œq
(
œq
)

1773 iàĞ!
	`msi_maskabË_œq
(
œq_desc
[
œq
].
msi_desc
) )

1774 
	`ack_APIC_œq
();

1775 
	}
}

1777 
	#shutdown_msi_œq
 
mask_msi_œq


	)

1783 
hw_œq_cÚŒŞËr
 
	gpci_msi_ty³
 = {

1784 .
ty³Çme
 = "PCI-MSI",

1785 .
	g¡¬tup
 = 
¡¬tup_msi_œq
,

1786 .
	gshutdown
 = 
shutdown_msi_œq
,

1787 .
	g’abË
 = 
unmask_msi_œq
,

1788 .
	gdi§bË
 = 
mask_msi_œq
,

1789 .
	gack
 = 
ack_msi_œq
,

1790 .
	g’d
 = 
’d_msi_œq
,

1791 .
	g£t_affš™y
 = 
£t_msi_affš™y
,

1794 
šlše
 
	$š™_IO_APIC_Œ­s
()

1796 
œq
;

1798 
œq
 = 0; 
	`¶©fÜm_Ëgacy_œq
(irq); irq++)

1799 ià(
	`IO_APIC_IRQ
(
œq
è&& !
	`IO_APIC_VECTOR
(irq))

1800 
	`make_8259A_œq
(
œq
);

1801 
	}
}

1803 
	$’abË_Ïpic_œq
(
œq
)

1805 
v
;

1807 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1808 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v
 & ~
APIC_LVT_MASKED
);

1809 
	}
}

1811 
	$di§bË_Ïpic_œq
(
œq
)

1813 
v
;

1815 
v
 = 
	`­ic_»ad
(
APIC_LVT0
);

1816 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
v
 | 
APIC_LVT_MASKED
);

1817 
	}
}

1819 
	$ack_Ïpic_œq
(
œq
)

1821 
	`ack_APIC_œq
();

1822 
	}
}

1824 
	$’d_Ïpic_œq
(
œq
è{ 
	}
}

1826 
hw_œq_cÚŒŞËr
 
	gÏpic_œq_ty³
 = {

1827 .
ty³Çme
 = "local-APIC-edge",

1828 .
	g¡¬tup
 = 
NULL
,

1829 .
	gshutdown
 = 
NULL
,

1830 .
	g’abË
 = 
’abË_Ïpic_œq
,

1831 .
	gdi§bË
 = 
di§bË_Ïpic_œq
,

1832 .
	gack
 = 
ack_Ïpic_œq
,

1833 .
	g’d
 = 
’d_Ïpic_œq
,

1843 
__š™
 
	$uÆock_ExtINT_logic
()

1845 
­ic
, 
pš
, 
i
;

1846 
IO_APIC_rou‹_’Œy
 
’Œy0
, 
’Œy1
;

1847 
§ve_cÚŒŞ
, 
§ve_äeq_£Ëù
;

1849 
pš
 = 
	`fšd_i§_œq_pš
(8, 
mp_INT
);

1850 
­ic
 = 
	`fšd_i§_œq_­ic
(8, 
mp_INT
);

1851 ià(
pš
 == -1)

1854 
’Œy0
 = 
	`ißpic_»ad_’Œy
(
­ic
, 
pš
, 0);

1855 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

1857 
	`mem£t
(&
’Œy1
, 0, (entry1));

1859 
’Œy1
.
de¡_mode
 = 0;

1860 
’Œy1
.
mask
 = 0;

1861 
	`SET_DEST
(
’Œy1
.
de¡
.
de¡32
,ƒÁry1.de¡.
physiÿl
.
physiÿl_de¡
,

1862 
	`h¬d_smp_´oûssÜ_id
());

1863 
’Œy1
.
d–iv”y_mode
 = 
de¡_ExtINT
;

1864 
’Œy1
.
pŞ¬™y
 = 
’Œy0
.polarity;

1865 
’Œy1
.
Œigg”
 = 0;

1866 
’Œy1
.
veùÜ
 = 0;

1868 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 0, 
’Œy1
);

1870 
§ve_cÚŒŞ
 = 
	`CMOS_READ
(
RTC_CONTROL
);

1871 
§ve_äeq_£Ëù
 = 
	`CMOS_READ
(
RTC_FREQ_SELECT
);

1872 
	`CMOS_WRITE
((
§ve_äeq_£Ëù
 & ~
RTC_RATE_SELECT
) | 0x6,

1873 
RTC_FREQ_SELECT
);

1874 
	`CMOS_WRITE
(
§ve_cÚŒŞ
 | 
RTC_PIE
, 
RTC_CONTROL
);

1876 
i
 = 100;

1877 
i
-- > 0) {

1878 
	`md–ay
(10);

1879 ià((
	`CMOS_READ
(
RTC_INTR_FLAGS
è& 
RTC_PF
) == RTC_PF)

1880 
i
 -= 10;

1883 
	`CMOS_WRITE
(
§ve_cÚŒŞ
, 
RTC_CONTROL
);

1884 
	`CMOS_WRITE
(
§ve_äeq_£Ëù
, 
RTC_FREQ_SELECT
);

1885 
	`ş—r_IO_APIC_pš
(
­ic
, 
pš
);

1887 
	`ißpic_wr™e_’Œy
(
­ic
, 
pš
, 0, 
’Œy0
);

1888 
	}
}

1896 
__š™
 
	$check_tim”
()

1898 
­ic1
, 
pš1
, 
­ic2
, 
pš2
;

1899 
veùÜ
, 
»t
;

1900 
æags
;

1902 
	`loÿl_œq_§ve
(
æags
);

1907 
	`di§bË_8259A_œq
(0);

1908 
veùÜ
 = 
FIRST_HIPRIORITY_VECTOR
;

1909 
	`ş—r_œq_veùÜ
(0);

1911 ià((
»t
 = 
	`bšd_œq_veùÜ
(0, 
veùÜ
, (
ıumask_t
)
CPU_MASK_ALL
)))

1912 
	`´štk
(
KERN_ERR
"..IRQ0 i nÙ s‘ cÜ»ùly w™h ißpic!!!,ƒ¼:%d\n", 
»t
);

1914 
œq_desc
[0].
d•th
 = 0;

1915 
œq_desc
[0].
¡©us
 &ğ~
IRQ_DISABLED
;

1924 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_EXTINT
);

1925 
	`š™_8259A
(1);

1930 
pš1
 = 
	`fšd_i§_œq_pš
(0, 
mp_INT
);

1931 
­ic1
 = 
	`fšd_i§_œq_­ic
(0, 
mp_INT
);

1932 
pš2
 = 
ißpic_i8259
.
pš
;

1933 
­ic2
 = 
ißpic_i8259
.
­ic
;

1935 
	`´štk
(
KERN_INFO
 "..TIMER: vector=0x%02X‡pic1=%d…in1=%d‡pic2=%d…in2=%d\n",

1936 
veùÜ
, 
­ic1
, 
pš1
, 
­ic2
, 
pš2
);

1938 ià(
pš1
 != -1) {

1942 
	`unmask_IO_APIC_œq
(0);

1943 ià(
	`tim”_œq_wÜks
()) {

1944 
	`loÿl_œq_»¡Üe
(
æags
);

1947 
	`ş—r_IO_APIC_pš
(
­ic1
, 
pš1
);

1948 
	`´štk
(
KERN_ERR
 "..MP-BIOS bug: 8254imer‚ot connectedo "

1952 
	`´štk
(
KERN_INFO
 "...tryingo set upimer (IRQ0)hroughhe 8259A ... ");

1953 ià(
pš2
 != -1) {

1954 
	`´štk
("\n..... (found…š %dè...", 
pš2
);

1958 
	`£tup_ExtINT_IRQ0_pš
(
­ic2
, 
pš2
, 
veùÜ
);

1959 ià(
	`tim”_œq_wÜks
()) {

1960 
	`loÿl_œq_»¡Üe
(
æags
);

1961 
	`´štk
("works.\n");

1962 ià(
pš1
 != -1)

1963 
	`»¶aû_pš_©_œq
(0, 
­ic1
, 
pš1
, 
­ic2
, 
pš2
);

1965 
	`add_pš_to_œq
(0, 
­ic2
, 
pš2
);

1971 
	`ş—r_IO_APIC_pš
(
­ic2
, 
pš2
);

1973 
	`´štk
(" failed.\n");

1975 ià(
nmi_w©chdog
 =ğ
NMI_IO_APIC
) {

1976 
	`´štk
(
KERN_WARNING
 "timer doesn't workhroughhe IO-APIC - disabling NMI Watchdog!\n");

1977 
nmi_w©chdog
 = 0;

1980 
	`´štk
(
KERN_INFO
 "...tryingo set upimer‡s Virtual Wire IRQ...");

1982 
	`di§bË_8259A_œq
(0);

1983 
œq_desc
[0].
hªdËr
 = &
Ïpic_œq_ty³
;

1984 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_DM_FIXED
 | 
veùÜ
);

1985 
	`’abË_8259A_œq
(0);

1987 ià(
	`tim”_œq_wÜks
()) {

1988 
	`loÿl_œq_»¡Üe
(
æags
);

1989 
	`´štk
(" works.\n");

1992 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_LVT_MASKED
 | 
APIC_DM_FIXED
 | 
veùÜ
);

1993 
	`´štk
(" failed.\n");

1995 
	`´štk
(
KERN_INFO
 "...tryingo set upimer‡s ExtINT IRQ...");

1998 
	`š™_8259A
(0);

1999 
	`make_8259A_œq
(0);

2000 
	`­ic_wr™e_¬ound
(
APIC_LVT0
, 
APIC_DM_EXTINT
);

2002 
	`uÆock_ExtINT_logic
();

2004 
	`loÿl_œq_»¡Üe
(
æags
);

2006 ià(
	`tim”_œq_wÜks
()) {

2007 
	`´štk
(" works.\n");

2010 
	`´štk
(" failed :(.\n");

2011 
	`·nic
("IO-APIC +imer doesn't work! Boot with‡pic_verbosity=debug "

2013 
	}
}

2022 
	#PIC_IRQS
 (1 << 
PIC_CASCADE_IR
)

	)

2024 
IO_APIC_rou‹_’Œy
 *
	gißpic_pm_¡©e
;

2026 
__š™
 
	$ißpic_pm_¡©e_®loc
()

2028 
i
, 
Ä_’Œy
 = 0;

2030 
i
 = 0; i < 
Ä_ißpics
; i++)

2031 
Ä_’Œy
 +ğ
Ä_ißpic_»gi¡”s
[
i
];

2033 
ißpic_pm_¡©e
 = 
	`_xm®loc
((
IO_APIC_rou‹_’Œy
)*
Ä_’Œy
,

2034 (
IO_APIC_rou‹_’Œy
));

2035 
	`BUG_ON
(
ißpic_pm_¡©e
 =ğ
NULL
);

2036 
	}
}

2038 
__š™
 
	$£tup_IO_APIC
()

2040 
	`’abË_IO_APIC
();

2042 ià(
aıi_ißpic
)

2043 
io_­ic_œqs
 = ~0;

2045 
io_­ic_œqs
 = ~
PIC_IRQS
;

2047 
	`´štk
("ENABLING IO-APIC IRQs\n");

2048 
	`´štk
(" -> Usšg % ACK m‘hod\n", 
ißpic_ack_Ãw
 ? "new" : "old");

2053 ià(!
aıi_ißpic
)

2054 
	`£tup_ißpic_ids_äom_mpc
();

2055 
	`sync_Arb_IDs
();

2056 
	`£tup_IO_APIC_œqs
();

2057 
	`š™_IO_APIC_Œ­s
();

2058 
	`check_tim”
();

2059 
	`´št_IO_APIC
();

2060 
	`ißpic_pm_¡©e_®loc
();

2062 
	`»gi¡”_keyhªdËr
('z', &
´št_IO_APIC_keyhªdËr
);

2063 
	}
}

2065 
	$ißpic_su¥’d
()

2067 
IO_APIC_rou‹_’Œy
 *
’Œy
 = 
ißpic_pm_¡©e
;

2068 
æags
;

2069 
­ic
, 
i
;

2071 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2072 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++) {

2073 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
­ic
]; i ++, 
’Œy
 ++ ) {

2074 *(((*)
’Œy
è+ 1èğ
	`__io_­ic_»ad
(
­ic
, 0x11 + 2 * 
i
);

2075 *(((*)
’Œy
è+ 0èğ
	`__io_­ic_»ad
(
­ic
, 0x10 + 2 * 
i
);

2078 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2079 
	}
}

2081 
	$ißpic_»sume
()

2083 
IO_APIC_rou‹_’Œy
 *
’Œy
 = 
ißpic_pm_¡©e
;

2084 
æags
;

2085 
IO_APIC_»g_00
 
»g_00
;

2086 
i
, 
­ic
;

2088 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2089 
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++){

2090 
»g_00
.
¿w
 = 
	`__io_­ic_»ad
(
­ic
, 0);

2091 ià(
»g_00
.
b™s
.
ID
 !ğ
mp_ißpics
[
­ic
].
mpc_­icid
) {

2092 
»g_00
.
b™s
.
ID
 = 
mp_ißpics
[
­ic
].
mpc_­icid
;

2093 
	`__io_­ic_wr™e
(
­ic
, 0, 
»g_00
.
¿w
);

2095 
i
 = 0; i < 
Ä_ißpic_»gi¡”s
[
­ic
]; i++, 
’Œy
++) {

2096 
	`__io_­ic_wr™e
(
­ic
, 0x11+2*
i
, *(((*)
’Œy
)+1));

2097 
	`__io_­ic_wr™e
(
­ic
, 0x10+2*
i
, *(((*)
’Œy
)+0));

2100 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2101 
	}
}

2107 #ifdeà
CONFIG_ACPI_BOOT


2109 
__š™
 
	$io_­ic_g‘_unique_id
 (
ißpic
, 
­ic_id
)

2111 
IO_APIC_»g_00
 
»g_00
;

2112 
physid_mask_t
 
__š™d©a
 
­ic_id_m­
 = 
PHYSID_MASK_NONE
;

2113 
physid_mask_t
 
tmp
;

2114 
æags
;

2115 
i
 = 0;

2126 ià(
	`physids_em±y
(
­ic_id_m­
))

2127 
­ic_id_m­
 = 
	`ißpic_phys_id_m­
(
phys_ıu_´e£Á_m­
);

2129 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2130 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 0);

2131 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2133 ià(
­ic_id
 >ğ
	`g‘_physiÿl_brßdÿ¡
()) {

2134 
	`´štk
(
KERN_WARNING
 "IOAPIC[%d]: Invalid‡pic_id %d,rying "

2135 "%d\n", 
ißpic
, 
­ic_id
, 
»g_00
.
b™s
.
ID
);

2136 
­ic_id
 = 
»g_00
.
b™s
.
ID
;

2143 ià(
	`check_­icid_u£d
(
­ic_id_m­
, 
­ic_id
)) {

2145 
i
 = 0; i < 
	`g‘_physiÿl_brßdÿ¡
(); i++) {

2146 ià(!
	`check_­icid_u£d
(
­ic_id_m­
, 
i
))

2150 ià(
i
 =ğ
	`g‘_physiÿl_brßdÿ¡
())

2151 
	`·nic
("Max‡pic_idƒxceeded!\n");

2153 
	`´štk
(
KERN_WARNING
 "IOAPIC[%d]:‡pic_id %d‡lready used, "

2154 "Œyšg %d\n", 
ißpic
, 
­ic_id
, 
i
);

2156 
­ic_id
 = 
i
;

2159 
tmp
 = 
	`­icid_to_ıu_´e£Á
(
­ic_id
);

2160 
	`physids_Ü
(
­ic_id_m­
,‡pic_id_m­, 
tmp
);

2162 ià(
»g_00
.
b™s
.
ID
 !ğ
­ic_id
) {

2163 
»g_00
.
b™s
.
ID
 = 
­ic_id
;

2165 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2166 
	`io_­ic_wr™e
(
ißpic
, 0, 
»g_00
.
¿w
);

2167 
»g_00
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 0);

2168 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2171 ià(
»g_00
.
b™s
.
ID
 !ğ
­ic_id
) {

2172 
	`´štk
("IOAPIC[%d]: UÇbËØchªg­ic_id!\n", 
ißpic
);

2177 
	`­ic_´štk
(
APIC_VERBOSE
, 
KERN_INFO


2178 "IOAPIC[%d]: AssigÃd‡pic_id %d\n", 
ißpic
, 
­ic_id
);

2180  
­ic_id
;

2181 
	}
}

2184 
__š™
 
	$io_­ic_g‘_v”siÚ
 (
ißpic
)

2186 
IO_APIC_»g_01
 
»g_01
;

2187 
æags
;

2189 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2190 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 1);

2191 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2193  
»g_01
.
b™s
.
v”siÚ
;

2194 
	}
}

2197 
__š™
 
	$io_­ic_g‘_»dœ_’Œ›s
 (
ißpic
)

2199 
IO_APIC_»g_01
 
»g_01
;

2200 
æags
;

2202 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2203 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
ißpic
, 1);

2204 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2206  
»g_01
.
b™s
.
’Œ›s
;

2207 
	}
}

2210 
	$io_­ic_£t_pci_routšg
 (
ißpic
, 
pš
, 
œq
, 
edge_Ëv–
, 
aùive_high_low
)

2212 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

2213 
IO_APIC_rou‹_’Œy
 
’Œy
;

2214 
æags
;

2215 
veùÜ
;

2217 ià(!
	`IO_APIC_IRQ
(
œq
)) {

2218 
	`´štk
(
KERN_ERR
 "IOAPIC[%d]: Invalid„eferenceo IRQ 0\n",

2219 
ißpic
);

2220  -
EINVAL
;

2229 
	`mem£t
(&
’Œy
,0,(entry));

2231 
’Œy
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

2232 
’Œy
.
de¡_mode
 = 
INT_DEST_MODE
;

2233 
	`SET_DEST
(
’Œy
.
de¡
.
de¡32
,ƒÁry.de¡.
logiÿl
.
logiÿl_de¡
,

2234 
	`ıu_mask_to_­icid
(
TARGET_CPUS
));

2235 
’Œy
.
Œigg”
 = 
edge_Ëv–
;

2236 
’Œy
.
pŞ¬™y
 = 
aùive_high_low
;

2237 
’Œy
.
mask
 = 1;

2242 ià(!
	`¶©fÜm_Ëgacy_œq
(
œq
))

2243 
	`add_pš_to_œq
(
œq
, 
ißpic
, 
pš
);

2245 
veùÜ
 = 
	`assign_œq_veùÜ
(
œq
);

2246 ià(
veùÜ
 < 0)

2247  
veùÜ
;

2248 
’Œy
.
veùÜ
 = vector;

2250 
	`­ic_´štk
(
APIC_DEBUG
, 
KERN_DEBUG
 "IOAPIC[%d]: Set PCI„outingƒntry "

2251 "(%d-%d -> 0x%x -> IRQ %d Mode:%˜Aùive:%i)\n", 
ißpic
,

2252 
mp_ißpics
[
ißpic
].
mpc_­icid
, 
pš
, 
’Œy
.
veùÜ
, 
œq
,

2253 
edge_Ëv–
, 
aùive_high_low
);

2255 
	`ißpic_»gi¡”_šŒ
(
œq
, 
edge_Ëv–
);

2257 ià(!
ißpic
 && 
	`¶©fÜm_Ëgacy_œq
(
œq
))

2258 
	`di§bË_8259A_œq
(
œq
);

2260 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2261 
	`__ißpic_wr™e_’Œy
(
ißpic
, 
pš
, 0, 
’Œy
);

2262 
	`£t_Çtive_œq_šfo
(
œq
, 
TARGET_CPUS
);

2263 
	`¥š_uÆock
(&
ißpic_lock
);

2265 
	`¥š_lock
(&
desc
->
lock
);

2266 ià(!(
desc
->
¡©us
 & (
IRQ_DISABLED
 | 
IRQ_GUEST
)))

2267 
desc
->
hªdËr
->
	`¡¬tup
(
œq
);

2268 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

2271 
	}
}

2275 
	$ißpic_physba£_to_id
(
physba£
)

2277 
­ic
;

2278  
­ic
 = 0;‡piø< 
Ä_ißpics
;‡pic++ )

2279 iàĞ
mp_ißpics
[
­ic
].
mpc_­iÿddr
 =ğ
physba£
 )

2280  
­ic
;

2281  -
EINVAL
;

2282 
	}
}

2284 
­ic_gsi_ba£
(
­ic
);

2286 
	$­ic_pš_2_gsi_œq
(
­ic
, 
pš
)

2288 
idx
, 
œq
;

2290 ià(
­ic
 < 0)

2291  -
EINVAL
;

2293 
œq
 = 
	`­ic_gsi_ba£
(
­ic
è+ 
pš
;

2294 ià(
­ic
 == 0) {

2295 
idx
 = 
	`fšd_œq_’Œy
(
­ic
, 
pš
, 
mp_INT
);

2296 ià(
idx
 >= 0)

2297 
œq
 = 
	`pš_2_œq
(
idx
, 
­ic
, 
pš
);

2299  
œq
;

2300 
	}
}

2302 
	$ißpic_gue¡_»ad
(
physba£
, 
»g
, 
u32
 *
pv®
)

2304 
­ic
;

2305 
æags
;

2307 iàĞ(
­ic
 = 
	`ißpic_physba£_to_id
(
physba£
)) < 0 )

2308  
­ic
;

2310 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2311 *
pv®
 = 
	`io_­ic_»ad
(
­ic
, 
»g
);

2312 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2315 
	}
}

2317 
	#WARN_BOGUS_WRITE
(
f
, 
a
...) \

2318 
	`d´štk
(
XENLOG_INFO
, "\n%s: " \

2321 "%s: " 
f
, 
__FUNCTION__
, 
­ic
, 
pš
, 
œq
, \

2322 
__FUNCTION__
, *(
u32
 *)&
¹e
, \

2323 
__FUNCTION__
 , ##
a
 )

	)

2325 
	$ißpic_gue¡_wr™e
(
physba£
, 
»g
, 
u32
 
v®
)

2327 
­ic
, 
pš
, 
œq
, 
»t
, 
veùÜ
, 
pœq
;

2328 
IO_APIC_rou‹_’Œy
 
¹e
 = { 0 };

2329 
æags
;

2330 
œq_cfg
 *
cfg
;

2331 
œq_desc
 *
desc
;

2333 iàĞ(
­ic
 = 
	`ißpic_physba£_to_id
(
physba£
)) < 0 )

2334  
­ic
;

2337 iàĞ(
»g
 < 0x10) || (reg & 1) )

2340 
pš
 = (
»g
 - 0x10) >> 1;

2343 *(
u32
 *)&
¹e
 = 
v®
;

2353 iàĞ
¹e
.
d–iv”y_mode
 > 
de¡_Lowe¡Prio
 )

2355 
	`´štk
("ERROR: Attempto write weird IOAPIC destination mode!\n");

2356 
	`´štk
(" APIC=%d/%d,†o-»g=%x\n", 
­ic
, 
pš
, 
v®
);

2357  -
EINVAL
;

2364 
¹e
.
d–iv”y_mode
 = 
INT_DELIVERY_MODE
;

2365 
¹e
.
de¡_mode
 = 
INT_DEST_MODE
;

2367 
œq
 = 
	`­ic_pš_2_gsi_œq
(
­ic
, 
pš
);

2368 iàĞ
œq
 < 0 )

2369  
œq
;

2371 
desc
 = 
	`œq_to_desc
(
œq
);

2372 
cfg
 = 
desc
->
ch_d©a
;

2380 
pœq
 = (
œq
 >ğ256è? irq : 
¹e
.
veùÜ
;

2381 iàĞ(
pœq
 < 0è|| (pœq >ğ
dom0
->
Ä_pœqs
) )

2382  -
EINVAL
;

2384 iàĞ
desc
->
aùiÚ
 )

2386 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2387 
»t
 = 
	`io_­ic_»ad
(
­ic
, 0x10 + 2 * 
pš
);

2388 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2389 
¹e
.
veùÜ
 = 
cfg
->vector;

2390 iàĞ*(
u32
*)&
¹e
 !ğ
»t
 )

2391 
	`WARN_BOGUS_WRITE
("old_entry=%08x…irq=%d\n%s: "

2393 
»t
, 
pœq
, 
__FUNCTION__
);

2397 iàĞ
cfg
->
veùÜ
 <ğ0 || cfg->veùÜ > 
LAST_DYNAMIC_VECTOR
 ) {

2398 
veùÜ
 = 
	`assign_œq_veùÜ
(
œq
);

2399 iàĞ
veùÜ
 < 0 )

2400  
veùÜ
;

2402 
	`´štk
(
XENLOG_INFO
 "®loÿ‹d veùÜ %02x fÜ irq %d\n", 
veùÜ
, 
œq
);

2404 
	`add_pš_to_œq
(
œq
, 
­ic
, 
pš
);

2406 
	`¥š_lock
(&
pcidevs_lock
);

2407 
	`¥š_lock
(&
dom0
->
ev’t_lock
);

2408 
»t
 = 
	`m­_domaš_pœq
(
dom0
, 
pœq
, 
œq
,

2409 
MAP_PIRQ_TYPE_GSI
, 
NULL
);

2410 
	`¥š_uÆock
(&
dom0
->
ev’t_lock
);

2411 
	`¥š_uÆock
(&
pcidevs_lock
);

2412 iàĞ
»t
 < 0 )

2413  
»t
;

2415 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2417 
desc
->
hªdËr
 = 
¹e
.
Œigg”
 ?

2418 &
ißpic_Ëv–_ty³
: &
ißpic_edge_ty³
;

2421 
¹e
.
mask
 =„‹.
Œigg”
;

2423 
¹e
.
veùÜ
 = 
cfg
->vector;

2425 
	`SET_DEST
(
¹e
.
de¡
.
de¡32
,„‹.de¡.
logiÿl
.
logiÿl_de¡
,

2426 
	`ıu_mask_to_­icid
(&
cfg
->
ıu_mask
));

2428 
	`io_­ic_wr™e
(
­ic
, 0x10 + 2 * 
pš
, *(((*)&
¹e
) + 0));

2429 
	`io_­ic_wr™e
(
­ic
, 0x11 + 2 * 
pš
, *(((*)&
¹e
) + 1));

2431 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2434 
	}
}

2436 
	$dump_ißpic_œq_šfo
()

2438 
œq_pš_li¡
 *
’Œy
;

2439 
IO_APIC_rou‹_’Œy
 
¹e
;

2440 
œq
, 
pš
, 
´š‹d
 = 0;

2441 
æags
;

2443 iàĞ!
œq_2_pš
 )

2446  
œq
 = 0; irq < 
Ä_œqs_gsi
; irq++ )

2448 
’Œy
 = &
œq_2_pš
[
œq
];

2449 iàĞ
’Œy
->
pš
 == -1 )

2452 iàĞ!
´š‹d
++ )

2453 
	`´štk
("IO-APIC interrupt information:\n");

2455 
	`´štk
(" IRQ%3d Vec%3d:\n", 
œq
, 
	`œq_to_veùÜ
(irq));

2459 
pš
 = 
’Œy
->pin;

2461 
	`´štk
(" Apiø0x%02x, Pš %2d: ", 
’Œy
->
­ic
, 
pš
);

2463 
	`¥š_lock_œq§ve
(&
ißpic_lock
, 
æags
);

2464 *(((*)&
¹e
è+ 0èğ
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x10 + 2 * 
pš
);

2465 *(((*)&
¹e
è+ 1èğ
	`io_­ic_»ad
(
’Œy
->
­ic
, 0x11 + 2 * 
pš
);

2466 
	`¥š_uÆock_œq»¡Üe
(&
ißpic_lock
, 
æags
);

2468 
	`´štk
("vector=%u, delivery_mode=%u, dest_mode=%s, "

2471 
¹e
.
veùÜ
,„‹.
d–iv”y_mode
,

2472 
¹e
.
de¡_mode
 ? "logical" : "physical",

2473 
¹e
.
d–iv”y_¡©us
,„‹.
pŞ¬™y
,„‹.
œr
,

2474 
¹e
.
Œigg”
 ? "Ëv–" : "edge",„‹.
mask
,

2475 
¹e
.
de¡
.
logiÿl
.
logiÿl_de¡
);

2477 iàĞ
’Œy
->
Ãxt
 == 0 )

2479 
’Œy
 = &
œq_2_pš
[’Œy->
Ãxt
];

2482 
	}
}

2484 
highe¡_gsi
();

2486 
__š™d©a
 
	gmax_gsi_œqs
;

2487 
š‹g”_·¿m
("max_gsi_œqs", 
max_gsi_œqs
);

2489 
__š™
 
	$š™_ißpic_m­pšgs
()

2491 
ißpic_phys
;

2492 
i
, 
idx
 = 
FIX_IO_APIC_BASE_0
;

2493 
IO_APIC_»g_01
 
»g_01
;

2495 iàĞ
smp_found_cÚfig
 )

2496 
Ä_œqs_gsi
 = 0;

2497  
i
 = 0; i < 
Ä_ißpics
; i++ )

2499 iàĞ
smp_found_cÚfig
 )

2501 
ißpic_phys
 = 
mp_ißpics
[
i
].
mpc_­iÿddr
;

2502 iàĞ!
ißpic_phys
 )

2504 
	`´štk
(
KERN_ERR
 "WARNING: bogus zero IO-APIC‡ddress "

2506 
smp_found_cÚfig
 = 0;

2507 
sk_ißpic_£tup
 = 1;

2508 
çke_ißpic_·ge
;

2513 
çke_ißpic_·ge
:

2514 
ißpic_phys
 = 
	`__·
(
	`®loc_x’h—p_·ge
());

2515 
	`ş—r_·ge
(
	`__va
(
ißpic_phys
));

2517 
	`£t_fixm­_noÿche
(
idx
, 
ißpic_phys
);

2518 
	`­ic_´štk
(
APIC_VERBOSE
, "mapped IOAPICo %08lx (%08lx)\n",

2519 
	`__fix_to_vœt
(
idx
), 
ißpic_phys
);

2520 
idx
++;

2522 iàĞ
smp_found_cÚfig
 )

2525 
»g_01
.
¿w
 = 
	`io_­ic_»ad
(
i
, 1);

2526 
Ä_ißpic_»gi¡”s
[
i
] = 
»g_01
.
b™s
.
’Œ›s
 + 1;

2527 
Ä_œqs_gsi
 +ğ
Ä_ißpic_»gi¡”s
[
i
];

2531 
Ä_œqs_gsi
 = 
	`max
Òr_œqs_gsi, 
	`highe¡_gsi
());

2533 iàĞ
max_gsi_œqs
 == 0 )

2534 
max_gsi_œqs
 = 
Ä_œqs
 ?‚r_œq / 8 : 
PAGE_SIZE
;

2535 iàĞ
Ä_œqs
 !ğ0 && 
max_gsi_œqs
 >‚r_irqs )

2537 
	`´štk
(
XENLOG_WARNING
 "\"max_gsi_irqs=\" cannot be specified†arger"

2539 
max_gsi_œqs
 = 
Ä_œqs
;

2541 iàĞ
max_gsi_œqs
 < 16 )

2542 
max_gsi_œqs
 = 16;

2545 iàĞ
max_gsi_œqs
 > 
PAGE_SIZE
 * 8 )

2546 
max_gsi_œqs
 = 
PAGE_SIZE
 * 8;

2548 iàĞ!
smp_found_cÚfig
 || 
sk_ißpic_£tup
 || 
Ä_œqs_gsi
 < 16 )

2549 
Ä_œqs_gsi
 = 16;

2550 iàĞ
Ä_œqs_gsi
 > 
max_gsi_œqs
 )

2552 
	`´štk
(
XENLOG_WARNING
 "Limitingo %u GSI IRQs (found %u)\n",

2553 
max_gsi_œqs
, 
Ä_œqs_gsi
);

2554 
Ä_œqs_gsi
 = 
max_gsi_œqs
;

2557 iàĞ
Ä_œqs
 == 0 )

2558 
Ä_œqs
 = 
ıu_has_­ic
 ?

2559 
	`max
(16U + 
	`num_´e£Á_ıus
(è* 
NR_DYNAMIC_VECTORS
,

2560 8 * 
Ä_œqs_gsi
) :

2561 
Ä_œqs_gsi
;

2562 iàĞ
Ä_œqs
 < 16 )

2563 
Ä_œqs
 = 16;

2564 
	`´štk
(
XENLOG_INFO
 "IRQ†imits: %u GSI, %u MSI/MSI-X\n",

2565 
Ä_œqs_gsi
, 
Ä_œqs
 -‚r_irqs_gsi);

2566 
	}
}

	@ioport_emulate.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/š™.h
>

9 
	~<x’/sched.h
>

10 
	~<x’/dmi.h
>

13 (*
iÛmul_hªdË_quœk
)(

14 
u8
 
İcode
, *
io_emul_¡ub
, 
ıu_u£r_»gs
 *
»gs
);

16 
	$iÛmul_hªdË_´ŞŸÁ_quœk
(

17 
u8
 
İcode
, *
io_emul_¡ub
, 
ıu_u£r_»gs
 *
»gs
)

19 
ušt16_t
 
pÜt
 = 
»gs
->
edx
;

20 
ušt8_t
 
v®ue
 = 
»gs
->
—x
;

22 iàĞ(
İcode
 !ğ0x“è|| (
pÜt
 !ğ0xcd4è|| !(
v®ue
 & 0x80) )

26 
io_emul_¡ub
[0] = 0x9c;

28 
io_emul_¡ub
[1] = 0xfa;

30 
io_emul_¡ub
[2] = 0xee;

32 
io_emul_¡ub
[3] = 0xec;

34 
io_emul_¡ub
[4] = 0xa8;

35 
io_emul_¡ub
[5] = 0x80;

37 
io_emul_¡ub
[6] = 0x75;

38 
io_emul_¡ub
[7] = 0xfb;

40 
io_emul_¡ub
[8] = 0x9d;

42 
io_emul_¡ub
[9] = 0xc3;

43 
	}
}

45 
__š™
 
	$´ŞŸÁ_quœk
(
dmi_sy¡em_id
 *
d
)

47 
iÛmul_hªdË_quœk
 = 
iÛmul_hªdË_´ŞŸÁ_quœk
;

49 
	}
}

52 
dmi_sy¡em_id
 
__š™d©a
 
	giİÜt_quœks_tbl
[] = {

58 .
ÿÎback
 = 
´ŞŸÁ_quœk
,

59 .
	gid’t
 = "HP ProLiant DL3xx",

60 .
	gm©ches
 = {

61 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

62 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant DL3"),

66 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

67 .
	gid’t
 = "HP ProLiant DL5xx",

68 .
	gm©ches
 = {

69 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

70 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant DL5"),

74 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

75 .
	gid’t
 = "HP ProLiant DL7xx",

76 .
	gm©ches
 = {

77 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

78 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant DL7"),

82 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

83 .
	gid’t
 = "HP ProLiant ML3xx",

84 .
	gm©ches
 = {

85 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

86 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant ML3"),

90 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

91 .
	gid’t
 = "HP ProLiant ML5xx",

92 .
	gm©ches
 = {

93 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

94 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant ML5"),

98 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

99 .
	gid’t
 = "HP ProLiant BL2xx",

100 .
	gm©ches
 = {

101 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

102 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant BL2"),

106 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

107 .
	gid’t
 = "HP ProLiant BL4xx",

108 .
	gm©ches
 = {

109 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

110 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant BL4"),

114 .
	gÿÎback
 = 
´ŞŸÁ_quœk
,

115 .
	gid’t
 = "HP ProLiant BL6xx",

116 .
	gm©ches
 = {

117 
DMI_MATCH
(
DMI_BIOS_VENDOR
, "HP"),

118 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "ProLiant BL6"),

124 
__š™
 
	$iİÜt_quœks_š™
()

126 
	`dmi_check_sy¡em
(
iİÜt_quœks_tbl
);

128 
	}
}

129 
__š™ÿÎ
(
iİÜt_quœks_š™
);

	@irq.c

8 
	~<x’/cÚfig.h
>

9 
	~<x’/š™.h
>

10 
	~<x’/d–ay.h
>

11 
	~<x’/”ºo.h
>

12 
	~<x’/ev’t.h
>

13 
	~<x’/œq.h
>

14 
	~<x’/³rfc.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/keyhªdËr.h
>

17 
	~<x’/com·t.h
>

18 
	~<x’/ioÿp.h
>

19 
	~<x’/iommu.h
>

20 
	~<x’/Œaû.h
>

21 
	~<asm/msi.h
>

22 
	~<asm/cu¼’t.h
>

23 
	~<asm/æushb.h
>

24 
	~<asm/mach-g’”ic/mach_­ic.h
>

25 
	~<public/physdev.h
>

28 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_noœqb®ªû
 = 0;

29 
boŞ—n_·¿m
("noœqb®ªû", 
İt_noœqb®ªû
);

31 
__»ad_mo¡ly
 
	gÄ_œqs_gsi
 = 16;

32 
__»ad_mo¡ly
 
	gÄ_œqs
;

33 
š‹g”_·¿m
("Ä_œqs", 
Ä_œqs
);

35 
u8
 
__»ad_mo¡ly
 *
	gœq_veùÜ
;

36 
œq_desc
 
__»ad_mo¡ly
 *
	gœq_desc
 = 
NULL
;

38 
__»ad_mo¡ly
 *
	gœq_¡©us
 = 
NULL
;

39 
	#IRQ_UNUSED
 (0)

	)

40 
	#IRQ_USED
 (1)

	)

41 
	#IRQ_RSVD
 (2)

	)

43 
	#IRQ_VECTOR_UNASSIGNED
 (0)

	)

45 
DECLARE_BITMAP
(
u£d_veùÜs
, 
NR_VECTORS
);

47 
œq_cfg
 
__»ad_mo¡ly
 *
	gœq_cfg
 = 
NULL
;

49 
DEFINE_SPINLOCK
(
veùÜ_lock
);

51 
DEFINE_PER_CPU
(
veùÜ_œq_t
, 
veùÜ_œq
);

53 
DEFINE_PER_CPU
(
ıu_u£r_»gs
 *, 
__œq_»gs
);

55 
LIST_HEAD
(
œq_¿‹lim™_li¡
);

56 
DEFINE_SPINLOCK
(
œq_¿‹lim™_lock
);

57 
tim”
 
	gœq_¿‹lim™_tim”
;

60 
__»ad_mo¡ly
 
	gœq_¿‹lim™_th»shŞd
 = 10000;

61 
š‹g”_·¿m
("œq_¿‹lim™", 
œq_¿‹lim™_th»shŞd
);

64 
	$lock_veùÜ_lock
()

69 
	`¥š_lock
(&
veùÜ_lock
);

70 
	}
}

72 
	$uÆock_veùÜ_lock
()

74 
	`¥š_uÆock
(&
veùÜ_lock
);

75 
	}
}

77 
__š™
 
	$__bšd_œq_veùÜ
(
œq
, 
veùÜ
, 
ıumask_t
 
ıu_mask
)

79 
ıumask_t
 
Úlše_mask
;

80 
ıu
;

81 
œq_cfg
 *
cfg
 = 
	`œq_cfg
(
œq
);

83 
	`BUG_ON
(()
œq
 >ğ
Ä_œqs
);

84 
	`BUG_ON
(()
veùÜ
 >ğ
NR_VECTORS
);

86 
	`ıus_ªd
(
Úlše_mask
, 
ıu_mask
, 
ıu_Úlše_m­
);

87 ià(
	`ıus_em±y
(
Úlše_mask
))

88  -
EINVAL
;

89 ià((
cfg
->
veùÜ
 =ğveùÜè&& 
	`ıus_equ®
(cfg->
ıu_mask
, 
Úlše_mask
))

91 ià(
cfg
->
veùÜ
 !ğ
IRQ_VECTOR_UNASSIGNED
)

92  -
EBUSY
;

93 
	`fÜ_—ch_ıu_mask
(
ıu
, 
Úlše_mask
)

94 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = 
œq
;

95 
cfg
->
veùÜ
 = vector;

96 
cfg
->
ıu_mask
 = 
Úlše_mask
;

97 
œq_¡©us
[
œq
] = 
IRQ_USED
;

98 ià(
	`IO_APIC_IRQ
(
œq
))

99 
œq_veùÜ
[
œq
] = 
veùÜ
;

101 
	}
}

103 
__š™
 
	$bšd_œq_veùÜ
(
œq
, 
veùÜ
, 
ıumask_t
 
ıu_mask
)

105 
æags
;

106 
»t
;

108 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

109 
»t
 = 
	`__bšd_œq_veùÜ
(
œq
, 
veùÜ
, 
ıu_mask
);

110 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

111  
»t
;

112 
	}
}

114 
šlše
 
	$fšd_uÇssigÃd_œq
()

116 
œq
;

118 
œq
 = 
Ä_œqs_gsi
; irq < 
Ä_œqs
; irq++)

119 ià(
œq_¡©us
[
œq
] =ğ
IRQ_UNUSED
)

120  
œq
;

121  -
ENOSPC
;

122 
	}
}

127 
	$ü—‹_œq
()

129 
æags
;

130 
œq
, 
»t
;

131 
œq
 = -
ENOSPC
;

133 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

135 
œq
 = 
	`fšd_uÇssigÃd_œq
();

136 ià(
œq
 < 0)

137 
out
;

138 
»t
 = 
	`__assign_œq_veùÜ
(
œq
, 
	`œq_cfg
(œq), 
TARGET_CPUS
);

139 ià(
»t
 < 0)

140 
œq
 = 
»t
;

141 
out
:

142 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

144  
œq
;

145 
	}
}

147 
	$dyÇmic_œq_ş—nup
(
œq
)

149 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

150 
æags
;

151 
œqaùiÚ
 *
aùiÚ
;

153 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

154 
desc
->
¡©us
 |ğ
IRQ_DISABLED
;

155 
desc
->
hªdËr
->
	`shutdown
(
œq
);

156 
aùiÚ
 = 
desc
->action;

157 
desc
->
aùiÚ
 = 
NULL
;

158 
desc
->
d•th
 = 1;

159 
desc
->
msi_desc
 = 
NULL
;

160 
desc
->
hªdËr
 = &
no_œq_ty³
;

161 
	`ıus_£Î
(
desc
->
affš™y
);

162 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

165 dØ{ 
	`smp_mb
(); }  
desc
->
¡©us
 & 
IRQ_INPROGRESS
 );

167 ià(
aùiÚ
)

168 
	`xä“
(
aùiÚ
);

169 
	}
}

171 
š™_Úe_œq_¡©us
(
œq
);

173 
	$__ş—r_œq_veùÜ
(
œq
)

175 
ıu
, 
veùÜ
;

176 
ıumask_t
 
tmp_mask
;

177 
œq_cfg
 *
cfg
 = 
	`œq_cfg
(
œq
);

179 
	`BUG_ON
(!
cfg
->
veùÜ
);

181 
veùÜ
 = 
cfg
->vector;

182 
	`ıus_ªd
(
tmp_mask
, 
cfg
->
ıu_mask
, 
ıu_Úlše_m­
);

184 
	`fÜ_—ch_ıu_mask
(
ıu
, 
tmp_mask
)

185 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

187 
cfg
->
veùÜ
 = 
IRQ_VECTOR_UNASSIGNED
;

188 
	`ıus_ş—r
(
cfg
->
ıu_mask
);

189 
	`š™_Úe_œq_¡©us
(
œq
);

191 ià(
	`lik–y
(!
cfg
->
move_š_´og»ss
))

193 
	`fÜ_—ch_ıu_mask
(
ıu
, 
tmp_mask
) {

194 
veùÜ
 = 
FIRST_DYNAMIC_VECTOR
; veùÜ <ğ
LAST_DYNAMIC_VECTOR
;

195 
veùÜ
++) {

196 ià(
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] !ğ
œq
)

198 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

203 
cfg
->
move_š_´og»ss
 = 0;

204 
	}
}

206 
	$ş—r_œq_veùÜ
(
œq
)

208 
æags
;

210 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

211 
	`__ş—r_œq_veùÜ
(
œq
);

212 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

213 
	}
}

215 
	$de¡roy_œq
(
œq
)

217 
	`BUG_ON
(!
	`MSI_IRQ
(
œq
));

218 
	`dyÇmic_œq_ş—nup
(
œq
);

219 
	`ş—r_œq_veùÜ
(
œq
);

220 
	}
}

222 
	$œq_to_veùÜ
(
œq
)

224 
veùÜ
 = -1;

225 
œq_cfg
 *
cfg
;

227 
	`BUG_ON
(
œq
 >ğ
Ä_œqs
 || irq < 0);

229 ià(
	`IO_APIC_IRQ
(
œq
))

230 
veùÜ
 = 
œq_veùÜ
[
œq
];

231 if(
	`MSI_IRQ
(
œq
)) {

232 
cfg
 = 
	`œq_cfg
(
œq
);

233 
veùÜ
 = 
cfg
->vector;

235 
veùÜ
 = 
	`LEGACY_VECTOR
(
œq
);

237  
veùÜ
;

238 
	}
}

240 
	$š™_Úe_œq_desc
(
œq_desc
 *
desc
)

242 
desc
->
¡©us
 = 
IRQ_DISABLED
;

243 
desc
->
hªdËr
 = &
no_œq_ty³
;

244 
desc
->
aùiÚ
 = 
NULL
;

245 
desc
->
d•th
 = 1;

246 
desc
->
msi_desc
 = 
NULL
;

247 
	`¥š_lock_š™
(&
desc
->
lock
);

248 
	`ıus_£Î
(
desc
->
affš™y
);

249 
	`INIT_LIST_HEAD
(&
desc
->
¾_lšk
);

250 
	}
}

252 
	$š™_Úe_œq_¡©us
(
œq
)

254 
œq_¡©us
[
œq
] = 
IRQ_UNUSED
;

255 
	}
}

257 
	$š™_Úe_œq_cfg
(
œq_cfg
 *
cfg
)

259 
cfg
->
veùÜ
 = 
IRQ_VECTOR_UNASSIGNED
;

260 
	`ıus_ş—r
(
cfg
->
ıu_mask
);

261 
	`ıus_ş—r
(
cfg
->
Şd_ıu_mask
);

262 
	}
}

264 
	$š™_œq_d©a
()

266 
œq_desc
 *
desc
;

267 
œq_cfg
 *
cfg
;

268 
œq
, 
veùÜ
;

270 
veùÜ
 = 0; veùÜ < 
NR_VECTORS
; ++vector)

271 
	`this_ıu
(
veùÜ_œq
)[
veùÜ
] = -1;

273 
œq_desc
 = 
	`xm®loc_¬¿y
(œq_desc, 
Ä_œqs
);

274 
œq_cfg
 = 
	`xm®loc_¬¿y
(œq_cfg, 
Ä_œqs
);

275 
œq_¡©us
 = 
	`xm®loc_¬¿y
(, 
Ä_œqs
);

276 
œq_veùÜ
 = 
	`xm®loc_¬¿y
(
u8
, 
Ä_œqs_gsi
);

278 iàĞ!
œq_desc
 || !
œq_cfg
 || !
œq_¡©us
 ||! 
œq_veùÜ
 )

279  -
ENOMEM
;

281 
	`mem£t
(
œq_desc
, 0, 
Ä_œqs
 * (*irq_desc));

282 
	`mem£t
(
œq_cfg
, 0, 
Ä_œqs
 * (*irq_cfg));

283 
	`mem£t
(
œq_¡©us
, 0, 
Ä_œqs
 * (*irq_status));

284 
	`mem£t
(
œq_veùÜ
, 0, 
Ä_œqs_gsi
 * (*irq_vector));

286 
œq
 = 0; irq < 
Ä_œqs
; irq++) {

287 
desc
 = 
	`œq_to_desc
(
œq
);

288 
cfg
 = 
	`œq_cfg
(
œq
);

289 
desc
->
œq
 = irq;

290 
desc
->
ch_d©a
 = 
cfg
;

291 
	`š™_Úe_œq_desc
(
desc
);

292 
	`š™_Úe_œq_cfg
(
cfg
);

293 
	`š™_Úe_œq_¡©us
(
œq
);

297 
	`£t_b™
(
LEGACY_SYSCALL_VECTOR
, 
u£d_veùÜs
);

298 
	`£t_b™
(
HYPERCALL_VECTOR
, 
u£d_veùÜs
);

301 
	`£t_b™
(
IRQ_MOVE_CLEANUP_VECTOR
, 
u£d_veùÜs
);

304 
	}
}

306 
__do_IRQ_gue¡
(
veùÜ
);

308 
	$no_aùiÚ
(
ıl
, *
dev_id
, 
ıu_u£r_»gs
 *
»gs
è{ 
	}
}

310 
	$’abË_nÚe
(
veùÜ
è{ 
	}
}

311 
	$¡¬tup_nÚe
(
veùÜ
è{  0; 
	}
}

312 
	$di§bË_nÚe
(
veùÜ
è{ 
	}
}

313 
	$ack_nÚe
(
œq
)

315 
	`ack_bad_œq
(
œq
);

316 
	}
}

318 
	#shutdown_nÚe
 
di§bË_nÚe


	)

319 
	#’d_nÚe
 
’abË_nÚe


	)

321 
hw_œq_cÚŒŞËr
 
	gno_œq_ty³
 = {

323 
¡¬tup_nÚe
,

324 
shutdown_nÚe
,

325 
’abË_nÚe
,

326 
di§bË_nÚe
,

327 
ack_nÚe
,

328 
’d_nÚe


331 
	$__assign_œq_veùÜ
(
œq
, 
œq_cfg
 *
cfg
, cÚ¡ 
ıumask_t
 *
mask
)

344 
cu¼’t_veùÜ
 = 
FIRST_DYNAMIC_VECTOR
, 
cu¼’t_off£t
 = 0;

345 
Şd_veùÜ
;

346 
ıu
, 
”r
;

347 
ıumask_t
 
tmp_mask
;

349 
Şd_veùÜ
 = 
	`œq_to_veùÜ
(
œq
);

350 ià(
Şd_veùÜ
) {

351 
	`ıus_ªd
(
tmp_mask
, *
mask
, 
ıu_Úlše_m­
);

352 ià(
	`ıus_š‹r£ùs
(
tmp_mask
, 
cfg
->
ıu_mask
)) {

353 
cfg
->
veùÜ
 = 
Şd_veùÜ
;

358 ià((
cfg
->
move_š_´og»ss
è|| cfg->
move_ş—nup_couÁ
)

359  -
EAGAIN
;

361 
”r
 = -
ENOSPC
;

362 
	`fÜ_—ch_ıu_mask
(
ıu
, *
mask
) {

363 
Ãw_ıu
;

364 
veùÜ
, 
off£t
;

367 ià(!
	`ıu_Úlše
(
ıu
))

370 
	`ıus_ªd
(
tmp_mask
, *
	`veùÜ_®loÿtiÚ_ıumask
(
ıu
), 
ıu_Úlše_m­
);

372 
veùÜ
 = 
cu¼’t_veùÜ
;

373 
off£t
 = 
cu¼’t_off£t
;

374 
Ãxt
:

375 
veùÜ
 += 8;

376 ià(
veùÜ
 > 
LAST_DYNAMIC_VECTOR
) {

378 
off£t
 = (offset + 1) % 8;

379 
veùÜ
 = 
FIRST_DYNAMIC_VECTOR
 + 
off£t
;

381 ià(
	`uÆik–y
(
cu¼’t_veùÜ
 =ğ
veùÜ
))

384 ià(
	`‹¡_b™
(
veùÜ
, 
u£d_veùÜs
))

385 
Ãxt
;

387 
	`fÜ_—ch_ıu_mask
(
Ãw_ıu
, 
tmp_mask
)

388 ià(
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] != -1)

389 
Ãxt
;

391 
cu¼’t_veùÜ
 = 
veùÜ
;

392 
cu¼’t_off£t
 = 
off£t
;

393 ià(
Şd_veùÜ
) {

394 
cfg
->
move_š_´og»ss
 = 1;

395 
	`ıus_cİy
(
cfg
->
Şd_ıu_mask
, cfg->
ıu_mask
);

397 
	`fÜ_—ch_ıu_mask
(
Ãw_ıu
, 
tmp_mask
)

398 
	`³r_ıu
(
veùÜ_œq
, 
Ãw_ıu
)[
veùÜ
] = 
œq
;

399 
cfg
->
veùÜ
 = vector;

400 
	`ıus_cİy
(
cfg
->
ıu_mask
, 
tmp_mask
);

402 
œq_¡©us
[
œq
] = 
IRQ_USED
;

403 ià(
	`IO_APIC_IRQ
(
œq
))

404 
œq_veùÜ
[
œq
] = 
veùÜ
;

405 
”r
 = 0;

408  
”r
;

409 
	}
}

411 
	$assign_œq_veùÜ
(
œq
)

413 
»t
;

414 
æags
;

415 
œq_cfg
 *
cfg
 = &œq_cfg[
œq
];

416 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

418 
	`BUG_ON
(
œq
 >ğ
Ä_œqs
 || irq <0);

420 
	`¥š_lock_œq§ve
(&
veùÜ_lock
, 
æags
);

421 
»t
 = 
	`__assign_œq_veùÜ
(
œq
, 
cfg
, 
TARGET_CPUS
);

422 ià(!
»t
) {

423 
»t
 = 
cfg
->
veùÜ
;

424 
	`ıus_cİy
(
desc
->
affš™y
, 
cfg
->
ıu_mask
);

426 
	`¥š_uÆock_œq»¡Üe
(&
veùÜ_lock
, 
æags
);

427  
»t
;

428 
	}
}

434 
	$__£tup_veùÜ_œq
(
ıu
)

436 
œq
, 
veùÜ
;

437 
œq_cfg
 *
cfg
;

440 
veùÜ
 = 0; veùÜ < 
NR_VECTORS
; ++vector)

441 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = -1;

443 
œq
 = 0; irq < 
Ä_œqs
; ++irq) {

444 
cfg
 = 
	`œq_cfg
(
œq
);

445 ià(!
	`ıu_is£t
(
ıu
, 
cfg
->
ıu_mask
))

447 
veùÜ
 = 
	`œq_to_veùÜ
(
œq
);

448 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
veùÜ
] = 
œq
;

450 
	}
}

452 
	$move_masked_œq
(
œq
)

454 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

456 ià(
	`lik–y
(!(
desc
->
¡©us
 & 
IRQ_MOVE_PENDING
)))

459 
desc
->
¡©us
 &ğ~
IRQ_MOVE_PENDING
;

461 ià(
	`uÆik–y
(
	`ıus_em±y
(
desc
->
³ndšg_mask
)))

464 ià(!
desc
->
hªdËr
->
£t_affš™y
)

476 ià(
	`lik–y
(
	`ıus_š‹r£ùs
(
desc
->
³ndšg_mask
, 
ıu_Úlše_m­
)))

477 
desc
->
hªdËr
->
	`£t_affš™y
(
œq
, desc->
³ndšg_mask
);

479 
	`ıus_ş—r
(
desc
->
³ndšg_mask
);

480 
	}
}

482 
	$move_Çtive_œq
(
œq
)

484 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

486 ià(
	`lik–y
(!(
desc
->
¡©us
 & 
IRQ_MOVE_PENDING
)))

489 ià(
	`uÆik–y
(
desc
->
¡©us
 & 
IRQ_DISABLED
))

492 
desc
->
hªdËr
->
	`di§bË
(
œq
);

493 
	`move_masked_œq
(
œq
);

494 
desc
->
hªdËr
->
	`’abË
(
œq
);

495 
	}
}

498 
	$œq_£t_affš™y
(
œq_desc
 *
desc
, cÚ¡ 
ıumask_t
 *
mask
)

500 ià(!
desc
->
hªdËr
->
£t_affš™y
)

503 
	`ASSERT
(
	`¥š_is_locked
(&
desc
->
lock
));

504 
desc
->
¡©us
 &ğ~
IRQ_MOVE_PENDING
;

505 
	`wmb
();

506 
	`ıus_cİy
(
desc
->
³ndšg_mask
, *
mask
);

507 
	`wmb
();

508 
desc
->
¡©us
 |ğ
IRQ_MOVE_PENDING
;

509 
	}
}

511 
	$pœq_£t_affš™y
(
domaš
 *
d
, 
pœq
, cÚ¡ 
ıumask_t
 *
mask
)

513 
æags
;

514 
œq_desc
 *
desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, &
æags
);

516 iàĞ!
desc
 )

518 
	`œq_£t_affš™y
(
desc
, 
mask
);

519 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

520 
	}
}

522 
DEFINE_PER_CPU
(, 
œq_couÁ
);

524 
asmlškage
 
	$do_IRQ
(
ıu_u£r_»gs
 *
»gs
)

526 
œqaùiÚ
 *
aùiÚ
;

527 
ušt32_t
 
tsc_š
;

528 
œq_desc
 *
desc
;

529 
veùÜ
 = 
»gs
->
’Œy_veùÜ
;

530 
œq
 = 
	`__g‘_ıu_v¬
(
veùÜ_œq
[
veùÜ
]);

531 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

533 
	`³rfc_šü
(
œqs
);

535 
	`this_ıu
(
œq_couÁ
)++;

537 ià(
œq
 < 0) {

538 
	`ack_APIC_œq
();

539 
	`´štk
("%s: %d.%d No irq handler for vector (irq %d)\n",

540 
__func__
, 
	`smp_´oûssÜ_id
(), 
veùÜ
, 
œq
);

541 
	`£t_œq_»gs
(
Şd_»gs
);

545 
	`œq_’‹r
();

547 
desc
 = 
	`œq_to_desc
(
œq
);

549 
	`¥š_lock
(&
desc
->
lock
);

550 
desc
->
hªdËr
->
	`ack
(
œq
);

552 iàĞ
	`lik–y
(
desc
->
¡©us
 & 
IRQ_GUEST
) )

554 iàĞ
œq_¿‹lim™_tim”
.
funùiÚ
 &&

555 
	`uÆik–y
(
desc
->
¾_út
++ >ğ
œq_¿‹lim™_th»shŞd
) )

557 
s_time_t
 
now
 = 
	`NOW
();

558 iàĞ
now
 < (
desc
->
¾_quªtum_¡¬t
 + 
	`MILLISECS
(10)) )

560 
desc
->
hªdËr
->
	`di§bË
(
œq
);

566 iàĞ
	`lik–y
(
	`li¡_em±y
(&
desc
->
¾_lšk
)) )

568 
	`¥š_lock
(&
œq_¿‹lim™_lock
);

569 iàĞ
	`li¡_em±y
(&
œq_¿‹lim™_li¡
) )

570 
	`£t_tim”
(&
œq_¿‹lim™_tim”
, 
now
 + 
	`MILLISECS
(10));

571 
	`li¡_add
(&
desc
->
¾_lšk
, &
œq_¿‹lim™_li¡
);

572 
	`¥š_uÆock
(&
œq_¿‹lim™_lock
);

574 
out
;

576 
desc
->
¾_út
 = 0;

577 
desc
->
¾_quªtum_¡¬t
 = 
now
;

580 
tsc_š
 = 
tb_š™_dÚe
 ? 
	`g‘_cyşes
() : 0;

581 
	`__do_IRQ_gue¡
(
œq
);

582 
	`TRACE_3D
(
TRC_TRACE_IRQ
, 
œq
, 
tsc_š
, 
	`g‘_cyşes
());

583 
out_no_’d
;

586 
desc
->
¡©us
 &ğ~
IRQ_REPLAY
;

587 
desc
->
¡©us
 |ğ
IRQ_PENDING
;

593 iàĞ
desc
->
¡©us
 & (
IRQ_DISABLED
 | 
IRQ_INPROGRESS
) )

594 
out
;

596 
desc
->
¡©us
 |ğ
IRQ_INPROGRESS
;

598 
aùiÚ
 = 
desc
->action;

599  
desc
->
¡©us
 & 
IRQ_PENDING
 )

601 
desc
->
¡©us
 &ğ~
IRQ_PENDING
;

602 
	`¥š_uÆock_œq
(&
desc
->
lock
);

603 
tsc_š
 = 
tb_š™_dÚe
 ? 
	`g‘_cyşes
() : 0;

604 
aùiÚ
->
	`hªdËr
(
œq
,‡ùiÚ->
dev_id
, 
»gs
);

605 
	`TRACE_3D
(
TRC_TRACE_IRQ
, 
œq
, 
tsc_š
, 
	`g‘_cyşes
());

606 
	`¥š_lock_œq
(&
desc
->
lock
);

609 
desc
->
¡©us
 &ğ~
IRQ_INPROGRESS
;

611 
out
:

612 
desc
->
hªdËr
->
	`’d
(
œq
);

613 
out_no_’d
:

614 
	`¥š_uÆock
(&
desc
->
lock
);

615 
	`œq_ex™
();

616 
	`£t_œq_»gs
(
Şd_»gs
);

617 
	}
}

619 
	$œq_¿‹lim™_tim”_â
(*
d©a
)

621 
œq_desc
 *
desc
, *
tmp
;

622 
æags
;

624 
	`¥š_lock_œq§ve
(&
œq_¿‹lim™_lock
, 
æags
);

626 
	`li¡_fÜ_—ch_’Œy_§ã
 ( 
desc
, 
tmp
, &
œq_¿‹lim™_li¡
, 
¾_lšk
 )

628 
	`¥š_lock
(&
desc
->
lock
);

629 
desc
->
hªdËr
->
	`’abË
(desc->
œq
);

630 
	`li¡_d–
(&
desc
->
¾_lšk
);

631 
	`INIT_LIST_HEAD
(&
desc
->
¾_lšk
);

632 
	`¥š_uÆock
(&
desc
->
lock
);

635 
	`¥š_uÆock_œq»¡Üe
(&
œq_¿‹lim™_lock
, 
æags
);

636 
	}
}

638 
__š™
 
	$œq_¿‹lim™_š™
()

640 iàĞ
œq_¿‹lim™_th»shŞd
 )

641 
	`š™_tim”
(&
œq_¿‹lim™_tim”
, 
œq_¿‹lim™_tim”_â
, 
NULL
, 0);

643 
	}
}

644 
__š™ÿÎ
(
œq_¿‹lim™_š™
);

646 
»que¡_œq
(
œq
,

647 (*
hªdËr
)(, *, 
ıu_u£r_»gs
 *),

648 
œqæags
, cÚ¡ * 
devÇme
, *
dev_id
)

650 
œqaùiÚ
 * 
aùiÚ
;

651 
»tv®
;

659 ià(
œq
 >ğ
Ä_œqs
)

660  -
EINVAL
;

661 ià(!
hªdËr
)

662  -
EINVAL
;

664 
aùiÚ
 = 
	`xm®loc
(
œqaùiÚ
);

665 ià(!
aùiÚ
)

666  -
ENOMEM
;

668 
aùiÚ
->
hªdËr
 = handler;

669 
aùiÚ
->
Çme
 = 
devÇme
;

670 
aùiÚ
->
dev_id
 = dev_id;

671 
aùiÚ
->
ä“_Ú_»Ëa£
 = 1;

673 
»tv®
 = 
	`£tup_œq
(
œq
, 
aùiÚ
);

674 ià(
»tv®
)

675 
	`xä“
(
aùiÚ
);

677  
»tv®
;

678 
	}
}

680 
	$»Ëa£_œq
(
œq
)

682 
œq_desc
 *
desc
;

683 
æags
;

684 
œqaùiÚ
 *
aùiÚ
;

686 
desc
 = 
	`œq_to_desc
(
œq
);

688 
	`¥š_lock_œq§ve
(&
desc
->
lock
,
æags
);

689 
aùiÚ
 = 
desc
->action;

690 
desc
->
aùiÚ
 = 
NULL
;

691 
desc
->
d•th
 = 1;

692 
desc
->
¡©us
 |ğ
IRQ_DISABLED
;

693 
desc
->
hªdËr
->
	`shutdown
(
œq
);

694 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
,
æags
);

697 dØ{ 
	`smp_mb
(); }  
desc
->
¡©us
 & 
IRQ_INPROGRESS
 );

699 ià(
aùiÚ
 &&‡ùiÚ->
ä“_Ú_»Ëa£
)

700 
	`xä“
(
aùiÚ
);

701 
	}
}

703 
	$£tup_œq
(
œq
, 
œqaùiÚ
 *
Ãw
)

705 
œq_desc
 *
desc
;

706 
æags
;

708 
desc
 = 
	`œq_to_desc
(
œq
);

710 
	`¥š_lock_œq§ve
(&
desc
->
lock
,
æags
);

712 iàĞ
desc
->
aùiÚ
 !ğ
NULL
 )

714 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
,
æags
);

715  -
EBUSY
;

718 
desc
->
aùiÚ
 = 
Ãw
;

719 
desc
->
d•th
 = 0;

720 
desc
->
¡©us
 &ğ~
IRQ_DISABLED
;

721 
desc
->
hªdËr
->
	`¡¬tup
(
œq
);

723 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
,
æags
);

726 
	}
}

733 
	#IRQ_MAX_GUESTS
 7

	)

735 
u8
 
	mÄ_gue¡s
;

736 
u8
 
	mš_æight
;

737 
u8
 
	msh¬—bË
;

738 
u8
 
	mack_ty³
;

739 
	#ACKTYPE_NONE
 0

	)

740 
	#ACKTYPE_UNMASK
 1

	)

741 
	#ACKTYPE_EOI
 2

	)

742 
ıumask_t
 
	mıu_eoi_m­
;

743 
tim”
 
	meoi_tim”
;

744 
domaš
 *
	mgue¡
[
IRQ_MAX_GUESTS
];

745 } 
	tœq_gue¡_aùiÚ_t
;

751 
	s³ndšg_eoi
 {

752 
u32
 
	m»ady
:1;

753 
u32
 
	mœq
:23;

754 
u32
 
	mveùÜ
:8;

757 
DEFINE_PER_CPU
(
³ndšg_eoi
,…’dšg_eoi[
NR_DYNAMIC_VECTORS
]);

758 
	#³ndšg_eoi_¥
(
p
è(Õ)[
NR_DYNAMIC_VECTORS
-1].
veùÜ
)

	)

760 
boŞ_t
 
	$ıu_has_³ndšg_­ic_eoi
()

762  (
	`³ndšg_eoi_¥
(
	`this_ıu
(
³ndšg_eoi
)) != 0);

763 
	}
}

765 
šlše
 
	$£t_pœq_eoi
(
domaš
 *
d
, 
œq
)

767 iàĞ
d
->
¬ch
.
pœq_eoi_m­
 )

768 
	`£t_b™
(
œq
, 
d
->
¬ch
.
pœq_eoi_m­
);

769 
	}
}

771 
šlše
 
	$ş—r_pœq_eoi
(
domaš
 *
d
, 
œq
)

773 iàĞ
d
->
¬ch
.
pœq_eoi_m­
 )

774 
	`ş—r_b™
(
œq
, 
d
->
¬ch
.
pœq_eoi_m­
);

775 
	}
}

777 
	$_œq_gue¡_eoi
(
œq_desc
 *
desc
)

779 
œq_gue¡_aùiÚ_t
 *
aùiÚ
 = (œq_gue¡_aùiÚ_ˆ*)
desc
->action;

780 
i
, 
œq
 = 
desc
 - 
œq_desc
;

782 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST_EOI_PENDING
) )

785  
i
 = 0; i < 
aùiÚ
->
Ä_gue¡s
; ++i )

786 
	`ş—r_pœq_eoi
(
aùiÚ
->
gue¡
[
i
],

787 
	`domaš_œq_to_pœq
(
aùiÚ
->
gue¡
[
i
], 
œq
));

789 
desc
->
¡©us
 &ğ~(
IRQ_INPROGRESS
|
IRQ_GUEST_EOI_PENDING
);

790 
desc
->
hªdËr
->
	`’abË
(
œq
);

791 
	}
}

793 
£t_eoi_»ady
(*
d©a
);

795 
	$œq_gue¡_eoi_tim”_â
(*
d©a
)

797 
œq_desc
 *
desc
 = 
d©a
;

798 
œq
 = 
desc
 - 
œq_desc
;

799 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

800 
ıumask_t
 
ıu_eoi_m­
;

801 
æags
;

803 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

805 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

806 
out
;

808 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

810 iàĞ
aùiÚ
->
ack_ty³
 !ğ
ACKTYPE_NONE
 )

812 
i
;

813  
i
 = 0; i < 
aùiÚ
->
Ä_gue¡s
; i++ )

815 
domaš
 *
d
 = 
aùiÚ
->
gue¡
[
i
];

816 
pœq
 = 
	`domaš_œq_to_pœq
(
d
, 
œq
);

817 iàĞ
	`‹¡_ªd_ş—r_b™
(
pœq
, 
d
->
pœq_mask
) )

818 
aùiÚ
->
š_æight
--;

822 iàĞ
aùiÚ
->
š_æight
 != 0 )

823 
out
;

825  
aùiÚ
->
ack_ty³
 )

827 
ACKTYPE_UNMASK
:

828 
desc
->
hªdËr
->
	`’d
(
œq
);

830 
ACKTYPE_EOI
:

831 
ıu_eoi_m­
 = 
aùiÚ
->cpu_eoi_map;

832 
	`¥š_uÆock_œq
(&
desc
->
lock
);

833 
	`Ú_£Ëùed_ıus
(&
ıu_eoi_m­
, 
£t_eoi_»ady
, 
desc
, 0);

834 
	`¥š_lock_œq
(&
desc
->
lock
);

836 
ACKTYPE_NONE
:

837 
	`_œq_gue¡_eoi
(
desc
);

841 
out
:

842 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

843 
	}
}

845 
	$__do_IRQ_gue¡
(
œq
)

847 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

848 
œq_gue¡_aùiÚ_t
 *
aùiÚ
 = (œq_gue¡_aùiÚ_ˆ*)
desc
->action;

849 
domaš
 *
d
;

850 
i
, 
¥
, 
®»ady_³ndšg
 = 0;

851 
³ndšg_eoi
 *
³oi
 = 
	`this_ıu
(pending_eoi);

852 
veùÜ
 = 
	`g‘_œq_»gs
()->
’Œy_veùÜ
;

854 iàĞ
	`uÆik–y
(
aùiÚ
->
Ä_gue¡s
 == 0) )

857 
	`ASSERT
(
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_EOI
);

858 
	`ASSERT
(
desc
->
¡©us
 & 
IRQ_DISABLED
);

859 
desc
->
hªdËr
->
	`’d
(
œq
);

863 iàĞ
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_EOI
 )

865 
¥
 = 
	`³ndšg_eoi_¥
(
³oi
);

866 
	`ASSERT
((
¥
 =ğ0è|| (
³oi
[¥-1].
veùÜ
 < vector));

867 
	`ASSERT
(
¥
 < (
NR_DYNAMIC_VECTORS
-1));

868 
³oi
[
¥
].
œq
 = irq;

869 
³oi
[
¥
].
veùÜ
 = vector;

870 
³oi
[
¥
].
»ady
 = 0;

871 
	`³ndšg_eoi_¥
(
³oi
èğ
¥
+1;

872 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
aùiÚ
->
ıu_eoi_m­
);

875  
i
 = 0; i < 
aùiÚ
->
Ä_gue¡s
; i++ )

877 
pœq
;

878 
d
 = 
aùiÚ
->
gue¡
[
i
];

879 
pœq
 = 
	`domaš_œq_to_pœq
(
d
, 
œq
);

880 iàĞ(
aùiÚ
->
ack_ty³
 !ğ
ACKTYPE_NONE
) &&

881 !
	`‹¡_ªd_£t_b™
(
pœq
, 
d
->
pœq_mask
) )

882 
aùiÚ
->
š_æight
++;

883 iàĞ
	`hvm_do_IRQ_dpci
(
d
, 
pœq
) )

885 iàĞ
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_NONE
 )

887 
®»ady_³ndšg
 +ğ!!(
desc
->
¡©us
 & 
IRQ_INPROGRESS
);

888 
desc
->
¡©us
 |ğ
IRQ_INPROGRESS
;

891 iàĞ
	`£nd_gue¡_pœq
(
d
, 
pœq
) &&

892 (
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_NONE
) )

894 
®»ady_³ndšg
++;

898 
	`¡İ_tim”
(&
aùiÚ
->
eoi_tim”
);

900 iàĞ(
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_NONE
) &&

901 (
®»ady_³ndšg
 =ğ
aùiÚ
->
Ä_gue¡s
) )

903 
desc
->
hªdËr
->
	`di§bË
(
œq
);

904 
desc
->
¡©us
 |ğ
IRQ_GUEST_EOI_PENDING
;

905  
i
 = 0; i < 
®»ady_³ndšg
; ++i )

907 
d
 = 
aùiÚ
->
gue¡
[
i
];

908 
	`£t_pœq_eoi
(
d
, 
	`domaš_œq_to_pœq
(d, 
œq
));

920 
	`mig¿‹_tim”
(&
aùiÚ
->
eoi_tim”
, 
	`smp_´oûssÜ_id
());

921 
	`£t_tim”
(&
aùiÚ
->
eoi_tim”
, 
	`NOW
(è+ 
	`MILLISECS
(1));

922 
	}
}

929 
œq_desc
 *
	$domaš_¥š_lock_œq_desc
(

930 
domaš
 *
d
, 
pœq
, *
pæags
)

932 
œq
;

933 
æags
;

934 
œq_desc
 *
desc
;

938 
œq
 = 
	`domaš_pœq_to_œq
(
d
, 
pœq
);

939 iàĞ
œq
 <= 0 )

940  
NULL
;

941 
desc
 = 
	`œq_to_desc
(
œq
);

942 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

943 iàĞ
œq
 =ğ
	`domaš_pœq_to_œq
(
d
, 
pœq
) )

945 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

948 iàĞ
pæags
 !ğ
NULL
 )

949 *
pæags
 = 
æags
;

950  
desc
;

951 
	}
}

954 
	$æush_»ady_eoi
()

956 
³ndšg_eoi
 *
³oi
 = 
	`this_ıu
(pending_eoi);

957 
œq_desc
 *
desc
;

958 
œq
, 
¥
;

960 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

962 
¥
 = 
	`³ndšg_eoi_¥
(
³oi
);

964  (--
¥
 >ğ0è&& 
³oi
[¥].
»ady
 )

966 
œq
 = 
³oi
[
¥
].irq;

967 
	`ASSERT
(
œq
 > 0);

968 
desc
 = 
	`œq_to_desc
(
œq
);

969 
	`¥š_lock
(&
desc
->
lock
);

970 
desc
->
hªdËr
->
	`’d
(
œq
);

971 
	`¥š_uÆock
(&
desc
->
lock
);

974 
	`³ndšg_eoi_¥
(
³oi
èğ
¥
+1;

975 
	}
}

977 
	$__£t_eoi_»ady
(
œq_desc
 *
desc
)

979 
œq_gue¡_aùiÚ_t
 *
aùiÚ
 = (œq_gue¡_aùiÚ_ˆ*)
desc
->action;

980 
³ndšg_eoi
 *
³oi
 = 
	`this_ıu
(pending_eoi);

981 
œq
, 
¥
;

983 
œq
 = 
desc
 - 
œq_desc
;

985 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) ||

986 (
aùiÚ
->
š_æight
 != 0) ||

987 !
	`ıu_‹¡_ªd_ş—r
(
	`smp_´oûssÜ_id
(), 
aùiÚ
->
ıu_eoi_m­
) )

990 
¥
 = 
	`³ndšg_eoi_¥
(
³oi
);

993 
	`ASSERT
(
¥
 > 0);

994 }  
³oi
[--
¥
].
œq
 != irq );

995 
	`ASSERT
(!
³oi
[
¥
].
»ady
);

996 
³oi
[
¥
].
»ady
 = 1;

997 
	}
}

1000 
	$£t_eoi_»ady
(*
d©a
)

1002 
œq_desc
 *
desc
 = 
d©a
;

1004 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

1006 
	`¥š_lock
(&
desc
->
lock
);

1007 
	`__£t_eoi_»ady
(
desc
);

1008 
	`¥š_uÆock
(&
desc
->
lock
);

1010 
	`æush_»ady_eoi
();

1011 
	}
}

1013 
	$__pœq_gue¡_eoi
(
domaš
 *
d
, 
pœq
)

1015 
œq_desc
 *
desc
;

1016 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

1017 
ıumask_t
 
ıu_eoi_m­
;

1018 
œq
;

1020 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

1021 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, 
NULL
);

1022 iàĞ
desc
 =ğ
NULL
 )

1025 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

1027 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1031 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1032 
œq
 = 
desc
 - 
œq_desc
;

1034 iàĞ
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_NONE
 )

1036 
	`ASSERT
(!
	`‹¡_b™
(
pœq
, 
d
->
pœq_mask
));

1037 
	`¡İ_tim”
(&
aùiÚ
->
eoi_tim”
);

1038 
	`_œq_gue¡_eoi
(
desc
);

1041 iàĞ
	`uÆik–y
(!
	`‹¡_ªd_ş—r_b™
(
pœq
, 
d
->
pœq_mask
)) ||

1042 
	`uÆik–y
(--
aùiÚ
->
š_æight
 != 0) )

1044 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1048 iàĞ
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_UNMASK
 )

1050 
	`ASSERT
(
	`ıus_em±y
(
aùiÚ
->
ıu_eoi_m­
));

1051 
desc
->
hªdËr
->
	`’d
(
œq
);

1052 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1056 
	`ASSERT
(
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_EOI
);

1058 
ıu_eoi_m­
 = 
aùiÚ
->cpu_eoi_map;

1060 iàĞ
	`ıu_‹¡_ªd_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_eoi_m­
) )

1062 
	`__£t_eoi_»ady
(
desc
);

1063 
	`¥š_uÆock
(&
desc
->
lock
);

1064 
	`æush_»ady_eoi
();

1065 
	`loÿl_œq_’abË
();

1069 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1072 iàĞ!
	`ıus_em±y
(
ıu_eoi_m­
) )

1073 
	`Ú_£Ëùed_ıus
(&
ıu_eoi_m­
, 
£t_eoi_»ady
, 
desc
, 0);

1074 
	}
}

1076 
	$pœq_gue¡_eoi
(
domaš
 *
d
, 
œq
)

1078 iàĞ(
œq
 < 0è|| (œq >ğ
d
->
Ä_pœqs
) )

1079  -
EINVAL
;

1081 
	`__pœq_gue¡_eoi
(
d
, 
œq
);

1084 
	}
}

1086 
	$pœq_gue¡_unmask
(
domaš
 *
d
)

1088 
œq
, 
Ä
 = 
d
->
Ä_pœqs
;

1090  
œq
 = 
	`fšd_fœ¡_b™
(
d
->
pœq_mask
, 
Ä
);

1091 
œq
 < 
Ä
;

1092 
œq
 = 
	`fšd_Ãxt_b™
(
d
->
pœq_mask
, 
Ä
, irq+1) )

1094 iàĞ!
	`‹¡_b™
(
d
->
pœq_to_evtchn
[
œq
], &
	`sh¬ed_šfo
(d, 
evtchn_mask
)) )

1095 
	`__pœq_gue¡_eoi
(
d
, 
œq
);

1099 
	}
}

1101 
ißpic_ack_Ãw
;

1102 
	$pœq_ackty³
(
domaš
 *
d
, 
pœq
)

1104 
œq_desc
 *
desc
;

1105 
œq
;

1107 
œq
 = 
	`domaš_pœq_to_œq
(
d
, 
pœq
);

1108 iàĞ
œq
 <= 0 )

1109  
ACKTYPE_NONE
;

1111 
desc
 = 
	`œq_to_desc
(
œq
);

1113 iàĞ
desc
->
hªdËr
 =ğ&
no_œq_ty³
 )

1114  
ACKTYPE_NONE
;

1120 iàĞ!
	`¡rcmp
(
desc
->
hªdËr
->
ty³Çme
, "IO-APIC-edge") ||

1121 !
	`¡rcmp
(
desc
->
hªdËr
->
ty³Çme
, "local-APIC-edge") )

1122  
ACKTYPE_NONE
;

1128 iàĞ
desc
->
hªdËr
 =ğ&
pci_msi_ty³
 )

1129  
	`msi_maskabË_œq
(
desc
->
msi_desc
è? 
ACKTYPE_NONE
 : 
ACKTYPE_EOI
;

1135 iàĞ!
	`¡rcmp
(
desc
->
hªdËr
->
ty³Çme
, "IO-APIC-level") )

1136  
ißpic_ack_Ãw
 ? 
ACKTYPE_EOI
 : 
ACKTYPE_UNMASK
;

1139 iàĞ!
	`¡rcmp
(
desc
->
hªdËr
->
ty³Çme
, "XT-PIC") )

1140  
ACKTYPE_UNMASK
;

1142 
	`´štk
("UnknowÀPICy³ '%s' fÜ IRQ %d\n", 
desc
->
hªdËr
->
ty³Çme
, 
œq
);

1143 
	`BUG
();

1146 
	}
}

1148 
	$pœq_sh¬ed
(
domaš
 *
d
, 
pœq
)

1150 
œq_desc
 *
desc
;

1151 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

1152 
æags
;

1153 
sh¬ed
;

1155 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, &
æags
);

1156 iàĞ
desc
 =ğ
NULL
 )

1159 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1160 
sh¬ed
 = ((
desc
->
¡©us
 & 
IRQ_GUEST
è&& (
aùiÚ
->
Ä_gue¡s
 > 1));

1162 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1164  
sh¬ed
;

1165 
	}
}

1167 
	$pœq_gue¡_bšd
(
vıu
 *
v
, 
pœq
, 
wl_sh¬e
)

1169 
œq
;

1170 
œq_desc
 *
desc
;

1171 
œq_gue¡_aùiÚ_t
 *
aùiÚ
, *
ÃwaùiÚ
 = 
NULL
;

1172 
rc
 = 0;

1173 
ıumask_t
 
ıumask
 = 
CPU_MASK_NONE
;

1175 
	`WARN_ON
(!
	`¥š_is_locked
(&
v
->
domaš
->
ev’t_lock
));

1176 
	`BUG_ON
(!
	`loÿl_œq_is_’abËd
());

1178 
»Œy
:

1179 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
v
->
domaš
, 
pœq
, 
NULL
);

1180 iàĞ
desc
 =ğ
NULL
 )

1182 
rc
 = -
EINVAL
;

1183 
out
;

1186 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1187 
œq
 = 
desc
 - 
œq_desc
;

1189 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

1191 iàĞ
desc
->
aùiÚ
 !ğ
NULL
 )

1193 
	`gd´štk
(
XENLOG_INFO
,

1195 
pœq
, 
desc
->
aùiÚ
->
Çme
);

1196 
rc
 = -
EBUSY
;

1197 
uÆock_out
;

1200 iàĞ
ÃwaùiÚ
 =ğ
NULL
 )

1202 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1203 iàĞ(
ÃwaùiÚ
 = 
	`xm®loc
(
œq_gue¡_aùiÚ_t
)è!ğ
NULL
 )

1204 
»Œy
;

1205 
	`gd´štk
(
XENLOG_INFO
,

1207 
pœq
);

1208 
rc
 = -
ENOMEM
;

1209 
out
;

1212 
aùiÚ
 = 
ÃwaùiÚ
;

1213 
desc
->
aùiÚ
 = (
œqaùiÚ
 *)action;

1214 
ÃwaùiÚ
 = 
NULL
;

1216 
aùiÚ
->
Ä_gue¡s
 = 0;

1217 
aùiÚ
->
š_æight
 = 0;

1218 
aùiÚ
->
sh¬—bË
 = 
wl_sh¬e
;

1219 
aùiÚ
->
ack_ty³
 = 
	`pœq_ackty³
(
v
->
domaš
, 
pœq
);

1220 
	`ıus_ş—r
(
aùiÚ
->
ıu_eoi_m­
);

1221 
	`š™_tim”
(&
aùiÚ
->
eoi_tim”
, 
œq_gue¡_eoi_tim”_â
, 
desc
, 0);

1223 
desc
->
d•th
 = 0;

1224 
desc
->
¡©us
 |ğ
IRQ_GUEST
;

1225 
desc
->
¡©us
 &ğ~
IRQ_DISABLED
;

1226 
desc
->
hªdËr
->
	`¡¬tup
(
œq
);

1229 
	`ıu_£t
(
v
->
´oûssÜ
, 
ıumask
);

1230 iàĞ!
İt_noœqb®ªû
 && (
desc
->
hªdËr
->
£t_affš™y
 !ğ
NULL
) )

1231 
desc
->
hªdËr
->
	`£t_affš™y
(
œq
, 
ıumask
);

1233 iàĞ!
wl_sh¬e
 || !
aùiÚ
->
sh¬—bË
 )

1235 
	`gd´štk
(
XENLOG_INFO
, "Cannot bind IRQ %do guest. %s.\n",

1236 
pœq
,

1237 
wl_sh¬e
 ?

1240 
rc
 = -
EBUSY
;

1241 
uÆock_out
;

1243 iàĞ
aùiÚ
->
Ä_gue¡s
 == 0 )

1249 
	`ASSERT
(
aùiÚ
->
ack_ty³
 =ğ
ACKTYPE_EOI
);

1250 
	`ASSERT
(
desc
->
¡©us
 & 
IRQ_DISABLED
);

1251 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1252 
	`ıu_»Ïx
();

1253 
»Œy
;

1256 iàĞ
aùiÚ
->
Ä_gue¡s
 =ğ
IRQ_MAX_GUESTS
 )

1258 
	`gd´štk
(
XENLOG_INFO
, "Cannot bind IRQ %do guest. "

1259 "AÌ—dy‡ˆmax sh¬e.\n", 
pœq
);

1260 
rc
 = -
EBUSY
;

1261 
uÆock_out
;

1264 
aùiÚ
->
gue¡
[aùiÚ->
Ä_gue¡s
++] = 
v
->
domaš
;

1266 iàĞ
aùiÚ
->
ack_ty³
 !ğ
ACKTYPE_NONE
 )

1267 
	`£t_pœq_eoi
(
v
->
domaš
, 
pœq
);

1269 
	`ş—r_pœq_eoi
(
v
->
domaš
, 
pœq
);

1271 
uÆock_out
:

1272 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1273 
out
:

1274 iàĞ
ÃwaùiÚ
 !ğ
NULL
 )

1275 
	`xä“
(
ÃwaùiÚ
);

1276  
rc
;

1277 
	}
}

1279 
œq_gue¡_aùiÚ_t
 *
	$__pœq_gue¡_unbšd
(

1280 
domaš
 *
d
, 
pœq
, 
œq_desc
 *
desc
)

1282 
œq
;

1283 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

1284 
ıumask_t
 
ıu_eoi_m­
;

1285 
i
;

1287 
	`BUG_ON
(!(
desc
->
¡©us
 & 
IRQ_GUEST
));

1289 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1290 
œq
 = 
desc
 - 
œq_desc
;

1292 iàĞ
	`uÆik–y
(
aùiÚ
 =ğ
NULL
) )

1294 
	`d´štk
(
XENLOG_G_WARNING
, "dom%d:…irq %d: desc->action is NULL!\n",

1295 
d
->
domaš_id
, 
pœq
);

1296  
NULL
;

1299  
i
 = 0; (˜< 
aùiÚ
->
Ä_gue¡s
è&& (aùiÚ->
gue¡
[i] !ğ
d
); i++ )

1301 
	`BUG_ON
(
i
 =ğ
aùiÚ
->
Ä_gue¡s
);

1302 
	`memmove
(&
aùiÚ
->
gue¡
[
i
], &action->guest[i+1],

1303 (
aùiÚ
->
Ä_gue¡s
-
i
-1è* ×ùiÚ->
gue¡
[0]));

1304 
aùiÚ
->
Ä_gue¡s
--;

1306  
aùiÚ
->
ack_ty³
 )

1308 
ACKTYPE_UNMASK
:

1309 iàĞ
	`‹¡_ªd_ş—r_b™
(
pœq
, 
d
->
pœq_mask
) &&

1310 (--
aùiÚ
->
š_æight
 == 0) )

1311 
desc
->
hªdËr
->
	`’d
(
œq
);

1313 
ACKTYPE_EOI
:

1315 iàĞ
	`‹¡_ªd_ş—r_b™
(
pœq
, 
d
->
pœq_mask
) &&

1316 (--
aùiÚ
->
š_æight
 == 0) &&

1317 (
aùiÚ
->
Ä_gue¡s
 != 0) )

1319 
ıu_eoi_m­
 = 
aùiÚ
->cpu_eoi_map;

1320 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1321 
	`Ú_£Ëùed_ıus
(&
ıu_eoi_m­
, 
£t_eoi_»ady
, 
desc
, 0);

1322 
	`¥š_lock_œq
(&
desc
->
lock
);

1325 
ACKTYPE_NONE
:

1326 
	`¡İ_tim”
(&
aùiÚ
->
eoi_tim”
);

1327 
	`_œq_gue¡_eoi
(
desc
);

1335 
	`BUG_ON
(
	`‹¡_b™
(
pœq
, 
d
->
pœq_mask
));

1337 iàĞ
aùiÚ
->
Ä_gue¡s
 != 0 )

1338  
NULL
;

1340 
	`BUG_ON
(
aùiÚ
->
š_æight
 != 0);

1343 
desc
->
d•th
 = 1;

1344 
desc
->
¡©us
 |ğ
IRQ_DISABLED
;

1345 
desc
->
hªdËr
->
	`di§bË
(
œq
);

1354 
ıu_eoi_m­
 = 
aùiÚ
->cpu_eoi_map;

1355 iàĞ!
	`ıus_em±y
(
ıu_eoi_m­
) )

1357 
	`BUG_ON
(
aùiÚ
->
ack_ty³
 !ğ
ACKTYPE_EOI
);

1358 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1359 
	`Ú_£Ëùed_ıus
(&
ıu_eoi_m­
, 
£t_eoi_»ady
, 
desc
, 1);

1360 
	`¥š_lock_œq
(&
desc
->
lock
);

1363 
	`BUG_ON
(!
	`ıus_em±y
(
aùiÚ
->
ıu_eoi_m­
));

1365 
desc
->
aùiÚ
 = 
NULL
;

1366 
desc
->
¡©us
 &ğ~(
IRQ_GUEST
|
IRQ_GUEST_EOI_PENDING
|
IRQ_INPROGRESS
);

1367 
desc
->
hªdËr
->
	`shutdown
(
œq
);

1370  
aùiÚ
;

1371 
	}
}

1373 
	$pœq_gue¡_unbšd
(
domaš
 *
d
, 
pœq
)

1375 
œq_gue¡_aùiÚ_t
 *
ŞdaùiÚ
 = 
NULL
;

1376 
œq_desc
 *
desc
;

1377 
œq
;

1379 
	`WARN_ON
(!
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1381 
	`BUG_ON
(!
	`loÿl_œq_is_’abËd
());

1382 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
pœq
, 
NULL
);

1384 iàĞ
desc
 =ğ
NULL
 )

1386 
œq
 = -
	`domaš_pœq_to_œq
(
d
, 
pœq
);

1387 
	`BUG_ON
(
œq
 <= 0);

1388 
desc
 = 
	`œq_to_desc
(
œq
);

1389 
	`¥š_lock_œq
(&
desc
->
lock
);

1390 
d
->
¬ch
.
pœq_œq
[
pœq
] = d->¬ch.
œq_pœq
[
œq
] = 0;

1394 
ŞdaùiÚ
 = 
	`__pœq_gue¡_unbšd
(
d
, 
pœq
, 
desc
);

1397 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1399 iàĞ
ŞdaùiÚ
 !ğ
NULL
 )

1401 
	`kl_tim”
(&
ŞdaùiÚ
->
eoi_tim”
);

1402 
	`xä“
(
ŞdaùiÚ
);

1404 
	}
}

1406 
	$pœq_gue¡_fÜû_unbšd
(
domaš
 *
d
, 
œq
)

1408 
œq_desc
 *
desc
;

1409 
œq_gue¡_aùiÚ_t
 *
aùiÚ
, *
ŞdaùiÚ
 = 
NULL
;

1410 
i
, 
bound
 = 0;

1412 
	`WARN_ON
(!
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1414 
	`BUG_ON
(!
	`loÿl_œq_is_’abËd
());

1415 
desc
 = 
	`domaš_¥š_lock_œq_desc
(
d
, 
œq
, 
NULL
);

1416 
	`BUG_ON
(
desc
 =ğ
NULL
);

1418 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

1419 
out
;

1421 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1422 iàĞ
	`uÆik–y
(
aùiÚ
 =ğ
NULL
) )

1424 
	`d´štk
(
XENLOG_G_WARNING
, "dom%d:…irq %d: desc->action is NULL!\n",

1425 
d
->
domaš_id
, 
œq
);

1426 
out
;

1429  
i
 = 0; (˜< 
aùiÚ
->
Ä_gue¡s
è&& (aùiÚ->
gue¡
[i] !ğ
d
); i++ )

1431 iàĞ
i
 =ğ
aùiÚ
->
Ä_gue¡s
 )

1432 
out
;

1434 
bound
 = 1;

1435 
ŞdaùiÚ
 = 
	`__pœq_gue¡_unbšd
(
d
, 
œq
, 
desc
);

1437 
out
:

1438 
	`¥š_uÆock_œq
(&
desc
->
lock
);

1440 iàĞ
ŞdaùiÚ
 !ğ
NULL
 )

1442 
	`kl_tim”
(&
ŞdaùiÚ
->
eoi_tim”
);

1443 
	`xä“
(
ŞdaùiÚ
);

1446  
bound
;

1447 
	}
}

1449 
	$g‘_ä“_pœq
(
domaš
 *
d
, 
ty³
, 
šdex
)

1451 
i
;

1453 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1455 iàĞ
ty³
 =ğ
MAP_PIRQ_TYPE_GSI
 )

1457  
i
 = 16; i < 
Ä_œqs_gsi
; i++ )

1458 iàĞ!
d
->
¬ch
.
pœq_œq
[
i
] )

1460 iàĞ!
	`is_hvm_domaš
(
d
) ||

1461 
d
->
¬ch
.
pœq_emuœq
[
i
] =ğ
IRQ_UNBOUND
 )

1464 iàĞ
i
 =ğ
Ä_œqs_gsi
 )

1465  -
ENOSPC
;

1469  
i
 = 
d
->
Ä_pœqs
 - 1; i >ğ
Ä_œqs_gsi
; i-- )

1470 iàĞ!
d
->
¬ch
.
pœq_œq
[
i
] )

1472 iàĞ!
	`is_hvm_domaš
(
d
) ||

1473 
d
->
¬ch
.
pœq_emuœq
[
i
] =ğ
IRQ_UNBOUND
 )

1476 iàĞ
i
 < 
Ä_œqs_gsi
 )

1477  -
ENOSPC
;

1480  
i
;

1481 
	}
}

1483 
	$m­_domaš_pœq
(

1484 
domaš
 *
d
, 
pœq
, 
œq
, 
ty³
, *
d©a
)

1486 
»t
 = 0;

1487 
Şd_œq
, 
Şd_pœq
;

1488 
œq_desc
 *
desc
;

1489 
æags
;

1490 
msi_desc
 *msi_desc;

1491 
pci_dev
 *
pdev
 = 
NULL
;

1493 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

1494 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1496 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) &&

1497 !(
	`IS_PRIV_FOR
(
cu¼’t
->
domaš
, 
d
) &&

1498 
	`œq_acûss_³rm™‹d
(
cu¼’t
->
domaš
, 
pœq
)))

1499  -
EPERM
;

1501 iàĞ
pœq
 < 0 ||…œq >ğ
d
->
Ä_pœqs
 || 
œq
 < 0 || irq >ğ
Ä_œqs
 )

1503 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: invalid…irq %d or irq %d\n",

1504 
d
->
domaš_id
, 
pœq
, 
œq
);

1505  -
EINVAL
;

1508 
Şd_œq
 = 
	`domaš_pœq_to_œq
(
d
, 
pœq
);

1509 
Şd_pœq
 = 
	`domaš_œq_to_pœq
(
d
, 
œq
);

1511 iàĞ(
Şd_œq
 > 0 && (Şd_œq !ğ
œq
) ) ||

1512 (
Şd_pœq
 && (Şd_pœq !ğ
pœq
)) )

1514 
	`d´štk
(
XENLOG_G_WARNING
, "dom%d:…irq %d or irq %d‡lready mapped\n",

1515 
d
->
domaš_id
, 
pœq
, 
œq
);

1519 
»t
 = 
	`œq_³rm™_acûss
(
d
, 
pœq
);

1520 iàĞ
»t
 )

1522 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: could‚ot…ermit‡ccesso irq %d\n",

1523 
d
->
domaš_id
, 
pœq
);

1524  
»t
;

1527 
desc
 = 
	`œq_to_desc
(
œq
);

1529 iàĞ
ty³
 =ğ
MAP_PIRQ_TYPE_MSI
 )

1531 
msi_šfo
 *
msi
 = (msi_šfØ*)
d©a
;

1533 
»t
 = -
ENODEV
;

1534 iàĞ!
ıu_has_­ic
 )

1535 
dÚe
;

1537 
pdev
 = 
	`pci_g‘_pdev
(
msi
->
bus
, msi->
devâ
);

1538 
»t
 = 
	`pci_’abË_msi
(
msi
, &
msi_desc
);

1539 iàĞ
»t
 )

1540 
dÚe
;

1542 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

1544 iàĞ
desc
->
hªdËr
 !ğ&
no_œq_ty³
 )

1545 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: irq %d in use\n",

1546 
d
->
domaš_id
, 
œq
);

1547 
desc
->
hªdËr
 = &
pci_msi_ty³
;

1548 
d
->
¬ch
.
pœq_œq
[
pœq
] = 
œq
;

1549 
d
->
¬ch
.
œq_pœq
[
œq
] = 
pœq
;

1550 
	`£tup_msi_œq
(
pdev
, 
msi_desc
, 
œq
);

1551 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1554 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

1555 
d
->
¬ch
.
pœq_œq
[
pœq
] = 
œq
;

1556 
d
->
¬ch
.
œq_pœq
[
œq
] = 
pœq
;

1557 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1560 
dÚe
:

1561  
»t
;

1562 
	}
}

1565 
	$unm­_domaš_pœq
(
domaš
 *
d
, 
pœq
)

1567 
æags
;

1568 
œq_desc
 *
desc
;

1569 
œq
, 
»t
 = 0;

1570 
boŞ_t
 
fÜûd_unbšd
;

1571 
msi_desc
 *msi_desøğ
NULL
;

1573 iàĞ(
pœq
 < 0è|| (pœq >ğ
d
->
Ä_pœqs
) )

1574  -
EINVAL
;

1576 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

1577 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1579 
œq
 = 
	`domaš_pœq_to_œq
(
d
, 
pœq
);

1580 iàĞ
œq
 <= 0 )

1582 
	`d´štk
(
XENLOG_G_ERR
, "dom%d:…irq %d‚ot mapped\n",

1583 
d
->
domaš_id
, 
pœq
);

1584 
»t
 = -
EINVAL
;

1585 
dÚe
;

1588 
fÜûd_unbšd
 = 
	`pœq_gue¡_fÜû_unbšd
(
d
, 
pœq
);

1589 iàĞ
fÜûd_unbšd
 )

1590 
	`d´štk
(
XENLOG_G_WARNING
, "dom%d: forcing unbind of…irq %d\n",

1591 
d
->
domaš_id
, 
pœq
);

1593 
desc
 = 
	`œq_to_desc
(
œq
);

1595 iàĞ(
msi_desc
 = 
desc
->msi_descè!ğ
NULL
 )

1596 
	`pci_di§bË_msi
(
msi_desc
);

1598 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

1600 
	`BUG_ON
(
œq
 !ğ
	`domaš_pœq_to_œq
(
d
, 
pœq
));

1602 iàĞ!
fÜûd_unbšd
 )

1604 
d
->
¬ch
.
pœq_œq
[
pœq
] = 0;

1605 
d
->
¬ch
.
œq_pœq
[
œq
] = 0;

1609 
d
->
¬ch
.
pœq_œq
[
pœq
] = -
œq
;

1610 
d
->
¬ch
.
œq_pœq
[
œq
] = -
pœq
;

1613 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1614 ià(
msi_desc
)

1615 
	`msi_ä“_œq
(
msi_desc
);

1617 
»t
 = 
	`œq_d’y_acûss
(
d
, 
pœq
);

1618 iàĞ
»t
 )

1619 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: could‚ot deny‡ccesso irq %d\n",

1620 
d
->
domaš_id
, 
pœq
);

1622 iàĞ
desc
->
hªdËr
 =ğ&
pci_msi_ty³
 )

1623 
desc
->
hªdËr
 = &
no_œq_ty³
;

1625 
dÚe
:

1626  
»t
;

1627 
	}
}

1629 
	$ä“_domaš_pœqs
(
domaš
 *
d
)

1631 
i
;

1633 
	`¥š_lock
(&
pcidevs_lock
);

1634 
	`¥š_lock
(&
d
->
ev’t_lock
);

1636  
i
 = 0; i < 
d
->
Ä_pœqs
; i++ )

1637 iàĞ
d
->
¬ch
.
pœq_œq
[
i
] > 0 )

1638 
	`unm­_domaš_pœq
(
d
, 
i
);

1640 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

1641 
	`¥š_uÆock
(&
pcidevs_lock
);

1642 
	}
}

1644 
dump_ißpic_œq_šfo
();

1646 
	$dump_œqs
(
key
)

1648 
i
, 
œq
, 
pœq
;

1649 
œq_desc
 *
desc
;

1650 
œq_cfg
 *
cfg
;

1651 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

1652 
domaš
 *
d
;

1653 
æags
;

1655 
	`´štk
("Guest interrupt information:\n");

1657  
œq
 = 0; irq < 
Ä_œqs
; irq++ )

1660 
desc
 = 
	`œq_to_desc
(
œq
);

1661 
cfg
 = 
desc
->
ch_d©a
;

1663 iàĞ!
desc
->
hªdËr
 || desc->hªdË¸=ğ&
no_œq_ty³
 )

1666 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

1668 
	`ıumask_sú´štf
(
keyhªdËr_sü©ch
, (keyhandler_scratch),

1669 
desc
->
affš™y
);

1670 
	`´štk
(" IRQ:%4d‡ffinity:%s vec:%02xype=%-15s"

1672 
œq
, 
keyhªdËr_sü©ch
, 
cfg
->
veùÜ
,

1673 
desc
->
hªdËr
->
ty³Çme
, desc->
¡©us
);

1675 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

1676 
	`´štk
("mapped, unbound\n");

1679 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1681 
	`´štk
("š-æight=%d domaš-li¡=", 
aùiÚ
->
š_æight
);

1683  
i
 = 0; i < 
aùiÚ
->
Ä_gue¡s
; i++ )

1685 
d
 = 
aùiÚ
->
gue¡
[
i
];

1686 
pœq
 = 
	`domaš_œq_to_pœq
(
d
, 
œq
);

1687 
	`´štk
("%u:%3d(%c%c%c%c)",

1688 
d
->
domaš_id
, 
pœq
,

1689 (
	`‹¡_b™
(
d
->
pœq_to_evtchn
[
pœq
],

1690 &
	`sh¬ed_šfo
(
d
, 
evtchn_³ndšg
)) ?

1692 (
	`‹¡_b™
(
d
->
pœq_to_evtchn
[
pœq
] /

1693 
	`BITS_PER_EVTCHN_WORD
(
d
),

1694 &
	`vıu_šfo
(
d
->
vıu
[0], 
evtchn_³ndšg_£l
)) ?

1696 (
	`‹¡_b™
(
d
->
pœq_to_evtchn
[
pœq
],

1697 &
	`sh¬ed_šfo
(
d
, 
evtchn_mask
)) ?

1699 (
	`‹¡_b™
(
pœq
, 
d
->
pœq_mask
) ?

1701 iàĞ
i
 !ğ
aùiÚ
->
Ä_gue¡s
 )

1702 
	`´štk
(",");

1705 
	`´štk
("\n");

1708 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1711 
	`dump_ißpic_œq_šfo
();

1712 
	}
}

1714 
keyhªdËr
 
	gdump_œqs_keyhªdËr
 = {

1715 .
dŸgno¡ic
 = 1,

1716 .
	gu
.
	gâ
 = 
dump_œqs
,

1717 .
	gdesc
 = "dump interrupt bindings"

1720 
__š™
 
	$£tup_dump_œqs
()

1722 
	`»gi¡”_keyhªdËr
('i', &
dump_œqs_keyhªdËr
);

1724 
	}
}

1725 
__š™ÿÎ
(
£tup_dump_œqs
);

1728 
	$fixup_œqs
()

1730 
œq
, 
¥
;

1731 
w¬Ãd
;

1732 
œq_desc
 *
desc
;

1733 
œq_gue¡_aùiÚ_t
 *
aùiÚ
;

1734 
³ndšg_eoi
 *
³oi
;

1736  
œq
 = 0; irq < 
Ä_œqs
; irq++ )

1738 
b»ak_affš™y
 = 0;

1739 
£t_affš™y
 = 1;

1740 
ıumask_t
 
affš™y
;

1742 iàĞ
œq
 == 2 )

1745 
desc
 = 
	`œq_to_desc
(
œq
);

1747 
	`¥š_lock
(&
desc
->
lock
);

1749 
affš™y
 = 
desc
->affinity;

1750 iàĞ!
desc
->
aùiÚ
 || 
	`ıus_sub£t
(
affš™y
, 
ıu_Úlše_m­
) )

1752 
	`¥š_uÆock
(&
desc
->
lock
);

1756 
	`ıus_ªd
(
affš™y
,‡ffš™y, 
ıu_Úlše_m­
);

1757 iàĞ
	`ıus_em±y
(
affš™y
) )

1759 
b»ak_affš™y
 = 1;

1760 
affš™y
 = 
ıu_Úlše_m­
;

1763 iàĞ
desc
->
hªdËr
->
di§bË
 )

1764 
desc
->
hªdËr
->
	`di§bË
(
œq
);

1766 iàĞ
desc
->
hªdËr
->
£t_affš™y
 )

1767 
desc
->
hªdËr
->
	`£t_affš™y
(
œq
, 
affš™y
);

1768 iàĞ!(
w¬Ãd
++) )

1769 
£t_affš™y
 = 0;

1771 iàĞ
desc
->
hªdËr
->
’abË
 )

1772 
desc
->
hªdËr
->
	`’abË
(
œq
);

1774 
	`¥š_uÆock
(&
desc
->
lock
);

1776 iàĞ
b»ak_affš™y
 && 
£t_affš™y
 )

1777 
	`´štk
("Brokaffš™y fÜ irq %i\n", 
œq
);

1778 iàĞ!
£t_affš™y
 )

1779 
	`´štk
("CªnÙ s‘‡ffš™y fÜ irq %i\n", 
œq
);

1783 
	`loÿl_œq_’abË
();

1784 
	`md–ay
(1);

1785 
	`loÿl_œq_di§bË
();

1788  
œq
 = 0; irq < 
Ä_œqs
; irq++ )

1790 
desc
 = 
	`œq_to_desc
(
œq
);

1791 iàĞ!(
desc
->
¡©us
 & 
IRQ_GUEST
) )

1793 
aùiÚ
 = (
œq_gue¡_aùiÚ_t
 *)
desc
->action;

1794 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
aùiÚ
->
ıu_eoi_m­
);

1798 
³oi
 = 
	`this_ıu
(
³ndšg_eoi
);

1799  
¥
 = 0; s°< 
	`³ndšg_eoi_¥
(
³oi
); sp++ )

1800 
³oi
[
¥
].
»ady
 = 1;

1801 
	`æush_»ady_eoi
();

1802 
	}
}

1804 
	$m­_domaš_emuœq_pœq
(
domaš
 *
d
, 
pœq
, 
emuœq
)

1806 
Şd_emuœq
 = 
IRQ_UNBOUND
, 
Şd_pœq
 = IRQ_UNBOUND;

1808 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1810 iàĞ!
	`is_hvm_domaš
(
d
) )

1811  -
EINVAL
;

1813 iàĞ
pœq
 < 0 ||…œq >ğ
d
->
Ä_pœqs
 ||

1814 
emuœq
 =ğ
IRQ_UNBOUND
 ||ƒmuœq >ğ(è
Ä_œqs
 )

1816 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: invalid…irq %d orƒmuirq %d\n",

1817 
d
->
domaš_id
, 
pœq
, 
emuœq
);

1818  -
EINVAL
;

1821 
Şd_emuœq
 = 
	`domaš_pœq_to_emuœq
(
d
, 
pœq
);

1822 iàĞ
emuœq
 !ğ
IRQ_PT
 )

1823 
Şd_pœq
 = 
	`domaš_emuœq_to_pœq
(
d
, 
emuœq
);

1825 iàĞ(
Şd_emuœq
 !ğ
IRQ_UNBOUND
 && (Şd_emuœq !ğ
emuœq
) ) ||

1826 (
Şd_pœq
 !ğ
IRQ_UNBOUND
 && (Şd_pœq !ğ
pœq
)) )

1828 
	`d´štk
(
XENLOG_G_WARNING
, "dom%d:…irq %d orƒmuirq %d‡lready mapped\n",

1829 
d
->
domaš_id
, 
pœq
, 
emuœq
);

1833 
d
->
¬ch
.
pœq_emuœq
[
pœq
] = 
emuœq
;

1835 iàĞ
emuœq
 !ğ
IRQ_PT
 )

1836 
d
->
¬ch
.
emuœq_pœq
[
emuœq
] = 
pœq
;

1839 
	}
}

1841 
	$unm­_domaš_pœq_emuœq
(
domaš
 *
d
, 
pœq
)

1843 
emuœq
, 
»t
 = 0;

1845 iàĞ!
	`is_hvm_domaš
(
d
) )

1846  -
EINVAL
;

1848 iàĞ(
pœq
 < 0è|| (pœq >ğ
d
->
Ä_pœqs
) )

1849  -
EINVAL
;

1851 
	`ASSERT
(
	`¥š_is_locked
(&
d
->
ev’t_lock
));

1853 
emuœq
 = 
	`domaš_pœq_to_emuœq
(
d
, 
pœq
);

1854 iàĞ
emuœq
 =ğ
IRQ_UNBOUND
 )

1856 
	`d´štk
(
XENLOG_G_ERR
, "dom%d:…irq %d‚ot mapped\n",

1857 
d
->
domaš_id
, 
pœq
);

1858 
»t
 = -
EINVAL
;

1859 
dÚe
;

1862 
d
->
¬ch
.
pœq_emuœq
[
pœq
] = 
IRQ_UNBOUND
;

1863 iàĞ
emuœq
 !ğ
IRQ_PT
 )

1864 
d
->
¬ch
.
emuœq_pœq
[
emuœq
] = 
IRQ_UNBOUND
;

1866 
dÚe
:

1867  
»t
;

1868 
	}
}

1870 
	$hvm_domaš_u£_pœq
(
domaš
 *
d
, 
pœq
)

1872 
emuœq
;

1874 iàĞ!
	`is_hvm_domaš
(
d
è|| 
pœq
 < 0 )

1877 
emuœq
 = 
	`domaš_pœq_to_emuœq
(
d
, 
pœq
);

1878 iàĞ
emuœq
 !ğ
IRQ_UNBOUND
 && 
d
->
pœq_to_evtchn
[
pœq
] != 0 )

1882 
	}
}

	@machine_kexec.c

9 
	~<x’/lib.h
>

10 
	~<asm/œq.h
>

11 
	~<asm/·ge.h
>

12 
	~<asm/æushb.h
>

13 
	~<x’/smp.h
>

14 
	~<x’/nmi.h
>

15 
	~<x’/ty³s.h
>

16 
	~<x’/cÚsŞe.h
>

17 
	~<x’/kexec.h
>

18 
	~<x’/domaš_·ge.h
>

19 
	~<asm/fixm­.h
>

20 
	~<asm/hvm/hvm.h
>

21 
	~<asm/h³t.h
>

23 (*
	t»loÿ‹_Ãw_k”Ãl_t
)(

24 
	tšdœeùiÚ_·ge
,

25 *
	t·ge_li¡
,

26 
	t¡¬t_add»ss
,

27 #ifdeà
	t__i386__


28 
	tıu_has_·e
,

30 
	t´e£rve_cÚ‹xt
);

32 
	`machše_kexec_g‘_x’
(
x’_kexec_¿nge_t
 *
¿nge
);

35 
	$machše_kexec_lßd
(
ty³
, 
¦Ù
, 
x’_kexec_image_t
 *
image
)

37 
´ev_ma
 = 0;

38 
fix_ba£
 = 
FIX_KEXEC_BASE_0
 + (
¦Ù
 * (
KEXEC_XEN_NO_PAGES
 >> 1));

39 
k
;

45  
k
 = 0; k < 
KEXEC_XEN_NO_PAGES
; k++ )

47 iàĞ(
k
 & 1) == 0 )

50 
´ev_ma
 = 
image
->
·ge_li¡
[
k
];

55 iàĞ
	`is_pv_32Ú64_domaš
(
dom0
) )

67 
image
->
·ge_li¡
[
k
] = 
´ev_ma
;

71 
	`£t_fixm­
(
fix_ba£
 + (
k
 >> 1), 
´ev_ma
);

72 
image
->
·ge_li¡
[
k
] = 
	`fix_to_vœt
(
fix_ba£
 + (k >> 1));

78 
	}
}

80 
	$machše_kexec_uÆßd
(
ty³
, 
¦Ù
, 
x’_kexec_image_t
 *
image
)

82 
	}
}

84 
	$machše_»boÙ_kexec
(
x’_kexec_image_t
 *
image
)

86 
	`BUG_ON
(
	`smp_´oûssÜ_id
() != 0);

87 
	`smp_£nd_¡İ
();

88 
	`machše_kexec
(
image
);

89 
	`BUG
();

90 
	}
}

92 
	$machše_kexec
(
x’_kexec_image_t
 *
image
)

94 
desc_±r
 
gdt_desc
 = {

95 .
ba£
 = ()(
boÙ_ıu_gdt_bË
 - 
FIRST_RESERVED_GDT_ENTRY
),

96 .
lim™
 = 
LAST_RESERVED_GDT_BYTE


99 iàĞ
	`h³t_brßdÿ¡_is_avaabË
() )

100 
	`h³t_di§bË_Ëgacy_brßdÿ¡
();

107 
asm
 vŞ©Ğ"lgdˆ%0" : : "m" (
gdt_desc
) );

109 #ifdeà
CONFIG_COMPAT


110 iàĞ
	`is_pv_32Ú64_domaš
(
dom0
) )

112 
	`com·t_machše_kexec
(
ºk
,

113 
šdœeùiÚ_·ge
,

114 *
·ge_li¡
,

115 
¡¬t_add»ss
);

116 
	`com·t_machše_kexec
(
image
->
·ge_li¡
[1],

117 
image
->
šdœeùiÚ_·ge
,

118 
image
->
·ge_li¡
,

119 
image
->
¡¬t_add»ss
);

124 
»loÿ‹_Ãw_k”Ãl_t
 
ºk
;

126 
ºk
 = (
»loÿ‹_Ãw_k”Ãl_t
è
image
->
·ge_li¡
[1];

127 (*
ºk
)(
image
->
šdœeùiÚ_·ge
, image->
·ge_li¡
,

128 
image
->
¡¬t_add»ss
,

129 #ifdeà
__i386__


134 
	}
}

136 
	$machše_kexec_g‘
(
x’_kexec_¿nge_t
 *
¿nge
)

138 ià(
¿nge
->¿ng!ğ
KEXEC_RANGE_MA_XEN
)

139  -
EINVAL
;

140  
	`machše_kexec_g‘_x’
(
¿nge
);

141 
	}
}

143 
	$¬ch_üash_§ve_vmcÜešfo
()

145 
	`VMCOREINFO_SYMBOL
(
dom_x’
);

146 
	`VMCOREINFO_SYMBOL
(
dom_io
);

148 #ifdeà
CONFIG_X86_32


149 
	`VMCOREINFO_SYMBOL
(
x’h—p_phys_’d
);

151 #ifdeà
CONFIG_X86_PAE


152 
	`VMCOREINFO_SYMBOL_ALIAS
(
pgd_l3
, 
idË_pg_bË
);

154 #ifdeà
CONFIG_X86_64


155 
	`VMCOREINFO_SYMBOL_ALIAS
(
pgd_l4
, 
idË_pg_bË
);

157 
	}
}

	@mark_vregion.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_MARK_VREGION


26 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


27 
	gunm¬k_±_sucûss
;

28 
	gunm¬k_±_nÙfound
;

34 
	$l1e_m¬k
(
l1_pg’Œy_t
 *
l1t
, 
i
, 
·ge_bË
 *
±
, 
±šdex
)

36 
v®ue
;

37 
mâ
;

39 #ifdeà
DEBUG_ASSERT


40 ià(!(
	`l1e_g‘_æags
(
l1t
[
i
]è& 
_PAGE_PRESENT
)è
	`my·nic
("l1e_mark: Nonpresent!");

41 ià(!
	`this_ıu
(
locked_±
))

42 
	`my·nic
("lock_pt before†1e_mark!");

43 ià(!
	`¥š_is_locked
((
¥šlock_t
 *)
	`this_ıu
(
locked_±
)))

44 
	`my·nic
("huh†1e_mark!");

47 #ifdeà
ENABLE_BITMAP_VRT


48 #ifdeà
DEBUG_WARN


50 
j
;

51 
	`my¥š_lock_±
(
±
, 107);

52 
j
=0;j<
MAX_CACHE
;j++) {

53 ià(
	`‹¡_b™m­
(
±
, 
±šdex
, 
j
))

54 
	`my´štk
("BUG!est_bitmap()=true??");

56 
	`¥š_uÆock_±
(
±
, 107);

61 
v»giÚ_t
 *
vr
;

62 #ifdeà
ENABLE_VREGIONS


64 
mâ
 = 
	`l1e_g‘_pâ
(
l1t
[
i
]);

65 
vr
 = 
	`v¹_g‘
(
mâ
, 
VR_REFCNT_RMAP
, 0);

67 #ifdeà
ENABLE_RANGE


69 
v»giÚ_t
 *
vr2
, *
Şd
;

70 
·ge_dœ
 *
pgd
 = 
	`g‘_pgd
(
±
);

71 
vâ
 = (
	`g‘_va
(
±
, 
±šdex
) >> 12U);

72 ià(
vr2
 = 
	`check_¿nge
(
pgd
, 
vâ
)) {

73 
	`¥š_uÆock
(&
vr
->
lock
);

74 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

76 ià(
vr2
->
äame_couÁ
 >ğ
MAX_PAGES_IN_VREGION
) {

77 
	`my´štk
("TODO..¿ng»giÚ fuÎ..vâ:0x%x vr:0x%x\n", 
vâ
, 
vr2
);

78 
	`my·nic
("range„egion full");

80 ià(!
	`‹¡_b™
(
VR_POOL
, &
vr
->
æags
)) {

81 
	`my·nic
("TODO:...non-pool &„ange\n");

84 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
, 
VRT_SET_RETURN_OLD
|
VRT_SET_LOCK_SYNC
|
VRT_SET_SKIP_UNLOCK_VR2
);

85 
	`MYASSERT
(
Şd
 =ğ
vr
);

86 ià(
Şd
)

87 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

88 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

93 #ifdeà
ENABLE_RMAP


94 ià(!
vr
) {

95 
	`my´štk
("mâ %x, chaš [%d,%d],ry‡gaš.\n", 
mâ
, 
	`FTABLE_NEXT
(mâ), 
	`FTABLE_PREV
(mfn));

96 
	`my·nic
("NULL vr !\n");

98 ià(
	`FTABLE_NEXT
(
mâ
è=ğ-1 || 
	`FTABLE_PREV
(mfn) == -1) {

99 
	`my´štk
("mâ %x, chaš [%d,%d],ry‡gaš.\n", 
mâ
, 
	`FTABLE_NEXT
(mâ), 
	`FTABLE_PREV
(mfn));

100 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

101 
	`¥š_uÆock
(&
vr
->
lock
);

102 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 2);

103 
vr
 = 
NULL
;

104 
	`my·nic
("should've had mfn..\n");

108 
rm­i
 = (
	`l1e_g‘_æags
(
l1t
[
i
])&
_PAGE_GUEST_KERNEL
è? 
RMAPS_KERNEL
 : 
RMAPS_USER
 ;

110 #ifdeà
ENABLE_KERNEL_SHADOW


111 ià(
	`g‘_va
(
±
, 
±šdex
è>ğ
USERLAND_END
) {

112 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_KERNEL
);

114 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_USER
);

116 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_USER
);

120 #ifdeà
ENABLE_VR_USER


121 ià(
rm­i
 =ğ
RMAPS_USER
 && 
	`‹¡_b™
(
VR_KERNEL
, &
vr
->
æags
)) {

122 
rm­s_butš
 *
r
;

123 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

124 ià(
r
->
rm­_couÁ
 == 0) {

125 
	`¥š_uÆock
(&
vr
->
lock
);

126 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

128 
v»giÚ_t
 *
vr2
, *
Şd
;

129 
vr2
 = 
	`g‘_£ed_u£r
();

130 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
,
VRT_RETURN_OLD
|
VRT_SET_LOCK_SYNC
|
VRT_SET_SKIP_UNLOCK_VR2
);

131 
	`MYASSERT
(
Şd
 =ğ
vr
);

132 ià(
Şd
)

133 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

134 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

135 
vr
 = 
vr2
;

139 #ifdeà
ENABLE_VR_KERNEL


140 ià(
rm­i
 =ğ
RMAPS_KERNEL
 && 
	`‹¡_b™
(
VR_XEN
, &
vr
->
æags
)) {

141 
rm­s_butš
 *
r
;

142 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

143 ià(
r
->
rm­_couÁ
 == 0) {

144 
	`¥š_uÆock
(&
vr
->
lock
);

145 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

147 
v»giÚ_t
 *
vr2
, *
Şd
;

148 
vr2
 = 
	`g‘_£ed_k”Ãl
();

149 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
,
VRT_SET_RETURN_OLD
|
VRT_SET_LOCK_SYNC
|
VRT_SET_SKIP_UNLOCK_VR2
);

150 
	`MYASSERT
(
Şd
 =ğ
vr
);

151 ià(
Şd
)

152 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

153 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

154 
vr
 = 
vr2
;

159 
	`add_rm­
(
vr
, 
±
, 
±šdex
, 
mâ
, 
rm­i
);

161 
b™m­
 = 
vr
->
æags
;

162 
	`¥š_uÆock
(&
vr
->
lock
);

165 #ifdeà
ENABLE_PER_CACHE_PT


166 
	`add_shadow
(
±
, 
±šdex
, 
	`l1e_g‘_š‹
(
l1t
[
i
]), 
b™m­
, !!
	`‹¡_b™
(
VR_NO_REGIONING
, &
vr
->
æags
)

167 #ifdeà
ENABLE_REGIONING_NOKERNEL


168 || 
rm­i
 =ğ
RMAPS_KERNEL


172 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

173 
pcouÁ
[
COUNT_L1E_MARK
]++;

174 
	}
}

176 
	$l1e_unm¬k
(
l1_pg’Œy_t
 *
l1t
, 
i
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

178 
m¬k
;

180 #ifdeà
DEBUG_ASSERT


181 ià(!
	`this_ıu
(
locked_±
))

182 
	`my·nic
("lock_pt before†1e_unmark!");

183 ià(!
	`¥š_is_locked
((
¥šlock_t
 *)
	`this_ıu
(
locked_±
)))

184 
	`my·nic
("huh†1e_unmark!");

188 
l1_pg’Œy_t
 *
l1t
;

189 
j
;

190 
j
=0;j<
MAX_CACHE
;j++) {

191 
l1t
 = 
±
->
shadow
[
j
];

193 ià(
	`l1e_is_şo£d
(
l1t
[
i
])) {

194 
	`my´štk
("unmarking closed†1e..opening it.\n");

196 
	`l1e_İ’
(
l1t
, 
i
);

205 
l1_pg’Œy_t
 *
‹mp
 = 
±
->
shadow
[0];

206 
rm­i
 = (
	`l1e_g‘_æags
(
‹mp
[
±šdex
])&
_PAGE_GUEST_KERNEL
è? 
RMAPS_KERNEL
 : 
RMAPS_USER
 ;

208 #ifdeà
ENABLE_KERNEL_SHADOW


209 ià(
	`g‘_va
(
±
, 
±šdex
è>ğ
USERLAND_END
) {

210 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_KERNEL
);

212 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_USER
);

214 
	`MYASSERT
(
rm­i
 =ğ
RMAPS_USER
);

218 #ifdeà
ENABLE_RMAP


219 ià(
	`d–_rm­
(
±
, 
±šdex
, 
mâ
, 
rm­i
))

222 #ifdeà
ENABLE_PER_CACHE_PT


223 
	`d–_shadow
(
±
, 
±šdex
, 
mâ
);

225 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


226 
unm¬k_±_sucûss
++;

228 
pcouÁ
[
COUNT_L1E_UNMARK
]++;

231 ià(!
mši_aùiv©ed
)

233 #ifdeà
DEBUG_ASSERT


234 
	`my´štk
("[NOT!±mâ=%x,±i=%d,mâ=%x,vr=xx] \n", 
±
->
mâ
, 
±šdex
, mfn );

235 
	`´št_±
(
±
);

239 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


240 
unm¬k_±_nÙfound
++;

242 
	}
}

244 
	$unm¬k_±
(
·ge_bË
 *
±
)

246 
mymâ
;

247 
i
,
j
;

248 #ifdeà
DEBUG_WARN


249 
couÁ
=0;

251 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


252 
unm¬k_±_sucûss
 = 
unm¬k_±_nÙfound
 = 0;

253 
	`my´štk
("->unm¬k_±(%x)\n", 
±
->
mâ
);

255 
l1_pg’Œy_t
 
l1e
, *
l1t
;

256 
	`mâ_check
(
±
->
mâ
);

257 
	`MYASSERT
(
±
->
Ëv–
 == 1);

258 
l1t
 = 
	`m­_domaš_·ge
(
±
->
mâ
);

259 
j
=0;j<
L1_PAGETABLE_ENTRIES
;j++) {

260 ià(!(
	`l1e_g‘_æags
(
l1t
[
j
]è& 
_PAGE_PRESENT
)) {

264 
mymâ
 = 
	`l1e_g‘_pâ
(
l1t
[
j
]);

265 
	`mâ_check
(
mymâ
);

266 
	`l1e_unm¬k
(
l1t
, 
j
, 
±
, j , 
	`l1e_g‘_pâ
(l1t[j]));

267 #ifdeà
DEBUG_WARN


268 
couÁ
++;

271 
	`unm­_domaš_·ge
(
l1t
);

275 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


276 
	`my´štk
("couÁ:%d suc:%d‚Ùfound:%d„emaš_rm:%dÙ_rm_sh¬ed:%d\n",
couÁ
 ,
unm¬k_±_sucûss
 ,
unm¬k_±_nÙfound
 , 
	`check_±_rm­_sh¬ed
(
±
), 
	`tÙ®_rm­_sh¬ed
() );

279 
	}
}

281 
	$m¬k_±
(
·ge_bË
 *
±
)

283 
l1_pg’Œy_t
 
l1e
, *
l1t
;

284 
couÁ
 = 0, 
i
, 
j
;

286 
	`mâ_check
(
±
->
mâ
);

287 
	`MYASSERT
(
±
->
Ëv–
 == 1);

288 
l1t
 = 
	`m­_domaš_·ge
(
±
->
mâ
);

289 
j
=0;j<
L1_PAGETABLE_ENTRIES
;j++) {

290 ià(!(
	`l1e_g‘_æags
(
l1t
[
j
]è& 
_PAGE_PRESENT
))

292 
	`l1e_m¬k
(
l1t
, 
j
, 
±
, j);

293 
couÁ
++;

294 #ifdeà
VERBOSE_PAGE_TABLE_MARKING_L1E


295 
	`my´štk
("Æ1e:%x\n", 
l1t
[
j
].
l1
);

298 
	`unm­_domaš_·ge
(
l1t
);

299 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


300 
	`my´štk
("%d m¬ked fÜ %x[%d]%x.\n", 
couÁ
, 
±
->
up_±
->
mâ
,…t->
up_šdex
,…t->mfn);

303 
	}
}

306 
	$l1e_İ’
(
l1_pg’Œy_t
 *
l1t
, 
i
)

308 #ifdeà
ENABLE_PROTECTION_BIT


309 
b™
 = 2;

311 
b™
 = 0;

313 
	`MYASSERT
(
	`l1e_g‘_pâ
(
l1t
[
i
]));

315 ià(
	`‹¡_ªd_£t_b™
(
b™
, &
l1t
[
i
].
l1
))

316 
	`my·nic
("l1e_close:‡lready open ??‚ew_marking");

317 
	}
}

318 
	$l1e_şo£
(
l1_pg’Œy_t
 *
l1t
, 
i
)

320 #ifdeà
ENABLE_PROTECTION_BIT


321 
b™
 = 2;

323 
b™
 = 0;

325 
	`MYASSERT
(
	`l1e_g‘_pâ
(
l1t
[
i
]));

327 ià(!
	`‹¡_ªd_ş—r_b™
(
b™
, &
l1t
[
i
].
l1
))

328 
	`my·nic
("l1e_close:‡lready closed ??‚ew_marking");

329 
	}
}

	@microcode.c

24 
	~<x’/cÚfig.h
>

25 
	~<x’/lib.h
>

26 
	~<x’/k”Ãl.h
>

27 
	~<x’/š™.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/smp.h
>

30 
	~<x’/¥šlock.h
>

31 
	~<x’/gue¡_acûss.h
>

33 
	~<asm/cu¼’t.h
>

34 
	~<asm/m¤.h
>

35 
	~<asm/uacûss.h
>

36 
	~<asm/´oûssÜ.h
>

37 
	~<asm/miüocode.h
>

39 cÚ¡ 
miüocode_İs
 *
	gmiüocode_İs
;

41 
DEFINE_SPINLOCK
(
miüocode_mu‹x
);

43 
DEFINE_PER_CPU
(
ucode_ıu_šfo
, ucode_cpu_info);

45 
	smiüocode_šfo
 {

46 
	mıu
;

47 
ušt32_t
 
	mbufãr_size
;

48 
	m”rÜ
;

49 
	mbufãr
[1];

52 
	$__miüocode_fši_ıu
(
ıu
)

54 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

56 
	`xä“
(
uci
->
mc
.
mc_v®id
);

57 
	`mem£t
(
uci
, 0, (*uci));

58 
	}
}

60 
	$miüocode_fši_ıu
(
ıu
)

62 
	`¥š_lock
(&
miüocode_mu‹x
);

63 
	`__miüocode_fši_ıu
(
ıu
);

64 
	`¥š_uÆock
(&
miüocode_mu‹x
);

65 
	}
}

67 
	$miüocode_»sume_ıu
(
ıu
)

69 
”r
;

70 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

71 
ıu_sigÇtu»
 
nsig
;

73 iàĞ!
uci
->
mc
.
mc_v®id
 )

74  -
EIO
;

80 
”r
 = 
miüocode_İs
->
	`cŞËù_ıu_šfo
(
ıu
, &
nsig
);

81 iàĞ
”r
 )

83 
	`miüocode_fši_ıu
(
ıu
);

84  
”r
;

87 iàĞ
miüocode_İs
->
	`miüocode_»sume_m©ch
(
ıu
, &
nsig
) )

89  
miüocode_İs
->
	`­¶y_miüocode
(
ıu
);

93 
	`miüocode_fši_ıu
(
ıu
);

94  -
EIO
;

96 
	}
}

98 
	$miüocode_upd©e_ıu
(cÚ¡ *
buf
, 
size_t
 
size
)

100 
”r
;

101 
ıu
 = 
	`smp_´oûssÜ_id
();

102 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

104 
	`¥š_lock
(&
miüocode_mu‹x
);

106 
”r
 = 
miüocode_İs
->
	`cŞËù_ıu_šfo
(
ıu
, &
uci
->
ıu_sig
);

107 iàĞ
	`lik–y
(!
”r
) )

108 
”r
 = 
miüocode_İs
->
	`ıu_»que¡_miüocode
(
ıu
, 
buf
, 
size
);

110 
	`__miüocode_fši_ıu
(
ıu
);

112 
	`¥š_uÆock
(&
miüocode_mu‹x
);

114  
”r
;

115 
	}
}

117 
	$do_miüocode_upd©e
(*
_šfo
)

119 
miüocode_šfo
 *
šfo
 = 
_šfo
;

120 
”rÜ
;

122 
	`BUG_ON
(
šfo
->
ıu
 !ğ
	`smp_´oûssÜ_id
());

124 
”rÜ
 = 
	`miüocode_upd©e_ıu
(
šfo
->
bufãr
, info->
bufãr_size
);

125 iàĞ
”rÜ
 )

126 
šfo
->
”rÜ
 =ƒrror;

128 
šfo
->
ıu
 = 
	`Ãxt_ıu
(šfo->ıu, 
ıu_Úlše_m­
);

129 iàĞ
šfo
->
ıu
 < 
NR_CPUS
 )

130  
	`cÚtšue_hy³rÿÎ_Ú_ıu
(
šfo
->
ıu
, 
do_miüocode_upd©e
, info);

132 
”rÜ
 = 
šfo
->error;

133 
	`xä“
(
šfo
);

134  
”rÜ
;

135 
	}
}

137 
miüocode_upd©e
(
	$XEN_GUEST_HANDLE
(
cÚ¡_void
è
buf
, 
Ën
)

139 
»t
;

140 
miüocode_šfo
 *
šfo
;

142 iàĞ
Ën
 !ğ(
ušt32_t
)len )

143  -
E2BIG
;

145 iàĞ
miüocode_İs
 =ğ
NULL
 )

146  -
EINVAL
;

148 
šfo
 = 
	`xm®loc_by‹s
((*šfoè+ 
Ën
);

149 iàĞ
šfo
 =ğ
NULL
 )

150  -
ENOMEM
;

152 
»t
 = 
	`cİy_äom_gue¡
(
šfo
->
bufãr
, 
buf
, 
Ën
);

153 iàĞ
»t
 != 0 )

155 
	`xä“
(
šfo
);

156  
»t
;

159 
šfo
->
bufãr_size
 = 
Ën
;

160 
šfo
->
”rÜ
 = 0;

161 
šfo
->
ıu
 = 
	`fœ¡_ıu
(
ıu_Úlše_m­
);

163  
	`cÚtšue_hy³rÿÎ_Ú_ıu
(
šfo
->
ıu
, 
do_miüocode_upd©e
, info);

164 
	}
}

	@microcode_amd.c

17 
	~<x’/cÚfig.h
>

18 
	~<x’/lib.h
>

19 
	~<x’/k”Ãl.h
>

20 
	~<x’/š™.h
>

21 
	~<x’/sched.h
>

22 
	~<x’/smp.h
>

23 
	~<x’/¥šlock.h
>

25 
	~<asm/m¤.h
>

26 
	~<asm/uacûss.h
>

27 
	~<asm/´oûssÜ.h
>

28 
	~<asm/miüocode.h
>

30 
	#´_debug
(
x
...è(()0)

	)

32 
	#UCODE_MAGIC
 0x00414d44

	)

33 
	#UCODE_EQUIV_CPU_TABLE_TYPE
 0x00000000

	)

34 
	#UCODE_UCODE_TYPE
 0x00000001

	)

36 
	#UCODE_MAX_SIZE
 (2048)

	)

37 
	#DEFAULT_UCODE_DATASIZE
 (896)

	)

38 
	#MC_HEADER_SIZE
 ((
miüocode_h—d”_amd
))

	)

39 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

40 
	#DWSIZE
 ((
ušt32_t
))

	)

43 
DEFINE_SPINLOCK
(
miüocode_upd©e_lock
);

45 
equiv_ıu_’Œy
 *
	gequiv_ıu_bË
;

47 
	$cŞËù_ıu_šfo
(
ıu
, 
ıu_sigÇtu»
 *
csig
)

49 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
ıu
];

51 
	`mem£t
(
csig
, 0, (*csig));

53 iàĞ(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
è|| (c->
x86
 < 0x10) )

55 
	`´štk
(
KERN_ERR
 "microcode: CPU%d‚ot‡ capable AMD…rocessor\n",

56 
ıu
);

57  -
EINVAL
;

60 
	`rdm¤l
(
MSR_AMD_PATCHLEVEL
, 
csig
->
»v
);

62 
	`´štk
(
KERN_INFO
 "microcode: collect_cpu_info:…atch_id=0x%x\n",

63 
csig
->
»v
);

66 
	}
}

68 
	$miüocode_f™s
(*
mc
, 
ıu
)

70 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

71 
miüocode_h—d”_amd
 *
mc_h—d”
 = 
mc
;

72 
cu¼’t_ıu_id
;

73 
equiv_ıu_id
 = 0x0;

74 
i
;

77 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

79 iàĞ
equiv_ıu_bË
 =ğ
NULL
 )

81 
	`´štk
(
KERN_INFO
 "microcode: CPU%d microcode update with "

83 
ıu
, 
mc_h—d”
->
·tch_id
, 
uci
->
ıu_sig
.
»v
);

84 
out
;

87 
cu¼’t_ıu_id
 = 
	`ıuid_—x
(0x00000001);

89  
i
 = 0; 
equiv_ıu_bË
[i].
š¡®Ëd_ıu
 != 0; i++ )

91 iàĞ
cu¼’t_ıu_id
 =ğ
equiv_ıu_bË
[
i
].
š¡®Ëd_ıu
 )

93 
equiv_ıu_id
 = 
equiv_ıu_bË
[
i
].
equiv_ıu
 & 0xffff;

98 iàĞ!
equiv_ıu_id
 )

100 
	`´štk
(
KERN_ERR
 "microcode: CPU%d cpu_id "

101 "nÙ found iÀequiv®’ˆıuabË\n", 
ıu
);

102  -
EINVAL
;

105 iàĞ(
mc_h—d”
->
´oûssÜ_»v_id
è!ğ
equiv_ıu_id
 )

107 
	`´štk
(
KERN_INFO
 "microcode: CPU%d…atch does‚ot match "

109 
ıu
, 
mc_h—d”
->
´oûssÜ_»v_id
, 
equiv_ıu_id
);

110  -
EINVAL
;

113 iàĞ
mc_h—d”
->
·tch_id
 <ğ
uci
->
ıu_sig
.
»v
 )

114  -
EINVAL
;

116 
	`´štk
(
KERN_INFO
 "microcode: CPU%d found‡ matching microcode "

118 
ıu
, 
mc_h—d”
->
·tch_id
, 
uci
->
ıu_sig
.
»v
);

120 
out
:

122 
	}
}

124 
	$­¶y_miüocode
(
ıu
)

126 
æags
;

127 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

128 
ušt32_t
 
»v
;

129 
miüocode_amd
 *
mc_amd
 = 
uci
->
mc
.mc_amd;

132 
	`BUG_ON
(
	`¿w_smp_´oûssÜ_id
(è!ğ
ıu
);

134 iàĞ
mc_amd
 =ğ
NULL
 )

135  -
EINVAL
;

137 
	`¥š_lock_œq§ve
(&
miüocode_upd©e_lock
, 
æags
);

139 
	`wrm¤l
(
MSR_AMD_PATCHLOADER
, ()&
mc_amd
->
hdr
.
d©a_code
);

142 
	`rdm¤l
(
MSR_AMD_PATCHLEVEL
, 
»v
);

144 
	`¥š_uÆock_œq»¡Üe
(&
miüocode_upd©e_lock
, 
æags
);

147 iàĞ
»v
 !ğ
mc_amd
->
hdr
.
·tch_id
 )

149 
	`´štk
(
KERN_ERR
 "microcode: CPU%d update from„evision "

150 "0x%xØ0x%x faed\n", 
ıu
,

151 
mc_amd
->
hdr
.
·tch_id
, 
»v
);

152  -
EIO
;

155 
	`´štk
("microcode: CPU%d updated from„evision "

157 
ıu
, 
uci
->
ıu_sig
.
»v
, 
mc_amd
->
hdr
.
·tch_id
);

159 
uci
->
ıu_sig
.
»v
 =„ev;

162 
	}
}

164 
	$g‘_Ãxt_ucode_äom_bufãr_amd
(*
mc
, cÚ¡ *
buf
,

165 
size_t
 
size
, *
off£t
)

167 
miüocode_h—d”_amd
 *
mc_h—d”
;

168 
size_t
 
tÙ®_size
;

169 cÚ¡ 
ušt8_t
 *
buå
 = 
buf
;

170 
off
;

172 
off
 = *
off£t
;

175 iàĞ
off
 >ğ
size
 )

178 iàĞ
buå
[
off
] !ğ
UCODE_UCODE_TYPE
 )

180 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

182  -
EINVAL
;

185 
mc_h—d”
 = (
miüocode_h—d”_amd
 *)(&
buå
[
off
+8]);

187 
tÙ®_size
 = (è(
buå
[
off
+4] + (bufp[off+5] << 8));

189 
	`´štk
(
KERN_INFO
 "microcode: size %lu,otal_size %lu, offset %ld\n",

190 ()
size
, 
tÙ®_size
, 
off
);

192 iàĞ(
off
 + 
tÙ®_size
è> 
size
 )

194 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! Bad data in microcode data file\n");

195  -
EINVAL
;

198 
	`mem£t
(
mc
, 0, 
UCODE_MAX_SIZE
);

199 
	`memıy
(
mc
, (cÚ¡ *)(&
buå
[
off
 + 8]), 
tÙ®_size
);

201 *
off£t
 = 
off
 + 
tÙ®_size
 + 8;

204 
	}
}

206 
	$š¡®l_equiv_ıu_bË
(cÚ¡ *
buf
, 
ušt32_t
 
size
,

207 *
off£t
)

209 cÚ¡ 
ušt32_t
 *
buf_pos
 = 
buf
;

210 
off
;

212 
off
 = *
off£t
;

213 *
off£t
 = 0;

216 iàĞ
off
 >ğ
size
 )

217  -
EINVAL
;

219 iàĞ
buf_pos
[1] !ğ
UCODE_EQUIV_CPU_TABLE_TYPE
 )

221 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

223  -
EINVAL
;

226 iàĞ
size
 == 0 )

228 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

230  -
EINVAL
;

233 
equiv_ıu_bË
 = 
	`xm®loc_by‹s
(
size
);

234 iàĞ
equiv_ıu_bË
 =ğ
NULL
 )

236 
	`´štk
(
KERN_ERR
 "microcode:ƒrror, can't‡llocate "

238  -
ENOMEM
;

241 
	`mem£t
(
equiv_ıu_bË
, 0, 
size
);

242 
	`memıy
(
equiv_ıu_bË
, (cÚ¡ *)&
buf_pos
[3], 
size
);

244 *
off£t
 = 
size
 + 12;

247 
	}
}

249 
	$ıu_»que¡_miüocode
(
ıu
, cÚ¡ *
buf
, 
size_t
 
size
)

251 cÚ¡ 
ušt32_t
 *
buf_pos
;

252 
off£t
 = 0;

253 
”rÜ
 = 0;

254 
»t
;

255 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

256 *
mc
;

259 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

261 
buf_pos
 = (cÚ¡ 
ušt32_t
 *)
buf
;

263 iàĞ
buf_pos
[0] !ğ
UCODE_MAGIC
 )

265 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! Wrong "

267  -
EINVAL
;

270 
”rÜ
 = 
	`š¡®l_equiv_ıu_bË
(
buf
, (
ušt32_t
)(
buf_pos
[2]), &
off£t
);

271 iàĞ
”rÜ
 )

273 
	`´štk
(
KERN_ERR
 "microcode: installingƒquivalent cpuable failed\n");

274  -
EINVAL
;

277 
mc
 = 
	`xm®loc_by‹s
(
UCODE_MAX_SIZE
);

278 iàĞ
mc
 =ğ
NULL
 )

280 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

282 
”rÜ
 = -
ENOMEM
;

283 
out
;

287 
uci
->
mc
.
mc_amd
 = mc;

293  (
»t
 = 
	`g‘_Ãxt_ucode_äom_bufãr_amd
(
mc
, 
buf
, 
size
, &
off£t
)) == 0)

295 
”rÜ
 = 
	`miüocode_f™s
(
mc
, 
ıu
);

296 ià(
”rÜ
 != 0)

299 
”rÜ
 = 
	`­¶y_miüocode
(
ıu
);

300 ià(
”rÜ
 == 0)

307 ià(
”rÜ
) {

308 
	`xä“
(
mc
);

309 
mc
 = 
NULL
;

311 
uci
->
mc
.
mc_amd
 = mc;

313 
out
:

314 
	`xä“
(
equiv_ıu_bË
);

315 
equiv_ıu_bË
 = 
NULL
;

317  
”rÜ
;

318 
	}
}

320 
	$miüocode_»sume_m©ch
(
ıu
, 
ıu_sigÇtu»
 *
nsig
)

323 
	}
}

325 cÚ¡ 
miüocode_İs
 
	gmiüocode_amd_İs
 = {

326 .
miüocode_»sume_m©ch
 = microcode_resume_match,

327 .
	gıu_»que¡_miüocode
 = 
ıu_»que¡_miüocode
,

328 .
	gcŞËù_ıu_šfo
 = 
cŞËù_ıu_šfo
,

329 .
	g­¶y_miüocode
 = 
­¶y_miüocode
,

332 
__š™
 
	$miüocode_š™_amd
()

334 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
 )

335 
miüocode_İs
 = &
miüocode_amd_İs
;

337 
	}
}

338 
__š™ÿÎ
(
miüocode_š™_amd
);

	@microcode_intel.c

24 
	~<x’/cÚfig.h
>

25 
	~<x’/lib.h
>

26 
	~<x’/k”Ãl.h
>

27 
	~<x’/š™.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/smp.h
>

30 
	~<x’/¥šlock.h
>

32 
	~<asm/m¤.h
>

33 
	~<asm/uacûss.h
>

34 
	~<asm/´oûssÜ.h
>

35 
	~<asm/miüocode.h
>

37 
	#´_debug
(
x
...è(()0)

	)

39 
	#DEFAULT_UCODE_DATASIZE
 (2000)

	)

40 
	#MC_HEADER_SIZE
 ((
miüocode_h—d”_š‹l
))

	)

41 
	#DEFAULT_UCODE_TOTALSIZE
 (
DEFAULT_UCODE_DATASIZE
 + 
MC_HEADER_SIZE
)

	)

42 
	#EXT_HEADER_SIZE
 ((
ex‹nded_sigbË
))

	)

43 
	#EXT_SIGNATURE_SIZE
 ((
ex‹nded_sigÇtu»
))

	)

44 
	#DWSIZE
 ((
u32
))

	)

45 
	#g‘_tÙ®size
(
mc
) \

46 (((
miüocode_š‹l
 *)
mc
)->
hdr
.
tÙ®size
 ? \

47 ((
miüocode_š‹l
 *)
mc
)->
hdr
.
tÙ®size
 : \

48 
DEFAULT_UCODE_TOTALSIZE
)

	)

50 
	#g‘_d©asize
(
mc
) \

51 (((
miüocode_š‹l
 *)
mc
)->
hdr
.
d©asize
 ? \

52 ((
miüocode_š‹l
 *)
mc
)->
hdr
.
d©asize
 : 
DEFAULT_UCODE_DATASIZE
)

	)

54 
	#sigm©ch
(
s1
, 
s2
, 
p1
, 
p2
) \

55 (((
s1
è=ğ(
s2
)è&& (((
p1
è& (
p2
)è|| ((Õ1è=ğ0è&& (Õ2è=ğ0))))

	)

57 
	#ex‰abË_size
(
‘
è(Ót)->
couÁ
 * 
EXT_SIGNATURE_SIZE
 + 
EXT_HEADER_SIZE
)

	)

60 
DEFINE_SPINLOCK
(
miüocode_upd©e_lock
);

62 
	$cŞËù_ıu_šfo
(
ıu_num
, 
ıu_sigÇtu»
 *
csig
)

64 
ıušfo_x86
 *
c
 = &
ıu_d©a
[
ıu_num
];

65 
ušt64_t
 
m¤_cÚ‹Á
;

67 
	`BUG_ON
(
ıu_num
 !ğ
	`smp_´oûssÜ_id
());

69 
	`mem£t
(
csig
, 0, (*csig));

71 iàĞ(
c
->
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
è|| (c->
x86
 < 6) ||

72 
	`ıu_has
(
c
, 
X86_FEATURE_IA64
) )

74 
	`´štk
(
KERN_ERR
 "microcode: CPU%d‚ot‡ capable Intel "

75 "´oûssÜ\n", 
ıu_num
);

79 
csig
->
sig
 = 
	`ıuid_—x
(0x00000001);

81 iàĞ(
c
->
x86_mod–
 >ğ5è|| (c->
x86
 > 6) )

84 
	`rdm¤l
(
MSR_IA32_PLATFORM_ID
, 
m¤_cÚ‹Á
);

85 
csig
->
pf
 = 1 << ((
m¤_cÚ‹Á
 >> 50) & 7);

88 
	`wrm¤l
(
MSR_IA32_UCODE_REV
, 0x0ULL);

90 
	`sync_cÜe
();

92 
	`rdm¤l
(
MSR_IA32_UCODE_REV
, 
m¤_cÚ‹Á
);

93 
csig
->
»v
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

94 
	`´_debug
("microcode: collect_cpu_info : sig=0x%x,…f=0x%x,„ev=0x%x\n",

95 
csig
->
sig
, csig->
pf
, csig->
»v
);

98 
	}
}

100 
šlše
 
	$miüocode_upd©e_m©ch
(

101 
ıu_num
, 
miüocode_h—d”_š‹l
 *
mc_h—d”
, 
sig
, 
pf
)

103 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu_num
);

105  (
	`sigm©ch
(
sig
, 
uci
->
ıu_sig
.sig, 
pf
, uci->cpu_sig.pf) &&

106 (
mc_h—d”
->
»v
 > 
uci
->
ıu_sig
.rev));

107 
	}
}

109 
	$miüocode_§n™y_check
(*
mc
)

111 
miüocode_h—d”_š‹l
 *
mc_h—d”
 = 
mc
;

112 
ex‹nded_sigbË
 *
ext_h—d”
 = 
NULL
;

113 
ex‹nded_sigÇtu»
 *
ext_sig
;

114 
tÙ®_size
, 
d©a_size
, 
ext_bË_size
;

115 
sum
, 
Üig_sum
, 
ext_sigcouÁ
 = 0, 
i
;

117 
tÙ®_size
 = 
	`g‘_tÙ®size
(
mc_h—d”
);

118 
d©a_size
 = 
	`g‘_d©asize
(
mc_h—d”
);

119 iàĞ(
d©a_size
 + 
MC_HEADER_SIZE
è> 
tÙ®_size
 )

121 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

123  -
EINVAL
;

126 iàĞ(
mc_h—d”
->
ldrv”
 !ğ1è|| (mc_h—d”->
hdrv”
 != 1) )

128 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

130  -
EINVAL
;

132 
ext_bË_size
 = 
tÙ®_size
 - (
MC_HEADER_SIZE
 + 
d©a_size
);

133 iàĞ
ext_bË_size
 )

135 iàĞ(
ext_bË_size
 < 
EXT_HEADER_SIZE
) ||

136 ((
ext_bË_size
 - 
EXT_HEADER_SIZE
è% 
EXT_SIGNATURE_SIZE
) )

138 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

140  -
EINVAL
;

142 
ext_h—d”
 = 
mc
 + 
MC_HEADER_SIZE
 + 
d©a_size
;

143 iàĞ
ext_bË_size
 !ğ
	`ex‰abË_size
(
ext_h—d”
) )

145 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! "

147  -
EFAULT
;

149 
ext_sigcouÁ
 = 
ext_h—d”
->
couÁ
;

153 iàĞ
ext_bË_size
 )

155 
ext_bË_sum
 = 0;

156 *
ext_bËp
 = (*)
ext_h—d”
;

158 
i
 = 
ext_bË_size
 / 
DWSIZE
;

159  
i
-- )

160 
ext_bË_sum
 +ğ
ext_bËp
[
i
];

161 iàĞ
ext_bË_sum
 )

163 
	`´štk
(
KERN_WARNING
 "microcode:‡borting, "

165  -
EINVAL
;

170 
Üig_sum
 = 0;

171 
i
 = (
MC_HEADER_SIZE
 + 
d©a_size
è/ 
DWSIZE
;

172  
i
-- )

173 
Üig_sum
 +ğ((*)
mc
)[
i
];

174 iàĞ
Üig_sum
 )

176 
	`´štk
(
KERN_ERR
 "microcode:‡borting, bad checksum\n");

177  -
EINVAL
;

179 iàĞ!
ext_bË_size
 )

182  
i
 = 0; i < 
ext_sigcouÁ
; i++ )

184 
ext_sig
 = (*)
ext_h—d”
 + 
EXT_HEADER_SIZE
 +

185 
EXT_SIGNATURE_SIZE
 * 
i
;

186 
sum
 = 
Üig_sum


187 - (
mc_h—d”
->
sig
 + mc_h—d”->
pf
 + mc_h—d”->
cksum
)

188 + (
ext_sig
->
sig
 +ƒxt_sig->
pf
 +ƒxt_sig->
cksum
);

189 iàĞ
sum
 )

191 
	`´štk
(
KERN_ERR
 "microcode:‡borting, bad checksum\n");

192  -
EINVAL
;

196 
	}
}

203 
	$g‘_m©chšg_miüocode
(*
mc
, 
ıu
)

205 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

206 
miüocode_h—d”_š‹l
 *
mc_h—d”
 = 
mc
;

207 
ex‹nded_sigbË
 *
ext_h—d”
;

208 
tÙ®_size
 = 
	`g‘_tÙ®size
(
mc_h—d”
);

209 
ext_sigcouÁ
, 
i
;

210 
ex‹nded_sigÇtu»
 *
ext_sig
;

211 *
Ãw_mc
;

213 iàĞ
	`miüocode_upd©e_m©ch
(
ıu
, 
mc_h—d”
,

214 
mc_h—d”
->
sig
, mc_h—d”->
pf
) )

215 
fšd
;

217 iàĞ
tÙ®_size
 <ğ(
	`g‘_d©asize
(
mc_h—d”
è+ 
MC_HEADER_SIZE
) )

220 
ext_h—d”
 = 
mc
 + 
	`g‘_d©asize
(
mc_h—d”
è+ 
MC_HEADER_SIZE
;

221 
ext_sigcouÁ
 = 
ext_h—d”
->
couÁ
;

222 
ext_sig
 = (*)
ext_h—d”
 + 
EXT_HEADER_SIZE
;

223  
i
 = 0; i < 
ext_sigcouÁ
; i++ )

225 iàĞ
	`miüocode_upd©e_m©ch
(
ıu
, 
mc_h—d”
,

226 
ext_sig
->
sig
,ƒxt_sig->
pf
) )

227 
fšd
;

228 
ext_sig
++;

231 
fšd
:

232 
	`´_debug
("microcode: CPU%d found‡ matching microcode update with"

234 
ıu
, 
mc_h—d”
->
»v
, 
uci
->
ıu_sig
.rev);

235 
Ãw_mc
 = 
	`xm®loc_by‹s
(
tÙ®_size
);

236 iàĞ
Ãw_mc
 =ğ
NULL
 )

238 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! Can‚ot‡llocate memory\n");

239  -
ENOMEM
;

243 
	`xä“
(
uci
->
mc
.
mc_š‹l
);

245 
	`memıy
(
Ãw_mc
, 
mc
, 
tÙ®_size
);

246 
uci
->
mc
.
mc_š‹l
 = 
Ãw_mc
;

248 
	}
}

250 
	$­¶y_miüocode
(
ıu
)

252 
æags
;

253 
ušt64_t
 
m¤_cÚ‹Á
;

254 
v®
[2];

255 
ıu_num
 = 
	`¿w_smp_´oûssÜ_id
();

256 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu_num
);

259 
	`BUG_ON
(
ıu_num
 !ğ
ıu
);

261 iàĞ
uci
->
mc
.
mc_š‹l
 =ğ
NULL
 )

262  -
EINVAL
;

265 
	`¥š_lock_œq§ve
(&
miüocode_upd©e_lock
, 
æags
);

268 
	`wrm¤l
(
MSR_IA32_UCODE_WRITE
, ()
uci
->
mc
.
mc_š‹l
->
b™s
);

269 
	`wrm¤l
(
MSR_IA32_UCODE_REV
, 0x0ULL);

272 
	`sync_cÜe
();

275 
	`rdm¤l
(
MSR_IA32_UCODE_REV
, 
m¤_cÚ‹Á
);

276 
v®
[1] = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

278 
	`¥š_uÆock_œq»¡Üe
(&
miüocode_upd©e_lock
, 
æags
);

279 iàĞ
v®
[1] !ğ
uci
->
mc
.
mc_š‹l
->
hdr
.
»v
 )

281 
	`´štk
(
KERN_ERR
 "microcode: CPU%d update from„evision "

282 "0x%xØ0x%x faed\n", 
ıu_num
, 
uci
->
ıu_sig
.
»v
, 
v®
[1]);

283  -
EIO
;

285 
	`´štk
(
KERN_INFO
 "microcode: CPU%d updated from„evision "

287 
ıu_num
, 
uci
->
ıu_sig
.
»v
, 
v®
[1],

288 
uci
->
mc
.
mc_š‹l
->
hdr
.
d©e
 & 0xffff,

289 
uci
->
mc
.
mc_š‹l
->
hdr
.
d©e
 >> 24,

290 (
uci
->
mc
.
mc_š‹l
->
hdr
.
d©e
 >> 16) & 0xff);

291 
uci
->
ıu_sig
.
»v
 = 
v®
[1];

294 
	}
}

296 
	$g‘_Ãxt_ucode_äom_bufãr
(**
mc
, cÚ¡ 
u8
 *
buf
,

297 
size
, 
off£t
)

299 
miüocode_h—d”_š‹l
 *
mc_h—d”
;

300 
tÙ®_size
;

303 iàĞ
off£t
 >ğ
size
 )

305 
mc_h—d”
 = (
miüocode_h—d”_š‹l
 *)(
buf
 + 
off£t
);

306 
tÙ®_size
 = 
	`g‘_tÙ®size
(
mc_h—d”
);

308 iàĞ(
off£t
 + 
tÙ®_size
è> 
size
 )

310 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! Bad data in microcode data file\n");

311  -
EINVAL
;

314 *
mc
 = 
	`xm®loc_by‹s
(
tÙ®_size
);

315 iàĞ*
mc
 =ğ
NULL
 )

317 
	`´štk
(
KERN_ERR
 "microcode:ƒrror! Can‚ot‡llocate memory\n");

318  -
ENOMEM
;

320 
	`memıy
(*
mc
, (cÚ¡ *)(
buf
 + 
off£t
), 
tÙ®_size
);

321  
off£t
 + 
tÙ®_size
;

322 
	}
}

324 
	$ıu_»que¡_miüocode
(
ıu
, cÚ¡ *
buf
, 
size_t
 
size
)

326 
off£t
 = 0;

327 
”rÜ
 = 0;

328 *
mc
;

329 
m©chšg_couÁ
 = 0;

332 
	`BUG_ON
(
ıu
 !ğ
	`¿w_smp_´oûssÜ_id
());

334  (
off£t
 = 
	`g‘_Ãxt_ucode_äom_bufãr
(&
mc
, 
buf
, 
size
, offset)) > 0 )

336 
”rÜ
 = 
	`miüocode_§n™y_check
(
mc
);

337 iàĞ
”rÜ
 )

339 
”rÜ
 = 
	`g‘_m©chšg_miüocode
(
mc
, 
ıu
);

340 iàĞ
”rÜ
 < 0 )

346 iàĞ
”rÜ
 == 1 )

348 
m©chšg_couÁ
++;

349 
”rÜ
 = 0;

351 
	`xä“
(
mc
);

353 iàĞ
off£t
 > 0 )

354 
	`xä“
(
mc
);

355 iàĞ
off£t
 < 0 )

356 
”rÜ
 = 
off£t
;

358 iàĞ!
”rÜ
 && 
m©chšg_couÁ
 )

359 
	`­¶y_miüocode
(
ıu
);

361  
”rÜ
;

362 
	}
}

364 
	$miüocode_»sume_m©ch
(
ıu
, 
ıu_sigÇtu»
 *
nsig
)

366 
ucode_ıu_šfo
 *
uci
 = &
	`³r_ıu
(ucode_ıu_šfo, 
ıu
);

368  (
	`sigm©ch
(
nsig
->
sig
, 
uci
->
ıu_sig
.sig,‚sig->
pf
, uci->cpu_sig.pf) &&

369 (
uci
->
ıu_sig
.
»v
 > 
nsig
->rev));

370 
	}
}

372 cÚ¡ 
miüocode_İs
 
	gmiüocode_š‹l_İs
 = {

373 .
miüocode_»sume_m©ch
 = microcode_resume_match,

374 .
	gıu_»que¡_miüocode
 = 
ıu_»que¡_miüocode
,

375 .
	gcŞËù_ıu_šfo
 = 
cŞËù_ıu_šfo
,

376 .
	g­¶y_miüocode
 = 
­¶y_miüocode
,

379 
__š™
 
	$miüocode_š™_š‹l
()

381 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

382 
miüocode_İs
 = &
miüocode_š‹l_İs
;

384 
	}
}

385 
__š™ÿÎ
(
miüocode_š™_š‹l
);

	@mini.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 
	gpcouÁ
[
COUNT_MAX
];

26 
	g’abË_³rfmÚ
 = 0;

29 
v»giÚ_t
 *
	gv»giÚ_1mb_poŞ
[
MAX_VREGION_1MB_POOL
];

30 
	gv»giÚ_1mb_poŞ_couÁ
;

31 
	gnum_v»giÚs_³r_1mb
;

32 #ifdeà
ENABLE_DENSITY


33 
©omic_t
 
	gab™_d’s™y_sh¬ed
[
MAX_CACHE
][32];

36 
	#ÿche_fuÎ
(
X
èĞ
	`ACTIVE_FRAMES_CACHE
(X)>
ÿchemª
[X].
size
/4 )

	)

38 
©omic_t
 
	gmši_¶aû
[
MAX_PLACE
];

39 
©omic_t
 
	gmši_couÁ
;

40 
	gmši_aùiv©ed
;

41 
	gmši_di§blšg
;

46 
	$™”©ed_b™couÁ
 (
n
)

48 
couÁ
=0;

49 
n
)

51 
couÁ
 +ğ
n
 & 0x1u ;

52 
n
 >>= 1 ;

54  
couÁ
 ;

55 
	}
}

59 
	gb™s_š_ch¬
 [256] ;

61 
	$compu‹_b™s_š_ch¬
 ()

63 
i
 ;

64 
i
 = 0; i < 256; i++)

65 
b™s_š_ch¬
 [
i
] = 
	`™”©ed_b™couÁ
 (i) ;

67 
	}
}

69 
šlše
 
	$b™couÁ
 (
n
)

72 
»t
;

73 
»t
 = 
b™s_š_ch¬
 [
n
 & 0xffu]

74 + 
b™s_š_ch¬
 [(
n
 >> 8) & 0xffu]

75 + 
b™s_š_ch¬
 [(
n
 >> 16) & 0xffu]

76 + 
b™s_š_ch¬
 [(
n
 >> 24) & 0xffu] ;

77  
»t
;

78 
	}
}

88 
	sıušfo_x86
 {

89 
__u8
 
	mx86
;

90 
__u8
 
	mx86_v’dÜ
;

91 
__u8
 
	mx86_mod–
;

92 
__u8
 
	mx86_mask
;

93 
	mıuid_Ëv–
;

94 
	mx86_ÿ·b™y
[
NCAPINTS
];

95 
	mx86_v’dÜ_id
[16];

96 
	mx86_mod–_id
[64];

97 
	mx86_ÿche_size
;

98 
	mx86_ÿche_®ignm’t
;

99 
	mx86_pow”
;

100 
	mx86_max_cÜes
;

101 
	mboÙed_cÜes
;

102 
	m­icid
;

103 
	mx86_şæush_size
;

104 } 
	g__ÿch–še_®igÃd
;

107 
	$my´št_ıu_šfo
(
ıušfo_x86
 *
šfo
)

109 
	`my´štk
("%2x%2x%2x%2x, cpuid_Ëv–=%d, cache=%dK(?),%d®ign, %dmaxcÜes\n", 
šfo
->
x86
, info->
x86_v’dÜ
, info->
x86_mod–
, info->
x86_mask
, info->
ıuid_Ëv–
, info->
x86_ÿche_size
, info->
x86_ÿche_®ignm’t
, info->
x86_max_cÜes
);

110 
	}
}

117 
my´št_x’h—p
();

119 
šlše
 
	$mâ_check
(
mâ
)

121 #ifdeà
DEBUG_ASSERT


122 ià(
mâ
 >ğ
max_·ge
) {

123 
	`my´štk
("mâ_check:šv®id mâ 0x%x(%d), max_·ge:%d,‡» you usšg video-ÿrd? s‘„uÆev–Ø3\n", 
mâ
, mâ, 
max_·ge
);

124 
	`my·nic
("mfn_check");

127 
	`MYASSERT
(!
pâ_hŞe_mask
);

129 
	`lik–y
(
	`‹¡_b™
(
	`pâ_to_pdx
(
mâ
è/ 
PDX_GROUP_COUNT
,

130 
pdx_group_v®id
))

132 
	`my´štk
("mâ_check:šv®id mâ 0x%x(%d),e¡_b™(%d/%d ,…dx_group_v®idèç\n", 
mâ
, mâ, 
	`pâ_to_pdx
(mâ), 
PDX_GROUP_COUNT
);

133 
	`my·nic
("mfn_check");

136 
	}
}

140 #ifdeà
ENABLE_HISTOGRAM


142 
šlše
 
	$vr_šc_d’s™y
(
v»giÚ_t
 *
vr
, 
i
, 
ÿche
)

144 #ifdeà
DEBUG_ASSERT


145 ià(
i
<0 || i>32è
	`my·nic
("i<0||i>32");

146 ià(
ÿche
<0 || cache>=
MAX_CACHE
è
	`my·nic
("cache<0||cache>=MAX_CACHE");

147 ià(!
	`¥š_is_locked
(&
vr
->
couÁ_lock
)è
	`my·nic
("inc_density:get vr->count_lock first!");

149 ià(
i
==32)

150 
i
 = 31;

152 
vr
->
ab™_hi¡og¿m
[
ÿche
][
i
]++;

153 #ifdeà
DEBUG_ASSERT


154 ià(!
vr
->
ab™_hi¡og¿m
[
ÿche
][
i
])

155 
	`my·nic
("WARN: vr_inc_density overflow?");

157 #ifdeà
ENABLE_CACHEMAN1


158 
	`my¥š_lock
(&
ÿchemª
[
ÿche
].
lock
, 125);

159 ià(
	`is_v»giÚ_ÿche_š
(
vr
, 
ÿche
)) {

160 
ÿchemª
[
ÿche
].
ab™_d’s™y
[
i
]++;

161 #ifdeà
DEBUG_ASSERT


162 ià(!
ÿchemª
[
ÿche
].
ab™_d’s™y
[
i
])

163 
	`my·nic
("WARN: vr_inc_density cache density overflow?\n");

165 ià(
vr
->
pgd
) {

166 #ifdeà
DEBUG_ASSERT


167 ià(
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

168 
	`my·nic
("vr_inc_density!!");

170 
	`©omic_šc
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
i
]);

171 #ifdeà
DEBUG_ASSERT


172 ià(!
	`©omic_»ad
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
i
]))

173 
	`my·nic
("WARN: vr_inc_density…gd->density overflow?\n");

176 #ifdeà
DEBUG_ASSERT


177 ià(!
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

178 
	`my·nic
("vr_inc_density!!");

180 
	`©omic_šc
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
i
]);

181 #ifdeà
DEBUG_ASSERT


182 ià(!
	`©omic_»ad
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
i
]))

183 
	`my·nic
("WARN: vr_inc_density shared…gd->density overflow?\n");

187 
	`¥š_uÆock
(&
ÿchemª
[
ÿche
].
lock
);

189 
	}
}

191 
šlše
 
	$vr_dec_d’s™y
(
v»giÚ_t
 *
vr
, 
i
, 
ÿche
)

193 #ifdeà
DEBUG_ASSERT


194 ià(
i
<0 || i>32è
	`my·nic
("i<0||i>32");

195 ià(
ÿche
<0 || cache>=
MAX_CACHE
è
	`my·nic
("cache<0||cache>=MAX_CACHE");

196 ià(!
	`¥š_is_locked
(&
vr
->
couÁ_lock
)è
	`my·nic
("dec_density:get vr->count_lock first!");

198 ià(
i
==32)

199 
i
 = 31;

200 #ifdeà
DEBUG_ASSERT


201 ià(!
vr
->
ab™_d’s™y
[
ÿche
][
i
]) {

202 
	`my´štk
("und”æow, i=%d,$%d\n", 
i
, 
ÿche
);

203 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

204 
	`my·nic
("WARN: vr_dec_density going -1?");

207 
vr
->
ab™_d’s™y
[
ÿche
][
i
]--;

208 #ifdeà
ENABLE_CACHEMAN1


209 
	`my¥š_lock
(&
ÿchemª
[
ÿche
].
lock
, 126);

210 ià(
	`is_v»giÚ_ÿche_š
(
vr
, 
ÿche
)) {

211 #ifdeà
DEBUG_ASSERT


212 ià(!
ÿchemª
[
ÿche
].
ab™_d’s™y
[
i
])

213 
	`my·nic
("WARN: vr_dec_density cache density going -1?\n");

215 
ÿchemª
[
ÿche
].
ab™_d’s™y
[
i
]--;

216 ià(
vr
->
pgd
) {

217 #ifdeà
DEBUG_ASSERT


218 ià(
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

219 
	`my·nic
("vr_dec_density!!");

221 #ifdeà
DEBUG_ASSERT


222 ià(!
	`©omic_»ad
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
i
])) {

223 
	`my¥š_lock
(&
vr
->
lock
,155);

224 
	`´št_v»giÚ
(
vr
, 
VR_PRINT_RMAP
);

225 
	`¥š_uÆock
(&
vr
->
lock
);

226 
	`my·nic
("WARN: vr_dec_density…gd->density going -1?\n");

229 
	`©omic_dec
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
i
]);

231 #ifdeà
DEBUG_ASSERT


232 ià(!
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

233 
	`my·nic
("vr_dec_density!!");

235 #ifdeà
DEBUG_ASSERT


236 ià(!
	`©omic_»ad
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
i
]))

237 
	`my·nic
("WARN: vr_dec_density shared…gd->density going -1?\n");

239 
	`©omic_dec
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
i
]);

242 
	`¥š_uÆock
(&
ÿchemª
[
ÿche
].
lock
);

244 
	}
}

246 
šlše
 
	$vr_»£t_d’s™y
(
v»giÚ_t
 *
vr
, 
i
, 
ÿche
)

248 #ifdeà
DEBUG_ASSERT


249 ià(
i
<0 || i>31è
	`my·nic
("i<0||i>31");

250 ià(
ÿche
<0 || cache>=
MAX_CACHE
è
	`my·nic
("cache<0||cache>=MAX_CACHE");

252 
vr
->
ab™_d’s™y
[
ÿche
][
i
] = 0;

253 
	}
}

256 
šlše
 
	$vr_move_d’s™y
(
v»giÚ_t
 *
vr
, 
äom
, 
to
, 
ÿche
)

258 #ifdeà
DEBUG_ASSERT


259 ià(
äom
<0 || from>32è
	`my·nic
("from<0||from>32");

260 ià(
to
<0 ||o>32è
	`my·nic
("to<0||to>32");

261 ià(
ÿche
<0 || cache>=
MAX_CACHE
è
	`my·nic
("cache<0||cache>=MAX_CACHE");

262 ià(!
	`¥š_is_locked
(&
vr
->
couÁ_lock
)è
	`my·nic
("move_density:get vr->count_lock first!");

264 ià(
äom
==32)

265 
äom
 = 31;

266 ià(
to
==32)

267 
to
 = 31;

268 #ifdeà
DEBUG_ASSERT


269 ià(!
vr
->
ab™_d’s™y
[
ÿche
][
äom
]) {

270 
	`my´štk
("und”æow, from=%d,$%d\n", 
äom
, 
ÿche
);

271 
	`´št_v»giÚ
(
vr
,
VRPRINT_RMAP
);

272 
	`my·nic
("WARN: vr_move_density going -1?");

275 
vr
->
ab™_d’s™y
[
ÿche
][
äom
]--;

276 
vr
->
ab™_d’s™y
[
ÿche
][
to
]++;

277 #ifdeà
DEBUG_ASSERT


278 ià(!
vr
->
ab™_d’s™y
[
ÿche
][
to
])

279 
	`my·nic
("WARN: vr_move_density overflow?");

281 #ifdeà
ENABLE_CACHEMAN1


282 
	`my¥š_lock
(&
ÿchemª
[
ÿche
].
lock
, 129);

283 ià(
	`is_v»giÚ_ÿche_š
(
vr
, 
ÿche
)) {

284 #ifdeà
DEBUG_ASSERT


285 ià(!
ÿchemª
[
ÿche
].
ab™_d’s™y
[
äom
])

286 
	`my·nic
("WARN: vr_move_density cache density going -1?\n");

288 
ÿchemª
[
ÿche
].
ab™_d’s™y
[
äom
]--;

289 
ÿchemª
[
ÿche
].
ab™_d’s™y
[
to
]++;

290 #ifdeà
DEBUG_ASSERT


291 ià(!
ÿchemª
[
ÿche
].
ab™_d’s™y
[
to
])

292 
	`my·nic
("WARN: vr_move_density cache density overflow?\n");

294 ià(
vr
->
pgd
) {

295 #ifdeà
DEBUG_ASSERT


296 ià(
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

297 
	`my·nic
("vr_move_density!!");

299 #ifdeà
DEBUG_ASSERT


300 ià(!
	`©omic_»ad
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
äom
]))

301 
	`my·nic
("WARN: vr_move_density…gd->density going -1?\n");

303 
	`©omic_dec
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
äom
]);

304 
	`©omic_šc
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
to
]);

305 #ifdeà
DEBUG_ASSERT


306 ià(!
	`©omic_»ad
(&
vr
->
pgd
->
ab™_d’s™y
[
ÿche
][
to
]))

307 
	`my·nic
("WARN: vr_move_density…gd->density overflow?\n");

310 #ifdeà
DEBUG_ASSERT


311 ià(!
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
))

312 
	`my·nic
("vr_move_density!!");

314 #ifdeà
DEBUG_ASSERT


315 ià(!
	`©omic_»ad
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
äom
]))

316 
	`my·nic
("WARN: vr_move_density shared…gd->density going -1?\n");

318 
	`©omic_dec
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
äom
]);

319 
	`©omic_šc
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
to
]);

320 #ifdeà
DEBUG_ASSERT


321 ià(!
	`©omic_»ad
(&
ab™_d’s™y_sh¬ed
[
ÿche
][
to
]))

322 
	`my·nic
("WARN: vr_move_density shared…gd->density overflow?\n");

326 
	`¥š_uÆock
(&
ÿchemª
[
ÿche
].
lock
);

328 
	}
}

428 #ifdeà
DEBUG_HISTOGRAM


429 
¥šlock_t
 
	ghi¡_lock
;

430 
	#MAX_HISTOGRAM
 2560

431 
	shi¡og¿m_’Œy
 {

	)

432 
	mab™_hi¡Üy
;

433 
	mcouÁ
;

434 
hi¡og¿m_’Œy
 *
	mÃxt
;

435 } 
	gh’Œy
[
MAX_HISTOGRAM
];

436 
hi¡og¿m_’Œy
 *
	ghä“
;

437 
hi¡og¿m_’Œy
 *
	ghli¡
;

439 
	$š™_hi¡
()

441 
i
;

442 
hli¡
 = 
NULL
;

443 
hä“
 = &
h’Œy
[0];

444 
i
=0;i<
MAX_HISTOGRAM
;i++) {

445 
h’Œy
[
i
].
ab™_hi¡Üy
 = h’Œy[i].
couÁ
 = 0;

446 
h’Œy
[
i
].
Ãxt
 = &hentry[i+1];

448 
h’Œy
[
i
-1].
Ãxt
 = 
NULL
;

449 
	}
}

451 
	$add_hi¡
(
ab™_hi¡Üy
)

453 
hi¡og¿m_’Œy
 *
i
 = 
hli¡
, *
´e_i
;

454 ià(!
i
) {

455 ià(!
hä“
) {

456 
	`my·nic
("increase MAX_HISTOGRAM!\n");

458 
hli¡
 = 
hä“
;

459 
hli¡
->
ab™_hi¡Üy
 =‡bit_history;

460 
hli¡
->
couÁ
 = 1;

461 
hä“
 = hä“->
Ãxt
;

462 
hli¡
->
Ãxt
 = 
NULL
;

465 
i
) {

466 ià(
i
->
ab™_hi¡Üy
 ==‡bit_history) {

467 
i
->
couÁ
++;

470 
´e_i
 = 
i
;

471 
i
 = i->
Ãxt
;

475 ià(!
hä“
) {

476 
	`my·nic
("increase MAX_HISTOGRAM!\n");

478 
i
 = 
hä“
;

479 
hä“
 = hä“->
Ãxt
;

480 
i
->
Ãxt
 = 
NULL
;

481 
´e_i
->
Ãxt
 = 
i
;

482 
i
->
ab™_hi¡Üy
 =‡bit_history;

483 
i
->
couÁ
 = 1;

484 
	}
}

486 
hi¡og¿m_’Œy
 *
	$g‘_hi¡
()

488 
hi¡og¿m_’Œy
 *
i
 = 
hli¡
, *
»t
 = 
NULL
;

489 
Ïrge
 = 0;

490 
i
) {

491 ià(
i
->
couÁ
 > 
Ïrge
 && i->
ab™_hi¡Üy
) {

492 
»t
 = 
i
;

493 
Ïrge
 = 
i
->
couÁ
;

495 
i
 = i->
Ãxt
;

497  
»t
;

498 
	}
}

500 
	$´št_hi¡
()

502 
hi¡og¿m_’Œy
 *
i
 = 
hli¡
;

503 
i
) {

504 
	`my´štk
("ab™:%8x couÁ:%d\n", 
i
->
ab™_hi¡Üy
, i->
couÁ
);

505 
i
 = i->
Ãxt
;

507 
	}
}

513 
	$´štx_v»giÚ
(
v»giÚ_t
 *
vr
)

515 
li¡_h—d
 *
k
;

516 
rm­_£t
 *
rms
;

517 
i
,
j
;

518 
¬¿y
[128];

519 
couÁ
 = 0;

523 
¬¿y
[
couÁ
++] = 0;

524 
¬¿y
[
couÁ
++] = 
	`ÿchem­_couÁ
(
vr
);

525 
¬¿y
[
couÁ
++] = 
vr
->
rm­_couÁ
[0];

526 
¬¿y
[
couÁ
++] = 
vr
->
äame_couÁ
;

527 
¬¿y
[
couÁ
++] = 
vr
->
æags
;

528 #ifdeà
ENABLE_CLOCK_OLD


529 
j
=0;j<
MAX_CACHE
;j++) {

530 
i
=0;i<32;i++)

531 
¬¿y
[
couÁ
++] = 
vr
->
ab™_d’s™y
[
j
][
i
];

557 
	`MYXTRACE
(
TRC_MIN_VREGION
, 
couÁ
, 
¬¿y
);

558 
	}
}

562 
	$´št_v»giÚ
(
v»giÚ_t
 *
vr
, 
æag
)

564 
li¡_h—d
 *
k
;

565 
i
,
j
;

566 #ifdeà
ENABLE_REGIONING3


567 
s_time_t
 
now
 = 
	`NOW
();

570 
	`my´štk
("vr:%p "

573 #ifdeà
ENABLE_REGIONING3


579 #ifdeà
ENABLE_DENSITY


582 "\n", 
vr
,

583 
vr
->
rm­_couÁ
[
RMAPS_USER
], vr->rm­_couÁ[
RMAPS_KERNEL
], vr->
äame_couÁ
,

585 #ifdeà
ENABLE_REGIONING3


586 
vr
->
acûss
/1000LL,

587 (
now
 - 
vr
->
ošt
)/1000LL,

590 
vr
->
æags


592 #ifdeà
ENABLE_DENSITY


593 ,
	`ACTIVE_FRAMES_VR
(
vr
, 0), ACTIVE_FRAMES_VR(vr, 1)

597 
	`my´štk
("refcnt:");

598 
i
=0;i<
MAX_VR_REFCNT
;i++)

599 
	`´štk
("%d,",
	`©omic_»ad
(&
vr
->
vr_»fút
[
i
]));

600 
	`´štk
("\n");

603 #ifdeà
ENABLE_DENSITY


604 ià(
æag
 & 
VRPRINT_DENSITY
) {

621 #ifdeà
ENABLE_RMAP


622 ià(
æag
 & 
VRPRINT_RMAP
) {

623 
	`´št_rm­s
(
vr
);

626 
	}
}

629 #ifdeà
DEBUG_CHECK_VREGION


630 
	#MAX_MFN_LIST
 2560

631 
	smâ_li¡_t
 {

	)

632 
	mmâ_li¡
[
MAX_MFN_LIST
];

635 
	$add_mâ
(
mâ
, *
mâ_li¡
)

637 
i
;

638 
i
=0;i<
MAX_MFN_LIST
;i++) {

639 ià(
mâ_li¡
[
i
] =ğ
mâ
)

642 
i
=0;i<
MAX_MFN_LIST
;i++) {

643 ià(!
mâ_li¡
[
i
]) {

644 
mâ_li¡
[
i
] = 
mâ
;

648 
	`my·nic
("add_mfn: full?");

649 
	}
}

651 
	$couÁ_mâ_li¡
(*
mâ_li¡
)

653 
i
, 
couÁ
=0;

654 
i
=0;i<
MAX_MFN_LIST
;i++)

655 ià(
mâ_li¡
[
i
])

656 
couÁ
++;

657  
couÁ
;

658 
	}
}

662 
	$check_v»giÚ
(
v»giÚ_t
 *
vr
, 
İtiÚ
)

664 
this
 
is
 
Şd
 
code
..

666 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

667 
pcouÁ
[
COUNT_CHECK_VREGION
]++;

668 
rm­_£t
 *
rms
;

669 
·ge_dœ
 *
pgd
 = 
NULL
;

670 
i
, 
j
;

671 
couÁ
 = 0, 
couÁ_sub
 = 0, 
is_sh¬ed
 = 0;

672 
mâ_li¡_t
 *
mâ_li¡
 = 
	`myxm®loc
(mâ_li¡_t, 
TODO
);

674 
i
=0;i<
MAX_MFN_LIST
;i++)

675 
mâ_li¡
->mâ_li¡[
i
] = 0;

677 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
vr
->
rm­s_li¡
, 
li¡
) {

678 
couÁ_sub
 = 0;

679 
i
=0;i<
rms
->
size
;i++) {

680 ià(!
rms
->
rm­s
[
i
].
±
)

682 
couÁ
++;

683 
couÁ_sub
++;

684 
	`add_mâ
(
rms
->
rm­s
[
i
].
mâ
, &
mâ_li¡
->mfn_list[0]);

685 ià(
pgd
 =ğ
NULL
) {

686 
pgd
 = 
rms
->
rm­s
[
i
].
±
->pgd;

689 ià(
pgd
 !ğ
rms
->
rm­s
[
i
].
±
->pgd) {

691 
is_sh¬ed
 = 1;

692 ià(!
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
)) {

693 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

694 
	`my·nic
("Shared flag should be on.\n");

698 ià(
couÁ_sub
==0 && 
rms
 !ğ&
vr
->
deçuÉ_rm­s
)

699 
	`my´štk
("empty„map_setƒxists??");

701 ià(
vr
->
rm­_couÁ
[
todo
] !ğ
couÁ
)

702 
	`my´štk
("vr->rm­_couÁ %d,%d !ğ»® %d\n", 
vr
->
rm­_couÁ
[
RMAPS_USER
], vr->rm­_couÁ[
RMAPS_KERNEL
], 
couÁ
);

703 ià(
vr
->
äame_couÁ
 !ğ
	`couÁ_mâ_li¡
(&
mâ_li¡
->mfn_list[0]))

704 
	`my´štk
("vr->äame_couÁ %d!ô—È%d\n", 
vr
->
äame_couÁ
, 
	`couÁ_mâ_li¡
(&
mâ_li¡
->mfn_list[0]));

705 ià(!
is_sh¬ed
 && 
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
)) {

706 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

707 
	`my·nic
("Shared flag should be off!.\n");

709 
	`myxä“
(
mâ_li¡
, 9);

710 ià(
	`‹¡_b™
(
VR_SHARED_PAGE
, &
vr
->
æags
)) {

711 ià(
vr
->
rm­_couÁ
[
todo
] < 2)

712 
	`my´štk
("Shared but„map_count<2 \n");

714 #ifdeà
DEBUG_ASSERT


715 ià(
	`‹¡_b™
(
VR_ONECACHE
, &
vr
->
æags
)) {

717 ià(
İtiÚ
 && !
	`‹¡_b™
(
VR_MIGRATING
, &
vr
->
æags
è&& 
	`ÿchem­_couÁ
(vr)>1) {

718 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

719 
	`my´štk
("Priv©v¸ha %d cache m­³d!\n", 
	`ÿchem­_couÁ
(
vr
) );

726 #ifdeà
ENABLE_DENSITY


727 
sum
;

728 
j
=0;j<
MAX_CACHE
;j++) {

729 
sum
 = 0;

730 
i
=0;i<32;i++) {

731 
sum
 +ğ
vr
->
ab™_d’s™y
[
j
][
i
];

733 ià(
sum
 !ğ
vr
->
äame_couÁ
)

734 
	`my´štk
("d’s™y sum:%d !ğ#äame:%d fÜ $%d!\n", 
sum
, 
vr
->
äame_couÁ
, 
j
);

738 
	}
}

740 
	$check_v»giÚ
(
v»giÚ_t
 *
vr
, 
İtiÚ
è{
	}
}

743 #ifdeà
VERBOSE_PAGE_TABLE_MARKING


744 
	$check_±_rm­_sh¬ed
(
·ge_bË
 *
±
)

746 
li¡_h—d
 *
i
,*
k
, *
k2
;

747 
v»giÚ_t
 *
vr
;

748 
rm­
 *
rm
;

749 
»t
 = 0, 
j
;

753 
	`li¡_fÜ_—ch_’Œy
(
vr
, &
v»giÚs_sh¬ed
, 
glob®_li¡
) {

755 
	`li¡_fÜ_—ch_§ã
(
k
, 
k2
, &
vr
->
rm­_li¡
) {

756 
rm
 = 
	`li¡_’Œy
(
k
, 
rm­
, 
li¡
);

757 ià(
rm
->
±
 ==…t) {

758 
	`my´štk
("REMAIN [pgmâ=%x,±mâ=%x,±i=%d]\n",
rm
->
±
->
pgd
->
mâ
,„m->±->mâ,„m->
±šdex
);

759 
»t
++;

760 } ià(
rm
->
±
->
mâ
 ==…t->mfn) {

761 
	`my´štk
("BUG!!„m->pt!=pt but„m->pt->mfn==pt->mfn?? !\n");

766  
»t
;

767 
	}
}

769 #ifdeà
DEBUG_CHECK_RMAP


770 
	$v”ify_rm­
(
rm­_’Œy
 *
rme
)

772 
l1_pg’Œy_t
 
l1e
, *
l1t
;

774 
l1t
 = 
	`m­_domaš_·ge
(
rme
->
±
->
mâ
);

775 
l1e
 = 
l1t
[
rme
->
±šdex
];

777 ià(!(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_PRESENT
)) {

778 
	`my´štk
("v”ify: L1 dÛ¢'ˆexi¡!„me->±->mâ:%x[%d] buˆl1e=%x\n", 
rme
->
±
->
mâ
,„me->
±šdex
, 
l1e
.
l1
);

779 
	`my·nic
("verify");

781 ià(
	`l1e_g‘_pâ
(
l1e
è!ğ
rme
->
mâ
) {

782 
	`my´štk
("v”ify:†1e=%x,„me->mâ:%x\n", 
l1e
.
l1
, 
rme
->
mâ
);

783 
	`my·nic
("verify");

785 
	`unm­_domaš_·ge
(
l1t
);

786 
	}
}

788 
	$v”ify_rm­_’Œy
(
rm­_£t
 *
rms
)

790 
i
;

791 
i
=0;i<
rms
->
size
;i++) {

792 ià(
rms
->
rm­s
[
i
].
±
) {

793 
	`v”ify_rm­
(&
rms
->
rm­s
[
i
]);

797 
	}
}

800 
	$v”ify_sh¬ed_rm­
()

802 
v»giÚ_t
 *
vr
;

803 
rm­_£t
 *
rms
;

807 
	`li¡_fÜ_—ch_’Œy
(
vr
, &
v»giÚs_sh¬ed
, 
glob®_li¡
) {

809 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
vr
->
rm­s_li¡
, 
li¡
) {

810 
	`v”ify_rm­_’Œy
(
rms
);

813 
	}
}

815 
	$v”ify_sh¬ed_rm­
(è{
	}
}

818 
	$´št_±
(
·ge_bË
 *
±
)

820 #ifdeà
ENABLE_PT_RECURSIVE


821 
	`my´štk
("lvl:%d mâ:%x(%d), upÕt:%x i:%xè±_couÁ:%d‡ux:%lx\n", 
±
->
Ëv–
,…t->
mâ
,…t->
u£r_l4
,…t->
up_±
,…t->
up_šdex
,…t->
±_couÁ
,…t->
aux
);

823 
	`my´štk
("mâ:%x(%d)\n", 
±
->
mâ
,…t->
u£r_l4
);

825 
	}
}

828 
	$ÿche_fšd_em±›¡
()

830 
mš
 = 999999, 
»t
 = -1, 
i
, 
aùive_äames
;

831 
i
=0;i<
MAX_CACHE
;i++) {

832 
aùive_äames
 = 
	`ACTIVE_FRAMES_CACHE
(
i
);

833 ià(
aùive_äames
 < 
mš
) {

834 
mš
 = 
aùive_äames
;

835 
»t
 = 
i
;

838 #ifdeà
DEBUG_ASSERT


839 ià(
»t
 == -1)

840 
	`my·nic
("ret==-1");

842  
»t
;

843 
	}
}

846 
	$š™Ÿl_ÿche_cu¼’t
(
·ge_dœ
 *
pgd
)

848  
ÿche_now
;

849 
	}
}

852 
	$š™Ÿl_ÿche_Ï¡
(
·ge_dœ
 *
pgd
)

854  
MAX_CACHE
-1;

855 
	}
}

858 
	$š™Ÿl_ÿche_fœ¡
(
·ge_dœ
 *
pgd
)

861 
	}
}

864 
	$š™Ÿl_ÿche_em±›¡
(
·ge_dœ
 *
pgd
)

866  
	`ÿche_fšd_em±›¡
();

867 
	}
}

870 
	$š™Ÿl_ÿche_®t
(
·ge_dœ
 *
pgd
)

872 
»t
;

874 
®t
 = 0;

875 
®t
++;

876 ià(
®t
>=
MAX_CACHE
)

877 
®t
 = 0;

878 
»t
 = 
®t
;

880 #ifdeà
VERBOSE_ALLOC_CURRENT_CACHE


881 
	`my´štk
("pgdmâ:%x‡Îoc'edØ$%d\n", 
pgd
->
mâ
, 
»t
);

883 #ifdeà
DEBUG_ASSERT


884 ià(!(
»t
>=0 &&„‘<
MAX_CACHE
)) {

885 
	`my´štk
("!!");

886 
	`my·nic
("panic");

889  
»t
;

890 
	}
}

894 
	$myb™s
()

896 
myb™s
[2][
	`BITS_TO_LONGS
(1024)];

897 
	`´štk
("size:%d=%d*2, %x=%x, %x\n", (
myb™s
), (mybits[0]), mybits, mybits[0], mybits[1] );

899 
	`b™m­_z”o
(
myb™s
[0], 1024);

900 
	`b™m­_z”o
(
myb™s
[1], 1024);

901 
myb™s
[1][3] = 0xa;

903 
pos
;

905  
pos
 = 
	`fšd_fœ¡_b™
(
myb™s
[1], 1024);

906 
pos
 < 1024;

907 
pos
 = 
	`fšd_Ãxt_b™
(
myb™s
[1], 1024,…os+1) )

909 
	`´štk
("%d=£t, ", 
pos
);

911 
	`´štk
("\n");

913 
	`‹¡_ªd_£t_b™
Ğ96, 
myb™s
[1]);

915  
pos
 = 
	`fšd_fœ¡_b™
(
myb™s
[1], 1024);

916 
pos
 < 1024;

917 
pos
 = 
	`fšd_Ãxt_b™
(
myb™s
[1], 1024,…os+1) )

919 
	`´štk
("%d=£t, ", 
pos
);

921 
	`´štk
("\n");

923 
	`‹¡_ªd_ş—r_b™
Ğ97, 
myb™s
[1]);

925  
pos
 = 
	`fšd_fœ¡_b™
(
myb™s
[1], 1024);

926 
pos
 < 1024;

927 
pos
 = 
	`fšd_Ãxt_b™
(
myb™s
[1], 1024,…os+1) )

929 
	`´štk
("%d=£t, ", 
pos
);

931 
	`´štk
("\n");

933 
i
;

934  
i
=0;i<1024;i++) {

935 iàĞ
	`‹¡_b™
(
i
, 
myb™s
[1]) ) {

936 
	`´štk
("%d, ",
i
);

939 
	`´štk
("\n");

940 
	}
}

944 
	$myb™s
()

946 
æags
 = 0;

947 
Şd
;

949 
	`´štk
("æags:%x\n", 
æags
);

950 
Şd
 = 
	`‹¡_ªd_£t_b™
(
VR_SHARED_PAGE
, &
æags
);

951 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

952 
Şd
 = 
	`‹¡_ªd_£t_b™
(
VR_SHARED_PAGE
, &
æags
);

953 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

954 
Şd
 = 
	`‹¡_ªd_ş—r_b™
(
VR_SHARED_PAGE
, &
æags
);

955 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

956 
Şd
 = 
	`‹¡_ªd_ş—r_b™
(
VR_SHARED_PAGE
, &
æags
);

957 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

958 
Şd
 = 
	`‹¡_ªd_£t_b™
(
VR_SHARED_PAGE
, &
æags
);

959 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

960 
Şd
 = 
	`‹¡_ªd_ş—r_b™
(
VR_SHARED_PAGE
, &
æags
);

961 
	`´štk
("Şd:%x, fÏgs:%x\n", 
Şd
, 
æags
);

962 
	}
}

969 #ifdeà
ENABLE_BINPACKING


970 
DEFINE_PER_CPU
(
s_time_t
, 
cosched_æagtime
);

971 
DEFINE_PER_CPU
(
·ge_dœ
 *, 
cosched_ex³ùed
);

973 
DEFINE_PER_CPU
(, 
locked_±
);

974 
DEFINE_PER_CPU
(, 
found_±
);

975 
DEFINE_PER_CPU
(, 
locked_±_loc
);

976 
¥šlock_t
 
	g‹mp_lock
;

980 
	gşock_³riod_ms
;

981 *
	gmachše_Çme
;

982 
	gmax_´oc
;

983 
	gmax_ÿche
;

984 
	g´oc2štÿche
[
MAX_PROC
];

985 
ıumask_t
 
	gÿche2ıumask
[
MAX_CACHE
];

987 
	$´št_cÚfig
()

989 
	`my´štk
("Machše=%s, %d CPUs(MAX:%d), %d caches(MAX:%d), sizeof(vr)=%d\n", 
machše_Çme
, 
max_´oc
, 
MAX_PROC
, 
max_ÿche
, 
MAX_CACHE
, (
v»giÚ_t
));

990 
	}
}

992 
	$sy¡em_wide_de¡roy
()

994 
	`my´štk
("system_wide_destory start..\n");

996 #ifdeà
ENABLE_VREGIONS


997 ià(
mybË
) {

998 
	`v¹_de¡roy
();

1002 #ifdeà
ENABLE_VREGIONS


1004 
i
;

1005 ià(
v»giÚs_ä“_couÁ
 !ğ
num_v»giÚs_³r_1mb
*
v»giÚ_1mb_poŞ_couÁ
)

1006 
	`my´štk
("W¬n! v»giÚs_ä“_couÁ:%d !ğÜigš®:%d\n", 
v»giÚs_ä“_couÁ
, 
num_v»giÚs_³r_1mb
*
v»giÚ_1mb_poŞ_couÁ
);

1007 
i
=0;i<
v»giÚ_1mb_poŞ_couÁ
;i++) {

1008 
	`myxä“
(
v»giÚ_1mb_poŞ
[
i
], 6);

1010 ià(
v»giÚs_xm®loc_couÁ
)

1011 
	`my´štk
("WARN! DutØem±y v»giÚs_ä“,ÿÎed xm®loø%dimes. Inü—£…oŞ size!\n", 
v»giÚs_xm®loc_couÁ
);

1013 
	`memËak_»pÜt
();

1014 
	`my´štk
("end of system_wide_destroy\n");

1015 
	}
}

1017 
	gıu¡r
[1024];

1018 
	$´št_pıus
()

1020 
ıu
;

1021 
	`fÜ_—ch_ıu_mask
(
ıu
, 
ıu_Úlše_m­
) {

1022 
	`my´štk
("pıu%d: ", 
ıu
);

1024 
	`ıumask_sú´štf
(
ıu¡r
, (ıu¡r), 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
));

1025 
	`´štk
("siblšg=%s, ", 
ıu¡r
);

1027 
	`ıumask_sú´štf
(
ıu¡r
, (ıu¡r), 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

1028 
	`´štk
("cÜe=%s\n", 
ıu¡r
);

1032 
	`my´štk
("max_·gğ%ld (%ldM)\n", 
max_·ge
, max_page*4/1024);

1033 
	`my´štk
("max_pdx = %ld (%ldMè…â_pdx_hŞe_shiá = %d\n", 
max_pdx
, max_pdx*4/1024, 
pâ_pdx_hŞe_shiá
 );

1034 
	`my´štk
("tÙ®_·ge ğ%ld (%ldM)\n", 
tÙ®_·ges
,otal_pages*4/1024);

1036 
	`MYASSERT
(
max_pdx
 =ğ
max_·ge
);

1037 
	`MYASSERT
(
pâ_pdx_hŞe_shiá
 == 0);

1038 
	}
}

1039 #ifdeà
ENABLE_TIMESTAMP


1040 *
	gtime¡amp_Çme
[
MAX_TIMESTAMP_ID
];

1042 
	$sy¡em_wide_š™
()

1044 
i
;

1045 
	`©omic_£t
(&
mši_couÁ
, 0);

1046 
	`´št_pıus
();

1047 
i
=0;i<
MAX_CACHE
;i++) {

1048 
	`ıus_ş—r
(
ÿche2ıumask
[
i
]);

1050 
i
=0;i<
MAX_PROC
;i++) {

1051 
´oc2štÿche
[
i
] = -1;

1053 #ifdeà
ENABLE_TIMESTAMP


1054 
time¡amp_Çme
[0] = "clear_abit";

1055 
time¡amp_Çme
[1] = "page_migrate";

1057 
	`my´štk
("ıuid_Ëv– : %d\n", 
ıu_d©a
[0].
ıuid_Ëv–
);

1058 #ifdeà
ENABLE_ASYMMETRIC_CACHE


1059 #”rÜ 
TODO


1061 #iâdeà
ONECACHE


1062 ià(
ıu_d©a
[0].
ıuid_Ëv–
 == 10) {

1063 
şock_³riod_ms
 = 100;

1064 
machše_Çme
 = "piquet";

1065 
max_´oc
 = 4;

1066 
max_ÿche
 = 2;

1067 
´oc2štÿche
[0] = 0;

1068 
´oc2štÿche
[1] = 0;

1069 
´oc2štÿche
[2] = 1;

1070 
´oc2štÿche
[3] = 1;

1071 
	`ıu_£t
(0, 
ÿche2ıumask
[0]);

1072 
	`ıu_£t
(1, 
ÿche2ıumask
[0]);

1073 
	`ıu_£t
(2, 
ÿche2ıumask
[1]);

1074 
	`ıu_£t
(3, 
ÿche2ıumask
[1]);

1075 } ià(
ıu_d©a
[0].
ıuid_Ëv–
 == 11) {

1076 
şock_³riod_ms
 = 100;

1077 
machše_Çme
 = "westmere";

1078 
max_´oc
 = 32;

1079 
max_ÿche
 = 4;

1080 
i
;

1081 
i
=0;i<8;i++) {

1082 
´oc2štÿche
[
i
] = 0;

1083 
	`ıu_£t
(
i
, 
ÿche2ıumask
[0]);

1085 
i
=8;i<16;i++) {

1086 
´oc2štÿche
[
i
] = 1;

1087 
	`ıu_£t
(
i
, 
ÿche2ıumask
[1]);

1089 
i
=16;i<24;i++) {

1090 
´oc2štÿche
[
i
] = 2;

1091 
	`ıu_£t
(
i
, 
ÿche2ıumask
[2]);

1093 
i
=24;i<32;i++) {

1094 
´oc2štÿche
[
i
] = 3;

1095 
	`ıu_£t
(
i
, 
ÿche2ıumask
[3]);

1098 
	`my·nic
("cannot determine machine...TODO\n");

1102 
şock_³riod_ms
 = 100;

1103 
machše_Çme
 = "Vishal's machine";

1104 
max_´oc
 = 0;

1105 
max_ÿche
 = 1;

1106 
ıu
;

1107 
	`fÜ_—ch_ıu_mask
(
ıu
, 
ıu_Úlše_m­
) {

1108 
´oc2štÿche
[
ıu
] = 0;

1109 
	`ıu_£t
(
ıu
, 
ÿche2ıumask
[0]);

1110 
max_´oc
++;

1116 #ifdeà
ENABLE_MEASURE_UNBALANCE


1117 
i
=0;i<
MAX_CACHE
;i++) {

1118 
	`©omic_£t
(&
ÿchemª
[
i
].
vıu_couÁ
 , 0);

1123 #ifdeà
ENABLE_PGD


1124 
	`š™_pgds
();

1126 #ifdeà
ENABLE_TRACK_MEMLEAK


1127 
	`š™_Œack_memËak
();

1129 #ifdeà
ENABLE_TRACK_SPINLOCK


1130 
	`š™_Œack_¥šlock
();

1132 #ifdeà
ENABLE_VREGIONS


1133 
	`š™_v»giÚ_poŞs
();

1135 #ifdeà
ENABLE_TRACK_MEMLEAK


1136 
	`š™_Œack_memËak_size
();

1138 
	`š™_mybË
();

1139 #ifdeà
ENABLE_VREGIONS


1140 ià(
mybË
)

1141 
	`v¹_š™
();

1143 #ifdeà
REGIONING_TEMP


1144 
	`»giÚšg_š™
();

1146 #ifdeà
ENABLE_HETERO


1147 
	`h‘”o_š™Ÿlize
();

1149 
	}
}

1153 
	$_’abË_soá_ÿche
(*
šfo
)

1155 
ıu
 = 
	`smp_´oûssÜ_id
();

1156 
	`my´štk
("CPU%d:ƒÇbËd\n", 
ıu
);

1157 
	}
}

1159 
h—p_äame_t
 *
	gmybË
;

1161 
	$š™_mybË
()

1163 ià(!(
h—p_äame_t
)) {

1164 
	`my´štk
("mytable is‚ot used.\n");

1165 
mybË
 = -1;

1168 
	`my´štk
("max_·ge:%d *ƒÁry size:%d = mybË size:%d\n", 
max_·ge
, (
h—p_äame_t
), (heap_frame_t)*max_page);

1169 
mybË
 = 
	`myxm®loc_by‹s
Ğ(
h—p_äame_t
)*
max_·ge
, 5 );

1170 ià(
mybË
) {

1171 
	`mem£t
(
mybË
, 0, (
h—p_äame_t
)*
max_·ge
);

1172 
	`my´štk
("mybË†oÿ‹d‡ˆ%p\n", 
mybË
);

1175 
	`my·nic
("WARN mytable‡llocation failed!?!?\n");

1176 
	}
}

1178 
	$’abË_soá_ÿche
()

1180 
i
,
j
 ;

1184 
vıu
 *
v
;

1185 
domaš
 *
d
;

1187 ià(!
max_´oc
) {

1188 
	`my´štk
("WARN!ƒnabling cancelled...unknown machine..\n");

1191 
	`my´štk
("==================== SOFT CACHE ENABLED ====================\n");

1193 
	`MYASSERT
(
_PAGE_GUEST_KERNEL
 != 0);

1195 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1196 
	`fÜ_—ch_domaš
(
d
) {

1197 
	`my´štk
("d%d.¬ch.·gšg.mode:%xƒÇbËd:%x, shadow:%x, h­:%x\n", 
d
->
domaš_id
, d->
¬ch
.
·gšg
.
mode
, 
	`·gšg_mode_’abËd
(d), 
	`·gšg_mode_shadow
(d), 
	`·gšg_mode_h­
(d));

1198 
	`my´štk
("d%d->vm_assi¡:%x (1:fuÎ-4GB-£glim™, 2:4gb_£gnÙify, 4:wr™abËPT, 8:PDPT abov4gb(x86/PAE gue¡)\n", 
d
->
domaš_id
, d->
vm_assi¡
);

1199 
	`·gšg_dump_domaš_šfo
(
d
);

1200 
	`MYASSERT
(!(
d
->
¬ch
.
·gšg
.
mode
));

1201 
	`fÜ_—ch_vıu
(
d
,
v
) {

1203 
	`·gšg_dump_vıu_šfo
(
v
);

1206 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1208 
	`my´št_x’h—p
();

1209 
	`´št_pıus
();

1210 #ifdeà
ENABLE_BINPACKING


1211 
i
=0;i<
max_´oc
;i++) {

1212 ià(
	`³r_ıu
(
cosched_æagtime
, 
i
))

1213 
	`my´štk
("WARN! cosched value was‚ot cleared yet??\n");

1214 
	`³r_ıu
(
cosched_æagtime
, 
i
) = 0;

1215 
	`³r_ıu
(
cosched_ex³ùed
, 
i
) = 0;

1218 
i
=0;i<
max_´oc
;i++) {

1219 ià(
	`³r_ıu
(
locked_±
, 
i
))

1220 
	`my´štk
("lšg”šg†ocked_±‡ˆP%d\n", 
i
);

1221 
	`³r_ıu
(
locked_±
, 
i
) = 0;

1223 
	`³r_ıu
(
locked_±_loc
, 
i
) = 0;

1225 ià(
	`³r_ıu
(
found_±
, 
i
))

1226 
	`my´štk
("lšg”šg found_±‡ˆP%d\n", 
i
);

1227 
	`³r_ıu
(
found_±
, 
i
) = 0;

1228 ià(
i
==0)

1229 
	`my´št_ıu_šfo
(&
ıu_d©a
[
i
]);

1231 #ifdeà
ENABLE_TIMESTAMP


1232 
i
=0;i<
max_´oc
;i++) {

1233 
	`š™_time¡amp
(&
	`³r_ıu
(
time¡amp
, 
i
));

1236 #ifdeà
ENABLE_CACHE_BALANCE


1237 
	`¥š_lock_š™
(&
mig¿tšg_lock
);

1239 
	`¥š_lock_š™
(&
‹mp_lock
);

1240 #ifdeà
DEBUG_HISTOGRAM


1241 
	`¥š_lock_š™
(&
hi¡_lock
);

1243 ià(
mši_di§blšg
)

1244 
	`my·nic
("mini_disabling is set?");

1246 
	`mem£t
(
pcouÁ
, 0, (pcount));

1250 
	`´št_cÚfig
();

1251 
	`compu‹_b™s_š_ch¬
 ();

1252 #ifdeà
ENABLE_PTMAN


1253 
	`š™_±mª
();

1255 #ifdeà
ENABLE_CACHEMAN1


1256 
	`š™_ÿchemª
();

1258 #ifdeà
ENABLE_DENSITY


1260 
	`mem£t
(
ab™_d’s™y_sh¬ed
, 0, (abit_density_shared));

1263 
ıus
 = ()
	`num_Úlše_ıus
();

1265 #ifdeà
ENABLE_ASYMMETRIC_CACHE


1266 ià(
ıus
 !ğ
max_´oc
-1) {

1267 
	`my´štk
("WARN!ƒÇblšg cªûÎed...#PCPU=%d (Ãed %d)\n", 
ıus
, 
max_´oc
-1);

1271 ià(
ıus
 !ğ
max_´oc
) {

1272 
	`my´štk
("WARN!ƒÇblšg cªûÎed...#PCPU=%d (Ãed %d)\n", 
ıus
, 
max_´oc
);

1276 ià(!
mybË
) {

1277 
	`my´štk
("null mytable. cancelƒnableing\n");

1282 
i
=0;i<
max_·ge
;i++) {

1283 #ifdeà
ENABLE_ABIT


1284 
	`FTABLE_ABIT
(
i
) = 0;

1285 
	`FTABLE_TIME
(
i
) = 0;

1290 #ifdeà
VERBOSE_PAGE_FAULT


1293 
mši_aùiv©ed
 = 1;

1294 
	`Ú_—ch_ıu
(
_’abË_soá_ÿche
, 
NULL
, 1);

1296 
	}
}

1298 
	#MYARRAY_SIZE2
 32

	)

1299 
	$´štx_—ch_vıu
()

1301 
vıu
 *
v
;

1302 
domaš
 *
d
;

1303 
¬¿y
[
MYARRAY_SIZE2
];

1304 
no
;

1306 
i
;

1307 
i
=0;i<12;i++)

1308 
¬¿y
[
i
] = 12-i;

1309 
	`MYXTRACE
(
TRC_MIN_EACH_VCPU
, 12, 
¬¿y
);

1312 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1313 
	`fÜ_—ch_domaš_vıu
(
d
, 
v
) {

1314 
¬¿y
[0] = 
d
->
domaš_id
;

1315 
¬¿y
[1] = 
v
->
vıu_id
;

1316 
¬¿y
[2] = 
v
->
±ouch_couÁ
[0];

1317 
¬¿y
[3] = 
v
->
±ouch_couÁ
[1];

1318 
¬¿y
[4] = 
v
->
±ouch_couÁ
[2];

1319 
¬¿y
[5] = 
v
->
±ouch_couÁ
[3];

1320 
¬¿y
[6] = 
v
->
±ouch_couÁ
[4];

1321 
¬¿y
[7] = 0;

1322 
¬¿y
[8] = 0;

1323 
¬¿y
[9] = 0;

1324 
¬¿y
[10] = 0;

1325 
¬¿y
[11] = 0;

1327 
	`csched_šfo
(
vıu
 *
v
, 
¬¿y
[]);

1328 #ifdeà
ENABLE_BINPACKING


1329 #”rÜ 
TODO


1330 
no
 = 
	`csched_šfo
(
v
, &
¬¿y
[12]);

1332 
no
 = 0;

1334 
	`MYXTRACE
(
TRC_MIN_EACH_VCPU
, 12+
no
, 
¬¿y
);

1335 ià(12+
no
 >ğ
MYARRAY_SIZE2
)

1336 
	`·nic
("SIZE2\n");

1338 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1340 
	}
}

1342 
	$´št_—ch_vıu
()

1344 
vıu
 *
v
;

1345 
domaš
 *
d
;

1346 
¬¿y
[12];

1347 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1348 
	`fÜ_—ch_domaš_vıu
(
d
, 
v
) {

1349 
¬¿y
[0] = 
d
->
domaš_id
;

1350 
¬¿y
[1] = 
v
->
vıu_id
;

1351 
¬¿y
[2] = 
v
->
vcouÁ
[0];

1352 
¬¿y
[3] = 
v
->
vcouÁ
[1];

1353 
¬¿y
[4] = 
v
->
vcouÁ
[2];

1354 
¬¿y
[5] = 
v
->
vcouÁ
[3];

1355 
¬¿y
[6] = 
v
->
vcouÁ
[4];

1356 
¬¿y
[7] = 0;

1357 
¬¿y
[8] = 0;

1358 
¬¿y
[9] = 0;

1359 
¬¿y
[10] = 0;

1360 
¬¿y
[11] = 0;

1362 
	`my´štk
("d%dv%d,…touch:%d=~%d+%d,%d,%d u-sched:%d/%d,%d†oİ-d‘eù:%d\n", 
¬¿y
[0],‡rray[1],‡rray[2],‡rray[3],‡rray[4],‡rray[5],‡rray[6],‡rray[7],‡rray[8],‡rray[9],‡rray[10]);

1364 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1365 
	}
}

1367 
	gusched_´št
;

1369 
	$h—¹b—t
()

1371 
´ev
[
COUNT_MAX
];

1372 
	`my´štk
(

1377 #ifdeà
ENABLE_HOT_PAGES


1380 #ifdeà
ENABLE_HETERO


1384 #ifdeà
ENABLE_MYPROF


1388 , 
pcouÁ
[
COUNT_PAGE_TOUCH_USER
]-
´ev
[COUNT_PAGE_TOUCH_USER]

1389 , 
pcouÁ
[
COUNT_PAGE_TOUCH_KERNEL
]-
´ev
[COUNT_PAGE_TOUCH_KERNEL]

1390 , 
pcouÁ
[
COUNT_SYSCALL
]-
´ev
[COUNT_SYSCALL]

1391 , 
pcouÁ
[
COUNT_USCHED
]-
´ev
[COUNT_USCHED]

1392 , 
pcouÁ
[
COUNT_GLOBALIZE
]-
´ev
[COUNT_GLOBALIZE]

1396 , 
pcouÁ
[
COUNT_CLEAR_ABIT
]-
´ev
[COUNT_CLEAR_ABIT]

1397 , 
	`ACTIVE_FRAMES_CACHE
(0), ACTIVE_FRAMES_CACHE(1)

1398 #ifdeà
ENABLE_MEASURE_UNBALANCE


1399 , 
	`©omic_»ad
(&
ÿchemª
[0].
vıu_couÁ
),‡tomic_read(&cacheman[1].vcpu_count)

1403 #ifdeà
ENABLE_HOT_PAGES


1404 , 
£ed_u£r_hÙ
->
äame_couÁ


1405 , 
	`©omic_»ad
(&
hÙ_·ges_vm
[0])

1406 , 
	`©omic_»ad
(&
hÙ_·ges_vm
[1])

1407 , 
	`©omic_»ad
(&
hÙ_·ges_vm
[2])

1408 , 
	`©omic_»ad
(&
hÙ_·ges_vm
[3])

1410 #ifdeà
ENABLE_HETERO


1411 , 
	`©omic_»ad
(&
h‘”o_·ges_couÁ
)

1412 , 
	`©omic_»ad
(&
h‘”o_·ges_vm
[0]), 
h‘”o_·ges_vm_lim™
[0]

1413 , 
	`©omic_»ad
(&
h‘”o_·ges_vm
[1]), 
h‘”o_·ges_vm_lim™
[1]

1414 , 
	`©omic_»ad
(&
h‘”o_·ges_vm
[2]), 
h‘”o_·ges_vm_lim™
[2]

1415 , 
	`©omic_»ad
(&
h‘”o_·ges_vm
[3]), 
h‘”o_·ges_vm_lim™
[3]

1421 #ifdeà
ENABLE_MYPROF


1422 , 
my_tÙ®_§m¶es


1426 
diff
 = 
pcouÁ
[
COUNT_SYSCALL
]-pcouÁ[
COUNT_SYSRET
];

1427 ià(
diff
 > 
max_´oc
 || diff < -max_proc) {

1428 
	`my´štk
("WARN: sysÿÎ:%d, sy¤‘:%d\n", 
pcouÁ
[
COUNT_SYSCALL
],…couÁ[
COUNT_SYSRET
]);

1433 #ifdeà
ENABLE_MYPROF


1434 
my_tÙ®_§m¶es
 = 0;

1436 
	`memıy
(
´ev
, 
pcouÁ
, (pcount));

1437 
	}
}

1439 
	$´štx_ÿche
(
v”bo£
)

1441 
i
,
j
;

1442 
·ge_dœ
 *
pgd
;

1443 
pgd_couÁ
[
MAX_CACHE
];

1444 
pgd_couÁ_tÙ®
 = 0;

1445 
i
=0;i<
MAX_CACHE
;i++)

1446 
pgd_couÁ
[
i
] = 0;

1448 
	`my¥š_lock
(&
pgd_li¡_lock
, 39);

1449 
	`li¡_fÜ_—ch_’Œy
(
pgd
, &
pgd_li¡
, 
li¡
) {

1452 
	`¥š_uÆock
(&
pgd_li¡_lock
);

1455 
i
=0;i<
MAX_CACHE
;i++) {

1456 
	`TRACE_5D
(
TRC_MIN_CACHE
, 
i
, 
ÿchemª
[i].
size
/4 , cachemª[i].
äames_couÁ
, cachemª[i].
v»giÚs_couÁ
, 
pgd_couÁ
[i] );

1457 
pgd_couÁ_tÙ®
 +ğ
pgd_couÁ
[
i
];

1458 #ifdeà
ENABLE_DENSITY


1459 
¬¿y
[34];

1460 
j
=0;j<32;j++)

1461 
¬¿y
[
j
] = 
ÿchemª
[
i
].
ab™_d’s™y
[j];

1462 
¬¿y
[32] = 
	`ACTIVE_FRAMES_CACHE
(
i
);

1463 
¬¿y
[33] = 
i
;

1464 
	`MYXTRACE
(
TRC_MIN_CACHE_DENSITY
, 34, 
¬¿y
);

1466 #ifdeà
ENABLE_DENSITY


1467 
	`my¥š_lock
(&
pgd_li¡_lock
, 131);

1468 
	`li¡_fÜ_—ch_’Œy
(
pgd
, &
pgd_li¡
, 
li¡
) {

1469 ià(
	`ACTIVE_FRAMES_PGD
(
pgd
, 
i
)) {

1470 
¬¿y
[33] = 
pgd
->
mâ
;

1471 
j
=0;j<32;j++)

1472 
¬¿y
[
j
] = 
	`©omic_»ad
(&
pgd
->
ab™_d’s™y
[
i
][j]);

1473 
¬¿y
[32] = 
	`ACTIVE_FRAMES_PGD
(
pgd
, 
i
);

1474 
	`MYXTRACE
(
TRC_MIN_PGD_DENSITY
, 34, 
¬¿y
);

1477 
	`¥š_uÆock
(&
pgd_li¡_lock
);

1478 
j
=0;j<32;j++)

1479 
¬¿y
[
j
] = 
	`©omic_»ad
(&
ab™_d’s™y_sh¬ed
[
i
][j]);

1480 
¬¿y
[33] = 0;

1481 
¬¿y
[32] = 
	`ACTIVE_FRAMES_SHARED
(
i
);

1482 
	`MYXTRACE
(
TRC_MIN_SHARED_DENSITY
, 34, 
¬¿y
);

1484 
	`´štx_—ch_ÿche
(
i
, 
v”bo£
);

1486 
	`TRACE_1D
(
TRC_MIN_CACHE_PGD_COUNT
, 
pgd_couÁ_tÙ®
);

1488 
	}
}

1490 #ifdeà
ENABLE_GLOBAL_LIST


1491 
	$´št_v»giÚs_£ed
(
æag
, *
couÁ
)

1493 #ifdeà
ENABLE_VREGIONS


1494 
v»giÚ_t
 *
vr
, *
‹mp
;

1495 
v»giÚ_t
 
‹mp_vr
;

1496 
‹mp
 = &
‹mp_vr
;

1497 
‹mp
->
æags
 = ~0UL;

1500 
sk_couÁ
 = 0;

1501 
	`my¥š_lock
(&
v»giÚs_£ed_lock
, 173);

1502 
	`li¡_fÜ_—ch_’Œy
(
vr
, &
v»giÚs_£ed
, 
glob®_li¡
) {

1503 
couÁ
[1]++;

1504 
couÁ
[2] +ğ
vr
->
äame_couÁ
;

1505 
couÁ
[3] +ğ
vr
->
rm­_couÁ
[0];

1506 
couÁ
[4] +ğ
vr
->
rm­_couÁ
[1];

1514 ià(
vr
->
æags
 =ğ
‹mp
->æag && vr->
äame_couÁ
 ==emp->frame_count &&

1515 
vr
->
rm­_couÁ
[0] =ğ
‹mp
->rmap_count[0] &&

1516 
vr
->
rm­_couÁ
[1] =ğ
‹mp
->rmap_count[1]) {

1517 
sk_couÁ
++;

1519 ià(
sk_couÁ
) {

1520 
	`my´štk
("%d sk³d.\n", 
sk_couÁ
);

1521 
sk_couÁ
 = 0;

1523 
	`´št_v»giÚ
(
vr
, 
æag
);

1524 *
‹mp
 = *
vr
;

1535 
	`¥š_uÆock
(&
v»giÚs_£ed_lock
);

1536 ià(
sk_couÁ
) {

1537 
	`my´štk
("%d sk³d.\n", 
sk_couÁ
);

1538 
sk_couÁ
 = 0;

1542 
	}
}

1544 
	$´št_®l_v»giÚs
()

1546 
couÁ
[5];

1547 
	`mem£t
(
couÁ
, 0, (count));

1548 
	`my´štk
(" ---- seed„egions ----\n");

1549 
	`´št_v»giÚs_£ed
(0, 
couÁ
);

1550 
	`my´štk
("..ªd %d 1-·ged glob®, sØ%dv¸%däam%d,%d„m­\n", 
couÁ
[0], count[1], count[2], count[3], count[4]);

1551 
	}
}

1553 
	$´št_®l_v»giÚs
(è{
	}
}

1556 
	$´št_İ’b™_couÁ
(
·ge_dœ
 *
pgd
)

1558 
i
;

1559 
	`MYASSERT
(
pgd
);

1560 
	`´štk
("stat:");

1561 
i
=0;i<
max_ÿche
;i++) {

1562 
	`´štk
("%3d,", 
pgd
->
İ’b™_couÁ
[
i
]);

1564 
	`´štk
("/%d", 
pgd
->
m¬k_couÁ
);

1565 
	}
}

1567 
	$´št_pgd
(
·ge_dœ
 *
pgd
, 
æag
)

1569 
	`my´štk
("pgd:%x(mfn:%5x,%5x)f:%x "

1573 , 
pgd
,…gd->
±
->
mâ
,…gd->
mâ_u£r
,…gd->
æag


1575 , 
	`g‘_comm
(
pgd
->
cu¼’t_k¡ack
)

1578 
	`´št_İ’b™_couÁ
(
pgd
);

1579 
	`´štk
("\n");

1580 
	}
}

1582 
	$´št_pgds
(
v”bo£
)

1584 #ifdeà
ENABLE_PGD


1585 
·ge_dœ
 *
pgd
;

1586 
	`my´štk
("--…gd„eports --\n");

1587 
	`my¥š_lock
(&
pgd_li¡_lock
, 39);

1588 
	`li¡_fÜ_—ch_’Œy
(
pgd
, &
pgd_li¡
, 
li¡
) {

1589 
	`´št_pgd
(
pgd
,0);

1591 
	`¥š_uÆock
(&
pgd_li¡_lock
);

1593 
	}
}

1596 
	$_di§bË_soá_ÿche
(*
šfo
)

1598 
ıu
 = 
	`smp_´oûssÜ_id
();

1600 
	}
}

1602 
	$di§bË_soá_ÿche
()

1604 
»t
 = 0;

1605 
i
;

1606 ià(!
mši_aùiv©ed
) {

1607 
	`my´štk
("already disabled\n");

1608  
»t
;

1610 ià(
mši_di§blšg
)

1611 
	`my·nic
("NO ! mini_disabling");

1612 
mši_di§blšg
 = 1;

1613 
mši_aùiv©ed
 = 0;

1615 
v®ue
;

1616 ià(
v®ue
 = 
	`©omic_»ad
(&
mši_couÁ
)) {

1617 
	`my´štk
("Wa™šg mši_couÁ = %d...", 
v®ue
);

1619 
i
=0;i<
MAX_PLACE
;i++)

1620 
	`´štk
("%d, ", 
	`©omic_»ad
(&
mši_¶aû
[
i
]));

1622 
	`´štk
("\n");

1623 
	`©omic_»ad
(&
mši_couÁ
)) {

1624 
	`ıu_»Ïx
();

1628 
	`my´štk
("==================== DISABLED ======================\n");

1629 
	`Ú_—ch_ıu
(
_di§bË_soá_ÿche
, 
NULL
, 1);

1630 #ifdeà
ENABLE_TRACK_MEMLEAK


1633 #ifdeà
ENABLE_TRACK_SPINLOCK


1634 
	`¥šlock_»pÜt
();

1637 #ifdeà
ENABLE_PGD


1638 
	`d–_®l_pgd
();

1640 
vıu
 *
v
;

1641 
domaš
 *
d
;

1642 
mši_di§blšg
 = 0;

1644 #ifdeà
ENABLE_GLOBAL_LIST


1645 
	`my¥š_lock
(&
v»giÚs_£ed_lock
, 106);

1646 ià(!
	`li¡_em±y
(&
v»giÚs_£ed
)) {

1647 
	`my´štk
("WARN !!!! : still have some vregions_seed??\n");

1649 
	`¥š_uÆock
(&
v»giÚs_£ed_lock
);

1651 #ifdeà
DEBUG_STAT


1652 
	`´št_—ch_vıu
();

1656 
	`my´štk
("after cleaned up\n");

1657 
	`´št_pgds
(1);

1658 
	`´št_®l_v»giÚs
();

1660 #ifdeà
ENABLE_TIMESTAMP


1661 
	`´št_time¡amp
();

1663 #ifdeà
ENABLE_CACHEMAN1


1664 
	`check_ÿchemª_aá”_ş—nup
();

1667 #ifdeà
ENABLE_VREGIONS


1668 
	`check_v¹
();

1675 #ifdeà
ENABLE_VREGIONS


1676 
	`my´štk
("v»giÚs_ä“_couÁ:%d v Üigš®:%d\n", 
v»giÚs_ä“_couÁ
, 
num_v»giÚs_³r_1mb
*
v»giÚ_1mb_poŞ_couÁ
);

1677 ià(
v»giÚs_xm®loc_couÁ
)

1678 
	`my´štk
("WARN! DutØem±y v»giÚs_ä“,ÿÎed xm®loø%dimes. Inü—£…oŞ size!\n", 
v»giÚs_xm®loc_couÁ
);

1681 
j
;

1683 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1684 
	`fÜ_—ch_domaš_vıu
(
d
,
v
) {

1685 
ıumask_t
 
‹mp_ıumask
;

1686 #ifdeà
DEBUG_STAT


1687 
j
=0;j<
PTOUCH_MAX
;j++)

1688 
v
->
vcouÁ
[
j
] = 0;

1690 #ifdeà
ENABLE_PGD


1691 
v
->
cu¼’t_pgd
 = 
NULL
;

1692 
v
->
cu¼’t_k¡ack
 = 
NULL
;

1694 
v
->
de¡_ÿche
 = -1;

1695 
v
->
´št_couÁdown
 = 0;

1697 
	`fÜ_—ch_domaš
(
d
) {

1698 
d
->
k”Ãl_pgd
 = 
NULL
;

1699 
	`¥š_lock_š™
(&
d
->
k”Ãl_pgd_lock
);

1701 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1702 #ifdeà
ENABLE_HETERO


1703 ià(
	`©omic_»ad
(&
h‘”o_·ges_couÁ
) != 0) {

1704 
	`my´štk
("WARNING!‚Ú-z”Øh‘”o_·ges_couÁ = %d\n", 
	`©omic_»ad
(&
h‘”o_·ges_couÁ
));

1707 #ifdeà
ENABLE_TRACK_MEMLEAK


1708 
	`memËak_»pÜt
();

1709 
	`my´št_x’h—p
();

1713 
	}
}

1717 
	$do_myhy³rÿÎ
(
£rviû
, 
·rm2
, 
·rm3
, 
·rm4
, 
·rm5
)

1719 
»t
 = 0;

1723 ià(
£rviû
 == 0x0 || service == 0x1) {

1724 ià(!
mši_aùiv©ed
)

1725 
»t
 = 
	`’abË_soá_ÿche
();

1727 
»t
 = 
	`di§bË_soá_ÿche
();

1728 } ià(
£rviû
 == 0x2) {

1729 
	`my´štk
("£rviû=%d‚Ù defšed!\n", 
£rviû
);

1730 } ià(
£rviû
 == 0x3) {

1732 
	`my´štk
("£rviû=%d‚Ù defšed!\n", 
£rviû
);

1733 } ià(
£rviû
 == 0x4) {

1735 
	`my´štk
("£rviû=%d‚Ù defšed!\n", 
£rviû
);

1736 } ià(
£rviû
 == 0x5) {

1737 #ifdeà
ENABLE_RANGE


1738 ià(
cu¼’t
->
cu¼’t_pgd
) {

1739 
rd
 = 
	`add_gue¡_»giÚ
(
·rm2
, 1);

1740 ià(
rd
) {

1741 
»t
 = 
	`add_¿nge
(
cu¼’t
->
cu¼’t_pgd
, 
·rm2
, 
·rm3
, 
rd
);

1742 
v»giÚ_t
 *
Ãwvr
 = 
g¹
[
rd
].
vr
;

1743 
	`cÚ¡ruù_¿nge_vr
(
·rm2
, 
·rm3
, 
Ãwvr
, 
rd
);

1747 
	`my´štk
("WARN ignore‡dd_range\n");

1749 
	`my´štk
("ENABLE_RANGE„equired!\n");

1751 } ià(
£rviû
 == 0x6) {

1752 #ifdeà
ENABLE_RANGE


1753 ià(
cu¼’t
->
cu¼’t_pgd
) {

1754 
rd
 = 
	`d–_¿nge
(
cu¼’t
->
cu¼’t_pgd
, 
·rm2
, 
·rm3
);

1755 
	`d–_gue¡_»giÚ
(
rd
, 1);

1757 
	`my´štk
("WARN ignore del_range\n");

1759 
	`my´štk
("ENABLE_RANGE„equired!\n");

1761 } ià(
£rviû
 == 0x7) {

1769 } ià(
£rviû
 == 0x8) {

1770 #ifdeà
ENABLE_RANGE


1771 #ifdeà
ENABLE_VREGION_MAPPING


1772 ià(
cu¼’t
->
cu¼’t_pgd
) {

1773 
v»giÚ_t
 *
vr
;

1774 
vr
 = 
g¹
[
cu¼’t
->
cu¼’t_pgd
->
¿nges
[
·rm2
].
rd
].vr;

1775 
	`MYASSERT
(
vr
>ğ
HYPERVISOR_VIRT_START
);

1776 
	`my´štk
("[%d] v¸%°: clo£ cache(%d)\n", 
·rm2
, 
vr
, 
·rm3
);

1777 
	`´št_v»giÚ
(
vr
, 0);

1778 ià(
·rm3
 >ğ0 &&…¬m3 < 
MAX_CACHE
) {

1779 
	`my¥š_lock
(&
vr
->
lock
, 106);

1780 ià(
	`is_v»giÚ_ÿche_m­³d
(
vr
, 
·rm3
)) {

1781 
	`şo£_v»giÚ_ÿche
(
vr
, 
·rm3
);

1783 
	`my´štk
("skip:‡lready closed vr!\n");

1785 
	`¥š_uÆock
(&
vr
->
lock
);

1787 
	`my´štk
("Inv®id cach%d\n", 
·rm3
);

1789 
	`my´štk
("WARN ignore ops_range\n");

1791 
	`my´štk
("ENABLE_VREGION_MAPPING„equired!\n");

1794 
	`my´štk
("ENABLE_RANGE„equired!\n");

1796 #ifdeà
ENABLE_GUEST_REGION


1797 } ià(
£rviû
 == 0xa) {

1798 
»t
 = 
	`add_gue¡_»giÚ
(
·rm2
, 0);

1799 
pcouÁ
[
COUNT_GUEST_API
]++;

1800 } ià(
£rviû
 == 0xb) {

1801 
	`d–_gue¡_»giÚ
(
·rm2
, 1, 
cu¼’t
->
domaš
);

1802 
»t
 = 
·rm2
;

1803 
pcouÁ
[
COUNT_GUEST_API
]++;

1804 } ià(
£rviû
 == 0xc) {

1818 
	`MYASSERT
(
	`maddr_g‘_owÃr
(
·rm2
 << 
PAGE_SHIFT
è=ğ
cu¼’t
->
domaš
);

1819 
	`add_·ge_gue¡_»giÚ
(
·rm2
, 0 , 
·rm4
);

1820 
pcouÁ
[
COUNT_GUEST_API
]++;

1821 } ià(
£rviû
 == 0xd) {

1835 
	`MYASSERT
(
	`maddr_g‘_owÃr
(
·rm2
 << 
PAGE_SHIFT
è=ğ
cu¼’t
->
domaš
);

1836 
	`d–_·ge_gue¡_»giÚ
(
·rm2
, 0 , 
·rm4
);

1837 
pcouÁ
[
COUNT_GUEST_API
]++;

1839 } ià(
£rviû
 == 0xe) {

1840 ifĞ
·rm2
 == 1){

1841 
’abË_³rfmÚ
 = 
·rm3
;

1847  
»t
;

1848 
	}
}

	@mm.c

87 
	~<x’/cÚfig.h
>

88 
	~<x’/š™.h
>

89 
	~<x’/k”Ãl.h
>

90 
	~<x’/lib.h
>

91 
	~<x’/mm.h
>

92 
	~<x’/domaš.h
>

93 
	~<x’/sched.h
>

94 
	~<x’/”ºo.h
>

95 
	~<x’/³rfc.h
>

96 
	~<x’/œq.h
>

97 
	~<x’/soáœq.h
>

98 
	~<x’/domaš_·ge.h
>

99 
	~<x’/ev’t.h
>

100 
	~<x’/ioÿp.h
>

101 
	~<x’/gue¡_acûss.h
>

102 
	~<asm/·gšg.h
>

103 
	~<asm/shadow.h
>

104 
	~<asm/·ge.h
>

105 
	~<asm/æushb.h
>

106 
	~<asm/io.h
>

107 
	~<asm/ldt.h
>

108 
	~<asm/x86_emuÏ‹.h
>

109 
	~<asm/e820.h
>

110 
	~<asm/hy³rÿÎ.h
>

111 
	~<asm/sh¬ed.h
>

112 
	~<public/memÜy.h
>

113 
	~<public/sched.h
>

114 
	~<xsm/xsm.h
>

115 
	~<x’/Œaû.h
>

116 
	~<asm/£tup.h
>

117 
	~<asm/fixm­.h
>

118 
	~<asm/mem_sh¬šg.h
>

119 
	~<mši.h
>

126 
l1_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

127 
	gl1_id’tm­
[
L1_PAGETABLE_ENTRIES
];

129 
	#MEM_LOG
(
_f
, 
_a
...è
	`gd´štk
(
XENLOG_WARNING
 , _à"\n" , ## _a)

	)

136 #ià!
defšed
(
NDEBUG
è|| defšed(
__i386__
)

137 
	#PTE_UPDATE_WITH_CMPXCHG


	)

140 
boŞ_t
 
__»ad_mo¡ly
 
	gmem_hÙ¶ug
 = 0;

143 
domaš
 *
	gdom_x’
, *
	gdom_io
, *
	gdom_cow
;

146 
	gmax_·ge
;

147 
	gtÙ®_·ges
;

149 
__»ad_mo¡ly
 
	gpdx_group_v®id
[
BITS_TO_LONGS
(

150 (
FRAMETABLE_SIZE
 / (*
äame_bË
è+ 
PDX_GROUP_COUNT
 - 1)

151 / 
PDX_GROUP_COUNT
)] = { [0] = 1 };

153 
	#PAGE_CACHE_ATTRS
 (
_PAGE_PAT
|
_PAGE_PCD
|
_PAGE_PWT
)

	)

155 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_®low_su³½age
;

156 
boŞ—n_·¿m
("®lowsu³½age", 
İt_®low_su³½age
);

158 #ifdeà
__i386__


159 
g‘_su³½age
(
mâ
, 
domaš
 *
d
);

161 
put_su³½age
(
mâ
);

163 
	#l1_di§Îow_mask
(
d
) \

164 ((
d
 !ğ
dom_io
) && \

165 (
	`¿nge£t_is_em±y
((
d
)->
iomem_ÿps
) && \

166 
	`¿nge£t_is_em±y
((
d
)->
¬ch
.
iİÜt_ÿps
) && \

167 !
	`has_¬ch_pdevs
(
d
) && \

168 !
	`is_hvm_domaš
(
d
)) ? \

169 
L1_DISALLOW_MASK
 : (L1_DISALLOW_MASK & ~
PAGE_CACHE_ATTRS
))

	)

171 #ifdeà
__x86_64__


172 
l2_pg’Œy_t
 *
	gcom·t_idË_pg_bË_l2
 = 
NULL
;

173 
	#l3_di§Îow_mask
(
d
è(!
	`is_pv_32Ú64_domaš
(d) ? \

174 
L3_DISALLOW_MASK
 : \

175 
COMPAT_L3_DISALLOW_MASK
)

	)

177 
	#l3_di§Îow_mask
(
d
è
L3_DISALLOW_MASK


	)

180 #ifdeà
__x86_64__


181 
__š™
 
	$š™_¥ag‘abË
()

183 
s
, 
¡¬t
 = 
SPAGETABLE_VIRT_START
;

184 
’d
 = 
SPAGETABLE_VIRT_END
;

185 
¡•
, 
mâ
;

186 
max_’Œ›s
;

188 
¡•
 = 1UL << 
PAGETABLE_ORDER
;

189 
max_’Œ›s
 = (
max_pdx
 + ((1UL<<
SUPERPAGE_ORDER
)-1)) >> SUPERPAGE_ORDER;

190 
’d
 = 
¡¬t
 + (((
max_’Œ›s
 * (*
¥age_bË
)) +

191 ((1UL<<
SUPERPAGE_SHIFT
)-1)) & (~((1UL<<SUPERPAGE_SHIFT)-1)));

193 
s
 = 
¡¬t
; s < 
’d
; s +ğ
¡•
 << 
PAGE_SHIFT
)

195 
mâ
 = 
	`®loc_boÙ_·ges
(
¡•
, step);

196 iàĞ!
mâ
 )

197 
	`·nic
("Notƒnough memory for spageable");

198 
	`m­_·ges_to_x’
(
s
, 
mâ
, 
¡•
, 
PAGE_HYPERVISOR
);

200 
	`mem£t
((*)
¡¬t
, 0, 
’d
 - start);

201 
	}
}

204 
__š™
 
	$š™_äam‘abË_chunk
(*
¡¬t
, *
’d
)

206 
s
 = ()
¡¬t
;

207 
e
 = ()
’d
;

208 
¡•
, 
mâ
;

210 
	`ASSERT
(!(
s
 & ((1 << 
L2_PAGETABLE_SHIFT
) - 1)));

211  ; 
s
 < 
e
; s +ğ
¡•
 << 
PAGE_SHIFT
 )

213 
¡•
 = 1UL << (
ıu_has_·ge1gb
 &&

214 !(
s
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1)) ?

215 
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
 :

216 
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

221  
¡•
 && 
s
 + (¡• << 
PAGE_SHIFT
è> 
e
 + (4 << PAGE_SHIFT) )

222 
¡•
 >>ğ
PAGETABLE_ORDER
;

224 
mâ
 = 
	`®loc_boÙ_·ges
(
¡•
, step);

225 }  !
mâ
 && (
¡•
 >>ğ
PAGETABLE_ORDER
) );

226 iàĞ!
mâ
 )

227 
	`·nic
("Notƒnough memory for frameable");

228 
	`m­_·ges_to_x’
(
s
, 
mâ
, 
¡•
, 
PAGE_HYPERVISOR
);

231 
	`mem£t
(
¡¬t
, 0, 
’d
 - start);

232 
	`mem£t
(
’d
, -1, 
s
 - ()end);

233 
	}
}

235 
__š™
 
	$š™_äam‘abË
()

237 
sidx
, 
eidx
, 
nidx
;

238 
max_idx
 = (
max_pdx
 + 
PDX_GROUP_COUNT
 - 1) / PDX_GROUP_COUNT;

240 #ifdeà
__x86_64__


241 
	`BUILD_BUG_ON
(
XEN_VIRT_END
 > 
FRAMETABLE_VIRT_END
);

243 
	`BUILD_BUG_ON
(
FRAMETABLE_VIRT_START
 & ((1UL << 
L2_PAGETABLE_SHIFT
) - 1));

245  
sidx
 = 0; ; sidx = 
nidx
 )

247 
eidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
max_idx
, 
sidx
);

248 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
max_idx
, 
eidx
);

249 iàĞ
nidx
 >ğ
max_idx
 )

251 
	`š™_äam‘abË_chunk
(
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
),

252 
	`pdx_to_·ge
(
eidx
 * 
PDX_GROUP_COUNT
));

254 iàĞ!
mem_hÙ¶ug
 )

255 
	`š™_äam‘abË_chunk
(
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
),

256 
	`pdx_to_·ge
(
max_pdx
 - 1) + 1);

259 
	`š™_äam‘abË_chunk
(
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
),

260 
	`pdx_to_·ge
(
max_idx
 * 
PDX_GROUP_COUNT
 - 1) + 1);

261 
	`mem£t
(
	`pdx_to_·ge
(
max_pdx
), -1,

262 ()
	`pdx_to_·ge
(
max_idx
 * 
PDX_GROUP_COUNT
) -

263 ()
	`pdx_to_·ge
(
max_pdx
));

265 #ifdeà
__x86_64__


266 ià(
İt_®low_su³½age
)

267 
	`š™_¥ag‘abË
();

269 
	}
}

271 
__š™
 
	$¬ch_š™_memÜy
()

273 
i
, 
pâ
, 
r¡¬t_pâ
, 
»nd_pâ
, 
io¡¬t_pâ
, 
iÛnd_pâ
;

280 
dom_x’
 = 
	`domaš_ü—‹
(
DOMID_XEN
, 
DOMCRF_dummy
, 0);

281 
	`BUG_ON
(
dom_x’
 =ğ
NULL
);

288 
dom_io
 = 
	`domaš_ü—‹
(
DOMID_IO
, 
DOMCRF_dummy
, 0);

289 
	`BUG_ON
(
dom_io
 =ğ
NULL
);

295 
dom_cow
 = 
	`domaš_ü—‹
(
DOMID_COW
, 
DOMCRF_dummy
, 0);

296 
	`BUG_ON
(
dom_cow
 =ğ
NULL
);

299  
i
 = 0; i < 0x100; i++ )

300 
	`sh¬e_x’_·ge_w™h_gue¡
(
	`mâ_to_·ge
(
i
), 
dom_io
, 
XENSHARE_wr™abË
);

303  
i
 = 0, 
pâ
 = 0;…â < 
max_·ge
; i++ )

305  (
i
 < 
e820
.
Ä_m­
) &&

306 (
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
) &&

307 (
e820
.
m­
[
i
].
ty³
 !ğ
E820_UNUSABLE
) )

308 
i
++;

310 iàĞ
i
 >ğ
e820
.
Ä_m­
 )

313 
r¡¬t_pâ
 = 
»nd_pâ
 = 
max_·ge
;

318 
r¡¬t_pâ
 = 
	`mš_t
(, 
max_·ge
,

319 
	`PFN_UP
(
e820
.
m­
[
i
].
addr
));

320 
»nd_pâ
 = 
	`max_t
(, 
r¡¬t_pâ
,

321 
	`PFN_DOWN
(
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
));

329 
io¡¬t_pâ
 = 
	`max_t
(, 
pâ
, 1UL << (20 - 
PAGE_SHIFT
));

330 #ià
	`defšed
(
CONFIG_X86_32
)

331 
iÛnd_pâ
 = 
	`mš_t
(, 
r¡¬t_pâ
,

332 
DIRECTMAP_MBYTES
 << (20 - 
PAGE_SHIFT
));

334 
iÛnd_pâ
 = 
	`mš
(
r¡¬t_pâ
, 16UL << (20 - 
PAGE_SHIFT
));

336 iàĞ
io¡¬t_pâ
 < 
iÛnd_pâ
 )

337 
	`de¡roy_x’_m­pšgs
(()
	`mâ_to_vœt
(
io¡¬t_pâ
),

338 ()
	`mâ_to_vœt
(
iÛnd_pâ
));

341  ; 
pâ
 < 
r¡¬t_pâ
;…fn++ )

343 iàĞ!
	`mâ_v®id
(
pâ
) )

345 
	`sh¬e_x’_·ge_w™h_gue¡
(

346 
	`mâ_to_·ge
(
pâ
), 
dom_io
, 
XENSHARE_wr™abË
);

350 
pâ
 = 
»nd_pâ
;

353 
	`sub¬ch_š™_memÜy
();

355 
	`mem_sh¬šg_š™
();

356 
	}
}

358 
	$·ge_is_¿m_ty³
(
mâ
, 
mem_ty³
)

360 
ušt64_t
 
maddr
 = 
	`pâ_to_·ddr
(
mâ
);

361 
i
;

363  
i
 = 0; i < 
e820
.
Ä_m­
; i++ )

365  
e820
.
m­
[
i
].
ty³
 )

367 
E820_RAM
:

368 iàĞ
mem_ty³
 & 
RAM_TYPE_CONVENTIONAL
 )

371 
E820_RESERVED
:

372 iàĞ
mem_ty³
 & 
RAM_TYPE_RESERVED
 )

375 
E820_UNUSABLE
:

376 iàĞ
mem_ty³
 & 
RAM_TYPE_UNUSABLE
 )

379 
E820_ACPI
:

380 
E820_NVS
:

381 iàĞ
mem_ty³
 & 
RAM_TYPE_ACPI
 )

390 iàĞ(
e820
.
m­
[
i
].
addr
 <ğ
maddr
) &&

391 ((
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
è>ğ(
maddr
 + 
PAGE_SIZE
)) )

396 
	}
}

398 
	$domaš_g‘_maximum_gpâ
(
domaš
 *
d
)

400 iàĞ
	`is_hvm_domaš
(
d
) )

401  
	`p2m_g‘_ho¡p2m
(
d
)->
max_m­³d_pâ
;

403  
	`¬ch_g‘_max_pâ
(
d
) - 1;

404 
	}
}

406 
	$sh¬e_x’_·ge_w™h_gue¡
(

407 
·ge_šfo
 *
·ge
, 
domaš
 *
d
, 
»adÚly
)

409 iàĞ
	`·ge_g‘_owÃr
(
·ge
è=ğ
d
 )

412 
	`£t_gpâ_äom_mâ
(
	`·ge_to_mâ
(
·ge
), 
INVALID_M2P_ENTRY
);

414 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

417 
·ge
->
u
.
šu£
.
ty³_šfo
 = (
»adÚly
 ? 
PGT_nÚe
 : 
PGT_wr™abË_·ge
);

418 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_v®id©ed
 | 1;

420 
	`·ge_£t_owÃr
(
·ge
, 
d
);

421 
	`wmb
();

422 
	`ASSERT
((
·ge
->
couÁ_šfo
 & ~
PGC_x’_h—p
) == 0);

425 iàĞ!
d
->
is_dyšg
 )

427 
·ge
->
couÁ_šfo
 |ğ
PGC_®loÿ‹d
 | 1;

428 iàĞ
	`uÆik–y
(
d
->
x’h—p_·ges
++ == 0) )

429 
	`g‘_knowÇlive_domaš
(
d
);

430 
	`·ge_li¡_add_
(
·ge
, &
d
->
x’·ge_li¡
);

433 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

434 
	}
}

436 
	$sh¬e_x’_·ge_w™h_´iveged_gue¡s
(

437 
·ge_šfo
 *
·ge
, 
»adÚly
)

439 
	`sh¬e_x’_·ge_w™h_gue¡
(
·ge
, 
dom_x’
, 
»adÚly
);

440 
	}
}

442 #ià
defšed
(
__i386__
)

444 #ifdeà
NDEBUG


446 
	#l3b_Ãeds_shadow
(
mâ
è((mâè>ğ0x100000)

	)

454 
	#l3b_Ãeds_shadow
(
mâ
) \

455 (((((
mâ
è<< 
PAGE_SHIFT
è!ğ
	`__·
(
idË_pg_bË
)) && \

456 (
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & 
PGC_couÁ_mask
) && \

457 ((
mâ
) & 1)) || \

458 ((
mâ
è>ğ0x100000))

	)

461 
l1_pg’Œy_t
 *
	gfix_·e_highmem_¶1e
;

464 
__š™
 
	$ÿche_·e_fixm­_add»ss
()

466 
fixm­_ba£
 = 
	`fix_to_vœt
(
FIX_PAE_HIGHMEM_0
);

467 
l2_pg’Œy_t
 *
¶2e
 = 
	`vœt_to_x’_l2e
(
fixm­_ba£
);

468 
fix_·e_highmem_¶1e
 = 
	`l2e_to_l1e
(*
¶2e
è+ 
	`l1_bË_off£t
(
fixm­_ba£
);

470 
	}
}

471 
__š™ÿÎ
(
ÿche_·e_fixm­_add»ss
);

473 
DEFINE_PER_CPU
(
u32
, 
make_ü3_time¡amp
);

475 
	$make_ü3
(
vıu
 *
v
, 
mâ
)

479 
l3_pg’Œy_t
 *
highmem_l3b
, *
lowmem_l3b
;

480 
·e_l3_ÿche
 *
ÿche
 = &
v
->
¬ch
.pae_l3_cache;

481 
ıu
 = 
	`smp_´oûssÜ_id
();

484 iàĞ!
	`l3b_Ãeds_shadow
(
mâ
) )

486 
v
->
¬ch
.
ü3
 = 
mâ
 << 
PAGE_SHIFT
;

488 
ÿche
->
high_mâ
 = 0;

493 
	`ASSERT
(!
	`š_œq
());

496 
	`¥š_lock
(&
ÿche
->
lock
);

498 
ÿche
->
šu£_idx
 ^= 1;

499 
ÿche
->
high_mâ
 = 
mâ
;

502 
	`l1e_wr™e
(
fix_·e_highmem_¶1e
-
ıu
, 
	`l1e_äom_pâ
(
mâ
, 
__PAGE_HYPERVISOR
));

505 iàĞ
	`uÆik–y
(
	`this_ıu
(
make_ü3_time¡amp
è=ğthis_ıu(
bæush_time
)) )

506 
	`æush_b_Úe_loÿl
(
	`fix_to_vœt
(
FIX_PAE_HIGHMEM_0
 + 
ıu
));

507 
highmem_l3b
 = (
l3_pg’Œy_t
 *)
	`fix_to_vœt
(
FIX_PAE_HIGHMEM_0
 + 
ıu
);

508 
lowmem_l3b
 = 
ÿche
->
bË
[ÿche->
šu£_idx
];

509 
	`memıy
(
lowmem_l3b
, 
highmem_l3b
, (
ÿche
->
bË
[0]));

510 
	`l1e_wr™e
(
fix_·e_highmem_¶1e
-
ıu
, 
	`l1e_em±y
());

511 
	`this_ıu
(
make_ü3_time¡amp
èğthis_ıu(
bæush_time
);

513 
v
->
¬ch
.
ü3
 = 
	`__·
(
lowmem_l3b
);

515 
	`¥š_uÆock
(&
ÿche
->
lock
);

516 
	}
}

520 
	$make_ü3
(
vıu
 *
v
, 
mâ
)

522 
v
->
¬ch
.
ü3
 = 
mâ
 << 
PAGE_SHIFT
;

523 
	}
}

527 
	$wr™e_±ba£
(
vıu
 *
v
)

529 
	`wr™e_ü3
(
v
->
¬ch
.
ü3
);

530 
	}
}

540 
	$upd©e_ü3
(
vıu
 *
v
)

542 
ü3_mâ
=0;

544 iàĞ
	`·gšg_mode_’abËd
(
v
->
domaš
) )

546 
	`·gšg_upd©e_ü3
(
v
);

550 #ià
CONFIG_PAGING_LEVELS
 == 4

551 iàĞ!(
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) )

552 
ü3_mâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË_u£r
);

555 
ü3_mâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
);

557 
	`make_ü3
(
v
, 
ü3_mâ
);

558 
	}
}

561 
	$šv®id©e_shadow_ldt
(
vıu
 *
v
, 
æush
)

563 
i
;

564 
pâ
;

565 
·ge_šfo
 *
·ge
;

567 
	`BUG_ON
(
	`uÆik–y
(
	`š_œq
()));

569 
	`¥š_lock
(&
v
->
¬ch
.
shadow_ldt_lock
);

571 iàĞ
v
->
¬ch
.
shadow_ldt_m­út
 == 0 )

572 
out
;

574 
v
->
¬ch
.
shadow_ldt_m­út
 = 0;

576  
i
 = 16; i < 32; i++ )

578 
pâ
 = 
	`l1e_g‘_pâ
(
v
->
¬ch
.
³rdomaš_±es
[
i
]);

579 iàĞ
pâ
 == 0 ) ;

580 
	`l1e_wr™e
(&
v
->
¬ch
.
³rdomaš_±es
[
i
], 
	`l1e_em±y
());

581 
·ge
 = 
	`mâ_to_·ge
(
pâ
);

582 
	`ASSERT_PAGE_IS_TYPE
(
·ge
, 
PGT_£g_desc_·ge
);

583 
	`ASSERT_PAGE_IS_DOMAIN
(
·ge
, 
v
->
domaš
);

584 
	`put_·ge_ªd_ty³
(
·ge
);

588 iàĞ
æush
 )

589 
	`æush_b_mask
(&
v
->
vıu_dœty_ıumask
);

591 
out
:

592 
	`¥š_uÆock
(&
v
->
¬ch
.
shadow_ldt_lock
);

593 
	}
}

596 
	$®loc_£gdesc_·ge
(
·ge_šfo
 *
·ge
)

598 
desc_¡ruù
 *
descs
;

599 
i
;

601 
descs
 = 
	`__m­_domaš_·ge
(
·ge
);

603  
i
 = 0; i < 512; i++ )

604 iàĞ
	`uÆik–y
(!
	`check_desütÜ
(
	`·ge_g‘_owÃr
(
·ge
), &
descs
[
i
])) )

605 
ç
;

607 
	`unm­_domaš_·ge
(
descs
);

610 
ç
:

611 
	`unm­_domaš_·ge
(
descs
);

612  -
EINVAL
;

613 
	}
}

617 
	$m­_ldt_shadow_·ge
(
off
)

619 
vıu
 *
v
 = 
cu¼’t
;

620 
domaš
 *
d
 = 
v
->domain;

621 
gmâ
, 
mâ
;

622 
l1_pg’Œy_t
 
l1e
, 
Æ1e
;

623 
gva
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_ba£
 + (
off
 << 
PAGE_SHIFT
);

624 
okay
;

626 
	`BUG_ON
(
	`uÆik–y
(
	`š_œq
()));

628 
	`gue¡_g‘_eff_k”n_l1e
(
v
, 
gva
, &
l1e
);

629 iàĞ
	`uÆik–y
(!(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_PRESENT
)) )

632 
gmâ
 = 
	`l1e_g‘_pâ
(
l1e
);

633 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

634 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
mâ
)) )

637 
okay
 = 
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_£g_desc_·ge
);

638 iàĞ
	`uÆik–y
(!
okay
) )

641 
Æ1e
 = 
	`l1e_äom_pâ
(
mâ
, 
	`l1e_g‘_æags
(
l1e
è| 
_PAGE_RW
);

643 
	`¥š_lock
(&
v
->
¬ch
.
shadow_ldt_lock
);

644 
	`l1e_wr™e
(&
v
->
¬ch
.
³rdomaš_±es
[
off
 + 16], 
Æ1e
);

645 
v
->
¬ch
.
shadow_ldt_m­út
++;

646 
	`¥š_uÆock
(&
v
->
¬ch
.
shadow_ldt_lock
);

649 
	}
}

652 
	$g‘_·ge_äom_·g’r
(
·ge_Ä
, 
domaš
 *
d
)

654 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
·ge_Ä
);

656 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
·ge_Ä
)è|| uÆik–y(!
	`g‘_·ge
(
·ge
, 
d
)) )

658 
	`MEM_LOG
("Could‚Ù g‘…ag»àfÜ…â %lx", 
·ge_Ä
);

663 
	}
}

666 
	$g‘_·ge_ªd_ty³_äom_·g’r
(
·ge_Ä
,

667 
ty³
,

668 
domaš
 *
d
,

669 
·¹Ÿl
,

670 
´“m±ibË
)

672 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
·ge_Ä
);

673 
rc
;

675 iàĞ
	`lik–y
(
·¹Ÿl
 >= 0) &&

676 
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
·ge_Ä
, 
d
)) )

677  -
EINVAL
;

679 
rc
 = (
´“m±ibË
 ?

680 
	`g‘_·ge_ty³_´“m±ibË
(
·ge
, 
ty³
) :

681 (
	`g‘_·ge_ty³
(
·ge
, 
ty³
è? 0 : -
EINVAL
));

683 iàĞ
	`uÆik–y
(
rc
è&& 
·¹Ÿl
 >= 0 )

684 
	`put_·ge
(
·ge
);

686  
rc
;

687 
	}
}

689 #ifdeà
__x86_64__


690 
	$put_d©a_·ge
(

691 
·ge_šfo
 *
·ge
, 
wr™—bË
)

693 iàĞ
wr™—bË
 )

694 
	`put_·ge_ªd_ty³
(
·ge
);

696 
	`put_·ge
(
·ge
);

697 
	}
}

712 
	#defše_g‘_lš—r_·g‘abË
(
Ëv–
) \

714 
g‘_
##
Ëv–
##
	`_lš—r_·g‘abË
( \

715 
Ëv–
##
_pg’Œy_t
 
pde
, 
pde_pâ
, 
domaš
 *
d
) \

717 
x
, 
y
; \

718 
·ge_šfo
 *
·ge
; \

719 
pâ
; \

721 iàĞ(
Ëv–
##
	`e_g‘_æags
(
pde
è& 
_PAGE_RW
) ) \

723 
	`MEM_LOG
("Attempto create†inear….t. with write…erms"); \

727 iàĞ(
pâ
 = 
Ëv–
##
	`e_g‘_pâ
(
pde
)è!ğ
pde_pâ
 ) \

730 iàĞ
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
pâ
, 
d
)) ) \

737 
·ge
 = 
	`mâ_to_·ge
(
pâ
); \

738 
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
; \

740 
x
 = 
y
; \

741 iàĞ
	`uÆik–y
((
x
 & 
PGT_couÁ_mask
) == PGT_count_mask) || \

742 
	`uÆik–y
((
x
 & (
PGT_ty³_mask
|
PGT_v®id©ed
)) != \

743 (
PGT_
##
Ëv–
##
_·ge_bË
|
PGT_v®id©ed
)) ) \

745 
	`put_·ge
(
·ge
); \

749  (
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
, x + 1)) != x ); \

753 }

	)

756 
	$is_iomem_·ge
(
mâ
)

758 
·ge_šfo
 *
·ge
;

760 iàĞ!
	`mâ_v®id
(
mâ
) )

764 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

765 
	`ASSERT
((
·ge
->
couÁ_šfo
 & 
PGC_couÁ_mask
) != 0);

767  (
	`·ge_g‘_owÃr
(
·ge
è=ğ
dom_io
);

768 
	}
}

770 
	$upd©e_x’_m­pšgs
(
mâ
, 
ÿch—‰r
)

772 
”r
 = 0;

773 #ifdeà
__x86_64__


774 
boŞ_t
 
®Ÿs
 = 
mâ
 >ğ
	`PFN_DOWN
(
x’_phys_¡¬t
) &&

775 
mâ
 < 
	`PFN_UP
(
x’_phys_¡¬t
 + ()
_’d
 - 
XEN_VIRT_START
);

776 
x’_va
 =

777 
XEN_VIRT_START
 + ((
mâ
 - 
	`PFN_DOWN
(
x’_phys_¡¬t
)è<< 
PAGE_SHIFT
);

779 iàĞ
	`uÆik–y
(
®Ÿs
è&& 
ÿch—‰r
 )

780 
”r
 = 
	`m­_·ges_to_x’
(
x’_va
, 
mâ
, 1, 0);

781 iàĞ!
”r
 )

782 
”r
 = 
	`m­_·ges_to_x’
(()
	`mâ_to_vœt
(
mâ
), mfn, 1,

783 
PAGE_HYPERVISOR
 | 
	`ÿch—‰r_to_±e_æags
(
ÿch—‰r
));

784 iàĞ
	`uÆik–y
(
®Ÿs
è&& !
ÿch—‰r
 && !
”r
 )

785 
”r
 = 
	`m­_·ges_to_x’
(
x’_va
, 
mâ
, 1, 
PAGE_HYPERVISOR
);

787  
”r
;

788 
	}
}

791 
	$g‘_·ge_äom_l1e
(

792 
l1_pg’Œy_t
 
l1e
, 
domaš
 *
l1e_owÃr
, domaš *
pg_owÃr
)

794 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

795 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
mâ
);

796 
ušt32_t
 
l1f
 = 
	`l1e_g‘_æags
(
l1e
);

797 
vıu
 *
cu¼
 = 
cu¼’t
;

798 
domaš
 *
»®_pg_owÃr
;

799 
boŞ_t
 
wr™e
;

801 iàĞ!(
l1f
 & 
_PAGE_PRESENT
) )

804 iàĞ
	`uÆik–y
(
l1f
 & 
	`l1_di§Îow_mask
(
l1e_owÃr
)) )

806 
	`MEM_LOG
("Bad L1 fÏg %x", 
l1f
 & 
	`l1_di§Îow_mask
(
l1e_owÃr
));

810 iàĞ!
	`mâ_v®id
(
mâ
) ||

811 (
»®_pg_owÃr
 = 
	`·ge_g‘_owÃr_ªd_»ã»nû
(
·ge
)è=ğ
dom_io
 )

814 iàĞ
	`mâ_v®id
(
mâ
) )

815 
	`put_·ge
(
·ge
);

818 iàĞ
pg_owÃr
 =ğ
dom_io
 )

819 
pg_owÃr
 = 
cu¼
->
domaš
;

821 iàĞ!
	`iomem_acûss_³rm™‹d
(
pg_owÃr
, 
mâ
, mfn) )

823 iàĞ
mâ
 !ğ(
PADDR_MASK
 >> 
PAGE_SHIFT
) )

824 
	`MEM_LOG
("Non-privileged (%u)‡ttempto map I/O space %08lx",

825 
pg_owÃr
->
domaš_id
, 
mâ
);

829 iàĞ!(
l1f
 & 
_PAGE_RW
è|| 
	`IS_PRIV
(
pg_owÃr
) ||

830 !
	`¿nge£t_cÚšs_sšgËtÚ
(
mmio_ro_¿nges
, 
mâ
) )

832 
	`d´štk
(
XENLOG_G_WARNING
,

834 
l1e_owÃr
->
domaš_id
, 
mâ
);

838 iàĞ
	`uÆik–y
(
»®_pg_owÃr
 !ğ
pg_owÃr
) )

846 iàĞ(
»®_pg_owÃr
 =ğ
NULL
è|| (
pg_owÃr
 =ğ
l1e_owÃr
) ||

847 !
	`IS_PRIV_FOR
(
pg_owÃr
, 
»®_pg_owÃr
) )

848 
could_nÙ_pš
;

849 
pg_owÃr
 = 
»®_pg_owÃr
;

856 
wr™e
 = (
l1f
 & 
_PAGE_RW
) &&

857 ((
l1e_owÃr
 =ğ
pg_owÃr
è|| !
	`·gšg_mode_ex‹º®
(pg_owner));

858 iàĞ
wr™e
 && !
	`g‘_·ge_ty³
(
·ge
, 
PGT_wr™abË_·ge
) )

859 
could_nÙ_pš
;

861 iàĞ
	`±e_æags_to_ÿch—‰r
(
l1f
) !=

862 ((
·ge
->
couÁ_šfo
 & 
PGC_ÿch—‰r_mask
è>> 
PGC_ÿch—‰r_ba£
) )

864 
x
, 
nx
, 
y
 = 
·ge
->
couÁ_šfo
;

865 
ÿch—‰r
 = 
	`±e_æags_to_ÿch—‰r
(
l1f
);

867 iàĞ
	`is_x’_h—p_·ge
(
·ge
) )

869 iàĞ
wr™e
 )

870 
	`put_·ge_ty³
(
·ge
);

871 
	`put_·ge
(
·ge
);

872 
	`MEM_LOG
("Attempto change cache‡ttributes of Xen heap…age");

877 
x
 = 
y
;

878 
nx
 = (
x
 & ~
PGC_ÿch—‰r_mask
è| (
ÿch—‰r
 << 
PGC_ÿch—‰r_ba£
);

879 }  (
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, 
nx
)) != x );

881 iàĞ
	`uÆik–y
(
	`upd©e_x’_m­pšgs
(
mâ
, 
ÿch—‰r
) != 0) )

883 
ÿch—‰r
 = 
y
 & 
PGC_ÿch—‰r_mask
;

885 
x
 = 
y
;

886 
nx
 = (
x
 & ~
PGC_ÿch—‰r_mask
è| 
ÿch—‰r
;

887 }  (
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, 
nx
)) != x );

889 iàĞ
wr™e
 )

890 
	`put_·ge_ty³
(
·ge
);

891 
	`put_·ge
(
·ge
);

893 
	`MEM_LOG
("Error updating mappings for mfn %lx (pfn %lx,"

894 " from L1ƒÁry %" 
PRI±e
 ") for %d",

895 
mâ
, 
	`g‘_gpâ_äom_mâ
(mfn),

896 
	`l1e_g‘_š‹
(
l1e
), 
l1e_owÃr
->
domaš_id
);

903 
could_nÙ_pš
:

904 
	`MEM_LOG
("E¼Ü g‘tšg mâ %lx (pâ %lxèäom L1ƒÁry %" 
PRI±e


906 
mâ
, 
	`g‘_gpâ_äom_mâ
(mfn),

907 
	`l1e_g‘_š‹
(
l1e
), 
l1e_owÃr
->
domaš_id
, 
pg_owÃr
->domain_id);

908 iàĞ
»®_pg_owÃr
 !ğ
NULL
 )

909 
	`put_·ge
(
·ge
);

911 
	}
}

915 
defše_g‘_lš—r_·g‘abË
(
l2
);

917 
	$g‘_·ge_äom_l2e
(

918 
l2_pg’Œy_t
 
l2e
, 
pâ
, 
domaš
 *
d
)

920 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

921 
rc
;

923 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

926 iàĞ
	`uÆik–y
((
	`l2e_g‘_æags
(
l2e
è& 
L2_DISALLOW_MASK
)) )

928 
	`MEM_LOG
("Bad L2 fÏg %x", 
	`l2e_g‘_æags
(
l2e
è& 
L2_DISALLOW_MASK
);

929  -
EINVAL
;

932 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) )

934 
rc
 = 
	`g‘_·ge_ªd_ty³_äom_·g’r
(
mâ
, 
PGT_l1_·ge_bË
, 
d
, 0, 0);

935 iàĞ
	`uÆik–y
(
rc
 =ğ-
EINVAL
è&& 
	`g‘_l2_lš—r_·g‘abË
(
l2e
, 
pâ
, 
d
) )

936 
rc
 = 0;

937  
rc
;

940 iàĞ!
İt_®low_su³½age
 )

942 
	`MEM_LOG
("Attempto map superpage without‡llowsuperpage "

944  -
EINVAL
;

947 iàĞ
mâ
 & (
L1_PAGETABLE_ENTRIES
-1) )

949 
	`MEM_LOG
("UÇligÃd su³½agm­‡‰em± mâ %lx", 
mâ
);

950  -
EINVAL
;

953  
	`g‘_su³½age
(
mâ
, 
d
);

954 
	}
}

957 
defše_g‘_lš—r_·g‘abË
(
l3
);

959 
	$g‘_·ge_äom_l3e
(

960 
l3_pg’Œy_t
 
l3e
, 
pâ
, 
domaš
 *
d
, 
·¹Ÿl
, 
´“m±ibË
)

962 
rc
;

964 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

967 iàĞ
	`uÆik–y
((
	`l3e_g‘_æags
(
l3e
è& 
	`l3_di§Îow_mask
(
d
))) )

969 
	`MEM_LOG
("Bad L3 fÏg %x", 
	`l3e_g‘_æags
(
l3e
è& 
	`l3_di§Îow_mask
(
d
));

970  -
EINVAL
;

973 
rc
 = 
	`g‘_·ge_ªd_ty³_äom_·g’r
(

974 
	`l3e_g‘_pâ
(
l3e
), 
PGT_l2_·ge_bË
, 
d
, 
·¹Ÿl
, 
´“m±ibË
);

975 iàĞ
	`uÆik–y
(
rc
 =ğ-
EINVAL
è&& 
	`g‘_l3_lš—r_·g‘abË
(
l3e
, 
pâ
, 
d
) )

976 
rc
 = 0;

978  
rc
;

979 
	}
}

981 #ià
CONFIG_PAGING_LEVELS
 >= 4

982 
defše_g‘_lš—r_·g‘abË
(
l4
);

984 
	$g‘_·ge_äom_l4e
(

985 
l4_pg’Œy_t
 
l4e
, 
pâ
, 
domaš
 *
d
, 
·¹Ÿl
, 
´“m±ibË
)

987 
rc
;

989 iàĞ!(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
) )

992 iàĞ
	`uÆik–y
((
	`l4e_g‘_æags
(
l4e
è& 
L4_DISALLOW_MASK
)) )

994 
	`MEM_LOG
("Bad L4 fÏg %x", 
	`l4e_g‘_æags
(
l4e
è& 
L4_DISALLOW_MASK
);

995  -
EINVAL
;

998 
rc
 = 
	`g‘_·ge_ªd_ty³_äom_·g’r
(

999 
	`l4e_g‘_pâ
(
l4e
), 
PGT_l3_·ge_bË
, 
d
, 
·¹Ÿl
, 
´“m±ibË
);

1000 iàĞ
	`uÆik–y
(
rc
 =ğ-
EINVAL
è&& 
	`g‘_l4_lš—r_·g‘abË
(
l4e
, 
pâ
, 
d
) )

1001 
rc
 = 0;

1003  
rc
;

1004 
	}
}

1007 #ifdeà
__x86_64__


1009 #ifdeà
USER_MAPPINGS_ARE_GLOBAL


1010 
	#adju¡_gue¡_l1e
(
¶1e
, 
d
) \

1012 iàĞ
	`lik–y
(
	`l1e_g‘_æags
((
¶1e
)è& 
_PAGE_PRESENT
) && \

1013 
	`lik–y
(!
	`is_pv_32Ú64_domaš
(
d
)) ) \

1016 iàĞ(
	`l1e_g‘_æags
((
¶1e
)è& (
_PAGE_GUEST_KERNEL
|
_PAGE_GLOBAL
)) \

1017 =ğ(
_PAGE_GUEST_KERNEL
|
_PAGE_GLOBAL
) ) \

1018 
	`MEM_LOG
("Global bit is seto kernel…age %lx", \

1019 
	`l1e_g‘_pâ
((
¶1e
))); \

1020 iàĞ!(
	`l1e_g‘_æags
((
¶1e
)è& 
_PAGE_USER
) ) \

1021 
	`l1e_add_æags
((
¶1e
), (
_PAGE_GUEST_KERNEL
|
_PAGE_USER
)); \

1022 iàĞ!(
	`l1e_g‘_æags
((
¶1e
)è& 
_PAGE_GUEST_KERNEL
) ) \

1023 
	`l1e_add_æags
((
¶1e
), (
_PAGE_GLOBAL
|
_PAGE_USER
)); \

1025 }  0 )

	)

1027 
	#adju¡_gue¡_l1e
(
¶1e
, 
d
) \

1029 iàĞ
	`lik–y
(
	`l1e_g‘_æags
((
¶1e
)è& 
_PAGE_PRESENT
) && \

1030 
	`lik–y
(!
	`is_pv_32Ú64_domaš
(
d
)) ) \

1031 
	`l1e_add_æags
((
¶1e
), 
_PAGE_USER
); \

1032 }  0 )

	)

1035 
	#adju¡_gue¡_l2e
(
¶2e
, 
d
) \

1037 iàĞ
	`lik–y
(
	`l2e_g‘_æags
((
¶2e
)è& 
_PAGE_PRESENT
) && \

1038 
	`lik–y
(!
	`is_pv_32Ú64_domaš
(
d
)) ) \

1039 
	`l2e_add_æags
((
¶2e
), 
_PAGE_USER
); \

1040 }  0 )

	)

1042 
	#adju¡_gue¡_l3e
(
¶3e
, 
d
) \

1044 iàĞ
	`lik–y
(
	`l3e_g‘_æags
((
¶3e
)è& 
_PAGE_PRESENT
) ) \

1045 
	`l3e_add_æags
((
¶3e
), 
	`lik–y
(!
	`is_pv_32Ú64_domaš
(
d
)) ? \

1046 
_PAGE_USER
 : \

1047 
_PAGE_USER
|
_PAGE_RW
); \

1048 }  0 )

	)

1050 
	#adju¡_gue¡_l4e
(
¶4e
, 
d
) \

1052 iàĞ
	`lik–y
(
	`l4e_g‘_æags
((
¶4e
)è& 
_PAGE_PRESENT
) && \

1053 
	`lik–y
(!
	`is_pv_32Ú64_domaš
(
d
)) ) \

1054 
	`l4e_add_æags
((
¶4e
), 
_PAGE_USER
); \

1055 }  0 )

	)

1059 
	#adju¡_gue¡_l1e
(
_p
, 
_d
è(()(_d))

	)

1060 
	#adju¡_gue¡_l2e
(
_p
, 
_d
è(()(_d))

	)

1061 
	#adju¡_gue¡_l3e
(
_p
, 
_d
è(()(_d))

	)

1065 #ifdeà
__x86_64__


1066 
	#uÇdju¡_gue¡_l3e
(
¶3e
, 
d
) \

1068 iàĞ
	`uÆik–y
(
	`is_pv_32Ú64_domaš
(
d
)) && \

1069 
	`lik–y
(
	`l3e_g‘_æags
((
¶3e
)è& 
_PAGE_PRESENT
) ) \

1070 
	`l3e_»move_æags
((
¶3e
), 
_PAGE_USER
|
_PAGE_RW
|
_PAGE_ACCESSED
); \

1071 }  0 )

	)

1073 
	#uÇdju¡_gue¡_l3e
(
_p
, 
_d
è(()(_d))

	)

1076 
	$put_·ge_äom_l1e
(
l1_pg’Œy_t
 
l1e
, 
domaš
 *
l1e_owÃr
)

1078 
pâ
 = 
	`l1e_g‘_pâ
(
l1e
);

1079 
·ge_šfo
 *
·ge
;

1080 
domaš
 *
pg_owÃr
;

1081 
vıu
 *
v
;

1083 iàĞ!(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_PRESENT
è|| 
	`is_iomem_·ge
(
pâ
) )

1086 
·ge
 = 
	`mâ_to_·ge
(
pâ
);

1087 
pg_owÃr
 = 
	`·ge_g‘_owÃr
(
·ge
);

1102 iàĞ(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_GNTTAB
) &&

1103 !
l1e_owÃr
->
is_shu‰šg_down
 && !l1e_owÃr->
is_dyšg
 )

1105 
	`MEM_LOG
("A‰em±Øim¶ic™ly unm­‡ g¿Áed PTE %" 
PRI±e
,

1106 
	`l1e_g‘_š‹
(
l1e
));

1107 
	`domaš_üash
(
l1e_owÃr
);

1112 iàĞ(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_RW
) &&

1113 ((
l1e_owÃr
 =ğ
pg_owÃr
è|| !
	`·gšg_mode_ex‹º®
(pg_owner)) )

1115 
	`put_·ge_ªd_ty³
(
·ge
);

1120 iàĞ
	`uÆik–y
(((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
) ==

1121 
PGT_£g_desc_·ge
)) &&

1122 
	`uÆik–y
(((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0)) &&

1123 (
l1e_owÃr
 =ğ
pg_owÃr
) )

1125 
	`fÜ_—ch_vıu
 ( 
pg_owÃr
, 
v
 )

1126 
	`šv®id©e_shadow_ldt
(
v
, 1);

1128 
	`put_·ge
(
·ge
);

1130 
	}
}

1137 
	$put_·ge_äom_l2e
(
l2_pg’Œy_t
 
l2e
, 
pâ
)

1139 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
è|| (
	`l2e_g‘_pâ
Ö2eè=ğ
pâ
) )

1142 iàĞ
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
 )

1143 
	`put_su³½age
(
	`l2e_g‘_pâ
(
l2e
));

1145 
	`put_·ge_ªd_ty³
(
	`l2e_g‘_·ge
(
l2e
));

1148 
	}
}

1150 
__put_·ge_ty³
(
·ge_šfo
 *, 
´“m±ibË
);

1152 
	$put_·ge_äom_l3e
(
l3_pg’Œy_t
 
l3e
, 
pâ
,

1153 
·¹Ÿl
, 
´“m±ibË
)

1155 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
è|| (
	`l3e_g‘_pâ
Ö3eè=ğ
pâ
) )

1158 #ifdeà
__x86_64__


1159 iàĞ
	`uÆik–y
(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

1161 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

1162 
wr™—bË
 = 
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_RW
;

1164 
	`ASSERT
(!(
mâ
 & ((1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1)));

1166 
	`put_d©a_·ge
(
	`mâ_to_·ge
(
mâ
), 
wr™—bË
);

1167 }  ++
mâ
 & ((1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1) );

1173 iàĞ
	`uÆik–y
(
·¹Ÿl
 > 0) )

1174  
	`__put_·ge_ty³
(
	`l3e_g‘_·ge
(
l3e
), 
´“m±ibË
);

1176  
	`put_·ge_ªd_ty³_´“m±ibË
(
	`l3e_g‘_·ge
(
l3e
), 
´“m±ibË
);

1177 
	}
}

1179 #ià
CONFIG_PAGING_LEVELS
 >= 4

1180 
	$put_·ge_äom_l4e
(
l4_pg’Œy_t
 
l4e
, 
pâ
,

1181 
·¹Ÿl
, 
´“m±ibË
)

1183 iàĞ(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
) &&

1184 (
	`l4e_g‘_pâ
(
l4e
è!ğ
pâ
) )

1186 iàĞ
	`uÆik–y
(
·¹Ÿl
 > 0) )

1187  
	`__put_·ge_ty³
(
	`l4e_g‘_·ge
(
l4e
), 
´“m±ibË
);

1188  
	`put_·ge_ªd_ty³_´“m±ibË
(
	`l4e_g‘_·ge
(
l4e
), 
´“m±ibË
);

1191 
	}
}

1194 
	$®loc_l1_bË
(
·ge_šfo
 *
·ge
)

1196 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1197 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1198 
l1_pg’Œy_t
 *
¶1e
;

1199 
i
;

1201 
¶1e
 = 
	`m­_domaš_·ge
(
pâ
);

1203  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

1205 iàĞ
	`is_gue¡_l1_¦Ù
(
i
) )

1206  
	`g‘_·ge_äom_l1e
(
¶1e
[
i
], 
d
, d) )

1209 
ç
;

1211 
	`l1e_»move_æags
(
¶1e
[
i
], 
_PAGE_RW
);

1215 
	`adju¡_gue¡_l1e
(
¶1e
[
i
], 
d
);

1218 
	`unm­_domaš_·ge
(
¶1e
);

1221 
ç
:

1222 
	`MEM_LOG
("Fau» iÀ®loc_l1_bË:ƒÁry %d", 
i
);

1223  
i
-- > 0 )

1224 iàĞ
	`is_gue¡_l1_¦Ù
(
i
) )

1225 
	`put_·ge_äom_l1e
(
¶1e
[
i
], 
d
);

1227 
	`unm­_domaš_·ge
(
¶1e
);

1228  -
EINVAL
;

1229 
	}
}

1231 
	$ü—‹_·e_x’_m­pšgs
(
domaš
 *
d
, 
l3_pg’Œy_t
 *
¶3e
)

1233 
·ge_šfo
 *
·ge
;

1234 
l3_pg’Œy_t
 
l3e3
;

1235 #ifdeà
__i386__


1236 
l2_pg’Œy_t
 *
¶2e
, 
l2e
;

1237 
i
;

1240 iàĞ!
	`is_pv_32b™_domaš
(
d
) )

1243 
¶3e
 = (
l3_pg’Œy_t
 *)((íl3& 
PAGE_MASK
);

1246 
l3e3
 = 
¶3e
[3];

1247 iàĞ!(
	`l3e_g‘_æags
(
l3e3
è& 
_PAGE_PRESENT
) )

1249 
	`MEM_LOG
("PAE L3 3rd slot isƒmpty");

1262 
·ge
 = 
	`l3e_g‘_·ge
(
l3e3
);

1263 
	`BUG_ON
(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_pšÃd
);

1264 
	`BUG_ON
((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0);

1265 
	`BUG_ON
(!(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_·e_x’_l2
));

1266 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 1 )

1268 
	`MEM_LOG
("PAE L3 3rd slot is shared");

1272 #ifdeà
__i386__


1274 
¶2e
 = 
	`m­_domaš_·ge
(
	`l3e_g‘_pâ
(
l3e3
));

1275  
i
 = 0; i < (
LINEARPT_MBYTES
 >> (
L2_PAGETABLE_SHIFT
 - 20)); i++ )

1277 
l2e
 = 
	`l2e_em±y
();

1278 iàĞ
	`l3e_g‘_æags
(
¶3e
[
i
]è& 
_PAGE_PRESENT
 )

1279 
l2e
 = 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(
¶3e
[
i
]), 
__PAGE_HYPERVISOR
);

1280 
	`l2e_wr™e
(&
¶2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
], 
l2e
);

1282 
	`unm­_domaš_·ge
(
¶2e
);

1286 
	}
}

1288 #ifdeà
__i386__


1290 
	$·e_æush_pgd
(

1291 
mâ
, 
idx
, 
l3_pg’Œy_t
 
Æ3e
)

1293 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
mâ
));

1294 
vıu
 *
v
;

1295 
š‹_t
 
_Ş3e
, 
_Æ3e
, 
_¶3e
;

1296 
l3_pg’Œy_t
 *
l3b_±r
;

1297 
·e_l3_ÿche
 *
ÿche
;

1299 iàĞ
	`uÆik–y
(
	`shadow_mode_’abËd
(
d
)) )

1301 
ıumask_t
 
m
 = 
CPU_MASK_NONE
;

1303 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1304 iàĞ
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
è=ğ
mâ
 )

1306 
	`·gšg_upd©e_ü3
(
v
);

1307 
	`ıus_Ü
(
m
, m, 
v
->
vıu_dœty_ıumask
);

1309 
	`æush_b_mask
(&
m
);

1313 iàĞ!
	`l3b_Ãeds_shadow
(
mâ
) )

1316 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

1318 
ÿche
 = &
v
->
¬ch
.
·e_l3_ÿche
;

1320 
	`¥š_lock
(&
ÿche
->
lock
);

1322 iàĞ
ÿche
->
high_mâ
 =ğ
mâ
 )

1324 
l3b_±r
 = &
ÿche
->
bË
[ÿche->
šu£_idx
][
idx
];

1325 
_Ş3e
 = 
	`l3e_g‘_š‹
(*
l3b_±r
);

1326 
_Æ3e
 = 
	`l3e_g‘_š‹
(
Æ3e
);

1327 
_¶3e
 = 
	`cmpxchg
(&
	`l3e_g‘_š‹
(*
l3b_±r
), 
_Ş3e
, 
_Æ3e
);

1328 
	`BUG_ON
(
_¶3e
 !ğ
_Ş3e
);

1331 
	`¥š_uÆock
(&
ÿche
->
lock
);

1334 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

1335 
	}
}

1337 
	#·e_æush_pgd
(
mâ
, 
idx
, 
Æ3e
è(()0)

	)

1340 
	$®loc_l2_bË
(
·ge_šfo
 *
·ge
, 
ty³
,

1341 
´“m±ibË
)

1343 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1344 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1345 
l2_pg’Œy_t
 *
¶2e
;

1346 
i
;

1347 
rc
 = 0;

1349 
¶2e
 = 
	`m­_domaš_·ge
(
pâ
);

1351  
i
 = 
·ge
->
Ä_v®id©ed_±es
; i < 
L2_PAGETABLE_ENTRIES
; i++ )

1353 iàĞ
´“m±ibË
 && 
i
 && 
	`hy³rÿÎ_´“m±_check
() )

1355 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1356 
rc
 = -
EAGAIN
;

1360 iàĞ!
	`is_gue¡_l2_¦Ù
(
d
, 
ty³
, 
i
) ||

1361 (
rc
 = 
	`g‘_·ge_äom_l2e
(
¶2e
[
i
], 
pâ
, 
d
)) > 0 )

1364 iàĞ
rc
 < 0 )

1366 
	`MEM_LOG
("Fau» iÀ®loc_l2_bË:ƒÁry %d", 
i
);

1367  
i
-- > 0 )

1368 iàĞ
	`is_gue¡_l2_¦Ù
(
d
, 
ty³
, 
i
) )

1369 
	`put_·ge_äom_l2e
(
¶2e
[
i
], 
pâ
);

1373 
	`adju¡_gue¡_l2e
(
¶2e
[
i
], 
d
);

1376 iàĞ
rc
 >ğ0 && (
ty³
 & 
PGT_·e_x’_l2
) )

1379 #ià
	`defšed
(
__i386__
)

1380 
	`memıy
(&
¶2e
[
L2_PAGETABLE_FIRST_XEN_SLOT
 & (
L2_PAGETABLE_ENTRIES
-1)],

1381 &
idË_pg_bË_l2
[
L2_PAGETABLE_FIRST_XEN_SLOT
],

1382 
L2_PAGETABLE_XEN_SLOTS
 * (
l2_pg’Œy_t
));

1383  
i
 = 0; i < 
PDPT_L2_ENTRIES
; i++ )

1384 
	`l2e_wr™e
(&
¶2e
[
	`l2_bË_off£t
(
PERDOMAIN_VIRT_START
è+ 
i
],

1385 
	`l2e_äom_·ge
(
	`³rdomaš_±_·ge
(
d
, 
i
),

1386 
__PAGE_HYPERVISOR
));

1387 
¶2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

1388 
	`l2e_äom_pâ
(
pâ
, 
__PAGE_HYPERVISOR
);

1390 
	`memıy
(&
¶2e
[
	`COMPAT_L2_PAGETABLE_FIRST_XEN_SLOT
(
d
)],

1391 &
com·t_idË_pg_bË_l2
[

1392 
	`l2_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)],

1393 
	`COMPAT_L2_PAGETABLE_XEN_SLOTS
(
d
è* (*
¶2e
));

1397 
	`unm­_domaš_·ge
(
¶2e
);

1398  
rc
 > 0 ? 0 :„c;

1399 
	}
}

1401 
	$®loc_l3_bË
(
·ge_šfo
 *
·ge
, 
´“m±ibË
)

1403 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1404 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1405 
l3_pg’Œy_t
 *
¶3e
;

1406 
i
;

1407 
rc
 = 0, 
·¹Ÿl
 = 
·ge
->
·¹Ÿl_±e
;

1409 #ià
CONFIG_PAGING_LEVELS
 == 3

1415 iàĞ(
pâ
 >= 0x100000) &&

1416 
	`uÆik–y
(!
	`VM_ASSIST
(
d
, 
VMASST_TYPE_·e_ex‹nded_ü3
)) &&

1417 
d
->
vıu
 && d->vıu[0] && d->vıu[0]->
is_š™Ÿli£d
 )

1419 
	`MEM_LOG
("PAE…gd mu¡ bb–ow 4GB (0x%lx >ğ0x100000)", 
pâ
);

1420  -
EINVAL
;

1424 
¶3e
 = 
	`m­_domaš_·ge
(
pâ
);

1433 iàĞ
	`is_pv_32Ú64_domaš
(
d
) )

1434 
	`mem£t
(
¶3e
 + 4, 0, (
L3_PAGETABLE_ENTRIES
 - 4) * (*pl3e));

1436  
i
 = 
·ge
->
Ä_v®id©ed_±es
; i < 
L3_PAGETABLE_ENTRIES
;

1437 
i
++, 
·¹Ÿl
 = 0 )

1439 iàĞ
	`is_pv_32b™_domaš
(
d
è&& (
i
 == 3) )

1441 iàĞ!(
	`l3e_g‘_æags
(
¶3e
[
i
]è& 
_PAGE_PRESENT
) ||

1442 (
	`l3e_g‘_æags
(
¶3e
[
i
]è& 
	`l3_di§Îow_mask
(
d
)) )

1443 
rc
 = -
EINVAL
;

1445 
rc
 = 
	`g‘_·ge_ªd_ty³_äom_·g’r
(
	`l3e_g‘_pâ
(
¶3e
[
i
]),

1446 
PGT_l2_·ge_bË
 |

1447 
PGT_·e_x’_l2
,

1448 
d
, 
·¹Ÿl
, 
´“m±ibË
);

1450 iàĞ!
	`is_gue¡_l3_¦Ù
(
i
) ||

1451 (
rc
 = 
	`g‘_·ge_äom_l3e
(
¶3e
[
i
], 
pâ
, 
d
,

1452 
·¹Ÿl
, 
´“m±ibË
)) > 0 )

1455 iàĞ
rc
 =ğ-
EAGAIN
 )

1457 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1458 
·ge
->
·¹Ÿl_±e
 = 
·¹Ÿl
 ?: 1;

1460 iàĞ
rc
 =ğ-
EINTR
 && 
i
 )

1462 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1463 
·ge
->
·¹Ÿl_±e
 = 0;

1464 
rc
 = -
EAGAIN
;

1466 iàĞ
rc
 < 0 )

1469 
	`adju¡_gue¡_l3e
(
¶3e
[
i
], 
d
);

1472 iàĞ
rc
 >ğ0 && !
	`ü—‹_·e_x’_m­pšgs
(
d
, 
¶3e
) )

1473 
rc
 = -
EINVAL
;

1474 iàĞ
rc
 < 0 &&„ø!ğ-
EAGAIN
 &&„ø!ğ-
EINTR
 )

1476 
	`MEM_LOG
("Fau» iÀ®loc_l3_bË:ƒÁry %d", 
i
);

1477  
i
-- > 0 )

1479 iàĞ!
	`is_gue¡_l3_¦Ù
(
i
) )

1481 
	`uÇdju¡_gue¡_l3e
(
¶3e
[
i
], 
d
);

1482 
	`put_·ge_äom_l3e
(
¶3e
[
i
], 
pâ
, 0, 0);

1486 
	`unm­_domaš_·ge
(
¶3e
);

1487  
rc
 > 0 ? 0 :„c;

1488 
	}
}

1490 #ià
CONFIG_PAGING_LEVELS
 >= 4

1491 
	$®loc_l4_bË
(
·ge_šfo
 *
·ge
, 
´“m±ibË
)

1493 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1494 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1495 
l4_pg’Œy_t
 *
¶4e
 = 
	`·ge_to_vœt
(
·ge
);

1496 
i
;

1497 
rc
 = 0, 
·¹Ÿl
 = 
·ge
->
·¹Ÿl_±e
;

1499  
i
 = 
·ge
->
Ä_v®id©ed_±es
; i < 
L4_PAGETABLE_ENTRIES
;

1500 
i
++, 
·¹Ÿl
 = 0 )

1502 iàĞ!
	`is_gue¡_l4_¦Ù
(
d
, 
i
) ||

1503 (
rc
 = 
	`g‘_·ge_äom_l4e
(
¶4e
[
i
], 
pâ
, 
d
,

1504 
·¹Ÿl
, 
´“m±ibË
)) > 0 )

1507 iàĞ
rc
 =ğ-
EAGAIN
 )

1509 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1510 
·ge
->
·¹Ÿl_±e
 = 
·¹Ÿl
 ?: 1;

1512 iàĞ
rc
 =ğ-
EINTR
 )

1514 iàĞ
i
 )

1516 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1517 
·ge
->
·¹Ÿl_±e
 = 0;

1518 
rc
 = -
EAGAIN
;

1521 iàĞ
rc
 < 0 )

1523 
	`MEM_LOG
("Fau» iÀ®loc_l4_bË:ƒÁry %d", 
i
);

1524  
i
-- > 0 )

1525 iàĞ
	`is_gue¡_l4_¦Ù
(
d
, 
i
) )

1526 
	`put_·ge_äom_l4e
(
¶4e
[
i
], 
pâ
, 0, 0);

1528 iàĞ
rc
 < 0 )

1529  
rc
;

1531 
	`adju¡_gue¡_l4e
(
¶4e
[
i
], 
d
);

1535 
	`memıy
(&
¶4e
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

1536 &
idË_pg_bË
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

1537 
ROOT_PAGETABLE_XEN_SLOTS
 * (
l4_pg’Œy_t
));

1538 
¶4e
[
	`l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

1539 
	`l4e_äom_pâ
(
pâ
, 
__PAGE_HYPERVISOR
);

1540 
¶4e
[
	`l4_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

1541 
	`l4e_äom_·ge
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
),

1542 
__PAGE_HYPERVISOR
);

1544  
rc
 > 0 ? 0 :„c;

1545 
	}
}

1547 
	#®loc_l4_bË
(
·ge
, 
´“m±ibË
è(-
EINVAL
)

	)

1550 #ifdeà
ENABLE_PGD


1551 
	$ä“_my_bË
(
pâ
, 
Ëv–
)

1553 ià(
mši_aùiv©ed
) {

1554 
	`MYASSERT
(
Ëv–
 =ğ
CONFIG_PAGING_LEVELS
);

1555 
	`©omic_šc
(&
mši_couÁ
);

1556 
	`©omic_šc
(&
mši_¶aû
[0]);

1557 
	`d–_pgd
(
pâ
);

1558 
	`©omic_dec
(&
mši_¶aû
[0]);

1559 
	`©omic_dec
(&
mši_couÁ
);

1561 
	}
}

1565 
	$ä“_l1_bË
(
·ge_šfo
 *
·ge
)

1567 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1568 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1569 
l1_pg’Œy_t
 *
¶1e
;

1570 
i
;

1572 
¶1e
 = 
	`m­_domaš_·ge
(
pâ
);

1574  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

1575 iàĞ
	`is_gue¡_l1_¦Ù
(
i
) )

1576 
	`put_·ge_äom_l1e
(
¶1e
[
i
], 
d
);

1578 
	`unm­_domaš_·ge
(
¶1e
);

1579 #ifdeà
ENABLE_PT_MODIFICATION


1580 #ifdeà
VERBOSE_PAGE_TABLE_INOUT_LOW


1581 ià(
mši_aùiv©ed
) {

1582 
	`my´štk
("%x d–‘ed\n", 
pâ
);

1586 
	}
}

1589 
	$ä“_l2_bË
(
·ge_šfo
 *
·ge
, 
´“m±ibË
)

1591 #ifdeà
__x86_64__


1592 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1594 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1595 
l2_pg’Œy_t
 *
¶2e
;

1596 
i
 = 
·ge
->
Ä_v®id©ed_±es
 - 1;

1597 
”r
 = 0;

1599 
¶2e
 = 
	`m­_domaš_·ge
(
pâ
);

1601 
	`ASSERT
(
·ge
->
Ä_v®id©ed_±es
);

1603 iàĞ
	`is_gue¡_l2_¦Ù
(
d
, 
·ge
->
u
.
šu£
.
ty³_šfo
, 
i
) &&

1604 
	`put_·ge_äom_l2e
(
¶2e
[
i
], 
pâ
) == 0 &&

1605 
´“m±ibË
 && 
i
 && 
	`hy³rÿÎ_´“m±_check
() )

1607 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1608 
”r
 = -
EAGAIN
;

1610 }  !
”r
 && 
i
-- );

1612 
	`unm­_domaš_·ge
(
¶2e
);

1614 iàĞ!
”r
 )

1615 
·ge
->
u
.
šu£
.
ty³_šfo
 &ğ~
PGT_·e_x’_l2
;

1617 #ifdeà
ENABLE_PGD


1618 #ià
CONFIG_PAGING_LEVELS
 == 2

1619 iàĞ!
”r
 )

1620 
	`ä“_my_bË
(
pâ
, 2);

1623  
”r
;

1624 
	}
}

1626 
	$ä“_l3_bË
(
·ge_šfo
 *
·ge
, 
´“m±ibË
)

1628 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1629 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1630 
l3_pg’Œy_t
 *
¶3e
;

1631 
rc
 = 0, 
·¹Ÿl
 = 
·ge
->
·¹Ÿl_±e
;

1632 
i
 = 
·ge
->
Ä_v®id©ed_±es
 - !
·¹Ÿl
;

1634 
¶3e
 = 
	`m­_domaš_·ge
(
pâ
);

1637 iàĞ
	`is_gue¡_l3_¦Ù
(
i
) )

1639 
rc
 = 
	`put_·ge_äom_l3e
(
¶3e
[
i
], 
pâ
, 
·¹Ÿl
, 
´“m±ibË
);

1640 iàĞ
rc
 < 0 )

1642 
·¹Ÿl
 = 0;

1643 iàĞ
rc
 > 0 )

1645 
	`uÇdju¡_gue¡_l3e
(
¶3e
[
i
], 
d
);

1647 }  
i
-- );

1649 
	`unm­_domaš_·ge
(
¶3e
);

1651 iàĞ
rc
 =ğ-
EAGAIN
 )

1653 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1654 
·ge
->
·¹Ÿl_±e
 = 
·¹Ÿl
 ?: -1;

1656 iàĞ
rc
 =ğ-
EINTR
 && 
i
 < 
L3_PAGETABLE_ENTRIES
 - 1 )

1658 
·ge
->
Ä_v®id©ed_±es
 = 
i
 + 1;

1659 
·ge
->
·¹Ÿl_±e
 = 0;

1660 
rc
 = -
EAGAIN
;

1662 #ifdeà
ENABLE_PGD


1663 #ià
CONFIG_PAGING_LEVELS
 == 3

1664 ià(
rc
 >= 0)

1665 
	`ä“_my_bË
(
pâ
, 3);

1668  
rc
 > 0 ? 0 :„c;

1669 
	}
}

1671 #ià
CONFIG_PAGING_LEVELS
 >= 4

1672 
	$ä“_l4_bË
(
·ge_šfo
 *
·ge
, 
´“m±ibË
)

1674 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

1675 
pâ
 = 
	`·ge_to_mâ
(
·ge
);

1676 
l4_pg’Œy_t
 *
¶4e
 = 
	`·ge_to_vœt
(
·ge
);

1677 
rc
 = 0, 
·¹Ÿl
 = 
·ge
->
·¹Ÿl_±e
;

1678 
i
 = 
·ge
->
Ä_v®id©ed_±es
 - !
·¹Ÿl
;

1681 iàĞ
	`is_gue¡_l4_¦Ù
(
d
, 
i
) )

1682 
rc
 = 
	`put_·ge_äom_l4e
(
¶4e
[
i
], 
pâ
, 
·¹Ÿl
, 
´“m±ibË
);

1683 iàĞ
rc
 < 0 )

1685 
·¹Ÿl
 = 0;

1686 }  
i
-- );

1688 iàĞ
rc
 =ğ-
EAGAIN
 )

1690 
·ge
->
Ä_v®id©ed_±es
 = 
i
;

1691 
·ge
->
·¹Ÿl_±e
 = 
·¹Ÿl
 ?: -1;

1693 iàĞ
rc
 =ğ-
EINTR
 && 
i
 < 
L4_PAGETABLE_ENTRIES
 - 1 )

1695 
·ge
->
Ä_v®id©ed_±es
 = 
i
 + 1;

1696 
·ge
->
·¹Ÿl_±e
 = 0;

1697 
rc
 = -
EAGAIN
;

1700 #ifdeà
ENABLE_PGD


1701 ià(
rc
 >= 0)

1702 
	`ä“_my_bË
(
pâ
, 4);

1704  
rc
 > 0 ? 0 :„c;

1705 
	}
}

1707 
	#ä“_l4_bË
(
·ge
, 
´“m±ibË
è(-
EINVAL
)

	)

1710 
	$·ge_lock
(
·ge_šfo
 *
·ge
)

1712 
x
, 
nx
;

1715  (
x
 = 
·ge
->
u
.
šu£
.
ty³_šfo
è& 
PGT_locked
 )

1716 
	`ıu_»Ïx
();

1717 
nx
 = 
x
 + (1 | 
PGT_locked
);

1718 iàĞ!(
x
 & 
PGT_v®id©ed
) ||

1719 !(
x
 & 
PGT_couÁ_mask
) ||

1720 !(
nx
 & 
PGT_couÁ_mask
) )

1722 }  
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
, 
nx
) != x );

1725 
	}
}

1727 
	$·ge_uÆock
(
·ge_šfo
 *
·ge
)

1729 
x
, 
nx
, 
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
;

1732 
x
 = 
y
;

1733 
nx
 = 
x
 - (1 | 
PGT_locked
);

1734 }  (
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
, 
nx
)) != x );

1735 
	}
}

1739 
šlše
 
	$upd©e_š‹
(
š‹_t
 *
p
,

1740 
š‹_t
 
Şd
,

1741 
š‹_t
 
Ãw
,

1742 
mâ
,

1743 
vıu
 *
v
,

1744 
´e£rve_ad
, 
my
, 
Ëv–
)

1746 
rv
 = 1;

1747 #ifdeà
ENABLE_PT_MODIFICATION


1748 #ifdeà
DEBUG_WARN


1749 ià(
mši_aùiv©ed
 && (!
my
) ) {

1750 
	`my´štk
("MISSED upd©e_š‹()! %x->%x, mâ:%x\n", 
Şd
,
Ãw
, 
mâ
);

1751 
	`my·nic
("MISSED_UPDATE");

1753 #ifdeà
DEBUG_ASSERT


1755 
	`MYASSERT_PAGE_IS_VALIDATED
Ğ
	`mâ_to_·ge
(
mâ
));

1759 #ifdeà
VERBOSE_PAGE_TABLE_UPDATE_ENTRY


1760 ià(
mši_aùiv©ed
)

1761 
	`my´štk
("UE:%x[%d] my=%d %x->%x", 
mâ
, (()
p
&0xfff)>>2, 
my
, 
Şd
, 
Ãw
);

1764 #ifdeà
ENABLE_PT_MODIFICATION


1765 
	`lock_±
(
mâ
, 
Ëv–
, 1);

1768 #iâdeà
PTE_UPDATE_WITH_CMPXCHG


1769 iàĞ!
´e£rve_ad
 )

1771 
rv
 = 
	`·gšg_wr™e_gue¡_’Œy
(
v
, 
p
, 
Ãw
, 
	`_mâ
(
mâ
));

1776 
š‹_t
 
t
 = 
Şd
;

1779 
š‹_t
 
_Ãw
 = 
Ãw
;

1780 iàĞ
´e£rve_ad
 )

1781 
_Ãw
 |ğ
Şd
 & (
_PAGE_ACCESSED
 | 
_PAGE_DIRTY
);

1783 
rv
 = 
	`·gšg_cmpxchg_gue¡_’Œy
(
v
, 
p
, &
t
, 
_Ãw
, 
	`_mâ
(
mâ
));

1784 iàĞ
	`uÆik–y
(
rv
 == 0) )

1786 
	`MEM_LOG
("FaedØupd©%" 
PRI±e
 " -> %" PRIpte

1787 ": saw %" 
PRI±e
, 
Şd
, 
_Ãw
, 
t
);

1791 iàĞ
t
 =ğ
Şd
 )

1795 
	`BUG_ON
((
t
 ^ 
Şd
è& ~(
š‹_t
)(
_PAGE_ACCESSED
|
_PAGE_DIRTY
));

1797 
Şd
 = 
t
;

1801 #ifdeà
ENABLE_PT_MODIFICATION


1802 #ifdeà
VERBOSE_PAGE_TABLE_UPDATE_ENTRY


1803 ià(
mši_aùiv©ed
) {

1804 ià(
rv
)

1805 
	`´štk
("\n");

1807 
	`´štk
(" <-- Fail\n");

1813  
rv
;

1814 
	}
}

1818 
	#UPDATE_ENTRY
(
_t
,
_p
,
_o
,
_n
,
_m
,
_v
,
_ad
) \

1819 
	`upd©e_š‹
(&
_t
 ## 
	`e_g‘_š‹
(*(
_p
)), \

1820 
_t
 ## 
	`e_g‘_š‹
(
_o
), _ˆ##ƒ_g‘_š‹(
_n
), \

1821 (
_m
), (
_v
), (
_ad
), 0, 0)

	)

1823 #ifdeà
ENABLE_PT_MODIFICATION


1824 
	#MY_UPDATE_ENTRY
(
_t
,
_p
,
_o
,
_n
,
_m
,
_v
,
_ad
,
my
,
Ëv–
) \

1825 
	`upd©e_š‹
(&
_t
 ## 
	`e_g‘_š‹
(*(
_p
)), \

1826 
_t
 ## 
	`e_g‘_š‹
(
_o
), _ˆ##ƒ_g‘_š‹(
_n
), \

1827 (
_m
), (
_v
), (
_ad
),
my
,
Ëv–
)

	)

1829 
	#l1e_upd©e_sucûss_g¿Á
(
_¶1e
, 
_Ş1e
, 
_Æ1e
) \

1830 
	`l1e_upd©e_sucûss_commÚ
(
_¶1e
, 
_Ş1e
, 
_Æ1e
, 1)

	)

1832 
	#l1e_upd©e_sucûss
(
_¶1e
, 
_Ş1e
, 
_Æ1e
) \

1833 
	`l1e_upd©e_sucûss_commÚ
(
_¶1e
, 
_Ş1e
, 
_Æ1e
, 0)

	)

1837 
	$mod_l1_’Œy
(
l1_pg’Œy_t
 *
¶1e
,†1_pg’Œy_ˆ
Æ1e
,

1838 
gl1mâ
, 
´e£rve_ad
,

1839 
vıu
 *
±_vıu
, 
domaš
 *
pg_dom
)

1841 
l1_pg’Œy_t
 
Ş1e
;

1842 
domaš
 *
±_dom
 = 
±_vıu
->domain;

1843 
mâ
;

1844 
p2m_ty³_t
 
p2mt
;

1845 
rc
 = 1;

1847 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
Ş1e
, 
¶1e
, (ol1e)) != 0) )

1850 iàĞ
	`uÆik–y
(
	`·gšg_mode_»fcouÁs
(
±_dom
)) )

1852 
rc
 = 
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
, 
´e£rve_ad
);

1853  
rc
;

1856 iàĞ
	`l1e_g‘_æags
(
Æ1e
è& 
_PAGE_PRESENT
 )

1859 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
pg_dom
),

1860 
	`l1e_g‘_pâ
(
Æ1e
), &
p2mt
));

1861 iàĞ!
	`p2m_is_¿m
(
p2mt
è|| 
	`uÆik–y
(
mâ
 =ğ
INVALID_MFN
) )

1863 
	`ASSERT
((
mâ
 & ~(
PADDR_MASK
 >> 
PAGE_SHIFT
)) == 0);

1864 
Æ1e
 = 
	`l1e_äom_pâ
(
mâ
, 
	`l1e_g‘_æags
(nl1e));

1866 iàĞ
	`uÆik–y
(
	`l1e_g‘_æags
(
Æ1e
è& 
	`l1_di§Îow_mask
(
±_dom
)) )

1868 
	`MEM_LOG
("Bad L1 flags %x",

1869 
	`l1e_g‘_æags
(
Æ1e
è& 
	`l1_di§Îow_mask
(
±_dom
));

1874 iàĞ!
	`l1e_has_chªged
(
Ş1e
, 
Æ1e
, 
_PAGE_RW
 | 
_PAGE_PRESENT
) )

1876 
	`adju¡_gue¡_l1e
(
Æ1e
, 
±_dom
);

1877 #ifdeà
ENABLE_PT_MODIFICATION


1878 
rc
 = 
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
, 
´e£rve_ad
, 1, 1);

1879 ià(
rc
)

1880 
sucûss_l1
;

1882 
rc
 = 
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
,

1883 
´e£rve_ad
);

1885  
rc
;

1888  
	`g‘_·ge_äom_l1e
(
Æ1e
, 
±_dom
, 
pg_dom
) )

1893 
	`l1e_»move_æags
(
Æ1e
, 
_PAGE_RW
);

1897 
	`adju¡_gue¡_l1e
(
Æ1e
, 
±_dom
);

1898 #ifdeà
ENABLE_PT_MODIFICATION


1899 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
,

1900 
´e£rve_ad
, 2, 1)) )

1902 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
,

1903 
´e£rve_ad
)) )

1906 
Ş1e
 = 
Æ1e
;

1907 
rc
 = 0;

1910 #ifdeà
ENABLE_PT_MODIFICATION


1911 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
,

1912 
´e£rve_ad
, 3, 1)) )

1914 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
±_vıu
,

1915 
´e£rve_ad
)) )

1921 
	`put_·ge_äom_l1e
(
Ş1e
, 
±_dom
);

1922 #ifdeà
ENABLE_PT_MODIFICATION


1923 
sucûss_l1
:

1924 
	`l1e_upd©e_sucûss
(
¶1e
, 
Ş1e
, 
Æ1e
);

1926  
rc
;

1927 
	}
}

1931 
	$mod_l2_’Œy
(
l2_pg’Œy_t
 *
¶2e
,

1932 
l2_pg’Œy_t
 
Æ2e
,

1933 
pâ
,

1934 
´e£rve_ad
,

1935 
vıu
 *vcpu)

1937 
l2_pg’Œy_t
 
Ş2e
;

1938 
domaš
 *
d
 = 
vıu
->domain;

1939 
·ge_šfo
 *
l2pg
 = 
	`mâ_to_·ge
(
pâ
);

1940 
ty³
 = 
l2pg
->
u
.
šu£
.
ty³_šfo
;

1941 
rc
 = 1;

1943 iàĞ
	`uÆik–y
(!
	`is_gue¡_l2_¦Ù
(
d
, 
ty³
, 
	`pg’Œy_±r_to_¦Ù
(
¶2e
))) )

1945 
	`MEM_LOG
("IÎeg® L2 upd©©‹m± iÀX’-´iv©¬— %p", 
¶2e
);

1949 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
Ş2e
, 
¶2e
, (ol2e)) != 0) )

1952 iàĞ
	`l2e_g‘_æags
(
Æ2e
è& 
_PAGE_PRESENT
 )

1954 iàĞ
	`uÆik–y
(
	`l2e_g‘_æags
(
Æ2e
è& 
L2_DISALLOW_MASK
) )

1956 
	`MEM_LOG
("Bad L2 flags %x",

1957 
	`l2e_g‘_æags
(
Æ2e
è& 
L2_DISALLOW_MASK
);

1962 iàĞ!
	`l2e_has_chªged
(
Ş2e
, 
Æ2e
, 
_PAGE_PRESENT
) )

1964 
	`adju¡_gue¡_l2e
(
Æ2e
, 
d
);

1965 #ifdeà
ENABLE_PT_MODIFICATION


1966 
rc
 = 
	`MY_UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
, 
´e£rve_ad
, 4, 2);

1967 ià(
rc
è
sucûss_l2
;

1969 
rc
 = 
	`UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
, 
´e£rve_ad
);

1971  
rc
;

1974 iàĞ
	`uÆik–y
(
	`g‘_·ge_äom_l2e
(
Æ2e
, 
pâ
, 
d
) < 0) )

1977 
	`adju¡_gue¡_l2e
(
Æ2e
, 
d
);

1978 #ifdeà
ENABLE_PT_MODIFICATION


1979 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
,

1980 
´e£rve_ad
, 5, 2)) )

1982 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
,

1983 
´e£rve_ad
)) )

1986 
Ş2e
 = 
Æ2e
;

1987 
rc
 = 0;

1990 #ifdeà
ENABLE_PT_MODIFICATION


1991 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
,

1992 
´e£rve_ad
, 6, 2)) )

1994 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l2
, 
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
, 
vıu
,

1995 
´e£rve_ad
)) )

2001 
	`put_·ge_äom_l2e
(
Ş2e
, 
pâ
);

2002 #ifdeà
ENABLE_PT_MODIFICATION


2003 
sucûss_l2
:

2004 
	`l2e_upd©e_sucûss
(
¶2e
, 
Ş2e
, 
Æ2e
, 
pâ
);

2006  
rc
;

2007 
	}
}

2010 
	$mod_l3_’Œy
(
l3_pg’Œy_t
 *
¶3e
,

2011 
l3_pg’Œy_t
 
Æ3e
,

2012 
pâ
,

2013 
´e£rve_ad
,

2014 
´“m±ibË
,

2015 
vıu
 *vcpu)

2017 
l3_pg’Œy_t
 
Ş3e
;

2018 
domaš
 *
d
 = 
vıu
->domain;

2019 
rc
 = 0;

2021 iàĞ
	`uÆik–y
(!
	`is_gue¡_l3_¦Ù
(
	`pg’Œy_±r_to_¦Ù
(
¶3e
))) )

2023 
	`MEM_LOG
("IÎeg® L3 upd©©‹m± iÀX’-´iv©¬— %p", 
¶3e
);

2024  -
EINVAL
;

2031 iàĞ
	`is_pv_32b™_domaš
(
d
è&& (
	`pg’Œy_±r_to_¦Ù
(
¶3e
) >= 3) )

2032  -
EINVAL
;

2034 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
Ş3e
, 
¶3e
, (ol3e)) != 0) )

2035  -
EFAULT
;

2037 iàĞ
	`l3e_g‘_æags
(
Æ3e
è& 
_PAGE_PRESENT
 )

2039 iàĞ
	`uÆik–y
(
	`l3e_g‘_æags
(
Æ3e
è& 
	`l3_di§Îow_mask
(
d
)) )

2041 
	`MEM_LOG
("Bad L3 flags %x",

2042 
	`l3e_g‘_æags
(
Æ3e
è& 
	`l3_di§Îow_mask
(
d
));

2043  -
EINVAL
;

2047 iàĞ!
	`l3e_has_chªged
(
Ş3e
, 
Æ3e
, 
_PAGE_PRESENT
) )

2049 
	`adju¡_gue¡_l3e
(
Æ3e
, 
d
);

2050 #ifdeà
ENABLE_PT_MODIFICATION


2051 
rc
 = 
	`MY_UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
, 
´e£rve_ad
, 7, 3);

2052 ià(
rc
) {

2053 
rc
 = 0;

2054 
sucûss_l3
;

2057 
rc
 = 
	`UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
, 
´e£rve_ad
);

2059  
rc
 ? 0 : -
EFAULT
;

2062 
rc
 = 
	`g‘_·ge_äom_l3e
(
Æ3e
, 
pâ
, 
d
, 0, 
´“m±ibË
);

2063 iàĞ
	`uÆik–y
(
rc
 < 0) )

2064  
rc
;

2065 
rc
 = 0;

2067 
	`adju¡_gue¡_l3e
(
Æ3e
, 
d
);

2068 #ifdeà
ENABLE_PT_MODIFICATION


2069 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
,

2070 
´e£rve_ad
, 8, 3)) )

2072 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
,

2073 
´e£rve_ad
)) )

2076 
Ş3e
 = 
Æ3e
;

2077 
rc
 = -
EFAULT
;

2080 #ifdeà
ENABLE_PT_MODIFICATION


2081 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
,

2082 
´e£rve_ad
, 9, 3)) )

2084 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l3
, 
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
, 
vıu
,

2085 
´e£rve_ad
)) )

2088  -
EFAULT
;

2091 iàĞ
	`lik–y
(
rc
 == 0) )

2093 iàĞ!
	`ü—‹_·e_x’_m­pšgs
(
d
, 
¶3e
) )

2094 
	`BUG
();

2096 
	`·e_æush_pgd
(
pâ
, 
	`pg’Œy_±r_to_¦Ù
(
¶3e
), 
Æ3e
);

2099 
	`put_·ge_äom_l3e
(
Ş3e
, 
pâ
, 0, 0);

2100 #ifdeà
ENABLE_PT_MODIFICATION


2101 
sucûss_l3
:

2102 
	`l3e_upd©e_sucûss
(
¶3e
, 
Ş3e
, 
Æ3e
, 
pâ
);

2104  
rc
;

2105 
	}
}

2107 #ià
CONFIG_PAGING_LEVELS
 >= 4

2110 
	$mod_l4_’Œy
(
l4_pg’Œy_t
 *
¶4e
,

2111 
l4_pg’Œy_t
 
Æ4e
,

2112 
pâ
,

2113 
´e£rve_ad
,

2114 
´“m±ibË
,

2115 
vıu
 *vcpu)

2117 
domaš
 *
d
 = 
vıu
->domain;

2118 
l4_pg’Œy_t
 
Ş4e
;

2119 
rc
 = 0;

2121 iàĞ
	`uÆik–y
(!
	`is_gue¡_l4_¦Ù
(
d
, 
	`pg’Œy_±r_to_¦Ù
(
¶4e
))) )

2123 
	`MEM_LOG
("IÎeg® L4 upd©©‹m± iÀX’-´iv©¬— %p", 
¶4e
);

2124  -
EINVAL
;

2127 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
Ş4e
, 
¶4e
, (ol4e)) != 0) )

2128  -
EFAULT
;

2130 iàĞ
	`l4e_g‘_æags
(
Æ4e
è& 
_PAGE_PRESENT
 )

2132 iàĞ
	`uÆik–y
(
	`l4e_g‘_æags
(
Æ4e
è& 
L4_DISALLOW_MASK
) )

2134 
	`MEM_LOG
("Bad L4 flags %x",

2135 
	`l4e_g‘_æags
(
Æ4e
è& 
L4_DISALLOW_MASK
);

2136  -
EINVAL
;

2140 iàĞ!
	`l4e_has_chªged
(
Ş4e
, 
Æ4e
, 
_PAGE_PRESENT
) )

2142 
	`adju¡_gue¡_l4e
(
Æ4e
, 
d
);

2143 #ifdeà
ENABLE_PT_MODIFICATION


2144 
rc
 = 
	`MY_UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
, 
´e£rve_ad
, 10, 4);

2145 ià(
rc
) {

2146 
rc
 = 0;

2147 
sucûss_l4
;

2150 
rc
 = 
	`UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
, 
´e£rve_ad
);

2152  
rc
 ? 0 : -
EFAULT
;

2155 
rc
 = 
	`g‘_·ge_äom_l4e
(
Æ4e
, 
pâ
, 
d
, 0, 
´“m±ibË
);

2156 iàĞ
	`uÆik–y
(
rc
 < 0) )

2157  
rc
;

2158 
rc
 = 0;

2160 
	`adju¡_gue¡_l4e
(
Æ4e
, 
d
);

2161 #ifdeà
ENABLE_PT_MODIFICATION


2162 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
,

2163 
´e£rve_ad
, 11, 4)) )

2165 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
,

2166 
´e£rve_ad
)) )

2169 
Ş4e
 = 
Æ4e
;

2170 
rc
 = -
EFAULT
;

2173 #ifdeà
ENABLE_PT_MODIFICATION


2174 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
,

2175 
´e£rve_ad
, 12, 4)) )

2177 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l4
, 
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
, 
vıu
,

2178 
´e£rve_ad
)) )

2181  -
EFAULT
;

2184 
	`put_·ge_äom_l4e
(
Ş4e
, 
pâ
, 0, 0);

2185 #ifdeà
ENABLE_PT_MODIFICATION


2186 
sucûss_l4
:

2187 
	`l4e_upd©e_sucûss
(
¶4e
, 
Ş4e
, 
Æ4e
, 
pâ
);

2189  
rc
;

2190 
	}
}

2194 
	$ş—nup_·ge_ÿch—‰r
(
·ge_šfo
 *
·ge
)

2196 
ušt32_t
 
ÿch—‰r
 =

2197 (
·ge
->
couÁ_šfo
 & 
PGC_ÿch—‰r_mask
è>> 
PGC_ÿch—‰r_ba£
;

2199 iàĞ
	`lik–y
(
ÿch—‰r
 == 0) )

2202 
·ge
->
couÁ_šfo
 &ğ~
PGC_ÿch—‰r_mask
;

2204 
	`BUG_ON
(
	`is_x’_h—p_·ge
(
·ge
));

2206  
	`upd©e_x’_m­pšgs
(
	`·ge_to_mâ
(
·ge
), 0);

2207 
	}
}

2209 
	$put_·ge
(
·ge_šfo
 *
·ge
)

2211 
nx
, 
x
, 
y
 = 
·ge
->
couÁ_šfo
;

2214 
	`ASSERT
((
y
 & 
PGC_couÁ_mask
) != 0);

2215 
x
 = 
y
;

2216 
nx
 = 
x
 - 1;

2218  
	`uÆik–y
((
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, 
nx
)) != x) );

2220 iàĞ
	`uÆik–y
((
nx
 & 
PGC_couÁ_mask
) == 0) )

2222 iàĞ
	`ş—nup_·ge_ÿch—‰r
(
·ge
) == 0 )

2223 
	`ä“_domh—p_·ge
(
·ge
);

2225 
	`MEM_LOG
("L—kšg…â %lx", 
	`·ge_to_mâ
(
·ge
));

2227 
	}
}

2230 
domaš
 *
	$·ge_g‘_owÃr_ªd_»ã»nû
(
·ge_šfo
 *
·ge
)

2232 
x
, 
y
 = 
·ge
->
couÁ_šfo
;

2235 
x
 = 
y
;

2241 iàĞ
	`uÆik–y
(((
x
 + 2è& 
PGC_couÁ_mask
) <= 2) )

2242  
NULL
;

2244  (
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, x + 1)) != x );

2246  
	`·ge_g‘_owÃr
(
·ge
);

2247 
	}
}

2250 
	$g‘_·ge
(
·ge_šfo
 *
·ge
, 
domaš
 *domain)

2252 
domaš
 *
owÃr
 = 
	`·ge_g‘_owÃr_ªd_»ã»nû
(
·ge
);

2254 iàĞ
	`lik–y
(
owÃr
 =ğ
domaš
) )

2257 iàĞ
owÃr
 !ğ
NULL
 )

2258 
	`put_·ge
(
·ge
);

2260 iàĞ!
	`_shadow_mode_»fcouÁs
(
domaš
è&& !domaš->
is_dyšg
 )

2261 
	`gd´štk
(
XENLOG_INFO
,

2263 
PRty³_šfo
 "\n",

2264 
	`·ge_to_mâ
(
·ge
), 
domaš
, 
owÃr
,

2265 
·ge
->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

2267 
	}
}

2277 
	$g‘_·ge_light
(
·ge_šfo
 *
·ge
)

2279 
x
, 
nx
, 
y
 = 
·ge
->
couÁ_šfo
;

2282 
x
 = 
y
;

2283 
nx
 = 
x
 + 1;

2284 
	`BUG_ON
(!(
x
 & 
PGC_couÁ_mask
));

2285 
	`BUG_ON
(!(
nx
 & 
PGC_couÁ_mask
));

2286 
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, 
nx
);

2288  
	`uÆik–y
(
y
 !ğ
x
) );

2289 
	}
}

2291 
	$®loc_·ge_ty³
(
·ge_šfo
 *
·ge
, 
ty³
,

2292 
´“m±ibË
)

2294 
domaš
 *
owÃr
 = 
	`·ge_g‘_owÃr
(
·ge
);

2295 
rc
;

2298 iàĞ
	`lik–y
(
owÃr
 !ğ
NULL
) )

2299 
	`·gšg_m¬k_dœty
(
owÃr
, 
	`·ge_to_mâ
(
·ge
));

2301  
ty³
 & 
PGT_ty³_mask
 )

2303 
PGT_l1_·ge_bË
:

2304 
rc
 = 
	`®loc_l1_bË
(
·ge
);

2306 
PGT_l2_·ge_bË
:

2307 
rc
 = 
	`®loc_l2_bË
(
·ge
, 
ty³
, 
´“m±ibË
);

2309 
PGT_l3_·ge_bË
:

2310 
rc
 = 
	`®loc_l3_bË
(
·ge
, 
´“m±ibË
);

2312 
PGT_l4_·ge_bË
:

2313 
rc
 = 
	`®loc_l4_bË
(
·ge
, 
´“m±ibË
);

2315 
PGT_£g_desc_·ge
:

2316 
rc
 = 
	`®loc_£gdesc_·ge
(
·ge
);

2319 
	`´štk
("Bady³ iÀ®loc_·ge_ty³ %lx=%" 
PRty³_šfo
 " c=%lx\n",

2320 
ty³
, 
·ge
->
u
.
šu£
.
ty³_šfo
,

2321 
·ge
->
couÁ_šfo
);

2322 
rc
 = -
EINVAL
;

2323 
	`BUG
();

2327 
	`wmb
();

2328 iàĞ
rc
 =ğ-
EAGAIN
 )

2330 
	`g‘_·ge_light
(
·ge
);

2331 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_·¹Ÿl
;

2333 iàĞ
rc
 =ğ-
EINTR
 )

2335 
	`ASSERT
((
·ge
->
u
.
šu£
.
ty³_šfo
 &

2336 (
PGT_couÁ_mask
|
PGT_v®id©ed
|
PGT_·¹Ÿl
)) == 1);

2337 
·ge
->
u
.
šu£
.
ty³_šfo
 &ğ~
PGT_couÁ_mask
;

2339 iàĞ
rc
 )

2341 
	`ASSERT
(
rc
 < 0);

2342 
	`MEM_LOG
("Error while validating mfn %lx (pfn %lx) forype %"

2343 
PRty³_šfo
 ": caf=%08lxaf=%" PRtype_info,

2344 
	`·ge_to_mâ
(
·ge
), 
	`g‘_gpâ_äom_mâ
(page_to_mfn(page)),

2345 
ty³
, 
·ge
->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

2346 
·ge
->
u
.
šu£
.
ty³_šfo
 = 0;

2350 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_v®id©ed
;

2353  
rc
;

2354 
	}
}

2357 
	$ä“_·ge_ty³
(
·ge_šfo
 *
·ge
, 
ty³
,

2358 
´“m±ibË
)

2360 
domaš
 *
owÃr
 = 
	`·ge_g‘_owÃr
(
·ge
);

2361 
gmâ
;

2362 
rc
;

2364 iàĞ
	`lik–y
(
owÃr
 !ğ
NULL
è&& 
	`uÆik–y
(
	`·gšg_mode_’abËd
(owner)) )

2367 
	`·gšg_m¬k_dœty
(
owÃr
, 
	`·ge_to_mâ
(
·ge
));

2369 iàĞ
	`shadow_mode_»fcouÁs
(
owÃr
) )

2372 
gmâ
 = 
	`mâ_to_gmâ
(
owÃr
, 
	`·ge_to_mâ
(
·ge
));

2373 
	`ASSERT
(
	`VALID_M2P
(
gmâ
));

2375 if(!
	`SHARED_M2P
(
gmâ
))

2376 
	`shadow_»move_®l_shadows
(
owÃr
->
vıu
[0], 
	`_mâ
(
gmâ
));

2379 iàĞ!(
ty³
 & 
PGT_·¹Ÿl
) )

2381 
·ge
->
Ä_v®id©ed_±es
 = 1U << 
PAGETABLE_ORDER
;

2382 
·ge
->
·¹Ÿl_±e
 = 0;

2385  
ty³
 & 
PGT_ty³_mask
 )

2387 
PGT_l1_·ge_bË
:

2388 
	`ä“_l1_bË
(
·ge
);

2389 
rc
 = 0;

2391 
PGT_l2_·ge_bË
:

2392 
rc
 = 
	`ä“_l2_bË
(
·ge
, 
´“m±ibË
);

2394 
PGT_l3_·ge_bË
:

2395 #ià
CONFIG_PAGING_LEVELS
 == 3

2396 iàĞ!(
ty³
 & 
PGT_·¹Ÿl
) )

2397 
·ge
->
Ä_v®id©ed_±es
 = 
L3_PAGETABLE_ENTRIES
;

2399 
rc
 = 
	`ä“_l3_bË
(
·ge
, 
´“m±ibË
);

2401 
PGT_l4_·ge_bË
:

2402 
rc
 = 
	`ä“_l4_bË
(
·ge
, 
´“m±ibË
);

2405 
	`MEM_LOG
("ty³ %lx…â %lx\n", 
ty³
, 
	`·ge_to_mâ
(
·ge
));

2406 
rc
 = -
EINVAL
;

2407 
	`BUG
();

2410  
rc
;

2411 
	}
}

2414 
	$__put_fš®_·ge_ty³
(

2415 
·ge_šfo
 *
·ge
, 
ty³
, 
´“m±ibË
)

2417 
rc
 = 
	`ä“_·ge_ty³
(
·ge
, 
ty³
, 
´“m±ibË
);

2420 iàĞ
rc
 == 0 )

2429 iàĞ!(
	`shadow_mode_’abËd
(
	`·ge_g‘_owÃr
(
·ge
)) &&

2430 (
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
)) )

2431 
·ge
->
bæush_time¡amp
 = 
	`bæush_cu¼’t_time
();

2432 
	`wmb
();

2433 
·ge
->
u
.
šu£
.
ty³_šfo
--;

2435 iàĞ
rc
 =ğ-
EINTR
 )

2437 
	`ASSERT
((
·ge
->
u
.
šu£
.
ty³_šfo
 &

2438 (
PGT_couÁ_mask
|
PGT_v®id©ed
|
PGT_·¹Ÿl
)) == 1);

2439 iàĞ!(
	`shadow_mode_’abËd
(
	`·ge_g‘_owÃr
(
·ge
)) &&

2440 (
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
)) )

2441 
·ge
->
bæush_time¡amp
 = 
	`bæush_cu¼’t_time
();

2442 
	`wmb
();

2443 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_v®id©ed
;

2447 
	`BUG_ON
(
rc
 !ğ-
EAGAIN
);

2448 
	`wmb
();

2449 
	`g‘_·ge_light
(
·ge
);

2450 
·ge
->
u
.
šu£
.
ty³_šfo
 |ğ
PGT_·¹Ÿl
;

2453  
rc
;

2454 
	}
}

2457 
	$__put_·ge_ty³
(
·ge_šfo
 *
·ge
,

2458 
´“m±ibË
)

2460 
nx
, 
x
, 
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
;

2461 
rc
 = 0;

2465 
x
 = 
y
;

2466 
nx
 = 
x
 - 1;

2468 
	`ASSERT
((
x
 & 
PGT_couÁ_mask
) != 0);

2470 iàĞ
	`uÆik–y
((
nx
 & 
PGT_couÁ_mask
) == 0) )

2472 iàĞ
	`uÆik–y
((
nx
 & 
PGT_ty³_mask
è<ğ
PGT_l4_·ge_bË
) &&

2473 
	`lik–y
(
nx
 & (
PGT_v®id©ed
|
PGT_·¹Ÿl
)) )

2480 
nx
 = 
x
 & ~(
PGT_v®id©ed
|
PGT_·¹Ÿl
);

2481 iàĞ
	`uÆik–y
((
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
,

2482 
x
, 
nx
)) != x) )

2485 
rc
 = 
	`__put_fš®_·ge_ty³
(
·ge
, 
x
, 
´“m±ibË
);

2486 iàĞ
x
 & 
PGT_·¹Ÿl
 )

2487 
	`put_·ge
(
·ge
);

2498 iàĞ!(
	`shadow_mode_’abËd
(
	`·ge_g‘_owÃr
(
·ge
)) &&

2499 (
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
)) )

2500 
·ge
->
bæush_time¡amp
 = 
	`bæush_cu¼’t_time
();

2503 iàĞ
	`lik–y
((
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
, 
nx
)) == x) )

2506 iàĞ
´“m±ibË
 && 
	`hy³rÿÎ_´“m±_check
() )

2507  -
EINTR
;

2510  
rc
;

2511 
	}
}

2514 
	$__g‘_·ge_ty³
(
·ge_šfo
 *
·ge
, 
ty³
,

2515 
´“m±ibË
)

2517 
nx
, 
x
, 
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
;

2518 
rc
 = 0;

2520 
	`ASSERT
(!(
ty³
 & ~(
PGT_ty³_mask
 | 
PGT_·e_x’_l2
)));

2524 
x
 = 
y
;

2525 
nx
 = 
x
 + 1;

2526 iàĞ
	`uÆik–y
((
nx
 & 
PGT_couÁ_mask
) == 0) )

2528 
	`MEM_LOG
("Ty³ couÁ ov”æow oÀpâ %lx", 
	`·ge_to_mâ
(
·ge
));

2529  -
EINVAL
;

2531 iàĞ
	`uÆik–y
((
x
 & 
PGT_couÁ_mask
) == 0) )

2533 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

2539 iàĞ
d
 && 
	`shadow_mode_’abËd
(d)

2540 && (
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
)

2541 && !((
·ge
->
shadow_æags
 & (1u<<29))

2542 && 
ty³
 =ğ
PGT_wr™abË_·ge
) )

2543 
	`shadow_»move_®l_shadows
(
d
->
vıu
[0], 
	`_mâ
(
	`·ge_to_mâ
(
·ge
)));

2545 
	`ASSERT
(!(
x
 & 
PGT_·e_x’_l2
));

2546 iàĞ(
x
 & 
PGT_ty³_mask
è!ğ
ty³
 )

2553 
ıumask_t
 
mask
 = 
d
->
domaš_dœty_ıumask
;

2556 
	`bæush_f‹r
(
mask
, 
·ge
->
bæush_time¡amp
);

2558 iàĞ
	`uÆik–y
(!
	`ıus_em±y
(
mask
)) &&

2560 (!
	`shadow_mode_’abËd
(
	`·ge_g‘_owÃr
(
·ge
)) ||

2561 ((
nx
 & 
PGT_ty³_mask
è=ğ
PGT_wr™abË_·ge
)) )

2563 
	`³rfc_šü
(
Ãed_æush_b_æush
);

2564 
	`æush_b_mask
(&
mask
);

2568 
nx
 &ğ~(
PGT_ty³_mask
 | 
PGT_v®id©ed
);

2569 
nx
 |ğ
ty³
;

2573 iàĞ
ty³
 =ğ
PGT_wr™abË_·ge
 ||y³ =ğ
PGT_sh¬ed_·ge
 )

2574 
nx
 |ğ
PGT_v®id©ed
;

2577 iàĞ
	`uÆik–y
((
x
 & (
PGT_ty³_mask
|
PGT_·e_x’_l2
)è!ğ
ty³
) )

2580 iàĞ((
x
 & 
PGT_ty³_mask
è=ğ
PGT_l2_·ge_bË
) &&

2581 (
ty³
 =ğ
PGT_l1_·ge_bË
) )

2582  -
EINVAL
;

2583 iàĞ((
x
 & 
PGT_ty³_mask
è=ğ
PGT_l3_·ge_bË
) &&

2584 (
ty³
 =ğ
PGT_l2_·ge_bË
) )

2585  -
EINVAL
;

2586 iàĞ((
x
 & 
PGT_ty³_mask
è=ğ
PGT_l4_·ge_bË
) &&

2587 (
ty³
 =ğ
PGT_l3_·ge_bË
) )

2588  -
EINVAL
;

2589 
	`MEM_LOG
("Bady³ (§w %" 
PRty³_šfo
 " !=ƒxp %" PRtype_info ") "

2591 
x
, 
ty³
, 
	`·ge_to_mâ
(
·ge
),

2592 
	`g‘_gpâ_äom_mâ
(
	`·ge_to_mâ
(
·ge
)));

2593  -
EINVAL
;

2595 iàĞ
	`uÆik–y
(!(
x
 & 
PGT_v®id©ed
)) )

2597 iàĞ!(
x
 & 
PGT_·¹Ÿl
) )

2600  (
y
 = 
·ge
->
u
.
šu£
.
ty³_šfo
è=ğ
x
 )

2602 iàĞ
´“m±ibË
 && 
	`hy³rÿÎ_´“m±_check
() )

2603  -
EINTR
;

2604 
	`ıu_»Ïx
();

2609 
	`ASSERT
((
x
 & 
PGT_couÁ_mask
) == 1);

2610 
nx
 = 
x
 & ~
PGT_·¹Ÿl
;

2613 iàĞ
	`lik–y
((
y
 = 
	`cmpxchg
(&
·ge
->
u
.
šu£
.
ty³_šfo
, 
x
, 
nx
)) == x) )

2616 iàĞ
´“m±ibË
 && 
	`hy³rÿÎ_´“m±_check
() )

2617  -
EINTR
;

2620 iàĞ
	`uÆik–y
((
x
 & 
PGT_ty³_mask
è!ğ
ty³
) )

2623 
domaš
 *
d
 = 
	`·ge_g‘_owÃr
(
·ge
);

2624 iàĞ
d
 && !
	`is_hvm_domaš
(dè&& 
	`uÆik–y
(
	`Ãed_iommu
(d)) )

2626 iàĞ(
x
 & 
PGT_ty³_mask
è=ğ
PGT_wr™abË_·ge
 )

2627 
	`iommu_unm­_·ge
(
d
, 
	`mâ_to_gmâ
(d, 
	`·ge_to_mâ
(
·ge
)));

2628 iàĞ
ty³
 =ğ
PGT_wr™abË_·ge
 )

2629 
	`iommu_m­_·ge
(
d
, 
	`mâ_to_gmâ
(d, 
	`·ge_to_mâ
(
·ge
)),

2630 
	`·ge_to_mâ
(
·ge
),

2631 
IOMMUF_»adabË
|
IOMMUF_wr™abË
);

2635 iàĞ
	`uÆik–y
(!(
nx
 & 
PGT_v®id©ed
)) )

2637 iàĞ!(
x
 & 
PGT_·¹Ÿl
) )

2639 
·ge
->
Ä_v®id©ed_±es
 = 0;

2640 
·ge
->
·¹Ÿl_±e
 = 0;

2642 
rc
 = 
	`®loc_·ge_ty³
(
·ge
, 
ty³
, 
´“m±ibË
);

2645 iàĞ(
x
 & 
PGT_·¹Ÿl
è&& !(
nx
 & PGT_partial) )

2646 
	`put_·ge
(
·ge
);

2648  
rc
;

2649 
	}
}

2651 
	$put_·ge_ty³
(
·ge_šfo
 *
·ge
)

2653 
rc
 = 
	`__put_·ge_ty³
(
·ge
, 0);

2654 
	`ASSERT
(
rc
 == 0);

2655 ()
rc
;

2656 
	}
}

2658 
	$g‘_·ge_ty³
(
·ge_šfo
 *
·ge
, 
ty³
)

2660 
rc
 = 
	`__g‘_·ge_ty³
(
·ge
, 
ty³
, 0);

2661 iàĞ
	`lik–y
(
rc
 == 0) )

2663 
	`ASSERT
(
rc
 =ğ-
EINVAL
);

2665 
	}
}

2667 
	$put_·ge_ty³_´“m±ibË
(
·ge_šfo
 *
·ge
)

2669  
	`__put_·ge_ty³
(
·ge
, 1);

2670 
	}
}

2672 
	$g‘_·ge_ty³_´“m±ibË
(
·ge_šfo
 *
·ge
, 
ty³
)

2674  
	`__g‘_·ge_ty³
(
·ge
, 
ty³
, 1);

2675 
	}
}

2677 
	$g‘_¥age_·ges
(
·ge_šfo
 *
·ge
, 
domaš
 *
d
)

2679 
i
;

2681 
i
 = 0; i < (1<<
PAGETABLE_ORDER
); i++, 
·ge
++)

2683 ià(!
	`g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_wr™abË_·ge
))

2685 --
i
 >= 0)

2686 
	`put_·ge_ªd_ty³
(--
·ge
);

2691 
	}
}

2693 
	$put_¥age_·ges
(
·ge_šfo
 *
·ge
)

2695 
i
;

2697 
i
 = 0; i < (1<<
PAGETABLE_ORDER
); i++, 
·ge
++)

2699 
	`put_·ge_ªd_ty³
(
·ge
);

2702 
	}
}

2704 #ifdeà
__x86_64__


2706 
	$m¬k_su³½age
(
¥age_šfo
 *
¥age
, 
domaš
 *
d
)

2708 
x
, 
nx
, 
y
 = 
¥age
->
ty³_šfo
;

2709 
·ges_dÚe
 = 0;

2711 
	`ASSERT
(
İt_®low_su³½age
);

2714 
x
 = 
y
;

2715 
nx
 = 
x
 + 1;

2716 iàĞ(
x
 & 
SGT_ty³_mask
è=ğ
SGT_m¬k
 )

2718 
	`MEM_LOG
("Duplicate superpage mark‡ttempt mfn %lx",

2719 
	`¥age_to_mâ
(
¥age
));

2720 iàĞ
·ges_dÚe
 )

2721 
	`put_¥age_·ges
(
	`¥age_to_·ge
(
¥age
));

2722  -
EINVAL
;

2724 iàĞ(
x
 & 
SGT_ty³_mask
è=ğ
SGT_dyÇmic
 )

2726 iàĞ
·ges_dÚe
 )

2728 
	`put_¥age_·ges
(
	`¥age_to_·ge
(
¥age
));

2729 
·ges_dÚe
 = 0;

2732 iàĞ!
·ges_dÚe
 )

2734 iàĞ!
	`g‘_¥age_·ges
(
	`¥age_to_·ge
(
¥age
), 
d
) )

2736 
	`MEM_LOG
("Superpageype conflict in mark‡ttempt mfn %lx",

2737 
	`¥age_to_mâ
(
¥age
));

2738  -
EINVAL
;

2740 
·ges_dÚe
 = 1;

2742 
nx
 = (nx & ~
SGT_ty³_mask
è| 
SGT_m¬k
;

2744 }  (
y
 = 
	`cmpxchg
(&
¥age
->
ty³_šfo
, 
x
, 
nx
)) != x );

2747 
	}
}

2749 
	$unm¬k_su³½age
(
¥age_šfo
 *
¥age
)

2751 
x
, 
nx
, 
y
 = 
¥age
->
ty³_šfo
;

2752 
do_·ges
 = 0;

2754 
	`ASSERT
(
İt_®low_su³½age
);

2757 
x
 = 
y
;

2758 
nx
 = 
x
 - 1;

2759 iàĞ(
x
 & 
SGT_ty³_mask
è!ğ
SGT_m¬k
 )

2761 
	`MEM_LOG
("Attempto unmark unmarked superpage mfn %lx",

2762 
	`¥age_to_mâ
(
¥age
));

2763  -
EINVAL
;

2765 iàĞ(
nx
 & 
SGT_couÁ_mask
) == 0 )

2767 
nx
 = (nx & ~
SGT_ty³_mask
è| 
SGT_nÚe
;

2768 
do_·ges
 = 1;

2772 
nx
 = (nx & ~
SGT_ty³_mask
è| 
SGT_dyÇmic
;

2774 }  (
y
 = 
	`cmpxchg
(&
¥age
->
ty³_šfo
, 
x
, 
nx
)) != x );

2776 iàĞ
do_·ges
 )

2777 
	`put_¥age_·ges
(
	`¥age_to_·ge
(
¥age
));

2780 
	}
}

2782 
	$ş—r_su³½age_m¬k
(
·ge_šfo
 *
·ge
)

2784 
¥age_šfo
 *
¥age
;

2786 iàĞ!
İt_®low_su³½age
 )

2789 
¥age
 = 
	`·ge_to_¥age
(
·ge
);

2790 ià((
¥age
->
ty³_šfo
 & 
SGT_ty³_mask
è=ğ
SGT_m¬k
)

2791 
	`unm¬k_su³½age
(
¥age
);

2793 
	}
}

2795 
	$g‘_su³½age
(
mâ
, 
domaš
 *
d
)

2797 
¥age_šfo
 *
¥age
;

2798 
x
, 
nx
, 
y
;

2799 
·ges_dÚe
 = 0;

2801 
	`ASSERT
(
İt_®low_su³½age
);

2803 
¥age
 = 
	`mâ_to_¥age
(
mâ
);

2804 
y
 = 
¥age
->
ty³_šfo
;

2806 
x
 = 
y
;

2807 
nx
 = 
x
 + 1;

2808 iàĞ(
x
 & 
SGT_ty³_mask
è!ğ
SGT_nÚe
 )

2810 iàĞ
·ges_dÚe
 )

2812 
	`put_¥age_·ges
(
	`¥age_to_·ge
(
¥age
));

2813 
·ges_dÚe
 = 0;

2818 iàĞ!
	`g‘_¥age_·ges
(
	`¥age_to_·ge
(
¥age
), 
d
) )

2820 
	`MEM_LOG
("Type conflict on superpage mapping mfn %lx",

2821 
	`¥age_to_mâ
(
¥age
));

2822  -
EINVAL
;

2824 
·ges_dÚe
 = 1;

2825 
nx
 = (nx & ~
SGT_ty³_mask
è| 
SGT_dyÇmic
;

2827 }  (
y
 = 
	`cmpxchg
(&
¥age
->
ty³_šfo
, 
x
, 
nx
)) != x );

2830 
	}
}

2832 
	$put_su³½age
(
mâ
)

2834 
¥age_šfo
 *
¥age
;

2835 
x
, 
nx
, 
y
;

2836 
do_·ges
 = 0;

2838 iàĞ!
İt_®low_su³½age
 )

2840 
	`put_¥age_·ges
(
	`mâ_to_·ge
(
mâ
));

2844 
¥age
 = 
	`mâ_to_¥age
(
mâ
);

2845 
y
 = 
¥age
->
ty³_šfo
;

2847 
x
 = 
y
;

2848 
nx
 = 
x
 - 1;

2849 ià((
x
 & 
SGT_ty³_mask
è=ğ
SGT_dyÇmic
)

2851 ià((
nx
 & 
SGT_couÁ_mask
) == 0)

2853 
nx
 = (nx & ~
SGT_ty³_mask
è| 
SGT_nÚe
;

2854 
do_·ges
 = 1;

2858 } (
y
 = 
	`cmpxchg
(&
¥age
->
ty³_šfo
, 
x
, 
nx
)) != x);

2860 ià(
do_·ges
)

2861 
	`put_¥age_·ges
(
	`¥age_to_·ge
(
¥age
));

2864 
	}
}

2868 
	$ş—r_su³½age_m¬k
(
·ge_šfo
 *
·ge
)

2870 
	}
}

2872 
	$g‘_su³½age
(
mâ
, 
domaš
 *
d
)

2874  
	`g‘_¥age_·ges
(
	`mâ_to_·ge
(
mâ
), 
d
);

2875 
	}
}

2877 
	$put_su³½age
(
mâ
)

2879 
	`put_¥age_·ges
(
	`mâ_to_·ge
(
mâ
));

2880 
	}
}

2885 
	$Ãw_gue¡_ü3
(
mâ
)

2887 
vıu
 *
cu¼
 = 
cu¼’t
;

2888 
domaš
 *
d
 = 
cu¼
->domain;

2889 
okay
;

2890 
Şd_ba£_mâ
;

2892 #ifdeà
__x86_64__


2893 iàĞ
	`is_pv_32Ú64_domaš
(
d
) )

2896 
	`my·nic
("new_guest_cr3:‚ot-supported 32on64");

2898 
okay
 = 
	`·gšg_mode_»fcouÁs
(
d
)

2900 : 
	`mod_l4_’Œy
(

2901 
	`__va
(
	`·g‘abË_g‘_·ddr
(
cu¼
->
¬ch
.
gue¡_bË
)),

2902 
	`l4e_äom_pâ
(

2903 
mâ
,

2904 (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_ACCESSED
)),

2905 
	`·g‘abË_g‘_pâ
(
cu¼
->
¬ch
.
gue¡_bË
), 0, 0, curr) == 0;

2906 iàĞ
	`uÆik–y
(!
okay
) )

2908 
	`MEM_LOG
("E¼Ü whš¡®lšg‚ew com·ˆba£±¸%lx", 
mâ
);

2912 
	`šv®id©e_shadow_ldt
(
cu¼
, 0);

2913 
	`wr™e_±ba£
(
cu¼
);

2918 
okay
 = 
	`·gšg_mode_»fcouÁs
(
d
)

2919 ? 
	`g‘_·ge_äom_·g’r
(
mâ
, 
d
)

2920 : !
	`g‘_·ge_ªd_ty³_äom_·g’r
(
mâ
, 
PGT_roÙ_·ge_bË
, 
d
, 0, 0);

2921 iàĞ
	`uÆik–y
(!
okay
) )

2923 
	`MEM_LOG
("E¼Ü whš¡®lšg‚ew ba£±¸%lx", 
mâ
);

2927 
	`šv®id©e_shadow_ldt
(
cu¼
, 0);

2929 
Şd_ba£_mâ
 = 
	`·g‘abË_g‘_pâ
(
cu¼
->
¬ch
.
gue¡_bË
);

2931 
cu¼
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_äom_pâ
(
mâ
);

2932 
	`upd©e_ü3
(
cu¼
);

2933 #ifdeà
ENABLE_PGD


2934 
shadow_ü3
 = 
NULL
;

2935 ià(
mši_aùiv©ed
)

2936 
shadow_ü3
 = 
	`chªge_ü3
(
Şd_ba£_mâ
);

2937 ià(
shadow_ü3
) {

2938 #ifdeà
ENABLE_PER_CACHE_PT


2939 #ifdeà
NO_PGD_ABOVE_4GB


2940 
	`MYASSERT
(!(
shadow_ü3
 & 0xffffffff00000fff));

2942 
	`_wr™e_ü3
(
shadow_ü3
, 2);

2945 
	`_wr™e_ü3
(
cu¼
->
¬ch
.
ü3
, 2);

2948 
	`wr™e_±ba£
(
cu¼
);

2951 iàĞ
	`lik–y
(
Şd_ba£_mâ
 != 0) )

2953 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

2954 
	`put_·ge
(
	`mâ_to_·ge
(
Şd_ba£_mâ
));

2956 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
Şd_ba£_mâ
));

2960 
	}
}

2962 
domaš
 *
	$g‘_pg_owÃr
(
domid_t
 
domid
)

2964 
domaš
 *
pg_owÃr
 = 
NULL
, *
cu¼
 = 
cu¼’t
->domain;

2966 iàĞ
	`lik–y
(
domid
 =ğ
DOMID_SELF
) )

2968 
pg_owÃr
 = 
	`rcu_lock_cu¼’t_domaš
();

2969 
out
;

2972 iàĞ
	`uÆik–y
(
domid
 =ğ
cu¼
->
domaš_id
) )

2974 
	`MEM_LOG
("Cannot specify itself‡s foreign domain");

2975 
out
;

2978 iàĞ
	`uÆik–y
(
	`·gšg_mode_Œª¦©e
(
cu¼
)) )

2980 
	`MEM_LOG
("Cannot mix foreign mappings withranslated domains");

2981 
out
;

2984  
domid
 )

2986 
DOMID_IO
:

2987 
pg_owÃr
 = 
	`rcu_lock_domaš
(
dom_io
);

2989 
DOMID_XEN
:

2990 iàĞ!
	`IS_PRIV
(
cu¼
) )

2992 
	`MEM_LOG
("Cannot set foreign dom");

2995 
pg_owÃr
 = 
	`rcu_lock_domaš
(
dom_x’
);

2998 iàĞ(
pg_owÃr
 = 
	`rcu_lock_domaš_by_id
(
domid
)è=ğ
NULL
 )

3000 
	`MEM_LOG
("UnknowÀdomaš '%u'", 
domid
);

3003 iàĞ!
	`IS_PRIV_FOR
(
cu¼
, 
pg_owÃr
) )

3005 
	`MEM_LOG
("Cannot set foreign dom");

3006 
	`rcu_uÆock_domaš
(
pg_owÃr
);

3007 
pg_owÃr
 = 
NULL
;

3012 
out
:

3013  
pg_owÃr
;

3014 
	}
}

3016 
	$put_pg_owÃr
(
domaš
 *
pg_owÃr
)

3018 
	`rcu_uÆock_domaš
(
pg_owÃr
);

3019 
	}
}

3021 
šlše
 
vıumask_to_pıumask
(

3022 
domaš
 *
d
, 
	$XEN_GUEST_HANDLE
(
cÚ¡_void
è
bm­
, 
ıumask_t
 *
pmask
)

3024 
vıu_id
, 
vıu_bŸs
, 
offs
;

3025 
vmask
;

3026 
vıu
 *
v
;

3027 
boŞ_t
 
is_Çtive
 = !
	`is_pv_32Ú64_domaš
(
d
);

3029 
	`ıus_ş—r
(*
pmask
);

3030  
vmask
 = 0, 
offs
 = 0; ; ++offs)

3032 
vıu_bŸs
 = 
offs
 * (
is_Çtive
 ? 
BITS_PER_LONG
 : 32);

3033 iàĞ
vıu_bŸs
 >ğ
d
->
max_vıus
 )

3036 iàĞ
	`uÆik–y
(
is_Çtive
 ?

3037 
	`cİy_äom_gue¡_off£t
(&
vmask
, 
bm­
, 
offs
, 1) :

3038 
	`cİy_äom_gue¡_off£t
((*)&
vmask
, 
bm­
,

3039 
offs
, 1)) )

3041 
	`ıus_ş—r
(*
pmask
);

3042  -
EFAULT
;

3045  
vmask
 )

3047 
vıu_id
 = 
	`fšd_fœ¡_£t_b™
(
vmask
);

3048 
vmask
 &ğ~(1UL << 
vıu_id
);

3049 
vıu_id
 +ğ
vıu_bŸs
;

3050 iàĞ(
vıu_id
 >ğ
d
->
max_vıus
) )

3052 iàĞ((
v
 = 
d
->
vıu
[
vıu_id
]è!ğ
NULL
) )

3053 
	`ıus_Ü
(*
pmask
, *pmask, 
v
->
vıu_dœty_ıumask
);

3056 
	}
}

3058 #ifdeà
__i386__


3059 
šlše
 *
	$fixm­_domaš_·ge
(
mâ
)

3061 
ıu
 = 
	`smp_´oûssÜ_id
();

3062 *
±r
 = (*)
	`fix_to_vœt
(
FIX_PAE_HIGHMEM_0
 + 
ıu
);

3064 
	`l1e_wr™e
(
fix_·e_highmem_¶1e
 - 
ıu
,

3065 
	`l1e_äom_pâ
(
mâ
, 
__PAGE_HYPERVISOR
));

3066 
	`æush_b_Úe_loÿl
(
±r
);

3067  
±r
;

3068 
	}
}

3069 
šlše
 
	$fixunm­_domaš_·ge
(cÚ¡ *
±r
)

3071 
ıu
 = 
	`vœt_to_fix
(()
±r
è- 
FIX_PAE_HIGHMEM_0
;

3073 
	`l1e_wr™e
(
fix_·e_highmem_¶1e
 - 
ıu
, 
	`l1e_em±y
());

3074 
	`this_ıu
(
make_ü3_time¡amp
èğthis_ıu(
bæush_time
);

3075 
	}
}

3077 
	#fixm­_domaš_·ge
(
mâ
è
	`mâ_to_vœt
(mâ)

	)

3078 
	#fixunm­_domaš_·ge
(
±r
è(()ÕŒ))

	)

3081 
do_mmuext_İ
(

3082 
	$XEN_GUEST_HANDLE
(
mmuext_İ_t
è
uİs
,

3083 
couÁ
,

3084 
	$XEN_GUEST_HANDLE
(
ušt
è
pdÚe
,

3085 
fÜeigndom
)

3087 
mmuext_İ
 
İ
;

3088 
rc
 = 0, 
i
 = 0, 
okay
;

3089 
ty³
;

3090 
dÚe
 = 0;

3091 
vıu
 *
cu¼
 = 
cu¼’t
;

3092 
domaš
 *
d
 = 
cu¼
->domain;

3093 
domaš
 *
pg_owÃr
;

3095 iàĞ
	`uÆik–y
(
couÁ
 & 
MMU_UPDATE_PREEMPTED
) )

3097 
couÁ
 &ğ~
MMU_UPDATE_PREEMPTED
;

3098 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_is_nuÎ
(
pdÚe
)) )

3099 ()
	`cİy_äom_gue¡
(&
dÚe
, 
pdÚe
, 1);

3102 
	`³rfc_šü
(
ÿÎs_to_mmuext_İ
);

3104 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_okay
(
uİs
, 
couÁ
)) )

3106 
rc
 = -
EFAULT
;

3107 
out
;

3110 iàĞ(
pg_owÃr
 = 
	`g‘_pg_owÃr
(
fÜeigndom
)è=ğ
NULL
 )

3112 
rc
 = -
ESRCH
;

3113 
out
;

3116  
i
 = 0; i < 
couÁ
; i++ )

3118 iàĞ
	`hy³rÿÎ_´“m±_check
() )

3120 
rc
 = -
EAGAIN
;

3124 iàĞ
	`uÆik–y
(
	`__cİy_äom_gue¡
(&
İ
, 
uİs
, 1) != 0) )

3126 
	`MEM_LOG
("Bad __copy_from_guest");

3127 
rc
 = -
EFAULT
;

3131 
okay
 = 1;

3133  
İ
.
cmd
 )

3135 
MMUEXT_PIN_L1_TABLE
:

3136 
ty³
 = 
PGT_l1_·ge_bË
;

3137 
pš_·ge
;

3139 
MMUEXT_PIN_L2_TABLE
:

3140 
ty³
 = 
PGT_l2_·ge_bË
;

3141 
pš_·ge
;

3143 
MMUEXT_PIN_L3_TABLE
:

3144 
ty³
 = 
PGT_l3_·ge_bË
;

3145 
pš_·ge
;

3147 
MMUEXT_PIN_L4_TABLE
:

3148 iàĞ
	`is_pv_32b™_domaš
(
pg_owÃr
) )

3150 
ty³
 = 
PGT_l4_·ge_bË
;

3152 
pš_·ge
: {

3153 
mâ
;

3154 
·ge_šfo
 *
·ge
;

3157 iàĞ(
İ
.
cmd
 - 
MMUEXT_PIN_L1_TABLE
è> (
CONFIG_PAGING_LEVELS
 - 1) )

3160 iàĞ
	`·gšg_mode_»fcouÁs
(
pg_owÃr
) )

3163 
mâ
 = 
	`gmâ_to_mâ
(
pg_owÃr
, 
İ
.
¬g1
.mfn);

3164 
rc
 = 
	`g‘_·ge_ªd_ty³_äom_·g’r
(
mâ
, 
ty³
, 
pg_owÃr
, 0, 1);

3165 
okay
 = !
rc
;

3166 iàĞ
	`uÆik–y
(!
okay
) )

3168 iàĞ
rc
 =ğ-
EINTR
 )

3169 
rc
 = -
EAGAIN
;

3170 iàĞ
rc
 !ğ-
EAGAIN
 )

3171 
	`MEM_LOG
("E¼Ü whpšnšg mâ %lx", 
mâ
);

3175 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

3177 iàĞ(
rc
 = 
	`xsm_memÜy_pš_·ge
(
d
, 
·ge
)) != 0 )

3179 
	`put_·ge_ªd_ty³
(
·ge
);

3180 
okay
 = 0;

3184 iàĞ
	`uÆik–y
(
	`‹¡_ªd_£t_b™
(
_PGT_pšÃd
,

3185 &
·ge
->
u
.
šu£
.
ty³_šfo
)) )

3187 
	`MEM_LOG
("Mâ %lx‡Ì—dy…šÃd", 
mâ
);

3188 
	`put_·ge_ªd_ty³
(
·ge
);

3189 
okay
 = 0;

3194 
	`·gšg_m¬k_dœty
(
pg_owÃr
, 
mâ
);

3195 #ifdeà
VERBOSE_PINNING


3197 ià(
mši_aùiv©ed
)

3198 
	`my´štk
("mâ:%x…šÃd\n", 
mâ
);

3202 iàĞ
	`uÆik–y
(
pg_owÃr
 !ğ
d
) )

3204 
drİ_»f
;

3205 
	`¥š_lock
(&
pg_owÃr
->
·ge_®loc_lock
);

3206 
drİ_»f
 = (
pg_owÃr
->
is_dyšg
 &&

3207 
	`‹¡_ªd_ş—r_b™
(
_PGT_pšÃd
,

3208 &
·ge
->
u
.
šu£
.
ty³_šfo
));

3209 
	`¥š_uÆock
(&
pg_owÃr
->
·ge_®loc_lock
);

3210 iàĞ
drİ_»f
 )

3211 
	`put_·ge_ªd_ty³
(
·ge
);

3217 
MMUEXT_UNPIN_TABLE
: {

3218 
mâ
;

3219 
·ge_šfo
 *
·ge
;

3221 iàĞ
	`·gšg_mode_»fcouÁs
(
pg_owÃr
) )

3224 
mâ
 = 
	`gmâ_to_mâ
(
pg_owÃr
, 
İ
.
¬g1
.mfn);

3225 iàĞ
	`uÆik–y
(!(
okay
 = 
	`g‘_·ge_äom_·g’r
(
mâ
, 
pg_owÃr
))) )

3227 
	`MEM_LOG
("Mâ %lx bad domaš", 
mâ
);

3231 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

3233 iàĞ!
	`‹¡_ªd_ş—r_b™
(
_PGT_pšÃd
, &
·ge
->
u
.
šu£
.
ty³_šfo
) )

3235 
okay
 = 0;

3236 
	`put_·ge
(
·ge
);

3237 
	`MEM_LOG
("Mâ %lx‚Ù…šÃd", 
mâ
);

3241 
	`put_·ge_ªd_ty³
(
·ge
);

3242 
	`put_·ge
(
·ge
);

3244 ià(
mši_aùiv©ed
) {

3245 
	`mâ_check
(
mâ
);

3246 #ifdeà
VERBOSE_PINNING


3247 
	`my´štk
("mâ:%x uÅšÃd\n",
mâ
 );

3258 
	`·gšg_m¬k_dœty
(
pg_owÃr
, 
mâ
);

3263 
MMUEXT_NEW_BASEPTR
:

3264 
okay
 = 
	`Ãw_gue¡_ü3
(
	`gmâ_to_mâ
(
d
, 
İ
.
¬g1
.
mâ
));

3267 #ifdeà
__x86_64__


3268 
MMUEXT_NEW_USER_BASEPTR
: {

3269 
Şd_mâ
, 
mâ
;

3271 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
İ
.
¬g1
.mfn);

3272 iàĞ
mâ
 != 0 )

3274 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

3275 
okay
 = 
	`g‘_·ge_äom_·g’r
(
mâ
, 
d
);

3277 
okay
 = !
	`g‘_·ge_ªd_ty³_äom_·g’r
(

3278 
mâ
, 
PGT_roÙ_·ge_bË
, 
d
, 0, 0);

3279 iàĞ
	`uÆik–y
(!
okay
) )

3281 
	`MEM_LOG
("E¼Ü whš¡®lšg‚ew mâ %lx", 
mâ
);

3286 
Şd_mâ
 = 
	`·g‘abË_g‘_pâ
(
cu¼
->
¬ch
.
gue¡_bË_u£r
);

3287 
cu¼
->
¬ch
.
gue¡_bË_u£r
 = 
	`·g‘abË_äom_pâ
(
mâ
);

3288 #ifdeà
ENABLE_PGD


3289 ià(
mši_aùiv©ed
) {

3290 
·ge_dœ
 *
pgd
 = 
cu¼’t
->
cu¼’t_pgd
;

3292 ià(
pgd
 && 
mâ
) {

3293 
·ge_bË
 *
±
;

3294 #ifdeà
ENABLE_PTMAN


3295 
	`±mª_lock
(
mâ
);

3296 
	`MYASSERT
Ğ!
	`fšd_pgd
(
mâ
, &
±
) );

3297 
	`±mª_uÆock
(
mâ
);

3298 ià(
pgd
->
mâ_u£r
) {

3299 
	`MYASSERT
(
±
 &&…t->
u£r_l4
);

3300 
	`MYASSERT
(
pgd
->
mâ_u£r
 =ğ
mâ
);

3302 
	`MYASSERT
(!
±
);

3303 
±
 = 
	`add_pgd_u£r
(
mâ
);

3304 
pgd
->
mâ_u£r
 = 
mâ
;

3307 
	`my¥š_lock
(&
pgd_li¡_lock
, 175);

3308 
	`MYASSERT
Ğ!
	`fšd_pgd_sim¶e
(
mâ
) );

3309 
	`¥š_uÆock
(&
pgd_li¡_lock
);

3310 ià(
pgd
->
mâ_u£r
) {

3311 
	`MYASSERT
(
pgd
->
mâ_u£r
 =ğ
mâ
);

3313 
pgd
->
mâ_u£r
 = 
mâ
;

3319 iàĞ
Şd_mâ
 != 0 )

3321 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

3322 
	`put_·ge
(
	`mâ_to_·ge
(
Şd_mâ
));

3324 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
Şd_mâ
));

3331 
MMUEXT_TLB_FLUSH_LOCAL
:

3332 
	`æush_b_loÿl
();

3335 
MMUEXT_INVLPG_LOCAL
:

3336 iàĞ!
	`·gšg_mode_’abËd
(
d
)

3337 || 
	`·gšg_švÍg
(
cu¼
, 
İ
.
¬g1
.
lš—r_addr
) != 0 )

3338 
	`æush_b_Úe_loÿl
(
İ
.
¬g1
.
lš—r_addr
);

3341 
MMUEXT_TLB_FLUSH_MULTI
:

3342 
MMUEXT_INVLPG_MULTI
:

3344 
ıumask_t
 
pmask
;

3346 iàĞ
	`uÆik–y
(
	`vıumask_to_pıumask
(
d
, 
İ
.
¬g2
.
vıumask
, &
pmask
)) )

3348 
okay
 = 0;

3351 iàĞ
İ
.
cmd
 =ğ
MMUEXT_TLB_FLUSH_MULTI
 )

3352 
	`æush_b_mask
(&
pmask
);

3354 
	`æush_b_Úe_mask
(&
pmask
, 
İ
.
¬g1
.
lš—r_addr
);

3358 
MMUEXT_TLB_FLUSH_ALL
:

3359 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

3362 
MMUEXT_INVLPG_ALL
:

3363 
	`æush_b_Úe_mask
(&
d
->
domaš_dœty_ıumask
, 
İ
.
¬g1
.
lš—r_addr
);

3366 
MMUEXT_FLUSH_CACHE
:

3367 iàĞ
	`uÆik–y
(!
	`ÿche_æush_³rm™‹d
(
d
)) )

3369 
	`MEM_LOG
("Non-physdev domainriedo FLUSH_CACHE.");

3370 
okay
 = 0;

3374 
	`wbšvd
();

3378 
MMUEXT_FLUSH_CACHE_GLOBAL
:

3379 iàĞ
	`uÆik–y
(
fÜeigndom
 !ğ
DOMID_SELF
) )

3380 
okay
 = 0;

3381 iàĞ
	`lik–y
(
	`ÿche_æush_³rm™‹d
(
d
)) )

3383 
ıu
;

3384 
ıumask_t
 
mask
 = 
CPU_MASK_NONE
;

3386 
	`fÜ_—ch_Úlše_ıu
(
ıu
)

3387 iàĞ!
	`ıus_š‹r£ùs
(
mask
,

3388 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
)) )

3389 
	`ıu_£t
(
ıu
, 
mask
);

3390 
	`æush_mask
(&
mask
, 
FLUSH_CACHE
);

3394 
	`MEM_LOG
("Non-physdev domainriedo FLUSH_CACHE_GLOBAL");

3395 
okay
 = 0;

3399 
MMUEXT_SET_LDT
:

3401 
±r
 = 
İ
.
¬g1
.
lš—r_addr
;

3402 
’ts
 = 
İ
.
¬g2
.
Ä_’ts
;

3404 iàĞ
	`·gšg_mode_ex‹º®
(
d
) )

3406 
	`MEM_LOG
("ignoring SET_LDT hypercall fromƒxternal domain");

3407 
okay
 = 0;

3409 iàĞ((
±r
 & (
PAGE_SIZE
-1)) != 0) ||

3410 (
’ts
 > 8192) ||

3411 !
	`¬¿y_acûss_ok
(
±r
, 
’ts
, 
LDT_ENTRY_SIZE
) )

3413 
okay
 = 0;

3414 
	`MEM_LOG
("Bad‡rg tØSET_LDT:…Œ=%lx,ƒÁs=%lx", 
±r
, 
’ts
);

3416 iàĞ(
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_’ts
 !ğ
’ts
) ||

3417 (
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_ba£
 !ğ
±r
) )

3419 
	`šv®id©e_shadow_ldt
(
cu¼
, 0);

3420 
	`æush_b_loÿl
();

3421 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_ba£
 = 
±r
;

3422 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_’ts
 = 
’ts
;

3423 
	`lßd_LDT
(
cu¼
);

3424 iàĞ
’ts
 != 0 )

3425 ()
	`m­_ldt_shadow_·ge
(0);

3430 
MMUEXT_CLEAR_PAGE
: {

3431 
mâ
;

3432 *
±r
;

3434 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
İ
.
¬g1
.mfn);

3435 
okay
 = !
	`g‘_·ge_ªd_ty³_äom_·g’r
(

3436 
mâ
, 
PGT_wr™abË_·ge
, 
d
, 0, 0);

3437 iàĞ
	`uÆik–y
(!
okay
) )

3439 
	`MEM_LOG
("E¼Ü whş—ršg mâ %lx", 
mâ
);

3444 
	`·gšg_m¬k_dœty
(
d
, 
mâ
);

3446 
±r
 = 
	`fixm­_domaš_·ge
(
mâ
);

3447 
	`ş—r_·ge
(
±r
);

3448 
	`fixunm­_domaš_·ge
(
±r
);

3450 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

3454 
MMUEXT_COPY_PAGE
:

3456 cÚ¡ *
¤c
;

3457 *
d¡
;

3458 
¤c_mâ
, 
mâ
;

3460 
¤c_mâ
 = 
	`gmâ_to_mâ
(
d
, 
İ
.
¬g2
.src_mfn);

3461 
okay
 = 
	`g‘_·ge_äom_·g’r
(
¤c_mâ
, 
d
);

3462 iàĞ
	`uÆik–y
(!
okay
) )

3464 
	`MEM_LOG
("E¼Ü whcİyšg from mâ %lx", 
¤c_mâ
);

3468 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
İ
.
¬g1
.mfn);

3469 
okay
 = !
	`g‘_·ge_ªd_ty³_äom_·g’r
(

3470 
mâ
, 
PGT_wr™abË_·ge
, 
d
, 0, 0);

3471 iàĞ
	`uÆik–y
(!
okay
) )

3473 
	`put_·ge
(
	`mâ_to_·ge
(
¤c_mâ
));

3474 
	`MEM_LOG
("E¼Ü whcİyšgØmâ %lx", 
mâ
);

3479 
	`·gšg_m¬k_dœty
(
d
, 
mâ
);

3481 
¤c
 = 
	`m­_domaš_·ge
(
¤c_mâ
);

3482 
d¡
 = 
	`fixm­_domaš_·ge
(
mâ
);

3483 
	`cİy_·ge
(
d¡
, 
¤c
);

3484 
	`fixunm­_domaš_·ge
(
d¡
);

3485 
	`unm­_domaš_·ge
(
¤c
);

3487 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

3488 
	`put_·ge
(
	`mâ_to_·ge
(
¤c_mâ
));

3492 #ifdeà
__x86_64__


3493 
MMUEXT_MARK_SUPER
:

3495 
mâ
;

3496 
¥age_šfo
 *
¥age
;

3498 
mâ
 = 
İ
.
¬g1
.mfn;

3499 iàĞ
mâ
 & (
L1_PAGETABLE_ENTRIES
-1) )

3501 
	`MEM_LOG
("UÇligÃd su³½ag»ã»nû mâ %lx", 
mâ
);

3502 
okay
 = 0;

3506 iàĞ!
İt_®low_su³½age
 )

3508 
	`MEM_LOG
("Superpages disallowed");

3509 
okay
 = 0;

3510 
rc
 = -
ENOSYS
;

3514 
¥age
 = 
	`mâ_to_¥age
(
mâ
);

3515 
okay
 = (
	`m¬k_su³½age
(
¥age
, 
d
) >= 0);

3519 
MMUEXT_UNMARK_SUPER
:

3521 
mâ
;

3522 
¥age_šfo
 *
¥age
;

3524 
mâ
 = 
İ
.
¬g1
.mfn;

3525 iàĞ
mâ
 & (
L1_PAGETABLE_ENTRIES
-1) )

3527 
	`MEM_LOG
("UÇligÃd su³½ag»ã»nû mâ %lx", 
mâ
);

3528 
okay
 = 0;

3532 iàĞ!
İt_®low_su³½age
 )

3534 
	`MEM_LOG
("Superpages disallowed");

3535 
okay
 = 0;

3536 
rc
 = -
ENOSYS
;

3540 
¥age
 = 
	`mâ_to_¥age
(
mâ
);

3541 
okay
 = (
	`unm¬k_su³½age
(
¥age
) >= 0);

3547 
	`MEM_LOG
("Inv®idƒx‹nded…ˆcommªd 0x%x", 
İ
.
cmd
);

3548 
rc
 = -
ENOSYS
;

3549 
okay
 = 0;

3553 iàĞ
	`uÆik–y
(!
okay
) )

3555 
rc
 =„ø?„ø: -
EINVAL
;

3559 
	`gue¡_hªdË_add_off£t
(
uİs
, 1);

3562 iàĞ
rc
 =ğ-
EAGAIN
 )

3563 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

3564 
__HYPERVISOR_mmuext_İ
, "hihi",

3565 
uİs
, (
couÁ
 - 
i
è| 
MMU_UPDATE_PREEMPTED
, 
pdÚe
, 
fÜeigndom
);

3567 
	`put_pg_owÃr
(
pg_owÃr
);

3569 
	`³rfc_add
(
num_mmuext_İs
, 
i
);

3571 
out
:

3573 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_is_nuÎ
(
pdÚe
)) )

3575 
dÚe
 +ğ
i
;

3576 
	`cİy_to_gue¡
(
pdÚe
, &
dÚe
, 1);

3579  
rc
;

3580 
	}
}

3582 
do_mmu_upd©e
(

3583 
	$XEN_GUEST_HANDLE
(
mmu_upd©e_t
è
u»qs
,

3584 
couÁ
,

3585 
	$XEN_GUEST_HANDLE
(
ušt
è
pdÚe
,

3586 
fÜeigndom
)

3588 
mmu_upd©e
 
»q
;

3589 *
va
;

3590 
gpâ
, 
gmâ
, 
mâ
;

3591 
·ge_šfo
 *
·ge
;

3592 
rc
 = 0, 
okay
 = 1, 
i
 = 0;

3593 
cmd
, 
dÚe
 = 0, 
±_dom
;

3594 
vıu
 *
v
 = 
cu¼’t
;

3595 
domaš
 *
d
 = 
v
->domaš, *
±_owÃr
 = d, *
pg_owÃr
;

3596 
domaš_mm­_ÿche
 
m­ÿche
;

3598 iàĞ
	`uÆik–y
(
couÁ
 & 
MMU_UPDATE_PREEMPTED
) )

3600 
couÁ
 &ğ~
MMU_UPDATE_PREEMPTED
;

3601 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_is_nuÎ
(
pdÚe
)) )

3602 ()
	`cİy_äom_gue¡
(&
dÚe
, 
pdÚe
, 1);

3605 
	`³rfc_šü
(
ÿÎs_to_mmu_upd©e
);

3607 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_okay
(
u»qs
, 
couÁ
)) )

3609 
rc
 = -
EFAULT
;

3610 
out
;

3613 iàĞ(
±_dom
 = 
fÜeigndom
 >> 16) != 0 )

3616 iàĞ(
±_owÃr
 = 
	`rcu_lock_domaš_by_id
(
±_dom
 - 1)è=ğ
NULL
 )

3618 
rc
 = -
EINVAL
;

3619 
out
;

3621 iàĞ
±_owÃr
 =ğ
d
 )

3622 
	`rcu_uÆock_domaš
(
±_owÃr
);

3623 iàĞ(
v
 = 
±_owÃr
->
vıu
 ?…t_owÃr->vıu[0] : 
NULL
) == NULL )

3625 
rc
 = -
EINVAL
;

3626 
out
;

3628 iàĞ!
	`IS_PRIV_FOR
(
d
, 
±_owÃr
) )

3630 
rc
 = -
ESRCH
;

3631 
out
;

3635 iàĞ(
pg_owÃr
 = 
	`g‘_pg_owÃr
((
ušt16_t
)
fÜeigndom
)è=ğ
NULL
 )

3637 
rc
 = -
ESRCH
;

3638 
out
;

3641 
	`domaš_mm­_ÿche_š™
(&
m­ÿche
);

3643  
i
 = 0; i < 
couÁ
; i++ )

3645 iàĞ
	`hy³rÿÎ_´“m±_check
() )

3647 
rc
 = -
EAGAIN
;

3651 iàĞ
	`uÆik–y
(
	`__cİy_äom_gue¡
(&
»q
, 
u»qs
, 1) != 0) )

3653 
	`MEM_LOG
("Bad __copy_from_guest");

3654 
rc
 = -
EFAULT
;

3658 
cmd
 = 
»q
.
±r
 & ((
l1_pg’Œy_t
)-1);

3659 
okay
 = 0;

3661  
cmd
 )

3668 
MMU_NORMAL_PT_UPDATE
:

3669 
MMU_PT_UPDATE_PRESERVE_AD
:

3671 
p2m_ty³_t
 
p2mt
;

3673 
rc
 = 
	`xsm_mmu_nÜm®_upd©e
(
d
, 
pg_owÃr
, 
»q
.
v®
);

3674 iàĞ
rc
 )

3677 
»q
.
±r
 -ğ
cmd
;

3678 
gmâ
 = 
»q
.
±r
 >> 
PAGE_SHIFT
;

3679 
mâ
 = 
	`mâ_x
(
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
±_owÃr
), 
gmâ
, &
p2mt
));

3680 iàĞ!
	`p2m_is_v®id
(
p2mt
) )

3681 
mâ
 = 
INVALID_MFN
;

3683 iàĞ
	`p2m_is_·ged
(
p2mt
) )

3685 
	`p2m_mem_·gšg_pİuÏ‹
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
), 
gmâ
);

3687 
rc
 = -
ENOENT
;

3691 iàĞ
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
mâ
, 
±_owÃr
)) )

3693 
	`MEM_LOG
("Could‚ot get…age for‚ormal update");

3697 
va
 = 
	`m­_domaš_·ge_w™h_ÿche
(
mâ
, &
m­ÿche
);

3698 
va
 = (*)(()va +

3699 ()(
»q
.
±r
 & ~
PAGE_MASK
));

3700 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

3702 iàĞ
	`·ge_lock
(
·ge
) )

3704  
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
 )

3706 
PGT_l1_·ge_bË
:

3708 
l1_pg’Œy_t
 
l1e
 = 
	`l1e_äom_š‹
(
»q
.
v®
);

3709 
p2m_ty³_t
 
l1e_p2mt
;

3710 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3711 
	`l1e_g‘_pâ
(
l1e
), &
l1e_p2mt
);

3713 iàĞ
	`p2m_is_·ged
(
l1e_p2mt
) )

3715 
	`p2m_mem_·gšg_pİuÏ‹
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3716 
	`l1e_g‘_pâ
(
l1e
));

3717 
rc
 = -
ENOENT
;

3720 iàĞ
p2m_¿m_·gšg_š_¡¬t
 =ğ
l1e_p2mt
 )

3722 
rc
 = -
ENOENT
;

3725 #ifdeà
__x86_64__


3729 iàĞ
p2m_¿m_sh¬ed
 =ğ
l1e_p2mt
 )

3732 iàĞ
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_RW
 )

3734 
rc
 = 
	`mem_sh¬šg_unsh¬e_·ge
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3735 
	`l1e_g‘_pâ
(
l1e
),

3737 iàĞ
rc
 )

3743 
okay
 = 
	`mod_l1_’Œy
(
va
, 
l1e
, 
mâ
,

3744 
cmd
 =ğ
MMU_PT_UPDATE_PRESERVE_AD
, 
v
,

3745 
pg_owÃr
);

3748 
PGT_l2_·ge_bË
:

3750 
l2_pg’Œy_t
 
l2e
 = 
	`l2e_äom_š‹
(
»q
.
v®
);

3751 
p2m_ty³_t
 
l2e_p2mt
;

3752 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
), 
	`l2e_g‘_pâ
(
l2e
), &
l2e_p2mt
);

3754 iàĞ
	`p2m_is_·ged
(
l2e_p2mt
) )

3756 
	`p2m_mem_·gšg_pİuÏ‹
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3757 
	`l2e_g‘_pâ
(
l2e
));

3758 
rc
 = -
ENOENT
;

3761 iàĞ
p2m_¿m_·gšg_š_¡¬t
 =ğ
l2e_p2mt
 )

3763 
rc
 = -
ENOENT
;

3766 iàĞ
p2m_¿m_sh¬ed
 =ğ
l2e_p2mt
 )

3768 
	`MEM_LOG
("Unexpected‡ttempto map shared…age.\n");

3769 
rc
 = -
EINVAL
;

3774 
okay
 = 
	`mod_l2_’Œy
(
va
, 
l2e
, 
mâ
,

3775 
cmd
 =ğ
MMU_PT_UPDATE_PRESERVE_AD
, 
v
);

3778 
PGT_l3_·ge_bË
:

3780 
l3_pg’Œy_t
 
l3e
 = 
	`l3e_äom_š‹
(
»q
.
v®
);

3781 
p2m_ty³_t
 
l3e_p2mt
;

3782 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
), 
	`l3e_g‘_pâ
(
l3e
), &
l3e_p2mt
);

3784 iàĞ
	`p2m_is_·ged
(
l3e_p2mt
) )

3786 
	`p2m_mem_·gšg_pİuÏ‹
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3787 
	`l3e_g‘_pâ
(
l3e
));

3788 
rc
 = -
ENOENT
;

3791 iàĞ
p2m_¿m_·gšg_š_¡¬t
 =ğ
l3e_p2mt
 )

3793 
rc
 = -
ENOENT
;

3796 iàĞ
p2m_¿m_sh¬ed
 =ğ
l3e_p2mt
 )

3798 
	`MEM_LOG
("Unexpected‡ttempto map shared…age.\n");

3799 
rc
 = -
EINVAL
;

3803 
rc
 = 
	`mod_l3_’Œy
(
va
, 
l3e
, 
mâ
,

3804 
cmd
 =ğ
MMU_PT_UPDATE_PRESERVE_AD
, 1, 
v
);

3805 
okay
 = !
rc
;

3808 #ià
CONFIG_PAGING_LEVELS
 >= 4

3809 
PGT_l4_·ge_bË
:

3811 
l4_pg’Œy_t
 
l4e
 = 
	`l4e_äom_š‹
(
»q
.
v®
);

3812 
p2m_ty³_t
 
l4e_p2mt
;

3813 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3814 
	`l4e_g‘_pâ
(
l4e
), &
l4e_p2mt
);

3816 iàĞ
	`p2m_is_·ged
(
l4e_p2mt
) )

3818 
	`p2m_mem_·gšg_pİuÏ‹
(
	`p2m_g‘_ho¡p2m
(
pg_owÃr
),

3819 
	`l4e_g‘_pâ
(
l4e
));

3820 
rc
 = -
ENOENT
;

3823 iàĞ
p2m_¿m_·gšg_š_¡¬t
 =ğ
l4e_p2mt
 )

3825 
rc
 = -
ENOENT
;

3828 iàĞ
p2m_¿m_sh¬ed
 =ğ
l4e_p2mt
 )

3830 
	`MEM_LOG
("Unexpected‡ttempto map shared…age.\n");

3831 
rc
 = -
EINVAL
;

3835 
rc
 = 
	`mod_l4_’Œy
(
va
, 
l4e
, 
mâ
,

3836 
cmd
 =ğ
MMU_PT_UPDATE_PRESERVE_AD
, 1, 
v
);

3837 
okay
 = !
rc
;

3841 
PGT_wr™abË_·ge
:

3842 
	`³rfc_šü
(
wr™abË_mmu_upd©es
);

3843 #ifdeà
VERBOSE_NOT_A_PT


3844 ià(
mši_aùiv©ed
) {

3845 
	`©omic_šc
(&
mši_couÁ
);

3846 
	`©omic_šc
(&
mši_¶aû
[1]);

3847 
·ge_bË
 *
±
;

3848 
	`my´štk
("nÙ_a_±: _mâ(mâ:%x):%x, v®->%x\n", 
mâ
, 
	`_mâ
(mâ), 
»q
.
v®
 );

3849 
±
 = 
	`fšd_±_mâ
(
	`_mâ
(
mâ
));

3850 ià(
±
)

3851 
	`my´štk
("FOUND!\n");

3852 
	`©omic_dec
(&
mši_¶aû
[1]);

3853 
	`©omic_dec
(&
mši_couÁ
);

3856 
okay
 = 
	`·gšg_wr™e_gue¡_’Œy
(

3857 
v
, 
va
, 
»q
.
v®
, 
	`_mâ
(
mâ
));

3860 
	`·ge_uÆock
(
·ge
);

3861 iàĞ
rc
 =ğ-
EINTR
 )

3862 
rc
 = -
EAGAIN
;

3864 iàĞ
	`g‘_·ge_ty³
(
·ge
, 
PGT_wr™abË_·ge
) )

3866 
	`³rfc_šü
(
wr™abË_mmu_upd©es
);

3867 
okay
 = 
	`·gšg_wr™e_gue¡_’Œy
(

3868 
v
, 
va
, 
»q
.
v®
, 
	`_mâ
(
mâ
));

3869 
	`put_·ge_ty³
(
·ge
);

3872 
	`unm­_domaš_·ge_w™h_ÿche
(
va
, &
m­ÿche
);

3873 
	`put_·ge
(
·ge
);

3877 
MMU_MACHPHYS_UPDATE
:

3879 
mâ
 = 
»q
.
±r
 >> 
PAGE_SHIFT
;

3880 
gpâ
 = 
»q
.
v®
;

3882 
rc
 = 
	`xsm_mmu_machphys_upd©e
(
d
, 
mâ
);

3883 iàĞ
rc
 )

3886 iàĞ
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
mâ
, 
pg_owÃr
)) )

3888 
	`MEM_LOG
("Could‚ot get…age for mach->phys update");

3892 iàĞ
	`uÆik–y
(
	`·gšg_mode_Œª¦©e
(
pg_owÃr
)) )

3894 
	`MEM_LOG
("Mach-phys update on‡uto-translate guest");

3898 
	`£t_gpâ_äom_mâ
(
mâ
, 
gpâ
);

3899 
okay
 = 1;

3901 
	`·gšg_m¬k_dœty
(
pg_owÃr
, 
mâ
);

3903 
	`put_·ge
(
	`mâ_to_·ge
(
mâ
));

3907 
	`MEM_LOG
("Inv®id…agupd©commªd %x", 
cmd
);

3908 
rc
 = -
ENOSYS
;

3909 
okay
 = 0;

3913 iàĞ
	`uÆik–y
(!
okay
) )

3915 
rc
 =„ø?„ø: -
EINVAL
;

3919 
	`gue¡_hªdË_add_off£t
(
u»qs
, 1);

3922 iàĞ
rc
 =ğ-
EAGAIN
 )

3923 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

3924 
__HYPERVISOR_mmu_upd©e
, "hihi",

3925 
u»qs
, (
couÁ
 - 
i
è| 
MMU_UPDATE_PREEMPTED
, 
pdÚe
, 
fÜeigndom
);

3927 
	`put_pg_owÃr
(
pg_owÃr
);

3929 
	`domaš_mm­_ÿche_de¡roy
(&
m­ÿche
);

3931 
	`³rfc_add
(
num_·ge_upd©es
, 
i
);

3933 
out
:

3934 iàĞ
±_owÃr
 && (±_owÃ¸!ğ
d
) )

3935 
	`rcu_uÆock_domaš
(
±_owÃr
);

3938 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_is_nuÎ
(
pdÚe
)) )

3940 
dÚe
 +ğ
i
;

3941 
	`cİy_to_gue¡
(
pdÚe
, &
dÚe
, 1);

3944  
rc
;

3945 
	}
}

3952 
	$ü—‹_g¿Á_±e_m­pšg
(

3953 
ušt64_t
 
±e_addr
, 
l1_pg’Œy_t
 
Æ1e
, 
vıu
 *
v
)

3955 
rc
 = 
GNTST_okay
;

3956 *
va
;

3957 
gmâ
, 
mâ
;

3958 
·ge_šfo
 *
·ge
;

3959 
l1_pg’Œy_t
 
Ş1e
;

3960 
domaš
 *
d
 = 
v
->domain;

3962 
	`ASSERT
(
	`domaš_is_locked
(
d
));

3964 
	`adju¡_gue¡_l1e
(
Æ1e
, 
d
);

3966 
gmâ
 = 
±e_addr
 >> 
PAGE_SHIFT
;

3967 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

3969 iàĞ
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
mâ
, 
cu¼’t
->
domaš
)) )

3971 
	`MEM_LOG
("Could‚ot get…age for‚ormal update");

3972  
GNTST_g’”®_”rÜ
;

3975 
va
 = 
	`m­_domaš_·ge
(
mâ
);

3976 
va
 = (*)(()v¨+ (()
±e_addr
 & ~
PAGE_MASK
));

3977 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

3979 iàĞ!
	`·ge_lock
(
·ge
) )

3981 
rc
 = 
GNTST_g’”®_”rÜ
;

3982 
çed
;

3985 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

3987 
	`·ge_uÆock
(
·ge
);

3988 
rc
 = 
GNTST_g’”®_”rÜ
;

3989 
çed
;

3992 
Ş1e
 = *(
l1_pg’Œy_t
 *)
va
;

3993 #ifdeà
ENABLE_PT_MODIFICATION


3994 iàĞ!
	`MY_UPDATE_ENTRY
(
l1
, (
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
Æ1e
, 
mâ
, 
v
, 0, 13, 1) )

3996 iàĞ!
	`UPDATE_ENTRY
(
l1
, (
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
Æ1e
, 
mâ
, 
v
, 0) )

3999 
	`·ge_uÆock
(
·ge
);

4000 
rc
 = 
GNTST_g’”®_”rÜ
;

4001 
çed
;

4004 
	`·ge_uÆock
(
·ge
);

4006 iàĞ!
	`·gšg_mode_»fcouÁs
(
d
) )

4007 
	`put_·ge_äom_l1e
(
Ş1e
, 
d
);

4008 #ifdeà
ENABLE_PT_MODIFICATION


4009 
	`l1e_upd©e_sucûss_g¿Á
((
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
Æ1e
);

4011 
çed
:

4012 
	`unm­_domaš_·ge
(
va
);

4013 
	`put_·ge
(
·ge
);

4015  
rc
;

4016 
	}
}

4018 
	$de¡roy_g¿Á_±e_m­pšg
(

4019 
ušt64_t
 
addr
, 
äame
, 
domaš
 *
d
)

4021 
rc
 = 
GNTST_okay
;

4022 *
va
;

4023 
gmâ
, 
mâ
;

4024 
·ge_šfo
 *
·ge
;

4025 
l1_pg’Œy_t
 
Ş1e
;

4027 
gmâ
 = 
addr
 >> 
PAGE_SHIFT
;

4028 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

4030 iàĞ
	`uÆik–y
(!
	`g‘_·ge_äom_·g’r
(
mâ
, 
cu¼’t
->
domaš
)) )

4032 
	`MEM_LOG
("Could‚ot get…age for‚ormal update");

4033  
GNTST_g’”®_”rÜ
;

4036 
va
 = 
	`m­_domaš_·ge
(
mâ
);

4037 
va
 = (*)(()v¨+ (()
addr
 & ~
PAGE_MASK
));

4038 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

4040 iàĞ!
	`·ge_lock
(
·ge
) )

4042 
rc
 = 
GNTST_g’”®_”rÜ
;

4043 
çed
;

4046 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

4048 
	`·ge_uÆock
(
·ge
);

4049 
rc
 = 
GNTST_g’”®_”rÜ
;

4050 
çed
;

4053 
Ş1e
 = *(
l1_pg’Œy_t
 *)
va
;

4056 iàĞ
	`uÆik–y
(
	`l1e_g‘_pâ
(
Ş1e
è!ğ
äame
) )

4058 
	`·ge_uÆock
(
·ge
);

4059 
	`MEM_LOG
("PTEƒÁry %lx fÜ‡dd»s %"
PRIx64
" doesn't match frame %lx",

4060 ()
	`l1e_g‘_š‹
(
Ş1e
), 
addr
, 
äame
);

4061 
rc
 = 
GNTST_g’”®_”rÜ
;

4062 
çed
;

4066 #ifdeà
ENABLE_PT_MODIFICATION


4067 iàĞ
	`uÆik–y
(!
MY_UPDATE_ENTRY


4068 (
l1
,

4069 (
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
	`l1e_em±y
(), 
mâ
,

4070 
d
->
vıu
[0] ,

4073 iàĞ
	`uÆik–y
(!
UPDATE_ENTRY


4074 (
l1
,

4075 (
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
	`l1e_em±y
(), 
mâ
,

4076 
d
->
vıu
[0] ,

4080 
	`·ge_uÆock
(
·ge
);

4081 
	`MEM_LOG
("CªnÙ d–‘PTEƒÁry‡ˆ%p", 
va
);

4082 
rc
 = 
GNTST_g’”®_”rÜ
;

4083 
çed
;

4086 
	`·ge_uÆock
(
·ge
);

4087 #ifdeà
ENABLE_PT_MODIFICATION


4088 
	`l1e_upd©e_sucûss_g¿Á
((
l1_pg’Œy_t
 *)
va
, 
Ş1e
, 
	`l1e_em±y
());

4090 
çed
:

4091 
	`unm­_domaš_·ge
(
va
);

4092 
	`put_·ge
(
·ge
);

4093  
rc
;

4094 
	}
}

4097 
	$ü—‹_g¿Á_va_m­pšg
(

4098 
va
, 
l1_pg’Œy_t
 
Æ1e
, 
vıu
 *
v
)

4100 
l1_pg’Œy_t
 *
¶1e
, 
Ş1e
;

4101 
domaš
 *
d
 = 
v
->domain;

4102 
gl1mâ
;

4103 
·ge_šfo
 *
l1pg
;

4104 
okay
;

4106 
	`ASSERT
(
	`domaš_is_locked
(
d
));

4108 
	`adju¡_gue¡_l1e
(
Æ1e
, 
d
);

4110 
¶1e
 = 
	`gue¡_m­_l1e
(
v
, 
va
, &
gl1mâ
);

4111 iàĞ!
¶1e
 )

4113 
	`MEM_LOG
("Could‚Ù fšd L1 PTE fÜ‡dd»s %lx", 
va
);

4114  
GNTST_g’”®_”rÜ
;

4117 iàĞ!
	`g‘_·ge_äom_·g’r
(
gl1mâ
, 
cu¼’t
->
domaš
) )

4119 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4120  
GNTST_g’”®_”rÜ
;

4123 
l1pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

4124 iàĞ!
	`·ge_lock
(
l1pg
) )

4126 
	`put_·ge
(
l1pg
);

4127 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4128  
GNTST_g’”®_”rÜ
;

4131 iàĞ(
l1pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

4133 
	`·ge_uÆock
(
l1pg
);

4134 
	`put_·ge
(
l1pg
);

4135 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4136  
GNTST_g’”®_”rÜ
;

4139 
Ş1e
 = *
¶1e
;

4140 #ifdeà
ENABLE_PT_MODIFICATION


4141 
okay
 = 
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
v
, 0, 15, 1);

4143 
okay
 = 
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
v
, 0);

4146 
	`·ge_uÆock
(
l1pg
);

4147 
	`put_·ge
(
l1pg
);

4148 #ifdeà
ENABLE_PT_MODIFICATION


4149 ià(
okay
)

4150 
	`l1e_upd©e_sucûss_g¿Á
(
¶1e
, 
Ş1e
, 
Æ1e
);

4152 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4154 iàĞ
okay
 && !
	`·gšg_mode_»fcouÁs
(
d
) )

4155 
	`put_·ge_äom_l1e
(
Ş1e
, 
d
);

4157  
okay
 ? 
GNTST_okay
 : 
GNTST_g’”®_”rÜ
;

4158 
	}
}

4160 
	$»¶aû_g¿Á_va_m­pšg
(

4161 
addr
, 
äame
, 
l1_pg’Œy_t
 
Æ1e
, 
vıu
 *
v
)

4163 
l1_pg’Œy_t
 *
¶1e
, 
Ş1e
;

4164 
gl1mâ
;

4165 
·ge_šfo
 *
l1pg
;

4166 
rc
 = 0;

4168 
¶1e
 = 
	`gue¡_m­_l1e
(
v
, 
addr
, &
gl1mâ
);

4169 iàĞ!
¶1e
 )

4171 
	`MEM_LOG
("Could‚Ù fšd L1 PTE fÜ‡dd»s %lx", 
addr
);

4172  
GNTST_g’”®_”rÜ
;

4175 iàĞ!
	`g‘_·ge_äom_·g’r
(
gl1mâ
, 
cu¼’t
->
domaš
) )

4177 
rc
 = 
GNTST_g’”®_”rÜ
;

4178 
out
;

4181 
l1pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

4182 iàĞ!
	`·ge_lock
(
l1pg
) )

4184 
rc
 = 
GNTST_g’”®_”rÜ
;

4185 
	`put_·ge
(
l1pg
);

4186 
out
;

4189 iàĞ(
l1pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

4191 
rc
 = 
GNTST_g’”®_”rÜ
;

4192 
uÆock_ªd_out
;

4195 
Ş1e
 = *
¶1e
;

4198 iàĞ
	`uÆik–y
(
	`l1e_g‘_pâ
(
Ş1e
è!ğ
äame
) )

4200 
	`MEM_LOG
("PTEƒntry %lx for‡ddress %lx doesn't match frame %lx",

4201 
	`l1e_g‘_pâ
(
Ş1e
), 
addr
, 
äame
);

4202 
rc
 = 
GNTST_g’”®_”rÜ
;

4203 
uÆock_ªd_out
;

4207 #ifdeà
ENABLE_PT_MODIFICATION


4208 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
v
, 0, 16, 1)) )

4210 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
gl1mâ
, 
v
, 0)) )

4213 
	`MEM_LOG
("CªnÙ d–‘PTEƒÁry‡ˆ%p", (*)
¶1e
);

4214 
rc
 = 
GNTST_g’”®_”rÜ
;

4215 
uÆock_ªd_out
;

4217 #ifdeà
ENABLE_PT_MODIFICATION


4218 
	`l1e_upd©e_sucûss_g¿Á
(
¶1e
, 
Ş1e
, 
Æ1e
);

4221 
uÆock_ªd_out
:

4222 
	`·ge_uÆock
(
l1pg
);

4223 
	`put_·ge
(
l1pg
);

4224 
out
:

4225 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4226  
rc
;

4227 
	}
}

4229 
	$de¡roy_g¿Á_va_m­pšg
(

4230 
addr
, 
äame
, 
vıu
 *
v
)

4232  
	`»¶aû_g¿Á_va_m­pšg
(
addr
, 
äame
, 
	`l1e_em±y
(), 
v
);

4233 
	}
}

4235 
	$ü—‹_g¿Á_p2m_m­pšg
(
ušt64_t
 
addr
, 
äame
,

4236 
æags
,

4237 
ÿche_æags
)

4239 
p2m_ty³_t
 
p2mt
;

4240 
rc
;

4242 iàĞ
ÿche_æags
 || (
æags
 & ~
GNTMAP_»adÚly
è!ğ
GNTMAP_ho¡_m­
 )

4243  
GNTST_g’”®_”rÜ
;

4245 iàĞ
æags
 & 
GNTMAP_»adÚly
 )

4246 
p2mt
 = 
p2m_g¿Á_m­_ro
;

4248 
p2mt
 = 
p2m_g¿Á_m­_rw
;

4249 
rc
 = 
	`gue¡_physm­_add_’Œy
(
	`p2m_g‘_ho¡p2m
(
cu¼’t
->
domaš
),

4250 
addr
 >> 
PAGE_SHIFT
, 
äame
, 0, 
p2mt
);

4251 iàĞ
rc
 )

4252  
GNTST_g’”®_”rÜ
;

4254  
GNTST_okay
;

4255 
	}
}

4257 
	$ü—‹_g¿Á_ho¡_m­pšg
(
ušt64_t
 
addr
, 
äame
,

4258 
æags
, 
ÿche_æags
)

4260 
l1_pg’Œy_t
 
±e
;

4262 iàĞ
	`·gšg_mode_ex‹º®
(
cu¼’t
->
domaš
) )

4263  
	`ü—‹_g¿Á_p2m_m­pšg
(
addr
, 
äame
, 
æags
, 
ÿche_æags
);

4265 
±e
 = 
	`l1e_äom_pâ
(
äame
, 
GRANT_PTE_FLAGS
);

4266 iàĞ(
æags
 & 
GNTMAP_­¶iÿtiÚ_m­
) )

4267 
	`l1e_add_æags
(
±e
,
_PAGE_USER
);

4268 iàĞ!(
æags
 & 
GNTMAP_»adÚly
) )

4269 
	`l1e_add_æags
(
±e
,
_PAGE_RW
);

4271 
	`l1e_add_æags
(
±e
,

4272 ((
æags
 >> 
_GNTMAP_gue¡_ava0
è* 
_PAGE_AVAIL0
)

4273 & 
_PAGE_AVAIL
);

4275 
	`l1e_add_æags
(
±e
, 
	`ÿch—‰r_to_±e_æags
(
ÿche_æags
 >> 5));

4277 iàĞ
æags
 & 
GNTMAP_cÚšs_±e
 )

4278  
	`ü—‹_g¿Á_±e_m­pšg
(
addr
, 
±e
, 
cu¼’t
);

4279  
	`ü—‹_g¿Á_va_m­pšg
(
addr
, 
±e
, 
cu¼’t
);

4280 
	}
}

4282 
	$»¶aû_g¿Á_p2m_m­pšg
(

4283 
ušt64_t
 
addr
, 
äame
, ušt64_ˆ
Ãw_addr
, 
æags
)

4285 
gâ
 = ()(
addr
 >> 
PAGE_SHIFT
);

4286 
p2m_ty³_t
 
ty³
;

4287 
mâ_t
 
Şd_mâ
;

4288 
domaš
 *
d
 = 
cu¼’t
->domain;

4290 iàĞ
Ãw_addr
 !ğ0 || (
æags
 & 
GNTMAP_cÚšs_±e
) )

4291  
GNTST_g’”®_”rÜ
;

4293 
Şd_mâ
 = 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
, &
ty³
);

4294 iàĞ!
	`p2m_is_g¿Á
(
ty³
è|| 
	`mâ_x
(
Şd_mâ
è!ğ
äame
 )

4296 
	`gd´štk
(
XENLOG_WARNING
,

4298 
ty³
, 
	`mâ_x
(
Şd_mâ
), 
äame
);

4299  
GNTST_g’”®_”rÜ
;

4301 
	`gue¡_physm­_»move_·ge
(
d
, 
gâ
, 
äame
, 0);

4303  
GNTST_okay
;

4304 
	}
}

4306 
	$»¶aû_g¿Á_ho¡_m­pšg
(

4307 
ušt64_t
 
addr
, 
äame
, ušt64_ˆ
Ãw_addr
, 
æags
)

4309 
vıu
 *
cu¼
 = 
cu¼’t
;

4310 
l1_pg’Œy_t
 *
¶1e
, 
Ş1e
;

4311 
gl1mâ
;

4312 
·ge_šfo
 *
l1pg
;

4313 
rc
;

4315 iàĞ
	`·gšg_mode_ex‹º®
(
cu¼’t
->
domaš
) )

4316  
	`»¶aû_g¿Á_p2m_m­pšg
(
addr
, 
äame
, 
Ãw_addr
, 
æags
);

4318 iàĞ
æags
 & 
GNTMAP_cÚšs_±e
 )

4320 iàĞ!
Ãw_addr
 )

4321  
	`de¡roy_g¿Á_±e_m­pšg
(
addr
, 
äame
, 
cu¼
->
domaš
);

4323 
	`MEM_LOG
("Unsupported grantable operation");

4324  
GNTST_g’”®_”rÜ
;

4327 iàĞ!
Ãw_addr
 )

4328  
	`de¡roy_g¿Á_va_m­pšg
(
addr
, 
äame
, 
cu¼
);

4330 
¶1e
 = 
	`gue¡_m­_l1e
(
cu¼
, 
Ãw_addr
, &
gl1mâ
);

4331 iàĞ!
¶1e
 )

4333 
	`MEM_LOG
("Could‚ot find L1 PTE for‡ddress %lx",

4334 ()
Ãw_addr
);

4335  
GNTST_g’”®_”rÜ
;

4338 iàĞ!
	`g‘_·ge_äom_·g’r
(
gl1mâ
, 
cu¼’t
->
domaš
) )

4340 
	`gue¡_unm­_l1e
(
cu¼
, 
¶1e
);

4341  
GNTST_g’”®_”rÜ
;

4344 
l1pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

4345 iàĞ!
	`·ge_lock
(
l1pg
) )

4347 
	`put_·ge
(
l1pg
);

4348 
	`gue¡_unm­_l1e
(
cu¼
, 
¶1e
);

4349  
GNTST_g’”®_”rÜ
;

4352 iàĞ(
l1pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

4354 
	`·ge_uÆock
(
l1pg
);

4355 
	`put_·ge
(
l1pg
);

4356 
	`gue¡_unm­_l1e
(
cu¼
, 
¶1e
);

4357  
GNTST_g’”®_”rÜ
;

4360 
Ş1e
 = *
¶1e
;

4362 #ifdeà
ENABLE_PT_MODIFICATION


4363 iàĞ
	`uÆik–y
(!
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
	`l1e_em±y
(),

4364 
gl1mâ
, 
cu¼
, 0, 17, 1)) )

4366 iàĞ
	`uÆik–y
(!
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
	`l1e_em±y
(),

4367 
gl1mâ
, 
cu¼
, 0)) )

4370 
	`·ge_uÆock
(
l1pg
);

4371 
	`put_·ge
(
l1pg
);

4372 
	`MEM_LOG
("CªnÙ d–‘PTEƒÁry‡ˆ%p", (*)
¶1e
);

4373 
	`gue¡_unm­_l1e
(
cu¼
, 
¶1e
);

4374  
GNTST_g’”®_”rÜ
;

4377 
	`·ge_uÆock
(
l1pg
);

4378 
	`put_·ge
(
l1pg
);

4379 #ifdeà
ENABLE_PT_MODIFICATION


4380 
	`l1e_upd©e_sucûss_g¿Á
(
¶1e
, 
Ş1e
, 
	`l1e_em±y
());

4382 
	`gue¡_unm­_l1e
(
cu¼
, 
¶1e
);

4384 
rc
 = 
	`»¶aû_g¿Á_va_m­pšg
(
addr
, 
äame
, 
Ş1e
, 
cu¼
);

4385 iàĞ
rc
 && !
	`·gšg_mode_»fcouÁs
(
cu¼
->
domaš
) )

4386 
	`put_·ge_äom_l1e
(
Ş1e
, 
cu¼
->
domaš
);

4388  
rc
;

4389 
	}
}

4391 
	$dÚ©e_·ge
(

4392 
domaš
 *
d
, 
·ge_šfo
 *
·ge
, 
memæags
)

4394 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

4396 iàĞ
	`is_x’_h—p_·ge
(
·ge
è|| (
	`·ge_g‘_owÃr
Õageè!ğ
NULL
) )

4397 
ç
;

4399 iàĞ
d
->
is_dyšg
 )

4400 
ç
;

4402 iàĞ
·ge
->
couÁ_šfo
 & ~(
PGC_®loÿ‹d
 | 1) )

4403 
ç
;

4405 iàĞ!(
memæags
 & 
MEMF_no_»fcouÁ
) )

4407 iàĞ
d
->
tÙ_·ges
 >ğd->
max_·ges
 )

4408 
ç
;

4409 
d
->
tÙ_·ges
++;

4412 
·ge
->
couÁ_šfo
 = 
PGC_®loÿ‹d
 | 1;

4413 
	`·ge_£t_owÃr
(
·ge
, 
d
);

4414 
	`·ge_li¡_add_
(
·ge
,&
d
->
·ge_li¡
);

4416 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4419 
ç
:

4420 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4421 
	`MEM_LOG
("Bad dÚ©%p:ƒd=%p(%u), sd=%p, caf=%08lx,af=%" 
PRty³_šfo
,

4422 (*)
	`·ge_to_mâ
(
·ge
), 
d
, d->
domaš_id
,

4423 
	`·ge_g‘_owÃr
(
·ge
),…age->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

4425 
	}
}

4427 
	$¡—l_·ge
(

4428 
domaš
 *
d
, 
·ge_šfo
 *
·ge
, 
memæags
)

4430 
x
, 
y
;

4431 
boŞ_t
 
drİ_dom_»f
 = 0;

4433 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

4435 iàĞ
	`is_x’_h—p_·ge
(
·ge
è|| (
	`·ge_g‘_owÃr
Õageè!ğ
d
) )

4436 
ç
;

4442 
y
 = 
·ge
->
couÁ_šfo
;

4444 
x
 = 
y
;

4445 iàĞ(
x
 & (
PGC_couÁ_mask
|
PGC_®loÿ‹d
)) != (1 | PGC_allocated) )

4446 
ç
;

4447 
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, x & ~
PGC_couÁ_mask
);

4448 }  
y
 !ğ
x
 );

4451 
	`·ge_£t_owÃr
(
·ge
, 
NULL
);

4452 
y
 = 
·ge
->
couÁ_šfo
;

4454 
x
 = 
y
;

4455 
	`BUG_ON
((
x
 & (
PGC_couÁ_mask
|
PGC_®loÿ‹d
)) != PGC_allocated);

4456 }  (
y
 = 
	`cmpxchg
(&
·ge
->
couÁ_šfo
, 
x
, x | 1)) != x );

4459 iàĞ!(
memæags
 & 
MEMF_no_»fcouÁ
è&& !--
d
->
tÙ_·ges
 )

4460 
drİ_dom_»f
 = 1;

4461 
	`·ge_li¡_d–
(
·ge
, &
d
->
·ge_li¡
);

4463 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4464 iàĞ
	`uÆik–y
(
drİ_dom_»f
) )

4465 
	`put_domaš
(
d
);

4468 
ç
:

4469 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4470 
	`MEM_LOG
("Bad…ag%p:ƒd=%p(%u), sd=%p, caf=%08lx,af=%" 
PRty³_šfo
,

4471 (*)
	`·ge_to_mâ
(
·ge
), 
d
, d->
domaš_id
,

4472 
	`·ge_g‘_owÃr
(
·ge
),…age->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

4474 
	}
}

4476 
	$·ge_make_sh¬abË
(
domaš
 *
d
,

4477 
·ge_šfo
 *
·ge
,

4478 
ex³ùed_»fút
)

4480 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

4483 iàĞ!
	`g‘_·ge_ªd_ty³
(
·ge
, 
d
, 
PGT_sh¬ed_·ge
) )

4485 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4486  -
EINVAL
;

4490 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 1 )

4492 
	`put_·ge_ªd_ty³
(
·ge
);

4493 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4494  -
EEXIST
;

4499 if(
·ge
->
couÁ_šfo
 !ğ(
PGC_®loÿ‹d
 | (2 + 
ex³ùed_»fút
)))

4502 
	`put_·ge_ªd_ty³
(
·ge
);

4503 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4504  -
E2BIG
;

4507 
	`·ge_£t_owÃr
(
·ge
, 
dom_cow
);

4508 
d
->
tÙ_·ges
--;

4509 
	`·ge_li¡_d–
(
·ge
, &
d
->
·ge_li¡
);

4510 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4512 
	}
}

4514 
	$·ge_make_´iv©e
(
domaš
 *
d
, 
·ge_šfo
 *
·ge
)

4516 if(!
	`g‘_·ge
(
·ge
, 
dom_cow
))

4517  -
EINVAL
;

4519 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

4522 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & (
PGT_ty³_mask
 | 
PGT_couÁ_mask
))

4523 !ğ(
PGT_sh¬ed_·ge
 | 1) )

4525 
	`put_·ge
(
·ge
);

4526 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4527  -
EEXIST
;

4531 
	`put_·ge_ªd_ty³
(
·ge
);

4534 
	`ASSERT
(
	`·ge_g‘_owÃr
(
·ge
è=ğ
dom_cow
);

4535 
	`·ge_£t_owÃr
(
·ge
, 
d
);

4537 
d
->
tÙ_·ges
++;

4538 
	`·ge_li¡_add_
(
·ge
, &
d
->
·ge_li¡
);

4539 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

4541 
	`put_·ge
(
·ge
);

4544 
	}
}

4546 #ifdeà
DEBUG_WARN


4547 
	$fšd_l1e_mâ
(
addr
)

4549 
mâ
;

4550 #ià
CONFIG_PAGING_LEVELS
 == 4

4551 
l4_pg’Œy_t
 
l4e
, *
l4t
;

4553 #ià
CONFIG_PAGING_LEVELS
 >= 3

4554 
l3_pg’Œy_t
 
l3e
, *
l3t
;

4556 
l2_pg’Œy_t
 
l2e
, *
l2t
;

4558 
mâ
 = 
	`»ad_ü3
(è>> 
PAGE_SHIFT
;

4560 #ià
CONFIG_PAGING_LEVELS
 == 4

4561 
l4t
 = 
	`m­_domaš_·ge
(
mâ
);

4562 
l4e
 = 
l4t
[
	`l4_bË_off£t
(
addr
)];

4563 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

4564 
	`unm­_domaš_·ge
(
l4t
);

4566 #ià
CONFIG_PAGING_LEVELS
 >= 3

4567 
l3t
 = 
	`m­_domaš_·ge
(
mâ
);

4568 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
addr
)];

4569 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

4570 
	`unm­_domaš_·ge
(
l3t
);

4572 
l2t
 = 
	`m­_domaš_·ge
(
mâ
);

4573 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
addr
)];

4574 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

4575 
	`unm­_domaš_·ge
(
l2t
);

4576  
	`l2e_g‘_pâ
(
l2e
);

4577 
	}
}

4582 
	$__do_upd©e_va_m­pšg
(

4583 
va
, 
u64
 
v®64
, 
æags
, 
domaš
 *
pg_owÃr
)

4585 
l1_pg’Œy_t
 
v®
 = 
	`l1e_äom_š‹
(
v®64
);

4586 
vıu
 *
v
 = 
cu¼’t
;

4587 
domaš
 *
d
 = 
v
->domain;

4588 
·ge_šfo
 *
gl1pg
;

4589 
l1_pg’Œy_t
 *
¶1e
;

4590 
bm­_±r
, 
gl1mâ
;

4591 
ıumask_t
 
pmask
;

4592 
rc
;

4594 
	`³rfc_šü
(
ÿÎs_to_upd©e_va
);

4596 
rc
 = 
	`xsm_upd©e_va_m­pšg
(
d
, 
pg_owÃr
, 
v®
);

4597 iàĞ
rc
 ) {

4598 
	`my´štk
("??? do_update_va_map\n");

4599  
rc
;

4602 
rc
 = -
EINVAL
;

4603 
¶1e
 = 
	`gue¡_m­_l1e
(
v
, 
va
, &
gl1mâ
);

4604 iàĞ
	`uÆik–y
(!
¶1e
 || !
	`g‘_·ge_äom_·g’r
(
gl1mâ
, 
d
)) )

4605 
out
;

4607 
gl1pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

4608 iàĞ!
	`·ge_lock
(
gl1pg
) )

4610 
	`put_·ge
(
gl1pg
);

4611 
out
;

4614 iàĞ(
gl1pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

4616 
	`·ge_uÆock
(
gl1pg
);

4617 
	`put_·ge
(
gl1pg
);

4618 
out
;

4625 #ifdeà
DEBUG_WARN


4626 #iâdeà
ENABLE_PER_CACHE_PT


4627 ià(
mši_aùiv©ed
 && 
gl1mâ
!=
	`fšd_l1e_mâ
(
va
) ) {

4628 
	`my´štk
("WARN!! gl1mâ:%x , 2mâ:%x ,„‘=%x\n", 
gl1mâ
, 
	`gmâ_to_mâ
(
cu¼’t
->
domaš
, gl1mâè, 
	`fšd_l1e_mâ
(
va
) );

4633 
rc
 = 
	`mod_l1_’Œy
(
¶1e
, 
v®
, 
gl1mâ
, 0, 
v
, 
pg_owÃr
è? 0 : -
EINVAL
;

4635 
	`·ge_uÆock
(
gl1pg
);

4636 
	`put_·ge
(
gl1pg
);

4638 
out
:

4639 iàĞ
¶1e
 )

4640 
	`gue¡_unm­_l1e
(
v
, 
¶1e
);

4642  
æags
 & 
UVMF_FLUSHTYPE_MASK
 )

4644 
UVMF_TLB_FLUSH
:

4645  (
bm­_±r
 = 
æags
 & ~
UVMF_FLUSHTYPE_MASK
) )

4647 
UVMF_LOCAL
:

4648 
	`æush_b_loÿl
();

4650 
UVMF_ALL
:

4651 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

4654 
rc
 = 
	`vıumask_to_pıumask
(
d
, 
	`cÚ¡_gue¡_hªdË_äom_±r
(
bm­_±r
,

4656 &
pmask
);

4657 
	`æush_b_mask
(&
pmask
);

4662 
UVMF_INVLPG
:

4663  (
bm­_±r
 = 
æags
 & ~
UVMF_FLUSHTYPE_MASK
) )

4665 
UVMF_LOCAL
:

4666 iàĞ!
	`·gšg_mode_’abËd
(
d
) ||

4667 (
	`·gšg_švÍg
(
v
, 
va
) != 0) )

4668 
	`æush_b_Úe_loÿl
(
va
);

4670 
UVMF_ALL
:

4671 
	`æush_b_Úe_mask
(&
d
->
domaš_dœty_ıumask
, 
va
);

4674 
rc
 = 
	`vıumask_to_pıumask
(
d
, 
	`cÚ¡_gue¡_hªdË_äom_±r
(
bm­_±r
,

4676 &
pmask
);

4677 
	`æush_b_Úe_mask
(&
pmask
, 
va
);

4683  
rc
;

4684 
	}
}

4686 
	$do_upd©e_va_m­pšg
(
va
, 
u64
 
v®64
,

4687 
æags
)

4689  
	`__do_upd©e_va_m­pšg
(
va
, 
v®64
, 
æags
, 
cu¼’t
->
domaš
);

4690 
	}
}

4692 
	$do_upd©e_va_m­pšg_Ùh”domaš
(
va
, 
u64
 
v®64
,

4693 
æags
,

4694 
domid_t
 
domid
)

4696 
domaš
 *
pg_owÃr
;

4697 
rc
;

4699 iàĞ(
pg_owÃr
 = 
	`g‘_pg_owÃr
(
domid
)è=ğ
NULL
 )

4700  -
ESRCH
;

4702 
rc
 = 
	`__do_upd©e_va_m­pšg
(
va
, 
v®64
, 
æags
, 
pg_owÃr
);

4704 
	`put_pg_owÃr
(
pg_owÃr
);

4706  
rc
;

4707 
	}
}

4715 
	$de¡roy_gdt
(
vıu
 *
v
)

4717 
i
;

4718 
pâ
;

4720 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_’ts
 = 0;

4721  
i
 = 0; i < 
FIRST_RESERVED_GDT_PAGE
; i++ )

4723 iàĞ(
pâ
 = 
	`l1e_g‘_pâ
(
v
->
¬ch
.
³rdomaš_±es
[
i
])) != 0 )

4724 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
pâ
));

4725 
	`l1e_wr™e
(&
v
->
¬ch
.
³rdomaš_±es
[
i
], 
	`l1e_em±y
());

4726 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_äames
[
i
] = 0;

4728 
	}
}

4731 
	$£t_gdt
(
vıu
 *
v
,

4732 *
äames
,

4733 
’Œ›s
)

4735 
domaš
 *
d
 = 
v
->domain;

4737 
i
, 
Ä_·ges
 = (
’Œ›s
 + 511) / 512;

4738 
mâ
;

4740 iàĞ
’Œ›s
 > 
FIRST_RESERVED_GDT_ENTRY
 )

4741  -
EINVAL
;

4744  
i
 = 0; i < 
Ä_·ges
; i++ )

4746 
mâ
 = 
äames
[
i
] = 
	`gmâ_to_mâ
(
d
, frames[i]);

4747 iàĞ!
	`mâ_v®id
(
mâ
) ||

4748 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_£g_desc_·ge
) )

4749 
ç
;

4753 
	`de¡roy_gdt
(
v
);

4756 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_’ts
 = 
’Œ›s
;

4757  
i
 = 0; i < 
Ä_·ges
; i++ )

4759 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_äames
[
i
] = 
äames
[i];

4760 
	`l1e_wr™e
(&
v
->
¬ch
.
³rdomaš_±es
[
i
],

4761 
	`l1e_äom_pâ
(
äames
[
i
], 
__PAGE_HYPERVISOR
));

4766 
ç
:

4767  
i
-- > 0 )

4768 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
äames
[
i
]));

4769  -
EINVAL
;

4770 
	}
}

4773 
do_£t_gdt
(
	$XEN_GUEST_HANDLE
(
ulÚg
è
äame_li¡
, 
’Œ›s
)

4775 
Ä_·ges
 = (
’Œ›s
 + 511) / 512;

4776 
äames
[16];

4777 
vıu
 *
cu¼
 = 
cu¼’t
;

4778 
»t
;

4781 iàĞ
’Œ›s
 > 
FIRST_RESERVED_GDT_ENTRY
 )

4782  -
EINVAL
;

4784 iàĞ
	`cİy_äom_gue¡
(
äames
, 
äame_li¡
, 
Ä_·ges
) )

4785  -
EFAULT
;

4787 
	`domaš_lock
(
cu¼
->
domaš
);

4789 iàĞ(
»t
 = 
	`£t_gdt
(
cu¼
, 
äames
, 
’Œ›s
)) == 0 )

4790 
	`æush_b_loÿl
();

4792 
	`domaš_uÆock
(
cu¼
->
domaš
);

4794  
»t
;

4795 
	}
}

4798 
	$do_upd©e_desütÜ
(
u64
 
·
, u64 
desc
)

4800 
domaš
 *
dom
 = 
cu¼’t
->domain;

4801 
gmâ
 = 
·
 >> 
PAGE_SHIFT
;

4802 
mâ
;

4803 
off£t
;

4804 
desc_¡ruù
 *
gdt_³Á
, 
d
;

4805 
·ge_šfo
 *
·ge
;

4806 
»t
 = -
EINVAL
;

4808 
off£t
 = (()
·
 & ~
PAGE_MASK
è/ (
desc_¡ruù
);

4810 *(
u64
 *)&
d
 = 
desc
;

4812 
mâ
 = 
	`gmâ_to_mâ
(
dom
, 
gmâ
);

4813 iàĞ((()
·
 % (
desc_¡ruù
)) != 0) ||

4814 !
	`mâ_v®id
(
mâ
) ||

4815 !
	`check_desütÜ
(
dom
, &
d
) )

4816  -
EINVAL
;

4818 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

4819 iàĞ
	`uÆik–y
(!
	`g‘_·ge
(
·ge
, 
dom
)) )

4820  -
EINVAL
;

4823  
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
 )

4825 
PGT_£g_desc_·ge
:

4826 iàĞ
	`uÆik–y
(!
	`g‘_·ge_ty³
(
·ge
, 
PGT_£g_desc_·ge
)) )

4827 
out
;

4830 iàĞ
	`uÆik–y
(!
	`g‘_·ge_ty³
(
·ge
, 
PGT_wr™abË_·ge
)) )

4831 
out
;

4835 
	`·gšg_m¬k_dœty
(
dom
, 
mâ
);

4838 
gdt_³Á
 = 
	`m­_domaš_·ge
(
mâ
);

4839 
	`©omic_wr™e64
((
ušt64_t
 *)&
gdt_³Á
[
off£t
], *(ušt64_ˆ*)&
d
);

4840 
	`unm­_domaš_·ge
(
gdt_³Á
);

4842 
	`put_·ge_ty³
(
·ge
);

4844 
»t
 = 0;

4846 
out
:

4847 
	`put_·ge
(
·ge
);

4849  
»t
;

4850 
	}
}

4852 
e820’Œy
 
	te820’Œy_t
;

4853 
DEFINE_XEN_GUEST_HANDLE
(
e820’Œy_t
);

4855 
	smemÜy_m­_cÚ‹xt


4857 
	mn
;

4858 
	ms
;

4859 
x’_memÜy_m­
 
	mm­
;

4862 
	$hªdË_iomem_¿nge
(
s
, 
e
, *
p
)

4864 
memÜy_m­_cÚ‹xt
 *
ùxt
 = 
p
;

4866 iàĞ
s
 > 
ùxt
->s )

4868 
e820’Œy_t
 
’t
;

4869 
	`XEN_GUEST_HANDLE
(
e820’Œy_t
è
bufãr
;

4871 iàĞ
ùxt
->
n
 + 1 >ğùxt->
m­
.
Ä_’Œ›s
 )

4872  -
EINVAL
;

4873 
’t
.
addr
 = (
ušt64_t
)
ùxt
->
s
 << 
PAGE_SHIFT
;

4874 
’t
.
size
 = (
ušt64_t
)(
s
 - 
ùxt
->sè<< 
PAGE_SHIFT
;

4875 
’t
.
ty³
 = 
E820_RESERVED
;

4876 
bufãr
 = 
	`gue¡_hªdË_ÿ¡
(
ùxt
->
m­
.bufãr, 
e820’Œy_t
);

4877 iàĞ
	`__cİy_to_gue¡_off£t
(
bufãr
, 
ùxt
->
n
, &
’t
, 1) )

4878  -
EFAULT
;

4879 
ùxt
->
n
++;

4881 
ùxt
->
s
 = 
e
 + 1;

4884 
	}
}

4886 
¬ch_memÜy_İ
(
İ
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

4888 
·ge_šfo
 *
·ge
 = 
NULL
;

4889 
rc
;

4891  
İ
 )

4893 
XENMEM_add_to_physm­
:

4895 
x’_add_to_physm­
 
x©p
;

4896 
´ev_mâ
, 
mâ
 = 0, 
gpâ
;

4897 
domaš
 *
d
;

4899 iàĞ
	`cİy_äom_gue¡
(&
x©p
, 
¬g
, 1) )

4900  -
EFAULT
;

4902 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
x©p
.
domid
, &
d
);

4903 iàĞ
rc
 != 0 )

4904  
rc
;

4906 iàĞ
	`xsm_add_to_physm­
(
cu¼’t
->
domaš
, 
d
) )

4908 
	`rcu_uÆock_domaš
(
d
);

4909  -
EPERM
;

4912  
x©p
.
¥aû
 )

4914 
XENMAPSPACE_sh¬ed_šfo
:

4915 iàĞ
x©p
.
idx
 == 0 )

4916 
mâ
 = 
	`vœt_to_mâ
(
d
->
sh¬ed_šfo
);

4918 
XENMAPSPACE_g¿Á_bË
:

4919 
	`¥š_lock
(&
d
->
g¿Á_bË
->
lock
);

4921 iàĞ
d
->
g¿Á_bË
->
gt_v”siÚ
 == 0 )

4922 
d
->
g¿Á_bË
->
gt_v”siÚ
 = 1;

4924 iàĞ
d
->
g¿Á_bË
->
gt_v”siÚ
 == 2 &&

4925 (
x©p
.
idx
 & 
XENMAPIDX_g¿Á_bË_¡©us
) )

4927 
x©p
.
idx
 &ğ~
XENMAPIDX_g¿Á_bË_¡©us
;

4928 iàĞ
x©p
.
idx
 < 
	`Ä_¡©us_äames
(
d
->
g¿Á_bË
) )

4929 
mâ
 = 
	`vœt_to_mâ
(
d
->
g¿Á_bË
->
¡©us
[
x©p
.
idx
]);

4933 iàĞ(
x©p
.
idx
 >ğ
	`Ä_g¿Á_äames
(
d
->
g¿Á_bË
)) &&

4934 (
x©p
.
idx
 < 
max_Ä_g¿Á_äames
) )

4935 
	`gÁb_grow_bË
(
d
, 
x©p
.
idx
 + 1);

4937 iàĞ
x©p
.
idx
 < 
	`Ä_g¿Á_äames
(
d
->
g¿Á_bË
) )

4938 
mâ
 = 
	`vœt_to_mâ
(
d
->
g¿Á_bË
->
sh¬ed_¿w
[
x©p
.
idx
]);

4941 
	`¥š_uÆock
(&
d
->
g¿Á_bË
->
lock
);

4943 
XENMAPSPACE_gmâ
:

4945 
p2m_ty³_t
 
p2mt
;

4947 
x©p
.
idx
 = 
	`mâ_x
(
	`gâ_to_mâ_unsh¬e
(
	`p2m_g‘_ho¡p2m
(
d
),

4948 
x©p
.
idx
, &
p2mt
, 0));

4950 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

4952 
	`rcu_uÆock_domaš
(
d
);

4953  -
ENOMEM
;

4955 iàĞ!
	`g‘_·ge_äom_·g’r
(
x©p
.
idx
, 
d
) )

4957 
mâ
 = 
x©p
.
idx
;

4958 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

4965 iàĞ!
	`·gšg_mode_Œª¦©e
(
d
è|| (
mâ
 == 0) )

4967 iàĞ
·ge
 )

4968 
	`put_·ge
(
·ge
);

4969 
	`rcu_uÆock_domaš
(
d
);

4970  -
EINVAL
;

4973 
	`domaš_lock
(
d
);

4975 iàĞ
·ge
 )

4976 
	`put_·ge
(
·ge
);

4979 
´ev_mâ
 = 
	`gmâ_to_mâ
(
d
, 
x©p
.
gpâ
);

4980 iàĞ
	`mâ_v®id
(
´ev_mâ
) )

4982 iàĞ
	`is_x’_h—p_mâ
(
´ev_mâ
) )

4984 
	`gue¡_physm­_»move_·ge
(
d
, 
x©p
.
gpâ
, 
´ev_mâ
, 0);

4987 
	`gue¡_»move_·ge
(
d
, 
x©p
.
gpâ
);

4991 
gpâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
);

4992 
	`ASSERT
Ğ
gpâ
 !ğ
SHARED_M2P_ENTRY
 );

4993 iàĞ
gpâ
 !ğ
INVALID_M2P_ENTRY
 )

4994 
	`gue¡_physm­_»move_·ge
(
d
, 
gpâ
, 
mâ
, 0);

4997 
rc
 = 
	`gue¡_physm­_add_·ge
(
d
, 
x©p
.
gpâ
, 
mâ
, 0);

4999 
	`domaš_uÆock
(
d
);

5001 
	`rcu_uÆock_domaš
(
d
);

5003  
rc
;

5006 
XENMEM_£t_memÜy_m­
:

5008 
x’_fÜeign_memÜy_m­
 
fm­
;

5009 
domaš
 *
d
;

5011 iàĞ
	`cİy_äom_gue¡
(&
fm­
, 
¬g
, 1) )

5012  -
EFAULT
;

5014 iàĞ
fm­
.
m­
.
Ä_’Œ›s
 > 
	`ARRAY_SIZE
(
d
->
¬ch
.
e820
) )

5015  -
EINVAL
;

5017 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
fm­
.
domid
, &
d
);

5018 iàĞ
rc
 != 0 )

5019  
rc
;

5021 
rc
 = 
	`xsm_domaš_memÜy_m­
(
d
);

5022 iàĞ
rc
 )

5024 
	`rcu_uÆock_domaš
(
d
);

5025  
rc
;

5028 
rc
 = 
	`cİy_äom_gue¡
(
d
->
¬ch
.
e820
, 
fm­
.
m­
.
bufãr
,

5029 
fm­
.
m­
.
Ä_’Œ›s
è? -
EFAULT
 : 0;

5030 
d
->
¬ch
.
Ä_e820
 = 
fm­
.
m­
.
Ä_’Œ›s
;

5032 
	`rcu_uÆock_domaš
(
d
);

5033  
rc
;

5036 
XENMEM_memÜy_m­
:

5038 
x’_memÜy_m­
 
m­
;

5039 
domaš
 *
d
 = 
cu¼’t
->domain;

5042 iàĞ
d
->
¬ch
.
Ä_e820
 == 0 )

5043  -
ENOSYS
;

5045 iàĞ
	`cİy_äom_gue¡
(&
m­
, 
¬g
, 1) )

5046  -
EFAULT
;

5048 
m­
.
Ä_’Œ›s
 = 
	`mš
(m­.Ä_’Œ›s, 
d
->
¬ch
.
Ä_e820
);

5049 iàĞ
	`cİy_to_gue¡
(
m­
.
bufãr
, 
d
->
¬ch
.
e820
, m­.
Ä_’Œ›s
) ||

5050 
	`cİy_to_gue¡
(
¬g
, &
m­
, 1) )

5051  -
EFAULT
;

5056 
XENMEM_machše_memÜy_m­
:

5058 
memÜy_m­_cÚ‹xt
 
ùxt
;

5059 
	`XEN_GUEST_HANDLE
(
e820’Œy_t
è
bufãr
;

5060 
i
;

5062 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) )

5063  -
EINVAL
;

5065 
rc
 = 
	`xsm_machše_memÜy_m­
();

5066 iàĞ
rc
 )

5067  
rc
;

5069 iàĞ
	`cİy_äom_gue¡
(&
ùxt
.
m­
, 
¬g
, 1) )

5070  -
EFAULT
;

5071 iàĞ
ùxt
.
m­
.
Ä_’Œ›s
 < 
e820
.
Ä_m­
 + 1 )

5072  -
EINVAL
;

5074 
bufãr
 = 
	`gue¡_hªdË_ÿ¡
(
ùxt
.
m­
.bufãr, 
e820’Œy_t
);

5075 iàĞ!
	`gue¡_hªdË_okay
(
bufãr
, 
ùxt
.
m­
.
Ä_’Œ›s
) )

5076  -
EFAULT
;

5078  
i
 = 0, 
ùxt
.
n
 = 0, ctxt.
s
 = 0; i < 
e820
.
Ä_m­
; ++i, ++ctxt.n )

5080 
s
 = 
	`PFN_DOWN
(
e820
.
m­
[
i
].
addr
);

5082 iàĞ
s
 )

5084 
rc
 = 
	`¿nge£t_»pÜt_¿nges
(
cu¼’t
->
domaš
->
iomem_ÿps
,

5085 
ùxt
.
s
, s - 1,

5086 
hªdË_iomem_¿nge
, &
ùxt
);

5087 iàĞ!
rc
 )

5088 
rc
 = 
	`hªdË_iomem_¿nge
(
s
, s, &
ùxt
);

5089 iàĞ
rc
 )

5090  
rc
;

5092 iàĞ
ùxt
.
m­
.
Ä_’Œ›s
 <ğùxt.
n
 + (
e820
.
Ä_m­
 - 
i
) )

5093  -
EINVAL
;

5094 iàĞ
	`__cİy_to_gue¡_off£t
(
bufãr
, 
ùxt
.
n
, 
e820
.
m­
 + 
i
, 1) )

5095  -
EFAULT
;

5096 
ùxt
.
s
 = 
	`PFN_UP
(
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
);

5099 iàĞ
ùxt
.
s
 )

5101 
rc
 = 
	`¿nge£t_»pÜt_¿nges
(
cu¼’t
->
domaš
->
iomem_ÿps
, 
ùxt
.
s
,

5102 ~0UL, 
hªdË_iomem_¿nge
, &
ùxt
);

5103 iàĞ!
rc
 && 
ùxt
.
s
 )

5104 
rc
 = 
	`hªdË_iomem_¿nge
(~0UL, ~0UL, &
ùxt
);

5105 iàĞ
rc
 )

5106  
rc
;

5109 
ùxt
.
m­
.
Ä_’Œ›s
 = ctxt.
n
;

5111 iàĞ
	`cİy_to_gue¡
(
¬g
, &
ùxt
.
m­
, 1) )

5112  -
EFAULT
;

5117 
XENMEM_machphys_m­pšg
:

5119 
x’_machphys_m­pšg
 
m­pšg
 = {

5120 .
v_¡¬t
 = 
MACH2PHYS_VIRT_START
,

5121 .
v_’d
 = 
MACH2PHYS_VIRT_END
,

5122 .
max_mâ
 = 
MACH2PHYS_NR_ENTRIES
 - 1

5125 iàĞ!
mem_hÙ¶ug
 )

5126 
m­pšg
.
max_mâ
 = 
max_·ge
 - 1;

5127 iàĞ
	`cİy_to_gue¡
(
¬g
, &
m­pšg
, 1) )

5128  -
EFAULT
;

5133 
XENMEM_£t_pod_rg‘
:

5134 
XENMEM_g‘_pod_rg‘
:

5136 
x’_pod_rg‘_t
 
rg‘
;

5137 
domaš
 *
d
;

5138 
p2m_domaš
 *
p2m
;

5141 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) )

5142  -
EINVAL
;

5144 iàĞ
	`cİy_äom_gue¡
(&
rg‘
, 
¬g
, 1) )

5145  -
EFAULT
;

5147 
rc
 = 
	`rcu_lock_rg‘_domaš_by_id
(
rg‘
.
domid
, &
d
);

5148 iàĞ
rc
 != 0 )

5149  
rc
;

5151 iàĞ
İ
 =ğ
XENMEM_£t_pod_rg‘
 )

5153 iàĞ
rg‘
.
rg‘_·ges
 > 
d
->
max_·ges
 )

5155 
rc
 = -
EINVAL
;

5156 
pod_rg‘_out_uÆock
;

5159 
rc
 = 
	`p2m_pod_£t_mem_rg‘
(
d
, 
rg‘
.
rg‘_·ges
);

5162 iàĞ
rc
 =ğ-
EAGAIN
 )

5164 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

5165 
__HYPERVISOR_memÜy_İ
, "lh", 
İ
, 
¬g
);

5167 iàĞ
rc
 >= 0 )

5169 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

5170 
rg‘
.
tÙ_·ges
 = 
d
->tot_pages;

5171 
rg‘
.
pod_ÿche_·ges
 = 
p2m
->
pod
.
couÁ
;

5172 
rg‘
.
pod_’Œ›s
 = 
p2m
->
pod
.
’Œy_couÁ
;

5174 iàĞ
	`cİy_to_gue¡
(
¬g
, &
rg‘
, 1) )

5176 
rc
ğ-
EFAULT
;

5177 
pod_rg‘_out_uÆock
;

5181 
pod_rg‘_out_uÆock
:

5182 
	`rcu_uÆock_domaš
(
d
);

5183  
rc
;

5186 #ifdeà
__x86_64__


5187 
XENMEM_g‘_sh¬šg_ä“d_·ges
:

5188  
	`mem_sh¬šg_g‘_Ä_§ved_mâs
();

5192  
	`sub¬ch_memÜy_İ
(
İ
, 
¬g
);

5196 
	}
}

5203 
	s±wr_emuÏ‹_ùxt
 {

5204 
x86_emuÏ‹_ùxt
 
	mùxt
;

5205 
	mü2
;

5206 
l1_pg’Œy_t
 
	m±e
;

5209 
	$±wr_emuÏ‹d_»ad
(

5210 
x86_£gm’t
 
£g
,

5211 
off£t
,

5212 *
p_d©a
,

5213 
by‹s
,

5214 
x86_emuÏ‹_ùxt
 *
ùxt
)

5216 
rc
;

5217 
addr
 = 
off£t
;

5219 iàĞ(
rc
 = 
	`cİy_äom_u£r
(
p_d©a
, (*)
addr
, 
by‹s
)) != 0 )

5221 
	`´İag©e_·ge_çuÉ
(
addr
 + 
by‹s
 - 
rc
, 0);

5222  
X86EMUL_EXCEPTION
;

5225  
X86EMUL_OKAY
;

5226 
	}
}

5228 
	$±wr_emuÏ‹d_upd©e
(

5229 
addr
,

5230 
·ddr_t
 
Şd
,

5231 
·ddr_t
 
v®
,

5232 
by‹s
,

5233 
do_cmpxchg
,

5234 
±wr_emuÏ‹_ùxt
 *
±wr_ùxt
)

5236 
mâ
;

5237 
uÇligÃd_addr
 = 
addr
;

5238 
·ge_šfo
 *
·ge
;

5239 
l1_pg’Œy_t
 
±e
, 
Ş1e
, 
Æ1e
, *
¶1e
;

5240 
vıu
 *
v
 = 
cu¼’t
;

5241 
domaš
 *
d
 = 
v
->domain;

5244 iàĞ
	`uÆik–y
(((
addr
^
±wr_ùxt
->
ü2
è& 
PAGE_MASK
è|| (add¸& (
by‹s
-1))) )

5246 
	`MEM_LOG
("ptwr_emulate: bad‡ccess (cr2=%lx,‡ddr=%lx, bytes=%u)",

5247 
±wr_ùxt
->
ü2
, 
addr
, 
by‹s
);

5248  
X86EMUL_UNHANDLEABLE
;

5252 iàĞ
by‹s
 !ğ(
·ddr_t
) )

5254 
·ddr_t
 
fuÎ
;

5255 
rc
, 
off£t
 = 
addr
 & ((
·ddr_t
)-1);

5258 
addr
 &ğ~((
·ddr_t
)-1);

5259 iàĞ(
rc
 = 
	`cİy_äom_u£r
(&
fuÎ
, (*)
addr
, (
·ddr_t
))) != 0 )

5261 
	`´İag©e_·ge_çuÉ
(
addr
+(
·ddr_t
)-
rc
, 0);

5262  
X86EMUL_EXCEPTION
;

5265 
fuÎ
 &ğ~((((
·ddr_t
)1 << (
by‹s
*8)è- 1è<< (
off£t
*8));

5267 
v®
 &ğ(((
·ddr_t
)1 << (
by‹s
*8)) - 1);

5268 
v®
 <<ğ(
off£t
)*8;

5269 
v®
 |ğ
fuÎ
;

5271 
Şd
 &ğ(((
·ddr_t
)1 << (
by‹s
*8)) - 1);

5272 
Şd
 <<ğ(
off£t
)*8;

5273 
Şd
 |ğ
fuÎ
;

5276 
±e
 = 
±wr_ùxt
->pte;

5277 
mâ
 = 
	`l1e_g‘_pâ
(
±e
);

5278 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

5281 
	`ASSERT
((
	`l1e_g‘_æags
(
±e
è& (
_PAGE_RW
|
_PAGE_PRESENT
)) == _PAGE_PRESENT);

5282 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

5283 
	`ASSERT
((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è=ğ
PGT_l1_·ge_bË
);

5284 
	`ASSERT
((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0);

5285 
	`ASSERT
(
	`·ge_g‘_owÃr
(
·ge
è=ğ
d
);

5288 
Æ1e
 = 
	`l1e_äom_š‹
(
v®
);

5289  
	`g‘_·ge_äom_l1e
(
Æ1e
, 
d
, d) )

5292 iàĞ
	`is_pv_32b™_domaš
(
d
è&& (
by‹s
 =ğ4è&& (
uÇligÃd_addr
 & 4) &&

5293 !
do_cmpxchg
 && (
	`l1e_g‘_æags
(
Æ1e
è& 
_PAGE_PRESENT
) )

5301 
	`gd´štk
(
XENLOG_DEBUG
, "ptwr_emulate: fixing up invalid PAE PTE %"

5302 
PRI±e
"\n", 
	`l1e_g‘_š‹
(
Æ1e
));

5303 
	`l1e_»move_æags
(
Æ1e
, 
_PAGE_PRESENT
);

5307 
	`MEM_LOG
("ptwr_emulate: could‚ot get_page_from_l1e()");

5308  
X86EMUL_UNHANDLEABLE
;

5312 
	`l1e_»move_æags
(
Æ1e
, 
_PAGE_RW
);

5316 
	`adju¡_gue¡_l1e
(
Æ1e
, 
d
);

5319 
¶1e
 = 
	`m­_domaš_·ge
(
mâ
);

5320 
¶1e
 = (
l1_pg’Œy_t
 *)((íl1+ (
addr
 & ~
PAGE_MASK
));

5321 iàĞ
do_cmpxchg
 )

5323 #ifdeà
ENABLE_PT_MODIFICATION


5325 
	`lock_±
(
mâ
, 1, 2);

5327 
okay
;

5328 
š‹_t
 
t
 = 
Şd
;

5329 
Ş1e
 = 
	`l1e_äom_š‹
(
Şd
);

5331 
okay
 = 
	`·gšg_cmpxchg_gue¡_’Œy
(
v
, &
	`l1e_g‘_š‹
(*
¶1e
),

5332 &
t
, 
	`l1e_g‘_š‹
(
Æ1e
), 
	`_mâ
(
mâ
));

5333 
okay
 = (okay && 
t
 =ğ
Şd
);

5335 iàĞ!
okay
 )

5337 
	`unm­_domaš_·ge
(
¶1e
);

5338 
	`put_·ge_äom_l1e
(
Æ1e
, 
d
);

5339 #ifdeà
ENABLE_PT_MODIFICATION


5340 
	`my´štk
("INFO†ast…ath I missed..\n");

5341 
	`uÆock_±
(0);

5343  
X86EMUL_CMPXCHG_FAILED
;

5345 #ifdeà
ENABLE_PT_MODIFICATION


5351 
Ş1e
 = *
¶1e
;

5352 #ifdeà
ENABLE_PT_MODIFICATION


5353 iàĞ!
	`MY_UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
mâ
, 
v
, 0, 101, 1) )

5355 iàĞ!
	`UPDATE_ENTRY
(
l1
, 
¶1e
, 
Ş1e
, 
Æ1e
, 
mâ
, 
v
, 0) )

5357 
	`BUG
();

5360 
	`Œaû_±wr_emuÏtiÚ
(
addr
, 
Æ1e
);

5361 #ifdeà
ENABLE_PT_MODIFICATION


5362 ià(
mši_aùiv©ed
) {

5363 
	`©omic_šc
(&
mši_couÁ
);

5364 
	`©omic_šc
(&
mši_¶aû
[2]);

5365 #ifdeà
VERBOSE_PAGE_TABLE_PTWR_EMULATED_UPDATE


5366 
	`my´štk
("PTWR: %x[%d] %x->%x,…l1e:%x\n", 
mâ
, (()
¶1e
&0xfff)>>2, 
Şd
, 
Æ1e
.
l1
,…l1e);

5368 
	`l1e_upd©e_sucûss
(
¶1e
, 
Ş1e
, 
Æ1e
);

5369 
	`©omic_dec
(&
mši_¶aû
[2]);

5370 
	`©omic_dec
(&
mši_couÁ
);

5371 } ià(
	`this_ıu
(
found_±
)) {

5372 
	`uÆock_±
(0);

5375 
	`unm­_domaš_·ge
(
¶1e
);

5378 
	`put_·ge_äom_l1e
(
Ş1e
, 
d
);

5380  
X86EMUL_OKAY
;

5381 
	}
}

5383 
	$±wr_emuÏ‹d_wr™e
(

5384 
x86_£gm’t
 
£g
,

5385 
off£t
,

5386 *
p_d©a
,

5387 
by‹s
,

5388 
x86_emuÏ‹_ùxt
 *
ùxt
)

5390 
·ddr_t
 
v®
 = 0;

5392 iàĞ(
by‹s
 > (
·ddr_t
)) || (bytes & (bytes -1)) )

5394 
	`MEM_LOG
("ptwr_emulate: bad write size (addr=%lx, bytes=%u)",

5395 
off£t
, 
by‹s
);

5396  
X86EMUL_UNHANDLEABLE
;

5399 
	`memıy
(&
v®
, 
p_d©a
, 
by‹s
);

5401  
	`±wr_emuÏ‹d_upd©e
(

5402 
off£t
, 0, 
v®
, 
by‹s
, 0,

5403 
	`cÚš”_of
(
ùxt
, 
±wr_emuÏ‹_ùxt
, ctxt));

5404 
	}
}

5406 
	$±wr_emuÏ‹d_cmpxchg
(

5407 
x86_£gm’t
 
£g
,

5408 
off£t
,

5409 *
p_Şd
,

5410 *
p_Ãw
,

5411 
by‹s
,

5412 
x86_emuÏ‹_ùxt
 *
ùxt
)

5414 
·ddr_t
 
Şd
 = 0, 
Ãw
 = 0;

5416 iàĞ(
by‹s
 > (
·ddr_t
)) || (bytes & (bytes -1)) )

5418 
	`MEM_LOG
("ptwr_emulate: bad cmpxchg size (addr=%lx, bytes=%u)",

5419 
off£t
, 
by‹s
);

5420  
X86EMUL_UNHANDLEABLE
;

5423 
	`memıy
(&
Şd
, 
p_Şd
, 
by‹s
);

5424 
	`memıy
(&
Ãw
, 
p_Ãw
, 
by‹s
);

5426  
	`±wr_emuÏ‹d_upd©e
(

5427 
off£t
, 
Şd
, 
Ãw
, 
by‹s
, 1,

5428 
	`cÚš”_of
(
ùxt
, 
±wr_emuÏ‹_ùxt
, ctxt));

5429 
	}
}

5431 cÚ¡ 
x86_emuÏ‹_İs
 
	g±wr_emuÏ‹_İs
 = {

5432 .
»ad
 = 
±wr_emuÏ‹d_»ad
,

5433 .
	gš¢_ãtch
 = 
±wr_emuÏ‹d_»ad
,

5434 .
	gwr™e
 = 
±wr_emuÏ‹d_wr™e
,

5435 .
	gcmpxchg
 = 
±wr_emuÏ‹d_cmpxchg
,

5439 
	$±wr_do_·ge_çuÉ
(
vıu
 *
v
, 
addr
,

5440 
ıu_u£r_»gs
 *
»gs
)

5442 
domaš
 *
d
 = 
v
->domain;

5443 
·ge_šfo
 *
·ge
;

5444 
l1_pg’Œy_t
 
±e
;

5445 
±wr_emuÏ‹_ùxt
 
±wr_ùxt
;

5446 
rc
;

5449 
	`gue¡_g‘_eff_l1e
(
v
, 
addr
, &
±e
);

5452 iàĞ((
	`l1e_g‘_æags
(
±e
è& (
_PAGE_PRESENT
|
_PAGE_RW
)) != _PAGE_PRESENT) ||

5453 !
	`g‘_·ge_äom_·g’r
(
	`l1e_g‘_pâ
(
±e
), 
d
) )

5454 
ba
;

5456 
·ge
 = 
	`l1e_g‘_·ge
(
±e
);

5457 iàĞ!
	`·ge_lock
(
·ge
) )

5459 
	`put_·ge
(
·ge
);

5460 
ba
;

5463 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_l1_·ge_bË
 )

5465 
	`·ge_uÆock
(
·ge
);

5466 
	`put_·ge
(
·ge
);

5467 
ba
;

5470 
±wr_ùxt
.
ùxt
.
»gs
 =„egs;

5471 
±wr_ùxt
.
ùxt
.
fÜû_wr™eback
 = 0;

5472 
±wr_ùxt
.
ùxt
.
addr_size
 =…twr_ùxt.ùxt.
¥_size
 =

5473 
	`is_pv_32Ú64_domaš
(
d
è? 32 : 
BITS_PER_LONG
;

5474 
±wr_ùxt
.
ü2
 = 
addr
;

5475 
±wr_ùxt
.
±e
 =…te;

5477 
rc
 = 
	`x86_emuÏ‹
(&
±wr_ùxt
.
ùxt
, &
±wr_emuÏ‹_İs
);

5479 
	`·ge_uÆock
(
·ge
);

5480 
	`put_·ge
(
·ge
);

5482 iàĞ
rc
 =ğ
X86EMUL_UNHANDLEABLE
 )

5483 
ba
;

5485 
	`³rfc_šü
(
±wr_emuÏtiÚs
);

5486  
EXCRET_çuÉ_fixed
;

5488 
ba
:

5490 
	}
}

5492 
	$ä“_x’_·g‘abË
(*
v
)

5494 iàĞ
—¾y_boÙ
 )

5497 iàĞ
	`is_x’_h—p_·ge
(
	`vœt_to_·ge
(
v
)) )

5498 
	`ä“_x’h—p_·ge
(
v
);

5500 
	`ä“_domh—p_·ge
(
	`vœt_to_·ge
(
v
));

5501 
	}
}

5504 
	#l1f_to_lNf
(
f
è(((fè& 
_PAGE_PRESENT
è? ((fè| 
_PAGE_PSE
è: (f))

	)

5505 
	#lNf_to_l1f
(
f
è(((fè& 
_PAGE_PRESENT
è? ((fè& ~
_PAGE_PSE
è: (f))

	)

5515 
	#æush_¬—
(
v
,
f
è(!
	`loÿl_œq_is_’abËd
() ? \

5516 
	`æush_¬—_loÿl
((cÚ¡ *)
v
, 
f
) : \

5517 
	`æush_¬—_®l
((cÚ¡ *)
v
, 
f
))

	)

5519 
	$m­_·ges_to_x’
(

5520 
vœt
,

5521 
mâ
,

5522 
Ä_mâs
,

5523 
æags
)

5525 
l2_pg’Œy_t
 *
¶2e
, 
Ş2e
;

5526 
l1_pg’Œy_t
 *
¶1e
, 
Ş1e
;

5527 
i
;

5529  
Ä_mâs
 != 0 )

5531 #ifdeà
__x86_64__


5532 
l3_pg’Œy_t
 
Ş3e
, *
¶3e
 = 
	`vœt_to_x’_l3e
(
vœt
);

5534 iàĞ!
¶3e
 )

5535  -
ENOMEM
;

5536 
Ş3e
 = *
¶3e
;

5538 iàĞ
ıu_has_·ge1gb
 &&

5539 !(((
vœt
 >> 
PAGE_SHIFT
è| 
mâ
) &

5540 ((1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1)) &&

5541 
Ä_mâs
 >ğ(1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) &&

5542 !(
æags
 & (
_PAGE_PAT
 | 
MAP_SMALL_PAGES
)) )

5545 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_äom_pâ
(
mâ
, 
	`l1f_to_lNf
(
æags
)));

5547 iàĞ(
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_PRESENT
) )

5549 
æush_æags
 =

5550 
FLUSH_TLB
 | 
	`FLUSH_ORDER
(2 * 
PAGETABLE_ORDER
);

5552 iàĞ
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_PSE
 )

5554 iàĞ
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_GLOBAL
 )

5555 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5556 iàĞ(
	`lNf_to_l1f
(
	`l3e_g‘_æags
(
Ş3e
)è^ 
æags
) &

5557 
PAGE_CACHE_ATTRS
 )

5558 
æush_æags
 |ğ
FLUSH_CACHE
;

5559 
	`æush_¬—
(
vœt
, 
æush_æags
);

5563 
¶2e
 = 
	`l3e_to_l2e
(
Ş3e
);

5564  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

5566 
Ş2e
 = 
¶2e
[
i
];

5567 iàĞ!(
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PRESENT
) )

5569 iàĞ
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PSE
 )

5571 iàĞ
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_GLOBAL
 )

5572 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5573 iàĞ(
	`lNf_to_l1f
(
	`l2e_g‘_æags
(
Ş2e
)è^ 
æags
) &

5574 
PAGE_CACHE_ATTRS
 )

5575 
æush_æags
 |ğ
FLUSH_CACHE
;

5579 
j
;

5581 
¶1e
 = 
	`l2e_to_l1e
(
Ş2e
);

5582  
j
 = 0; j < 
L1_PAGETABLE_ENTRIES
; j++ )

5584 
Ş1e
 = 
¶1e
[
j
];

5585 iàĞ
	`l1e_g‘_æags
(
Ş1e
è& 
_PAGE_GLOBAL
 )

5586 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5587 iàĞ(
	`l1e_g‘_æags
(
Ş1e
è^ 
æags
) &

5588 
PAGE_CACHE_ATTRS
 )

5589 
æush_æags
 |ğ
FLUSH_CACHE
;

5593 
	`æush_¬—
(
vœt
, 
æush_æags
);

5594  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

5596 
Ş2e
 = 
¶2e
[
i
];

5597 iàĞ(
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PRESENT
) &&

5598 !(
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PSE
) )

5599 
	`ä“_x’_·g‘abË
(
	`l2e_to_l1e
(
Ş2e
));

5601 
	`ä“_x’_·g‘abË
(
¶2e
);

5605 
vœt
 +ğ1UL << 
L3_PAGETABLE_SHIFT
;

5606 
mâ
 +ğ1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

5607 
Ä_mâs
 -ğ1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

5611 iàĞ(
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_PRESENT
) &&

5612 (
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_PSE
) )

5614 
æush_æags
 =

5615 
FLUSH_TLB
 | 
	`FLUSH_ORDER
(2 * 
PAGETABLE_ORDER
);

5618 iàĞ((
	`l3e_g‘_pâ
(
Ş3e
è& ~(
L2_PAGETABLE_ENTRIES
 *

5619 
L1_PAGETABLE_ENTRIES
 - 1)) +

5620 (
	`l2_bË_off£t
(
vœt
è<< 
PAGETABLE_ORDER
) +

5621 
	`l1_bË_off£t
(
vœt
è=ğ
mâ
) &&

5622 ((
	`lNf_to_l1f
(
	`l3e_g‘_æags
(
Ş3e
)è^ 
æags
) &

5623 ~(
_PAGE_ACCESSED
|
_PAGE_DIRTY
)) == 0 )

5626 
i
 = (1 << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) -

5627 (
mâ
 & ((1 << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1));

5628 iàĞ
i
 > 
Ä_mâs
 )

5629 
i
 = 
Ä_mâs
;

5630 
vœt
 +ğ
i
 << 
PAGE_SHIFT
;

5631 
mâ
 +ğ
i
;

5632 
Ä_mâs
 -ğ
i
;

5636 
¶2e
 = 
	`®loc_x’_·g‘abË
();

5637 iàĞ
¶2e
 =ğ
NULL
 )

5638  -
ENOMEM
;

5640  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

5641 
	`l2e_wr™e
(
¶2e
 + 
i
,

5642 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(
Ş3e
) +

5643 (
i
 << 
PAGETABLE_ORDER
),

5644 
	`l3e_g‘_æags
(
Ş3e
)));

5646 iàĞ
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_GLOBAL
 )

5647 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5649 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_äom_pâ
(
	`vœt_to_mâ
(
¶2e
),

5650 
__PAGE_HYPERVISOR
));

5651 
	`æush_¬—
(
vœt
, 
æush_æags
);

5655 
¶2e
 = 
	`vœt_to_x’_l2e
(
vœt
);

5656 iàĞ!
¶2e
 )

5657  -
ENOMEM
;

5659 iàĞ((((
vœt
>>
PAGE_SHIFT
è| 
mâ
è& ((1<<
PAGETABLE_ORDER
)-1)) == 0) &&

5660 (
Ä_mâs
 >ğ(1<<
PAGETABLE_ORDER
)) &&

5661 !(
æags
 & (
_PAGE_PAT
|
MAP_SMALL_PAGES
)) )

5664 
Ş2e
 = *
¶2e
;

5665 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_äom_pâ
(
mâ
, 
	`l1f_to_lNf
(
æags
)));

5667 iàĞ(
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PRESENT
) )

5669 
æush_æags
 =

5670 
FLUSH_TLB
 | 
	`FLUSH_ORDER
(
PAGETABLE_ORDER
);

5672 iàĞ
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PSE
 )

5674 iàĞ
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_GLOBAL
 )

5675 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5676 iàĞ(
	`lNf_to_l1f
(
	`l2e_g‘_æags
(
Ş2e
)è^ 
æags
) &

5677 
PAGE_CACHE_ATTRS
 )

5678 
æush_æags
 |ğ
FLUSH_CACHE
;

5679 
	`æush_¬—
(
vœt
, 
æush_æags
);

5683 
¶1e
 = 
	`l2e_to_l1e
(
Ş2e
);

5684  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

5686 iàĞ
	`l1e_g‘_æags
(
¶1e
[
i
]è& 
_PAGE_GLOBAL
 )

5687 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5688 iàĞ(
	`l1e_g‘_æags
(
¶1e
[
i
]è^ 
æags
) &

5689 
PAGE_CACHE_ATTRS
 )

5690 
æush_æags
 |ğ
FLUSH_CACHE
;

5692 
	`æush_¬—
(
vœt
, 
æush_æags
);

5693 
	`ä“_x’_·g‘abË
(
¶1e
);

5697 
vœt
 +ğ1UL << 
L2_PAGETABLE_SHIFT
;

5698 
mâ
 +ğ1UL << 
PAGETABLE_ORDER
;

5699 
Ä_mâs
 -ğ1UL << 
PAGETABLE_ORDER
;

5704 iàĞ!(
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PRESENT
) )

5706 
¶1e
 = 
	`®loc_x’_·g‘abË
();

5707 iàĞ
¶1e
 =ğ
NULL
 )

5708  -
ENOMEM
;

5709 
	`ş—r_·ge
(
¶1e
);

5710 
	`l2e_wr™e
(
¶2e
, 
	`l2e_äom_pâ
(
	`vœt_to_mâ
(
¶1e
),

5711 
__PAGE_HYPERVISOR
));

5713 iàĞ
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PSE
 )

5715 
æush_æags
 =

5716 
FLUSH_TLB
 | 
	`FLUSH_ORDER
(
PAGETABLE_ORDER
);

5719 iàĞ(((
	`l2e_g‘_pâ
(*
¶2e
è& ~(
L1_PAGETABLE_ENTRIES
 - 1)) +

5720 
	`l1_bË_off£t
(
vœt
)è=ğ
mâ
) &&

5721 (((
	`lNf_to_l1f
(
	`l2e_g‘_æags
(*
¶2e
)è^ 
æags
) &

5722 ~(
_PAGE_ACCESSED
|
_PAGE_DIRTY
)) == 0) )

5725 
i
 = (1 << (
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) -

5726 (
mâ
 & ((1 << (
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1));

5727 iàĞ
i
 > 
Ä_mâs
 )

5728 
i
 = 
Ä_mâs
;

5729 
vœt
 +ğ
i
 << 
L1_PAGETABLE_SHIFT
;

5730 
mâ
 +ğ
i
;

5731 
Ä_mâs
 -ğ
i
;

5732 
check_l3
;

5735 
¶1e
 = 
	`®loc_x’_·g‘abË
();

5736 iàĞ
¶1e
 =ğ
NULL
 )

5737  -
ENOMEM
;

5739  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

5740 
	`l1e_wr™e
(&
¶1e
[
i
],

5741 
	`l1e_äom_pâ
(
	`l2e_g‘_pâ
(*
¶2e
è+ 
i
,

5742 
	`lNf_to_l1f
(
	`l2e_g‘_æags
(*
¶2e
))));

5744 iàĞ
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_GLOBAL
 )

5745 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5747 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_äom_pâ
(
	`vœt_to_mâ
(
¶1e
),

5748 
__PAGE_HYPERVISOR
));

5749 
	`æush_¬—
(
vœt
, 
æush_æags
);

5752 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
è+ 
	`l1_bË_off£t
(
vœt
);

5753 
Ş1e
 = *
¶1e
;

5754 
	`l1e_wr™e_©omic
(
¶1e
, 
	`l1e_äom_pâ
(
mâ
, 
æags
));

5755 iàĞ(
	`l1e_g‘_æags
(
Ş1e
è& 
_PAGE_PRESENT
) )

5757 
æush_æags
 = 
FLUSH_TLB
 | 
	`FLUSH_ORDER
(0);

5758 iàĞ
	`l1e_g‘_æags
(
Ş1e
è& 
_PAGE_GLOBAL
 )

5759 
æush_æags
 |ğ
FLUSH_TLB_GLOBAL
;

5760 iàĞ(
	`l1e_g‘_æags
(
Ş1e
è^ 
æags
è& 
PAGE_CACHE_ATTRS
 )

5761 
æush_æags
 |ğ
FLUSH_CACHE
;

5762 
	`æush_¬—
(
vœt
, 
æush_æags
);

5765 
vœt
 +ğ1UL << 
L1_PAGETABLE_SHIFT
;

5766 
mâ
 += 1UL;

5767 
Ä_mâs
 -= 1UL;

5769 iàĞ(
æags
 =ğ
PAGE_HYPERVISOR
) &&

5770 ((
Ä_mâs
 == 0) ||

5771 ((((
vœt
 >> 
PAGE_SHIFT
è| 
mâ
) &

5772 ((1 << 
PAGETABLE_ORDER
) - 1)) == 0)) )

5774 
ba£_mâ
;

5775 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
);

5776 
ba£_mâ
 = 
	`l1e_g‘_pâ
(*
¶1e
è& ~(
L1_PAGETABLE_ENTRIES
 - 1);

5777  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++, 
¶1e
++ )

5778 iàĞ(
	`l1e_g‘_pâ
(*
¶1e
è!ğ(
ba£_mâ
 + 
i
)) ||

5779 (
	`l1e_g‘_æags
(*
¶1e
è!ğ
æags
) )

5781 iàĞ
i
 =ğ
L1_PAGETABLE_ENTRIES
 )

5783 
Ş2e
 = *
¶2e
;

5784 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_äom_pâ
(
ba£_mâ
,

5785 
	`l1f_to_lNf
(
æags
)));

5786 
	`æush_¬—
(
vœt
 - 
PAGE_SIZE
,

5787 
FLUSH_TLB_GLOBAL
 |

5788 
	`FLUSH_ORDER
(
PAGETABLE_ORDER
));

5789 
	`ä“_x’_·g‘abË
(
	`l2e_to_l1e
(
Ş2e
));

5794 
check_l3
: ;

5795 #ifdeà
__x86_64__


5796 iàĞ
ıu_has_·ge1gb
 &&

5797 (
æags
 =ğ
PAGE_HYPERVISOR
) &&

5798 ((
Ä_mâs
 == 0) ||

5799 !(((
vœt
 >> 
PAGE_SHIFT
è| 
mâ
) &

5800 ((1UL << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
)) - 1))) )

5802 
ba£_mâ
;

5804 
Ş3e
 = *
¶3e
;

5805 
¶2e
 = 
	`l3e_to_l2e
(
Ş3e
);

5806 
ba£_mâ
 = 
	`l2e_g‘_pâ
(*
¶2e
è& ~(
L2_PAGETABLE_ENTRIES
 *

5807 
L1_PAGETABLE_ENTRIES
 - 1);

5808  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++, 
¶2e
++ )

5809 iàĞ(
	`l2e_g‘_pâ
(*
¶2e
) !=

5810 (
ba£_mâ
 + (
i
 << 
PAGETABLE_ORDER
))) ||

5811 (
	`l2e_g‘_æags
(*
¶2e
è!ğ
	`l1f_to_lNf
(
æags
)) )

5813 iàĞ
i
 =ğ
L2_PAGETABLE_ENTRIES
 )

5815 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_äom_pâ
(
ba£_mâ
,

5816 
	`l1f_to_lNf
(
æags
)));

5817 
	`æush_¬—
(
vœt
 - 
PAGE_SIZE
,

5818 
FLUSH_TLB_GLOBAL
 |

5819 
	`FLUSH_ORDER
(2*
PAGETABLE_ORDER
));

5820 
	`ä“_x’_·g‘abË
(
	`l3e_to_l2e
(
Ş3e
));

5827 
	}
}

5829 
	$de¡roy_x’_m­pšgs
(
s
, 
e
)

5831 
l2_pg’Œy_t
 *
¶2e
;

5832 
l1_pg’Œy_t
 *
¶1e
;

5833 
i
;

5834 
v
 = 
s
;

5836 
	`ASSERT
((
s
 & ~
PAGE_MASK
) == 0);

5837 
	`ASSERT
((
e
 & ~
PAGE_MASK
) == 0);

5839  
v
 < 
e
 )

5841 #ifdeà
__x86_64__


5842 
l3_pg’Œy_t
 *
¶3e
 = 
	`vœt_to_x’_l3e
(
v
);

5844 iàĞ!(
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PRESENT
) )

5846 
v
 +ğ1UL << 
L3_PAGETABLE_SHIFT
;

5847 
v
 &ğ~((1UL << 
L3_PAGETABLE_SHIFT
) - 1);

5851 iàĞ
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PSE
 )

5853 iàĞ
	`l2_bË_off£t
(
v
) == 0 &&

5854 
	`l1_bË_off£t
(
v
) == 0 &&

5855 ((
e
 - 
v
è>ğ(1UL << 
L3_PAGETABLE_SHIFT
)) )

5858 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_em±y
());

5859 
v
 +ğ1UL << 
L3_PAGETABLE_SHIFT
;

5864 
¶2e
 = 
	`®loc_x’_·g‘abË
();

5865  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

5866 
	`l2e_wr™e
(
¶2e
 + 
i
,

5867 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(*
¶3e
) +

5868 (
i
 << 
PAGETABLE_ORDER
),

5869 
	`l3e_g‘_æags
(*
¶3e
)));

5870 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_äom_pâ
(
	`vœt_to_mâ
(
¶2e
),

5871 
__PAGE_HYPERVISOR
));

5875 
¶2e
 = 
	`vœt_to_x’_l2e
(
v
);

5877 iàĞ!(
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PRESENT
) )

5879 
v
 +ğ1UL << 
L2_PAGETABLE_SHIFT
;

5880 
v
 &ğ~((1UL << 
L2_PAGETABLE_SHIFT
) - 1);

5884 iàĞ
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PSE
 )

5886 iàĞ(
	`l1_bË_off£t
(
v
) == 0) &&

5887 ((
e
-
v
è>ğ(1UL << 
L2_PAGETABLE_SHIFT
)) )

5890 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_em±y
());

5891 
v
 +ğ1UL << 
L2_PAGETABLE_SHIFT
;

5896 
¶1e
 = 
	`®loc_x’_·g‘abË
();

5897  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

5898 
	`l1e_wr™e
(&
¶1e
[
i
],

5899 
	`l1e_äom_pâ
(
	`l2e_g‘_pâ
(*
¶2e
è+ 
i
,

5900 
	`l2e_g‘_æags
(*
¶2e
è& ~
_PAGE_PSE
));

5901 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_äom_pâ
(
	`vœt_to_mâ
(
¶1e
),

5902 
__PAGE_HYPERVISOR
));

5908 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
è+ 
	`l1_bË_off£t
(
v
);

5909 
	`l1e_wr™e_©omic
(
¶1e
, 
	`l1e_em±y
());

5910 
v
 +ğ
PAGE_SIZE
;

5913 iàĞ(
v
 !ğ
e
è&& (
	`l1_bË_off£t
(v) != 0) )

5915 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
);

5916  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

5917 iàĞ
	`l1e_g‘_š‹
(
¶1e
[
i
]) != 0 )

5919 iàĞ
i
 =ğ
L1_PAGETABLE_ENTRIES
 )

5922 
	`l2e_wr™e_©omic
(
¶2e
, 
	`l2e_em±y
());

5923 
	`æush_¬—
(
NULL
, 
FLUSH_TLB_GLOBAL
);

5924 
	`ä“_x’_·g‘abË
(
¶1e
);

5928 #ifdeà
__x86_64__


5930 iàĞ(
v
 !ğ
e
è&& (
	`l2_bË_off£t
(vè+ 
	`l1_bË_off£t
(v) != 0) )

5932 
¶2e
 = 
	`l3e_to_l2e
(*
¶3e
);

5933  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

5934 iàĞ
	`l2e_g‘_š‹
(
¶2e
[
i
]) != 0 )

5936 iàĞ
i
 =ğ
L2_PAGETABLE_ENTRIES
 )

5939 
	`l3e_wr™e_©omic
(
¶3e
, 
	`l3e_em±y
());

5940 
	`æush_¬—
(
NULL
, 
FLUSH_TLB_GLOBAL
);

5941 
	`ä“_x’_·g‘abË
(
¶2e
);

5946 
	`æush_¬—
(
NULL
, 
FLUSH_TLB_GLOBAL
);

5947 
	}
}

5949 
	$__£t_fixm­
(

5950 
fixed_add»s£s
 
idx
, 
mâ
, 
æags
)

5952 
	`BUG_ON
(
idx
 >ğ
__’d_of_fixed_add»s£s
);

5953 
	`m­_·ges_to_x’
(
	`fix_to_vœt
(
idx
), 
mâ
, 1, 
æags
);

5954 
	}
}

5956 #ifdeà
MEMORY_GUARD


5958 
	$memgu¬d_š™
()

5960 
¡¬t
 = 
	`max_t
(, 
x’_phys_¡¬t
, 1UL << 20);

5961 #ifdeà
__i386__


5962 
	`m­_·ges_to_x’
(

5963 ()
	`__va
(
¡¬t
),

5964 
¡¬t
 >> 
PAGE_SHIFT
,

5965 (
x’h—p_phys_’d
 - 
¡¬t
è>> 
PAGE_SHIFT
,

5966 
__PAGE_HYPERVISOR
|
MAP_SMALL_PAGES
);

5968 
	`m­_·ges_to_x’
(

5969 ()
	`__va
(
¡¬t
),

5970 
¡¬t
 >> 
PAGE_SHIFT
,

5971 (
	`__·
(&
_’d
è+ 
PAGE_SIZE
 - 1 - 
¡¬t
è>> 
PAGE_SHIFT
,

5972 
__PAGE_HYPERVISOR
|
MAP_SMALL_PAGES
);

5973 
	`BUG_ON
(
¡¬t
 !ğ
x’_phys_¡¬t
);

5974 
	`m­_·ges_to_x’
(

5975 
XEN_VIRT_START
,

5976 
¡¬t
 >> 
PAGE_SHIFT
,

5977 (
	`__·
(&
_’d
è+ 
PAGE_SIZE
 - 1 - 
¡¬t
è>> 
PAGE_SHIFT
,

5978 
__PAGE_HYPERVISOR
|
MAP_SMALL_PAGES
);

5980 
	}
}

5982 
	$__memgu¬d_chªge_¿nge
(*
p
, 
l
, 
gu¬d
)

5984 
_p
 = ()
p
;

5985 
_l
 = ()
l
;

5986 
æags
 = 
__PAGE_HYPERVISOR
 | 
MAP_SMALL_PAGES
;

5989 
	`ASSERT
((
_p
&~
PAGE_MASK
) == 0);

5990 
	`ASSERT
((
_l
&~
PAGE_MASK
) == 0);

5992 iàĞ
gu¬d
 )

5993 
æags
 &ğ~
_PAGE_PRESENT
;

5995 
	`m­_·ges_to_x’
(

5996 
_p
, 
	`vœt_to_maddr
(
p
è>> 
PAGE_SHIFT
, 
_l
 >> PAGE_SHIFT, 
æags
);

5997 
	}
}

5999 
	$memgu¬d_gu¬d_¿nge
(*
p
, 
l
)

6001 
	`__memgu¬d_chªge_¿nge
(
p
, 
l
, 1);

6002 
	}
}

6004 
	$memgu¬d_ungu¬d_¿nge
(*
p
, 
l
)

6006 
	`__memgu¬d_chªge_¿nge
(
p
, 
l
, 0);

6007 
	}
}

6011 
	$memgu¬d_gu¬d_¡ack
(*
p
)

6013 
	`BUILD_BUG_ON
((
PRIMARY_STACK_SIZE
 + 
PAGE_SIZE
è> 
STACK_SIZE
);

6014 
p
 = (*)((í + 
STACK_SIZE
 -

6015 
PRIMARY_STACK_SIZE
 - 
PAGE_SIZE
);

6016 
	`memgu¬d_gu¬d_¿nge
(
p
, 
PAGE_SIZE
);

6017 
	}
}

6019 
	$memgu¬d_ungu¬d_¡ack
(*
p
)

6021 
p
 = (*)((í + 
STACK_SIZE
 -

6022 
PRIMARY_STACK_SIZE
 - 
PAGE_SIZE
);

6023 
	`memgu¬d_ungu¬d_¿nge
(
p
, 
PAGE_SIZE
);

6024 
	}
}

	@mm/guest_walk.c

25 
	~<x’/ty³s.h
>

26 
	~<x’/mm.h
>

27 
	~<x’/·gšg.h
>

28 
	~<x’/domaš_·ge.h
>

29 
	~<x’/sched.h
>

30 
	~<asm/·ge.h
>

31 
	~<asm/gue¡_±.h
>

35 
ušt32_t
 
	$mªd©Üy_æags
(
vıu
 *
v
, 
ušt32_t
 
pãc
)

37 
ušt32_t
 
æags
[] = {

39  
_PAGE_PRESENT
,

40  
_PAGE_PRESENT
|
_PAGE_RW
,

41  
_PAGE_PRESENT
|
_PAGE_USER
,

42  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
,

43  
_PAGE_PRESENT
,

44  
_PAGE_PRESENT
|
_PAGE_RW
,

45  
_PAGE_PRESENT
|
_PAGE_USER
,

46  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
,

47  
_PAGE_PRESENT
|
_PAGE_NX_BIT
,

48  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_NX_BIT
,

49  
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_NX_BIT
,

50  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_NX_BIT
,

51  
_PAGE_PRESENT
|
_PAGE_NX_BIT
,

52  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_NX_BIT
,

53  
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_NX_BIT
,

54  
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_NX_BIT
,

58 iàĞ!
	`gue¡_suµÜts_nx
(
v
) )

59 
pãc
 &ğ~
PFEC_š¢_ãtch
;

62 iàĞ
	`is_hvm_vıu
(
v
è&& 
	`uÆik–y
(!
	`hvm_wp_’abËd
(v))

63 && !(
pãc
 & 
PFEC_u£r_mode
) )

64 
pãc
 &ğ~
PFEC_wr™e_acûss
;

66  
æags
[(
pãc
 & 0x1fè>> 1] | 
_PAGE_INVALID_BITS
;

67 
	}
}

71 
ušt32_t
 
	$£t_ad_b™s
(*
gue¡_p
, *
w®k_p
, 
£t_dœty
)

73 
gue¡_š‹_t
 
Şd
, 
Ãw
;

75 
Şd
 = *(
gue¡_š‹_t
 *)
w®k_p
;

76 
Ãw
 = 
Şd
 | 
_PAGE_ACCESSED
 | (
£t_dœty
 ? 
_PAGE_DIRTY
 : 0);

77 iàĞ
Şd
 !ğ
Ãw
 )

82 *(
gue¡_š‹_t
 *)
w®k_p
 = 
Ãw
;

83 iàĞ
	`cmpxchg
(((
gue¡_š‹_t
 *)
gue¡_p
), 
Şd
, 
Ãw
) == old )

87 
	}
}

89 
šlše
 *
	$m­_domaš_gâ
(
p2m_domaš
 *
p2m
,

90 
gâ_t
 
gâ
,

91 
mâ_t
 *
mâ
,

92 
p2m_ty³_t
 *
p2mt
,

93 
ušt32_t
 *
rc
)

96 *
mâ
 = 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
	`gâ_x
(
gâ
), 
p2mt
, 0);

97 iàĞ
	`p2m_is_·gšg
(*
p2mt
) )

99 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
	`gâ_x
(
gâ
));

101 *
rc
 = 
_PAGE_PAGED
;

102  
NULL
;

104 iàĞ
	`p2m_is_sh¬ed
(*
p2mt
) )

106 *
rc
 = 
_PAGE_SHARED
;

107  
NULL
;

109 iàĞ!
	`p2m_is_¿m
(*
p2mt
) )

111 *
rc
 |ğ
_PAGE_PRESENT
;

112  
NULL
;

114 
	`ASSERT
(
	`mâ_v®id
(
	`mâ_x
(*
mâ
)));

116  
	`m­_domaš_·ge
(
	`mâ_x
(*
mâ
));

117 
	}
}

121 
ušt32_t


122 
	$gue¡_w®k_bËs
(
vıu
 *
v
, 
p2m_domaš
 *
p2m
,

123 
va
, 
w®k_t
 *
gw
,

124 
ušt32_t
 
pãc
, 
mâ_t
 
tİ_mâ
, *
tİ_m­
)

126 
domaš
 *
d
 = 
v
->domain;

127 
p2m_ty³_t
 
p2mt
;

128 
gue¡_l1e_t
 *
l1p
 = 
NULL
;

129 
gue¡_l2e_t
 *
l2p
 = 
NULL
;

130 #ià
GUEST_PAGING_LEVELS
 >= 4

131 
gue¡_l3e_t
 *
l3p
 = 
NULL
;

132 
gue¡_l4e_t
 *
l4p
;

134 
ušt32_t
 
gæags
, 
mæags
, 
iæags
, 
rc
 = 0;

135 
p£
;

137 
	`³rfc_šü
(
gue¡_w®k
);

138 
	`mem£t
(
gw
, 0, (*gw));

139 
gw
->
va
 = va;

145 
mæags
 = 
	`mªd©Üy_æags
(
v
, 
pãc
);

146 
iæags
 = (
_PAGE_NX_BIT
 | 
_PAGE_INVALID_BITS
);

148 #ià
GUEST_PAGING_LEVELS
 >= 3

149 #ià
GUEST_PAGING_LEVELS
 >= 4

152 
gw
->
l4mâ
 = 
tİ_mâ
;

153 
l4p
 = (
gue¡_l4e_t
 *è
tİ_m­
;

154 
gw
->
l4e
 = 
l4p
[
	`gue¡_l4_bË_off£t
(
va
)];

155 
gæags
 = 
	`gue¡_l4e_g‘_æags
(
gw
->
l4e
è^ 
iæags
;

156 
rc
 |ğ((
gæags
 & 
mæags
) ^ mflags);

157 iàĞ
rc
 & 
_PAGE_PRESENT
 ) 
out
;

160 
l3p
 = 
	`m­_domaš_gâ
(
p2m
,

161 
	`gue¡_l4e_g‘_gâ
(
gw
->
l4e
),

162 &
gw
->
l3mâ
,

163 &
p2mt
,

164 &
rc
);

165 if(
l3p
 =ğ
NULL
)

166 
out
;

168 
gw
->
l3e
 = 
l3p
[
	`gue¡_l3_bË_off£t
(
va
)];

169 
gæags
 = 
	`gue¡_l3e_g‘_æags
(
gw
->
l3e
è^ 
iæags
;

170 
rc
 |ğ((
gæags
 & 
mæags
) ^ mflags);

171 iàĞ
rc
 & 
_PAGE_PRESENT
 )

172 
out
;

177 
gw
->
l3e
 = ((
gue¡_l3e_t
 *è
tİ_m­
)[
	`gue¡_l3_bË_off£t
(
va
)];

178 iàĞ!(
	`gue¡_l3e_g‘_æags
(
gw
->
l3e
è& 
_PAGE_PRESENT
) )

180 
rc
 |ğ
_PAGE_PRESENT
;

181 
out
;

187 
l2p
 = 
	`m­_domaš_gâ
(
p2m
,

188 
	`gue¡_l3e_g‘_gâ
(
gw
->
l3e
),

189 &
gw
->
l2mâ
,

190 &
p2mt
,

191 &
rc
);

192 if(
l2p
 =ğ
NULL
)

193 
out
;

195 
gw
->
l2e
 = 
l2p
[
	`gue¡_l2_bË_off£t
(
va
)];

200 
gw
->
l2mâ
 = 
tİ_mâ
;

201 
l2p
 = (
gue¡_l2e_t
 *è
tİ_m­
;

202 
gw
->
l2e
 = 
l2p
[
	`gue¡_l2_bË_off£t
(
va
)];

206 
gæags
 = 
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è^ 
iæags
;

207 
rc
 |ğ((
gæags
 & 
mæags
) ^ mflags);

208 iàĞ
rc
 & 
_PAGE_PRESENT
 )

209 
out
;

211 
p£
 = (
	`gue¡_suµÜts_su³½ages
(
v
) &&

212 (
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
));

214 iàĞ
p£
 )

220 
gâ_t
 
¡¬t
 = 
	`gue¡_l2e_g‘_gâ
(
gw
->
l2e
);

223 
æags
 = (
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_RW
|

224 
_PAGE_ACCESSED
|
_PAGE_DIRTY
);

228 
æags
 |ğ(
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
)

229 & (
_PAGE_PAT
|
_PAGE_PWT
|
_PAGE_PCD
));

230 iàĞ!(
	`gâ_x
(
¡¬t
) & 1) )

232 
æags
 &ğ~
_PAGE_PAT
;

234 
	#GUEST_L2_GFN_ALIGN
 (1 << (
GUEST_L2_PAGETABLE_SHIFT
 - \

235 
GUEST_L1_PAGETABLE_SHIFT
))

	)

236 iàĞ
	`gâ_x
(
¡¬t
è& (
GUEST_L2_GFN_ALIGN
 - 1) & ~0x1 )

238 #ià
GUEST_PAGING_LEVELS
 == 2

249 
rc
 |ğ
_PAGE_INVALID_BITS
;

254 
¡¬t
 = 
	`_gâ
((
	`gâ_x
(¡¬tè& ~(
GUEST_L2_GFN_ALIGN
 - 1)) +

255 
	`gue¡_l1_bË_off£t
(
va
));

256 
gw
->
l1e
 = 
	`gue¡_l1e_äom_gâ
(
¡¬t
, 
æags
);

257 
gw
->
l1mâ
 = 
	`_mâ
(
INVALID_MFN
);

262 
l1p
 = 
	`m­_domaš_gâ
(
p2m
,

263 
	`gue¡_l2e_g‘_gâ
(
gw
->
l2e
),

264 &
gw
->
l1mâ
,

265 &
p2mt
,

266 &
rc
);

267 if(
l1p
 =ğ
NULL
)

268 
out
;

269 
gw
->
l1e
 = 
l1p
[
	`gue¡_l1_bË_off£t
(
va
)];

270 
gæags
 = 
	`gue¡_l1e_g‘_æags
(
gw
->
l1e
è^ 
iæags
;

271 
rc
 |ğ((
gæags
 & 
mæags
) ^ mflags);

278 iàĞ
rc
 == 0 )

280 #ià
GUEST_PAGING_LEVELS
 == 4

281 iàĞ
	`£t_ad_b™s
(
l4p
 + 
	`gue¡_l4_bË_off£t
(
va
), &
gw
->
l4e
, 0) )

282 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
gw
->
l4mâ
));

283 iàĞ
	`£t_ad_b™s
(
l3p
 + 
	`gue¡_l3_bË_off£t
(
va
), &
gw
->
l3e
, 0) )

284 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
gw
->
l3mâ
));

286 iàĞ
	`£t_ad_b™s
(
l2p
 + 
	`gue¡_l2_bË_off£t
(
va
), &
gw
->
l2e
,

287 (
p£
 && (
pãc
 & 
PFEC_wr™e_acûss
))) )

288 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
gw
->
l2mâ
));

289 iàĞ!
p£
 )

291 iàĞ
	`£t_ad_b™s
(
l1p
 + 
	`gue¡_l1_bË_off£t
(
va
), &
gw
->
l1e
,

292 (
pãc
 & 
PFEC_wr™e_acûss
)) )

293 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
gw
->
l1mâ
));

297 
out
:

298 #ià
GUEST_PAGING_LEVELS
 == 4

299 iàĞ
l3p
 ) 
	`unm­_domaš_·ge
(l3p);

301 #ià
GUEST_PAGING_LEVELS
 >= 3

302 iàĞ
l2p
 ) 
	`unm­_domaš_·ge
(l2p);

304 iàĞ
l1p
 ) 
	`unm­_domaš_·ge
(l1p);

306  
rc
;

307 
	}
}

	@mm/hap/guest_walk.c

23 
	~<x’/domaš_·ge.h
>

24 
	~<x’/·gšg.h
>

25 
	~<x’/cÚfig.h
>

26 
	~<x’/sched.h
>

27 
	~"´iv©e.h
"

29 
	#_h­_gva_to_gâ
(
Ëv–s
è
h­_gva_to_gâ_
##Ëv–s##
_Ëv–s


	)

30 
	#h­_gva_to_gâ
(
Ëv–s
è
	`_h­_gva_to_gâ
Öev–s)

	)

32 #ià
GUEST_PAGING_LEVELS
 <ğ
CONFIG_PAGING_LEVELS


34 
	~<asm/gue¡_±.h
>

35 
	~<asm/p2m.h
>

37 
	$h­_gva_to_gâ
(
GUEST_PAGING_LEVELS
)(

38 
vıu
 *
v
, 
gva
, 
ušt32_t
 *
pãc
)

40 
ü3
;

41 
ušt32_t
 
missšg
;

42 
mâ_t
 
tİ_mâ
;

43 *
tİ_m­
;

44 
p2m_ty³_t
 
p2mt
;

45 
w®k_t
 
gw
;

46 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

49 
ü3
 = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

50 
tİ_mâ
 = 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
ü3
 >> 
PAGE_SHIFT
, &
p2mt
, 0);

51 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

53 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
ü3
 >> 
PAGE_SHIFT
);

55 
pãc
[0] = 
PFEC_·ge_·ged
;

56  
INVALID_GFN
;

58 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

60 
pãc
[0] = 
PFEC_·ge_sh¬ed
;

61  
INVALID_GFN
;

63 iàĞ!
	`p2m_is_¿m
(
p2mt
) )

65 
pãc
[0] &ğ~
PFEC_·ge_´e£Á
;

66  
INVALID_GFN
;

70 
	`ASSERT
(
	`mâ_v®id
(
	`mâ_x
(
tİ_mâ
)));

71 
tİ_m­
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
tİ_mâ
));

72 #ià
GUEST_PAGING_LEVELS
 == 3

73 
tİ_m­
 +ğ(
ü3
 & ~(
PAGE_MASK
 | 31));

75 
missšg
 = 
	`gue¡_w®k_bËs
(
v
, 
p2m
, 
gva
, &
gw
, 
pãc
[0], 
tİ_mâ
, 
tİ_m­
);

76 
	`unm­_domaš_·ge
(
tİ_m­
);

79 iàĞ
missšg
 == 0 )

81 
gâ_t
 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(
gw
.
l1e
);

82 
	`gâ_to_mâ_unsh¬e
(
p2m
, 
	`gâ_x
(
gâ
), &
p2mt
, 0);

83 iàĞ
	`p2m_is_·gšg
(
p2mt
) )

85 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m
, 
	`gâ_x
(
gâ
));

87 
pãc
[0] = 
PFEC_·ge_·ged
;

88  
INVALID_GFN
;

90 iàĞ
	`p2m_is_sh¬ed
(
p2mt
) )

92 
pãc
[0] = 
PFEC_·ge_sh¬ed
;

93  
INVALID_GFN
;

96  
	`gâ_x
(
gâ
);

99 iàĞ
missšg
 & 
_PAGE_PRESENT
 )

100 
pãc
[0] &ğ~
PFEC_·ge_´e£Á
;

102 iàĞ
missšg
 & 
_PAGE_INVALID_BITS
 )

103 
pãc
[0] |ğ
PFEC_»£rved_b™
;

105 iàĞ
missšg
 & 
_PAGE_PAGED
 )

106 
pãc
[0] = 
PFEC_·ge_·ged
;

108 iàĞ
missšg
 & 
_PAGE_SHARED
 )

109 
pãc
[0] = 
PFEC_·ge_sh¬ed
;

111  
INVALID_GFN
;

112 
	}
}

116 
	$h­_gva_to_gâ
(
GUEST_PAGING_LEVELS
)(

117 
vıu
 *
v
, 
gva
, 
ušt32_t
 *
pãc
)

119 
	`gd´štk
(
XENLOG_ERR
,

121 
	`domaš_üash
(
v
->
domaš
);

122  
INVALID_GFN
;

123 
	}
}

	@mm/hap/hap.c

23 
	~<x’/cÚfig.h
>

24 
	~<x’/ty³s.h
>

25 
	~<x’/mm.h
>

26 
	~<x’/Œaû.h
>

27 
	~<x’/sched.h
>

28 
	~<x’/³rfc.h
>

29 
	~<x’/œq.h
>

30 
	~<x’/domaš_·ge.h
>

31 
	~<x’/gue¡_acûss.h
>

32 
	~<x’/keyhªdËr.h
>

33 
	~<asm/ev’t.h
>

34 
	~<asm/·ge.h
>

35 
	~<asm/cu¼’t.h
>

36 
	~<asm/æushb.h
>

37 
	~<asm/sh¬ed.h
>

38 
	~<asm/h­.h
>

39 
	~<asm/·gšg.h
>

40 
	~<asm/p2m.h
>

41 
	~<asm/domaš.h
>

42 
	~<x’/numa.h
>

44 
	~"´iv©e.h
"

47 #undeà
mâ_to_·ge


48 
	#mâ_to_·ge
(
_m
è
	`__mâ_to_·ge
(
	`mâ_x
(_m))

	)

49 #undeà
mâ_v®id


50 
	#mâ_v®id
(
_mâ
è
	`__mâ_v®id
(
	`mâ_x
(_mâ))

	)

51 #undeà
·ge_to_mâ


52 
	#·ge_to_mâ
(
_pg
è
	`_mâ
(
	`__·ge_to_mâ
(_pg))

	)

58 
	$h­_’abË_v¿m_Œackšg
(
domaš
 *
d
)

60 
i
;

61 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

63 iàĞ!
dœty_v¿m
 )

64  -
EINVAL
;

67 
	`h­_lock
(
d
);

68 
d
->
¬ch
.
·gšg
.
mode
 |ğ
PG_log_dœty
;

69 
	`h­_uÆock
(
d
);

72 
i
 = 
dœty_v¿m
->
begš_pâ
; i < dœty_v¿m->
’d_pâ
; i++)

73 
	`p2m_chªge_ty³
(
	`p2m_g‘_ho¡p2m
(
d
), 
i
, 
p2m_¿m_rw
, 
p2m_¿m_logdœty
);

75 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

77 
	}
}

79 
	$h­_di§bË_v¿m_Œackšg
(
domaš
 *
d
)

81 
i
;

82 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

84 iàĞ!
dœty_v¿m
 )

85  -
EINVAL
;

87 
	`h­_lock
(
d
);

88 
d
->
¬ch
.
·gšg
.
mode
 &ğ~
PG_log_dœty
;

89 
	`h­_uÆock
(
d
);

92 
i
 = 
dœty_v¿m
->
begš_pâ
; i < dœty_v¿m->
’d_pâ
; i++)

93 
	`p2m_chªge_ty³
(
	`p2m_g‘_ho¡p2m
(
d
), 
i
, 
p2m_¿m_logdœty
, 
p2m_¿m_rw
);

95 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

97 
	}
}

99 
	$h­_ş—n_v¿m_Œackšg
(
domaš
 *
d
)

101 
i
;

102 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

104 iàĞ!
dœty_v¿m
 )

108 
i
 = 
dœty_v¿m
->
begš_pâ
; i < dœty_v¿m->
’d_pâ
; i++)

109 
	`p2m_chªge_ty³
(
	`p2m_g‘_ho¡p2m
(
d
), 
i
, 
p2m_¿m_rw
, 
p2m_¿m_logdœty
);

111 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

112 
	}
}

114 
	$h­_v¿m_Œackšg_š™
(
domaš
 *
d
)

116 
	`·gšg_log_dœty_š™
(
d
, 
h­_’abË_v¿m_Œackšg
,

117 
h­_di§bË_v¿m_Œackšg
,

118 
h­_ş—n_v¿m_Œackšg
);

119 
	}
}

121 
h­_Œack_dœty_v¿m
(
domaš
 *
d
,

122 
begš_pâ
,

123 
Ä
,

124 
	$XEN_GUEST_HANDLE_64
(
ušt8
è
dœty_b™m­
)

126 
rc
 = 0;

127 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

129 iàĞ
Ä
 )

131 iàĞ
	`·gšg_mode_log_dœty
(
d
è&& 
dœty_v¿m
 )

133 iàĞ
begš_pâ
 !ğ
dœty_v¿m
->begin_pfn ||

134 
begš_pâ
 + 
Ä
 !ğ
dœty_v¿m
->
’d_pâ
 )

136 
	`·gšg_log_dœty_di§bË
(
d
);

137 
dœty_v¿m
->
begš_pâ
 = begin_pfn;

138 
dœty_v¿m
->
’d_pâ
 = 
begš_pâ
 + 
Ä
;

139 
rc
 = 
	`·gšg_log_dœty_’abË
(
d
);

140 ià(
rc
 != 0)

141 
·¿m_ç
;

144 iàĞ!
	`·gšg_mode_log_dœty
(
d
è&& !
dœty_v¿m
 )

146 
rc
 -
ENOMEM
;

147 iàĞ(
dœty_v¿m
 = 
	`xm®loc
(
sh_dœty_v¿m
)è=ğ
NULL
 )

148 
·¿m_ç
;

150 
dœty_v¿m
->
begš_pâ
 = begin_pfn;

151 
dœty_v¿m
->
’d_pâ
 = 
begš_pâ
 + 
Ä
;

152 
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
 = dirty_vram;

153 
	`h­_v¿m_Œackšg_š™
(
d
);

154 
rc
 = 
	`·gšg_log_dœty_’abË
(
d
);

155 ià(
rc
 != 0)

156 
·¿m_ç
;

160 iàĞ!
	`·gšg_mode_log_dœty
(
d
è&& 
dœty_v¿m
 )

161 
rc
 = -
EINVAL
;

163 
rc
 = -
ENODATA
;

164 
·¿m_ç
;

167 
rc
 = 
	`·gšg_log_dœty_¿nge
(
d
, 
begš_pâ
, 
Ä
, 
dœty_b™m­
);

171 iàĞ
	`·gšg_mode_log_dœty
(
d
è&& 
dœty_v¿m
 ) {

172 
rc
 = 
	`·gšg_log_dœty_di§bË
(
d
);

173 
	`xä“
(
dœty_v¿m
);

174 
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dœty_v¿m = 
NULL
;

176 
rc
 = 0;

179  
rc
;

181 
·¿m_ç
:

182 iàĞ
dœty_v¿m
 )

184 
	`xä“
(
dœty_v¿m
);

185 
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dœty_v¿m = 
NULL
;

187  
rc
;

188 
	}
}

195 
	$h­_’abË_log_dœty
(
domaš
 *
d
)

198 
	`h­_lock
(
d
);

199 
d
->
¬ch
.
·gšg
.
mode
 |ğ
PG_log_dœty
;

200 
	`h­_uÆock
(
d
);

203 
	`p2m_chªge_’Œy_ty³_glob®
(
	`p2m_g‘_ho¡p2m
(
d
),

204 
p2m_¿m_rw
, 
p2m_¿m_logdœty
);

205 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

207 
	}
}

209 
	$h­_di§bË_log_dœty
(
domaš
 *
d
)

211 
	`h­_lock
(
d
);

212 
d
->
¬ch
.
·gšg
.
mode
 &ğ~
PG_log_dœty
;

213 
	`h­_uÆock
(
d
);

216 
	`p2m_chªge_’Œy_ty³_glob®
(
	`p2m_g‘_ho¡p2m
(
d
),

217 
p2m_¿m_logdœty
, 
p2m_¿m_rw
);

219 
	}
}

221 
	$h­_ş—n_dœty_b™m­
(
domaš
 *
d
)

224 
	`p2m_chªge_’Œy_ty³_glob®
(
	`p2m_g‘_ho¡p2m
(
d
),

225 
p2m_¿m_rw
, 
p2m_¿m_logdœty
);

226 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

227 
	}
}

229 
	$h­_logdœty_š™
(
domaš
 *
d
)

231 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

232 iàĞ
	`·gšg_mode_log_dœty
(
d
è&& 
dœty_v¿m
 )

234 
	`·gšg_log_dœty_di§bË
(
d
);

235 
	`xä“
(
dœty_v¿m
);

236 
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dœty_v¿m = 
NULL
;

240 
	`·gšg_log_dœty_š™
(
d
, 
h­_’abË_log_dœty
,

241 
h­_di§bË_log_dœty
,

242 
h­_ş—n_dœty_b™m­
);

243 
	}
}

248 
·ge_šfo
 *
	$h­_®loc
(
domaš
 *
d
)

250 
·ge_šfo
 *
pg
 = 
NULL
;

251 *
p
;

253 
	`ASSERT
(
	`h­_locked_by_me
(
d
));

255 
pg
 = 
	`·ge_li¡_»move_h—d
(&
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
);

256 iàĞ
	`uÆik–y
(!
pg
) )

257  
NULL
;

259 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
--;

261 
p
 = 
	`__m­_domaš_·ge
(
pg
);

262 
	`ASSERT
(
p
 !ğ
NULL
);

263 
	`ş—r_·ge
(
p
);

264 
	`h­_unm­_domaš_·ge
(
p
);

266  
pg
;

267 
	}
}

269 
	$h­_ä“
(
domaš
 *
d
, 
mâ_t
 
mâ
)

271 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
mâ
);

273 
	`ASSERT
(
	`h­_locked_by_me
(
d
));

275 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
++;

276 
	`·ge_li¡_add_
(
pg
, &
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
);

277 
	}
}

279 
·ge_šfo
 *
	$h­_®loc_p2m_·ge
(
domaš
 *
d
)

281 
·ge_šfo
 *
pg
;

282 
do_lockšg
;

286 
do_lockšg
 = !
	`h­_locked_by_me
(
d
);

287 iàĞ
do_lockšg
 )

288 
	`h­_lock
(
d
);

289 
pg
 = 
	`h­_®loc
(
d
);

291 #ià
CONFIG_PAGING_LEVELS
 == 3

296 iàĞ
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
 == 0

297 && 
	`mâ_x
(
	`·ge_to_mâ
(
pg
)è>ğ(1UL << (32 - 
PAGE_SHIFT
)) )

299 
	`ä“_domh—p_·ge
(
pg
);

300 
pg
 = 
	`®loc_domh—p_·ge
(

301 
NULL
, 
	`MEMF_b™s
(32è| 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

302 iàĞ
	`lik–y
(
pg
 !ğ
NULL
) )

304 *
p
 = 
	`__m­_domaš_·ge
(
pg
);

305 
	`ş—r_·ge
(
p
);

306 
	`h­_unm­_domaš_·ge
(
p
);

311 iàĞ
	`lik–y
(
pg
 !ğ
NULL
) )

313 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
--;

314 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
++;

315 
	`·ge_£t_owÃr
(
pg
, 
d
);

316 
pg
->
couÁ_šfo
 |= 1;

319 iàĞ
do_lockšg
 )

320 
	`h­_uÆock
(
d
);

321  
pg
;

322 
	}
}

324 
	$h­_ä“_p2m_·ge
(
domaš
 *
d
, 
·ge_šfo
 *
pg
)

326 
do_lockšg
;

330 
do_lockšg
 = !
	`h­_locked_by_me
(
d
);

331 iàĞ
do_lockšg
 )

332 
	`h­_lock
(
d
);

334 
	`ASSERT
(
	`·ge_g‘_owÃr
(
pg
è=ğ
d
);

336 iàĞ(
pg
->
couÁ_šfo
 & 
PGC_couÁ_mask
) != 1 ) {

337 
	`HAP_ERROR
("Odd…2m…ag%°couÁ c=%#lx=%"
PRty³_šfo
"\n",

338 
pg
,…g->
couÁ_šfo
,…g->
u
.
šu£
.
ty³_šfo
);

339 
	`WARN
();

341 
pg
->
couÁ_šfo
 &ğ~
PGC_couÁ_mask
;

344 
	`·ge_£t_owÃr
(
pg
, 
NULL
);

345 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
--;

346 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
++;

347 
	`h­_ä“
(
d
, 
	`·ge_to_mâ
(
pg
));

348 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
 >= 0);

350 iàĞ
do_lockšg
 )

351 
	`h­_uÆock
(
d
);

352 
	}
}

356 
	$h­_g‘_®loÿtiÚ
(
domaš
 *
d
)

358 
pg
 = 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges


359 + 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
;

361  ((
pg
 >> (20 - 
PAGE_SHIFT
))

362 + ((
pg
 & ((1 << (20 - 
PAGE_SHIFT
)) - 1)) ? 1 : 0));

363 
	}
}

368 
	$h­_£t_®loÿtiÚ
(
domaš
 *
d
, 
·ges
, *
´“m±ed
)

370 
·ge_šfo
 *
pg
;

372 
	`ASSERT
(
	`h­_locked_by_me
(
d
));

374 iàĞ
·ges
 < 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
 )

375 
·ges
 = 0;

377 
·ges
 -ğ
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
;

379  
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 !ğ
·ges
 )

381 iàĞ
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 < 
·ges
 )

384 
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

385 iàĞ
pg
 =ğ
NULL
 )

387 
	`HAP_PRINTK
("failedo‡llocate hap…ages.\n");

388  -
ENOMEM
;

390 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
++;

391 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
++;

392 
	`·ge_li¡_add_
(
pg
, &
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
);

394 iàĞ
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 > 
·ges
 )

397 iàĞ
	`·ge_li¡_em±y
(&
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
) )

399 
	`HAP_PRINTK
("failedo freeƒnough hap…ages.\n");

400  -
ENOMEM
;

402 
pg
 = 
	`·ge_li¡_»move_h—d
(&
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
);

403 
	`ASSERT
(
pg
);

404 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
--;

405 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
--;

406 
	`ä“_domh—p_·ge
(
pg
);

410 iàĞ
´“m±ed
 && 
	`hy³rÿÎ_´“m±_check
() )

412 *
´“m±ed
 = 1;

418 
	}
}

420 #ià
CONFIG_PAGING_LEVELS
 == 4

421 
	$h­_š¡®l_x’_’Œ›s_š_l4
(
vıu
 *
v
, 
mâ_t
 
l4mâ
)

423 
domaš
 *
d
 = 
v
->domain;

424 
l4_pg’Œy_t
 *
l4e
;

426 
l4e
 = 
	`h­_m­_domaš_·ge
(
l4mâ
);

427 
	`ASSERT
(
l4e
 !ğ
NULL
);

430 
	`memıy
(&
l4e
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

431 &
idË_pg_bË
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

432 
ROOT_PAGETABLE_XEN_SLOTS
 * (
l4_pg’Œy_t
));

435 
l4e
[
	`l4_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

436 
	`l4e_äom_pâ
(
	`mâ_x
(
	`·ge_to_mâ
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
))),

437 
__PAGE_HYPERVISOR
);

440 
l4e
[
	`l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

441 
	`l4e_äom_pâ
(
	`mâ_x
(
l4mâ
), 
__PAGE_HYPERVISOR
);

444 
l4e
[
	`l4_bË_off£t
(
RO_MPT_VIRT_START
)] =

445 
	`l4e_äom_pâ
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
d
)))),

446 
__PAGE_HYPERVISOR
);

448 
	`h­_unm­_domaš_·ge
(
l4e
);

449 
	}
}

452 #ià
CONFIG_PAGING_LEVELS
 == 3

453 
	$h­_š¡®l_x’_’Œ›s_š_l2h
(
vıu
 *
v
, 
mâ_t
 
l2hmâ
)

455 
domaš
 *
d
 = 
v
->domain;

456 
p2m_domaš
 *
ho¡p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

457 
l2_pg’Œy_t
 *
l2e
;

458 
l3_pg’Œy_t
 *
p2m
;

459 
i
;

461 
l2e
 = 
	`h­_m­_domaš_·ge
(
l2hmâ
);

462 
	`ASSERT
(
l2e
 !ğ
NULL
);

465 
	`memıy
(&
l2e
[
L2_PAGETABLE_FIRST_XEN_SLOT
 & (
L2_PAGETABLE_ENTRIES
-1)],

466 &
idË_pg_bË_l2
[
L2_PAGETABLE_FIRST_XEN_SLOT
],

467 
L2_PAGETABLE_XEN_SLOTS
 * (
l2_pg’Œy_t
));

470  
i
 = 0; i < 
PDPT_L2_ENTRIES
; i++ )

471 
l2e
[
	`l2_bË_off£t
(
PERDOMAIN_VIRT_START
è+ 
i
] =

472 
	`l2e_äom_pâ
(

473 
	`mâ_x
(
	`·ge_to_mâ
(
	`³rdomaš_±_·ge
(
d
, 
i
))),

474 
__PAGE_HYPERVISOR
);

477  
i
 = 0; i < 4; i++ )

478 
l2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
] =

479 
	`l2e_em±y
();

482 
	`ASSERT
(
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
ho¡p2m
)) != 0);

483 
p2m
 = 
	`h­_m­_domaš_·ge
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
ho¡p2m
)));

484  
i
 = 0; i < 
MACHPHYS_MBYTES
>>1; i++ )

486 
l2e
[
	`l2_bË_off£t
(
RO_MPT_VIRT_START
è+ 
i
] =

487 (
	`l3e_g‘_æags
(
p2m
[
i
]è& 
_PAGE_PRESENT
)

488 ? 
	`l2e_äom_pâ
(
	`mâ_x
(
	`_mâ
(
	`l3e_g‘_pâ
(
p2m
[
i
]))),

489 
__PAGE_HYPERVISOR
)

490 : 
	`l2e_em±y
();

492 
	`h­_unm­_domaš_·ge
(
p2m
);

493 
	`h­_unm­_domaš_·ge
(
l2e
);

494 
	}
}

497 
mâ_t
 
	$h­_make_mÚ™Ü_bË
(
vıu
 *
v
)

499 
domaš
 *
d
 = 
v
->domain;

500 
·ge_šfo
 *
pg
;

502 
	`ASSERT
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
mÚ™Ü_bË
) == 0);

504 #ià
CONFIG_PAGING_LEVELS
 == 4

506 
mâ_t
 
m4mâ
;

507 iàĞ(
pg
 = 
	`h­_®loc
(
d
)è=ğ
NULL
 )

508 
oom
;

509 
m4mâ
 = 
	`·ge_to_mâ
(
pg
);

510 
	`h­_š¡®l_x’_’Œ›s_š_l4
(
v
, 
m4mâ
);

511  
m4mâ
;

513 #–ià
CONFIG_PAGING_LEVELS
 == 3

515 
mâ_t
 
m3mâ
, 
m2mâ
;

516 
l3_pg’Œy_t
 *
l3e
;

517 
l2_pg’Œy_t
 *
l2e
;

518 
i
;

520 iàĞ(
pg
 = 
	`h­_®loc
(
d
)è=ğ
NULL
 )

521 
oom
;

522 
m3mâ
 = 
	`·ge_to_mâ
(
pg
);

527 iàĞ(
pg
 = 
	`h­_®loc
(
d
)è=ğ
NULL
 )

528 
oom
;

529 
m2mâ
 = 
	`·ge_to_mâ
(
pg
);

530 
l3e
 = 
	`h­_m­_domaš_·ge
(
m3mâ
);

531 
l3e
[3] = 
	`l3e_äom_pâ
(
	`mâ_x
(
m2mâ
), 
_PAGE_PRESENT
);

532 
	`h­_š¡®l_x’_’Œ›s_š_l2h
(
v
, 
m2mâ
);

534 
l2e
 = 
	`h­_m­_domaš_·ge
(
m2mâ
);

535  
i
 = 0; i < 
L3_PAGETABLE_ENTRIES
; i++ )

536 
l2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
] =

537 (
	`l3e_g‘_æags
(
l3e
[
i
]è& 
_PAGE_PRESENT
)

538 ? 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(
l3e
[
i
]), 
__PAGE_HYPERVISOR
)

539 : 
	`l2e_em±y
();

540 
	`h­_unm­_domaš_·ge
(
l2e
);

541 
	`h­_unm­_domaš_·ge
(
l3e
);

543 
	`HAP_PRINTK
("Ãw mÚ™ÜabË: %#lx\n", 
	`mâ_x
(
m3mâ
));

544  
m3mâ
;

548 
oom
:

549 
	`HAP_ERROR
("out of memory building monitor…agetable\n");

550 
	`domaš_üash
(
d
);

551  
	`_mâ
(
INVALID_MFN
);

552 
	}
}

554 
	$h­_de¡roy_mÚ™Ü_bË
(
vıu
* 
v
, 
mâ_t
 
mmâ
)

556 
domaš
 *
d
 = 
v
->domain;

558 #ià
CONFIG_PAGING_LEVELS
 == 3

561 
l3_pg’Œy_t
 *
l3e
 = 
	`h­_m­_domaš_·ge
(
mmâ
);

562 
	`ASSERT
(
	`l3e_g‘_æags
(
l3e
[3]è& 
_PAGE_PRESENT
);

563 
	`h­_ä“
(
d
, 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[3])));

564 
	`h­_unm­_domaš_·ge
(
l3e
);

569 
	`h­_ä“
(
d
, 
mmâ
);

570 
	}
}

575 
	$h­_domaš_š™
(
domaš
 *
d
)

577 
	`h­_lock_š™
(
d
);

578 
	`INIT_PAGE_LIST_HEAD
(&
d
->
¬ch
.
·gšg
.
h­
.
ä“li¡
);

579 
	}
}

582 
	$h­_’abË
(
domaš
 *
d
, 
u32
 
mode
)

584 
Şd_·ges
;

585 
rv
 = 0;

587 
	`domaš_·u£
(
d
);

590 iàĞ(
d
 =ğ
cu¼’t
->
domaš
) )

592 
rv
 = -
EINVAL
;

593 
out
;

596 
Şd_·ges
 = 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
;

597 iàĞ
Şd_·ges
 == 0 )

599 
r
;

600 
	`h­_lock
(
d
);

601 
r
 = 
	`h­_£t_®loÿtiÚ
(
d
, 256, 
NULL
);

602 
	`h­_uÆock
(
d
);

603 iàĞ
r
 != 0 )

605 
	`h­_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

606 
rv
 = -
ENOMEM
;

607 
out
;

612 
d
->
¬ch
.
·gšg
.
®loc_·ge
 = 
h­_®loc_p2m_·ge
;

613 
d
->
¬ch
.
·gšg
.
ä“_·ge
 = 
h­_ä“_p2m_·ge
;

616 iàĞ
mode
 & 
PG_Œª¦©e
 )

618 
rv
 = 
	`p2m_®loc_bË
(
	`p2m_g‘_ho¡p2m
(
d
));

619 iàĞ
rv
 != 0 )

620 
out
;

624 
d
->
¬ch
.
·gšg
.
mode
 = mod| 
PG_HAP_’abË
;

626 
out
:

627 
	`domaš_uÅau£
(
d
);

628  
rv
;

629 
	}
}

631 
	$h­_fš®_‹¬down
(
domaš
 *
d
)

633 iàĞ
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 != 0 )

634 
	`h­_‹¬down
(
d
);

636 
	`p2m_‹¬down
(
	`p2m_g‘_ho¡p2m
(
d
));

638 
	`h­_lock
(
d
);

639 
	`h­_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

640 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
 == 0);

641 
	`h­_uÆock
(
d
);

642 
	}
}

644 
	$h­_‹¬down
(
domaš
 *
d
)

646 
vıu
 *
v
;

647 
mâ_t
 
mâ
;

649 
	`ASSERT
(
d
->
is_dyšg
);

650 
	`ASSERT
(
d
 !ğ
cu¼’t
->
domaš
);

652 iàĞ!
	`h­_locked_by_me
(
d
) )

653 
	`h­_lock
(
d
);

655 iàĞ
	`·gšg_mode_’abËd
(
d
) )

658 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

660 iàĞ
v
->
¬ch
.
·gšg
.
mode
 && 
	`·gšg_mode_ex‹º®
(
d
) )

662 
mâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
);

663 iàĞ
	`mâ_v®id
(
mâ
è&& (
	`mâ_x
(mfn) != 0) )

664 
	`h­_de¡roy_mÚ™Ü_bË
(
v
, 
mâ
);

665 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_nuÎ
();

670 iàĞ
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 != 0 )

672 
	`HAP_PRINTK
("teardown of domain %u starts."

674 
d
->
domaš_id
,

675 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
,

676 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
,

677 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
);

678 
	`h­_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

679 
	`HAP_PRINTK
("teardown done."

681 
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
,

682 
d
->
¬ch
.
·gšg
.
h­
.
ä“_·ges
,

683 
d
->
¬ch
.
·gšg
.
h­
.
p2m_·ges
);

684 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
h­
.
tÙ®_·ges
 == 0);

687 
d
->
¬ch
.
·gšg
.
mode
 &ğ~
PG_log_dœty
;

689 
	`h­_uÆock
(
d
);

690 
	}
}

692 
h­_domùl
(
domaš
 *
d
, 
x’_domùl_shadow_İ_t
 *
sc
,

693 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

695 
rc
, 
´“m±ed
 = 0;

697  
sc
->
İ
 )

699 
XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION
:

700 
	`h­_lock
(
d
);

701 
rc
 = 
	`h­_£t_®loÿtiÚ
(
d
, 
sc
->
mb
 << (20 - 
PAGE_SHIFT
), &
´“m±ed
);

702 
	`h­_uÆock
(
d
);

703 iàĞ
´“m±ed
 )

705 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(
__HYPERVISOR_domùl
, "h",

706 
u_domùl
);

709 
sc
->
mb
 = 
	`h­_g‘_®loÿtiÚ
(
d
);

710  
rc
;

711 
XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION
:

712 
sc
->
mb
 = 
	`h­_g‘_®loÿtiÚ
(
d
);

715 
	`HAP_ERROR
("Bad h­ domùÈİ %u\n", 
sc
->
İ
);

716  -
EINVAL
;

718 
	}
}

720 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_»®_mode
;

721 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_´Ùeùed_mode
;

722 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_·e_mode
;

723 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_lÚg_mode
;

725 
	$h­_vıu_š™
(
vıu
 *
v
)

727 
v
->
¬ch
.
·gšg
.
mode
 = &
h­_·gšg_»®_mode
;

728 
	}
}

737 
	$h­_·ge_çuÉ
(
vıu
 *
v
, 
va
,

738 
ıu_u£r_»gs
 *
»gs
)

740 
domaš
 *
d
 = 
v
->domain;

742 
	`HAP_ERROR
("Intercepted‡ guest #PF (%u:%u) with HAPƒnabled.\n",

743 
d
->
domaš_id
, 
v
->
vıu_id
);

744 
	`domaš_üash
(
d
);

746 
	}
}

752 
	$h­_švÍg
(
vıu
 *
v
, 
va
)

754 
	`HAP_ERROR
("Intercepted‡ guest INVLPG (%u:%u) with HAPƒnabled.\n",

755 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

756 
	`domaš_üash
(
v
->
domaš
);

758 
	}
}

760 
	$h­_upd©e_ü3
(
vıu
 *
v
, 
do_lockšg
)

762 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3] = v->¬ch.hvm_vıu.
gue¡_ü
[3];

763 
	`hvm_upd©e_gue¡_ü
(
v
, 3);

764 
	}
}

766 
	$h­_upd©e_·gšg_modes
(
vıu
 *
v
)

768 
domaš
 *
d
 = 
v
->domain;

770 
	`h­_lock
(
d
);

772 
v
->
¬ch
.
·gšg
.
mode
 =

773 !
	`hvm_·gšg_’abËd
(
v
è? &
h­_·gšg_»®_mode
 :

774 
	`hvm_lÚg_mode_’abËd
(
v
è? &
h­_·gšg_lÚg_mode
 :

775 
	`hvm_·e_’abËd
(
v
è? &
h­_·gšg_·e_mode
 :

776 &
h­_·gšg_´Ùeùed_mode
;

778 iàĞ
	`·g‘abË_is_nuÎ
(
v
->
¬ch
.
mÚ™Ü_bË
) )

780 
mâ_t
 
mmâ
 = 
	`h­_make_mÚ™Ü_bË
(
v
);

781 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_äom_mâ
(
mmâ
);

782 
	`make_ü3
(
v
, 
	`mâ_x
(
mmâ
));

783 
	`hvm_upd©e_ho¡_ü3
(
v
);

787 
	`h­_upd©e_ü3
(
v
, 0);

789 
	`h­_uÆock
(
d
);

790 
	}
}

792 #ià
CONFIG_PAGING_LEVELS
 == 3

793 
	$p2m_š¡®l_’Œy_š_mÚ™Üs
(
domaš
 *
d
, 
l3_pg’Œy_t
 *
l3e
)

801 
l2_pg’Œy_t
 *
ml2e
;

802 
vıu
 *
v
;

803 
šdex
;

805 
šdex
 = (()
l3e
 & ~
PAGE_MASK
è/ (
l3_pg’Œy_t
);

806 
	`ASSERT
(
šdex
 < 
MACHPHYS_MBYTES
>>1);

808 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

810 iàĞ
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
mÚ™Ü_bË
) == 0 )

813 
	`ASSERT
(
	`·gšg_mode_ex‹º®
(
v
->
domaš
));

815 iàĞ
v
 =ğ
cu¼’t
 )

816 
ml2e
 = 
__lš—r_l2_bË
 + 
	`l2_lš—r_off£t
(
RO_MPT_VIRT_START
);

818 
l3_pg’Œy_t
 *
ml3e
;

819 
ml3e
 = 
	`h­_m­_domaš_·ge
(

820 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
));

821 
	`ASSERT
(
	`l3e_g‘_æags
(
ml3e
[3]è& 
_PAGE_PRESENT
);

822 
ml2e
 = 
	`h­_m­_domaš_·ge
(
	`_mâ
(
	`l3e_g‘_pâ
(
ml3e
[3])));

823 
ml2e
 +ğ
	`l2_bË_off£t
(
RO_MPT_VIRT_START
);

824 
	`h­_unm­_domaš_·ge
(
ml3e
);

826 
ml2e
[
šdex
] = 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(*
l3e
), 
__PAGE_HYPERVISOR
);

827 iàĞ
v
 !ğ
cu¼’t
 )

828 
	`h­_unm­_domaš_·ge
(
ml2e
);

830 
	}
}

834 
	$h­_wr™e_p2m_’Œy
(
vıu
 *
v
, 
gâ
, 
l1_pg’Œy_t
 *
p
,

835 
mâ_t
 
bË_mâ
, 
l1_pg’Œy_t
 
Ãw
, 
Ëv–
)

837 
ušt32_t
 
Şd_æags
;

839 
	`h­_lock
(
v
->
domaš
);

841 
Şd_æags
 = 
	`l1e_g‘_æags
(*
p
);

842 
	`§ã_wr™e_±e
(
p
, 
Ãw
);

843 iàĞ(
Şd_æags
 & 
_PAGE_PRESENT
)

844 && (
Ëv–
 =ğ1 || (Ëv– =ğ2 && (
Şd_æags
 & 
_PAGE_PSE
))) )

845 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

847 #ià
CONFIG_PAGING_LEVELS
 == 3

849 iàĞ
Ëv–
 == 3 )

852 
	`p2m_š¡®l_’Œy_š_mÚ™Üs
(
v
->
domaš
, (
l3_pg’Œy_t
 *)
p
);

855 
	`h­_uÆock
(
v
->
domaš
);

856 
	}
}

858 
	$h­_gva_to_gâ_»®_mode
(

859 
vıu
 *
v
, 
gva
, 
ušt32_t
 *
pãc
)

861  ((
·ddr_t
)
gva
 >> 
PAGE_SHIFT
);

862 
	}
}

865 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_»®_mode
 = {

866 .
·ge_çuÉ
 = 
h­_·ge_çuÉ
,

867 .
	gšvÍg
 = 
h­_švÍg
,

868 .
	ggva_to_gâ
 = 
h­_gva_to_gâ_»®_mode
,

869 .
	gupd©e_ü3
 = 
h­_upd©e_ü3
,

870 .
	gupd©e_·gšg_modes
 = 
h­_upd©e_·gšg_modes
,

871 .
	gwr™e_p2m_’Œy
 = 
h­_wr™e_p2m_’Œy
,

872 .
	ggue¡_Ëv–s
 = 1

875 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_´Ùeùed_mode
 = {

876 .
·ge_çuÉ
 = 
h­_·ge_çuÉ
,

877 .
	gšvÍg
 = 
h­_švÍg
,

878 .
	ggva_to_gâ
 = 
h­_gva_to_gâ_2_Ëv–s
,

879 .
	gupd©e_ü3
 = 
h­_upd©e_ü3
,

880 .
	gupd©e_·gšg_modes
 = 
h­_upd©e_·gšg_modes
,

881 .
	gwr™e_p2m_’Œy
 = 
h­_wr™e_p2m_’Œy
,

882 .
	ggue¡_Ëv–s
 = 2

885 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_·e_mode
 = {

886 .
·ge_çuÉ
 = 
h­_·ge_çuÉ
,

887 .
	gšvÍg
 = 
h­_švÍg
,

888 .
	ggva_to_gâ
 = 
h­_gva_to_gâ_3_Ëv–s
,

889 .
	gupd©e_ü3
 = 
h­_upd©e_ü3
,

890 .
	gupd©e_·gšg_modes
 = 
h­_upd©e_·gšg_modes
,

891 .
	gwr™e_p2m_’Œy
 = 
h­_wr™e_p2m_’Œy
,

892 .
	ggue¡_Ëv–s
 = 3

895 cÚ¡ 
·gšg_mode
 
	gh­_·gšg_lÚg_mode
 = {

896 .
·ge_çuÉ
 = 
h­_·ge_çuÉ
,

897 .
	gšvÍg
 = 
h­_švÍg
,

898 .
	ggva_to_gâ
 = 
h­_gva_to_gâ_4_Ëv–s
,

899 .
	gupd©e_ü3
 = 
h­_upd©e_ü3
,

900 .
	gupd©e_·gšg_modes
 = 
h­_upd©e_·gšg_modes
,

901 .
	gwr™e_p2m_’Œy
 = 
h­_wr™e_p2m_’Œy
,

902 .
	ggue¡_Ëv–s
 = 4

	@mm/hap/p2m-ept.c

19 
	~<x’/cÚfig.h
>

20 
	~<x’/domaš_·ge.h
>

21 
	~<x’/sched.h
>

22 
	~<asm/cu¼’t.h
>

23 
	~<asm/·gšg.h
>

24 
	~<asm/ty³s.h
>

25 
	~<asm/domaš.h
>

26 
	~<asm/p2m.h
>

27 
	~<asm/hvm/vmx/vmx.h
>

28 
	~<asm/hvm/vmx/vmcs.h
>

29 
	~<x’/iommu.h
>

30 
	~<asm/mŒr.h
>

31 
	~<asm/hvm/ÿch—‰r.h
>

32 
	~<x’/keyhªdËr.h
>

33 
	~<x’/soáœq.h
>

35 
	#©omic_»ad_•t_’Œy
(
__³±e
) \

36 Ğ(
•t_’Œy_t
è{ .
•‹
 = 
	`©omic_»ad64
(&(
__³±e
)->•‹è} )

	)

37 
	#©omic_wr™e_•t_’Œy
(
__³±e
, 
__•‹
) \

38 
	`©omic_wr™e64
(&(
__³±e
)->
•‹
, (
__•‹
).•‹)

	)

40 
	#is_•‹_´e£Á
(
•t_’Œy
è(Ó±_’Œy)->
•‹
 & 0x7)

	)

41 
	#is_•‹_su³½age
(
•t_’Œy
è(Ó±_’Œy)->
¥
)

	)

44 
	$•t_pod_check_ªd_pİuÏ‹
(
p2m_domaš
 *
p2m
, 
gâ
,

45 
•t_’Œy_t
 *
’Œy
, 
Üd”
,

46 
p2m_qu”y_t
 
q
)

50 
do_lockšg
 = !
	`p2m_locked_by_me
(
p2m
);

51 
r
;

53 iàĞ
do_lockšg
 )

54 
	`p2m_lock
(
p2m
);

57 iàĞ
’Œy
->
§_p2mt
 !ğ
p2m_pİuÏ‹_Ú_demªd
 )

59 iàĞ
do_lockšg
 )

60 
	`p2m_uÆock
(
p2m
);

64 
r
 = 
	`p2m_pod_demªd_pİuÏ‹
(
p2m
, 
gâ
, 
Üd”
, 
q
);

66 iàĞ
do_lockšg
 )

67 
	`p2m_uÆock
(
p2m
);

69  
r
;

70 
	}
}

72 
	$•t_p2m_ty³_to_æags
(
•t_’Œy_t
 *
’Œy
, 
p2m_ty³_t
 
ty³
, 
p2m_acûss_t
 
acûss
)

75 
ty³
)

77 
p2m_šv®id
:

78 
p2m_mmio_dm
:

79 
p2m_pİuÏ‹_Ú_demªd
:

80 
p2m_¿m_·gšg_out
:

81 
p2m_¿m_·ged
:

82 
p2m_¿m_·gšg_š
:

83 
p2m_¿m_·gšg_š_¡¬t
:

85 
’Œy
->
r
 =ƒÁry->
w
 =ƒÁry->
x
 = 0;

87 
p2m_¿m_rw
:

88 
’Œy
->
r
 =ƒÁry->
w
 =ƒÁry->
x
 = 1;

90 
p2m_mmio_dœeù
:

91 
’Œy
->
r
 =ƒÁry->
x
 = 1;

92 
’Œy
->
w
 = !
	`¿nge£t_cÚšs_sšgËtÚ
(
mmio_ro_¿nges
,

93 
’Œy
->
mâ
);

95 
p2m_¿m_logdœty
:

96 
p2m_¿m_ro
:

97 
p2m_¿m_sh¬ed
:

98 
’Œy
->
r
 =ƒÁry->
x
 = 1;

99 
’Œy
->
w
 = 0;

101 
p2m_g¿Á_m­_rw
:

102 
’Œy
->
r
 =ƒÁry->
w
 = 1;

103 
’Œy
->
x
 = 0;

105 
p2m_g¿Á_m­_ro
:

106 
’Œy
->
r
 = 1;

107 
’Œy
->
w
 =ƒÁry->
x
 = 0;

113 
acûss
)

115 
p2m_acûss_n
:

116 
’Œy
->
r
 =ƒÁry->
w
 =ƒÁry->
x
 = 0;

118 
p2m_acûss_r
:

119 
’Œy
->
w
 =ƒÁry->
x
 = 0;

121 
p2m_acûss_w
:

122 
’Œy
->
r
 =ƒÁry->
x
 = 0;

124 
p2m_acûss_x
:

125 
’Œy
->
r
 =ƒÁry->
w
 = 0;

127 
p2m_acûss_rx
:

128 
p2m_acûss_rx2rw
:

129 
’Œy
->
w
 = 0;

131 
p2m_acûss_wx
:

132 
’Œy
->
r
 = 0;

134 
p2m_acûss_rw
:

135 
’Œy
->
x
 = 0;

137 
p2m_acûss_rwx
:

141 
	}
}

143 
	#GUEST_TABLE_MAP_FAILED
 0

	)

144 
	#GUEST_TABLE_NORMAL_PAGE
 1

	)

145 
	#GUEST_TABLE_SUPER_PAGE
 2

	)

146 
	#GUEST_TABLE_POD_PAGE
 3

	)

149 
	$•t_£t_middË_’Œy
(
p2m_domaš
 *
p2m
, 
•t_’Œy_t
 *
•t_’Œy
)

151 
·ge_šfo
 *
pg
;

153 
pg
 = 
	`p2m_®loc_±p
(
p2m
, 0);

154 iàĞ
pg
 =ğ
NULL
 )

157 
•t_’Œy
->
•‹
 = 0;

158 
•t_’Œy
->
mâ
 = 
	`·ge_to_mâ
(
pg
);

159 
•t_’Œy
->
acûss
 = 
p2m
->
deçuÉ_acûss
;

161 
•t_’Œy
->
r
 =ƒ±_’Œy->
w
 =ƒ±_’Œy->
x
 = 1;

164 
	}
}

167 
	$•t_ä“_’Œy
(
p2m_domaš
 *
p2m
, 
•t_’Œy_t
 *
•t_’Œy
, 
Ëv–
)

170 iàĞ
Ëv–
 =ğ0 || !
	`is_•‹_´e£Á
(
•t_’Œy
) ||

171 
	`is_•‹_su³½age
(
•t_’Œy
) )

174 iàĞ
Ëv–
 > 1 )

176 
•t_’Œy_t
 *
•‹
 = 
	`m­_domaš_·ge
(
•t_’Œy
->
mâ
);

177  
i
 = 0; i < 
EPT_PAGETABLE_ENTRIES
; i++ )

178 
	`•t_ä“_’Œy
(
p2m
, 
•‹
 + 
i
, 
Ëv–
 - 1);

179 
	`unm­_domaš_·ge
(
•‹
);

182 
	`p2m_ä“_±p
(
p2m
, 
	`mâ_to_·ge
(
•t_’Œy
->
mâ
));

183 
	}
}

185 
	$•t_¥l™_su³r_·ge
(
p2m_domaš
 *
p2m
, 
•t_’Œy_t
 *
•t_’Œy
,

186 
Ëv–
, 
rg‘
)

188 
•t_’Œy_t
 
Ãw_•t
, *
bË
;

189 
ušt64_t
 
Œunk
;

190 
rv
 = 1;

193 iàĞ
Ëv–
 =ğ0 ||†ev– =ğ
rg‘
 )

194  
rv
;

196 
	`ASSERT
(
	`is_•‹_su³½age
(
•t_’Œy
));

198 iàĞ!
	`•t_£t_middË_’Œy
(
p2m
, &
Ãw_•t
) )

201 
bË
 = 
	`m­_domaš_·ge
(
Ãw_•t
.
mâ
);

202 
Œunk
 = 1UL << ((
Ëv–
 - 1è* 
EPT_TABLE_ORDER
);

204  
i
 = 0; i < 
EPT_PAGETABLE_ENTRIES
; i++ )

206 
•t_’Œy_t
 *
•‹
 = 
bË
 + 
i
;

208 
•‹
->epte = 0;

209 
•‹
->
emt
 = 
•t_’Œy
->emt;

210 
•‹
->
©
 = 
•t_’Œy
->ipat;

211 
•‹
->
¥
 = (
Ëv–
 > 1) ? 1 : 0;

212 
•‹
->
acûss
 = 
•t_’Œy
->access;

213 
•‹
->
§_p2mt
 = 
•t_’Œy
->sa_p2mt;

214 
•‹
->
mâ
 = 
•t_’Œy
->mâ + 
i
 * 
Œunk
;

215 
•‹
->
rsvd2_¢p
 = ( 
iommu_’abËd
 && 
iommu_¢oİ
 ) ? 1 : 0;

217 
	`•t_p2m_ty³_to_æags
(
•‹
,ƒ±e->
§_p2mt
,ƒ±e->
acûss
);

219 iàĞ(
Ëv–
 - 1è=ğ
rg‘
 )

222 
	`ASSERT
(
	`is_•‹_su³½age
(
•‹
));

224 iàĞ!(
rv
 = 
	`•t_¥l™_su³r_·ge
(
p2m
, 
•‹
, 
Ëv–
 - 1, 
rg‘
)) )

228 
	`unm­_domaš_·ge
(
bË
);

231 *
•t_’Œy
 = 
Ãw_•t
;

233  
rv
;

234 
	}
}

250 
	$•t_Ãxt_Ëv–
(
p2m_domaš
 *
p2m
, 
boŞ_t
 
»ad_Úly
,

251 
•t_’Œy_t
 **
bË
, *
gâ_»mašd”
,

252 
Ãxt_Ëv–
)

254 
mâ
;

255 
•t_’Œy_t
 *
•t_’Œy
, 
e
;

256 
u32
 
shiá
, 
šdex
;

258 
shiá
 = 
Ãxt_Ëv–
 * 
EPT_TABLE_ORDER
;

260 
šdex
 = *
gâ_»mašd”
 >> 
shiá
;

263 
	`ASSERT
(
šdex
 < 
EPT_PAGETABLE_ENTRIES
);

265 
•t_’Œy
 = (*
bË
è+ 
šdex
;

270 
e
 = 
	`©omic_»ad_•t_’Œy
(
•t_’Œy
);

272 iàĞ!
	`is_•‹_´e£Á
(&
e
) )

274 iàĞ
e
.
§_p2mt
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

275  
GUEST_TABLE_POD_PAGE
;

277 iàĞ
»ad_Úly
 )

278  
GUEST_TABLE_MAP_FAILED
;

280 iàĞ!
	`•t_£t_middË_’Œy
(
p2m
, 
•t_’Œy
) )

281  
GUEST_TABLE_MAP_FAILED
;

283 
e
 = 
	`©omic_»ad_•t_’Œy
(
•t_’Œy
);

287 iàĞ
	`is_•‹_su³½age
(&
e
) )

288  
GUEST_TABLE_SUPER_PAGE
;

290 
mâ
 = 
e
.mfn;

291 
	`unm­_domaš_·ge
(*
bË
);

292 *
bË
 = 
	`m­_domaš_·ge
(
mâ
);

293 *
gâ_»mašd”
 &ğ(1UL << 
shiá
) - 1;

294  
GUEST_TABLE_NORMAL_PAGE
;

295 
	}
}

302 
	$•t_£t_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
,

303 
Üd”
, 
p2m_ty³_t
 
p2mt
, 
p2m_acûss_t
 
p2ma
)

305 
•t_’Œy_t
 *
bË
, *
•t_’Œy
 = 
NULL
;

306 
gâ_»mašd”
 = 
gâ
;

307 
off£t
 = 0;

308 
u32
 
šdex
;

309 
i
, 
rg‘
 = 
Üd”
 / 
EPT_TABLE_ORDER
;

310 
rv
 = 0;

311 
»t
 = 0;

312 
boŞ_t
 
dœeù_mmio
 = (
p2mt
 =ğ
p2m_mmio_dœeù
);

313 
ušt8_t
 
©
 = 0;

314 
Ãed_modify_vtd_bË
 = 1;

315 
vtd_±e_´e£Á
 = 0;

316 
Ãeds_sync
 = 1;

317 
domaš
 *
d
 = 
p2m
->domain;

318 
•t_’Œy_t
 
Şd_’Œy
 = { .
•‹
 = 0 };

326 iàĞ((
gâ
 | 
	`mâ_x
(
mâ
)è& ((1UL << 
Üd”
) - 1)) ||

327 ((
u64
)
gâ
 >> ((
	`•t_g‘_wl
(
d
è+ 1è* 
EPT_TABLE_ORDER
)) ||

328 (
Üd”
 % 
EPT_TABLE_ORDER
) )

331 
	`ASSERT
((
rg‘
 =ğ2 && 
	`hvm_h­_has_1gb
(
d
)) ||

332 (
rg‘
 =ğ1 && 
	`hvm_h­_has_2mb
(
d
)) ||

333 (
rg‘
 == 0));

335 
bË
 = 
	`m­_domaš_·ge
(
	`•t_g‘_a¤
(
d
));

337 
	`ASSERT
(
bË
 !ğ
NULL
);

339  
i
 = 
	`•t_g‘_wl
(
d
); i > 
rg‘
; i-- )

341 
»t
 = 
	`•t_Ãxt_Ëv–
(
p2m
, 0, &
bË
, &
gâ_»mašd”
, 
i
);

342 iàĞ!
»t
 )

343 
out
;

344 iàĞ
»t
 !ğ
GUEST_TABLE_NORMAL_PAGE
 )

348 
	`ASSERT
(
»t
 !ğ
GUEST_TABLE_POD_PAGE
 || 
i
 !ğ
rg‘
);

350 
šdex
 = 
gâ_»mašd”
 >> (
i
 * 
EPT_TABLE_ORDER
);

351 
off£t
 = 
gâ_»mašd”
 & ((1UL << (
i
 * 
EPT_TABLE_ORDER
)) - 1);

353 
•t_’Œy
 = 
bË
 + 
šdex
;

356 
vtd_±e_´e£Á
 = 
	`is_•‹_´e£Á
(
•t_’Œy
) ? 1 : 0;

367 iàĞ
i
 =ğ
rg‘
 )

370 
•t_’Œy_t
 
Ãw_’Œy
 = { .
•‹
 = 0 };

373 iàĞ!
	`is_•‹_´e£Á
(
•t_’Œy
) )

374 
Ãeds_sync
 = 0;

378 
Şd_’Œy
 = *
•t_’Œy
;

380 iàĞ
	`mâ_v®id
(
	`mâ_x
(
mâ
)è|| 
dœeù_mmio
 || 
	`p2m_is_·ged
(
p2mt
) ||

381 (
p2mt
 =ğ
p2m_¿m_·gšg_š_¡¬t
) )

384 
Ãw_’Œy
.
emt
 = 
	`•‹_g‘_’Œy_emt
(
p2m
->
domaš
, 
gâ
, 
mâ
, &
©
,

385 
dœeù_mmio
);

387 
Ãw_’Œy
.
©
 = ipat;

388 
Ãw_’Œy
.
¥
 = 
Üd”
 ? 1 : 0;

389 
Ãw_’Œy
.
§_p2mt
 = 
p2mt
;

390 
Ãw_’Œy
.
acûss
 = 
p2ma
;

391 
Ãw_’Œy
.
rsvd2_¢p
 = (
iommu_’abËd
 && 
iommu_¢oİ
);

393 iàĞ
Ãw_’Œy
.
mâ
 =ğ
	`mâ_x
(mfn) )

394 
Ãed_modify_vtd_bË
 = 0;

396 
Ãw_’Œy
.
mâ
 = 
	`mâ_x
(mfn);

398 
	`•t_p2m_ty³_to_æags
(&
Ãw_’Œy
, 
p2mt
, 
p2ma
);

401 
	`©omic_wr™e_•t_’Œy
(
•t_’Œy
, 
Ãw_’Œy
);

406 
•t_’Œy_t
 
¥l™_•t_’Œy
;

407 
•t_’Œy_t
 
Ãw_’Œy
 = { .
•‹
 = 0 };

409 
	`ASSERT
(
	`is_•‹_su³½age
(
•t_’Œy
));

411 
¥l™_•t_’Œy
 = 
	`©omic_»ad_•t_’Œy
(
•t_’Œy
);

413 iàĞ!
	`•t_¥l™_su³r_·ge
(
p2m
, &
¥l™_•t_’Œy
, 
i
, 
rg‘
) )

415 
	`•t_ä“_’Œy
(
p2m
, &
¥l™_•t_’Œy
, 
i
);

416 
out
;

421 
	`©omic_wr™e_•t_’Œy
(
•t_’Œy
, 
¥l™_•t_’Œy
);

424  ; 
i
 > 
rg‘
; i-- )

425 
	`•t_Ãxt_Ëv–
(
p2m
, 0, &
bË
, &
gâ_»mašd”
, 
i
);

427 
	`ASSERT
(
i
 =ğ
rg‘
);

429 
šdex
 = 
gâ_»mašd”
 >> (
i
 * 
EPT_TABLE_ORDER
);

430 
off£t
 = 
gâ_»mašd”
 & ((1UL << (
i
 * 
EPT_TABLE_ORDER
)) - 1);

432 
•t_’Œy
 = 
bË
 + 
šdex
;

434 
Ãw_’Œy
.
emt
 = 
	`•‹_g‘_’Œy_emt
(
d
, 
gâ
, 
mâ
, &
©
, 
dœeù_mmio
);

435 
Ãw_’Œy
.
©
 = ipat;

436 
Ãw_’Œy
.
¥
 = 
i
 ? 1 : 0;

437 
Ãw_’Œy
.
§_p2mt
 = 
p2mt
;

438 
Ãw_’Œy
.
acûss
 = 
p2ma
;

439 
Ãw_’Œy
.
rsvd2_¢p
 = (
iommu_’abËd
 && 
iommu_¢oİ
);

441 iàĞ
Ãw_’Œy
.
mâ
 =ğ
	`mâ_x
(mfn) )

442 
Ãed_modify_vtd_bË
 = 0;

444 
Ãw_’Œy
.
mâ
 = 
	`mâ_x
(mfn);

446 
	`•t_p2m_ty³_to_æags
(&
Ãw_’Œy
, 
p2mt
, 
p2ma
);

448 
	`©omic_wr™e_•t_’Œy
(
•t_’Œy
, 
Ãw_’Œy
);

452 iàĞ
	`mâ_v®id
(
	`mâ_x
(
mâ
)) &&

453 (
gâ
 + (1UL << 
Üd”
è- 1 > 
p2m
->
max_m­³d_pâ
) )

454 
p2m
->
max_m­³d_pâ
 = 
gâ
 + (1UL << 
Üd”
) - 1;

457 
rv
 = 1;

459 
out
:

460 
	`unm­_domaš_·ge
(
bË
);

462 iàĞ
Ãeds_sync
 )

463 
	`•t_sync_domaš
(
p2m
->
domaš
);

465 iàĞ
rv
 && 
iommu_’abËd
 && 
	`Ãed_iommu
(
p2m
->
domaš
è&& 
Ãed_modify_vtd_bË
 )

467 iàĞ
iommu_h­_±_sh¬e
 )

468 
	`iommu_±e_æush
(
d
, 
gâ
, (
u64
*)
•t_’Œy
, 
Üd”
, 
vtd_±e_´e£Á
);

471 iàĞ
p2mt
 =ğ
p2m_¿m_rw
 )

473 iàĞ
Üd”
 > 0 )

475  
i
 = 0; i < (1 << 
Üd”
); i++ )

476 
	`iommu_m­_·ge
(

477 
p2m
->
domaš
, 
gâ
 - 
off£t
 + 
i
, 
	`mâ_x
(
mâ
) - offset + i,

478 
IOMMUF_»adabË
 | 
IOMMUF_wr™abË
);

480 iàĞ!
Üd”
 )

481 
	`iommu_m­_·ge
(

482 
p2m
->
domaš
, 
gâ
, 
	`mâ_x
(
mâ
), 
IOMMUF_»adabË
 | 
IOMMUF_wr™abË
);

486 iàĞ
Üd”
 > 0 )

488  
i
 = 0; i < (1 << 
Üd”
); i++ )

489 
	`iommu_unm­_·ge
(
p2m
->
domaš
, 
gâ
 - 
off£t
 + 
i
);

491 iàĞ!
Üd”
 )

492 
	`iommu_unm­_·ge
(
p2m
->
domaš
, 
gâ
);

501 iàĞ
	`is_•‹_´e£Á
(&
Şd_’Œy
) )

502 
	`•t_ä“_’Œy
(
p2m
, &
Şd_’Œy
, 
rg‘
);

504  
rv
;

505 
	}
}

508 
mâ_t
 
	$•t_g‘_’Œy
(
p2m_domaš
 *
p2m
,

509 
gâ
, 
p2m_ty³_t
 *
t
, 
p2m_acûss_t
* 
a
,

510 
p2m_qu”y_t
 
q
)

512 
domaš
 *
d
 = 
p2m
->domain;

513 
•t_’Œy_t
 *
bË
 = 
	`m­_domaš_·ge
(
	`•t_g‘_a¤
(
d
));

514 
gâ_»mašd”
 = 
gâ
;

515 
•t_’Œy_t
 *
•t_’Œy
;

516 
u32
 
šdex
;

517 
i
;

518 
»t
 = 0;

519 
mâ_t
 
mâ
 = 
	`_mâ
(
INVALID_MFN
);

521 *
t
 = 
p2m_mmio_dm
;

522 *
a
 = 
p2m_acûss_n
;

525 iàĞ
gâ
 > 
p2m
->
max_m­³d_pâ
 )

526 
out
;

530  
i
 = 
	`•t_g‘_wl
(
d
); i > 0; i-- )

532 
»Œy
:

533 
»t
 = 
	`•t_Ãxt_Ëv–
(
p2m
, 1, &
bË
, &
gâ_»mašd”
, 
i
);

534 iàĞ!
»t
 )

535 
out
;

536 iàĞ
»t
 =ğ
GUEST_TABLE_POD_PAGE
 )

538 iàĞ
q
 =ğ
p2m_qu”y
 )

540 *
t
 = 
p2m_pİuÏ‹_Ú_demªd
;

541 
out
;

545 
	`ASSERT
(
i
 == 1);

547 
šdex
 = 
gâ_»mašd”
 >> ( 
i
 * 
EPT_TABLE_ORDER
);

548 
•t_’Œy
 = 
bË
 + 
šdex
;

550 iàĞ!
	`•t_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

551 
•t_’Œy
, 9, 
q
) )

552 
»Œy
;

554 
out
;

556 iàĞ
»t
 =ğ
GUEST_TABLE_SUPER_PAGE
 )

560 
šdex
 = 
gâ_»mašd”
 >> (
i
 * 
EPT_TABLE_ORDER
);

561 
•t_’Œy
 = 
bË
 + 
šdex
;

563 iàĞ
•t_’Œy
->
§_p2mt
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

565 iàĞ
q
 =ğ
p2m_qu”y
 )

567 *
t
 = 
p2m_pİuÏ‹_Ú_demªd
;

568 
out
;

571 
	`ASSERT
(
i
 == 0);

573 iàĞ
	`•t_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

574 
•t_’Œy
, 0, 
q
) )

575 
out
;

579 iàĞ
•t_’Œy
->
§_p2mt
 !ğ
p2m_šv®id
 )

581 *
t
 = 
•t_’Œy
->
§_p2mt
;

582 *
a
 = 
•t_’Œy
->
acûss
;

584 
mâ
 = 
	`_mâ
(
•t_’Œy
->mfn);

585 iàĞ
i
 )

591 
¥l™_mâ
 = 
	`mâ_x
(
mâ
) +

592 (
gâ_»mašd”
 &

593 ((1 << (
i
 * 
EPT_TABLE_ORDER
)) - 1));

594 
mâ
 = 
	`_mâ
(
¥l™_mâ
);

598 
out
:

599 
	`unm­_domaš_·ge
(
bË
);

600  
mâ
;

601 
	}
}

606 
•t_’Œy_t
 
	$•t_g‘_’Œy_cÚ‹Á
(
p2m_domaš
 *
p2m
,

607 
gâ
, *
Ëv–
)

609 
•t_’Œy_t
 *
bË
 = 
	`m­_domaš_·ge
(
	`•t_g‘_a¤
(
p2m
->
domaš
));

610 
gâ_»mašd”
 = 
gâ
;

611 
•t_’Œy_t
 *
•t_’Œy
;

612 
•t_’Œy_t
 
cÚ‹Á
 = { .
•‹
 = 0 };

613 
u32
 
šdex
;

614 
i
;

615 
»t
=0;

618 iàĞ
gâ
 > 
p2m
->
max_m­³d_pâ
 )

619 
out
;

621  
i
 = 
	`•t_g‘_wl
(
p2m
->
domaš
); i > 0; i-- )

623 
»t
 = 
	`•t_Ãxt_Ëv–
(
p2m
, 1, &
bË
, &
gâ_»mašd”
, 
i
);

624 iàĞ!
»t
 ||„‘ =ğ
GUEST_TABLE_POD_PAGE
 )

625 
out
;

626 iàĞ
»t
 =ğ
GUEST_TABLE_SUPER_PAGE
 )

630 
šdex
 = 
gâ_»mašd”
 >> (
i
 * 
EPT_TABLE_ORDER
);

631 
•t_’Œy
 = 
bË
 + 
šdex
;

632 
cÚ‹Á
 = *
•t_’Œy
;

633 *
Ëv–
 = 
i
;

635 
out
:

636 
	`unm­_domaš_·ge
(
bË
);

637  
cÚ‹Á
;

638 
	}
}

640 
	$•t_w®k_bË
(
domaš
 *
d
, 
gâ
)

642 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

643 
•t_’Œy_t
 *
bË
 = 
	`m­_domaš_·ge
(
	`•t_g‘_a¤
(
d
));

644 
gâ_»mašd”
 = 
gâ
;

646 
i
;

648 
	`gd´štk
(
XENLOG_ERR
, "Walking EPTables for domain %d gfn %lx\n",

649 
d
->
domaš_id
, 
gâ
);

652 iàĞ
gâ
 > 
p2m
->
max_m­³d_pâ
 )

654 
	`gd´štk
(
XENLOG_ERR
, " gfnƒxceeds max_mapped_pfn %lx\n",

655 
p2m
->
max_m­³d_pâ
);

656 
out
;

659  
i
 = 
	`•t_g‘_wl
(
d
); i >= 0; i-- )

661 
•t_’Œy_t
 *
•t_’Œy
, *
Ãxt
;

662 
u32
 
šdex
;

665 
šdex
 = 
gâ_»mašd”
 >> (
i
*
EPT_TABLE_ORDER
);

666 
•t_’Œy
 = 
bË
 + 
šdex
;

668 
	`gd´štk
(
XENLOG_ERR
, "ƒ±%"
PRIx64
"\n", 
•t_’Œy
->
•‹
);

670 iàĞ(
i
 =ğ0è|| !
	`is_•‹_´e£Á
(
•t_’Œy
) ||

671 
	`is_•‹_su³½age
(
•t_’Œy
) )

672 
out
;

675 
gâ_»mašd”
 &ğ(1UL << (
i
*
EPT_TABLE_ORDER
)) - 1;

677 
Ãxt
 = 
	`m­_domaš_·ge
(
•t_’Œy
->
mâ
);

679 
	`unm­_domaš_·ge
(
bË
);

681 
bË
 = 
Ãxt
;

685 
out
:

686 
	`unm­_domaš_·ge
(
bË
);

688 
	}
}

690 
mâ_t
 
	$•t_g‘_’Œy_cu¼’t
(
p2m_domaš
 *
p2m
,

691 
gâ
, 
p2m_ty³_t
 *
t
, 
p2m_acûss_t
 *
a
,

692 
p2m_qu”y_t
 
q
)

694  
	`•t_g‘_’Œy
(
p2m
, 
gâ
, 
t
, 
a
, 
q
);

695 
	}
}

701 
	$Ãed_modify_•t_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
,

702 
mâ_t
 
mâ
, 
ušt8_t
 
o_©
, ušt8_ˆ
o_emt
,

703 
p2m_ty³_t
 
p2mt
)

705 
ušt8_t
 
©
;

706 
ušt8_t
 
emt
;

707 
boŞ_t
 
dœeù_mmio
 = (
p2mt
 =ğ
p2m_mmio_dœeù
);

709 
emt
 = 
	`•‹_g‘_’Œy_emt
(
p2m
->
domaš
, 
gâ
, 
mâ
, &
©
, 
dœeù_mmio
);

711 iàĞ(
emt
 =ğ
o_emt
è&& (
©
 =ğ
o_©
) )

715 
	}
}

717 
	$•t_chªge_’Œy_emt_w™h_¿nge
(
domaš
 *
d
,

718 
¡¬t_gâ
,

719 
’d_gâ
)

721 
gâ
;

722 
•t_’Œy_t
 
e
;

723 
mâ_t
 
mâ
;

724 
Üd”
 = 0;

725 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

727 
	`p2m_lock
(
p2m
);

728  
gâ
 = 
¡¬t_gâ
; gâ <ğ
’d_gâ
; gfn++ )

730 
Ëv–
 = 0;

731 
ušt64_t
 
Œunk
 = 0;

733 
e
 = 
	`•t_g‘_’Œy_cÚ‹Á
(
p2m
, 
gâ
, &
Ëv–
);

734 iàĞ!
	`p2m_has_emt
(
e
.
§_p2mt
) )

737 
Üd”
 = 0;

738 
mâ
 = 
	`_mâ
(
e
.mfn);

740 iàĞ
	`is_•‹_su³½age
(&
e
) )

742  
Ëv–
 )

744 
Œunk
 = (1UL << (
Ëv–
 * 
EPT_TABLE_ORDER
)) - 1;

745 iàĞ!(
gâ
 & 
Œunk
è&& (gâ +runk <ğ
’d_gâ
) )

751 
Üd”
 = 
Ëv–
 * 
EPT_TABLE_ORDER
;

752 iàĞ
	`Ãed_modify_•t_’Œy
(
p2m
, 
gâ
, 
mâ
,

753 
e
.
©
,ƒ.
emt
,ƒ.
§_p2mt
) )

754 
	`•t_£t_’Œy
(
p2m
, 
gâ
, 
mâ
, 
Üd”
, 
e
.
§_p2mt
,ƒ.
acûss
);

755 
gâ
 +ğ
Œunk
;

758 
Ëv–
--;

763 iàĞ
	`Ãed_modify_•t_’Œy
(
p2m
, 
gâ
, 
mâ
, 
e
.
©
,ƒ.
emt
,ƒ.
§_p2mt
) )

764 
	`•t_£t_’Œy
(
p2m
, 
gâ
, 
mâ
, 
Üd”
, 
e
.
§_p2mt
,ƒ.
acûss
);

767 
	`p2m_uÆock
(
p2m
);

768 
	}
}

775 
	$•t_chªge_’Œy_ty³_·ge
(
mâ_t
 
•t_·ge_mâ
, 
•t_·ge_Ëv–
,

776 
p2m_ty³_t
 
Ù
,…2m_ty³_ˆ
Á
)

778 
•t_’Œy_t
 
e
, *
•‹
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
•t_·ge_mâ
));

780  
i
 = 0; i < 
EPT_PAGETABLE_ENTRIES
; i++ )

782 iàĞ!
	`is_•‹_´e£Á
(
•‹
 + 
i
) )

785 iàĞ(
•t_·ge_Ëv–
 > 0è&& !
	`is_•‹_su³½age
(
•‹
 + 
i
) )

786 
	`•t_chªge_’Œy_ty³_·ge
(
	`_mâ
(
•‹
[
i
].
mâ
),

787 
•t_·ge_Ëv–
 - 1, 
Ù
, 
Á
);

790 
e
 = 
	`©omic_»ad_•t_’Œy
(&
•‹
[
i
]);

791 iàĞ
e
.
§_p2mt
 !ğ
Ù
 )

794 
e
.
§_p2mt
 = 
Á
;

795 
	`•t_p2m_ty³_to_æags
(&
e
, 
Á
,ƒ.
acûss
);

796 
	`©omic_wr™e_•t_’Œy
(&
•‹
[
i
], 
e
);

800 
	`unm­_domaš_·ge
(
•‹
);

801 
	}
}

803 
	$•t_chªge_’Œy_ty³_glob®
(
p2m_domaš
 *
p2m
,

804 
p2m_ty³_t
 
Ù
,…2m_ty³_ˆ
Á
)

806 
domaš
 *
d
 = 
p2m
->domain;

807 iàĞ
	`•t_g‘_a¤
(
d
) == 0 )

810 
	`BUG_ON
(
	`p2m_is_g¿Á
(
Ù
è||…2m_is_g¿Á(
Á
));

811 
	`BUG_ON
(
Ù
 !ğ
Á
 && (Ù =ğ
p2m_mmio_dœeù
 ||‚t ==…2m_mmio_direct));

813 
	`•t_chªge_’Œy_ty³_·ge
(
	`_mâ
(
	`•t_g‘_a¤
(
d
)), 
	`•t_g‘_wl
(d), 
Ù
, 
Á
);

815 
	`•t_sync_domaš
(
d
);

816 
	}
}

818 
	$•t_p2m_š™
(
domaš
 *
d
)

820 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

821 
p2m
->
£t_’Œy
 = 
•t_£t_’Œy
;

822 
p2m
->
g‘_’Œy
 = 
•t_g‘_’Œy
;

823 
p2m
->
g‘_’Œy_cu¼’t
 = 
•t_g‘_’Œy_cu¼’t
;

824 
p2m
->
chªge_’Œy_ty³_glob®
 = 
•t_chªge_’Œy_ty³_glob®
;

825 
	}
}

827 
	$•t_dump_p2m_bË
(
key
)

829 
domaš
 *
d
;

830 
•t_’Œy_t
 *
bË
, *
•t_’Œy
;

831 
mâ_t
 
mâ
;

832 
Üd”
;

833 
i
;

834 
is_pod
;

835 
»t
 = 0;

836 
šdex
;

837 
gâ
, 
gâ_»mašd”
;

838 
»cÜd_couÁ”
 = 0;

839 
p2m_domaš
 *
p2m
;

841 
	`fÜ_—ch_domaš
(
d
)

843 iàĞ!
	`h­_’abËd
(
d
) )

846 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

847 
	`´štk
("\ndomaš%d EPT…2mabË: \n", 
d
->
domaš_id
);

849  
gâ
 = 0; gâ <ğ
p2m
->
max_m­³d_pâ
; gâ +ğ(1 << 
Üd”
) )

851 
gâ_»mašd”
 = 
gâ
;

852 
mâ
 = 
	`_mâ
(
INVALID_MFN
);

853 
bË
 = 
	`m­_domaš_·ge
(
	`•t_g‘_a¤
(
d
));

855  
i
 = 
	`•t_g‘_wl
(
d
); i > 0; i-- )

857 
»t
 = 
	`•t_Ãxt_Ëv–
(
p2m
, 1, &
bË
, &
gâ_»mašd”
, 
i
);

858 iàĞ
»t
 !ğ
GUEST_TABLE_NORMAL_PAGE
 )

862 
Üd”
 = 
i
 * 
EPT_TABLE_ORDER
;

864 iàĞ
»t
 =ğ
GUEST_TABLE_MAP_FAILED
 )

865 
out
;

867 
šdex
 = 
gâ_»mašd”
 >> 
Üd”
;

868 
•t_’Œy
 = 
bË
 + 
šdex
;

869 iàĞ
•t_’Œy
->
§_p2mt
 !ğ
p2m_šv®id
 )

871 Ğ
•t_’Œy
->
§_p2mt
 =ğ
p2m_pİuÏ‹_Ú_demªd
 ) ?

872 Ğ
mâ
 = 
	`_mâ
(
INVALID_MFN
), 
is_pod
 = 1 ) :

873 Ğ
mâ
 = 
	`_mâ
(
•t_’Œy
->mâ), 
is_pod
 = 0 );

875 
	`´štk
("gfn: %-16lx mfn: %-16lx order: %2d is_pod: %d\n",

876 
gâ
, 
	`mâ_x
(
mâ
), 
Üd”
, 
is_pod
);

878 iàĞ!(
»cÜd_couÁ”
++ % 100) )

879 
	`´oûss_³ndšg_soáœqs
();

881 
out
:

882 
	`unm­_domaš_·ge
(
bË
);

885 
	}
}

887 
keyhªdËr
 
	g•t_p2m_bË
 = {

888 .
dŸgno¡ic
 = 0,

889 .
	gu
.
	gâ
 = 
•t_dump_p2m_bË
,

890 .
	gdesc
 = "dumpƒpt…2mable"

893 
	$£tup_•t_dump
()

895 
	`»gi¡”_keyhªdËr
('D', &
•t_p2m_bË
);

896 
	}
}

	@mm/hap/private.h

20 #iâdeà
__HAP_PRIVATE_H__


21 
	#__HAP_PRIVATE_H__


	)

26 
h­_gva_to_gâ_2_Ëv–s
(
vıu
 *
v
, 
gva
,

27 
ušt32_t
 *
pãc
);

28 
h­_gva_to_gâ_3_Ëv–s
(
vıu
 *
v
, 
gva
,

29 
ušt32_t
 *
pãc
);

30 
h­_gva_to_gâ_4_Ëv–s
(
vıu
 *
v
, 
gva
,

31 
ušt32_t
 *
pãc
);

	@mm/mem_access.c

24 
	~<asm/p2m.h
>

25 
	~<asm/mem_ev’t.h
>

28 
mem_acûss_domùl
(
domaš
 *
d
, 
x’_domùl_mem_ev’t_İ_t
 *
mec
,

29 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

31 
rc
;

32 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

34  
mec
->
İ
 )

36 
XEN_DOMCTL_MEM_EVENT_OP_ACCESS_RESUME
:

38 
	`p2m_mem_acûss_»sume
(
p2m
);

39 
rc
 = 0;

44 
rc
 = -
ENOSYS
;

48  
rc
;

49 
	}
}

	@mm/mem_event.c

24 
	~<asm/domaš.h
>

25 
	~<x’/ev’t.h
>

26 
	~<asm/p2m.h
>

27 
	~<asm/mem_ev’t.h
>

28 
	~<asm/mem_·gšg.h
>

29 
	~<asm/mem_acûss.h
>

32 
	#x’_mb
(è
	`mb
()

	)

33 
	#x’_rmb
(è
	`rmb
()

	)

34 
	#x’_wmb
(è
	`wmb
()

	)

36 
	#mem_ev’t_ršg_lock_š™
(
_d
è
	`¥š_lock_š™
(&(_d)->
mem_ev’t
.
ršg_lock
)

	)

37 
	#mem_ev’t_ršg_lock
(
_d
è
	`¥š_lock
(&(_d)->
mem_ev’t
.
ršg_lock
)

	)

38 
	#mem_ev’t_ršg_uÆock
(
_d
è
	`¥š_uÆock
(&(_d)->
mem_ev’t
.
ršg_lock
)

	)

40 
	#MEM_EVENT_RING_THRESHOLD
 4

	)

42 
	$mem_ev’t_’abË
(
domaš
 *
d
, 
mâ_t
 
ršg_mâ
, mâ_ˆ
sh¬ed_mâ
)

44 
rc
;

47 
d
->
mem_ev’t
.
ršg_·ge
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
ršg_mâ
));

48 iàĞ
d
->
mem_ev’t
.
ršg_·ge
 =ğ
NULL
 )

49 
”r
;

51 
d
->
mem_ev’t
.
sh¬ed_·ge
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
sh¬ed_mâ
));

52 iàĞ
d
->
mem_ev’t
.
sh¬ed_·ge
 =ğ
NULL
 )

53 
”r_ršg
;

56 
rc
 = 
	`®loc_unbound_x’_ev’t_chªÃl
(
d
->
vıu
[0],

57 
cu¼’t
->
domaš
->
domaš_id
);

58 iàĞ
rc
 < 0 )

59 
”r_sh¬ed
;

61 ((
mem_ev’t_sh¬ed_·ge_t
 *)
d
->
mem_ev’t
.
sh¬ed_·ge
)->
pÜt
 = 
rc
;

62 
d
->
mem_ev’t
.
x’_pÜt
 = 
rc
;

65 
	`FRONT_RING_INIT
(&
d
->
mem_ev’t
.
äÚt_ršg
,

66 (
mem_ev’t_¤šg_t
 *)
d
->
mem_ev’t
.
ršg_·ge
,

67 
PAGE_SIZE
);

69 
	`mem_ev’t_ršg_lock_š™
(
d
);

72 
	`mem_ev’t_uÅau£_vıus
(
d
);

76 
”r_sh¬ed
:

77 
	`unm­_domaš_·ge
(
d
->
mem_ev’t
.
sh¬ed_·ge
);

78 
d
->
mem_ev’t
.
sh¬ed_·ge
 = 
NULL
;

79 
”r_ršg
:

80 
	`unm­_domaš_·ge
(
d
->
mem_ev’t
.
ršg_·ge
);

81 
d
->
mem_ev’t
.
ršg_·ge
 = 
NULL
;

82 
”r
:

84 
	}
}

86 
	$mem_ev’t_di§bË
(
domaš
 *
d
)

88 
	`unm­_domaš_·ge
(
d
->
mem_ev’t
.
ršg_·ge
);

89 
d
->
mem_ev’t
.
ršg_·ge
 = 
NULL
;

91 
	`unm­_domaš_·ge
(
d
->
mem_ev’t
.
sh¬ed_·ge
);

92 
d
->
mem_ev’t
.
sh¬ed_·ge
 = 
NULL
;

95 
	}
}

97 
	$mem_ev’t_put_»que¡
(
domaš
 *
d
, 
mem_ev’t_»que¡_t
 *
»q
)

99 
mem_ev’t_äÚt_ršg_t
 *
äÚt_ršg
;

100 
RING_IDX
 
»q_´od
;

102 
	`mem_ev’t_ršg_lock
(
d
);

104 
äÚt_ršg
 = &
d
->
mem_ev’t
.front_ring;

105 
»q_´od
 = 
äÚt_ršg
->
»q_´od_pvt
;

108 
	`memıy
(
	`RING_GET_REQUEST
(
äÚt_ršg
, 
»q_´od
), 
»q
, (*req));

109 
»q_´od
++;

112 
äÚt_ršg
->
»q_´od_pvt
 = 
»q_´od
;

113 
	`RING_PUSH_REQUESTS
(
äÚt_ršg
);

115 
	`mem_ev’t_ršg_uÆock
(
d
);

117 
	`nÙify_vŸ_x’_ev’t_chªÃl
(
d
, d->
mem_ev’t
.
x’_pÜt
);

118 
	}
}

120 
	$mem_ev’t_g‘_»¥Ú£
(
domaš
 *
d
, 
mem_ev’t_»¥Ú£_t
 *
r¥
)

122 
mem_ev’t_äÚt_ršg_t
 *
äÚt_ršg
;

123 
RING_IDX
 
r¥_cÚs
;

125 
	`mem_ev’t_ršg_lock
(
d
);

127 
äÚt_ršg
 = &
d
->
mem_ev’t
.front_ring;

128 
r¥_cÚs
 = 
äÚt_ršg
->rsp_cons;

131 
	`memıy
(
r¥
, 
	`RING_GET_RESPONSE
(
äÚt_ršg
, 
r¥_cÚs
), (*rsp));

132 
r¥_cÚs
++;

135 
äÚt_ršg
->
r¥_cÚs
 =„sp_cons;

136 
äÚt_ršg
->
¤šg
->
r¥_ev’t
 = 
r¥_cÚs
 + 1;

138 
	`mem_ev’t_ršg_uÆock
(
d
);

139 
	}
}

141 
	$mem_ev’t_uÅau£_vıus
(
domaš
 *
d
)

143 
vıu
 *
v
;

145 
	`fÜ_—ch_vıu
 ( 
d
, 
v
 )

146 iàĞ
	`‹¡_ªd_ş—r_b™
(
_VPF_mem_ev’t
, &
v
->
·u£_æags
) )

147 
	`vıu_wake
(
v
);

148 
	}
}

150 
	$mem_ev’t_m¬k_ªd_·u£
(
vıu
 *
v
)

152 
	`£t_b™
(
_VPF_mem_ev’t
, &
v
->
·u£_æags
);

153 
	`vıu_¦“p_nosync
(
v
);

154 
	}
}

156 
	$mem_ev’t_check_ršg
(
domaš
 *
d
)

158 
vıu
 *
cu¼
 = 
cu¼’t
;

159 
ä“_»que¡s
;

160 
ršg_fuÎ
;

162 iàĞ!
d
->
mem_ev’t
.
ršg_·ge
 )

165 
	`mem_ev’t_ršg_lock
(
d
);

167 
ä“_»que¡s
 = 
	`RING_FREE_REQUESTS
(&
d
->
mem_ev’t
.
äÚt_ršg
);

168 iàĞ
	`uÆik–y
(
ä“_»que¡s
 < 2) )

170 
	`gd´štk
(
XENLOG_INFO
, "ä“„eque¡ slÙs: %d\n", 
ä“_»que¡s
);

171 
	`WARN_ON
(
ä“_»que¡s
 == 0);

173 
ršg_fuÎ
 = 
ä“_»que¡s
 < 
MEM_EVENT_RING_THRESHOLD
 ? 1 : 0;

175 iàĞ(
cu¼
->
domaš
->
domaš_id
 =ğ
d
->domaš_idè&& 
ršg_fuÎ
 )

177 
	`£t_b™
(
_VPF_mem_ev’t
, &
cu¼
->
·u£_æags
);

178 
	`vıu_¦“p_nosync
(
cu¼
);

181 
	`mem_ev’t_ršg_uÆock
(
d
);

183  
ršg_fuÎ
;

184 
	}
}

186 
mem_ev’t_domùl
(
domaš
 *
d
, 
x’_domùl_mem_ev’t_İ_t
 *
mec
,

187 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

189 
rc
;

191 iàĞ
	`uÆik–y
(
d
 =ğ
cu¼’t
->
domaš
) )

193 
	`gd´štk
(
XENLOG_INFO
, "Triedo do‡ memory…aging op on itself.\n");

194  -
EINVAL
;

197 iàĞ
	`uÆik–y
(
d
->
is_dyšg
) )

199 
	`gd´štk
(
XENLOG_INFO
, "Ignoring memory…aging op on dying domain %u\n",

200 
d
->
domaš_id
);

204 iàĞ
	`uÆik–y
(
d
->
vıu
 =ğ
NULL
) || unlikely(d->vcpu[0] == NULL) )

206 
	`gd´štk
(
XENLOG_INFO
,

208 
d
->
domaš_id
);

209  -
EINVAL
;

214 
rc
 = 
	`xsm_mem_ev’t_cÚŒŞ
(
d
, 
mec
->
İ
);

215 iàĞ
rc
 )

216  
rc
;

219 
rc
 = -
ENOSYS
;

221  
mec
-> 
mode
 )

225  
mec
->
İ
 )

227 
XEN_DOMCTL_MEM_EVENT_OP_ENABLE
:

229 
domaš
 *
dom_mem_ev’t
 = 
cu¼’t
->domain;

230 
vıu
 *
v
 = 
cu¼’t
;

231 
ršg_addr
 = 
mec
->ring_addr;

232 
sh¬ed_addr
 = 
mec
->shared_addr;

233 
l1_pg’Œy_t
 
l1e
;

234 
gâ
;

235 
p2m_ty³_t
 
p2mt
;

236 
mâ_t
 
ršg_mâ
;

237 
mâ_t
 
sh¬ed_mâ
;

242 
rc
 = -
EBUSY
;

243 iàĞ
d
->
mem_ev’t
.
ršg_·ge
 )

247 
rc
 = -
ENODEV
;

248 iàĞ!(
	`h­_’abËd
(
d
) &&

249 (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)) )

253 
	`gue¡_g‘_eff_l1e
(
v
, 
ršg_addr
, &
l1e
);

254 
gâ
 = 
	`l1e_g‘_pâ
(
l1e
);

255 
ršg_mâ
 = 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
dom_mem_ev’t
), 
gâ
, &
p2mt
);

257 
rc
 = -
EINVAL
;

258 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
	`mâ_x
(
ršg_mâ
))) )

262 
	`gue¡_g‘_eff_l1e
(
v
, 
sh¬ed_addr
, &
l1e
);

263 
gâ
 = 
	`l1e_g‘_pâ
(
l1e
);

264 
sh¬ed_mâ
 = 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
dom_mem_ev’t
), 
gâ
, &
p2mt
);

266 
rc
 = -
EINVAL
;

267 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
	`mâ_x
(
sh¬ed_mâ
))) )

270 
rc
 = -
EINVAL
;

271 iàĞ
	`mem_ev’t_’abË
(
d
, 
ršg_mâ
, 
sh¬ed_mâ
) != 0 )

274 
rc
 = 0;

278 
XEN_DOMCTL_MEM_EVENT_OP_DISABLE
:

280 
rc
 = 
	`mem_ev’t_di§bË
(
d
);

285 
rc
 = -
ENOSYS
;

290 
XEN_DOMCTL_MEM_EVENT_OP_PAGING
:

292 
rc
 = 
	`mem_·gšg_domùl
(
d
, 
mec
, 
u_domùl
);

295 
XEN_DOMCTL_MEM_EVENT_OP_ACCESS
:

297 
rc
 = 
	`mem_acûss_domùl
(
d
, 
mec
, 
u_domùl
);

302  
rc
;

303 
	}
}

	@mm/mem_paging.c

24 
	~<asm/p2m.h
>

25 
	~<asm/mem_ev’t.h
>

28 
mem_·gšg_domùl
(
domaš
 *
d
, 
x’_domùl_mem_ev’t_İ_t
 *
mec
,

29 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

31 
rc
;

32 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

34  
mec
->
İ
 )

36 
XEN_DOMCTL_MEM_EVENT_OP_PAGING_NOMINATE
:

38 
gâ
 = 
mec
->gfn;

39 
rc
 = 
	`p2m_mem_·gšg_nomš©e
(
p2m
, 
gâ
);

43 
XEN_DOMCTL_MEM_EVENT_OP_PAGING_EVICT
:

45 
gâ
 = 
mec
->gfn;

46 
rc
 = 
	`p2m_mem_·gšg_eviù
(
p2m
, 
gâ
);

50 
XEN_DOMCTL_MEM_EVENT_OP_PAGING_PREP
:

52 
gâ
 = 
mec
->gfn;

53 
rc
 = 
	`p2m_mem_·gšg_´•
(
p2m
, 
gâ
);

57 
XEN_DOMCTL_MEM_EVENT_OP_PAGING_RESUME
:

59 
	`p2m_mem_·gšg_»sume
(
p2m
);

60 
rc
 = 0;

65 
rc
 = -
ENOSYS
;

69  
rc
;

70 
	}
}

	@mm/mem_sharing.c

23 
	~<asm/·ge.h
>

24 
	~<asm/¡ršg.h
>

25 
	~<asm/p2m.h
>

26 
	~<asm/mem_ev’t.h
>

27 
	~<asm/©omic.h
>

28 
	~<x’/domaš_·ge.h
>

29 
	~<x’/ty³s.h
>

30 
	~<x’/¥šlock.h
>

31 
	~<x’/mm.h
>

32 
	~<x’/sched.h
>

35 
	#MEM_SHARING_AUDIT
 0

	)

37 #ià
MEM_SHARING_AUDIT


38 
mem_sh¬šg_aud™
();

39 
	#MEM_SHARING_DEBUG
(
_f
, 
_a
...) \

40 
	`debugŒaû_´štk
("mem_sh¬šg_debug: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

42 
	#mem_sh¬šg_aud™
(èdØ{} 0)

	)

45 
	#mem_sh¬šg_’abËd
(
d
) \

46 (
	`is_hvm_domaš
(
d
è&& (d)->
¬ch
.
hvm_domaš
.
mem_sh¬šg_’abËd
)

	)

48 #undeà
mâ_to_·ge


49 
	#mâ_to_·ge
(
_m
è
	`__mâ_to_·ge
(
	`mâ_x
(_m))

	)

50 #undeà
mâ_v®id


51 
	#mâ_v®id
(
_mâ
è
	`__mâ_v®id
(
	`mâ_x
(_mâ))

	)

52 #undeà
·ge_to_mâ


53 
	#·ge_to_mâ
(
_pg
è
	`_mâ
(
	`__·ge_to_mâ
(_pg))

	)

55 
shr_hªdË_t
 
	gÃxt_hªdË
 = 1;

56 
©omic_t
 
	gÄ_§ved_mâs
 = 
ATOMIC_INIT
(0);

58 
	sshr_hash_’Œy


60 
shr_hªdË_t
 
	mhªdË
;

61 
mâ_t
 
	mmâ
;

62 
shr_hash_’Œy
 *
	mÃxt
;

63 
li¡_h—d
 
	mgâs
;

64 } 
	tshr_hash_’Œy_t
;

66 
	#SHR_HASH_LENGTH
 1000

	)

67 
shr_hash_’Œy_t
 *
	gshr_hash
[
SHR_HASH_LENGTH
];

69 
	sgâ_šfo


71 
	mgâ
;

72 
domid_t
 
	mdomaš
;

73 
li¡_h—d
 
	mli¡
;

74 } 
	tgâ_šfo_t
;

76 
	sshr_lock


78 
¥šlock_t
 
	mlock
;

79 
	mlock”
;

80 cÚ¡ *
	mlock”_funùiÚ
;

81 } 
	tshr_lock_t
;

82 
shr_lock_t
 
	gshr_lock
;

85 
šlše
 
	$li¡_has_Úe_’Œy
(
li¡_h—d
 *
h—d
)

87  (
h—d
->
Ãxt
 != head) && (head->next->next == head);

88 
	}
}

90 
šlše
 
gâ_šfo
* 
	$gâ_g‘_šfo
(
li¡_h—d
 *
li¡
)

92  
	`li¡_’Œy
(
li¡
->
Ãxt
, 
gâ_šfo
,†ist);

93 
	}
}

95 
	#shr_lock_š™
(
_i
) \

97 
	`¥š_lock_š™
(&
shr_lock
.
lock
); \

98 
shr_lock
.
lock”
 = -1; \

99 
shr_lock
.
lock”_funùiÚ
 = "nobody"; \

100 } 0)

	)

102 
	#shr_locked_by_me
(
_i
) \

103 (
cu¼’t
->
´oûssÜ
 =ğ
shr_lock
.
lock”
)

	)

105 
	#shr_lock
(
_i
) \

107 iàĞ
	`uÆik–y
(
shr_lock
.
lock”
 =ğ
cu¼’t
->
´oûssÜ
) ) \

109 
	`´štk
("Error: shr†ock held by %s\n", \

110 
shr_lock
.
lock”_funùiÚ
); \

111 
	`BUG
(); \

113 
	`¥š_lock
(&
shr_lock
.
lock
); \

114 
	`ASSERT
(
shr_lock
.
lock”
 == -1); \

115 
shr_lock
.
lock”
 = 
cu¼’t
->
´oûssÜ
; \

116 
shr_lock
.
lock”_funùiÚ
 = 
__func__
; \

117 } 0)

	)

119 
	#shr_uÆock
(
_i
) \

121 
	`ASSERT
(
shr_lock
.
lock”
 =ğ
cu¼’t
->
´oûssÜ
); \

122 
shr_lock
.
lock”
 = -1; \

123 
shr_lock
.
lock”_funùiÚ
 = "nobody"; \

124 
	`¥š_uÆock
(&
shr_lock
.
lock
); \

125 } 0)

	)

127 
	$mem_sh¬šg_hash_š™
()

129 
i
;

131 
	`shr_lock_š™
();

132 
i
=0; i<
SHR_HASH_LENGTH
; i++)

133 
shr_hash
[
i
] = 
NULL
;

134 
	}
}

136 
shr_hash_’Œy_t
 *
	$mem_sh¬šg_hash_®loc
()

138  
	`xm®loc
(
shr_hash_’Œy_t
);

139 
	}
}

141 
	$mem_sh¬šg_hash_de¡roy
(
shr_hash_’Œy_t
 *
e
)

143 
	`xä“
(
e
);

144 
	}
}

146 
gâ_šfo_t
 *
	$mem_sh¬šg_gâ_®loc
()

148  
	`xm®loc
(
gâ_šfo_t
);

149 
	}
}

151 
	$mem_sh¬šg_gâ_de¡roy
(
gâ_šfo_t
 *
gâ
, 
was_sh¬ed
)

154 if(
was_sh¬ed
)

156 
domaš
 *
d
 = 
	`g‘_domaš_by_id
(
gâ
->domain);

159 if(
d
)

161 
	`©omic_dec
(&
d
->
shr_·ges
);

162 
	`put_domaš
(
d
);

165 
	`xä“
(
gâ
);

166 
	}
}

168 
shr_hash_’Œy_t
* 
	$mem_sh¬šg_hash_lookup
(
shr_hªdË_t
 
hªdË
)

170 
shr_hash_’Œy_t
 *
e
;

172 
e
 = 
shr_hash
[
hªdË
 % 
SHR_HASH_LENGTH
];

173 
e
 !ğ
NULL
)

175 if(
e
->
hªdË
 == handle)

176  
e
;

177 
e
 =ƒ->
Ãxt
;

180  
NULL
;

181 
	}
}

183 
shr_hash_’Œy_t
* 
	$mem_sh¬šg_hash_š£¹
(
shr_hªdË_t
 
hªdË
, 
mâ_t
 
mâ
)

185 
shr_hash_’Œy_t
 *
e
, **
“
;

187 
e
 = 
	`mem_sh¬šg_hash_®loc
();

188 if(
e
 =ğ
NULL
)  NULL;

189 
e
->
hªdË
 = handle;

190 
e
->
mâ
 = mfn;

191 
“
 = &
shr_hash
[
hªdË
 % 
SHR_HASH_LENGTH
];

192 
e
->
Ãxt
 = *
“
;

193 *
“
 = 
e
;

194  
e
;

195 
	}
}

197 
	$mem_sh¬šg_hash_d–‘e
(
shr_hªdË_t
 
hªdË
)

199 
shr_hash_’Œy_t
 **
µ»v
, *
e
;

201 
µ»v
 = &
shr_hash
[
hªdË
 % 
SHR_HASH_LENGTH
];

202 
e
 = *
µ»v
;

203 
e
 !ğ
NULL
)

205 if(
e
->
hªdË
 == handle)

207 *
µ»v
 = 
e
->
Ãxt
;

208 
	`mem_sh¬šg_hash_de¡roy
(
e
);

211 
µ»v
 = &
e
->
Ãxt
;

212 
e
 =ƒ->
Ãxt
;

214 
	`´štk
("Could‚Ù fšd sh¸’Œy fÜ hªdË %"
PRIx64
"\n", 
hªdË
);

215 
	`BUG
();

216 
	}
}

218 #ià
MEM_SHARING_AUDIT


219 
	$mem_sh¬šg_aud™
()

221 
shr_hash_’Œy_t
 *
e
;

222 
li¡_h—d
 *
Ë
;

223 
gâ_šfo_t
 *
g
;

224 
buck‘
;

225 
·ge_šfo
 *
pg
;

227 
	`shr_lock
();

229 
buck‘
=0; buck‘ < 
SHR_HASH_LENGTH
; bucket++)

231 
e
 = 
shr_hash
[
buck‘
];

233 
e
 !ğ
NULL
)

235 
Ä_gâs
=0;

238 
pg
 = 
	`mâ_to_·ge
(
e
->
mâ
);

239 if((
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_sh¬ed_·ge
)

240 
	`MEM_SHARING_DEBUG
("mfn %lx‚ot shared, but inhe hash!\n",

241 
	`mâ_x
(
e
->
mâ
));

242 if(
	`·ge_g‘_owÃr
(
pg
è!ğ
dom_cow
)

243 
	`MEM_SHARING_DEBUG
("mfn %lx shared, but wrong owner (%d)!\n",

244 
	`mâ_x
(
e
->
mâ
),

245 
	`·ge_g‘_owÃr
(
pg
)->
domaš_id
);

246 if(
e
->
hªdË
 !ğ
pg
->
shr_hªdË
)

247 
	`MEM_SHARING_DEBUG
("mfn %lx shared, but wrong handle "

249 
	`mâ_x
(
e
->
mâ
), 
pg
->
shr_hªdË
,ƒ->
hªdË
);

251 
	`li¡_fÜ_—ch
(
Ë
, &
e
->
gâs
)

253 
domaš
 *
d
;

254 
p2m_domaš
 *
p2m
;

255 
p2m_ty³_t
 
t
;

256 
mâ_t
 
mâ
;

258 
g
 = 
	`li¡_’Œy
(
Ë
, 
gâ_šfo
, 
li¡
);

259 
d
 = 
	`g‘_domaš_by_id
(
g
->
domaš
);

260 if(
d
 =ğ
NULL
)

262 
	`MEM_SHARING_DEBUG
("Unknow dom: %d, for PFN=%lx, MFN=%lx\n",

263 
g
->
domaš
, g->
gâ
, 
	`mâ_x
(
e
->
mâ
));

266 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

267 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
g
->
gâ
, &
t
);

268 if(
	`mâ_x
(
mâ
è!ğmâ_x(
e
->mfn))

269 
	`MEM_SHARING_DEBUG
("Incorrect P2M for d=%d, PFN=%lx."

271 
g
->
domaš
, g->
gâ
, 
	`mâ_x
(
e
->
mâ
),

272 
	`mâ_x
(
mâ
));

273 if(
t
 !ğ
p2m_¿m_sh¬ed
)

274 
	`MEM_SHARING_DEBUG
("Incorrect P2Mype for d=%d, PFN=%lx."

276 
g
->
domaš
, g->
gâ
, 
	`mâ_x
(
e
->
mâ
),

277 
p2m_¿m_sh¬ed
, 
t
);

278 
	`put_domaš
(
d
);

279 
Ä_gâs
++;

281 if(
Ä_gâs
 !ğ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
))

282 
	`MEM_SHARING_DEBUG
("Mismatched counts for MFN=%lx."

284 
	`mâ_x
(
e
->
mâ
), 
Ä_gâs
,

285 (
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
));

286 
e
 =ƒ->
Ãxt
;

290 
	`shr_uÆock
();

291 
	}
}

295 
·ge_šfo
* 
	$mem_sh¬šg_®loc_·ge
(
domaš
 *
d
,

296 
gâ
,

297 
mu¡_sucûed
)

299 
·ge_šfo
* 
·ge
;

300 
vıu
 *
v
 = 
cu¼’t
;

301 
mem_ev’t_»que¡_t
 
»q
;

303 
·ge
 = 
	`®loc_domh—p_·ge
(
d
, 0);

304 if(
·ge
 !ğ
NULL
) …age;

306 
	`mem£t
(&
»q
, 0, (req));

307 
»q
.
ty³
 = 
MEM_EVENT_TYPE_SHARED
;

309 if(
mu¡_sucûed
)

314 
	`BUG
();

320 
	`ASSERT
(
v
->
domaš
->
domaš_id
 =ğ
d
->domain_id);

321 
	`vıu_·u£_nosync
(
v
);

322 
»q
.
æags
 |ğ
MEM_EVENT_FLAG_VCPU_PAUSED
;

326 if(
	`mem_ev’t_check_ršg
(
d
)è 
·ge
;

328 
»q
.
gâ
 = gfn;

329 
»q
.
p2mt
 = 
p2m_¿m_sh¬ed
;

330 
»q
.
vıu_id
 = 
v
->vcpu_id;

331 
	`mem_ev’t_put_»que¡
(
d
, &
»q
);

333  
·ge
;

334 
	}
}

336 
	$mem_sh¬šg_g‘_Ä_§ved_mâs
()

338  ()
	`©omic_»ad
(&
Ä_§ved_mâs
);

339 
	}
}

341 
	$mem_sh¬šg_sh¬šg_»sume
(
domaš
 *
d
)

343 
mem_ev’t_»¥Ú£_t
 
r¥
;

346 
	`mem_ev’t_g‘_»¥Ú£
(
d
, &
r¥
);

349 ifĞ
r¥
.
æags
 & 
MEM_EVENT_FLAG_VCPU_PAUSED
 )

350 
	`vıu_uÅau£
(
d
->
vıu
[
r¥
.
vıu_id
]);

353 
	}
}

355 
	$mem_sh¬šg_debug_mâ
(
mâ
)

357 
·ge_šfo
 *
·ge
;

359 if(!
	`mâ_v®id
(
	`_mâ
(
mâ
)))

361 
	`´štk
("Inv®id MFN=%lx\n", 
mâ
);

364 
·ge
 = 
	`mâ_to_·ge
(
	`_mâ
(
mâ
));

366 
	`´štk
("Debug…age: MFN=%lx is ci=%lx,i=%lx, owner_id=%d\n",

367 
	`mâ_x
(
	`·ge_to_mâ
(
·ge
)),

368 
·ge
->
couÁ_šfo
,

369 
·ge
->
u
.
šu£
.
ty³_šfo
,

370 
	`·ge_g‘_owÃr
(
·ge
)->
domaš_id
);

373 
	}
}

375 
	$mem_sh¬šg_debug_gâ
(
domaš
 *
d
, 
gâ
)

377 
p2m_ty³_t
 
p2mt
;

378 
mâ_t
 
mâ
;

379 
·ge_šfo
 *
·ge
;

381 
mâ
 = 
	`gâ_to_mâ
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
, &
p2mt
);

382 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

384 
	`´štk
("Debug for domain=%d, gfn=%lx, ",

385 
d
->
domaš_id
,

386 
gâ
);

387  
	`mem_sh¬šg_debug_mâ
(
	`mâ_x
(
mâ
));

388 
	}
}

390 
	#SHGNT_PER_PAGE_V1
 (
PAGE_SIZE
 / (
g¿Á_’Œy_v1_t
))

	)

391 
	#sh¬ed_’Œy_v1
(
t
, 
e
) \

392 ((
t
)->
sh¬ed_v1
[(
e
)/
SHGNT_PER_PAGE_V1
][Ó)%SHGNT_PER_PAGE_V1])

	)

393 
	#SHGNT_PER_PAGE_V2
 (
PAGE_SIZE
 / (
g¿Á_’Œy_v2_t
))

	)

394 
	#sh¬ed_’Œy_v2
(
t
, 
e
) \

395 ((
t
)->
sh¬ed_v2
[(
e
)/
SHGNT_PER_PAGE_V2
][Ó)%SHGNT_PER_PAGE_V2])

	)

396 
	#STGNT_PER_PAGE
 (
PAGE_SIZE
 / (
g¿Á_¡©us_t
))

	)

397 
	#¡©us_’Œy
(
t
, 
e
) \

398 ((
t
)->
¡©us
[(
e
)/
STGNT_PER_PAGE
][Ó)%STGNT_PER_PAGE])

	)

400 
g¿Á_’Œy_h—d”_t
 *

401 
	$sh¬ed_’Œy_h—d”
(
g¿Á_bË
 *
t
, 
g¿Á_»f_t
 
»f
)

403 
	`ASSERT
(
t
->
gt_v”siÚ
 != 0);

404 ià(
t
->
gt_v”siÚ
 == 1)

405  (
g¿Á_’Œy_h—d”_t
*)&
	`sh¬ed_’Œy_v1
(
t
, 
»f
);

407  &
	`sh¬ed_’Œy_v2
(
t
, 
»f
).
hdr
;

408 
	}
}

410 
	$mem_sh¬šg_g»f_to_gâ
(
domaš
 *
d
,

411 
g¿Á_»f_t
 
»f
,

412 *
gâ
)

414 if(
d
->
g¿Á_bË
->
gt_v”siÚ
 < 1)

417 ià(
d
->
g¿Á_bË
->
gt_v”siÚ
 == 1)

419 
g¿Á_’Œy_v1_t
 *
sha1
;

420 
sha1
 = &
	`sh¬ed_’Œy_v1
(
d
->
g¿Á_bË
, 
»f
);

421 *
gâ
 = 
sha1
->
äame
;

426 
g¿Á_’Œy_v2_t
 *
sha2
;

427 
sha2
 = &
	`sh¬ed_’Œy_v2
(
d
->
g¿Á_bË
, 
»f
);

428 *
gâ
 = 
sha2
->
fuÎ_·ge
.
äame
;

433 
	}
}

439 
	$mem_sh¬šg_gâ_accouÁ
(
gâ_šfo
 *
gâ
, 
sh¬šg
)

441 
domaš
 *
d
;

449 if(
	`li¡_has_Úe_’Œy
(&
gâ
->
li¡
))

451 
d
 = 
	`g‘_domaš_by_id
(
gâ
->
domaš
);

452 
	`BUG_ON
(!
d
);

453 if(
sh¬šg
)

454 
	`©omic_šc
(&
d
->
shr_·ges
);

456 
	`©omic_dec
(&
d
->
shr_·ges
);

457 
	`put_domaš
(
d
);

461 
	`mem_sh¬šg_aud™
();

464 
	}
}

466 
	$mem_sh¬šg_debug_g»f
(
domaš
 *
d
, 
g¿Á_»f_t
 
»f
)

468 
g¿Á_’Œy_h—d”_t
 *
shah
;

469 
ušt16_t
 
¡©us
;

470 
gâ
;

472 if(
d
->
g¿Á_bË
->
gt_v”siÚ
 < 1)

474 
	`´štk
("Askedo debug [dom=%d,gref=%d], but‚ot yet inited.\n",

475 
d
->
domaš_id
, 
»f
);

478 
	`mem_sh¬šg_g»f_to_gâ
(
d
, 
»f
, &
gâ
);

479 
shah
 = 
	`sh¬ed_’Œy_h—d”
(
d
->
g¿Á_bË
, 
»f
);

480 ià(
d
->
g¿Á_bË
->
gt_v”siÚ
 == 1)

481 
¡©us
 = 
shah
->
æags
;

483 
¡©us
 = 
	`¡©us_’Œy
(
d
->
g¿Á_bË
, 
»f
);

485 
	`´štk
("==> Grant [dom=%d,ref=%d], status=%x. ",

486 
d
->
domaš_id
, 
»f
, 
¡©us
);

488  
	`mem_sh¬šg_debug_gâ
(
d
, 
gâ
);

489 
	}
}

491 
	$mem_sh¬šg_nomš©e_·ge
(
p2m_domaš
 *
p2m
,

492 
gâ
,

493 
ex³ùed_»fút
,

494 
shr_hªdË_t
 *
phªdË
)

496 
p2m_ty³_t
 
p2mt
;

497 
mâ_t
 
mâ
;

498 
·ge_šfo
 *
·ge
;

499 
»t
;

500 
shr_hªdË_t
 
hªdË
;

501 
shr_hash_’Œy_t
 *
hash_’Œy
;

502 
gâ_šfo
 *gfn_info;

503 
domaš
 *
d
 = 
p2m
->domain;

505 *
phªdË
 = 0UL;

507 
	`shr_lock
();

508 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
);

511 
»t
 = -
EINVAL
;

512 ià(!
	`mâ_v®id
(
mâ
))

513 
out
;

516 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

517 ià(
	`p2m_is_sh¬ed
(
p2mt
)) {

518 *
phªdË
 = 
·ge
->
shr_hªdË
;

519 
»t
 = 0;

520 
out
;

524 ià(!
	`p2m_is_sh¬abË
(
p2mt
))

525 
out
;

528 
»t
 = 
	`·ge_make_sh¬abË
(
d
, 
·ge
, 
ex³ùed_»fút
);

529 if(
»t
)

530 
out
;

533 
»t
 = -
ENOMEM
;

534 
hªdË
 = 
Ãxt_hªdË
++;

535 if((
hash_’Œy
 = 
	`mem_sh¬šg_hash_š£¹
(
hªdË
, 
mâ
)è=ğ
NULL
)

537 
out
;

539 if((
gâ_šfo
 = 
	`mem_sh¬šg_gâ_®loc
()è=ğ
NULL
)

541 
	`mem_sh¬šg_hash_de¡roy
(
hash_’Œy
);

542 
out
;

546 if(
	`p2m_chªge_ty³
(
p2m
, 
gâ
, 
p2mt
, 
p2m_¿m_sh¬ed
) !=…2mt)

552 
	`BUG_ON
(
	`·ge_make_´iv©e
(
d
, 
·ge
) != 0);

553 
	`mem_sh¬šg_hash_de¡roy
(
hash_’Œy
);

554 
	`mem_sh¬šg_gâ_de¡roy
(
gâ_šfo
, 0);

555 
out
;

559 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
mâ
), 
SHARED_M2P_ENTRY
);

561 
	`INIT_LIST_HEAD
(&
hash_’Œy
->
gâs
);

562 
	`INIT_LIST_HEAD
(&
gâ_šfo
->
li¡
);

563 
	`li¡_add
(&
gâ_šfo
->
li¡
, &
hash_’Œy
->
gâs
);

564 
gâ_šfo
->
gâ
 = gfn;

565 
gâ_šfo
->
domaš
 = 
d
->
domaš_id
;

566 
·ge
->
shr_hªdË
 = 
hªdË
;

567 *
phªdË
 = 
hªdË
;

569 
»t
 = 0;

571 
out
:

572 
	`shr_uÆock
();

573  
»t
;

574 
	}
}

576 
	$mem_sh¬šg_sh¬e_·ges
(
shr_hªdË_t
 
sh
, shr_hªdË_ˆ
ch
)

578 
shr_hash_’Œy_t
 *
£
, *
û
;

579 
·ge_šfo
 *
¥age
, *
ıage
;

580 
li¡_h—d
 *
Ë
, *
‹
;

581 
gâ_šfo
 *
gâ
;

582 
domaš
 *
d
;

583 
»t
;

585 
	`shr_lock
();

587 
»t
 = 
XEN_DOMCTL_MEM_SHARING_S_HANDLE_INVALID
;

588 
£
 = 
	`mem_sh¬šg_hash_lookup
(
sh
);

589 if(
£
 =ğ
NULL
è
”r_out
;

590 
»t
 = 
XEN_DOMCTL_MEM_SHARING_C_HANDLE_INVALID
;

591 
û
 = 
	`mem_sh¬šg_hash_lookup
(
ch
);

592 if(
û
 =ğ
NULL
è
”r_out
;

593 
¥age
 = 
	`mâ_to_·ge
(
£
->
mâ
);

594 
ıage
 = 
	`mâ_to_·ge
(
û
->
mâ
);

596 
	`mem_sh¬šg_gâ_accouÁ
(
	`gâ_g‘_šfo
(&
û
->
gâs
), 1);

597 
	`mem_sh¬šg_gâ_accouÁ
(
	`gâ_g‘_šfo
(&
£
->
gâs
), 1);

598 
	`li¡_fÜ_—ch_§ã
(
Ë
, 
‹
, &
û
->
gâs
)

600 
gâ
 = 
	`li¡_’Œy
(
Ë
, 
gâ_šfo
, 
li¡
);

603 
	`BUG_ON
(!
	`g‘_·ge_ªd_ty³
(
¥age
, 
dom_cow
, 
PGT_sh¬ed_·ge
));

605 
	`li¡_d–
(&
gâ
->
li¡
);

606 
d
 = 
	`g‘_domaš_by_id
(
gâ
->
domaš
);

607 
	`BUG_ON
(!
d
);

608 
	`BUG_ON
(
	`£t_sh¬ed_p2m_’Œy
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
->gâ, 
£
->
mâ
) == 0);

609 
	`put_domaš
(
d
);

610 
	`li¡_add
(&
gâ
->
li¡
, &
£
->
gâs
);

611 
	`put_·ge_ªd_ty³
(
ıage
);

613 
	`ASSERT
(
	`li¡_em±y
(&
û
->
gâs
));

614 
	`mem_sh¬šg_hash_d–‘e
(
ch
);

615 
	`©omic_šc
(&
Ä_§ved_mâs
);

617 if(
	`‹¡_ªd_ş—r_b™
(
_PGC_®loÿ‹d
, &
ıage
->
couÁ_šfo
))

618 
	`put_·ge
(
ıage
);

619 
»t
 = 0;

621 
”r_out
:

622 
	`shr_uÆock
();

624  
»t
;

625 
	}
}

627 
	$mem_sh¬šg_unsh¬e_·ge
(
p2m_domaš
 *
p2m
,

628 
gâ
,

629 
ušt16_t
 
æags
)

631 
p2m_ty³_t
 
p2mt
;

632 
mâ_t
 
mâ
;

633 
·ge_šfo
 *
·ge
, *
Şd_·ge
;

634 *
s
, *
t
;

635 
»t
, 
Ï¡_gâ
;

636 
shr_hash_’Œy_t
 *
hash_’Œy
;

637 
gâ_šfo
 *gâ_šfØğ
NULL
;

638 
shr_hªdË_t
 
hªdË
;

639 
li¡_h—d
 *
Ë
;

640 
domaš
 *
d
 = 
p2m
->domain;

642 
	`mem_sh¬šg_aud™
();

644 
	`shr_lock
();

646 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
);

649 ià(!
	`p2m_is_sh¬ed
(
p2mt
)) {

650 
	`shr_uÆock
();

654 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

655 
hªdË
 = 
·ge
->
shr_hªdË
;

657 
hash_’Œy
 = 
	`mem_sh¬šg_hash_lookup
(
hªdË
);

658 
	`li¡_fÜ_—ch
(
Ë
, &
hash_’Œy
->
gâs
)

660 
gâ_šfo
 = 
	`li¡_’Œy
(
Ë
, gâ_šfo, 
li¡
);

661 if((
gâ_šfo
->
gâ
 =ğgâè&& (gâ_šfo->
domaš
 =ğ
d
->
domaš_id
))

662 
gâ_found
;

664 
	`´štk
("Could‚Ù fšd gâ_šfØfÜ sh¬ed gâ: %lx\n", 
gâ
);

665 
	`BUG
();

666 
gâ_found
:

669 
	`li¡_d–
(&
gâ_šfo
->
li¡
);

670 
Ï¡_gâ
 = 
	`li¡_em±y
(&
hash_’Œy
->
gâs
);

674 if(
æags
 & 
MEM_SHARING_DESTROY_GFN
)

676 
	`mem_sh¬šg_gâ_de¡roy
(
gâ_šfo
, !
Ï¡_gâ
);

677 if(
Ï¡_gâ
)

678 
	`mem_sh¬šg_hash_d–‘e
(
hªdË
);

682 
	`©omic_dec
(&
Ä_§ved_mâs
);

683 
	`shr_uÆock
();

684 
	`put_·ge_ªd_ty³
(
·ge
);

685 if(
Ï¡_gâ
 &&

686 
	`‹¡_ªd_ş—r_b™
(
_PGC_®loÿ‹d
, &
·ge
->
couÁ_šfo
))

687 
	`put_·ge
(
·ge
);

691 
»t
 = 
	`·ge_make_´iv©e
(
d
, 
·ge
);

692 
	`BUG_ON
(
Ï¡_gâ
 & 
»t
);

693 if(
»t
 =ğ0è
´iv©e_·ge_found
;

695 
Şd_·ge
 = 
·ge
;

696 
·ge
 = 
	`mem_sh¬šg_®loc_·ge
(
d
, 
gâ
, 
æags
 & 
MEM_SHARING_MUST_SUCCEED
);

697 
	`BUG_ON
(!
·ge
 && (
æags
 & 
MEM_SHARING_MUST_SUCCEED
));

698 if(!
·ge
)

702 
	`li¡_add
(&
gâ_šfo
->
li¡
, &
hash_’Œy
->
gâs
);

703 
	`shr_uÆock
();

704  -
ENOMEM
;

707 
s
 = 
	`m­_domaš_·ge
(
	`__·ge_to_mâ
(
Şd_·ge
));

708 
t
 = 
	`m­_domaš_·ge
(
	`__·ge_to_mâ
(
·ge
));

709 
	`memıy
(
t
, 
s
, 
PAGE_SIZE
);

710 
	`unm­_domaš_·ge
(
s
);

711 
	`unm­_domaš_·ge
(
t
);

713 
	`BUG_ON
(
	`£t_sh¬ed_p2m_’Œy
(
p2m
, 
gâ
, 
	`·ge_to_mâ
(
·ge
)) == 0);

714 
	`put_·ge_ªd_ty³
(
Şd_·ge
);

716 
´iv©e_·ge_found
:

718 
	`mem_sh¬šg_gâ_de¡roy
(
gâ_šfo
, !
Ï¡_gâ
);

719 if(
Ï¡_gâ
)

720 
	`mem_sh¬šg_hash_d–‘e
(
hªdË
);

722 
	`©omic_dec
(&
Ä_§ved_mâs
);

724 if(
	`p2m_chªge_ty³
(
p2m
, 
gâ
, 
p2m_¿m_sh¬ed
, 
p2m_¿m_rw
) !=

725 
p2m_¿m_sh¬ed
)

727 
	`´štk
("Could‚ot change…2mype.\n");

728 
	`BUG
();

731 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
	`·ge_to_mâ
(
·ge
)), 
gâ
);

733 
	`shr_uÆock
();

735 
	}
}

737 
	$mem_sh¬šg_domùl
(
domaš
 *
d
, 
x’_domùl_mem_sh¬šg_İ_t
 *
mec
)

739 
rc
;

741 
mec
->
İ
)

743 
XEN_DOMCTL_MEM_SHARING_OP_CONTROL
:

745 
d
->
¬ch
.
hvm_domaš
.
mem_sh¬šg_’abËd
 = 
mec
->
u
.
’abË
;

746 
	`mem_sh¬šg_aud™
();

747 
rc
 = 0;

751 
XEN_DOMCTL_MEM_SHARING_OP_NOMINATE_GFN
:

753 
gâ
 = 
mec
->
u
.
nomš©e
.u.gfn;

754 
shr_hªdË_t
 
hªdË
;

755 if(!
	`mem_sh¬šg_’abËd
(
d
))

756  -
EINVAL
;

757 
rc
 = 
	`mem_sh¬šg_nomš©e_·ge
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
, 0, &
hªdË
);

758 
mec
->
u
.
nomš©e
.
hªdË
 = handle;

759 
	`mem_sh¬šg_aud™
();

763 
XEN_DOMCTL_MEM_SHARING_OP_NOMINATE_GREF
:

765 
g¿Á_»f_t
 
g»f
 = 
mec
->
u
.
nomš©e
.u.
g¿Á_»f
;

766 
gâ
;

767 
shr_hªdË_t
 
hªdË
;

769 if(!
	`mem_sh¬šg_’abËd
(
d
))

770  -
EINVAL
;

771 if(
	`mem_sh¬šg_g»f_to_gâ
(
d
, 
g»f
, &
gâ
) < 0)

772  -
EINVAL
;

773 
rc
 = 
	`mem_sh¬šg_nomš©e_·ge
(
	`p2m_g‘_ho¡p2m
(
d
),

774 
gâ
, 3, &
hªdË
);

775 
mec
->
u
.
nomš©e
.
hªdË
 = handle;

776 
	`mem_sh¬šg_aud™
();

780 
XEN_DOMCTL_MEM_SHARING_OP_SHARE
:

782 
shr_hªdË_t
 
sh
 = 
mec
->
u
.
sh¬e
.
sourû_hªdË
;

783 
shr_hªdË_t
 
ch
 = 
mec
->
u
.
sh¬e
.
ş›Á_hªdË
;

784 
rc
 = 
	`mem_sh¬šg_sh¬e_·ges
(
sh
, 
ch
);

785 
	`mem_sh¬šg_aud™
();

789 
XEN_DOMCTL_MEM_SHARING_OP_RESUME
:

791 if(!
	`mem_sh¬šg_’abËd
(
d
))

792  -
EINVAL
;

793 
	`mem_sh¬šg_aud™
();

794 
rc
 = 
	`mem_sh¬šg_sh¬šg_»sume
(
d
);

798 
XEN_DOMCTL_MEM_SHARING_OP_DEBUG_GFN
:

800 
gâ
 = 
mec
->
u
.
debug
.u.gfn;

801 
rc
 = 
	`mem_sh¬šg_debug_gâ
(
d
, 
gâ
);

802 
	`mem_sh¬šg_aud™
();

806 
XEN_DOMCTL_MEM_SHARING_OP_DEBUG_MFN
:

808 
mâ
 = 
mec
->
u
.
debug
.u.mfn;

809 
rc
 = 
	`mem_sh¬šg_debug_mâ
(
mâ
);

810 
	`mem_sh¬šg_aud™
();

814 
XEN_DOMCTL_MEM_SHARING_OP_DEBUG_GREF
:

816 
g¿Á_»f_t
 
g»f
 = 
mec
->
u
.
debug
.u.gref;

817 
rc
 = 
	`mem_sh¬šg_debug_g»f
(
d
, 
g»f
);

818 
	`mem_sh¬šg_aud™
();

823 
rc
 = -
ENOSYS
;

827  
rc
;

828 
	}
}

830 
	$mem_sh¬šg_š™
()

832 
	`´štk
("Initing memory sharing.\n");

833 
	`mem_sh¬šg_hash_š™
();

834 
	}
}

	@mm/p2m.c

27 
	~<asm/domaš.h
>

28 
	~<asm/·ge.h
>

29 
	~<asm/·gšg.h
>

30 
	~<asm/p2m.h
>

31 
	~<asm/hvm/vmx/vmx.h
>

32 
	~<x’/iommu.h
>

33 
	~<asm/mem_ev’t.h
>

34 
	~<public/mem_ev’t.h
>

35 
	~<asm/mem_sh¬šg.h
>

36 
	~<x’/ev’t.h
>

39 
	#P2M_AUDIT
 0

	)

40 
	#P2M_DEBUGGING
 0

	)

43 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_h­_1gb
 = 1;

44 
boŞ—n_·¿m
("h­_1gb", 
İt_h­_1gb
);

46 
boŞ_t
 
__»ad_mo¡ly
 
	gİt_h­_2mb
 = 1;

47 
boŞ—n_·¿m
("h­_2mb", 
İt_h­_2mb
);

50 
	#P2M_PRINTK
(
_f
, 
_a
...) \

51 
	`debugŒaû_´štk
("p2m: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

52 
	#P2M_ERROR
(
_f
, 
_a
...) \

53 
	`´štk
("pgƒ¼Ü: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

54 #ià
P2M_DEBUGGING


55 
	#P2M_DEBUG
(
_f
, 
_a
...) \

56 
	`debugŒaû_´štk
("p2mdebug: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

58 
	#P2M_DEBUG
(
_f
, 
_a
...èdØ{ ()(_f); } 0)

	)

63 #undeà
mâ_to_·ge


64 
	#mâ_to_·ge
(
_m
è
	`__mâ_to_·ge
(
	`mâ_x
(_m))

	)

65 #undeà
mâ_v®id


66 
	#mâ_v®id
(
_mâ
è
	`__mâ_v®id
(
	`mâ_x
(_mâ))

	)

67 #undeà
·ge_to_mâ


68 
	#·ge_to_mâ
(
_pg
è
	`_mâ
(
	`__·ge_to_mâ
(_pg))

	)

72 
	#P2M_BASE_FLAGS
 \

73 (
_PAGE_PRESENT
 | 
_PAGE_USER
 | 
_PAGE_DIRTY
 | 
_PAGE_ACCESSED
)

	)

75 
	#SUPERPAGE_PAGES
 (1UL << 9)

	)

76 
	#su³½age_®igÃd
(
_x
è(((_x)&(
SUPERPAGE_PAGES
-1))==0)

	)

78 
	$p2m_ty³_to_æags
(
p2m_ty³_t
 
t
, 
mâ_t
 
mâ
)

80 
æags
;

81 #ifdeà
__x86_64__


82 
æags
 = ()(
t
 & 0x3fff) << 9;

84 
æags
 = (
t
 & 0x7UL) << 9;

86 #iâdeà
HAVE_GRANT_MAP_P2M


87 
	`BUG_ON
(
	`p2m_is_g¿Á
(
t
));

89 
t
)

91 
p2m_šv®id
:

93  
æags
;

94 
p2m_¿m_rw
:

95 
p2m_g¿Á_m­_rw
:

96  
æags
 | 
P2M_BASE_FLAGS
 | 
_PAGE_RW
;

97 
p2m_¿m_logdœty
:

98  
æags
 | 
P2M_BASE_FLAGS
;

99 
p2m_¿m_ro
:

100 
p2m_g¿Á_m­_ro
:

101  
æags
 | 
P2M_BASE_FLAGS
;

102 
p2m_¿m_sh¬ed
:

103  
æags
 | 
P2M_BASE_FLAGS
;

104 
p2m_mmio_dm
:

105  
æags
;

106 
p2m_mmio_dœeù
:

107 iàĞ!
	`¿nge£t_cÚšs_sšgËtÚ
(
mmio_ro_¿nges
, 
	`mâ_x
(
mâ
)) )

108 
æags
 |ğ
_PAGE_RW
;

109  
æags
 | 
P2M_BASE_FLAGS
 | 
_PAGE_PCD
;

110 
p2m_pİuÏ‹_Ú_demªd
:

111  
æags
;

113 
	}
}

115 #ià
P2M_AUDIT


116 
aud™_p2m
(
p2m_domaš
 *
p2m
, 
¡riù_m2p
);

118 
	#aud™_p2m
(
_p2m
, 
_m2p
èdØ{ ()(_p2m),(_m2p); } 0)

	)

124 
l1_pg’Œy_t
 *

125 
	$p2m_fšd_’Œy
(*
bË
, *
gâ_»mašd”
,

126 
gâ
, 
u32
 
shiá
, u32 
max
)

128 
u32
 
šdex
;

130 
šdex
 = *
gâ_»mašd”
 >> 
shiá
;

131 iàĞ
šdex
 >ğ
max
 )

133 
	`P2M_DEBUG
("gfn=0x%lx out of„ange "

135 
gâ
, *
gâ_»mašd”
, 
shiá
, 
šdex
, 
max
);

136  
NULL
;

138 *
gâ_»mašd”
 &ğ(1 << 
shiá
) - 1;

139  (
l1_pg’Œy_t
 *)
bË
 + 
šdex
;

140 
	}
}

142 
·ge_šfo
 *

143 
	$p2m_®loc_±p
(
p2m_domaš
 *
p2m
, 
ty³
)

145 
·ge_šfo
 *
pg
;

147 
	`ASSERT
(
p2m
);

148 
	`ASSERT
(
p2m
->
domaš
);

149 
	`ASSERT
(
p2m
->
domaš
->
¬ch
.
·gšg
.
®loc_·ge
);

150 
pg
 = 
p2m
->
domaš
->
¬ch
.
·gšg
.
	`®loc_·ge
(p2m->domain);

151 ià(
pg
 =ğ
NULL
)

152  
NULL
;

154 
	`·ge_li¡_add_
(
pg
, &
p2m
->
·ges
);

155 
pg
->
u
.
šu£
.
ty³_šfo
 = 
ty³
 | 1 | 
PGT_v®id©ed
;

157  
pg
;

158 
	}
}

161 
	$p2m_ä“_±p
(
p2m_domaš
 *
p2m
, 
·ge_šfo
 *
pg
)

163 
	`ASSERT
(
pg
);

164 
	`ASSERT
(
p2m
);

165 
	`ASSERT
(
p2m
->
domaš
);

166 
	`ASSERT
(
p2m
->
domaš
->
¬ch
.
·gšg
.
ä“_·ge
);

168 
	`·ge_li¡_d–
(
pg
, &
p2m
->
·ges
);

169 
p2m
->
domaš
->
¬ch
.
·gšg
.
	`ä“_·ge
Õ2m->domaš, 
pg
);

172 
	}
}

176 
	$p2m_ä“_’Œy
(
p2m_domaš
 *
p2m
, 
l1_pg’Œy_t
 *
p2m_’Œy
, 
·ge_Üd”
)

179 iàĞ
·ge_Üd”
 == 0

180 || !(
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PRESENT
)

181 || (
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PSE
) )

184 iàĞ
·ge_Üd”
 > 9 )

186 
l1_pg’Œy_t
 *
l3_bË
 = 
	`m­_domaš_·ge
(
	`l1e_g‘_pâ
(*
p2m_’Œy
));

187  
i
 = 0; i < 
L3_PAGETABLE_ENTRIES
; i++ )

188 
	`p2m_ä“_’Œy
(
p2m
, 
l3_bË
 + 
i
, 
·ge_Üd”
 - 9);

189 
	`unm­_domaš_·ge
(
l3_bË
);

192 
	`p2m_ä“_±p
(
p2m
, 
	`mâ_to_·ge
(
	`_mâ
(
	`l1e_g‘_pâ
(*
p2m_’Œy
))));

193 
	}
}

199 
	$p2m_Ãxt_Ëv–
(
p2m_domaš
 *
p2m
, 
mâ_t
 *
bË_mâ
, **
bË
,

200 *
gâ_»mašd”
, 
gâ
, 
u32
 
shiá
,

201 
u32
 
max
, 
ty³
)

203 
l1_pg’Œy_t
 *
l1_’Œy
;

204 
l1_pg’Œy_t
 *
p2m_’Œy
;

205 
l1_pg’Œy_t
 
Ãw_’Œy
;

206 *
Ãxt
;

207 
i
;

209 iàĞ!(
p2m_’Œy
 = 
	`p2m_fšd_’Œy
(*
bË
, 
gâ_»mašd”
, 
gâ
,

210 
shiá
, 
max
)) )

214 iàĞ!
	`l1e_g‘_æags
(*
p2m_’Œy
) )

216 
·ge_šfo
 *
pg
;

218 
pg
 = 
	`p2m_®loc_±p
(
p2m
, 
ty³
);

219 iàĞ
pg
 =ğ
NULL
 )

222 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
	`mâ_x
(
	`·ge_to_mâ
(
pg
)),

223 
__PAGE_HYPERVISOR
 | 
_PAGE_USER
);

225  
ty³
 ) {

226 
PGT_l3_·ge_bË
:

227 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

228 
p2m_’Œy
, *
bË_mâ
, 
Ãw_’Œy
, 4);

230 
PGT_l2_·ge_bË
:

231 #ià
CONFIG_PAGING_LEVELS
 == 3

233 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
	`mâ_x
(
	`·ge_to_mâ
(
pg
)), 
_PAGE_PRESENT
);

235 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

236 
p2m_’Œy
, *
bË_mâ
, 
Ãw_’Œy
, 3);

238 
PGT_l1_·ge_bË
:

239 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

240 
p2m_’Œy
, *
bË_mâ
, 
Ãw_’Œy
, 2);

243 
	`BUG
();

248 
	`ASSERT
(
	`l1e_g‘_æags
(*
p2m_’Œy
è& (
_PAGE_PRESENT
|
_PAGE_PSE
));

251 iàĞ
ty³
 =ğ
PGT_l2_·ge_bË
 && (
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PSE
) )

253 
æags
, 
pâ
;

254 
·ge_šfo
 *
pg
;

256 
pg
 = 
	`p2m_®loc_±p
(
p2m
, 
PGT_l2_·ge_bË
);

257 iàĞ
pg
 =ğ
NULL
 )

260 
æags
 = 
	`l1e_g‘_æags
(*
p2m_’Œy
);

261 
pâ
 = 
	`l1e_g‘_pâ
(*
p2m_’Œy
);

263 
l1_’Œy
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·ge_to_mâ
(
pg
)));

264  
i
 = 0; i < 
L2_PAGETABLE_ENTRIES
; i++ )

266 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
pâ
 + (
i
 * 
L1_PAGETABLE_ENTRIES
), 
æags
);

267 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

268 
l1_’Œy
+
i
, *
bË_mâ
, 
Ãw_’Œy
, 2);

270 
	`unm­_domaš_·ge
(
l1_’Œy
);

271 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
	`mâ_x
(
	`·ge_to_mâ
(
pg
)),

272 
__PAGE_HYPERVISOR
|
_PAGE_USER
);

273 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

274 
p2m_’Œy
, *
bË_mâ
, 
Ãw_’Œy
, 3);

279 iàĞ
ty³
 =ğ
PGT_l1_·ge_bË
 && (
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PSE
) )

281 
æags
, 
pâ
;

282 
·ge_šfo
 *
pg
;

284 
pg
 = 
	`p2m_®loc_±p
(
p2m
, 
PGT_l1_·ge_bË
);

285 iàĞ
pg
 =ğ
NULL
 )

290 
æags
 = 
	`l1e_g‘_æags
(*
p2m_’Œy
);

291 
pâ
 = 
	`l1e_g‘_pâ
(*
p2m_’Œy
);

292 iàĞ
pâ
 & 1 )

293 
pâ
 -= 1;

295 
æags
 &ğ~
_PAGE_PSE
;

297 
l1_’Œy
 = 
	`__m­_domaš_·ge
(
pg
);

298  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

300 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
pâ
 + 
i
, 
æags
);

301 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

302 
l1_’Œy
+
i
, *
bË_mâ
, 
Ãw_’Œy
, 1);

304 
	`unm­_domaš_·ge
(
l1_’Œy
);

306 
Ãw_’Œy
 = 
	`l1e_äom_pâ
(
	`mâ_x
(
	`·ge_to_mâ
(
pg
)),

307 
__PAGE_HYPERVISOR
|
_PAGE_USER
);

308 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

309 
p2m_’Œy
, *
bË_mâ
, 
Ãw_’Œy
, 2);

312 *
bË_mâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(*
p2m_’Œy
));

313 
Ãxt
 = 
	`m­_domaš_·ge
(
	`mâ_x
(*
bË_mâ
));

314 
	`unm­_domaš_·ge
(*
bË
);

315 *
bË
 = 
Ãxt
;

318 
	}
}

324 
£t_p2m_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
,

325 
·ge_Üd”
, 
p2m_ty³_t
 
p2mt
, 
p2m_acûss_t
 
p2ma
);

328 
	$p2m_pod_ÿche_add
(
p2m_domaš
 *
p2m
,

329 
·ge_šfo
 *
·ge
,

330 
Üd”
)

332 
i
;

333 
·ge_šfo
 *
p
;

334 
domaš
 *
d
 = 
p2m
->domain;

336 #iâdeà
NDEBUG


337 
mâ_t
 
mâ
;

339 
mâ
 = 
	`·ge_to_mâ
(
·ge
);

342 ifĞ
	`mâ_x
(
mâ
è& ((1 << 
Üd”
) - 1) )

344 
	`´štk
("%s: mfn %lx‚ot‡ligned order %lu! (mask %lx)\n",

345 
__func__
, 
	`mâ_x
(
mâ
), 
Üd”
, ((1UL << order) - 1));

349 
i
=0; i < 1 << 
Üd”
 ; i++) {

350 
domaš
 * 
od
;

352 
p
 = 
	`mâ_to_·ge
(
	`_mâ
(
	`mâ_x
(
mâ
è+ 
i
));

353 
od
 = 
	`·ge_g‘_owÃr
(
p
);

354 if(
od
 !ğ
d
)

356 
	`´štk
("%s: mfn %lxƒxpected owner d%d, got owner d%d!\n",

357 
__func__
, 
	`mâ_x
(
mâ
), 
d
->
domaš_id
,

358 
od
?od->
domaš_id
:-1);

364 
	`ASSERT
(
	`p2m_locked_by_me
(
p2m
));

371  
i
 = 0; i < (1 << 
Üd”
); i++ )

373 *
b
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·ge_to_mâ
(
·ge
)è+ 
i
);

374 
	`ş—r_·ge
(
b
);

375 
	`unm­_domaš_·ge
(
b
);

378 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

381 
i
=0; i < 1 << 
Üd”
 ; i++)

383 
p
 = 
·ge
 + 
i
;

384 
	`·ge_li¡_d–
(
p
, &
d
->
·ge_li¡
);

388 
Üd”
)

391 
	`·ge_li¡_add_
(
·ge
, &
p2m
->
pod
.
su³r
);

392 
p2m
->
pod
.
couÁ
 +ğ1 << 
Üd”
;

395 
	`·ge_li¡_add_
(
·ge
, &
p2m
->
pod
.
sšgË
);

396 
p2m
->
pod
.
couÁ
 += 1;

399 
	`BUG
();

404 
	`BUG_ON
Ğ
d
->
¬ch
.
»lmem
 !ğ
RELMEM_nÙ_¡¬‹d
 );

406 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

409 
	}
}

415 
·ge_šfo
 * 
	$p2m_pod_ÿche_g‘
(
p2m_domaš
 *
p2m
,

416 
Üd”
)

418 
·ge_šfo
 *
p
 = 
NULL
;

419 
i
;

421 iàĞ
Üd”
 =ğ9 && 
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) )

423  
NULL
;

425 iàĞ
Üd”
 =ğ0 && 
	`·ge_li¡_em±y
(&
p2m
->
pod
.
sšgË
) )

427 
mâ
;

428 
·ge_šfo
 *
q
;

430 
	`BUG_ON
Ğ
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) );

434 
p
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
pod
.
su³r
);

435 
mâ
 = 
	`mâ_x
(
	`·ge_to_mâ
(
p
));

437  
i
=0; i<
SUPERPAGE_PAGES
; i++ )

439 
q
 = 
	`mâ_to_·ge
(
	`_mâ
(
mâ
+
i
));

440 
	`·ge_li¡_add_
(
q
, &
p2m
->
pod
.
sšgË
);

444  
Üd”
 )

447 
	`BUG_ON
Ğ
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) );

448 
p
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
pod
.
su³r
);

449 
p2m
->
pod
.
couÁ
 -ğ1 << 
Üd”
;

452 
	`BUG_ON
Ğ
	`·ge_li¡_em±y
(&
p2m
->
pod
.
sšgË
) );

453 
p
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
pod
.
sšgË
);

454 
p2m
->
pod
.
couÁ
 -= 1;

457 
	`BUG
();

461  
i
 = 0 ; i < (1 << 
Üd”
); i++ )

463 
	`BUG_ON
(
	`·ge_g‘_owÃr
(
p
 + 
i
è!ğ
p2m
->
domaš
);

464 
	`·ge_li¡_add_
(
p
 + 
i
, &
p2m
->
domaš
->
·ge_li¡
);

467  
p
;

468 
	}
}

472 
	$p2m_pod_£t_ÿche_rg‘
(
p2m_domaš
 *
p2m
, 
pod_rg‘
, 
´“m±ibË
)

474 
domaš
 *
d
 = 
p2m
->domain;

475 
»t
 = 0;

478  
pod_rg‘
 > 
p2m
->
pod
.
couÁ
 )

480 
·ge_šfo
 * 
·ge
;

481 
Üd”
;

483 iàĞ(
pod_rg‘
 - 
p2m
->
pod
.
couÁ
è>ğ
SUPERPAGE_PAGES
 )

484 
Üd”
 = 9;

486 
Üd”
 = 0;

487 
»Œy
:

488 
·ge
 = 
	`®loc_domh—p_·ges
(
d
, 
Üd”
, 0);

489 iàĞ
	`uÆik–y
(
·ge
 =ğ
NULL
) )

491 iàĞ
Üd”
 == 9 )

494 
Üd”
 = 0;

495 
»Œy
;

498 
	`´štk
("%s: Unableo‡llocate domheap…age for…od cache.arget %lu cachesize %d\n",

499 
__func__
, 
pod_rg‘
, 
p2m
->
pod
.
couÁ
);

500 
»t
 = -
ENOMEM
;

501 
out
;

504 
	`p2m_pod_ÿche_add
(
p2m
, 
·ge
, 
Üd”
);

506 iàĞ
	`hy³rÿÎ_´“m±_check
(è&& 
´“m±ibË
 )

508 
»t
 = -
EAGAIN
;

509 
out
;

516  
pod_rg‘
 < 
p2m
->
pod
.
couÁ
 )

518 
·ge_šfo
 * 
·ge
;

519 
Üd”
, 
i
;

523 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

525 iàĞ(
p2m
->
pod
.
couÁ
 - 
pod_rg‘
è> 
SUPERPAGE_PAGES


526 && !
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) )

527 
Üd”
 = 9;

529 
Üd”
 = 0;

531 
·ge
 = 
	`p2m_pod_ÿche_g‘
(
p2m
, 
Üd”
);

533 
	`ASSERT
(
·ge
 !ğ
NULL
);

535 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

538  
i
 = 0 ; i < (1 << 
Üd”
) ; i++ )

541 iàĞ
	`uÆik–y
(!
	`g‘_·ge
(
·ge
+
i
, 
d
)) )

543 
	`gd´štk
(
XENLOG_INFO
, "Bad…agä“ fÜ domaš %u\n", 
d
->
domaš_id
);

544 
»t
 = -
EINVAL
;

545 
out
;

548 iàĞ
	`‹¡_ªd_ş—r_b™
(
_PGT_pšÃd
, &(
·ge
+
i
)->
u
.
šu£
.
ty³_šfo
) )

549 
	`put_·ge_ªd_ty³
(
·ge
+
i
);

551 iàĞ
	`‹¡_ªd_ş—r_b™
(
_PGC_®loÿ‹d
, &(
·ge
+
i
)->
couÁ_šfo
) )

552 
	`put_·ge
(
·ge
+
i
);

554 
	`put_·ge
(
·ge
+
i
);

556 iàĞ
	`hy³rÿÎ_´“m±_check
(è&& 
´“m±ibË
 )

558 
»t
 = -
EAGAIN
;

559 
out
;

564 
out
:

565  
»t
;

566 
	}
}

605 
	$p2m_pod_£t_mem_rg‘
(
domaš
 *
d
, 
rg‘
)

607 
pod_rg‘
;

608 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

609 
»t
 = 0;

610 
pİuÏ‹d
;

612 
	`p2m_lock
(
p2m
);

615 iàĞ
p2m
->
pod
.
’Œy_couÁ
 == 0 )

616 
out
;

619 iàĞ
d
->
is_dyšg
 )

620 
out
;

624 iàĞ
rg‘
 < 
d
->
tÙ_·ges
 )

625 
out
;

627 
pİuÏ‹d
 = 
d
->
tÙ_·ges
 - 
p2m
->
pod
.
couÁ
;

629 
pod_rg‘
 = 
rg‘
 - 
pİuÏ‹d
;

633 iàĞ
pod_rg‘
 > 
p2m
->
pod
.
’Œy_couÁ
 )

634 
pod_rg‘
 = 
p2m
->
pod
.
’Œy_couÁ
;

636 
	`ASSERT
Ğ
pod_rg‘
 >ğ
p2m
->
pod
.
couÁ
 );

638 
»t
 = 
	`p2m_pod_£t_ÿche_rg‘
(
p2m
, 
pod_rg‘
, 1 );

640 
out
:

641 
	`p2m_uÆock
(
p2m
);

643  
»t
;

644 
	}
}

647 
	$p2m_pod_em±y_ÿche
(
domaš
 *
d
)

649 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

650 
·ge_šfo
 *
·ge
;

653 
	`BUG_ON
(!
d
->
is_dyšg
);

654 
	`¥š_b¬r›r
(&
p2m
->
lock
);

656 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

658  (
·ge
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
pod
.
su³r
)) )

660 
i
;

662  
i
 = 0 ; i < 
SUPERPAGE_PAGES
 ; i++ )

664 
	`BUG_ON
(
	`·ge_g‘_owÃr
(
·ge
 + 
i
è!ğ
d
);

665 
	`·ge_li¡_add_
(
·ge
 + 
i
, &
d
->
·ge_li¡
);

668 
p2m
->
pod
.
couÁ
 -ğ
SUPERPAGE_PAGES
;

671  (
·ge
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
pod
.
sšgË
)) )

673 
	`BUG_ON
(
	`·ge_g‘_owÃr
(
·ge
è!ğ
d
);

674 
	`·ge_li¡_add_
(
·ge
, &
d
->
·ge_li¡
);

676 
p2m
->
pod
.
couÁ
 -= 1;

679 
	`BUG_ON
(
p2m
->
pod
.
couÁ
 != 0);

681 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

682 
	}
}

685 
	$p2m_pod_ofæše_Ü_brok’_h™
(
·ge_šfo
 *
p
)

687 
domaš
 *
d
;

688 
p2m_domaš
 *
p2m
;

689 
·ge_šfo
 *
q
, *
tmp
;

690 
mâ
, 
bmâ
;

692 iàĞ!(
d
 = 
	`·ge_g‘_owÃr
(
p
)è|| !(
p2m
 = 
	`p2m_g‘_ho¡p2m
(d)) )

695 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

696 
bmâ
 = 
	`mâ_x
(
	`·ge_to_mâ
(
p
));

697 
	`·ge_li¡_fÜ_—ch_§ã
(
q
, 
tmp
, &
p2m
->
pod
.
su³r
)

699 
mâ
 = 
	`mâ_x
(
	`·ge_to_mâ
(
q
));

700 iàĞ(
bmâ
 >ğ
mâ
è&& ((bmâ - mâè< 
SUPERPAGE_PAGES
) )

702 
i
;

703 
	`·ge_li¡_d–
(
q
, &
p2m
->
pod
.
su³r
);

704  
i
 = 0; i < 
SUPERPAGE_PAGES
; i++)

706 
q
 = 
	`mâ_to_·ge
(
	`_mâ
(
mâ
 + 
i
));

707 
	`·ge_li¡_add_
(
q
, &
p2m
->
pod
.
sšgË
);

709 
	`·ge_li¡_d–
(
p
, &
p2m
->
pod
.
sšgË
);

710 
p2m
->
pod
.
couÁ
--;

711 
pod_h™
;

715 
	`·ge_li¡_fÜ_—ch_§ã
(
q
, 
tmp
, &
p2m
->
pod
.
sšgË
)

717 
mâ
 = 
	`mâ_x
(
	`·ge_to_mâ
(
q
));

718 iàĞ
mâ
 =ğ
bmâ
 )

720 
	`·ge_li¡_d–
(
p
, &
p2m
->
pod
.
sšgË
);

721 
p2m
->
pod
.
couÁ
--;

722 
pod_h™
;

726 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

729 
pod_h™
:

730 
	`·ge_li¡_add_
(
p
, &
d
->
¬ch
.
»lmem_li¡
);

731 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

733 
	}
}

736 
	$p2m_pod_ofæše_Ü_brok’_»¶aû
(
·ge_šfo
 *
p
)

738 
domaš
 *
d
;

739 
p2m_domaš
 *
p2m
;

741 iàĞ!(
d
 = 
	`·ge_g‘_owÃr
(
p
)è|| !(
p2m
 = 
	`p2m_g‘_ho¡p2m
(d)) )

744 
	`ä“_domh—p_·ge
(
p
);

746 
p
 = 
	`®loc_domh—p_·ge
(
d
, 0);

747 iàĞ
	`uÆik–y
(!
p
) )

750 
	`p2m_lock
(
p2m
);

751 
	`p2m_pod_ÿche_add
(
p2m
, 
p
, 0);

752 
	`p2m_uÆock
(
p2m
);

754 
	}
}

765 
	$p2m_pod_deü—£_»£rv©iÚ
(
domaš
 *
d
,

766 
x’_pâ_t
 
gpâ
,

767 
Üd”
)

769 
»t
=0;

770 
i
;

771 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

773 
¡—l_fÜ_ÿche
 = 0;

774 
pod
 = 0, 
nÚpod
 = 0, 
¿m
 = 0;

779 iàĞ
p2m
->
pod
.
’Œy_couÁ
 == 0 )

780 
out
;

783 
¡—l_fÜ_ÿche
 = ( 
p2m
->
pod
.
’Œy_couÁ
 >…2m->pod.
couÁ
 );

785 
	`p2m_lock
(
p2m
);

786 
	`aud™_p2m
(
p2m
, 1);

788 iàĞ
	`uÆik–y
(
d
->
is_dyšg
) )

789 
out_uÆock
;

793  
i
=0; i<(1<<
Üd”
); i++)

795 
p2m_ty³_t
 
t
;

797 
	`gâ_to_mâ_qu”y
(
p2m
, 
gpâ
 + 
i
, &
t
);

799 iàĞ
t
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

800 
pod
++;

803 
nÚpod
++;

804 iàĞ
	`p2m_is_¿m
(
t
) )

805 
¿m
++;

810 if(!
pod
 && !
¡—l_fÜ_ÿche
)

811 
out_uÆock
;

813 iàĞ!
nÚpod
 )

817 
	`£t_p2m_’Œy
(
p2m
, 
gpâ
, 
	`_mâ
(
INVALID_MFN
), 
Üd”
, 
p2m_šv®id
,…2m->
deçuÉ_acûss
);

818 
p2m
->
pod
.
’Œy_couÁ
-=(1<<
Üd”
);

819 
	`BUG_ON
(
p2m
->
pod
.
’Œy_couÁ
 < 0);

820 
»t
 = 1;

821 
out_’Œy_check
;

830  
i
=0;

831 
i
<(1<<
Üd”
è&& (
pod
>0 || (
¡—l_fÜ_ÿche
 && 
¿m
 > 0));

832 
i
++)

834 
mâ_t
 
mâ
;

835 
p2m_ty³_t
 
t
;

837 
mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gpâ
 + 
i
, &
t
);

838 iàĞ
t
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

840 
	`£t_p2m_’Œy
(
p2m
, 
gpâ
 + 
i
, 
	`_mâ
(
INVALID_MFN
), 0, 
p2m_šv®id
,…2m->
deçuÉ_acûss
);

841 
p2m
->
pod
.
’Œy_couÁ
--;

842 
	`BUG_ON
(
p2m
->
pod
.
’Œy_couÁ
 < 0);

843 
pod
--;

845 iàĞ
¡—l_fÜ_ÿche
 && 
	`p2m_is_¿m
(
t
) )

847 
·ge_šfo
 *
·ge
;

849 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

851 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

853 
	`£t_p2m_’Œy
(
p2m
, 
gpâ
 + 
i
, 
	`_mâ
(
INVALID_MFN
), 0, 
p2m_šv®id
,…2m->
deçuÉ_acûss
);

854 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
mâ
), 
INVALID_M2P_ENTRY
);

856 
	`p2m_pod_ÿche_add
(
p2m
, 
·ge
, 0);

858 
¡—l_fÜ_ÿche
 = ( 
p2m
->
pod
.
’Œy_couÁ
 >…2m->pod.
couÁ
 );

860 
nÚpod
--;

861 
¿m
--;

867 iàĞ
nÚpod
 == 0 )

868 
»t
 = 1;

870 
out_’Œy_check
:

872 iàĞ
p2m
->
pod
.
’Œy_couÁ
 <…2m->pod.
couÁ
 )

874 
	`p2m_pod_£t_ÿche_rg‘
(
p2m
,…2m->
pod
.
’Œy_couÁ
, 0 );

877 
out_uÆock
:

878 
	`aud™_p2m
(
p2m
, 1);

879 
	`p2m_uÆock
(
p2m
);

881 
out
:

882  
»t
;

883 
	}
}

886 
	$p2m_pod_dump_d©a
(
p2m_domaš
 *
p2m
)

888 
	`´štk
(" PoDƒntries=%d cachesize=%d\n",

889 
p2m
->
pod
.
’Œy_couÁ
,…2m->pod.
couÁ
);

890 
	}
}

896 
	$p2m_pod_z”o_check_su³½age
(
p2m_domaš
 *
p2m
, 
gâ
)

898 
mâ_t
 
mâ
, 
mâ0
 = 
	`_mâ
(
INVALID_MFN
);

899 
p2m_ty³_t
 
ty³
, 
ty³0
 = 0;

900 * 
m­
 = 
NULL
;

901 
»t
=0, 
»£t
 = 0;

902 
i
, 
j
;

903 
max_»f
 = 1;

904 
domaš
 *
d
 = 
p2m
->domain;

906 iàĞ!
	`su³½age_®igÃd
(
gâ
) )

907 
out
;

910 iàĞ
	`·gšg_mode_shadow
(
d
) )

911 
max_»f
++;

915  
i
=0; i<
SUPERPAGE_PAGES
; i++ )

918 
mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
 + 
i
, &
ty³
);

920 iàĞ
i
 == 0 )

922 
mâ0
 = 
mâ
;

923 
ty³0
 = 
ty³
;

937 iàĞ!
	`p2m_is_¿m
(
ty³
)

938 || 
ty³
 !ğ
ty³0


939 || ( (
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & 
PGC_®loÿ‹d
) == 0 )

940 || ( (
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & (
PGC_·ge_bË
|
PGC_x’_h—p
)) != 0 )

941 || ( (
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & 
PGC_x’_h—p
 ) != 0 )

942 || ( (
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & 
PGC_couÁ_mask
è> 
max_»f
 )

943 || !ĞĞ
i
 =ğ0 && 
	`su³½age_®igÃd
(
	`mâ_x
(
mâ0
)) )

944 || ( 
i
 !ğ0 && 
	`mâ_x
(
mâ
è=ğ(mâ_x(
mâ0
) + i) ) ) )

945 
out
;

949  
i
=0; i<
SUPERPAGE_PAGES
; i++ )

952 
m­
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ0
è+ 
i
);

954  
j
=0; j<16; j++ )

955 ifĞ*(
m­
+
j
) != 0 )

958 
	`unm­_domaš_·ge
(
m­
);

960 iàĞ
j
 < 16 )

961 
out
;

966 
	`£t_p2m_’Œy
(
p2m
, 
gâ
,

967 
	`_mâ
(
POPULATE_ON_DEMAND_MFN
), 9,

968 
p2m_pİuÏ‹_Ú_demªd
, 
p2m
->
deçuÉ_acûss
);

973  
i
=0; i < 
SUPERPAGE_PAGES
; i++ )

975 
mâ
 = 
	`_mâ
(
	`mâ_x
(
mâ0
è+ 
i
);

976 iàĞ(
	`mâ_to_·ge
(
mâ
)->
couÁ_šfo
 & 
PGC_couÁ_mask
) > 1 )

978 
»£t
 = 1;

979 
out_»£t
;

984  
i
=0; i < 
SUPERPAGE_PAGES
; i++ )

986 
m­
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ0
è+ 
i
);

988  
j
=0; j<
PAGE_SIZE
/(*
m­
); j++ )

989 ifĞ*(
m­
+
j
) != 0 )

991 
»£t
 = 1;

995 
	`unm­_domaš_·ge
(
m­
);

997 iàĞ
»£t
 )

998 
out_»£t
;

1001 iàĞ
tb_š™_dÚe
 )

1004 
u64
 
gâ
, 
mâ
;

1005 
d
:16,
Üd”
:16;

1006 } 
t
;

1008 
t
.
gâ
 = gfn;

1009 
t
.
mâ
 = 
	`mâ_x
(mfn);

1010 
t
.
d
 = d->
domaš_id
;

1011 
t
.
Üd”
 = 9;

1013 
	`__Œaû_v¬
(
TRC_MEM_POD_ZERO_RECLAIM
, 0, (
t
), &t);

1018 
	`p2m_pod_ÿche_add
(
p2m
, 
	`mâ_to_·ge
(
mâ0
), 9);

1019 
p2m
->
pod
.
’Œy_couÁ
 +ğ
SUPERPAGE_PAGES
;

1021 
out_»£t
:

1022 iàĞ
»£t
 )

1023 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ0
, 9, 
ty³0
,…2m->
deçuÉ_acûss
);

1025 
out
:

1026  
»t
;

1027 
	}
}

1030 
	$p2m_pod_z”o_check
(
p2m_domaš
 *
p2m
, *
gâs
, 
couÁ
)

1032 
mâ_t
 
mâs
[
couÁ
];

1033 
p2m_ty³_t
 
ty³s
[
couÁ
];

1034 * 
m­
[
couÁ
];

1035 
domaš
 *
d
 = 
p2m
->domain;

1037 
i
, 
j
;

1038 
max_»f
 = 1;

1041 iàĞ
	`·gšg_mode_shadow
(
d
) )

1042 
max_»f
++;

1045  
i
=0; i<
couÁ
; i++ )

1047 
mâs
[
i
] = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâs
[i], 
ty³s
 + i);

1050 iàĞ
	`p2m_is_¿m
(
ty³s
[
i
])

1051 && ( (
	`mâ_to_·ge
(
mâs
[
i
])->
couÁ_šfo
 & 
PGC_®loÿ‹d
) != 0 )

1052 && ( (
	`mâ_to_·ge
(
mâs
[
i
])->
couÁ_šfo
 & (
PGC_·ge_bË
|
PGC_x’_h—p
)) == 0 )

1053 && ( (
	`mâ_to_·ge
(
mâs
[
i
])->
couÁ_šfo
 & 
PGC_couÁ_mask
è<ğ
max_»f
 ) )

1054 
m­
[
i
] = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâs
[i]));

1056 
m­
[
i
] = 
NULL
;

1061  
i
=0; i<
couÁ
; i++ )

1063 if(!
m­
[
i
])

1067  
j
=0; j<16; j++ )

1068 ifĞ*(
m­
[
i
]+
j
) != 0 )

1071 iàĞ
j
 < 16 )

1073 
	`unm­_domaš_·ge
(
m­
[
i
]);

1074 
m­
[
i
] = 
NULL
;

1079 
	`£t_p2m_’Œy
(
p2m
, 
gâs
[
i
],

1080 
	`_mâ
(
POPULATE_ON_DEMAND_MFN
), 0,

1081 
p2m_pİuÏ‹_Ú_demªd
, 
p2m
->
deçuÉ_acûss
);

1085 iàĞ(
	`mâ_to_·ge
(
mâs
[
i
])->
couÁ_šfo
 & 
PGC_couÁ_mask
) > 1 )

1087 
	`unm­_domaš_·ge
(
m­
[
i
]);

1088 
m­
[
i
] = 
NULL
;

1090 
	`£t_p2m_’Œy
(
p2m
, 
gâs
[
i
], 
mâs
[i], 0, 
ty³s
[i],…2m->
deçuÉ_acûss
);

1097  
i
=0; i < 
couÁ
; i++ )

1099 if(!
m­
[
i
])

1102  
j
=0; j<
PAGE_SIZE
/(*
m­
[
i
]); j++ )

1103 ifĞ*(
m­
[
i
]+
j
) != 0 )

1106 
	`unm­_domaš_·ge
(
m­
[
i
]);

1110 iàĞ
j
 < 
PAGE_SIZE
/(*
m­
[
i
]) )

1112 
	`£t_p2m_’Œy
(
p2m
, 
gâs
[
i
], 
mâs
[i], 0, 
ty³s
[i],…2m->
deçuÉ_acûss
);

1116 iàĞ
tb_š™_dÚe
 )

1119 
u64
 
gâ
, 
mâ
;

1120 
d
:16,
Üd”
:16;

1121 } 
t
;

1123 
t
.
gâ
 = 
gâs
[
i
];

1124 
t
.
mâ
 = 
	`mâ_x
(
mâs
[
i
]);

1125 
t
.
d
 = d->
domaš_id
;

1126 
t
.
Üd”
 = 0;

1128 
	`__Œaû_v¬
(
TRC_MEM_POD_ZERO_RECLAIM
, 0, (
t
), &t);

1132 
	`p2m_pod_ÿche_add
(
p2m
, 
	`mâ_to_·ge
(
mâs
[
i
]), 0);

1133 
p2m
->
pod
.
’Œy_couÁ
++;

1137 
	}
}

1139 
	#POD_SWEEP_LIMIT
 1024

	)

1141 
	$p2m_pod_em”g’cy_sw“p_su³r
(
p2m_domaš
 *
p2m
)

1143 
i
, 
¡¬t
, 
lim™
;

1145 iàĞ
p2m
->
pod
.
»şaim_su³r
 == 0 )

1147 
p2m
->
pod
.
»şaim_su³r
 = (p2m->pod.
max_gue¡
>>9)<<9;

1148 
p2m
->
pod
.
»şaim_su³r
 -ğ
SUPERPAGE_PAGES
;

1151 
¡¬t
 = 
p2m
->
pod
.
»şaim_su³r
;

1152 
lim™
 = (
¡¬t
 > 
POD_SWEEP_LIMIT
) ? (start - POD_SWEEP_LIMIT) : 0;

1154  
i
=
p2m
->
pod
.
»şaim_su³r
 ; i > 0 ; i -ğ
SUPERPAGE_PAGES
 )

1156 
	`p2m_pod_z”o_check_su³½age
(
p2m
, 
i
);

1162 iàĞ!
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
è&& 
i
 < 
lim™
 )

1166 
p2m
->
pod
.
»şaim_su³r
 = 
i
 ? i - 
SUPERPAGE_PAGES
 : 0;

1167 
	}
}

1169 
	#POD_SWEEP_STRIDE
 16

	)

1171 
	$p2m_pod_em”g’cy_sw“p
(
p2m_domaš
 *
p2m
)

1173 
gâs
[
POD_SWEEP_STRIDE
];

1174 
i
, 
j
=0, 
¡¬t
, 
lim™
;

1175 
p2m_ty³_t
 
t
;

1178 iàĞ
p2m
->
pod
.
»şaim_sšgË
 == 0 )

1179 
p2m
->
pod
.
»şaim_sšgË
 =…2m->pod.
max_gue¡
;

1181 
¡¬t
 = 
p2m
->
pod
.
»şaim_sšgË
;

1182 
lim™
 = (
¡¬t
 > 
POD_SWEEP_LIMIT
) ? (start - POD_SWEEP_LIMIT) : 0;

1185  
i
=
p2m
->
pod
.
»şaim_sšgË
; i > 0 ; i-- )

1187 
	`gâ_to_mâ_qu”y
(
p2m
, 
i
, &
t
 );

1188 iàĞ
	`p2m_is_¿m
(
t
) )

1190 
gâs
[
j
] = 
i
;

1191 
j
++;

1192 
	`BUG_ON
(
j
 > 
POD_SWEEP_STRIDE
);

1193 iàĞ
j
 =ğ
POD_SWEEP_STRIDE
 )

1195 
	`p2m_pod_z”o_check
(
p2m
, 
gâs
, 
j
);

1196 
j
 = 0;

1204 iàĞ
p2m
->
pod
.
couÁ
 > 0 && 
i
 < 
lim™
 )

1208 iàĞ
j
 )

1209 
	`p2m_pod_z”o_check
(
p2m
, 
gâs
, 
j
);

1211 
p2m
->
pod
.
»şaim_sšgË
 = 
i
 ? i - 1 : i;

1213 
	}
}

1216 
	$p2m_pod_demªd_pİuÏ‹
(
p2m_domaš
 *
p2m
, 
gâ
,

1217 
Üd”
,

1218 
p2m_qu”y_t
 
q
)

1220 
domaš
 *
d
 = 
p2m
->domain;

1221 
·ge_šfo
 *
p
 = 
NULL
;

1222 
gâ_®igÃd
;

1223 
mâ_t
 
mâ
;

1224 
i
;

1226 
	`ASSERT
(
	`p2m_locked_by_me
(
p2m
));

1231 iàĞ
	`uÆik–y
(
d
->
is_dyšg
) )

1232 
out_ç
;

1236 iàĞ
Üd”
 == 18 )

1238 
gâ_®igÃd
 = (
gâ
 >> 
Üd”
) << order;

1244 
	`£t_p2m_’Œy
(
p2m
, 
gâ_®igÃd
, 
	`_mâ
(
POPULATE_ON_DEMAND_MFN
), 9,

1245 
p2m_pİuÏ‹_Ú_demªd
, 
p2m
->
deçuÉ_acûss
);

1246 
	`aud™_p2m
(
p2m
, 1);

1247 
	`p2m_uÆock
(
p2m
);

1255 iàĞ
p2m
->
pod
.
’Œy_couÁ
 >…2m->pod.
couÁ
 )

1259 iàĞ
Üd”
 =ğ9 && 
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) )

1260 
	`p2m_pod_em”g’cy_sw“p_su³r
(
p2m
);

1262 iàĞ
	`·ge_li¡_em±y
(&
p2m
->
pod
.
sšgË
) &&

1263 ĞĞ
Üd”
 == 0 )

1264 || (
Üd”
 =ğ9 && 
	`·ge_li¡_em±y
(&
p2m
->
pod
.
su³r
) ) ) )

1265 
	`p2m_pod_em”g’cy_sw“p
(
p2m
);

1269 iàĞ
q
 =ğ
p2m_gue¡
 && 
gâ
 > 
p2m
->
pod
.
max_gue¡
 )

1270 
p2m
->
pod
.
max_gue¡
 = 
gâ
;

1272 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

1274 iàĞ
p2m
->
pod
.
couÁ
 == 0 )

1275 
out_of_memÜy
;

1279 iàĞ(
p
 = 
	`p2m_pod_ÿche_g‘
(
p2m
, 
Üd”
)è=ğ
NULL
 )

1280 
»m­_ªd_»Œy
;

1282 
mâ
 = 
	`·ge_to_mâ
(
p
);

1284 
	`BUG_ON
((
	`mâ_x
(
mâ
è& ((1 << 
Üd”
)-1)) != 0);

1286 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

1288 
gâ_®igÃd
 = (
gâ
 >> 
Üd”
) << order;

1290 
	`£t_p2m_’Œy
(
p2m
, 
gâ_®igÃd
, 
mâ
, 
Üd”
, 
p2m_¿m_rw
,…2m->
deçuÉ_acûss
);

1292  
i
 = 0; i < (1UL << 
Üd”
); i++ )

1294 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
mâ
è+ 
i
, 
gâ_®igÃd
 + i);

1295 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
mâ
è+ 
i
);

1298 
p2m
->
pod
.
’Œy_couÁ
 -ğ(1 << 
Üd”
);

1299 
	`BUG_ON
(
p2m
->
pod
.
’Œy_couÁ
 < 0);

1301 iàĞ
tb_š™_dÚe
 )

1304 
u64
 
gâ
, 
mâ
;

1305 
d
:16,
Üd”
:16;

1306 } 
t
;

1308 
t
.
gâ
 = gfn;

1309 
t
.
mâ
 = 
	`mâ_x
(mfn);

1310 
t
.
d
 = d->
domaš_id
;

1311 
t
.
Üd”
 = order;

1313 
	`__Œaû_v¬
(
TRC_MEM_POD_POPULATE
, 0, (
t
), &t);

1317 
out_of_memÜy
:

1318 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

1320 
	`´štk
("%s: OuˆoàpİuÏ‹-Ú-demªd memÜy!Ù_·ge %" 
PRIu32
 "…od_’Œ› %" 
PRIi32
 "\n",

1321 
__func__
, 
d
->
tÙ_·ges
, 
p2m
->
pod
.
’Œy_couÁ
);

1322 
	`domaš_üash
(
d
);

1323 
out_ç
:

1325 
»m­_ªd_»Œy
:

1326 
	`BUG_ON
(
Üd”
 != 9);

1327 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

1330 
gâ_®igÃd
 = (
gâ
>>
Üd”
)<<order;

1331 
i
=0; i<(1<<
Üd”
); i++)

1332 
	`£t_p2m_’Œy
(
p2m
, 
gâ_®igÃd
+
i
, 
	`_mâ
(
POPULATE_ON_DEMAND_MFN
), 0,

1333 
p2m_pİuÏ‹_Ú_demªd
, 
p2m
->
deçuÉ_acûss
);

1334 iàĞ
tb_š™_dÚe
 )

1337 
u64
 
gâ
;

1338 
d
:16;

1339 } 
t
;

1341 
t
.
gâ
 = gfn;

1342 
t
.
d
 = d->
domaš_id
;

1344 
	`__Œaû_v¬
(
TRC_MEM_POD_SUPERPAGE_SPLINTER
, 0, (
t
), &t);

1348 
	}
}

1351 
	$p2m_pod_check_ªd_pİuÏ‹
(
p2m_domaš
 *
p2m
, 
gâ
,

1352 
l1_pg’Œy_t
 *
p2m_’Œy
, 
Üd”
,

1353 
p2m_qu”y_t
 
q
)

1357 
do_lockšg
 = !
	`p2m_locked_by_me
(
p2m
);

1358 
r
;

1360 iàĞ
do_lockšg
 )

1361 
	`p2m_lock
(
p2m
);

1363 
	`aud™_p2m
(
p2m
, 1);

1366 iàĞ
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(*
p2m_’Œy
)è!ğ
p2m_pİuÏ‹_Ú_demªd
 )

1368 iàĞ
do_lockšg
 )

1369 
	`p2m_uÆock
(
p2m
);

1373 
r
 = 
	`p2m_pod_demªd_pİuÏ‹
(
p2m
, 
gâ
, 
Üd”
, 
q
);

1375 
	`aud™_p2m
(
p2m
, 1);

1376 iàĞ
do_lockšg
 )

1377 
	`p2m_uÆock
(
p2m
);

1379  
r
;

1380 
	}
}

1384 
	$p2m_£t_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
,

1385 
·ge_Üd”
, 
p2m_ty³_t
 
p2mt
, 
p2m_acûss_t
 
p2ma
)

1388 
mâ_t
 
bË_mâ
 = 
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
));

1389 *
bË
 =
	`m­_domaš_·ge
(
	`mâ_x
(
bË_mâ
));

1390 
i
, 
gâ_»mašd”
 = 
gâ
;

1391 
l1_pg’Œy_t
 *
p2m_’Œy
;

1392 
l1_pg’Œy_t
 
’Œy_cÚ‹Á
;

1393 
l2_pg’Œy_t
 
l2e_cÚ‹Á
;

1394 
l3_pg’Œy_t
 
l3e_cÚ‹Á
;

1395 
rv
=0;

1397 iàĞ
tb_š™_dÚe
 )

1400 
u64
 
gâ
, 
mâ
;

1401 
p2mt
;

1402 
d
:16,
Üd”
:16;

1403 } 
t
;

1405 
t
.
gâ
 = gfn;

1406 
t
.
mâ
 = 
	`mâ_x
(mfn);

1407 
t
.
p2mt
 =…2mt;

1408 
t
.
d
 = 
p2m
->
domaš
->
domaš_id
;

1409 
t
.
Üd”
 = 
·ge_Üd”
;

1411 
	`__Œaû_v¬
(
TRC_MEM_SET_P2M_ENTRY
, 0, (
t
), &t);

1414 #ià
CONFIG_PAGING_LEVELS
 >= 4

1415 iàĞ!
	`p2m_Ãxt_Ëv–
(
p2m
, &
bË_mâ
, &
bË
, &
gâ_»mašd”
, 
gâ
,

1416 
L4_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
,

1417 
L4_PAGETABLE_ENTRIES
, 
PGT_l3_·ge_bË
) )

1418 
out
;

1423 iàĞ
·ge_Üd”
 == 18 )

1425 
l1_pg’Œy_t
 
Şd_’Œy
 = 
	`l1e_em±y
();

1426 
p2m_’Œy
 = 
	`p2m_fšd_’Œy
(
bË
, &
gâ_»mašd”
, 
gâ
,

1427 
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
,

1428 
L3_PAGETABLE_ENTRIES
);

1429 
	`ASSERT
(
p2m_’Œy
);

1430 iàĞ(
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PRESENT
) &&

1431 !(
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PSE
) )

1435 
Şd_’Œy
 = *
p2m_’Œy
;

1438 
	`ASSERT
(!
	`mâ_v®id
(
mâ
è|| 
p2mt
 !ğ
p2m_mmio_dœeù
);

1439 
l3e_cÚ‹Á
 = 
	`mâ_v®id
(
mâ
)

1440 ? 
	`l3e_äom_pâ
(
	`mâ_x
(
mâ
),

1441 
	`p2m_ty³_to_æags
(
p2mt
, 
mâ
è| 
_PAGE_PSE
)

1442 : 
	`l3e_em±y
();

1443 
’Œy_cÚ‹Á
.
l1
 = 
l3e_cÚ‹Á
.
l3
;

1444 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
, 
p2m_’Œy
,

1445 
bË_mâ
, 
’Œy_cÚ‹Á
, 3);

1449 iàĞ
	`l1e_g‘_æags
(
Şd_’Œy
è& 
_PAGE_PRESENT
 )

1450 
	`p2m_ä“_’Œy
(
p2m
, &
Şd_’Œy
, 
·ge_Üd”
);

1459 iàĞ!
	`p2m_Ãxt_Ëv–
(
p2m
, &
bË_mâ
, &
bË
, &
gâ_»mašd”
, 
gâ
,

1460 
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
,

1461 ((
CONFIG_PAGING_LEVELS
 == 3)

1462 ? (
	`h­_’abËd
(
p2m
->
domaš
) ? 4 : 8)

1463 : 
L3_PAGETABLE_ENTRIES
),

1464 
PGT_l2_·ge_bË
) )

1465 
out
;

1467 iàĞ
·ge_Üd”
 == 0 )

1469 iàĞ!
	`p2m_Ãxt_Ëv–
(
p2m
, &
bË_mâ
, &
bË
, &
gâ_»mašd”
, 
gâ
,

1470 
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
,

1471 
L2_PAGETABLE_ENTRIES
, 
PGT_l1_·ge_bË
) )

1472 
out
;

1474 
p2m_’Œy
 = 
	`p2m_fšd_’Œy
(
bË
, &
gâ_»mašd”
, 
gâ
,

1475 0, 
L1_PAGETABLE_ENTRIES
);

1476 
	`ASSERT
(
p2m_’Œy
);

1478 iàĞ
	`mâ_v®id
(
mâ
è|| (
p2mt
 =ğ
p2m_mmio_dœeù
) )

1479 
’Œy_cÚ‹Á
 = 
	`l1e_äom_pâ
(
	`mâ_x
(
mâ
),

1480 
	`p2m_ty³_to_æags
(
p2mt
, 
mâ
));

1482 
’Œy_cÚ‹Á
 = 
	`l1e_em±y
();

1485 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
, 
p2m_’Œy
,

1486 
bË_mâ
, 
’Œy_cÚ‹Á
, 1);

1489 iàĞ
·ge_Üd”
 == 9 )

1491 
l1_pg’Œy_t
 
Şd_’Œy
 = 
	`l1e_em±y
();

1492 
p2m_’Œy
 = 
	`p2m_fšd_’Œy
(
bË
, &
gâ_»mašd”
, 
gâ
,

1493 
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
,

1494 
L2_PAGETABLE_ENTRIES
);

1495 
	`ASSERT
(
p2m_’Œy
);

1498 iàĞ(
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PRESENT
) &&

1499 !(
	`l1e_g‘_æags
(*
p2m_’Œy
è& 
_PAGE_PSE
) )

1503 
Şd_’Œy
 = *
p2m_’Œy
;

1506 
	`ASSERT
(!
	`mâ_v®id
(
mâ
è|| 
p2mt
 !ğ
p2m_mmio_dœeù
);

1507 iàĞ
	`mâ_v®id
(
mâ
è|| 
	`p2m_is_magic
(
p2mt
) )

1508 
l2e_cÚ‹Á
 = 
	`l2e_äom_pâ
(
	`mâ_x
(
mâ
),

1509 
	`p2m_ty³_to_æags
(
p2mt
, 
mâ
) |

1510 
_PAGE_PSE
);

1512 
l2e_cÚ‹Á
 = 
	`l2e_em±y
();

1514 
’Œy_cÚ‹Á
.
l1
 = 
l2e_cÚ‹Á
.
l2
;

1515 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
, 
p2m_’Œy
,

1516 
bË_mâ
, 
’Œy_cÚ‹Á
, 2);

1520 iàĞ
	`l1e_g‘_æags
(
Şd_’Œy
è& 
_PAGE_PRESENT
 )

1521 
	`p2m_ä“_’Œy
(
p2m
, &
Şd_’Œy
, 
·ge_Üd”
);

1525 iàĞ
	`mâ_v®id
(
mâ
)

1526 && (
gâ
 + (1UL << 
·ge_Üd”
è- 1 > 
p2m
->
max_m­³d_pâ
) )

1527 
p2m
->
max_m­³d_pâ
 = 
gâ
 + (1UL << 
·ge_Üd”
) - 1;

1529 iàĞ
iommu_’abËd
 && 
	`Ãed_iommu
(
p2m
->
domaš
) )

1531 iàĞ
p2mt
 =ğ
p2m_¿m_rw
 )

1532  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

1533 
	`iommu_m­_·ge
(
p2m
->
domaš
, 
gâ
+
i
, 
	`mâ_x
(
mâ
)+i,

1534 
IOMMUF_»adabË
|
IOMMUF_wr™abË
);

1536  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

1537 
	`iommu_unm­_·ge
(
p2m
->
domaš
, 
gâ
+
i
);

1541 
rv
 = 1;

1543 
out
:

1544 
	`unm­_domaš_·ge
(
bË
);

1545  
rv
;

1546 
	}
}

1548 
mâ_t


1549 
	$p2m_gâ_to_mâ
(
p2m_domaš
 *
p2m
, 
gâ
, 
p2m_ty³_t
 *
t
, 
p2m_acûss_t
 *
a
,

1550 
p2m_qu”y_t
 
q
)

1552 
mâ_t
 
mâ
;

1553 
·ddr_t
 
addr
 = (Õaddr_t)
gâ
è<< 
PAGE_SHIFT
;

1554 
l2_pg’Œy_t
 *
l2e
;

1555 
l1_pg’Œy_t
 *
l1e
;

1557 
	`ASSERT
(
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
));

1563 *
t
 = 
p2m_mmio_dm
;

1565 *
a
 = 
p2m_acûss_rwx
;

1567 
mâ
 = 
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
));

1569 iàĞ
gâ
 > 
p2m
->
max_m­³d_pâ
 )

1571  
	`_mâ
(
INVALID_MFN
);

1573 #ià
CONFIG_PAGING_LEVELS
 >= 4

1575 
l4_pg’Œy_t
 *
l4e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

1576 
l4e
 +ğ
	`l4_bË_off£t
(
addr
);

1577 iàĞ(
	`l4e_g‘_æags
(*
l4e
è& 
_PAGE_PRESENT
) == 0 )

1579 
	`unm­_domaš_·ge
(
l4e
);

1580  
	`_mâ
(
INVALID_MFN
);

1582 
mâ
 = 
	`_mâ
(
	`l4e_g‘_pâ
(*
l4e
));

1583 
	`unm­_domaš_·ge
(
l4e
);

1587 
l3_pg’Œy_t
 *
l3e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

1588 #ià
CONFIG_PAGING_LEVELS
 == 3

1594 
l3e
 +ğ(
addr
 >> 
L3_PAGETABLE_SHIFT
);

1596 
l3e
 +ğ
	`l3_bË_off£t
(
addr
);

1598 
pod_»Œy_l3
:

1599 iàĞ(
	`l3e_g‘_æags
(*
l3e
è& 
_PAGE_PRESENT
) == 0 )

1601 iàĞ
	`p2m_æags_to_ty³
(
	`l3e_g‘_æags
(*
l3e
)è=ğ
p2m_pİuÏ‹_Ú_demªd
 )

1603 iàĞ
q
 !ğ
p2m_qu”y
 )

1605 iàĞ!
	`p2m_pod_demªd_pİuÏ‹
(
p2m
, 
gâ
, 18, 
q
) )

1606 
pod_»Œy_l3
;

1609 *
t
 = 
p2m_pİuÏ‹_Ú_demªd
;

1611 
	`unm­_domaš_·ge
(
l3e
);

1612  
	`_mâ
(
INVALID_MFN
);

1614 iàĞ(
	`l3e_g‘_æags
(*
l3e
è& 
_PAGE_PSE
) )

1616 
mâ
 = 
	`_mâ
(
	`l3e_g‘_pâ
(*
l3e
) +

1617 
	`l2_bË_off£t
(
addr
è* 
L1_PAGETABLE_ENTRIES
 +

1618 
	`l1_bË_off£t
(
addr
));

1619 *
t
 = 
	`p2m_æags_to_ty³
(
	`l3e_g‘_æags
(*
l3e
));

1620 
	`unm­_domaš_·ge
(
l3e
);

1622 
	`ASSERT
(
	`mâ_v®id
(
mâ
è|| !
	`p2m_is_¿m
(*
t
));

1623  (
	`p2m_is_v®id
(*
t
)è? 
mâ
 : 
	`_mâ
(
INVALID_MFN
);

1626 
mâ
 = 
	`_mâ
(
	`l3e_g‘_pâ
(*
l3e
));

1627 
	`unm­_domaš_·ge
(
l3e
);

1630 
l2e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

1631 
l2e
 +ğ
	`l2_bË_off£t
(
addr
);

1633 
pod_»Œy_l2
:

1634 iàĞ(
	`l2e_g‘_æags
(*
l2e
è& 
_PAGE_PRESENT
) == 0 )

1637 iàĞ
	`p2m_æags_to_ty³
(
	`l2e_g‘_æags
(*
l2e
)è=ğ
p2m_pİuÏ‹_Ú_demªd
 )

1639 iàĞ
q
 !ğ
p2m_qu”y
 ) {

1640 iàĞ!
	`p2m_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

1641 (
l1_pg’Œy_t
 *)
l2e
, 9, 
q
) )

1642 
pod_»Œy_l2
;

1644 *
t
 = 
p2m_pİuÏ‹_Ú_demªd
;

1647 
	`unm­_domaš_·ge
(
l2e
);

1648  
	`_mâ
(
INVALID_MFN
);

1650 iàĞ(
	`l2e_g‘_æags
(*
l2e
è& 
_PAGE_PSE
) )

1652 
mâ
 = 
	`_mâ
(
	`l2e_g‘_pâ
(*
l2e
è+ 
	`l1_bË_off£t
(
addr
));

1653 *
t
 = 
	`p2m_æags_to_ty³
(
	`l2e_g‘_æags
(*
l2e
));

1654 
	`unm­_domaš_·ge
(
l2e
);

1656 
	`ASSERT
(
	`mâ_v®id
(
mâ
è|| !
	`p2m_is_¿m
(*
t
));

1657  (
	`p2m_is_v®id
(*
t
)è? 
mâ
 : 
	`_mâ
(
INVALID_MFN
);

1660 
mâ
 = 
	`_mâ
(
	`l2e_g‘_pâ
(*
l2e
));

1661 
	`unm­_domaš_·ge
(
l2e
);

1663 
l1e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

1664 
l1e
 +ğ
	`l1_bË_off£t
(
addr
);

1665 
pod_»Œy_l1
:

1666 iàĞ(
	`l1e_g‘_æags
(*
l1e
è& 
_PAGE_PRESENT
) == 0 )

1669 iàĞ
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(*
l1e
)è=ğ
p2m_pİuÏ‹_Ú_demªd
 )

1671 iàĞ
q
 !ğ
p2m_qu”y
 ) {

1672 iàĞ!
	`p2m_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

1673 (
l1_pg’Œy_t
 *)
l1e
, 0, 
q
) )

1674 
pod_»Œy_l1
;

1676 *
t
 = 
p2m_pİuÏ‹_Ú_demªd
;

1679 
	`unm­_domaš_·ge
(
l1e
);

1680  
	`_mâ
(
INVALID_MFN
);

1682 
mâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(*
l1e
));

1683 *
t
 = 
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(*
l1e
));

1684 
	`unm­_domaš_·ge
(
l1e
);

1686 
	`ASSERT
(
	`mâ_v®id
(
mâ
è|| !
	`p2m_is_¿m
(*
t
));

1687  (
	`p2m_is_v®id
(*
t
è|| 
	`p2m_is_g¿Á
(*t)è? 
mâ
 : 
	`_mâ
(
INVALID_MFN
);

1688 
	}
}

1691 
mâ_t
 
	$p2m_gâ_to_mâ_cu¼’t
(
p2m_domaš
 *
p2m
,

1692 
gâ
, 
p2m_ty³_t
 *
t
, 
p2m_acûss_t
 *
a
,

1693 
p2m_qu”y_t
 
q
)

1695 
mâ_t
 
mâ
 = 
	`_mâ
(
INVALID_MFN
);

1696 
p2m_ty³_t
 
p2mt
 = 
p2m_mmio_dm
;

1697 
·ddr_t
 
addr
 = (Õaddr_t)
gâ
è<< 
PAGE_SHIFT
;

1704 *
a
 = 
p2m_acûss_rwx
;

1706 iàĞ
gâ
 <ğ
p2m
->
max_m­³d_pâ
 )

1708 
l1_pg’Œy_t
 
l1e
 = 
	`l1e_em±y
(), *
p2m_’Œy
;

1709 
l2_pg’Œy_t
 
l2e
 = 
	`l2e_em±y
();

1710 
»t
;

1711 #ià
CONFIG_PAGING_LEVELS
 >= 4

1712 
l3_pg’Œy_t
 
l3e
 = 
	`l3e_em±y
();

1715 
	`ASSERT
(
gâ
 < (
RO_MPT_VIRT_END
 - 
RO_MPT_VIRT_START
)

1716 / (
l1_pg’Œy_t
));

1718 #ià
CONFIG_PAGING_LEVELS
 >= 4

1722 
p2m_’Œy
 = (
l1_pg’Œy_t
 *)

1723 &
__lš—r_l2_bË
[
	`l2_lš—r_off£t
(
RO_MPT_VIRT_START
)

1724 + 
	`l3_lš—r_off£t
(
addr
)];

1725 
pod_»Œy_l3
:

1726 
»t
 = 
	`__cİy_äom_u£r
(&
l3e
, 
p2m_’Œy
, (l3e));

1728 iàĞ
»t
 !ğ0 || !(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

1730 iàĞ(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) &&

1731 (
	`p2m_æags_to_ty³
(
	`l3e_g‘_æags
(
l3e
)è=ğ
p2m_pİuÏ‹_Ú_demªd
) )

1734 iàĞ
q
 !ğ
p2m_qu”y
 )

1736 iàĞ!
	`p2m_pod_demªd_pİuÏ‹
(
p2m
, 
gâ
, 18, 
q
) )

1737 
pod_»Œy_l3
;

1738 
p2mt
 = 
p2m_šv®id
;

1739 
	`´štk
("%s: AÎoÿ‹ 1GB faed!\n", 
__func__
);

1740 
out
;

1744 
p2mt
 = 
p2m_pİuÏ‹_Ú_demªd
;

1745 
out
;

1748 
pod_»Œy_l2
;

1751 iàĞ
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
 )

1753 
p2mt
 = 
	`p2m_æags_to_ty³
(
	`l3e_g‘_æags
(
l3e
));

1754 
	`ASSERT
(
	`l3e_g‘_pâ
(
l3e
è!ğ
INVALID_MFN
 || !
	`p2m_is_¿m
(
p2mt
));

1755 ià(
	`p2m_is_v®id
(
p2mt
) )

1756 
mâ
 = 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
) +

1757 
	`l2_bË_off£t
(
addr
è* 
L1_PAGETABLE_ENTRIES
 +

1758 
	`l1_bË_off£t
(
addr
));

1760 
p2mt
 = 
p2m_mmio_dm
;

1762 
out
;

1768 
p2m_’Œy
 = &
__lš—r_l1_bË
[
	`l1_lš—r_off£t
(
RO_MPT_VIRT_START
)

1769 + 
	`l2_lš—r_off£t
(
addr
)];

1771 
pod_»Œy_l2
:

1772 
»t
 = 
	`__cİy_äom_u£r
(&
l2e
,

1773 
p2m_’Œy
,

1774 (
l2e
));

1775 iàĞ
»t
 != 0

1776 || !(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

1778 ifĞ(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
)

1779 && ( 
	`p2m_æags_to_ty³
(
	`l2e_g‘_æags
(
l2e
))

1780 =ğ
p2m_pİuÏ‹_Ú_demªd
 ) )

1784 iàĞ
q
 !ğ
p2m_qu”y
 )

1786 iàĞ!
	`p2m_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

1787 
p2m_’Œy
, 9, 
q
) )

1788 
pod_»Œy_l2
;

1791 
p2mt
 = 
p2m_šv®id
;

1792 
	`´štk
("%s: AÎoÿ‹ faed!\n", 
__func__
);

1793 
out
;

1797 
p2mt
 = 
p2m_pİuÏ‹_Ú_demªd
;

1798 
out
;

1802 
pod_»Œy_l1
;

1805 ià(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
)

1807 
p2mt
 = 
	`p2m_æags_to_ty³
(
	`l2e_g‘_æags
(
l2e
));

1808 
	`ASSERT
(
	`l2e_g‘_pâ
(
l2e
è!ğ
INVALID_MFN
 || !
	`p2m_is_¿m
(
p2mt
));

1810 iàĞ
	`p2m_is_v®id
(
p2mt
) )

1811 
mâ
 = 
	`_mâ
(
	`l2e_g‘_pâ
(
l2e
è+ 
	`l1_bË_off£t
(
addr
));

1813 
p2mt
 = 
p2m_mmio_dm
;

1815 
out
;

1824 
pod_»Œy_l1
:

1825 
p2m_’Œy
 = &
phys_to_machše_m­pšg
[
gâ
];

1827 
»t
 = 
	`__cİy_äom_u£r
(&
l1e
,

1828 
p2m_’Œy
,

1829 (
l1e
));

1831 iàĞ
»t
 == 0 ) {

1832 
p2mt
 = 
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(
l1e
));

1833 
	`ASSERT
(
	`l1e_g‘_pâ
(
l1e
è!ğ
INVALID_MFN
 || !
	`p2m_is_¿m
(
p2mt
));

1835 iàĞ
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(
l1e
))

1836 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

1840 iàĞ
q
 !ğ
p2m_qu”y
 )

1842 iàĞ!
	`p2m_pod_check_ªd_pİuÏ‹
(
p2m
, 
gâ
,

1843 (
l1_pg’Œy_t
 *)
p2m_’Œy
, 0, 
q
) )

1844 
pod_»Œy_l1
;

1847 
p2mt
 = 
p2m_šv®id
;

1848 
out
;

1852 
p2mt
 = 
p2m_pİuÏ‹_Ú_demªd
;

1853 
out
;

1857 iàĞ
	`p2m_is_v®id
(
p2mt
è|| 
	`p2m_is_g¿Á
(p2mt) )

1858 
mâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(
l1e
));

1861 
p2mt
 = 
p2m_mmio_dm
;

1864 
out
:

1865 *
t
 = 
p2mt
;

1866  
mâ
;

1867 
	}
}

1870 
	$p2m_š™Ÿli£
(
domaš
 *
d
, 
p2m_domaš
 *
p2m
)

1872 
	`mem£t
(
p2m
, 0, (*p2m));

1873 
	`p2m_lock_š™
(
p2m
);

1874 
	`INIT_PAGE_LIST_HEAD
(&
p2m
->
·ges
);

1875 
	`INIT_PAGE_LIST_HEAD
(&
p2m
->
pod
.
su³r
);

1876 
	`INIT_PAGE_LIST_HEAD
(&
p2m
->
pod
.
sšgË
);

1878 
p2m
->
domaš
 = 
d
;

1879 
p2m
->
deçuÉ_acûss
 = 
p2m_acûss_rwx
;

1881 
p2m
->
£t_’Œy
 = 
p2m_£t_’Œy
;

1882 
p2m
->
g‘_’Œy
 = 
p2m_gâ_to_mâ
;

1883 
p2m
->
g‘_’Œy_cu¼’t
 = 
p2m_gâ_to_mâ_cu¼’t
;

1884 
p2m
->
chªge_’Œy_ty³_glob®
 = 
p2m_chªge_ty³_glob®
;

1886 iàĞ
	`h­_’abËd
(
d
è&& (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) )

1887 
	`•t_p2m_š™
(
d
);

1890 
	}
}

1892 
	$p2m_š™
(
domaš
 *
d
)

1894 
p2m_domaš
 *
p2m
;

1896 
	`p2m_g‘_ho¡p2m
(
d
èğ
p2m
 = 
	`xm®loc
(
p2m_domaš
);

1897 iàĞ
p2m
 =ğ
NULL
 )

1898  -
ENOMEM
;

1899 
	`p2m_š™Ÿli£
(
d
, 
p2m
);

1902 
	}
}

1904 
	$p2m_chªge_’Œy_ty³_glob®
(
p2m_domaš
 *
p2m
,

1905 
p2m_ty³_t
 
Ù
,…2m_ty³_ˆ
Á
)

1907 
	`p2m_lock
(
p2m
);

1908 
p2m
->
	`chªge_’Œy_ty³_glob®
Õ2m, 
Ù
, 
Á
);

1909 
	`p2m_uÆock
(
p2m
);

1910 
	}
}

1913 
	$£t_p2m_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
,

1914 
·ge_Üd”
, 
p2m_ty³_t
 
p2mt
, 
p2m_acûss_t
 
p2ma
)

1916 
domaš
 *
d
 = 
p2m
->domain;

1917 
todo
 = 1uÈ<< 
·ge_Üd”
;

1918 
Üd”
;

1919 
rc
 = 1;

1921  
todo
 )

1923 iàĞ
	`h­_’abËd
(
d
) )

1924 
Üd”
 = ( (((
gâ
 | 
	`mâ_x
(
mâ
è| 
todo
) & ((1ul << 18) - 1)) == 0) &&

1925 
	`hvm_h­_has_1gb
(
d
è&& 
İt_h­_1gb
 ) ? 18 :

1926 ((((
gâ
 | 
	`mâ_x
(
mâ
è| 
todo
) & ((1ul << 9) - 1)) == 0) &&

1927 
	`hvm_h­_has_2mb
(
d
è&& 
İt_h­_2mb
) ? 9 : 0;

1929 
Üd”
 = 0;

1931 iàĞ!
p2m
->
	`£t_’Œy
Õ2m, 
gâ
, 
mâ
, 
Üd”
, 
p2mt
, 
p2ma
) )

1932 
rc
 = 0;

1933 
gâ
 +ğ1uÈ<< 
Üd”
;

1934 iàĞ
	`mâ_x
(
mâ
è!ğ
INVALID_MFN
 )

1935 
mâ
 = 
	`_mâ
(
	`mâ_x
(mâè+ (1uÈ<< 
Üd”
));

1936 
todo
 -ğ1uÈ<< 
Üd”
;

1939  
rc
;

1940 
	}
}

1949 
	$p2m_®loc_bË
(
p2m_domaš
 *
p2m
)

1951 
mâ_t
 
mâ
 = 
	`_mâ
(
INVALID_MFN
);

1952 
·ge_šfo
 *
·ge
, *
p2m_tİ
;

1953 
·ge_couÁ
 = 0;

1954 
gâ
 = -1UL;

1955 
domaš
 *
d
 = 
p2m
->domain;

1957 
	`p2m_lock
(
p2m
);

1959 iàĞ
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
p2m
)) != 0 )

1961 
	`P2M_ERROR
("p2m‡lready‡llocated forhis domain\n");

1962 
	`p2m_uÆock
(
p2m
);

1963  -
EINVAL
;

1966 
	`P2M_PRINTK
("allocating…2mable\n");

1968 
p2m_tİ
 = 
	`p2m_®loc_±p
(
p2m
,

1969 #ià
CONFIG_PAGING_LEVELS
 == 4

1970 
PGT_l4_·ge_bË


1972 
PGT_l3_·ge_bË


1976 iàĞ
p2m_tİ
 =ğ
NULL
 )

1978 
	`p2m_uÆock
(
p2m
);

1979  -
ENOMEM
;

1982 
p2m
->
phys_bË
 = 
	`·g‘abË_äom_mâ
(
	`·ge_to_mâ
(
p2m_tİ
));

1984 iàĞ
	`h­_’abËd
(
d
è&& (
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) )

1985 
	`iommu_£t_pgd
(
d
);

1987 
	`P2M_PRINTK
("populating…2mable\n");

1990 iàĞ!
	`£t_p2m_’Œy
(
p2m
, 0, 
	`_mâ
(
INVALID_MFN
), 0,

1991 
p2m_šv®id
, 
p2m
->
deçuÉ_acûss
) )

1992 
”rÜ
;

1995 
	`¥š_lock
(&
p2m
->
domaš
->
·ge_®loc_lock
);

1996 
	`·ge_li¡_fÜ_—ch
(
·ge
, &
p2m
->
domaš
->
·ge_li¡
)

1998 
mâ
 = 
	`·ge_to_mâ
(
·ge
);

1999 
gâ
 = 
	`g‘_gpâ_äom_mâ
(
	`mâ_x
(
mâ
));

2001 
	`ASSERT
(
gâ
 !ğ
SHARED_M2P_ENTRY
);

2002 
·ge_couÁ
++;

2004 #ifdeà
__x86_64__


2005 (
gâ
 != 0x5555555555555555L)

2007 (
gâ
 != 0x55555555L)

2009 && 
gâ
 !ğ
INVALID_M2P_ENTRY


2010 && !
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ
, 0, 
p2m_¿m_rw
,…2m->
deçuÉ_acûss
) )

2011 
”rÜ_uÆock
;

2013 
	`¥š_uÆock
(&
p2m
->
domaš
->
·ge_®loc_lock
);

2015 
	`P2M_PRINTK
("p2mabË in™Ÿli£d (%u…ages)\n", 
·ge_couÁ
);

2016 
	`p2m_uÆock
(
p2m
);

2019 
”rÜ_uÆock
:

2020 
	`¥š_uÆock
(&
p2m
->
domaš
->
·ge_®loc_lock
);

2021 
”rÜ
:

2022 
	`P2M_PRINTK
("failedo initialize…2mable, gfn=%05lx, mfn=%"

2023 
PRI_mâ
 "\n", 
gâ
, 
	`mâ_x
(
mâ
));

2024 
	`p2m_uÆock
(
p2m
);

2025  -
ENOMEM
;

2026 
	}
}

2028 
	$p2m_‹¬down
(
p2m_domaš
 *
p2m
)

2032 
·ge_šfo
 *
pg
;

2033 
domaš
 *
d
 = 
p2m
->domain;

2034 #ifdeà
__x86_64__


2035 
gâ
;

2036 
p2m_ty³_t
 
t
;

2037 
p2m_acûss_t
 
a
;

2038 
mâ_t
 
mâ
;

2041 
	`p2m_lock
(
p2m
);

2043 #ifdeà
__x86_64__


2044  
gâ
=0; gâ < 
p2m
->
max_m­³d_pâ
; gfn++ )

2046 
mâ
 = 
p2m
->
	`g‘_’Œy
Õ2m, 
gâ
, &
t
, &
a
, 
p2m_qu”y
);

2047 iàĞ
	`mâ_v®id
(
mâ
è&& (
t
 =ğ
p2m_¿m_sh¬ed
) )

2048 
	`BUG_ON
(
	`mem_sh¬šg_unsh¬e_·ge
(
p2m
, 
gâ
, 
MEM_SHARING_DESTROY_GFN
));

2052 
p2m
->
phys_bË
 = 
	`·g‘abË_nuÎ
();

2054  (
pg
 = 
	`·ge_li¡_»move_h—d
(&
p2m
->
·ges
)) )

2055 
d
->
¬ch
.
·gšg
.
	`ä“_·ge
(d, 
pg
);

2056 
	`p2m_uÆock
(
p2m
);

2057 
	}
}

2059 
	$p2m_fš®_‹¬down
(
domaš
 *
d
)

2062 
	`xä“
(
d
->
¬ch
.
p2m
);

2063 
d
->
¬ch
.
p2m
 = 
NULL
;

2064 
	}
}

2066 #ià
P2M_AUDIT


2070 
	$aud™_p2m
(
p2m_domaš
 *
p2m
, 
¡riù_m2p
)

2072 
·ge_šfo
 *
·ge
;

2073 
domaš
 *
od
;

2074 
mâ
, 
gâ
, 
m2pâ
, 
Í2mâ
 = 0;

2075 
’Œy_couÁ
 = 0;

2076 
mâ_t
 
p2mâ
;

2077 
Üphªs_d
 = 0, 
Üphªs_i
 = 0, 
mpbad
 = 0, 
pmbad
 = 0;

2078 
‹¡_lš—r
;

2079 
p2m_ty³_t
 
ty³
;

2080 
domaš
 *
d
 = 
p2m
->domain;

2082 iàĞ!
	`·gšg_mode_Œª¦©e
(
d
) )

2087 
‹¡_lš—r
 = ( (
d
 =ğ
cu¼’t
->
domaš
)

2088 && !
	`·g‘abË_is_nuÎ
(
cu¼’t
->
¬ch
.
mÚ™Ü_bË
) );

2089 iàĞ
‹¡_lš—r
 )

2090 
	`æush_b_loÿl
();

2092 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

2096 
	`·ge_li¡_fÜ_—ch
 ( 
·ge
, &
d
->
·ge_li¡
 )

2098 
mâ
 = 
	`mâ_x
(
	`·ge_to_mâ
(
·ge
));

2102 
od
 = 
	`·ge_g‘_owÃr
(
·ge
);

2104 iàĞ
od
 !ğ
d
 )

2106 
	`P2M_PRINTK
("wrong owner %#lx -> %p(%u) != %p(%u)\n",

2107 
mâ
, 
od
, (od?od->
domaš_id
:-1), 
d
, d->domain_id);

2111 
gâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
);

2112 iàĞ
gâ
 =ğ
INVALID_M2P_ENTRY
 )

2114 
Üphªs_i
++;

2120 iàĞ
gâ
 == 0x55555555 || gfn == 0x5555555555555555 )

2122 
Üphªs_d
++;

2128 iàĞ
gâ
 =ğ
SHARED_M2P_ENTRY
 )

2130 
	`P2M_PRINTK
("shared mfn (%lx) on domain…age†ist!\n",

2131 
mâ
);

2135 
p2mâ
 = 
	`gâ_to_mâ_ty³_p2m
(
p2m
, 
gâ
, &
ty³
, 
p2m_qu”y
);

2136 iàĞ
¡riù_m2p
 && 
	`mâ_x
(
p2mâ
è!ğ
mâ
 )

2138 
mpbad
++;

2139 
	`P2M_PRINTK
("map mismatch mfn %#lx -> gfn %#lx -> mfn %#lx"

2141 
mâ
, 
gâ
, 
	`mâ_x
(
p2mâ
),

2142 (
	`mâ_v®id
(
p2mâ
)

2143 ? 
	`g‘_gpâ_äom_mâ
(
	`mâ_x
(
p2mâ
))

2148 
	`£t_gpâ_äom_mâ
(
mâ
, 
INVALID_M2P_ENTRY
);

2151 iàĞ
‹¡_lš—r
 && (
gâ
 <ğ
p2m
->
max_m­³d_pâ
) )

2153 
Í2mâ
 = 
	`mâ_x
(
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
ty³
));

2154 iàĞ
Í2mâ
 !ğ
	`mâ_x
(
p2mâ
) )

2156 
	`P2M_PRINTK
("linear mismatch gfn %#lx -> mfn %#lx "

2157 "(!ğmâ %#lx)\n", 
gâ
, 
Í2mâ
, 
	`mâ_x
(
p2mâ
));

2165 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

2168 iàĞ
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
p2m
)) != 0 )

2170 
l2_pg’Œy_t
 *
l2e
;

2171 
l1_pg’Œy_t
 *
l1e
;

2172 
i1
, 
i2
;

2174 #ià
CONFIG_PAGING_LEVELS
 == 4

2175 
l4_pg’Œy_t
 *
l4e
;

2176 
l3_pg’Œy_t
 *
l3e
;

2177 
i4
, 
i3
;

2178 
l4e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
))));

2180 
l3_pg’Œy_t
 *
l3e
;

2181 
i3
;

2182 
l3e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
))));

2185 
gâ
 = 0;

2186 #ià
CONFIG_PAGING_LEVELS
 >= 4

2187  
i4
 = 0; i4 < 
L4_PAGETABLE_ENTRIES
; i4++ )

2189 iàĞ!(
	`l4e_g‘_æags
(
l4e
[
i4
]è& 
_PAGE_PRESENT
) )

2191 
gâ
 +ğ1 << (
L4_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

2194 
l3e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`_mâ
(
	`l4e_g‘_pâ
(
l4e
[
i4
]))));

2196  
i3
 = 0;

2197 
i3
 < ((
CONFIG_PAGING_LEVELS
==4è? 
L3_PAGETABLE_ENTRIES
 : 8);

2198 
i3
++ )

2200 iàĞ!(
	`l3e_g‘_æags
(
l3e
[
i3
]è& 
_PAGE_PRESENT
) )

2202 
gâ
 +ğ1 << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

2207 iàĞ
	`l3e_g‘_æags
(
l3e
[
i3
]è& 
_PAGE_PSE
 )

2209 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
[
i3
]);

2210 
	`ASSERT
(
	`mâ_v®id
(
	`_mâ
(
mâ
)));

2212  
i2
 = 0;

2213 
i2
 < (
L2_PAGETABLE_ENTRIES
 * 
L1_PAGETABLE_ENTRIES
);

2214 
i2
++)

2216 
m2pâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
+
i2
);

2217 iàĞ
m2pâ
 !ğ(
gâ
 + 
i2
) )

2219 
pmbad
++;

2220 
	`P2M_PRINTK
("mismatch: gfn %#lx -> mfn %#lx"

2221 " -> gâ %#lx\n", 
gâ
+
i2
, 
mâ
+i2,

2222 
m2pâ
);

2223 
	`BUG
();

2225 
gâ
 +ğ1 << (
L3_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

2230 
l2e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[
i3
]))));

2231  
i2
 = 0; i2 < 
L2_PAGETABLE_ENTRIES
; i2++ )

2233 iàĞ!(
	`l2e_g‘_æags
(
l2e
[
i2
]è& 
_PAGE_PRESENT
) )

2235 iàĞ(
	`l2e_g‘_æags
(
l2e
[
i2
]è& 
_PAGE_PSE
)

2236 && ( 
	`p2m_æags_to_ty³
(
	`l2e_g‘_æags
(
l2e
[
i2
]))

2237 =ğ
p2m_pİuÏ‹_Ú_demªd
 ) )

2238 
’Œy_couÁ
+=
SUPERPAGE_PAGES
;

2239 
gâ
 +ğ1 << (
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

2244 iàĞ
	`l2e_g‘_æags
(
l2e
[
i2
]è& 
_PAGE_PSE
 )

2246 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
[
i2
]);

2247 
	`ASSERT
(
	`mâ_v®id
(
	`_mâ
(
mâ
)));

2248  
i1
 = 0; i1 < 
L1_PAGETABLE_ENTRIES
; i1++)

2250 
m2pâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
+
i1
);

2252 iàĞ(
m2pâ
 !ğ(
gâ
 + 
i1
)) &&

2253 (
m2pâ
 !ğ
SHARED_M2P_ENTRY
) )

2255 
pmbad
++;

2256 
	`P2M_PRINTK
("mismatch: gfn %#lx -> mfn %#lx"

2257 " -> gâ %#lx\n", 
gâ
+
i1
, 
mâ
+i1,

2258 
m2pâ
);

2259 
	`BUG
();

2262 
gâ
 +ğ1 << (
L2_PAGETABLE_SHIFT
 - 
PAGE_SHIFT
);

2266 
l1e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`_mâ
(
	`l2e_g‘_pâ
(
l2e
[
i2
]))));

2268  
i1
 = 0; i1 < 
L1_PAGETABLE_ENTRIES
; i1++, 
gâ
++ )

2270 
p2m_ty³_t
 
ty³
;

2272 
ty³
 = 
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(
l1e
[
i1
]));

2273 iàĞ!(
	`l1e_g‘_æags
(
l1e
[
i1
]è& 
_PAGE_PRESENT
) )

2275 iàĞ
ty³
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

2276 
’Œy_couÁ
++;

2279 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
[
i1
]);

2280 
	`ASSERT
(
	`mâ_v®id
(
	`_mâ
(
mâ
)));

2281 
m2pâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
);

2282 iàĞ
m2pâ
 !ğ
gâ
 &&

2283 
ty³
 !ğ
p2m_mmio_dœeù
 &&

2284 !
	`p2m_is_g¿Á
(
ty³
) &&

2285 !
	`p2m_is_sh¬ed
(
ty³
) )

2287 
pmbad
++;

2288 
	`´štk
("mismatch: gfn %#lx -> mfn %#lx"

2289 " -> gâ %#lx\n", 
gâ
, 
mâ
, 
m2pâ
);

2290 
	`P2M_PRINTK
("mismatch: gfn %#lx -> mfn %#lx"

2291 " -> gâ %#lx\n", 
gâ
, 
mâ
, 
m2pâ
);

2292 
	`BUG
();

2295 
	`unm­_domaš_·ge
(
l1e
);

2297 
	`unm­_domaš_·ge
(
l2e
);

2299 #ià
CONFIG_PAGING_LEVELS
 >= 4

2300 
	`unm­_domaš_·ge
(
l3e
);

2304 #ià
CONFIG_PAGING_LEVELS
 == 4

2305 
	`unm­_domaš_·ge
(
l4e
);

2307 
	`unm­_domaš_·ge
(
l3e
);

2312 iàĞ
’Œy_couÁ
 !ğ
p2m
->
pod
.entry_count )

2314 
	`´štk
("%s:„efcountedƒntry count %d,‡udit count %d!\n",

2315 
__func__
,

2316 
p2m
->
pod
.
’Œy_couÁ
,

2317 
’Œy_couÁ
);

2318 
	`BUG
();

2325 iàĞ
mpbad
 | 
pmbad
 )

2327 
	`P2M_PRINTK
("p2m‡udit found %lu odd…2m, %lu bad m2pƒntries\n",

2328 
pmbad
, 
mpbad
);

2329 
	`WARN
();

2337 
	`p2m_»move_·ge
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ
,

2338 
·ge_Üd”
)

2340 
i
;

2341 
mâ_t
 
mâ_»tuº
;

2342 
p2m_ty³_t
 
t
;

2343 
p2m_acûss_t
 
a
;

2345 iàĞ!
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
) )

2347 iàĞ
	`Ãed_iommu
(
p2m
->
domaš
) )

2348  
i
 = 0; i < (1 << 
·ge_Üd”
); i++ )

2349 
	`iommu_unm­_·ge
(
p2m
->
domaš
, 
mâ
 + 
i
);

2353 
	`P2M_DEBUG
("»movšg gâ=%#lx mâ=%#lx\n", 
gâ
, 
mâ
);

2355 iàĞ
	`mâ_v®id
(
	`_mâ
(
mâ
)) )

2357  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

2359 
mâ_»tuº
 = 
p2m
->
	`g‘_’Œy
Õ2m, 
gâ
 + 
i
, &
t
, &
a
, 
p2m_qu”y
);

2360 iàĞ!
	`p2m_is_g¿Á
(
t
) )

2361 
	`£t_gpâ_äom_mâ
(
mâ
+
i
, 
INVALID_M2P_ENTRY
);

2362 
	`ASSERT
Ğ!
	`p2m_is_v®id
(
t
è|| 
mâ
 + 
i
 =ğ
	`mâ_x
(
mâ_»tuº
) );

2365 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
INVALID_MFN
), 
·ge_Üd”
, 
p2m_šv®id
,…2m->
deçuÉ_acûss
);

2369 
	`gue¡_physm­_»move_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
,

2370 
mâ
, 
·ge_Üd”
)

2372 
	`p2m_lock
(
p2m
);

2373 
	`aud™_p2m
(
p2m
, 1);

2374 
	`p2m_»move_·ge
(
p2m
, 
gâ
, 
mâ
, 
·ge_Üd”
);

2375 
	`aud™_p2m
(
p2m
, 1);

2376 
	`p2m_uÆock
(
p2m
);

2379 #ià
CONFIG_PAGING_LEVELS
 == 3

2380 
	`gâ_check_lim™
(

2381 
domaš
 *
d
, 
gâ
, 
Üd”
)

2388 iàĞ!
	`h­_’abËd
(
d
è|| ((
gâ
 + (1uÈ<< 
Üd”
)) <= 0x100000UL) ||

2389 (
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
) )

2392 iàĞ!
	`‹¡_ªd_£t_boŞ
(
d
->
¬ch
.
hvm_domaš
.
svm
.
Åt_4gb_w¬nšg
) )

2393 
	`d´štk
(
XENLOG_WARNING
, "Dom%d failedo…opulate memory beyond"

2395 
d
->
domaš_id
);

2397  -
EINVAL
;

2400 
	#gâ_check_lim™
(
d
, 
g
, 
o
è0

	)

2404 
	`gue¡_physm­_m¬k_pİuÏ‹_Ú_demªd
(
domaš
 *
d
, 
gâ
,

2405 
Üd”
)

2407 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

2408 
i
;

2409 
p2m_ty³_t
 
Ù
;

2410 
mâ_t
 
omâ
;

2411 
pod_couÁ
 = 0;

2412 
rc
 = 0;

2414 
	`BUG_ON
(!
	`·gšg_mode_Œª¦©e
(
d
));

2416 
rc
 = 
	`gâ_check_lim™
(
d
, 
gâ
, 
Üd”
);

2417 iàĞ
rc
 != 0 )

2418  
rc
;

2420 
	`p2m_lock
(
p2m
);

2421 
	`aud™_p2m
(
p2m
, 1);

2423 
	`P2M_DEBUG
("m¬k…od gâ=%#lx\n", 
gâ
);

2426  
i
 = 0; i < (1UL << 
Üd”
); i++ )

2428 
omâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
 + 
i
, &
Ù
);

2429 iàĞ
	`p2m_is_¿m
(
Ù
) )

2431 
	`´štk
("%s: gfn_to_mfn„eturnedype %d!\n",

2432 
__func__
, 
Ù
);

2433 
rc
 = -
EBUSY
;

2434 
out
;

2436 iàĞ
Ù
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

2439 
pod_couÁ
++;

2444 iàĞ!
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
POPULATE_ON_DEMAND_MFN
), 
Üd”
,

2445 
p2m_pİuÏ‹_Ú_demªd
, 
p2m
->
deçuÉ_acûss
) )

2446 
rc
 = -
EINVAL
;

2449 
p2m
->
pod
.
’Œy_couÁ
 +ğ1 << 
Üd”
;

2450 
p2m
->
pod
.
’Œy_couÁ
 -ğ
pod_couÁ
;

2451 
	`BUG_ON
(
p2m
->
pod
.
’Œy_couÁ
 < 0);

2454 
	`aud™_p2m
(
p2m
, 1);

2455 
	`p2m_uÆock
(
p2m
);

2457 
out
:

2458  
rc
;

2462 
	`gue¡_physm­_add_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
,

2463 
mâ
, 
·ge_Üd”
,

2464 
p2m_ty³_t
 
t
)

2466 
domaš
 *
d
 = 
p2m
->domain;

2467 
i
, 
ogâ
;

2468 
p2m_ty³_t
 
Ù
;

2469 
mâ_t
 
omâ
;

2470 
pod_couÁ
 = 0;

2471 
rc
 = 0;

2473 iàĞ!
	`·gšg_mode_Œª¦©e
(
d
) )

2475 iàĞ
	`Ãed_iommu
(
d
è&& 
t
 =ğ
p2m_¿m_rw
 )

2477  
i
 = 0; i < (1 << 
·ge_Üd”
); i++ )

2479 
rc
 = 
	`iommu_m­_·ge
(

2480 
d
, 
mâ
 + 
i
, mâ + i, 
IOMMUF_»adabË
|
IOMMUF_wr™abË
);

2481 iàĞ
rc
 != 0 )

2483  
i
-- > 0 )

2484 
	`iommu_unm­_·ge
(
d
, 
mâ
 + 
i
);

2485  
rc
;

2492 
rc
 = 
	`gâ_check_lim™
(
d
, 
gâ
, 
·ge_Üd”
);

2493 iàĞ
rc
 != 0 )

2494  
rc
;

2496 
	`p2m_lock
(
p2m
);

2497 
	`aud™_p2m
(
p2m
, 0);

2499 
	`P2M_DEBUG
("addšg gâ=%#lx mâ=%#lx\n", 
gâ
, 
mâ
);

2502  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

2504 
omâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
 + 
i
, &
Ù
);

2505 iàĞ
	`p2m_is_g¿Á
(
Ù
) )

2508 
	`domaš_üash
(
d
);

2509 
	`p2m_uÆock
(
p2m
);

2510  -
EINVAL
;

2512 iàĞ
	`p2m_is_¿m
(
Ù
) )

2514 
	`ASSERT
(
	`mâ_v®id
(
omâ
));

2515 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
omâ
), 
INVALID_M2P_ENTRY
);

2517 iàĞ
Ù
 =ğ
p2m_pİuÏ‹_Ú_demªd
 )

2520 
pod_couÁ
++;

2525  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

2527 iàĞ
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
	`_mâ
(
mâ
 + 
i
))è!ğ
d
 )

2529 
ogâ
 = 
	`mâ_to_gâ
(
d
, 
	`_mâ
(
mâ
+
i
));

2531 #ifdeà
__x86_64__


2532 (
ogâ
 != 0x5555555555555555L)

2534 (
ogâ
 != 0x55555555L)

2536 && (
ogâ
 !ğ
INVALID_M2P_ENTRY
)

2537 && (
ogâ
 !ğ
gâ
 + 
i
) )

2541 
	`P2M_DEBUG
("aliased! mfn=%#lx, old gfn=%#lx,‚ew gfn=%#lx\n",

2542 
mâ
 + 
i
, 
ogâ
, 
gâ
 + i);

2543 
omâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
ogâ
, &
Ù
);

2544 iàĞ
	`p2m_is_¿m
(
Ù
) )

2546 
	`ASSERT
(
	`mâ_v®id
(
omâ
));

2547 
	`P2M_DEBUG
("old gfn=%#lx -> mfn %#lx\n",

2548 
ogâ
 , 
	`mâ_x
(
omâ
));

2549 iàĞ
	`mâ_x
(
omâ
è=ğ(
mâ
 + 
i
) )

2550 
	`p2m_»move_·ge
(
p2m
, 
ogâ
, 
mâ
 + 
i
, 0);

2556 iàĞ
	`mâ_v®id
(
	`_mâ
(
mâ
)) )

2558 iàĞ!
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
mâ
), 
·ge_Üd”
, 
t
,…2m->
deçuÉ_acûss
) )

2559 
rc
 = -
EINVAL
;

2560 iàĞ!
	`p2m_is_g¿Á
(
t
) )

2562  
i
 = 0; i < (1UL << 
·ge_Üd”
); i++ )

2563 
	`£t_gpâ_äom_mâ
(
mâ
+
i
, 
gâ
+i);

2568 
	`gd´štk
(
XENLOG_WARNING
, "Adding bad mfno…2m map (%#lx -> %#lx)\n",

2569 
gâ
, 
mâ
);

2570 iàĞ!
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
INVALID_MFN
), 
·ge_Üd”
,

2571 
p2m_šv®id
, 
p2m
->
deçuÉ_acûss
) )

2572 
rc
 = -
EINVAL
;

2575 
p2m
->
pod
.
’Œy_couÁ
 -ğ
pod_couÁ
;

2576 
	`BUG_ON
(
p2m
->
pod
.
’Œy_couÁ
 < 0);

2580 
	`aud™_p2m
(
p2m
, 1);

2581 
	`p2m_uÆock
(
p2m
);

2583  
rc
;

2589 
	`p2m_chªge_ty³_glob®
(
p2m_domaš
 *
p2m
, 
p2m_ty³_t
 
Ù
,…2m_ty³_ˆ
Á
)

2591 
mâ
, 
gâ
, 
æags
;

2592 
l1_pg’Œy_t
 
l1e_cÚ‹Á
;

2593 
l1_pg’Œy_t
 *
l1e
;

2594 
l2_pg’Œy_t
 *
l2e
;

2595 
mâ_t
 
l1mâ
, 
l2mâ
, 
l3mâ
;

2596 
i1
, 
i2
, 
i3
;

2597 
l3_pg’Œy_t
 *
l3e
;

2598 #ià
CONFIG_PAGING_LEVELS
 == 4

2599 
l4_pg’Œy_t
 *
l4e
;

2600 
i4
;

2603 
	`BUG_ON
(
	`p2m_is_g¿Á
(
Ù
è||…2m_is_g¿Á(
Á
));

2604 
	`BUG_ON
(
Ù
 !ğ
Á
 && (Ù =ğ
p2m_mmio_dœeù
 ||‚t ==…2m_mmio_direct));

2606 iàĞ!
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
) )

2609 iàĞ
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
p2m
)) == 0 )

2612 
	`ASSERT
(
	`p2m_locked_by_me
(
p2m
));

2614 #ià
CONFIG_PAGING_LEVELS
 == 4

2615 
l4e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
))));

2617 
l3mâ
 = 
	`_mâ
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
))));

2618 
l3e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
p2m
))));

2621 #ià
CONFIG_PAGING_LEVELS
 >= 4

2622  
i4
 = 0; i4 < 
L4_PAGETABLE_ENTRIES
; i4++ )

2624 iàĞ!(
	`l4e_g‘_æags
(
l4e
[
i4
]è& 
_PAGE_PRESENT
) )

2628 
l3mâ
 = 
	`_mâ
(
	`l4e_g‘_pâ
(
l4e
[
i4
]));

2629 
l3e
 = 
	`m­_domaš_·ge
(
	`l4e_g‘_pâ
(
l4e
[
i4
]));

2631  
i3
 = 0;

2632 
i3
 < ((
CONFIG_PAGING_LEVELS
==4è? 
L3_PAGETABLE_ENTRIES
 : 8);

2633 
i3
++ )

2635 iàĞ!(
	`l3e_g‘_æags
(
l3e
[
i3
]è& 
_PAGE_PRESENT
) )

2639 iàĞ(
	`l3e_g‘_æags
(
l3e
[
i3
]è& 
_PAGE_PSE
) )

2641 
æags
 = 
	`l3e_g‘_æags
(
l3e
[
i3
]);

2642 iàĞ
	`p2m_æags_to_ty³
(
æags
è!ğ
Ù
 )

2644 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
[
i3
]);

2645 
gâ
 = 
	`g‘_gpâ_äom_mâ
(
mâ
);

2646 
æags
 = 
	`p2m_ty³_to_æags
(
Á
, 
	`_mâ
(
mâ
));

2647 
l1e_cÚ‹Á
 = 
	`l1e_äom_pâ
(
mâ
, 
æags
 | 
_PAGE_PSE
);

2648 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

2649 (
l1_pg’Œy_t
 *)&
l3e
[
i3
],

2650 
l3mâ
, 
l1e_cÚ‹Á
, 3);

2654 
l2mâ
 = 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[
i3
]));

2655 
l2e
 = 
	`m­_domaš_·ge
(
	`l3e_g‘_pâ
(
l3e
[
i3
]));

2656  
i2
 = 0; i2 < 
L2_PAGETABLE_ENTRIES
; i2++ )

2658 iàĞ!(
	`l2e_g‘_æags
(
l2e
[
i2
]è& 
_PAGE_PRESENT
) )

2663 iàĞ(
	`l2e_g‘_æags
(
l2e
[
i2
]è& 
_PAGE_PSE
) )

2665 
æags
 = 
	`l2e_g‘_æags
(
l2e
[
i2
]);

2666 iàĞ
	`p2m_æags_to_ty³
(
æags
è!ğ
Ù
 )

2668 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
[
i2
]);

2671 
gâ
 = (
i2
 + (
i3


2672 #ià
CONFIG_PAGING_LEVELS
 >= 4

2673 + (
i4
 * 
L3_PAGETABLE_ENTRIES
)

2676 * 
L2_PAGETABLE_ENTRIES
è* 
L1_PAGETABLE_ENTRIES
;

2677 
æags
 = 
	`p2m_ty³_to_æags
(
Á
, 
	`_mâ
(
mâ
));

2678 
l1e_cÚ‹Á
 = 
	`l1e_äom_pâ
(
mâ
, 
æags
 | 
_PAGE_PSE
);

2679 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
,

2680 (
l1_pg’Œy_t
 *)&
l2e
[
i2
],

2681 
l2mâ
, 
l1e_cÚ‹Á
, 2);

2685 
l1mâ
 = 
	`_mâ
(
	`l2e_g‘_pâ
(
l2e
[
i2
]));

2686 
l1e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
l1mâ
));

2688  
i1
 = 0; i1 < 
L1_PAGETABLE_ENTRIES
; i1++, 
gâ
++ )

2690 
æags
 = 
	`l1e_g‘_æags
(
l1e
[
i1
]);

2691 iàĞ
	`p2m_æags_to_ty³
(
æags
è!ğ
Ù
 )

2693 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
[
i1
]);

2694 
gâ
 = 
i1
 + (
i2
 + (
i3


2695 #ià
CONFIG_PAGING_LEVELS
 >= 4

2696 + (
i4
 * 
L3_PAGETABLE_ENTRIES
)

2699 * 
L2_PAGETABLE_ENTRIES
è* 
L1_PAGETABLE_ENTRIES
;

2701 
æags
 = 
	`p2m_ty³_to_æags
(
Á
, 
	`_mâ
(
mâ
));

2702 
l1e_cÚ‹Á
 = 
	`l1e_äom_pâ
(
mâ
, 
æags
);

2703 
	`·gšg_wr™e_p2m_’Œy
(
p2m
->
domaš
, 
gâ
, &
l1e
[
i1
],

2704 
l1mâ
, 
l1e_cÚ‹Á
, 1);

2706 
	`unm­_domaš_·ge
(
l1e
);

2708 
	`unm­_domaš_·ge
(
l2e
);

2710 #ià
CONFIG_PAGING_LEVELS
 >= 4

2711 
	`unm­_domaš_·ge
(
l3e
);

2715 #ià
CONFIG_PAGING_LEVELS
 == 4

2716 
	`unm­_domaš_·ge
(
l4e
);

2718 
	`unm­_domaš_·ge
(
l3e
);

2725 
p2m_ty³_t
 
	`p2m_chªge_ty³
(
p2m_domaš
 *
p2m
, 
gâ
,

2726 
p2m_ty³_t
 
Ù
,…2m_ty³_ˆ
Á
)

2728 
p2m_ty³_t
 
±
;

2729 
mâ_t
 
mâ
;

2731 
	`BUG_ON
(
	`p2m_is_g¿Á
(
Ù
è||…2m_is_g¿Á(
Á
));

2733 
	`p2m_lock
(
p2m
);

2735 
mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
±
);

2736 iàĞ
±
 =ğ
Ù
 )

2737 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ
, 0, 
Á
,…2m->
deçuÉ_acûss
);

2739 
	`p2m_uÆock
(
p2m
);

2741  
±
;

2745 
	`£t_mmio_p2m_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
)

2747 
rc
 = 0;

2748 
p2m_ty³_t
 
Ù
;

2749 
mâ_t
 
omâ
;

2751 iàĞ!
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
) )

2754 
omâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
Ù
);

2755 iàĞ
	`p2m_is_g¿Á
(
Ù
) )

2757 
	`domaš_üash
(
p2m
->
domaš
);

2760 iàĞ
	`p2m_is_¿m
(
Ù
) )

2762 
	`ASSERT
(
	`mâ_v®id
(
omâ
));

2763 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
omâ
), 
INVALID_M2P_ENTRY
);

2766 
	`P2M_DEBUG
("£ˆmmiØ%lx %lx\n", 
gâ
, 
	`mâ_x
(
mâ
));

2767 
	`p2m_lock
(
p2m
);

2768 
rc
 = 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ
, 0, 
p2m_mmio_dœeù
,…2m->
deçuÉ_acûss
);

2769 
	`aud™_p2m
(
p2m
, 1);

2770 
	`p2m_uÆock
(
p2m
);

2771 iàĞ0 =ğ
rc
 )

2772 
	`gd´štk
(
XENLOG_ERR
,

2774 
	`mâ_x
(
	`gâ_to_mâ
(
p2m
, 
gâ
, &
Ù
)));

2775  
rc
;

2779 
	`ş—r_mmio_p2m_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
)

2781 
rc
 = 0;

2782 
mâ_t
 
mâ
;

2783 
p2m_ty³_t
 
t
;

2785 iàĞ!
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
) )

2788 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
t
);

2791 iàĞ(
INVALID_MFN
 =ğ
	`mâ_x
(
mâ
)è|| (
t
 !ğ
p2m_mmio_dœeù
) )

2793 
	`gd´štk
(
XENLOG_ERR
,

2794 "ş—r_mmio_p2m_’Œy: gâ_to_mâ faed! gâ=%08lx\n", 
gâ
);

2797 
	`p2m_lock
(
p2m
);

2798 
rc
 = 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
INVALID_MFN
), 0, 0,…2m->
deçuÉ_acûss
);

2799 
	`aud™_p2m
(
p2m
, 1);

2800 
	`p2m_uÆock
(
p2m
);

2802  
rc
;

2806 
	`£t_sh¬ed_p2m_’Œy
(
p2m_domaš
 *
p2m
, 
gâ
, 
mâ_t
 
mâ
)

2808 
rc
 = 0;

2809 
Ãed_lock
 = !
	`p2m_locked_by_me
(
p2m
);

2810 
p2m_ty³_t
 
Ù
;

2811 
mâ_t
 
omâ
;

2813 iàĞ!
	`·gšg_mode_Œª¦©e
(
p2m
->
domaš
) )

2816 
omâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
Ù
);

2819 
	`ASSERT
(
	`p2m_is_sh¬ed
(
Ù
));

2820 
	`ASSERT
(
	`mâ_v®id
(
omâ
));

2822 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
omâ
), 
INVALID_M2P_ENTRY
);

2824 
	`P2M_DEBUG
("£ˆsh¬ed %lx %lx\n", 
gâ
, 
	`mâ_x
(
mâ
));

2825 iàĞ
Ãed_lock
 )

2826 
	`p2m_lock
(
p2m
);

2827 
rc
 = 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ
, 0, 
p2m_¿m_sh¬ed
,…2m->
deçuÉ_acûss
);

2828 iàĞ
Ãed_lock
 )

2829 
	`p2m_uÆock
(
p2m
);

2830 iàĞ0 =ğ
rc
 )

2831 
	`gd´štk
(
XENLOG_ERR
,

2833 
	`gmâ_to_mâ
(
p2m
->
domaš
, 
gâ
));

2834  
rc
;

2837 #ifdeà
__x86_64__


2838 
	`p2m_mem_·gšg_nomš©e
(
p2m_domaš
 *
p2m
, 
gâ
)

2840 
·ge_šfo
 *
·ge
;

2841 
p2m_ty³_t
 
p2mt
;

2842 
mâ_t
 
mâ
;

2843 
»t
;

2845 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
);

2848 
»t
 = -
EINVAL
;

2849 iàĞ!
	`mâ_v®id
(
mâ
) )

2850 
out
;

2853 
»t
 = -
EAGAIN
;

2854 iàĞ!
	`p2m_is_·g—bË
(
p2mt
) )

2855 
out
;

2858 iàĞ
	`is_iomem_·ge
(
	`mâ_x
(
mâ
)) )

2859 
out
;

2862 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

2863 iàĞ(
·ge
->
couÁ_šfo
 & (
PGC_couÁ_mask
 | 
PGC_®loÿ‹d
)) !=

2864 (1 | 
PGC_®loÿ‹d
) )

2865 
out
;

2867 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_nÚe
 )

2868 
out
;

2871 
	`p2m_lock
(
p2m
);

2872 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
mâ
, 0, 
p2m_¿m_·gšg_out
,…2m->
deçuÉ_acûss
);

2873 
	`aud™_p2m
(
p2m
, 1);

2874 
	`p2m_uÆock
(
p2m
);

2876 
»t
 = 0;

2878 
out
:

2879  
»t
;

2882 
	`p2m_mem_·gšg_eviù
(
p2m_domaš
 *
p2m
, 
gâ
)

2884 
·ge_šfo
 *
·ge
;

2885 
p2m_ty³_t
 
p2mt
;

2886 
mâ_t
 
mâ
;

2887 
domaš
 *
d
 = 
p2m
->domain;

2890 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
);

2891 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
mâ
)) )

2892  -
EINVAL
;

2894 iàĞ(
p2mt
 =ğ
p2m_¿m_·ged
è|| (p2mˆ=ğ
p2m_¿m_·gšg_š
) ||

2895 (
p2mt
 =ğ
p2m_¿m_·gšg_š_¡¬t
) )

2896  -
EINVAL
;

2899 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

2900 iàĞ
	`uÆik–y
(!
	`g‘_·ge
(
·ge
, 
d
)) )

2901  -
EINVAL
;

2904 iàĞ
	`‹¡_ªd_ş—r_b™
(
_PGC_®loÿ‹d
, &
·ge
->
couÁ_šfo
) )

2905 
	`put_·ge
(
·ge
);

2908 
	`p2m_lock
(
p2m
);

2909 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
PAGING_MFN
), 0, 
p2m_¿m_·ged
,…2m->
deçuÉ_acûss
);

2910 
	`aud™_p2m
(
p2m
, 1);

2911 
	`p2m_uÆock
(
p2m
);

2914 
	`put_·ge
(
·ge
);

2919 
	`p2m_mem_·gšg_drİ_·ge
(
p2m_domaš
 *
p2m
, 
gâ
)

2921 
vıu
 *
v
 = 
cu¼’t
;

2922 
mem_ev’t_»que¡_t
 
»q
;

2923 
domaš
 *
d
 = 
p2m
->domain;

2926 iàĞ
	`mem_ev’t_check_ršg
(
d
) == 0)

2929 
	`mem£t
(&
»q
, 0, (req));

2930 
»q
.
æags
 |ğ
MEM_EVENT_FLAG_DROP_PAGE
;

2931 
»q
.
gâ
 = gfn;

2932 
»q
.
vıu_id
 = 
v
->vcpu_id;

2934 
	`mem_ev’t_put_»que¡
(
d
, &
»q
);

2938 
	`p2m_mem_·gšg_pİuÏ‹
(
p2m_domaš
 *
p2m
, 
gâ
)

2940 
vıu
 *
v
 = 
cu¼’t
;

2941 
mem_ev’t_»que¡_t
 
»q
;

2942 
p2m_ty³_t
 
p2mt
;

2943 
domaš
 *
d
 = 
p2m
->domain;

2946 iàĞ
	`mem_ev’t_check_ršg
(
d
) )

2949 
	`mem£t
(&
»q
, 0, (req));

2950 
»q
.
ty³
 = 
MEM_EVENT_TYPE_PAGING
;

2955 
	`gâ_to_mâ
(
p2m
, 
gâ
, &
p2mt
);

2956 iàĞ
p2mt
 =ğ
p2m_¿m_·ged
 )

2958 
	`p2m_lock
(
p2m
);

2959 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`_mâ
(
PAGING_MFN
), 0, 
p2m_¿m_·gšg_š_¡¬t
,…2m->
deçuÉ_acûss
);

2960 
	`aud™_p2m
(
p2m
, 1);

2961 
	`p2m_uÆock
(
p2m
);

2965 iàĞ
v
->
domaš
->
domaš_id
 =ğ
d
->domain_id )

2967 
	`vıu_·u£_nosync
(
v
);

2968 
»q
.
æags
 |ğ
MEM_EVENT_FLAG_VCPU_PAUSED
;

2970 iàĞ
p2mt
 !ğ
p2m_¿m_·gšg_out
 &&…2mˆ!ğ
p2m_¿m_·ged
 )

2977 
»q
.
gâ
 = gfn;

2978 
»q
.
p2mt
 =…2mt;

2979 
»q
.
vıu_id
 = 
v
->vcpu_id;

2981 
	`mem_ev’t_put_»que¡
(
d
, &
»q
);

2984 
	`p2m_mem_·gšg_´•
(
p2m_domaš
 *
p2m
, 
gâ
)

2986 
·ge_šfo
 *
·ge
;

2989 
·ge
 = 
	`®loc_domh—p_·ge
(
p2m
->
domaš
, 0);

2990 iàĞ
	`uÆik–y
(
·ge
 =ğ
NULL
) )

2991  -
ENOMEM
;

2994 
	`p2m_lock
(
p2m
);

2995 
	`£t_p2m_’Œy
(
p2m
, 
gâ
, 
	`·ge_to_mâ
(
·ge
), 0, 
p2m_¿m_·gšg_š
,…2m->
deçuÉ_acûss
);

2996 
	`aud™_p2m
(
p2m
, 1);

2997 
	`p2m_uÆock
(
p2m
);

3002 
	`p2m_mem_·gšg_»sume
(
p2m_domaš
 *
p2m
)

3004 
domaš
 *
d
 = 
p2m
->domain;

3005 
mem_ev’t_»¥Ú£_t
 
r¥
;

3006 
p2m_ty³_t
 
p2mt
;

3007 
mâ_t
 
mâ
;

3010 
	`mem_ev’t_g‘_»¥Ú£
(
d
, &
r¥
);

3013 iàĞ!(
r¥
.
æags
 & 
MEM_EVENT_FLAG_DROP_PAGE
) )

3015 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
r¥
.
gâ
, &
p2mt
);

3016 
	`p2m_lock
(
p2m
);

3017 
	`£t_p2m_’Œy
(
p2m
, 
r¥
.
gâ
, 
mâ
, 0, 
p2m_¿m_rw
,…2m->
deçuÉ_acûss
);

3018 
	`£t_gpâ_äom_mâ
(
	`mâ_x
(
mâ
), 
r¥
.
gâ
);

3019 
	`aud™_p2m
(
p2m
, 1);

3020 
	`p2m_uÆock
(
p2m
);

3024 iàĞ
r¥
.
æags
 & 
MEM_EVENT_FLAG_VCPU_PAUSED
 )

3025 
	`vıu_uÅau£
(
d
->
vıu
[
r¥
.
vıu_id
]);

3028 
	`mem_ev’t_uÅau£_vıus
(
d
);

3031 
	`p2m_mem_acûss_check
(
g·
, 
boŞ_t
 
gÏ_v®id
, 
gÏ
,

3032 
boŞ_t
 
acûss_r
, boŞ_ˆ
acûss_w
, boŞ_ˆ
acûss_x
)

3034 
vıu
 *
v
 = 
cu¼’t
;

3035 
mem_ev’t_»que¡_t
 
»q
;

3036 
gâ
 = 
g·
 >> 
PAGE_SHIFT
;

3037 
domaš
 *
d
 = 
v
->domain;

3038 
p2m_domaš
* 
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3039 
»s
;

3040 
mâ_t
 
mâ
;

3041 
p2m_ty³_t
 
p2mt
;

3042 
p2m_acûss_t
 
p2ma
;

3045 
	`p2m_lock
(
p2m
);

3046 
mâ
 = 
p2m
->
	`g‘_’Œy
Õ2m, 
gâ
, &
p2mt
, &
p2ma
, 
p2m_qu”y
);

3048 iàĞ
acûss_w
 && 
p2ma
 =ğ
p2m_acûss_rx2rw
 )

3050 
p2m
->
	`£t_’Œy
Õ2m, 
gâ
, 
mâ
, 0, 
p2mt
, 
p2m_acûss_rw
);

3051 
	`p2m_uÆock
(
p2m
);

3054 
	`p2m_uÆock
(
p2m
);

3057 
»s
 = 
	`mem_ev’t_check_ršg
(
d
);

3058 iàĞ
»s
 < 0 )

3061 iàĞ
p2m
->
acûss_»quœed
 )

3063 
	`´štk
(
XENLOG_INFO


3065 
v
->
vıu_id
, 
d
->
domaš_id
);

3067 
	`mem_ev’t_m¬k_ªd_·u£
(
v
);

3072 
	`p2m_lock
(
p2m
);

3073 
p2m
->
	`£t_’Œy
Õ2m, 
gâ
, 
mâ
, 0, 
p2mt
, 
p2m_acûss_rwx
);

3074 
	`p2m_uÆock
(
p2m
);

3079 iàĞ
»s
 > 0 )

3082 
	`mem£t
(&
»q
, 0, (req));

3083 
»q
.
ty³
 = 
MEM_EVENT_TYPE_ACCESS
;

3084 
»q
.
»asÚ
 = 
MEM_EVENT_REASON_VIOLATION
;

3087 
	`vıu_·u£_nosync
(
v
);

3088 
»q
.
æags
 |ğ
MEM_EVENT_FLAG_VCPU_PAUSED
;

3091 
»q
.
gâ
 = gfn;

3092 
»q
.
off£t
 = 
g·
 & ((1 << 
PAGE_SHIFT
) - 1);

3093 
»q
.
gÏ_v®id
 = gla_valid;

3094 
»q
.
gÏ
 = gla;

3095 
»q
.
acûss_r
 =‡ccess_r;

3096 
»q
.
acûss_w
 =‡ccess_w;

3097 
»q
.
acûss_x
 =‡ccess_x;

3099 
»q
.
vıu_id
 = 
v
->vcpu_id;

3101 
	`mem_ev’t_put_»que¡
(
d
, &
»q
);

3106 
	`p2m_mem_acûss_»sume
(
p2m_domaš
 *
p2m
)

3108 
domaš
 *
d
 = 
p2m
->domain;

3109 
mem_ev’t_»¥Ú£_t
 
r¥
;

3111 
	`mem_ev’t_g‘_»¥Ú£
(
d
, &
r¥
);

3114 iàĞ
r¥
.
æags
 & 
MEM_EVENT_FLAG_VCPU_PAUSED
 )

3115 
	`vıu_uÅau£
(
d
->
vıu
[
r¥
.
vıu_id
]);

3119 
	`mem_ev’t_uÅau£_vıus
(
d
);

	@mm/paging.c

23 
	~<x’/š™.h
>

24 
	~<asm/·gšg.h
>

25 
	~<asm/shadow.h
>

26 
	~<asm/p2m.h
>

27 
	~<asm/h­.h
>

28 
	~<asm/gue¡_acûss.h
>

29 
	~<x’/numa.h
>

30 
	~<xsm/xsm.h
>

33 
	#PAGING_PRINTK
(
_f
, 
_a
...) \

34 
	`debugŒaû_´štk
("pg: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

35 
	#PAGING_ERROR
(
_f
, 
_a
...) \

36 
	`´štk
("pgƒ¼Ü: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

37 
	#PAGING_DEBUG
(
æag
, 
_f
, 
_a
...) \

39 ià(
PAGING_DEBUG_
 ## 
æag
) \

40 
	`debugŒaû_´štk
("pgdebug: %s(): " 
_f
, 
__func__
, ##
_a
); \

41 } 0)

	)

47 #undeà
mâ_to_·ge


48 
	#mâ_to_·ge
(
_m
è
	`__mâ_to_·ge
(
	`mâ_x
(_m))

	)

49 #undeà
mâ_v®id


50 
	#mâ_v®id
(
_mâ
è
	`__mâ_v®id
(
	`mâ_x
(_mâ))

	)

51 #undeà
·ge_to_mâ


52 
	#·ge_to_mâ
(
_pg
è
	`_mâ
(
	`__·ge_to_mâ
(_pg))

	)

69 
	#log_dœty_lock_š™
(
_d
) \

71 
	`¥š_lock_š™
(&(
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock
); \

72 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
 = -1; \

73 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”_funùiÚ
 = "nobody"; \

74 } 0)

	)

76 
	#log_dœty_lock
(
_d
) \

78 ià(
	`uÆik–y
((
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
==
cu¼’t
->
´oûssÜ
))\

80 
	`´štk
("Error:…aging†og dirty†ock held by %s\n", \

81 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”_funùiÚ
); \

82 
	`BUG
(); \

84 
	`¥š_lock
(&(
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock
); \

85 
	`ASSERT
((
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
 == -1); \

86 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
 = 
cu¼’t
->
´oûssÜ
; \

87 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”_funùiÚ
 = 
__func__
; \

88 } 0)

	)

90 
	#log_dœty_uÆock
(
_d
) \

92 
	`ASSERT
((
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
 =ğ
cu¼’t
->
´oûssÜ
); \

93 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”
 = -1; \

94 (
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock”_funùiÚ
 = "nobody"; \

95 
	`¥š_uÆock
(&(
_d
)->
¬ch
.
·gšg
.
log_dœty
.
lock
); \

96 } 0)

	)

98 
mâ_t
 
	$·gšg_Ãw_log_dœty_·ge
(
domaš
 *
d
)

100 
·ge_šfo
 *
·ge
;

102 
·ge
 = 
d
->
¬ch
.
·gšg
.
	`®loc_·ge
(d);

103 iàĞ
	`uÆik–y
(
·ge
 =ğ
NULL
) )

105 
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
++;

106  
	`_mâ
(
INVALID_MFN
);

109 
d
->
¬ch
.
·gšg
.
log_dœty
.
®locs
++;

111  
	`·ge_to_mâ
(
·ge
);

112 
	}
}

115 *
	$·gšg_Ãw_log_dœty_Ëaf
(
mâ_t
 
mâ
)

117 *
Ëaf
 = 
NULL
;

118 iàĞ
	`mâ_v®id
(
mâ
) )

120 
Ëaf
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

121 
	`ş—r_·ge
(
Ëaf
);

123  
Ëaf
;

124 
	}
}

127 
mâ_t
 *
	$·gšg_Ãw_log_dœty_node
(
mâ_t
 
mâ
)

129 
i
;

130 
mâ_t
 *
node
 = 
NULL
;

131 iàĞ
	`mâ_v®id
(
mâ
) )

133 
node
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

134  
i
 = 0; i < 
LOGDIRTY_NODE_ENTRIES
; i++ )

135 
node
[
i
] = 
	`_mâ
(
INVALID_MFN
);

137  
node
;

138 
	}
}

141 
mâ_t
 *
	$·gšg_m­_log_dœty_b™m­
(
domaš
 *
d
)

143 iàĞ
	`lik–y
(
	`mâ_v®id
(
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
)) )

144  
	`m­_domaš_·ge
(
	`mâ_x
(
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
));

145  
NULL
;

146 
	}
}

148 
	$·gšg_ä“_log_dœty_·ge
(
domaš
 *
d
, 
mâ_t
 
mâ
)

150 
d
->
¬ch
.
·gšg
.
log_dœty
.
®locs
--;

151 
d
->
¬ch
.
·gšg
.
	`ä“_·ge
(d, 
	`mâ_to_·ge
(
mâ
));

152 
	}
}

154 
	$·gšg_ä“_log_dœty_b™m­
(
domaš
 *
d
)

156 
mâ_t
 *
l4
, *
l3
, *
l2
;

157 
i4
, 
i3
, 
i2
;

159 iàĞ!
	`mâ_v®id
(
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
) )

162 
l4
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
));

164  
i4
 = 0; i4 < 
LOGDIRTY_NODE_ENTRIES
; i4++ )

166 iàĞ!
	`mâ_v®id
(
l4
[
i4
]) )

169 
l3
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
l4
[
i4
]));

171  
i3
 = 0; i3 < 
LOGDIRTY_NODE_ENTRIES
; i3++ )

173 iàĞ!
	`mâ_v®id
(
l3
[
i3
]) )

176 
l2
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
l3
[
i3
]));

178  
i2
 = 0; i2 < 
LOGDIRTY_NODE_ENTRIES
; i2++ )

179 iàĞ
	`mâ_v®id
(
l2
[
i2
]) )

180 
	`·gšg_ä“_log_dœty_·ge
(
d
, 
l2
[
i2
]);

182 
	`unm­_domaš_·ge
(
l2
);

183 
	`·gšg_ä“_log_dœty_·ge
(
d
, 
l3
[
i3
]);

186 
	`unm­_domaš_·ge
(
l3
);

187 
	`·gšg_ä“_log_dœty_·ge
(
d
, 
l4
[
i4
]);

190 
	`unm­_domaš_·ge
(
l4
);

191 
	`·gšg_ä“_log_dœty_·ge
(
d
, d->
¬ch
.
·gšg
.
log_dœty
.
tİ
);

193 
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
 = 
	`_mâ
(
INVALID_MFN
);

194 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
log_dœty
.
®locs
 == 0);

195 
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
 = 0;

196 
	}
}

198 
	$·gšg_log_dœty_’abË
(
domaš
 *
d
)

200 
»t
;

202 iàĞ
	`·gšg_mode_log_dœty
(
d
) )

203  -
EINVAL
;

205 
	`domaš_·u£
(
d
);

206 
»t
 = 
d
->
¬ch
.
·gšg
.
log_dœty
.
	`’abË_log_dœty
(d);

207 
	`domaš_uÅau£
(
d
);

209  
»t
;

210 
	}
}

212 
	$·gšg_log_dœty_di§bË
(
domaš
 *
d
)

214 
»t
;

216 
	`domaš_·u£
(
d
);

218 
»t
 = 
d
->
¬ch
.
·gšg
.
log_dœty
.
	`di§bË_log_dœty
(d);

219 
	`log_dœty_lock
(
d
);

220 iàĞ!
	`·gšg_mode_log_dœty
(
d
) )

221 
	`·gšg_ä“_log_dœty_b™m­
(
d
);

222 
	`log_dœty_uÆock
(
d
);

223 
	`domaš_uÅau£
(
d
);

225  
»t
;

226 
	}
}

229 
	$·gšg_m¬k_dœty
(
domaš
 *
d
, 
gue¡_mâ
)

231 
pâ
;

232 
mâ_t
 
gmâ
, 
Ãw_mâ
;

233 
chªged
;

234 
mâ_t
 
mâ
, *
l4
, *
l3
, *
l2
;

235 *
l1
;

236 
i1
, 
i2
, 
i3
, 
i4
;

238 
gmâ
 = 
	`_mâ
(
gue¡_mâ
);

240 iàĞ!
	`·gšg_mode_log_dœty
(
d
è|| !
	`mâ_v®id
(
gmâ
) ||

241 
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
gmâ
)è!ğ
d
 )

245 
pâ
 = 
	`g‘_gpâ_äom_mâ
(
	`mâ_x
(
gmâ
));

247 
	`BUG_ON
(
	`SHARED_M2P
(
pâ
));

254 iàĞ
	`uÆik–y
(!
	`VALID_M2P
(
pâ
)) )

257 
i1
 = 
	`L1_LOGDIRTY_IDX
(
pâ
);

258 
i2
 = 
	`L2_LOGDIRTY_IDX
(
pâ
);

259 
i3
 = 
	`L3_LOGDIRTY_IDX
(
pâ
);

260 
i4
 = 
	`L4_LOGDIRTY_IDX
(
pâ
);

266 
Ãw_mâ
 = 
	`_mâ
(
INVALID_MFN
);

268 
agaš
:

269 
	`log_dœty_lock
(
d
);

271 
l4
 = 
	`·gšg_m­_log_dœty_b™m­
(
d
);

272 iàĞ
	`uÆik–y
(!
l4
) )

274 
l4
 = 
	`·gšg_Ãw_log_dœty_node
(
Ãw_mâ
);

275 
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
 = 
Ãw_mâ
;

276 
Ãw_mâ
 = 
	`_mâ
(
INVALID_MFN
);

278 iàĞ
	`uÆik–y
(!
l4
) )

279 
oom
;

281 
mâ
 = 
l4
[
i4
];

282 iàĞ!
	`mâ_v®id
(
mâ
) )

284 
l3
 = 
	`·gšg_Ãw_log_dœty_node
(
Ãw_mâ
);

285 
mâ
 = 
l4
[
i4
] = 
Ãw_mâ
;

286 
Ãw_mâ
 = 
	`_mâ
(
INVALID_MFN
);

289 
l3
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

290 
	`unm­_domaš_·ge
(
l4
);

291 iàĞ
	`uÆik–y
(!
l3
) )

292 
oom
;

294 
mâ
 = 
l3
[
i3
];

295 iàĞ!
	`mâ_v®id
(
mâ
) )

297 
l2
 = 
	`·gšg_Ãw_log_dœty_node
(
Ãw_mâ
);

298 
mâ
 = 
l3
[
i3
] = 
Ãw_mâ
;

299 
Ãw_mâ
 = 
	`_mâ
(
INVALID_MFN
);

302 
l2
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

303 
	`unm­_domaš_·ge
(
l3
);

304 iàĞ
	`uÆik–y
(!
l2
) )

305 
oom
;

307 
mâ
 = 
l2
[
i2
];

308 iàĞ!
	`mâ_v®id
(
mâ
) )

310 
l1
 = 
	`·gšg_Ãw_log_dœty_Ëaf
(
Ãw_mâ
);

311 
mâ
 = 
l2
[
i2
] = 
Ãw_mâ
;

312 
Ãw_mâ
 = 
	`_mâ
(
INVALID_MFN
);

315 
l1
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

316 
	`unm­_domaš_·ge
(
l2
);

317 iàĞ
	`uÆik–y
(!
l1
) )

318 
oom
;

320 
chªged
 = !
	`__‹¡_ªd_£t_b™
(
i1
, 
l1
);

321 
	`unm­_domaš_·ge
(
l1
);

322 iàĞ
chªged
 )

324 
	`PAGING_DEBUG
(
LOGDIRTY
,

325 "m¬ked mâ %" 
PRI_mâ
 " (pfn=%lx), dom %d\n",

326 
	`mâ_x
(
gmâ
), 
pâ
, 
d
->
domaš_id
);

327 
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
++;

330 
	`log_dœty_uÆock
(
d
);

331 iàĞ
	`mâ_v®id
(
Ãw_mâ
) )

332 
	`·gšg_ä“_log_dœty_·ge
(
d
, 
Ãw_mâ
);

335 
oom
:

336 
	`log_dœty_uÆock
(
d
);

337 
Ãw_mâ
 = 
	`·gšg_Ãw_log_dœty_·ge
(
d
);

338 iàĞ!
	`mâ_v®id
(
Ãw_mâ
) )

341 
agaš
;

342 
	}
}

346 
	$·gšg_mâ_is_dœty
(
domaš
 *
d
, 
mâ_t
 
gmâ
)

348 
pâ
;

349 
mâ_t
 
mâ
, *
l4
, *
l3
, *
l2
;

350 *
l1
;

351 
rv
 = 0;

353 
	`log_dœty_lock
(
d
);

354 
	`ASSERT
(
	`·gšg_mode_log_dœty
(
d
));

357 
pâ
 = 
	`g‘_gpâ_äom_mâ
(
	`mâ_x
(
gmâ
));

359 iàĞ
	`uÆik–y
(
	`SHARED_M2P
(
pâ
è|| !
	`VALID_M2P
(pfn)) )

360 
out
;

362 
mâ
 = 
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
;

363 iàĞ!
	`mâ_v®id
(
mâ
) )

364 
out
;

366 
l4
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

367 
mâ
 = 
l4
[
	`L4_LOGDIRTY_IDX
(
pâ
)];

368 
	`unm­_domaš_·ge
(
l4
);

369 iàĞ!
	`mâ_v®id
(
mâ
) )

370 
out
;

372 
l3
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

373 
mâ
 = 
l3
[
	`L3_LOGDIRTY_IDX
(
pâ
)];

374 
	`unm­_domaš_·ge
(
l3
);

375 iàĞ!
	`mâ_v®id
(
mâ
) )

376 
out
;

378 
l2
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

379 
mâ
 = 
l2
[
	`L2_LOGDIRTY_IDX
(
pâ
)];

380 
	`unm­_domaš_·ge
(
l2
);

381 iàĞ!
	`mâ_v®id
(
mâ
) )

382 
out
;

384 
l1
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

385 
rv
 = 
	`‹¡_b™
(
	`L1_LOGDIRTY_IDX
(
pâ
), 
l1
);

386 
	`unm­_domaš_·ge
(
l1
);

388 
out
:

389 
	`log_dœty_uÆock
(
d
);

390  
rv
;

391 
	}
}

396 
	$·gšg_log_dœty_İ
(
domaš
 *
d
, 
x’_domùl_shadow_İ
 *
sc
)

398 
rv
 = 0, 
ş—n
 = 0, 
³ek
 = 1;

399 
·ges
 = 0;

400 
mâ_t
 *
l4
, *
l3
, *
l2
;

401 *
l1
;

402 
i4
, 
i3
, 
i2
;

404 
	`domaš_·u£
(
d
);

405 
	`log_dœty_lock
(
d
);

407 
ş—n
 = (
sc
->
İ
 =ğ
XEN_DOMCTL_SHADOW_OP_CLEAN
);

409 
	`PAGING_DEBUG
(
LOGDIRTY
, "log-dirty %s: dom %u faults=%u dirty=%u\n",

410 (
ş—n
) ? "clean" : "peek",

411 
d
->
domaš_id
,

412 
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
,

413 
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
);

415 
sc
->
¡©s
.
çuÉ_couÁ
 = 
d
->
¬ch
.
·gšg
.
log_dœty
.fault_count;

416 
sc
->
¡©s
.
dœty_couÁ
 = 
d
->
¬ch
.
·gšg
.
log_dœty
.dirty_count;

418 iàĞ
ş—n
 )

420 
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
 = 0;

421 
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
 = 0;

424 iàĞ
	`gue¡_hªdË_is_nuÎ
(
sc
->
dœty_b™m­
) )

426 
³ek
 = 0;

428 iàĞ
	`uÆik–y
(
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
) ) {

429 
	`´štk
("%s: %d failed…age‡llocs while†ogging dirty…ages\n",

430 
__FUNCTION__
, 
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
);

431 
rv
 = -
ENOMEM
;

432 
out
;

435 
·ges
 = 0;

436 
l4
 = 
	`·gšg_m­_log_dœty_b™m­
(
d
);

438  
i4
 = 0;

439 (
·ges
 < 
sc
->·gesè&& (
i4
 < 
LOGDIRTY_NODE_ENTRIES
);

440 
i4
++ )

442 
l3
 = (
l4
 && 
	`mâ_v®id
Ö4[
i4
])è? 
	`m­_domaš_·ge
(
	`mâ_x
Ö4[i4])è: 
NULL
;

443  
i3
 = 0;

444 (
·ges
 < 
sc
->·gesè&& (
i3
 < 
LOGDIRTY_NODE_ENTRIES
);

445 
i3
++ )

447 
l2
 = ((
l3
 && 
	`mâ_v®id
Ö3[
i3
])) ?

448 
	`m­_domaš_·ge
(
	`mâ_x
(
l3
[
i3
])è: 
NULL
);

449  
i2
 = 0;

450 (
·ges
 < 
sc
->·gesè&& (
i2
 < 
LOGDIRTY_NODE_ENTRIES
);

451 
i2
++ )

453 
z”Ûs
[
PAGE_SIZE
/
BYTES_PER_LONG
];

454 
by‹s
 = 
PAGE_SIZE
;

455 
l1
 = ((
l2
 && 
	`mâ_v®id
Ö2[
i2
])) ?

456 
	`m­_domaš_·ge
(
	`mâ_x
(
l2
[
i2
])è: 
z”Ûs
);

457 iàĞ
	`uÆik–y
(((
sc
->
·ges
 -…age + 7è>> 3è< 
by‹s
) )

458 
by‹s
 = ()((
sc
->
·ges
 -…ages + 7) >> 3);

459 iàĞ
	`lik–y
(
³ek
) )

461 iàĞ
	`cİy_to_gue¡_off£t
(
sc
->
dœty_b™m­
, 
·ges
 >> 3,

462 (
ušt8_t
 *)
l1
, 
by‹s
) != 0 )

464 
rv
 = -
EFAULT
;

465 
out
;

468 iàĞ
ş—n
 && 
l1
 !ğ
z”Ûs
 )

469 
	`ş—r_·ge
(
l1
);

470 
·ges
 +ğ
by‹s
 << 3;

471 iàĞ
l1
 !ğ
z”Ûs
 )

472 
	`unm­_domaš_·ge
(
l1
);

474 iàĞ
l2
 )

475 
	`unm­_domaš_·ge
(
l2
);

477 iàĞ
l3
 )

478 
	`unm­_domaš_·ge
(
l3
);

480 iàĞ
l4
 )

481 
	`unm­_domaš_·ge
(
l4
);

483 iàĞ
·ges
 < 
sc
->pages )

484 
sc
->
·ges
 =…ages;

486 
	`log_dœty_uÆock
(
d
);

488 iàĞ
ş—n
 )

492 
d
->
¬ch
.
·gšg
.
log_dœty
.
	`ş—n_dœty_b™m­
(d);

494 
	`domaš_uÅau£
(
d
);

495  
rv
;

497 
out
:

498 
	`log_dœty_uÆock
(
d
);

499 
	`domaš_uÅau£
(
d
);

500  
rv
;

501 
	}
}

503 
·gšg_log_dœty_¿nge
(
domaš
 *
d
,

504 
begš_pâ
,

505 
Ä
,

506 
	$XEN_GUEST_HANDLE_64
(
ušt8
è
dœty_b™m­
)

508 
rv
 = 0;

509 
·ges
 = 0;

510 
mâ_t
 *
l4
, *
l3
, *
l2
;

511 *
l1
;

512 
b1
, 
b2
, 
b3
, 
b4
;

513 
i2
, 
i3
, 
i4
;

515 
d
->
¬ch
.
·gšg
.
log_dœty
.
	`ş—n_dœty_b™m­
(d);

516 
	`log_dœty_lock
(
d
);

518 
	`PAGING_DEBUG
(
LOGDIRTY
, "log-dirty-range: dom %u faults=%u dirty=%u\n",

519 
d
->
domaš_id
,

520 
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
,

521 
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
);

523 iàĞ
	`uÆik–y
(
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
) ) {

524 
	`´štk
("%s: %d failed…age‡llocs while†ogging dirty…ages\n",

525 
__FUNCTION__
, 
d
->
¬ch
.
·gšg
.
log_dœty
.
çed_®locs
);

526 
rv
 = -
ENOMEM
;

527 
out
;

530 iàĞ!
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
 &&

531 !
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
 ) {

532 
size
 = (
Ä
 + 
BITS_PER_LONG
 - 1) / BITS_PER_LONG;

533 
z”Ûs
[
size
];

534 
	`mem£t
(
z”Ûs
, 0x00, 
size
 * 
BYTES_PER_LONG
);

535 
rv
 = 0;

536 iàĞ
	`cİy_to_gue¡_off£t
(
dœty_b™m­
, 0, (
ušt8_t
 *è
z”Ûs
,

537 
size
 * 
BYTES_PER_LONG
) != 0 )

538 
rv
 = -
EFAULT
;

539 
out
;

541 
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
 = 0;

542 
d
->
¬ch
.
·gšg
.
log_dœty
.
dœty_couÁ
 = 0;

544 
b1
 = 
	`L1_LOGDIRTY_IDX
(
begš_pâ
);

545 
b2
 = 
	`L2_LOGDIRTY_IDX
(
begš_pâ
);

546 
b3
 = 
	`L3_LOGDIRTY_IDX
(
begš_pâ
);

547 
b4
 = 
	`L4_LOGDIRTY_IDX
(
begš_pâ
);

548 
l4
 = 
	`·gšg_m­_log_dœty_b™m­
(
d
);

550  
i4
 = 
b4
;

551 (
·ges
 < 
Ä
è&& (
i4
 < 
LOGDIRTY_NODE_ENTRIES
);

552 
i4
++ )

554 
l3
 = (
l4
 && 
	`mâ_v®id
Ö4[
i4
])è? 
	`m­_domaš_·ge
(
	`mâ_x
Ö4[i4])è: 
NULL
;

555  
i3
 = 
b3
;

556 (
·ges
 < 
Ä
è&& (
i3
 < 
LOGDIRTY_NODE_ENTRIES
);

557 
i3
++ )

559 
l2
 = ((
l3
 && 
	`mâ_v®id
Ö3[
i3
])) ?

560 
	`m­_domaš_·ge
(
	`mâ_x
(
l3
[
i3
])è: 
NULL
);

561  
i2
 = 
b2
;

562 (
·ges
 < 
Ä
è&& (
i2
 < 
LOGDIRTY_NODE_ENTRIES
);

563 
i2
++ )

565 
z”Ûs
[
PAGE_SIZE
/
BYTES_PER_LONG
];

566 
by‹s
 = 
PAGE_SIZE
;

567 
ušt8_t
 *
s
;

568 
l1
 = ((
l2
 && 
	`mâ_v®id
Ö2[
i2
])) ?

569 
	`m­_domaš_·ge
(
	`mâ_x
(
l2
[
i2
])è: 
z”Ûs
);

571 
s
 = ((
ušt8_t
*)
l1
è+ (
b1
 >> 3);

572 
by‹s
 -ğ
b1
 >> 3;

574 iàĞ
	`lik–y
(((
Ä
 - 
·ges
 + 7è>> 3è< 
by‹s
) )

575 
by‹s
 = ()((
Ä
 - 
·ges
 + 7) >> 3);

579 iàĞ
b1
 & 0x7 )

581 
i
, 
j
;

582 
ušt32_t
 *
l
 = (ušt32_t*è
s
;

583 
b™s
 = 
b1
 & 0x7;

584 
b™mask
 = (1 << 
b™s
) - 1;

585 
size
 = (
by‹s
 + 
BYTES_PER_LONG
 - 1) / BYTES_PER_LONG;

586 
b™m­
[
size
];

587 
´š‹d
 = 0;

589 iàĞ
´š‹d
 !ğ
begš_pâ
 )

591 
	`d´štk
(
XENLOG_DEBUG
, "%s: begin_pfn %lx is‚ot 32K‡ligned!\n",

592 
__FUNCTION__
, 
begš_pâ
);

593 
´š‹d
 = 
begš_pâ
;

596  
i
 = 0; i < 
size
 - 1; i++, 
l
++ ) {

597 
b™m­
[
i
] = ((*
l
è>> 
b™s
) |

598 (((*((
ušt8_t
*)(
l
 + 1))è& 
b™mask
è<< ((*lè* 8 - 
b™s
));

600 
s
 = (
ušt8_t
*è
l
;

601 
size
 = 
BYTES_PER_LONG
 - ((
b1
 >> 3) & 0x3);

602 
b™m­
[
i
] = 0;

603  
j
 = 0; j < 
size
; j++, 
s
++ )

604 
b™m­
[
i
] |ğ(*
s
è<< (
j
 * 8);

605 
b™m­
[
i
] = (b™m­[i] >> 
b™s
è| (
b™mask
 << (
size
 * 8 - bits));

606 iàĞ
	`cİy_to_gue¡_off£t
(
dœty_b™m­
, (
·ges
 >> 3),

607 (
ušt8_t
*è
b™m­
, 
by‹s
) != 0 )

609 
rv
 = -
EFAULT
;

610 
out
;

615 iàĞ
	`cİy_to_gue¡_off£t
(
dœty_b™m­
, 
·ges
 >> 3,

616 
s
, 
by‹s
) != 0 )

618 
rv
 = -
EFAULT
;

619 
out
;

623 iàĞ
l1
 !ğ
z”Ûs
 )

624 
	`ş—r_·ge
(
l1
);

625 
·ges
 +ğ
by‹s
 << 3;

626 iàĞ
l1
 !ğ
z”Ûs
 )

627 
	`unm­_domaš_·ge
(
l1
);

628 
b1
 = b1 & 0x7;

630 
b2
 = 0;

631 iàĞ
l2
 )

632 
	`unm­_domaš_·ge
(
l2
);

634 
b3
 = 0;

635 iàĞ
l3
 )

636 
	`unm­_domaš_·ge
(
l3
);

638 iàĞ
l4
 )

639 
	`unm­_domaš_·ge
(
l4
);

641 
	`log_dœty_uÆock
(
d
);

643  
rv
;

645 
out
:

646 
	`log_dœty_uÆock
(
d
);

647  
rv
;

648 
	}
}

657 
·gšg_log_dœty_š™
(
domaš
 *
d
,

658 (*
’abË_log_dœty
)(
domaš
 *
d
),

659 (*
di§bË_log_dœty
)(
domaš
 *
d
),

660 (*
ş—n_dœty_b™m­
)(
domaš
 *
d
))

663 
	`log_dœty_lock_š™
(
d
);

665 
d
->
¬ch
.
·gšg
.
log_dœty
.
’abË_log_dœty
 =ƒnable_log_dirty;

666 
d
->
¬ch
.
·gšg
.
log_dœty
.
di§bË_log_dœty
 = disable_log_dirty;

667 
d
->
¬ch
.
·gšg
.
log_dœty
.
ş—n_dœty_b™m­
 = clean_dirty_bitmap;

668 
d
->
¬ch
.
·gšg
.
log_dœty
.
tİ
 = 
	`_mâ
(
INVALID_MFN
);

669 
	}
}

672 
	$·gšg_log_dœty_‹¬down
(
domaš
*
d
)

674 
	`log_dœty_lock
(
d
);

675 
	`·gšg_ä“_log_dœty_b™m­
(
d
);

676 
	`log_dœty_uÆock
(
d
);

677 
	}
}

682 
	$·gšg_domaš_š™
(
domaš
 *
d
, 
domü_æags
)

684 
rc
;

686 iàĞ(
rc
 = 
	`p2m_š™
(
d
)) != 0 )

687  
rc
;

692 
	`shadow_domaš_š™
(
d
, 
domü_æags
);

695 iàĞ
	`h­_’abËd
(
d
) )

696 
	`h­_domaš_š™
(
d
);

699 
	}
}

702 
	$·gšg_vıu_š™
(
vıu
 *
v
)

704 iàĞ
	`h­_’abËd
(
v
->
domaš
) )

705 
	`h­_vıu_š™
(
v
);

707 
	`shadow_vıu_š™
(
v
);

708 
	}
}

711 
·gšg_domùl
(
domaš
 *
d
, 
x’_domùl_shadow_İ_t
 *
sc
,

712 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

714 
rc
;

716 iàĞ
	`uÆik–y
(
d
 =ğ
cu¼’t
->
domaš
) )

718 
	`gd´štk
(
XENLOG_INFO
, "Triedo do‡…aging op on itself.\n");

719  -
EINVAL
;

722 iàĞ
	`uÆik–y
(
d
->
is_dyšg
) )

724 
	`gd´štk
(
XENLOG_INFO
, "Ignoring…aging op on dying domain %u\n",

725 
d
->
domaš_id
);

729 iàĞ
	`uÆik–y
(
d
->
vıu
 =ğ
NULL
) || unlikely(d->vcpu[0] == NULL) )

731 
	`gd´štk
(
XENLOG_DEBUG
, "Paging op on‡ domain (%u) with‚o vcpus\n",

732 
d
->
domaš_id
);

733  -
EINVAL
;

736 
rc
 = 
	`xsm_shadow_cÚŒŞ
(
d
, 
sc
->
İ
);

737 iàĞ
rc
 )

738  
rc
;

747  
sc
->
İ
 )

750 
XEN_DOMCTL_SHADOW_OP_ENABLE
:

751 iàĞ!(
sc
->
mode
 & 
XEN_DOMCTL_SHADOW_ENABLE_LOG_DIRTY
) )

754 
XEN_DOMCTL_SHADOW_OP_ENABLE_LOGDIRTY
:

755 iàĞ
	`h­_’abËd
(
d
) )

756 
	`h­_logdœty_š™
(
d
);

757  
	`·gšg_log_dœty_’abË
(
d
);

759 
XEN_DOMCTL_SHADOW_OP_OFF
:

760 iàĞ
	`·gšg_mode_log_dœty
(
d
) )

761 iàĞ(
rc
 = 
	`·gšg_log_dœty_di§bË
(
d
)) != 0 )

762  
rc
;

765 
XEN_DOMCTL_SHADOW_OP_CLEAN
:

766 
XEN_DOMCTL_SHADOW_OP_PEEK
:

767  
	`·gšg_log_dœty_İ
(
d
, 
sc
);

771 iàĞ
	`h­_’abËd
(
d
) )

772  
	`h­_domùl
(
d
, 
sc
, 
u_domùl
);

774  
	`shadow_domùl
(
d
, 
sc
, 
u_domùl
);

775 
	}
}

778 
	$·gšg_‹¬down
(
domaš
 *
d
)

780 iàĞ
	`h­_’abËd
(
d
) )

781 
	`h­_‹¬down
(
d
);

783 
	`shadow_‹¬down
(
d
);

786 
	`·gšg_log_dœty_‹¬down
(
d
);

789 
	`p2m_pod_em±y_ÿche
(
d
);

790 
	}
}

793 
	$·gšg_fš®_‹¬down
(
domaš
 *
d
)

795 iàĞ
	`h­_’abËd
(
d
) )

796 
	`h­_fš®_‹¬down
(
d
);

798 
	`shadow_fš®_‹¬down
(
d
);

800 
	`p2m_fš®_‹¬down
(
d
);

801 
	}
}

805 
	$·gšg_’abË
(
domaš
 *
d
, 
u32
 
mode
)

807 iàĞ
	`h­_’abËd
(
d
) )

808  
	`h­_’abË
(
d
, 
mode
 | 
PG_HAP_’abË
);

810  
	`shadow_’abË
(
d
, 
mode
 | 
PG_SH_’abË
);

811 
	}
}

815 
	$·g‘abË_dyšg
(
domaš
 *
d
, 
·ddr_t
 
g·
)

817 
vıu
 *
v
;

819 
	`ASSERT
(
	`·gšg_mode_shadow
(
d
));

821 
v
 = 
d
->
vıu
[0];

822 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`·g‘abË_dyšg
(v, 
g·
);

823 
	}
}

826 
	$·gšg_dump_domaš_šfo
(
domaš
 *
d
)

828 iàĞ
	`·gšg_mode_’abËd
(
d
) )

830 
	`´štk
("…aging‡ssistance: ");

831 iàĞ
	`·gšg_mode_shadow
(
d
) )

832 
	`´štk
("shadow ");

833 iàĞ
	`·gšg_mode_h­
(
d
) )

834 
	`´štk
("hap ");

835 iàĞ
	`·gšg_mode_»fcouÁs
(
d
) )

836 
	`´štk
("refcounts ");

837 iàĞ
	`·gšg_mode_log_dœty
(
d
) )

838 
	`´štk
("log_dirty ");

839 iàĞ
	`·gšg_mode_Œª¦©e
(
d
) )

840 
	`´štk
("translate ");

841 iàĞ
	`·gšg_mode_ex‹º®
(
d
) )

842 
	`´štk
("external ");

843 
	`´štk
("\n");

845 
	}
}

847 
	$·gšg_dump_vıu_šfo
(
vıu
 *
v
)

849 iàĞ
	`·gšg_mode_’abËd
(
v
->
domaš
) )

851 
	`´štk
("…aging‡ssistance: ");

852 iàĞ
	`·gšg_mode_shadow
(
v
->
domaš
) )

854 iàĞ
v
->
¬ch
.
·gšg
.
mode
 )

855 
	`´štk
("shadowed %u-on-%u\n",

856 
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
,

857 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
shadow_Ëv–s
);

859 
	`´štk
("not shadowed\n");

861 iàĞ
	`·gšg_mode_h­
(
v
->
domaš
è&& v->
¬ch
.
·gšg
.
mode
 )

862 
	`´štk
("hap, %u†evels\n",

863 
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
);

865 
	`´štk
("none\n");

867 
	}
}

	@mm/shadow/common.c

24 
	~<x’/cÚfig.h
>

25 
	~<x’/ty³s.h
>

26 
	~<x’/mm.h
>

27 
	~<x’/Œaû.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/³rfc.h
>

30 
	~<x’/œq.h
>

31 
	~<x’/domaš_·ge.h
>

32 
	~<x’/gue¡_acûss.h
>

33 
	~<x’/keyhªdËr.h
>

34 
	~<asm/ev’t.h
>

35 
	~<asm/·ge.h
>

36 
	~<asm/cu¼’t.h
>

37 
	~<asm/æushb.h
>

38 
	~<asm/shadow.h
>

39 
	~<x’/numa.h
>

40 
	~"´iv©e.h
"

42 
DEFINE_PER_CPU
(
ušt32_t
,
Œaû_shadow_·th_æags
);

46 
	$shadow_domaš_š™
(
domaš
 *
d
, 
domü_æags
)

48 
	`shadow_lock_š™
(
d
);

49 
	`INIT_PAGE_LIST_HEAD
(&
d
->
¬ch
.
·gšg
.
shadow
.
ä“li¡
);

50 
	`INIT_PAGE_LIST_HEAD
(&
d
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
);

53 
	`·gšg_log_dœty_š™
(
d
, 
shadow_’abË_log_dœty
,

54 
shadow_di§bË_log_dœty
, 
shadow_ş—n_dœty_b™m­
);

56 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

57 
d
->
¬ch
.
·gšg
.
shadow
.
oos_aùive
 = 0;

58 
d
->
¬ch
.
·gšg
.
shadow
.
oos_off
 = (
domü_æags
 & 
DOMCRF_oos_off
) ? 1 : 0;

60 
d
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg_İ
 = 0;

61 
	}
}

69 
	$shadow_vıu_š™
(
vıu
 *
v
)

71 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

72 
i
, 
j
;

74  
i
 = 0; i < 
SHADOW_OOS_PAGES
; i++ )

76 
v
->
¬ch
.
·gšg
.
shadow
.
oos
[
i
] = 
	`_mâ
(
INVALID_MFN
);

77 
v
->
¬ch
.
·gšg
.
shadow
.
oos_¢­shÙ
[
i
] = 
	`_mâ
(
INVALID_MFN
);

78  
j
 = 0; j < 
SHADOW_OOS_FIXUPS
; j++ )

79 
v
->
¬ch
.
·gšg
.
shadow
.
oos_fixup
[
i
].
smâ
[
j
] = 
	`_mâ
(
INVALID_MFN
);

83 
v
->
¬ch
.
·gšg
.
mode
 = &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 3);

84 
	}
}

86 #ià
SHADOW_AUDIT


87 
	gshadow_aud™_’abË
 = 0;

89 
	$shadow_aud™_key
(
key
)

91 
shadow_aud™_’abË
 = !shadow_audit_enable;

92 
	`´štk
("%s shadow_audit_enable=%d\n",

93 
__func__
, 
shadow_aud™_’abË
);

94 
	}
}

96 
keyhªdËr
 
	gshadow_aud™_keyhªdËr
 = {

97 .
u
.
â
 = 
shadow_aud™_key
,

98 .
	gdesc
 = "toggle shadow‡udits"

101 
__š™
 
	$shadow_aud™_key_š™
()

103 
	`»gi¡”_keyhªdËr
('O', &
shadow_aud™_keyhªdËr
);

105 
	}
}

106 
__š™ÿÎ
(
shadow_aud™_key_š™
);

109 
	$_shadow_mode_»fcouÁs
(
domaš
 *
d
)

111  
	`shadow_mode_»fcouÁs
(
d
);

112 
	}
}

119 
£gm’t_»gi¡”
 *
	$hvm_g‘_£g_»g
(

120 
x86_£gm’t
 
£g
, 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

122 
£gm’t_»gi¡”
 *
£g_»g
 = &
sh_ùxt
->£g_»g[
£g
];

123 iàĞ!
	`__‹¡_ªd_£t_b™
(
£g
, &
sh_ùxt
->
v®id_£g_»gs
) )

124 
	`hvm_g‘_£gm’t_»gi¡”
(
cu¼’t
, 
£g
, 
£g_»g
);

125  
£g_»g
;

126 
	}
}

128 
	$hvm_Œª¦©e_lš—r_addr
(

129 
x86_£gm’t
 
£g
,

130 
off£t
,

131 
by‹s
,

132 
hvm_acûss_ty³
 
acûss_ty³
,

133 
sh_emuÏ‹_ùxt
 *
sh_ùxt
,

134 *
·ddr
)

136 
£gm’t_»gi¡”
 *
»g
 = 
	`hvm_g‘_£g_»g
(
£g
, 
sh_ùxt
);

137 
okay
;

139 
okay
 = 
	`hvm_vœtu®_to_lš—r_addr
(

140 
£g
, 
»g
, 
off£t
, 
by‹s
, 
acûss_ty³
, 
sh_ùxt
->
ùxt
.
addr_size
, 
·ddr
);

142 iàĞ!
okay
 )

144 
	`hvm_šjeù_exû±iÚ
(
TRAP_gp_çuÉ
, 0, 0);

145  
X86EMUL_EXCEPTION
;

149 
	}
}

152 
	$hvm_»ad
(
x86_£gm’t
 
£g
,

153 
off£t
,

154 *
p_d©a
,

155 
by‹s
,

156 
hvm_acûss_ty³
 
acûss_ty³
,

157 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

159 
addr
;

160 
rc
;

162 
rc
 = 
	`hvm_Œª¦©e_lš—r_addr
(

163 
£g
, 
off£t
, 
by‹s
, 
acûss_ty³
, 
sh_ùxt
, &
addr
);

164 iàĞ
rc
 )

165  
rc
;

167 iàĞ
acûss_ty³
 =ğ
hvm_acûss_š¢_ãtch
 )

168 
rc
 = 
	`hvm_ãtch_äom_gue¡_vœt
(
p_d©a
, 
addr
, 
by‹s
, 0);

170 
rc
 = 
	`hvm_cİy_äom_gue¡_vœt
(
p_d©a
, 
addr
, 
by‹s
, 0);

172  
rc
 )

174 
HVMCOPY_okay
:

175  
X86EMUL_OKAY
;

176 
HVMCOPY_bad_gva_to_gâ
:

177  
X86EMUL_EXCEPTION
;

178 
HVMCOPY_bad_gâ_to_mâ
:

179 
HVMCOPY_unhªdËabË
:

180  
X86EMUL_UNHANDLEABLE
;

181 
HVMCOPY_gâ_·ged_out
:

182 
HVMCOPY_gâ_sh¬ed
:

183  
X86EMUL_RETRY
;

186 
	`BUG
();

187  
X86EMUL_UNHANDLEABLE
;

188 
	}
}

191 
	$hvm_emuÏ‹_»ad
(
x86_£gm’t
 
£g
,

192 
off£t
,

193 *
p_d©a
,

194 
by‹s
,

195 
x86_emuÏ‹_ùxt
 *
ùxt
)

197 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

198  
X86EMUL_UNHANDLEABLE
;

199  
	`hvm_»ad
(
£g
, 
off£t
, 
p_d©a
, 
by‹s
, 
hvm_acûss_»ad
,

200 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt));

201 
	}
}

204 
	$hvm_emuÏ‹_š¢_ãtch
(
x86_£gm’t
 
£g
,

205 
off£t
,

206 *
p_d©a
,

207 
by‹s
,

208 
x86_emuÏ‹_ùxt
 *
ùxt
)

210 
sh_emuÏ‹_ùxt
 *
sh_ùxt
 =

211 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt);

212 
š¢_off
 = 
off£t
 - 
sh_ùxt
->
š¢_buf_e
;

214 
	`ASSERT
(
£g
 =ğ
x86_£g_cs
);

217 iàĞ
	`uÆik–y
((
š¢_off
 + 
by‹s
è> 
sh_ùxt
->
š¢_buf_by‹s
) )

218  
	`hvm_»ad
(
£g
, 
off£t
, 
p_d©a
, 
by‹s
,

219 
hvm_acûss_š¢_ãtch
, 
sh_ùxt
);

222 
	`memıy
(
p_d©a
, &
sh_ùxt
->
š¢_buf
[
š¢_off
], 
by‹s
);

223  
X86EMUL_OKAY
;

224 
	}
}

227 
	$hvm_emuÏ‹_wr™e
(
x86_£gm’t
 
£g
,

228 
off£t
,

229 *
p_d©a
,

230 
by‹s
,

231 
x86_emuÏ‹_ùxt
 *
ùxt
)

233 
sh_emuÏ‹_ùxt
 *
sh_ùxt
 =

234 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt);

235 
vıu
 *
v
 = 
cu¼’t
;

236 
addr
;

237 
rc
;

239 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

240  
X86EMUL_UNHANDLEABLE
;

243 iàĞ
£g
 =ğ
x86_£g_ss
 )

244 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_¡ack
);

246 
rc
 = 
	`hvm_Œª¦©e_lš—r_addr
(

247 
£g
, 
off£t
, 
by‹s
, 
hvm_acûss_wr™e
, 
sh_ùxt
, &
addr
);

248 iàĞ
rc
 )

249  
rc
;

251  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_wr™e
(

252 
v
, 
addr
, 
p_d©a
, 
by‹s
, 
sh_ùxt
);

253 
	}
}

256 
	$hvm_emuÏ‹_cmpxchg
(
x86_£gm’t
 
£g
,

257 
off£t
,

258 *
p_Şd
,

259 *
p_Ãw
,

260 
by‹s
,

261 
x86_emuÏ‹_ùxt
 *
ùxt
)

263 
sh_emuÏ‹_ùxt
 *
sh_ùxt
 =

264 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt);

265 
vıu
 *
v
 = 
cu¼’t
;

266 
addr
, 
Şd
[2], 
Ãw
[2];

267 
rc
;

269 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

270  
X86EMUL_UNHANDLEABLE
;

272 
rc
 = 
	`hvm_Œª¦©e_lš—r_addr
(

273 
£g
, 
off£t
, 
by‹s
, 
hvm_acûss_wr™e
, 
sh_ùxt
, &
addr
);

274 iàĞ
rc
 )

275  
rc
;

277 
Şd
[0] = 
Ãw
[0] = 0;

278 
	`memıy
(
Şd
, 
p_Şd
, 
by‹s
);

279 
	`memıy
(
Ãw
, 
p_Ãw
, 
by‹s
);

281 iàĞ
by‹s
 <= () )

282  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_cmpxchg
(

283 
v
, 
addr
, 
Şd
[0], 
Ãw
[0], 
by‹s
, 
sh_ùxt
);

285 #ifdeà
__i386__


286 iàĞ
by‹s
 == 8 )

287  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_cmpxchg8b
(

288 
v
, 
addr
, 
Şd
[0], old[1], 
Ãw
[0],‚ew[1], 
sh_ùxt
);

291  
X86EMUL_UNHANDLEABLE
;

292 
	}
}

294 cÚ¡ 
x86_emuÏ‹_İs
 
	ghvm_shadow_emuÏtÜ_İs
 = {

295 .
»ad
 = 
hvm_emuÏ‹_»ad
,

296 .
	gš¢_ãtch
 = 
hvm_emuÏ‹_š¢_ãtch
,

297 .
	gwr™e
 = 
hvm_emuÏ‹_wr™e
,

298 .
	gcmpxchg
 = 
hvm_emuÏ‹_cmpxchg
,

302 
	$pv_emuÏ‹_»ad
(
x86_£gm’t
 
£g
,

303 
off£t
,

304 *
p_d©a
,

305 
by‹s
,

306 
x86_emuÏ‹_ùxt
 *
ùxt
)

308 
rc
;

310 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

311  
X86EMUL_UNHANDLEABLE
;

313 iàĞ(
rc
 = 
	`cİy_äom_u£r
(
p_d©a
, (*)
off£t
, 
by‹s
)) != 0 )

315 
	`´İag©e_·ge_çuÉ
(
off£t
 + 
by‹s
 - 
rc
, 0);

316  
X86EMUL_EXCEPTION
;

319  
X86EMUL_OKAY
;

320 
	}
}

323 
	$pv_emuÏ‹_wr™e
(
x86_£gm’t
 
£g
,

324 
off£t
,

325 *
p_d©a
,

326 
by‹s
,

327 
x86_emuÏ‹_ùxt
 *
ùxt
)

329 
sh_emuÏ‹_ùxt
 *
sh_ùxt
 =

330 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt);

331 
vıu
 *
v
 = 
cu¼’t
;

332 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

333  
X86EMUL_UNHANDLEABLE
;

334  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_wr™e
(

335 
v
, 
off£t
, 
p_d©a
, 
by‹s
, 
sh_ùxt
);

336 
	}
}

339 
	$pv_emuÏ‹_cmpxchg
(
x86_£gm’t
 
£g
,

340 
off£t
,

341 *
p_Şd
,

342 *
p_Ãw
,

343 
by‹s
,

344 
x86_emuÏ‹_ùxt
 *
ùxt
)

346 
sh_emuÏ‹_ùxt
 *
sh_ùxt
 =

347 
	`cÚš”_of
(
ùxt
, 
sh_emuÏ‹_ùxt
, ctxt);

348 
Şd
[2], 
Ãw
[2];

349 
vıu
 *
v
 = 
cu¼’t
;

351 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

352  
X86EMUL_UNHANDLEABLE
;

354 
Şd
[0] = 
Ãw
[0] = 0;

355 
	`memıy
(
Şd
, 
p_Şd
, 
by‹s
);

356 
	`memıy
(
Ãw
, 
p_Ãw
, 
by‹s
);

358 iàĞ
by‹s
 <= () )

359  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_cmpxchg
(

360 
v
, 
off£t
, 
Şd
[0], 
Ãw
[0], 
by‹s
, 
sh_ùxt
);

362 #ifdeà
__i386__


363 iàĞ
by‹s
 == 8 )

364  
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`x86_emuÏ‹_cmpxchg8b
(

365 
v
, 
off£t
, 
Şd
[0], old[1], 
Ãw
[0],‚ew[1], 
sh_ùxt
);

368  
X86EMUL_UNHANDLEABLE
;

369 
	}
}

371 cÚ¡ 
x86_emuÏ‹_İs
 
	gpv_shadow_emuÏtÜ_İs
 = {

372 .
»ad
 = 
pv_emuÏ‹_»ad
,

373 .
	gš¢_ãtch
 = 
pv_emuÏ‹_»ad
,

374 .
	gwr™e
 = 
pv_emuÏ‹_wr™e
,

375 .
	gcmpxchg
 = 
pv_emuÏ‹_cmpxchg
,

378 cÚ¡ 
x86_emuÏ‹_İs
 *
	$shadow_š™_emuÏtiÚ
(

379 
sh_emuÏ‹_ùxt
 *
sh_ùxt
, 
ıu_u£r_»gs
 *
»gs
)

381 
£gm’t_»gi¡”
 *
üeg
, *
¤eg
;

382 
vıu
 *
v
 = 
cu¼’t
;

383 
addr
;

385 
sh_ùxt
->
ùxt
.
»gs
 =„egs;

386 
sh_ùxt
->
ùxt
.
fÜû_wr™eback
 = 0;

388 iàĞ!
	`is_hvm_vıu
(
v
) )

390 
sh_ùxt
->
ùxt
.
addr_size
 = sh_ùxt->ùxt.
¥_size
 = 
BITS_PER_LONG
;

391  &
pv_shadow_emuÏtÜ_İs
;

395 
sh_ùxt
->
v®id_£g_»gs
 = 0;

396 
üeg
 = 
	`hvm_g‘_£g_»g
(
x86_£g_cs
, 
sh_ùxt
);

399 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
è&& 
üeg
->
©Œ
.
f›lds
.
l
 )

401 
sh_ùxt
->
ùxt
.
addr_size
 = sh_ùxt->ùxt.
¥_size
 = 64;

405 
¤eg
 = 
	`hvm_g‘_£g_»g
(
x86_£g_ss
, 
sh_ùxt
);

406 
sh_ùxt
->
ùxt
.
addr_size
 = 
üeg
->
©Œ
.
f›lds
.
db
 ? 32 : 16;

407 
sh_ùxt
->
ùxt
.
¥_size
 = 
¤eg
->
©Œ
.
f›lds
.
db
 ? 32 : 16;

411 
sh_ùxt
->
š¢_buf_e
 = 
»gs
->
e
;

412 
sh_ùxt
->
š¢_buf_by‹s
 =

413 (!
	`hvm_Œª¦©e_lš—r_addr
(

414 
x86_£g_cs
, 
»gs
->
e
, (
sh_ùxt
->
š¢_buf
),

415 
hvm_acûss_š¢_ãtch
, 
sh_ùxt
, &
addr
) &&

416 !
	`hvm_ãtch_äom_gue¡_vœt_noçuÉ
(

417 
sh_ùxt
->
š¢_buf
, 
addr
, (sh_ctxt->insn_buf), 0))

418 ? (
sh_ùxt
->
š¢_buf
) : 0;

420  &
hvm_shadow_emuÏtÜ_İs
;

421 
	}
}

425 
	$shadow_cÚtšue_emuÏtiÚ
(
sh_emuÏ‹_ùxt
 *
sh_ùxt
,

426 
ıu_u£r_»gs
 *
»gs
)

428 
vıu
 *
v
 = 
cu¼’t
;

429 
addr
, 
diff
;

434 iàĞ
	`is_hvm_vıu
(
v
) )

436 
diff
 = 
»gs
->
e
 - 
sh_ùxt
->
š¢_buf_e
;

437 iàĞ
diff
 > 
sh_ùxt
->
š¢_buf_by‹s
 )

440 
sh_ùxt
->
š¢_buf_by‹s
 =

441 (!
	`hvm_Œª¦©e_lš—r_addr
(

442 
x86_£g_cs
, 
»gs
->
e
, (
sh_ùxt
->
š¢_buf
),

443 
hvm_acûss_š¢_ãtch
, 
sh_ùxt
, &
addr
) &&

444 !
	`hvm_ãtch_äom_gue¡_vœt_noçuÉ
(

445 
sh_ùxt
->
š¢_buf
, 
addr
, (sh_ctxt->insn_buf), 0))

446 ? (
sh_ùxt
->
š¢_buf
) : 0;

447 
sh_ùxt
->
š¢_buf_e
 = 
»gs
->
e
;

450 
	}
}

453 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

501 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_FULL


502 
	$sh_oos_aud™
(
domaš
 *
d
)

504 
idx
, 
ex³ùed_idx
, 
ex³ùed_idx_®t
;

505 
·ge_šfo
 *
pg
;

506 
vıu
 *
v
;

508 
	`fÜ_—ch_vıu
(
d
, 
v
)

510  
idx
 = 0; idx < 
SHADOW_OOS_PAGES
; idx++ )

512 
mâ_t
 *
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

513 iàĞ!
	`mâ_v®id
(
oos
[
idx
]) )

516 
ex³ùed_idx
 = 
	`mâ_x
(
oos
[
idx
]è% 
SHADOW_OOS_PAGES
;

517 
ex³ùed_idx_®t
 = ((
ex³ùed_idx
 + 1è% 
SHADOW_OOS_PAGES
);

518 iàĞ
idx
 !ğ
ex³ùed_idx
 && idx !ğ
ex³ùed_idx_®t
 )

520 
	`´štk
("%s: idx %d contains gmfn %lx,ƒxpected‡t %d or %d.\n",

521 
__func__
, 
idx
, 
	`mâ_x
(
oos
[idx]),

522 
ex³ùed_idx
, 
ex³ùed_idx_®t
);

523 
	`BUG
();

525 
pg
 = 
	`mâ_to_·ge
(
oos
[
idx
]);

526 iàĞ!(
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) )

528 
	`´štk
("%s: idx %x gmâ %lx‚Ù‡…ˆ(couÁ %"
PRIx32
")\n",

529 
__func__
, 
idx
, 
	`mâ_x
(
oos
[idx]), 
pg
->
couÁ_šfo
);

530 
	`BUG
();

532 iàĞ!(
pg
->
shadow_æags
 & 
SHF_out_of_sync
) )

534 
	`´štk
("%s: idx %x gmfn %lx‚ot marked oos (flags %lx)\n",

535 
__func__
, 
idx
, 
	`mâ_x
(
oos
[idx]), 
pg
->
shadow_æags
);

536 
	`BUG
();

538 iàĞ(
pg
->
shadow_æags
 & 
SHF_·ge_ty³_mask
 & ~
SHF_L1_ANY
) )

540 
	`´štk
("%s: idx %x gmfn %lx shadowed‡s‚on-l1 (flags %lx)\n",

541 
__func__
, 
idx
, 
	`mâ_x
(
oos
[idx]), 
pg
->
shadow_æags
);

542 
	`BUG
();

546 
	}
}

549 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES


550 
	$oos_aud™_hash_is_´e£Á
(
domaš
 *
d
, 
mâ_t
 
gmâ
)

552 
idx
;

553 
vıu
 *
v
;

554 
mâ_t
 *
oos
;

556 
	`ASSERT
(
	`mâ_is_out_of_sync
(
gmâ
));

558 
	`fÜ_—ch_vıu
(
d
, 
v
)

560 
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

561 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

562 iàĞ
	`mâ_x
(
oos
[
idx
]è!ğmâ_x(
gmâ
) )

563 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

565 iàĞ
	`mâ_x
(
oos
[
idx
]è=ğmâ_x(
gmâ
) )

569 
	`SHADOW_ERROR
("gmâ %lx m¬ked OOS buˆnÙ iÀhashabË\n", 
	`mâ_x
(
gmâ
));

570 
	`BUG
();

571 
	}
}

575 
šlše
 
	$_sh_»sync_l1
(
vıu
 *
v
, 
mâ_t
 
gmâ
, mâ_ˆ
¢pmâ
)

577 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gmâ
);

579 
	`ASSERT
(
	`mâ_v®id
(
gmâ
));

580 
	`ASSERT
(
	`·ge_is_out_of_sync
(
pg
));

583 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_32
 )

584 
	`SHADOW_INTERNAL_NAME
(
sh_»sync_l1
, 2)(
v
, 
gmâ
, 
¢pmâ
);

585 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_PAE
 )

586 
	`SHADOW_INTERNAL_NAME
(
sh_»sync_l1
, 3)(
v
, 
gmâ
, 
¢pmâ
);

587 #ià
CONFIG_PAGING_LEVELS
 >= 4

588 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_64
 )

589 
	`SHADOW_INTERNAL_NAME
(
sh_»sync_l1
, 4)(
v
, 
gmâ
, 
¢pmâ
);

591 
	}
}

600 
šlše
 
	$oos_fixup_æush_gmâ
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

601 
oos_fixup
 *
fixup
)

603 
i
;

604  
i
 = 0; i < 
SHADOW_OOS_FIXUPS
; i++ )

606 iàĞ
	`mâ_x
(
fixup
->
smâ
[
i
]è!ğ
INVALID_MFN
 )

608 
	`sh_»move_wr™e_acûss_äom_¦1p
(
v
, 
gmâ
,

609 
fixup
->
smâ
[
i
],

610 
fixup
->
off
[
i
]);

611 
fixup
->
smâ
[
i
] = 
	`_mâ
(
INVALID_MFN
);

617 
	}
}

619 
	$oos_fixup_add
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

620 
mâ_t
 
smâ
, 
off
)

622 
idx
, 
Ãxt
;

623 
mâ_t
 *
oos
;

624 
oos_fixup
 *oos_fixup;

625 
domaš
 *
d
 = 
v
->domain;

627 
	`³rfc_šü
(
shadow_oos_fixup_add
);

629 
	`fÜ_—ch_vıu
(
d
, 
v
)

631 
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

632 
oos_fixup
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_fixup;

633 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

634 iàĞ
	`mâ_x
(
oos
[
idx
]è!ğmâ_x(
gmâ
) )

635 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

636 iàĞ
	`mâ_x
(
oos
[
idx
]è=ğmâ_x(
gmâ
) )

638 
i
;

639  
i
 = 0; i < 
SHADOW_OOS_FIXUPS
; i++ )

641 iàĞ
	`mâ_v®id
(
oos_fixup
[
idx
].
smâ
[
i
])

642 && (
	`mâ_x
(
oos_fixup
[
idx
].
smâ
[
i
]) == mfn_x(smfn))

643 && (
oos_fixup
[
idx
].
off
[
i
] == off) )

647 
Ãxt
 = 
oos_fixup
[
idx
].next;

649 iàĞ
	`mâ_x
(
oos_fixup
[
idx
].
smâ
[
Ãxt
]è!ğ
INVALID_MFN
 )

651 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_OOS_FIXUP_EVICT
);

654 
	`sh_»move_wr™e_acûss_äom_¦1p
(
v
, 
gmâ
,

655 
oos_fixup
[
idx
].
smâ
[
Ãxt
],

656 
oos_fixup
[
idx
].
off
[
Ãxt
]);

657 
	`³rfc_šü
(
shadow_oos_fixup_eviù
);

665 
oos_fixup
[
idx
].
smâ
[
Ãxt
] = smfn;

666 
oos_fixup
[
idx
].
off
[
Ãxt
] = off;

667 
oos_fixup
[
idx
].
Ãxt
 = (Ãxˆ+ 1è% 
SHADOW_OOS_FIXUPS
;

669 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_OOS_FIXUP_ADD
);

674 
	`SHADOW_ERROR
("gmâ %lx wa OOS buˆnÙ iÀhashabË\n", 
	`mâ_x
(
gmâ
));

675 
	`BUG
();

676 
	}
}

678 
	$oos_»move_wr™e_acûss
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

679 
oos_fixup
 *
fixup
)

681 
álb
 = 0;

683 
álb
 |ğ
	`oos_fixup_æush_gmâ
(
v
, 
gmâ
, 
fixup
);

685  
	`sh_»move_wr™e_acûss
(
v
, 
gmâ
, 0, 0) )

692 
álb
 |= 1;

701 
	`sh_»move_shadows
(
v
, 
gmâ
, 0 , 1 );

705 iàĞ
álb
 )

706 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

709 
	}
}

712 
šlše
 
	$Œaû_»sync
(
ev’t
, 
mâ_t
 
gmâ
)

714 iàĞ
tb_š™_dÚe
 )

717 
gâ
 = 
	`mâ_to_gâ
(
cu¼’t
->
domaš
, 
gmâ
);

718 
	`__Œaû_v¬
(
ev’t
, 0 , (
gâ
), &gfn);

720 
	}
}

723 
	$_sh_»sync
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

724 
oos_fixup
 *
fixup
, 
mâ_t
 
¢p
)

726 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gmâ
);

728 
	`ASSERT
(
	`shadow_locked_by_me
(
v
->
domaš
));

729 
	`ASSERT
(
	`mâ_is_out_of_sync
(
gmâ
));

731 
	`ASSERT
(!(
	`mâ_to_·ge
(
gmâ
)->
shadow_æags
 & 
SHF_·ge_ty³_mask


732 & ~
SHF_L1_ANY
));

733 
	`ASSERT
(!
	`sh_·ge_has_muÉË_shadows
(
	`mâ_to_·ge
(
gmâ
)));

735 
	`SHADOW_PRINTK
("d=%d, v=%d, gmfn=%05lx\n",

736 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
	`mâ_x
(
gmâ
));

739 iàĞ
	`oos_»move_wr™e_acûss
(
v
, 
gmâ
, 
fixup
) )

746 
pg
->
shadow_æags
 &ğ~
SHF_oos_may_wr™e
;

749 
	`_sh_»sync_l1
(
v
, 
gmâ
, 
¢p
);

752 
pg
->
shadow_æags
 &ğ~
SHF_out_of_sync
;

753 
	`³rfc_šü
(
shadow_»sync
);

754 
	`Œaû_»sync
(
TRC_SHADOW_RESYNC_FULL
, 
gmâ
);

755 
	}
}

759 
	$oos_hash_add
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

761 
i
, 
idx
, 
oidx
, 
sw­
 = 0;

762 *
g±r
, *
g¢µŒ
;

763 
mâ_t
 *
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

764 
mâ_t
 *
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

765 
oos_fixup
 *oos_fixu°ğ
v
->
¬ch
.
·gšg
.
shadow
.oos_fixup;

766 
oos_fixup
 
fixup
 = { .
Ãxt
 = 0 };

768 
i
 = 0; i < 
SHADOW_OOS_FIXUPS
; i++ )

769 
fixup
.
smâ
[
i
] = 
	`_mâ
(
INVALID_MFN
);

771 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

772 
oidx
 = 
idx
;

774 iàĞ
	`mâ_v®id
(
oos
[
idx
])

775 && (
	`mâ_x
(
oos
[
idx
]è% 
SHADOW_OOS_PAGES
) == idx )

778 
	`SWAP
(
oos
[
idx
], 
gmâ
);

779 
	`SWAP
(
oos_fixup
[
idx
], 
fixup
);

780 
sw­
 = 1;

781 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

783 iàĞ
	`mâ_v®id
(
oos
[
idx
]) )

786 
	`_sh_»sync
(
v
, 
oos
[
idx
], &
oos_fixup
[idx], 
oos_¢­shÙ
[idx]);

787 
	`³rfc_šü
(
shadow_unsync_eviù
);

789 
oos
[
idx
] = 
gmâ
;

790 
oos_fixup
[
idx
] = 
fixup
;

792 iàĞ
sw­
 )

793 
	`SWAP
(
oos_¢­shÙ
[
idx
], oos_¢­shÙ[
oidx
]);

795 
g±r
 = 
	`sh_m­_domaš_·ge
(
oos
[
oidx
]);

796 
g¢µŒ
 = 
	`sh_m­_domaš_·ge
(
oos_¢­shÙ
[
oidx
]);

797 
	`memıy
(
g¢µŒ
, 
g±r
, 
PAGE_SIZE
);

798 
	`sh_unm­_domaš_·ge
(
g±r
);

799 
	`sh_unm­_domaš_·ge
(
g¢µŒ
);

800 
	}
}

803 
	$oos_hash_»move
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

805 
idx
;

806 
mâ_t
 *
oos
;

807 
domaš
 *
d
 = 
v
->domain;

809 
	`SHADOW_PRINTK
("D%dV%d gmfn %lx\n",

810 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
	`mâ_x
(
gmâ
));

812 
	`fÜ_—ch_vıu
(
d
, 
v
)

814 
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

815 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

816 iàĞ
	`mâ_x
(
oos
[
idx
]è!ğmâ_x(
gmâ
) )

817 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

818 iàĞ
	`mâ_x
(
oos
[
idx
]è=ğmâ_x(
gmâ
) )

820 
oos
[
idx
] = 
	`_mâ
(
INVALID_MFN
);

825 
	`SHADOW_ERROR
("gmâ %lx wa OOS buˆnÙ iÀhashabË\n", 
	`mâ_x
(
gmâ
));

826 
	`BUG
();

827 
	}
}

829 
mâ_t
 
	$oos_¢­shÙ_lookup
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

831 
idx
;

832 
mâ_t
 *
oos
;

833 
mâ_t
 *
oos_¢­shÙ
;

834 
domaš
 *
d
 = 
v
->domain;

836 
	`fÜ_—ch_vıu
(
d
, 
v
)

838 
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

839 
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

840 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

841 iàĞ
	`mâ_x
(
oos
[
idx
]è!ğmâ_x(
gmâ
) )

842 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

843 iàĞ
	`mâ_x
(
oos
[
idx
]è=ğmâ_x(
gmâ
) )

845  
oos_¢­shÙ
[
idx
];

849 
	`SHADOW_ERROR
("gmâ %lx wa OOS buˆnÙ iÀhashabË\n", 
	`mâ_x
(
gmâ
));

850 
	`BUG
();

851  
	`_mâ
(
INVALID_MFN
);

852 
	}
}

855 
	$sh_»sync
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

857 
idx
;

858 
mâ_t
 *
oos
;

859 
mâ_t
 *
oos_¢­shÙ
;

860 
oos_fixup
 *oos_fixup;

861 
domaš
 *
d
 = 
v
->domain;

863 
	`fÜ_—ch_vıu
(
d
, 
v
)

865 
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

866 
oos_fixup
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_fixup;

867 
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

868 
idx
 = 
	`mâ_x
(
gmâ
è% 
SHADOW_OOS_PAGES
;

869 iàĞ
	`mâ_x
(
oos
[
idx
]è!ğmâ_x(
gmâ
) )

870 
idx
 = (idx + 1è% 
SHADOW_OOS_PAGES
;

872 iàĞ
	`mâ_x
(
oos
[
idx
]è=ğmâ_x(
gmâ
) )

874 
	`_sh_»sync
(
v
, 
gmâ
, &
oos_fixup
[
idx
], 
oos_¢­shÙ
[idx]);

875 
oos
[
idx
] = 
	`_mâ
(
INVALID_MFN
);

880 
	`SHADOW_ERROR
("gmâ %lx wa OOS buˆnÙ iÀhashabË\n", 
	`mâ_x
(
gmâ
));

881 
	`BUG
();

882 
	}
}

886 
	$sh_sk_sync
(
vıu
 *
v
, 
mâ_t
 
gl1mâ
)

888 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

889 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_32
 )

890  
	`SHADOW_INTERNAL_NAME
(
sh_§ã_nÙ_to_sync
, 2)(
v
, 
gl1mâ
);

891 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_PAE
 )

892  
	`SHADOW_INTERNAL_NAME
(
sh_§ã_nÙ_to_sync
, 3)(
v
, 
gl1mâ
);

893 #ià
CONFIG_PAGING_LEVELS
 >= 4

894 iàĞ
pg
->
shadow_æags
 & 
SHF_L1_64
 )

895  
	`SHADOW_INTERNAL_NAME
(
sh_§ã_nÙ_to_sync
, 4)(
v
, 
gl1mâ
);

897 
	`SHADOW_ERROR
("gmfn 0x%lx was OOS but‚ot shadowed‡s‡n†1.\n",

898 
	`mâ_x
(
gl1mâ
));

899 
	`BUG
();

901 
	}
}

909 
	$sh_»sync_®l
(
vıu
 *
v
, 
sk
, 
this
, 
Ùh”s
, 
do_lockšg
)

911 
idx
;

912 
vıu
 *
Ùh”
;

913 
mâ_t
 *
oos
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos;

914 
mâ_t
 *
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

915 
oos_fixup
 *oos_fixu°ğ
v
->
¬ch
.
·gšg
.
shadow
.oos_fixup;

917 
	`SHADOW_PRINTK
("d=%d, v=%d\n", 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

919 
	`ASSERT
(
do_lockšg
 || 
	`shadow_locked_by_me
(
v
->
domaš
));

921 iàĞ!
this
 )

922 
»sync_Ùh”s
;

924 iàĞ
do_lockšg
 )

925 
	`shadow_lock
(
v
->
domaš
);

928  
idx
 = 0; idx < 
SHADOW_OOS_PAGES
; idx++ )

929 iàĞ
	`mâ_v®id
(
oos
[
idx
]) )

932 
	`_sh_»sync
(
v
, 
oos
[
idx
], &
oos_fixup
[idx], 
oos_¢­shÙ
[idx]);

933 
oos
[
idx
] = 
	`_mâ
(
INVALID_MFN
);

936 iàĞ
do_lockšg
 )

937 
	`shadow_uÆock
(
v
->
domaš
);

939 
»sync_Ùh”s
:

940 iàĞ!
Ùh”s
 )

944 
	`fÜ_—ch_vıu
(
v
->
domaš
, 
Ùh”
)

946 iàĞ
v
 =ğ
Ùh”
 )

949 iàĞ
do_lockšg
 )

950 
	`shadow_lock
(
v
->
domaš
);

952 
oos
 = 
Ùh”
->
¬ch
.
·gšg
.
shadow
.oos;

953 
oos_fixup
 = 
Ùh”
->
¬ch
.
·gšg
.
shadow
.oos_fixup;

954 
oos_¢­shÙ
 = 
Ùh”
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

956  
idx
 = 0; idx < 
SHADOW_OOS_PAGES
; idx++ )

958 iàĞ!
	`mâ_v®id
(
oos
[
idx
]) )

961 iàĞ
sk
 )

964 iàĞ
	`sh_sk_sync
(
v
, 
oos
[
idx
]) )

966 
	`Œaû_»sync
(
TRC_SHADOW_RESYNC_ONLY
, 
oos
[
idx
]);

967 
	`_sh_»sync_l1
(
Ùh”
, 
oos
[
idx
], 
oos_¢­shÙ
[idx]);

972 
	`_sh_»sync
(
Ùh”
, 
oos
[
idx
], &
oos_fixup
[idx], 
oos_¢­shÙ
[idx]);

973 
oos
[
idx
] = 
	`_mâ
(
INVALID_MFN
);

977 iàĞ
do_lockšg
 )

978 
	`shadow_uÆock
(
v
->
domaš
);

980 
	}
}

984 
	$sh_unsync
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

986 
·ge_šfo
 *
pg
;

988 
	`ASSERT
(
	`shadow_locked_by_me
(
v
->
domaš
));

990 
	`SHADOW_PRINTK
("d=%d, v=%d, gmfn=%05lx\n",

991 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
	`mâ_x
(
gmâ
));

993 
pg
 = 
	`mâ_to_·ge
(
gmâ
);

998 iàĞ
pg
->
shadow_æags
 &

999 ((
SHF_·ge_ty³_mask
 & ~
SHF_L1_ANY
è| 
SHF_out_of_sync
)

1000 || 
	`sh_·ge_has_muÉË_shadows
(
pg
)

1001 || !
	`is_hvm_domaš
(
v
->
domaš
)

1002 || !
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
oos_aùive
 )

1005 
pg
->
shadow_æags
 |ğ
SHF_out_of_sync
|
SHF_oos_may_wr™e
;

1006 
	`oos_hash_add
(
v
, 
gmâ
);

1007 
	`³rfc_šü
(
shadow_unsync
);

1008 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_UNSYNC
);

1010 
	}
}

1021 
	$shadow_´omÙe
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
ty³
)

1023 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
gmâ
);

1025 
	`ASSERT
(
	`mâ_v®id
(
gmâ
));

1027 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

1029 iàĞ
	`·ge_is_out_of_sync
(
·ge
) )

1030 
	`sh_»sync
(
v
, 
gmâ
);

1034 
	`ASSERT
((
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_wr™abË_·ge


1035 || (
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0

1036 || 
v
->
domaš
->
is_shu‰šg_down
);

1039 iàĞ!
	`‹¡_ªd_£t_b™
(
_PGC_·ge_bË
, &
·ge
->
couÁ_šfo
) )

1040 
·ge
->
shadow_æags
 = 0;

1042 
	`ASSERT
(!
	`‹¡_b™
(
ty³
, &
·ge
->
shadow_æags
));

1043 
	`£t_b™
(
ty³
, &
·ge
->
shadow_æags
);

1044 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_PROMOTE
);

1045 
	}
}

1047 
	$shadow_demÙe
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
ty³
)

1049 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
gmâ
);

1051 
	`ASSERT
(
	`‹¡_b™
(
_PGC_·ge_bË
, &
·ge
->
couÁ_šfo
));

1052 
	`ASSERT
(
	`‹¡_b™
(
ty³
, &
·ge
->
shadow_æags
));

1054 
	`ş—r_b™
(
ty³
, &
·ge
->
shadow_æags
);

1056 iàĞ(
·ge
->
shadow_æags
 & 
SHF_·ge_ty³_mask
) == 0 )

1058 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

1060 iàĞ
	`·ge_is_out_of_sync
(
·ge
) )

1062 
	`oos_hash_»move
(
v
, 
gmâ
);

1065 
	`ş—r_b™
(
_PGC_·ge_bË
, &
·ge
->
couÁ_šfo
);

1068 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_DEMOTE
);

1069 
	}
}

1076 
	$sh_v®id©e_gue¡_’Œy
(
vıu
 *
v
, 
mâ_t
 
gmâ
, *
’Œy
, 
u32
 
size
)

1078 
»suÉ
 = 0;

1079 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
gmâ
);

1081 
	`·gšg_m¬k_dœty
(
v
->
domaš
, 
	`mâ_x
(
gmâ
));

1096 iàĞ!(
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
) )

1099 iàĞ
·ge
->
shadow_æags
 & 
SHF_L1_32
 )

1100 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl1e
, 2)

1101 (
v
, 
gmâ
, 
’Œy
, 
size
);

1102 iàĞ
·ge
->
shadow_æags
 & 
SHF_L2_32
 )

1103 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2e
, 2)

1104 (
v
, 
gmâ
, 
’Œy
, 
size
);

1106 iàĞ
·ge
->
shadow_æags
 & 
SHF_L1_PAE
 )

1107 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl1e
, 3)

1108 (
v
, 
gmâ
, 
’Œy
, 
size
);

1109 iàĞ
·ge
->
shadow_æags
 & 
SHF_L2_PAE
 )

1110 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2e
, 3)

1111 (
v
, 
gmâ
, 
’Œy
, 
size
);

1112 iàĞ
·ge
->
shadow_æags
 & 
SHF_L2H_PAE
 )

1113 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2he
, 3)

1114 (
v
, 
gmâ
, 
’Œy
, 
size
);

1116 #ià
CONFIG_PAGING_LEVELS
 >= 4

1117 iàĞ
·ge
->
shadow_æags
 & 
SHF_L1_64
 )

1118 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl1e
, 4)

1119 (
v
, 
gmâ
, 
’Œy
, 
size
);

1120 iàĞ
·ge
->
shadow_æags
 & 
SHF_L2_64
 )

1121 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2e
, 4)

1122 (
v
, 
gmâ
, 
’Œy
, 
size
);

1123 iàĞ
·ge
->
shadow_æags
 & 
SHF_L2H_64
 )

1124 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2he
, 4)

1125 (
v
, 
gmâ
, 
’Œy
, 
size
);

1126 iàĞ
·ge
->
shadow_æags
 & 
SHF_L3_64
 )

1127 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl3e
, 4)

1128 (
v
, 
gmâ
, 
’Œy
, 
size
);

1129 iàĞ
·ge
->
shadow_æags
 & 
SHF_L4_64
 )

1130 
»suÉ
 |ğ
	`SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl4e
, 4)

1131 (
v
, 
gmâ
, 
’Œy
, 
size
);

1133 
	`ASSERT
((
·ge
->
shadow_æags


1134 & (
SHF_L4_64
|
SHF_L3_64
|
SHF_L2H_64
|
SHF_L2_64
|
SHF_L1_64
)) == 0);

1136 
	`this_ıu
(
Œaû_shadow_·th_æags
è|ğ(
»suÉ
<<(
TRCE_SFLAG_SET_CHANGED
));

1138  
»suÉ
;

1139 
	}
}

1143 
	$sh_v®id©e_gue¡_±_wr™e
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

1144 *
’Œy
, 
u32
 
size
)

1149 
domaš
 *
d
 = 
v
->domain;

1150 
rc
;

1152 
	`ASSERT
(
	`shadow_locked_by_me
(
v
->
domaš
));

1153 
rc
 = 
	`sh_v®id©e_gue¡_’Œy
(
v
, 
gmâ
, 
’Œy
, 
size
);

1154 iàĞ
rc
 & 
SHADOW_SET_FLUSH
 )

1156 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

1157 iàĞ
rc
 & 
SHADOW_SET_ERROR
 )

1164 
	`sh_»move_shadows
(
v
, 
gmâ
, 0, 0);

1166 
	}
}

1168 
	$shadow_wr™e_gue¡_’Œy
(
vıu
 *
v
, 
š‹_t
 *
p
,

1169 
š‹_t
 
Ãw
, 
mâ_t
 
gmâ
)

1173 
çed
;

1174 
	`shadow_lock
(
v
->
domaš
);

1175 
çed
 = 
	`__cİy_to_u£r
(
p
, &
Ãw
, (new));

1176 iàĞ
çed
 !ğ(
Ãw
) )

1177 
	`sh_v®id©e_gue¡_’Œy
(
v
, 
gmâ
, 
p
, (
Ãw
));

1178 
	`shadow_uÆock
(
v
->
domaš
);

1179  (
çed
 == 0);

1180 
	}
}

1182 
	$shadow_cmpxchg_gue¡_’Œy
(
vıu
 *
v
, 
š‹_t
 *
p
,

1183 
š‹_t
 *
Şd
, iÁ±e_ˆ
Ãw
, 
mâ_t
 
gmâ
)

1189 
çed
;

1190 
š‹_t
 
t
 = *
Şd
;

1191 
	`shadow_lock
(
v
->
domaš
);

1192 
çed
 = 
	`cmpxchg_u£r
(
p
, 
t
, 
Ãw
);

1193 iàĞ
t
 =ğ*
Şd
 )

1194 
	`sh_v®id©e_gue¡_’Œy
(
v
, 
gmâ
, 
p
, (
Ãw
));

1195 *
Şd
 = 
t
;

1196 
	`shadow_uÆock
(
v
->
domaš
);

1197  (
çed
 == 0);

1198 
	}
}

1245 
	$shadow_mš_acû±abË_·ges
(
domaš
 *
d
)

1247 
u32
 
vıu_couÁ
 = 1;

1248 
vıu
 *
v
;

1250 
	`fÜ_—ch_vıu
(
d
, 
v
)

1251 
vıu_couÁ
++;

1253  (
vıu_couÁ
 * 128);

1254 
	}
}

1257 
šlše
 
u32


1258 
	$shadow_size
(
shadow_ty³
)

1260 cÚ¡ 
u32
 
ty³_to_size
[
SH_ty³_unu£d
] = {

1279 
	`ASSERT
(
shadow_ty³
 < 
SH_ty³_unu£d
);

1280  
ty³_to_size
[
shadow_ty³
];

1281 
	}
}

1286 
	$shadow_unhook_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
smâ
, 
u£r_Úly
)

1288 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

1289  
¥
->
u
.
sh
.
ty³
 )

1291 
SH_ty³_l2_32_shadow
:

1292 
	`SHADOW_INTERNAL_NAME
(
sh_unhook_32b_m­pšgs
, 2)(
v
, 
smâ
, 
u£r_Úly
);

1294 
SH_ty³_l2_·e_shadow
:

1295 
SH_ty³_l2h_·e_shadow
:

1296 
	`SHADOW_INTERNAL_NAME
(
sh_unhook_·e_m­pšgs
, 3)(
v
, 
smâ
, 
u£r_Úly
);

1298 #ià
CONFIG_PAGING_LEVELS
 >= 4

1299 
SH_ty³_l4_64_shadow
:

1300 
	`SHADOW_INTERNAL_NAME
(
sh_unhook_64b_m­pšgs
, 4)(
v
, 
smâ
, 
u£r_Úly
);

1304 
	`SHADOW_ERROR
("tİ-Ëv– shadow ha bady³ %08x\n", 
¥
->
u
.
sh
.
ty³
);

1305 
	`BUG
();

1307 
	}
}

1309 
šlše
 
	$Œaû_shadow_´—Îoc_uÅš
(
domaš
 *
d
, 
mâ_t
 
smâ
)

1311 iàĞ
tb_š™_dÚe
 )

1314 
gâ
;

1315 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

1316 
gâ
 = 
	`mâ_to_gâ
(
d
, 
	`backpoš‹r
(
	`mâ_to_·ge
(
smâ
)));

1317 
	`__Œaû_v¬
(
TRC_SHADOW_PREALLOC_UNPIN
, 0 , (
gâ
), &gfn);

1319 
	}
}

1323 
	$_shadow_´—Îoc
(

1324 
domaš
 *
d
,

1325 
·ges
)

1329 
vıu
 *
v
, *
v2
;

1330 
·ge_šfo
 *
¥
, *
t
;

1331 
mâ_t
 
smâ
;

1332 
i
;

1334 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 >ğ
·ges
 ) ;

1336 
v
 = 
cu¼’t
;

1337 iàĞ
v
->
domaš
 !ğ
d
 )

1338 
v
 = 
d
->
vıu
[0];

1339 
	`ASSERT
(
v
 !ğ
NULL
);

1342 
	`³rfc_šü
(
shadow_´—Îoc_1
);

1343 
	`fÜ—ch_pšÃd_shadow
(
d
, 
¥
, 
t
)

1345 
smâ
 = 
	`·ge_to_mâ
(
¥
);

1348 
	`Œaû_shadow_´—Îoc_uÅš
(
d
, 
smâ
);

1349 
	`sh_uÅš
(
v
, 
smâ
);

1352 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 >ğ
·ges
 ) ;

1358 
	`³rfc_šü
(
shadow_´—Îoc_2
);

1360 
	`fÜ_—ch_vıu
(
d
, 
v2
)

1361  
i
 = 0 ; i < 4 ; i++ )

1363 iàĞ!
	`·g‘abË_is_nuÎ
(
v2
->
¬ch
.
shadow_bË
[
i
]) )

1365 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_PREALLOC_UNHOOK
);

1366 
	`shadow_unhook_m­pšgs
(
v
,

1367 
	`·g‘abË_g‘_mâ
(
v2
->
¬ch
.
shadow_bË
[
i
]), 0);

1370 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 >ğ
·ges
 )

1372 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

1380 
	`SHADOW_ERROR
("Can't…re-allocate %u shadow…ages!\n"

1382 
·ges
,

1383 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

1384 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

1385 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

1386 
	`BUG
();

1387 
	}
}

1394 
	$shadow_´—Îoc
(
domaš
 *
d
, 
u32
 
ty³
, 
couÁ
)

1396  
	`_shadow_´—Îoc
(
d
, 
	`shadow_size
(
ty³
è* 
couÁ
);

1397 
	}
}

1401 
	$shadow_blow_bËs
(
domaš
 *
d
)

1403 
·ge_šfo
 *
¥
, *
t
;

1404 
vıu
 *
v
 = 
d
->vcpu[0];

1405 
mâ_t
 
smâ
;

1406 
i
;

1408 
	`ASSERT
(
v
 !ğ
NULL
);

1411 
	`fÜ—ch_pšÃd_shadow
(
d
, 
¥
, 
t
)

1413 
smâ
 = 
	`·ge_to_mâ
(
¥
);

1414 
	`sh_uÅš
(
v
, 
smâ
);

1418 
	`fÜ_—ch_vıu
(
d
, 
v
)

1419  
i
 = 0 ; i < 4 ; i++ )

1420 iàĞ!
	`·g‘abË_is_nuÎ
(
v
->
¬ch
.
shadow_bË
[
i
]) )

1421 
	`shadow_unhook_m­pšgs
(
v
,

1422 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[
i
]), 0);

1425 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

1426 
	}
}

1428 
	$shadow_blow_bËs_³r_domaš
(
domaš
 *
d
)

1430 iàĞ
	`shadow_mode_’abËd
(
d
è&& d->
vıu
 !ğ
NULL
 && d->vcpu[0] != NULL ) {

1431 
	`shadow_lock
(
d
);

1432 
	`shadow_blow_bËs
(
d
);

1433 
	`shadow_uÆock
(
d
);

1435 
	}
}

1437 #iâdeà
NDEBUG


1441 
	$shadow_blow_®l_bËs
(
c
)

1443 
domaš
 *
d
;

1444 
	`´štk
("'%c'…»s£d -> blowšg‡Î shadowabËs\n", 
c
);

1445 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

1446 
	`fÜ_—ch_domaš
(
d
)

1448 iàĞ
	`shadow_mode_’abËd
(
d
è&& d->
vıu
 !ğ
NULL
 && d->vcpu[0] != NULL )

1450 
	`shadow_lock
(
d
);

1451 
	`shadow_blow_bËs
(
d
);

1452 
	`shadow_uÆock
(
d
);

1455 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

1456 
	}
}

1458 
keyhªdËr
 
	gshadow_blow_®l_bËs_keyhªdËr
 = {

1459 .
u
.
â
 = 
shadow_blow_®l_bËs
,

1460 .
	gdesc
 = "reset shadow…agetables"

1464 
__š™
 
	$shadow_blow_bËs_keyhªdËr_š™
()

1466 
	`»gi¡”_keyhªdËr
('S', &
shadow_blow_®l_bËs_keyhªdËr
);

1468 
	}
}

1469 
__š™ÿÎ
(
shadow_blow_bËs_keyhªdËr_š™
);

1473 
šlše
 
·ge_šfo
 *

1474 
	$Ãxt_shadow
(cÚ¡ 
·ge_šfo
 *
¥
)

1476  
¥
->
Ãxt_shadow
 ? 
	`pdx_to_·ge
(¥->Ãxt_shadowè: 
NULL
;

1477 
	}
}

1479 
šlše
 

1480 
	$£t_Ãxt_shadow
(
·ge_šfo
 *
¥
, ·ge_šfØ*
Ãxt
)

1482 
¥
->
Ãxt_shadow
 = 
Ãxt
 ? 
	`·ge_to_pdx
(next) : 0;

1483 
	}
}

1488 
mâ_t
 
	$shadow_®loc
(
domaš
 *
d
,

1489 
u32
 
shadow_ty³
,

1490 
backpoš‹r
)

1492 
·ge_šfo
 *
¥
 = 
NULL
;

1493 
·ges
 = 
	`shadow_size
(
shadow_ty³
);

1494 
·ge_li¡_h—d
 
tmp_li¡
;

1495 
ıumask_t
 
mask
;

1496 *
p
;

1497 
i
;

1499 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1500 
	`ASSERT
(
shadow_ty³
 !ğ
SH_ty³_nÚe
);

1501 
	`³rfc_šü
(
shadow_®loc
);

1503 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 < 
·ges
 )

1510 
	`SHADOW_ERROR
("Cª'ˆ®loÿ‹ %˜shadow…ages!\n", 
·ges
);

1511 
	`BUG
();

1513 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 -ğ
·ges
;

1516 
shadow_ty³
)

1518 
SH_ty³_æ1_32_shadow
:

1519 
SH_ty³_æ1_·e_shadow
:

1520 
SH_ty³_æ1_64_shadow
:

1523 
backpoš‹r
 = 
	`pâ_to_pdx
(backpointer);

1530 
	`INIT_PAGE_LIST_HEAD
(&
tmp_li¡
);

1533  
i
 = 0; i < 
·ges
 ; i++ )

1535 
¥
 = 
	`·ge_li¡_»move_h—d
(&
d
->
¬ch
.
·gšg
.
shadow
.
ä“li¡
);

1538 
mask
 = 
d
->
domaš_dœty_ıumask
;

1539 
	`bæush_f‹r
(
mask
, 
¥
->
bæush_time¡amp
);

1540 iàĞ
	`uÆik–y
(!
	`ıus_em±y
(
mask
)) )

1542 
	`³rfc_šü
(
shadow_®loc_bæush
);

1543 
	`æush_b_mask
(&
mask
);

1546 
p
 = 
	`__m­_domaš_·ge
(
¥
);

1547 
	`ASSERT
(
p
 !ğ
NULL
);

1548 
	`ş—r_·ge
(
p
);

1549 
	`sh_unm­_domaš_·ge
(
p
);

1550 
	`INIT_PAGE_LIST_ENTRY
(&
¥
->
li¡
);

1551 
	`·ge_li¡_add
(
¥
, &
tmp_li¡
);

1552 
¥
->
u
.
sh
.
ty³
 = 
shadow_ty³
;

1553 
¥
->
u
.
sh
.
pšÃd
 = 0;

1554 
¥
->
u
.
sh
.
couÁ
 = 0;

1555 
¥
->
u
.
sh
.
h—d
 = 0;

1556 
¥
->
v
.
sh
.
back
 = 
backpoš‹r
;

1557 
	`£t_Ãxt_shadow
(
¥
, 
NULL
);

1558 
	`³rfc_šü
(
shadow_®loc_couÁ
);

1560 iàĞ
shadow_ty³
 >ğ
SH_ty³_mš_shadow


1561 && 
shadow_ty³
 <ğ
SH_ty³_max_shadow
 )

1562 
¥
->
u
.
sh
.
h—d
 = 1;

1563  
	`·ge_to_mâ
(
¥
);

1564 
	}
}

1568 
	$shadow_ä“
(
domaš
 *
d
, 
mâ_t
 
smâ
)

1570 
·ge_šfo
 *
Ãxt
 = 
NULL
, *
¥
 = 
	`mâ_to_·ge
(
smâ
);

1571 
·ges
;

1572 
u32
 
shadow_ty³
;

1573 
i
;

1575 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1576 
	`³rfc_šü
(
shadow_ä“
);

1578 
shadow_ty³
 = 
¥
->
u
.
sh
.
ty³
;

1579 
	`ASSERT
(
shadow_ty³
 !ğ
SH_ty³_nÚe
);

1580 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
 || (
shadow_ty³
 > 
SH_ty³_max_shadow
));

1581 
·ges
 = 
	`shadow_size
(
shadow_ty³
);

1583  
i
 = 0; i < 
·ges
; i++ )

1585 #ià
SHADOW_OPTIMIZATIONS
 & (
SHOPT_WRITABLE_HEURISTIC
 | 
SHOPT_FAST_EMULATION
)

1586 
vıu
 *
v
;

1587 
	`fÜ_—ch_vıu
(
d
, 
v
)

1589 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


1591 iàĞ
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_wr™—bË_±e_smâ


1592 =ğ
	`mâ_x
(
	`·ge_to_mâ
(
¥
)) )

1593 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_wr™—bË_±e_smâ
 = 0;

1595 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


1596 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

1601 iàĞ
i
 < 
·ges
 - 1 )

1602 
Ãxt
 = 
	`pdx_to_·ge
(
¥
->
li¡
.next);

1604 
¥
->
u
.
sh
.
ty³
 = sp->u.sh.
h—d
 = 0;

1609 
¥
->
bæush_time¡amp
 = 
	`bæush_cu¼’t_time
();

1610 
	`³rfc_deü
(
shadow_®loc_couÁ
);

1611 
	`·ge_li¡_add_
(
¥
, &
d
->
¬ch
.
·gšg
.
shadow
.
ä“li¡
);

1612 
¥
 = 
Ãxt
;

1615 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
 +ğ
·ges
;

1616 
	}
}

1622 
·ge_šfo
 *

1623 
	$shadow_®loc_p2m_·ge
(
domaš
 *
d
)

1625 
·ge_šfo
 *
pg
;

1626 
do_lockšg
;

1630 
do_lockšg
 = !
	`shadow_locked_by_me
(
d
);

1631 iàĞ
do_lockšg
 )

1632 
	`shadow_lock
(
d
);

1634 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges


1635 < 
	`shadow_mš_acû±abË_·ges
(
d
) + 1 )

1637 iàĞ
do_lockšg
 )

1638 
	`shadow_uÆock
(
d
);

1639  
NULL
;

1642 
	`shadow_´—Îoc
(
d
, 
SH_ty³_p2m_bË
, 1);

1643 
pg
 = 
	`mâ_to_·ge
(
	`shadow_®loc
(
d
, 
SH_ty³_p2m_bË
, 0));

1644 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
++;

1645 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
--;

1647 iàĞ
do_lockšg
 )

1648 
	`shadow_uÆock
(
d
);

1655 
	`·ge_£t_owÃr
(
pg
, 
d
);

1656 
pg
->
couÁ_šfo
 |= 1;

1657  
pg
;

1658 
	}
}

1661 
	$shadow_ä“_p2m_·ge
(
domaš
 *
d
, 
·ge_šfo
 *
pg
)

1663 
do_lockšg
;

1665 
	`ASSERT
(
	`·ge_g‘_owÃr
(
pg
è=ğ
d
);

1667 iàĞ(
pg
->
couÁ_šfo
 & 
PGC_couÁ_mask
) != 1 )

1669 
	`SHADOW_ERROR
("Odd…2m…agcouÁ c=%#lx=%"
PRty³_šfo
"\n",

1670 
pg
->
couÁ_šfo
,…g->
u
.
šu£
.
ty³_šfo
);

1672 
pg
->
couÁ_šfo
 &ğ~
PGC_couÁ_mask
;

1673 
pg
->
u
.
sh
.
ty³
 = 
SH_ty³_p2m_bË
;

1674 
	`·ge_£t_owÃr
(
pg
, 
NULL
);

1678 
do_lockšg
 = !
	`shadow_locked_by_me
(
d
);

1679 iàĞ
do_lockšg
 )

1680 
	`shadow_lock
(
d
);

1682 
	`shadow_ä“
(
d
, 
	`·ge_to_mâ
(
pg
));

1683 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
--;

1684 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
++;

1686 iàĞ
do_lockšg
 )

1687 
	`shadow_uÆock
(
d
);

1688 
	}
}

1690 #ià
CONFIG_PAGING_LEVELS
 == 3

1691 
	$p2m_š¡®l_’Œy_š_mÚ™Üs
(
domaš
 *
d
,

1692 
l3_pg’Œy_t
 *
l3e
)

1701 
l2_pg’Œy_t
 *
ml2e
;

1702 
vıu
 *
v
;

1703 
šdex
;

1705 
šdex
 = (()
l3e
 & ~
PAGE_MASK
è/ (
l3_pg’Œy_t
);

1706 
	`ASSERT
(
šdex
 < 
MACHPHYS_MBYTES
>>1);

1708 
	`fÜ_—ch_vıu
(
d
, 
v
)

1710 iàĞ
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
mÚ™Ü_bË
) == 0 )

1712 
	`ASSERT
(
	`shadow_mode_ex‹º®
(
v
->
domaš
));

1714 
	`SHADOW_DEBUG
(
P2M
, "d=%u v=%u index=%u mfn=%#lx\n",

1715 
d
->
domaš_id
, 
v
->
vıu_id
, 
šdex
, 
	`l3e_g‘_pâ
(*
l3e
));

1717 iàĞ
v
 =ğ
cu¼’t
 )

1718 
ml2e
 = 
__lš—r_l2_bË
 + 
	`l2_lš—r_off£t
(
RO_MPT_VIRT_START
);

1721 
l3_pg’Œy_t
 *
ml3e
;

1722 
ml3e
 = 
	`sh_m­_domaš_·ge
(
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
));

1723 
	`ASSERT
(
	`l3e_g‘_æags
(
ml3e
[3]è& 
_PAGE_PRESENT
);

1724 
ml2e
 = 
	`sh_m­_domaš_·ge
(
	`_mâ
(
	`l3e_g‘_pâ
(
ml3e
[3])));

1725 
ml2e
 +ğ
	`l2_bË_off£t
(
RO_MPT_VIRT_START
);

1726 
	`sh_unm­_domaš_·ge
(
ml3e
);

1728 
ml2e
[
šdex
] = 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(*
l3e
), 
__PAGE_HYPERVISOR
);

1729 iàĞ
v
 !ğ
cu¼’t
 )

1730 
	`sh_unm­_domaš_·ge
(
ml2e
);

1732 
	}
}

1739 
	$sh_£t_®loÿtiÚ
(
domaš
 *
d
,

1740 
·ges
,

1741 *
´“m±ed
)

1743 
·ge_šfo
 *
¥
;

1744 
low”_bound
;

1746 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1748 iàĞ
·ges
 > 0 )

1751 iàĞ
·ges
 < 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
 )

1752 
·ges
 = 0;

1754 
·ges
 -ğ
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
;

1758 
low”_bound
 = 
	`shadow_mš_acû±abË_·ges
(
d
è+ (d->
tÙ_·ges
 / 256);

1759 iàĞ
·ges
 < 
low”_bound
 )

1760 
·ges
 = 
low”_bound
;

1763 
	`SHADOW_PRINTK
("current %iarget %i\n",

1764 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
, 
·ges
);

1766  
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 !ğ
·ges
 )

1768 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 < 
·ges
 )

1771 
¥
 = (
·ge_šfo
 *)

1772 
	`®loc_domh—p_·ge
(
NULL
, 
	`MEMF_node
(
	`domaš_to_node
(
d
)));

1773 iàĞ
¥
 =ğ
NULL
 )

1775 
	`SHADOW_PRINTK
("failedo‡llocate shadow…ages.\n");

1776  -
ENOMEM
;

1778 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
++;

1779 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
++;

1780 
¥
->
u
.
sh
.
ty³
 = 0;

1781 
¥
->
u
.
sh
.
pšÃd
 = 0;

1782 
¥
->
u
.
sh
.
couÁ
 = 0;

1783 
¥
->
bæush_time¡amp
 = 0;

1784 
	`·ge_li¡_add_
(
¥
, &
d
->
¬ch
.
·gšg
.
shadow
.
ä“li¡
);

1786 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 > 
·ges
 )

1789 
	`_shadow_´—Îoc
(
d
, 1);

1790 
¥
 = 
	`·ge_li¡_»move_h—d
(&
d
->
¬ch
.
·gšg
.
shadow
.
ä“li¡
);

1791 
	`ASSERT
(
¥
);

1796 
	`·ge_£t_owÃr
(
¥
, 
NULL
);

1797 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
--;

1798 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
--;

1799 
	`ä“_domh—p_·ge
(
¥
);

1803 iàĞ
´“m±ed
 && 
	`hy³rÿÎ_´“m±_check
() )

1805 *
´“m±ed
 = 1;

1811 
	}
}

1814 
	$shadow_g‘_®loÿtiÚ
(
domaš
 *
d
)

1816 
pg
 = 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges


1817 + 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
;

1818  ((
pg
 >> (20 - 
PAGE_SHIFT
))

1819 + ((
pg
 & ((1 << (20 - 
PAGE_SHIFT
)) - 1)) ? 1 : 0));

1820 
	}
}

1827 
	#SHADOW_HASH_BUCKETS
 251

	)

1831 
u32
 
	tkey_t
;

1832 
šlše
 
key_t
 
	$sh_hash
(
n
, 
t
)

1834 *
p
 = (*)&
n
;

1835 
key_t
 
k
 = 
t
;

1836 
i
;

1837  
i
 = 0; i < (
n
è; i++ ) 
k
 = (
u32
)
p
[i] + (k<<6) + (k<<16) - k;

1838  
k
 % 
SHADOW_HASH_BUCKETS
;

1839 
	}
}

1841 #ià
SHADOW_AUDIT
 & (
SHADOW_AUDIT_HASH
|
SHADOW_AUDIT_HASH_FULL
)

1845 
	$sh_hash_aud™_buck‘
(
domaš
 *
d
, 
buck‘
)

1848 
·ge_šfo
 *
¥
, *
x
;

1850 iàĞ!(
SHADOW_AUDIT_ENABLE
) )

1853 
¥
 = 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
buck‘
];

1854  
¥
 )

1857 
	`BUG_ON
Ğ(
¥
->
couÁ_šfo
 & 
PGC_couÁ_mask
 )!= 0 ) ;

1859 
	`BUG_ON
Ğ
¥
->
u
.
sh
.
ty³
 == 0 );

1860 
	`BUG_ON
Ğ
¥
->
u
.
sh
.
ty³
 > 
SH_ty³_max_shadow
 );

1862 
	`BUG_ON
Ğ!
¥
->
u
.
sh
.
h—d
 );

1864 
	`BUG_ON
Ğ
	`sh_hash
(
	`__backpoš‹r
(
¥
), sp->
u
.
sh
.
ty³
è!ğ
buck‘
 );

1866  
x
 = 
	`Ãxt_shadow
(
¥
); x; x =‚ext_shadow(x) )

1867 
	`BUG_ON
Ğ
x
->
v
.
sh
.
back
 =ğ
¥
->v.sh.back &&

1868 
x
->
u
.
sh
.
ty³
 =ğ
¥
->u.sh.type );

1870 iàĞ
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_æ1_32_shadow


1871 && 
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_æ1_·e_shadow


1872 && 
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_æ1_64_shadow
 )

1874 
·ge_šfo
 *
gpg
 = 
	`mâ_to_·ge
(
	`backpoš‹r
(
¥
));

1876 
	`BUG_ON
Ğ!(
gpg
->
shadow_æags
 & (1<<
¥
->
u
.
sh
.
ty³
)) );

1878 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

1879 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_32_shadow


1880 || 
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_·e_shadow


1881 || 
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_64_shadow
 )

1883 iàĞ(
gpg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è=ğ
PGT_wr™abË_·ge


1884 && (
gpg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0 )

1886 iàĞ!
	`·ge_is_out_of_sync
(
gpg
) )

1888 
	`SHADOW_ERROR
("MFN %#"
PRI_mâ
" shadowed (by %#"PRI_mfn")"

1890 
	`__backpoš‹r
(
¥
),

1891 
	`mâ_x
(
	`·ge_to_mâ
(
¥
)),

1892 
gpg
->
u
.
šu£
.
ty³_šfo
);

1893 
	`BUG
();

1899 iàĞ(
gpg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è=ğ
PGT_wr™abË_·ge


1900 && (
gpg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0 )

1902 
	`SHADOW_ERROR
("MFN %#"
PRI_mâ
" shadowed (by %#"PRI_mfn")"

1904 
	`__backpoš‹r
(
¥
), 
	`mâ_x
(
	`·ge_to_mâ
(sp)),

1905 
gpg
->
u
.
šu£
.
ty³_šfo
);

1906 
	`BUG
();

1910 
¥
 = 
	`Ãxt_shadow
(sp);

1912 
	}
}

1915 
	#sh_hash_aud™_buck‘
(
_d
, 
_b
èdØ{} 0)

	)

1919 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_HASH_FULL


1921 
	$sh_hash_aud™
(
domaš
 *
d
)

1924 
i
;

1926 iàĞ!(
SHADOW_AUDIT_ENABLE
) )

1929  
i
 = 0; i < 
SHADOW_HASH_BUCKETS
; i++ )

1931 
	`sh_hash_aud™_buck‘
(
d
, 
i
);

1933 
	}
}

1936 
	#sh_hash_aud™
(
_d
èdØ{} 0)

	)

1941 
	$shadow_hash_®loc
(
domaš
 *
d
)

1943 
·ge_šfo
 **
bË
;

1945 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1946 
	`ASSERT
(!
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

1948 
bË
 = 
	`xm®loc_¬¿y
(
·ge_šfo
 *, 
SHADOW_HASH_BUCKETS
);

1949 iàĞ!
bË
 )  1;

1950 
	`mem£t
(
bË
, 0,

1951 
SHADOW_HASH_BUCKETS
 *  (
·ge_šfo
 *));

1952 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
 = 
bË
;

1954 
	}
}

1958 
	$shadow_hash_‹¬down
(
domaš
 *
d
)

1960 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1961 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

1963 
	`xä“
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

1964 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
 = 
NULL
;

1965 
	}
}

1968 
mâ_t
 
	$shadow_hash_lookup
(
vıu
 *
v
, 
n
, 
t
)

1972 
domaš
 *
d
 = 
v
->domain;

1973 
·ge_šfo
 *
¥
, *
´ev
;

1974 
key_t
 
key
;

1976 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

1977 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

1978 
	`ASSERT
(
t
);

1980 
	`sh_hash_aud™
(
d
);

1982 
	`³rfc_šü
(
shadow_hash_lookups
);

1983 
key
 = 
	`sh_hash
(
n
, 
t
);

1984 
	`sh_hash_aud™_buck‘
(
d
, 
key
);

1986 
¥
 = 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
];

1987 
´ev
 = 
NULL
;

1988 
¥
)

1990 iàĞ
	`__backpoš‹r
(
¥
è=ğ
n
 && sp->
u
.
sh
.
ty³
 =ğ
t
 )

1993 iàĞ
	`uÆik–y
(
¥
 !ğ
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
]) )

1995 iàĞ
	`uÆik–y
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_w®kšg
 != 0) )

1997  
	`·ge_to_mâ
(
¥
);

2000 
	`ASSERT
(
´ev
);

2002 
´ev
->
Ãxt_shadow
 = 
¥
->next_shadow;

2004 
	`£t_Ãxt_shadow
(
¥
, 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
]);

2005 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
] = 
¥
;

2010 
	`³rfc_šü
(
shadow_hash_lookup_h—d
);

2012  
	`·ge_to_mâ
(
¥
);

2014 
´ev
 = 
¥
;

2015 
¥
 = 
	`Ãxt_shadow
(sp);

2018 
	`³rfc_šü
(
shadow_hash_lookup_miss
);

2019  
	`_mâ
(
INVALID_MFN
);

2020 
	}
}

2022 
	$shadow_hash_š£¹
(
vıu
 *
v
, 
n
, 
t
,

2023 
mâ_t
 
smâ
)

2026 
domaš
 *
d
 = 
v
->domain;

2027 
·ge_šfo
 *
¥
;

2028 
key_t
 
key
;

2030 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

2031 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

2032 
	`ASSERT
(
t
);

2034 
	`sh_hash_aud™
(
d
);

2036 
	`³rfc_šü
(
shadow_hash_š£¹s
);

2037 
key
 = 
	`sh_hash
(
n
, 
t
);

2038 
	`sh_hash_aud™_buck‘
(
d
, 
key
);

2041 
¥
 = 
	`mâ_to_·ge
(
smâ
);

2042 
	`£t_Ãxt_shadow
(
¥
, 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
]);

2043 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
] = 
¥
;

2045 
	`sh_hash_aud™_buck‘
(
d
, 
key
);

2046 
	}
}

2048 
	$shadow_hash_d–‘e
(
vıu
 *
v
, 
n
, 
t
,

2049 
mâ_t
 
smâ
)

2052 
domaš
 *
d
 = 
v
->domain;

2053 
·ge_šfo
 *
¥
, *
x
;

2054 
key_t
 
key
;

2056 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

2057 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
);

2058 
	`ASSERT
(
t
);

2060 
	`sh_hash_aud™
(
d
);

2062 
	`³rfc_šü
(
shadow_hash_d–‘es
);

2063 
key
 = 
	`sh_hash
(
n
, 
t
);

2064 
	`sh_hash_aud™_buck‘
(
d
, 
key
);

2066 
¥
 = 
	`mâ_to_·ge
(
smâ
);

2067 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
] =ğ
¥
 )

2069 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
] = 
	`Ãxt_shadow
(
¥
);

2073 
x
 = 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
key
];

2076 
	`ASSERT
(
x
);

2078 iàĞ
	`Ãxt_shadow
(
x
è=ğ
¥
 )

2080 
x
->
Ãxt_shadow
 = 
¥
->next_shadow;

2083 
x
 = 
	`Ãxt_shadow
(x);

2086 
	`£t_Ãxt_shadow
(
¥
, 
NULL
);

2088 
	`sh_hash_aud™_buck‘
(
d
, 
key
);

2089 
	}
}

2091 (*
	thash_ÿÎback_t
)(
	tvıu
 *
	tv
, 
	tmâ_t
 
	tsmâ
, mâ_ˆ
	tÙh”_mâ
);

2093 
	$hash_fÜ—ch
(
vıu
 *
v
,

2094 
ÿÎback_mask
,

2095 cÚ¡ 
hash_ÿÎback_t
 
ÿÎbacks
[],

2096 
mâ_t
 
ÿÎback_mâ
)

2106 
i
, 
dÚe
 = 0;

2107 
domaš
 *
d
 = 
v
->domain;

2108 
·ge_šfo
 *
x
;

2110 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

2113 iàĞ
	`uÆik–y
(!
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
) )

2117 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
hash_w®kšg
 == 0);

2118 
d
->
¬ch
.
·gšg
.
shadow
.
hash_w®kšg
 = 1;

2120  
i
 = 0; i < 
SHADOW_HASH_BUCKETS
; i++ )

2125  
x
 = 
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
[
i
]; x; x = 
	`Ãxt_shadow
(x) )

2127 iàĞ
ÿÎback_mask
 & (1 << 
x
->
u
.
sh
.
ty³
) )

2129 
	`ASSERT
(
x
->
u
.
sh
.
ty³
 <= 15);

2130 
	`ASSERT
(
ÿÎbacks
[
x
->
u
.
sh
.
ty³
] !ğ
NULL
);

2131 
dÚe
 = 
ÿÎbacks
[
x
->
u
.
sh
.
ty³
](
v
, 
	`·ge_to_mâ
(x),

2132 
ÿÎback_mâ
);

2133 iàĞ
dÚe
 ) ;

2136 iàĞ
dÚe
 ) ;

2138 
d
->
¬ch
.
·gšg
.
shadow
.
hash_w®kšg
 = 0;

2139 
	}
}

2147 
	$sh_de¡roy_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2149 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2150 
t
 = 
¥
->
u
.
sh
.
ty³
;

2153 
	`SHADOW_PRINTK
("smâ=%#lx\n", 
	`mâ_x
(
smâ
));

2157 
	`ASSERT
(
t
 =ğ
SH_ty³_æ1_32_shadow
 ||

2158 
t
 =ğ
SH_ty³_æ1_·e_shadow
 ||

2159 
t
 =ğ
SH_ty³_æ1_64_shadow
 ||

2160 
t
 =ğ
SH_ty³_mÚ™Ü_bË
 ||

2161 (
	`is_pv_32Ú64_vıu
(
v
è&& 
t
 =ğ
SH_ty³_l4_64_shadow
) ||

2162 (
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
	`backpoš‹r
(
¥
)))

2163 =ğ
v
->
domaš
));

2167  
t
 )

2169 
SH_ty³_l1_32_shadow
:

2170 
SH_ty³_æ1_32_shadow
:

2171 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l1_shadow
, 2)(
v
, 
smâ
);

2173 
SH_ty³_l2_32_shadow
:

2174 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l2_shadow
, 2)(
v
, 
smâ
);

2177 
SH_ty³_l1_·e_shadow
:

2178 
SH_ty³_æ1_·e_shadow
:

2179 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l1_shadow
, 3)(
v
, 
smâ
);

2181 
SH_ty³_l2_·e_shadow
:

2182 
SH_ty³_l2h_·e_shadow
:

2183 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l2_shadow
, 3)(
v
, 
smâ
);

2186 #ià
CONFIG_PAGING_LEVELS
 >= 4

2187 
SH_ty³_l1_64_shadow
:

2188 
SH_ty³_æ1_64_shadow
:

2189 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l1_shadow
, 4)(
v
, 
smâ
);

2191 
SH_ty³_l2h_64_shadow
:

2192 
	`ASSERT
(
	`is_pv_32Ú64_vıu
(
v
));

2194 
SH_ty³_l2_64_shadow
:

2195 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l2_shadow
, 4)(
v
, 
smâ
);

2197 
SH_ty³_l3_64_shadow
:

2198 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l3_shadow
, 4)(
v
, 
smâ
);

2200 
SH_ty³_l4_64_shadow
:

2201 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_l4_shadow
, 4)(
v
, 
smâ
);

2205 
	`SHADOW_ERROR
("triedo destroy shadow of badype %08lx\n",

2206 ()
t
);

2207 
	`BUG
();

2209 
	}
}

2211 
šlše
 
	$Œaû_shadow_wrm­_bf
(
mâ_t
 
gmâ
)

2213 iàĞ
tb_š™_dÚe
 )

2216 
gâ
 = 
	`mâ_to_gâ
(
cu¼’t
->
domaš
, 
gmâ
);

2217 
	`__Œaû_v¬
(
TRC_SHADOW_WRMAP_BF
, 0 , (
gâ
), &gfn);

2219 
	}
}

2228 
	$sh_»move_wr™e_acûss
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

2229 
Ëv–
,

2230 
çuÉ_addr
)

2233 cÚ¡ 
hash_ÿÎback_t
 
ÿÎbacks
[
SH_ty³_unu£d
] = {

2234 
NULL
,

2235 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 2),

2236 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 2),

2237 
NULL
,

2238 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 3),

2239 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 3),

2240 
NULL
,

2241 
NULL
,

2242 #ià
CONFIG_PAGING_LEVELS
 >= 4

2243 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 4),

2244 
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 4),

2246 
NULL
,

2247 
NULL
,

2249 
NULL
,

2250 
NULL
,

2251 
NULL
,

2252 
NULL
,

2253 
NULL
,

2254 
NULL


2257 
ÿÎback_mask
 =

2258 1 << 
SH_ty³_l1_32_shadow


2259 | 1 << 
SH_ty³_æ1_32_shadow


2260 | 1 << 
SH_ty³_l1_·e_shadow


2261 | 1 << 
SH_ty³_æ1_·e_shadow


2262 | 1 << 
SH_ty³_l1_64_shadow


2263 | 1 << 
SH_ty³_æ1_64_shadow


2265 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gmâ
);

2267 
	`ASSERT
(
	`shadow_locked_by_me
(
v
->
domaš
));

2273 iàĞ!
	`shadow_mode_»fcouÁs
(
v
->
domaš
) )

2277 iàĞ(
	`sh_mâ_is_a_·ge_bË
(
gmâ
)

2278 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2280 && !
	`mâ_oos_may_wr™e
(
gmâ
)

2283 || (
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0 )

2286 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_WRMAP
);

2288 
	`³rfc_šü
(
shadow_wr™—bË
);

2292 iàĞ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
è!ğ
PGT_wr™abË_·ge
 )

2294 
	`SHADOW_ERROR
("can't„emove write‡ccesso mfn %lx,ype_info is %"

2295 
PRty³_šfo
 "\n",

2296 
	`mâ_x
(
gmâ
), 
	`mâ_to_·ge
(gmâ)->
u
.
šu£
.
ty³_šfo
);

2297 
	`domaš_üash
(
v
->
domaš
);

2300 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


2301 iàĞ
v
 =ğ
cu¼’t
 )

2303 
gâ
;

2308 
	#GUESS
(
_a
, 
_h
) do { \

2309 iàĞ
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`guess_wrm­
(v, (
_a
), 
gmâ
) ) \

2310 
	`³rfc_šü
(
shadow_wr™—bË_h_
 ## 
_h
); \

2311 iàĞ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0 ) \

2313 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_WRMAP_GUESS_FOUND
); \

2316 } 0)

	)

2318 iàĞ
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
 == 2 )

2320 iàĞ
Ëv–
 == 1 )

2322 
	`GUESS
(0xC0000000UL + (
çuÉ_addr
 >> 10), 1);

2325 ià((
gâ
 = 
	`mâ_to_gâ
(
v
->
domaš
, 
gmâ
)) < 0x38000 )

2326 
	`GUESS
(0xC0000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2329 iàĞ
Ëv–
 == 1 )

2330 
	`GUESS
(0xBFC00000UL

2331 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 10), 6);

2333 iàĞ
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
 == 3 )

2336  
Ëv–
 )

2338 1: 
	`GUESS
(0xC0000000UL + (
çuÉ_addr
 >> 9), 2); ;

2339 2: 
	`GUESS
(0xC0600000UL + (
çuÉ_addr
 >> 18), 2); ;

2343 ià((
gâ
 = 
	`mâ_to_gâ
(
v
->
domaš
, 
gmâ
)) < 0x38000 )

2344 
	`GUESS
(0xC0000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2347  
Ëv–
 )

2349 1: 
	`GUESS
(0xBF800000UL

2350 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 9), 6); ;

2351 2: 
	`GUESS
(0xBFDFC000UL

2352 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 18), 6); ;

2355 #ià
CONFIG_PAGING_LEVELS
 >= 4

2356 iàĞ
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
 == 4 )

2359  
Ëv–
 )

2361 1: 
	`GUESS
(0xfffff68000000000UL

2362 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 9), 3); ;

2363 2: 
	`GUESS
(0xfffff6fb40000000UL

2364 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 18), 3); ;

2365 3: 
	`GUESS
(0xfffff6fb7da00000UL

2366 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 27), 3); ;

2372 
gâ
 = 
	`mâ_to_gâ
(
v
->
domaš
, 
gmâ
);

2373 
	`GUESS
(0xffff880000000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2374 
	`GUESS
(0xffff810000000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2375 
	`GUESS
(0x0000010000000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2381 
	`GUESS
(0xffffã0000000000UL + (
gâ
 << 
PAGE_SHIFT
), 4);

2384  
Ëv–
 )

2386 1: 
	`GUESS
(0xffff800000000000

2387 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 9), 6); ;

2388 2: 
	`GUESS
(0xffff804000000000UL

2389 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 18), 6); ;

2390 3: 
	`GUESS
(0xffff804020000000UL

2391 + ((
çuÉ_addr
 & 
VADDR_MASK
) >> 27), 6); ;

2394 
	`GUESS
(0xffffff0000000000 + (
gâ
 << 
PAGE_SHIFT
), 6);

2398 #undeà
GUESS


2401 iàĞ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0 )

2410 iàĞ
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_wr™—bË_±e_smâ
 != 0 )

2412 
Şd_couÁ
 = (
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
);

2413 
mâ_t
 
Ï¡_smâ
 = 
	`_mâ
(
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_wr™—bË_±e_smâ
);

2414 
shty³
 = 
	`mâ_to_·ge
(
Ï¡_smâ
)->
u
.
sh
.
ty³
;

2416 iàĞ
ÿÎbacks
[
shty³
] )

2417 
ÿÎbacks
[
shty³
](
v
, 
Ï¡_smâ
, 
gmâ
);

2419 iàĞ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
è!ğ
Şd_couÁ
 )

2420 
	`³rfc_šü
(
shadow_wr™—bË_h_5
);

2423 iàĞ(
pg
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0 )

2429 
	`Œaû_shadow_wrm­_bf
(
gmâ
);

2430 iàĞ
Ëv–
 == 0 )

2431 
	`³rfc_šü
(
shadow_wr™—bË_bf_1
);

2433 
	`³rfc_šü
(
shadow_wr™—bË_bf
);

2434 
	`hash_fÜ—ch
(
v
, 
ÿÎback_mask
, 
ÿÎbacks
, 
gmâ
);

2438 iàĞ(
	`mâ_to_·ge
(
gmâ
)->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) != 0 )

2440 iàĞ
Ëv–
 == 0 )

2443 
	`SHADOW_ERROR
("can't„emove write‡ccesso mfn %lx: guest has "

2444 "%lu s³cŸl-u£ m­pšg oà™\n", 
	`mâ_x
(
gmâ
),

2445 (
	`mâ_to_·ge
(
gmâ
)->
u
.
šu£
.
ty³_šfo
&
PGT_couÁ_mask
));

2446 
	`domaš_üash
(
v
->
domaš
);

2451 
	}
}

2453 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2454 
	$sh_»move_wr™e_acûss_äom_¦1p
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

2455 
mâ_t
 
smâ
, 
off
)

2457 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2459 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2460 
	`ASSERT
(
	`mâ_v®id
(
gmâ
));

2462 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_32_shadow


2463 || 
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_æ1_32_shadow
 )

2465  
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_¦1p
,2)

2466 (
v
, 
gmâ
, 
smâ
, 
off
);

2468 #ià
CONFIG_PAGING_LEVELS
 >= 3

2469 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_·e_shadow


2470 || 
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_æ1_·e_shadow
 )

2471  
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_¦1p
,3)

2472 (
v
, 
gmâ
, 
smâ
, 
off
);

2473 #ià
CONFIG_PAGING_LEVELS
 >= 4

2474 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_64_shadow


2475 || 
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_æ1_64_shadow
 )

2476  
	`SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_¦1p
,4)

2477 (
v
, 
gmâ
, 
smâ
, 
off
);

2482 
	}
}

2489 
	$sh_»move_®l_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

2491 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
gmâ
);

2492 
ex³ùed_couÁ
, 
do_lockšg
;

2495 cÚ¡ 
hash_ÿÎback_t
 
ÿÎbacks
[
SH_ty³_unu£d
] = {

2496 
NULL
,

2497 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 2),

2498 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 2),

2499 
NULL
,

2500 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 3),

2501 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 3),

2502 
NULL
,

2503 
NULL
,

2504 #ià
CONFIG_PAGING_LEVELS
 >= 4

2505 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 4),

2506 
	`SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 4),

2508 
NULL
,

2509 
NULL
,

2511 
NULL
,

2512 
NULL
,

2513 
NULL
,

2514 
NULL
,

2515 
NULL
,

2516 
NULL


2519 
ÿÎback_mask
 =

2520 1 << 
SH_ty³_l1_32_shadow


2521 | 1 << 
SH_ty³_æ1_32_shadow


2522 | 1 << 
SH_ty³_l1_·e_shadow


2523 | 1 << 
SH_ty³_æ1_·e_shadow


2524 | 1 << 
SH_ty³_l1_64_shadow


2525 | 1 << 
SH_ty³_æ1_64_shadow


2528 
	`³rfc_šü
(
shadow_m­pšgs
);

2529 iàĞ(
·ge
->
couÁ_šfo
 & 
PGC_couÁ_mask
) == 0 )

2536 
do_lockšg
 = !
	`shadow_locked_by_me
(
v
->
domaš
);

2537 iàĞ
do_lockšg
 ) 
	`shadow_lock
(
v
->
domaš
);

2543 
	`³rfc_šü
(
shadow_m­pšgs_bf
);

2544 
	`hash_fÜ—ch
(
v
, 
ÿÎback_mask
, 
ÿÎbacks
, 
gmâ
);

2547 
ex³ùed_couÁ
 = (
·ge
->
couÁ_šfo
 & 
PGC_®loÿ‹d
) ? 1 : 0;

2548 iàĞ(
·ge
->
couÁ_šfo
 & 
PGC_couÁ_mask
è!ğ
ex³ùed_couÁ
 )

2553 iàĞ!(
	`shadow_mode_ex‹º®
(
v
->
domaš
)

2554 && (
·ge
->
couÁ_šfo
 & 
PGC_couÁ_mask
) <= 3

2555 && (
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 0) )

2557 
	`SHADOW_ERROR
("can't find‡ll mappings of mfn %lx: "

2558 "c=%08lx=%08lx\n", 
	`mâ_x
(
gmâ
),

2559 
·ge
->
couÁ_šfo
,…age->
u
.
šu£
.
ty³_šfo
);

2563 iàĞ
do_lockšg
 ) 
	`shadow_uÆock
(
v
->
domaš
);

2567 
	}
}

2573 
	$sh_»move_shadow_vŸ_poš‹r
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2577 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2578 
mâ_t
 
pmâ
;

2579 *
vaddr
;

2580 
rc
;

2582 
	`ASSERT
(
¥
->
u
.
sh
.
ty³
 > 0);

2583 
	`ASSERT
(
¥
->
u
.
sh
.
ty³
 < 
SH_ty³_max_shadow
);

2584 
	`ASSERT
(
	`sh_ty³_has_up_poš‹r
(
v
, 
¥
->
u
.
sh
.
ty³
));

2586 ià(
¥
->
up
 == 0)  0;

2587 
pmâ
 = 
	`_mâ
(
¥
->
up
 >> 
PAGE_SHIFT
);

2588 
	`ASSERT
(
	`mâ_v®id
(
pmâ
));

2589 
vaddr
 = 
	`sh_m­_domaš_·ge
(
pmâ
);

2590 
	`ASSERT
(
vaddr
);

2591 
vaddr
 +ğ
¥
->
up
 & (
PAGE_SIZE
-1);

2592 
	`ASSERT
(
	`l1e_g‘_pâ
(*(
l1_pg’Œy_t
 *)
vaddr
è=ğ
	`mâ_x
(
smâ
));

2595 
rc
 = (
¥
->
u
.
sh
.
couÁ
 == 1) ? 1 : 0;

2598 
¥
->
u
.
sh
.
ty³
)

2600 
SH_ty³_l1_32_shadow
:

2601 
SH_ty³_l2_32_shadow
:

2602 
	`SHADOW_INTERNAL_NAME
(
sh_ş—r_shadow_’Œy
, 2)(
v
, 
vaddr
, 
pmâ
);

2604 
SH_ty³_l1_·e_shadow
:

2605 
SH_ty³_l2_·e_shadow
:

2606 
SH_ty³_l2h_·e_shadow
:

2607 
	`SHADOW_INTERNAL_NAME
(
sh_ş—r_shadow_’Œy
, 3)(
v
, 
vaddr
, 
pmâ
);

2609 #ià
CONFIG_PAGING_LEVELS
 >= 4

2610 
SH_ty³_l1_64_shadow
:

2611 
SH_ty³_l2_64_shadow
:

2612 
SH_ty³_l2h_64_shadow
:

2613 
SH_ty³_l3_64_shadow
:

2614 
SH_ty³_l4_64_shadow
:

2615 
	`SHADOW_INTERNAL_NAME
(
sh_ş—r_shadow_’Œy
, 4)(
v
, 
vaddr
, 
pmâ
);

2618 : 
	`BUG
();

2621 
	`sh_unm­_domaš_·ge
(
vaddr
);

2622 iàĞ
rc
 )

2623 
	`³rfc_šü
(
shadow_up_poš‹r
);

2625 
	`³rfc_šü
(
shadow_unshadow_bf
);

2627  
rc
;

2628 
	}
}

2630 
	$sh_»move_shadows
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
ç¡
, 
®l
)

2639 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gmâ
);

2640 
mâ_t
 
smâ
;

2641 
do_lockšg
;

2642 
t
;

2646 cÚ¡ 
hash_ÿÎback_t
 
ÿÎbacks
[
SH_ty³_unu£d
] = {

2647 
NULL
,

2648 
NULL
,

2649 
NULL
,

2650 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 2),

2651 
NULL
,

2652 
NULL
,

2653 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 3),

2654 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 3),

2655 
NULL
,

2656 
NULL
,

2657 #ià
CONFIG_PAGING_LEVELS
 >= 4

2658 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 4),

2659 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 4),

2660 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l2_shadow
, 4),

2661 
	`SHADOW_INTERNAL_NAME
(
sh_»move_l3_shadow
, 4),

2663 
NULL
,

2664 
NULL
,

2665 
NULL
,

2666 
NULL
,

2668 
NULL
,

2669 
NULL


2673 
masks
[
SH_ty³_unu£d
] = {

2675 1 << 
SH_ty³_l2_32_shadow
,

2678 ((1 << 
SH_ty³_l2h_·e_shadow
)

2679 | (1 << 
SH_ty³_l2_·e_shadow
)),

2683 ((1 << 
SH_ty³_l2h_64_shadow
)

2684 | (1 << 
SH_ty³_l2_64_shadow
)),

2686 1 << 
SH_ty³_l3_64_shadow
,

2687 1 << 
SH_ty³_l3_64_shadow
,

2688 1 << 
SH_ty³_l4_64_shadow
,

2694 
	`ASSERT
(!(
®l
 && 
ç¡
));

2695 
	`ASSERT
(
	`mâ_v®id
(
gmâ
));

2701 
do_lockšg
 = !
	`shadow_locked_by_me
(
v
->
domaš
);

2702 iàĞ
do_lockšg
 ) 
	`shadow_lock
(
v
->
domaš
);

2704 
	`SHADOW_PRINTK
("d=%d, v=%d, gmfn=%05lx\n",

2705 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
	`mâ_x
(
gmâ
));

2708 iàĞ(
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) == 0 )

2710 iàĞ
do_lockšg
 ) 
	`shadow_uÆock
(
v
->
domaš
);

2715 
	`³rfc_šü
(
shadow_unshadow
);

2721 
	#DO_UNSHADOW
(
_ty³
) do { \

2722 
t
 = (
_ty³
); \

2723 ifĞ!(
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) \

2724 || !(
pg
->
shadow_æags
 & (1 << 
t
)) ) \

2726 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`mâ_x
(
gmâ
), 
t
); \

2727 iàĞ
	`uÆik–y
(!
	`mâ_v®id
(
smâ
)) ) \

2729 
	`SHADOW_ERROR
(": gmâ %#lx ha æag 0x%"
PRIx32
 \

2730 " buˆnØty³-0x%"
PRIx32
" shadow\n", \

2731 
	`mâ_x
(
gmâ
), (
ušt32_t
)
pg
->
shadow_æags
, 
t
); \

2734 iàĞ
	`sh_ty³_is_pšÇbË
(
v
, 
t
) ) \

2735 
	`sh_uÅš
(
v
, 
smâ
); \

2736 iàĞ
	`sh_ty³_has_up_poš‹r
(
v
, 
t
) ) \

2737 
	`sh_»move_shadow_vŸ_poš‹r
(
v
, 
smâ
); \

2738 ifĞ!
ç¡
 \

2739 && (
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) \

2740 && (
pg
->
shadow_æags
 & (1 << 
t
)) ) \

2741 
	`hash_fÜ—ch
(
v
, 
masks
[
t
], 
ÿÎbacks
, 
smâ
); \

2742 } 0)

	)

2744 
	`DO_UNSHADOW
(
SH_ty³_l2_32_shadow
);

2745 
	`DO_UNSHADOW
(
SH_ty³_l1_32_shadow
);

2746 
	`DO_UNSHADOW
(
SH_ty³_l2h_·e_shadow
);

2747 
	`DO_UNSHADOW
(
SH_ty³_l2_·e_shadow
);

2748 
	`DO_UNSHADOW
(
SH_ty³_l1_·e_shadow
);

2749 #ià
CONFIG_PAGING_LEVELS
 >= 4

2750 
	`DO_UNSHADOW
(
SH_ty³_l4_64_shadow
);

2751 
	`DO_UNSHADOW
(
SH_ty³_l3_64_shadow
);

2752 
	`DO_UNSHADOW
(
SH_ty³_l2h_64_shadow
);

2753 
	`DO_UNSHADOW
(
SH_ty³_l2_64_shadow
);

2754 
	`DO_UNSHADOW
(
SH_ty³_l1_64_shadow
);

2757 #undeà
DO_UNSHADOW


2760 iàĞ!
ç¡
 && 
®l
 && (
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) )

2762 
	`SHADOW_ERROR
("can't find‡ll shadows of mfn %05lx "

2764 
	`mâ_x
(
gmâ
), 
pg
->
shadow_æags
);

2765 
	`domaš_üash
(
v
->
domaš
);

2770 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

2772 iàĞ
do_lockšg
 ) 
	`shadow_uÆock
(
v
->
domaš
);

2773 
	}
}

2776 
	$sh_»move_®l_shadows_ªd_·»Ás
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

2780 
	`sh_»move_shadows
(
v
, 
gmâ
, 0, 1);

2789 
	}
}

2793 #ià
CONFIG_PAGING_LEVELS
 >= 4

2797 
	$sh_ş—r_up_poš‹r
(
vıu
 *
v
, 
mâ_t
 
smâ
, mâ_ˆ
unu£d
)

2799 
	`mâ_to_·ge
(
smâ
)->
up
 = 0;

2801 
	}
}

2804 
	$sh_»£t_l3_up_poš‹rs
(
vıu
 *
v
)

2806 
hash_ÿÎback_t
 
ÿÎbacks
[
SH_ty³_unu£d
] = {

2807 
NULL
,

2808 
NULL
,

2809 
NULL
,

2810 
NULL
,

2811 
NULL
,

2812 
NULL
,

2813 
NULL
,

2814 
NULL
,

2815 
NULL
,

2816 
NULL
,

2817 
NULL
,

2818 
NULL
,

2819 #ià
CONFIG_PAGING_LEVELS
 >= 4

2820 
sh_ş—r_up_poš‹r
,

2822 
NULL
,

2824 
NULL
,

2825 
NULL
,

2826 
NULL


2828 
ÿÎback_mask
 = 1 << 
SH_ty³_l3_64_shadow
;

2830 
	`hash_fÜ—ch
(
v
, 
ÿÎback_mask
, 
ÿÎbacks
, 
	`_mâ
(
INVALID_MFN
));

2831 
	}
}

2836 
	$sh_upd©e_·gšg_modes
(
vıu
 *
v
)

2838 
domaš
 *
d
 = 
v
->domain;

2839 cÚ¡ 
·gšg_mode
 *
Şd_mode
 = 
v
->
¬ch
.
·gšg
.
mode
;

2841 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

2843 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

2845 iàĞ
	`uÆik–y
(!
v
->
¬ch
.
·gšg
.
vb
) )

2847 
v
->
¬ch
.
·gšg
.
vb
 = 
	`xm®loc_¬¿y
(
shadow_vb
, 
VTLB_ENTRIES
);

2848 iàĞ
	`uÆik–y
(!
v
->
¬ch
.
·gšg
.
vb
) )

2850 
	`SHADOW_ERROR
("Could‚ot‡llocate vTLB space for dom %u vcpu %u\n",

2851 
d
->
domaš_id
, 
v
->
vıu_id
);

2852 
	`domaš_üash
(
v
->
domaš
);

2855 
	`mem£t
(
v
->
¬ch
.
·gšg
.
vb
, 0,

2856 
VTLB_ENTRIES
 *  (
shadow_vb
));

2857 
	`¥š_lock_š™
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

2861 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2862 iàĞ
	`mâ_x
(
v
->
¬ch
.
·gšg
.
shadow
.
oos_¢­shÙ
[0]è=ğ
INVALID_MFN
 )

2864 
i
;

2865 
i
 = 0; i < 
SHADOW_OOS_PAGES
; i++)

2867 
	`shadow_´—Îoc
(
d
, 
SH_ty³_oos_¢­shÙ
, 1);

2868 
v
->
¬ch
.
·gšg
.
shadow
.
oos_¢­shÙ
[
i
] =

2869 
	`shadow_®loc
(
d
, 
SH_ty³_oos_¢­shÙ
, 0);

2884 iàĞ
v
->
¬ch
.
·gšg
.
mode
 )

2885 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`d‘ach_Şd_bËs
(v);

2887 iàĞ!
	`is_hvm_domaš
(
d
) )

2892 #ià
CONFIG_PAGING_LEVELS
 == 4

2893 
v
->
¬ch
.
·gšg
.
mode
 = &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 4);

2895 
v
->
¬ch
.
·gšg
.
mode
 = &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 3);

2903 
	`ASSERT
(
	`shadow_mode_Œª¦©e
(
d
));

2904 
	`ASSERT
(
	`shadow_mode_ex‹º®
(
d
));

2906 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2910 
	`shadow_»sync_®l
(
v
, 0);

2913 iàĞ!
	`hvm_·gšg_’abËd
(
v
) )

2918 
v
->
¬ch
.
gue¡_bË
 = 
d
->¬ch.
·gšg
.
shadow
.
uÅaged_·g‘abË
;

2919 
v
->
¬ch
.
·gšg
.
mode
 = &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 2);

2923 #ifdeà
__x86_64__


2924 iàĞ
	`hvm_lÚg_mode_’abËd
(
v
) )

2927 
v
->
¬ch
.
·gšg
.
mode
 =

2928 &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 4);

2932 iàĞ
	`hvm_·e_’abËd
(
v
) )

2935 
v
->
¬ch
.
·gšg
.
mode
 =

2936 &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 3);

2941 
v
->
¬ch
.
·gšg
.
mode
 =

2942 &
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 2);

2946 iàĞ
	`·g‘abË_is_nuÎ
(
v
->
¬ch
.
mÚ™Ü_bË
) )

2948 
mâ_t
 
mmâ
 = 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`make_mÚ™Ü_bË
(v);

2949 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_äom_mâ
(
mmâ
);

2950 
	`make_ü3
(
v
, 
	`mâ_x
(
mmâ
));

2951 
	`hvm_upd©e_ho¡_ü3
(
v
);

2954 iàĞ
v
->
¬ch
.
·gšg
.
mode
 !ğ
Şd_mode
 )

2956 
	`SHADOW_PRINTK
("new…aging mode: d=%u v=%u…e=%d gl=%u "

2958 
d
->
domaš_id
, 
v
->
vıu_id
,

2959 
	`is_hvm_domaš
(
d
è? 
	`hvm_·gšg_’abËd
(
v
) : 1,

2960 
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
,

2961 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
shadow_Ëv–s
,

2962 
Şd_mode
 ? old_mode->
gue¡_Ëv–s
 : 0,

2963 
Şd_mode
 ? old_mode->
shadow
.
shadow_Ëv–s
 : 0);

2964 iàĞ
Şd_mode
 &&

2965 (
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
shadow_Ëv–s
 !=

2966 
Şd_mode
->
shadow
.
shadow_Ëv–s
) )

2969 
mâ_t
 
Ãw_mâ
, 
Şd_mâ
;

2971 iàĞ
v
 !ğ
cu¼’t
 && 
	`vıu_ruÂabË
(v) )

2973 
	`SHADOW_ERROR
("Somehird…arty (d=%u v=%u) is changing "

2976 
cu¼’t
->
domaš
->
domaš_id
, cu¼’t->
vıu_id
,

2977 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

2980 
	`domaš_üash
(
v
->
domaš
);

2984 
Şd_mâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
);

2985 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_nuÎ
();

2986 
Ãw_mâ
 = 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`make_mÚ™Ü_bË
(v);

2987 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_äom_mâ
(
Ãw_mâ
);

2988 
	`SHADOW_PRINTK
("Ãw mÚ™ÜabË %"
PRI_mâ
 "\n",

2989 
	`mâ_x
(
Ãw_mâ
));

2994 
	`make_ü3
(
v
, 
	`mâ_x
(
Ãw_mâ
));

2995 iàĞ
v
 =ğ
cu¼’t
 )

2996 
	`wr™e_±ba£
(
v
);

2997 
	`hvm_upd©e_ho¡_ü3
(
v
);

2998 
Şd_mode
->
shadow
.
	`de¡roy_mÚ™Ü_bË
(
v
, 
Şd_mâ
);

3008 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3011 iàĞ
	`is_hvm_domaš
(
d
è&& !d->
¬ch
.
·gšg
.
shadow
.
oos_off
 )

3013 
³
 = 1;

3014 
vıu
 *
v±r
;

3016 
	`fÜ_—ch_vıu
(
d
, 
v±r
)

3018 iàĞ!
	`hvm_·gšg_’abËd
(
v±r
) )

3020 
³
 = 0;

3025 
d
->
¬ch
.
·gšg
.
shadow
.
oos_aùive
 = 
³
;

3029 
v
->
¬ch
.
·gšg
.
mode
->
	`upd©e_ü3
(v, 0);

3030 
	}
}

3032 
	$shadow_upd©e_·gšg_modes
(
vıu
 *
v
)

3034 
	`shadow_lock
(
v
->
domaš
);

3035 
	`sh_upd©e_·gšg_modes
(
v
);

3036 
	`shadow_uÆock
(
v
->
domaš
);

3037 
	}
}

3042 
	$sh_Ãw_mode
(
domaš
 *
d
, 
u32
 
Ãw_mode
)

3045 
vıu
 *
v
;

3047 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

3048 
	`ASSERT
(
d
 !ğ
cu¼’t
->
domaš
);

3050 
d
->
¬ch
.
·gšg
.
mode
 = 
Ãw_mode
;

3051 
	`fÜ_—ch_vıu
(
d
, 
v
)

3052 
	`sh_upd©e_·gšg_modes
(
v
);

3053 
	}
}

3055 
	$shadow_’abË
(
domaš
 *
d
, 
u32
 
mode
)

3061 
Şd_·ges
;

3062 
·ge_šfo
 *
pg
 = 
NULL
;

3063 
ušt32_t
 *
e
;

3064 
i
, 
rv
 = 0;

3065 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3067 
mode
 |ğ
PG_SH_’abË
;

3069 
	`domaš_·u£
(
d
);

3072 iàĞ(
d
 =ğ
cu¼’t
->
domaš
) ||

3073 
	`shadow_mode_’abËd
(
d
) ||

3074 ((
mode
 & 
PG_Œª¦©e
è&& !(mod& 
PG_»fcouÁs
)) ||

3075 ((
mode
 & 
PG_ex‹º®
è&& !(mod& 
PG_Œª¦©e
)) )

3077 
rv
 = -
EINVAL
;

3078 
out_uÆocked
;

3082 
Şd_·ges
 = 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
;

3083 iàĞ
Şd_·ges
 == 0 )

3085 
r
;

3086 
	`shadow_lock
(
d
);

3087 
r
 = 
	`sh_£t_®loÿtiÚ
(
d
, 1024, 
NULL
);

3088 iàĞ
r
 != 0 )

3090 
	`sh_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

3091 
rv
 = -
ENOMEM
;

3092 
out_locked
;

3094 
	`shadow_uÆock
(
d
);

3098 
d
->
¬ch
.
·gšg
.
®loc_·ge
 = 
shadow_®loc_p2m_·ge
;

3099 
d
->
¬ch
.
·gšg
.
ä“_·ge
 = 
shadow_ä“_p2m_·ge
;

3103 iàĞ
mode
 & 
PG_Œª¦©e
 )

3105 
rv
 = 
	`p2m_®loc_bË
(
p2m
);

3106 ià(
rv
 != 0)

3107 
out_uÆocked
;

3112 iàĞ
	`is_hvm_domaš
(
d
) )

3116 
pg
 = 
	`shadow_®loc_p2m_·ge
(
d
);

3117 iàĞ
pg
 =ğ
NULL
 )

3119 
rv
 = -
ENOMEM
;

3120 
out_uÆocked
;

3124 
e
 = 
	`__m­_domaš_·ge
(
pg
);

3125  
i
 = 0; i < 
PAGE_SIZE
 / (*
e
); i++ )

3126 
e
[
i
] = ((0x400000U * i)

3127 | 
_PAGE_PRESENT
 | 
_PAGE_RW
 | 
_PAGE_USER


3128 | 
_PAGE_ACCESSED
 | 
_PAGE_DIRTY
 | 
_PAGE_PSE
);

3129 
	`sh_unm­_domaš_·ge
(
e
);

3130 
pg
->
u
.
šu£
.
ty³_šfo
 = 
PGT_l2_·ge_bË
 | 1 | 
PGT_v®id©ed
;

3133 
	`shadow_lock
(
d
);

3136 iàĞ
	`shadow_mode_’abËd
(
d
) )

3138 
rv
 = -
EINVAL
;

3139 
out_locked
;

3143 iàĞ
	`shadow_hash_®loc
(
d
) != 0 )

3145 
rv
 = -
ENOMEM
;

3146 
out_locked
;

3149 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_LINUX_L3_TOPLEVEL
)

3152 
d
->
¬ch
.
·gšg
.
shadow
.
İt_æags
 = 
SHOPT_LINUX_L3_TOPLEVEL
;

3156 iàĞ
	`is_hvm_domaš
(
d
) )

3157 
d
->
¬ch
.
·gšg
.
shadow
.
uÅaged_·g‘abË
 = 
	`·g‘abË_äom_·ge
(
pg
);

3160 
	`sh_Ãw_mode
(
d
, 
mode
);

3162 
out_locked
:

3163 
	`shadow_uÆock
(
d
);

3164 
out_uÆocked
:

3165 iàĞ
rv
 !ğ0 && !
	`·g‘abË_is_nuÎ
(
	`p2m_g‘_·g‘abË
(
p2m
)) )

3166 
	`p2m_‹¬down
(
p2m
);

3167 iàĞ
rv
 !ğ0 && 
pg
 !ğ
NULL
 )

3168 
	`shadow_ä“_p2m_·ge
(
d
, 
pg
);

3169 
	`domaš_uÅau£
(
d
);

3170  
rv
;

3171 
	}
}

3173 
	$shadow_‹¬down
(
domaš
 *
d
)

3177 
vıu
 *
v
;

3178 
mâ_t
 
mâ
;

3179 
·ge_šfo
 *
uÅaged_·g‘abË
 = 
NULL
;

3181 
	`ASSERT
(
d
->
is_dyšg
);

3182 
	`ASSERT
(
d
 !ğ
cu¼’t
->
domaš
);

3184 iàĞ!
	`shadow_locked_by_me
(
d
) )

3185 
	`shadow_lock
(
d
);

3187 iàĞ
	`shadow_mode_’abËd
(
d
) )

3190 
	`fÜ_—ch_vıu
(
d
, 
v
)

3192 iàĞ
v
->
¬ch
.
·gšg
.
mode
 )

3194 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`d‘ach_Şd_bËs
(v);

3195 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

3197 
mâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
);

3198 iàĞ
	`mâ_v®id
(
mâ
è&& (
	`mâ_x
(mfn) != 0) )

3199 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`de¡roy_mÚ™Ü_bË
(v, 
mâ
);

3200 
v
->
¬ch
.
mÚ™Ü_bË
 = 
	`·g‘abË_nuÎ
();

3206 #ià(
SHADOW_OPTIMIZATIONS
 & (
SHOPT_VIRTUAL_TLB
|
SHOPT_OUT_OF_SYNC
))

3208 
	`fÜ_—ch_vıu
(
d
, 
v
)

3210 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

3211 iàĞ
v
->
¬ch
.
·gšg
.
vb
 )

3213 
	`xä“
(
v
->
¬ch
.
·gšg
.
vb
);

3214 
v
->
¬ch
.
·gšg
.
vb
 = 
NULL
;

3218 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3220 
i
;

3221 
mâ_t
 *
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

3222  
i
 = 0; i < 
SHADOW_OOS_PAGES
; i++ )

3223 iàĞ
	`mâ_v®id
(
oos_¢­shÙ
[
i
]) )

3225 
	`shadow_ä“
(
d
, 
oos_¢­shÙ
[
i
]);

3226 
oos_¢­shÙ
[
i
] = 
	`_mâ
(
INVALID_MFN
);

3233 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 != 0 )

3235 
	`SHADOW_PRINTK
("teardown of domain %u starts."

3237 
d
->
domaš_id
,

3238 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3239 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3240 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3242 
	`sh_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

3244 ià(
d
->
¬ch
.
·gšg
.
shadow
.
hash_bË
)

3245 
	`shadow_hash_‹¬down
(
d
);

3247 
	`SHADOW_PRINTK
("teardown done."

3249 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3250 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3251 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3252 
	`ASSERT
(
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 == 0);

3257 iàĞ!
	`·g‘abË_is_nuÎ
(
d
->
¬ch
.
·gšg
.
shadow
.
uÅaged_·g‘abË
) )

3259 
	`fÜ_—ch_vıu
(
d
, 
v
)

3261 
	`ASSERT
(
	`is_hvm_vıu
(
v
));

3262 iàĞ!
	`hvm_·gšg_’abËd
(
v
) )

3263 
v
->
¬ch
.
gue¡_bË
 = 
	`·g‘abË_nuÎ
();

3265 
uÅaged_·g‘abË
 =

3266 
	`·g‘abË_g‘_·ge
(
d
->
¬ch
.
·gšg
.
shadow
.
uÅaged_·g‘abË
);

3267 
d
->
¬ch
.
·gšg
.
shadow
.
uÅaged_·g‘abË
 = 
	`·g‘abË_nuÎ
();

3273 
d
->
¬ch
.
·gšg
.
mode
 &ğ~
PG_log_dœty
;

3275 ià(
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
) {

3276 
	`xä“
(
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
->
¦1ma
);

3277 
	`xä“
(
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
->
dœty_b™m­
);

3278 
	`xä“
(
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
);

3279 
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
 = 
NULL
;

3282 
	`shadow_uÆock
(
d
);

3285 iàĞ
uÅaged_·g‘abË
 )

3286 
	`shadow_ä“_p2m_·ge
(
d
, 
uÅaged_·g‘abË
);

3287 
	}
}

3289 
	$shadow_fš®_‹¬down
(
domaš
 *
d
)

3292 
	`SHADOW_PRINTK
("dom %u finaleardown starts."

3294 
d
->
domaš_id
,

3295 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3296 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3297 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3302 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 != 0 )

3303 
	`shadow_‹¬down
(
d
);

3306 
	`p2m_‹¬down
(
	`p2m_g‘_ho¡p2m
(
d
));

3308 
	`shadow_lock
(
d
);

3309 
	`sh_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

3310 
	`SHADOW_PRINTK
("dom %u finaleardown done."

3312 
d
->
domaš_id
,

3313 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3314 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3315 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3316 
	`shadow_uÆock
(
d
);

3317 
	}
}

3319 
	$shadow_Úe_b™_’abË
(
domaš
 *
d
, 
u32
 
mode
)

3322 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

3325 iàĞ
d
 =ğ
cu¼’t
->
domaš
 || (d->
¬ch
.
·gšg
.
mode
 & mode) == mode )

3327  -
EINVAL
;

3330 
mode
 |ğ
PG_SH_’abË
;

3332 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 == 0 )

3335 iàĞ
	`sh_£t_®loÿtiÚ
(
d
, 1, 
NULL
) != 0 )

3337 
	`sh_£t_®loÿtiÚ
(
d
, 0, 
NULL
);

3338  -
ENOMEM
;

3343 
d
->
¬ch
.
·gšg
.
®loc_·ge
 = 
shadow_®loc_p2m_·ge
;

3344 
d
->
¬ch
.
·gšg
.
ä“_·ge
 = 
shadow_ä“_p2m_·ge
;

3346 iàĞ
d
->
¬ch
.
·gšg
.
mode
 == 0 )

3349 iàĞ
	`shadow_hash_®loc
(
d
) != 0 )

3350  -
ENOMEM
;

3354 
	`sh_Ãw_mode
(
d
, d->
¬ch
.
·gšg
.
mode
 | mode);

3357 
	}
}

3359 
	$shadow_Úe_b™_di§bË
(
domaš
 *
d
, 
u32
 
mode
)

3362 
vıu
 *
v
;

3363 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

3366 iàĞ
d
 =ğ
cu¼’t
->
domaš
 || !((d->
¬ch
.
·gšg
.
mode
 & mode) == mode) )

3368  -
EINVAL
;

3372 
	`sh_Ãw_mode
(
d
, d->
¬ch
.
·gšg
.
mode
 & ~mode);

3373 iàĞ
d
->
¬ch
.
·gšg
.
mode
 == 0 )

3376 
	`SHADOW_PRINTK
("un-shadowing of domain %u starts."

3378 
d
->
domaš_id
,

3379 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3380 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3381 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3382 
	`fÜ_—ch_vıu
(
d
, 
v
)

3384 iàĞ
v
->
¬ch
.
·gšg
.
mode
 )

3385 
v
->
¬ch
.
·gšg
.
mode
->
shadow
.
	`d‘ach_Şd_bËs
(v);

3386 #ià
CONFIG_PAGING_LEVELS
 == 4

3387 iàĞ!(
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) )

3388 
	`make_ü3
(
v
, 
	`·g‘abË_g‘_pâ
(v->
¬ch
.
gue¡_bË_u£r
));

3391 
	`make_ü3
(
v
, 
	`·g‘abË_g‘_pâ
(v->
¬ch
.
gue¡_bË
));

3393 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3395 
i
;

3396 
mâ_t
 *
oos_¢­shÙ
 = 
v
->
¬ch
.
·gšg
.
shadow
.oos_snapshot;

3397  
i
 = 0; i < 
SHADOW_OOS_PAGES
; i++ )

3398 iàĞ
	`mâ_v®id
(
oos_¢­shÙ
[
i
]) )

3400 
	`shadow_ä“
(
d
, 
oos_¢­shÙ
[
i
]);

3401 
oos_¢­shÙ
[
i
] = 
	`_mâ
(
INVALID_MFN
);

3408 iàĞ
	`sh_£t_®loÿtiÚ
(
d
, 0, 
NULL
) != 0 )

3409 
	`BUG
();

3410 
	`shadow_hash_‹¬down
(
d
);

3411 
	`SHADOW_PRINTK
("un-shadowing of domain %u done."

3413 
d
->
domaš_id
,

3414 
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
,

3415 
d
->
¬ch
.
·gšg
.
shadow
.
ä“_·ges
,

3416 
d
->
¬ch
.
·gšg
.
shadow
.
p2m_·ges
);

3420 
	}
}

3423 
	$shadow_‹¡_’abË
(
domaš
 *
d
)

3425 
»t
;

3427 
	`domaš_·u£
(
d
);

3428 
	`shadow_lock
(
d
);

3429 
»t
 = 
	`shadow_Úe_b™_’abË
(
d
, 
PG_SH_’abË
);

3430 
	`shadow_uÆock
(
d
);

3431 
	`domaš_uÅau£
(
d
);

3433  
»t
;

3434 
	}
}

3436 
	$shadow_‹¡_di§bË
(
domaš
 *
d
)

3438 
»t
;

3440 
	`domaš_·u£
(
d
);

3441 
	`shadow_lock
(
d
);

3442 
»t
 = 
	`shadow_Úe_b™_di§bË
(
d
, 
PG_SH_’abË
);

3443 
	`shadow_uÆock
(
d
);

3444 
	`domaš_uÅau£
(
d
);

3446  
»t
;

3447 
	}
}

3457 
	$sh_unshadow_fÜ_p2m_chªge
(
vıu
 *
v
, 
gâ
,

3458 
l1_pg’Œy_t
 *
p
, 
mâ_t
 
bË_mâ
,

3459 
l1_pg’Œy_t
 
Ãw
, 
Ëv–
)

3461 
domaš
 *
d
 = 
v
->domain;

3465 
	`ASSERT
(!(
Ëv–
 > 2 && (
	`l1e_g‘_æags
(*
p
è& 
_PAGE_PRESENT
) &&

3466 (
	`l1e_g‘_æags
(*
p
è& 
_PAGE_PSE
)));

3469 iàĞ
Ëv–
 == 1 )

3471 
mâ_t
 
mâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(*
p
));

3472 
p2m_ty³_t
 
p2mt
 = 
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(*
p
));

3473 iàĞ(
	`p2m_is_v®id
(
p2mt
è|| 
	`p2m_is_g¿Á
Õ2mt)è&& 
	`mâ_v®id
(
mâ
) )

3475 
	`sh_»move_®l_shadows_ªd_·»Ás
(
v
, 
mâ
);

3476 iàĞ
	`sh_»move_®l_m­pšgs
(
v
, 
mâ
) )

3477 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

3484 iàĞ
Ëv–
 =ğ2 && (
	`l1e_g‘_æags
(*
p
è& 
_PAGE_PRESENT
) &&

3485 (
	`l1e_g‘_æags
(*
p
è& 
_PAGE_PSE
) )

3487 
i
;

3488 
ıumask_t
 
æushmask
;

3489 
mâ_t
 
omâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(*
p
));

3490 
mâ_t
 
nmâ
 = 
	`_mâ
(
	`l1e_g‘_pâ
(
Ãw
));

3491 
l1_pg’Œy_t
 *
Å‹
 = 
NULL
;

3492 
p2m_ty³_t
 
p2mt
 = 
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(*
p
));

3493 iàĞ
	`p2m_is_v®id
(
p2mt
è&& 
	`mâ_v®id
(
omâ
) )

3495 
	`ıus_ş—r
(
æushmask
);

3498 iàĞ(
	`l1e_g‘_æags
(
Ãw
è& 
_PAGE_PRESENT
)

3499 && !(
	`l1e_g‘_æags
(
Ãw
è& 
_PAGE_PSE
)

3500 && 
	`mâ_v®id
(
nmâ
) )

3501 
Å‹
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
nmâ
));

3503  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

3505 iàĞ!
Å‹


3506 || !
	`p2m_is_¿m
(
	`p2m_æags_to_ty³
(
	`l1e_g‘_æags
(
Å‹
[
i
])))

3507 || 
	`l1e_g‘_pâ
(
Å‹
[
i
]è!ğ
	`mâ_x
(
omâ
) )

3510 
	`sh_»move_®l_shadows_ªd_·»Ás
(
v
, 
omâ
);

3511 iàĞ
	`sh_»move_®l_m­pšgs
(
v
, 
omâ
) )

3512 
	`ıus_Ü
(
æushmask
, flushmask, 
d
->
domaš_dœty_ıumask
);

3514 
omâ
 = 
	`_mâ
(
	`mâ_x
(omfn) + 1);

3516 
	`æush_b_mask
(&
æushmask
);

3518 iàĞ
Å‹
 )

3519 
	`unm­_domaš_·ge
(
Å‹
);

3522 
	}
}

3525 
	$shadow_wr™e_p2m_’Œy
(
vıu
 *
v
, 
gâ
,

3526 
l1_pg’Œy_t
 *
p
, 
mâ_t
 
bË_mâ
,

3527 
l1_pg’Œy_t
 
Ãw
, 
Ëv–
)

3529 
domaš
 *
d
 = 
v
->domain;

3531 
	`shadow_lock
(
d
);

3535 iàĞ
	`lik–y
(
d
->
¬ch
.
·gšg
.
shadow
.
tÙ®_·ges
 != 0) )

3536 
	`sh_unshadow_fÜ_p2m_chªge
(
v
, 
gâ
, 
p
, 
bË_mâ
, 
Ãw
, 
Ëv–
);

3539 
	`§ã_wr™e_±e
(
p
, 
Ãw
);

3542 #ià
CONFIG_PAGING_LEVELS
 == 3

3543 iàĞ
Ëv–
 == 3 )

3546 
	`p2m_š¡®l_’Œy_š_mÚ™Üs
(
d
, (
l3_pg’Œy_t
 *)
p
);

3549 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_FAULT_PATH
)

3556 iàĞ
d
->
¬ch
.
·gšg
.
shadow
.
has_ç¡_mmio_’Œ›s
 )

3558 
	`shadow_blow_bËs
(
d
);

3559 
d
->
¬ch
.
·gšg
.
shadow
.
has_ç¡_mmio_’Œ›s
 = 0;

3563 
	`shadow_uÆock
(
d
);

3564 
	}
}

3572 
	$shadow_’abË_log_dœty
(
domaš
 *
d
)

3574 
»t
;

3577 
	`shadow_lock
(
d
);

3578 iàĞ
	`shadow_mode_’abËd
(
d
) )

3583 
	`shadow_blow_bËs
(
d
);

3586 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_LINUX_L3_TOPLEVEL
)

3590 iàĞ
	`is_pv_32Ú64_domaš
(
d
) )

3591 
d
->
¬ch
.
·gšg
.
shadow
.
İt_æags
 = 
SHOPT_LINUX_L3_TOPLEVEL
;

3594 
»t
 = 
	`shadow_Úe_b™_’abË
(
d
, 
PG_log_dœty
);

3595 
	`shadow_uÆock
(
d
);

3597  
»t
;

3598 
	}
}

3601 
	$shadow_di§bË_log_dœty
(
domaš
 *
d
)

3603 
»t
;

3606 
	`shadow_lock
(
d
);

3607 
»t
 = 
	`shadow_Úe_b™_di§bË
(
d
, 
PG_log_dœty
);

3608 
	`shadow_uÆock
(
d
);

3610  
»t
;

3611 
	}
}

3616 
	$shadow_ş—n_dœty_b™m­
(
domaš
 *
d
)

3618 
	`shadow_lock
(
d
);

3622 
	`shadow_blow_bËs
(
d
);

3623 
	`shadow_uÆock
(
d
);

3624 
	}
}

3629 
shadow_Œack_dœty_v¿m
(
domaš
 *
d
,

3630 
begš_pâ
,

3631 
Ä
,

3632 
	$XEN_GUEST_HANDLE_64
(
ušt8
è
dœty_b™m­
)

3634 
rc
;

3635 
’d_pâ
 = 
begš_pâ
 + 
Ä
;

3636 
dœty_size
 = (
Ä
 + 7) / 8;

3637 
æush_b
 = 0;

3638 
i
;

3639 
p2m_ty³_t
 
t
;

3640 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

3641 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

3643 ià(
’d_pâ
 < 
begš_pâ


3644 || 
begš_pâ
 > 
p2m
->
max_m­³d_pâ


3645 || 
’d_pâ
 >ğ
p2m
->
max_m­³d_pâ
)

3646  -
EINVAL
;

3648 
	`shadow_lock
(
d
);

3650 iàĞ
dœty_v¿m
 && (!
Ä
 ||

3651 Ğ
begš_pâ
 !ğ
dœty_v¿m
->begin_pfn

3652 || 
’d_pâ
 !ğ
dœty_v¿m
->end_pfn )) )

3655 
	`gd´štk
(
XENLOG_INFO
, "¡İpšg¿ckšg VRAM %lx - %lx\n", 
dœty_v¿m
->
begš_pâ
, dœty_v¿m->
’d_pâ
);

3656 
	`xä“
(
dœty_v¿m
->
¦1ma
);

3657 
	`xä“
(
dœty_v¿m
->
dœty_b™m­
);

3658 
	`xä“
(
dœty_v¿m
);

3659 
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dœty_v¿m = 
NULL
;

3662 iàĞ!
Ä
 )

3664 
rc
 = 0;

3665 
out
;

3670 iàĞ!
dœty_v¿m
 )

3674 
	`shadow_blow_bËs
(
d
);

3676 
	`gd´štk
(
XENLOG_INFO
, "Œackšg VRAM %lx - %lx\n", 
begš_pâ
, 
’d_pâ
);

3678 
rc
 = -
ENOMEM
;

3679 iàĞ(
dœty_v¿m
 = 
	`xm®loc
(
sh_dœty_v¿m
)è=ğ
NULL
 )

3680 
out
;

3681 
dœty_v¿m
->
begš_pâ
 = begin_pfn;

3682 
dœty_v¿m
->
’d_pâ
 =ƒnd_pfn;

3683 
d
->
¬ch
.
hvm_domaš
.
dœty_v¿m
 = dirty_vram;

3685 iàĞ(
dœty_v¿m
->
¦1ma
 = 
	`xm®loc_¬¿y
(
·ddr_t
, 
Ä
)è=ğ
NULL
 )

3686 
out_dœty_v¿m
;

3687 
	`mem£t
(
dœty_v¿m
->
¦1ma
, ~0, (
·ddr_t
è* 
Ä
);

3689 iàĞ(
dœty_v¿m
->
dœty_b™m­
 = 
	`xm®loc_¬¿y
(
ušt8_t
, 
dœty_size
)è=ğ
NULL
 )

3690 
out_¦1ma
;

3691 
	`mem£t
(
dœty_v¿m
->
dœty_b™m­
, 0, 
dœty_size
);

3693 
dœty_v¿m
->
Ï¡_dœty
 = 
	`NOW
();

3696 
rc
 = -
ENODATA
;

3698 ià(
dœty_v¿m
->
Ï¡_dœty
 == -1)

3701 
rc
 = -
EFAULT
;

3702 iàĞ
	`cİy_to_gue¡
(
dœty_b™m­
, 
dœty_v¿m
->dœty_b™m­, 
dœty_size
) == 0 )

3703 
rc
 = 0;

3707 #ifdeà
__i386__


3708 
m­_mâ
 = 
INVALID_MFN
;

3709 *
m­_¦1p
 = 
NULL
;

3713  
i
 = 0; i < 
Ä
; i++ ) {

3714 
mâ_t
 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
begš_pâ
 + 
i
, &
t
);

3715 
·ge_šfo
 *
·ge
;

3716 
dœty
 = 0;

3717 
·ddr_t
 
¦1ma
 = 
dœty_v¿m
->¦1ma[
i
];

3719 ià(
	`mâ_x
(
mâ
è=ğ
INVALID_MFN
)

3721 
dœty
 = 1;

3725 
·ge
 = 
	`mâ_to_·ge
(
mâ
);

3726 
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
)

3733 iàĞ
¦1ma
 =ğ
INVALID_PADDR
 )

3736 
dœty
 = 1;

3739 
æush_b
 |ğ
	`sh_»move_®l_m­pšgs
(
d
->
vıu
[0], 
mâ
);

3745 
l1_pg’Œy_t
 *
¦1e
;

3746 #ifdeà
__i386__


3747 *
¦1p
 = 
m­_¦1p
;

3748 
¦1mâ
 = 
	`·ddr_to_pâ
(
¦1ma
);

3750 iàĞ
¦1mâ
 !ğ
m­_mâ
 ) {

3751 iàĞ
m­_¦1p
 )

3752 
	`sh_unm­_domaš_·ge
(
m­_¦1p
);

3753 
m­_¦1p
 = 
¦1p
 = 
	`sh_m­_domaš_·ge
(
	`_mâ
(
¦1mâ
));

3754 
m­_mâ
 = 
¦1mâ
;

3756 
¦1e
 = 
¦1p
 + (
¦1ma
 & ~
PAGE_MASK
);

3758 
¦1e
 = 
	`maddr_to_vœt
(
¦1ma
);

3761 iàĞ
	`l1e_g‘_æags
(*
¦1e
è& 
_PAGE_DIRTY
 )

3763 
dœty
 = 1;

3766 
	`l1e_»move_æags
(*
¦1e
, 
_PAGE_DIRTY
);

3767 
æush_b
 = 1;

3774 
dœty
 = 1;

3779 iàĞ
dœty
 )

3781 
dœty_v¿m
->
dœty_b™m­
[
i
 / 8] |= 1 << (i % 8);

3782 
dœty_v¿m
->
Ï¡_dœty
 = 
	`NOW
();

3786 #ifdeà
__i386__


3787 iàĞ
m­_¦1p
 )

3788 
	`sh_unm­_domaš_·ge
(
m­_¦1p
);

3791 
rc
 = -
EFAULT
;

3792 iàĞ
	`cİy_to_gue¡
(
dœty_b™m­
, 
dœty_v¿m
->dœty_b™m­, 
dœty_size
) == 0 ) {

3793 
	`mem£t
(
dœty_v¿m
->
dœty_b™m­
, 0, 
dœty_size
);

3794 ià(
dœty_v¿m
->
Ï¡_dœty
 + 
	`SECONDS
(2è< 
	`NOW
())

3798  
i
 = 
begš_pâ
; i < 
’d_pâ
; i++ ) {

3799 
mâ_t
 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
i
, &
t
);

3800 ià(
	`mâ_x
(
mâ
è!ğ
INVALID_MFN
)

3801 
æush_b
 |ğ
	`sh_»move_wr™e_acûss
(
d
->
vıu
[0], 
mâ
, 1, 0);

3803 
dœty_v¿m
->
Ï¡_dœty
 = -1;

3805 
rc
 = 0;

3808 iàĞ
æush_b
 )

3809 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

3810 
out
;

3812 
out_¦1ma
:

3813 
	`xä“
(
dœty_v¿m
->
¦1ma
);

3814 
out_dœty_v¿m
:

3815 
	`xä“
(
dœty_v¿m
);

3816 
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dœty_v¿m = 
NULL
;

3818 
out
:

3819 
	`shadow_uÆock
(
d
);

3820  
rc
;

3821 
	}
}

3826 
shadow_domùl
(
domaš
 *
d
,

3827 
x’_domùl_shadow_İ_t
 *
sc
,

3828 
	$XEN_GUEST_HANDLE
(è
u_domùl
)

3830 
rc
, 
´“m±ed
 = 0;

3832  
sc
->
İ
 )

3834 
XEN_DOMCTL_SHADOW_OP_OFF
:

3835 iàĞ
d
->
¬ch
.
·gšg
.
mode
 =ğ
PG_SH_’abË
 )

3836 iàĞ(
rc
 = 
	`shadow_‹¡_di§bË
(
d
)) != 0 )

3837  
rc
;

3840 
XEN_DOMCTL_SHADOW_OP_ENABLE_TEST
:

3841  
	`shadow_‹¡_’abË
(
d
);

3843 
XEN_DOMCTL_SHADOW_OP_ENABLE_TRANSLATE
:

3844  
	`shadow_’abË
(
d
, 
PG_»fcouÁs
|
PG_Œª¦©e
);

3846 
XEN_DOMCTL_SHADOW_OP_ENABLE
:

3847  
	`shadow_’abË
(
d
, 
sc
->
mode
 << 
PG_mode_shiá
);

3849 
XEN_DOMCTL_SHADOW_OP_GET_ALLOCATION
:

3850 
sc
->
mb
 = 
	`shadow_g‘_®loÿtiÚ
(
d
);

3853 
XEN_DOMCTL_SHADOW_OP_SET_ALLOCATION
:

3854 
	`shadow_lock
(
d
);

3855 iàĞ
sc
->
mb
 =ğ0 && 
	`shadow_mode_’abËd
(
d
) )

3859 
	`SHADOW_ERROR
("Can't set shadow‡llocationo zero, domain %u"

3860 " i ¡Èusšg shadows.\n", 
d
->
domaš_id
);

3861 
	`shadow_uÆock
(
d
);

3862  -
EINVAL
;

3864 
rc
 = 
	`sh_£t_®loÿtiÚ
(
d
, 
sc
->
mb
 << (20 - 
PAGE_SHIFT
), &
´“m±ed
);

3865 
	`shadow_uÆock
(
d
);

3866 iàĞ
´“m±ed
 )

3868 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

3869 
__HYPERVISOR_domùl
, "h", 
u_domùl
);

3872 
sc
->
mb
 = 
	`shadow_g‘_®loÿtiÚ
(
d
);

3873  
rc
;

3876 
	`SHADOW_ERROR
("Bad shadow o°%u\n", 
sc
->
İ
);

3877  -
EINVAL
;

3879 
	}
}

3885 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_FULL


3887 
	$shadow_aud™_bËs
(
vıu
 *
v
)

3890 cÚ¡ 
hash_ÿÎback_t
 
ÿÎbacks
[
SH_ty³_unu£d
] = {

3891 
NULL
,

3892 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l1_bË
, 2),

3893 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_æ1_bË
, 2),

3894 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 2),

3895 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l1_bË
, 3),

3896 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_æ1_bË
, 3),

3897 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 3),

3898 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 3),

3899 #ià
CONFIG_PAGING_LEVELS
 >= 4

3900 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l1_bË
, 4),

3901 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_æ1_bË
, 4),

3902 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 4),

3903 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 4),

3904 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l3_bË
, 4),

3905 
	`SHADOW_INTERNAL_NAME
(
sh_aud™_l4_bË
, 4),

3907 
NULL


3909 
mask
;

3911 iàĞ!(
SHADOW_AUDIT_ENABLE
) )

3914 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3915 
	`sh_oos_aud™
(
v
->
domaš
);

3918 iàĞ
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_FULL
 )

3919 
mask
 = ~1;

3923  
v
->
¬ch
.
·gšg
.
mode
->
gue¡_Ëv–s
 )

3925 2: 
mask
 = (
SHF_L1_32
|
SHF_FL1_32
|
SHF_L2_32
); ;

3926 3: 
mask
 = (
SHF_L1_PAE
|
SHF_FL1_PAE
|
SHF_L2_PAE


3927 |
SHF_L2H_PAE
); ;

3928 4: 
mask
 = (
SHF_L1_64
|
SHF_FL1_64
|
SHF_L2_64


3929 |
SHF_L3_64
|
SHF_L4_64
); ;

3930 : 
	`BUG
();

3934 
	`hash_fÜ—ch
(
v
, ~1, 
ÿÎbacks
, 
	`_mâ
(
INVALID_MFN
));

3935 
	}
}

	@mm/shadow/multi.c

24 
	~<x’/cÚfig.h
>

25 
	~<x’/ty³s.h
>

26 
	~<x’/mm.h
>

27 
	~<x’/Œaû.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/³rfc.h
>

30 
	~<x’/domaš_·ge.h
>

31 
	~<x’/ioÿp.h
>

32 
	~<asm/·ge.h
>

33 
	~<asm/cu¼’t.h
>

34 
	~<asm/shadow.h
>

35 
	~<asm/æushb.h
>

36 
	~<asm/hvm/hvm.h
>

37 
	~<asm/hvm/ÿch—‰r.h
>

38 
	~<asm/mŒr.h
>

39 
	~<asm/gue¡_±.h
>

40 
	~<public/sched.h
>

41 
	~"´iv©e.h
"

42 
	~"ty³s.h
"

67 
	#FETCH_TYPE_PREFETCH
 1

	)

68 
	#FETCH_TYPE_DEMAND
 2

	)

69 
	#FETCH_TYPE_WRITE
 4

	)

71 
	má_´eãtch
 = 
FETCH_TYPE_PREFETCH
,

72 
	má_demªd_»ad
 = 
FETCH_TYPE_DEMAND
,

73 
	má_demªd_wr™e
 = 
FETCH_TYPE_DEMAND
 | 
FETCH_TYPE_WRITE
,

74 } 
	tãtch_ty³_t
;

76 #ifdeà
DEBUG_TRACE_DUMP


77 *
	gãtch_ty³_Çmes
[] = {

78 [
á_´eãtch
] "prefetch",

79 [
á_demªd_»ad
] "demand„ead",

80 [
á_demªd_wr™e
] "demand write",

92 
šlše
 
mâ_t


93 
	$g‘_æ1_shadow_¡©us
(
vıu
 *
v
, 
gâ_t
 
gâ
)

96 
mâ_t
 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`gâ_x
(
gâ
), 
SH_ty³_æ1_shadow
);

97 
	`ASSERT
(!
	`mâ_v®id
(
smâ
è|| 
	`mâ_to_·ge
(smâ)->
u
.
sh
.
h—d
);

98  
smâ
;

99 
	}
}

101 
šlše
 
mâ_t


102 
	$g‘_shadow_¡©us
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
shadow_ty³
)

105 
mâ_t
 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`mâ_x
(
gmâ
), 
shadow_ty³
);

106 
	`ASSERT
(!
	`mâ_v®id
(
smâ
è|| 
	`mâ_to_·ge
(smâ)->
u
.
sh
.
h—d
);

107 
	`³rfc_šü
(
shadow_g‘_shadow_¡©us
);

108  
smâ
;

109 
	}
}

111 
šlše
 

112 
	$£t_æ1_shadow_¡©us
(
vıu
 *
v
, 
gâ_t
 
gâ
, 
mâ_t
 
smâ
)

115 
	`SHADOW_PRINTK
("gâ=%"
SH_PRI_gâ
",ype=%08x, smfn=%05lx\n",

116 
	`gâ_x
(
gâ
), 
SH_ty³_æ1_shadow
, 
	`mâ_x
(
smâ
));

118 
	`ASSERT
(
	`mâ_to_·ge
(
smâ
)->
u
.
sh
.
h—d
);

119 
	`shadow_hash_š£¹
(
v
, 
	`gâ_x
(
gâ
), 
SH_ty³_æ1_shadow
, 
smâ
);

120 
	}
}

122 
šlše
 

123 
	$£t_shadow_¡©us
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
shadow_ty³
, mâ_ˆ
smâ
)

126 
domaš
 *
d
 = 
v
->domain;

127 
»s
;

129 
	`SHADOW_PRINTK
("d=%d, v=%d, gmfn=%05lx,ype=%08x, smfn=%05lx\n",

130 
d
->
domaš_id
, 
v
->
vıu_id
, 
	`mâ_x
(
gmâ
),

131 
shadow_ty³
, 
	`mâ_x
(
smâ
));

133 
	`ASSERT
(
	`mâ_to_·ge
(
smâ
)->
u
.
sh
.
h—d
);

136 iàĞ!
	`is_pv_32Ú64_vıu
(
v
è|| 
shadow_ty³
 !ğ
SH_ty³_l4_64_shadow
 )

138 
»s
 = 
	`g‘_·ge
(
	`mâ_to_·ge
(
gmâ
), 
d
);

139 
	`ASSERT
(
»s
 == 1);

142 
	`shadow_hash_š£¹
(
v
, 
	`mâ_x
(
gmâ
), 
shadow_ty³
, 
smâ
);

143 
	}
}

145 
šlše
 

146 
	$d–‘e_æ1_shadow_¡©us
(
vıu
 *
v
, 
gâ_t
 
gâ
, 
mâ_t
 
smâ
)

149 
	`SHADOW_PRINTK
("gâ=%"
SH_PRI_gâ
",ype=%08x, smfn=%05lx\n",

150 
	`gâ_x
(
gâ
), 
SH_ty³_æ1_shadow
, 
	`mâ_x
(
smâ
));

151 
	`ASSERT
(
	`mâ_to_·ge
(
smâ
)->
u
.
sh
.
h—d
);

152 
	`shadow_hash_d–‘e
(
v
, 
	`gâ_x
(
gâ
), 
SH_ty³_æ1_shadow
, 
smâ
);

153 
	}
}

155 
šlše
 

156 
	$d–‘e_shadow_¡©us
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
shadow_ty³
, mâ_ˆ
smâ
)

159 
	`SHADOW_PRINTK
("d=%d, v=%d, gmfn=%05lx,ype=%08x, smfn=%05lx\n",

160 
v
->
domaš
->
domaš_id
, v->
vıu_id
,

161 
	`mâ_x
(
gmâ
), 
shadow_ty³
, mâ_x(
smâ
));

162 
	`ASSERT
(
	`mâ_to_·ge
(
smâ
)->
u
.
sh
.
h—d
);

163 
	`shadow_hash_d–‘e
(
v
, 
	`mâ_x
(
gmâ
), 
shadow_ty³
, 
smâ
);

165 iàĞ!
	`is_pv_32Ú64_vıu
(
v
è|| 
shadow_ty³
 !ğ
SH_ty³_l4_64_shadow
 )

166 
	`put_·ge
(
	`mâ_to_·ge
(
gmâ
));

167 
	}
}

173 
šlše
 
ušt32_t


174 
	$sh_w®k_gue¡_bËs
(
vıu
 *
v
, 
va
, 
w®k_t
 *
gw
,

175 
ušt32_t
 
pãc
)

177  
	`gue¡_w®k_bËs
(
v
, 
	`p2m_g‘_ho¡p2m
(v->
domaš
), 
va
, 
gw
, 
pãc
,

178 #ià
GUEST_PAGING_LEVELS
 == 3

179 
	`_mâ
(
INVALID_MFN
),

180 
v
->
¬ch
.
·gšg
.
shadow
.
gl3e


182 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
gue¡_bË
),

183 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË


186 
	}
}

194 
šlše
 
ušt32_t


195 
	$shadow_check_gw®k
(
vıu
 *
v
, 
va
, 
w®k_t
 *
gw
, 
v”siÚ
)

197 
domaš
 *
d
 = 
v
->domain;

198 
gue¡_l1e_t
 *
l1p
;

199 
gue¡_l2e_t
 *
l2p
;

200 #ià
GUEST_PAGING_LEVELS
 >= 4

201 
gue¡_l3e_t
 *
l3p
;

202 
gue¡_l4e_t
 *
l4p
;

204 
mism©ch
 = 0;

206 
	`ASSERT
(
	`shadow_locked_by_me
(
d
));

208 iàĞ
v”siÚ
 =ğ
	`©omic_»ad
(&
d
->
¬ch
.
·gšg
.
shadow
.
gbË_dœty_v”siÚ
) )

221 
	`³rfc_šü
(
shadow_check_gw®k
);

222 #ià
GUEST_PAGING_LEVELS
 >= 3

223 #ià
GUEST_PAGING_LEVELS
 >= 4

224 
l4p
 = (
gue¡_l4e_t
 *)
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
;

225 
mism©ch
 |ğ(
gw
->
l4e
.
l4
 !ğ
l4p
[
	`gue¡_l4_bË_off£t
(
va
)].l4);

226 
l3p
 = 
	`sh_m­_domaš_·ge
(
gw
->
l3mâ
);

227 
mism©ch
 |ğ(
gw
->
l3e
.
l3
 !ğ
l3p
[
	`gue¡_l3_bË_off£t
(
va
)].l3);

228 
	`sh_unm­_domaš_·ge
(
l3p
);

230 
mism©ch
 |ğ(
gw
->
l3e
.
l3
 !=

231 
v
->
¬ch
.
·gšg
.
shadow
.
gl3e
[
	`gue¡_l3_bË_off£t
(
va
)].
l3
);

233 
l2p
 = 
	`sh_m­_domaš_·ge
(
gw
->
l2mâ
);

234 
mism©ch
 |ğ(
gw
->
l2e
.
l2
 !ğ
l2p
[
	`gue¡_l2_bË_off£t
(
va
)].l2);

235 
	`sh_unm­_domaš_·ge
(
l2p
);

237 
l2p
 = (
gue¡_l2e_t
 *)
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
;

238 
mism©ch
 |ğ(
gw
->
l2e
.
l2
 !ğ
l2p
[
	`gue¡_l2_bË_off£t
(
va
)].l2);

240 iàĞ!(
	`gue¡_suµÜts_su³½ages
(
v
) &&

241 (
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
)) )

243 
l1p
 = 
	`sh_m­_domaš_·ge
(
gw
->
l1mâ
);

244 
mism©ch
 |ğ(
gw
->
l1e
.
l1
 !ğ
l1p
[
	`gue¡_l1_bË_off£t
(
va
)].l1);

245 
	`sh_unm­_domaš_·ge
(
l1p
);

248  !
mism©ch
;

249 
	}
}

252 
	$shadow_check_gl1e
(
vıu
 *
v
, 
w®k_t
 *
gw
)

254 
gue¡_l1e_t
 *
l1p
, 
Æ1e
;

256 iàĞ!
	`mâ_v®id
(
gw
->
l1mâ
) )

260 
l1p
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
gw
->
l1mâ
));

261 
Æ1e
.
l1
 = 
l1p
[
	`gue¡_l1_bË_off£t
(
gw
->
va
)].l1;

262 
	`unm­_domaš_·ge
(
l1p
);

264  
gw
->
l1e
.
l1
 !ğ
Æ1e
.l1;

265 
	}
}

276 
	#GW_RMWR_FLUSHTLB
 1

	)

277 
	#GW_RMWR_REWALK
 2

	)

279 
šlše
 
ušt32_t


280 
	$gw_»move_wr™e_acûs£s
(
vıu
 *
v
, 
va
, 
w®k_t
 *
gw
)

282 
ušt32_t
 
rc
 = 0;

284 #ià
GUEST_PAGING_LEVELS
 >= 3

285 #ià
GUEST_PAGING_LEVELS
 >= 4

286 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

287 iàĞ
	`mâ_is_out_of_sync
(
gw
->
l3mâ
) )

289 
	`sh_»sync
(
v
, 
gw
->
l3mâ
);

290 
rc
 = 
GW_RMWR_REWALK
;

294 iàĞ
	`sh_»move_wr™e_acûss
(
v
, 
gw
->
l3mâ
, 3, 
va
) )

295 
rc
 = 
GW_RMWR_FLUSHTLB
;

298 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

299 iàĞ
	`mâ_is_out_of_sync
(
gw
->
l2mâ
) )

301 
	`sh_»sync
(
v
, 
gw
->
l2mâ
);

302 
rc
 |ğ
GW_RMWR_REWALK
;

306 iàĞ
	`sh_»move_wr™e_acûss
(
v
, 
gw
->
l2mâ
, 2, 
va
) )

307 
rc
 |ğ
GW_RMWR_FLUSHTLB
;

310 iàĞ!(
	`gue¡_suµÜts_su³½ages
(
v
) &&

311 (
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
))

312 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

313 && !
	`mâ_is_out_of_sync
(
gw
->
l1mâ
)

315 && 
	`sh_»move_wr™e_acûss
(
v
, 
gw
->
l1mâ
, 1, 
va
) )

316 
rc
 |ğ
GW_RMWR_FLUSHTLB
;

318  
rc
;

319 
	}
}

321 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES


324 
	$sh_aud™_gw
(
vıu
 *
v
, 
w®k_t
 *
gw
)

326 
mâ_t
 
smâ
;

328 iàĞ!(
SHADOW_AUDIT_ENABLE
) )

331 #ià
GUEST_PAGING_LEVELS
 >= 4

332 iàĞ
	`mâ_v®id
(
gw
->
l4mâ
)

333 && 
	`mâ_v®id
((
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l4mâ
,

334 
SH_ty³_l4_shadow
))) )

335 (è
	`sh_aud™_l4_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

336 iàĞ
	`mâ_v®id
(
gw
->
l3mâ
)

337 && 
	`mâ_v®id
((
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l3mâ
,

338 
SH_ty³_l3_shadow
))) )

339 (è
	`sh_aud™_l3_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

341 iàĞ
	`mâ_v®id
(
gw
->
l2mâ
) )

343 iàĞ
	`mâ_v®id
((
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l2mâ
,

344 
SH_ty³_l2_shadow
))) )

345 (è
	`sh_aud™_l2_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

346 #ià
GUEST_PAGING_LEVELS
 == 3

347 iàĞ
	`mâ_v®id
((
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l2mâ
,

348 
SH_ty³_l2h_shadow
))) )

349 (è
	`sh_aud™_l2_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

352 iàĞ
	`mâ_v®id
(
gw
->
l1mâ
)

353 && 
	`mâ_v®id
((
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l1mâ
,

354 
SH_ty³_l1_shadow
))) )

355 (è
	`sh_aud™_l1_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

356 iàĞ(
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PRESENT
)

357 && (
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
)

358 && 
	`mâ_v®id
(

359 (
smâ
 = 
	`g‘_æ1_shadow_¡©us
(
v
, 
	`gue¡_l2e_g‘_gâ
(
gw
->
l2e
)))) )

360 (è
	`sh_aud™_æ1_bË
(
v
, 
smâ
, 
	`_mâ
(
INVALID_MFN
));

361 
	}
}

364 
	#sh_aud™_gw
(
_v
, 
_gw
èdØ{} 0)

	)

368 #ià(
CONFIG_PAGING_LEVELS
 =ğ
GUEST_PAGING_LEVELS
)

370 
	$sh_gue¡_m­_l1e
(
vıu
 *
v
, 
addr
,

371 *
gl1mâ
)

373 *
¶1e
 = 
NULL
;

374 
w®k_t
 
gw
;

376 
	`ASSERT
(
	`shadow_mode_Œª¦©e
(
v
->
domaš
));

381 iàĞ
	`sh_w®k_gue¡_bËs
(
v
, 
addr
, &
gw
, 
PFEC_·ge_´e£Á
) == 0

382 && 
	`mâ_v®id
(
gw
.
l1mâ
) )

384 iàĞ
gl1mâ
 )

385 *
gl1mâ
 = 
	`mâ_x
(
gw
.
l1mâ
);

386 
¶1e
 = 
	`m­_domaš_·ge
(
	`mâ_x
(
gw
.
l1mâ
)) +

387 (
	`gue¡_l1_bË_off£t
(
addr
è* (
gue¡_l1e_t
));

390  
¶1e
;

391 
	}
}

394 
	$sh_gue¡_g‘_eff_l1e
(
vıu
 *
v
, 
addr
, *
eff_l1e
)

396 
w®k_t
 
gw
;

398 
	`ASSERT
(
	`shadow_mode_Œª¦©e
(
v
->
domaš
));

403 (è
	`sh_w®k_gue¡_bËs
(
v
, 
addr
, &
gw
, 
PFEC_·ge_´e£Á
);

404 *(
gue¡_l1e_t
 *)
eff_l1e
 = 
gw
.
l1e
;

405 
	}
}

427 
šlše
 
mâ_t
 
	$sh_Ãxt_·ge
(
mâ_t
 
smâ
)

429 
mâ_t
 
Ãxt
;

430 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
smâ
);

432 
	`ASSERT
(
pg
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_32_shadow


433 || 
pg
->
u
.
sh
.
ty³
 =ğ
SH_ty³_æ1_32_shadow


434 || 
pg
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

435 
	`ASSERT
(
pg
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
 ||…g->u.sh.
h—d
);

436 
	`ASSERT
(
pg
->
li¡
.
Ãxt
 !ğ
PAGE_LIST_NULL
);

438 
Ãxt
 = 
	`_mâ
(
	`pdx_to_pâ
(
pg
->
li¡
.next));

440 
	`ASSERT
(
	`mâ_to_·ge
(
Ãxt
)->
u
.
sh
.
ty³
 =ğ
pg
->u.sh.type);

441 
	`ASSERT
(!
	`mâ_to_·ge
(
Ãxt
)->
u
.
sh
.
h—d
);

442  
Ãxt
;

443 
	}
}

445 
šlše
 
u32


446 
	$gue¡_šdex
(*
±r
)

448  (
u32
)(()
±r
 & ~
PAGE_MASK
è/ (
gue¡_l1e_t
);

449 
	}
}

451 
u32


452 
	$shadow_l1_šdex
(
mâ_t
 *
smâ
, 
u32
 
gue¡_šdex
)

454 #ià(
GUEST_PAGING_LEVELS
 == 2)

455 
	`ASSERT
(
	`mâ_to_·ge
(*
smâ
)->
u
.
sh
.
h—d
);

456 iàĞ
gue¡_šdex
 >ğ
SHADOW_L1_PAGETABLE_ENTRIES
 )

457 *
smâ
 = 
	`sh_Ãxt_·ge
(*smfn);

458  (
gue¡_šdex
 % 
SHADOW_L1_PAGETABLE_ENTRIES
);

460  
gue¡_šdex
;

462 
	}
}

464 
u32


465 
	$shadow_l2_šdex
(
mâ_t
 *
smâ
, 
u32
 
gue¡_šdex
)

467 #ià(
GUEST_PAGING_LEVELS
 == 2)

468 
i
;

469 
	`ASSERT
(
	`mâ_to_·ge
(*
smâ
)->
u
.
sh
.
h—d
);

472  
i
 = 0; i < 
gue¡_šdex
 / (
SHADOW_L2_PAGETABLE_ENTRIES
 / 2); i++ )

473 *
smâ
 = 
	`sh_Ãxt_·ge
(*smfn);

476  (
gue¡_šdex
 % (
SHADOW_L2_PAGETABLE_ENTRIES
 / 2)) * 2;

478  
gue¡_šdex
;

480 
	}
}

482 #ià
GUEST_PAGING_LEVELS
 >= 4

484 
u32


485 
	$shadow_l3_šdex
(
mâ_t
 *
smâ
, 
u32
 
gue¡_šdex
)

487  
gue¡_šdex
;

488 
	}
}

490 
u32


491 
	$shadow_l4_šdex
(
mâ_t
 *
smâ
, 
u32
 
gue¡_šdex
)

493  
gue¡_šdex
;

494 
	}
}

506 
®ways_šlše
 

507 
	$_sh_´İag©e
(
vıu
 *
v
,

508 
gue¡_š‹_t
 
gue¡_š‹
,

509 
mâ_t
 
rg‘_mâ
,

510 *
shadow_’Œy_±r
,

511 
Ëv–
,

512 
ãtch_ty³_t
 
á
,

513 
p2m_ty³_t
 
p2mt
)

515 
gue¡_l1e_t
 
gue¡_’Œy
 = { 
gue¡_š‹
 };

516 
shadow_l1e_t
 *
¥
 = 
shadow_’Œy_±r
;

517 
domaš
 *
d
 = 
v
->domain;

518 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

519 
gâ_t
 
rg‘_gâ
 = 
	`gue¡_l1e_g‘_gâ
(
gue¡_’Œy
);

520 
u32
 
·ss_thru_æags
;

521 
u32
 
gæags
, 
sæags
;

524 
	`ASSERT
(
GUEST_PAGING_LEVELS
 > 3 || 
Ëv–
 != 3);

527 iàĞ!
	`p2m_is_v®id
(
p2mt
è&& !
	`p2m_is_g¿Á
(p2mt) )

529 *
¥
 = 
	`shadow_l1e_em±y
();

530 
dÚe
;

533 
gæags
 = 
	`gue¡_l1e_g‘_æags
(
gue¡_’Œy
);

535 iàĞ
	`uÆik–y
(!(
gæags
 & 
_PAGE_PRESENT
)) )

537 #ià!(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

540 iàĞ
Ëv–
 == 1 )

541 *
¥
 = 
	`sh_l1e_gÅ
();

544 *
¥
 = 
	`shadow_l1e_em±y
();

545 
dÚe
;

548 iàĞ
Ëv–
 =ğ1 && 
p2mt
 =ğ
p2m_mmio_dm
 )

551 *
¥
 = 
	`sh_l1e_mmio
(
rg‘_gâ
, 
gæags
);

552 iàĞ!
d
->
¬ch
.
·gšg
.
shadow
.
has_ç¡_mmio_’Œ›s
 )

553 
d
->
¬ch
.
·gšg
.
shadow
.
has_ç¡_mmio_’Œ›s
 = 1;

554 
dÚe
;

562 iàĞ!
	`mâ_v®id
(
rg‘_mâ
)

563 && !(
Ëv–
 =ğ1 && (!
	`shadow_mode_»fcouÁs
(
d
)

564 || 
p2mt
 =ğ
p2m_mmio_dœeù
)) )

566 
	`ASSERT
((
á
 =ğ
á_´eãtch
));

567 *
¥
 = 
	`shadow_l1e_em±y
();

568 
dÚe
;

576 
·ss_thru_æags
 = (
_PAGE_ACCESSED
 | 
_PAGE_USER
 |

577 
_PAGE_RW
 | 
_PAGE_PRESENT
);

578 iàĞ
	`gue¡_suµÜts_nx
(
v
) )

579 
·ss_thru_æags
 |ğ
_PAGE_NX_BIT
;

580 iàĞ!
	`shadow_mode_»fcouÁs
(
d
è&& !
	`mâ_v®id
(
rg‘_mâ
) )

581 
·ss_thru_æags
 |ğ
_PAGE_PAT
 | 
_PAGE_PCD
 | 
_PAGE_PWT
;

582 
sæags
 = 
gæags
 & 
·ss_thru_æags
;

588 iàĞ(
Ëv–
 =ğ1è&& 
	`is_hvm_domaš
(
d
) &&

589 !
	`is_x’_h—p_mâ
(
	`mâ_x
(
rg‘_mâ
)) )

591 
ty³
;

600 iàĞ
	`hvm_g‘_mem_pšÃd_ÿch—‰r
(
d
, 
	`gâ_x
(
rg‘_gâ
), &
ty³
) )

601 
sæags
 |ğ
	`·t_ty³_2_±e_æags
(
ty³
);

602 iàĞ
d
->
¬ch
.
hvm_domaš
.
is_š_uc_mode
 )

603 
sæags
 |ğ
	`·t_ty³_2_±e_æags
(
PAT_TYPE_UNCACHABLE
);

605 iàĞ
	`iomem_acûss_³rm™‹d
(
d
, 
	`mâ_x
(
rg‘_mâ
), mfn_x(target_mfn) + 1) )

607 iàĞ
p2mt
 =ğ
p2m_mmio_dœeù
 )

608 
sæags
 |ğ
	`g‘_·t_æags
(
v
,

609 
gæags
,

610 
	`gâ_to_·ddr
(
rg‘_gâ
),

611 ((
·ddr_t
)
	`mâ_x
(
rg‘_mâ
)è<< 
PAGE_SHIFT
,

612 
MTRR_TYPE_UNCACHABLE
);

613 iàĞ
iommu_¢oİ
 )

614 
sæags
 |ğ
	`·t_ty³_2_±e_æags
(
PAT_TYPE_WRBACK
);

616 
sæags
 |ğ
	`g‘_·t_æags
(
v
,

617 
gæags
,

618 
	`gâ_to_·ddr
(
rg‘_gâ
),

619 ((
·ddr_t
)
	`mâ_x
(
rg‘_mâ
)è<< 
PAGE_SHIFT
,

620 
NO_HARDCODE_MEM_TYPE
);

631 iàĞ(
Ëv–
 > 1è&& !((
SHADOW_PAGING_LEVELS
 == 3) && (level == 3)) )

632 
sæags
 |ğ
_PAGE_ACCESSED
 | 
_PAGE_DIRTY
;

637 iàĞ
	`uÆik–y
(!(
gæags
 & 
_PAGE_ACCESSED
)) )

638 
sæags
 &ğ~
_PAGE_PRESENT
;

641 iàĞ
	`uÆik–y
(((
Ëv–
 == 1) ||

642 ((
Ëv–
 == 2) &&

643 (
gæags
 & 
_PAGE_PSE
) &&

644 
	`gue¡_suµÜts_su³½ages
(
v
)))

645 && !(
gæags
 & 
_PAGE_DIRTY
)) )

646 
sæags
 &ğ~
_PAGE_RW
;

655 iàĞ
	`uÆik–y
((
Ëv–
 =ğ1è&& 
	`shadow_mode_log_dœty
(
d
)) )

657 iàĞ
	`mâ_v®id
(
rg‘_mâ
) ) {

658 iàĞ
á
 & 
FETCH_TYPE_WRITE
 )

659 
	`·gšg_m¬k_dœty
(
d
, 
	`mâ_x
(
rg‘_mâ
));

660 iàĞ!
	`·gšg_mâ_is_dœty
(
d
, 
rg‘_mâ
) )

661 
sæags
 &ğ~
_PAGE_RW
;

665 iàĞ
	`uÆik–y
((
Ëv–
 =ğ1è&& 
dœty_v¿m


666 && 
dœty_v¿m
->
Ï¡_dœty
 == -1

667 && 
	`gâ_x
(
rg‘_gâ
è>ğ
dœty_v¿m
->
begš_pâ


668 && 
	`gâ_x
(
rg‘_gâ
è< 
dœty_v¿m
->
’d_pâ
) )

670 iàĞ
á
 & 
FETCH_TYPE_WRITE
 )

671 
dœty_v¿m
->
Ï¡_dœty
 = 
	`NOW
();

673 
sæags
 &ğ~
_PAGE_RW
;

677 iàĞ
	`p2m_is_»adÚly
(
p2mt
) ||

678 (
p2mt
 =ğ
p2m_mmio_dœeù
 &&

679 
	`¿nge£t_cÚšs_sšgËtÚ
(
mmio_ro_¿nges
, 
	`mâ_x
(
rg‘_mâ
))) )

680 
sæags
 &ğ~
_PAGE_RW
;

684 iàĞ
	`uÆik–y
((
Ëv–
 == 1)

685 && 
	`sh_mâ_is_a_·ge_bË
(
rg‘_mâ
)

686 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

689 && !(
	`mâ_oos_may_wr™e
(
rg‘_mâ
)

690 && (
á
 =ğ
á_demªd_wr™e
))

694 iàĞ
	`shadow_mode_Œ­_»ads
(
d
) )

699 
sæags
 &ğ~
_PAGE_PRESENT
;

705 
sæags
 &ğ~
_PAGE_RW
;

712 iàĞ(
GUEST_PAGING_LEVELS
 =ğ4è&& !
	`is_pv_32Ú64_domaš
(
d
)

713 && !
	`is_hvm_domaš
(
d
) )

715 
sæags
 |ğ
_PAGE_USER
;

718 *
¥
 = 
	`shadow_l1e_äom_mâ
(
rg‘_mâ
, 
sæags
);

720 
dÚe
:

721 
	`SHADOW_DEBUG
(
PROPAGATE
,

722 "% Ëv– %u gue¡ %" 
SH_PRI_g±e
 " shadow %" 
SH_PRI_±e
 "\n",

723 
ãtch_ty³_Çmes
[
á
], 
Ëv–
, 
gue¡_’Œy
.
l1
, 
¥
->l1);

724 
	}
}

731 #ià
GUEST_PAGING_LEVELS
 >= 4

733 
	$l4e_´İag©e_äom_gue¡
(
vıu
 *
v
,

734 
gue¡_l4e_t
 
gl4e
,

735 
mâ_t
 
¦3mâ
,

736 
shadow_l4e_t
 *
¦4e
,

737 
ãtch_ty³_t
 
á
)

739 
	`_sh_´İag©e
(
v
, 
gl4e
.
l4
, 
¦3mâ
, 
¦4e
, 4, 
á
, 
p2m_¿m_rw
);

740 
	}
}

743 
	$l3e_´İag©e_äom_gue¡
(
vıu
 *
v
,

744 
gue¡_l3e_t
 
gl3e
,

745 
mâ_t
 
¦2mâ
,

746 
shadow_l3e_t
 *
¦3e
,

747 
ãtch_ty³_t
 
á
)

749 
	`_sh_´İag©e
(
v
, 
gl3e
.
l3
, 
¦2mâ
, 
¦3e
, 3, 
á
, 
p2m_¿m_rw
);

750 
	}
}

754 
	$l2e_´İag©e_äom_gue¡
(
vıu
 *
v
,

755 
gue¡_l2e_t
 
gl2e
,

756 
mâ_t
 
¦1mâ
,

757 
shadow_l2e_t
 *
¦2e
,

758 
ãtch_ty³_t
 
á
)

760 
	`_sh_´İag©e
(
v
, 
gl2e
.
l2
, 
¦1mâ
, 
¦2e
, 2, 
á
, 
p2m_¿m_rw
);

761 
	}
}

764 
	$l1e_´İag©e_äom_gue¡
(
vıu
 *
v
,

765 
gue¡_l1e_t
 
gl1e
,

766 
mâ_t
 
gmâ
,

767 
shadow_l1e_t
 *
¦1e
,

768 
ãtch_ty³_t
 
á
,

769 
p2m_ty³_t
 
p2mt
)

771 
	`_sh_´İag©e
(
v
, 
gl1e
.
l1
, 
gmâ
, 
¦1e
, 1, 
á
, 
p2mt
);

772 
	}
}

781 
šlše
 
	$§ã_wr™e_’Œy
(*
d¡
, *
¤c
)

787 vŞ©*
d
 = 
d¡
;

788 *
s
 = 
¤c
;

789 
	`ASSERT
(!((è
d
 & ( (
shadow_l1e_t
) - 1)));

790 #ià
CONFIG_PAGING_LEVELS
 == 3

796 
	`BUILD_BUG_ON
( (
shadow_l1e_t
) != 2 *  ());

797 
d
[0] = 0;

798 
d
[1] = 
s
[1];

799 
d
[0] = 
s
[0];

803 
	`BUILD_BUG_ON
( (
shadow_l1e_t
) !=  ());

804 *
d
 = *
s
;

806 
	}
}

809 
šlše
 

810 
	$shadow_wr™e_’Œ›s
(*
d
, *
s
, 
’Œ›s
, 
mâ_t
 
mâ
)

815 
shadow_l1e_t
 *
d¡
 = 
d
;

816 
shadow_l1e_t
 *
¤c
 = 
s
;

817 *
m­
 = 
NULL
;

818 
i
;

825 iàĞ
	`__cİy_to_u£r
(
d
, d,  ()) != 0 )

827 
	`³rfc_šü
(
shadow_lš—r_m­_çed
);

828 
m­
 = 
	`sh_m­_domaš_·ge
(
mâ
);

829 
	`ASSERT
(
m­
 !ğ
NULL
);

830 
d¡
 = 
m­
 + (()d¡ & (
PAGE_SIZE
 - 1));

834  
i
 = 0; i < 
’Œ›s
; i++ )

835 
	`§ã_wr™e_’Œy
(
d¡
++, 
¤c
++);

837 iàĞ
m­
 !ğ
NULL
 ) 
	`sh_unm­_domaš_·ge
(map);

838 
	}
}

840 
šlše
 

841 
	$³rms_¡riùly_šü—£d
(
u32
 
Şd_æags
, u32 
Ãw_æags
)

845 
u32
 
of
 = 
Şd_æags
 & (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_NX
);

846 
u32
 
nf
 = 
Ãw_æags
 & (
_PAGE_PRESENT
|
_PAGE_RW
|
_PAGE_USER
|
_PAGE_NX
);

849 
of
 ^ğ
_PAGE_NX_BIT
;

850 
nf
 ^ğ
_PAGE_NX_BIT
;

853  ((
of
 | (oà^ 
nf
)) ==‚f);

854 
	}
}

858 
šlše


859 
	$shadow_g‘_·ge_äom_l1e
(
shadow_l1e_t
 
¦1e
, 
domaš
 *
d
, 
p2m_ty³_t
 
ty³
)

861 
»s
;

862 
mâ_t
 
mâ
;

863 
domaš
 *
owÃr
;

865 
	`ASSERT
(!
	`sh_l1e_is_magic
(
¦1e
));

867 iàĞ!
	`shadow_mode_»fcouÁs
(
d
) )

870 
»s
 = 
	`g‘_·ge_äom_l1e
(
¦1e
, 
d
, d);

875 iàĞ
	`uÆik–y
(!
»s
) &&

876 !
	`shadow_mode_Œª¦©e
(
d
) &&

877 
	`mâ_v®id
(
mâ
 = 
	`shadow_l1e_g‘_mâ
(
¦1e
)) &&

878 (
owÃr
 = 
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
mâ
))) &&

879 (
d
 !ğ
owÃr
) &&

880 
	`IS_PRIV_FOR
(
d
, 
owÃr
))

882 
»s
 = 
	`g‘_·ge_äom_l1e
(
¦1e
, 
d
, 
owÃr
);

883 
	`SHADOW_PRINTK
("privileged domain %d installs map of mfn %05lx "

885 
d
->
domaš_id
, 
	`mâ_x
(
mâ
), 
owÃr
->domain_id,

886 
»s
 ? "success" : "failed");

890 iàĞ
	`uÆik–y
(!
»s
) &&

891 (
ty³
 =ğ
p2m_g¿Á_m­_rw
 ||

892 (
ty³
 =ğ
p2m_g¿Á_m­_ro
 &&

893 !(
	`shadow_l1e_g‘_æags
(
¦1e
è& 
_PAGE_RW
))) )

898 
mâ
 = 
	`shadow_l1e_g‘_mâ
(
¦1e
);

899 iàĞ
	`mâ_v®id
(
mâ
) )

900 
»s
 = 
	`g‘_·ge_äom_l1e
(
¦1e
, 
d
, 
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
mâ
)));

903 iàĞ
	`uÆik–y
(!
»s
) )

905 
	`³rfc_šü
(
shadow_g‘_·ge_ç
);

906 
	`SHADOW_PRINTK
("çed:†1e=" 
SH_PRI_±e
 "\n");

909  
»s
;

910 
	}
}

912 
šlše


913 
	$shadow_put_·ge_äom_l1e
(
shadow_l1e_t
 
¦1e
, 
domaš
 *
d
)

915 iàĞ!
	`shadow_mode_»fcouÁs
(
d
) )

918 
	`put_·ge_äom_l1e
(
¦1e
, 
d
);

919 
	}
}

921 #ià
GUEST_PAGING_LEVELS
 >= 4

922 
	$shadow_£t_l4e
(
vıu
 *
v
,

923 
shadow_l4e_t
 *
¦4e
,

924 
shadow_l4e_t
 
Ãw_¦4e
,

925 
mâ_t
 
¦4mâ
)

927 
æags
 = 0, 
ok
;

928 
shadow_l4e_t
 
Şd_¦4e
;

929 
·ddr_t
 
·ddr
;

930 
	`ASSERT
(
¦4e
 !ğ
NULL
);

931 
Şd_¦4e
 = *
¦4e
;

933 iàĞ
Şd_¦4e
.
l4
 =ğ
Ãw_¦4e
.l4 )  0;

935 
·ddr
 = ((((
·ddr_t
)
	`mâ_x
(
¦4mâ
)è<< 
PAGE_SHIFT
)

936 | ((()
¦4e
è& ~
PAGE_MASK
));

938 iàĞ
	`shadow_l4e_g‘_æags
(
Ãw_¦4e
è& 
_PAGE_PRESENT
 )

941 
mâ_t
 
¦3mâ
 = 
	`shadow_l4e_g‘_mâ
(
Ãw_¦4e
);

942 
ok
 = 
	`sh_g‘_»f
(
v
, 
¦3mâ
, 
·ddr
);

944 iàĞ
	`sh_ty³_is_pšÇbË
(
v
, 
SH_ty³_l3_64_shadow
) )

945 
ok
 |ğ
	`sh_pš
(
v
, 
¦3mâ
);

946 iàĞ!
ok
 )

948 
	`domaš_üash
(
v
->
domaš
);

949  
SHADOW_SET_ERROR
;

954 
	`shadow_wr™e_’Œ›s
(
¦4e
, &
Ãw_¦4e
, 1, 
¦4mâ
);

955 
æags
 |ğ
SHADOW_SET_CHANGED
;

957 iàĞ
	`shadow_l4e_g‘_æags
(
Şd_¦4e
è& 
_PAGE_PRESENT
 )

960 
mâ_t
 
o¦3mâ
 = 
	`shadow_l4e_g‘_mâ
(
Şd_¦4e
);

961 iàĞ(
	`mâ_x
(
o¦3mâ
è!ğmâ_x(
	`shadow_l4e_g‘_mâ
(
Ãw_¦4e
)))

962 || !
	`³rms_¡riùly_šü—£d
(
	`shadow_l4e_g‘_æags
(
Şd_¦4e
),

963 
	`shadow_l4e_g‘_æags
(
Ãw_¦4e
)) )

965 
æags
 |ğ
SHADOW_SET_FLUSH
;

967 
	`sh_put_»f
(
v
, 
o¦3mâ
, 
·ddr
);

969  
æags
;

970 
	}
}

972 
	$shadow_£t_l3e
(
vıu
 *
v
,

973 
shadow_l3e_t
 *
¦3e
,

974 
shadow_l3e_t
 
Ãw_¦3e
,

975 
mâ_t
 
¦3mâ
)

977 
æags
 = 0;

978 
shadow_l3e_t
 
Şd_¦3e
;

979 
·ddr_t
 
·ddr
;

980 
	`ASSERT
(
¦3e
 !ğ
NULL
);

981 
Şd_¦3e
 = *
¦3e
;

983 iàĞ
Şd_¦3e
.
l3
 =ğ
Ãw_¦3e
.l3 )  0;

985 
·ddr
 = ((((
·ddr_t
)
	`mâ_x
(
¦3mâ
)è<< 
PAGE_SHIFT
)

986 | ((()
¦3e
è& ~
PAGE_MASK
));

988 iàĞ
	`shadow_l3e_g‘_æags
(
Ãw_¦3e
è& 
_PAGE_PRESENT
 )

991 iàĞ!
	`sh_g‘_»f
(
v
, 
	`shadow_l3e_g‘_mâ
(
Ãw_¦3e
), 
·ddr
) )

993 
	`domaš_üash
(
v
->
domaš
);

994  
SHADOW_SET_ERROR
;

999 
	`shadow_wr™e_’Œ›s
(
¦3e
, &
Ãw_¦3e
, 1, 
¦3mâ
);

1000 
æags
 |ğ
SHADOW_SET_CHANGED
;

1002 iàĞ
	`shadow_l3e_g‘_æags
(
Şd_¦3e
è& 
_PAGE_PRESENT
 )

1005 
mâ_t
 
o¦2mâ
 = 
	`shadow_l3e_g‘_mâ
(
Şd_¦3e
);

1006 iàĞ(
	`mâ_x
(
o¦2mâ
è!ğmâ_x(
	`shadow_l3e_g‘_mâ
(
Ãw_¦3e
))) ||

1007 !
	`³rms_¡riùly_šü—£d
(
	`shadow_l3e_g‘_æags
(
Şd_¦3e
),

1008 
	`shadow_l3e_g‘_æags
(
Ãw_¦3e
)) )

1010 
æags
 |ğ
SHADOW_SET_FLUSH
;

1012 
	`sh_put_»f
(
v
, 
o¦2mâ
, 
·ddr
);

1014  
æags
;

1015 
	}
}

1018 
	$shadow_£t_l2e
(
vıu
 *
v
,

1019 
shadow_l2e_t
 *
¦2e
,

1020 
shadow_l2e_t
 
Ãw_¦2e
,

1021 
mâ_t
 
¦2mâ
)

1023 
æags
 = 0;

1024 
shadow_l2e_t
 
Şd_¦2e
;

1025 
·ddr_t
 
·ddr
;

1027 #ià
GUEST_PAGING_LEVELS
 == 2

1033 
shadow_l2e_t
 
·œ
[2] = { 
Ãw_¦2e
,‚ew_sl2e };

1035 
¦2e
 = (
shadow_l2e_t
 *)(()sl2e & ~((shadow_l2e_t)));

1038 
	`ASSERT
(
¦2e
 !ğ
NULL
);

1039 
Şd_¦2e
 = *
¦2e
;

1041 iàĞ
Şd_¦2e
.
l2
 =ğ
Ãw_¦2e
.l2 )  0;

1043 
·ddr
 = ((((
·ddr_t
)
	`mâ_x
(
¦2mâ
)è<< 
PAGE_SHIFT
)

1044 | ((()
¦2e
è& ~
PAGE_MASK
));

1046 iàĞ
	`shadow_l2e_g‘_æags
(
Ãw_¦2e
è& 
_PAGE_PRESENT
 )

1048 
mâ_t
 
¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(
Ãw_¦2e
);

1049 
	`ASSERT
(
	`mâ_to_·ge
(
¦1mâ
)->
u
.
sh
.
h—d
);

1052 iàĞ!
	`sh_g‘_»f
(
v
, 
¦1mâ
, 
·ddr
) )

1054 
	`domaš_üash
(
v
->
domaš
);

1055  
SHADOW_SET_ERROR
;

1057 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

1059 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
¦1mâ
);

1060 
mâ_t
 
gl1mâ
;

1062 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

1063 
gl1mâ
 = 
	`backpoš‹r
(
¥
);

1067 iàĞ(
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_æ1_shadow
è&& 
	`mâ_v®id
(
gl1mâ
)

1068 && 
	`mâ_is_out_of_sync
(
gl1mâ
) )

1069 
	`sh_»sync
(
v
, 
gl1mâ
);

1072 #ià
GUEST_PAGING_LEVELS
 == 2

1074 
¦1mâ
 = 
	`sh_Ãxt_·ge
(sl1mfn);

1075 
·œ
[1] = 
	`shadow_l2e_äom_mâ
(
¦1mâ
, 
	`shadow_l2e_g‘_æags
(
Ãw_¦2e
));

1080 #ià
GUEST_PAGING_LEVELS
 == 2

1081 
	`shadow_wr™e_’Œ›s
(
¦2e
, &
·œ
, 2, 
¦2mâ
);

1083 
	`shadow_wr™e_’Œ›s
(
¦2e
, &
Ãw_¦2e
, 1, 
¦2mâ
);

1085 
æags
 |ğ
SHADOW_SET_CHANGED
;

1087 iàĞ
	`shadow_l2e_g‘_æags
(
Şd_¦2e
è& 
_PAGE_PRESENT
 )

1090 
mâ_t
 
o¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(
Şd_¦2e
);

1091 iàĞ(
	`mâ_x
(
o¦1mâ
è!ğmâ_x(
	`shadow_l2e_g‘_mâ
(
Ãw_¦2e
))) ||

1092 !
	`³rms_¡riùly_šü—£d
(
	`shadow_l2e_g‘_æags
(
Şd_¦2e
),

1093 
	`shadow_l2e_g‘_æags
(
Ãw_¦2e
)) )

1095 
æags
 |ğ
SHADOW_SET_FLUSH
;

1097 
	`sh_put_»f
(
v
, 
o¦1mâ
, 
·ddr
);

1099  
æags
;

1100 
	}
}

1102 
šlše
 
	$shadow_v¿m_g‘_l1e
(
shadow_l1e_t
 
Ãw_¦1e
,

1103 
shadow_l1e_t
 *
¦1e
,

1104 
mâ_t
 
¦1mâ
,

1105 
domaš
 *
d
)

1107 
mâ_t
 
mâ
 = 
	`shadow_l1e_g‘_mâ
(
Ãw_¦1e
);

1108 
æags
 = 
	`shadow_l1e_g‘_æags
(
Ãw_¦1e
);

1109 
gâ
;

1110 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

1112 iàĞ!
dœty_v¿m


1113 || !(
æags
 & 
_PAGE_RW
)

1114 || !
	`mâ_v®id
(
mâ
) )

1117 
gâ
 = 
	`mâ_to_gâ
(
d
, 
mâ
);

1119 
	`BUG_ON
(
	`SHARED_M2P
(
gâ
));

1121 iàĞ(
gâ
 >ğ
dœty_v¿m
->
begš_pâ
è&& (gâ < dœty_v¿m->
’d_pâ
) )

1123 
i
 = 
gâ
 - 
dœty_v¿m
->
begš_pâ
;

1124 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
mâ
);

1126 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 1 )

1128 
dœty_v¿m
->
¦1ma
[
i
] = 
	`pâ_to_·ddr
(
	`mâ_x
(
¦1mâ
))

1129 | (()
¦1e
 & ~
PAGE_MASK
);

1131 
	}
}

1133 
šlše
 
	$shadow_v¿m_put_l1e
(
shadow_l1e_t
 
Şd_¦1e
,

1134 
shadow_l1e_t
 *
¦1e
,

1135 
mâ_t
 
¦1mâ
,

1136 
domaš
 *
d
)

1138 
mâ_t
 
mâ
 = 
	`shadow_l1e_g‘_mâ
(
Şd_¦1e
);

1139 
æags
 = 
	`shadow_l1e_g‘_æags
(
Şd_¦1e
);

1140 
gâ
;

1141 
sh_dœty_v¿m
 *
dœty_v¿m
 = 
d
->
¬ch
.
hvm_domaš
.dirty_vram;

1143 iàĞ!
dœty_v¿m


1144 || !(
æags
 & 
_PAGE_RW
)

1145 || !
	`mâ_v®id
(
mâ
) )

1148 
gâ
 = 
	`mâ_to_gâ
(
d
, 
mâ
);

1150 
	`BUG_ON
(
	`SHARED_M2P
(
gâ
));

1152 iàĞ(
gâ
 >ğ
dœty_v¿m
->
begš_pâ
è&& (gâ < dœty_v¿m->
’d_pâ
) )

1154 
i
 = 
gâ
 - 
dœty_v¿m
->
begš_pâ
;

1155 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
mâ
);

1156 
dœty
 = 0;

1157 
·ddr_t
 
¦1ma
 = 
	`pâ_to_·ddr
(
	`mâ_x
(
¦1mâ
))

1158 | (()
¦1e
 & ~
PAGE_MASK
);

1160 iàĞ(
·ge
->
u
.
šu£
.
ty³_šfo
 & 
PGT_couÁ_mask
) == 1 )

1163 iàĞ
dœty_v¿m
->
¦1ma
[
i
] =ğ
INVALID_PADDR
 ) {

1165 
dœty
 = 1;

1169 
	`ASSERT
(
dœty_v¿m
->
¦1ma
[
i
] == sl1ma);

1170 
dœty_v¿m
->
¦1ma
[
i
] = 
INVALID_PADDR
;

1171 iàĞ
æags
 & 
_PAGE_DIRTY
 )

1172 
dœty
 = 1;

1178 
dœty
 = 1;

1180 iàĞ
dœty_v¿m
->
¦1ma
[
i
] == sl1ma )

1183 
dœty_v¿m
->
¦1ma
[
i
] = 
INVALID_PADDR
;

1191 iàĞ
dœty
 )

1193 
dœty_v¿m
->
dœty_b™m­
[
i
 / 8] |= 1 << (i % 8);

1194 
dœty_v¿m
->
Ï¡_dœty
 = 
	`NOW
();

1197 
	}
}

1199 
	$shadow_£t_l1e
(
vıu
 *
v
,

1200 
shadow_l1e_t
 *
¦1e
,

1201 
shadow_l1e_t
 
Ãw_¦1e
,

1202 
p2m_ty³_t
 
Ãw_ty³
,

1203 
mâ_t
 
¦1mâ
)

1205 
æags
 = 0;

1206 
domaš
 *
d
 = 
v
->domain;

1207 
shadow_l1e_t
 
Şd_¦1e
;

1208 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC


1209 
mâ_t
 
Ãw_gmâ
 = 
	`shadow_l1e_g‘_mâ
(
Ãw_¦1e
);

1211 
	`ASSERT
(
¦1e
 !ğ
NULL
);

1213 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC


1214 iàĞ
	`mâ_v®id
(
Ãw_gmâ
è&& 
	`mâ_oos_may_wr™e
(new_gmfn)

1215 && ((
	`shadow_l1e_g‘_æags
(
Ãw_¦1e
è& (
_PAGE_RW
|
_PAGE_PRESENT
))

1216 =ğ(
_PAGE_RW
|
_PAGE_PRESENT
)) )

1217 
	`oos_fixup_add
(
v
, 
Ãw_gmâ
, 
¦1mâ
, 
	`pg’Œy_±r_to_¦Ù
(
¦1e
));

1220 
Şd_¦1e
 = *
¦1e
;

1222 iàĞ
Şd_¦1e
.
l1
 =ğ
Ãw_¦1e
.l1 )  0;

1224 iàĞ(
	`shadow_l1e_g‘_æags
(
Ãw_¦1e
è& 
_PAGE_PRESENT
)

1225 && !
	`sh_l1e_is_magic
(
Ãw_¦1e
) )

1228 iàĞ
	`shadow_mode_»fcouÁs
(
d
) ) {

1229 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_SHADOW_L1_GET_REF
);

1230  
	`shadow_g‘_·ge_äom_l1e
(
Ãw_¦1e
, 
d
, 
Ãw_ty³
) )

1234 
æags
 |ğ
SHADOW_SET_ERROR
;

1235 
Ãw_¦1e
 = 
	`shadow_l1e_em±y
();

1238 
	`shadow_l1e_»move_æags
(
Ãw_¦1e
, 
_PAGE_RW
);

1241 
	`shadow_v¿m_g‘_l1e
(
Ãw_¦1e
, 
¦1e
, 
¦1mâ
, 
d
);

1248 
	`shadow_wr™e_’Œ›s
(
¦1e
, &
Ãw_¦1e
, 1, 
¦1mâ
);

1249 
æags
 |ğ
SHADOW_SET_CHANGED
;

1251 iàĞ(
	`shadow_l1e_g‘_æags
(
Şd_¦1e
è& 
_PAGE_PRESENT
)

1252 && !
	`sh_l1e_is_magic
(
Şd_¦1e
) )

1259 iàĞ
	`shadow_mode_»fcouÁs
(
d
) )

1261 
	`shadow_v¿m_put_l1e
(
Şd_¦1e
, 
¦1e
, 
¦1mâ
, 
d
);

1262 
	`shadow_put_·ge_äom_l1e
(
Şd_¦1e
, 
d
);

1263 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_SHADOW_L1_PUT_REF
);

1266  
æags
;

1267 
	}
}

1285 
šlše
 
	$šüem’t_±r_to_gue¡_’Œy
(*
±r
)

1287 iàĞ
±r
 )

1289 
gue¡_l1e_t
 **
’Œy
 = 
±r
;

1290 (*
’Œy
)++;

1292 
	}
}

1295 
	#_SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, 
_dÚe
, 
_code
) \

1297 
_i
; \

1298 
shadow_l1e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
((
_¦1mâ
)); \

1299 
	`ASSERT
(
	`mâ_to_·ge
(
_¦1mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l1_shadow
 \

1300 || 
	`mâ_to_·ge
(
_¦1mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_æ1_shadow
);\

1301  
_i
 = 0; _˜< 
SHADOW_L1_PAGETABLE_ENTRIES
; _i++ ) \

1303 (
_¦1e
èğ
_¥
 + 
_i
; \

1304 iàĞ
	`shadow_l1e_g‘_æags
(*(
_¦1e
)è& 
_PAGE_PRESENT
 ) \

1305 {
_code
} \

1306 iàĞ
_dÚe
 ) ; \

1307 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl1p
); \

1309 
	`sh_unm­_domaš_·ge
(
_¥
); \

1310 } 0)

	)

1313 #ià
GUEST_PAGING_LEVELS
 =ğ2 && 
SHADOW_PAGING_LEVELS
 > 2

1314 
	#SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, 
_dÚe
, 
_code
) \

1316 
__dÚe
 = 0; \

1317 
	`_SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, \

1318 ({ (
__dÚe
 = 
_dÚe
); }), 
_code
); \

1319 
_¦1mâ
 = 
	`sh_Ãxt_·ge
(_sl1mfn); \

1320 iàĞ!
__dÚe
 ) \

1321 
	`_SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, \

1322 ({ (
__dÚe
 = 
_dÚe
); }), 
_code
); \

1323 } 0)

	)

1325 
	#SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, 
_dÚe
, 
_code
) \

1326 
	`_SHADOW_FOREACH_L1E
(
_¦1mâ
, 
_¦1e
, 
_gl1p
, 
_dÚe
, 
_code
)

	)

1330 #ià
GUEST_PAGING_LEVELS
 == 2

1333 
	#SHADOW_FOREACH_L2E
(
_¦2mâ
, 
_¦2e
, 
_gl2p
, 
_dÚe
, 
_dom
, 
_code
) \

1335 
_i
, 
_j
, 
__dÚe
 = 0; \

1336 
_x’
 = !
	`shadow_mode_ex‹º®
(
_dom
); \

1337 
	`ASSERT
(
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);\

1338  
_j
 = 0; _j < 4 && !
__dÚe
; _j++ ) \

1340 
shadow_l2e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
(
_¦2mâ
); \

1341  
_i
 = 0; _˜< 
SHADOW_L2_PAGETABLE_ENTRIES
; _i += 2 ) \

1342 iàĞ(!(
_x’
)) \

1343 || ((
_j
 * 
SHADOW_L2_PAGETABLE_ENTRIES
è+ 
_i
) \

1344 < (
HYPERVISOR_VIRT_START
 >> 
SHADOW_L2_PAGETABLE_SHIFT
) ) \

1346 (
_¦2e
èğ
_¥
 + 
_i
; \

1347 iàĞ
	`shadow_l2e_g‘_æags
(*(
_¦2e
)è& 
_PAGE_PRESENT
 ) \

1348 {
_code
} \

1349 iàĞ(
__dÚe
 = (
_dÚe
)) ) ; \

1350 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl2p
); \

1352 
	`sh_unm­_domaš_·ge
(
_¥
); \

1353 iàĞ
_j
 < 3 ) 
_¦2mâ
 = 
	`sh_Ãxt_·ge
(_sl2mfn); \

1355 } 0)

	)

1357 #–ià
GUEST_PAGING_LEVELS
 == 3

1360 
	#SHADOW_FOREACH_L2E
(
_¦2mâ
, 
_¦2e
, 
_gl2p
, 
_dÚe
, 
_dom
, 
_code
) \

1362 
_i
; \

1363 
_x’
 = !
	`shadow_mode_ex‹º®
(
_dom
); \

1364 
shadow_l2e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
((
_¦2mâ
)); \

1365 
	`ASSERT
(
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_·e_shadow
 \

1366 || 
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2h_·e_shadow
);\

1367  
_i
 = 0; _˜< 
SHADOW_L2_PAGETABLE_ENTRIES
; _i++ ) \

1368 iàĞ(!(
_x’
)) \

1369 || 
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 !ğ
SH_ty³_l2h_·e_shadow
\

1370 || ((
_i
 + (3 * 
SHADOW_L2_PAGETABLE_ENTRIES
)) \

1371 < (
HYPERVISOR_VIRT_START
 >> 
SHADOW_L2_PAGETABLE_SHIFT
)) ) \

1373 (
_¦2e
èğ
_¥
 + 
_i
; \

1374 iàĞ
	`shadow_l2e_g‘_æags
(*(
_¦2e
)è& 
_PAGE_PRESENT
 ) \

1375 {
_code
} \

1376 iàĞ
_dÚe
 ) ; \

1377 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl2p
); \

1379 
	`sh_unm­_domaš_·ge
(
_¥
); \

1380 } 0)

	)

1385 
	#SHADOW_FOREACH_L2E
(
_¦2mâ
, 
_¦2e
, 
_gl2p
, 
_dÚe
, 
_dom
, 
_code
) \

1387 
_i
; \

1388 
_x’
 = !
	`shadow_mode_ex‹º®
(
_dom
); \

1389 
shadow_l2e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
((
_¦2mâ
)); \

1390 
	`ASSERT
(
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_64_shadow
 ||\

1391 
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2h_64_shadow
);\

1392  
_i
 = 0; _˜< 
SHADOW_L2_PAGETABLE_ENTRIES
; _i++ ) \

1394 iàĞ(!(
_x’
)) \

1395 || !
	`is_pv_32Ú64_domaš
(
_dom
) \

1396 || 
	`mâ_to_·ge
(
_¦2mâ
)->
u
.
sh
.
ty³
 !ğ
SH_ty³_l2h_64_shadow
\

1397 || (
_i
 < 
	`COMPAT_L2_PAGETABLE_FIRST_XEN_SLOT
(
_dom
)) ) \

1399 (
_¦2e
èğ
_¥
 + 
_i
; \

1400 iàĞ
	`shadow_l2e_g‘_æags
(*(
_¦2e
)è& 
_PAGE_PRESENT
 ) \

1401 {
_code
} \

1402 iàĞ
_dÚe
 ) ; \

1403 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl2p
); \

1406 
	`sh_unm­_domaš_·ge
(
_¥
); \

1407 } 0)

	)

1411 #ià
GUEST_PAGING_LEVELS
 == 4

1414 
	#SHADOW_FOREACH_L3E
(
_¦3mâ
, 
_¦3e
, 
_gl3p
, 
_dÚe
, 
_code
) \

1416 
_i
; \

1417 
shadow_l3e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
((
_¦3mâ
)); \

1418 
	`ASSERT
(
	`mâ_to_·ge
(
_¦3mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l3_64_shadow
);\

1419  
_i
 = 0; _˜< 
SHADOW_L3_PAGETABLE_ENTRIES
; _i++ ) \

1421 (
_¦3e
èğ
_¥
 + 
_i
; \

1422 iàĞ
	`shadow_l3e_g‘_æags
(*(
_¦3e
)è& 
_PAGE_PRESENT
 ) \

1423 {
_code
} \

1424 iàĞ
_dÚe
 ) ; \

1425 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl3p
); \

1427 
	`sh_unm­_domaš_·ge
(
_¥
); \

1428 } 0)

	)

1431 
	#SHADOW_FOREACH_L4E
(
_¦4mâ
, 
_¦4e
, 
_gl4p
, 
_dÚe
, 
_dom
, 
_code
) \

1433 
shadow_l4e_t
 *
_¥
 = 
	`sh_m­_domaš_·ge
((
_¦4mâ
)); \

1434 
_x’
 = !
	`shadow_mode_ex‹º®
(
_dom
); \

1435 
_i
; \

1436 
	`ASSERT
(
	`mâ_to_·ge
(
_¦4mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l4_64_shadow
);\

1437  
_i
 = 0; _˜< 
SHADOW_L4_PAGETABLE_ENTRIES
; _i++ ) \

1439 iàĞ(!(
_x’
)è|| 
	`is_gue¡_l4_¦Ù
(
_dom
, 
_i
) ) \

1441 (
_¦4e
èğ
_¥
 + 
_i
; \

1442 iàĞ
	`shadow_l4e_g‘_æags
(*(
_¦4e
)è& 
_PAGE_PRESENT
 ) \

1443 {
_code
} \

1444 iàĞ
_dÚe
 ) ; \

1446 
	`šüem’t_±r_to_gue¡_’Œy
(
_gl4p
); \

1448 
	`sh_unm­_domaš_·ge
(
_¥
); \

1449 } 0)

	)

1462 #ià
CONFIG_PAGING_LEVELS
 =ğ4 && 
GUEST_PAGING_LEVELS
 == 4

1463 
	$sh_š¡®l_x’_’Œ›s_š_l4
(
vıu
 *
v
, 
mâ_t
 
gl4mâ
, mâ_ˆ
¦4mâ
)

1465 
domaš
 *
d
 = 
v
->domain;

1466 
shadow_l4e_t
 *
¦4e
;

1468 
¦4e
 = 
	`sh_m­_domaš_·ge
(
¦4mâ
);

1469 
	`ASSERT
(
¦4e
 !ğ
NULL
);

1470 
	`ASSERT
( (
l4_pg’Œy_t
è=ğ (
shadow_l4e_t
));

1473 
	`memıy
(&
¦4e
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

1474 &
idË_pg_bË
[
ROOT_PAGETABLE_FIRST_XEN_SLOT
],

1475 
ROOT_PAGETABLE_XEN_SLOTS
 * (
l4_pg’Œy_t
));

1478 
¦4e
[
	`shadow_l4_bË_off£t
(
PERDOMAIN_VIRT_START
)] =

1479 
	`shadow_l4e_äom_mâ
(
	`·ge_to_mâ
(
	`vœt_to_·ge
(
d
->
¬ch
.
mm_³rdomaš_l3
)),

1480 
__PAGE_HYPERVISOR
);

1486 
¦4e
[
	`shadow_l4_bË_off£t
(
SH_LINEAR_PT_VIRT_START
)] =

1487 
	`shadow_l4e_äom_mâ
(
¦4mâ
, 
__PAGE_HYPERVISOR
);

1490 iàĞ
	`shadow_mode_Œª¦©e
(
v
->
domaš
è&& !
	`shadow_mode_ex‹º®
(v->domain) )

1493 
¦4e
[
	`shadow_l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

1494 
	`shadow_l4e_em±y
();

1498 
¦4e
[
	`shadow_l4_bË_off£t
(
LINEAR_PT_VIRT_START
)] =

1499 
	`shadow_l4e_äom_mâ
(
gl4mâ
, 
__PAGE_HYPERVISOR
);

1502 iàĞ
	`shadow_mode_Œª¦©e
(
v
->
domaš
) )

1505 
¦4e
[
	`shadow_l4_bË_off£t
(
RO_MPT_VIRT_START
)] =

1506 
	`shadow_l4e_äom_mâ
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
d
))),

1507 
__PAGE_HYPERVISOR
);

1510 
	`sh_unm­_domaš_·ge
(
¦4e
);

1511 
	}
}

1514 #ià
CONFIG_PAGING_LEVELS
 >ğ3 && 
GUEST_PAGING_LEVELS
 >= 3

1519 
	$sh_š¡®l_x’_’Œ›s_š_l2h
(
vıu
 *
v
, 
mâ_t
 
¦2hmâ
)

1521 
domaš
 *
d
 = 
v
->domain;

1522 
shadow_l2e_t
 *
¦2e
;

1523 #ià
CONFIG_PAGING_LEVELS
 == 3

1524 
i
;

1527 iàĞ!
	`is_pv_32Ú64_vıu
(
v
) )

1531 
¦2e
 = 
	`sh_m­_domaš_·ge
(
¦2hmâ
);

1532 
	`ASSERT
(
¦2e
 !ğ
NULL
);

1533 
	`ASSERT
( (
l2_pg’Œy_t
è=ğ (
shadow_l2e_t
));

1535 #ià
CONFIG_PAGING_LEVELS
 == 3

1538 
	`memıy
(&
¦2e
[
L2_PAGETABLE_FIRST_XEN_SLOT
 & (
L2_PAGETABLE_ENTRIES
-1)],

1539 &
idË_pg_bË_l2
[
L2_PAGETABLE_FIRST_XEN_SLOT
],

1540 
L2_PAGETABLE_XEN_SLOTS
 * (
l2_pg’Œy_t
));

1543  
i
 = 0; i < 
PDPT_L2_ENTRIES
; i++ )

1544 
¦2e
[
	`shadow_l2_bË_off£t
(
PERDOMAIN_VIRT_START
è+ 
i
] =

1545 
	`shadow_l2e_äom_mâ
(

1546 
	`·ge_to_mâ
(
	`³rdomaš_±_·ge
(
d
, 
i
)),

1547 
__PAGE_HYPERVISOR
);

1554  
i
 = 0; i < 
SHADOW_L3_PAGETABLE_ENTRIES
; i++ )

1555 
¦2e
[
	`shadow_l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
] =

1556 
	`shadow_l2e_em±y
();

1557  
i
 = 0; i < 
SHADOW_L3_PAGETABLE_ENTRIES
; i++ )

1558 
¦2e
[
	`shadow_l2_bË_off£t
(
SH_LINEAR_PT_VIRT_START
è+ 
i
] =

1559 
	`shadow_l2e_em±y
();

1561 iàĞ
	`shadow_mode_Œª¦©e
(
d
) )

1564 
l3_pg’Œy_t
 *
p2m
;

1565 
	`ASSERT
(
	`·g‘abË_g‘_pâ
(
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
d
))) != 0);

1566 
p2m
 = 
	`sh_m­_domaš_·ge
(
	`·g‘abË_g‘_mâ
(
	`p2m_g‘_·g‘abË
(
	`p2m_g‘_ho¡p2m
(
d
))));

1567  
i
 = 0; i < 
MACHPHYS_MBYTES
>>1; i++ )

1569 
¦2e
[
	`shadow_l2_bË_off£t
(
RO_MPT_VIRT_START
è+ 
i
] =

1570 (
	`l3e_g‘_æags
(
p2m
[
i
]è& 
_PAGE_PRESENT
)

1571 ? 
	`shadow_l2e_äom_mâ
(
	`_mâ
(
	`l3e_g‘_pâ
(
p2m
[
i
])),

1572 
__PAGE_HYPERVISOR
)

1573 : 
	`shadow_l2e_em±y
();

1575 
	`sh_unm­_domaš_·ge
(
p2m
);

1581 
	`memıy
(

1582 &
¦2e
[
	`COMPAT_L2_PAGETABLE_FIRST_XEN_SLOT
(
d
)],

1583 &
com·t_idË_pg_bË_l2
[
	`l2_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)],

1584 
	`COMPAT_L2_PAGETABLE_XEN_SLOTS
(
d
è* (*
¦2e
));

1588 
	`sh_unm­_domaš_·ge
(
¦2e
);

1589 
	}
}

1599 
mâ_t


1600 
	$sh_make_shadow
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
shadow_ty³
)

1602 
mâ_t
 
smâ
 = 
	`shadow_®loc
(
v
->
domaš
, 
shadow_ty³
, 
	`mâ_x
(
gmâ
));

1603 
	`SHADOW_DEBUG
(
MAKE_SHADOW
, "(%05lx, %u)=>%05lx\n",

1604 
	`mâ_x
(
gmâ
), 
shadow_ty³
, mâ_x(
smâ
));

1606 iàĞ
	`sh_ty³_has_up_poš‹r
(
v
, 
shadow_ty³
) )

1608 
	`mâ_to_·ge
(
smâ
)->
up
 = 0;

1610 #ià
GUEST_PAGING_LEVELS
 == 4

1611 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_LINUX_L3_TOPLEVEL
)

1612 iàĞ
shadow_ty³
 =ğ
SH_ty³_l4_64_shadow
 &&

1613 
	`uÆik–y
(
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
İt_æags
 & 
SHOPT_LINUX_L3_TOPLEVEL
) )

1621 
·ge_šfo
 *
¥
, *
t
;

1622 
vıu
 *
v2
;

1623 
l4couÁ
 = 0, 
vıus
 = 0;

1624 
	`·ge_li¡_fÜ_—ch
(
¥
, &
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
)

1626 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l4_64_shadow
 )

1627 
l4couÁ
++;

1629 
	`fÜ_—ch_vıu
 ( 
v
->
domaš
, 
v2
 )

1630 
vıus
++;

1631 iàĞ
l4couÁ
 > 2 * 
vıus
 )

1634 
	`·ge_li¡_fÜ_—ch_§ã
(
¥
, 
t
, &
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
)

1636 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l3_64_shadow
 )

1637 
	`sh_uÅš
(
v
, 
	`·ge_to_mâ
(
¥
));

1639 
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
İt_æags
 &ğ~
SHOPT_LINUX_L3_TOPLEVEL
;

1640 
	`sh_»£t_l3_up_poš‹rs
(
v
);

1647 iàĞ!
	`shadow_mode_ex‹º®
(
v
->
domaš
) )

1649 
shadow_ty³
)

1651 #ià
CONFIG_PAGING_LEVELS
 =ğ4 && 
GUEST_PAGING_LEVELS
 == 4

1652 
SH_ty³_l4_shadow
:

1653 
	`sh_š¡®l_x’_’Œ›s_š_l4
(
v
, 
gmâ
, 
smâ
); ;

1655 #ià
CONFIG_PAGING_LEVELS
 >ğ3 && 
GUEST_PAGING_LEVELS
 >= 3

1656 
SH_ty³_l2h_shadow
:

1657 
	`sh_š¡®l_x’_’Œ›s_š_l2h
(
v
, 
smâ
); ;

1663 
	`shadow_´omÙe
(
v
, 
gmâ
, 
shadow_ty³
);

1664 
	`£t_shadow_¡©us
(
v
, 
gmâ
, 
shadow_ty³
, 
smâ
);

1666  
smâ
;

1667 
	}
}

1670 
mâ_t


1671 
	$make_æ1_shadow
(
vıu
 *
v
, 
gâ_t
 
gâ
)

1673 
mâ_t
 
smâ
 = 
	`shadow_®loc
(
v
->
domaš
, 
SH_ty³_æ1_shadow
,

1674 (è
	`gâ_x
(
gâ
));

1676 
	`SHADOW_DEBUG
(
MAKE_SHADOW
, "(%" 
SH_PRI_gâ
 ")=>%" 
PRI_mâ
 "\n",

1677 
	`gâ_x
(
gâ
), 
	`mâ_x
(
smâ
));

1679 
	`£t_æ1_shadow_¡©us
(
v
, 
gâ
, 
smâ
);

1680  
smâ
;

1681 
	}
}

1684 #ià
SHADOW_PAGING_LEVELS
 =ğ
GUEST_PAGING_LEVELS


1685 
mâ_t


1686 
	$sh_make_mÚ™Ü_bË
(
vıu
 *
v
)

1688 
domaš
 *
d
 = 
v
->domain;

1690 
	`ASSERT
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
mÚ™Ü_bË
) == 0);

1693 
	`shadow_´—Îoc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 
CONFIG_PAGING_LEVELS
);

1695 #ià
CONFIG_PAGING_LEVELS
 == 4

1697 
mâ_t
 
m4mâ
;

1698 
m4mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1699 
	`sh_š¡®l_x’_’Œ›s_š_l4
(
v
, 
m4mâ
, m4mfn);

1701 
	`mâ_to_·ge
(
m4mâ
)->
shadow_æags
 = 4;

1702 #ià
SHADOW_PAGING_LEVELS
 < 4

1704 
mâ_t
 
m3mâ
, 
m2mâ
;

1705 
l4_pg’Œy_t
 *
l4e
;

1706 
l3_pg’Œy_t
 *
l3e
;

1710 
l4e
 = 
	`sh_m­_domaš_·ge
(
m4mâ
);

1712 
m3mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1713 
	`mâ_to_·ge
(
m3mâ
)->
shadow_æags
 = 3;

1714 
l4e
[
	`shadow_l4_bË_off£t
(
SH_LINEAR_PT_VIRT_START
)]

1715 ğ
	`l4e_äom_pâ
(
	`mâ_x
(
m3mâ
), 
__PAGE_HYPERVISOR
);

1717 
m2mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1718 
	`mâ_to_·ge
(
m2mâ
)->
shadow_æags
 = 2;

1719 
l3e
 = 
	`sh_m­_domaš_·ge
(
m3mâ
);

1720 
l3e
[0] = 
	`l3e_äom_pâ
(
	`mâ_x
(
m2mâ
), 
__PAGE_HYPERVISOR
);

1721 
	`sh_unm­_domaš_·ge
(
l3e
);

1723 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

1727 
m3mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1728 
	`mâ_to_·ge
(
m3mâ
)->
shadow_æags
 = 3;

1729 
l4e
[0] = 
	`l4e_äom_pâ
(
	`mâ_x
(
m3mâ
), 
__PAGE_HYPERVISOR
);

1731 
m2mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1732 
	`mâ_to_·ge
(
m2mâ
)->
shadow_æags
 = 2;

1733 
l3e
 = 
	`sh_m­_domaš_·ge
(
m3mâ
);

1734 
l3e
[3] = 
	`l3e_äom_pâ
(
	`mâ_x
(
m2mâ
), 
_PAGE_PRESENT
);

1735 
	`sh_š¡®l_x’_’Œ›s_š_l2h
(
v
, 
m2mâ
);

1736 
	`sh_unm­_domaš_·ge
(
l3e
);

1739 
	`sh_unm­_domaš_·ge
(
l4e
);

1742  
m4mâ
;

1745 #–ià
CONFIG_PAGING_LEVELS
 == 3

1748 
mâ_t
 
m3mâ
, 
m2mâ
;

1749 
l3_pg’Œy_t
 *
l3e
;

1750 
l2_pg’Œy_t
 *
l2e
;

1751 
i
;

1753 
m3mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1755 
	`mâ_to_·ge
(
m3mâ
)->
shadow_æags
 = 3;

1759 
m2mâ
 = 
	`shadow_®loc
(
d
, 
SH_ty³_mÚ™Ü_bË
, 0);

1760 
	`mâ_to_·ge
(
m2mâ
)->
shadow_æags
 = 2;

1761 
l3e
 = 
	`sh_m­_domaš_·ge
(
m3mâ
);

1762 
l3e
[3] = 
	`l3e_äom_pâ
(
	`mâ_x
(
m2mâ
), 
_PAGE_PRESENT
);

1763 
	`sh_š¡®l_x’_’Œ›s_š_l2h
(
v
, 
m2mâ
);

1765 
l2e
 = 
	`sh_m­_domaš_·ge
(
m2mâ
);

1766  
i
 = 0; i < 
L3_PAGETABLE_ENTRIES
; i++ )

1767 
l2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
] =

1768 (
	`l3e_g‘_æags
(
l3e
[
i
]è& 
_PAGE_PRESENT
)

1769 ? 
	`l2e_äom_pâ
(
	`l3e_g‘_pâ
(
l3e
[
i
]), 
__PAGE_HYPERVISOR
)

1770 : 
	`l2e_em±y
();

1771 
	`sh_unm­_domaš_·ge
(
l2e
);

1772 
	`sh_unm­_domaš_·ge
(
l3e
);

1774 
	`SHADOW_PRINTK
("Ãw mÚ™ÜabË: %#lx\n", 
	`mâ_x
(
m3mâ
));

1775  
m3mâ
;

1779 #”rÜ 
this
 
should
 
nÙ
 
h­³n


1781 
	}
}

1796 #ià
GUEST_PAGING_LEVELS
 >= 4

1797 
shadow_l4e_t
 * 
	$shadow_g‘_ªd_ü—‹_l4e
(
vıu
 *
v
,

1798 
w®k_t
 *
gw
,

1799 
mâ_t
 *
¦4mâ
)

1802 *
¦4mâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[0]);

1804  
	`sh_lš—r_l4_bË
(
v
è+ 
	`shadow_l4_lš—r_off£t
(
gw
->
va
);

1805 
	}
}

1807 
shadow_l3e_t
 * 
	$shadow_g‘_ªd_ü—‹_l3e
(
vıu
 *
v
,

1808 
w®k_t
 *
gw
,

1809 
mâ_t
 *
¦3mâ
,

1810 
ãtch_ty³_t
 
á
,

1811 *
»sync
)

1813 
mâ_t
 
¦4mâ
;

1814 
shadow_l4e_t
 *
¦4e
;

1815 iàĞ!
	`mâ_v®id
(
gw
->
l3mâ
èè 
NULL
;

1817 
¦4e
 = 
	`shadow_g‘_ªd_ü—‹_l4e
(
v
, 
gw
, &
¦4mâ
);

1818 
	`ASSERT
(
¦4e
 !ğ
NULL
);

1819 iàĞ
	`shadow_l4e_g‘_æags
(*
¦4e
è& 
_PAGE_PRESENT
 )

1821 *
¦3mâ
 = 
	`shadow_l4e_g‘_mâ
(*
¦4e
);

1822 
	`ASSERT
(
	`mâ_v®id
(*
¦3mâ
));

1826 
r
;

1827 
shadow_l4e_t
 
Ãw_¦4e
;

1829 *
¦3mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l3mâ
, 
SH_ty³_l3_shadow
);

1830 iàĞ!
	`mâ_v®id
(*
¦3mâ
) )

1833 *
¦3mâ
 = 
	`sh_make_shadow
(
v
, 
gw
->
l3mâ
, 
SH_ty³_l3_shadow
);

1836 
	`l4e_´İag©e_äom_gue¡
(
v
, 
gw
->
l4e
, *
¦3mâ
, &
Ãw_¦4e
, 
á
);

1837 
r
 = 
	`shadow_£t_l4e
(
v
, 
¦4e
, 
Ãw_¦4e
, 
¦4mâ
);

1838 
	`ASSERT
((
r
 & 
SHADOW_SET_FLUSH
) == 0);

1839 iàĞ
r
 & 
SHADOW_SET_ERROR
 )

1840  
NULL
;

1842 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

1843 *
»sync
 |= 1;

1848  
	`sh_lš—r_l3_bË
(
v
è+ 
	`shadow_l3_lš—r_off£t
(
gw
->
va
);

1849 
	}
}

1853 
shadow_l2e_t
 * 
	$shadow_g‘_ªd_ü—‹_l2e
(
vıu
 *
v
,

1854 
w®k_t
 *
gw
,

1855 
mâ_t
 *
¦2mâ
,

1856 
ãtch_ty³_t
 
á
,

1857 *
»sync
)

1859 #ià
GUEST_PAGING_LEVELS
 >= 4

1860 
mâ_t
 
¦3mâ
 = 
	`_mâ
(
INVALID_MFN
);

1861 
shadow_l3e_t
 *
¦3e
;

1862 iàĞ!
	`mâ_v®id
(
gw
->
l2mâ
èè 
NULL
;

1864 
¦3e
 = 
	`shadow_g‘_ªd_ü—‹_l3e
(
v
, 
gw
, &
¦3mâ
, 
á
, 
»sync
);

1865 iàĞ
¦3e
 =ğ
NULL
 )  NULL;

1866 iàĞ
	`shadow_l3e_g‘_æags
(*
¦3e
è& 
_PAGE_PRESENT
 )

1868 *
¦2mâ
 = 
	`shadow_l3e_g‘_mâ
(*
¦3e
);

1869 
	`ASSERT
(
	`mâ_v®id
(*
¦2mâ
));

1873 
r
;

1874 
shadow_l3e_t
 
Ãw_¦3e
;

1875 
t
 = 
SH_ty³_l2_shadow
;

1878 iàĞ
	`is_pv_32Ú64_domaš
(
v
->
domaš
) &&

1879 
	`gue¡_l4_bË_off£t
(
gw
->
va
) == 0 &&

1880 
	`gue¡_l3_bË_off£t
(
gw
->
va
) == 3 )

1881 
t
 = 
SH_ty³_l2h_shadow
;

1884 *
¦2mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l2mâ
, 
t
);

1885 iàĞ!
	`mâ_v®id
(*
¦2mâ
) )

1888 *
¦2mâ
 = 
	`sh_make_shadow
(
v
, 
gw
->
l2mâ
, 
t
);

1891 
	`l3e_´İag©e_äom_gue¡
(
v
, 
gw
->
l3e
, *
¦2mâ
, &
Ãw_¦3e
, 
á
);

1892 
r
 = 
	`shadow_£t_l3e
(
v
, 
¦3e
, 
Ãw_¦3e
, 
¦3mâ
);

1893 
	`ASSERT
((
r
 & 
SHADOW_SET_FLUSH
) == 0);

1894 iàĞ
r
 & 
SHADOW_SET_ERROR
 )

1895  
NULL
;

1897 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

1898 *
»sync
 |= 1;

1903  
	`sh_lš—r_l2_bË
(
v
è+ 
	`shadow_l2_lš—r_off£t
(
gw
->
va
);

1904 #–ià
GUEST_PAGING_LEVELS
 == 3

1907 
shadow_l3e_t
 *
¦3e
 = ((shadow_l3e_ˆ*)&
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
)

1908 + 
	`shadow_l3_lš—r_off£t
(
gw
->
va
);

1909 iàĞ!(
	`shadow_l3e_g‘_æags
(*
¦3e
è& 
_PAGE_PRESENT
) )

1910  
NULL
;

1911 *
¦2mâ
 = 
	`shadow_l3e_g‘_mâ
(*
¦3e
);

1912 
	`ASSERT
(
	`mâ_v®id
(*
¦2mâ
));

1913  
	`sh_lš—r_l2_bË
(
v
è+ 
	`shadow_l2_lš—r_off£t
(
gw
->
va
);

1916 *
¦2mâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[0]);

1920 (è
	`shadow_l2_šdex
(
¦2mâ
, 
	`gue¡_l2_bË_off£t
(
gw
->
va
));

1922  
	`sh_lš—r_l2_bË
(
v
è+ 
	`shadow_l2_lš—r_off£t
(
gw
->
va
);

1924 
	}
}

1927 
shadow_l1e_t
 * 
	$shadow_g‘_ªd_ü—‹_l1e
(
vıu
 *
v
,

1928 
w®k_t
 *
gw
,

1929 
mâ_t
 *
¦1mâ
,

1930 
ãtch_ty³_t
 
á
)

1932 
mâ_t
 
¦2mâ
;

1933 
»sync
 = 0;

1934 
shadow_l2e_t
 *
¦2e
;

1937 
¦2e
 = 
	`shadow_g‘_ªd_ü—‹_l2e
(
v
, 
gw
, &
¦2mâ
, 
á
, &
»sync
);

1938 iàĞ
¦2e
 =ğ
NULL
 )  NULL;

1942 iàĞ
	`shadow_l2e_g‘_æags
(*
¦2e
è& 
_PAGE_PRESENT


1943 && 
	`lik–y
(
á
 !ğ
á_demªd_wr™e


1944 || (
	`shadow_l2e_g‘_æags
(*
¦2e
è& 
_PAGE_RW
)

1945 || !(
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
)) )

1947 *
¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(*
¦2e
);

1948 
	`ASSERT
(
	`mâ_v®id
(*
¦1mâ
));

1952 
shadow_l2e_t
 
Ãw_¦2e
;

1953 
r
, 
æags
 = 
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
);

1955 iàĞ!(
æags
 & 
_PAGE_PRESENT
) )

1956  
NULL
;

1957 iàĞ
	`gue¡_suµÜts_su³½ages
(
v
è&& (
æags
 & 
_PAGE_PSE
) )

1960 
gâ_t
 
l2gâ
 = 
	`gue¡_l2e_g‘_gâ
(
gw
->
l2e
);

1961 *
¦1mâ
 = 
	`g‘_æ1_shadow_¡©us
(
v
, 
l2gâ
);

1962 iàĞ!
	`mâ_v®id
(*
¦1mâ
) )

1965 *
¦1mâ
 = 
	`make_æ1_shadow
(
v
, 
l2gâ
);

1971 iàĞ!
	`mâ_v®id
(
gw
->
l1mâ
èè 
NULL
;

1972 *
¦1mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gw
->
l1mâ
, 
SH_ty³_l1_shadow
);

1973 iàĞ!
	`mâ_v®id
(*
¦1mâ
) )

1976 *
¦1mâ
 = 
	`sh_make_shadow
(
v
, 
gw
->
l1mâ
, 
SH_ty³_l1_shadow
);

1980 
	`l2e_´İag©e_äom_gue¡
(
v
, 
gw
->
l2e
, *
¦1mâ
, &
Ãw_¦2e
, 
á
);

1981 
r
 = 
	`shadow_£t_l2e
(
v
, 
¦2e
, 
Ãw_¦2e
, 
¦2mâ
);

1982 
	`ASSERT
((
r
 & 
SHADOW_SET_FLUSH
) == 0);

1983 iàĞ
r
 & 
SHADOW_SET_ERROR
 )

1984  
NULL
;

1991 (è
	`shadow_l1_šdex
(
¦1mâ
, 
	`gue¡_l1_bË_off£t
(
gw
->
va
));

1994 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

1997 iàĞ
»sync
 )

1998 
	`shadow_»sync_®l
(
v
, 0);

2002  
	`sh_lš—r_l1_bË
(
v
è+ 
	`shadow_l1_lš—r_off£t
(
gw
->
va
);

2003 
	}
}

2017 #ià
GUEST_PAGING_LEVELS
 >= 4

2018 
	$sh_de¡roy_l4_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2020 
shadow_l4e_t
 *
¦4e
;

2021 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2022 
u32
 
t
 = 
¥
->
u
.
sh
.
ty³
;

2023 
mâ_t
 
gmâ
, 
¦4mâ
;

2025 
	`SHADOW_DEBUG
(
DESTROY_SHADOW
,

2026 "%s(%05lx)\n", 
__func__
, 
	`mâ_x
(
smâ
));

2027 
	`ASSERT
(
t
 =ğ
SH_ty³_l4_shadow
);

2028 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

2031 
gmâ
 = 
	`backpoš‹r
(
¥
);

2032 
	`d–‘e_shadow_¡©us
(
v
, 
gmâ
, 
t
, 
smâ
);

2033 
	`shadow_demÙe
(
v
, 
gmâ
, 
t
);

2035 
¦4mâ
 = 
smâ
;

2036 
	`SHADOW_FOREACH_L4E
(
¦4mâ
, 
¦4e
, 0, 0, 
v
->
domaš
, {

2037 iàĞ
	`shadow_l4e_g‘_æags
(*
¦4e
è& 
_PAGE_PRESENT
 )

2039 
	`sh_put_»f
(
v
, 
	`shadow_l4e_g‘_mâ
(*
¦4e
),

2040 (((
·ddr_t
)
	`mâ_x
(
¦4mâ
)è<< 
PAGE_SHIFT
)

2041 | (()
¦4e
 & ~
PAGE_MASK
));

2046 
	`shadow_ä“
(
v
->
domaš
, 
smâ
);

2047 
	}
}

2049 
	$sh_de¡roy_l3_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2051 
shadow_l3e_t
 *
¦3e
;

2052 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2053 
u32
 
t
 = 
¥
->
u
.
sh
.
ty³
;

2054 
mâ_t
 
gmâ
, 
¦3mâ
;

2056 
	`SHADOW_DEBUG
(
DESTROY_SHADOW
,

2057 "%s(%05lx)\n", 
__func__
, 
	`mâ_x
(
smâ
));

2058 
	`ASSERT
(
t
 =ğ
SH_ty³_l3_shadow
);

2059 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

2062 
gmâ
 = 
	`backpoš‹r
(
¥
);

2063 
	`d–‘e_shadow_¡©us
(
v
, 
gmâ
, 
t
, 
smâ
);

2064 
	`shadow_demÙe
(
v
, 
gmâ
, 
t
);

2067 
¦3mâ
 = 
smâ
;

2068 
	`SHADOW_FOREACH_L3E
(
¦3mâ
, 
¦3e
, 0, 0, {

2069 iàĞ
	`shadow_l3e_g‘_æags
(*
¦3e
è& 
_PAGE_PRESENT
 )

2070 
	`sh_put_»f
(
v
, 
	`shadow_l3e_g‘_mâ
(*
¦3e
),

2071 (((
·ddr_t
)
	`mâ_x
(
¦3mâ
)è<< 
PAGE_SHIFT
)

2072 | (()
¦3e
 & ~
PAGE_MASK
));

2076 
	`shadow_ä“
(
v
->
domaš
, 
smâ
);

2077 
	}
}

2081 
	$sh_de¡roy_l2_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2083 
shadow_l2e_t
 *
¦2e
;

2084 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2085 
u32
 
t
 = 
¥
->
u
.
sh
.
ty³
;

2086 
mâ_t
 
gmâ
, 
¦2mâ
;

2088 
	`SHADOW_DEBUG
(
DESTROY_SHADOW
,

2089 "%s(%05lx)\n", 
__func__
, 
	`mâ_x
(
smâ
));

2091 #ià
GUEST_PAGING_LEVELS
 >= 3

2092 
	`ASSERT
(
t
 =ğ
SH_ty³_l2_shadow
 || =ğ
SH_ty³_l2h_shadow
);

2094 
	`ASSERT
(
t
 =ğ
SH_ty³_l2_shadow
);

2096 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

2099 
gmâ
 = 
	`backpoš‹r
(
¥
);

2100 
	`d–‘e_shadow_¡©us
(
v
, 
gmâ
, 
t
, 
smâ
);

2101 
	`shadow_demÙe
(
v
, 
gmâ
, 
t
);

2104 
¦2mâ
 = 
smâ
;

2105 
	`SHADOW_FOREACH_L2E
(
¦2mâ
, 
¦2e
, 0, 0, 
v
->
domaš
, {

2106 iàĞ
	`shadow_l2e_g‘_æags
(*
¦2e
è& 
_PAGE_PRESENT
 )

2107 
	`sh_put_»f
(
v
, 
	`shadow_l2e_g‘_mâ
(*
¦2e
),

2108 (((
·ddr_t
)
	`mâ_x
(
¦2mâ
)è<< 
PAGE_SHIFT
)

2109 | (()
¦2e
 & ~
PAGE_MASK
));

2113 
	`shadow_ä“
(
v
->
domaš
, 
smâ
);

2114 
	}
}

2116 
	$sh_de¡roy_l1_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
)

2118 
domaš
 *
d
 = 
v
->domain;

2119 
shadow_l1e_t
 *
¦1e
;

2120 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

2121 
u32
 
t
 = 
¥
->
u
.
sh
.
ty³
;

2123 
	`SHADOW_DEBUG
(
DESTROY_SHADOW
,

2124 "%s(%05lx)\n", 
__func__
, 
	`mâ_x
(
smâ
));

2125 
	`ASSERT
(
t
 =ğ
SH_ty³_l1_shadow
 || =ğ
SH_ty³_æ1_shadow
);

2126 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

2129 iàĞ
t
 =ğ
SH_ty³_æ1_shadow
 )

2131 
gâ_t
 
gâ
 = 
	`_gâ
(
¥
->
v
.
sh
.
back
);

2132 
	`d–‘e_æ1_shadow_¡©us
(
v
, 
gâ
, 
smâ
);

2136 
mâ_t
 
gmâ
 = 
	`backpoš‹r
(
¥
);

2137 
	`d–‘e_shadow_¡©us
(
v
, 
gmâ
, 
t
, 
smâ
);

2138 
	`shadow_demÙe
(
v
, 
gmâ
, 
t
);

2141 iàĞ
	`shadow_mode_»fcouÁs
(
d
) )

2144 
mâ_t
 
¦1mâ
 = 
smâ
;

2145 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1e
, 0, 0, {

2146 iàĞ(
	`shadow_l1e_g‘_æags
(*
¦1e
è& 
_PAGE_PRESENT
)

2147 && !
	`sh_l1e_is_magic
(*
¦1e
) ) {

2148 
	`shadow_v¿m_put_l1e
(*
¦1e
, sl1e, 
¦1mâ
, 
d
);

2149 
	`shadow_put_·ge_äom_l1e
(*
¦1e
, 
d
);

2155 
	`shadow_ä“
(
v
->
domaš
, 
smâ
);

2156 
	}
}

2158 #ià
SHADOW_PAGING_LEVELS
 =ğ
GUEST_PAGING_LEVELS


2159 
	$sh_de¡roy_mÚ™Ü_bË
(
vıu
 *
v
, 
mâ_t
 
mmâ
)

2161 
domaš
 *
d
 = 
v
->domain;

2162 
	`ASSERT
(
	`mâ_to_·ge
(
mmâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_mÚ™Ü_bË
);

2164 #ià(
CONFIG_PAGING_LEVELS
 =ğ4è&& (
SHADOW_PAGING_LEVELS
 != 4)

2166 
mâ_t
 
m3mâ
;

2167 
l4_pg’Œy_t
 *
l4e
 = 
	`sh_m­_domaš_·ge
(
mmâ
);

2168 
l3_pg’Œy_t
 *
l3e
;

2169 
lš—r_¦Ù
 = 
	`shadow_l4_bË_off£t
(
SH_LINEAR_PT_VIRT_START
);

2173 
	`ASSERT
(
	`l4e_g‘_æags
(
l4e
[
lš—r_¦Ù
]è& 
_PAGE_PRESENT
);

2174 
m3mâ
 = 
	`_mâ
(
	`l4e_g‘_pâ
(
l4e
[
lš—r_¦Ù
]));

2175 
l3e
 = 
	`sh_m­_domaš_·ge
(
m3mâ
);

2176 
	`ASSERT
(
	`l3e_g‘_æags
(
l3e
[0]è& 
_PAGE_PRESENT
);

2177 
	`shadow_ä“
(
d
, 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[0])));

2178 
	`sh_unm­_domaš_·ge
(
l3e
);

2179 
	`shadow_ä“
(
d
, 
m3mâ
);

2181 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2185 
	`ASSERT
(
	`l4e_g‘_æags
(
l4e
[0]è& 
_PAGE_PRESENT
);

2186 
m3mâ
 = 
	`_mâ
(
	`l4e_g‘_pâ
(
l4e
[0]));

2187 
l3e
 = 
	`sh_m­_domaš_·ge
(
m3mâ
);

2188 
	`ASSERT
(
	`l3e_g‘_æags
(
l3e
[3]è& 
_PAGE_PRESENT
);

2189 
	`shadow_ä“
(
d
, 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[3])));

2190 
	`sh_unm­_domaš_·ge
(
l3e
);

2191 
	`shadow_ä“
(
d
, 
m3mâ
);

2193 
	`sh_unm­_domaš_·ge
(
l4e
);

2195 #–ià
CONFIG_PAGING_LEVELS
 == 3

2198 
l3_pg’Œy_t
 *
l3e
 = 
	`sh_m­_domaš_·ge
(
mmâ
);

2199 
	`ASSERT
(
	`l3e_g‘_æags
(
l3e
[3]è& 
_PAGE_PRESENT
);

2200 
	`shadow_ä“
(
d
, 
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[3])));

2201 
	`sh_unm­_domaš_·ge
(
l3e
);

2206 
	`shadow_ä“
(
d
, 
mmâ
);

2207 
	}
}

2221 #ià
GUEST_PAGING_LEVELS
 == 2

2223 
	$sh_unhook_32b_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
¦2mâ
, 
u£r_Úly
)

2225 
shadow_l2e_t
 *
¦2e
;

2226 
	`SHADOW_FOREACH_L2E
(
¦2mâ
, 
¦2e
, 0, 0, 
v
->
domaš
, {

2227 iàĞ!
u£r_Úly
 || (
¦2e
->
l2
 & 
_PAGE_USER
) )

2228 (è
	`shadow_£t_l2e
(
v
, 
¦2e
, 
	`shadow_l2e_em±y
(), 
¦2mâ
);

2230 
	}
}

2232 #–ià
GUEST_PAGING_LEVELS
 == 3

2234 
	$sh_unhook_·e_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
¦2mâ
, 
u£r_Úly
)

2237 
shadow_l2e_t
 *
¦2e
;

2238 
	`SHADOW_FOREACH_L2E
(
¦2mâ
, 
¦2e
, 0, 0, 
v
->
domaš
, {

2239 iàĞ!
u£r_Úly
 || (
¦2e
->
l2
 & 
_PAGE_USER
) )

2240 (è
	`shadow_£t_l2e
(
v
, 
¦2e
, 
	`shadow_l2e_em±y
(), 
¦2mâ
);

2242 
	}
}

2244 #–ià
GUEST_PAGING_LEVELS
 == 4

2246 
	$sh_unhook_64b_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
¦4mâ
, 
u£r_Úly
)

2248 
shadow_l4e_t
 *
¦4e
;

2249 
	`SHADOW_FOREACH_L4E
(
¦4mâ
, 
¦4e
, 0, 0, 
v
->
domaš
, {

2250 iàĞ!
u£r_Úly
 || (
¦4e
->
l4
 & 
_PAGE_USER
) )

2251 (è
	`shadow_£t_l4e
(
v
, 
¦4e
, 
	`shadow_l4e_em±y
(), 
¦4mâ
);

2253 
	}
}

2268 #ià
GUEST_PAGING_LEVELS
 >= 4

2269 
	$v®id©e_gl4e
(
vıu
 *
v
, *
Ãw_ge
, 
mâ_t
 
¦4mâ
, *
£
)

2271 
shadow_l4e_t
 
Ãw_¦4e
;

2272 
gue¡_l4e_t
 
Ãw_gl4e
 = *(gue¡_l4e_ˆ*)
Ãw_ge
;

2273 
shadow_l4e_t
 *
¦4p
 = 
£
;

2274 
mâ_t
 
¦3mâ
 = 
	`_mâ
(
INVALID_MFN
);

2275 
domaš
 *
d
 = 
v
->domain;

2276 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
d
);

2277 
p2m_ty³_t
 
p2mt
;

2278 
»suÉ
 = 0;

2280 
	`³rfc_šü
(
shadow_v®id©e_gl4e_ÿÎs
);

2282 iàĞ
	`gue¡_l4e_g‘_æags
(
Ãw_gl4e
è& 
_PAGE_PRESENT
 )

2284 
gâ_t
 
gl3gâ
 = 
	`gue¡_l4e_g‘_gâ
(
Ãw_gl4e
);

2285 
mâ_t
 
gl3mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gl3gâ
, &
p2mt
);

2286 iàĞ
	`p2m_is_¿m
(
p2mt
) )

2287 
¦3mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gl3mâ
, 
SH_ty³_l3_shadow
);

2288 iàĞ
p2mt
 !ğ
p2m_pİuÏ‹_Ú_demªd
 )

2289 
»suÉ
 |ğ
SHADOW_SET_ERROR
;

2291 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

2292 iàĞ
	`mâ_v®id
(
¦3mâ
) )

2293 
	`shadow_»sync_®l
(
v
, 0);

2296 
	`l4e_´İag©e_äom_gue¡
(
v
, 
Ãw_gl4e
, 
¦3mâ
, &
Ãw_¦4e
, 
á_´eãtch
);

2299 iàĞ!
	`shadow_mode_ex‹º®
(
d
) )

2301 
shadow_šdex
 = ((()
¦4p
 & ~
PAGE_MASK
) /

2302 (
shadow_l4e_t
));

2303 
»£rved_x’_¦Ù
 = !
	`is_gue¡_l4_¦Ù
(
d
, 
shadow_šdex
);

2305 iàĞ
	`uÆik–y
(
»£rved_x’_¦Ù
) )

2309 
	`SHADOW_PRINTK
("%s out-of-range update "

2310 "¦4mâ=%05lx index=0x%x v®=%" 
SH_PRI_±e
 "\n",

2311 
__func__
, 
	`mâ_x
(
¦4mâ
), 
shadow_šdex
, 
Ãw_¦4e
.
l4
);

2312 iàĞ
	`shadow_l4e_g‘_æags
(
Ãw_¦4e
è& 
_PAGE_PRESENT
 )

2314 
	`SHADOW_ERROR
("out-of-range†4e update\n");

2315 
»suÉ
 |ğ
SHADOW_SET_ERROR
;

2319  
»suÉ
;

2323 
»suÉ
 |ğ
	`shadow_£t_l4e
(
v
, 
¦4p
, 
Ãw_¦4e
, 
¦4mâ
);

2324  
»suÉ
;

2325 
	}
}

2328 
	$v®id©e_gl3e
(
vıu
 *
v
, *
Ãw_ge
, 
mâ_t
 
¦3mâ
, *
£
)

2330 
shadow_l3e_t
 
Ãw_¦3e
;

2331 
gue¡_l3e_t
 
Ãw_gl3e
 = *(gue¡_l3e_ˆ*)
Ãw_ge
;

2332 
shadow_l3e_t
 *
¦3p
 = 
£
;

2333 
mâ_t
 
¦2mâ
 = 
	`_mâ
(
INVALID_MFN
);

2334 
p2m_ty³_t
 
p2mt
;

2335 
»suÉ
 = 0;

2336 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

2338 
	`³rfc_šü
(
shadow_v®id©e_gl3e_ÿÎs
);

2340 iàĞ
	`gue¡_l3e_g‘_æags
(
Ãw_gl3e
è& 
_PAGE_PRESENT
 )

2342 
gâ_t
 
gl2gâ
 = 
	`gue¡_l3e_g‘_gâ
(
Ãw_gl3e
);

2343 
mâ_t
 
gl2mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gl2gâ
, &
p2mt
);

2344 iàĞ
	`p2m_is_¿m
(
p2mt
) )

2345 
¦2mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gl2mâ
, 
SH_ty³_l2_shadow
);

2346 iàĞ
p2mt
 !ğ
p2m_pİuÏ‹_Ú_demªd
 )

2347 
»suÉ
 |ğ
SHADOW_SET_ERROR
;

2349 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
 )

2350 iàĞ
	`mâ_v®id
(
¦2mâ
) )

2351 
	`shadow_»sync_®l
(
v
, 0);

2354 
	`l3e_´İag©e_äom_gue¡
(
v
, 
Ãw_gl3e
, 
¦2mâ
, &
Ãw_¦3e
, 
á_´eãtch
);

2355 
»suÉ
 |ğ
	`shadow_£t_l3e
(
v
, 
¦3p
, 
Ãw_¦3e
, 
¦3mâ
);

2357  
»suÉ
;

2358 
	}
}

2361 
	$v®id©e_gl2e
(
vıu
 *
v
, *
Ãw_ge
, 
mâ_t
 
¦2mâ
, *
£
)

2363 
shadow_l2e_t
 
Ãw_¦2e
;

2364 
gue¡_l2e_t
 
Ãw_gl2e
 = *(gue¡_l2e_ˆ*)
Ãw_ge
;

2365 
shadow_l2e_t
 *
¦2p
 = 
£
;

2366 
mâ_t
 
¦1mâ
 = 
	`_mâ
(
INVALID_MFN
);

2367 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

2368 
p2m_ty³_t
 
p2mt
;

2369 
»suÉ
 = 0;

2371 
	`³rfc_šü
(
shadow_v®id©e_gl2e_ÿÎs
);

2373 iàĞ
	`gue¡_l2e_g‘_æags
(
Ãw_gl2e
è& 
_PAGE_PRESENT
 )

2375 
gâ_t
 
gl1gâ
 = 
	`gue¡_l2e_g‘_gâ
(
Ãw_gl2e
);

2376 iàĞ
	`gue¡_suµÜts_su³½ages
(
v
) &&

2377 (
	`gue¡_l2e_g‘_æags
(
Ãw_gl2e
è& 
_PAGE_PSE
) )

2381 
¦1mâ
 = 
	`g‘_æ1_shadow_¡©us
(
v
, 
gl1gâ
);

2387 iàĞ!
	`mâ_v®id
(
¦1mâ
) )

2388 
¦1mâ
 = 
	`make_æ1_shadow
(
v
, 
gl1gâ
);

2393 
mâ_t
 
gl1mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gl1gâ
, &
p2mt
);

2394 iàĞ
	`p2m_is_¿m
(
p2mt
) )

2395 
¦1mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gl1mâ
, 
SH_ty³_l1_shadow
);

2396 iàĞ
p2mt
 !ğ
p2m_pİuÏ‹_Ú_demªd
 )

2397 
»suÉ
 |ğ
SHADOW_SET_ERROR
;

2400 
	`l2e_´İag©e_äom_gue¡
(
v
, 
Ãw_gl2e
, 
¦1mâ
, &
Ãw_¦2e
, 
á_´eãtch
);

2405 #ià
SHADOW_PAGING_LEVELS
 < 4

2406 #ià
CONFIG_PAGING_LEVELS
 =ğ
SHADOW_PAGING_LEVELS


2407 iàĞ!
	`shadow_mode_ex‹º®
(
v
->
domaš
) )

2409 
shadow_šdex
 = ((()
¦2p
 & ~
PAGE_MASK
) /

2410 (
shadow_l2e_t
));

2411 
»£rved_x’_¦Ù
;

2413 #ià
SHADOW_PAGING_LEVELS
 == 3

2414 
»£rved_x’_¦Ù
 =

2415 ((
	`mâ_to_·ge
(
¦2mâ
)->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2h_·e_shadow
) &&

2416 (
shadow_šdex


2417 >ğ(
L2_PAGETABLE_FIRST_XEN_SLOT
 & (
L2_PAGETABLE_ENTRIES
-1))));

2419 
»£rved_x’_¦Ù
 = (
shadow_šdex
 >ğ
L2_PAGETABLE_FIRST_XEN_SLOT
);

2422 iàĞ
	`uÆik–y
(
»£rved_x’_¦Ù
) )

2426 
	`SHADOW_PRINTK
("%s out-of-range update "

2427 "¦2mâ=%05lx index=0x%x v®=%" 
SH_PRI_±e
 "\n",

2428 
__func__
, 
	`mâ_x
(
¦2mâ
), 
shadow_šdex
, 
Ãw_¦2e
.
l2
);

2429 iàĞ
	`shadow_l2e_g‘_æags
(
Ãw_¦2e
è& 
_PAGE_PRESENT
 )

2431 
	`SHADOW_ERROR
("out-of-range†2e update\n");

2432 
»suÉ
 |ğ
SHADOW_SET_ERROR
;

2436  
»suÉ
;

2442 
»suÉ
 |ğ
	`shadow_£t_l2e
(
v
, 
¦2p
, 
Ãw_¦2e
, 
¦2mâ
);

2444  
»suÉ
;

2445 
	}
}

2447 
	$v®id©e_gl1e
(
vıu
 *
v
, *
Ãw_ge
, 
mâ_t
 
¦1mâ
, *
£
)

2449 
shadow_l1e_t
 
Ãw_¦1e
;

2450 
gue¡_l1e_t
 
Ãw_gl1e
 = *(gue¡_l1e_ˆ*)
Ãw_ge
;

2451 
shadow_l1e_t
 *
¦1p
 = 
£
;

2452 
gâ_t
 
gâ
;

2453 
mâ_t
 
gmâ
;

2454 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

2455 
p2m_ty³_t
 
p2mt
;

2456 
»suÉ
 = 0;

2457 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2458 
mâ_t
 
gl1mâ
;

2461 
	`³rfc_šü
(
shadow_v®id©e_gl1e_ÿÎs
);

2463 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(
Ãw_gl1e
);

2464 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
p2mt
);

2466 
	`l1e_´İag©e_äom_gue¡
(
v
, 
Ãw_gl1e
, 
gmâ
, &
Ãw_¦1e
, 
á_´eãtch
, 
p2mt
);

2467 
»suÉ
 |ğ
	`shadow_£t_l1e
(
v
, 
¦1p
, 
Ãw_¦1e
, 
p2mt
, 
¦1mâ
);

2469 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2470 
gl1mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦1mâ
));

2471 iàĞ
	`mâ_v®id
(
gl1mâ
)

2472 && 
	`mâ_is_out_of_sync
(
gl1mâ
) )

2475 
mâ_t
 
¢pmâ
 = 
	`oos_¢­shÙ_lookup
(
v
, 
gl1mâ
);

2476 
gue¡_l1e_t
 *
¢p
;

2478 
	`ASSERT
(
	`mâ_v®id
(
¢pmâ
));

2480 
¢p
 = 
	`sh_m­_domaš_·ge
(
¢pmâ
);

2481 
¢p
[
	`gue¡_šdex
(
Ãw_ge
)] = 
Ãw_gl1e
;

2482 
	`sh_unm­_domaš_·ge
(
¢p
);

2486  
»suÉ
;

2487 
	}
}

2489 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2496 
	$sh_»sync_l1
(
vıu
 *
v
, 
mâ_t
 
gl1mâ
, mâ_ˆ
¢pmâ
)

2498 
mâ_t
 
¦1mâ
;

2499 
shadow_l1e_t
 *
¦1p
;

2500 
gue¡_l1e_t
 *
gl1p
, *
gp
, *
¢p
;

2501 
rc
 = 0;

2503 
	`ASSERT
(
	`mâ_v®id
(
¢pmâ
));

2505 
¦1mâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gl1mâ
, 
SH_ty³_l1_shadow
);

2506 
	`ASSERT
(
	`mâ_v®id
(
¦1mâ
));

2508 
¢p
 = 
	`sh_m­_domaš_·ge
(
¢pmâ
);

2509 
gp
 = 
	`sh_m­_domaš_·ge
(
gl1mâ
);

2510 
gl1p
 = 
gp
;

2512 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1p
, &
gl1p
, 0, {

2513 
gue¡_l1e_t
 
gl1e
 = *
gl1p
;

2514 
gue¡_l1e_t
 *
¢¶1p
 = (gue¡_l1e_ˆ*)
¢p
 + 
	`gue¡_šdex
(
gl1p
);

2516 iàĞ
	`memcmp
(
¢¶1p
, &
gl1e
, (gl1e)) )

2518 
gâ_t
 
gâ
;

2519 
mâ_t
 
gmâ
;

2520 
p2m_ty³_t
 
p2mt
;

2521 
shadow_l1e_t
 
n¦1e
;

2523 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(
gl1e
);

2524 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
gâ
, &
p2mt
);

2525 
	`l1e_´İag©e_äom_gue¡
(
v
, 
gl1e
, 
gmâ
, &
n¦1e
, 
á_´eãtch
, 
p2mt
);

2526 
rc
 |ğ
	`shadow_£t_l1e
(
v
, 
¦1p
, 
n¦1e
, 
p2mt
, 
¦1mâ
);

2528 *
¢¶1p
 = 
gl1e
;

2532 
	`sh_unm­_domaš_·ge
(
gp
);

2533 
	`sh_unm­_domaš_·ge
(
¢p
);

2536 
	`ASSERT
(!(
rc
 & 
SHADOW_SET_FLUSH
));

2537 
	}
}

2545 
	$sh_§ã_nÙ_to_sync
(
vıu
 *
v
, 
mâ_t
 
gl1mâ
)

2547 
·ge_šfo
 *
¥
;

2548 
mâ_t
 
smâ
;

2550 iàĞ!
	`sh_ty³_has_up_poš‹r
(
v
, 
SH_ty³_l1_shadow
) )

2553 
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gl1mâ
, 
SH_ty³_l1_shadow
);

2554 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2557 
¥
 = 
	`mâ_to_·ge
(
smâ
);

2558 iàĞ
¥
->
u
.
sh
.
couÁ
 !ğ1 || !¥->
up
 )

2560 
smâ
 = 
	`_mâ
(
¥
->
up
 >> 
PAGE_SHIFT
);

2561 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2563 #ià(
SHADOW_PAGING_LEVELS
 == 4)

2565 
¥
 = 
	`mâ_to_·ge
(
smâ
);

2566 
	`ASSERT
(
	`sh_ty³_has_up_poš‹r
(
v
, 
SH_ty³_l2_shadow
));

2567 iàĞ
¥
->
u
.
sh
.
couÁ
 !ğ1 || !¥->
up
 )

2569 
smâ
 = 
	`_mâ
(
¥
->
up
 >> 
PAGE_SHIFT
);

2570 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2573 
¥
 = 
	`mâ_to_·ge
(
smâ
);

2574 iàĞ
¥
->
u
.
sh
.
couÁ
 != 1

2575 || !
	`sh_ty³_has_up_poš‹r
(
v
, 
SH_ty³_l3_64_shadow
è|| !
¥
->
up
 )

2577 
smâ
 = 
	`_mâ
(
¥
->
up
 >> 
PAGE_SHIFT
);

2578 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2581 iàĞ
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[0]è=ğ
	`mâ_x
(
smâ
)

2582 #ià(
SHADOW_PAGING_LEVELS
 == 3)

2583 || 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[1]è=ğ
	`mâ_x
(
smâ
)

2584 || 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[2]è=ğ
	`mâ_x
(
smâ
)

2585 || 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[3]è=ğ
	`mâ_x
(
smâ
)

2593 
	}
}

2602 
šlše
 

2603 
sh_m­_ªd_v®id©e
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

2604 *
Ãw_gp
, 
u32
 
size
, u32 
sh_ty³
,

2605 
	$u32
 (*
shadow_šdex
)(
mâ_t
 *
smâ
, 
u32
 
idx
),

2606 (*
v®id©e_ge
)(
vıu
 *
v
, *
ge
,

2607 
mâ_t
 
smâ
, *
£
))

2610 
mâ_t
 
smâ
, 
smâ2
, 
m­_mâ
;

2611 
shadow_l1e_t
 *
¦1p
;

2612 
u32
 
shadow_idx
, 
gue¡_idx
;

2613 
»suÉ
 = 0;

2616 
size
 +ğ()
Ãw_gp
 & ( (
gue¡_l1e_t
) - 1);

2617 
Ãw_gp
 = (*)((êew_g°& ~( (
gue¡_l1e_t
) - 1));

2618 
size
 = (siz+  (
gue¡_l1e_t
) - 1) & ~( (guest_l1e_t) - 1);

2619 
	`ASSERT
(
size
 + ((()
Ãw_gp
è& ~
PAGE_MASK
è<ğ
PAGE_SIZE
);

2622 
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gmâ
, 
sh_ty³
);

2623 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

2624 
gue¡_idx
 = 
	`gue¡_šdex
(
Ãw_gp
);

2625 
m­_mâ
 = 
smâ
;

2626 
shadow_idx
 = 
	`shadow_šdex
(&
m­_mâ
, 
gue¡_idx
);

2627 
¦1p
 = 
	`sh_m­_domaš_·ge
(
m­_mâ
);

2630  
size
 )

2632 
smâ2
 = 
smâ
;

2633 
gue¡_idx
 = 
	`gue¡_šdex
(
Ãw_gp
);

2634 
shadow_idx
 = 
	`shadow_šdex
(&
smâ2
, 
gue¡_idx
);

2635 iàĞ
	`mâ_x
(
smâ2
è!ğmâ_x(
m­_mâ
) )

2638 
m­_mâ
 = 
smâ2
;

2639 
	`sh_unm­_domaš_·ge
(
¦1p
);

2640 
¦1p
 = 
	`sh_m­_domaš_·ge
(
m­_mâ
);

2642 
»suÉ
 |ğ
	`v®id©e_ge
(
v
,

2643 
Ãw_gp
,

2644 
m­_mâ
,

2645 &
¦1p
[
shadow_idx
]);

2646 
size
 -ğ(
gue¡_l1e_t
);

2647 
Ãw_gp
 +ğ(
gue¡_l1e_t
);

2649 
	`sh_unm­_domaš_·ge
(
¦1p
);

2650  
»suÉ
;

2651 
	}
}

2655 
	$sh_m­_ªd_v®id©e_gl4e
(
vıu
 *
v
, 
mâ_t
 
gl4mâ
,

2656 *
Ãw_gl4p
, 
u32
 
size
)

2658 #ià
GUEST_PAGING_LEVELS
 >= 4

2659  
	`sh_m­_ªd_v®id©e
(
v
, 
gl4mâ
, 
Ãw_gl4p
, 
size
,

2660 
SH_ty³_l4_shadow
,

2661 
shadow_l4_šdex
,

2662 
v®id©e_gl4e
);

2664 
	`SHADOW_ERROR
("called in wrong…aging mode!\n");

2665 
	`BUG
();

2668 
	}
}

2671 
	$sh_m­_ªd_v®id©e_gl3e
(
vıu
 *
v
, 
mâ_t
 
gl3mâ
,

2672 *
Ãw_gl3p
, 
u32
 
size
)

2674 #ià
GUEST_PAGING_LEVELS
 >= 4

2675  
	`sh_m­_ªd_v®id©e
(
v
, 
gl3mâ
, 
Ãw_gl3p
, 
size
,

2676 
SH_ty³_l3_shadow
,

2677 
shadow_l3_šdex
,

2678 
v®id©e_gl3e
);

2680 
	`SHADOW_ERROR
("called in wrong…aging mode!\n");

2681 
	`BUG
();

2684 
	}
}

2687 
	$sh_m­_ªd_v®id©e_gl2e
(
vıu
 *
v
, 
mâ_t
 
gl2mâ
,

2688 *
Ãw_gl2p
, 
u32
 
size
)

2690  
	`sh_m­_ªd_v®id©e
(
v
, 
gl2mâ
, 
Ãw_gl2p
, 
size
,

2691 
SH_ty³_l2_shadow
,

2692 
shadow_l2_šdex
,

2693 
v®id©e_gl2e
);

2694 
	}
}

2697 
	$sh_m­_ªd_v®id©e_gl2he
(
vıu
 *
v
, 
mâ_t
 
gl2mâ
,

2698 *
Ãw_gl2p
, 
u32
 
size
)

2700 #ià
GUEST_PAGING_LEVELS
 >= 3

2701  
	`sh_m­_ªd_v®id©e
(
v
, 
gl2mâ
, 
Ãw_gl2p
, 
size
,

2702 
SH_ty³_l2h_shadow
,

2703 
shadow_l2_šdex
,

2704 
v®id©e_gl2e
);

2706 
	`SHADOW_ERROR
("called in wrong…aging mode!\n");

2707 
	`BUG
();

2710 
	}
}

2713 
	$sh_m­_ªd_v®id©e_gl1e
(
vıu
 *
v
, 
mâ_t
 
gl1mâ
,

2714 *
Ãw_gl1p
, 
u32
 
size
)

2716  
	`sh_m­_ªd_v®id©e
(
v
, 
gl1mâ
, 
Ãw_gl1p
, 
size
,

2717 
SH_ty³_l1_shadow
,

2718 
shadow_l1_šdex
,

2719 
v®id©e_gl1e
);

2720 
	}
}

2733 
šlše
 
	$check_fÜ_—¾y_unshadow
(
vıu
 *
v
, 
mâ_t
 
gmâ
)

2735 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_EARLY_UNSHADOW


2742 iàĞĞ
v
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg


2743 || ( !
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg_İ


2744 && 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_mâ_fÜ_unshadow
 =ğ
	`mâ_x
(
gmâ
) ) )

2745 && 
	`sh_mâ_is_a_·ge_bË
(
gmâ
)

2746 && !(
	`mâ_to_·ge
(
gmâ
)->
shadow_æags


2747 & (
SHF_L2_32
|
SHF_L2_PAE
|
SHF_L2H_PAE
|
SHF_L4_64
)) )

2749 
	`³rfc_šü
(
shadow_—¾y_unshadow
);

2750 
	`sh_»move_shadows
(
v
, 
gmâ
, 1, 0 );

2751 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_EARLY_UNSHADOW
);

2753 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_mâ_fÜ_unshadow
 = 
	`mâ_x
(
gmâ
);

2755 
	}
}

2758 
šlše
 
	$»£t_—¾y_unshadow
(
vıu
 *
v
)

2760 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_EARLY_UNSHADOW


2761 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_mâ_fÜ_unshadow
 = 
INVALID_MFN
;

2763 
	}
}

2773 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_PREFETCH


2776 
	#PREFETCH_DISTANCE
 32

	)

2778 
	$sh_´eãtch
(
vıu
 *
v
, 
w®k_t
 *
gw
,

2779 
shadow_l1e_t
 *
±r_¦1e
, 
mâ_t
 
¦1mâ
)

2781 
i
, 
di¡
;

2782 
gâ_t
 
gâ
;

2783 
mâ_t
 
gmâ
;

2784 
gue¡_l1e_t
 *
gl1p
 = 
NULL
, 
gl1e
;

2785 
shadow_l1e_t
 
¦1e
;

2786 
u32
 
gæags
;

2787 
p2m_ty³_t
 
p2mt
;

2788 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2789 
gue¡_l1e_t
 *
¢¶1p
 = 
NULL
;

2794 
di¡
 = (
PAGE_SIZE
 - (()
±r_¦1e
 & ~
PAGE_MASK
)è/  
¦1e
;

2796 iàĞ
di¡
 > 
PREFETCH_DISTANCE
 )

2797 
di¡
 = 
PREFETCH_DISTANCE
;

2799 iàĞ
	`mâ_v®id
(
gw
->
l1mâ
) )

2802 
gl1p
 = 
	`sh_m­_domaš_·ge
(
gw
->
l1mâ
);

2803 
gl1p
 +ğ
	`gue¡_l1_bË_off£t
(
gw
->
va
);

2805 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2806 iàĞ
	`mâ_is_out_of_sync
(
gw
->
l1mâ
) )

2808 
mâ_t
 
¢pmâ
 = 
	`oos_¢­shÙ_lookup
(
v
, 
gw
->
l1mâ
);

2810 
	`ASSERT
(
	`mâ_v®id
(
¢pmâ
));

2811 
¢¶1p
 = 
	`sh_m­_domaš_·ge
(
¢pmâ
);

2812 
¢¶1p
 +ğ
	`gue¡_l1_bË_off£t
(
gw
->
va
);

2817  
i
 = 1; i < 
di¡
 ; i++ )

2820 iàĞ
±r_¦1e
[
i
].
l1
 != 0 )

2823 iàĞ
	`mâ_v®id
(
gw
->
l1mâ
) )

2826 
gl1e
 = 
gl1p
[
i
];

2829 
gæags
 = 
	`gue¡_l1e_g‘_æags
(
gl1e
);

2830 iàĞ(
gæags
 & 
_PAGE_PRESENT
)

2831 && (!(
gæags
 & 
_PAGE_ACCESSED
)

2832 || ((
gæags
 & 
_PAGE_RW
è&& !(gæag & 
_PAGE_DIRTY
))) )

2838 
	`ASSERT
(
	`gue¡_l2e_g‘_æags
(
gw
->
l2e
è& 
_PAGE_PSE
);

2840 
gl1e
 = 
	`gue¡_l1e_äom_gâ
(

2841 
	`_gâ
(
	`gâ_x
(
	`gue¡_l1e_g‘_gâ
(
gw
->
l1e
)è+ 
i
),

2842 
	`gue¡_l1e_g‘_æags
(
gw
->
l1e
));

2846 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(
gl1e
);

2847 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
gâ
, &
p2mt
);

2850 
	`l1e_´İag©e_äom_gue¡
(
v
, 
gl1e
, 
gmâ
, &
¦1e
, 
á_´eãtch
, 
p2mt
);

2851 (è
	`shadow_£t_l1e
(
v
, 
±r_¦1e
 + 
i
, 
¦1e
, 
p2mt
, 
¦1mâ
);

2853 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2854 iàĞ
¢¶1p
 !ğ
NULL
 )

2855 
¢¶1p
[
i
] = 
gl1e
;

2858 iàĞ
gl1p
 !ğ
NULL
 )

2859 
	`sh_unm­_domaš_·ge
(
gl1p
);

2860 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

2861 iàĞ
¢¶1p
 !ğ
NULL
 )

2862 
	`sh_unm­_domaš_·ge
(
¢¶1p
);

2864 
	}
}

2868 #ià
GUEST_PAGING_LEVELS
 == 4

2869 
u64
 
	tgue¡_va_t
;

2870 
u64
 
	tgue¡_·_t
;

2871 #–ià
GUEST_PAGING_LEVELS
 == 3

2872 
u32
 
	tgue¡_va_t
;

2873 
u64
 
	tgue¡_·_t
;

2875 
u32
 
	tgue¡_va_t
;

2876 
u32
 
	tgue¡_·_t
;

2879 
šlše
 
	$Œaû_shadow_g’
(
u32
 
ev’t
, 
gue¡_va_t
 
va
)

2881 iàĞ
tb_š™_dÚe
 )

2883 
ev’t
 |ğ(
GUEST_PAGING_LEVELS
-2)<<8;

2884 
	`__Œaû_v¬
(
ev’t
, 0 , (
va
), &va);

2886 
	}
}

2888 
šlše
 
	$Œaû_shadow_fixup
(
gue¡_l1e_t
 
gl1e
,

2889 
gue¡_va_t
 
va
)

2891 iàĞ
tb_š™_dÚe
 )

2896 
gue¡_l1e_t
 
gl1e
;

2897 
gue¡_va_t
 
va
;

2898 
u32
 
æags
;

2899 } 
	`__©Œibu‹__
((
·cked
)è
d
;

2900 
u32
 
ev’t
;

2902 
ev’t
 = 
TRC_SHADOW_FIXUP
 | ((
GUEST_PAGING_LEVELS
-2)<<8);

2904 
d
.
gl1e
 = gl1e;

2905 
d
.
va
 = va;

2906 
d
.
æags
 = 
	`this_ıu
(
Œaû_shadow_·th_æags
);

2908 
	`__Œaû_v¬
(
ev’t
, 0 , (
d
), &d);

2910 
	}
}

2912 
šlše
 
	$Œaû_nÙ_shadow_çuÉ
(
gue¡_l1e_t
 
gl1e
,

2913 
gue¡_va_t
 
va
)

2915 iàĞ
tb_š™_dÚe
 )

2920 
gue¡_l1e_t
 
gl1e
;

2921 
gue¡_va_t
 
va
;

2922 
u32
 
æags
;

2923 } 
	`__©Œibu‹__
((
·cked
)è
d
;

2924 
u32
 
ev’t
;

2926 
ev’t
 = 
TRC_SHADOW_NOT_SHADOW
 | ((
GUEST_PAGING_LEVELS
-2)<<8);

2928 
d
.
gl1e
 = gl1e;

2929 
d
.
va
 = va;

2930 
d
.
æags
 = 
	`this_ıu
(
Œaû_shadow_·th_æags
);

2932 
	`__Œaû_v¬
(
ev’t
, 0 , (
d
), &d);

2934 
	}
}

2936 
šlše
 
	$Œaû_shadow_emuÏ‹_Ùh”
(
u32
 
ev’t
,

2937 
gue¡_va_t
 
va
,

2938 
gâ_t
 
gâ
)

2940 iàĞ
tb_š™_dÚe
 )

2945 #ià
GUEST_PAGING_LEVELS
 == 2

2946 
u32
 
gâ
;

2948 
u64
 
gâ
;

2950 
gue¡_va_t
 
va
;

2951 } 
	`__©Œibu‹__
((
·cked
)è
d
;

2953 
ev’t
 |ğ((
GUEST_PAGING_LEVELS
-2)<<8);

2955 
d
.
gâ
=
	`gâ_x
(gfn);

2956 
d
.
va
 = va;

2958 
	`__Œaû_v¬
(
ev’t
, 0 , (
d
), &d);

2960 
	}
}

2962 #ià
GUEST_PAGING_LEVELS
 == 3

2963 
DEFINE_PER_CPU
(
gue¡_va_t
,
Œaû_emuÏ‹_š™Ÿl_va
);

2964 
DEFINE_PER_CPU
(,
Œaû_exŒa_emuÏtiÚ_couÁ
);

2966 
DEFINE_PER_CPU
(
gue¡_·_t
,
Œaû_emuÏ‹_wr™e_v®
);

2968 
šlše
 
	$Œaû_shadow_emuÏ‹
(
gue¡_l1e_t
 
gl1e
, 
va
)

2970 iàĞ
tb_š™_dÚe
 )

2975 
gue¡_l1e_t
 
gl1e
, 
wr™e_v®
;

2976 
gue¡_va_t
 
va
;

2977 
æags
:29, 
emuÏtiÚ_couÁ
:3;

2978 } 
	`__©Œibu‹__
((
·cked
)è
d
;

2979 
u32
 
ev’t
;

2981 
ev’t
 = 
TRC_SHADOW_EMULATE
 | ((
GUEST_PAGING_LEVELS
-2)<<8);

2983 
d
.
gl1e
 = gl1e;

2984 
d
.
wr™e_v®
.
l1
 = 
	`this_ıu
(
Œaû_emuÏ‹_wr™e_v®
);

2985 
d
.
va
 = va;

2986 #ià
GUEST_PAGING_LEVELS
 == 3

2987 
d
.
emuÏtiÚ_couÁ
 = 
	`this_ıu
(
Œaû_exŒa_emuÏtiÚ_couÁ
);

2989 
d
.
æags
 = 
	`this_ıu
(
Œaû_shadow_·th_æags
);

2991 
	`__Œaû_v¬
(
ev’t
, 0 , (
d
), &d);

2993 
	}
}

3003 
	$sh_·ge_çuÉ
(
vıu
 *
v
,

3004 
va
,

3005 
ıu_u£r_»gs
 *
»gs
)

3007 
domaš
 *
d
 = 
v
->domain;

3008 
w®k_t
 
gw
;

3009 
gâ_t
 
gâ
 = 
	`_gâ
(0);

3010 
mâ_t
 
gmâ
, 
¦1mâ
 = 
	`_mâ
(0);

3011 
shadow_l1e_t
 
¦1e
, *
±r_¦1e
;

3012 
·ddr_t
 
g·
;

3013 
sh_emuÏ‹_ùxt
 
emul_ùxt
;

3014 cÚ¡ 
x86_emuÏ‹_İs
 *
emul_İs
;

3015 
r
;

3016 
ãtch_ty³_t
 
á
 = 0;

3017 
p2m_ty³_t
 
p2mt
;

3018 
ušt32_t
 
rc
;

3019 
v”siÚ
;

3020 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3021 
ç¡_emul
 = 0;

3024 
	`SHADOW_PRINTK
("d:v=%u:%u va=%#lxƒrr=%u,„ip=%lx\n",

3025 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
va
, 
»gs
->
”rÜ_code
,

3026 
»gs
->
e
);

3028 
	`³rfc_šü
(
shadow_çuÉ
);

3030 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3035 iàĞ
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok


3036 && 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_äame
 =ğ(
va
 >> 
PAGE_SHIFT
) )

3041 iàĞ
»gs
->
”rÜ_code
 =ğ(
PFEC_wr™e_acûss
 | 
PFEC_·ge_´e£Á
) )

3043 
ç¡_emul
 = 1;

3044 
gmâ
 = 
	`_mâ
(
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_mâ
);

3046 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3049 iàĞ
	`mâ_v®id
(
gmâ
è&& 
	`mâ_is_out_of_sync
(gmfn) )

3051 
ç¡_emul
 = 0;

3052 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3053 
·ge_çuÉ_¦ow_·th
;

3057 
	`³rfc_šü
(
shadow_çuÉ_ç¡_emuÏ‹
);

3058 
—¾y_emuÏtiÚ
;

3061 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3071 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_FAULT_PATH
)

3072 iàĞ(
»gs
->
”rÜ_code
 & 
PFEC_»£rved_b™
) )

3074 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3079 
shadow_l2e_t
 
¦2e
;

3080 
mâ_t
 
gl1mâ
;

3081 iàĞ(
	`__cİy_äom_u£r
(&
¦2e
,

3082 (
	`sh_lš—r_l2_bË
(
v
)

3083 + 
	`shadow_l2_lš—r_off£t
(
va
)),

3084 (
¦2e
)) != 0)

3085 || !(
	`shadow_l2e_g‘_æags
(
¦2e
è& 
_PAGE_PRESENT
)

3086 || !
	`mâ_v®id
(
gl1mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(

3087 
	`shadow_l2e_g‘_mâ
(
¦2e
))))

3088 || 
	`uÆik–y
(
	`mâ_is_out_of_sync
(
gl1mâ
)) )

3092 
	`ASSERT
(
»gs
->
”rÜ_code
 & 
PFEC_·ge_´e£Á
);

3093 
»gs
->
”rÜ_code
 ^ğ(
PFEC_»£rved_b™
|
PFEC_·ge_´e£Á
);

3094 
·ge_çuÉ_¦ow_·th
;

3100 iàĞ
	`lik–y
((
	`__cİy_äom_u£r
(&
¦1e
,

3101 (
	`sh_lš—r_l1_bË
(
v
)

3102 + 
	`shadow_l1_lš—r_off£t
(
va
)),

3103 (
¦1e
)) == 0)

3104 && 
	`sh_l1e_is_magic
(
¦1e
)) )

3107 iàĞ
	`sh_l1e_is_gÅ
(
¦1e
) )

3111 
	`ASSERT
(
»gs
->
”rÜ_code
 & 
PFEC_·ge_´e£Á
);

3112 
»gs
->
”rÜ_code
 ^ğ(
PFEC_»£rved_b™
|
PFEC_·ge_´e£Á
);

3113 
	`»£t_—¾y_unshadow
(
v
);

3114 
	`³rfc_šü
(
shadow_çuÉ_ç¡_gÅ
);

3115 
	`SHADOW_PRINTK
("fast…ath‚ot-present\n");

3116 
	`Œaû_shadow_g’
(
TRC_SHADOW_FAST_PROPAGATE
, 
va
);

3122 
	`ASSERT
(
	`sh_l1e_is_mmio
(
¦1e
));

3123 
g·
 = (((
·ddr_t
)(
	`gâ_x
(
	`sh_l1e_mmio_g‘_gâ
(
¦1e
))))

3124 << 
PAGE_SHIFT
)

3125 | (
va
 & ~
PAGE_MASK
);

3127 
	`³rfc_šü
(
shadow_çuÉ_ç¡_mmio
);

3128 
	`SHADOW_PRINTK
("ç¡…©h mmiØ%#"
PRI·ddr
"\n", 
g·
);

3129 
	`»£t_—¾y_unshadow
(
v
);

3130 
	`Œaû_shadow_g’
(
TRC_SHADOW_FAST_MMIO
, 
va
);

3131  (
	`hªdË_mmio_w™h_Œª¦©iÚ
(
va
, 
g·
 >> 
PAGE_SHIFT
)

3132 ? 
EXCRET_çuÉ_fixed
 : 0);

3139 
	`³rfc_šü
(
shadow_çuÉ_ç¡_ç
);

3140 
	`SHADOW_PRINTK
("fast…ath false‡larm!\n");

3141 
	`Œaû_shadow_g’
(
TRC_SHADOW_FALSE_FAST_PATH
, 
va
);

3142  
EXCRET_çuÉ_fixed
;

3146 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3147 
·ge_çuÉ_¦ow_·th
:

3156 iàĞ
	`uÆik–y
(
	`shadow_locked_by_me
(
d
)) )

3158 
	`SHADOW_ERROR
("Recursive shadow fault:†ock wasaken by %s\n",

3159 
d
->
¬ch
.
·gšg
.
shadow
.
lock”_funùiÚ
);

3163 
»w®k
:

3169 
v”siÚ
 = 
	`©omic_»ad
(&
d
->
¬ch
.
·gšg
.
shadow
.
gbË_dœty_v”siÚ
);

3170 
	`rmb
();

3171 
rc
 = 
	`sh_w®k_gue¡_bËs
(
v
, 
va
, &
gw
, 
»gs
->
”rÜ_code
);

3173 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3174 
»gs
->
”rÜ_code
 &ğ~
PFEC_·ge_´e£Á
;

3175 iàĞ!(
rc
 & 
_PAGE_PRESENT
) )

3176 
»gs
->
”rÜ_code
 |ğ
PFEC_·ge_´e£Á
;

3179 iàĞ
rc
 != 0 )

3181 
	`³rfc_šü
(
shadow_çuÉ_ba_»®_çuÉ
);

3182 
	`SHADOW_PRINTK
("not‡ shadow fault\n");

3183 
	`»£t_—¾y_unshadow
(
v
);

3184 iàĞ(
rc
 & 
_PAGE_INVALID_BITS
) )

3185 
»gs
->
”rÜ_code
 |ğ
PFEC_»£rved_b™
;

3186 
´İag©e
;

3193 iàĞ
	`uÆik–y
(
d
->
is_shu‰šg_down
 && d->
shutdown_code
 =ğ
SHUTDOWN_üash
) )

3195 
	`SHADOW_PRINTK
("guest is shutting down\n");

3196 
´İag©e
;

3200 
á
 = ((
»gs
->
”rÜ_code
 & 
PFEC_wr™e_acûss
)

3201 ? 
á_demªd_wr™e
 : 
á_demªd_»ad
);

3204 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(
gw
.
l1e
);

3205 
gmâ
 = 
	`gâ_to_mâ_gue¡
(
	`p2m_g‘_ho¡p2m
(
d
), 
gâ
, &
p2mt
);

3207 iàĞ
	`shadow_mode_»fcouÁs
(
d
) &&

3208 ((!
	`p2m_is_v®id
(
p2mt
è&& !
	`p2m_is_g¿Á
(p2mt)) ||

3209 (!
	`p2m_is_mmio
(
p2mt
è&& !
	`mâ_v®id
(
gmâ
))) )

3211 
	`³rfc_šü
(
shadow_çuÉ_ba_bad_gâ
);

3212 
	`SHADOW_PRINTK
("BAD gâ=%"
SH_PRI_gâ
" gmâ=%"
PRI_mâ
"\n",

3213 
	`gâ_x
(
gâ
), 
	`mâ_x
(
gmâ
));

3214 
	`»£t_—¾y_unshadow
(
v
);

3215 
´İag©e
;

3218 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

3220 
	`vb_š£¹
(
v
, 
va
 >> 
PAGE_SHIFT
, 
	`gâ_x
(
gâ
),

3221 
»gs
->
”rÜ_code
 | 
PFEC_·ge_´e£Á
);

3224 
	`shadow_lock
(
d
);

3226 
TRACE_CLEAR_PATH_FLAGS
;

3237 
	`shadow_´—Îoc
(
d
,

3238 
SH_ty³_l1_shadow
,

3239 
GUEST_PAGING_LEVELS
 < 4 ? 1 : GUEST_PAGING_LEVELS - 1);

3241 
rc
 = 
	`gw_»move_wr™e_acûs£s
(
v
, 
va
, &
gw
);

3244 iàĞ
rc
 & 
GW_RMWR_FLUSHTLB
 )

3249 
	`³rfc_šü
(
shadow_rm_wr™e_æush_b
);

3250 
	`©omic_šc
(&
d
->
¬ch
.
·gšg
.
shadow
.
gbË_dœty_v”siÚ
);

3251 
	`æush_b_mask
(&
d
->
domaš_dœty_ıumask
);

3254 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3256 iàĞ
rc
 & 
GW_RMWR_REWALK
 )

3258 
	`shadow_uÆock
(
d
);

3259 
»w®k
;

3263 iàĞ!
	`shadow_check_gw®k
(
v
, 
va
, &
gw
, 
v”siÚ
) )

3265 
	`³rfc_šü
(
shadow_šcÚsi¡’t_gw®k
);

3266 
	`shadow_uÆock
(
d
);

3267 
»w®k
;

3270 
	`shadow_aud™_bËs
(
v
);

3271 
	`sh_aud™_gw
(
v
, &
gw
);

3275 
±r_¦1e
 = 
	`shadow_g‘_ªd_ü—‹_l1e
(
v
, &
gw
, &
¦1mâ
, 
á
);

3276 iàĞ
	`uÆik–y
(
±r_¦1e
 =ğ
NULL
) )

3287 #ià
GUEST_PAGING_LEVELS
 == 3

3288 
v
->
¬ch
.
·gšg
.
mode
->
	`upd©e_ü3
(v, 0);

3290 
	`ASSERT
(
d
->
is_shu‰šg_down
);

3292 
	`shadow_uÆock
(
d
);

3293 
	`Œaû_shadow_g’
(
TRC_SHADOW_DOMF_DYING
, 
va
);

3297 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3299 iàĞ
	`sh_mâ_is_a_·ge_bË
(
gmâ
)

3300 && 
á
 =ğ
á_demªd_wr™e
 )

3301 
	`sh_unsync
(
v
, 
gmâ
);

3303 iàĞ
	`uÆik–y
(
d
->
is_shu‰šg_down
 && d->
shutdown_code
 =ğ
SHUTDOWN_üash
) )

3309 
	`shadow_uÆock
(
d
);

3315 iàĞ
	`shadow_check_gl1e
(
v
, &
gw
) )

3317 
	`³rfc_šü
(
shadow_šcÚsi¡’t_gw®k
);

3318 
	`shadow_uÆock
(
d
);

3319 
»w®k
;

3324 
	`l1e_´İag©e_äom_gue¡
(
v
, 
gw
.
l1e
, 
gmâ
, &
¦1e
, 
á
, 
p2mt
);

3325 
r
 = 
	`shadow_£t_l1e
(
v
, 
±r_¦1e
, 
¦1e
, 
p2mt
, 
¦1mâ
);

3327 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3328 iàĞ
	`mâ_v®id
(
gw
.
l1mâ
)

3329 && 
	`mâ_is_out_of_sync
(
gw
.
l1mâ
) )

3332 
mâ_t
 
¢pmâ
 = 
	`oos_¢­shÙ_lookup
(
v
, 
gw
.
l1mâ
);

3333 
gue¡_l1e_t
 *
¢p
;

3335 
	`ASSERT
(
	`mâ_v®id
(
¢pmâ
));

3337 
¢p
 = 
	`sh_m­_domaš_·ge
(
¢pmâ
);

3338 
¢p
[
	`gue¡_l1_bË_off£t
(
va
)] = 
gw
.
l1e
;

3339 
	`sh_unm­_domaš_·ge
(
¢p
);

3343 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_PREFETCH


3345 
	`sh_´eãtch
(
v
, &
gw
, 
±r_¦1e
, 
¦1mâ
);

3349 iàĞ
	`sh_mâ_is_a_·ge_bË
(
gmâ
)

3350 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3353 && !(
	`mâ_is_out_of_sync
(
gmâ
)

3354 && !(
»gs
->
”rÜ_code
 & 
PFEC_u£r_mode
))

3358 iàĞ
á
 =ğ
á_demªd_wr™e
 )

3360 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_wr™e
);

3361 
emuÏ‹
;

3363 iàĞ
	`shadow_mode_Œ­_»ads
(
d
è&& 
á
 =ğ
á_demªd_»ad
 )

3365 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_»ad
);

3366 
emuÏ‹
;

3371 iàĞ
p2mt
 =ğ
p2m_mmio_dm
 )

3373 
g·
 = 
	`gue¡_w®k_to_g·
(&
gw
);

3374 
mmio
;

3378 iàĞ
	`p2m_is_»adÚly
(
p2mt
è&& (
á
 =ğ
á_demªd_wr™e
) )

3380 
Ï¡·ge
;

3381 iàĞ
	`xchg
(&
Ï¡·ge
, 
va
 & 
PAGE_MASK
) != (va & PAGE_MASK) )

3382 
	`gd´štk
(
XENLOG_DEBUG
, "guest‡ttempted writeo„ead-only memory"

3384 
va
 & 
PAGE_MASK
, 
	`mâ_x
(
gmâ
));

3385 
emuÏ‹_»adÚly
;

3393 iàĞ
	`is_hvm_domaš
(
d
)

3394 && 
	`uÆik–y
(!
	`hvm_wp_’abËd
(
v
))

3395 && 
»gs
->
”rÜ_code
 =ğ(
PFEC_wr™e_acûss
|
PFEC_·ge_´e£Á
)

3396 && 
	`mâ_v®id
(
gmâ
) )

3398 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_wp
);

3399 
emuÏ‹
;

3402 
	`³rfc_šü
(
shadow_çuÉ_fixed
);

3403 
d
->
¬ch
.
·gšg
.
log_dœty
.
çuÉ_couÁ
++;

3404 
	`»£t_—¾y_unshadow
(
v
);

3406 
	`Œaû_shadow_fixup
(
gw
.
l1e
, 
va
);

3407 
dÚe
:

3408 
	`sh_aud™_gw
(
v
, &
gw
);

3409 
	`SHADOW_PRINTK
("fixed\n");

3410 
	`shadow_aud™_bËs
(
v
);

3411 
	`shadow_uÆock
(
d
);

3412  
EXCRET_çuÉ_fixed
;

3414 
emuÏ‹
:

3415 iàĞ!
	`shadow_mode_»fcouÁs
(
d
è|| !
	`gue¡_mode
(
»gs
) )

3416 
nÙ_a_shadow_çuÉ
;

3423 iàĞ(
»gs
->
”rÜ_code
 & 
PFEC_u£r_mode
) )

3425 
	`SHADOW_PRINTK
("user-mode faulto PT, unshadowing mfn %#lx\n",

3426 
	`mâ_x
(
gmâ
));

3427 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_çed
);

3428 
	`sh_»move_shadows
(
v
, 
gmâ
, 0 , 1 );

3429 
	`Œaû_shadow_emuÏ‹_Ùh”
(
TRC_SHADOW_EMULATE_UNSHADOW_USER
,

3430 
va
, 
gâ
);

3431 
dÚe
;

3438 
emuÏ‹_»adÚly
:

3442 iàĞ
	`sh_mâ_is_a_·ge_bË
(
gmâ
)

3443 && (
	`mâ_to_·ge
(
gmâ
)->
shadow_æags
 & 
SHF_·g‘abË_dyšg
) )

3445 
u£d
 = 0;

3446 
vıu
 *
tmp
;

3447 
	`fÜ_—ch_vıu
(
d
, 
tmp
)

3449 #ià
GUEST_PAGING_LEVELS
 == 3

3450 
i
;

3451  
i
 = 0; i < 4; i++ )

3453 
mâ_t
 
smâ
 = 
	`_mâ
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[
i
]));

3454 iàĞ
	`mâ_v®id
(
smâ
è&& (
	`mâ_x
(smfn) != 0) )

3456 
u£d
 |ğ(
	`mâ_to_·ge
(
smâ
)->
v
.
sh
.
back
 =ğ
	`mâ_x
(
gmâ
));

3458 iàĞ
u£d
 )

3463 
u£d
 = (
	`mâ_x
(
	`·g‘abË_g‘_mâ
(
tmp
->
¬ch
.
gue¡_bË
)è=ğmâ_x(
gmâ
));

3465 iàĞ
u£d
 )

3469 iàĞ!
u£d
 )

3470 
	`sh_»move_shadows
(
v
, 
gmâ
, 1 , 0 );

3477 
	`sh_aud™_gw
(
v
, &
gw
);

3478 
	`shadow_aud™_bËs
(
v
);

3479 
	`shadow_uÆock
(
d
);

3481 
	`this_ıu
(
Œaû_emuÏ‹_wr™e_v®
) = 0;

3483 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3484 
—¾y_emuÏtiÚ
:

3486 iàĞ
	`is_hvm_domaš
(
d
) )

3495 iàĞ
	`uÆik–y
(
	`hvm_ev’t_³ndšg
(
v
)) )

3497 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3498 iàĞ
ç¡_emul
 )

3500 
	`³rfc_šü
(
shadow_çuÉ_ç¡_emuÏ‹_ç
);

3501 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3504 
	`gd´štk
(
XENLOG_DEBUG
, "writeo…agetable duringƒvent "

3506 
va
, 
	`mâ_x
(
gmâ
));

3507 
	`sh_»move_shadows
(
v
, 
gmâ
, 0 , 1 );

3508 
	`Œaû_shadow_emuÏ‹_Ùh”
(
TRC_SHADOW_EMULATE_UNSHADOW_EVTINJ
,

3509 
va
, 
gâ
);

3510  
EXCRET_çuÉ_fixed
;

3514 
	`SHADOW_PRINTK
("emulate:ƒip=%#lxƒsp=%#lx\n",

3515 ()
»gs
->
e
, (ìegs->
e¥
);

3517 
emul_İs
 = 
	`shadow_š™_emuÏtiÚ
(&
emul_ùxt
, 
»gs
);

3519 
r
 = 
	`x86_emuÏ‹
(&
emul_ùxt
.
ùxt
, 
emul_İs
);

3526 iàĞ
r
 =ğ
X86EMUL_UNHANDLEABLE
 )

3528 
	`³rfc_šü
(
shadow_çuÉ_emuÏ‹_çed
);

3529 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3530 iàĞ
ç¡_emul
 )

3532 
	`³rfc_šü
(
shadow_çuÉ_ç¡_emuÏ‹_ç
);

3533 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3536 
	`SHADOW_PRINTK
("emulator failure, unshadowing mfn %#lx\n",

3537 
	`mâ_x
(
gmâ
));

3541 
	`shadow_»move_®l_shadows
(
v
, 
gmâ
);

3543 
	`Œaû_shadow_emuÏ‹_Ùh”
(
TRC_SHADOW_EMULATE_UNSHADOW_UNHANDLED
,

3544 
va
, 
gâ
);

3545 
emuÏ‹_dÚe
;

3548 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3557 iàĞ(
r
 =ğ
X86EMUL_OKAY
è&& 
	`sh_mâ_is_a_·ge_bË
(
gmâ
) )

3559 iàĞ!
ç¡_emul
 )

3561 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_äame
 = 
va
 >> 
PAGE_SHIFT
;

3562 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_emuÏ‹d_mâ
 = 
	`mâ_x
(
gmâ
);

3563 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 1;

3566 iàĞ
ç¡_emul
 )

3567 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3570 #ià
GUEST_PAGING_LEVELS
 == 3

3571 iàĞ
r
 =ğ
X86EMUL_OKAY
 ) {

3572 
i
, 
emuÏtiÚ_couÁ
=0;

3573 
	`this_ıu
(
Œaû_emuÏ‹_š™Ÿl_va
èğ
va
;

3576  
i
 = 0 ; i < 4 ; i++ )

3578 
	`shadow_cÚtšue_emuÏtiÚ
(&
emul_ùxt
, 
»gs
);

3579 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_was_±
 = 0;

3580 
r
 = 
	`x86_emuÏ‹
(&
emul_ùxt
.
ùxt
, 
emul_İs
);

3581 iàĞ
r
 =ğ
X86EMUL_OKAY
 )

3583 
emuÏtiÚ_couÁ
++;

3584 iàĞ
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_was_±
 )

3586 
	`³rfc_šü
(
shadow_em_ex_±
);

3587 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_EMULATION_2ND_PT_WRITTEN
);

3591 
	`³rfc_šü
(
shadow_em_ex_nÚ_±
);

3595 
	`³rfc_šü
(
shadow_em_ex_ç
);

3596 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_EMULATION_LAST_FAILED
);

3600 
	`this_ıu
(
Œaû_exŒa_emuÏtiÚ_couÁ
)=
emuÏtiÚ_couÁ
;

3604 
	`Œaû_shadow_emuÏ‹
(
gw
.
l1e
, 
va
);

3605 
emuÏ‹_dÚe
:

3606 
	`SHADOW_PRINTK
("emulated\n");

3607  
EXCRET_çuÉ_fixed
;

3609 
mmio
:

3610 iàĞ!
	`gue¡_mode
(
»gs
) )

3611 
nÙ_a_shadow_çuÉ
;

3612 
	`³rfc_šü
(
shadow_çuÉ_mmio
);

3613 
	`sh_aud™_gw
(
v
, &
gw
);

3614 
	`SHADOW_PRINTK
("mmiØ%#"
PRI·ddr
"\n", 
g·
);

3615 
	`shadow_aud™_bËs
(
v
);

3616 
	`»£t_—¾y_unshadow
(
v
);

3617 
	`shadow_uÆock
(
d
);

3618 
	`Œaû_shadow_g’
(
TRC_SHADOW_MMIO
, 
va
);

3619  (
	`hªdË_mmio_w™h_Œª¦©iÚ
(
va
, 
g·
 >> 
PAGE_SHIFT
)

3620 ? 
EXCRET_çuÉ_fixed
 : 0);

3622 
nÙ_a_shadow_çuÉ
:

3623 
	`sh_aud™_gw
(
v
, &
gw
);

3624 
	`SHADOW_PRINTK
("not‡ shadow fault\n");

3625 
	`shadow_aud™_bËs
(
v
);

3626 
	`»£t_—¾y_unshadow
(
v
);

3627 
	`shadow_uÆock
(
d
);

3629 
´İag©e
:

3630 
	`Œaû_nÙ_shadow_çuÉ
(
gw
.
l1e
, 
va
);

3633 
	}
}

3637 
	$sh_švÍg
(
vıu
 *
v
, 
va
)

3642 
mâ_t
 
¦1mâ
;

3643 
shadow_l2e_t
 
¦2e
;

3645 
	`³rfc_šü
(
shadow_švÍg
);

3647 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

3649 
	`vb_æush
(
v
);

3652 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


3653 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

3659 #ià
SHADOW_PAGING_LEVELS
 == 4

3661 
shadow_l3e_t
 
¦3e
;

3662 iàĞ!(
	`shadow_l4e_g‘_æags
(

3663 
	`sh_lš—r_l4_bË
(
v
)[
	`shadow_l4_lš—r_off£t
(
va
)])

3664 & 
_PAGE_PRESENT
) )

3669 iàĞ
	`__cİy_äom_u£r
(&
¦3e
, (
	`sh_lš—r_l3_bË
(
v
)

3670 + 
	`shadow_l3_lš—r_off£t
(
va
)),

3671  (
¦3e
)) != 0 )

3673 
	`³rfc_šü
(
shadow_švÍg_çuÉ
);

3676 iàĞ(!
	`shadow_l3e_g‘_æags
(
¦3e
è& 
_PAGE_PRESENT
) )

3680 iàĞ!(
	`l3e_g‘_æags
(
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
[
	`shadow_l3_lš—r_off£t
(
va
)])

3681 & 
_PAGE_PRESENT
) )

3688 iàĞ
	`__cİy_äom_u£r
(&
¦2e
,

3689 
	`sh_lš—r_l2_bË
(
v
è+ 
	`shadow_l2_lš—r_off£t
(
va
),

3690  (
¦2e
)) != 0 )

3692 
	`³rfc_šü
(
shadow_švÍg_çuÉ
);

3699 iàĞ!(
	`shadow_l2e_g‘_æags
(
¦2e
è& 
_PAGE_PRESENT
) )

3706 
¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(
¦2e
);

3707 iàĞ
	`mâ_to_·ge
(
¦1mâ
)->
u
.
sh
.
ty³


3708 =ğ
SH_ty³_æ1_shadow
 )

3710 
	`æush_b_loÿl
();

3714 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

3717 
mâ_t
 
gl1mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦1mâ
));

3718 
·ge_šfo
 *
pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

3719 iàĞ
	`mâ_v®id
(
gl1mâ
)

3720 && 
	`·ge_is_out_of_sync
(
pg
) )

3724 
	`shadow_lock
(
v
->
domaš
);

3730 iàĞ
	`__cİy_äom_u£r
(&
¦2e
,

3731 
	`sh_lš—r_l2_bË
(
v
)

3732 + 
	`shadow_l2_lš—r_off£t
(
va
),

3733  (
¦2e
)) != 0 )

3735 
	`³rfc_šü
(
shadow_švÍg_çuÉ
);

3736 
	`shadow_uÆock
(
v
->
domaš
);

3740 iàĞ!(
	`shadow_l2e_g‘_æags
(
¦2e
è& 
_PAGE_PRESENT
) )

3742 
	`shadow_uÆock
(
v
->
domaš
);

3746 
¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(
¦2e
);

3747 
gl1mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦1mâ
));

3748 
pg
 = 
	`mâ_to_·ge
(
gl1mâ
);

3750 iàĞ
	`lik–y
(
	`sh_mâ_is_a_·ge_bË
(
gl1mâ
)

3751 && 
	`·ge_is_out_of_sync
(
pg
) ) )

3753 
shadow_l1e_t
 *
¦1
;

3754 
¦1
 = 
	`sh_lš—r_l1_bË
(
v
è+ 
	`shadow_l1_lš—r_off£t
(
va
);

3756 (è
	`shadow_£t_l1e
(
v
, 
¦1
, 
	`shadow_l1e_em±y
(),

3757 
p2m_šv®id
, 
¦1mâ
);

3759 
	`shadow_uÆock
(
v
->
domaš
);

3767 
	}
}

3771 
	$sh_gva_to_gâ
(
vıu
 *
v
, 
va
, 
ušt32_t
 *
pãc
)

3775 
w®k_t
 
gw
;

3776 
gâ_t
 
gâ
;

3777 
ušt32_t
 
missšg
;

3779 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

3781 
vb_gâ
 = 
	`vb_lookup
(
v
, 
va
, 
pãc
[0]);

3782 iàĞ
	`VALID_GFN
(
vb_gâ
) )

3783  
vb_gâ
;

3786 iàĞ(
missšg
 = 
	`sh_w®k_gue¡_bËs
(
v
, 
va
, &
gw
, 
pãc
[0])) != 0 )

3788 iàĞ(
missšg
 & 
_PAGE_PRESENT
) )

3789 
pãc
[0] &ğ~
PFEC_·ge_´e£Á
;

3790 iàĞ
missšg
 & 
_PAGE_INVALID_BITS
 )

3791 
pãc
[0] |ğ
PFEC_»£rved_b™
;

3792  
INVALID_GFN
;

3794 
gâ
 = 
	`gue¡_w®k_to_gâ
(&
gw
);

3796 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

3798 
	`vb_š£¹
(
v
, 
va
 >> 
PAGE_SHIFT
, 
	`gâ_x
(
gâ
), 
pãc
[0]);

3801  
	`gâ_x
(
gâ
);

3802 
	}
}

3805 
šlše
 

3806 
	$sh_upd©e_lš—r_’Œ›s
(
vıu
 *
v
)

3809 
domaš
 *
d
 = 
v
->domain;

3842 iàĞ
	`shadow_mode_ex‹º®
(
d
)

3843 && 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
mÚ™Ü_bË
) == 0 )

3846 #ià(
CONFIG_PAGING_LEVELS
 =ğ4è&& (
SHADOW_PAGING_LEVELS
 == 4)

3852 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

3855 iàĞ
v
 =ğ
cu¼’t
 )

3857 
__lš—r_l4_bË
[
	`l4_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)] =

3858 
	`l4e_äom_pâ
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[0]),

3859 
__PAGE_HYPERVISOR
);

3863 
l4_pg’Œy_t
 *
ml4e
;

3864 
ml4e
 = 
	`sh_m­_domaš_·ge
(
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
));

3865 
ml4e
[
	`l4_bË_off£t
(
SH_LINEAR_PT_VIRT_START
)] =

3866 
	`l4e_äom_pâ
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[0]),

3867 
__PAGE_HYPERVISOR
);

3868 
	`sh_unm­_domaš_·ge
(
ml4e
);

3872 #–ià(
CONFIG_PAGING_LEVELS
 =ğ4è&& (
SHADOW_PAGING_LEVELS
 == 3)

3884 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

3888 
shadow_l3e_t
 *
¦3e
;

3889 
l2_pg’Œy_t
 *
ml2e
;

3890 
i
;

3893 iàĞ
v
 =ğ
cu¼’t
 )

3894 
ml2e
 = 
__lš—r_l2_bË


3895 + 
	`l2_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
);

3898 
mâ_t
 
l3mâ
, 
l2mâ
;

3899 
l4_pg’Œy_t
 *
ml4e
;

3900 
l3_pg’Œy_t
 *
ml3e
;

3901 
lš—r_¦Ù
 = 
	`shadow_l4_bË_off£t
(
SH_LINEAR_PT_VIRT_START
);

3902 
ml4e
 = 
	`sh_m­_domaš_·ge
(
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
));

3904 
	`ASSERT
(
	`l4e_g‘_æags
(
ml4e
[
lš—r_¦Ù
]è& 
_PAGE_PRESENT
);

3905 
l3mâ
 = 
	`_mâ
(
	`l4e_g‘_pâ
(
ml4e
[
lš—r_¦Ù
]));

3906 
ml3e
 = 
	`sh_m­_domaš_·ge
(
l3mâ
);

3907 
	`sh_unm­_domaš_·ge
(
ml4e
);

3909 
	`ASSERT
(
	`l3e_g‘_æags
(
ml3e
[0]è& 
_PAGE_PRESENT
);

3910 
l2mâ
 = 
	`_mâ
(
	`l3e_g‘_pâ
(
ml3e
[0]));

3911 
ml2e
 = 
	`sh_m­_domaš_·ge
(
l2mâ
);

3912 
	`sh_unm­_domaš_·ge
(
ml3e
);

3916 
¦3e
 = 
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
;

3918  
i
 = 0; i < 
SHADOW_L3_PAGETABLE_ENTRIES
; i++ )

3920 
ml2e
[
i
] =

3921 (
	`shadow_l3e_g‘_æags
(
¦3e
[
i
]è& 
_PAGE_PRESENT
)

3922 ? 
	`l2e_äom_pâ
(
	`mâ_x
(
	`shadow_l3e_g‘_mâ
(
¦3e
[
i
])),

3923 
__PAGE_HYPERVISOR
)

3924 : 
	`l2e_em±y
();

3927 iàĞ
v
 !ğ
cu¼’t
 )

3928 
	`sh_unm­_domaš_·ge
(
ml2e
);

3931 
	`domaš_üash
(
d
);

3933 #–ià
CONFIG_PAGING_LEVELS
 == 3

3949 
l2_pg’Œy_t
 *
l2e
, 
Ãw_l2e
;

3950 
shadow_l3e_t
 *
gue¡_l3e
 = 
NULL
, *
shadow_l3e
;

3951 
i
;

3952 
unm­_l2e
 = 0;

3954 #ià
GUEST_PAGING_LEVELS
 == 2

3957 
	`BUG_ON
(!
	`shadow_mode_ex‹º®
(
d
));

3958 
shadow_l3e
 = (
shadow_l3e_t
 *)&
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
;

3962 
shadow_l3e
 = (
shadow_l3e_t
 *)&
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
;

3963 
gue¡_l3e
 = (
gue¡_l3e_t
 *)&
v
->
¬ch
.
·gšg
.
shadow
.
gl3e
;

3968 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

3970 iàĞ
v
 =ğ
cu¼’t
 )

3974 
l2e
 = 
__lš—r_l2_bË
 + (3 * 
L2_PAGETABLE_ENTRIES
);

3979 
l3_pg’Œy_t
 *
l3e
;

3980 
l3e
 = 
	`sh_m­_domaš_·ge
(

3981 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
mÚ™Ü_bË
));

3982 
	`ASSERT
(
	`l3e_g‘_æags
(
l3e
[3]è& 
_PAGE_PRESENT
);

3983 
l2e
 = 
	`sh_m­_domaš_·ge
(
	`_mâ
(
	`l3e_g‘_pâ
(
l3e
[3])));

3984 
unm­_l2e
 = 1;

3985 
	`sh_unm­_domaš_·ge
(
l3e
);

3991 
	`ASSERT
(
	`shadow_l3e_g‘_æags
(
shadow_l3e
[3]è& 
_PAGE_PRESENT
);

3992 
l2e
 = 
	`sh_m­_domaš_·ge
(
	`shadow_l3e_g‘_mâ
(
shadow_l3e
[3]));

3993 
unm­_l2e
 = 1;

3998 iàĞ!
	`shadow_mode_Œª¦©e
(
d
) )

4000  
i
 = 0; i < 
SHADOW_L3_PAGETABLE_ENTRIES
; i++ )

4002 
Ãw_l2e
 =

4003 ((
	`shadow_l3e_g‘_æags
(
gue¡_l3e
[
i
]è& 
_PAGE_PRESENT
)

4004 ? 
	`l2e_äom_pâ
(
	`mâ_x
(
	`shadow_l3e_g‘_mâ
(
gue¡_l3e
[
i
])),

4005 
__PAGE_HYPERVISOR
)

4006 : 
	`l2e_em±y
());

4007 
	`§ã_wr™e_’Œy
(

4008 &
l2e
[
	`l2_bË_off£t
(
LINEAR_PT_VIRT_START
è+ 
i
],

4009 &
Ãw_l2e
);

4014  
i
 = 0; i < 
SHADOW_L3_PAGETABLE_ENTRIES
; i++ )

4016 
Ãw_l2e
 = (
	`shadow_l3e_g‘_æags
(
shadow_l3e
[
i
]è& 
_PAGE_PRESENT
)

4017 ? 
	`l2e_äom_pâ
(
	`mâ_x
(
	`shadow_l3e_g‘_mâ
(
shadow_l3e
[
i
])),

4018 
__PAGE_HYPERVISOR
)

4019 : 
	`l2e_em±y
();

4020 
	`§ã_wr™e_’Œy
(

4021 &
l2e
[
	`l2_bË_off£t
(
SH_LINEAR_PT_VIRT_START
è+ 
i
],

4022 &
Ãw_l2e
);

4025 iàĞ
unm­_l2e
 )

4026 
	`sh_unm­_domaš_·ge
(
l2e
);

4030 #”rÜ 
this
 
should
 
nÙ
 
h­³n


4033 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

4045 
	`æush_b_loÿl
();

4047 
	}
}

4054 
	$sh_d‘ach_Şd_bËs
(
vıu
 *
v
)

4056 
mâ_t
 
smâ
;

4057 
i
 = 0;

4063 #ià
GUEST_PAGING_LEVELS
 == 3

4065 
	`ASSERT
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 =ğ
NULL
);

4067 iàĞ
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 )

4069 
domaš
 *
d
 = 
v
->domain;

4070 iàĞ
	`shadow_mode_ex‹º®
(
d
è|| 
	`shadow_mode_Œª¦©e
(d) )

4071 
	`sh_unm­_domaš_·ge_glob®
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
);

4072 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 = 
NULL
;

4081 #ià
GUEST_PAGING_LEVELS
 == 3

4083  
i
 = 0 ; i < 4 ; i++ )

4086 
smâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[
i
]);

4087 iàĞ
	`mâ_x
(
smâ
) )

4088 
	`sh_put_»f
(
v
, 
smâ
, 0);

4089 
v
->
¬ch
.
shadow_bË
[
i
] = 
	`·g‘abË_nuÎ
();

4091 
	}
}

4095 
	$sh_£t_tİËv–_shadow
(
vıu
 *
v
,

4096 
¦Ù
,

4097 
mâ_t
 
gmâ
,

4098 
roÙ_ty³
)

4100 
mâ_t
 
smâ
;

4101 
·g‘abË_t
 
Şd_’Œy
, 
Ãw_’Œy
;

4103 
domaš
 *
d
 = 
v
->domain;

4106 
Şd_’Œy
 = 
v
->
¬ch
.
shadow_bË
[
¦Ù
];

4109 iàĞ!
	`mâ_v®id
(
gmâ
) )

4111 
Ãw_’Œy
 = 
	`·g‘abË_nuÎ
();

4112 
š¡®l_Ãw_’Œy
;

4116 
smâ
 = 
	`g‘_shadow_¡©us
(
v
, 
gmâ
, 
roÙ_ty³
);

4117 iàĞ!
	`mâ_v®id
(
smâ
) )

4120 
	`shadow_´—Îoc
(
d
, 
roÙ_ty³
, 1);

4122 
smâ
 = 
	`sh_make_shadow
(
v
, 
gmâ
, 
roÙ_ty³
);

4124 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

4127 iàĞ
	`sh_pš
(
v
, 
smâ
) == 0 )

4129 
	`SHADOW_ERROR
("ÿn'ˆpš %#lx‡ tİËv– shadow\n", 
	`mâ_x
(
smâ
));

4130 
	`domaš_üash
(
v
->
domaš
);

4135 iàĞ!
	`sh_g‘_»f
(
v
, 
smâ
, 0) )

4137 
	`SHADOW_ERROR
("ÿn'ˆš¡®È%#lx‡ tİËv– shadow\n", 
	`mâ_x
(
smâ
));

4138 
	`domaš_üash
(
v
->
domaš
);

4141 
Ãw_’Œy
 = 
	`·g‘abË_äom_mâ
(
smâ
);

4143 
š¡®l_Ãw_’Œy
:

4145 
	`SHADOW_PRINTK
("%u/%u [%u] gmâ %#"
PRI_mâ
" smfn %#"PRI_mfn"\n",

4146 
GUEST_PAGING_LEVELS
, 
SHADOW_PAGING_LEVELS
, 
¦Ù
,

4147 
	`mâ_x
(
gmâ
), mâ_x(
	`·g‘abË_g‘_mâ
(
Ãw_’Œy
)));

4148 
v
->
¬ch
.
shadow_bË
[
¦Ù
] = 
Ãw_’Œy
;

4151 iàĞ!
	`·g‘abË_is_nuÎ
(
Şd_’Œy
) ) {

4152 
mâ_t
 
Şd_smâ
 = 
	`·g‘abË_g‘_mâ
(
Şd_’Œy
);

4156 iàĞ!
	`mâ_to_·ge
(
Şd_smâ
)->
u
.
sh
.
pšÃd
 && !
	`sh_pš
(
v
, old_smfn) )

4158 
	`SHADOW_ERROR
("ÿn'ˆ»-pš %#lx\n", 
	`mâ_x
(
Şd_smâ
));

4159 
	`domaš_üash
(
v
->
domaš
);

4161 
	`sh_put_»f
(
v
, 
Şd_smâ
, 0);

4163 
	}
}

4167 
	$sh_upd©e_ü3
(
vıu
 *
v
, 
do_lockšg
)

4179 
domaš
 *
d
 = 
v
->domain;

4180 
mâ_t
 
gmâ
;

4181 #ià
GUEST_PAGING_LEVELS
 == 3

4182 
gue¡_l3e_t
 *
gl3e
;

4183 
u32
 
gue¡_idx
=0;

4184 
i
;

4188 iàĞ!
	`is_hvm_domaš
(
d
è&& !
v
->
is_š™Ÿli£d
 )

4190 
	`ASSERT
(
v
->
¬ch
.
ü3
 == 0);

4194 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

4198 
	`shadow_»sync_cu¼’t_vıu
(
v
, 
do_lockšg
);

4201 iàĞ
do_lockšg
 ) 
	`shadow_lock
(
v
->
domaš
);

4203 
	`ASSERT
(
	`shadow_locked_by_me
(
v
->
domaš
));

4204 
	`ASSERT
(
v
->
¬ch
.
·gšg
.
mode
);

4210 #iâdeà
NDEBUG


4212 iàĞ
	`is_hvm_domaš
(
d
) )

4214 
	`ASSERT
(
	`shadow_mode_ex‹º®
(
d
));

4215 iàĞ
	`hvm_·gšg_’abËd
(
v
) )

4216 
	`ASSERT
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
));

4218 
	`ASSERT
(
v
->
¬ch
.
gue¡_bË
.
pâ


4219 =ğ
d
->
¬ch
.
·gšg
.
shadow
.
uÅaged_·g‘abË
.
pâ
);

4223 
	`SHADOW_PRINTK
("d=%u v=%u guest_table=%05lx\n",

4224 
d
->
domaš_id
, 
v
->
vıu_id
,

4225 ()
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
));

4227 #ià
GUEST_PAGING_LEVELS
 == 4

4228 iàĞ!(
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
è&& !
	`is_pv_32Ú64_vıu
(v) )

4229 
gmâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
gue¡_bË_u£r
);

4232 
gmâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
gue¡_bË
);

4238 #ià
GUEST_PAGING_LEVELS
 == 4

4239 iàĞ
	`shadow_mode_ex‹º®
(
d
è|| 
	`shadow_mode_Œª¦©e
(d) )

4241 iàĞ
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 )

4242 
	`sh_unm­_domaš_·ge_glob®
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
);

4243 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 = 
	`sh_m­_domaš_·ge_glob®
(
gmâ
);

4246 
	`BUG_ON
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 =ğ
NULL
);

4249 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 = 
__lš—r_l4_bË
;

4250 #–ià
GUEST_PAGING_LEVELS
 == 3

4254 
	`ASSERT
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 =ğ
NULL
);

4256 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

4258 
gue¡_idx
 = 
	`gue¡_šdex
((*)
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3]);

4261 
gue¡_idx
 = 0;

4265 
gue¡_idx
 &= ~3;

4267 
gl3e
 = ((
gue¡_l3e_t
 *)
	`sh_m­_domaš_·ge
(
gmâ
)è+ 
gue¡_idx
;

4268  
i
 = 0; i < 4 ; i++ )

4269 
v
->
¬ch
.
·gšg
.
shadow
.
gl3e
[
i
] = gl3e[i];

4270 
	`sh_unm­_domaš_·ge
(
gl3e
);

4271 #–ià
GUEST_PAGING_LEVELS
 == 2

4272 iàĞ
	`shadow_mode_ex‹º®
(
d
è|| 
	`shadow_mode_Œª¦©e
(d) )

4274 iàĞ
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 )

4275 
	`sh_unm­_domaš_·ge_glob®
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
);

4276 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 = 
	`sh_m­_domaš_·ge_glob®
(
gmâ
);

4279 
	`BUG_ON
(
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 =ğ
NULL
);

4282 
v
->
¬ch
.
·gšg
.
shadow
.
gue¡_vbË
 = 
__lš—r_l2_bË
;

4284 #”rÜ 
this
 
should
 
Ãv”
 
h­³n


4295 #ià
GUEST_PAGING_LEVELS
 == 2

4296 iàĞ
	`sh_»move_wr™e_acûss
(
v
, 
gmâ
, 2, 0) != 0 )

4297 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

4298 
	`sh_£t_tİËv–_shadow
(
v
, 0, 
gmâ
, 
SH_ty³_l2_shadow
);

4299 #–ià
GUEST_PAGING_LEVELS
 == 3

4303 
æush
 = 0;

4304 
gâ_t
 
gl2gâ
;

4305 
mâ_t
 
gl2mâ
;

4306 
p2m_ty³_t
 
p2mt
;

4307 
gue¡_l3e_t
 *
gl3e
 = (gue¡_l3e_t*)&
v
->
¬ch
.
·gšg
.
shadow
.gl3e;

4309  
i
 = 0; i < 4; i++ )

4311 iàĞ
	`gue¡_l3e_g‘_æags
(
gl3e
[
i
]è& 
_PAGE_PRESENT
 )

4313 
gl2gâ
 = 
	`gue¡_l3e_g‘_gâ
(
gl3e
[
i
]);

4314 
gl2mâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
d
), 
gl2gâ
, &
p2mt
);

4315 iàĞ
	`p2m_is_¿m
(
p2mt
) )

4316 
æush
 |ğ
	`sh_»move_wr™e_acûss
(
v
, 
gl2mâ
, 2, 0);

4319 iàĞ
æush
 )

4320 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

4322  
i
 = 0; i < 4; i++ )

4324 iàĞ
	`gue¡_l3e_g‘_æags
(
gl3e
[
i
]è& 
_PAGE_PRESENT
 )

4326 
gl2gâ
 = 
	`gue¡_l3e_g‘_gâ
(
gl3e
[
i
]);

4327 
gl2mâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
d
), 
gl2gâ
, &
p2mt
);

4328 iàĞ
	`p2m_is_¿m
(
p2mt
) )

4329 
	`sh_£t_tİËv–_shadow
(
v
, 
i
, 
gl2mâ
, (i == 3)

4330 ? 
SH_ty³_l2h_shadow


4331 : 
SH_ty³_l2_shadow
);

4333 
	`sh_£t_tİËv–_shadow
(
v
, 
i
, 
	`_mâ
(
INVALID_MFN
), 0);

4336 
	`sh_£t_tİËv–_shadow
(
v
, 
i
, 
	`_mâ
(
INVALID_MFN
), 0);

4339 #–ià
GUEST_PAGING_LEVELS
 == 4

4340 iàĞ
	`sh_»move_wr™e_acûss
(
v
, 
gmâ
, 4, 0) != 0 )

4341 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

4342 
	`sh_£t_tİËv–_shadow
(
v
, 0, 
gmâ
, 
SH_ty³_l4_shadow
);

4344 #”rÜ 
This
 
should
 
Ãv”
 
h­³n


4351 #ià
SHADOW_PAGING_LEVELS
 == 3

4353 
mâ_t
 
smâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[0]);

4354 
i
;

4355  
i
 = 0; i < 4; i++ )

4357 #ià
GUEST_PAGING_LEVELS
 == 2

4359 iàĞ
i
 != 0 )

4360 
smâ
 = 
	`sh_Ãxt_·ge
(smfn);

4363 
smâ
 = 
	`·g‘abË_g‘_mâ
(
v
->
¬ch
.
shadow_bË
[
i
]);

4365 
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
[
i
] =

4366 (
	`mâ_x
(
smâ
) == 0)

4367 ? 
	`shadow_l3e_em±y
()

4368 : 
	`shadow_l3e_äom_mâ
(
smâ
, 
_PAGE_PRESENT
);

4377 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

4379 
	`make_ü3
(
v
, 
	`·g‘abË_g‘_pâ
(v->
¬ch
.
mÚ™Ü_bË
));

4384 
	`BUG_ON
(
GUEST_PAGING_LEVELS
 !ğ
SHADOW_PAGING_LEVELS
);

4385 #ià
SHADOW_PAGING_LEVELS
 == 3

4389 
	`ASSERT
(
	`vœt_to_maddr
(&
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
) <= 0xffffffe0ULL);

4390 
v
->
¬ch
.
ü3
 = 
	`vœt_to_maddr
(&v->¬ch.
·gšg
.
shadow
.
l3bË
);

4393 
	`make_ü3
(
v
, 
	`·g‘abË_g‘_pâ
(v->
¬ch
.
shadow_bË
[0]));

4401 iàĞ
	`shadow_mode_ex‹º®
(
d
) )

4403 
	`ASSERT
(
	`is_hvm_domaš
(
d
));

4404 #ià
SHADOW_PAGING_LEVELS
 == 3

4406 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3] =

4407 
	`vœt_to_maddr
(&
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
);

4410 
v
->
¬ch
.
hvm_vıu
.
hw_ü
[3] =

4411 
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
shadow_bË
[0]);

4413 
	`hvm_upd©e_gue¡_ü
(
v
, 3);

4417 
	`sh_upd©e_lš—r_’Œ›s
(
v
);

4419 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

4421 
	`vb_æush
(
v
);

4424 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_EMULATION


4425 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_emul_ok
 = 0;

4429 iàĞ
do_lockšg
 ) 
	`shadow_uÆock
(
v
->
domaš
);

4431 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

4436 
	`shadow_sync_Ùh”_vıus
(
v
, 
do_lockšg
);

4439 
	}
}

4445 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC


4446 
	$sh_rm_wr™e_acûss_äom_¦1p
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

4447 
mâ_t
 
smâ
, 
off
)

4449 
r
;

4450 
shadow_l1e_t
 *
¦1p
, 
¦1e
;

4451 
·ge_šfo
 *
¥
;

4453 
	`ASSERT
(
	`mâ_v®id
(
gmâ
));

4454 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

4457 
v
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg


4458 ğ!!(
	`mâ_to_·ge
(
gmâ
)->
shadow_æags
 & 
SHF_·g‘abË_dyšg
);

4461 
¥
 = 
	`mâ_to_·ge
(
smâ
);

4463 iàĞ((
¥
->
couÁ_šfo
 & 
PGC_couÁ_mask
) != 0)

4464 || (
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_l1_shadow


4465 && 
¥
->
u
.
sh
.
ty³
 !ğ
SH_ty³_æ1_shadow
) )

4466 
ç
;

4468 
¦1p
 = 
	`sh_m­_domaš_·ge
(
smâ
);

4469 
¦1p
 +ğ
off
;

4470 
¦1e
 = *
¦1p
;

4471 iàĞ((
	`shadow_l1e_g‘_æags
(
¦1e
è& (
_PAGE_PRESENT
|
_PAGE_RW
))

4472 !ğ(
_PAGE_PRESENT
|
_PAGE_RW
))

4473 || (
	`mâ_x
(
	`shadow_l1e_g‘_mâ
(
¦1e
)è!ğmâ_x(
gmâ
)) )

4475 
	`sh_unm­_domaš_·ge
(
¦1p
);

4476 
ç
;

4480 
¦1e
 = 
	`shadow_l1e_»move_æags
(¦1e, 
_PAGE_RW
);

4481 
r
 = 
	`shadow_£t_l1e
(
v
, 
¦1p
, 
¦1e
, 
p2m_¿m_rw
, 
smâ
);

4482 
	`ASSERT
Ğ!(
r
 & 
SHADOW_SET_ERROR
) );

4484 
	`sh_unm­_domaš_·ge
(
¦1p
);

4485 
	`³rfc_šü
(
shadow_wr™—bË_h_7
);

4488 
ç
:

4489 
	`³rfc_šü
(
shadow_wr™—bË_h_8
);

4491 
	}
}

4494 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


4495 
	$sh_guess_wrm­
(
vıu
 *
v
, 
vaddr
, 
mâ_t
 
gmâ
)

4499 
shadow_l1e_t
 
¦1e
, *
¦1p
;

4500 
shadow_l2e_t
 *
¦2p
;

4501 
shadow_l3e_t
 *
¦3p
;

4502 #ià
SHADOW_PAGING_LEVELS
 >= 4

4503 
shadow_l4e_t
 *
¦4p
;

4505 
mâ_t
 
¦1mâ
;

4506 
r
;

4509 #ià
SHADOW_PAGING_LEVELS
 >= 4

4510 
¦4p
 = 
	`sh_lš—r_l4_bË
(
v
è+ 
	`shadow_l4_lš—r_off£t
(
vaddr
);

4511 iàĞ!(
	`shadow_l4e_g‘_æags
(*
¦4p
è& 
_PAGE_PRESENT
) )

4513 
¦3p
 = 
	`sh_lš—r_l3_bË
(
v
è+ 
	`shadow_l3_lš—r_off£t
(
vaddr
);

4514 iàĞ!(
	`shadow_l3e_g‘_æags
(*
¦3p
è& 
_PAGE_PRESENT
) )

4517 
¦3p
 = ((
shadow_l3e_t
 *è
v
->
¬ch
.
·gšg
.
shadow
.
l3bË
)

4518 + 
	`shadow_l3_lš—r_off£t
(
vaddr
);

4519 iàĞ!(
	`shadow_l3e_g‘_æags
(*
¦3p
è& 
_PAGE_PRESENT
) )

4522 
¦2p
 = 
	`sh_lš—r_l2_bË
(
v
è+ 
	`shadow_l2_lš—r_off£t
(
vaddr
);

4523 iàĞ!(
	`shadow_l2e_g‘_æags
(*
¦2p
è& 
_PAGE_PRESENT
) )

4525 
¦1p
 = 
	`sh_lš—r_l1_bË
(
v
è+ 
	`shadow_l1_lš—r_off£t
(
vaddr
);

4526 
¦1e
 = *
¦1p
;

4527 iàĞ((
	`shadow_l1e_g‘_æags
(
¦1e
è& (
_PAGE_PRESENT
|
_PAGE_RW
))

4528 !ğ(
_PAGE_PRESENT
|
_PAGE_RW
))

4529 || (
	`mâ_x
(
	`shadow_l1e_g‘_mâ
(
¦1e
)è!ğmâ_x(
gmâ
)) )

4533 
¦1mâ
 = 
	`shadow_l2e_g‘_mâ
(*
¦2p
);

4534 
¦1e
 = 
	`shadow_l1e_»move_æags
(¦1e, 
_PAGE_RW
);

4535 
r
 = 
	`shadow_£t_l1e
(
v
, 
¦1p
, 
¦1e
, 
p2m_¿m_rw
, 
¦1mâ
);

4536 iàĞ
r
 & 
SHADOW_SET_ERROR
 ) {

4541 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_WRMAP_GUESS_FOUND
);

4543 
	}
}

4546 
	$sh_rm_wr™e_acûss_äom_l1
(
vıu
 *
v
, 
mâ_t
 
¦1mâ
,

4547 
mâ_t
 
»adÚly_mâ
)

4550 
shadow_l1e_t
 *
¦1e
;

4551 
dÚe
 = 0;

4552 
æags
;

4553 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


4554 
mâ_t
 
ba£_¦1mâ
 = 
¦1mâ
;

4557 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1e
, 0, 
dÚe
,

4559 
æags
 = 
	`shadow_l1e_g‘_æags
(*
¦1e
);

4560 iàĞ(
æags
 & 
_PAGE_PRESENT
)

4561 && (
æags
 & 
_PAGE_RW
)

4562 && (
	`mâ_x
(
	`shadow_l1e_g‘_mâ
(*
¦1e
)è=ğmâ_x(
»adÚly_mâ
)) )

4564 
shadow_l1e_t
 
ro_¦1e
 = 
	`shadow_l1e_»move_æags
(*
¦1e
, 
_PAGE_RW
);

4565 (è
	`shadow_£t_l1e
(
v
, 
¦1e
, 
ro_¦1e
, 
p2m_¿m_rw
, 
¦1mâ
);

4566 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


4568 
v
->
¬ch
.
·gšg
.
shadow
.
Ï¡_wr™—bË_±e_smâ
 = 
	`mâ_x
(
ba£_¦1mâ
);

4570 iàĞ(
	`mâ_to_·ge
(
»adÚly_mâ
)->
u
.
šu£
.
ty³_šfo


4571 & 
PGT_couÁ_mask
) == 0 )

4573 
dÚe
 = 1;

4576  
dÚe
;

4577 
	}
}

4580 
	$sh_rm_m­pšgs_äom_l1
(
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
rg‘_mâ
)

4583 
shadow_l1e_t
 *
¦1e
;

4584 
dÚe
 = 0;

4585 
æags
;

4587 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1e
, 0, 
dÚe
,

4589 
æags
 = 
	`shadow_l1e_g‘_æags
(*
¦1e
);

4590 iàĞ(
æags
 & 
_PAGE_PRESENT
)

4591 && (
	`mâ_x
(
	`shadow_l1e_g‘_mâ
(*
¦1e
)è=ğmâ_x(
rg‘_mâ
)) )

4593 (è
	`shadow_£t_l1e
(
v
, 
¦1e
, 
	`shadow_l1e_em±y
(),

4594 
p2m_šv®id
, 
¦1mâ
);

4595 iàĞ(
	`mâ_to_·ge
(
rg‘_mâ
)->
couÁ_šfo
 & 
PGC_couÁ_mask
) == 0 )

4597 
dÚe
 = 1;

4600  
dÚe
;

4601 
	}
}

4606 
	$sh_ş—r_shadow_’Œy
(
vıu
 *
v
, *
•
, 
mâ_t
 
smâ
)

4609  
	`mâ_to_·ge
(
smâ
)->
u
.
sh
.
ty³
 )

4611 
SH_ty³_l1_shadow
:

4612 (è
	`shadow_£t_l1e
(
v
, 
•
, 
	`shadow_l1e_em±y
(), 
p2m_šv®id
, 
smâ
);

4614 
SH_ty³_l2_shadow
:

4615 #ià
GUEST_PAGING_LEVELS
 >= 3

4616 
SH_ty³_l2h_shadow
:

4618 (è
	`shadow_£t_l2e
(
v
, 
•
, 
	`shadow_l2e_em±y
(), 
smâ
);

4620 #ià
GUEST_PAGING_LEVELS
 >= 4

4621 
SH_ty³_l3_shadow
:

4622 (è
	`shadow_£t_l3e
(
v
, 
•
, 
	`shadow_l3e_em±y
(), 
smâ
);

4624 
SH_ty³_l4_shadow
:

4625 (è
	`shadow_£t_l4e
(
v
, 
•
, 
	`shadow_l4e_em±y
(), 
smâ
);

4628 : 
	`BUG
();

4630 
	}
}

4632 
	$sh_»move_l1_shadow
(
vıu
 *
v
, 
mâ_t
 
¦2mâ
, mâ_ˆ
¦1mâ
)

4635 
shadow_l2e_t
 *
¦2e
;

4636 
dÚe
 = 0;

4637 
æags
;

4639 
	`SHADOW_FOREACH_L2E
(
¦2mâ
, 
¦2e
, 0, 
dÚe
, 
v
->
domaš
,

4641 
æags
 = 
	`shadow_l2e_g‘_æags
(*
¦2e
);

4642 iàĞ(
æags
 & 
_PAGE_PRESENT
)

4643 && (
	`mâ_x
(
	`shadow_l2e_g‘_mâ
(*
¦2e
)è=ğmâ_x(
¦1mâ
)) )

4645 (è
	`shadow_£t_l2e
(
v
, 
¦2e
, 
	`shadow_l2e_em±y
(), 
¦2mâ
);

4646 iàĞ
	`mâ_to_·ge
(
¦1mâ
)->
u
.
sh
.
ty³
 == 0 )

4648 
dÚe
 = 1;

4651  
dÚe
;

4652 
	}
}

4654 #ià
GUEST_PAGING_LEVELS
 >= 4

4655 
	$sh_»move_l2_shadow
(
vıu
 *
v
, 
mâ_t
 
¦3mâ
, mâ_ˆ
¦2mâ
)

4658 
shadow_l3e_t
 *
¦3e
;

4659 
dÚe
 = 0;

4660 
æags
;

4662 
	`SHADOW_FOREACH_L3E
(
¦3mâ
, 
¦3e
, 0, 
dÚe
,

4664 
æags
 = 
	`shadow_l3e_g‘_æags
(*
¦3e
);

4665 iàĞ(
æags
 & 
_PAGE_PRESENT
)

4666 && (
	`mâ_x
(
	`shadow_l3e_g‘_mâ
(*
¦3e
)è=ğmâ_x(
¦2mâ
)) )

4668 (è
	`shadow_£t_l3e
(
v
, 
¦3e
, 
	`shadow_l3e_em±y
(), 
¦3mâ
);

4669 iàĞ
	`mâ_to_·ge
(
¦2mâ
)->
u
.
sh
.
ty³
 == 0 )

4671 
dÚe
 = 1;

4674  
dÚe
;

4675 
	}
}

4677 
	$sh_»move_l3_shadow
(
vıu
 *
v
, 
mâ_t
 
¦4mâ
, mâ_ˆ
¦3mâ
)

4680 
shadow_l4e_t
 *
¦4e
;

4681 
dÚe
 = 0;

4682 
æags
;

4684 
	`SHADOW_FOREACH_L4E
(
¦4mâ
, 
¦4e
, 0, 
dÚe
, 
v
->
domaš
,

4686 
æags
 = 
	`shadow_l4e_g‘_æags
(*
¦4e
);

4687 iàĞ(
æags
 & 
_PAGE_PRESENT
)

4688 && (
	`mâ_x
(
	`shadow_l4e_g‘_mâ
(*
¦4e
)è=ğmâ_x(
¦3mâ
)) )

4690 (è
	`shadow_£t_l4e
(
v
, 
¦4e
, 
	`shadow_l4e_em±y
(), 
¦4mâ
);

4691 iàĞ
	`mâ_to_·ge
(
¦3mâ
)->
u
.
sh
.
ty³
 == 0 )

4693 
dÚe
 = 1;

4696  
dÚe
;

4697 
	}
}

4705 #ià
GUEST_PAGING_LEVELS
 == 3

4706 
	$sh_·g‘abË_dyšg
(
vıu
 *
v
, 
·ddr_t
 
g·
)

4708 
i
 = 0;

4709 
æush
 = 0;

4710 
ç¡_·th
 = 0;

4711 
·ddr_t
 
gü3
 = 0;

4712 
mâ_t
 
smâ
, 
gmâ
;

4713 
p2m_ty³_t
 
p2mt
;

4714 *
gl3·
 = 
NULL
;

4715 
gue¡_l3e_t
 *
gl3e
 = 
NULL
;

4716 
·ddr_t
 
gl2a
 = 0;

4718 
	`shadow_lock
(
v
->
domaš
);

4720 
gü3
 = (
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3]);

4722 iàĞ
gü3
 =ğ
g·
 )

4723 
ç¡_·th
 = 1;

4725 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
	`_gâ
(
g·
 >> 
PAGE_SHIFT
), &
p2mt
);

4726 iàĞ!
	`mâ_v®id
(
gmâ
è|| !
	`p2m_is_¿m
(
p2mt
) )

4728 
	`´štk
(
XENLOG_DEBUG
 "sh_·g‘abË_dyšg: g·‚Ù v®id %"
PRI·ddr
"\n",

4729 
g·
);

4730 
out
;

4732 iàĞ!
ç¡_·th
 )

4734 
gl3·
 = 
	`sh_m­_domaš_·ge
(
gmâ
);

4735 
gl3e
 = (
gue¡_l3e_t
 *)(
gl3·
 + (()
g·
 & ~
PAGE_MASK
));

4737  
i
 = 0; i < 4; i++ )

4739 iàĞ
ç¡_·th
 )

4740 
smâ
 = 
	`_mâ
(
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
shadow_bË
[
i
]));

4744 
gl2a
 = 
	`gue¡_l3e_g‘_·ddr
(
gl3e
[
i
]);

4745 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
	`_gâ
(
gl2a
 >> 
PAGE_SHIFT
), &
p2mt
);

4746 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`mâ_x
(
gmâ
), 
SH_ty³_l2_·e_shadow
);

4749 iàĞ
	`mâ_v®id
(
smâ
) )

4751 
gmâ
 = 
	`_mâ
(
	`mâ_to_·ge
(
smâ
)->
v
.
sh
.
back
);

4752 
	`mâ_to_·ge
(
gmâ
)->
shadow_æags
 |ğ
SHF_·g‘abË_dyšg
;

4753 
	`shadow_unhook_m­pšgs
(
v
, 
smâ
, 1 );

4754 
æush
 = 1;

4757 iàĞ
æush
 )

4758 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

4763 
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg_İ
 = 1;

4765 
v
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg
 = 1;

4767 
out
:

4768 iàĞ!
ç¡_·th
 )

4769 
	`unm­_domaš_·ge
(
gl3·
);

4770 
	`shadow_uÆock
(
v
->
domaš
);

4771 
	}
}

4773 
	$sh_·g‘abË_dyšg
(
vıu
 *
v
, 
·ddr_t
 
g·
)

4775 
mâ_t
 
smâ
, 
gmâ
;

4776 
p2m_ty³_t
 
p2mt
;

4778 
	`shadow_lock
(
v
->
domaš
);

4780 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
	`_gâ
(
g·
 >> 
PAGE_SHIFT
), &
p2mt
);

4781 #ià
GUEST_PAGING_LEVELS
 == 2

4782 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`mâ_x
(
gmâ
), 
SH_ty³_l2_32_shadow
);

4784 
smâ
 = 
	`shadow_hash_lookup
(
v
, 
	`mâ_x
(
gmâ
), 
SH_ty³_l4_64_shadow
);

4786 iàĞ
	`mâ_v®id
(
smâ
) )

4788 
	`mâ_to_·ge
(
gmâ
)->
shadow_æags
 |ğ
SHF_·g‘abË_dyšg
;

4789 
	`shadow_unhook_m­pšgs
(
v
, 
smâ
, 1 );

4791 
	`æush_b_mask
(&
v
->
domaš
->
domaš_dœty_ıumask
);

4797 
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg_İ
 = 1;

4799 
v
->
¬ch
.
·gšg
.
shadow
.
·g‘abË_dyšg
 = 1;

4801 
	`shadow_uÆock
(
v
->
domaš
);

4802 
	}
}

4809 
	#BAD_GVA_TO_GFN
 (~0UL)

	)

4810 
	#BAD_GFN_TO_MFN
 (~1UL)

	)

4811 
	#READONLY_GFN
 (~2UL)

	)

4812 
mâ_t
 
	$emuÏ‹_gva_to_mâ
(
vıu
 *
v
,

4813 
vaddr
,

4814 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

4816 
gâ
;

4817 
mâ_t
 
mâ
;

4818 
p2m_ty³_t
 
p2mt
;

4819 
ušt32_t
 
pãc
 = 
PFEC_·ge_´e£Á
 | 
PFEC_wr™e_acûss
;

4820 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

4823 
gâ
 = 
	`sh_gva_to_gâ
(
v
, 
vaddr
, &
pãc
);

4824 iàĞ
gâ
 =ğ
INVALID_GFN
 )

4826 iàĞ
	`is_hvm_vıu
(
v
) )

4827 
	`hvm_šjeù_exû±iÚ
(
TRAP_·ge_çuÉ
, 
pãc
, 
vaddr
);

4829 
	`´İag©e_·ge_çuÉ
(
vaddr
, 
pãc
);

4830  
	`_mâ
(
BAD_GVA_TO_GFN
);

4835 iàĞ
	`shadow_locked_by_me
(
v
->
domaš
) )

4836 
mâ
 = 
	`gâ_to_mâ_qu”y
(
p2m
, 
	`_gâ
(
gâ
), &
p2mt
);

4838 
mâ
 = 
	`gâ_to_mâ
(
p2m
, 
	`_gâ
(
gâ
), &
p2mt
);

4840 iàĞ
	`p2m_is_»adÚly
(
p2mt
) )

4841  
	`_mâ
(
READONLY_GFN
);

4842 iàĞ!
	`p2m_is_¿m
(
p2mt
) )

4843  
	`_mâ
(
BAD_GFN_TO_MFN
);

4845 
	`ASSERT
(
	`mâ_v®id
(
mâ
));

4846 
v
->
¬ch
.
·gšg
.
Ï¡_wr™e_was_±
 = !!
	`sh_mâ_is_a_·ge_bË
(
mâ
);

4847  
mâ
;

4848 
	}
}

4852 
	#MAPPING_UNHANDLEABLE
 ((*)()
X86EMUL_UNHANDLEABLE
)

	)

4853 
	#MAPPING_EXCEPTION
 ((*)()
X86EMUL_EXCEPTION
)

	)

4854 
	#MAPPING_SILENT_FAIL
 ((*)()
X86EMUL_OKAY
)

	)

4855 
	#emuÏ‹_m­_de¡_çed
(
rc
è(()Ôcè<ğ3)

	)

4856 *
	$emuÏ‹_m­_de¡
(
vıu
 *
v
,

4857 
vaddr
,

4858 
u32
 
by‹s
,

4859 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

4861 
off£t
;

4862 *
m­
 = 
NULL
;

4864 
sh_ùxt
->
mâ1
 = 
	`emuÏ‹_gva_to_mâ
(
v
, 
vaddr
, sh_ctxt);

4865 iàĞ!
	`mâ_v®id
(
sh_ùxt
->
mâ1
) )

4866  ((
	`mâ_x
(
sh_ùxt
->
mâ1
è=ğ
BAD_GVA_TO_GFN
) ?

4867 
MAPPING_EXCEPTION
 :

4868 (
	`mâ_x
(
sh_ùxt
->
mâ1
è=ğ
READONLY_GFN
) ?

4869 
MAPPING_SILENT_FAIL
 : 
MAPPING_UNHANDLEABLE
);

4871 #iâdeà
NDEBUG


4873 iàĞ
	`hvm_g‘_£g_»g
(
x86_£g_ss
, 
sh_ùxt
)->
©Œ
.
f›lds
.
d¶
 == 3 )

4875 
	`gd´štk
(
XENLOG_DEBUG
, "User-mode writeo…agetable„eached "

4877  
MAPPING_UNHANDLEABLE
;

4882 iàĞ
vaddr
 & (
by‹s
 - 1) )

4883 
	`sh_»move_shadows
(
v
, 
sh_ùxt
->
mâ1
, 0, 0 );

4885 iàĞ
	`lik–y
(((
vaddr
 + 
by‹s
 - 1è& 
PAGE_MASK
) == (vaddr & PAGE_MASK)) )

4888 
sh_ùxt
->
mâ2
 = 
	`_mâ
(
INVALID_MFN
);

4889 
m­
 = 
	`sh_m­_domaš_·ge
(
sh_ùxt
->
mâ1
è+ (
vaddr
 & ~
PAGE_MASK
);

4895 iàĞ!
	`is_hvm_vıu
(
v
) )

4896  
MAPPING_UNHANDLEABLE
;

4899 
sh_ùxt
->
mâ2
 = 
	`emuÏ‹_gva_to_mâ
(
v
, (
vaddr
 + 
by‹s
 - 1è& 
PAGE_MASK
,

4900 
sh_ùxt
);

4901 iàĞ!
	`mâ_v®id
(
sh_ùxt
->
mâ2
) )

4902  ((
	`mâ_x
(
sh_ùxt
->
mâ2
è=ğ
BAD_GVA_TO_GFN
) ?

4903 
MAPPING_EXCEPTION
 :

4904 (
	`mâ_x
(
sh_ùxt
->
mâ2
è=ğ
READONLY_GFN
) ?

4905 
MAPPING_SILENT_FAIL
 : 
MAPPING_UNHANDLEABLE
);

4908 
	`sh_»move_shadows
(
v
, 
sh_ùxt
->
mâ2
, 0, 0 );

4913 
	`ASSERT
(
	`is_hvm_vıu
(
v
));

4914 
m­
 = (*)
	`LDT_VIRT_START
(
v
);

4915 
off£t
 = 
	`l1_lš—r_off£t
((è
m­
);

4916 
	`l1e_wr™e
(&
__lš—r_l1_bË
[
off£t
],

4917 
	`l1e_äom_pâ
(
	`mâ_x
(
sh_ùxt
->
mâ1
), 
__PAGE_HYPERVISOR
));

4918 
	`l1e_wr™e
(&
__lš—r_l1_bË
[
off£t
 + 1],

4919 
	`l1e_äom_pâ
(
	`mâ_x
(
sh_ùxt
->
mâ2
), 
__PAGE_HYPERVISOR
));

4920 
	`æush_b_loÿl
();

4921 
m­
 +ğ(
vaddr
 & ~
PAGE_MASK
);

4924 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_SKIP_VERIFY
)

4927 
sh_ùxt
->
low_b™_was_ş—r
 = 
m­
 !ğ
NULL
 && !(*(
u8
 *)m­ & 
_PAGE_PRESENT
);

4930  
m­
;

4931 
	}
}

4935 
	$emuÏ‹_unm­_de¡
(
vıu
 *
v
,

4936 *
addr
,

4937 
u32
 
by‹s
,

4938 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

4940 
u32
 
b1
 = 
by‹s
, 
b2
 = 0, 
shæags
;

4942 
	`ASSERT
(
	`mâ_v®id
(
sh_ùxt
->
mâ1
));

4945 iàĞ
	`lik–y
(
by‹s
 >= 4)

4946 && (*(
u32
 *)
addr
 == 0)

4947 && ((è
addr
 & (( (
gue¡_š‹_t
)) - 1)) == 0 )

4948 
	`check_fÜ_—¾y_unshadow
(
v
, 
sh_ùxt
->
mâ1
);

4950 
	`»£t_—¾y_unshadow
(
v
);

4956 
shæags
 = 
	`mâ_to_·ge
(
sh_ùxt
->
mâ1
)->
shadow_æags
;

4957 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_SKIP_VERIFY
)

4958 iàĞ
sh_ùxt
->
low_b™_was_ş—r


4959 && !(*(
u8
 *)
addr
 & 
_PAGE_PRESENT
)

4960 && ((!(
shæags
 & 
SHF_32
)

4963 && (()
addr
 & 7) == 0

4964 && 
by‹s
 <= 8)

4966 (!(
shæags
 & (
SHF_PAE
|
SHF_64
))

4969 && (()
addr
 & 3) == 0

4970 && 
by‹s
 <= 4)) )

4973 
	`ASSERT
(!
	`mâ_v®id
(
sh_ùxt
->
mâ2
));

4978 iàĞ
	`uÆik–y
(
	`mâ_v®id
(
sh_ùxt
->
mâ2
)) )

4981 
b1
 = 
PAGE_SIZE
 - ((()
addr
è& ~
PAGE_MASK
);

4982 
b2
 = 
by‹s
 - 
b1
;

4983 
	`ASSERT
(
b2
 < 
by‹s
);

4985 iàĞ
	`lik–y
(
b1
 > 0) )

4986 
	`sh_v®id©e_gue¡_±_wr™e
(
v
, 
sh_ùxt
->
mâ1
, 
addr
, 
b1
);

4987 iàĞ
	`uÆik–y
(
b2
 > 0) )

4988 
	`sh_v®id©e_gue¡_±_wr™e
(
v
, 
sh_ùxt
->
mâ2
, 
addr
 + 
b1
, 
b2
);

4991 
	`·gšg_m¬k_dœty
(
v
->
domaš
, 
	`mâ_x
(
sh_ùxt
->
mâ1
));

4993 iàĞ
	`uÆik–y
(
	`mâ_v®id
(
sh_ùxt
->
mâ2
)) )

4995 
off£t
;

4996 
	`·gšg_m¬k_dœty
(
v
->
domaš
, 
	`mâ_x
(
sh_ùxt
->
mâ2
));

4998 
	`ASSERT
(((è
addr
 & 
PAGE_MASK
è=ğ
	`LDT_VIRT_START
(
v
));

4999 
off£t
 = 
	`l1_lš—r_off£t
((è
addr
);

5000 
	`l1e_wr™e
(&
__lš—r_l1_bË
[
off£t
], 
	`l1e_em±y
());

5001 
	`l1e_wr™e
(&
__lš—r_l1_bË
[
off£t
 + 1], 
	`l1e_em±y
());

5002 
	`æush_b_®l
();

5005 
	`sh_unm­_domaš_·ge
(
addr
);

5007 
	`©omic_šc
(&
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
gbË_dœty_v”siÚ
);

5008 
	}
}

5011 
	$sh_x86_emuÏ‹_wr™e
(
vıu
 *
v
, 
vaddr
, *
¤c
,

5012 
u32
 
by‹s
, 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

5014 *
addr
;

5017 iàĞ(
vaddr
 & (
by‹s
 - 1)è&& !
	`is_hvm_vıu
(
v
) )

5018  
X86EMUL_UNHANDLEABLE
;

5020 
addr
 = 
	`emuÏ‹_m­_de¡
(
v
, 
vaddr
, 
by‹s
, 
sh_ùxt
);

5021 iàĞ
	`emuÏ‹_m­_de¡_çed
(
addr
) )

5022  ()
addr
;

5024 
	`shadow_lock
(
v
->
domaš
);

5025 
	`memıy
(
addr
, 
¤c
, 
by‹s
);

5027 iàĞ
tb_š™_dÚe
 )

5029 #ià
GUEST_PAGING_LEVELS
 == 3

5030 iàĞ
vaddr
 =ğ
	`this_ıu
(
Œaû_emuÏ‹_š™Ÿl_va
) )

5031 
	`memıy
(&
	`this_ıu
(
Œaû_emuÏ‹_wr™e_v®
), 
¤c
, 
by‹s
);

5032 iàĞ(
vaddr
 & ~(0x7UL)è=ğ
	`this_ıu
(
Œaû_emuÏ‹_š™Ÿl_va
) )

5034 
	`TRACE_SHADOW_PATH_FLAG
(
TRCE_SFLAG_EMULATE_FULL_PT
);

5035 
	`memıy
(&
	`this_ıu
(
Œaû_emuÏ‹_wr™e_v®
),

5036 (*)(((è
addr
è& ~(0x7UL)), 
GUEST_PTE_SIZE
);

5039 
	`memıy
(&
	`this_ıu
(
Œaû_emuÏ‹_wr™e_v®
), 
¤c
, 
by‹s
);

5043 
	`emuÏ‹_unm­_de¡
(
v
, 
addr
, 
by‹s
, 
sh_ùxt
);

5044 
	`shadow_aud™_bËs
(
v
);

5045 
	`shadow_uÆock
(
v
->
domaš
);

5046  
X86EMUL_OKAY
;

5047 
	}
}

5050 
	$sh_x86_emuÏ‹_cmpxchg
(
vıu
 *
v
, 
vaddr
,

5051 
Şd
, 
Ãw
,

5052 
by‹s
, 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

5054 *
addr
;

5055 
´ev
;

5056 
rv
 = 
X86EMUL_OKAY
;

5059 iàĞ(
vaddr
 & (
by‹s
 - 1)è&& !
	`is_hvm_vıu
(
v
) )

5060  
X86EMUL_UNHANDLEABLE
;

5062 
addr
 = 
	`emuÏ‹_m­_de¡
(
v
, 
vaddr
, 
by‹s
, 
sh_ùxt
);

5063 iàĞ
	`emuÏ‹_m­_de¡_çed
(
addr
) )

5064  ()
addr
;

5066 
	`shadow_lock
(
v
->
domaš
);

5067  
by‹s
 )

5069 1: 
´ev
 = 
	`cmpxchg
(((
u8
 *)
addr
), 
Şd
, 
Ãw
); ;

5070 2: 
´ev
 = 
	`cmpxchg
(((
u16
 *)
addr
), 
Şd
, 
Ãw
); ;

5071 4: 
´ev
 = 
	`cmpxchg
(((
u32
 *)
addr
), 
Şd
, 
Ãw
); ;

5072 8: 
´ev
 = 
	`cmpxchg
(((
u64
 *)
addr
), 
Şd
, 
Ãw
); ;

5074 
	`SHADOW_PRINTK
("cmpxchg oàsiz%˜i nÙ suµÜ‹d\n", 
by‹s
);

5075 
´ev
 = ~
Şd
;

5078 iàĞ
´ev
 !ğ
Şd
 )

5079 
rv
 = 
X86EMUL_CMPXCHG_FAILED
;

5081 
	`SHADOW_DEBUG
(
EMULATE
, "va %#lx was %#lxƒxpected %#lx"

5083 
vaddr
, 
´ev
, 
Şd
, 
Ãw
, *(*)
addr
, 
by‹s
);

5085 
	`emuÏ‹_unm­_de¡
(
v
, 
addr
, 
by‹s
, 
sh_ùxt
);

5086 
	`shadow_aud™_bËs
(
v
);

5087 
	`shadow_uÆock
(
v
->
domaš
);

5088  
rv
;

5089 
	}
}

5091 #ifdeà
__i386__


5093 
	$sh_x86_emuÏ‹_cmpxchg8b
(
vıu
 *
v
, 
vaddr
,

5094 
Şd_lo
, 
Şd_hi
,

5095 
Ãw_lo
, 
Ãw_hi
,

5096 
sh_emuÏ‹_ùxt
 *
sh_ùxt
)

5098 *
addr
;

5099 
u64
 
Şd
, 
Ãw
, 
´ev
;

5100 
rv
 = 
X86EMUL_OKAY
;

5103 iàĞ(
vaddr
 & 7è&& !
	`is_hvm_vıu
(
v
) )

5104  
X86EMUL_UNHANDLEABLE
;

5106 
addr
 = 
	`emuÏ‹_m­_de¡
(
v
, 
vaddr
, 8, 
sh_ùxt
);

5107 iàĞ
	`emuÏ‹_m­_de¡_çed
(
addr
) )

5108  ()
addr
;

5110 
Şd
 = (((
u64
è
Şd_hi
è<< 32è| (u64è
Şd_lo
;

5111 
Ãw
 = (((
u64
è
Ãw_hi
è<< 32è| (u64è
Ãw_lo
;

5113 
	`shadow_lock
(
v
->
domaš
);

5114 
´ev
 = 
	`cmpxchg
(((
u64
 *)
addr
), 
Şd
, 
Ãw
);

5116 iàĞ
´ev
 !ğ
Şd
 )

5117 
rv
 = 
X86EMUL_CMPXCHG_FAILED
;

5119 
	`emuÏ‹_unm­_de¡
(
v
, 
addr
, 8, 
sh_ùxt
);

5120 
	`shadow_aud™_bËs
(
v
);

5121 
	`shadow_uÆock
(
v
->
domaš
);

5122  
rv
;

5123 
	}
}

5129 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES


5131 
	#AUDIT_FAIL
(
_Ëv–
, 
_fmt
, 
_a
...) do { \

5132 
	`´štk
("Shadow %u-on-%u‡udit failed‡t†evel %i, index %i\n" \

5133 "gl" #_Ëv– "mâ = %" 
PRI_mâ
 \

5134 " sl" #_Ëv– "mâ = %" 
PRI_mâ
 \

5136 " gl" #_Ëv– "ğ%" 
SH_PRI_g±e
 \

5137 " sl" #_Ëv– "ğ%" 
SH_PRI_±e
 "\nE¼Ü: " 
_fmt
 "\n", \

5138 
GUEST_PAGING_LEVELS
, 
SHADOW_PAGING_LEVELS
, \

5139 
_Ëv–
, 
	`gue¡_šdex
(
gl
 ## _Ëv– ## 
e
), \

5140 
	`mâ_x
(
gl
 ## 
_Ëv–
 ## 
mâ
), mâ_x(
¦
 ## _level ## mfn), \

5141 
gl
 ## 
_Ëv–
 ## 
e
, 
¦
 ## _level ##ƒ, \

5142 
gl
 ## 
_Ëv–
 ## 
e
->
l
 ## _Ëv–, 
¦
 ## _level ##ƒ->l ## _level, \

5143 ##
_a
); \

5144 
	`BUG
(); \

5145 
dÚe
 = 1; \

5146 } 0)

	)

5148 
	#AUDIT_FAIL_MIN
(
_Ëv–
, 
_fmt
, 
_a
...) do { \

5149 
	`´štk
("Shadow %u-on-%u‡udit failed‡t†evel %i\n" \

5150 "gl" #_Ëv– "mâ = %" 
PRI_mâ
 \

5151 " sl" #_Ëv– "mâ = %" 
PRI_mâ
 \

5152 " E¼Ü: " 
_fmt
 "\n", \

5153 
GUEST_PAGING_LEVELS
, 
SHADOW_PAGING_LEVELS
, \

5154 
_Ëv–
, \

5155 
	`mâ_x
(
gl
 ## 
_Ëv–
 ## 
mâ
), mâ_x(
¦
 ## _level ## mfn), \

5156 ##
_a
); \

5157 
	`BUG
(); \

5158 
dÚe
 = 1; \

5159 } 0)

	)

5161 * 
	$sh_aud™_æags
(
vıu
 *
v
, 
Ëv–
,

5162 
gæags
, 
sæags
)

5165 iàĞ(
sæags
 & 
_PAGE_PRESENT
è&& !(
gæags
 & _PAGE_PRESENT) )

5167 iàĞ(
sæags
 & 
_PAGE_GLOBAL
è&& !
	`is_hvm_vıu
(
v
) )

5169 iàĞ
Ëv–
 =ğ2 && (
sæags
 & 
_PAGE_PSE
) )

5171 #ià
SHADOW_PAGING_LEVELS
 == 3

5172 iàĞ
Ëv–
 =ğ3 )  
NULL
;

5174 iàĞ(
sæags
 & 
_PAGE_PRESENT
è&& !(
gæags
 & 
_PAGE_ACCESSED
) )

5176 iàĞ(
Ëv–
 =ğ1 || (Ëv– =ğ2 && (
gæags
 & 
_PAGE_PSE
)))

5177 && ((
sæags
 & 
_PAGE_RW
è&& !(
gæags
 & 
_PAGE_DIRTY
)) )

5179 iàĞ(
sæags
 & 
_PAGE_USER
è!ğ(
gæags
 & _PAGE_USER) )

5181 iàĞ(
sæags
 & 
_PAGE_NX_BIT
è!ğ(
gæags
 & _PAGE_NX_BIT) )

5183 iàĞ(
sæags
 & 
_PAGE_RW
è&& !(
gæags
 & _PAGE_RW) )

5185  
NULL
;

5186 
	}
}

5188 
	$sh_aud™_l1_bË
(
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
x
)

5190 
gue¡_l1e_t
 *
gl1e
, *
gp
;

5191 
shadow_l1e_t
 *
¦1e
;

5192 
mâ_t
 
mâ
, 
gmâ
, 
gl1mâ
;

5193 
gâ_t
 
gâ
;

5194 
p2m_ty³_t
 
p2mt
;

5195 *
s
;

5196 
dÚe
 = 0;

5199 
	`ASSERT
(
	`mâ_to_·ge
(
¦1mâ
)->
u
.
sh
.
h—d
);

5200 
gl1mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦1mâ
));

5202 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

5204 iàĞ
	`·ge_is_out_of_sync
(
	`mâ_to_·ge
(
gl1mâ
)) )

5206 
	`oos_aud™_hash_is_´e£Á
(
v
->
domaš
, 
gl1mâ
);

5211 
gl1e
 = 
gp
 = 
	`sh_m­_domaš_·ge
(
gl1mâ
);

5212 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1e
, &
gl1e
, 
dÚe
, {

5214 iàĞ
	`sh_l1e_is_magic
(*
¦1e
) )

5216 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_FAULT_PATH
)

5217 iàĞ
	`sh_l1e_is_gÅ
(*
¦1e
) )

5219 iàĞ
	`gue¡_l1e_g‘_æags
(*
gl1e
è& 
_PAGE_PRESENT
 )

5220 
	`AUDIT_FAIL
(1, "shadow is GNP magic but guest is…resent");

5224 
	`ASSERT
(
	`sh_l1e_is_mmio
(*
¦1e
));

5225 
gâ
 = 
	`sh_l1e_mmio_g‘_gâ
(*
¦1e
);

5226 iàĞ
	`gâ_x
(
gâ
è!ğgâ_x(
	`gue¡_l1e_g‘_gâ
(*
gl1e
)) )

5227 
	`AUDIT_FAIL
(1, "shadow MMIO gâ i %" 
SH_PRI_gâ


5228 " buˆgue¡ gâ i %" 
SH_PRI_gâ
,

5229 
	`gâ_x
(
gâ
),

5230 
	`gâ_x
(
	`gue¡_l1e_g‘_gâ
(*
gl1e
)));

5236 
s
 = 
	`sh_aud™_æags
(
v
, 1, 
	`gue¡_l1e_g‘_æags
(*
gl1e
),

5237 
	`shadow_l1e_g‘_æags
(*
¦1e
));

5238 iàĞ
s
 ) 
	`AUDIT_FAIL
(1, "%s", s);

5240 iàĞ
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_MFNS
 )

5242 
gâ
 = 
	`gue¡_l1e_g‘_gâ
(*
gl1e
);

5243 
mâ
 = 
	`shadow_l1e_g‘_mâ
(*
¦1e
);

5244 
gmâ
 = 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(
v
->
domaš
), 
gâ
, &
p2mt
);

5245 iàĞ!
	`p2m_is_g¿Á
(
p2mt
è&& 
	`mâ_x
(
gmâ
è!ğmâ_x(
mâ
) )

5246 
	`AUDIT_FAIL
(1, "bad¿n¦©iÚ: gâ %" 
SH_PRI_gâ


5247 " --> %" 
PRI_mâ
 " != mfn %" PRI_mfn,

5248 
	`gâ_x
(
gâ
), 
	`mâ_x
(
gmâ
), mâ_x(
mâ
));

5252 
	`sh_unm­_domaš_·ge
(
gp
);

5253  
dÚe
;

5254 
	}
}

5256 
	$sh_aud™_æ1_bË
(
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
x
)

5258 
gue¡_l1e_t
 *
gl1e
, 
e
;

5259 
shadow_l1e_t
 *
¦1e
;

5260 
mâ_t
 
gl1mâ
 = 
	`_mâ
(
INVALID_MFN
);

5261 
f
;

5262 
dÚe
 = 0;

5265 
e
 = 
	`gue¡_l1e_äom_gâ
(
	`_gâ
(0), 0); 
gl1e
 = &e;

5266 
	`SHADOW_FOREACH_L1E
(
¦1mâ
, 
¦1e
, 0, 
dÚe
, {

5267 
f
 = 
	`shadow_l1e_g‘_æags
(*
¦1e
);

5268 
f
 &ğ~(
_PAGE_AVAIL0
|
_PAGE_AVAIL1
|
_PAGE_AVAIL2
);

5269 iàĞ!(
f
 == 0

5270 || 
f
 =ğ(
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_RW
|

5271 
_PAGE_ACCESSED
)

5272 || 
f
 =ğ(
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_ACCESSED
)

5273 || 
f
 =ğ(
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_RW
|

5274 
_PAGE_ACCESSED
|
_PAGE_DIRTY
)

5275 || 
f
 =ğ(
_PAGE_PRESENT
|
_PAGE_USER
|
_PAGE_ACCESSED
|
_PAGE_DIRTY
)

5276 || 
	`sh_l1e_is_magic
(*
¦1e
)) )

5277 
	`AUDIT_FAIL
(1, "fl1e has bad flags");

5280 
	}
}

5282 
	$sh_aud™_l2_bË
(
vıu
 *
v
, 
mâ_t
 
¦2mâ
, mâ_ˆ
x
)

5284 
gue¡_l2e_t
 *
gl2e
, *
gp
;

5285 
shadow_l2e_t
 *
¦2e
;

5286 
mâ_t
 
mâ
, 
gmâ
, 
gl2mâ
;

5287 
gâ_t
 
gâ
;

5288 
p2m_domaš
 *
p2m
 = 
	`p2m_g‘_ho¡p2m
(
v
->
domaš
);

5289 
p2m_ty³_t
 
p2mt
;

5290 *
s
;

5291 
dÚe
 = 0;

5294 
	`ASSERT
(
	`mâ_to_·ge
(
¦2mâ
)->
u
.
sh
.
h—d
);

5295 
gl2mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦2mâ
));

5297 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

5299 iàĞ
	`·ge_is_out_of_sync
(
	`mâ_to_·ge
(
gl2mâ
)) )

5300 
	`AUDIT_FAIL_MIN
(2, "gmâ %lx i ouˆoàsync", 
	`mâ_x
(
gl2mâ
));

5303 
gl2e
 = 
gp
 = 
	`sh_m­_domaš_·ge
(
gl2mâ
);

5304 
	`SHADOW_FOREACH_L2E
(
¦2mâ
, 
¦2e
, &
gl2e
, 
dÚe
, 
v
->
domaš
, {

5306 
s
 = 
	`sh_aud™_æags
(
v
, 2, 
	`gue¡_l2e_g‘_æags
(*
gl2e
),

5307 
	`shadow_l2e_g‘_æags
(*
¦2e
));

5308 iàĞ
s
 ) 
	`AUDIT_FAIL
(2, "%s", s);

5310 iàĞ
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_MFNS
 )

5312 
gâ
 = 
	`gue¡_l2e_g‘_gâ
(*
gl2e
);

5313 
mâ
 = 
	`shadow_l2e_g‘_mâ
(*
¦2e
);

5314 
gmâ
 = (
	`gue¡_l2e_g‘_æags
(*
gl2e
è& 
_PAGE_PSE
)

5315 ? 
	`g‘_æ1_shadow_¡©us
(
v
, 
gâ
)

5316 : 
	`g‘_shadow_¡©us
(
v
, 
	`gâ_to_mâ_qu”y
(
p2m
, 
gâ
, &
p2mt
),

5317 
SH_ty³_l1_shadow
);

5318 iàĞ
	`mâ_x
(
gmâ
è!ğmâ_x(
mâ
) )

5319 
	`AUDIT_FAIL
(2, "bad¿n¦©iÚ: gâ %" 
SH_PRI_gâ


5320 " (--> %" 
PRI_mâ
 ")"

5321 " --> %" 
PRI_mâ
 " != mfn %" PRI_mfn,

5322 
	`gâ_x
(
gâ
),

5323 (
	`gue¡_l2e_g‘_æags
(*
gl2e
è& 
_PAGE_PSE
) ? 0

5324 : 
	`mâ_x
(
	`gâ_to_mâ_qu”y
(
p2m
,

5325 
gâ
, &
p2mt
)), 
	`mâ_x
(
gmâ
), mâ_x(
mâ
));

5328 
	`sh_unm­_domaš_·ge
(
gp
);

5330 
	}
}

5332 #ià
GUEST_PAGING_LEVELS
 >= 4

5333 
	$sh_aud™_l3_bË
(
vıu
 *
v
, 
mâ_t
 
¦3mâ
, mâ_ˆ
x
)

5335 
gue¡_l3e_t
 *
gl3e
, *
gp
;

5336 
shadow_l3e_t
 *
¦3e
;

5337 
mâ_t
 
mâ
, 
gmâ
, 
gl3mâ
;

5338 
gâ_t
 
gâ
;

5339 
p2m_ty³_t
 
p2mt
;

5340 *
s
;

5341 
dÚe
 = 0;

5344 
	`ASSERT
(
	`mâ_to_·ge
(
¦3mâ
)->
u
.
sh
.
h—d
);

5345 
gl3mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦3mâ
));

5347 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

5349 iàĞ
	`·ge_is_out_of_sync
(
	`mâ_to_·ge
(
gl3mâ
)) )

5350 
	`AUDIT_FAIL_MIN
(3, "gmâ %lx i ouˆoàsync", 
	`mâ_x
(
gl3mâ
));

5353 
gl3e
 = 
gp
 = 
	`sh_m­_domaš_·ge
(
gl3mâ
);

5354 
	`SHADOW_FOREACH_L3E
(
¦3mâ
, 
¦3e
, &
gl3e
, 
dÚe
, {

5356 
s
 = 
	`sh_aud™_æags
(
v
, 3, 
	`gue¡_l3e_g‘_æags
(*
gl3e
),

5357 
	`shadow_l3e_g‘_æags
(*
¦3e
));

5358 iàĞ
s
 ) 
	`AUDIT_FAIL
(3, "%s", s);

5360 iàĞ
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_MFNS
 )

5362 
gâ
 = 
	`gue¡_l3e_g‘_gâ
(*
gl3e
);

5363 
mâ
 = 
	`shadow_l3e_g‘_mâ
(*
¦3e
);

5364 
gmâ
 = 
	`g‘_shadow_¡©us
(
v
, 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(v->
domaš
), 
gâ
, &
p2mt
),

5365 ((
GUEST_PAGING_LEVELS
 == 3 ||

5366 
	`is_pv_32Ú64_vıu
(
v
))

5367 && !
	`shadow_mode_ex‹º®
(
v
->
domaš
)

5368 && (
	`gue¡_šdex
(
gl3e
) % 4) == 3)

5369 ? 
SH_ty³_l2h_shadow


5370 : 
SH_ty³_l2_shadow
);

5371 iàĞ
	`mâ_x
(
gmâ
è!ğmâ_x(
mâ
) )

5372 
	`AUDIT_FAIL
(3, "bad¿n¦©iÚ: gâ %" 
SH_PRI_gâ


5373 " --> %" 
PRI_mâ
 " != mfn %" PRI_mfn,

5374 
	`gâ_x
(
gâ
), 
	`mâ_x
(
gmâ
), mâ_x(
mâ
));

5377 
	`sh_unm­_domaš_·ge
(
gp
);

5379 
	}
}

5381 
	$sh_aud™_l4_bË
(
vıu
 *
v
, 
mâ_t
 
¦4mâ
, mâ_ˆ
x
)

5383 
gue¡_l4e_t
 *
gl4e
, *
gp
;

5384 
shadow_l4e_t
 *
¦4e
;

5385 
mâ_t
 
mâ
, 
gmâ
, 
gl4mâ
;

5386 
gâ_t
 
gâ
;

5387 
p2m_ty³_t
 
p2mt
;

5388 *
s
;

5389 
dÚe
 = 0;

5392 
	`ASSERT
(
	`mâ_to_·ge
(
¦4mâ
)->
u
.
sh
.
h—d
);

5393 
gl4mâ
 = 
	`backpoš‹r
(
	`mâ_to_·ge
(
¦4mâ
));

5395 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

5397 iàĞ
	`·ge_is_out_of_sync
(
	`mâ_to_·ge
(
gl4mâ
)) )

5398 
	`AUDIT_FAIL_MIN
(4, "gmâ %lx i ouˆoàsync", 
	`mâ_x
(
gl4mâ
));

5401 
gl4e
 = 
gp
 = 
	`sh_m­_domaš_·ge
(
gl4mâ
);

5402 
	`SHADOW_FOREACH_L4E
(
¦4mâ
, 
¦4e
, &
gl4e
, 
dÚe
, 
v
->
domaš
,

5404 
s
 = 
	`sh_aud™_æags
(
v
, 4, 
	`gue¡_l4e_g‘_æags
(*
gl4e
),

5405 
	`shadow_l4e_g‘_æags
(*
¦4e
));

5406 iàĞ
s
 ) 
	`AUDIT_FAIL
(4, "%s", s);

5408 iàĞ
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_MFNS
 )

5410 
gâ
 = 
	`gue¡_l4e_g‘_gâ
(*
gl4e
);

5411 
mâ
 = 
	`shadow_l4e_g‘_mâ
(*
¦4e
);

5412 
gmâ
 = 
	`g‘_shadow_¡©us
(
v
, 
	`gâ_to_mâ_qu”y
(
	`p2m_g‘_ho¡p2m
(v->
domaš
),

5413 
gâ
, &
p2mt
),

5414 
SH_ty³_l3_shadow
);

5415 iàĞ
	`mâ_x
(
gmâ
è!ğmâ_x(
mâ
) )

5416 
	`AUDIT_FAIL
(4, "bad¿n¦©iÚ: gâ %" 
SH_PRI_gâ


5417 " --> %" 
PRI_mâ
 " != mfn %" PRI_mfn,

5418 
	`gâ_x
(
gâ
), 
	`mâ_x
(
gmâ
), mâ_x(
mâ
));

5421 
	`sh_unm­_domaš_·ge
(
gp
);

5423 
	}
}

5427 #undeà
AUDIT_FAIL


5434 cÚ¡ 
·gšg_mode
 
	gsh_·gšg_mode
 = {

5435 .
·ge_çuÉ
 = 
sh_·ge_çuÉ
,

5436 .
	gšvÍg
 = 
sh_švÍg
,

5437 .
	ggva_to_gâ
 = 
sh_gva_to_gâ
,

5438 .
	gupd©e_ü3
 = 
sh_upd©e_ü3
,

5439 .
	gupd©e_·gšg_modes
 = 
shadow_upd©e_·gšg_modes
,

5440 .
	gwr™e_p2m_’Œy
 = 
shadow_wr™e_p2m_’Œy
,

5441 .
	gwr™e_gue¡_’Œy
 = 
shadow_wr™e_gue¡_’Œy
,

5442 .
	gcmpxchg_gue¡_’Œy
 = 
shadow_cmpxchg_gue¡_’Œy
,

5443 .
	ggue¡_m­_l1e
 = 
sh_gue¡_m­_l1e
,

5444 .
	ggue¡_g‘_eff_l1e
 = 
sh_gue¡_g‘_eff_l1e
,

5445 .
	ggue¡_Ëv–s
 = 
GUEST_PAGING_LEVELS
,

5446 .
	gshadow
.
	gd‘ach_Şd_bËs
 = 
sh_d‘ach_Şd_bËs
,

5447 .
	gshadow
.
	gx86_emuÏ‹_wr™e
 = 
sh_x86_emuÏ‹_wr™e
,

5448 .
	gshadow
.
	gx86_emuÏ‹_cmpxchg
 = 
sh_x86_emuÏ‹_cmpxchg
,

5449 #ifdeà
__i386__


5450 .
	gshadow
.
	gx86_emuÏ‹_cmpxchg8b
 = 
sh_x86_emuÏ‹_cmpxchg8b
,

5452 .
	gshadow
.
	gmake_mÚ™Ü_bË
 = 
sh_make_mÚ™Ü_bË
,

5453 .
	gshadow
.
	gde¡roy_mÚ™Ü_bË
 = 
sh_de¡roy_mÚ™Ü_bË
,

5454 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_WRITABLE_HEURISTIC


5455 .
	gshadow
.
	gguess_wrm­
 = 
sh_guess_wrm­
,

5457 .
	gshadow
.
	g·g‘abË_dyšg
 = 
sh_·g‘abË_dyšg
,

5458 .
	gshadow
.
	gshadow_Ëv–s
 = 
SHADOW_PAGING_LEVELS
,

	@mm/shadow/multi.h

25 
	$SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl1e
, 
GUEST_LEVELS
)(

26 
vıu
 *
v
, 
mâ_t
 
gl1mâ
, *
Ãw_gl1p
, 
u32
 
size
);

28 
	$SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2e
, 
GUEST_LEVELS
)(

29 
vıu
 *
v
, 
mâ_t
 
gl2mâ
, *
Ãw_gl2p
, 
u32
 
size
);

31 
	$SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2he
, 
GUEST_LEVELS
)(

32 
vıu
 *
v
, 
mâ_t
 
gl2mâ
, *
Ãw_gl2p
, 
u32
 
size
);

34 
	$SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl3e
, 
GUEST_LEVELS
)(

35 
vıu
 *
v
, 
mâ_t
 
gl3mâ
, *
Ãw_gl3p
, 
u32
 
size
);

37 
	$SHADOW_INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl4e
, 
GUEST_LEVELS
)(

38 
vıu
 *
v
, 
mâ_t
 
gl4mâ
, *
Ãw_gl4p
, 
u32
 
size
);

41 
	$SHADOW_INTERNAL_NAME
(
sh_de¡roy_l1_shadow
, 
GUEST_LEVELS
)(

42 
vıu
 *
v
, 
mâ_t
 
smâ
);

44 
	$SHADOW_INTERNAL_NAME
(
sh_de¡roy_l2_shadow
, 
GUEST_LEVELS
)(

45 
vıu
 *
v
, 
mâ_t
 
smâ
);

47 
	$SHADOW_INTERNAL_NAME
(
sh_de¡roy_l3_shadow
, 
GUEST_LEVELS
)(

48 
vıu
 *
v
, 
mâ_t
 
smâ
);

50 
	$SHADOW_INTERNAL_NAME
(
sh_de¡roy_l4_shadow
, 
GUEST_LEVELS
)(

51 
vıu
 *
v
, 
mâ_t
 
smâ
);

54 
	$SHADOW_INTERNAL_NAME
(
sh_unhook_32b_m­pšgs
, 
GUEST_LEVELS
)

55 (
vıu
 *
v
, 
mâ_t
 
¦2mâ
, 
u£r_Úly
);

57 
	$SHADOW_INTERNAL_NAME
(
sh_unhook_·e_m­pšgs
, 
GUEST_LEVELS
)

58 (
vıu
 *
v
, 
mâ_t
 
¦3mâ
, 
u£r_Úly
);

60 
	$SHADOW_INTERNAL_NAME
(
sh_unhook_64b_m­pšgs
, 
GUEST_LEVELS
)

61 (
vıu
 *
v
, 
mâ_t
 
¦4mâ
, 
u£r_Úly
);

64 
	$SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
, 
GUEST_LEVELS
)

65 (
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
»adÚly_mâ
);

67 
	$SHADOW_INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
, 
GUEST_LEVELS
)

68 (
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
rg‘_mâ
);

71 
	$SHADOW_INTERNAL_NAME
(
sh_ş—r_shadow_’Œy
, 
GUEST_LEVELS
)

72 (
vıu
 *
v
, *
•
, 
mâ_t
 
smâ
);

75 
	$SHADOW_INTERNAL_NAME
(
sh_»move_l1_shadow
, 
GUEST_LEVELS
)

76 (
vıu
 *
v
, 
mâ_t
 
¦2mâ
, mâ_ˆ
¦1mâ
);

78 
	$SHADOW_INTERNAL_NAME
(
sh_»move_l2_shadow
, 
GUEST_LEVELS
)

79 (
vıu
 *
v
, 
mâ_t
 
¦3mâ
, mâ_ˆ
¦2mâ
);

81 
	$SHADOW_INTERNAL_NAME
(
sh_»move_l3_shadow
, 
GUEST_LEVELS
)

82 (
vıu
 *
v
, 
mâ_t
 
¦4mâ
, mâ_ˆ
¦3mâ
);

84 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES


86 
	$SHADOW_INTERNAL_NAME
(
sh_aud™_l1_bË
, 
GUEST_LEVELS
)

87 (
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
x
);

89 
	$SHADOW_INTERNAL_NAME
(
sh_aud™_æ1_bË
, 
GUEST_LEVELS
)

90 (
vıu
 *
v
, 
mâ_t
 
¦1mâ
, mâ_ˆ
x
);

92 
	$SHADOW_INTERNAL_NAME
(
sh_aud™_l2_bË
, 
GUEST_LEVELS
)

93 (
vıu
 *
v
, 
mâ_t
 
¦2mâ
, mâ_ˆ
x
);

95 
	$SHADOW_INTERNAL_NAME
(
sh_aud™_l3_bË
, 
GUEST_LEVELS
)

96 (
vıu
 *
v
, 
mâ_t
 
¦3mâ
, mâ_ˆ
x
);

98 
	$SHADOW_INTERNAL_NAME
(
sh_aud™_l4_bË
, 
GUEST_LEVELS
)

99 (
vıu
 *
v
, 
mâ_t
 
¦4mâ
, mâ_ˆ
x
);

103 
	$SHADOW_INTERNAL_NAME
(
sh_gue¡_m­_l1e
, 
GUEST_LEVELS
)

104 (
vıu
 *
v
, 
va
, *
gl1mâ
);

106 
	$SHADOW_INTERNAL_NAME
(
sh_gue¡_g‘_eff_l1e
, 
GUEST_LEVELS
)

107 (
vıu
 *
v
, 
va
, *
eff_l1e
);

109 
mâ_t


110 
	$SHADOW_INTERNAL_NAME
(
sh_make_mÚ™Ü_bË
, 
GUEST_LEVELS
)

111 (
vıu
 *
v
);

113 
	$SHADOW_INTERNAL_NAME
(
sh_de¡roy_mÚ™Ü_bË
, 
GUEST_LEVELS
)

114 (
vıu
 *
v
, 
mâ_t
 
mmâ
);

116 cÚ¡ 
·gšg_mode


117 
	`SHADOW_INTERNAL_NAME
(
sh_·gšg_mode
, 
GUEST_LEVELS
);

119 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC


121 
	$SHADOW_INTERNAL_NAME
(
sh_»sync_l1
, 
GUEST_LEVELS
)

122 (
vıu
 *
v
, 
mâ_t
 
gmâ
, mâ_ˆ
¢pmâ
);

125 
	$SHADOW_INTERNAL_NAME
(
sh_§ã_nÙ_to_sync
, 
GUEST_LEVELS
)

126 (
vıu
*
v
, 
mâ_t
 
gmâ
);

129 
	$SHADOW_INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_¦1p
, 
GUEST_LEVELS
)

130 (
vıu
 *
v
, 
mâ_t
 
gmâ
, mâ_ˆ
smâ
, 
off
);

	@mm/shadow/private.h

24 #iâdeà
_XEN_SHADOW_PRIVATE_H


25 
	#_XEN_SHADOW_PRIVATE_H


	)

29 
	~<asm/·ge.h
>

30 
	~<x’/domaš_·ge.h
>

31 
	~<asm/x86_emuÏ‹.h
>

32 
	~<asm/hvm/suµÜt.h
>

39 
	#SHADOW_AUDIT_HASH
 0x01

	)

40 
	#SHADOW_AUDIT_HASH_FULL
 0x02

	)

41 
	#SHADOW_AUDIT_ENTRIES
 0x04

	)

42 
	#SHADOW_AUDIT_ENTRIES_FULL
 0x08

	)

43 
	#SHADOW_AUDIT_ENTRIES_MFNS
 0x10

	)

45 #ifdeà
NDEBUG


46 
	#SHADOW_AUDIT
 0

	)

47 
	#SHADOW_AUDIT_ENABLE
 0

	)

49 
	#SHADOW_AUDIT
 0x15

	)

50 
	#SHADOW_AUDIT_ENABLE
 
shadow_aud™_’abË


	)

51 
shadow_aud™_’abË
;

58 
	#SHOPT_WRITABLE_HEURISTIC
 0x01

	)

59 
	#SHOPT_EARLY_UNSHADOW
 0x02

	)

60 
	#SHOPT_FAST_FAULT_PATH
 0x04

	)

61 
	#SHOPT_PREFETCH
 0x08

	)

62 
	#SHOPT_LINUX_L3_TOPLEVEL
 0x10

	)

63 
	#SHOPT_SKIP_VERIFY
 0x20

	)

64 
	#SHOPT_VIRTUAL_TLB
 0x40

	)

65 
	#SHOPT_FAST_EMULATION
 0x80

	)

66 
	#SHOPT_OUT_OF_SYNC
 0x100

	)

68 
	#SHADOW_OPTIMIZATIONS
 0x1ff

	)

75 
	#SHADOW_PRINTK
(
_f
, 
_a
...) \

76 
	`debugŒaû_´štk
("sh: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

77 
	#SHADOW_ERROR
(
_f
, 
_a
...) \

78 
	`´štk
("shƒ¼Ü: %s(): " 
_f
, 
__func__
, ##
_a
)

	)

79 
	#SHADOW_DEBUG
(
æag
, 
_f
, 
_a
...) \

81 ià(
SHADOW_DEBUG_
 ## 
æag
) \

82 
	`debugŒaû_´štk
("shdebug: %s(): " 
_f
, 
__func__
, ##
_a
); \

83 } 0)

	)

86 
	#SHADOW_DEBUG_PROPAGATE
 1

	)

87 
	#SHADOW_DEBUG_MAKE_SHADOW
 1

	)

88 
	#SHADOW_DEBUG_DESTROY_SHADOW
 1

	)

89 
	#SHADOW_DEBUG_A_AND_D
 1

	)

90 
	#SHADOW_DEBUG_EMULATE
 1

	)

91 
	#SHADOW_DEBUG_P2M
 1

	)

92 
	#SHADOW_DEBUG_LOGDIRTY
 0

	)

97 
DECLARE_PER_CPU
(
ušt32_t
,
Œaû_shadow_·th_æags
);

99 
	#TRACE_SHADOW_PATH_FLAG
(
_x
) \

101 
	`this_ıu
(
Œaû_shadow_·th_æags
è|ğ(1<<(
_x
)); \

102 } 0)

	)

104 
	#TRACE_CLEAR_PATH_FLAGS
 \

105 
	`this_ıu
(
Œaû_shadow_·th_æags
èğ0

	)

108 
	mTRCE_SFLAG_SET_AD
,

109 
	mTRCE_SFLAG_SET_A
,

110 
	mTRCE_SFLAG_SHADOW_L1_GET_REF
,

111 
	mTRCE_SFLAG_SHADOW_L1_PUT_REF
,

112 
	mTRCE_SFLAG_L2_PROPAGATE
,

113 
	mTRCE_SFLAG_SET_CHANGED
,

114 
	mTRCE_SFLAG_SET_FLUSH
,

115 
	mTRCE_SFLAG_SET_ERROR
,

116 
	mTRCE_SFLAG_DEMOTE
,

117 
	mTRCE_SFLAG_PROMOTE
,

118 
	mTRCE_SFLAG_WRMAP
,

119 
	mTRCE_SFLAG_WRMAP_GUESS_FOUND
,

120 
	mTRCE_SFLAG_WRMAP_BRUTE_FORCE
,

121 
	mTRCE_SFLAG_EARLY_UNSHADOW
,

122 
	mTRCE_SFLAG_EMULATION_2ND_PT_WRITTEN
,

123 
	mTRCE_SFLAG_EMULATION_LAST_FAILED
,

124 
	mTRCE_SFLAG_EMULATE_FULL_PT
,

125 
	mTRCE_SFLAG_PREALLOC_UNHOOK
,

126 
	mTRCE_SFLAG_UNSYNC
,

127 
	mTRCE_SFLAG_OOS_FIXUP_ADD
,

128 
	mTRCE_SFLAG_OOS_FIXUP_EVICT
,

146 #iâdeà
CONFIG_SMP


147 #”rÜ 
shadow
.
h
 
cu¼’y
 
»quœes
 
CONFIG_SMP


150 
	#shadow_lock_š™
(
_d
) \

152 
	`¥š_lock_š™
(&(
_d
)->
¬ch
.
·gšg
.
shadow
.
lock
); \

153 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 = -1; \

154 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”_funùiÚ
 = "nobody"; \

155 } 0)

	)

157 
	#shadow_locked_by_me
(
_d
) \

158 (
cu¼’t
->
´oûssÜ
 =ğ(
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
)

	)

160 
	#shadow_lock
(
_d
) \

162 iàĞ
	`uÆik–y
((
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 =ğ
cu¼’t
->
´oûssÜ
) )\

164 
	`´štk
("Error: shadow†ock held by %s\n", \

165 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”_funùiÚ
); \

166 
	`BUG
(); \

168 
	`¥š_lock
(&(
_d
)->
¬ch
.
·gšg
.
shadow
.
lock
); \

169 
	`ASSERT
((
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 == -1); \

170 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 = 
cu¼’t
->
´oûssÜ
; \

171 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”_funùiÚ
 = 
__func__
; \

172 } 0)

	)

174 
	#shadow_uÆock
(
_d
) \

176 
	`ASSERT
((
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 =ğ
cu¼’t
->
´oûssÜ
); \

177 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”
 = -1; \

178 (
_d
)->
¬ch
.
·gšg
.
shadow
.
lock”_funùiÚ
 = "nobody"; \

179 
	`¥š_uÆock
(&(
_d
)->
¬ch
.
·gšg
.
shadow
.
lock
); \

180 } 0)

	)

184 #ià
GUEST_PAGING_LEVELS
 >= 3

185 
	#GUEST_PTE_SIZE
 8

	)

187 
	#GUEST_PTE_SIZE
 4

	)

194 #ià
SHADOW_AUDIT
 & 
SHADOW_AUDIT_ENTRIES_FULL


195 
shadow_aud™_bËs
(
vıu
 *
v
);

197 
	#shadow_aud™_bËs
(
_v
èdØ{} 0)

	)

204 
	#SHADOW_INTERNAL_NAME_HIDDEN
(
Çme
, 
gue¡_Ëv–s
) \

205 
Çme
 ## 
__gue¡_
 ## 
gue¡_Ëv–s


	)

206 
	#SHADOW_INTERNAL_NAME
(
Çme
, 
gue¡_Ëv–s
) \

207 
	`SHADOW_INTERNAL_NAME_HIDDEN
(
Çme
, 
gue¡_Ëv–s
)

	)

209 
	#GUEST_LEVELS
 2

	)

210 
	~"muÉi.h
"

211 #undeà
GUEST_LEVELS


213 
	#GUEST_LEVELS
 3

	)

214 
	~"muÉi.h
"

215 #undeà
GUEST_LEVELS


217 #ià
CONFIG_PAGING_LEVELS
 == 4

218 
	#GUEST_LEVELS
 4

	)

219 
	~"muÉi.h
"

220 #undeà
GUEST_LEVELS


224 
	#SH_ty³_nÚe
 (0Uè

	)

225 
	#SH_ty³_mš_shadow
 (1U)

	)

226 
	#SH_ty³_l1_32_shadow
 (1Uè

	)

227 
	#SH_ty³_æ1_32_shadow
 (2Uè

	)

228 
	#SH_ty³_l2_32_shadow
 (3Uè

	)

229 
	#SH_ty³_l1_·e_shadow
 (4Uè

	)

230 
	#SH_ty³_æ1_·e_shadow
 (5Uè

	)

231 
	#SH_ty³_l2_·e_shadow
 (6Uè

	)

232 
	#SH_ty³_l2h_·e_shadow
 (7Uè

	)

233 
	#SH_ty³_l1_64_shadow
 (8Uè

	)

234 
	#SH_ty³_æ1_64_shadow
 (9Uè

	)

235 
	#SH_ty³_l2_64_shadow
 (10Uè

	)

236 
	#SH_ty³_l2h_64_shadow
 (11Uè

	)

237 
	#SH_ty³_l3_64_shadow
 (12Uè

	)

238 
	#SH_ty³_l4_64_shadow
 (13Uè

	)

239 
	#SH_ty³_max_shadow
 (13U)

	)

240 
	#SH_ty³_p2m_bË
 (14Uè

	)

241 
	#SH_ty³_mÚ™Ü_bË
 (15Uè

	)

242 
	#SH_ty³_oos_¢­shÙ
 (16Uè

	)

243 
	#SH_ty³_unu£d
 (17U)

	)

249 
šlše
 
	$sh_ty³_is_pšÇbË
(
vıu
 *
v
, 
t
)

253 iàĞ
t
 =ğ
SH_ty³_l2_32_shadow


254 || 
t
 =ğ
SH_ty³_l2_·e_shadow


255 || 
t
 =ğ
SH_ty³_l2h_·e_shadow


256 || 
t
 =ğ
SH_ty³_l4_64_shadow
 )

259 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_LINUX_L3_TOPLEVEL
)

265 iàĞ
	`uÆik–y
((
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
İt_æags
 & 
SHOPT_LINUX_L3_TOPLEVEL
)

266 && 
CONFIG_PAGING_LEVELS
 >= 4

267 && 
t
 =ğ
SH_ty³_l3_64_shadow
) )

273 
	}
}

275 
šlše
 
	$sh_ty³_has_up_poš‹r
(
vıu
 *
v
, 
t
)

278 iàĞ
t
 =ğ
SH_ty³_l1_32_shadow


279 || 
t
 =ğ
SH_ty³_æ1_32_shadow


280 || 
t
 =ğ
SH_ty³_l2_32_shadow
 )

283  !
	`sh_ty³_is_pšÇbË
(
v
, 
t
);

284 
	}
}

291 
	#SHF_·ge_ty³_mask
 \

292 (((1u << (
SH_ty³_max_shadow
 + 1u)) - 1u) - \

293 ((1u << 
SH_ty³_mš_shadow
è- 1u))

	)

295 
	#SHF_L1_32
 (1u << 
SH_ty³_l1_32_shadow
)

	)

296 
	#SHF_FL1_32
 (1u << 
SH_ty³_æ1_32_shadow
)

	)

297 
	#SHF_L2_32
 (1u << 
SH_ty³_l2_32_shadow
)

	)

298 
	#SHF_L1_PAE
 (1u << 
SH_ty³_l1_·e_shadow
)

	)

299 
	#SHF_FL1_PAE
 (1u << 
SH_ty³_æ1_·e_shadow
)

	)

300 
	#SHF_L2_PAE
 (1u << 
SH_ty³_l2_·e_shadow
)

	)

301 
	#SHF_L2H_PAE
 (1u << 
SH_ty³_l2h_·e_shadow
)

	)

302 
	#SHF_L1_64
 (1u << 
SH_ty³_l1_64_shadow
)

	)

303 
	#SHF_FL1_64
 (1u << 
SH_ty³_æ1_64_shadow
)

	)

304 
	#SHF_L2_64
 (1u << 
SH_ty³_l2_64_shadow
)

	)

305 
	#SHF_L2H_64
 (1u << 
SH_ty³_l2h_64_shadow
)

	)

306 
	#SHF_L3_64
 (1u << 
SH_ty³_l3_64_shadow
)

	)

307 
	#SHF_L4_64
 (1u << 
SH_ty³_l4_64_shadow
)

	)

309 
	#SHF_32
 (
SHF_L1_32
|
SHF_FL1_32
|
SHF_L2_32
)

	)

310 
	#SHF_PAE
 (
SHF_L1_PAE
|
SHF_FL1_PAE
|
SHF_L2_PAE
|
SHF_L2H_PAE
)

	)

311 
	#SHF_64
 (
SHF_L1_64
|
SHF_FL1_64
|
SHF_L2_64
|
SHF_L2H_64
|
SHF_L3_64
|
SHF_L4_64
)

	)

313 
	#SHF_L1_ANY
 (
SHF_L1_32
|
SHF_L1_PAE
|
SHF_L1_64
)

	)

315 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

330 
	#SHF_out_of_sync
 (1u<<30)

	)

331 
	#SHF_oos_may_wr™e
 (1u<<29)

	)

335 
	#SHF_·g‘abË_dyšg
 (1u<<31)

	)

337 
šlše
 
	$sh_·ge_has_muÉË_shadows
(
·ge_šfo
 *
pg
)

339 
u32
 
shadows
;

340 iàĞ!(
pg
->
couÁ_šfo
 & 
PGC_·ge_bË
) )

342 
shadows
 = 
pg
->
shadow_æags
 & 
SHF_·ge_ty³_mask
;

344  ( (
shadows
 & ~(1UL << 
	`fšd_fœ¡_£t_b™
(shadows))) != 0 );

345 
	}
}

347 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

350 
šlše
 
	$·ge_is_out_of_sync
(
·ge_šfo
 *
p
)

352  (
p
->
couÁ_šfo
 & 
PGC_·ge_bË
)

353 && (
p
->
shadow_æags
 & 
SHF_out_of_sync
);

354 
	}
}

356 
šlše
 
	$mâ_is_out_of_sync
(
mâ_t
 
gmâ
)

358  
	`·ge_is_out_of_sync
(
	`mâ_to_·ge
(
	`mâ_x
(
gmâ
)));

359 
	}
}

361 
šlše
 
	$·ge_oos_may_wr™e
(
·ge_šfo
 *
p
)

363  (
p
->
couÁ_šfo
 & 
PGC_·ge_bË
)

364 && (
p
->
shadow_æags
 & 
SHF_oos_may_wr™e
);

365 
	}
}

367 
šlše
 
	$mâ_oos_may_wr™e
(
mâ_t
 
gmâ
)

369  
	`·ge_oos_may_wr™e
(
	`mâ_to_·ge
(
	`mâ_x
(
gmâ
)));

370 
	}
}

378 
mâ_t
 
shadow_hash_lookup
(
vıu
 *
v
, 
n
, 
t
);

379 
shadow_hash_š£¹
(
vıu
 *
v
,

380 
n
, 
t
, 
mâ_t
 
smâ
);

381 
shadow_hash_d–‘e
(
vıu
 *
v
,

382 
n
, 
t
, 
mâ_t
 
smâ
);

385 
shadow_´omÙe
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
ty³
);

386 
shadow_demÙe
(
vıu
 *
v
, 
mâ_t
 
gmâ
, 
u32
 
ty³
);

389 
shadow_´—Îoc
(
domaš
 *
d
, 
u32
 
shadow_ty³
, 
couÁ
);

390 
mâ_t
 
shadow_®loc
(
domaš
 *
d
,

391 
u32
 
shadow_ty³
,

392 
backpoš‹r
);

393 
shadow_ä“
(
domaš
 *
d
, 
mâ_t
 
smâ
);

396 
sh_š¡®l_x’_’Œ›s_š_l4
(
vıu
 *
v
, 
mâ_t
 
gl4mâ
, mâ_ˆ
¦4mâ
);

399 
sh_v®id©e_gue¡_’Œy
(
vıu
 *
v
, 
mâ_t
 
gmâ
, *
’Œy
, 
u32
 
size
);

402 
sh_v®id©e_gue¡_±_wr™e
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

403 *
’Œy
, 
u32
 
size
);

409 
sh_»move_wr™e_acûss
(
vıu
 *
v
, 
mâ_t
 
»adÚly_mâ
,

410 
Ëv–
,

411 
çuÉ_addr
);

414 
shadow_wr™e_p2m_’Œy
(
vıu
 *
v
, 
gâ
,

415 
l1_pg’Œy_t
 *
p
, 
mâ_t
 
bË_mâ
,

416 
l1_pg’Œy_t
 
Ãw
, 
Ëv–
);

417 
shadow_wr™e_gue¡_’Œy
(
vıu
 *
v
, 
š‹_t
 *
p
,

418 
š‹_t
 
Ãw
, 
mâ_t
 
gmâ
);

419 
shadow_cmpxchg_gue¡_’Œy
(
vıu
 *
v
, 
š‹_t
 *
p
,

420 
š‹_t
 *
Şd
, iÁ±e_ˆ
Ãw
, 
mâ_t
 
gmâ
);

424 
shadow_unhook_m­pšgs
(
vıu
 *
v
, 
mâ_t
 
smâ
, 
u£r_Úly
);

426 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC
)

428 
sh_unsync
(
vıu
 *
v
, 
mâ_t
 
gmâ
);

431 
sh_»sync
(
vıu
 *
v
, 
mâ_t
 
gmâ
);

433 
oos_fixup_add
(
vıu
 *
v
, 
mâ_t
 
gmâ
, mâ_ˆ
smâ
, 
off
);

435 
sh_»move_wr™e_acûss_äom_¦1p
(
vıu
 *
v
, 
mâ_t
 
gmâ
,

436 
mâ_t
 
smâ
, 
off£t
);

441 
sh_»sync_®l
(
vıu
 *
v
, 
sk
, 
this
, 
Ùh”s
, 
do_lockšg
);

443 
šlše
 

444 
	$shadow_»sync_®l
(
vıu
 *
v
, 
do_lockšg
)

446 
	`sh_»sync_®l
(
v
,

450 
do_lockšg
);

451 
	}
}

453 
šlše
 

454 
	$shadow_»sync_cu¼’t_vıu
(
vıu
 *
v
, 
do_lockšg
)

456 
	`sh_»sync_®l
(
v
,

460 
do_lockšg
);

461 
	}
}

463 
šlše
 

464 
	$shadow_sync_Ùh”_vıus
(
vıu
 *
v
, 
do_lockšg
)

466 
	`sh_»sync_®l
(
v
,

470 
do_lockšg
);

471 
	}
}

473 
oos_aud™_hash_is_´e£Á
(
domaš
 *
d
, 
mâ_t
 
gmâ
);

474 
mâ_t
 
oos_¢­shÙ_lookup
(
vıu
 *
v
, mâ_ˆ
gmâ
);

482 
sh_»£t_l3_up_poš‹rs
(
vıu
 *
v
);

489 
	#SHADOW_SET_CHANGED
 0x1

	)

491 
	#SHADOW_SET_FLUSH
 0x2

	)

493 
	#SHADOW_SET_ERROR
 0x4

	)

501 #undeà
mâ_to_·ge


502 
	#mâ_to_·ge
(
_m
è
	`__mâ_to_·ge
(
	`mâ_x
(_m))

	)

503 #undeà
mâ_v®id


504 
	#mâ_v®id
(
_mâ
è
	`__mâ_v®id
(
	`mâ_x
(_mâ))

	)

505 #undeà
·ge_to_mâ


506 
	#·ge_to_mâ
(
_pg
è
	`_mâ
(
	`__·ge_to_mâ
(_pg))

	)

509 #undeà
·g‘abË_g‘_·ge


510 
	#·g‘abË_g‘_·ge
(
x
è
	`mâ_to_·ge
(
	`·g‘abË_g‘_mâ
(x))

	)

511 #undeà
·g‘abË_äom_·ge


512 
	#·g‘abË_äom_·ge
(
pg
è
	`·g‘abË_äom_mâ
(
	`·ge_to_mâ
Õg))

	)

514 
	#backpoš‹r
(
¥
è
	`_mâ
(
	`pdx_to_pâ
(()(¥)->
v
.
sh
.
back
))

	)

515 
šlše
 
	$__backpoš‹r
(cÚ¡ 
·ge_šfo
 *
¥
)

517 
¥
->
u
.
sh
.
ty³
)

519 
SH_ty³_æ1_32_shadow
:

520 
SH_ty³_æ1_·e_shadow
:

521 
SH_ty³_æ1_64_shadow
:

522  
¥
->
v
.
sh
.
back
;

524  
	`pdx_to_pâ
(
¥
->
v
.
sh
.
back
);

525 
	}
}

527 
šlše
 

528 
	$sh_mâ_is_a_·ge_bË
(
mâ_t
 
gmâ
)

530 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
gmâ
);

531 
domaš
 *
owÃr
;

532 
ty³_šfo
;

534 iàĞ!
	`mâ_v®id
(
gmâ
) )

537 
owÃr
 = 
	`·ge_g‘_owÃr
(
·ge
);

538 iàĞ
owÃr
 && 
	`shadow_mode_»fcouÁs
(owner)

539 && (
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
) )

542 
ty³_šfo
 = 
·ge
->
u
.
šu£
.ty³_šfØ& 
PGT_ty³_mask
;

543  
ty³_šfo
 && (ty³_šfØ<ğ
PGT_l4_·ge_bË
);

544 
	}
}

547 
šlše
 *

548 
	$sh_m­_domaš_·ge
(
mâ_t
 
mâ
)

550  
	`m­_domaš_·ge
(
	`mâ_x
(
mâ
));

551 
	}
}

553 
šlše
 

554 
	$sh_unm­_domaš_·ge
(*
p
)

556 
	`unm­_domaš_·ge
(
p
);

557 
	}
}

559 
šlše
 *

560 
	$sh_m­_domaš_·ge_glob®
(
mâ_t
 
mâ
)

562  
	`m­_domaš_·ge_glob®
(
	`mâ_x
(
mâ
));

563 
	}
}

565 
šlše
 

566 
	$sh_unm­_domaš_·ge_glob®
(*
p
)

568 
	`unm­_domaš_·ge_glob®
(
p
);

569 
	}
}

574 
sh_de¡roy_shadow
(
vıu
 *
v
, 
mâ_t
 
smâ
);

580 
šlše
 
	$sh_g‘_»f
(
vıu
 *
v
, 
mâ_t
 
smâ
, 
·ddr_t
 
’Œy_·
)

582 
u32
 
x
, 
nx
;

583 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

585 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

586 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

588 
x
 = 
¥
->
u
.
sh
.
couÁ
;

589 
nx
 = 
x
 + 1;

591 iàĞ
	`uÆik–y
(
nx
 >= 1U<<26) )

593 
	`SHADOW_PRINTK
("shadow„ef overflow, gmfn=%lx smfn=%lx\n",

594 
	`__backpoš‹r
(
¥
), 
	`mâ_x
(
smâ
));

599 
¥
->
u
.
sh
.
couÁ
 = 
nx
;

602 iàĞ
’Œy_·
 != 0

603 && 
	`sh_ty³_has_up_poš‹r
(
v
, 
¥
->
u
.
sh
.
ty³
)

604 && 
¥
->
up
 == 0 )

605 
¥
->
up
 = 
’Œy_·
;

608 
	}
}

613 
šlše
 
	$sh_put_»f
(
vıu
 *
v
, 
mâ_t
 
smâ
, 
·ddr_t
 
’Œy_·
)

615 
u32
 
x
, 
nx
;

616 
·ge_šfo
 *
¥
 = 
	`mâ_to_·ge
(
smâ
);

618 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

619 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

620 
	`ASSERT
(!(
¥
->
couÁ_šfo
 & 
PGC_couÁ_mask
));

623 iàĞ
’Œy_·
 != 0

624 && 
	`sh_ty³_has_up_poš‹r
(
v
, 
¥
->
u
.
sh
.
ty³
)

625 && 
¥
->
up
 =ğ
’Œy_·
 )

626 
¥
->
up
 = 0;

628 
x
 = 
¥
->
u
.
sh
.
couÁ
;

629 
nx
 = 
x
 - 1;

631 iàĞ
	`uÆik–y
(
x
 == 0) )

633 
	`SHADOW_ERROR
("shadow„ef underflow, smfn=%lx oc=%08x=%#x\n",

634 
	`mâ_x
(
smâ
), 
¥
->
u
.
sh
.
couÁ
, sp->u.sh.
ty³
);

635 
	`BUG
();

639 
¥
->
u
.
sh
.
couÁ
 = 
nx
;

641 iàĞ
	`uÆik–y
(
nx
 == 0) )

642 
	`sh_de¡roy_shadow
(
v
, 
smâ
);

643 
	}
}

648 
šlše
 
·ge_šfo
 *

649 
	$´ev_pšÃd_shadow
(cÚ¡ 
·ge_šfo
 *
·ge
,

650 cÚ¡ 
domaš
 *
d
)

652 
·ge_šfo
 *
p
;

654 iàĞ
·ge
 =ğ
d
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
.
Ãxt
 )

655  
NULL
;

657 iàĞ
·ge
 =ğ
NULL
 )

658 
p
 = 
d
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
.

;

660 
p
 = 
	`pdx_to_·ge
(
·ge
->
li¡
.
´ev
);

662 iàĞ
p
 &&…->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
 )

664 
p
 = 
	`pdx_to_·ge
Õ->
li¡
.
´ev
);

665 
	`ASSERT
(
p
 &&…->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

666 
p
 = 
	`pdx_to_·ge
Õ->
li¡
.
´ev
);

667 
	`ASSERT
(
p
 &&…->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

668 
p
 = 
	`pdx_to_·ge
Õ->
li¡
.
´ev
);

669 
	`ASSERT
(
p
 &&…->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

671 
	`ASSERT
(!
p
 ||…->
u
.
sh
.
h—d
);

672  
p
;

673 
	}
}

675 
	#fÜ—ch_pšÃd_shadow
(
dom
, 
pos
, 
tmp
) \

676  
pos
 = 
	`´ev_pšÃd_shadow
(
NULL
, (
dom
)); \

677 
pos
 ? (
tmp
 = 
	`´ev_pšÃd_shadow
Õos, (
dom
)), 1) : 0; \

678 
pos
 = 
tmp
 )

	)

683 
šlše
 
	$sh_pš
(
vıu
 *
v
, 
mâ_t
 
smâ
)

685 
·ge_šfo
 *
¥
;

686 
·ge_li¡_h—d
 
h
, *
pš_li¡
;

688 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

689 
¥
 = 
	`mâ_to_·ge
(
smâ
);

690 
	`ASSERT
(
	`sh_ty³_is_pšÇbË
(
v
, 
¥
->
u
.
sh
.
ty³
));

691 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

694 
h
.
Ãxt
 = h.

 = 
¥
;

695 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
 )

697 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

698 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

699 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

700 
	`ASSERT
(
h
.

->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

702 
pš_li¡
 = &
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
;

704 iàĞ
¥
->
u
.
sh
.
pšÃd
 )

708 iàĞ
pš_li¡
->
Ãxt
 =ğ
h
.next )

710 
	`·ge_li¡_´ev
(
h
.
Ãxt
, 
pš_li¡
)->
li¡
.Ãxˆğh.

->list.next;

711 iàĞ
pš_li¡
->

 =ğ
h
.tail )

712 
pš_li¡
->

 = 
	`·ge_li¡_´ev
(
h
.
Ãxt
,…in_list);

714 
	`·ge_li¡_Ãxt
(
h
.

, 
pš_li¡
)->
li¡
.
´ev
 = h.
Ãxt
->list.prev;

715 
h
.

->
li¡
.
Ãxt
 = h.Ãxt->li¡.
´ev
 = 
PAGE_LIST_NULL
;

720 iàĞ!
	`sh_g‘_»f
(
v
, 
smâ
, 0) )

722 
¥
->
u
.
sh
.
pšÃd
 = 1;

723 
	`ASSERT
(
h
.
Ãxt
->
li¡
.
´ev
 =ğ
PAGE_LIST_NULL
);

724 
	`ASSERT
(
h
.

->
li¡
.
Ãxt
 =ğ
PAGE_LIST_NULL
);

727 
	`·ge_li¡_¥liû
(&
h
, 
pš_li¡
);

729 
	}
}

733 
šlše
 
	$sh_uÅš
(
vıu
 *
v
, 
mâ_t
 
smâ
)

735 
·ge_li¡_h—d
 
h
, *
pš_li¡
;

736 
·ge_šfo
 *
¥
;

738 
	`ASSERT
(
	`mâ_v®id
(
smâ
));

739 
¥
 = 
	`mâ_to_·ge
(
smâ
);

740 
	`ASSERT
(
	`sh_ty³_is_pšÇbË
(
v
, 
¥
->
u
.
sh
.
ty³
));

741 
	`ASSERT
(
¥
->
u
.
sh
.
h—d
);

744 
h
.
Ãxt
 = h.

 = 
¥
;

745 iàĞ
¥
->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
 )

747 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

748 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

749 
h
.

 = 
	`pdx_to_·ge
(h.->
li¡
.
Ãxt
);

750 
	`ASSERT
(
h
.

->
u
.
sh
.
ty³
 =ğ
SH_ty³_l2_32_shadow
);

752 
pš_li¡
 = &
v
->
domaš
->
¬ch
.
·gšg
.
shadow
.
pšÃd_shadows
;

754 iàĞ!
¥
->
u
.
sh
.
pšÃd
 )

757 
¥
->
u
.
sh
.
pšÃd
 = 0;

760 iàĞ
pš_li¡
->
Ãxt
 =ğ
h
.Ãxˆ&&…š_li¡->

 == h.tail )

761 
pš_li¡
->
Ãxt
 =…š_li¡->

 = 
NULL
;

764 iàĞ
pš_li¡
->
Ãxt
 =ğ
h
.next )

765 
pš_li¡
->
Ãxt
 = 
	`·ge_li¡_Ãxt
(
h
.

,…in_list);

767 
	`·ge_li¡_´ev
(
h
.
Ãxt
, 
pš_li¡
)->
li¡
.Ãxˆğh.

->list.next;

768 iàĞ
pš_li¡
->

 =ğ
h
.tail )

769 
pš_li¡
->

 = 
	`·ge_li¡_´ev
(
h
.
Ãxt
,…in_list);

771 
	`·ge_li¡_Ãxt
(
h
.

, 
pš_li¡
)->
li¡
.
´ev
 = h.
Ãxt
->list.prev;

773 
h
.

->
li¡
.
Ãxt
 = h.Ãxt->li¡.
´ev
 = 
PAGE_LIST_NULL
;

775 
	`sh_put_»f
(
v
, 
smâ
, 0);

776 
	}
}

782 
	ssh_emuÏ‹_ùxt
 {

783 
x86_emuÏ‹_ùxt
 
	mùxt
;

786 
ušt8_t
 
	mš¢_buf
[31];

787 
ušt8_t
 
	mš¢_buf_by‹s
;

788 
	mš¢_buf_e
;

791 
	mv®id_£g_»gs
;

792 
£gm’t_»gi¡”
 
	m£g_»g
[6];

795 
mâ_t
 
	mmâ1
, 
	mmâ2
;

797 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_SKIP_VERIFY
)

800 
	mlow_b™_was_ş—r
:1;

804 cÚ¡ 
x86_emuÏ‹_İs
 *
shadow_š™_emuÏtiÚ
(

805 
sh_emuÏ‹_ùxt
 *
sh_ùxt
, 
ıu_u£r_»gs
 *
»gs
);

806 
shadow_cÚtšue_emuÏtiÚ
(

807 
sh_emuÏ‹_ùxt
 *
sh_ùxt
, 
ıu_u£r_»gs
 *
»gs
);

808 
£gm’t_»gi¡”
 *
hvm_g‘_£g_»g
(

809 
x86_£gm’t
 
£g
, 
sh_emuÏ‹_ùxt
 *
sh_ùxt
);

811 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_VIRTUAL_TLB
)

825 
	#VTLB_ENTRIES
 13

	)

827 
	sshadow_vb
 {

828 
	m·ge_numb”
;

829 
	mäame_numb”
;

830 
ušt32_t
 
	mpãc
;

836 
šlše
 
	$vb_æush
(
vıu
 *
v
)

838 
	`¥š_lock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

839 
	`mem£t
(
v
->
¬ch
.
·gšg
.
vb
, 0, 
VTLB_ENTRIES
 *  (
shadow_vb
));

840 
	`¥š_uÆock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

841 
	}
}

843 
šlše
 
	$vb_hash
(
·ge_numb”
)

845  
·ge_numb”
 % 
VTLB_ENTRIES
;

846 
	}
}

849 
šlše
 
	$vb_š£¹
(
vıu
 *
v
, 
·ge
,

850 
äame
, 
ušt32_t
 
pãc
)

852 
shadow_vb
 
’Œy
 =

853 { .
·ge_numb”
 = 
·ge
, .
äame_numb”
 = 
äame
, .
pãc
 =…fec };

854 
	`¥š_lock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

855 
v
->
¬ch
.
·gšg
.
vb
[
	`vb_hash
(
·ge
)] = 
’Œy
;

856 
	`¥š_uÆock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

857 
	}
}

860 
šlše
 
	$vb_lookup
(
vıu
 *
v
,

861 
va
, 
ušt32_t
 
pãc
)

863 
·ge_numb”
 = 
va
 >> 
PAGE_SHIFT
;

864 
äame_numb”
 = 
INVALID_GFN
;

865 
i
 = 
	`vb_hash
(
·ge_numb”
);

867 
	`¥š_lock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

868 iàĞ
v
->
¬ch
.
·gšg
.
vb
[
i
].
pãc
 != 0

869 && 
v
->
¬ch
.
·gšg
.
vb
[
i
].
·ge_numb”
 ==…age_number

871 && (
v
->
¬ch
.
·gšg
.
vb
[
i
].
pãc
 &…fec) ==…fec )

873 
äame_numb”
 = 
v
->
¬ch
.
·gšg
.
vb
[
i
].frame_number;

875 
	`¥š_uÆock
(&
v
->
¬ch
.
·gšg
.
vb_lock
);

876  
äame_numb”
;

877 
	}
}

	@mm/shadow/types.h

23 #iâdeà
_XEN_SHADOW_TYPES_H


24 
	#_XEN_SHADOW_TYPES_H


	)

28 #ià
GUEST_PAGING_LEVELS
 == 4

29 
	#SHADOW_PAGING_LEVELS
 4

	)

31 
	#SHADOW_PAGING_LEVELS
 3

	)

40 #ià
SHADOW_PAGING_LEVELS
 == 3

41 
	#SHADOW_L1_PAGETABLE_ENTRIES
 512

	)

42 
	#SHADOW_L2_PAGETABLE_ENTRIES
 512

	)

43 
	#SHADOW_L3_PAGETABLE_ENTRIES
 4

	)

44 
	#SHADOW_L1_PAGETABLE_SHIFT
 12

	)

45 
	#SHADOW_L2_PAGETABLE_SHIFT
 21

	)

46 
	#SHADOW_L3_PAGETABLE_SHIFT
 30

	)

48 
	#SHADOW_L1_PAGETABLE_ENTRIES
 512

	)

49 
	#SHADOW_L2_PAGETABLE_ENTRIES
 512

	)

50 
	#SHADOW_L3_PAGETABLE_ENTRIES
 512

	)

51 
	#SHADOW_L4_PAGETABLE_ENTRIES
 512

	)

52 
	#SHADOW_L1_PAGETABLE_SHIFT
 12

	)

53 
	#SHADOW_L2_PAGETABLE_SHIFT
 21

	)

54 
	#SHADOW_L3_PAGETABLE_SHIFT
 30

	)

55 
	#SHADOW_L4_PAGETABLE_SHIFT
 39

	)

59 
l1_pg’Œy_t
 
	tshadow_l1e_t
;

60 
l2_pg’Œy_t
 
	tshadow_l2e_t
;

61 
l3_pg’Œy_t
 
	tshadow_l3e_t
;

62 #ià
SHADOW_PAGING_LEVELS
 >= 4

63 
l4_pg’Œy_t
 
	tshadow_l4e_t
;

67 
šlše
 
·ddr_t
 
	$shadow_l1e_g‘_·ddr
(
shadow_l1e_t
 
¦1e
)

68 {  
	`l1e_g‘_·ddr
(
¦1e
); 
	}
}

69 
šlše
 
·ddr_t
 
	$shadow_l2e_g‘_·ddr
(
shadow_l2e_t
 
¦2e
)

70 {  
	`l2e_g‘_·ddr
(
¦2e
); 
	}
}

71 
šlše
 
·ddr_t
 
	$shadow_l3e_g‘_·ddr
(
shadow_l3e_t
 
¦3e
)

72 {  
	`l3e_g‘_·ddr
(
¦3e
); 
	}
}

73 #ià
SHADOW_PAGING_LEVELS
 >= 4

74 
šlše
 
·ddr_t
 
	$shadow_l4e_g‘_·ddr
(
shadow_l4e_t
 
¦4e
)

75 {  
	`l4e_g‘_·ddr
(
¦4e
); 
	}
}

78 
šlše
 
mâ_t
 
	$shadow_l1e_g‘_mâ
(
shadow_l1e_t
 
¦1e
)

79 {  
	`_mâ
(
	`l1e_g‘_pâ
(
¦1e
)); 
	}
}

80 
šlše
 
mâ_t
 
	$shadow_l2e_g‘_mâ
(
shadow_l2e_t
 
¦2e
)

81 {  
	`_mâ
(
	`l2e_g‘_pâ
(
¦2e
)); 
	}
}

82 
šlše
 
mâ_t
 
	$shadow_l3e_g‘_mâ
(
shadow_l3e_t
 
¦3e
)

83 {  
	`_mâ
(
	`l3e_g‘_pâ
(
¦3e
)); 
	}
}

84 #ià
SHADOW_PAGING_LEVELS
 >= 4

85 
šlše
 
mâ_t
 
	$shadow_l4e_g‘_mâ
(
shadow_l4e_t
 
¦4e
)

86 {  
	`_mâ
(
	`l4e_g‘_pâ
(
¦4e
)); 
	}
}

89 
šlše
 
u32
 
	$shadow_l1e_g‘_æags
(
shadow_l1e_t
 
¦1e
)

90 {  
	`l1e_g‘_æags
(
¦1e
); 
	}
}

91 
šlše
 
u32
 
	$shadow_l2e_g‘_æags
(
shadow_l2e_t
 
¦2e
)

92 {  
	`l2e_g‘_æags
(
¦2e
); 
	}
}

93 
šlše
 
u32
 
	$shadow_l3e_g‘_æags
(
shadow_l3e_t
 
¦3e
)

94 {  
	`l3e_g‘_æags
(
¦3e
); 
	}
}

95 #ià
SHADOW_PAGING_LEVELS
 >= 4

96 
šlše
 
u32
 
	$shadow_l4e_g‘_æags
(
shadow_l4e_t
 
¦4e
)

97 {  
	`l4e_g‘_æags
(
¦4e
); 
	}
}

100 
šlše
 
shadow_l1e_t


101 
	$shadow_l1e_»move_æags
(
shadow_l1e_t
 
¦1e
, 
u32
 
æags
)

102 { 
	`l1e_»move_æags
(
¦1e
, 
æags
);  sl1e; 
	}
}

104 
šlše
 
shadow_l1e_t
 
	$shadow_l1e_em±y
()

105 {  
	`l1e_em±y
(); 
	}
}

106 
šlše
 
shadow_l2e_t
 
	$shadow_l2e_em±y
()

107 {  
	`l2e_em±y
(); 
	}
}

108 
šlše
 
shadow_l3e_t
 
	$shadow_l3e_em±y
()

109 {  
	`l3e_em±y
(); 
	}
}

110 #ià
SHADOW_PAGING_LEVELS
 >= 4

111 
šlše
 
shadow_l4e_t
 
	$shadow_l4e_em±y
()

112 {  
	`l4e_em±y
(); 
	}
}

115 
šlše
 
shadow_l1e_t
 
	$shadow_l1e_äom_mâ
(
mâ_t
 
mâ
, 
u32
 
æags
)

116 {  
	`l1e_äom_pâ
(
	`mâ_x
(
mâ
), 
æags
); 
	}
}

117 
šlše
 
shadow_l2e_t
 
	$shadow_l2e_äom_mâ
(
mâ_t
 
mâ
, 
u32
 
æags
)

118 {  
	`l2e_äom_pâ
(
	`mâ_x
(
mâ
), 
æags
); 
	}
}

119 
šlše
 
shadow_l3e_t
 
	$shadow_l3e_äom_mâ
(
mâ_t
 
mâ
, 
u32
 
æags
)

120 {  
	`l3e_äom_pâ
(
	`mâ_x
(
mâ
), 
æags
); 
	}
}

121 #ià
SHADOW_PAGING_LEVELS
 >= 4

122 
šlše
 
shadow_l4e_t
 
	$shadow_l4e_äom_mâ
(
mâ_t
 
mâ
, 
u32
 
æags
)

123 {  
	`l4e_äom_pâ
(
	`mâ_x
(
mâ
), 
æags
); 
	}
}

126 
	#shadow_l1_bË_off£t
(
a
è
	`l1_bË_off£t
×)

	)

127 
	#shadow_l2_bË_off£t
(
a
è
	`l2_bË_off£t
×)

	)

128 
	#shadow_l3_bË_off£t
(
a
è
	`l3_bË_off£t
×)

	)

129 
	#shadow_l4_bË_off£t
(
a
è
	`l4_bË_off£t
×)

	)

135 
	#shadow_l1_lš—r_off£t
(
_a
) \

136 (((
_a
è& 
VADDR_MASK
è>> 
SHADOW_L1_PAGETABLE_SHIFT
)

	)

137 
	#shadow_l2_lš—r_off£t
(
_a
) \

138 (((
_a
è& 
VADDR_MASK
è>> 
SHADOW_L2_PAGETABLE_SHIFT
)

	)

139 
	#shadow_l3_lš—r_off£t
(
_a
) \

140 (((
_a
è& 
VADDR_MASK
è>> 
SHADOW_L3_PAGETABLE_SHIFT
)

	)

141 
	#shadow_l4_lš—r_off£t
(
_a
) \

142 (((
_a
è& 
VADDR_MASK
è>> 
SHADOW_L4_PAGETABLE_SHIFT
)

	)

149 
	#__sh_lš—r_l1_bË
 ((
shadow_l1e_t
 *)(
SH_LINEAR_PT_VIRT_START
))

	)

150 
	#__sh_lš—r_l2_bË
 ((
shadow_l2e_t
 *) \

151 (
__sh_lš—r_l1_bË
 + 
	`shadow_l1_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)))

	)

154 #ià
SHADOW_PAGING_LEVELS
 == 4

155 
	#__sh_lš—r_l3_bË
 ((
shadow_l3e_t
 *) \

156 (
__sh_lš—r_l2_bË
 + 
	`shadow_l2_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)))

	)

157 
	#__sh_lš—r_l4_bË
 ((
shadow_l4e_t
 *) \

158 (
__sh_lš—r_l3_bË
 + 
	`shadow_l3_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)))

	)

161 
	#sh_lš—r_l1_bË
(
v
) ({ \

162 
	`ASSERT
(
cu¼’t
 =ğ(
v
)); \

163 
__sh_lš—r_l1_bË
; \

164 })

	)

169 
	#sh_lš—r_l2_bË
(
v
) ({ \

170 
	`ASSERT
(
cu¼’t
 =ğ(
v
)); \

171 ((
shadow_l2e_t
 *) \

172 (
	`is_hvm_vıu
(
v
è? 
__lš—r_l1_bË
 : 
__sh_lš—r_l1_bË
) + \

173 
	`shadow_l1_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)); \

174 })

	)

176 #ià
SHADOW_PAGING_LEVELS
 >= 4

177 
	#sh_lš—r_l3_bË
(
v
) ({ \

178 
	`ASSERT
(
cu¼’t
 =ğ(
v
)); \

179 ((
shadow_l3e_t
 *) \

180 (
	`is_hvm_vıu
(
v
è? 
__lš—r_l2_bË
 : 
__sh_lš—r_l2_bË
) + \

181 
	`shadow_l2_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)); \

182 })

	)

186 
	#sh_lš—r_l4_bË
(
v
) ({ \

187 
	`ASSERT
(
cu¼’t
 =ğ(
v
)); \

188 ((
l4_pg’Œy_t
 *) \

189 (
	`is_hvm_vıu
(
v
è? 
__lš—r_l3_bË
 : 
__sh_lš—r_l3_bË
) + \

190 
	`shadow_l3_lš—r_off£t
(
SH_LINEAR_PT_VIRT_START
)); \

191 })

	)

195 #undeà
gâ_to_mâ_qu”y


196 
	#gâ_to_mâ_qu”y
(
d
, 
g
, 
t
è
	`_gâ_to_mâ_ty³
((d), 
	`gâ_x
(g), (t), 
p2m_qu”y
)

	)

197 #undeà
gâ_to_mâ_gue¡


198 
	#gâ_to_mâ_gue¡
(
d
, 
g
, 
t
è
	`_gâ_to_mâ_ty³
((d), 
	`gâ_x
(g), (t), 
p2m_gue¡
)

	)

202 #ià
GUEST_PAGING_LEVELS
 == 2

203 
	#SH_ty³_l1_shadow
 
SH_ty³_l1_32_shadow


	)

204 
	#SH_ty³_l2_shadow
 
SH_ty³_l2_32_shadow


	)

205 
	#SH_ty³_æ1_shadow
 
SH_ty³_æ1_32_shadow


	)

206 #–ià
GUEST_PAGING_LEVELS
 == 3

207 
	#SH_ty³_l1_shadow
 
SH_ty³_l1_·e_shadow


	)

208 
	#SH_ty³_æ1_shadow
 
SH_ty³_æ1_·e_shadow


	)

209 
	#SH_ty³_l2_shadow
 
SH_ty³_l2_·e_shadow


	)

210 
	#SH_ty³_l2h_shadow
 
SH_ty³_l2h_·e_shadow


	)

212 
	#SH_ty³_l1_shadow
 
SH_ty³_l1_64_shadow


	)

213 
	#SH_ty³_æ1_shadow
 
SH_ty³_æ1_64_shadow


	)

214 
	#SH_ty³_l2_shadow
 
SH_ty³_l2_64_shadow


	)

215 
	#SH_ty³_l2h_shadow
 
SH_ty³_l2h_64_shadow


	)

216 
	#SH_ty³_l3_shadow
 
SH_ty³_l3_64_shadow


	)

217 
	#SH_ty³_l4_shadow
 
SH_ty³_l4_64_shadow


	)

223 
	#INTERNAL_NAME
(
Çme
è
	`SHADOW_INTERNAL_NAME
Òame, 
GUEST_PAGING_LEVELS
)

	)

228 
	#sh_·ge_çuÉ
 
	`INTERNAL_NAME
(
sh_·ge_çuÉ
)

	)

229 
	#sh_švÍg
 
	`INTERNAL_NAME
(
sh_švÍg
)

	)

230 
	#sh_gva_to_gâ
 
	`INTERNAL_NAME
(
sh_gva_to_gâ
)

	)

231 
	#sh_upd©e_ü3
 
	`INTERNAL_NAME
(
sh_upd©e_ü3
)

	)

232 
	#sh_rm_wr™e_acûss_äom_l1
 
	`INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_l1
)

	)

233 
	#sh_rm_m­pšgs_äom_l1
 
	`INTERNAL_NAME
(
sh_rm_m­pšgs_äom_l1
)

	)

234 
	#sh_»move_l1_shadow
 
	`INTERNAL_NAME
(
sh_»move_l1_shadow
)

	)

235 
	#sh_»move_l2_shadow
 
	`INTERNAL_NAME
(
sh_»move_l2_shadow
)

	)

236 
	#sh_»move_l3_shadow
 
	`INTERNAL_NAME
(
sh_»move_l3_shadow
)

	)

237 
	#sh_m­_ªd_v®id©e_gl4e
 
	`INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl4e
)

	)

238 
	#sh_m­_ªd_v®id©e_gl3e
 
	`INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl3e
)

	)

239 
	#sh_m­_ªd_v®id©e_gl2e
 
	`INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2e
)

	)

240 
	#sh_m­_ªd_v®id©e_gl2he
 
	`INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl2he
)

	)

241 
	#sh_m­_ªd_v®id©e_gl1e
 
	`INTERNAL_NAME
(
sh_m­_ªd_v®id©e_gl1e
)

	)

242 
	#sh_de¡roy_l4_shadow
 
	`INTERNAL_NAME
(
sh_de¡roy_l4_shadow
)

	)

243 
	#sh_de¡roy_l3_shadow
 
	`INTERNAL_NAME
(
sh_de¡roy_l3_shadow
)

	)

244 
	#sh_de¡roy_l2_shadow
 
	`INTERNAL_NAME
(
sh_de¡roy_l2_shadow
)

	)

245 
	#sh_de¡roy_l1_shadow
 
	`INTERNAL_NAME
(
sh_de¡roy_l1_shadow
)

	)

246 
	#sh_unhook_32b_m­pšgs
 
	`INTERNAL_NAME
(
sh_unhook_32b_m­pšgs
)

	)

247 
	#sh_unhook_·e_m­pšgs
 
	`INTERNAL_NAME
(
sh_unhook_·e_m­pšgs
)

	)

248 
	#sh_unhook_64b_m­pšgs
 
	`INTERNAL_NAME
(
sh_unhook_64b_m­pšgs
)

	)

249 
	#sh_·gšg_mode
 
	`INTERNAL_NAME
(
sh_·gšg_mode
)

	)

250 
	#sh_d‘ach_Şd_bËs
 
	`INTERNAL_NAME
(
sh_d‘ach_Şd_bËs
)

	)

251 
	#sh_x86_emuÏ‹_wr™e
 
	`INTERNAL_NAME
(
sh_x86_emuÏ‹_wr™e
)

	)

252 
	#sh_x86_emuÏ‹_cmpxchg
 
	`INTERNAL_NAME
(
sh_x86_emuÏ‹_cmpxchg
)

	)

253 
	#sh_x86_emuÏ‹_cmpxchg8b
 
	`INTERNAL_NAME
(
sh_x86_emuÏ‹_cmpxchg8b
)

	)

254 
	#sh_aud™_l1_bË
 
	`INTERNAL_NAME
(
sh_aud™_l1_bË
)

	)

255 
	#sh_aud™_æ1_bË
 
	`INTERNAL_NAME
(
sh_aud™_æ1_bË
)

	)

256 
	#sh_aud™_l2_bË
 
	`INTERNAL_NAME
(
sh_aud™_l2_bË
)

	)

257 
	#sh_aud™_l3_bË
 
	`INTERNAL_NAME
(
sh_aud™_l3_bË
)

	)

258 
	#sh_aud™_l4_bË
 
	`INTERNAL_NAME
(
sh_aud™_l4_bË
)

	)

259 
	#sh_guess_wrm­
 
	`INTERNAL_NAME
(
sh_guess_wrm­
)

	)

260 
	#sh_ş—r_shadow_’Œy
 
	`INTERNAL_NAME
(
sh_ş—r_shadow_’Œy
)

	)

262 #ià
SHADOW_OPTIMIZATIONS
 & 
SHOPT_OUT_OF_SYNC


263 
	#sh_»sync_l1
 
	`INTERNAL_NAME
(
sh_»sync_l1
)

	)

264 
	#sh_§ã_nÙ_to_sync
 
	`INTERNAL_NAME
(
sh_§ã_nÙ_to_sync
)

	)

265 
	#sh_rm_wr™e_acûss_äom_¦1p
 
	`INTERNAL_NAME
(
sh_rm_wr™e_acûss_äom_¦1p
)

	)

269 
	#sh_gue¡_m­_l1e
 \

270 
	`SHADOW_INTERNAL_NAME
(
sh_gue¡_m­_l1e
, 
CONFIG_PAGING_LEVELS
)

	)

271 
	#sh_gue¡_g‘_eff_l1e
 \

272 
	`SHADOW_INTERNAL_NAME
(
sh_gue¡_g‘_eff_l1e
, 
CONFIG_PAGING_LEVELS
)

	)

275 
	#sh_make_mÚ™Ü_bË
 \

276 
	`SHADOW_INTERNAL_NAME
(
sh_make_mÚ™Ü_bË
, 
SHADOW_PAGING_LEVELS
)

	)

277 
	#sh_de¡roy_mÚ™Ü_bË
 \

278 
	`SHADOW_INTERNAL_NAME
(
sh_de¡roy_mÚ™Ü_bË
, 
SHADOW_PAGING_LEVELS
)

	)

280 #ià
SHADOW_PAGING_LEVELS
 == 3

281 
	#MFN_FITS_IN_HVM_CR3
(
_MFN
è!(
	`mâ_x
(_MFNè>> 20)

	)

284 
	#SH_PRI_±e
 
PRI±e


	)

285 
	#SH_PRI_g±e
 
PRI_g±e


	)

286 
	#SH_PRI_gâ
 
PRI_gâ


	)

289 #ià(
SHADOW_OPTIMIZATIONS
 & 
SHOPT_FAST_FAULT_PATH
)

302 
	#SH_L1E_MAGIC
 0xffffffff00000001ULL

	)

303 
šlše
 
	$sh_l1e_is_magic
(
shadow_l1e_t
 
¦1e
)

305  ((
¦1e
.
l1
 & 
SH_L1E_MAGIC
) == SH_L1E_MAGIC);

306 
	}
}

309 
šlše
 
shadow_l1e_t
 
	$sh_l1e_gÅ
()

311  (
shadow_l1e_t
){ -1ULL };

312 
	}
}

314 
šlše
 
	$sh_l1e_is_gÅ
(
shadow_l1e_t
 
¦1e
)

316  (
¦1e
.
l1
 =ğ
	`sh_l1e_gÅ
().l1);

317 
	}
}

323 
	#SH_L1E_MMIO_MAGIC
 0xffffffff00000001ULL

	)

324 
	#SH_L1E_MMIO_MAGIC_MASK
 0xffffffff00000009ULL

	)

325 
	#SH_L1E_MMIO_GFN_MASK
 0x00000000fffffff0ULL

	)

326 
	#SH_L1E_MMIO_GFN_SHIFT
 4

	)

328 
šlše
 
shadow_l1e_t
 
	$sh_l1e_mmio
(
gâ_t
 
gâ
, 
u32
 
gæags
)

330  (
shadow_l1e_t
è{ (
SH_L1E_MMIO_MAGIC


331 | (
	`gâ_x
(
gâ
è<< 
SH_L1E_MMIO_GFN_SHIFT
)

332 | (
gæags
 & (
_PAGE_USER
|
_PAGE_RW
))) };

333 
	}
}

335 
šlše
 
	$sh_l1e_is_mmio
(
shadow_l1e_t
 
¦1e
)

337  ((
¦1e
.
l1
 & 
SH_L1E_MMIO_MAGIC_MASK
è=ğ
SH_L1E_MMIO_MAGIC
);

338 
	}
}

340 
šlše
 
gâ_t
 
	$sh_l1e_mmio_g‘_gâ
(
shadow_l1e_t
 
¦1e
)

342  
	`_gâ
((
¦1e
.
l1
 & 
SH_L1E_MMIO_GFN_MASK
è>> 
SH_L1E_MMIO_GFN_SHIFT
);

343 
	}
}

345 
šlše
 
u32
 
	$sh_l1e_mmio_g‘_æags
(
shadow_l1e_t
 
¦1e
)

347  (
u32
)((
¦1e
.
l1
 & (
_PAGE_USER
|
_PAGE_RW
)));

348 
	}
}

352 
	#sh_l1e_gÅ
(è
	`shadow_l1e_em±y
()

	)

353 
	#sh_l1e_mmio
(
_gâ
, 
_æags
è
	`shadow_l1e_em±y
()

	)

354 
	#sh_l1e_is_magic
(
_e
è(0)

	)

	@mpparse.c

16 
	~<x’/cÚfig.h
>

17 
	~<x’/ty³s.h
>

18 
	~<x’/œq.h
>

19 
	~<x’/š™.h
>

20 
	~<x’/aıi.h
>

21 
	~<x’/d–ay.h
>

22 
	~<x’/sched.h
>

24 
	~<asm/mc146818¹c.h
>

25 
	~<asm/b™İs.h
>

26 
	~<asm/smp.h
>

27 
	~<asm/aıi.h
>

28 
	~<asm/mŒr.h
>

29 
	~<asm/mp¥ec.h
>

30 
	~<asm/io_­ic.h
>

32 
	~<mach_­ic.h
>

33 
	~<mach_mµ¬£.h
>

34 
	~<bios_ebda.h
>

37 
	gsmp_found_cÚfig
;

38 
__devš™d©a
 
	gmaxıus
 = 
NR_CPUS
;

44 
	g­ic_v”siÚ
 [
MAX_APICS
];

45 
	gmp_bus_id_to_ty³
 [
MAX_MP_BUSSES
];

46 
	gmp_bus_id_to_node
 [
MAX_MP_BUSSES
];

47 
	gmp_bus_id_to_loÿl
 [
MAX_MP_BUSSES
];

48 
	gmp_bus_id_to_pci_bus
 [
MAX_MP_BUSSES
] = { [0 ... MAX_MP_BUSSES-1] = -1 };

49 
	gmp_cu¼’t_pci_id
;

52 
mpc_cÚfig_ißpic
 
	gmp_ißpics
[
MAX_IO_APICS
];

55 
mpc_cÚfig_št¤c
 
	gmp_œqs
[
MAX_IRQ_SOURCES
];

58 
	gmp_œq_’Œ›s
;

60 
	gpic_mode
;

61 
	gmp_Ïpic_addr
;

63 
	gdef_to_bigsmp
 = 0;

66 
	gboÙ_ıu_physiÿl_­icid
 = -1U;

68 
__devš™d©a
 
	gnum_´oûssÜs
;

71 
physid_mask_t
 
	gphys_ıu_´e£Á_m­
;

82 
__š™
 
	$mpf_checksum
(*
mp
, 
Ën
)

84 
sum
 = 0;

86 
Ën
--)

87 
sum
 +ğ*
mp
++;

89  
sum
 & 0xFF;

90 
	}
}

98 
	gmpc_»cÜd
;

99 
mpc_cÚfig_Œª¦©iÚ
 *
	gŒª¦©iÚ_bË
[
MAX_MPC_ENTRY
] 
	g__š™d©a
;

102 
__devš™
 
	$MP_´oûssÜ_šfo_x
(
mpc_cÚfig_´oûssÜ
 *
m
,

103 
u32
 
­icidx
)

105 
v”
, 
­icid
, 
ıu
 = 0;

106 
physid_mask_t
 
phys_ıu
;

108 ià(!(
m
->
mpc_ıuæag
 & 
CPU_ENABLED
))

109  -
EINVAL
;

111 
­icid
 = 
	`mpc_­ic_id
(
m
, 
­icidx
, 
Œª¦©iÚ_bË
[
mpc_»cÜd
]);

113 ià(
m
->
mpc_ã©u»æag
&(1<<0))

114 
	`D´štk
(" Floating…oint unit…resent.\n");

115 ià(
m
->
mpc_ã©u»æag
&(1<<7))

116 
	`D´štk
(" Machine Exception supported.\n");

117 ià(
m
->
mpc_ã©u»æag
&(1<<8))

118 
	`D´štk
(" 64 bit compare &ƒxchange supported.\n");

119 ià(
m
->
mpc_ã©u»æag
&(1<<9))

120 
	`D´štk
(" Internal APIC…resent.\n");

121 ià(
m
->
mpc_ã©u»æag
&(1<<11))

122 
	`D´štk
(" SEP…resent.\n");

123 ià(
m
->
mpc_ã©u»æag
&(1<<12))

124 
	`D´štk
(" MTRR…resent.\n");

125 ià(
m
->
mpc_ã©u»æag
&(1<<13))

126 
	`D´štk
(" PGE…resent.\n");

127 ià(
m
->
mpc_ã©u»æag
&(1<<14))

128 
	`D´štk
(" MCA…resent.\n");

129 ià(
m
->
mpc_ã©u»æag
&(1<<15))

130 
	`D´štk
(" CMOV…resent.\n");

131 ià(
m
->
mpc_ã©u»æag
&(1<<16))

132 
	`D´štk
(" PAT…resent.\n");

133 ià(
m
->
mpc_ã©u»æag
&(1<<17))

134 
	`D´štk
(" PSE…resent.\n");

135 ià(
m
->
mpc_ã©u»æag
&(1<<18))

136 
	`D´štk
(" PSN…resent.\n");

137 ià(
m
->
mpc_ã©u»æag
&(1<<19))

138 
	`D´štk
(" Cache Line Flush Instruction…resent.\n");

140 ià(
m
->
mpc_ã©u»æag
&(1<<21))

141 
	`D´štk
(" Debug Trace‡nd EMON Store…resent.\n");

142 ià(
m
->
mpc_ã©u»æag
&(1<<22))

143 
	`D´štk
(" ACPI Thermal Throttle Registers…resent.\n");

144 ià(
m
->
mpc_ã©u»æag
&(1<<23))

145 
	`D´štk
(" MMX…resent.\n");

146 ià(
m
->
mpc_ã©u»æag
&(1<<24))

147 
	`D´štk
(" FXSR…resent.\n");

148 ià(
m
->
mpc_ã©u»æag
&(1<<25))

149 
	`D´štk
(" XMM…resent.\n");

150 ià(
m
->
mpc_ã©u»æag
&(1<<26))

151 
	`D´štk
(" Willamette New Instructions…resent.\n");

152 ià(
m
->
mpc_ã©u»æag
&(1<<27))

153 
	`D´štk
(" Self Snoop…resent.\n");

154 ià(
m
->
mpc_ã©u»æag
&(1<<28))

155 
	`D´štk
(" HT…resent.\n");

156 ià(
m
->
mpc_ã©u»æag
&(1<<29))

157 
	`D´štk
(" Thermal Monitor…resent.\n");

161 ià(
m
->
mpc_ıuæag
 & 
CPU_BOOTPROCESSOR
) {

162 
	`D´štk
(" Bootup CPU\n");

163 
boÙ_ıu_physiÿl_­icid
 = 
­icid
;

166 
v”
 = 
m
->
mpc_­icv”
;

171 ià(
v”
 == 0x0) {

172 
	`´štk
(
KERN_WARNING
 "BIOS bug, APIC version is 0 for CPU#%d! "

174 
­icid
);

175 
v”
 = 0x10;

177 
­ic_v”siÚ
[
­icid
] = 
v”
;

179 
phys_ıu
 = 
	`­icid_to_ıu_´e£Á
(
­icid
);

180 
	`physids_Ü
(
phys_ıu_´e£Á_m­
,…hys_ıu_´e£Á_m­, 
phys_ıu
);

182 ià(
num_´oûssÜs
 >ğ
NR_CPUS
) {

183 
	`´štk
(
KERN_WARNING
 "WARNING: NR_CPUS†imit of %i„eached."

184 " ProûssÜ ignÜed.\n", 
NR_CPUS
);

185  -
ENOSPC
;

188 ià(
num_´oûssÜs
 >ğ
maxıus
) {

189 
	`´štk
(
KERN_WARNING
 "WARNING: maxcpus†imit of %i„eached."

190 " ProûssÜ ignÜed.\n", 
maxıus
);

191  -
ENOSPC
;

195 ià(!(
m
->
mpc_ıuæag
 & 
CPU_BOOTPROCESSOR
)) {

196 
ıu
 = 
	`®loc_ıu_id
();

197 ià(
ıu
 < 0) {

198 
	`´štk
(
KERN_WARNING
 "WARNING: Can't‡lloc cpu_id."

199 " ProûssÜ w™h‡picid %˜ignÜed\n", 
­icid
);

200  
ıu
;

202 
x86_ıu_to_­icid
[
ıu
] = 
­icid
;

203 
	`ıu_£t
(
ıu
, 
ıu_´e£Á_m­
);

206 ià(++
num_´oûssÜs
 > 8) {

211 
def_to_bigsmp
 = 1;

214  
ıu
;

215 
	}
}

217 
__devš™
 
	$MP_´oûssÜ_šfo
(
mpc_cÚfig_´oûssÜ
 *
m
)

219  
	`MP_´oûssÜ_šfo_x
(
m
, m->
mpc_­icid
);

220 
	}
}

222 
__š™
 
	$MP_bus_šfo
 (
mpc_cÚfig_bus
 *
m
)

224 
¡r
[7];

226 
	`memıy
(
¡r
, 
m
->
mpc_bu¡y³
, 6);

227 
¡r
[6] = 0;

229 
	`mpc_Ûm_bus_šfo
(
m
, 
¡r
, 
Œª¦©iÚ_bË
[
mpc_»cÜd
]);

232 ià(
m
->
mpc_busid
 >ğ
MAX_MP_BUSSES
) {

233 
	`´štk
(
KERN_WARNING
 "MPable busid value (%d) for bustype %s "

235 
m
->
mpc_busid
, 
¡r
, 
MAX_MP_BUSSES
 - 1);

240 ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_ISA
, (BUSTYPE_ISA)-1) == 0) {

241 
mp_bus_id_to_ty³
[
m
->
mpc_busid
] = 
MP_BUS_ISA
;

242 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_EISA
, (BUSTYPE_EISA)-1) == 0) {

243 
mp_bus_id_to_ty³
[
m
->
mpc_busid
] = 
MP_BUS_EISA
;

244 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_PCI
, (BUSTYPE_PCI)-1) == 0) {

245 
	`mpc_Ûm_pci_bus
(
m
, 
Œª¦©iÚ_bË
[
mpc_»cÜd
]);

246 
mp_bus_id_to_ty³
[
m
->
mpc_busid
] = 
MP_BUS_PCI
;

247 
mp_bus_id_to_pci_bus
[
m
->
mpc_busid
] = 
mp_cu¼’t_pci_id
;

248 
mp_cu¼’t_pci_id
++;

249 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_MCA
, (BUSTYPE_MCA)-1) == 0) {

250 
mp_bus_id_to_ty³
[
m
->
mpc_busid
] = 
MP_BUS_MCA
;

251 } ià(
	`¡ºcmp
(
¡r
, 
BUSTYPE_NEC98
, (BUSTYPE_NEC98)-1) == 0) {

252 
mp_bus_id_to_ty³
[
m
->
mpc_busid
] = 
MP_BUS_NEC98
;

254 
	`´štk
(
KERN_WARNING
 "UnknowÀbu¡y³ % - ignÜšg\n", 
¡r
);

256 
	}
}

258 
__š™
 
	$MP_ißpic_šfo
 (
mpc_cÚfig_ißpic
 *
m
)

260 ià(!(
m
->
mpc_æags
 & 
MPC_APIC_USABLE
))

263 
	`´štk
(
KERN_INFO
 "I/O APIC #%d Version %d‡t 0x%X.\n",

264 
m
->
mpc_­icid
, m->
mpc_­icv”
, m->
mpc_­iÿddr
);

265 ià(
Ä_ißpics
 >ğ
MAX_IO_APICS
) {

266 
	`´štk
(
KERN_CRIT
 "Max # of I/O APICs (%d)ƒxceeded (found %d).\n",

267 
MAX_IO_APICS
, 
Ä_ißpics
);

268 
	`·nic
("Recompile kernel with bigger MAX_IO_APICS!.\n");

270 ià(!
m
->
mpc_­iÿddr
) {

271 
	`´štk
(
KERN_ERR
 "WARNING: bogus zero I/O APIC‡ddress"

275 
mp_ißpics
[
Ä_ißpics
] = *
m
;

276 
Ä_ißpics
++;

277 
	}
}

279 
__š™
 
	$MP_št¤c_šfo
 (
mpc_cÚfig_št¤c
 *
m
)

281 
mp_œqs
 [
mp_œq_’Œ›s
] = *
m
;

282 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d,"

284 
m
->
mpc_œqty³
, m->
mpc_œqæag
 & 3,

285 (
m
->
mpc_œqæag
 >> 2è& 3, m->
mpc_¤cbus
,

286 
m
->
mpc_¤cbusœq
, m->
mpc_d¡­ic
, m->
mpc_d¡œq
);

287 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

288 
	`·nic
("Max # of irq sourcesƒxceeded!!\n");

289 
	}
}

291 
__š™
 
	$MP_lšt¤c_šfo
 (
mpc_cÚfig_lšt¤c
 *
m
)

293 
	`D´štk
("Lint:ype %d,…ol %d,rig %d, bus %d,"

295 
m
->
mpc_œqty³
, m->
mpc_œqæag
 & 3,

296 (
m
->
mpc_œqæag
 >> 2è&3, m->
mpc_¤cbusid
,

297 
m
->
mpc_¤cbusœq
, m->
mpc_de¡­ic
, m->
mpc_de¡­işšt
);

305 ià((
m
->
mpc_œqty³
 =ğ
mp_ExtINT
) &&

306 (
m
->
mpc_de¡­işšt
 != 0))

307 
	`BUG
();

308 ià((
m
->
mpc_œqty³
 =ğ
mp_NMI
) &&

309 (
m
->
mpc_de¡­işšt
 != 1))

310 
	`BUG
();

311 
	}
}

313 #ifdeà
CONFIG_X86_NUMAQ


314 
__š™
 
	$MP_Œª¦©iÚ_šfo
 (
mpc_cÚfig_Œª¦©iÚ
 *
m
)

316 
	`´štk
(
KERN_INFO
 "T¿n¦©iÚ:„ecÜd %d,y³ %d, quad %d, glob® %d,†oÿÈ%d\n", 
mpc_»cÜd
, 
m
->
Œªs_ty³
, m->
Œªs_quad
, m->
Œªs_glob®
, m->
Œªs_loÿl
);

318 ià(
mpc_»cÜd
 >ğ
MAX_MPC_ENTRY
)

319 
	`´štk
(
KERN_ERR
 "MAX_MPC_ENTRYƒxceeded!\n");

321 
Œª¦©iÚ_bË
[
mpc_»cÜd
] = 
m
;

322 ià(
m
->
Œªs_quad
 < 
MAX_NUMNODES
 && !
	`node_Úlše
(m->trans_quad))

323 
	`node_£t_Úlše
(
m
->
Œªs_quad
);

324 
	}
}

330 
__š™
 
smp_»ad_mpc_Ûm
(
mp_cÚfig_ÛmbË
 *
ÛmbË
, \

331 
Ûmsize
)

333 
	gcouÁ
 =  (*
ÛmbË
);

334 *
	gÛm±r
 = ((*)
ÛmbË
)+
couÁ
;

336 
	gmpc_»cÜd
 = 0;

337 
´štk
(
KERN_INFO
 "Found‡ÀOEM MPCabË‡ˆ%8°-…¬sšg iˆ... \n", 
ÛmbË
);

338 ià(
memcmp
(
ÛmbË
->
Ûm_sigÇtu»
,
MPC_OEM_SIGNATURE
,4))

340 
´štk
(
KERN_WARNING
 "SMP mpc oemtable: bad signature [%c%c%c%c]!\n",

341 
ÛmbË
->
Ûm_sigÇtu»
[0],

342 
ÛmbË
->
Ûm_sigÇtu»
[1],

343 
ÛmbË
->
Ûm_sigÇtu»
[2],

344 
ÛmbË
->
Ûm_sigÇtu»
[3]);

347 ià(
mpf_checksum
((*)
ÛmbË
,ÛmbË->
Ûm_Ëngth
))

349 
´štk
(
KERN_WARNING
 "SMP oem mptable: checksumƒrror!\n");

352 
	gcouÁ
 < 
	gÛmbË
->
	gÛm_Ëngth
) {

353 *
	gÛm±r
) {

354 
	gMP_TRANSLATION
:

356 
mpc_cÚfig_Œª¦©iÚ
 *
m
=

357 (
mpc_cÚfig_Œª¦©iÚ
 *)
Ûm±r
;

358 
MP_Œª¦©iÚ_šfo
(
m
);

359 
	gÛm±r
 +ğ(*
m
);

360 
	gcouÁ
 +ğ(*
m
);

361 ++
	gmpc_»cÜd
;

366 
´štk
(
KERN_WARNING
 "UÄecogni£d OEMabËƒÁryy³! - %d\n", (è*
Ûm±r
);

373 
šlše
 
	$mps_Ûm_check
(
mp_cÚfig_bË
 *
mpc
, *
Ûm
,

374 *
´oduùid
)

376 ià(
	`¡ºcmp
(
Ûm
, "IBM NUMA", 8))

377 
	`´štk
("Warning! May‚ot be‡ NUMA-Q system!\n");

378 ià(
mpc
->
mpc_Ûm±r
)

379 
	`smp_»ad_mpc_Ûm
((
mp_cÚfig_ÛmbË
 *è
mpc
->
mpc_Ûm±r
,

380 
mpc
->
mpc_Ûmsize
);

381 
	}
}

388 
__š™
 
	$smp_»ad_mpc
(
mp_cÚfig_bË
 *
mpc
)

390 
¡r
[16];

391 
Ûm
[10];

392 
couÁ
=(*
mpc
);

393 *
m±
=((*)
mpc
)+
couÁ
;

395 ià(
	`memcmp
(
mpc
->
mpc_sigÇtu»
,
MPC_SIGNATURE
,4)) {

396 
	`´štk
(
KERN_ERR
 "SMP mptable: bad signature [0x%x]!\n",

397 *(
u32
 *)
mpc
->
mpc_sigÇtu»
);

400 ià(
	`mpf_checksum
((*)
mpc
,mpc->
mpc_Ëngth
)) {

401 
	`´štk
(
KERN_ERR
 "SMP mptable: checksumƒrror!\n");

404 ià(
mpc
->
mpc_¥ec
!=0x01 && mpc->mpc_spec!=0x04) {

405 
	`´štk
(
KERN_ERR
 "SMP mptable: badable version (%d)!!\n",

406 
mpc
->
mpc_¥ec
);

409 ià(!
mpc
->
mpc_Ïpic
) {

410 
	`´štk
(
KERN_ERR
 "SMP mptable:‚ull†ocal APIC‡ddress!\n");

413 
	`memıy
(
Ûm
,
mpc
->
mpc_Ûm
,8);

414 
Ûm
[8]=0;

415 
	`´štk
(
KERN_INFO
 "OEM ID: % ",
Ûm
);

417 
	`memıy
(
¡r
,
mpc
->
mpc_´oduùid
,12);

418 
¡r
[12]=0;

419 
	`´štk
("Produù ID: % ",
¡r
);

421 
	`mps_Ûm_check
(
mpc
, 
Ûm
, 
¡r
);

423 
	`´štk
("APIC‡t: 0x%X\n",
mpc
->
mpc_Ïpic
);

429 ià(!
aıi_Ïpic
)

430 
mp_Ïpic_addr
 = 
mpc
->
mpc_Ïpic
;

435 
mpc_»cÜd
 = 0;

436 
couÁ
 < 
mpc
->
mpc_Ëngth
) {

437 *
m±
) {

438 
MP_PROCESSOR
:

440 
mpc_cÚfig_´oûssÜ
 *
m
=

441 (
mpc_cÚfig_´oûssÜ
 *)
m±
;

443 ià(!
aıi_Ïpic
)

444 
	`MP_´oûssÜ_šfo
(
m
);

445 
m±
 +ğ(*
m
);

446 
couÁ
 +ğ(*
m
);

449 
MP_BUS
:

451 
mpc_cÚfig_bus
 *
m
=

452 (
mpc_cÚfig_bus
 *)
m±
;

453 
	`MP_bus_šfo
(
m
);

454 
m±
 +ğ(*
m
);

455 
couÁ
 +ğ(*
m
);

458 
MP_IOAPIC
:

460 
mpc_cÚfig_ißpic
 *
m
=

461 (
mpc_cÚfig_ißpic
 *)
m±
;

462 
	`MP_ißpic_šfo
(
m
);

463 
m±
+=(*
m
);

464 
couÁ
+=(*
m
);

467 
MP_INTSRC
:

469 
mpc_cÚfig_št¤c
 *
m
=

470 (
mpc_cÚfig_št¤c
 *)
m±
;

472 
	`MP_št¤c_šfo
(
m
);

473 
m±
+=(*
m
);

474 
couÁ
+=(*
m
);

477 
MP_LINTSRC
:

479 
mpc_cÚfig_lšt¤c
 *
m
=

480 (
mpc_cÚfig_lšt¤c
 *)
m±
;

481 
	`MP_lšt¤c_šfo
(
m
);

482 
m±
+=(*
m
);

483 
couÁ
+=(*
m
);

488 
couÁ
 = 
mpc
->
mpc_Ëngth
;

492 ++
mpc_»cÜd
;

494 
	`şu¡”ed_­ic_check
();

495 ià(!
num_´oûssÜs
)

496 
	`´štk
(
KERN_ERR
 "SMP mptable:‚o…rocessors„egistered!\n");

497  
num_´oûssÜs
;

498 
	}
}

500 
__š™
 
	$ELCR_Œigg”
(
œq
)

502 
pÜt
;

504 
pÜt
 = 0x4d0 + (
œq
 >> 3);

505  (
	`šb
(
pÜt
è>> (
œq
 & 7)) & 1;

506 
	}
}

508 
__š™
 
	$cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
)

510 
mpc_cÚfig_št¤c
 
št¤c
;

511 
i
;

512 
ELCR_çÎback
 = 0;

514 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

515 
št¤c
.
mpc_œqæag
 = 0;

516 
št¤c
.
mpc_¤cbus
 = 0;

517 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[0].
mpc_­icid
;

519 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

529 ià(
mpc_deçuÉ_ty³
 == 5) {

530 
	`´štk
(
KERN_INFO
 "ISA/PCI busype with‚o IRQ information... falling backo ELCR\n");

532 ià(
	`ELCR_Œigg”
(0) || ELCR_trigger(1) || ELCR_trigger(2) || ELCR_trigger(13))

533 
	`´štk
(
KERN_WARNING
 "ELCR contains invalid data...‚ot using ELCR\n");

535 
	`´štk
(
KERN_INFO
 "Using ELCRo identify PCI interrupts\n");

536 
ELCR_çÎback
 = 1;

540 
i
 = 0; 
	`¶©fÜm_Ëgacy_œq
(i); i++) {

541 
mpc_deçuÉ_ty³
) {

543 ià(
i
 == 0 || i == 13)

547 ià(
i
 == 2)

551 ià(
ELCR_çÎback
) {

557 ià(
	`ELCR_Œigg”
(
i
))

558 
št¤c
.
mpc_œqæag
 = 13;

560 
št¤c
.
mpc_œqæag
 = 0;

563 
št¤c
.
mpc_¤cbusœq
 = 
i
;

564 
št¤c
.
mpc_d¡œq
 = 
i
 ? i : 2;

565 
	`MP_št¤c_šfo
(&
št¤c
);

568 
št¤c
.
mpc_œqty³
 = 
mp_ExtINT
;

569 
št¤c
.
mpc_¤cbusœq
 = 0;

570 
št¤c
.
mpc_d¡œq
 = 0;

571 
	`MP_št¤c_šfo
(&
št¤c
);

572 
	}
}

574 
šlše
 
__š™
 
	$cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpc_deçuÉ_ty³
)

576 
mpc_cÚfig_´oûssÜ
 
´oûssÜ
;

577 
mpc_cÚfig_bus
 
bus
;

578 
mpc_cÚfig_ißpic
 
ißpic
;

579 
mpc_cÚfig_lšt¤c
 
lšt¤c
;

580 
lš‰y³s
[2] = { 
mp_ExtINT
, 
mp_NMI
 };

581 
i
;

586 
mp_Ïpic_addr
 = 
APIC_DEFAULT_PHYS_BASE
;

591 
´oûssÜ
.
mpc_ty³
 = 
MP_PROCESSOR
;

593 
´oûssÜ
.
mpc_­icv”
 = 
mpc_deçuÉ_ty³
 > 4 ? 0x10 : 0x01;

594 
´oûssÜ
.
mpc_ıuæag
 = 
CPU_ENABLED
;

595 
´oûssÜ
.
mpc_ıuã©u»
 = (
boÙ_ıu_d©a
.
x86
 << 8) |

596 (
boÙ_ıu_d©a
.
x86_mod–
 << 4) |

597 
boÙ_ıu_d©a
.
x86_mask
;

598 
´oûssÜ
.
mpc_ã©u»æag
 = 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[0];

599 
´oûssÜ
.
mpc_»£rved
[0] = 0;

600 
´oûssÜ
.
mpc_»£rved
[1] = 0;

601 
i
 = 0; i < 2; i++) {

602 
´oûssÜ
.
mpc_­icid
 = 
i
;

603 
	`MP_´oûssÜ_šfo
(&
´oûssÜ
);

606 
bus
.
mpc_ty³
 = 
MP_BUS
;

607 
bus
.
mpc_busid
 = 0;

608 
mpc_deçuÉ_ty³
) {

610 
	`´štk
("???\n");

611 
	`´štk
(
KERN_ERR
 "Unknown standard configuration %d\n",

612 
mpc_deçuÉ_ty³
);

616 
	`memıy
(
bus
.
mpc_bu¡y³
, "ISA ", 6);

621 
	`memıy
(
bus
.
mpc_bu¡y³
, "EISA ", 6);

625 
	`memıy
(
bus
.
mpc_bu¡y³
, "MCA ", 6);

627 
	`MP_bus_šfo
(&
bus
);

628 ià(
mpc_deçuÉ_ty³
 > 4) {

629 
bus
.
mpc_busid
 = 1;

630 
	`memıy
(
bus
.
mpc_bu¡y³
, "PCI ", 6);

631 
	`MP_bus_šfo
(&
bus
);

634 
ißpic
.
mpc_ty³
 = 
MP_IOAPIC
;

635 
ißpic
.
mpc_­icid
 = 2;

636 
ißpic
.
mpc_­icv”
 = 
mpc_deçuÉ_ty³
 > 4 ? 0x10 : 0x01;

637 
ißpic
.
mpc_æags
 = 
MPC_APIC_USABLE
;

638 
ißpic
.
mpc_­iÿddr
 = 0xFEC00000;

639 
	`MP_ißpic_šfo
(&
ißpic
);

644 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(
mpc_deçuÉ_ty³
);

646 
lšt¤c
.
mpc_ty³
 = 
MP_LINTSRC
;

647 
lšt¤c
.
mpc_œqæag
 = 0;

648 
lšt¤c
.
mpc_¤cbusid
 = 0;

649 
lšt¤c
.
mpc_¤cbusœq
 = 0;

650 
lšt¤c
.
mpc_de¡­ic
 = 
MP_APIC_ALL
;

651 
i
 = 0; i < 2; i++) {

652 
lšt¤c
.
mpc_œqty³
 = 
lš‰y³s
[
i
];

653 
lšt¤c
.
mpc_de¡­işšt
 = 
i
;

654 
	`MP_lšt¤c_šfo
(&
lšt¤c
);

656 
	}
}

658 
š‹l_mp_æßtšg
 *
	gmpf_found
;

663 
__š™
 
	$g‘_smp_cÚfig
 ()

665 
š‹l_mp_æßtšg
 *
mpf
 = 
mpf_found
;

671 ià(
aıi_Ïpic
 && 
aıi_ißpic
) {

672 
	`´štk
(
KERN_INFO
 "Using ACPI (MADT) for SMP configuration information\n");

675 ià(
aıi_Ïpic
)

676 
	`´štk
(
KERN_INFO
 "Using ACPI for…rocessor (LAPIC) configuration information\n");

678 
	`´štk
(
KERN_INFO
 "IÁ– MuÉiProûssÜ S³cifiÿtiÚ v1.%d\n", 
mpf
->
mpf_¥ecifiÿtiÚ
);

679 ià(
mpf
->
mpf_ã©u»2
 & (1<<7)) {

680 
	`´štk
(
KERN_INFO
 " IMCR‡nd PIC compatibility mode.\n");

681 
pic_mode
 = 1;

683 
	`´štk
(
KERN_INFO
 " Virtual Wire compatibility mode.\n");

684 
pic_mode
 = 0;

690 ià(
mpf
->
mpf_ã©u»1
 != 0) {

692 
	`´štk
(
KERN_INFO
 "DeçuÉ MP cÚfigu¿tiÚ #%d\n", 
mpf
->
mpf_ã©u»1
);

693 
	`cÚ¡ruù_deçuÉ_ISA_m±abË
(
mpf
->
mpf_ã©u»1
);

695 } ià(
mpf
->
mpf_phy¥Œ
) {

701 ià(!
	`smp_»ad_mpc
((*)()
mpf
->
mpf_phy¥Œ
)) {

702 
smp_found_cÚfig
 = 0;

703 
	`´štk
(
KERN_ERR
 "BIOS bug, MPableƒrrors detected!...\n");

704 
	`´štk
(
KERN_ERR
 "... disabling SMP support. (tell your hw vendor)\n");

712 ià(!
mp_œq_’Œ›s
) {

713 
mpc_cÚfig_bus
 
bus
;

715 
	`´štk
(
KERN_ERR
 "BIOS bug,‚oƒxplicit IRQƒntries, using default mptable. (tell your hw vendor)\n");

717 
bus
.
mpc_ty³
 = 
MP_BUS
;

718 
bus
.
mpc_busid
 = 0;

719 
	`memıy
(
bus
.
mpc_bu¡y³
, "ISA ", 6);

720 
	`MP_bus_šfo
(&
bus
);

722 
	`cÚ¡ruù_deçuÉ_ioœq_m±abË
(0);

726 
	`BUG
();

728 
	`´štk
(
KERN_INFO
 "ProûssÜs: %d\n", 
num_´oûssÜs
);

732 
	}
}

734 
__š™
 
	$smp_sÿn_cÚfig
 (
ba£
, 
Ëngth
)

736 *
bp
 = 
	`maddr_to_vœt
(
ba£
);

737 
š‹l_mp_æßtšg
 *
mpf
;

739 
	`D´štk
("SÿÀSMP from %°fÜ %ld by‹s.\n", 
bp
,
Ëngth
);

740 ià((*
mpf
) != 16)

741 
	`´štk
("Error: MPF size\n");

743 
Ëngth
 > 0) {

744 
mpf
 = (
š‹l_mp_æßtšg
 *)
bp
;

745 ià((*
bp
 =ğ
SMP_MAGIC_IDENT
) &&

746 (
mpf
->
mpf_Ëngth
 == 1) &&

747 !
	`mpf_checksum
((*)
bp
, 16) &&

748 ((
mpf
->
mpf_¥ecifiÿtiÚ
 == 1)

749 || (
mpf
->
mpf_¥ecifiÿtiÚ
 == 4)) ) {

751 
smp_found_cÚfig
 = 1;

752 
	`´štk
(
KERN_INFO
 "found SMP MP-table‡t %08lx\n",

753 
	`vœt_to_maddr
(
mpf
));

755 
	`»£rve_boÙmem
(
	`vœt_to_maddr
(
mpf
), 
PAGE_SIZE
);

756 ià(
mpf
->
mpf_phy¥Œ
) {

766 
size
 = 
PAGE_SIZE
;

767 
’d
 = 
max_low_pâ
 * 
PAGE_SIZE
;

768 ià(
mpf
->
mpf_phy¥Œ
 + 
size
 > 
’d
)

769 
size
 = 
’d
 - 
mpf
->
mpf_phy¥Œ
;

770 
	`»£rve_boÙmem
(
mpf
->
mpf_phy¥Œ
, 
size
);

773 
mpf_found
 = 
mpf
;

776 
bp
 += 4;

777 
Ëngth
 -= 16;

780 
	}
}

782 
__š™
 
	$fšd_smp_cÚfig
 ()

784 
add»ss
;

794 ià(
	`smp_sÿn_cÚfig
(0x0,0x400) ||

795 
	`smp_sÿn_cÚfig
(639*0x400,0x400) ||

796 
	`smp_sÿn_cÚfig
(0xF0000,0x10000))

815 
add»ss
 = 
	`g‘_bios_ebda
();

816 ià(
add»ss
)

817 
	`smp_sÿn_cÚfig
(
add»ss
, 0x400);

818 
	}
}

824 #ifdeà
CONFIG_ACPI


826 
__š™
 
	$mp_»gi¡”_Ïpic_add»ss
 (

827 
u64
 
add»ss
)

829 ià(!
x2­ic_’abËd
) {

830 
mp_Ïpic_addr
 = (è
add»ss
;

831 
	`£t_fixm­_noÿche
(
FIX_APIC_BASE
, 
mp_Ïpic_addr
);

834 ià(
boÙ_ıu_physiÿl_­icid
 == -1U)

835 
boÙ_ıu_physiÿl_­icid
 = 
	`g‘_­ic_id
();

837 
	`D´štk
("BoÙ CPU = %d\n", 
boÙ_ıu_physiÿl_­icid
);

838 
	}
}

841 
__devš™
 
	$mp_»gi¡”_Ïpic
 (

842 
u32
 
id
,

843 
u8
 
’abËd
)

845 
mpc_cÚfig_´oûssÜ
 
´oûssÜ
;

846 
boÙ_ıu
 = 0;

848 ià(
MAX_APICS
 <ğ
id
) {

849 
	`´štk
(
KERN_WARNING
 "Processor #%d invalid (max %d)\n",

850 
id
, 
MAX_APICS
);

851  -
EINVAL
;

854 ià(
id
 =ğ
boÙ_ıu_physiÿl_­icid
)

855 
boÙ_ıu
 = 1;

857 
´oûssÜ
.
mpc_ty³
 = 
MP_PROCESSOR
;

858 
´oûssÜ
.
mpc_­icid
 = 
id
;

859 
´oûssÜ
.
mpc_­icv”
 = 
	`GET_APIC_VERSION
(
	`­ic_»ad
(
APIC_LVR
));

860 
´oûssÜ
.
mpc_ıuæag
 = (
’abËd
 ? 
CPU_ENABLED
 : 0);

861 
´oûssÜ
.
mpc_ıuæag
 |ğ(
boÙ_ıu
 ? 
CPU_BOOTPROCESSOR
 : 0);

862 
´oûssÜ
.
mpc_ıuã©u»
 = (
boÙ_ıu_d©a
.
x86
 << 8) |

863 (
boÙ_ıu_d©a
.
x86_mod–
 << 4è| boÙ_ıu_d©a.
x86_mask
;

864 
´oûssÜ
.
mpc_ã©u»æag
 = 
boÙ_ıu_d©a
.
x86_ÿ·b™y
[0];

865 
´oûssÜ
.
mpc_»£rved
[0] = 0;

866 
´oûssÜ
.
mpc_»£rved
[1] = 0;

868  
	`MP_´oûssÜ_šfo_x
(&
´oûssÜ
, 
id
);

869 
	}
}

871 
	$mp_uÄegi¡”_Ïpic
(
ušt32_t
 
­ic_id
, ušt32_ˆ
ıu
)

873 ià(!
ıu
 || (
­ic_id
 =ğ
boÙ_ıu_physiÿl_­icid
))

876 ià(
x86_ıu_to_­icid
[
ıu
] !ğ
­ic_id
)

879 
	`physid_ş—r
(
­ic_id
, 
phys_ıu_´e£Á_m­
);

881 
x86_ıu_to_­icid
[
ıu
] = 
BAD_APICID
;

882 
	`ıu_ş—r
(
ıu
, 
ıu_´e£Á_m­
);

883 
	}
}

885 #ifdef 
CONFIG_X86_IO_APIC


887 
	#MP_ISA_BUS
 0

	)

888 
	#MP_MAX_IOAPIC_PIN
 127

	)

890 
	smp_ißpic_routšg
 {

891 
	m­ic_id
;

892 
	mgsi_ba£
;

893 
	mgsi_’d
;

894 
u32
 
	mpš_´og¿mmed
[4];

895 } 
	gmp_ißpic_routšg
[
MAX_IO_APICS
];

898 
	$mp_fšd_ißpic
 (

899 
gsi
)

901 
i
 = 0;

904 
i
 = 0; i < 
Ä_ißpics
; i++) {

905 ià((
gsi
 >ğ
mp_ißpic_routšg
[
i
].
gsi_ba£
)

906 && (
gsi
 <ğ
mp_ißpic_routšg
[
i
].
gsi_’d
))

907  
i
;

910 
	`´štk
(
KERN_ERR
 "ERROR: UÇbËØloÿ‹ IOAPIC fÜ GSI %d\n", 
gsi
);

913 
	}
}

916 
__š™
 
	$mp_»gi¡”_ißpic
 (

917 
u8
 
id
,

918 
u32
 
add»ss
,

919 
u32
 
gsi_ba£
)

921 
idx
 = 0;

922 
tmpid
;

924 ià(
Ä_ißpics
 >ğ
MAX_IO_APICS
) {

925 
	`´štk
(
KERN_ERR
 "ERROR: Max # of I/O APICs (%d)ƒxceeded "

926 "(found %d)\n", 
MAX_IO_APICS
, 
Ä_ißpics
);

927 
	`·nic
("Recompile kernel with bigger MAX_IO_APICS!\n");

929 ià(!
add»ss
) {

930 
	`´štk
(
KERN_ERR
 "WARNING: Bogus (zero) I/O APIC‡ddress"

935 
idx
 = 
Ä_ißpics
++;

937 
mp_ißpics
[
idx
].
mpc_ty³
 = 
MP_IOAPIC
;

938 
mp_ißpics
[
idx
].
mpc_æags
 = 
MPC_APIC_USABLE
;

939 
mp_ißpics
[
idx
].
mpc_­iÿddr
 = 
add»ss
;

941 
	`£t_fixm­_noÿche
(
FIX_IO_APIC_BASE_0
 + 
idx
, 
add»ss
);

942 ià((
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
)

943 && !
	`APIC_XAPIC
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
]))

944 
tmpid
 = 
	`io_­ic_g‘_unique_id
(
idx
, 
id
);

946 
tmpid
 = 
id
;

947 ià(
tmpid
 == -1) {

948 
Ä_ißpics
--;

951 
mp_ißpics
[
idx
].
mpc_­icid
 = 
tmpid
;

952 
mp_ißpics
[
idx
].
mpc_­icv”
 = 
	`io_­ic_g‘_v”siÚ
(idx);

958 
mp_ißpic_routšg
[
idx
].
­ic_id
 = 
mp_ißpics
[idx].
mpc_­icid
;

959 
mp_ißpic_routšg
[
idx
].
gsi_ba£
 = gsi_base;

960 
mp_ißpic_routšg
[
idx
].
gsi_’d
 = 
gsi_ba£
 +

961 
	`io_­ic_g‘_»dœ_’Œ›s
(
idx
);

963 
	`´štk
("IOAPIC[%d]:‡pic_id %d, version %d,‡ddress 0x%x, "

964 "GSI %d-%d\n", 
idx
, 
mp_ißpics
[idx].
mpc_­icid
,

965 
mp_ißpics
[
idx
].
mpc_­icv”
, mp_ißpics[idx].
mpc_­iÿddr
,

966 
mp_ißpic_routšg
[
idx
].
gsi_ba£
,

967 
mp_ißpic_routšg
[
idx
].
gsi_’d
);

970 
	}
}

972 
	$highe¡_gsi
()

974 
x
, 
»s
 = 0;

975 
x
 = 0; x < 
Ä_ißpics
; x++)

976 ià(
»s
 < 
mp_ißpic_routšg
[
x
].
gsi_’d
)

977 
»s
 = 
mp_ißpic_routšg
[
x
].
gsi_’d
;

978  
»s
;

979 
	}
}

981 
	$­ic_gsi_ba£
(
­ic
)

983  
mp_ißpic_routšg
[
­ic
].
gsi_ba£
;

984 
	}
}

986 
__š™
 
	$mp_ov”ride_Ëgacy_œq
 (

987 
u8
 
bus_œq
,

988 
u8
 
pŞ¬™y
,

989 
u8
 
Œigg”
,

990 
u32
 
gsi
)

992 
mpc_cÚfig_št¤c
 
št¤c
;

993 
ißpic
 = -1;

994 
pš
 = -1;

999 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

1000 ià(
ißpic
 < 0)

1002 
pš
 = 
gsi
 - 
mp_ißpic_routšg
[
ißpic
].
gsi_ba£
;

1009 ià((
bus_œq
 =ğ0è&& (
Œigg”
 == 3))

1010 
Œigg”
 = 1;

1012 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

1013 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

1014 
št¤c
.
mpc_œqæag
 = (
Œigg”
 << 2è| 
pŞ¬™y
;

1015 
št¤c
.
mpc_¤cbus
 = 
MP_ISA_BUS
;

1016 
št¤c
.
mpc_¤cbusœq
 = 
bus_œq
;

1017 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[
ißpic
].
mpc_­icid
;

1018 
št¤c
.
mpc_d¡œq
 = 
pš
;

1020 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d, irq %d, %d-%d\n",

1021 
št¤c
.
mpc_œqty³
, iÁ¤c.
mpc_œqæag
 & 3,

1022 (
št¤c
.
mpc_œqæag
 >> 2è& 3, iÁ¤c.
mpc_¤cbus
,

1023 
št¤c
.
mpc_¤cbusœq
, iÁ¤c.
mpc_d¡­ic
, iÁ¤c.
mpc_d¡œq
);

1025 
mp_œqs
[
mp_œq_’Œ›s
] = 
št¤c
;

1026 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

1027 
	`·nic
("Max # of irq sourcesƒxceeded!\n");

1030 
	}
}

1032 
__š™
 
	$mp_cÚfig_aıi_Ëgacy_œqs
 ()

1034 
mpc_cÚfig_št¤c
 
št¤c
;

1035 
i
 = 0;

1036 
ißpic
 = -1;

1041 
mp_bus_id_to_ty³
[
MP_ISA_BUS
] = 
MP_BUS_ISA
;

1042 
	`D´štk
("Bu #%d i ISA\n", 
MP_ISA_BUS
);

1047 
ißpic
 = 
	`mp_fšd_ißpic
(0);

1048 ià(
ißpic
 < 0)

1051 
št¤c
.
mpc_ty³
 = 
MP_INTSRC
;

1052 
št¤c
.
mpc_œqæag
 = 0;

1053 
št¤c
.
mpc_¤cbus
 = 
MP_ISA_BUS
;

1054 
št¤c
.
mpc_d¡­ic
 = 
mp_ißpics
[
ißpic
].
mpc_­icid
;

1060 
i
 = 0; 
	`¶©fÜm_Ëgacy_œq
(i); i++) {

1061 
idx
;

1063 
idx
 = 0; idx < 
mp_œq_’Œ›s
; idx++) {

1064 
mpc_cÚfig_št¤c
 *
œq
 = 
mp_œqs
 + 
idx
;

1067 ià(
œq
->
mpc_¤cbus
 =ğ
MP_ISA_BUS
 && irq->
mpc_¤cbusœq
 =ğ
i
)

1071 ià((
œq
->
mpc_d¡­ic
 =ğ
št¤c
.mpc_dstapic) &&

1072 (
œq
->
mpc_d¡œq
 =ğ
i
))

1076 ià(
idx
 !ğ
mp_œq_’Œ›s
) {

1077 
	`´štk
(
KERN_DEBUG
 "ACPI: IRQ%d u£d by ov”ride.\n", 
i
);

1081 
št¤c
.
mpc_œqty³
 = 
mp_INT
;

1082 
št¤c
.
mpc_¤cbusœq
 = 
i
;

1083 
št¤c
.
mpc_d¡œq
 = 
i
;

1085 
	`D´štk
("Int:ype %d,…ol %d,rig %d, bus %d, irq %d, "

1086 "%d-%d\n", 
št¤c
.
mpc_œqty³
, iÁ¤c.
mpc_œqæag
 & 3,

1087 (
št¤c
.
mpc_œqæag
 >> 2è& 3, iÁ¤c.
mpc_¤cbus
,

1088 
št¤c
.
mpc_¤cbusœq
, iÁ¤c.
mpc_d¡­ic
,

1089 
št¤c
.
mpc_d¡œq
);

1091 
mp_œqs
[
mp_œq_’Œ›s
] = 
št¤c
;

1092 ià(++
mp_œq_’Œ›s
 =ğ
MAX_IRQ_SOURCES
)

1093 
	`·nic
("Max # of irq sourcesƒxceeded!\n");

1095 
	}
}

1097 
	$mp_»gi¡”_gsi
 (
u32
 
gsi
, 
Œigg”šg
, 
pŞ¬™y
)

1099 
ißpic
 = -1;

1100 
ißpic_pš
 = 0;

1101 
idx
, 
b™
 = 0;

1102 
œq_desc
 * 
desc
;

1103 
æags
;

1111 #ifdeà
CONFIG_ACPI_BUS


1113 ià(
aıi_çdt
.
sci_št
 =ğ
gsi
)

1114  
gsi
;

1117 
ißpic
 = 
	`mp_fšd_ißpic
(
gsi
);

1118 ià(
ißpic
 < 0) {

1119 
	`´štk
(
KERN_WARNING
 "NØIOAPIC fÜ GSI %u\n", 
gsi
);

1120  -
EINVAL
;

1123 
ißpic_pš
 = 
gsi
 - 
mp_ißpic_routšg
[
ißpic
].
gsi_ba£
;

1125 
desc
 = 
	`œq_to_desc
(
gsi
);

1126 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

1127 ià(!(
desc
->
¡©us
 & 
IRQ_DISABLED
è&& desc->
hªdËr
 !ğ&
no_œq_ty³
) {

1128 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1129  -
EEXIST
;

1131 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

1138 
b™
 = 
ißpic_pš
 % 32;

1139 
idx
 = (
ißpic_pš
 < 32) ? 0 : (ioapic_pin / 32);

1140 ià(
idx
 > 3) {

1141 
	`´štk
(
KERN_ERR
 "Invalid„eferenceo IOAPIC…in "

1142 "%d-%d\n", 
mp_ißpic_routšg
[
ißpic
].
­ic_id
,

1143 
ißpic_pš
);

1144  -
EINVAL
;

1146 ià((1<<
b™
è& 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
[
idx
]) {

1147 
	`D´štk
(
KERN_DEBUG
 "Pin %d-%d‡lready…rogrammed\n",

1148 
mp_ißpic_routšg
[
ißpic
].
­ic_id
, 
ißpic_pš
);

1149  -
EEXIST
;

1152 
mp_ißpic_routšg
[
ißpic
].
pš_´og¿mmed
[
idx
] |ğ(1<<
b™
);

1154  
	`io_­ic_£t_pci_routšg
(
ißpic
, 
ißpic_pš
, 
gsi
,

1155 
Œigg”šg
, 
pŞ¬™y
);

1156 
	}
}

	@msi.c

9 
	~<x’/cÚfig.h
>

10 
	~<x’/lib.h
>

11 
	~<x’/š™.h
>

12 
	~<x’/œq.h
>

13 
	~<x’/d–ay.h
>

14 
	~<x’/sched.h
>

15 
	~<x’/aıi.h
>

16 
	~<x’/”ºo.h
>

17 
	~<x’/pci.h
>

18 
	~<x’/pci_»gs.h
>

19 
	~<x’/ioÿp.h
>

20 
	~<x’/keyhªdËr.h
>

21 
	~<asm/io.h
>

22 
	~<asm/smp.h
>

23 
	~<asm/desc.h
>

24 
	~<asm/msi.h
>

25 
	~<asm/fixm­.h
>

26 
	~<asm/p2m.h
>

27 
	~<mach_­ic.h
>

28 
	~<io_pÜts.h
>

29 
	~<public/physdev.h
>

30 
	~<x’/iommu.h
>

33 
DEFINE_SPINLOCK
(
msix_fixm­_lock
);

34 
DECLARE_BITMAP
(
msix_fixm­_·ges
, 
FIX_MSIX_MAX_PAGES
);

36 
	$msix_fixm­_®loc
()

38 
i
, 
rc
 = -
ENOMEM
;

40 
	`¥š_lock
(&
msix_fixm­_lock
);

41  
i
 = 0; i < 
FIX_MSIX_MAX_PAGES
; i++ )

42 iàĞ!
	`‹¡_b™
(
i
, &
msix_fixm­_·ges
) )

44 iàĞ
i
 =ğ
FIX_MSIX_MAX_PAGES
 )

45 
out
;

46 
rc
 = 
FIX_MSIX_IO_RESERV_BASE
 + 
i
;

47 
	`£t_b™
(
i
, &
msix_fixm­_·ges
);

49 
out
:

50 
	`¥š_uÆock
(&
msix_fixm­_lock
);

51  
rc
;

52 
	}
}

54 
	$msix_fixm­_ä“
(
idx
)

56 
	`¥š_lock
(&
msix_fixm­_lock
);

57 iàĞ
idx
 >ğ
FIX_MSIX_IO_RESERV_BASE
 )

58 
	`ş—r_b™
(
idx
 - 
FIX_MSIX_IO_RESERV_BASE
, &
msix_fixm­_·ges
);

59 
	`¥š_uÆock
(&
msix_fixm­_lock
);

60 
	}
}

62 
	$msix_g‘_fixm­
(
pci_dev
 *
dev
, 
u64
 
bË_·ddr
,

63 
u64
 
’Œy_·ddr
)

65 
Ä_·ge
;

66 
idx
;

68 
Ä_·ge
 = (
’Œy_·ddr
 >> 
PAGE_SHIFT
è- (
bË_·ddr
 >> PAGE_SHIFT);

70 iàĞ
Ä_·ge
 < 0 ||‚r_·g>ğ
MAX_MSIX_TABLE_PAGES
 )

71  -
EINVAL
;

73 
	`¥š_lock
(&
dev
->
msix_bË_lock
);

74 iàĞ
dev
->
msix_bË_»fút
[
Ä_·ge
]++ == 0 )

76 
idx
 = 
	`msix_fixm­_®loc
();

77 iàĞ
idx
 < 0 )

79 
dev
->
msix_bË_»fút
[
Ä_·ge
]--;

80 
out
;

82 
	`£t_fixm­_noÿche
(
idx
, 
’Œy_·ddr
);

83 
dev
->
msix_bË_idx
[
Ä_·ge
] = 
idx
;

86 
idx
 = 
dev
->
msix_bË_idx
[
Ä_·ge
];

88 
out
:

89 
	`¥š_uÆock
(&
dev
->
msix_bË_lock
);

90  
idx
;

91 
	}
}

93 
	$msix_put_fixm­
(
pci_dev
 *
dev
, 
idx
)

95 
i
;

96 
¡¬t
;

98 
	`¥š_lock
(&
dev
->
msix_bË_lock
);

99  
i
 = 0; i < 
MAX_MSIX_TABLE_PAGES
; i++ )

101 iàĞ
dev
->
msix_bË_idx
[
i
] =ğ
idx
 )

104 iàĞ
i
 =ğ
MAX_MSIX_TABLE_PAGES
 )

105 
out
;

107 iàĞ--
dev
->
msix_bË_»fút
[
i
] == 0 )

109 
¡¬t
 = 
	`fix_to_vœt
(
idx
);

110 
	`de¡roy_x’_m­pšgs
(
¡¬t
, s¹ + 
PAGE_SIZE
);

111 
	`msix_fixm­_ä“
(
idx
);

112 
dev
->
msix_bË_idx
[
i
] = 0;

115 
out
:

116 
	`¥š_uÆock
(&
dev
->
msix_bË_lock
);

117 
	}
}

122 
	$msi_compo£_msg
(
pci_dev
 *
pdev
, 
œq
,

123 
msi_msg
 *
msg
)

125 
de¡
;

126 
ıumask_t
 
domaš
;

127 
œq_cfg
 *
cfg
 = 
	`œq_cfg
(
œq
);

128 
veùÜ
 = 
cfg
->vector;

129 
domaš
 = 
cfg
->
ıu_mask
;

131 iàĞ
	`ıus_em±y
Ğ
domaš
 ) ) {

132 
	`d´štk
(
XENLOG_ERR
,"%s, compo£ ms˜mes§g”rÜ!!\n", 
__func__
);

136 iàĞ
veùÜ
 ) {

137 
de¡
 = 
	`ıu_mask_to_­icid
(&
domaš
);

139 
msg
->
add»ss_hi
 = 
MSI_ADDR_BASE_HI
;

140 
msg
->
add»ss_lo
 =

141 
MSI_ADDR_BASE_LO
 |

142 ((
INT_DEST_MODE
 == 0) ?

143 
MSI_ADDR_DESTMODE_PHYS
:

144 
MSI_ADDR_DESTMODE_LOGIC
) |

145 ((
INT_DELIVERY_MODE
 !ğ
de¡_Lowe¡Prio
) ?

146 
MSI_ADDR_REDIRECTION_CPU
:

147 
MSI_ADDR_REDIRECTION_LOWPRI
) |

148 
	`MSI_ADDR_DEST_ID
(
de¡
);

149 
msg
->
de¡32
 = 
de¡
;

151 
msg
->
d©a
 =

152 
MSI_DATA_TRIGGER_EDGE
 |

153 
MSI_DATA_LEVEL_ASSERT
 |

154 ((
INT_DELIVERY_MODE
 !ğ
de¡_Lowe¡Prio
) ?

155 
MSI_DATA_DELIVERY_FIXED
:

156 
MSI_DATA_DELIVERY_LOWPRI
) |

157 
	`MSI_DATA_VECTOR
(
veùÜ
);

159 
	}
}

161 
	$»ad_msi_msg
(
msi_desc
 *
’Œy
, 
msi_msg
 *
msg
)

163  
’Œy
->
msi_©Œib
.
ty³
 )

165 
PCI_CAP_ID_MSI
:

167 
pci_dev
 *
dev
 = 
’Œy
->dev;

168 
pos
 = 
’Œy
->
msi_©Œib
.pos;

169 
u16
 
d©a
;

170 
u8
 
bus
 = 
dev
->bus;

171 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

172 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

174 
msg
->
add»ss_lo
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
,

175 
	`msi_low”_add»ss_»g
(
pos
));

176 iàĞ
’Œy
->
msi_©Œib
.
is_64
 )

178 
msg
->
add»ss_hi
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
,

179 
	`msi_uµ”_add»ss_»g
(
pos
));

180 
d©a
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msi_d©a_»g
(
pos
, 1));

184 
msg
->
add»ss_hi
 = 0;

185 
d©a
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msi_d©a_»g
(
pos
, 0));

187 
msg
->
d©a
 = data;

190 
PCI_CAP_ID_MSIX
:

192 
__iomem
 *
ba£
;

193 
ba£
 = 
’Œy
->
mask_ba£
;

195 
msg
->
add»ss_lo
 = 
	`»adl
(
ba£
 + 
PCI_MSIX_ENTRY_LOWER_ADDR_OFFSET
);

196 
msg
->
add»ss_hi
 = 
	`»adl
(
ba£
 + 
PCI_MSIX_ENTRY_UPPER_ADDR_OFFSET
);

197 
msg
->
d©a
 = 
	`»adl
(
ba£
 + 
PCI_MSIX_ENTRY_DATA_OFFSET
);

201 
	`BUG
();

204 iàĞ
iommu_’abËd
 )

205 
	`iommu_»ad_msi_äom_œe
(
’Œy
, 
msg
);

206 
	}
}

208 
	$£t_œq_msi
(
msi_desc
 *
’Œy
)

210 iàĞ
’Œy
->
œq
 >ğ
Ä_œqs
 )

212 
	`d´štk
(
XENLOG_ERR
, "Tryingo install msi data for irq %d\n",

213 
’Œy
->
œq
);

214  -
EINVAL
;

217 
œq_desc
[
’Œy
->
œq
].
msi_desc
 =ƒntry;

219 
	}
}

221 
	$wr™e_msi_msg
(
msi_desc
 *
’Œy
, 
msi_msg
 *
msg
)

223 
’Œy
->
msg
 = *msg;

225 iàĞ
iommu_’abËd
 )

226 
	`iommu_upd©e_œe_äom_msi
(
’Œy
, 
msg
);

228  
’Œy
->
msi_©Œib
.
ty³
 )

230 
PCI_CAP_ID_MSI
:

232 
pci_dev
 *
dev
 = 
’Œy
->dev;

233 
pos
 = 
’Œy
->
msi_©Œib
.pos;

234 
u8
 
bus
 = 
dev
->bus;

235 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

236 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

238 
	`pci_cÚf_wr™e32
(
bus
, 
¦Ù
, 
func
, 
	`msi_low”_add»ss_»g
(
pos
),

239 
msg
->
add»ss_lo
);

240 iàĞ
’Œy
->
msi_©Œib
.
is_64
 )

242 
	`pci_cÚf_wr™e32
(
bus
, 
¦Ù
, 
func
, 
	`msi_uµ”_add»ss_»g
(
pos
),

243 
msg
->
add»ss_hi
);

244 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
	`msi_d©a_»g
(
pos
, 1),

245 
msg
->
d©a
);

248 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
	`msi_d©a_»g
(
pos
, 0),

249 
msg
->
d©a
);

252 
PCI_CAP_ID_MSIX
:

254 
__iomem
 *
ba£
;

255 
ba£
 = 
’Œy
->
mask_ba£
;

257 
	`wr™–
(
msg
->
add»ss_lo
,

258 
ba£
 + 
PCI_MSIX_ENTRY_LOWER_ADDR_OFFSET
);

259 
	`wr™–
(
msg
->
add»ss_hi
,

260 
ba£
 + 
PCI_MSIX_ENTRY_UPPER_ADDR_OFFSET
);

261 
	`wr™–
(
msg
->
d©a
, 
ba£
 + 
PCI_MSIX_ENTRY_DATA_OFFSET
);

265 
	`BUG
();

267 
	}
}

269 
	$£t_msi_affš™y
(
œq
, 
ıumask_t
 
mask
)

271 
msi_msg
 
msg
;

272 
de¡
;

273 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

274 
msi_desc
 *msi_desøğ
desc
->msi_desc;

275 
œq_cfg
 *
cfg
 = 
desc
->
ch_d©a
;

277 
de¡
 = 
	`£t_desc_affš™y
(
desc
, &
mask
);

278 ià(
de¡
 =ğ
BAD_APICID
 || !
msi_desc
)

281 
	`ASSERT
(
	`¥š_is_locked
(&
desc
->
lock
));

283 
	`mem£t
(&
msg
, 0, (msg));

284 
	`»ad_msi_msg
(
msi_desc
, &
msg
);

286 
msg
.
d©a
 &ğ~
MSI_DATA_VECTOR_MASK
;

287 
msg
.
d©a
 |ğ
	`MSI_DATA_VECTOR
(
cfg
->
veùÜ
);

288 
msg
.
add»ss_lo
 &ğ~
MSI_ADDR_DEST_ID_MASK
;

289 
msg
.
add»ss_lo
 |ğ
	`MSI_ADDR_DEST_ID
(
de¡
);

290 
msg
.
de¡32
 = 
de¡
;

292 
	`wr™e_msi_msg
(
msi_desc
, &
msg
);

293 
	}
}

295 
	$msi_£t_’abË
(
pci_dev
 *
dev
, 
’abË
)

297 
pos
;

298 
u16
 
cÚŒŞ
;

299 
u8
 
bus
 = 
dev
->bus;

300 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

301 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

303 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSI
);

304 iàĞ
pos
 )

306 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
pos
 + 
PCI_MSI_FLAGS
);

307 
cÚŒŞ
 &ğ~
PCI_MSI_FLAGS_ENABLE
;

308 iàĞ
’abË
 )

309 
cÚŒŞ
 |ğ
PCI_MSI_FLAGS_ENABLE
;

310 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
pos
 + 
PCI_MSI_FLAGS
, 
cÚŒŞ
);

312 
	}
}

314 
	$msix_£t_’abË
(
pci_dev
 *
dev
, 
’abË
)

316 
pos
;

317 
u16
 
cÚŒŞ
;

318 
u8
 
bus
 = 
dev
->bus;

319 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

320 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

322 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSIX
);

323 iàĞ
pos
 )

325 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
pos
 + 
PCI_MSIX_FLAGS
);

326 
cÚŒŞ
 &ğ~
PCI_MSIX_FLAGS_ENABLE
;

327 iàĞ
’abË
 )

328 
cÚŒŞ
 |ğ
PCI_MSIX_FLAGS_ENABLE
;

329 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
pos
 + 
PCI_MSIX_FLAGS
, 
cÚŒŞ
);

331 
	}
}

333 
	$msi_maskabË_œq
(cÚ¡ 
msi_desc
 *
’Œy
)

335 
	`BUG_ON
(!
’Œy
);

336  
’Œy
->
msi_©Œib
.
ty³
 !ğ
PCI_CAP_ID_MSI


337 || 
’Œy
->
msi_©Œib
.
maskb™
;

338 
	}
}

340 
	$msi_£t_mask_b™
(
œq
, 
æag
)

342 
msi_desc
 *
’Œy
 = 
œq_desc
[
œq
].msi_desc;

344 
	`ASSERT
(
	`¥š_is_locked
(&
œq_desc
[
œq
].
lock
));

345 
	`BUG_ON
(!
’Œy
 || !’Œy->
dev
);

346 
’Œy
->
msi_©Œib
.
ty³
) {

347 
PCI_CAP_ID_MSI
:

348 ià(
’Œy
->
msi_©Œib
.
maskb™
) {

349 
pos
;

350 
u32
 
mask_b™s
;

351 
u8
 
bus
 = 
’Œy
->
dev
->bus;

352 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
’Œy
->
dev
->
devâ
);

353 
u8
 
func
 = 
	`PCI_FUNC
(
’Œy
->
dev
->
devâ
);

355 
pos
 = ()
’Œy
->
mask_ba£
;

356 
mask_b™s
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
, 
pos
);

357 
mask_b™s
 &= ~(1);

358 
mask_b™s
 |ğ
æag
;

359 
	`pci_cÚf_wr™e32
(
bus
, 
¦Ù
, 
func
, 
pos
, 
mask_b™s
);

362 
PCI_CAP_ID_MSIX
:

364 
off£t
 = 
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
;

365 
	`wr™–
(
æag
, 
’Œy
->
mask_ba£
 + 
off£t
);

366 
	`»adl
(
’Œy
->
mask_ba£
 + 
off£t
);

370 
	`BUG
();

373 
’Œy
->
msi_©Œib
.
masked
 = !!
æag
;

374 
	}
}

376 
	$msi_g‘_mask_b™
(cÚ¡ 
msi_desc
 *
’Œy
)

378 
’Œy
->
msi_©Œib
.
ty³
) {

379 
PCI_CAP_ID_MSI
:

380 ià(!
’Œy
->
dev
 || !’Œy->
msi_©Œib
.
maskb™
)

382  
	`pci_cÚf_»ad32
(
’Œy
->
dev
->
bus
, 
	`PCI_SLOT
ÓÁry->dev->
devâ
),

383 
	`PCI_FUNC
(
’Œy
->
dev
->
devâ
),

384 ()
’Œy
->
mask_ba£
) & 1;

385 
PCI_CAP_ID_MSIX
:

386  
	`»adl
(
’Œy
->
mask_ba£
 + 
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
) & 1;

389 
	}
}

391 
	$mask_msi_œq
(
œq
)

393 
	`msi_£t_mask_b™
(
œq
, 1);

394 
	}
}

396 
	$unmask_msi_œq
(
œq
)

398 
	`msi_£t_mask_b™
(
œq
, 0);

399 
	}
}

401 
msi_desc
* 
	$®loc_msi_’Œy
()

403 
msi_desc
 *
’Œy
;

405 
’Œy
 = 
	`xm®loc
(
msi_desc
);

406 iàĞ!
’Œy
 )

407  
NULL
;

409 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

410 
’Œy
->
dev
 = 
NULL
;

411 
’Œy
->
»m­_šdex
 = -1;

413  
’Œy
;

414 
	}
}

416 
	$£tup_msi_œq
(
pci_dev
 *
dev
, 
msi_desc
 *
msidesc
, 
œq
)

418 
msi_msg
 
msg
;

420 
	`msi_compo£_msg
(
dev
, 
œq
, &
msg
);

421 
	`£t_œq_msi
(
msidesc
);

422 
	`wr™e_msi_msg
(
œq_desc
[
œq
].
msi_desc
, &
msg
);

425 
	}
}

427 
	$msi_ä“_œq
(
msi_desc
 *
’Œy
)

429 
	`de¡roy_œq
(
’Œy
->
œq
);

430 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSIX
 )

432 
¡¬t
;

433 
¡¬t
 = ()
’Œy
->
mask_ba£
 & ~(
PAGE_SIZE
 - 1);

434 
	`msix_put_fixm­
(
’Œy
->
dev
, 
	`vœt_to_fix
(
¡¬t
));

438 iàĞ
iommu_’abËd
 )

439 
	`iommu_upd©e_œe_äom_msi
(
’Œy
, 
NULL
);

441 
	`li¡_d–
(&
’Œy
->
li¡
);

442 
	`xä“
(
’Œy
);

444 
	}
}

446 
msi_desc
 *
	$fšd_msi_’Œy
(
pci_dev
 *
dev
,

447 
œq
, 
ÿp_id
)

449 
msi_desc
 *
’Œy
;

451 
	`li¡_fÜ_—ch_’Œy
Ğ
’Œy
, &
dev
->
msi_li¡
, 
li¡
 )

453 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
ÿp_id
 &&

454 (
œq
 =ğ-1 || 
’Œy
->irq == irq) )

455  
’Œy
;

458  
NULL
;

459 
	}
}

470 
	$msi_ÿ·b™y_š™
(
pci_dev
 *
dev
,

471 
œq
,

472 
msi_desc
 **
desc
)

474 
msi_desc
 *
’Œy
;

475 
pos
;

476 
u16
 
cÚŒŞ
;

477 
u8
 
bus
 = 
dev
->bus;

478 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

479 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

481 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

482 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSI
);

483 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msi_cÚŒŞ_»g
(
pos
));

485 
	`msi_£t_’abË
(
dev
, 0);

487 
’Œy
 = 
	`®loc_msi_’Œy
();

488 iàĞ!
’Œy
 )

489  -
ENOMEM
;

491 
’Œy
->
msi_©Œib
.
ty³
 = 
PCI_CAP_ID_MSI
;

492 
’Œy
->
msi_©Œib
.
is_64
 = 
	`is_64b™_add»ss
(
cÚŒŞ
);

493 
’Œy
->
msi_©Œib
.
’Œy_Ä
 = 0;

494 
’Œy
->
msi_©Œib
.
maskb™
 = 
	`is_mask_b™_suµÜt
(
cÚŒŞ
);

495 
’Œy
->
msi_©Œib
.
masked
 = 1;

496 
’Œy
->
msi_©Œib
.
pos
 =…os;

497 
’Œy
->
œq
 = irq;

498 iàĞ
	`is_mask_b™_suµÜt
(
cÚŒŞ
) )

499 
’Œy
->
mask_ba£
 = (
__iomem
 *)()
	`msi_mask_b™s_»g
(
pos
,

500 
	`is_64b™_add»ss
(
cÚŒŞ
));

501 
’Œy
->
dev
 = dev;

502 iàĞ
’Œy
->
msi_©Œib
.
maskb™
 )

504 
maskb™s
, 
‹mp
;

506 
maskb™s
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
,

507 
	`msi_mask_b™s_»g
(
pos
, 
	`is_64b™_add»ss
(
cÚŒŞ
)));

508 
‹mp
 = (1 << 
	`muÉi_msi_ÿ·bË
(
cÚŒŞ
));

509 
‹mp
 = ((temp - 1) & ~temp);

510 
maskb™s
 |ğ
‹mp
;

511 
	`pci_cÚf_wr™e32
(
bus
, 
¦Ù
, 
func
,

512 
	`msi_mask_b™s_»g
(
pos
, 
	`is_64b™_add»ss
(
cÚŒŞ
)),

513 
maskb™s
);

515 
	`li¡_add_
(&
’Œy
->
li¡
, &
dev
->
msi_li¡
);

517 *
desc
 = 
’Œy
;

519 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
	`msi_cÚŒŞ_»g
(
pos
), 
cÚŒŞ
);

522 
	}
}

524 
u64
 
	$»ad_pci_mem_b¬
(
u8
 
bus
, u8 
¦Ù
, u8 
func
, u8 
bœ
)

526 
u8
 
lim™
;

527 
u32
 
addr
;

529  
	`pci_cÚf_»ad8
(
bus
, 
¦Ù
, 
func
, 
PCI_HEADER_TYPE
) & 0x7f )

531 
PCI_HEADER_TYPE_NORMAL
:

532 
lim™
 = 6;

534 
PCI_HEADER_TYPE_BRIDGE
:

535 
lim™
 = 2;

537 
PCI_HEADER_TYPE_CARDBUS
:

538 
lim™
 = 1;

544 iàĞ
bœ
 >ğ
lim™
 )

546 
addr
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
, 
PCI_BASE_ADDRESS_0
 + 
bœ
 * 4);

547 iàĞ(
addr
 & 
PCI_BASE_ADDRESS_SPACE
è=ğ
PCI_BASE_ADDRESS_SPACE_IO
 )

549 iàĞ(
addr
 & 
PCI_BASE_ADDRESS_MEM_TYPE_MASK
è=ğ
PCI_BASE_ADDRESS_MEM_TYPE_64
 )

551 
addr
 &ğ
PCI_BASE_ADDRESS_MEM_MASK
;

552 iàĞ++
bœ
 >ğ
lim™
 )

554  
addr
 |

555 ((
u64
)
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
,

556 
PCI_BASE_ADDRESS_0
 + 
bœ
 * 4) << 32);

558  
addr
 & 
PCI_BASE_ADDRESS_MEM_MASK
;

559 
	}
}

571 
	$msix_ÿ·b™y_š™
(
pci_dev
 *
dev
,

572 
msi_šfo
 *
msi
,

573 
msi_desc
 **
desc
,

574 
Ä_’Œ›s
)

576 
msi_desc
 *
’Œy
;

577 
pos
;

578 
u16
 
cÚŒŞ
;

579 
u64
 
bË_·ddr
, 
’Œy_·ddr
;

580 
u32
 
bË_off£t
, 
’Œy_off£t
;

581 
u8
 
bœ
;

582 
__iomem
 *
ba£
;

583 
idx
;

584 
u8
 
bus
 = 
dev
->bus;

585 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

586 
u8
 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

588 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

589 
	`ASSERT
(
desc
);

591 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSIX
);

592 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
));

593 
	`msix_£t_’abË
(
dev
, 0);

596 
’Œy
 = 
	`®loc_msi_’Œy
();

597 iàĞ!
’Œy
 )

598  -
ENOMEM
;

601 
bË_off£t
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
, 
	`msix_bË_off£t_»g
(
pos
));

602 
bœ
 = (
u8
)(
bË_off£t
 & 
PCI_MSIX_BIRMASK
);

603 
bË_off£t
 &ğ~
PCI_MSIX_BIRMASK
;

604 
’Œy_off£t
 = 
msi
->
’Œy_Ä
 * 
PCI_MSIX_ENTRY_SIZE
;

606 
bË_·ddr
 = 
msi
->
bË_ba£
 + 
bË_off£t
;

607 
’Œy_·ddr
 = 
bË_·ddr
 + 
’Œy_off£t
;

608 
idx
 = 
	`msix_g‘_fixm­
(
dev
, 
bË_·ddr
, 
’Œy_·ddr
);

609 iàĞ
idx
 < 0 )

611 
	`xä“
(
’Œy
);

612  
idx
;

614 
ba£
 = (*)(
	`fix_to_vœt
(
idx
) +

615 (()
’Œy_·ddr
 & ((1UL << 
PAGE_SHIFT
) - 1)));

617 
’Œy
->
msi_©Œib
.
ty³
 = 
PCI_CAP_ID_MSIX
;

618 
’Œy
->
msi_©Œib
.
is_64
 = 1;

619 
’Œy
->
msi_©Œib
.
’Œy_Ä
 = 
msi
->entry_nr;

620 
’Œy
->
msi_©Œib
.
maskb™
 = 1;

621 
’Œy
->
msi_©Œib
.
masked
 = 1;

622 
’Œy
->
msi_©Œib
.
pos
 =…os;

623 
’Œy
->
œq
 = 
msi
->irq;

624 
’Œy
->
dev
 = dev;

625 
’Œy
->
mask_ba£
 = 
ba£
;

627 
	`li¡_add_
(&
’Œy
->
li¡
, &
dev
->
msi_li¡
);

629 iàĞ!
dev
->
msix_Ä_’Œ›s
 )

631 
u64
 
pba_·ddr
;

632 
u32
 
pba_off£t
;

634 
	`ASSERT
(!
dev
->
msix_u£d_’Œ›s
);

635 
	`WARN_ON
(
msi
->
bË_ba£
 !ğ
	`»ad_pci_mem_b¬
(
bus
, 
¦Ù
, 
func
, 
bœ
));

637 
dev
->
msix_Ä_’Œ›s
 = 
Ä_’Œ›s
;

638 
dev
->
msix_bË
.
fœ¡
 = 
	`PFN_DOWN
(
bË_·ddr
);

639 
dev
->
msix_bË
.
Ï¡
 = 
	`PFN_DOWN
(
bË_·ddr
 +

640 
Ä_’Œ›s
 * 
PCI_MSIX_ENTRY_SIZE
 - 1);

641 
	`WARN_ON
(
	`¿nge£t_ov”Ïps_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_bË
.
fœ¡
,

642 
dev
->
msix_bË
.
Ï¡
));

644 
pba_off£t
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 
func
,

645 
	`msix_pba_off£t_»g
(
pos
));

646 
bœ
 = (
u8
)(
pba_off£t
 & 
PCI_MSIX_BIRMASK
);

647 
pba_·ddr
 = 
	`»ad_pci_mem_b¬
(
bus
, 
¦Ù
, 
func
, 
bœ
);

648 
	`WARN_ON
(!
pba_·ddr
);

649 
pba_·ddr
 +ğ
pba_off£t
 & ~
PCI_MSIX_BIRMASK
;

651 
dev
->
msix_pba
.
fœ¡
 = 
	`PFN_DOWN
(
pba_·ddr
);

652 
dev
->
msix_pba
.
Ï¡
 = 
	`PFN_DOWN
(
pba_·ddr
 +

653 
	`BITS_TO_LONGS
(
Ä_’Œ›s
) - 1);

654 
	`WARN_ON
(
	`¿nge£t_ov”Ïps_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_pba
.
fœ¡
,

655 
dev
->
msix_pba
.
Ï¡
));

657 iàĞ
	`¿nge£t_add_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_bË
.
fœ¡
,

658 
dev
->
msix_bË
.
Ï¡
) )

659 
	`WARN
();

660 iàĞ
	`¿nge£t_add_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_pba
.
fœ¡
,

661 
dev
->
msix_pba
.
Ï¡
) )

662 
	`WARN
();

664 iàĞ
dev
->
domaš
 )

665 
	`p2m_chªge_’Œy_ty³_glob®
(
	`p2m_g‘_ho¡p2m
(
dev
->
domaš
),

666 
p2m_mmio_dœeù
,…2m_mmio_direct);

667 iàĞ!
dev
->
domaš
 || !
	`·gšg_mode_Œª¦©e
(dev->domain) )

669 
domaš
 *
d
 = 
dev
->domain;

671 iàĞ!
d
 )

672 
	`fÜ_—ch_domaš
(
d
)

673 iàĞ!
	`·gšg_mode_Œª¦©e
(
d
) &&

674 (
	`iomem_acûss_³rm™‹d
(
d
, 
dev
->
msix_bË
.
fœ¡
,

675 
dev
->
msix_bË
.
Ï¡
) ||

676 
	`iomem_acûss_³rm™‹d
(
d
, 
dev
->
msix_pba
.
fœ¡
,

677 
dev
->
msix_pba
.
Ï¡
)) )

679 iàĞ
d
 )

685 
	`WARN_ON
(
dev
->
msix_Ä_’Œ›s
 !ğ
Ä_’Œ›s
);

686 
	`WARN_ON
(
dev
->
msix_bË
.
fœ¡
 !ğ(
bË_·ddr
 >> 
PAGE_SHIFT
));

687 ++
dev
->
msix_u£d_’Œ›s
;

690 
	`wr™–
(1, 
’Œy
->
mask_ba£
 + 
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
);

692 *
desc
 = 
’Œy
;

694 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
), 
cÚŒŞ
);

697 
	}
}

710 
	$__pci_’abË_msi
(
msi_šfo
 *
msi
, 
msi_desc
 **
desc
)

712 
¡©us
;

713 
pci_dev
 *
pdev
;

714 
msi_desc
 *
Şd_desc
;

716 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

717 
pdev
 = 
	`pci_g‘_pdev
(
msi
->
bus
, msi->
devâ
);

718 iàĞ!
pdev
 )

719  -
ENODEV
;

721 
Şd_desc
 = 
	`fšd_msi_’Œy
(
pdev
, 
msi
->
œq
, 
PCI_CAP_ID_MSI
);

722 iàĞ
Şd_desc
 )

724 
	`d´štk
(
XENLOG_WARNING
, "irq %d has‡lready mappedo MSI on "

725 "deviû %02x:%02x.%01x.\n", 
msi
->
œq
, msi->
bus
,

726 
	`PCI_SLOT
(
msi
->
devâ
), 
	`PCI_FUNC
(msi->devfn));

727 *
desc
 = 
Şd_desc
;

731 
Şd_desc
 = 
	`fšd_msi_’Œy
(
pdev
, -1, 
PCI_CAP_ID_MSIX
);

732 iàĞ
Şd_desc
 )

734 
	`d´štk
(
XENLOG_WARNING
, "MSI-X is‡lready in use on "

735 "deviû %02x:%02x.%01x\n", 
msi
->
bus
,

736 
	`PCI_SLOT
(
msi
->
devâ
), 
	`PCI_FUNC
(msi->devfn));

737 
	`pci_di§bË_msi
(
Şd_desc
);

740 
¡©us
 = 
	`msi_ÿ·b™y_š™
(
pdev
, 
msi
->
œq
, 
desc
);

741  
¡©us
;

742 
	}
}

744 
	$__pci_di§bË_msi
(
msi_desc
 *
’Œy
)

746 
pci_dev
 *
dev
;

747 
pos
;

748 
u16
 
cÚŒŞ
;

749 
u8
 
bus
, 
¦Ù
, 
func
;

751 
dev
 = 
’Œy
->dev;

752 
bus
 = 
dev
->bus;

753 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

754 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

756 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSI
);

757 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msi_cÚŒŞ_»g
(
pos
));

758 
	`msi_£t_’abË
(
dev
, 0);

760 
	`BUG_ON
(
	`li¡_em±y
(&
dev
->
msi_li¡
));

762 
	}
}

779 
	$__pci_’abË_msix
(
msi_šfo
 *
msi
, 
msi_desc
 **
desc
)

781 
¡©us
, 
pos
, 
Ä_’Œ›s
;

782 
pci_dev
 *
pdev
;

783 
u16
 
cÚŒŞ
;

784 
u8
 
¦Ù
 = 
	`PCI_SLOT
(
msi
->
devâ
);

785 
u8
 
func
 = 
	`PCI_FUNC
(
msi
->
devâ
);

786 
msi_desc
 *
Şd_desc
;

788 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

789 
pdev
 = 
	`pci_g‘_pdev
(
msi
->
bus
, msi->
devâ
);

790 iàĞ!
pdev
 )

791  -
ENODEV
;

793 
pos
 = 
	`pci_fšd_ÿp_off£t
(
msi
->
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSIX
);

794 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
msi
->
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
));

795 
Ä_’Œ›s
 = 
	`muÉi_msix_ÿ·bË
(
cÚŒŞ
);

796 ià(
msi
->
’Œy_Ä
 >ğ
Ä_’Œ›s
)

797  -
EINVAL
;

799 
Şd_desc
 = 
	`fšd_msi_’Œy
(
pdev
, 
msi
->
œq
, 
PCI_CAP_ID_MSIX
);

800 iàĞ
Şd_desc
 )

802 
	`d´štk
(
XENLOG_WARNING
, "irq %d has‡lready mappedo MSIX on "

803 "deviû %02x:%02x.%01x.\n", 
msi
->
œq
, msi->
bus
,

804 
	`PCI_SLOT
(
msi
->
devâ
), 
	`PCI_FUNC
(msi->devfn));

805 *
desc
 = 
Şd_desc
;

809 
Şd_desc
 = 
	`fšd_msi_’Œy
(
pdev
, -1, 
PCI_CAP_ID_MSI
);

810 iàĞ
Şd_desc
 )

812 
	`d´štk
(
XENLOG_WARNING
, "MSI is‡lready in use on "

813 "deviû %02x:%02x.%01x\n", 
msi
->
bus
,

814 
	`PCI_SLOT
(
msi
->
devâ
), 
	`PCI_FUNC
(msi->devfn));

815 
	`pci_di§bË_msi
(
Şd_desc
);

819 
¡©us
 = 
	`msix_ÿ·b™y_š™
(
pdev
, 
msi
, 
desc
, 
Ä_’Œ›s
);

820  
¡©us
;

821 
	}
}

823 
	$__pci_di§bË_msix
(
msi_desc
 *
’Œy
)

825 
pci_dev
 *
dev
;

826 
pos
;

827 
u16
 
cÚŒŞ
;

828 
u8
 
bus
, 
¦Ù
, 
func
;

830 
dev
 = 
’Œy
->dev;

831 
bus
 = 
dev
->bus;

832 
¦Ù
 = 
	`PCI_SLOT
(
dev
->
devâ
);

833 
func
 = 
	`PCI_FUNC
(
dev
->
devâ
);

835 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSIX
);

836 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
));

837 
	`msix_£t_’abË
(
dev
, 0);

839 
	`BUG_ON
(
	`li¡_em±y
(&
dev
->
msi_li¡
));

841 
	`wr™–
(1, 
’Œy
->
mask_ba£
 + 
PCI_MSIX_ENTRY_VECTOR_CTRL_OFFSET
);

843 
	`pci_cÚf_wr™e16
(
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
), 
cÚŒŞ
);

845 iàĞ!--
dev
->
msix_u£d_’Œ›s
 )

847 iàĞ
	`¿nge£t_»move_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_bË
.
fœ¡
,

848 
dev
->
msix_bË
.
Ï¡
) )

849 
	`WARN
();

850 iàĞ
	`¿nge£t_»move_¿nge
(
mmio_ro_¿nges
, 
dev
->
msix_pba
.
fœ¡
,

851 
dev
->
msix_pba
.
Ï¡
) )

852 
	`WARN
();

854 
	}
}

860 
	$pci_’abË_msi
(
msi_šfo
 *
msi
, 
msi_desc
 **
desc
)

862 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

864  
msi
->
bË_ba£
 ? 
	`__pci_’abË_msix
(msi, 
desc
) :

865 
	`__pci_’abË_msi
(
msi
, 
desc
);

866 
	}
}

871 
	$pci_di§bË_msi
(
msi_desc
 *msi_desc)

873 iàĞ
msi_desc
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSI
 )

874 
	`__pci_di§bË_msi
(
msi_desc
);

875 iàĞ
msi_desc
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSIX
 )

876 
	`__pci_di§bË_msix
(
msi_desc
);

877 
	}
}

879 
	$msi_ä“_œqs
(
pci_dev
* 
dev
)

881 
msi_desc
 *
’Œy
, *
tmp
;

883 
	`li¡_fÜ_—ch_’Œy_§ã
Ğ
’Œy
, 
tmp
, &
dev
->
msi_li¡
, 
li¡
 )

885 
	`pci_di§bË_msi
(
’Œy
);

886 
	`msi_ä“_œq
(
’Œy
);

888 
	}
}

890 
	$pci_ş—nup_msi
(
pci_dev
 *
pdev
)

893 
	`msi_£t_’abË
(
pdev
, 0);

894 
	`msix_£t_’abË
(
pdev
, 0);

895 
	`msi_ä“_œqs
(
pdev
);

896 
	}
}

898 
	$pci_»¡Üe_msi_¡©e
(
pci_dev
 *
pdev
)

900 
æags
;

901 
œq
;

902 
msi_desc
 *
’Œy
, *
tmp
;

903 
œq_desc
 *
desc
;

905 
	`ASSERT
(
	`¥š_is_locked
(&
pcidevs_lock
));

907 ià(!
pdev
)

908  -
EINVAL
;

910 
	`li¡_fÜ_—ch_’Œy_§ã
Ğ
’Œy
, 
tmp
, &
pdev
->
msi_li¡
, 
li¡
 )

912 
œq
 = 
’Œy
->irq;

913 
desc
 = &
œq_desc
[
œq
];

915 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

917 
	`ASSERT
(
desc
->
msi_desc
 =ğ
’Œy
);

919 ià(
desc
->
msi_desc
 !ğ
’Œy
)

921 
	`d´štk
(
XENLOG_ERR
, "Restore MSI for dev %x:%x‚ot set before?\n",

922 
pdev
->
bus
,…dev->
devâ
);

923 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

924  -
EINVAL
;

927 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSI
 )

928 
	`msi_£t_’abË
(
pdev
, 0);

929 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSIX
 )

930 
	`msix_£t_’abË
(
pdev
, 0);

932 
	`wr™e_msi_msg
(
’Œy
, &’Œy->
msg
);

934 
	`msi_£t_mask_b™
(
œq
, 
’Œy
->
msi_©Œib
.
masked
);

936 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSI
 )

937 
	`msi_£t_’abË
(
pdev
, 1);

938 iàĞ
’Œy
->
msi_©Œib
.
ty³
 =ğ
PCI_CAP_ID_MSIX
 )

939 
	`msix_£t_’abË
(
pdev
, 1);

941 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

945 
	}
}

947 
	$pci_msix_g‘_bË_Ën
(
pci_dev
 *
pdev
)

949 
pos
;

950 
u16
 
cÚŒŞ
;

951 
u8
 
bus
, 
¦Ù
, 
func
;

952 
Ën
;

954 
bus
 = 
pdev
->bus;

955 
¦Ù
 = 
	`PCI_SLOT
(
pdev
->
devâ
);

956 
func
 = 
	`PCI_FUNC
(
pdev
->
devâ
);

958 
pos
 = 
	`pci_fšd_ÿp_off£t
(
bus
, 
¦Ù
, 
func
, 
PCI_CAP_ID_MSIX
);

959 iàĞ!
pos
 )

962 
cÚŒŞ
 = 
	`pci_cÚf_»ad16
(
bus
, 
¦Ù
, 
func
, 
	`msix_cÚŒŞ_»g
(
pos
));

963 
Ën
 = 
	`msix_bË_size
(
cÚŒŞ
è* 
PCI_MSIX_ENTRY_SIZE
;

965  
Ën
;

966 
	}
}

968 
	$dump_msi
(
key
)

970 
œq
;

972 
	`´štk
("PCI-MSI interrupt information:\n");

974  
œq
 = 0; irq < 
Ä_œqs
; irq++ )

976 
œq_desc
 *
desc
 = 
	`œq_to_desc
(
œq
);

977 cÚ¡ 
msi_desc
 *
’Œy
;

978 
u32
 
addr
, 
d©a
;

979 
æags
;

980 
ty³
;

982 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

984 
’Œy
 = 
desc
->
msi_desc
;

985 
ty³
 = 
desc
->
hªdËr
 =ğ&
pci_msi_ty³
 && 
’Œy
;

987 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

989 iàĞ!
ty³
 )

992  
’Œy
->
msi_©Œib
.
ty³
 )

994 
PCI_CAP_ID_MSI
: 
ty³
 = ' '; ;

995 
PCI_CAP_ID_MSIX
: 
ty³
 = 'X'; ;

996 : 
ty³
 = '?'; ;

999 
d©a
 = 
’Œy
->
msg
.data;

1000 
addr
 = 
’Œy
->
msg
.
add»ss_lo
;

1002 
	`´štk
(" MSI%c %4u vec=%02x%7s%6s%3sassert%5s%7s"

1004 
ty³
, 
œq
,

1005 (
d©a
 & 
MSI_DATA_VECTOR_MASK
è>> 
MSI_DATA_VECTOR_SHIFT
,

1006 
d©a
 & 
MSI_DATA_DELIVERY_LOWPRI
 ? "lowest" : "fixed",

1007 
d©a
 & 
MSI_DATA_TRIGGER_LEVEL
 ? "level" : "edge",

1008 
d©a
 & 
MSI_DATA_LEVEL_ASSERT
 ? "" : "de",

1009 
addr
 & 
MSI_ADDR_DESTMODE_LOGIC
 ? "log" : "phys",

1010 
addr
 & 
MSI_ADDR_REDIRECTION_LOWPRI
 ? "lowest" : "cpu",

1011 
’Œy
->
msg
.
de¡32
,

1012 
’Œy
->
msi_©Œib
.
maskb™
,ƒÁry->msi_©Œib.
masked
,

1013 
	`msi_g‘_mask_b™
(
’Œy
));

1015 
	}
}

1017 
keyhªdËr
 
	gdump_msi_keyhªdËr
 = {

1018 .
dŸgno¡ic
 = 1,

1019 .
	gu
.
	gâ
 = 
dump_msi
,

1020 .
	gdesc
 = "dump MSI state"

1023 
__š™
 
	$msi_£tup_keyhªdËr
()

1025 
	`»gi¡”_keyhªdËr
('M', &
dump_msi_keyhªdËr
);

1027 
	}
}

1028 
__š™ÿÎ
(
msi_£tup_keyhªdËr
);

	@nmi.c

16 
	~<x’/cÚfig.h
>

17 
	~<x’/š™.h
>

18 
	~<x’/lib.h
>

19 
	~<x’/mm.h
>

20 
	~<x’/œq.h
>

21 
	~<x’/d–ay.h
>

22 
	~<x’/time.h
>

23 
	~<x’/sched.h
>

24 
	~<x’/cÚsŞe.h
>

25 
	~<x’/smp.h
>

26 
	~<x’/keyhªdËr.h
>

27 
	~<x’/ıu.h
>

28 
	~<asm/cu¼’t.h
>

29 
	~<asm/mc146818¹c.h
>

30 
	~<asm/m¤.h
>

31 
	~<asm/mp¥ec.h
>

32 
	~<asm/debugg”.h
>

33 
	~<asm/div64.h
>

34 
	~<asm/­ic.h
>

36 
	gnmi_w©chdog
 = 
NMI_NONE
;

37 
	gnmi_hz
 = 
HZ
;

38 
	gnmi_³rfùr_m¤
;

39 
	gnmi_p4_ccü_v®
;

40 
DEFINE_PER_CPU
(
tim”
, 
nmi_tim”
);

41 
DEFINE_PER_CPU
(, 
nmi_tim”_ticks
);

52 
DEFINE_SPINLOCK
(
Ïpic_nmi_owÃr_lock
);

53 
	gÏpic_nmi_owÃr
;

54 
	#LAPIC_NMI_WATCHDOG
 (1<<0)

	)

55 
	#LAPIC_NMI_RESERVED
 (1<<1)

	)

63 
	gnmi_aùive
;

65 
	#K7_EVNTSEL_ENABLE
 (1 << 22)

	)

66 
	#K7_EVNTSEL_INT
 (1 << 20)

	)

67 
	#K7_EVNTSEL_OS
 (1 << 17)

	)

68 
	#K7_EVNTSEL_USR
 (1 << 16)

	)

69 
	#K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING
 0x76

	)

70 
	#K7_NMI_EVENT
 
K7_EVENT_CYCLES_PROCESSOR_IS_RUNNING


	)

72 
	#P6_EVNTSEL0_ENABLE
 (1 << 22)

	)

73 
	#P6_EVNTSEL_INT
 (1 << 20)

	)

74 
	#P6_EVNTSEL_OS
 (1 << 17)

	)

75 
	#P6_EVNTSEL_USR
 (1 << 16)

	)

76 
	#P6_EVENT_CPU_CLOCKS_NOT_HALTED
 0x79

	)

77 
	#CORE_EVENT_CPU_CLOCKS_NOT_HALTED
 0x3c

	)

79 
	#P4_ESCR_EVENT_SELECT
(
N
è((N)<<25)

	)

80 
	#P4_CCCR_OVF_PMI0
 (1<<26)

	)

81 
	#P4_CCCR_OVF_PMI1
 (1<<27)

	)

82 
	#P4_CCCR_THRESHOLD
(
N
è((N)<<20)

	)

83 
	#P4_CCCR_COMPLEMENT
 (1<<19)

	)

84 
	#P4_CCCR_COMPARE
 (1<<18)

	)

85 
	#P4_CCCR_REQUIRED
 (3<<16)

	)

86 
	#P4_CCCR_ESCR_SELECT
(
N
è((N)<<13)

	)

87 
	#P4_CCCR_ENABLE
 (1<<12)

	)

93 
	#P4_NMI_CRU_ESCR0
 
	`P4_ESCR_EVENT_SELECT
(0x3F)

	)

94 
	#P4_NMI_IQ_CCCR0
 \

95 (
P4_CCCR_OVF_PMI0
|
	`P4_CCCR_THRESHOLD
(15)|
P4_CCCR_COMPLEMENT
| \

96 
P4_CCCR_COMPARE
|
P4_CCCR_REQUIRED
|
	`P4_CCCR_ESCR_SELECT
(4)|
P4_CCCR_ENABLE
)

	)

98 
__š™
 
	$check_nmi_w©chdog
 ()

100 
__š™d©a
 
´ev_nmi_couÁ
[
NR_CPUS
];

101 
ıu
;

103 iàĞ!
nmi_w©chdog
 )

106 
	`´štk
("Testing NMI watchdog --- ");

108 
	`fÜ_—ch_Úlše_ıu
 ( 
ıu
 )

109 
´ev_nmi_couÁ
[
ıu
] = 
	`nmi_couÁ
(cpu);

110 
	`loÿl_œq_’abË
();

111 
	`md–ay
((10*1000)/
nmi_hz
);

113 
	`fÜ_—ch_Úlše_ıu
 ( 
ıu
 )

115 iàĞ
	`nmi_couÁ
(
ıu
è- 
´ev_nmi_couÁ
[cpu] <= 5 )

116 
	`´štk
("CPU#%d stuck. ", 
ıu
);

118 
	`´štk
("CPU#%d okay. ", 
ıu
);

121 
	`´štk
("\n");

132 iàĞ
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
 )

133 
nmi_hz
 = 
	`max
(1ul, 
ıu_khz
 >> 20);

136 
	}
}

138 
	$nmi_tim”_â
(*
unu£d
)

140 
	`this_ıu
(
nmi_tim”_ticks
)++;

141 
	`£t_tim”
(&
	`this_ıu
(
nmi_tim”
), 
	`NOW
(è+ 
	`MILLISECS
(1000));

142 
	}
}

144 
	$di§bË_Ïpic_nmi_w©chdog
()

146 ià(
nmi_aùive
 <= 0)

148 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

149 
X86_VENDOR_AMD
:

150 
	`wrm¤
(
MSR_K7_EVNTSEL0
, 0, 0);

152 
X86_VENDOR_INTEL
:

153 
boÙ_ıu_d©a
.
x86
) {

155 ià(
boÙ_ıu_d©a
.
x86_mod–
 > 0xd)

158 
	`wrm¤
(
MSR_P6_EVNTSEL0
, 0, 0);

161 ià(
boÙ_ıu_d©a
.
x86_mod–
 > 0x4)

164 
	`wrm¤
(
MSR_P4_IQ_CCCR0
, 0, 0);

165 
	`wrm¤
(
MSR_P4_CRU_ESCR0
, 0, 0);

170 
nmi_aùive
 = -1;

172 
nmi_w©chdog
 = 0;

173 
	}
}

175 
	$’abË_Ïpic_nmi_w©chdog
()

177 ià(
nmi_aùive
 < 0) {

178 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

179 
	`£tup_­ic_nmi_w©chdog
();

181 
	}
}

183 
	$»£rve_Ïpic_nmi
()

185 
Şd_owÃr
;

187 
	`¥š_lock
(&
Ïpic_nmi_owÃr_lock
);

188 
Şd_owÃr
 = 
Ïpic_nmi_owÃr
;

189 
Ïpic_nmi_owÃr
 |ğ
LAPIC_NMI_RESERVED
;

190 
	`¥š_uÆock
(&
Ïpic_nmi_owÃr_lock
);

191 ià(
Şd_owÃr
 & 
LAPIC_NMI_RESERVED
)

192  -
EBUSY
;

193 ià(
Şd_owÃr
 & 
LAPIC_NMI_WATCHDOG
)

194 
	`di§bË_Ïpic_nmi_w©chdog
();

196 
	}
}

198 
	$»Ëa£_Ïpic_nmi
()

200 
Ãw_owÃr
;

202 
	`¥š_lock
(&
Ïpic_nmi_owÃr_lock
);

203 
Ãw_owÃr
 = 
Ïpic_nmi_owÃr
 & ~
LAPIC_NMI_RESERVED
;

204 
Ïpic_nmi_owÃr
 = 
Ãw_owÃr
;

205 
	`¥š_uÆock
(&
Ïpic_nmi_owÃr_lock
);

206 ià(
Ãw_owÃr
 & 
LAPIC_NMI_WATCHDOG
)

207 
	`’abË_Ïpic_nmi_w©chdog
();

208 
	}
}

210 
	#__pmš™
 
__devš™


	)

217 
__pmš™
 
	$ş—r_m¤_¿nge
(
ba£
, 
n
)

219 
i
;

221 
i
 = 0; i < 
n
; i++)

222 
	`wrm¤
(
ba£
+
i
, 0, 0);

223 
	}
}

225 
šlše
 
	$wr™e_w©chdog_couÁ”
(cÚ¡ *
desü
)

227 
u64
 
couÁ
 = (u64)
ıu_khz
 * 1000;

229 
	`do_div
(
couÁ
, 
nmi_hz
);

230 if(
desü
)

231 
	`D´štk
("£‰šg % tØ-0x%"
PRIx64
"\n", 
desü
, 
couÁ
);

232 
	`wrm¤l
(
nmi_³rfùr_m¤
, 0 - 
couÁ
);

233 
	}
}

235 
__pmš™
 
	$£tup_k7_w©chdog
()

237 
evÁ£l
;

239 
nmi_³rfùr_m¤
 = 
MSR_K7_PERFCTR0
;

241 
	`ş—r_m¤_¿nge
(
MSR_K7_EVNTSEL0
, 4);

242 
	`ş—r_m¤_¿nge
(
MSR_K7_PERFCTR0
, 4);

244 
evÁ£l
 = 
K7_EVNTSEL_INT


245 | 
K7_EVNTSEL_OS


246 | 
K7_EVNTSEL_USR


247 | 
K7_NMI_EVENT
;

249 
	`wrm¤
(
MSR_K7_EVNTSEL0
, 
evÁ£l
, 0);

250 
	`wr™e_w©chdog_couÁ”
("K7_PERFCTR0");

251 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

252 
evÁ£l
 |ğ
K7_EVNTSEL_ENABLE
;

253 
	`wrm¤
(
MSR_K7_EVNTSEL0
, 
evÁ£l
, 0);

254 
	}
}

256 
__pmš™
 
	$£tup_p6_w©chdog
(
couÁ”
)

258 
evÁ£l
;

260 
nmi_³rfùr_m¤
 = 
MSR_P6_PERFCTR0
;

262 
	`ş—r_m¤_¿nge
(
MSR_P6_EVNTSEL0
, 2);

263 
	`ş—r_m¤_¿nge
(
MSR_P6_PERFCTR0
, 2);

265 
evÁ£l
 = 
P6_EVNTSEL_INT


266 | 
P6_EVNTSEL_OS


267 | 
P6_EVNTSEL_USR


268 | 
couÁ”
;

270 
	`wrm¤
(
MSR_P6_EVNTSEL0
, 
evÁ£l
, 0);

271 
	`wr™e_w©chdog_couÁ”
("P6_PERFCTR0");

272 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

273 
evÁ£l
 |ğ
P6_EVNTSEL0_ENABLE
;

274 
	`wrm¤
(
MSR_P6_EVNTSEL0
, 
evÁ£l
, 0);

275 
	}
}

277 
__pmš™
 
	$£tup_p4_w©chdog
()

279 
ušt64_t
 
misc_’abË
;

281 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
misc_’abË
);

282 ià(!(
misc_’abË
 & 
MSR_IA32_MISC_ENABLE_PERF_AVAIL
))

285 
nmi_³rfùr_m¤
 = 
MSR_P4_IQ_PERFCTR0
;

286 
nmi_p4_ccü_v®
 = 
P4_NMI_IQ_CCCR0
;

287 iàĞ
boÙ_ıu_d©a
.
x86_num_siblšgs
 == 2 )

288 
nmi_p4_ccü_v®
 |ğ
P4_CCCR_OVF_PMI1
;

290 ià(!(
misc_’abË
 & 
MSR_IA32_MISC_ENABLE_PEBS_UNAVAIL
))

291 
	`ş—r_m¤_¿nge
(0x3F1, 2);

294 ià(
boÙ_ıu_d©a
.
x86_mod–
 >= 0x3) {

296 
	`ş—r_m¤_¿nge
(0x3A0, 26);

297 
	`ş—r_m¤_¿nge
(0x3BC, 3);

299 
	`ş—r_m¤_¿nge
(0x3A0, 31);

301 
	`ş—r_m¤_¿nge
(0x3C0, 6);

302 
	`ş—r_m¤_¿nge
(0x3C8, 6);

303 
	`ş—r_m¤_¿nge
(0x3E0, 2);

304 
	`ş—r_m¤_¿nge
(
MSR_P4_BPU_CCCR0
, 18);

305 
	`ş—r_m¤_¿nge
(
MSR_P4_BPU_PERFCTR0
, 18);

307 
	`wrm¤l
(
MSR_P4_CRU_ESCR0
, 
P4_NMI_CRU_ESCR0
);

308 
	`wrm¤l
(
MSR_P4_IQ_CCCR0
, 
P4_NMI_IQ_CCCR0
 & ~
P4_CCCR_ENABLE
);

309 
	`wr™e_w©chdog_couÁ”
("P4_IQ_COUNTER0");

310 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

311 
	`wrm¤l
(
MSR_P4_IQ_CCCR0
, 
nmi_p4_ccü_v®
);

313 
	}
}

315 
__pmš™
 
	$£tup_­ic_nmi_w©chdog
()

317 ià(!
nmi_w©chdog
)

320 
boÙ_ıu_d©a
.
x86_v’dÜ
) {

321 
X86_VENDOR_AMD
:

322 
boÙ_ıu_d©a
.
x86
) {

325 
	`£tup_k7_w©chdog
();

331 
X86_VENDOR_INTEL
:

332 
boÙ_ıu_d©a
.
x86
) {

334 
	`£tup_p6_w©chdog
((
boÙ_ıu_d©a
.
x86_mod–
 < 14)

335 ? 
P6_EVENT_CPU_CLOCKS_NOT_HALTED


336 : 
CORE_EVENT_CPU_CLOCKS_NOT_HALTED
);

339 ià(!
	`£tup_p4_w©chdog
())

350 
Ïpic_nmi_owÃr
 = 
LAPIC_NMI_WATCHDOG
;

351 
nmi_aùive
 = 1;

352 
	}
}

354 
	$ıu_nmi_ÿÎback
(

355 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

357 
ıu
 = ()
hıu
;

359  
aùiÚ
 )

361 
CPU_UP_PREPARE
:

362 
	`š™_tim”
(&
	`³r_ıu
(
nmi_tim”
, 
ıu
), 
nmi_tim”_â
, 
NULL
, cpu);

363 
	`£t_tim”
(&
	`³r_ıu
(
nmi_tim”
, 
ıu
), 
	`NOW
());

365 
CPU_UP_CANCELED
:

366 
CPU_DEAD
:

367 
	`kl_tim”
(&
	`³r_ıu
(
nmi_tim”
, 
ıu
));

373  
NOTIFY_DONE
;

374 
	}
}

376 
nÙif›r_block
 
	gıu_nmi_nfb
 = {

377 .
nÙif›r_ÿÎ
 = 
ıu_nmi_ÿÎback


380 
DEFINE_PER_CPU
(, 
Ï¡_œq_sums
);

381 
DEFINE_PER_CPU
(, 
®”t_couÁ”
);

383 
©omic_t
 
	gw©chdog_di§bË_couÁ
 = 
ATOMIC_INIT
(1);

385 
	$w©chdog_di§bË
()

387 
	`©omic_šc
(&
w©chdog_di§bË_couÁ
);

388 
	}
}

390 
	$w©chdog_’abË
()

392 
h—¹b—t_š™Ÿli£d
;

393 
ıu
;

395 iàĞ!
	`©omic_dec_ªd_‹¡
(&
w©chdog_di§bË_couÁ
) ||

396 
	`‹¡_ªd_£t_b™
(0, &
h—¹b—t_š™Ÿli£d
) )

403 
	`fÜ_—ch_Úlše_ıu
 ( 
ıu
 )

404 
	`ıu_nmi_ÿÎback
(&
ıu_nmi_nfb
, 
CPU_UP_PREPARE
, (*)()
ıu
);

405 
	`»gi¡”_ıu_nÙif›r
(&
ıu_nmi_nfb
);

406 
	}
}

408 
	$nmi_w©chdog_tick
(
ıu_u£r_»gs
 * 
»gs
)

410 
sum
 = 
	`this_ıu
(
nmi_tim”_ticks
);

412 iàĞ(
	`this_ıu
(
Ï¡_œq_sums
è=ğ
sum
) &&

413 !
	`©omic_»ad
(&
w©chdog_di§bË_couÁ
) )

419 
	`this_ıu
(
®”t_couÁ”
)++;

420 iàĞ
	`this_ıu
(
®”t_couÁ”
è=ğ5*
nmi_hz
 )

422 
	`cÚsŞe_fÜû_uÆock
();

423 
	`´štk
("Watchdogimer detectshat CPU%d is stuck!\n",

424 
	`smp_´oûssÜ_id
());

425 
	`çl_Œ­
(
TRAP_nmi
, 
»gs
);

430 
	`this_ıu
(
Ï¡_œq_sums
èğ
sum
;

431 
	`this_ıu
(
®”t_couÁ”
) = 0;

434 iàĞ
nmi_³rfùr_m¤
 )

436 iàĞ
nmi_³rfùr_m¤
 =ğ
MSR_P4_IQ_PERFCTR0
 )

445 
	`wrm¤l
(
MSR_P4_IQ_CCCR0
, 
nmi_p4_ccü_v®
);

446 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

448 iàĞ
nmi_³rfùr_m¤
 =ğ
MSR_P6_PERFCTR0
 )

454 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

456 
	`wr™e_w©chdog_couÁ”
(
NULL
);

458 
	}
}

466 
	$£lf_nmi
()

468 
u32
 
id
 = 
	`g‘_­ic_id
();

469 
	`loÿl_œq_di§bË
();

470 
	`­ic_wa™_iü_idË
();

471 
	`­ic_iü_wr™e
(
APIC_DM_NMI
 | 
APIC_DEST_PHYSICAL
, 
id
);

472 
	`loÿl_œq_’abË
();

473 
	}
}

475 
	$do_nmi_Œigg”
(
key
)

477 
	`´štk
("Trigg”šg NMI oÀAPIC ID %x\n", 
	`g‘_­ic_id
());

478 
	`£lf_nmi
();

479 
	}
}

481 
keyhªdËr
 
	gnmi_Œigg”_keyhªdËr
 = {

482 .
u
.
â
 = 
do_nmi_Œigg”
,

483 .
	gdesc
 = "trigger‡n NMI"

486 
	$do_nmi_¡©s
(
key
)

488 
i
;

489 
domaš
 *
d
;

490 
vıu
 *
v
;

492 
	`´štk
("CPU\tNMI\n");

493 
	`fÜ_—ch_Úlše_ıu
 ( 
i
 )

494 
	`´štk
("%3d\t%3d\n", 
i
, 
	`nmi_couÁ
(i));

496 iàĞ((
d
 = 
dom0
è=ğ
NULL
è|| (d->
vıu
 == NULL) ||

497 ((
v
 = 
d
->
vıu
[0]è=ğ
NULL
) )

500 
i
 = 
v
->
async_exû±iÚ_mask
 & (1 << 
VCPU_TRAP_NMI
);

501 iàĞ
v
->
nmi_³ndšg
 || 
i
 )

502 
	`´štk
("dom0 vpu0: NMI %s%s\n",

503 
v
->
nmi_³ndšg
 ? "pending " : "",

504 
i
 ? "masked " : "");

506 
	`´štk
("dom0 vcpu0: NMI‚either…ending‚or masked\n");

507 
	}
}

509 
keyhªdËr
 
	gnmi_¡©s_keyhªdËr
 = {

510 .
dŸgno¡ic
 = 1,

511 .
	gu
.
	gâ
 = 
do_nmi_¡©s
,

512 .
	gdesc
 = "NMI statistics"

515 
__š™
 
	$»gi¡”_nmi_Œigg”
()

517 
	`»gi¡”_keyhªdËr
('N', &
nmi_Œigg”_keyhªdËr
);

518 
	`»gi¡”_keyhªdËr
('n', &
nmi_¡©s_keyhªdËr
);

520 
	}
}

521 
__š™ÿÎ
(
»gi¡”_nmi_Œigg”
);

	@numa.c

7 
	~<x’/mm.h
>

8 
	~<x’/¡ršg.h
>

9 
	~<x’/š™.h
>

10 
	~<x’/ùy³.h
>

11 
	~<x’/nodemask.h
>

12 
	~<x’/numa.h
>

13 
	~<x’/keyhªdËr.h
>

14 
	~<x’/time.h
>

15 
	~<x’/smp.h
>

16 
	~<asm/aıi.h
>

17 
	~<x’/sched.h
>

19 
numa_£tup
(*
s
);

20 
cu¡om_·¿m
("numa", 
numa_£tup
);

22 #iâdeà
D´štk


23 
	#D´štk
(
x
...)

	)

27 
	#round_up
(
x
,
y
è((((x)+(y))-1è& (~((y)-1)))

	)

29 
node_d©a
 
	gnode_d©a
[
MAX_NUMNODES
];

32 
	gmemnode_shiá
;

33 
	$ty³of
(*
memnodem­
è
_memnodem­
[64];

34 
memnodem­size
;

35 
u8
 *
memnodem­
;

37 
ıu_to_node
[
NR_CPUS
] 
__»ad_mo¡ly
 = {

38 [0 ... 
NR_CPUS
-1] = 
NUMA_NO_NODE


39 
	}
};

43 
	g­icid_to_node
[
MAX_LOCAL_APIC
] 
	g__ıuš™d©a
 = {

44 [0 ... 
MAX_LOCAL_APIC
-1] = 
NUMA_NO_NODE


46 
ıumask_t
 
	gnode_to_ıumask
[
MAX_NUMNODES
] 
	g__»ad_mo¡ly
;

48 
nodemask_t
 
__»ad_mo¡ly
 
	gnode_Úlše_m­
 = { { [0] = 1UL } };

50 
numa_off
 
	g__devš™d©a
 = 0;

52 
aıi_numa
 
	g__devš™d©a
;

54 
	$¤©_di§bËd
()

56  
numa_off
 || 
aıi_numa
 < 0;

57 
	}
}

66 
__š™
 
	$pİuÏ‹_memnodem­
(cÚ¡ 
node
 *
nodes
,

67 
numnodes
, 
shiá
, *
nodeids
)

69 
¥dx
, 
•dx
;

70 
i
, 
»s
 = -1;

72 
	`mem£t
(
memnodem­
, 
NUMA_NO_NODE
, 
memnodem­size
 * (*memnodemap));

73 
i
 = 0; i < 
numnodes
; i++) {

74 
¥dx
 = 
	`·ddr_to_pdx
(
nodes
[
i
].
¡¬t
);

75 
•dx
 = 
	`·ddr_to_pdx
(
nodes
[
i
].
’d
 - 1) + 1;

76 ià(
¥dx
 >ğ
•dx
)

78 ià((
•dx
 >> 
shiá
è>ğ
memnodem­size
)

81 ià(
memnodem­
[
¥dx
 >> 
shiá
] !ğ
NUMA_NO_NODE
)

84 ià(!
nodeids
)

85 
memnodem­
[
¥dx
 >> 
shiá
] = 
i
;

87 
memnodem­
[
¥dx
 >> 
shiá
] = 
nodeids
[
i
];

89 
¥dx
 +ğ(1UL << 
shiá
);

90 } 
¥dx
 < 
•dx
);

91 
»s
 = 1;

93  
»s
;

94 
	}
}

96 
__š™
 
	$®loÿ‹_ÿch—ligÃd_memnodem­
()

98 #iâdeà
__i386__


99 
size
 = 
	`PFN_UP
(
memnodem­size
 * (*
memnodem­
));

100 
mâ
 = 
	`®loc_boÙ_·ges
(
size
, 1);

102 ià(!
mâ
) {

103 
	`´štk
(
KERN_ERR


105 
memnodem­size
 = 0;

109 
memnodem­
 = 
	`mâ_to_vœt
(
mâ
);

110 
mâ
 <<ğ
PAGE_SHIFT
;

111 
size
 <<ğ
PAGE_SHIFT
;

112 
	`´štk
(
KERN_DEBUG
 "NUMA: Allocated memnodemap from %lx - %lx\n",

113 
mâ
, mâ + 
size
);

114 
memnodem­size
 = 
size
 / (*
memnodem­
);

118 
	`´štk
(
KERN_ERR


120 
memnodem­size
, 
	`ARRAY_SIZE
(
_memnodem­
));

121 
memnodem­size
 = 0;

124 
	}
}

130 
__š™
 
	$exŒaù_lsb_äom_nodes
(cÚ¡ 
node
 *
nodes
,

131 
numnodes
)

133 
i
, 
nodes_u£d
 = 0;

134 
¥dx
, 
•dx
;

135 
b™f›ld
 = 0, 
memtİ
 = 0;

137 
i
 = 0; i < 
numnodes
; i++) {

138 
¥dx
 = 
	`·ddr_to_pdx
(
nodes
[
i
].
¡¬t
);

139 
•dx
 = 
	`·ddr_to_pdx
(
nodes
[
i
].
’d
 - 1) + 1;

140 ià(
¥dx
 >ğ
•dx
)

142 
b™f›ld
 |ğ
¥dx
;

143 
nodes_u£d
++;

144 ià(
•dx
 > 
memtİ
)

145 
memtİ
 = 
•dx
;

147 ià(
nodes_u£d
 <= 1)

148 
i
 = 
BITS_PER_LONG
 - 1;

150 
i
 = 
	`fšd_fœ¡_b™
(&
b™f›ld
, ()*8);

151 
memnodem­size
 = (
memtİ
 >> 
i
) + 1;

152  
i
;

153 
	}
}

155 
__š™
 
	$compu‹_hash_shiá
(
node
 *
nodes
, 
numnodes
,

156 *
nodeids
)

158 
shiá
;

160 
shiá
 = 
	`exŒaù_lsb_äom_nodes
(
nodes
, 
numnodes
);

161 ià(
memnodem­size
 <ğ
	`ARRAY_SIZE
(
_memnodem­
))

162 
memnodem­
 = 
_memnodem­
;

163 ià(
	`®loÿ‹_ÿch—ligÃd_memnodem­
())

165 
	`´štk
(
KERN_DEBUG
 "NUMA: Using %d forhe hash shift.\n",

166 
shiá
);

168 ià(
	`pİuÏ‹_memnodem­
(
nodes
, 
numnodes
, 
shiá
, 
nodeids
) != 1) {

169 
	`´štk
(
KERN_INFO
 "Your memory is‚ot‡ligned you‚eedo "

171 "shiá=%d\n", 
shiá
);

174  
shiá
;

175 
	}
}

177 
__š™
 
	$£tup_node_boÙmem
(
nodeid
, 
u64
 
¡¬t
, u64 
’d
)

179 
¡¬t_pâ
, 
’d_pâ
;

181 
¡¬t_pâ
 = 
¡¬t
 >> 
PAGE_SHIFT
;

182 
’d_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

184 
	`NODE_DATA
(
nodeid
)->
node_id
 =‚odeid;

185 
	`NODE_DATA
(
nodeid
)->
node_¡¬t_pâ
 = 
¡¬t_pâ
;

186 
	`NODE_DATA
(
nodeid
)->
node_¥ªÃd_·ges
 = 
’d_pâ
 - 
¡¬t_pâ
;

188 
	`node_£t_Úlše
(
nodeid
);

189 
	}
}

191 
__š™
 
	$numa_š™_¬¿y
()

193 
¼
, 
i
;

199 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

200 
i
 = 0; i < 
NR_CPUS
; i++) {

201 ià(
ıu_to_node
[
i
] !ğ
NUMA_NO_NODE
)

203 
	`numa_£t_node
(
i
, 
¼
);

204 
¼
 = 
	`Ãxt_node
Ôr, 
node_Úlše_m­
);

205 ià(
¼
 =ğ
MAX_NUMNODES
)

206 
¼
 = 
	`fœ¡_node
(
node_Úlše_m­
);

209 
	}
}

211 #ifdeà
CONFIG_NUMA_EMU


212 
numa_çke
 
	g__š™d©a
 = 0;

215 
	$numa_emuÏtiÚ
(
u64
 
¡¬t_pâ
, u64 
’d_pâ
)

217 
i
;

218 
node
 
nodes
[
MAX_NUMNODES
];

219 
u64
 
sz
 = ((
’d_pâ
 - 
¡¬t_pâ
)<<
PAGE_SHIFT
è/ 
numa_çke
;

222 ià(
	`hweight64
(
sz
) > 1) {

223 
u64
 
x
 = 1;

224 (
x
 << 1è< 
sz
)

225 
x
 <<= 1;

226 ià(
x
 < 
sz
/2)

227 
	`´štk
(
KERN_ERR
 "Numaƒmulation unbalanced. Complaino maintainer\n");

228 
sz
 = 
x
;

231 
	`mem£t
(&
nodes
,0,(nodes));

232 
i
 = 0; i < 
numa_çke
; i++) {

233 
nodes
[
i
].
¡¬t
 = (
¡¬t_pâ
<<
PAGE_SHIFT
è+ i*
sz
;

234 ià(
i
 =ğ
numa_çke
-1)

235 
sz
 = (
’d_pâ
<<
PAGE_SHIFT
è- 
nodes
[
i
].
¡¬t
;

236 
nodes
[
i
].
’d
 =‚odes[i].
¡¬t
 + 
sz
;

237 
	`´štk
(
KERN_INFO
 "Fakšg‚od%d‡ˆ%"
PRIx64
"-%"PRIx64" (%"
PRIu64
"MB)\n",

238 
i
,

239 
nodes
[
i
].
¡¬t
,‚odes[i].
’d
,

240 (
nodes
[
i
].
’d
 -‚odes[i].
¡¬t
) >> 20);

241 
	`node_£t_Úlše
(
i
);

243 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
nodes
, 
numa_çke
, 
NULL
);

244 ià(
memnode_shiá
 < 0) {

245 
memnode_shiá
 = 0;

246 
	`´štk
(
KERN_ERR
 "No NUMA hash function found. Emulation disabled.\n");

249 
	`fÜ_—ch_Úlše_node
(
i
)

250 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

251 
	`numa_š™_¬¿y
();

253 
	}
}

256 
__š™
 
	$numa_š™mem_š™
(
¡¬t_pâ
, 
’d_pâ
)

258 
i
;

260 #ifdeà
CONFIG_NUMA_EMU


261 ià(
numa_çke
 && !
	`numa_emuÏtiÚ
(
¡¬t_pâ
, 
’d_pâ
))

265 #ifdeà
CONFIG_ACPI_NUMA


266 ià(!
numa_off
 && !
	`aıi_sÿn_nodes
((
u64
)
¡¬t_pâ
 << 
PAGE_SHIFT
,

267 (
u64
)
’d_pâ
 << 
PAGE_SHIFT
))

271 
	`´štk
(
KERN_INFO
 "%s\n",

272 
numa_off
 ? "NUMAurned off" : "No NUMA configuration found");

274 
	`´štk
(
KERN_INFO
 "Fakšg‡‚od© %016"
PRIx64
"-%016"PRIx64"\n",

275 (
u64
)
¡¬t_pâ
 << 
PAGE_SHIFT
,

276 (
u64
)
’d_pâ
 << 
PAGE_SHIFT
);

278 
memnode_shiá
 = 
BITS_PER_LONG
 - 1;

279 
memnodem­
 = 
_memnodem­
;

280 
	`nodes_ş—r
(
node_Úlše_m­
);

281 
	`node_£t_Úlše
(0);

282 
i
 = 0; i < 
NR_CPUS
; i++)

283 
	`numa_£t_node
(
i
, 0);

284 
node_to_ıumask
[0] = 
	`ıumask_of_ıu
(0);

285 
	`£tup_node_boÙmem
(0, (
u64
)
¡¬t_pâ
 << 
PAGE_SHIFT
, (u64)
’d_pâ
 << PAGE_SHIFT);

286 
	}
}

288 
__ıuš™
 
	$numa_add_ıu
(
ıu
)

290 
	`ıu_£t
(
ıu
, 
node_to_ıumask
[
	`ıu_to_node
(cpu)]);

291 
	}
}

293 
__ıuš™
 
	$numa_£t_node
(
ıu
, 
node
)

295 
ıu_to_node
[
ıu
] = 
node
;

296 
	}
}

299 
__š™
 
	$numa_£tup
(*
İt
)

301 ià(!
	`¡ºcmp
(
İt
,"off",3))

302 
numa_off
 = 1;

303 ià(!
	`¡ºcmp
(
İt
,"on",2))

304 
numa_off
 = 0;

305 #ifdeà
CONFIG_NUMA_EMU


306 if(!
	`¡ºcmp
(
İt
, "fake=", 5)) {

307 
numa_off
 = 0;

308 
numa_çke
 = 
	`sim¶e_¡¹oul
(
İt
+5,
NULL
,0); ;

309 ià(
numa_çke
 >ğ
MAX_NUMNODES
)

310 
numa_çke
 = 
MAX_NUMNODES
;

313 #ifdeà
CONFIG_ACPI_NUMA


314 ià(!
	`¡ºcmp
(
İt
,"noacpi",6)) {

315 
numa_off
 = 0;

316 
aıi_numa
 = -1;

320 
	}
}

334 
__devš™
 
	$š™_ıu_to_node
()

336 
i
, 
node
;

337 
i
 = 0; i < 
NR_CPUS
; i++) {

338 
u32
 
­icid
 = 
x86_ıu_to_­icid
[
i
];

339 ià(
­icid
 =ğ
BAD_APICID
)

341 
node
 = 
­icid_to_node
[
­icid
];

342 iàĞ
node
 =ğ
NUMA_NO_NODE
 || !
	`node_Úlše
(node) )

343 
node
 = 0;

344 
	`numa_£t_node
(
i
, 
node
);

346 
	}
}

348 
EXPORT_SYMBOL
(
ıu_to_node
);

349 
EXPORT_SYMBOL
(
node_to_ıumask
);

350 
EXPORT_SYMBOL
(
memnode_shiá
);

351 
EXPORT_SYMBOL
(
memnodem­
);

352 
EXPORT_SYMBOL
(
node_d©a
);

354 
	$dump_numa
(
key
)

356 
s_time_t
 
now
 = 
	`NOW
();

357 
i
;

358 
domaš
 *
d
;

359 
·ge_šfo
 *
·ge
;

360 
·ge_num_node
[
MAX_NUMNODES
];

362 
	`´štk
("'%c'…»s£d -> dumpšg‚um¨šfØÒow-0x%X:%08X)\n", 
key
,

363 (
u32
)(
now
>>32), (u32)now);

365 
	`fÜ_—ch_Úlše_node
(
i
) {

366 
·ddr_t
 
·
 = (·ddr_t)(
	`NODE_DATA
(
i
)->
node_¡¬t_pâ
 + 1)<< 
PAGE_SHIFT
;

367 
	`´štk
("idx%d -> NODE%d start->%lu size->%lu\n",

368 
i
, 
	`NODE_DATA
(i)->
node_id
,

369 
	`NODE_DATA
(
i
)->
node_¡¬t_pâ
,

370 
	`NODE_DATA
(
i
)->
node_¥ªÃd_·ges
);

372 
	`´štk
("phys_to_nid(%"
PRI·ddr
"è-> %d should b%d\n", 
·
, 
	`phys_to_nid
(pa),

373 
	`NODE_DATA
(
i
)->
node_id
);

375 
	`fÜ_—ch_Úlše_ıu
(
i
)

376 
	`´štk
("CPU%d -> NODE%d\n", 
i
, 
ıu_to_node
[i]);

378 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

380 
	`´štk
("Memory†ocation ofƒach domain:\n");

381 
	`fÜ_—ch_domaš
(
d
)

383 
	`´štk
("Domaš %u (tÙ®: %u):\n", 
d
->
domaš_id
, d->
tÙ_·ges
);

385 
	`fÜ_—ch_Úlše_node
(
i
)

386 
·ge_num_node
[
i
] = 0;

388 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

389 
	`·ge_li¡_fÜ_—ch
(
·ge
, &
d
->
·ge_li¡
)

391 
i
 = 
	`phys_to_nid
((
·ddr_t
)
	`·ge_to_mâ
(
·ge
è<< 
PAGE_SHIFT
);

392 
·ge_num_node
[
i
]++;

394 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

396 
	`fÜ_—ch_Úlše_node
(
i
)

397 
	`´štk
(" Nod%u: %u\n", 
i
, 
·ge_num_node
[i]);

400 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

401 
	}
}

403 
keyhªdËr
 
	gdump_numa_keyhªdËr
 = {

404 .
dŸgno¡ic
 = 1,

405 .
	gu
.
	gâ
 = 
dump_numa
,

406 .
	gdesc
 = "dump‚uma info"

409 
__š™
 
	$»gi¡”_numa_Œigg”
()

411 
	`»gi¡”_keyhªdËr
('u', &
dump_numa_keyhªdËr
);

413 
	}
}

414 
__š™ÿÎ
(
»gi¡”_numa_Œigg”
);

	@oprofile/backtrace.c

13 
	~<x’/ty³s.h
>

14 
	~<asm/·ge.h
>

15 
	~<x’/x’İrof.h
>

16 
	~<asm/gue¡_acûss.h
>

18 
	säame_h—d
 {

19 
äame_h—d
 * 
	mebp
;

20 
	m»t
;

21 } 
__©Œibu‹__
((
·cked
));

23 
äame_h—d
 *

24 
	$dump_hy³rvisÜ_backŒaû
(
domaš
 *
d
, 
vıu
 *vcpu,

25 
äame_h—d
 * 
h—d
, 
mode
)

27 ià(!
	`x’İrof_add_Œaû
(
d
, 
vıu
, 
h—d
->
»t
, 
mode
))

32 ià(
h—d
 >ğh—d->
ebp
)

33  
NULL
;

35  
h—d
->
ebp
;

36 
	}
}

38 
äame_h—d
 *

39 
	$dump_gue¡_backŒaû
(
domaš
 *
d
, 
vıu
 *vcpu,

40 
äame_h—d
 * 
h—d
, 
mode
)

42 
äame_h—d
 
bufh—d
[2];

43 
	`XEN_GUEST_HANDLE
(è
gue¡_h—d
 = 
	`gue¡_hªdË_äom_±r
(
h—d
, );

46 ià(!
	`gue¡_hªdË_okay
(
gue¡_h—d
, (
bufh—d
)))

48 ià(
	`__cİy_äom_gue¡_off£t
((*)
bufh—d
, 
gue¡_h—d
, 0,

49 (
bufh—d
)))

52 ià(!
	`x’İrof_add_Œaû
(
d
, 
vıu
, 
bufh—d
[0].
»t
, 
mode
))

57 ià(
h—d
 >ğ
bufh—d
[0].
ebp
)

58  
NULL
;

60  
bufh—d
[0].
ebp
;

61 
	}
}

93 #ià
defšed
(
CONFIG_FRAME_POINTER
)

94 
	$v®id_hy³rvisÜ_¡ack
(
äame_h—d
 * 
h—d
,

95 
ıu_u£r_»gs
 * 
»gs
)

97 
h—daddr
 = ()
h—d
;

98 #ifdeà
CONFIG_X86_64


99 
¡ack
 = ()
»gs
->
r¥
;

101 
¡ack
 = ()
»gs
;

103 
¡ack_ba£
 = (
¡ack
 & ~(
STACK_SIZE
 - 1)) + STACK_SIZE;

105  
h—daddr
 > 
¡ack
 && h—dadd¸< 
¡ack_ba£
;

106 
	}
}

109 
	$v®id_hy³rvisÜ_¡ack
(
äame_h—d
 * 
h—d
,

110 
ıu_u£r_»gs
 * 
»gs
)

113 
	}
}

116 
	$x’İrof_backŒaû
(
domaš
 *
d
, 
vıu
 *vcpu,

117 
ıu_u£r_»gs
 * cÚ¡ 
»gs
,

118 
d•th
, 
mode
)

120 
äame_h—d
 *
h—d
;

122 
h—d
 = (
äame_h—d
 *)
»gs
->
ebp
;

124 ià(
mode
 > 1) {

125 
d•th
-- && 
	`v®id_hy³rvisÜ_¡ack
(
h—d
, 
»gs
))

126 
h—d
 = 
	`dump_hy³rvisÜ_backŒaû
(
d
, 
vıu
, h—d, 
mode
);

130 
d•th
-- && 
h—d
)

131 
h—d
 = 
	`dump_gue¡_backŒaû
(
d
, 
vıu
, h—d, 
mode
);

132 
	}
}

	@oprofile/nmi_int.c

14 
	~<x’/ev’t.h
>

15 
	~<x’/ty³s.h
>

16 
	~<x’/”ºo.h
>

17 
	~<x’/š™.h
>

18 
	~<x’/nmi.h
>

19 
	~<public/x’.h
>

20 
	~<asm/m¤.h
>

21 
	~<asm/­ic.h
>

22 
	~<asm/»gs.h
>

23 
	~<asm/cu¼’t.h
>

24 
	~<x’/d–ay.h
>

25 
	~<x’/¡ršg.h
>

27 
	~"İ_couÁ”.h
"

28 
	~"İ_x86_mod–.h
"

30 
İ_couÁ”_cÚfig
 
	gcouÁ”_cÚfig
[
OP_MAX_COUNTER
];

31 
İ_ibs_cÚfig
 
	gibs_cÚfig
;

33 
İ_x86_mod–_¥ec
 cÚ¡ *
__»ad_mo¡ly
 
	gmod–
;

34 
İ_m¤s
 
	gıu_m¤s
[
NR_CPUS
];

35 
	g§ved_lvc
[
NR_CPUS
];

37 *
	gıu_ty³
;

39 
	$·ssive_domaš_m¤_İ_checks
(
m¤
, *
ty³p
, *
šdexp
)

41 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
cu¼’t
);

42 iàĞ
mod–
 =ğ
NULL
 )

44 iàĞ
mod–
->
is_¬ch_pmu_m¤
 =ğ
NULL
 )

46 iàĞ!
mod–
->
	`is_¬ch_pmu_m¤
(
m¤
, 
ty³p
, 
šdexp
) )

49 iàĞ!(
vpmu
->
æags
 & 
PASSIVE_DOMAIN_ALLOCATED
) )

50 iàĞ! 
mod–
->
	`®loÿ‹d_m¤
(
cu¼’t
) )

53 
	}
}

55 
	$·ssive_domaš_do_rdm¤
(
m¤
, 
ušt64_t
 *
m¤_cÚ‹Á
)

57 
ty³
, 
šdex
;

59 iàĞ!
	`·ssive_domaš_m¤_İ_checks
(
m¤
, &
ty³
, &
šdex
))

62 
mod–
->
	`lßd_m¤
(
cu¼’t
, 
ty³
, 
šdex
, 
m¤_cÚ‹Á
);

64 
	}
}

66 
	$·ssive_domaš_do_wrm¤
(
m¤
, 
ušt64_t
 
m¤_cÚ‹Á
)

68 
ty³
, 
šdex
;

70 iàĞ!
	`·ssive_domaš_m¤_İ_checks
(
m¤
, &
ty³
, &
šdex
))

73 
mod–
->
	`§ve_m¤
(
cu¼’t
, 
ty³
, 
šdex
, 
m¤_cÚ‹Á
);

75 
	}
}

77 
	$·ssive_domaš_de¡roy
(
vıu
 *
v
)

79 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

80 iàĞ
vpmu
->
æags
 & 
PASSIVE_DOMAIN_ALLOCATED
 )

81 
mod–
->
	`ä“_m¤
(
v
);

82 
	}
}

84 
	$nmi_ÿÎback
(
ıu_u£r_»gs
 *
»gs
, 
ıu
)

86 
x’_mode
, 
ovf
;

88 
ovf
 = 
mod–
->
	`check_ùrs
(
ıu
, &
ıu_m¤s
[ıu], 
»gs
);

89 
x’_mode
 = 
	`ršg_0
(
»gs
);

90 iàĞ
ovf
 && 
	`is_aùive
(
cu¼’t
->
domaš
è&& !
x’_mode
 )

91 
	`£nd_gue¡_vıu_vœq
(
cu¼’t
, 
VIRQ_XENOPROF
);

93 iàĞ
ovf
 == 2 )

94 
	`‹¡_ªd_£t_boŞ
(
cu¼’t
->
nmi_³ndšg
);

96 
	}
}

99 
	$nmi_ıu_§ve_»gi¡”s
(
İ_m¤s
 *
m¤s
)

101 cÚ¡ 
Ä_ùrs
 = 
mod–
->
num_couÁ”s
;

102 cÚ¡ 
Ä_ù¾s
 = 
mod–
->
num_cÚŒŞs
;

103 
İ_m¤
 *
couÁ”s
 = 
m¤s
->counters;

104 
İ_m¤
 *
cÚŒŞs
 = 
m¤s
->controls;

105 
i
;

107 
i
 = 0; i < 
Ä_ùrs
; ++i) {

108 
	`rdm¤l
(
couÁ”s
[
i
].
addr
, couÁ”s[i].
v®ue
);

111 
i
 = 0; i < 
Ä_ù¾s
; ++i) {

112 
	`rdm¤l
(
cÚŒŞs
[
i
].
addr
, cÚŒŞs[i].
v®ue
);

114 
	}
}

117 
	$nmi_§ve_»gi¡”s
(* 
dummy
)

119 
ıu
 = 
	`smp_´oûssÜ_id
();

120 
İ_m¤s
 * 
m¤s
 = &
ıu_m¤s
[
ıu
];

121 
mod–
->
	`fl_š_add»s£s
(
m¤s
);

122 
	`nmi_ıu_§ve_»gi¡”s
(
m¤s
);

123 
	}
}

126 
	$ä“_m¤s
()

128 
i
;

129 
i
 = 0; i < 
NR_CPUS
; ++i) {

130 
	`xä“
(
ıu_m¤s
[
i
].
couÁ”s
);

131 
ıu_m¤s
[
i
].
couÁ”s
 = 
NULL
;

132 
	`xä“
(
ıu_m¤s
[
i
].
cÚŒŞs
);

133 
ıu_m¤s
[
i
].
cÚŒŞs
 = 
NULL
;

135 
	}
}

138 
	$®loÿ‹_m¤s
()

140 
sucûss
 = 1;

141 
size_t
 
cÚŒŞs_size
 = (
İ_m¤
è* 
mod–
->
num_cÚŒŞs
;

142 
size_t
 
couÁ”s_size
 = (
İ_m¤
è* 
mod–
->
num_couÁ”s
;

144 
i
;

145 
	`fÜ_—ch_Úlše_ıu
 (
i
) {

146 
ıu_m¤s
[
i
].
couÁ”s
 = 
	`xm®loc_by‹s
(
couÁ”s_size
);

147 ià(!
ıu_m¤s
[
i
].
couÁ”s
) {

148 
sucûss
 = 0;

151 
ıu_m¤s
[
i
].
cÚŒŞs
 = 
	`xm®loc_by‹s
(
cÚŒŞs_size
);

152 ià(!
ıu_m¤s
[
i
].
cÚŒŞs
) {

153 
sucûss
 = 0;

158 ià(!
sucûss
)

159 
	`ä“_m¤s
();

161  
sucûss
;

162 
	}
}

165 
	$nmi_ıu_£tup
(* 
dummy
)

167 
ıu
 = 
	`smp_´oûssÜ_id
();

168 
İ_m¤s
 * 
m¤s
 = &
ıu_m¤s
[
ıu
];

169 
mod–
->
	`£tup_ùrs
(
m¤s
);

170 
	}
}

173 
	$nmi_£tup_ev’ts
()

175 
	`Ú_—ch_ıu
(
nmi_ıu_£tup
, 
NULL
, 1);

177 
	}
}

179 
	$nmi_»£rve_couÁ”s
()

181 ià(!
	`®loÿ‹_m¤s
())

182  -
ENOMEM
;

189 ià(
	`»£rve_Ïpic_nmi
() < 0) {

190 
	`ä“_m¤s
();

191  -
EBUSY
;

196 
	`Ú_—ch_ıu
(
nmi_§ve_»gi¡”s
, 
NULL
, 1);

198 
	}
}

200 
	$nmi_’abË_vœq
()

202 
	`£t_nmi_ÿÎback
(
nmi_ÿÎback
);

204 
	}
}

207 
	$nmi_di§bË_vœq
()

209 
	`un£t_nmi_ÿÎback
();

210 
	}
}

213 
	$nmi_»¡Üe_»gi¡”s
(
İ_m¤s
 * 
m¤s
)

215 cÚ¡ 
Ä_ùrs
 = 
mod–
->
num_couÁ”s
;

216 cÚ¡ 
Ä_ù¾s
 = 
mod–
->
num_cÚŒŞs
;

217 
İ_m¤
 * 
couÁ”s
 = 
m¤s
->counters;

218 
İ_m¤
 * 
cÚŒŞs
 = 
m¤s
->controls;

219 
i
;

221 
i
 = 0; i < 
Ä_ù¾s
; ++i) {

222 
	`wrm¤l
(
cÚŒŞs
[
i
].
addr
, cÚŒŞs[i].
v®ue
);

225 
i
 = 0; i < 
Ä_ùrs
; ++i) {

226 
	`wrm¤l
(
couÁ”s
[
i
].
addr
, couÁ”s[i].
v®ue
);

228 
	}
}

231 
	$nmi_ıu_shutdown
(* 
dummy
)

233 
ıu
 = 
	`smp_´oûssÜ_id
();

234 
İ_m¤s
 * 
m¤s
 = &
ıu_m¤s
[
ıu
];

235 
	`nmi_»¡Üe_»gi¡”s
(
m¤s
);

236 
	}
}

239 
	$nmi_»Ëa£_couÁ”s
()

241 
	`Ú_—ch_ıu
(
nmi_ıu_shutdown
, 
NULL
, 1);

242 
	`»Ëa£_Ïpic_nmi
();

243 
	`ä“_m¤s
();

244 
	}
}

247 
	$nmi_ıu_¡¬t
(* 
dummy
)

249 
ıu
 = 
	`smp_´oûssÜ_id
();

250 
İ_m¤s
 cÚ¡ * 
m¤s
 = &
ıu_m¤s
[
ıu
];

251 
§ved_lvc
[
ıu
] = 
	`­ic_»ad
(
APIC_LVTPC
);

252 
	`­ic_wr™e
(
APIC_LVTPC
, 
APIC_DM_NMI
);

253 
mod–
->
	`¡¬t
(
m¤s
);

254 
	}
}

257 
	$nmi_¡¬t
()

259 
	`Ú_—ch_ıu
(
nmi_ıu_¡¬t
, 
NULL
, 1);

261 
	}
}

264 
	$nmi_ıu_¡İ
(* 
dummy
)

266 
v
;

267 
ıu
 = 
	`smp_´oûssÜ_id
();

268 
İ_m¤s
 cÚ¡ * 
m¤s
 = &
ıu_m¤s
[
ıu
];

269 
mod–
->
	`¡İ
(
m¤s
);

276 iàĞ!(
	`­ic_»ad
(
APIC_LVTPC
è& 
APIC_DM_NMI
)

277 || (
	`­ic_»ad
(
APIC_LVTPC
è& 
APIC_LVT_MASKED
) )

279 
	`´štk
("nmi_¡İ: APIC‚Ù good %ul\n", 
	`­ic_»ad
(
APIC_LVTPC
));

280 
	`md–ay
(5000);

282 
v
 = 
	`­ic_»ad
(
APIC_LVTERR
);

283 
	`­ic_wr™e
(
APIC_LVTERR
, 
v
 | 
APIC_LVT_MASKED
);

284 
	`­ic_wr™e
(
APIC_LVTPC
, 
§ved_lvc
[
ıu
]);

285 
	`­ic_wr™e
(
APIC_LVTERR
, 
v
);

286 
	}
}

289 
	$nmi_¡İ
()

291 
	`Ú_—ch_ıu
(
nmi_ıu_¡İ
, 
NULL
, 1);

292 
	}
}

295 
__š™
 
	$p4_š™
(** 
ıu_ty³
)

297 
__u8
 
ıu_mod–
 = 
cu¼’t_ıu_d©a
.
x86_mod–
;

299 ià((
ıu_mod–
 > 6) || (cpu_model == 5)) {

300 
	`´štk
("xenoprof: Initialization failed. "

302 "suµÜ‹d\n", 
ıu_mod–
);

306 #iâdeà
CONFIG_SMP


307 *
ıu_ty³
 = "i386/p4", 
XENOPROF_CPU_TYPE_SIZE
);

308 
mod–
 = &
İ_p4_¥ec
;

311 
cu¼’t_ıu_d©a
.
x86_num_siblšgs
) {

313 *
ıu_ty³
 = "i386/p4";

314 
mod–
 = &
İ_p4_¥ec
;

318 *
ıu_ty³
 = "i386/p4-ht";

319 
mod–
 = &
İ_p4_ht2_¥ec
;

323 
	`´štk
("Xenoprof ERROR: P4 HyperThreading detected with > 2hreads\n");

326 
	}
}

329 
	gfÜû_¬ch_³rfmÚ
;

330 
	$fÜû_ıu_ty³
(cÚ¡ *
¡r
)

332 ià(!
	`¡rcmp
(
¡r
, "arch_perfmon")) {

333 
fÜû_¬ch_³rfmÚ
 = 1;

334 
	`´štk
(
KERN_INFO
 "oprofile: forcing‡rchitectural…erfmon\n");

338 
	}
}

339 
cu¡om_·¿m
("ıu_ty³", 
fÜû_ıu_ty³
);

341 
µro_has_glob®_ù¾
;

342 
__š™
 
	$µro_š™
(** 
ıu_ty³
)

344 
__u8
 
ıu_mod–
 = 
cu¼’t_ıu_d©a
.
x86_mod–
;

346 ià(
fÜû_¬ch_³rfmÚ
 && 
ıu_has_¬ch_³rfmÚ
)

349 
ıu_mod–
) {

351 *
ıu_ty³
 = "i386/ppro";

354 *
ıu_ty³
 = "i386/pii";

358 *
ıu_ty³
 = "i386/piii";

362 *
ıu_ty³
 = "i386/p6_mobile";

365 *
ıu_ty³
 = "i386/core";

370 *
ıu_ty³
 = "i386/core_2";

371 
µro_has_glob®_ù¾
 = 1;

374 
	`¬ch_³rfmÚ_£tup_couÁ”s
();

375 *
ıu_ty³
 = "i386/core_i7";

376 
µro_has_glob®_ù¾
 = 1;

379 *
ıu_ty³
 = "i386/atom";

386 
mod–
 = &
İ_µro_¥ec
;

388 
	}
}

390 
__š™
 
	$¬ch_³rfmÚ_š™
(**
ıu_ty³
)

392 ià(!
ıu_has_¬ch_³rfmÚ
)

394 *
ıu_ty³
 = "i386/arch_perfmon";

395 
mod–
 = &
İ_¬ch_³rfmÚ_¥ec
;

396 
	`¬ch_³rfmÚ_£tup_couÁ”s
();

398 
	}
}

400 
__š™
 
	$nmi_š™
()

402 
__u8
 
v’dÜ
 = 
cu¼’t_ıu_d©a
.
x86_v’dÜ
;

403 
__u8
 
çmy
 = 
cu¼’t_ıu_d©a
.
x86
;

404 
__u8
 
_mod–
 = 
cu¼’t_ıu_d©a
.
x86_mod–
;

406 ià(!
ıu_has_­ic
) {

407 
	`´štk
("xenoprof: Initialization failed. No APIC\n");

408  -
ENODEV
;

411 
v’dÜ
) {

412 
X86_VENDOR_AMD
:

415 
çmy
) {

417 
	`´štk
("xenoprof: Initialization failed. "

419 "suµÜ‹d\n", 
çmy
);

420  -
ENODEV
;

422 
mod–
 = &
İ_©hlÚ_¥ec
;

423 
ıu_ty³
 = "i386/athlon";

426 
mod–
 = &
İ_©hlÚ_¥ec
;

429 
ıu_ty³
 = "x86-64/hammer";

432 
mod–
 = &
İ_©hlÚ_¥ec
;

433 
ıu_ty³
 = "x86-64/family10";

434 
	`ibs_š™
();

437 
mod–
 = &
İ_©hlÚ_¥ec
;

438 
ıu_ty³
 = "x86-64/family11";

441 
mod–
 = &
İ_©hlÚ_¥ec
;

442 
ıu_ty³
 = "x86-64/family12";

445 
mod–
 = &
İ_©hlÚ_¥ec
;

446 
ıu_ty³
 = "x86-64/family14";

449 
mod–
 = &
İ_©hlÚ_¥ec
;

450 
ıu_ty³
 = "x86-64/family15";

455 
X86_VENDOR_INTEL
:

456 
çmy
) {

459 
	`p4_š™
(&
ıu_ty³
);

464 
	`µro_š™
(&
ıu_ty³
);

470 ià(!
ıu_ty³
 && !
	`¬ch_³rfmÚ_š™
(&cpu_type)) {

471 
	`´štk
("xenoprof: Initialization failed. "

473 "i nÙ suµÜ‹d\n", 
çmy
, 
_mod–
);

474  -
ENODEV
;

479 
	`´štk
("xenoprof: Initialization failed. "

481 
v’dÜ
);

482  -
ENODEV
;

486 
	}
}

488 
__š™ÿÎ
(
nmi_š™
);

490 
	$x’İrof_¬ch_š™
(*
num_ev’ts
, *
_ıu_ty³
)

492 ià(
ıu_ty³
 =ğ
NULL
)

493  -
ENODEV
;

494 *
num_ev’ts
 = 
mod–
->
num_couÁ”s
;

495 
	`¡¾ıy
(
_ıu_ty³
, 
ıu_ty³
, 
XENOPROF_CPU_TYPE_SIZE
);

497 
	}
}

	@oprofile/op_counter.h

10 #iâdeà
OP_COUNTER_H


11 
	#OP_COUNTER_H


	)

13 
	#OP_MAX_COUNTER
 8

	)

18 
	sİ_couÁ”_cÚfig
 {

19 
	mcouÁ
;

20 
	m’abËd
;

21 
	mev’t
;

22 
	mk”Ãl
;

23 
	mu£r
;

24 
	mun™_mask
;

27 
İ_couÁ”_cÚfig
 
couÁ”_cÚfig
[];

30 
	sİ_ibs_cÚfig
 {

31 
	mİ_’abËd
;

32 
	mãtch_’abËd
;

33 
	mmax_út_ãtch
;

34 
	mmax_út_İ
;

35 
	m¿nd_’
;

36 
	mdi¥©ched_İs
;

39 
İ_ibs_cÚfig
 
ibs_cÚfig
;

	@oprofile/op_model_athlon.c

13 
	~<x’/ty³s.h
>

14 
	~<asm/m¤.h
>

15 
	~<asm/io.h
>

16 
	~<asm/­ic.h
>

17 
	~<asm/´oûssÜ.h
>

18 
	~<x’/sched.h
>

19 
	~<asm/»gs.h
>

20 
	~<asm/cu¼’t.h
>

21 
	~<asm/hvm/suµÜt.h
>

22 
	~<x’/pci_»gs.h
>

24 
	~"İ_x86_mod–.h
"

25 
	~"İ_couÁ”.h
"

27 
	#NUM_COUNTERS
 4

	)

28 
	#NUM_CONTROLS
 4

	)

30 
	#CTR_READ
(
m¤_cÚ‹Á
,
m¤s
,
c
èdØ{
	`rdm¤l
(m¤s->
couÁ”s
[(c)].
addr
, (m¤_cÚ‹Á));} 0)

	)

31 
	#CTR_WRITE
(
l
,
m¤s
,
c
èdØ{
	`wrm¤
(m¤s->
couÁ”s
[(c)].
addr
, -()Ö), -1);} 0)

	)

32 
	#CTR_OVERFLOWED
(
n
è(!(Òè& (1ULL<<31)))

	)

34 
	#CTRL_READ
(
m¤_cÚ‹Á
,
m¤s
,
c
èdØ{
	`rdm¤l
(m¤s->
cÚŒŞs
[(c)].
addr
, (m¤_cÚ‹Á));} 0)

	)

35 
	#CTRL_WRITE
(
m¤_cÚ‹Á
,
m¤s
,
c
èdØ{
	`wrm¤l
(m¤s->
cÚŒŞs
[(c)].
addr
, (m¤_cÚ‹Á));} 0)

	)

36 
	#CTRL_SET_ACTIVE
(
n
èÒ |ğ(1ULL<<22))

	)

37 
	#CTRL_SET_INACTIVE
(
n
èÒ &ğ~(1ULL<<22))

	)

38 
	#CTRL_CLEAR
(
v®
è(v® &ğ(1ULL<<21))

	)

39 
	#CTRL_SET_ENABLE
(
v®
è(v® |ğ1ULL<<20)

	)

40 
	#CTRL_SET_USR
(
v®
,
u
è(v® |ğ((u & 1è<< 16))

	)

41 
	#CTRL_SET_KERN
(
v®
,
k
è(v® |ğ((k & 1è<< 17))

	)

42 
	#CTRL_SET_UM
(
v®
, 
m
è(v® |ğ((m & 0xffè<< 8))

	)

43 
	#CTRL_SET_EVENT
(
v®
, 
e
è(v® |ğ((Ó >> 8è& 0xfè| (& 0xff)))

	)

44 
	#CTRL_SET_HOST_ONLY
(
v®
, 
h
è(v® |ğ((h & 0x1ULLè<< 41))

	)

45 
	#CTRL_SET_GUEST_ONLY
(
v®
, 
h
è(v® |ğ((h & 0x1ULLè<< 40))

	)

47 
	g»£t_v®ue
[
NUM_COUNTERS
];

49 
svm_¡gi_Ïb–
[];

51 #ifdeà
CONFIG_X86_64


52 
u32
 
	gibs_ÿps
 = 0;

53 
u64
 
	gibs_İ_ùl
;

55 
	#ibs_İ_ùl
 0

	)

59 
	#IBS_CPUID_FEATURES
 0x8000001b

	)

62 
	#MSR_AMD64_IBSFETCHCTL
 0xc0011030

	)

63 
	#MSR_AMD64_IBSFETCHLINAD
 0xc0011031

	)

64 
	#MSR_AMD64_IBSFETCHPHYSAD
 0xc0011032

	)

65 
	#MSR_AMD64_IBSOPCTL
 0xc0011033

	)

66 
	#MSR_AMD64_IBSOPRIP
 0xc0011034

	)

67 
	#MSR_AMD64_IBSOPDATA
 0xc0011035

	)

68 
	#MSR_AMD64_IBSOPDATA2
 0xc0011036

	)

69 
	#MSR_AMD64_IBSOPDATA3
 0xc0011037

	)

70 
	#MSR_AMD64_IBSDCLINAD
 0xc0011038

	)

71 
	#MSR_AMD64_IBSDCPHYSAD
 0xc0011039

	)

72 
	#MSR_AMD64_IBSCTL
 0xc001103a

	)

78 
	#IBS_CAPS_AVAIL
 (1LL<<0)

	)

79 
	#IBS_CAPS_RDWROPCNT
 (1LL<<3)

	)

80 
	#IBS_CAPS_OPCNT
 (1LL<<4)

	)

83 
	#IBS_RANDOM_BITS
 12

	)

84 
	#IBS_RANDOM_MASK
 ((1ULL << 
IBS_RANDOM_BITS
è- 1)

	)

85 
	#IBS_RANDOM_MAXCNT_OFFSET
 (1ULL << (
IBS_RANDOM_BITS
 - 5))

	)

88 
	#IBS_FETCH_RAND_EN
 (1ULL<<57)

	)

89 
	#IBS_FETCH_VAL
 (1ULL<<49)

	)

90 
	#IBS_FETCH_ENABLE
 (1ULL<<48)

	)

91 
	#IBS_FETCH_CNT
 0xFFFF0000ULL

	)

92 
	#IBS_FETCH_MAX_CNT
 0x0000FFFFULL

	)

95 
	#IBS_OP_CNT_CTL
 (1ULL<<19)

	)

96 
	#IBS_OP_VAL
 (1ULL<<18)

	)

97 
	#IBS_OP_ENABLE
 (1ULL<<17)

	)

98 
	#IBS_OP_MAX_CNT
 0x0000FFFFULL

	)

101 
	#IBS_FETCH_CODE
 13

	)

102 
	#IBS_OP_CODE
 14

	)

104 
	#şamp
(
v®
, 
mš
, 
max
) ({ \

105 
	`ty³of
(
v®
è
__v®
 = (val); \

106 
	`ty³of
(
mš
è
__mš
 = (min); \

107 
	`ty³of
(
max
è
__max
 = (max); \

108 (è(&
__v®
 =ğ&
__mš
); \

109 (è(&
__v®
 =ğ&
__max
); \

110 
__v®
 = __v® < 
__mš
 ? __min: __val; \

111 
__v®
 > 
__max
 ? __max: __v®; })

	)

116 
	$lf¤_¿ndom
()

118 
lf¤_v®ue
 = 0xF00D;

119 
b™
;

122 
b™
 = ((
lf¤_v®ue
 >> 0) ^

123 (
lf¤_v®ue
 >> 2) ^

124 (
lf¤_v®ue
 >> 3) ^

125 (
lf¤_v®ue
 >> 5)) & 0x0001;

128 
lf¤_v®ue
 = (lf¤_v®u>> 1è| (
b™
 << 15);

130  
lf¤_v®ue
;

131 
	}
}

140 
šlše
 
u64
 
	$İ_amd_¿ndomize_ibs_İ
(
u64
 
v®
)

142 
¿ndom
 = 
	`lf¤_¿ndom
();

144 ià(!(
ibs_ÿps
 & 
IBS_CAPS_RDWROPCNT
))

158 
v®
 +ğ(
s8
)(
¿ndom
 >> 4);

160 
v®
 |ğ(
u64
)(
¿ndom
 & 
IBS_RANDOM_MASK
) << 32;

162  
v®
;

163 
	}
}

165 
	$©hlÚ_fl_š_add»s£s
(
İ_m¤s
 * cÚ¡ 
m¤s
)

167 
m¤s
->
couÁ”s
[0].
addr
 = 
MSR_K7_PERFCTR0
;

168 
m¤s
->
couÁ”s
[1].
addr
 = 
MSR_K7_PERFCTR1
;

169 
m¤s
->
couÁ”s
[2].
addr
 = 
MSR_K7_PERFCTR2
;

170 
m¤s
->
couÁ”s
[3].
addr
 = 
MSR_K7_PERFCTR3
;

172 
m¤s
->
cÚŒŞs
[0].
addr
 = 
MSR_K7_EVNTSEL0
;

173 
m¤s
->
cÚŒŞs
[1].
addr
 = 
MSR_K7_EVNTSEL1
;

174 
m¤s
->
cÚŒŞs
[2].
addr
 = 
MSR_K7_EVNTSEL2
;

175 
m¤s
->
cÚŒŞs
[3].
addr
 = 
MSR_K7_EVNTSEL3
;

176 
	}
}

179 
	$©hlÚ_£tup_ùrs
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

181 
ušt64_t
 
m¤_cÚ‹Á
;

182 
i
;

185 
i
 = 0 ; i < 
NUM_CONTROLS
; ++i) {

186 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

187 
	`CTRL_CLEAR
(
m¤_cÚ‹Á
);

188 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

192 
i
 = 0; i < 
NUM_COUNTERS
; ++i) {

193 
	`CTR_WRITE
(1, 
m¤s
, 
i
);

197 
i
 = 0; i < 
NUM_COUNTERS
; ++i) {

198 ià(
couÁ”_cÚfig
[
i
].
’abËd
) {

199 
»£t_v®ue
[
i
] = 
couÁ”_cÚfig
[i].
couÁ
;

201 
	`CTR_WRITE
(
couÁ”_cÚfig
[
i
].
couÁ
, 
m¤s
, i);

203 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

204 
	`CTRL_CLEAR
(
m¤_cÚ‹Á
);

205 
	`CTRL_SET_ENABLE
(
m¤_cÚ‹Á
);

206 
	`CTRL_SET_USR
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
u£r
);

207 
	`CTRL_SET_KERN
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
k”Ãl
);

208 
	`CTRL_SET_UM
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
un™_mask
);

209 
	`CTRL_SET_EVENT
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
ev’t
);

210 
	`CTRL_SET_HOST_ONLY
(
m¤_cÚ‹Á
, 0);

211 
	`CTRL_SET_GUEST_ONLY
(
m¤_cÚ‹Á
, 0);

212 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

214 
»£t_v®ue
[
i
] = 0;

217 
	}
}

219 
šlše
 

220 
	$ibs_log_ev’t
(
u64
 
d©a
, 
ıu_u£r_»gs
 * cÚ¡ 
»gs
, 
mode
)

222 
vıu
 *
v
 = 
cu¼’t
;

223 
u32
 
‹mp
 = 0;

225 
‹mp
 = 
d©a
 & 0xFFFFFFFF;

226 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
‹mp
, 
mode
, 0);

228 
‹mp
 = (
d©a
 >> 32) & 0xFFFFFFFF;

229 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
‹mp
, 
mode
, 0);

231 
	}
}

233 
šlše
 
	$hªdË_ibs
(
mode
, 
ıu_u£r_»gs
 * cÚ¡ 
»gs
)

235 
u64
 
v®
, 
ùl
;

236 
vıu
 *
v
 = 
cu¼’t
;

238 ià(!
ibs_ÿps
)

241 ià(
ibs_cÚfig
.
ãtch_’abËd
) {

242 
	`rdm¤l
(
MSR_AMD64_IBSFETCHCTL
, 
ùl
);

243 ià(
ùl
 & 
IBS_FETCH_VAL
) {

244 
	`rdm¤l
(
MSR_AMD64_IBSFETCHLINAD
, 
v®
);

245 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
IBS_FETCH_CODE
, 
mode
, 0);

246 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
v®
, 
mode
, 0);

248 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

249 
	`ibs_log_ev’t
(
ùl
, 
»gs
, 
mode
);

251 
	`rdm¤l
(
MSR_AMD64_IBSFETCHPHYSAD
, 
v®
);

252 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

255 
ùl
 &ğ~(
IBS_FETCH_VAL
 | 
IBS_FETCH_CNT
);

256 
ùl
 |ğ
IBS_FETCH_ENABLE
;

257 
	`wrm¤l
(
MSR_AMD64_IBSFETCHCTL
, 
ùl
);

261 ià(
ibs_cÚfig
.
İ_’abËd
) {

262 
	`rdm¤l
(
MSR_AMD64_IBSOPCTL
, 
ùl
);

263 ià(
ùl
 & 
IBS_OP_VAL
) {

265 
	`rdm¤l
(
MSR_AMD64_IBSOPRIP
, 
v®
);

266 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
IBS_OP_CODE
, 
mode
, 0);

267 
	`x’İrof_log_ev’t
(
v
, 
»gs
, 
v®
, 
mode
, 0);

269 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

271 
	`rdm¤l
(
MSR_AMD64_IBSOPDATA
, 
v®
);

272 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

273 
	`rdm¤l
(
MSR_AMD64_IBSOPDATA2
, 
v®
);

274 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

275 
	`rdm¤l
(
MSR_AMD64_IBSOPDATA3
, 
v®
);

276 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

277 
	`rdm¤l
(
MSR_AMD64_IBSDCLINAD
, 
v®
);

278 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

279 
	`rdm¤l
(
MSR_AMD64_IBSDCPHYSAD
, 
v®
);

280 
	`ibs_log_ev’t
(
v®
, 
»gs
, 
mode
);

283 
ùl
 = 
	`İ_amd_¿ndomize_ibs_İ
(
ibs_İ_ùl
);

284 
	`wrm¤l
(
MSR_AMD64_IBSOPCTL
, 
ùl
);

289 
	}
}

291 
	$©hlÚ_check_ùrs
(cÚ¡ 
ıu
,

292 
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
,

293 
ıu_u£r_»gs
 * cÚ¡ 
»gs
)

296 
ušt64_t
 
m¤_cÚ‹Á
;

297 
i
;

298 
ovf
 = 0;

299 
e
 = 
»gs
->eip;

300 
mode
 = 0;

301 
vıu
 *
v
 = 
cu¼’t
;

302 
ıu_u£r_»gs
 *
gue¡_»gs
 = 
	`gue¡_ıu_u£r_»gs
();

304 ià(!
	`gue¡_mode
(
»gs
) &&

305 (
»gs
->
e
 =ğ()
svm_¡gi_Ïb–
)) {

307 
	`ASSERT
(
	`is_hvm_vıu
(
v
));

308 
e
 = 
gue¡_»gs
->eip;

309 
mode
 = 
	`x’İrofe_g‘_mode
(
v
, 
gue¡_»gs
);

311 
e
 = 
»gs
->eip;

312 
mode
 = 
	`x’İrofe_g‘_mode
(
v
, 
»gs
);

315 
i
 = 0 ; i < 
NUM_COUNTERS
; ++i) {

316 
	`CTR_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

317 ià(
	`CTR_OVERFLOWED
(
m¤_cÚ‹Á
)) {

318 
	`x’İrof_log_ev’t
(
cu¼’t
, 
»gs
, 
e
, 
mode
, 
i
);

319 
	`CTR_WRITE
(
»£t_v®ue
[
i
], 
m¤s
, i);

320 
ovf
 = 1;

324 
ovf
 = 
	`hªdË_ibs
(
mode
, 
»gs
);

326  
ovf
;

327 
	}
}

329 
šlše
 
	$¡¬t_ibs
()

331 #ifdeà
CONFIG_X86_64


332 
u64
 
v®
 = 0;

334 ià(!
ibs_ÿps
)

337 ià(
ibs_cÚfig
.
ãtch_’abËd
) {

338 
v®
 = (
ibs_cÚfig
.
max_út_ãtch
 >> 4è& 
IBS_FETCH_MAX_CNT
;

339 
v®
 |ğ
ibs_cÚfig
.
¿nd_’
 ? 
IBS_FETCH_RAND_EN
 : 0;

340 
v®
 |ğ
IBS_FETCH_ENABLE
;

341 
	`wrm¤l
(
MSR_AMD64_IBSFETCHCTL
, 
v®
);

344 ià(
ibs_cÚfig
.
İ_’abËd
) {

345 
ibs_İ_ùl
 = 
ibs_cÚfig
.
max_út_İ
 >> 4;

346 ià(!(
ibs_ÿps
 & 
IBS_CAPS_RDWROPCNT
)) {

351 
ibs_İ_ùl
 = 
	`şamp
(()ibs_op_ctl,

360 
ibs_İ_ùl
 = 
	`mš
(ibs_İ_ùÈ+ 
IBS_RANDOM_MAXCNT_OFFSET
,

361 
IBS_OP_MAX_CNT
);

363 ià(
ibs_ÿps
 & 
IBS_CAPS_OPCNT
 && 
ibs_cÚfig
.
di¥©ched_İs
)

364 
ibs_İ_ùl
 |ğ
IBS_OP_CNT_CTL
;

365 
ibs_İ_ùl
 |ğ
IBS_OP_ENABLE
;

366 
v®
 = 
	`İ_amd_¿ndomize_ibs_İ
(
ibs_İ_ùl
);

367 
	`wrm¤l
(
MSR_AMD64_IBSOPCTL
, 
v®
);

370 
	}
}

372 
	$©hlÚ_¡¬t
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

374 
ušt64_t
 
m¤_cÚ‹Á
;

375 
i
;

376 
i
 = 0 ; i < 
NUM_COUNTERS
 ; ++i) {

377 ià(
»£t_v®ue
[
i
]) {

378 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

379 
	`CTRL_SET_ACTIVE
(
m¤_cÚ‹Á
);

380 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

383 
	`¡¬t_ibs
();

384 
	}
}

386 
	$¡İ_ibs
()

388 ià(!
ibs_ÿps
)

391 ià(
ibs_cÚfig
.
ãtch_’abËd
)

393 
	`wrm¤l
(
MSR_AMD64_IBSFETCHCTL
, 0);

395 ià(
ibs_cÚfig
.
İ_’abËd
)

397 
	`wrm¤l
(
MSR_AMD64_IBSOPCTL
, 0);

398 
	}
}

400 
	$©hlÚ_¡İ
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

402 
ušt64_t
 
m¤_cÚ‹Á
;

403 
i
;

407 
i
 = 0 ; i < 
NUM_COUNTERS
 ; ++i) {

408 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

409 
	`CTRL_SET_INACTIVE
(
m¤_cÚ‹Á
);

410 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

413 
	`¡İ_ibs
();

414 
	}
}

416 #ifdeà
CONFIG_X86_64


418 
	#IBSCTL_LVTOFFSETVAL
 (1 << 8)

	)

419 
	#APIC_EILVT_MSG_NMI
 0x4

	)

420 
	#APIC_EILVT_LVTOFF_IBS
 1

	)

421 
	#APIC_EILVTn
(
n
è(0x500 + 0x10 *‚)

	)

422 
šlše
 
__š™
 
	$š™_ibs_nmi_³r_ıu
(*
¬g
)

424 
»g
;

426 
»g
 = (
APIC_EILVT_LVTOFF_IBS
 << 4è+ 
	`APIC_EILVTn
(0);

427 
	`­ic_wr™e
(
»g
, 
APIC_EILVT_MSG_NMI
 << 8);

428 
	}
}

430 
	#PCI_VENDOR_ID_AMD
 0x1022

	)

431 
	#PCI_DEVICE_ID_AMD_10H_NB_MISC
 0x1203

	)

432 
	#IBSCTL
 0x1cc

	)

433 
__š™
 
	$š™_ibs_nmi
()

435 
bus
, 
dev
, 
func
;

436 
u32
 
id
, 
v®ue
;

437 
u16
 
v’dÜ_id
, 
dev_id
;

438 
nodes
;

441 
	`Ú_—ch_ıu
(
š™_ibs_nmi_³r_ıu
, 
NULL
, 1);

443 
nodes
 = 0;

444 
bus
 = 0; bus < 256; bus++) {

445 
dev
 = 0; dev < 32; dev++) {

446 
func
 = 0; func < 8; func++) {

447 
id
 = 
	`pci_cÚf_»ad32
(
bus
, 
dev
, 
func
, 
PCI_VENDOR_ID
);

449 
v’dÜ_id
 = 
id
 & 0xffff;

450 
dev_id
 = (
id
 >> 16) & 0xffff;

452 ià((
v’dÜ_id
 =ğ
PCI_VENDOR_ID_AMD
) &&

453 (
dev_id
 =ğ
PCI_DEVICE_ID_AMD_10H_NB_MISC
)) {

455 
	`pci_cÚf_wr™e32
(
bus
, 
dev
, 
func
, 
IBSCTL
,

456 
IBSCTL_LVTOFFSETVAL
 | 
APIC_EILVT_LVTOFF_IBS
);

458 
v®ue
 = 
	`pci_cÚf_»ad32
(
bus
, 
dev
, 
func
, 
IBSCTL
);

460 ià(
v®ue
 !ğ(
IBSCTL_LVTOFFSETVAL
 |

461 
APIC_EILVT_LVTOFF_IBS
)) {

462 
	`´štk
("Xenoprofile: Failedo setup IBS LVT offset, "

463 "IBSCTL = %#08x\n", 
v®ue
);

466 
nodes
++;

472 ià(!
nodes
) {

473 
	`´štk
("Xenoprofile: No CPU‚ode configured for IBS\n");

478 
	}
}

480 
__š™
 
	$g‘_ibs_ÿps
()

482 
max_Ëv–
;

484 ià(!
	`boÙ_ıu_has
(
X86_FEATURE_IBS
))

488 
max_Ëv–
 = 
	`ıuid_—x
(0x80000000);

489 ià(
max_Ëv–
 >ğ
IBS_CPUID_FEATURES
)

490 
ibs_ÿps
 = 
	`ıuid_—x
(
IBS_CPUID_FEATURES
);

491 ià(!(
ibs_ÿps
 & 
IBS_CAPS_AVAIL
))

493 
ibs_ÿps
 = 0;

494 
	}
}

496 
__š™
 
	$ibs_š™
()

498 
	`g‘_ibs_ÿps
();

500 iàĞ!
ibs_ÿps
 )

503 ià(
	`š™_ibs_nmi
()) {

504 
ibs_ÿps
 = 0;

508 
	`´štk
("Xenoprofile: AMD IBS detected (0x%08x)\n",

509 ()
ibs_ÿps
);

510 
	}
}

514 
İ_x86_mod–_¥ec
 cÚ¡ 
	gİ_©hlÚ_¥ec
 = {

515 .
num_couÁ”s
 = 
NUM_COUNTERS
,

516 .
	gnum_cÚŒŞs
 = 
NUM_CONTROLS
,

517 .
	gfl_š_add»s£s
 = &
©hlÚ_fl_š_add»s£s
,

518 .
	g£tup_ùrs
 = &
©hlÚ_£tup_ùrs
,

519 .
	gcheck_ùrs
 = &
©hlÚ_check_ùrs
,

520 .
	g¡¬t
 = &
©hlÚ_¡¬t
,

521 .
	g¡İ
 = &
©hlÚ_¡İ


	@oprofile/op_model_p4.c

11 
	~<x’/ty³s.h
>

12 
	~<asm/m¤.h
>

13 
	~<asm/io.h
>

14 
	~<asm/­ic.h
>

15 
	~<asm/´oûssÜ.h
>

16 
	~<x’/sched.h
>

17 
	~<asm/»gs.h
>

18 
	~<asm/cu¼’t.h
>

20 
	~"İ_x86_mod–.h
"

21 
	~"İ_couÁ”.h
"

23 
	#NUM_EVENTS
 39

	)

25 
	#NUM_COUNTERS_NON_HT
 8

	)

26 
	#NUM_ESCRS_NON_HT
 45

	)

27 
	#NUM_CCCRS_NON_HT
 18

	)

28 
	#NUM_CONTROLS_NON_HT
 (
NUM_ESCRS_NON_HT
 + 
NUM_CCCRS_NON_HT
)

	)

30 
	#NUM_COUNTERS_HT2
 4

	)

31 
	#NUM_ESCRS_HT2
 23

	)

32 
	#NUM_CCCRS_HT2
 9

	)

33 
	#NUM_CONTROLS_HT2
 (
NUM_ESCRS_HT2
 + 
NUM_CCCRS_HT2
)

	)

35 
	gnum_couÁ”s
 = 
NUM_COUNTERS_NON_HT
;

41 
šlše
 
	$£tup_num_couÁ”s
()

43 #ifdeà
CONFIG_SMP


44 ià(
boÙ_ıu_d©a
.
x86_num_siblšgs
 == 2)

45 
num_couÁ”s
 = 
NUM_COUNTERS_HT2
;

47 
	}
}

49 
šlše
 
	$addr_šüem’t
()

51 #ifdeà
CONFIG_SMP


52  
boÙ_ıu_d©a
.
x86_num_siblšgs
 == 2 ? 2 : 1;

56 
	}
}

60 
	sp4_couÁ”_bšdšg
 {

61 
	mvœt_couÁ”
;

62 
	mcouÁ”_add»ss
;

63 
	mccü_add»ss
;

66 
	sp4_ev’t_bšdšg
 {

67 
	mesü_£Ëù
;

68 
	mev’t_£Ëù
;

70 
	mvœt_couÁ”
;

71 
	mesü_add»ss
;

72 } 
	mbšdšgs
[2];

79 
	#CTR_BPU_0
 (1 << 0)

	)

80 
	#CTR_MS_0
 (1 << 1)

	)

81 
	#CTR_FLAME_0
 (1 << 2)

	)

82 
	#CTR_IQ_4
 (1 << 3)

	)

83 
	#CTR_BPU_2
 (1 << 4)

	)

84 
	#CTR_MS_2
 (1 << 5)

	)

85 
	#CTR_FLAME_2
 (1 << 6)

	)

86 
	#CTR_IQ_5
 (1 << 7)

	)

88 
p4_couÁ”_bšdšg
 
	gp4_couÁ”s
 [
NUM_COUNTERS_NON_HT
] = {

89 { 
CTR_BPU_0
, 
MSR_P4_BPU_PERFCTR0
, 
MSR_P4_BPU_CCCR0
 },

90 { 
CTR_MS_0
, 
MSR_P4_MS_PERFCTR0
, 
MSR_P4_MS_CCCR0
 },

91 { 
CTR_FLAME_0
, 
MSR_P4_FLAME_PERFCTR0
, 
MSR_P4_FLAME_CCCR0
 },

92 { 
CTR_IQ_4
, 
MSR_P4_IQ_PERFCTR4
, 
MSR_P4_IQ_CCCR4
 },

93 { 
CTR_BPU_2
, 
MSR_P4_BPU_PERFCTR2
, 
MSR_P4_BPU_CCCR2
 },

94 { 
CTR_MS_2
, 
MSR_P4_MS_PERFCTR2
, 
MSR_P4_MS_CCCR2
 },

95 { 
CTR_FLAME_2
, 
MSR_P4_FLAME_PERFCTR2
, 
MSR_P4_FLAME_CCCR2
 },

96 { 
CTR_IQ_5
, 
MSR_P4_IQ_PERFCTR5
, 
MSR_P4_IQ_CCCR5
 }

99 
	#NUM_UNUSED_CCCRS
 
NUM_CCCRS_NON_HT
 - 
NUM_COUNTERS_NON_HT


	)

102 
	gp4_unu£d_ccü
[
NUM_UNUSED_CCCRS
] = {

103 
MSR_P4_BPU_CCCR1
, 
MSR_P4_BPU_CCCR3
,

104 
MSR_P4_MS_CCCR1
, 
MSR_P4_MS_CCCR3
,

105 
MSR_P4_FLAME_CCCR1
, 
MSR_P4_FLAME_CCCR3
,

106 
MSR_P4_IQ_CCCR0
, 
MSR_P4_IQ_CCCR1
,

107 
MSR_P4_IQ_CCCR2
, 
MSR_P4_IQ_CCCR3


112 cÚ¡ 
p4_ev’t_bšdšg
 
	gp4_ev’ts
[
NUM_EVENTS
] = {

116 { {
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

117 {
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

122 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR0
},

123 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR1
} }

128 { { 
CTR_MS_0
, 
MSR_P4_TC_ESCR0
},

129 { 
CTR_MS_2
, 
MSR_P4_TC_ESCR1
} }

134 { { 
CTR_BPU_0
, 
MSR_P4_BPU_ESCR0
},

135 { 
CTR_BPU_2
, 
MSR_P4_BPU_ESCR1
} }

140 { { 
CTR_BPU_0
, 
MSR_P4_ITLB_ESCR0
},

141 { 
CTR_BPU_2
, 
MSR_P4_ITLB_ESCR1
} }

146 { { 
CTR_FLAME_0
, 
MSR_P4_DAC_ESCR0
},

147 { 
CTR_FLAME_2
, 
MSR_P4_DAC_ESCR1
} }

152 { { 
CTR_FLAME_0
, 
MSR_P4_SAAT_ESCR0
},

153 { 
CTR_FLAME_2
, 
MSR_P4_SAAT_ESCR1
} }

158 { { 
CTR_FLAME_0
, 
MSR_P4_SAAT_ESCR0
},

159 { 
CTR_FLAME_2
, 
MSR_P4_SAAT_ESCR1
} }

164 { { 
CTR_FLAME_0
, 
MSR_P4_SAAT_ESCR0
},

165 { 
CTR_FLAME_2
, 
MSR_P4_SAAT_ESCR1
} }

170 { { 
CTR_BPU_0
, 
MSR_P4_MOB_ESCR0
},

171 { 
CTR_BPU_2
, 
MSR_P4_MOB_ESCR1
} }

176 { { 
CTR_BPU_0
, 
MSR_P4_PMH_ESCR0
},

177 { 
CTR_BPU_2
, 
MSR_P4_PMH_ESCR1
} }

182 { { 
CTR_BPU_0
, 
MSR_P4_BSU_ESCR0
},

183 { 
CTR_BPU_2
, 
MSR_P4_BSU_ESCR1
} }

188 { { 
CTR_BPU_0
, 
MSR_P4_FSB_ESCR0
},

194 { { 
CTR_BPU_2
, 
MSR_P4_FSB_ESCR1
},

200 { { 
CTR_BPU_0
, 
MSR_P4_FSB_ESCR0
},

201 { 
CTR_BPU_2
, 
MSR_P4_FSB_ESCR1
} }

206 { { 
CTR_BPU_0
, 
MSR_P4_BSU_ESCR0
},

212 { { 
CTR_BPU_2
, 
MSR_P4_BSU_ESCR1
 },

218 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

219 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

224 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

225 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

230 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

231 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

236 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

237 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

242 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

243 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

248 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

249 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

254 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

255 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

260 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

261 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

266 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

267 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

272 { { 
CTR_FLAME_0
, 
MSR_P4_FIRM_ESCR0
},

273 { 
CTR_FLAME_2
, 
MSR_P4_FIRM_ESCR1
} }

278 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

279 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

284 { { 
CTR_BPU_0
, 
MSR_P4_FSB_ESCR0
},

285 { 
CTR_BPU_2
, 
MSR_P4_FSB_ESCR1
} }

290 { { 
CTR_MS_0
, 
MSR_P4_MS_ESCR0
},

291 { 
CTR_MS_2
, 
MSR_P4_MS_ESCR1
} }

296 { { 
CTR_MS_0
, 
MSR_P4_MS_ESCR0
},

297 { 
CTR_MS_2
, 
MSR_P4_MS_ESCR1
} }

302 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

303 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

308 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

309 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

314 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR2
},

315 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR3
} }

320 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR0
},

321 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR1
} }

326 { { 
CTR_IQ_4
, 
MSR_P4_CRU_ESCR0
},

327 { 
CTR_IQ_5
, 
MSR_P4_CRU_ESCR1
} }

332 { { 
CTR_IQ_4
, 
MSR_P4_RAT_ESCR0
},

333 { 
CTR_IQ_5
, 
MSR_P4_RAT_ESCR1
} }

338 { { 
CTR_MS_0
, 
MSR_P4_TBPU_ESCR0
},

339 { 
CTR_MS_2
, 
MSR_P4_TBPU_ESCR1
} }

344 { { 
CTR_MS_0
, 
MSR_P4_TBPU_ESCR0
},

345 { 
CTR_MS_2
, 
MSR_P4_TBPU_ESCR1
} }

350 
	#MISC_PMC_ENABLED_P
(
x
è((xè& 1ULL << 7)

	)

352 
	#ESCR_RESERVED_BITS
 0x80000003ULL

	)

353 
	#ESCR_CLEAR
(
esü
è(Ósüè&ğ
ESCR_RESERVED_BITS
)

	)

354 
	#ESCR_SET_USR_0
(
esü
, 
u¤
è(Ósüè|ğ(((u¤è& 1ULLè<< 2))

	)

355 
	#ESCR_SET_OS_0
(
esü
, 
os
è(Ósüè|ğ(((osè& 1ULLè<< 3))

	)

356 
	#ESCR_SET_USR_1
(
esü
, 
u¤
è(Ósüè|ğ(((u¤è& 1ULL)))

	)

357 
	#ESCR_SET_OS_1
(
esü
, 
os
è(Ósüè|ğ(((osè& 1ULLè<< 1))

	)

358 
	#ESCR_SET_EVENT_SELECT
(
esü
, 
£l
è(Ósüè|ğ(((£lè& 0x3fULLè<< 25))

	)

359 
	#ESCR_SET_EVENT_MASK
(
esü
, 
mask
è(Ósüè|ğ(((maskè& 0xffffULLè<< 9))

	)

360 
	#ESCR_READ
(
esü
,
ev
,
i
èdØ{
	`rdm¤l
Óv->
bšdšgs
[(i)].
esü_add»ss
, (esü));} 0)

	)

361 
	#ESCR_WRITE
(
esü
,
ev
,
i
èdØ{
	`wrm¤l
Óv->
bšdšgs
[(i)].
esü_add»ss
, (esü));} 0)

	)

363 
	#CCCR_RESERVED_BITS
 0x38030FFFULL

	)

364 
	#CCCR_CLEAR
(
ccü
è((ccüè&ğ
CCCR_RESERVED_BITS
)

	)

365 
	#CCCR_SET_REQUIRED_BITS
(
ccü
è((ccüè|ğ0x00030000ULL)

	)

366 
	#CCCR_SET_ESCR_SELECT
(
ccü
, 
£l
è((ccüè|ğ(((£lè& 0x07ULLè<< 13))

	)

367 
	#CCCR_SET_PMI_OVF_0
(
ccü
è((ccüè|ğ(1ULL<<26))

	)

368 
	#CCCR_SET_PMI_OVF_1
(
ccü
è((ccüè|ğ(1ULL<<27))

	)

369 
	#CCCR_SET_ENABLE
(
ccü
è((ccüè|ğ(1ULL<<12))

	)

370 
	#CCCR_SET_DISABLE
(
ccü
è((ccüè&ğ~(1ULL<<12))

	)

371 
	#CCCR_READ
(
m¤_cÚ‹Á
, 
i
èdØ{
	`rdm¤l
(
p4_couÁ”s
[(i)].
ccü_add»ss
, (m¤_cÚ‹Á));} 0)

	)

372 
	#CCCR_WRITE
(
m¤_cÚ‹Á
, 
i
èdØ{
	`wrm¤l
(
p4_couÁ”s
[(i)].
ccü_add»ss
, (m¤_cÚ‹Á));} 0)

	)

373 
	#CCCR_OVF_P
(
ccü
è((ccüè& (1ULL<<31))

	)

374 
	#CCCR_CLEAR_OVF
(
ccü
è((ccüè&ğ(~(1ULL<<31)))

	)

376 
	#CTR_READ
(
m¤_cÚ‹Á
,
i
èdØ{
	`rdm¤l
(
p4_couÁ”s
[(i)].
couÁ”_add»ss
, (m¤_cÚ‹Á));} 0)

	)

377 
	#CTR_WRITE
(
m¤_cÚ‹Á
,
i
èdØ{
	`wrm¤l
(
p4_couÁ”s
[(i)].
couÁ”_add»ss
, -(m¤_cÚ‹Á));} 0)

	)

378 
	#CTR_OVERFLOW_P
(
ùr
è(!((ùrè& 0x80000000ULL))

	)

384 
	$g‘_¡agg”
()

386 #ifdeà
CONFIG_SMP


387 
ıu
 = 
	`smp_´oûssÜ_id
();

388  (
ıu
 !ğ
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_siblšg_m­
, cpu)));

391 
	}
}

397 
	#VIRT_CTR
(
¡agg”
, 
i
è((iè+ ((
num_couÁ”s
è* (¡agg”)))

	)

399 
	g»£t_v®ue
[
NUM_COUNTERS_NON_HT
];

402 
	$p4_fl_š_add»s£s
(
İ_m¤s
 * cÚ¡ 
m¤s
)

404 
i
;

405 
addr
, 
¡ag
;

407 
	`£tup_num_couÁ”s
();

408 
¡ag
 = 
	`g‘_¡agg”
();

411 
i
 = 0; i < 
num_couÁ”s
; ++i) {

412 
m¤s
->
couÁ”s
[
i
].
addr
 =

413 
p4_couÁ”s
[
	`VIRT_CTR
(
¡ag
, 
i
)].
couÁ”_add»ss
;

419 
i
 = 0, 
addr
 = 
MSR_P4_BPU_CCCR0
 + 
¡ag
;

420 
addr
 <ğ
MSR_P4_IQ_CCCR5
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

421 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

425 
addr
 = 
MSR_P4_BSU_ESCR0
 + 
¡ag
;

426 
addr
 < 
MSR_P4_IQ_ESCR0
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

427 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

432 ià(
boÙ_ıu_d©a
.
x86_mod–
 >= 0x3) {

433 
addr
 = 
MSR_P4_BSU_ESCR0
 + 
¡ag
;

434 
addr
 <ğ
MSR_P4_BSU_ESCR1
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

435 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

438 
addr
 = 
MSR_P4_IQ_ESCR0
 + 
¡ag
;

439 
addr
 <ğ
MSR_P4_IQ_ESCR1
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

440 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

444 
addr
 = 
MSR_P4_RAT_ESCR0
 + 
¡ag
;

445 
addr
 <ğ
MSR_P4_SSU_ESCR0
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

446 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

449 
addr
 = 
MSR_P4_MS_ESCR0
 + 
¡ag
;

450 
addr
 <ğ
MSR_P4_TC_ESCR1
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

451 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

454 
addr
 = 
MSR_P4_IX_ESCR0
 + 
¡ag
;

455 
addr
 <ğ
MSR_P4_CRU_ESCR3
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

456 
m¤s
->
cÚŒŞs
[
i
].
addr
 =‡ddr;

461 ià(
num_couÁ”s
 =ğ
NUM_COUNTERS_NON_HT
) {

463 
m¤s
->
cÚŒŞs
[
i
++].
addr
 = 
MSR_P4_CRU_ESCR5
;

464 
m¤s
->
cÚŒŞs
[
i
++].
addr
 = 
MSR_P4_CRU_ESCR4
;

466 } ià(
¡ag
 == 0) {

469 
m¤s
->
cÚŒŞs
[
i
++].
addr
 = 
MSR_P4_CRU_ESCR4
;

474 
m¤s
->
cÚŒŞs
[
i
++].
addr
 = 
MSR_P4_CRU_ESCR5
;

475 
m¤s
->
cÚŒŞs
[
i
++].
addr
 = 
MSR_P4_CRU_ESCR5
;

477 
	}
}

480 
	$pmc_£tup_Úe_p4_couÁ”
(
ùr
)

482 
i
;

483 cÚ¡ 
maxbšd
 = 2;

484 
ušt64_t
 
ccü
 = 0;

485 
ušt64_t
 
esü
 = 0;

486 
couÁ”_b™
;

487 cÚ¡ 
p4_ev’t_bšdšg
 *
ev
 = 
NULL
;

488 
¡ag
;

490 
¡ag
 = 
	`g‘_¡agg”
();

493 
couÁ”_b™
 = 1 << 
	`VIRT_CTR
(
¡ag
, 
ùr
);

496 ià(
couÁ”_cÚfig
[
ùr
].
ev’t
 <ğ0 || couÁ”_cÚfig[ùr].ev’ˆ> 
NUM_EVENTS
) {

497 
	`´štk
(
KERN_ERR


499 
couÁ”_cÚfig
[
ùr
].
ev’t
);

503 
ev
 = &(
p4_ev’ts
[
couÁ”_cÚfig
[
ùr
].
ev’t
 - 1]);

505 
i
 = 0; i < 
maxbšd
; i++) {

506 ià(
ev
->
bšdšgs
[
i
].
vœt_couÁ”
 & 
couÁ”_b™
) {

509 
	`ESCR_READ
(
esü
, 
ev
, 
i
);

510 
	`ESCR_CLEAR
(
esü
);

511 ià(
¡ag
 == 0) {

512 
	`ESCR_SET_USR_0
(
esü
, 
couÁ”_cÚfig
[
ùr
].
u£r
);

513 
	`ESCR_SET_OS_0
(
esü
, 
couÁ”_cÚfig
[
ùr
].
k”Ãl
);

515 
	`ESCR_SET_USR_1
(
esü
, 
couÁ”_cÚfig
[
ùr
].
u£r
);

516 
	`ESCR_SET_OS_1
(
esü
, 
couÁ”_cÚfig
[
ùr
].
k”Ãl
);

518 
	`ESCR_SET_EVENT_SELECT
(
esü
, 
ev
->
ev’t_£Ëù
);

519 
	`ESCR_SET_EVENT_MASK
(
esü
, 
couÁ”_cÚfig
[
ùr
].
un™_mask
);

520 
	`ESCR_WRITE
(
esü
, 
ev
, 
i
);

523 
	`CCCR_READ
(
ccü
, 
	`VIRT_CTR
(
¡ag
, 
ùr
));

524 
	`CCCR_CLEAR
(
ccü
);

525 
	`CCCR_SET_REQUIRED_BITS
(
ccü
);

526 
	`CCCR_SET_ESCR_SELECT
(
ccü
, 
ev
->
esü_£Ëù
);

527 ià(
¡ag
 == 0) {

528 
	`CCCR_SET_PMI_OVF_0
(
ccü
);

530 
	`CCCR_SET_PMI_OVF_1
(
ccü
);

532 
	`CCCR_WRITE
(
ccü
, 
	`VIRT_CTR
(
¡ag
, 
ùr
));

537 
	`´štk
(
KERN_ERR


539 
couÁ”_cÚfig
[
ùr
].
ev’t
, 
¡ag
, ctr);

540 
	}
}

543 
	$p4_£tup_ùrs
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

545 
i
;

546 
ušt64_t
 
m¤_cÚ‹Á
;

547 
addr
;

548 
¡ag
;

550 
¡ag
 = 
	`g‘_¡agg”
();

552 
	`rdm¤l
(
MSR_IA32_MISC_ENABLE
, 
m¤_cÚ‹Á
);

553 ià(! 
	`MISC_PMC_ENABLED_P
(
m¤_cÚ‹Á
)) {

554 
	`´štk
(
KERN_ERR
 "oprofile: P4 PMC‚ot‡vailable\n");

559 
i
 = 0 ; i < 
num_couÁ”s
 ; i++) {

560 
	`rdm¤l
(
p4_couÁ”s
[
	`VIRT_CTR
(
¡ag
, 
i
)].
ccü_add»ss
, 
m¤_cÚ‹Á
);

561 
	`CCCR_CLEAR
(
m¤_cÚ‹Á
);

562 
	`CCCR_SET_REQUIRED_BITS
(
m¤_cÚ‹Á
);

563 
	`wrm¤l
(
p4_couÁ”s
[
	`VIRT_CTR
(
¡ag
, 
i
)].
ccü_add»ss
, 
m¤_cÚ‹Á
);

567 
i
 = 
¡ag
 ; i < 
NUM_UNUSED_CCCRS
 ; i +ğ
	`addr_šüem’t
()) {

568 
	`rdm¤l
(
p4_unu£d_ccü
[
i
], 
m¤_cÚ‹Á
);

569 
	`CCCR_CLEAR
(
m¤_cÚ‹Á
);

570 
	`CCCR_SET_REQUIRED_BITS
(
m¤_cÚ‹Á
);

571 
	`wrm¤l
(
p4_unu£d_ccü
[
i
], 
m¤_cÚ‹Á
);

575 
addr
 = 
MSR_P4_BSU_ESCR0
 + 
¡ag
;

576 
addr
 < 
MSR_P4_IQ_ESCR0
;‡dd¸+ğ
	`addr_šüem’t
()) {

577 
	`wrm¤l
(
addr
, 0x0ULL);

581 ià(
boÙ_ıu_d©a
.
x86_mod–
 < 0x3) {

582 
	`wrm¤l
(
MSR_P4_IQ_ESCR0
, 0x0ULL);

583 
	`wrm¤l
(
MSR_P4_IQ_ESCR1
, 0x0ULL);

586 
addr
 = 
MSR_P4_RAT_ESCR0
 + 
¡ag
;

587 
addr
 <ğ
MSR_P4_SSU_ESCR0
; ++
i
,‡dd¸+ğ
	`addr_šüem’t
()) {

588 
	`wrm¤l
(
addr
, 0x0ULL);

591 
addr
 = 
MSR_P4_MS_ESCR0
 + 
¡ag
;

592 
addr
 <ğ
MSR_P4_TC_ESCR1
;‡dd¸+ğ
	`addr_šüem’t
()){

593 
	`wrm¤l
(
addr
, 0x0ULL);

596 
addr
 = 
MSR_P4_IX_ESCR0
 + 
¡ag
;

597 
addr
 <ğ
MSR_P4_CRU_ESCR3
;‡dd¸+ğ
	`addr_šüem’t
()){

598 
	`wrm¤l
(
addr
, 0x0ULL);

601 ià(
num_couÁ”s
 =ğ
NUM_COUNTERS_NON_HT
) {

602 
	`wrm¤l
(
MSR_P4_CRU_ESCR4
, 0x0ULL);

603 
	`wrm¤l
(
MSR_P4_CRU_ESCR5
, 0x0ULL);

604 } ià(
¡ag
 == 0) {

605 
	`wrm¤l
(
MSR_P4_CRU_ESCR4
, 0x0ULL);

607 
	`wrm¤l
(
MSR_P4_CRU_ESCR5
, 0x0ULL);

611 
i
 = 0 ; i < 
num_couÁ”s
 ; ++i) {

612 ià(
couÁ”_cÚfig
[
i
].
’abËd
) {

613 
»£t_v®ue
[
i
] = 
couÁ”_cÚfig
[i].
couÁ
;

614 
	`pmc_£tup_Úe_p4_couÁ”
(
i
);

615 
	`CTR_WRITE
(
couÁ”_cÚfig
[
i
].
couÁ
, 
	`VIRT_CTR
(
¡ag
, i));

617 
»£t_v®ue
[
i
] = 0;

620 
	}
}

622 
	$p4_check_ùrs
(cÚ¡ 
ıu
,

623 
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
,

624 
ıu_u£r_»gs
 * cÚ¡ 
»gs
)

626 
ùr
, 
¡ag
, 
»®
;

627 
ušt64_t
 
m¤_cÚ‹Á
;

628 
i
;

629 
ovf
 = 0;

630 
e
 = 
»gs
->eip;

631 
mode
 = 
	`x’İrofe_g‘_mode
(
cu¼’t
, 
»gs
);

633 
¡ag
 = 
	`g‘_¡agg”
();

635 
i
 = 0; i < 
num_couÁ”s
; ++i) {

637 ià(!
»£t_v®ue
[
i
])

657 
»®
 = 
	`VIRT_CTR
(
¡ag
, 
i
);

659 
	`CCCR_READ
(
m¤_cÚ‹Á
, 
»®
);

660 
	`CTR_READ
(
ùr
, 
»®
);

661 ià(
	`CCCR_OVF_P
(
m¤_cÚ‹Á
è|| 
	`CTR_OVERFLOW_P
(
ùr
)) {

662 
	`x’İrof_log_ev’t
(
cu¼’t
, 
»gs
, 
e
, 
mode
, 
i
);

663 
	`CTR_WRITE
(
»£t_v®ue
[
i
], 
»®
);

664 
	`CCCR_CLEAR_OVF
(
m¤_cÚ‹Á
);

665 
	`CCCR_WRITE
(
m¤_cÚ‹Á
, 
»®
);

666 
	`CTR_WRITE
(
»£t_v®ue
[
i
], 
»®
);

667 
ovf
 = 1;

672 
	`­ic_wr™e
(
APIC_LVTPC
, 
	`­ic_»ad
(APIC_LVTPCè& ~
APIC_LVT_MASKED
);

674  
ovf
;

675 
	}
}

678 
	$p4_¡¬t
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

680 
¡ag
;

681 
ušt64_t
 
m¤_cÚ‹Á
;

682 
i
;

684 
¡ag
 = 
	`g‘_¡agg”
();

686 
i
 = 0; i < 
num_couÁ”s
; ++i) {

687 ià(!
»£t_v®ue
[
i
])

689 
	`CCCR_READ
(
m¤_cÚ‹Á
, 
	`VIRT_CTR
(
¡ag
, 
i
));

690 
	`CCCR_SET_ENABLE
(
m¤_cÚ‹Á
);

691 
	`CCCR_WRITE
(
m¤_cÚ‹Á
, 
	`VIRT_CTR
(
¡ag
, 
i
));

693 
	}
}

696 
	$p4_¡İ
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

698 
¡ag
;

699 
ušt64_t
 
m¤_cÚ‹Á
;

700 
i
;

702 
¡ag
 = 
	`g‘_¡agg”
();

704 
i
 = 0; i < 
num_couÁ”s
; ++i) {

705 
	`CCCR_READ
(
m¤_cÚ‹Á
, 
	`VIRT_CTR
(
¡ag
, 
i
));

706 
	`CCCR_SET_DISABLE
(
m¤_cÚ‹Á
);

707 
	`CCCR_WRITE
(
m¤_cÚ‹Á
, 
	`VIRT_CTR
(
¡ag
, 
i
));

709 
	}
}

712 #ifdeà
CONFIG_SMP


713 
İ_x86_mod–_¥ec
 cÚ¡ 
	gİ_p4_ht2_¥ec
 = {

714 .
num_couÁ”s
 = 
NUM_COUNTERS_HT2
,

715 .
	gnum_cÚŒŞs
 = 
NUM_CONTROLS_HT2
,

716 .
	gfl_š_add»s£s
 = &
p4_fl_š_add»s£s
,

717 .
	g£tup_ùrs
 = &
p4_£tup_ùrs
,

718 .
	gcheck_ùrs
 = &
p4_check_ùrs
,

719 .
	g¡¬t
 = &
p4_¡¬t
,

720 .
	g¡İ
 = &
p4_¡İ


724 
İ_x86_mod–_¥ec
 cÚ¡ 
	gİ_p4_¥ec
 = {

725 .
num_couÁ”s
 = 
NUM_COUNTERS_NON_HT
,

726 .
	gnum_cÚŒŞs
 = 
NUM_CONTROLS_NON_HT
,

727 .
	gfl_š_add»s£s
 = &
p4_fl_š_add»s£s
,

728 .
	g£tup_ùrs
 = &
p4_£tup_ùrs
,

729 .
	gcheck_ùrs
 = &
p4_check_ùrs
,

730 .
	g¡¬t
 = &
p4_¡¬t
,

731 .
	g¡İ
 = &
p4_¡İ


	@oprofile/op_model_ppro.c

13 
	~<x’/ty³s.h
>

14 
	~<asm/m¤.h
>

15 
	~<asm/io.h
>

16 
	~<asm/­ic.h
>

17 
	~<asm/´oûssÜ.h
>

18 
	~<x’/sched.h
>

19 
	~<asm/»gs.h
>

20 
	~<asm/cu¼’t.h
>

21 
	~<asm/hvm/vpmu.h
>

22 
	~<asm/hvm/vmx/vpmu_cÜe2.h
>

24 
	~"İ_x86_mod–.h
"

25 
	~"İ_couÁ”.h
"

31 
	uıuid10_—x
 {

33 
	mv”siÚ_id
:8;

34 
	mnum_couÁ”s
:8;

35 
	mb™_width
:8;

36 
	mmask_Ëngth
:8;

37 } 
	m¥l™
;

38 
	mfuÎ
;

41 
	gnum_couÁ”s
 = 2;

42 
	gcouÁ”_width
 = 32;

44 
	#CTR_OVERFLOWED
(
n
è(!(Òè& (1ULL<<(
couÁ”_width
-1))))

	)

46 
	#CTRL_READ
(
m¤_cÚ‹Á
,
m¤s
,
c
èdØ{
	`rdm¤l
((m¤s->
cÚŒŞs
[(c)].
addr
), (m¤_cÚ‹Á));} 0)

	)

47 
	#CTRL_WRITE
(
m¤_cÚ‹Á
,
m¤s
,
c
èdØ{
	`wrm¤l
((m¤s->
cÚŒŞs
[(c)].
addr
), (m¤_cÚ‹Á));} 0)

	)

48 
	#CTRL_SET_ACTIVE
(
n
èÒ |ğ(1ULL<<22))

	)

49 
	#CTRL_SET_INACTIVE
(
n
èÒ &ğ~(1ULL<<22))

	)

50 
	#CTRL_CLEAR
(
x
è(x &ğ(1ULL<<21))

	)

51 
	#CTRL_SET_ENABLE
(
v®
è(v® |ğ1ULL<<20)

	)

52 
	#CTRL_SET_USR
(
v®
,
u
è(v® |ğ((u & 1ULLè<< 16))

	)

53 
	#CTRL_SET_KERN
(
v®
,
k
è(v® |ğ((k & 1ULLè<< 17))

	)

54 
	#CTRL_SET_UM
(
v®
, 
m
è(v® |ğ(m << 8))

	)

55 
	#CTRL_SET_EVENT
(
v®
, 
e
è(v® |ğe)

	)

56 
	#IS_ACTIVE
(
v®
è(v® & (1ULL << 22è)

	)

57 
	#IS_ENABLE
(
v®
è(v® & (1ULL << 20è)

	)

58 
	g»£t_v®ue
[
OP_MAX_COUNTER
];

59 
	gµro_has_glob®_ù¾
 = 0;

61 
	$µro_fl_š_add»s£s
(
İ_m¤s
 * cÚ¡ 
m¤s
)

63 
i
;

65 
i
 = 0; i < 
num_couÁ”s
; i++)

66 
m¤s
->
couÁ”s
[
i
].
addr
 = 
MSR_P6_PERFCTR0
 + i;

67 
i
 = 0; i < 
num_couÁ”s
; i++)

68 
m¤s
->
cÚŒŞs
[
i
].
addr
 = 
MSR_P6_EVNTSEL0
 + i;

69 
	}
}

72 
	$µro_£tup_ùrs
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

74 
ušt64_t
 
m¤_cÚ‹Á
;

75 
i
;

77 ià(
ıu_has_¬ch_³rfmÚ
) {

78 
ıuid10_—x
 
—x
;

79 
—x
.
fuÎ
 = 
	`ıuid_—x
(0xa);

85 ià(!(
—x
.
¥l™
.
v”siÚ_id
 == 0 &&

86 
cu¼’t_ıu_d©a
.
x86
 == 6 &&

87 
cu¼’t_ıu_d©a
.
x86_mod–
 == 15)) {

89 ià(
couÁ”_width
 < 
—x
.
¥l™
.
b™_width
)

90 
couÁ”_width
 = 
—x
.
¥l™
.
b™_width
;

95 
i
 = 0 ; i < 
num_couÁ”s
; ++i) {

96 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

97 
	`CTRL_CLEAR
(
m¤_cÚ‹Á
);

98 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

102 
i
 = 0; i < 
num_couÁ”s
; ++i)

103 
	`wrm¤l
(
m¤s
->
couÁ”s
[
i
].
addr
, ~0x0ULL);

106 
i
 = 0; i < 
num_couÁ”s
; ++i) {

107 ià(
couÁ”_cÚfig
[
i
].
’abËd
) {

108 
»£t_v®ue
[
i
] = 
couÁ”_cÚfig
[i].
couÁ
;

110 
	`wrm¤l
(
m¤s
->
couÁ”s
[
i
].
addr
, -
»£t_v®ue
[i]);

112 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

113 
	`CTRL_CLEAR
(
m¤_cÚ‹Á
);

114 
	`CTRL_SET_ENABLE
(
m¤_cÚ‹Á
);

115 
	`CTRL_SET_USR
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
u£r
);

116 
	`CTRL_SET_KERN
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
k”Ãl
);

117 
	`CTRL_SET_UM
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
un™_mask
);

118 
	`CTRL_SET_EVENT
(
m¤_cÚ‹Á
, 
couÁ”_cÚfig
[
i
].
ev’t
);

119 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

121 
»£t_v®ue
[
i
] = 0;

124 
	}
}

126 
	$µro_check_ùrs
(cÚ¡ 
ıu
,

127 
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
,

128 
ıu_u£r_»gs
 * cÚ¡ 
»gs
)

130 
u64
 
v®
;

131 
i
;

132 
ovf
 = 0;

133 
e
 = 
»gs
->eip;

134 
mode
 = 
	`x’İrofe_g‘_mode
(
cu¼’t
, 
»gs
);

135 
¬ch_m¤_·œ
 *
m¤s_cÚ‹Á
 = 
	`vıu_vpmu
(
cu¼’t
)->
cÚ‹xt
;

137 
i
 = 0 ; i < 
num_couÁ”s
; ++i) {

138 ià(!
»£t_v®ue
[
i
])

140 
	`rdm¤l
(
m¤s
->
couÁ”s
[
i
].
addr
, 
v®
);

141 ià(
	`CTR_OVERFLOWED
(
v®
)) {

142 
	`x’İrof_log_ev’t
(
cu¼’t
, 
»gs
, 
e
, 
mode
, 
i
);

143 
	`wrm¤l
(
m¤s
->
couÁ”s
[
i
].
addr
, -
»£t_v®ue
[i]);

144 iàĞ
	`is_·ssive
(
cu¼’t
->
domaš
è&& (
mode
 != 2) &&

145 (
	`vıu_vpmu
(
cu¼’t
)->
æags
 & 
PASSIVE_DOMAIN_ALLOCATED
) )

147 iàĞ
	`IS_ACTIVE
(
m¤s_cÚ‹Á
[
i
].
cÚŒŞ
) )

149 
m¤s_cÚ‹Á
[
i
].
couÁ”
 = 
v®
;

150 iàĞ
	`IS_ENABLE
(
m¤s_cÚ‹Á
[
i
].
cÚŒŞ
) )

151 
ovf
 = 2;

154 iàĞ!
ovf
 )

155 
ovf
 = 1;

161 
	`­ic_wr™e
(
APIC_LVTPC
, 
	`­ic_»ad
(APIC_LVTPCè& ~
APIC_LVT_MASKED
);

163  
ovf
;

164 
	}
}

167 
	$µro_¡¬t
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

169 
ušt64_t
 
m¤_cÚ‹Á
;

170 
i
;

172 
i
 = 0; i < 
num_couÁ”s
; ++i) {

173 ià(
»£t_v®ue
[
i
]) {

174 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

175 
	`CTRL_SET_ACTIVE
(
m¤_cÚ‹Á
);

176 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

182 iàĞ
µro_has_glob®_ù¾
 )

183 
	`wrm¤l
(
MSR_CORE_PERF_GLOBAL_CTRL
, (1ULL<<
num_couÁ”s
) - 1);

184 
	}
}

187 
	$µro_¡İ
(
İ_m¤s
 cÚ¡ * cÚ¡ 
m¤s
)

189 
ušt64_t
 
m¤_cÚ‹Á
;

190 
i
;

192 
i
 = 0; i < 
num_couÁ”s
; ++i) {

193 ià(!
»£t_v®ue
[
i
])

195 
	`CTRL_READ
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

196 
	`CTRL_SET_INACTIVE
(
m¤_cÚ‹Á
);

197 
	`CTRL_WRITE
(
m¤_cÚ‹Á
, 
m¤s
, 
i
);

199 iàĞ
µro_has_glob®_ù¾
 )

200 
	`wrm¤l
(
MSR_CORE_PERF_GLOBAL_CTRL
, 0x0ULL);

201 
	}
}

203 
	$µro_is_¬ch_pmu_m¤
(
u64
 
m¤_šdex
, *
ty³
, *
šdex
)

205 iàĞ(
m¤_šdex
 >ğ
MSR_IA32_PERFCTR0
) &&

206 (
m¤_šdex
 < (
MSR_IA32_PERFCTR0
 + 
num_couÁ”s
)) )

208 *
ty³
 = 
MSR_TYPE_ARCH_COUNTER
;

209 *
šdex
 = 
m¤_šdex
 - 
MSR_IA32_PERFCTR0
;

212 iàĞ(
m¤_šdex
 >ğ
MSR_P6_EVNTSEL0
) &&

213 (
m¤_šdex
 < (
MSR_P6_EVNTSEL0
 + 
num_couÁ”s
)) )

215 *
ty³
 = 
MSR_TYPE_ARCH_CTRL
;

216 *
šdex
 = 
m¤_šdex
 - 
MSR_P6_EVNTSEL0
;

221 
	}
}

223 
	$µro_®loÿ‹_m¤
(
vıu
 *
v
)

225 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

226 
¬ch_m¤_·œ
 *
m¤_cÚ‹Á
;

228 
m¤_cÚ‹Á
 = 
	`xm®loc_by‹s
Ğ(
¬ch_m¤_·œ
è* 
num_couÁ”s
 );

229 iàĞ!
m¤_cÚ‹Á
 )

230 
out
;

231 
	`mem£t
(
m¤_cÚ‹Á
, 0, (
¬ch_m¤_·œ
è* 
num_couÁ”s
);

232 
vpmu
->
cÚ‹xt
 = (*)
m¤_cÚ‹Á
;

233 
vpmu
->
æags
 = 0;

234 
vpmu
->
æags
 |ğ
PASSIVE_DOMAIN_ALLOCATED
;

236 
out
:

237 
	`gd´štk
(
XENLOG_WARNING
, "Insufficient memory for oprofile, oprofile is "

239 
v
->
vıu_id
, v->
domaš
->
domaš_id
);

241 
	}
}

243 
	$µro_ä“_m¤
(
vıu
 *
v
)

245 
vpmu_¡ruù
 *
vpmu
 = 
	`vıu_vpmu
(
v
);

247 iàĞ!(
vpmu
->
æags
 & 
PASSIVE_DOMAIN_ALLOCATED
) )

249 
	`xä“
(
vpmu
->
cÚ‹xt
);

250 
vpmu
->
æags
 &ğ~
PASSIVE_DOMAIN_ALLOCATED
;

251 
	}
}

253 
	$µro_lßd_m¤
(
vıu
 *
v
, 
ty³
, 
šdex
, 
u64
 *
m¤_cÚ‹Á
)

255 
¬ch_m¤_·œ
 *
m¤s
 = 
	`vıu_vpmu
(
v
)->
cÚ‹xt
;

256  
ty³
 )

258 
MSR_TYPE_ARCH_COUNTER
:

259 *
m¤_cÚ‹Á
 = 
m¤s
[
šdex
].
couÁ”
;

261 
MSR_TYPE_ARCH_CTRL
:

262 *
m¤_cÚ‹Á
 = 
m¤s
[
šdex
].
cÚŒŞ
;

265 
	}
}

267 
	$µro_§ve_m¤
(
vıu
 *
v
, 
ty³
, 
šdex
, 
u64
 
m¤_cÚ‹Á
)

269 
¬ch_m¤_·œ
 *
m¤s
 = 
	`vıu_vpmu
(
v
)->
cÚ‹xt
;

271  
ty³
 )

273 
MSR_TYPE_ARCH_COUNTER
:

274 
m¤s
[
šdex
].
couÁ”
 = 
m¤_cÚ‹Á
;

276 
MSR_TYPE_ARCH_CTRL
:

277 
m¤s
[
šdex
].
cÚŒŞ
 = 
m¤_cÚ‹Á
;

280 
	}
}

290 
	$¬ch_³rfmÚ_£tup_couÁ”s
()

292 
ıuid10_—x
 
—x
;

294 
—x
.
fuÎ
 = 
	`ıuid_—x
(0xa);

297 ià(
—x
.
¥l™
.
v”siÚ_id
 =ğ0 && 
cu¼’t_ıu_d©a
.
x86
 == 6 &&

298 
cu¼’t_ıu_d©a
.
x86_mod–
 == 15) {

299 
—x
.
¥l™
.
v”siÚ_id
 = 2;

300 
—x
.
¥l™
.
num_couÁ”s
 = 2;

301 
—x
.
¥l™
.
b™_width
 = 40;

304 
num_couÁ”s
 = 
	`mš_t
(
u8
, 
—x
.
¥l™
.num_couÁ”s, 
OP_MAX_COUNTER
);

306 
İ_¬ch_³rfmÚ_¥ec
.
num_couÁ”s
 =‚um_counters;

307 
İ_¬ch_³rfmÚ_¥ec
.
num_cÚŒŞs
 = 
num_couÁ”s
;

308 
İ_µro_¥ec
.
num_couÁ”s
 =‚um_counters;

309 
İ_µro_¥ec
.
num_cÚŒŞs
 = 
num_couÁ”s
;

310 
	}
}

312 
İ_x86_mod–_¥ec
 
__»ad_mo¡ly
 
	gİ_µro_¥ec
 = {

313 .
num_couÁ”s
 = 2,

314 .
	gnum_cÚŒŞs
 = 2,

315 .
	gfl_š_add»s£s
 = &
µro_fl_š_add»s£s
,

316 .
	g£tup_ùrs
 = &
µro_£tup_ùrs
,

317 .
	gcheck_ùrs
 = &
µro_check_ùrs
,

318 .
	g¡¬t
 = &
µro_¡¬t
,

319 .
	g¡İ
 = &
µro_¡İ
,

320 .
	gis_¬ch_pmu_m¤
 = &
µro_is_¬ch_pmu_m¤
,

321 .
	g®loÿ‹d_m¤
 = &
µro_®loÿ‹_m¤
,

322 .
	gä“_m¤
 = &
µro_ä“_m¤
,

323 .
	glßd_m¤
 = &
µro_lßd_m¤
,

324 .
	g§ve_m¤
 = &
µro_§ve_m¤


327 
İ_x86_mod–_¥ec
 
__»ad_mo¡ly
 
	gİ_¬ch_³rfmÚ_¥ec
 = {

329 .
fl_š_add»s£s
 = &
µro_fl_š_add»s£s
,

330 .
	g£tup_ùrs
 = &
µro_£tup_ùrs
,

331 .
	gcheck_ùrs
 = &
µro_check_ùrs
,

332 .
	g¡¬t
 = &
µro_¡¬t
,

333 .
	g¡İ
 = &
µro_¡İ
,

334 .
	gis_¬ch_pmu_m¤
 = &
µro_is_¬ch_pmu_m¤
,

335 .
	g®loÿ‹d_m¤
 = &
µro_®loÿ‹_m¤
,

336 .
	gä“_m¤
 = &
µro_ä“_m¤
,

337 .
	glßd_m¤
 = &
µro_lßd_m¤
,

338 .
	g§ve_m¤
 = &
µro_§ve_m¤


	@oprofile/op_x86_model.h

11 #iâdeà
OP_X86_MODEL_H


12 
	#OP_X86_MODEL_H


	)

14 
	sİ_m¤
 {

15 
	maddr
;

16 
ušt64_t
 
	mv®ue
;

19 
	sİ_m¤s
 {

20 
İ_m¤
 * 
	mcouÁ”s
;

21 
İ_m¤
 * 
	mcÚŒŞs
;

24 
	g±_»gs
;

29 
	sİ_x86_mod–_¥ec
 {

30 
	mnum_couÁ”s
;

31 
	mnum_cÚŒŞs
;

32 (*
	mfl_š_add»s£s
)(
İ_m¤s
 * cÚ¡ 
	mm¤s
);

33 (*
	m£tup_ùrs
)(
İ_m¤s
 cÚ¡ * cÚ¡ 
	mm¤s
);

34 (*
	mcheck_ùrs
)(cÚ¡ 
	mıu
,

35 
İ_m¤s
 cÚ¡ * cÚ¡ 
	mm¤s
,

36 
ıu_u£r_»gs
 * cÚ¡ 
	m»gs
);

37 (*
	m¡¬t
)(
İ_m¤s
 cÚ¡ * cÚ¡ 
	mm¤s
);

38 (*
	m¡İ
)(
İ_m¤s
 cÚ¡ * cÚ¡ 
	mm¤s
);

39 (*
	mis_¬ch_pmu_m¤
)(
u64
 
	mm¤_šdex
, *
	mty³
, *
	mšdex
);

40 (*
	m®loÿ‹d_m¤
)(
vıu
 *
	mv
);

41 (*
	mä“_m¤
)(
vıu
 *
	mv
);

42 (*
	mlßd_m¤
)(
vıu
 * cÚ¡ 
	mv
, 
	mty³
, 
	mšdex
, 
u64
 *
	mm¤_cÚ‹Á
);

43 (*
	m§ve_m¤
)(
vıu
 * cÚ¡ 
	mv
, 
	mty³
, 
	mšdex
, 
u64
 
	mm¤_cÚ‹Á
);

46 
İ_x86_mod–_¥ec
 
İ_µro_¥ec
;

47 
İ_x86_mod–_¥ec
 
İ_¬ch_³rfmÚ_¥ec
;

48 
İ_x86_mod–_¥ec
 cÚ¡ 
İ_p4_¥ec
;

49 
İ_x86_mod–_¥ec
 cÚ¡ 
İ_p4_ht2_¥ec
;

50 
İ_x86_mod–_¥ec
 cÚ¡ 
İ_©hlÚ_¥ec
;

52 
¬ch_³rfmÚ_£tup_couÁ”s
();

	@oprofile/xenoprof.c

11 
	~<x’/gue¡_acûss.h
>

12 
	~<x’/sched.h
>

13 
	~<public/x’İrof.h
>

14 #ifdeà
CONFIG_COMPAT


15 
	~<com·t/x’İrof.h
>

17 
	~<asm/hvm/suµÜt.h
>

19 
	~"İ_couÁ”.h
"

20 
	~<mši.h
>

22 #ifdeà
ENABLE_MYPROF


23 
	$my´of_couÁ”
()

25 
x’İrof_couÁ”
 
couÁ”
;

26 
couÁ”
.
šd
 = 0;

27 
couÁ”
.
couÁ
 = 10000;

28 
couÁ”
.
’abËd
 = 1;

29 
couÁ”
.
ev’t
 = 12;

30 
couÁ”
.
hy³rvisÜ
 = 0;

31 
couÁ”
.
k”Ãl
 = 1;

32 
couÁ”
.
u£r
 = 1;

33 
couÁ”
.
un™_mask
 = 0x100;

35 
couÁ”_cÚfig
[
couÁ”
.
šd
].
couÁ
 = counter.count;

36 
couÁ”_cÚfig
[
couÁ”
.
šd
].
’abËd
 = counter.enabled;

37 
couÁ”_cÚfig
[
couÁ”
.
šd
].
ev’t
 = counter.event;

38 
couÁ”_cÚfig
[
couÁ”
.
šd
].
k”Ãl
 = counter.kernel;

39 
couÁ”_cÚfig
[
couÁ”
.
šd
].
u£r
 = counter.user;

40 
couÁ”_cÚfig
[
couÁ”
.
šd
].
un™_mask
 = counter.unit_mask;

41 
i
;

42 
i
=1;i<4;i++) {

43 
couÁ”
.
šd
 = 
i
;

44 
couÁ”
.
couÁ
 = 0;

45 
couÁ”
.
’abËd
 = 0;

46 
couÁ”
.
ev’t
 = 0;

47 
couÁ”
.
hy³rvisÜ
 = 0;

48 
couÁ”
.
k”Ãl
 = 0;

49 
couÁ”
.
u£r
 = 0;

50 
couÁ”
.
un™_mask
 = 0;

52 
couÁ”_cÚfig
[
couÁ”
.
šd
].
couÁ
 = counter.count;

53 
couÁ”_cÚfig
[
couÁ”
.
šd
].
’abËd
 = counter.enabled;

54 
couÁ”_cÚfig
[
couÁ”
.
šd
].
ev’t
 = counter.event;

55 
couÁ”_cÚfig
[
couÁ”
.
šd
].
k”Ãl
 = counter.kernel;

56 
couÁ”_cÚfig
[
couÁ”
.
šd
].
u£r
 = counter.user;

57 
couÁ”_cÚfig
[
couÁ”
.
šd
].
un™_mask
 = counter.unit_mask;

59 
	}
}

63 
x’İrof_¬ch_couÁ”
(
	$XEN_GUEST_HANDLE
(è
¬g
)

65 
x’İrof_couÁ”
 
couÁ”
;

67 iàĞ
	`cİy_äom_gue¡
(&
couÁ”
, 
¬g
, 1) )

68  -
EFAULT
;

70 iàĞ
couÁ”
.
šd
 > 
OP_MAX_COUNTER
 )

71  -
E2BIG
;

73 
couÁ”_cÚfig
[
couÁ”
.
šd
].
couÁ
 = counter.count;

74 
couÁ”_cÚfig
[
couÁ”
.
šd
].
’abËd
 = counter.enabled;

75 
couÁ”_cÚfig
[
couÁ”
.
šd
].
ev’t
 = counter.event;

76 
couÁ”_cÚfig
[
couÁ”
.
šd
].
k”Ãl
 = counter.kernel;

77 
couÁ”_cÚfig
[
couÁ”
.
šd
].
u£r
 = counter.user;

78 
couÁ”_cÚfig
[
couÁ”
.
šd
].
un™_mask
 = counter.unit_mask;

80 #ifdeà
ENABLE_MYPROF


81 
	`´štk
("couÁ”:: ind:%x couÁ:%ÎxƒÇbËd:%xƒv’t:%x hy³rvisÜ:%x k”Ãl:%x u£r:%x un™_mask:%Îx\n", 
couÁ”
.
šd
, couÁ”.
couÁ
, couÁ”.
’abËd
, couÁ”.
ev’t
, couÁ”.
hy³rvisÜ
, couÁ”.
k”Ãl
, couÁ”.
u£r
, couÁ”.
un™_mask
 );

85 
	}
}

87 
x’İrof_¬ch_ibs_couÁ”
(
	$XEN_GUEST_HANDLE
(è
¬g
)

89 
x’İrof_ibs_couÁ”
 
ibs_couÁ”
;

91 iàĞ
	`cİy_äom_gue¡
(&
ibs_couÁ”
, 
¬g
, 1) )

92  -
EFAULT
;

94 
ibs_cÚfig
.
İ_’abËd
 = 
ibs_couÁ”
.op_enabled;

95 
ibs_cÚfig
.
ãtch_’abËd
 = 
ibs_couÁ”
.fetch_enabled;

96 
ibs_cÚfig
.
max_út_ãtch
 = 
ibs_couÁ”
.max_cnt_fetch;

97 
ibs_cÚfig
.
max_út_İ
 = 
ibs_couÁ”
.max_cnt_op;

98 
ibs_cÚfig
.
¿nd_’
 = 
ibs_couÁ”
.rand_en;

99 
ibs_cÚfig
.
di¥©ched_İs
 = 
ibs_couÁ”
.dispatched_ops;

102 
	}
}

104 #ifdeà
CONFIG_COMPAT


105 
com·t_İrof_¬ch_couÁ”
(
	$XEN_GUEST_HANDLE
(è
¬g
)

107 
com·t_İrof_couÁ”
 
couÁ”
;

109 iàĞ
	`cİy_äom_gue¡
(&
couÁ”
, 
¬g
, 1) )

110  -
EFAULT
;

112 iàĞ
couÁ”
.
šd
 > 
OP_MAX_COUNTER
 )

113  -
E2BIG
;

115 
couÁ”_cÚfig
[
couÁ”
.
šd
].
couÁ
 = counter.count;

116 
couÁ”_cÚfig
[
couÁ”
.
šd
].
’abËd
 = counter.enabled;

117 
couÁ”_cÚfig
[
couÁ”
.
šd
].
ev’t
 = counter.event;

118 
couÁ”_cÚfig
[
couÁ”
.
šd
].
k”Ãl
 = counter.kernel;

119 
couÁ”_cÚfig
[
couÁ”
.
šd
].
u£r
 = counter.user;

120 
couÁ”_cÚfig
[
couÁ”
.
šd
].
un™_mask
 = counter.unit_mask;

123 
	}
}

126 
	$x’İrofe_g‘_mode
(
vıu
 *
v
, 
ıu_u£r_»gs
 * cÚ¡ 
»gs
)

128 iàĞ!
	`gue¡_mode
(
»gs
) )

131 iàĞ
	`is_hvm_vıu
(
v
) )

132  ((
»gs
->
cs
 & 3) != 3);

134  
	`gue¡_k”Ãl_mode
(
v
, 
»gs
);

135 
	}
}

	@pci.c

7 
	~<x’/¥šlock.h
>

8 
	~<x’/pci.h
>

9 
	~<asm/io.h
>

11 
DEFINE_SPINLOCK
(
pci_cÚfig_lock
);

13 
ušt32_t
 
	$pci_cÚf_»ad
(
ušt32_t
 
cf8
, 
ušt8_t
 
off£t
, ušt8_ˆ
by‹s
)

15 
æags
;

16 
ušt32_t
 
v®ue
;

18 
	`BUG_ON
((
off£t
 + 
by‹s
) > 4);

20 
	`¥š_lock_œq§ve
(&
pci_cÚfig_lock
, 
æags
);

22 
	`ou
(
cf8
, 0xcf8);

24  
by‹s
 )

27 
v®ue
 = 
	`šb
(0xcfø+ 
off£t
);

30 
v®ue
 = 
	`šw
(0xcfø+ 
off£t
);

33 
v®ue
 = 
	`šl
(0xcfø+ 
off£t
);

36 
v®ue
 = 0;

37 
	`BUG
();

40 
	`¥š_uÆock_œq»¡Üe
(&
pci_cÚfig_lock
, 
æags
);

42  
v®ue
;

43 
	}
}

45 
	$pci_cÚf_wr™e
(
ušt32_t
 
cf8
, 
ušt8_t
 
off£t
, ušt8_ˆ
by‹s
, ušt32_ˆ
d©a
)

47 
æags
;

49 
	`BUG_ON
((
off£t
 + 
by‹s
) > 4);

51 
	`¥š_lock_œq§ve
(&
pci_cÚfig_lock
, 
æags
);

53 
	`ou
(
cf8
, 0xcf8);

55  
by‹s
 )

58 
	`outb
((
ušt8_t
)
d©a
, 0xcfø+ 
off£t
);

61 
	`outw
((
ušt16_t
)
d©a
, 0xcfø+ 
off£t
);

64 
	`ou
(
d©a
, 0xcfø+ 
off£t
);

68 
	`¥š_uÆock_œq»¡Üe
(&
pci_cÚfig_lock
, 
æags
);

69 
	}
}

	@per_cache_pt.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_PER_CACHE_PT


26 
	#š‹_g‘_pâ
(
X
) \

27 (()(((
X
è& (
PADDR_MASK
&
PAGE_MASK
)è>> 
PAGE_SHIFT
))

28 

	)

29 
	$l1e_¡©e
(
l1_pg’Œy_t
 
l1e
)

31 ià(
	`l1e_g‘_pâ
(
l1e
)) {

32 ià(
	`l1e_g‘_æags
(
l1e
)&

33 #ifdeà
ENABLE_PROTECTION_BIT


34 
_PAGE_USER


36 
_PAGE_PRESENT


39  
L1E_OPEN
;

41  
L1E_CLOSED
;

43 
	`MYASSERT
(!(
	`l1e_g‘_æags
(
l1e
)&
_PAGE_PRESENT
));

44  
L1E_NOT_PRESENT
;

46 
	}
}

49 
	$æag_shadow
(
·ge_bË
 *
±
, 
±šdex
, 
l1_pg’Œy_t
 
Æ1e
)

51 
i
;

52 
l1_pg’Œy_t
 *
l1t
;

53 
l1_pg’Œy_t
 *
¶1e
;

54 
l1_pg’Œy_t
 
Ş1e
;

55 
	`MYASSERT
(
	`l1e_g‘_æags
(
Æ1e
)&
_PAGE_PRESENT
);

57 
i
=0;i<
max_ÿche
;i++) {

58 
l1t
 = 
±
->
shadow
[
i
];

59 
¶1e
 = &
l1t
[
±šdex
];

60 
Ş1e
 = *
¶1e
;

64 ià(
i
==0)

65 ià((
	`l1e_g‘_æags
(
Æ1e
)&
_PAGE_GUEST_KERNEL
è!ğÖ1e_g‘_æags(
Ş1e
)&_PAGE_GUEST_KERNEL)) {

66 
	`my´štk
("%d->%d guest kernel bit @ va:%lx\n",

67 (
	`l1e_g‘_æags
(
Ş1e
)&
_PAGE_GUEST_KERNEL
),

68 (
	`l1e_g‘_æags
(
Æ1e
)&
_PAGE_GUEST_KERNEL
),

69 
	`g‘_va
(
±
, 
±šdex
)

73 
	`MYASSERT
(
	`l1e_¡©e
(
Æ1e
è=ğ
L1E_OPEN
);

75 iàĞ
	`l1e_¡©e
(
Ş1e
è=ğ
L1E_CLOSED
 ) {

76 
l1_pg’Œy_t
 
‹mp
 = 
Æ1e
;

77 
	`l1e_şo£
(&
‹mp
, 0);

78 
l1t
[
±šdex
] = 
‹mp
;

80 
l1t
[
±šdex
] = 
Æ1e
;

83 #ifdeà
ENABLE_REGIONING2


85 
l1t
 = 
±
->
»giÚšg_shadow
;

86 
¶1e
 = &
l1t
[
±šdex
];

87 
Ş1e
 = *
¶1e
;

88 
	`MYASSERT
(
	`l1e_g‘_pâ
(
l1t
[
±šdex
]è=ğl1e_g‘_pâ(
Æ1e
));

89 
	`MYASSERT
(
	`l1e_¡©e
(
Æ1e
è=ğ
L1E_OPEN
);

90 iàĞ
	`l1e_¡©e
(
Ş1e
è=ğ
L1E_CLOSED
 ) {

91 
l1_pg’Œy_t
 
‹mp
 = 
Æ1e
;

92 
	`l1e_şo£
(&
‹mp
, 0);

93 
l1t
[
±šdex
] = 
‹mp
;

95 
l1t
[
±šdex
] = 
Æ1e
;

97 
	}
}

100 
	$d–_shadow
(
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

102 
i
;

103 
l1_pg’Œy_t
 *
p
;

104 #ifdeà
ENABLE_MYXTRACE


105 ià(
	`is_x’_h—p_mâ
(
mâ
)) {

106 
	`my´štk
("WARN! guest un-maps xen_heap_mfn.. maybe xentrace?\n");

109 
	`MYASSERT
(!
	`is_x’_h—p_mâ
(
mâ
));

111 
i
=0;i<
max_ÿche
;i++) {

112 
p
 = 
±
->
shadow
[
i
];

119 ià(
	`l1e_¡©e
(
p
[
±šdex
]è=ğ
L1E_CLOSED
) {

120 
	`my´štk
("WARN: del closedƒntry\n");

123 
p
[
±šdex
].
l1
 = 
NULL
;

125 #ifdeà
ENABLE_BITMAP_BASIC


126 ià(
±
->
Ëv–
 == 1)

127 
	`şo£_b™m­
(
±
, 
±šdex
, -1);

129 #ifdeà
ENABLE_REGIONING2


130 
p
 = 
±
->
»giÚšg_shadow
;

131 
p
[
±šdex
].
l1
 = 
NULL
;

133 
	}
}

135 #ifdeà
ENABLE_KERNEL_SHADOW


137 
	$add_shadow2
(
·ge_bË
 *
±
, 
±šdex
, ·ge_bË *
±2
)

139 
i
;

140 
š‹_t
 *
p
, *
p2
;

141 
i
=0;i<
max_ÿche
;i++) {

142 
p
 = 
±
->
shadow
[
i
];

143 
p2
 = 
±2
->
shadow
[
i
];

144 ià(!(
p
[
±šdex
] =ğ
NULL
)) {

145 
	`´št_±
(
±
);

146 
	`my´štk
("±i:%d \n", 
±šdex
);

147 
	`my·nic
("!!!");

149 
p
[
±šdex
] = 
p2
[ptindex];

151 #ifdeà
ENABLE_REGIONING2


152 
p
 = 
±
->
»giÚšg_shadow
;

153 
p2
 = 
±2
->
»giÚšg_shadow
;

154 ià(!(
p
[
±šdex
] =ğ
NULL
)) {

155 
	`´št_±
(
±
);

156 
	`my´štk
("±i:%d \n", 
±šdex
);

157 
	`my·nic
("!!!!");

159 
p
[
±šdex
] = 
p2
[ptindex];

161 
TODO
 
k”Ãl
 
¥aû
 
»giÚšg
???

163 ià(!
»giÚšg_š™_İ’
) {

164 
	`MYASSERT
(
±
->
Ëv–
 == 1);

165 
	`l1e_şo£
(&
p
[
±šdex
], 0);

169 
	}
}

174 
	$add_shadow
(
·ge_bË
 *
±
, 
±šdex
, 
š‹_t
 
l1e
, 
b™m­
, 
»giÚšg_š™_İ’
)

176 
i
;

177 
š‹_t
 *
p
;

178 #ifdeà
ENABLE_MYXTRACE


179 ià(
	`is_x’_h—p_mâ
(
	`š‹_g‘_pâ
(
l1e
))) {

180 
	`my´štk
("WARN! guest maps xen_heap_mfn.. maybe xentrace?\n");

183 
	`MYASSERT
(!
	`is_x’_h—p_mâ
(
	`š‹_g‘_pâ
(
l1e
)));

185 
l1e
 &ğ~(()(
_PAGE_AVAIL
));

186 
	`MYASSERT
(
l1e
 & 
_PAGE_PRESENT
);

188 
æag
 = 
	`g‘_±e_æags
(
l1e
è& 
_PAGE_GUEST_KERNEL
;

190 ià(
æag
)

192 
	`my´štk
("u£r-Ëaf.…ti:%x†1e:%x va:%x\n", 
±šdex
, 
l1e
, 
	`g‘_va
(
±
,…tindex));

193 
	`´št_±
(
±
);

196 ià(!
æag
)

198 
	`my´štk
("k”Ãl-Ëaf.…ti:%x†1e:%x va:%x\n", 
±šdex
, 
l1e
, 
	`g‘_va
(
±
,…tindex));

199 
	`´št_±
(
±
);

203 
i
=0;i<
max_ÿche
;i++) {

204 
p
 = 
±
->
shadow
[
i
];

205 ià(!(
p
[
±šdex
] =ğ
NULL
)) {

206 
	`´št_±
(
±
);

207 
	`my´štk
("±i:%d†1e=%lx\n", 
±šdex
, 
l1e
);

208 
	`my·nic
("!!!");

210 
p
[
±šdex
] = 
l1e
;

211 ià(
±
->
Ëv–
 != 1)

216 ià(
	`‹¡_b™
(
VR_CACHEMAP_BASE
+
i
, &
b™m­
)) {

218 #ifdeà
ENABLE_BITMAP_VRT


219 #ifdeà
DEBUG_WARN


220 ià(
	`‹¡_b™m­
(
±
, 
±šdex
, 
i
))

221 
	`my´štk
("WARN! open bit?\n");

224 
	`l1e_şo£
(&
p
[
±šdex
], 0);

226 #ifdeà
ENABLE_BITMAP_VRT


227 
	`İ’_b™m­
(
±
, 
±šdex
, 
i
);

232 #ifdeà
ENABLE_BITMAP_BASIC


233 ià(
±
->
Ëv–
 == 1)

234 
	`İ’_b™m­
(
±
, 
±šdex
, -1);

236 #ifdeà
ENABLE_REGIONING2


237 
p
 = 
±
->
»giÚšg_shadow
;

238 
p
[
±šdex
] = 
l1e
;

239 #ifdeà
ENABLE_REGIONING3


241 ià(!
»giÚšg_š™_İ’
) {

242 
	`MYASSERT
(
±
->
Ëv–
 == 1);

243 
	`l1e_şo£
(&
p
[
±šdex
], 0);

247 
	}
}

249 #ifdeà
ENABLE_KERNEL_SHADOW


250 
	#SHADOW_NONLEAF_ASSERTION


	)

252 
	#SHADOW_NONLEAF_ASSERTION
 \

254 
va
 = 
	`g‘_va
(
±
, 
±šdex
); \

255 ià(
va
 >ğ
USERLAND_END
) { \

256 
	`my´štk
("va:%lx !!\n", 
va
); \

257 
	`my·nic
("panic"); \

259 }

	)

263 
	$d–_shadow_nÚËaf
(
·ge_bË
 *
±
, 
±šdex
)

265 
i
;

266 
š‹_t
 *
p
;

267 
	`MYASSERT
(
±
->
Ëv–
 != 1);

268 
SHADOW_NONLEAF_ASSERTION


269 
i
=0;i<
max_ÿche
;i++) {

270 
p
 = 
±
->
shadow
[
i
];

271 
mâ
 = 
	`š‹_g‘_pâ
(
p
[
±šdex
]);

272 
	`MYASSERT
(
	`is_x’_h—p_mâ
(
mâ
));

273 
p
[
±šdex
] = 
NULL
;

275 #ifdeà
ENABLE_REGIONING2


276 
p
 = 
±
->
»giÚšg_shadow
;

277 
p
[
±šdex
] = 
NULL
;

279 
	}
}

281 
	$add_shadow_nÚËaf
(
·ge_bË
 *
±
, 
±šdex
, ·ge_bË *
Ãwl1
, 
æags
)

283 
i
;

284 
mâ
;

285 
š‹_t
 *
p
;

287 
	`MYASSERT
(
æags
 & 
_PAGE_PRESENT
);

288 
	`MYASSERT
(
±
->
Ëv–
 != 1);

289 
SHADOW_NONLEAF_ASSERTION


292 ià(
±
->
Ëv–
 =ğ4 && 
	`L4_GUEST_KERNEL
(
±šdex
))

294 
	`my´štk
("k”Ãl-nÚËaf.…ti:%d f:%x va:0x%lx\n", 
±šdex
, 
æags
, 
	`g‘_va
(
±
,…tindex));

295 
	`´št_±
(
±
);

298 
i
=0;i<
max_ÿche
;i++) {

299 
p
 = 
±
->
shadow
[
i
];

300 
	`MYASSERT
(
p
[
±šdex
] =ğ
NULL
);

301 
mâ
 = 
	`vœt_to_mâ
(
Ãwl1
->
shadow
[
i
]);

302 
	`MYASSERT
(
	`is_x’_h—p_mâ
(
mâ
));

303 
p
[
±šdex
] = (
	`put_±e_æags
(
æags
è| ((
š‹_t
)(
mâ
)<<
PAGE_SHIFT
));

305 
	`MYASSERT
(
	`š‹_g‘_pâ
(
p
[
±šdex
]è=ğ
mâ
);

306 
	`MYASSERT
(
	`g‘_±e_æags
(
p
[
±šdex
]è=ğ
æags
);

308 #ifdeà
ENABLE_REGIONING2


309 
p
 = 
±
->
»giÚšg_shadow
;

310 
	`MYASSERT
(
p
[
±šdex
] =ğ
NULL
);

311 
mâ
 = 
	`vœt_to_mâ
(
Ãwl1
->
»giÚšg_shadow
);

312 
	`MYASSERT
(
	`is_x’_h—p_mâ
(
mâ
));

313 
p
[
±šdex
] = (
	`put_±e_æags
(
æags
è| (
mâ
<<
PAGE_SHIFT
));

316 
	}
}

317 
	$ü3_is_shadow
(
locked
)

319 
·ge_dœ
 *
pgd
 = 
cu¼’t
->
cu¼’t_pgd
;

320 
»t
 = 0;

321 #ifdeà
ENABLE_REGIONING2


322 ià(!
locked
)

323 
	`my¥š_lock
(&
pgd
->
lock
, 24);

325 
mâ
 = (
	`»ad_ü3
(è>> 
PAGE_SHIFT
);

327 ià(
mâ
 =ğ
	`vœt_to_mâ
(
pgd
->
±
->
shadow
[
ÿche_now
]))

328 
»t
 = 1;

329 #ifdeà
ENABLE_REGIONING2


330 
v»giÚ_t
 *
cur
 = 
pgd
->
cu¼’t_»giÚ
;

331 
ıu
 = 
pgd
->
»giÚšg_ıu
;

332 ià(!
locked
)

333 
	`¥š_uÆock
(&
pgd
->
lock
);

335 ià(
»t
) {

338 ià(
cur
 && 
ıu
 =ğ
	`smp_´oûssÜ_id
()) {

339 
	`my´štk
("mâ:%x\n", 
mâ
);

340 
	`my·nic
("normal-shadow during„egioning?");

345 ià(
mâ
 =ğ
	`vœt_to_mâ
(
pgd
->
±
->
»giÚšg_shadow
))

346 
»t
 = 2;

348 
	`my·nic
("?!?!?");

350 ià(
ıu
 !ğ
	`smp_´oûssÜ_id
())

351 
	`my´štk
("»giÚšg_ıu i %d ?\n", 
ıu
);

352 ià(!
cur
)

353 
	`my·nic
("zero cur_region during„egioning?");

358 ià(!
»t
) {

359 
	`my´štk
("pgdmfn:%lx, cr3:%lx [%lx,%lx], "

360 "g:%lx u:%lx\n",
pgd
->
±
->
mâ
, mâ, 
	`vœt_to_mâ
Õgd->±->
shadow
[0]), virt_to_mfn(pgd->pt->shadow[1]),

361 
cu¼’t
->
¬ch
.
gue¡_bË
.
pâ
, cu¼’t->¬ch.
gue¡_bË_u£r
.pfn);

363  
»t
;

364 
	}
}

	@percpu.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/³rıu.h
>

3 
	~<x’/ıu.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/mm.h
>

6 
	~<x’/rcupd©e.h
>

8 
	g__³r_ıu_off£t
[
NR_CPUS
];

9 
	#INVALID_PERCPU_AREA
 (-()
__³r_ıu_¡¬t
)

	)

10 
	#PERCPU_ORDER
 (
	`g‘_Üd”_äom_by‹s
(
__³r_ıu_d©a_’d
-
__³r_ıu_¡¬t
))

	)

12 
__š™
 
	$³rıu_š™_¬—s
()

14 
ıu
;

15  
ıu
 = 1; cpu < 
NR_CPUS
; cpu++ )

16 
__³r_ıu_off£t
[
ıu
] = 
INVALID_PERCPU_AREA
;

17 
	}
}

19 
	$š™_³rıu_¬—
(
ıu
)

21 *
p
;

22 iàĞ
__³r_ıu_off£t
[
ıu
] !ğ
INVALID_PERCPU_AREA
 )

23  -
EBUSY
;

24 iàĞ(
p
 = 
	`®loc_x’h—p_·ges
(
PERCPU_ORDER
, 0)è=ğ
NULL
 )

25  -
ENOMEM
;

26 
	`mem£t
(
p
, 0, 
__³r_ıu_d©a_’d
 - 
__³r_ıu_¡¬t
);

27 
__³r_ıu_off£t
[
ıu
] = 
p
 - 
__³r_ıu_¡¬t
;

29 
	}
}

31 
	sä“_šfo
 {

32 
	mıu
;

33 
rcu_h—d
 
	mrcu
;

35 
DEFINE_PER_CPU
(
ä“_šfo
, free_info);

37 
	$_ä“_³rıu_¬—
(
rcu_h—d
 *
h—d
)

39 
ä“_šfo
 *
šfo
 = 
	`cÚš”_of
(
h—d
, ä“_šfo, 
rcu
);

40 
ıu
 = 
šfo
->cpu;

41 *
p
 = 
__³r_ıu_¡¬t
 + 
__³r_ıu_off£t
[
ıu
];

42 
	`ä“_x’h—p_·ges
(
p
, 
PERCPU_ORDER
);

43 
__³r_ıu_off£t
[
ıu
] = 
INVALID_PERCPU_AREA
;

44 
	}
}

46 
	$ä“_³rıu_¬—
(
ıu
)

48 
ä“_šfo
 *
šfo
 = &
	`³r_ıu
(ä“_šfo, 
ıu
);

49 
šfo
->
ıu
 = cpu;

50 
	`ÿÎ_rcu
(&
šfo
->
rcu
, 
_ä“_³rıu_¬—
);

51 
	}
}

53 
	$ıu_³rıu_ÿÎback
(

54 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

56 
ıu
 = ()
hıu
;

57 
rc
 = 0;

59  
aùiÚ
 )

61 
CPU_UP_PREPARE
:

62 
rc
 = 
	`š™_³rıu_¬—
(
ıu
);

64 
CPU_UP_CANCELED
:

65 
CPU_DEAD
:

66 
	`ä“_³rıu_¬—
(
ıu
);

72  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

73 
	}
}

75 
nÙif›r_block
 
	gıu_³rıu_nfb
 = {

76 .
nÙif›r_ÿÎ
 = 
ıu_³rıu_ÿÎback
,

77 .
	g´iÜ™y
 = 100

80 
__š™
 
	$³rıu_´esmp_š™
()

82 
	`»gi¡”_ıu_nÙif›r
(&
ıu_³rıu_nfb
);

84 
	}
}

85 
´esmp_š™ÿÎ
(
³rıu_´esmp_š™
);

	@pgd.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_PGD


26 
li¡_h—d
 
	gpgd_li¡
;

27 
	gpgd_couÁ
;

28 
¥šlock_t
 
	gpgd_li¡_lock
;

30 
	$š™_pgds
()

32 
	`INIT_LIST_HEAD
(&
pgd_li¡
);

33 
pgd_couÁ
 = 0;

34 
	`¥š_lock_š™
(&
pgd_li¡_lock
);

35 
	}
}

37 #ifdeà
ENABLE_GLOBALIZE2


38 
	$š™_ui
(
usched_šfo
 *
ui
)

40 
i
;

41 
i
=0;i<
MAX_USCHED_INFO
;i++) {

42 
ui
[
i
].
e
 = 0;

43 
ui
[
i
].
addr
 = 0;

44 
ui
[
i
].
äom
 = -1;

45 
ui
[
i
].
vr
 = 
NULL
;

46 
ui
[
i
].
vr_æags
 = 0;

47 
ui
[
i
].
mâ
 = -1;

48 
ui
[
i
].
time
 = 0;

50 
	}
}

53 
	$´št_·ge
(
mâ
)

55 
·ge_šfo
 *
p
 = 
	`mâ_to_·ge
(
mâ
);

56 
	`my´štk
("mâ:%x,y³:%x,„aw_ty³:%x, owÃr:%x is_x’_h—p:%d is_iomem:%d\n", 
mâ
, 
p
->
u
.
šu£
.
ty³_šfo
 & 
PGT_ty³_mask
,…->u.šu£.ty³_šfo, 
	`·ge_g‘_owÃr
Õ), 
	`is_x’_h—p_·ge
Õ), 
	`is_iomem_·ge
(mfn) );

57 
	}
}

58 #ifdeà
ENABLE_PTMAN


59 
·ge_bË
 *
	$add_pgd_u£r
(
mâ
)

61 
	`mâ_check
(
mâ
);

62 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l4_·ge_bË
 );

63 
	`MYASSERT_PAGE_IS_VALIDATED
Ğ
	`mâ_to_·ge
(
mâ
));

65 #ifdeà
ENABLE_PTMAN


66 
	`lock_pgd
(
mâ
, 
pgd
, 3);

68 #ifdeà
ENABLE_PTMAN


69 
pgd
->
±
 = 
	`add_±
Õgd, -1, 
mâ
);

71 
pgd
->
mâ
 = mfn;

73 
	`my¥š_lock
(&
pgd_li¡_lock
, 116);

74 
	`li¡_add
(&
pgd
->
li¡
, &
pgd_li¡
);

75 
pgd_couÁ
++;

76 
	`¥š_uÆock
(&
pgd_li¡_lock
);

77 #ifdeà
ENABLE_PTMAN


78 
	`uÆock_±
(1);

80 #ifdeà
ENABLE_PTMAN


81 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


82 
	`my´štk
("pgdmâ=%5x‡dded,couÁ=%d\n", 
pgd
->
±
->
mâ
, 
pgd_couÁ
);

84 
	`TRACE_2D
(
TRC_MIN_ADD_PGD
, 
pgd
->
±
->
mâ
, 0 );

86 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


87 
	`my´štk
("pgdmâ=%5x‡dded,couÁ=%d\n", 
pgd
->
mâ
, 
pgd_couÁ
);

89 
	`TRACE_2D
(
TRC_MIN_ADD_PGD
, 
pgd
->
mâ
, 0 );

92  
	`add_±_u£r
(
mâ
);

93 
	}
}

95 
·ge_dœ
 *
	$add_pgd
(
mâ
, 
æag
)

97 
i
;

98 
·ge_dœ
 *
pgd
;

99 
	`mâ_check
(
mâ
);

100 #ifdeà
DEBUG_ASSERT


101 ià(!
	`‹¡_b™
(
PGD_KERNEL
, &
æag
) ) {

102 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l4_·ge_bË
 );

104 
	`MYASSERT_PAGE_IS_VALIDATED
Ğ
	`mâ_to_·ge
(
mâ
));

107 
pgd
 = 
	`myxm®loc
(
·ge_dœ
, 4);

108 ià(!
pgd
)

109 
	`my·nic
("xmalloc failed! -‡dd_pgd()\n");

110 
pgd
->
domaš
 = 
cu¼’t
->domain;

111 
	`INIT_LIST_HEAD
(&
pgd
->
li¡
);

112 
	`©omic_£t
(&
pgd
->
»fút
, 0);

113 
	`¥š_lock_š™
(&
pgd
->
lock
);

114 
pgd
->
æag
 = flag;

115 
pgd
->
m¬k_couÁ
 = 0;

116 
	`mem£t
(
pgd
->
İ’b™_couÁ
, 0, (pgd->openbit_count));

117 #ifdeà
ENABLE_REGIONING2


119 
pgd
->
cu¼’t_»giÚ
 = 
NULL
;

120 
pgd
->
»giÚšg_ıu
 = -1;

121 #ifdeà
ENABLE_REGIONING5


122 
pgd
->
»giÚšg_k¡ack
 = 
NULL
;

124 
pgd
->
»giÚšg_tick
 = 0;

125 
pgd
->
»giÚ_sw™ch_couÁ
 = 0;

126 
pgd
->
£qu’tŸl_couÁ
 = 0;

127 
pgd
->
m”ge_couÁ
 = 0;

128 
pgd
->
»giÚ_´ev_u£r_·ge_touch
 = -1;

129 
pgd
->
»giÚ_´ev_k”Ãl_·ge_touch
 = -1;

130 
pgd
->
»giÚ_´ev_time
 = 0;

131 
pgd
->
»giÚšg_adju¡
 =…gd->
»giÚšg_adju¡_´ev
 = 0;

132 
pgd
->
»giÚšg_·u£_»asÚ
 = -1;

133 
pgd
->
»giÚšg_·u£_couÁ
 = 0;

134 
pgd
->
»giÚšg_usched_couÁ
 = 0;

135 
pgd
->
Ãw»guÏr_duršg_nÜm®exec_couÁ
 = 0;

136 
pgd
->
»giÚšg_couÁ
 = 0;

137 
pgd
->
»giÚšg_´ev_»giÚ
 = 
NULL
;

139 #ifdeà
VERBOSE_BITMAP_PRINT


140 
pgd
->
İ’šg_couÁ
 = 0;

146 
pgd
->
mâ_u£r
 = 0;

147 #ifdeà
ENABLE_DENSITY


149 
	`mem£t
(
pgd
->
ab™_d’s™y
, 0, (pgd->abit_density));

151 #ifdeà
ENABLE_RANGE


152 
i
=0;i<
MAX_RANGES
;i++) {

153 
pgd
->
¿nges
[
i
].
vâ
 = 0;

154 
pgd
->
¿nges
[
i
].
couÁ
 = 0;

155 
pgd
->
¿nges
[
i
].
rd
 = 0;

158 #ifdeà
ENABLE_CLOCK


159 
pgd
->
şock_»sidue
 = 0;

160 
pgd
->
şock_´ev_now
 = 
	`NOW
();

161 
pgd
->
şock_ü3_chªges
 = 0;

162 
pgd
->
şock_tim”
 = 0;

163 
pgd
->
şock_scheduË
= 0;

164 
pgd
->
vtick_couÁ
 = 0;

166 #ifdeà
ENABLE_ABIT


167 
pgd
->
ş—r_ab™_couÁ
 = 0;

169 #ifdeà
ENABLE_PTMAN


170 
pgd
->
±
 = 
NULL
;

171 
	`lock_pgd
(
mâ
, 
pgd
, 3);

172 
pgd
->
±
 = 
	`add_±
Õgd, -1, 
mâ
);

174 
pgd
->
±
 = 
	`myxm®loc
(
·ge_bË
, 3);

175 ià(!
pgd
->
±
)

176 
	`my·nic
("xmalloc failed.");

177 
pgd
->
±
->
mâ
 = mfn;

178 
pgd
->
±
->
u£r_l4
 = 0;

180 
	`my¥š_lock
(&
pgd_li¡_lock
, 116);

181 
	`li¡_add
(&
pgd
->
li¡
, &
pgd_li¡
);

182 
pgd_couÁ
++;

183 
	`¥š_uÆock
(&
pgd_li¡_lock
);

184 #ifdeà
ENABLE_PTMAN


185 
	`uÆock_±
(1);

187 #ifdeà
ENABLE_PTMAN


188 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


189 
	`my´štk
("pgdmâ=%5x‡dded,couÁ=%d\n", 
pgd
->
±
->
mâ
, 
pgd_couÁ
);

191 
	`TRACE_2D
(
TRC_MIN_ADD_PGD
, 
pgd
->
±
->
mâ
, 0 );

193 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


194 
	`my´štk
("pgdmâ=%5x‡dded,couÁ=%d\n", 
pgd
->
mâ
, 
pgd_couÁ
);

196 
	`TRACE_2D
(
TRC_MIN_ADD_PGD
, 
pgd
->
±
->
mâ
, 0 );

198  
pgd
;

199 
	}
}

202 
	$d–_pgd_commÚ
(
·ge_dœ
 *
pgd
)

204 
·ge_bË
 *
±
;

205 #ifdeà
DEBUG_ASSERT


208 ià(!
pgd
)

209 
	`my·nic
("del_pgd_common():‚ull…gd?");

211 #ifdeà
ENABLE_REGIONING2


212 ià(
pgd
->
cu¼’t_»giÚ
) {

213 
	`»giÚšg_¡İ
(
CLOCK_EVENT_DYING_PGD
, 
pgd
);

215 
	`MYASSERT
(
pgd
->
cu¼’t_»giÚ
 =ğ
NULL
);

216 
	`MYASSERT
(
pgd
->
»giÚšg_tick
 == 0);

218 
vıu
 *
v
;

219 
domaš
 *
d
;

221 #ifdeà
DEBUG_ASSERT


222 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

223 
	`fÜ_—ch_domaš_vıu
(
d
,
v
) {

224 ià(
v
->
cu¼’t_pgd
 =ğ
pgd
) {

225 
	`©omic_dec
(&
v
->
cu¼’t_pgd
->
»fút
);

226 
v
->
cu¼’t_pgd
 = 
NULL
;

227 
	`my´štk
("WARN! d%dv%d' cu¼’t_pgd i »£‰edØNULL!!\n", 
d
->
domaš_id
, 
v
->
vıu_id
);

228 
	`my·nic
("shouldn't happen!!");

231 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

233 
	`MYASSERT
 (!
	`©omic_»ad
(&
pgd
->
»fút
));

235 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


236 
	`my´štk
("pgdmâ=%5x d–ed. couÁ=%d\n", 
pgd
->
±
->
mâ
, 
pgd_couÁ
);

237 
	`TRACE_2D
(
TRC_MIN_DEL_PGD
, 
pgd
->
±
->
mâ
, 
pgd_couÁ
);

239 #ifdeà
ENABLE_PTMAN


240 
mâ
 = 
pgd
->
±
->mfn;

241 
	`d–_±
(
pgd
, -1, 
mâ
);

242 
pgd
->
±
 = 
NULL
;

243 #ifdeà
ENABLE_KERNEL_SHADOW


245 ià(
	`‹¡_ªd_ş—r_b™
(
PGD_KERNEL
, &
pgd
->
æag
)) {

246 
	`my´štk
("unset…gd_kernel..\n");

247 ià(
pgd_couÁ
)

248 
	`my´štk
("WARN couÁ=%d†eá..pgd_k”ÃÈshould bd–‘ed‡ˆÏ¡\n", 
pgd_couÁ
);

249 
	`myä“_x’h—p_·ge
(
	`mâ_to_vœt
(
mâ
), 9);

253 
pgd
->
±
->
u£r_l4
 = 0;

254 
pgd
->
±
->
mâ
 = 
NULL
;

255 
	`myxä“
(
pgd
->
±
, 3);

256 
pgd
->
±
 = 
NULL
;

262 #ifdeà
ENABLE_RANGE


263 
	`d–_®l_¿nges
(
pgd
);

265 
	}
}

266 #iâdeà
ENABLE_PTMAN


267 
·ge_dœ
 *
	$fšd_pgd_sim¶e
(
pâ
)

269 
	`MYASSERT
(
	`¥š_is_locked
(&
pgd_li¡_lock
));

271 
·ge_dœ
 *
i
;

272 
	`li¡_fÜ_—ch_’Œy
(
i
, &
pgd_li¡
, 
li¡
) {

273 ià(
i
->
±
->
mâ
 =ğ
pâ
) {

274  
i
;

277  
NULL
;

278 
	}
}

282 
	$d–_pgd_u£r
(
mâ
, 
·ge_bË
 *
±
)

284 #ifdeà
ENABLE_PTMAN


286 
	`±mª_lock
(
mâ
);

287 
	`±mª_d–
(
mâ
);

288 
	`±mª_uÆock
(
mâ
);

295 
	}
}

297 
	$d–_pgd
(
mâ
)

299 
·ge_dœ
 *
pgd
 = 
NULL
;

300 
·ge_bË
 *
±
;

302 
	`my¥š_lock
(&
pgd_li¡_lock
, 66);

303 #ifdeà
ENABLE_PTMAN


304 
	`±mª_lock
(
mâ
);

305 
pgd
 = 
	`fšd_pgd
(
mâ
, &
±
);

306 
	`±mª_uÆock
(
mâ
);

308 
pgd
 = 
	`fšd_pgd_sim¶e
(
mâ
);

310 ià(!
pgd
) {

311 ià(
±
) {

312 
	`¥š_uÆock
(&
pgd_li¡_lock
);

313 
	`d–_pgd_u£r
(
mâ
, 
±
);

316 #ifdeà
VERBOSE_INFO


317 
	`my´štk
("INFO del_pgd failed..(initial or finishing?)\n");

319 
	`¥š_uÆock
(&
pgd_li¡_lock
);

322 
	`li¡_d–
(&
pgd
->
li¡
);

323 
pgd_couÁ
--;

324 ià(
	`‹¡_ªd_£t_b™
(
PGD_DYING
, &
pgd
->
æag
))

325 
	`my·nic
("already dying?\n");

326 
	`¥š_uÆock
(&
pgd_li¡_lock
);

328 ià(
	`©omic_»ad
(&
pgd
->
»fút
)) {

330 
	`my´štk
("del_pgd()‚on-zero„efcnt\n");

331 ià(
mši_aùiv©ed
)

332 
	`my´štk
("WARN! Waiting…gd->refcnt with mini_activated?\n");

333 
	`©omic_»ad
(&
pgd
->
»fút
)) {

334 
	`ıu_»Ïx
();

337 #ifdeà
ENABLE_PTMAN


338 
	`lock_±
(
mâ
, 
CONFIG_PAGING_LEVELS
, 4);

340 
	`d–_pgd_commÚ
(
pgd
);

341 #ifdeà
ENABLE_PTMAN


342 
	`uÆock_±
(1);

345 
	`myxä“
(
pgd
, 4);

346 #ifdeà
VERBOSE_PAGE_TABLE_INOUT_LOW


347 
	`my´štk
("%x d–‘ed\n", 
mâ
);

349 
	}
}

351 
	$d–_®l_pgd
()

353 
·ge_dœ
 *
pgd
;

354 
vıu
 *
v
;

355 
domaš
 *
d
;

357 
	`my´štk
("reset-pgd forciblyl.. ");

358 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

359 
	`fÜ_—ch_domaš_vıu
(
d
,
v
) {

360 ià(
v
->
cu¼’t_pgd
) {

361 
pgd
 = 
v
->
cu¼’t_pgd
;

362 
v
->
cu¼’t_pgd
 = 
NULL
;

363 
	`´štk
("d%dv%d , ", 
d
->
domaš_id
, 
v
->
vıu_id
);

364 
	`©omic_dec
(&
pgd
->
»fút
);

367 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

368 
	`´štk
("\n");

369 
	`my´štk
("starting del_all_pgd()\n");

370 
agaš
:

371 
	`my¥š_lock
(&
pgd_li¡_lock
, 22);

372 
	`li¡_fÜ_—ch_’Œy
(
pgd
, &
pgd_li¡
, 
li¡
) {

373 ià(
pgd
) {

374 
	`¥š_uÆock
(&
pgd_li¡_lock
);

375 
	`d–_pgd
(
pgd
->
±
->
mâ
);

376 
agaš
;

379 
	`¥š_uÆock
(&
pgd_li¡_lock
);

380 
	`my´štk
("end of del_all_pgd()\n");

381 
	}
}

383 
·ge_dœ
 *
	$fšd_Ü_add_pgd
(
mâ
)

385 
·ge_dœ
 *
pgd
;

386 #ifdeà
ENABLE_PTMAN


387 
	`±mª_lock
(
mâ
);

388 
pgd
 = 
	`fšd_pgd
(
mâ
, 
NULL
);

389 
	`±mª_uÆock
(
mâ
);

391 
	`my¥š_lock
(&
pgd_li¡_lock
, 175);

392 
pgd
 = 
	`fšd_pgd_sim¶e
(
mâ
);

393 
	`¥š_uÆock
(&
pgd_li¡_lock
);

395 #ifdeà
ENABLE_KERNEL_SHADOW


396 
l4_pg’Œy_t
 *
l4t
, *
p
;

397 ià(!
cu¼’t
->
domaš
->
k”Ãl_pgd
) {

398 
	`my¥š_lock
(&
cu¼’t
->
domaš
->
k”Ãl_pgd_lock
, 64);

399 ià(!
cu¼’t
->
domaš
->
k”Ãl_pgd
) {

400 
i
;

402 
p
 = (
l4_pg’Œy_t
 *)
	`my®loc_x’h—p_·ge
(9);

403 
	`MYASSERT
(
p
);

404 
	`mem£t
((*)
p
, 0, 
PAGE_SIZE
);

406 
l4t
 = 
	`m­_domaš_·ge
(
mâ
);

407 
i
=
L4_GUEST_START
;i<
L4_GUEST_END
;i++) {

408 ià(!(
	`l4e_g‘_æags
(
l4t
[
i
]è& 
_PAGE_PRESENT
))

410 
p
[
i
] = 
l4t
[i];

412 
	`unm­_domaš_·ge
(
l4t
);

413 
	`my´štk
("constructing kernel_pgd.\n");

414 
cu¼’t
->
domaš
->
k”Ãl_pgd
 = 
	`add_pgd
(
	`vœt_to_mâ
(
p
), 1UL << 
PGD_KERNEL
);

415 
	`MYASSERT
(
cu¼’t
->
domaš
->
k”Ãl_pgd
);

416 
	`my´štk
("k”Ãl_pgd(%lxè£t.. (dummyèpgd->±->mâ:%lx\n", 
cu¼’t
->
domaš
->
k”Ãl_pgd
, cu¼’t->domaš->k”Ãl_pgd->
±
->
mâ
);

417 
	`´št_±
(
cu¼’t
->
domaš
->
k”Ãl_pgd
->
±
);

420 
	`¥š_uÆock
(&
cu¼’t
->
domaš
->
k”Ãl_pgd_lock
);

423 ià(!
pgd
) {

424 
pgd
 = 
	`add_pgd
(
mâ
, 0);

426 
	`MYASSERT
(
pgd
);

427  
pgd
;

428 
	}
}

431 
	$chªge_ü3
(
Şd_ba£_mâ
)

433 
	`©omic_šc
(&
mši_couÁ
);

434 
	`©omic_šc
(&
mši_¶aû
[3]);

435 
s_time_t
 
´ev_now
 = 0;

436 
·ge_dœ
 *
pgd
 = 
NULL
, *
Şd_pgd
;

437 
i
;

438 
shadow_ü3
 = 
NULL
;

439 
s_time_t
 
now
;

441 
	`TRACE_4D
(
TRC_MIN_NEW_GUEST_CR3
, 
cu¼’t
->
domaš
->
domaš_id
, cu¼’t->
vıu_id
, 
Şd_ba£_mâ
, cu¼’t->
¬ch
.
ü3
 >> 
PAGE_SHIFT
 );

443 
	`MYASSERT
((
cu¼’t
->
¬ch
.
ü3
 >> 
PAGE_SHIFT
è=ğcu¼’t->¬ch.
gue¡_bË
.
pâ
);

444 
pgd
 = 
	`fšd_Ü_add_pgd
(
cu¼’t
->
¬ch
.
ü3
 >> 
PAGE_SHIFT
);

446 #ifdeà
DEBUG_ASSERT


447 ià(
cu¼’t
->
cu¼’t_pgd
 && cu¼’t->cu¼’t_pgd->
±
->
mâ
 !ğ
Şd_ba£_mâ
) {

448 
	`´št_±
(
cu¼’t
->
cu¼’t_pgd
->
±
);

449 
	`my´štk
("WARN!! cur_pgdmâ:%x !ğŞd_ba£_mâ:%x ??\n", 
cu¼’t
->
cu¼’t_pgd
->
±
->
mâ
, 
Şd_ba£_mâ
);

453 
Şd_pgd
 = 
cu¼’t
->
cu¼’t_pgd
;

454 
now
 = 
	`NOW
();

455 #ifdeà
ENABLE_CLOCK


456 ià(
Şd_pgd
) {

457 
Şd_pgd
->
şock_»sidue
 +ğ
now
 - old_pgd->
şock_´ev_now
;

458 
Şd_pgd
->
şock_´ev_now
 = 
now
;

459 
	`do_şock
(
CLOCK_EVENT_NEW_CR3
, 
Şd_pgd
, 
now
);

461 
pgd
->
şock_´ev_now
 = 
now
;

467 
	`©omic_šc
(&
pgd
->
»fút
);

468 
cu¼’t
->
cu¼’t_pgd
 = 
pgd
;

470 ià(
Şd_pgd
) {

471 
	`©omic_dec
(&
Şd_pgd
->
»fút
);

487 #ifdeà
VERBOSE_UPDATE_CR3


488 ià(
cu¼’t
->
´št_couÁdown
 > 0) {

489 
	`my´štk
("NOW:%6Îdms(d:%4Îdmsè",
now
/1000000ULL, (now - 
´ev_now
)/1000000ULL );

490 
	`´štk
("%5lx --> %5lx ", 
Şd_ba£_mâ
, 
cu¼’t
->
¬ch
.
ü3
>>
PAGE_SHIFT
);

496 
	`´št_İ’b™_couÁ
(
pgd
);

497 
	`´štk
("\n");

498 
´ev_now
 = 
now
;

499 
cu¼’t
->
´št_couÁdown
--;

502 #ifdeà
ENABLE_PER_CACHE_PT


503 
shadow_ü3
 = (
	`vœt_to_mâ
(
pgd
->
±
->
shadow
[
ÿche_now
]è<< 
PAGE_SHIFT
);

505 
	`´št_±
(
pgd
->
±
);

506 
l3_pg’Œy_t
 *
va
 = 
pgd
->
±
->
shadow
[
ÿche_now
];

507 
i
=0;i<512;i++) {

508 ià(
va
[
i
].
l3
)

509 
	`my´štk
("%d:%lx .. ", 
i
, 
	`l3e_g‘_š‹
(
va
[i]));

512 #ifdeà
ENABLE_REGIONING2


513 ià(
pgd
->
cu¼’t_»giÚ
 &&…gd->
»giÚšg_ıu
 =ğ
	`smp_´oûssÜ_id
()) {

514 
shadow_ü3
 = (
	`vœt_to_mâ
(
pgd
->
±
->
»giÚšg_shadow
è<< 
PAGE_SHIFT
);

516 
	`»giÚšg_»sume
(
pgd
, 
CLOCK_EVENT_NEW_CR3
);

520 
	`©omic_dec
(&
mši_¶aû
[3]);

521 
	`©omic_dec
(&
mši_couÁ
);

522  
shadow_ü3
;

523 
	}
}

	@physdev.c

2 
	~<x’/cÚfig.h
>

3 
	~<x’/š™.h
>

4 
	~<x’/lib.h
>

5 
	~<x’/ty³s.h
>

6 
	~<x’/sched.h
>

7 
	~<x’/œq.h
>

8 
	~<x’/ev’t.h
>

9 
	~<x’/gue¡_acûss.h
>

10 
	~<x’/ioÿp.h
>

11 
	~<asm/cu¼’t.h
>

12 
	~<asm/msi.h
>

13 
	~<asm/hy³rÿÎ.h
>

14 
	~<public/x’.h
>

15 
	~<public/physdev.h
>

16 
	~<xsm/xsm.h
>

17 
	~<asm/p2m.h
>

19 #iâdeà
COMPAT


20 
	t»t_t
;

24 
ißpic_gue¡_»ad
(

25 
physba£
, 
»g
, 
u32
 *
pv®
);

27 
ißpic_gue¡_wr™e
(

28 
physba£
, 
»g
, 
u32
 
pv®
);

30 
	$physdev_hvm_m­_pœq
(

31 
domaš
 *
d
, 
physdev_m­_pœq
 *
m­
)

33 
pœq
, 
»t
 = 0;

35 
	`¥š_lock
(&
d
->
ev’t_lock
);

36  
m­
->
ty³
 )

38 
MAP_PIRQ_TYPE_GSI
: {

39 
hvm_œq_dpci
 *hvm_irq_dpci;

40 
hvm_gœq_dpci_m­pšg
 *
gœq
;

41 
ušt32_t
 
machše_gsi
 = 0;

45 
hvm_œq_dpci
 = 
	`domaš_g‘_œq_dpci
(
d
);

46 iàĞ
hvm_œq_dpci
 )

48 
	`li¡_fÜ_—ch_’Œy
 ( 
gœq
,

49 &
hvm_œq_dpci
->
gœq
[
m­
->
šdex
],

50 
li¡
 )

51 
machše_gsi
 = 
gœq
->machine_gsi;

54 iàĞ
machše_gsi
 )

56 
m­
->
šdex
 = 
	`domaš_pœq_to_œq
(
d
, 
machše_gsi
);

57 
pœq
 = 
machše_gsi
;

58 
»t
 = (
pœq
 > 0) ? 0 :…irq;

64 
pœq
 = 
m­
->pirq;

65 iàĞ
pœq
 < 0 )

66 
pœq
 = 
	`g‘_ä“_pœq
(
d
, 
m­
->
ty³
, m­->
šdex
);

67 
»t
 = 
	`m­_domaš_emuœq_pœq
(
d
, 
pœq
, 
m­
->
šdex
);

69 
m­
->
pœq
 =…irq;

74 
»t
 = -
EINVAL
;

75 
	`d´štk
(
XENLOG_G_WARNING
, "m­y³ %d‚Ù suµÜ‹d y‘\n", 
m­
->
ty³
);

79 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

80  
»t
;

81 
	}
}

83 
	$physdev_m­_pœq
(
physdev_m­_pœq
 *
m­
)

85 
domaš
 *
d
;

86 
pœq
, 
œq
, 
»t
 = 0;

87 
msi_šfo
 
_msi
;

88 *
m­_d©a
 = 
NULL
;

90 
»t
 = 
	`rcu_lock_rg‘_domaš_by_id
(
m­
->
domid
, &
d
);

91 iàĞ
»t
 )

92  
»t
;

94 iàĞ
m­
->
domid
 =ğ
DOMID_SELF
 && 
	`is_hvm_domaš
(
d
) )

96 
»t
 = 
	`physdev_hvm_m­_pœq
(
d
, 
m­
);

97 
ä“_domaš
;

100 iàĞ!
	`IS_PRIV_FOR
(
cu¼’t
->
domaš
, 
d
) )

102 
»t
 = -
EPERM
;

103 
ä“_domaš
;

107  
m­
->
ty³
 )

109 
MAP_PIRQ_TYPE_GSI
:

110 iàĞ
m­
->
šdex
 < 0 || m­->šdex >ğ
Ä_œqs_gsi
 )

112 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: map invalid irq %d\n",

113 
d
->
domaš_id
, 
m­
->
šdex
);

114 
»t
 = -
EINVAL
;

115 
ä“_domaš
;

118 
œq
 = 
	`domaš_pœq_to_œq
(
cu¼’t
->
domaš
, 
m­
->
šdex
);

119 iàĞ
œq
 <= 0 )

121 iàĞ
	`IS_PRIV
(
cu¼’t
->
domaš
) )

122 
œq
 = 
m­
->
šdex
;

124 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: map…irq with incorrect irq!\n",

125 
d
->
domaš_id
);

126 
»t
 = -
EINVAL
;

127 
ä“_domaš
;

132 
MAP_PIRQ_TYPE_MSI
:

133 
œq
 = 
m­
->
šdex
;

134 iàĞ
œq
 == -1 )

135 
œq
 = 
	`ü—‹_œq
();

137 iàĞ
œq
 < 0 || irq >ğ
Ä_œqs
 )

139 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: can't create irq for msi!\n",

140 
d
->
domaš_id
);

141 
»t
 = -
EINVAL
;

142 
ä“_domaš
;

145 
_msi
.
bus
 = 
m­
->bus;

146 
_msi
.
devâ
 = 
m­
->devfn;

147 
_msi
.
’Œy_Ä
 = 
m­
->entry_nr;

148 
_msi
.
bË_ba£
 = 
m­
->table_base;

149 
_msi
.
œq
 = irq;

150 
m­_d©a
 = &
_msi
;

154 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: wrong map_pirqype %x\n",

155 
d
->
domaš_id
, 
m­
->
ty³
);

156 
»t
 = -
EINVAL
;

157 
ä“_domaš
;

160 
	`¥š_lock
(&
pcidevs_lock
);

162 
	`¥š_lock
(&
d
->
ev’t_lock
);

163 
pœq
 = 
	`domaš_œq_to_pœq
(
d
, 
œq
);

164 iàĞ
m­
->
pœq
 < 0 )

166 iàĞ
pœq
 )

168 
	`d´štk
(
XENLOG_G_ERR
, "dom%d: %d:%d‡lready mappedo %d\n",

169 
d
->
domaš_id
, 
m­
->
šdex
, m­->
pœq
,

170 
pœq
);

171 iàĞ
pœq
 < 0 )

173 
»t
 = -
EBUSY
;

174 
dÚe
;

179 
pœq
 = 
	`g‘_ä“_pœq
(
d
, 
m­
->
ty³
, m­->
šdex
);

180 iàĞ
pœq
 < 0 )

182 
	`d´štk
(
XENLOG_G_ERR
, "dom%d:‚Øä“…œq\n", 
d
->
domaš_id
);

183 
»t
 = 
pœq
;

184 
dÚe
;

190 iàĞ
pœq
 &&…œq !ğ
m­
->pirq )

192 
	`d´štk
(
XENLOG_G_ERR
, "dom%d:…irq %d conflicts with irq %d\n",

193 
d
->
domaš_id
, 
m­
->
šdex
, m­->
pœq
);

194 
»t
 = -
EEXIST
;

195 
dÚe
;

198 
pœq
 = 
m­
->pirq;

201 
»t
 = 
	`m­_domaš_pœq
(
d
, 
pœq
, 
œq
, 
m­
->
ty³
, 
m­_d©a
);

202 iàĞ
»t
 == 0 )

203 
m­
->
pœq
 =…irq;

205 iàĞ!
»t
 && 
	`is_hvm_domaš
(
d
) )

206 
	`m­_domaš_emuœq_pœq
(
d
, 
pœq
, 
IRQ_PT
);

208 
dÚe
:

209 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

210 
	`¥š_uÆock
(&
pcidevs_lock
);

211 iàĞ(
»t
 !ğ0è&& (
m­
->
ty³
 =ğ
MAP_PIRQ_TYPE_MSI
è&& (m­->
šdex
 == -1) )

212 
	`de¡roy_œq
(
œq
);

213 
ä“_domaš
:

214 
	`rcu_uÆock_domaš
(
d
);

215  
»t
;

216 
	}
}

218 
	$physdev_unm­_pœq
(
physdev_unm­_pœq
 *
unm­
)

220 
domaš
 *
d
;

221 
»t
;

223 
»t
 = 
	`rcu_lock_rg‘_domaš_by_id
(
unm­
->
domid
, &
d
);

224 iàĞ
»t
 )

225  
»t
;

227 iàĞ
	`is_hvm_domaš
(
d
) )

229 
	`¥š_lock
(&
d
->
ev’t_lock
);

230 
»t
 = 
	`unm­_domaš_pœq_emuœq
(
d
, 
unm­
->
pœq
);

231 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

232 iàĞ
unm­
->
domid
 =ğ
DOMID_SELF
 || 
»t
 )

233 
ä“_domaš
;

236 
»t
 = -
EPERM
;

237 iàĞ!
	`IS_PRIV_FOR
(
cu¼’t
->
domaš
, 
d
) )

238 
ä“_domaš
;

240 
	`¥š_lock
(&
pcidevs_lock
);

241 
	`¥š_lock
(&
d
->
ev’t_lock
);

242 
»t
 = 
	`unm­_domaš_pœq
(
d
, 
unm­
->
pœq
);

243 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

244 
	`¥š_uÆock
(&
pcidevs_lock
);

246 
ä“_domaš
:

247 
	`rcu_uÆock_domaš
(
d
);

248  
»t
;

249 
	}
}

251 
»t_t
 
do_physdev_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

253 
œq
;

254 
»t_t
 
»t
;

255 
vıu
 *
v
 = 
cu¼’t
;

257  
cmd
 )

259 
PHYSDEVOP_eoi
: {

260 
physdev_eoi
 
eoi
;

261 
»t
 = -
EFAULT
;

262 iàĞ
	`cİy_äom_gue¡
(&
eoi
, 
¬g
, 1) != 0 )

264 
»t
 = -
EINVAL
;

265 iàĞ
eoi
.
œq
 >ğ
v
->
domaš
->
Ä_pœqs
 )

267 iàĞ
v
->
domaš
->
¬ch
.
pœq_eoi_m­
 )

268 
	`evtchn_unmask
(
v
->
domaš
->
pœq_to_evtchn
[
eoi
.
œq
]);

269 iàĞ!
	`is_hvm_domaš
(
v
->
domaš
) ||

270 
	`domaš_pœq_to_emuœq
(
v
->
domaš
, 
eoi
.
œq
è=ğ
IRQ_PT
 )

271 
»t
 = 
	`pœq_gue¡_eoi
(
v
->
domaš
, 
eoi
.
œq
);

273 
»t
 = 0;

277 
PHYSDEVOP_pœq_eoi_gmâ
: {

278 
physdev_pœq_eoi_gmâ
 
šfo
;

279 
mâ
;

281 
»t
 = -
EFAULT
;

282 iàĞ
	`cİy_äom_gue¡
(&
šfo
, 
¬g
, 1) != 0 )

285 
»t
 = -
EINVAL
;

286 
mâ
 = 
	`gmâ_to_mâ
(
cu¼’t
->
domaš
, 
šfo
.
gmâ
);

287 iàĞ!
	`mâ_v®id
(
mâ
) ||

288 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
v
->
domaš
,

289 
PGT_wr™abË_·ge
) )

292 iàĞ
	`cmpxchg
(&
v
->
domaš
->
¬ch
.
pœq_eoi_m­_mâ
, 0, 
mâ
) != 0 )

294 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

295 
»t
 = -
EBUSY
;

299 
v
->
domaš
->
¬ch
.
pœq_eoi_m­
 = 
	`m­_domaš_·ge_glob®
(
mâ
);

300 iàĞ
v
->
domaš
->
¬ch
.
pœq_eoi_m­
 =ğ
NULL
 )

302 
v
->
domaš
->
¬ch
.
pœq_eoi_m­_mâ
 = 0;

303 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

304 
»t
 = -
ENOSPC
;

308 
»t
 = 0;

313 
PHYSDEVOP_IRQ_UNMASK_NOTIFY
: {

314 
»t
 = 
	`pœq_gue¡_unmask
(
v
->
domaš
);

318 
PHYSDEVOP_œq_¡©us_qu”y
: {

319 
physdev_œq_¡©us_qu”y
 
œq_¡©us_qu”y
;

320 
»t
 = -
EFAULT
;

321 iàĞ
	`cİy_äom_gue¡
(&
œq_¡©us_qu”y
, 
¬g
, 1) != 0 )

323 
œq
 = 
œq_¡©us_qu”y
.irq;

324 
»t
 = -
EINVAL
;

325 iàĞ(
œq
 < 0è|| (œq >ğ
v
->
domaš
->
Ä_pœqs
) )

327 
œq_¡©us_qu”y
.
æags
 = 0;

328 iàĞ
	`is_hvm_domaš
(
v
->
domaš
) &&

329 
	`domaš_pœq_to_emuœq
(
v
->
domaš
, 
œq
è!ğ
IRQ_PT
 )

331 
»t
 = 
	`cİy_to_gue¡
(
¬g
, &
œq_¡©us_qu”y
, 1è? -
EFAULT
 : 0;

343 
œq_¡©us_qu”y
.
æags
 |ğ
XENIRQSTAT_Ãeds_eoi
;

344 iàĞ
	`pœq_sh¬ed
(
v
->
domaš
, 
œq
) )

345 
œq_¡©us_qu”y
.
æags
 |ğ
XENIRQSTAT_sh¬ed
;

346 
»t
 = 
	`cİy_to_gue¡
(
¬g
, &
œq_¡©us_qu”y
, 1è? -
EFAULT
 : 0;

350 
PHYSDEVOP_m­_pœq
: {

351 
physdev_m­_pœq
 
m­
;

353 
»t
 = -
EFAULT
;

354 iàĞ
	`cİy_äom_gue¡
(&
m­
, 
¬g
, 1) != 0 )

357 
»t
 = 
	`physdev_m­_pœq
(&
m­
);

359 iàĞ
	`cİy_to_gue¡
(
¬g
, &
m­
, 1) != 0 )

360 
»t
 = -
EFAULT
;

364 
PHYSDEVOP_unm­_pœq
: {

365 
physdev_unm­_pœq
 
unm­
;

367 
»t
 = -
EFAULT
;

368 iàĞ
	`cİy_äom_gue¡
(&
unm­
, 
¬g
, 1) != 0 )

371 
»t
 = 
	`physdev_unm­_pœq
(&
unm­
);

375 
PHYSDEVOP_­ic_»ad
: {

376 
physdev_­ic
 
­ic
;

377 
»t
 = -
EFAULT
;

378 iàĞ
	`cİy_äom_gue¡
(&
­ic
, 
¬g
, 1) != 0 )

380 
»t
 = -
EPERM
;

381 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

383 
»t
 = 
	`xsm_­ic
(
v
->
domaš
, 
cmd
);

384 iàĞ
»t
 )

386 
»t
 = 
	`ißpic_gue¡_»ad
(
­ic
.
­ic_physba£
,‡pic.
»g
, &­ic.
v®ue
);

387 iàĞ
	`cİy_to_gue¡
(
¬g
, &
­ic
, 1) != 0 )

388 
»t
 = -
EFAULT
;

392 
PHYSDEVOP_­ic_wr™e
: {

393 
physdev_­ic
 
­ic
;

394 
»t
 = -
EFAULT
;

395 iàĞ
	`cİy_äom_gue¡
(&
­ic
, 
¬g
, 1) != 0 )

397 
»t
 = -
EPERM
;

398 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

400 
»t
 = 
	`xsm_­ic
(
v
->
domaš
, 
cmd
);

401 iàĞ
»t
 )

403 
»t
 = 
	`ißpic_gue¡_wr™e
(
­ic
.
­ic_physba£
,‡pic.
»g
,‡pic.
v®ue
);

407 
PHYSDEVOP_®loc_œq_veùÜ
: {

408 
physdev_œq
 
œq_İ
;

410 
»t
 = -
EFAULT
;

411 iàĞ
	`cİy_äom_gue¡
(&
œq_İ
, 
¬g
, 1) != 0 )

414 
»t
 = -
EPERM
;

415 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

418 
»t
 = 
	`xsm_assign_veùÜ
(
v
->
domaš
, 
œq_İ
.
œq
);

419 iàĞ
»t
 )

426 
œq_İ
.
veùÜ
 = irq_İ.
œq
;

427 
»t
 = 0;

429 iàĞ
	`cİy_to_gue¡
(
¬g
, &
œq_İ
, 1) != 0 )

430 
»t
 = -
EFAULT
;

434 
PHYSDEVOP_£t_iİl
: {

435 
physdev_£t_iİl
 
£t_iİl
;

436 
»t
 = -
EFAULT
;

437 iàĞ
	`cİy_äom_gue¡
(&
£t_iİl
, 
¬g
, 1) != 0 )

439 
»t
 = -
EINVAL
;

440 iàĞ
£t_iİl
.
iİl
 > 3 )

442 
»t
 = 0;

443 
v
->
¬ch
.
iİl
 = 
£t_iİl
.iopl;

447 
PHYSDEVOP_£t_iob™m­
: {

448 
physdev_£t_iob™m­
 
£t_iob™m­
;

449 
»t
 = -
EFAULT
;

450 iàĞ
	`cİy_äom_gue¡
(&
£t_iob™m­
, 
¬g
, 1) != 0 )

452 
»t
 = -
EINVAL
;

453 iàĞ!
	`gue¡_hªdË_okay
(
£t_iob™m­
.
b™m­
, 
IOBMP_BYTES
) ||

454 (
£t_iob™m­
.
Ä_pÜts
 > 65536) )

456 
»t
 = 0;

457 #iâdeà
COMPAT


458 
v
->
¬ch
.
iobmp
 = 
£t_iob™m­
.
b™m­
;

460 
	`gue¡_äom_com·t_hªdË
(
v
->
¬ch
.
iobmp
, 
£t_iob™m­
.
b™m­
);

462 
v
->
¬ch
.
iobmp_lim™
 = 
£t_iob™m­
.
Ä_pÜts
;

466 
PHYSDEVOP_mªage_pci_add
: {

467 
physdev_mªage_pci
 
mªage_pci
;

468 
»t
 = -
EPERM
;

469 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

471 
»t
 = -
EFAULT
;

472 iàĞ
	`cİy_äom_gue¡
(&
mªage_pci
, 
¬g
, 1) != 0 )

475 
»t
 = 
	`pci_add_deviû
(
mªage_pci
.
bus
, mªage_pci.
devâ
);

479 
PHYSDEVOP_mªage_pci_»move
: {

480 
physdev_mªage_pci
 
mªage_pci
;

481 
»t
 = -
EPERM
;

482 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

484 
»t
 = -
EFAULT
;

485 iàĞ
	`cİy_äom_gue¡
(&
mªage_pci
, 
¬g
, 1) != 0 )

488 
»t
 = 
	`pci_»move_deviû
(
mªage_pci
.
bus
, mªage_pci.
devâ
);

492 
PHYSDEVOP_mªage_pci_add_ext
: {

493 
physdev_mªage_pci_ext
 
mªage_pci_ext
;

494 
pci_dev_šfo
 
pdev_šfo
;

496 
»t
 = -
EPERM
;

497 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) )

500 
»t
 = -
EFAULT
;

501 iàĞ
	`cİy_äom_gue¡
(&
mªage_pci_ext
, 
¬g
, 1) != 0 )

504 
»t
 = -
EINVAL
;

505 iàĞ(
mªage_pci_ext
.
is_extâ
 > 1è|| (mªage_pci_ext.
is_vœtâ
 > 1) )

508 
pdev_šfo
.
is_extâ
 = 
mªage_pci_ext
.is_extfn;

509 
pdev_šfo
.
is_vœtâ
 = 
mªage_pci_ext
.is_virtfn;

510 
pdev_šfo
.
physâ
.
bus
 = 
mªage_pci_ext
.physfn.bus;

511 
pdev_šfo
.
physâ
.
devâ
 = 
mªage_pci_ext
.physfn.devfn;

512 
»t
 = 
	`pci_add_deviû_ext
(
mªage_pci_ext
.
bus
,

513 
mªage_pci_ext
.
devâ
,

514 &
pdev_šfo
);

518 
PHYSDEVOP_»¡Üe_msi
: {

519 
physdev_»¡Üe_msi
 
»¡Üe_msi
;

520 
pci_dev
 *
pdev
;

522 
»t
 = -
EPERM
;

523 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

526 
»t
 = -
EFAULT
;

527 iàĞ
	`cİy_äom_gue¡
(&
»¡Üe_msi
, 
¬g
, 1) != 0 )

530 
	`¥š_lock
(&
pcidevs_lock
);

531 
pdev
 = 
	`pci_g‘_pdev
(
»¡Üe_msi
.
bus
,„e¡Üe_msi.
devâ
);

532 
»t
 = 
pdev
 ? 
	`pci_»¡Üe_msi_¡©e
Õdevè: -
ENODEV
;

533 
	`¥š_uÆock
(&
pcidevs_lock
);

536 
PHYSDEVOP_£tup_gsi
: {

537 
physdev_£tup_gsi
 
£tup_gsi
;

539 
»t
 = -
EPERM
;

540 iàĞ!
	`IS_PRIV
(
v
->
domaš
) )

543 
»t
 = -
EFAULT
;

544 iàĞ
	`cİy_äom_gue¡
(&
£tup_gsi
, 
¬g
, 1) != 0 )

547 
»t
 = -
EINVAL
;

548 iàĞ
£tup_gsi
.
gsi
 < 0 || s‘up_gsi.gs˜>ğ
Ä_œqs_gsi
 )

550 
»t
 = 
	`mp_»gi¡”_gsi
(
£tup_gsi
.
gsi
, s‘up_gsi.
Œigg”šg
,

551 
£tup_gsi
.
pŞ¬™y
);

554 
PHYSDEVOP_g‘_ä“_pœq
: {

555 
physdev_g‘_ä“_pœq
 
out
;

556 
domaš
 *
d
;

558 
d
 = 
	`rcu_lock_cu¼’t_domaš
();

560 
»t
 = -
EFAULT
;

561 iàĞ
	`cİy_äom_gue¡
(&
out
, 
¬g
, 1) != 0 )

564 
	`¥š_lock
(&
d
->
ev’t_lock
);

565 
out
.
pœq
 = 
	`g‘_ä“_pœq
(
d
, out.
ty³
, 0);

566 
d
->
¬ch
.
pœq_œq
[
out
.
pœq
] = 
PIRQ_ALLOCATED
;

567 
	`¥š_uÆock
(&
d
->
ev’t_lock
);

569 
»t
 = 
	`cİy_to_gue¡
(
¬g
, &
out
, 1è? -
EFAULT
 : 0;

571 
	`rcu_uÆock_domaš
(
d
);

575 
»t
 = -
ENOSYS
;

579  
»t
;

580 
	}
}

	@platform_hypercall.c

9 
	~<x’/cÚfig.h
>

10 
	~<x’/ty³s.h
>

11 
	~<x’/lib.h
>

12 
	~<x’/mm.h
>

13 
	~<x’/sched.h
>

14 
	~<x’/domaš.h
>

15 
	~<x’/ev’t.h
>

16 
	~<x’/domaš_·ge.h
>

17 
	~<x’/Œaû.h
>

18 
	~<x’/cÚsŞe.h
>

19 
	~<x’/ioÿp.h
>

20 
	~<x’/gue¡_acûss.h
>

21 
	~<x’/aıi.h
>

22 
	~<x’/ıu.h
>

23 
	~<asm/cu¼’t.h
>

24 
	~<public/¶©fÜm.h
>

25 
	~<aıi/ıuäeq/´oûssÜ_³rf.h
>

26 
	~<asm/edd.h
>

27 
	~<asm/mŒr.h
>

28 
	~<asm/io_­ic.h
>

29 
	~"ıu/mŒr/mŒr.h
"

30 
	~<xsm/xsm.h
>

32 
ušt16_t
 
boÙ_edid_ÿps
;

33 
ušt8_t
 
boÙ_edid_šfo
[];

35 #iâdeà
COMPAT


36 
	t»t_t
;

37 
DEFINE_SPINLOCK
(
x’pf_lock
);

38 #undeà
cİy_äom_com·t


39 
	#cİy_äom_com·t
 
cİy_äom_gue¡


	)

40 #undeà
cİy_to_com·t


41 
	#cİy_to_com·t
 
cİy_to_gue¡


	)

42 #undeà
gue¡_äom_com·t_hªdË


43 
	#gue¡_äom_com·t_hªdË
(
x
,
y
è((x)=(y))

	)

45 
¥šlock_t
 
x’pf_lock
;

48 
DEFINE_PER_CPU
(
ušt64_t
, 
äeq
);

50 
£t_px_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_³rfÜmªû
 *
³rf
);

51 
£t_cx_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_pow”
 *
pow”
);

53 
	$ıu_äequ’cy_chªge_h–³r
(*
d©a
)

55  
	`ıu_äequ’cy_chªge
(
	`this_ıu
(
äeq
));

56 
	}
}

59 
ıu_up_h–³r
(*
d©a
);

60 
ıu_down_h–³r
(*
d©a
);

62 
»t_t
 
do_¶©fÜm_İ
(
	$XEN_GUEST_HANDLE
(
x’_¶©fÜm_İ_t
è
u_x’pf_İ
)

64 
»t_t
 
»t
 = 0;

65 
x’_¶©fÜm_İ
 
curİ
, *
İ
 = &curop;

67 iàĞ!
	`IS_PRIV
(
cu¼’t
->
domaš
) )

68  -
EPERM
;

70 iàĞ
	`cİy_äom_gue¡
(
İ
, 
u_x’pf_İ
, 1) )

71  -
EFAULT
;

73 iàĞ
İ
->
š‹rçû_v”siÚ
 !ğ
XENPF_INTERFACE_VERSION
 )

74  -
EACCES
;

81  !
	`¥š_Œylock
(&
x’pf_lock
) )

82 iàĞ
	`hy³rÿÎ_´“m±_check
() )

83  
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

84 
__HYPERVISOR_¶©fÜm_İ
, "h", 
u_x’pf_İ
);

86  
İ
->
cmd
 )

88 
XENPF_£‰ime
:

90 
»t
 = 
	`xsm_x’_£‰ime
();

91 iàĞ
»t
 )

94 
	`do_£‰ime
(
İ
->
u
.
£‰ime
.
£cs
,

95 
İ
->
u
.
£‰ime
.
n£cs
,

96 
İ
->
u
.
£‰ime
.
sy¡em_time
);

97 
»t
 = 0;

101 
XENPF_add_memty³
:

103 
»t
 = 
	`xsm_memty³
(
İ
->
cmd
);

104 iàĞ
»t
 )

107 
»t
 = 
	`mŒr_add_·ge
(

108 
İ
->
u
.
add_memty³
.
mâ
,

109 
İ
->
u
.
add_memty³
.
Ä_mâs
,

110 
İ
->
u
.
add_memty³
.
ty³
,

112 iàĞ
»t
 >= 0 )

114 
İ
->
u
.
add_memty³
.
hªdË
 = 0;

115 
İ
->
u
.
add_memty³
.
»g
 = 
»t
;

116 
»t
 = 
	`cİy_to_gue¡
(
u_x’pf_İ
, 
İ
, 1è? -
EFAULT
 : 0;

117 iàĞ
»t
 != 0 )

118 
	`mŒr_d–_·ge
(
»t
, 0, 0);

123 
XENPF_d–_memty³
:

125 
»t
 = 
	`xsm_memty³
(
İ
->
cmd
);

126 iàĞ
»t
 )

129 ià(
İ
->
u
.
d–_memty³
.
hªdË
 == 0

131 && ()
İ
->
u
.
d–_memty³
.
»g
 >= 0)

133 
»t
 = 
	`mŒr_d–_·ge
(
İ
->
u
.
d–_memty³
.
»g
, 0, 0);

134 iàĞ
»t
 > 0 )

135 
»t
 = 0;

138 
»t
 = -
EINVAL
;

142 
XENPF_»ad_memty³
:

144 
mâ
, 
Ä_mâs
;

145 
mŒr_ty³
 
ty³
;

147 
»t
 = 
	`xsm_memty³
(
İ
->
cmd
);

148 iàĞ
»t
 )

151 
»t
 = -
EINVAL
;

152 iàĞ
İ
->
u
.
»ad_memty³
.
»g
 < 
num_v¬_¿nges
 )

154 
mŒr_if
->
	`g‘
(
İ
->
u
.
»ad_memty³
.
»g
, &
mâ
, &
Ä_mâs
, &
ty³
);

155 
İ
->
u
.
»ad_memty³
.
mâ
 = mfn;

156 
İ
->
u
.
»ad_memty³
.
Ä_mâs
 =‚r_mfns;

157 
İ
->
u
.
»ad_memty³
.
ty³
 =ype;

158 
»t
 = 
	`cİy_to_gue¡
(
u_x’pf_İ
, 
İ
, 1è? -
EFAULT
 : 0;

163 
XENPF_miüocode_upd©e
:

165 
	`XEN_GUEST_HANDLE
(
cÚ¡_void
è
d©a
;

167 
»t
 = 
	`xsm_miüocode
();

168 iàĞ
»t
 )

171 
	`gue¡_äom_com·t_hªdË
(
d©a
, 
İ
->
u
.
miüocode
.data);

172 
»t
 = 
	`miüocode_upd©e
(
d©a
, 
İ
->
u
.
miüocode
.
Ëngth
);

176 
XENPF_¶©fÜm_quœk
:

178 
quœk_id
 = 
İ
->
u
.
¶©fÜm_quœk
.quirk_id;

180 
»t
 = 
	`xsm_¶©fÜm_quœk
(
quœk_id
);

181 iàĞ
»t
 )

184  
quœk_id
 )

186 
QUIRK_NOIRQBALANCING
:

187 
	`´štk
("Platform quirk -- Disabling IRQ balancing/affinity.\n");

188 
İt_noœqb®ªû
 = 1;

189 
	`£tup_ißpic_de¡
();

191 
QUIRK_IOAPIC_BAD_REGSEL
:

192 
QUIRK_IOAPIC_GOOD_REGSEL
:

193 #iâdeà
sis_­ic_bug


194 
sis_­ic_bug
 = (
quœk_id
 =ğ
QUIRK_IOAPIC_BAD_REGSEL
);

195 
	`d´štk
(
XENLOG_INFO
, "Domain 0 sayshat IO-APIC REGSEL is %s\n",

196 
sis_­ic_bug
 ? "bad" : "good");

198 iàĞ
sis_­ic_bug
 !ğ(
quœk_id
 =ğ
QUIRK_IOAPIC_BAD_REGSEL
) )

199 
	`d´štk
(
XENLOG_WARNING
,

201 
sis_­ic_bug
 ? "good" : "bad");

205 
»t
 = -
EINVAL
;

211 
XENPF_fœmw¬e_šfo
:

212 
»t
 = 
	`xsm_fœmw¬e_šfo
();

213 iàĞ
»t
 )

216  
İ
->
u
.
fœmw¬e_šfo
.
ty³
 )

218 
XEN_FW_DISK_INFO
: {

219 cÚ¡ 
edd_šfo
 *
šfo
;

220 
u16
 
Ëngth
;

222 
»t
 = -
ESRCH
;

223 iàĞ
İ
->
u
.
fœmw¬e_šfo
.
šdex
 >ğ
	`boÙsym
(
boÙ_edd_šfo_Ä
) )

226 
šfo
 = 
	`boÙsym
(
boÙ_edd_šfo
è+ 
İ
->
u
.
fœmw¬e_šfo
.
šdex
;

229 
»t
 = -
EFAULT
;

230 iàĞ
	`cİy_äom_com·t
(&
Ëngth
, 
İ
->
u
.
fœmw¬e_šfo
.u.

231 
disk_šfo
.
edd_·¿ms
, 1) )

233 iàĞ
Ëngth
 > 
šfo
->
edd_deviû_·¿ms
.length )

234 
Ëngth
 = 
šfo
->
edd_deviû_·¿ms
.length;

235 iàĞ
	`cİy_to_com·t
(
İ
->
u
.
fœmw¬e_šfo
.u.
disk_šfo
.
edd_·¿ms
,

236 (
u8
 *)&
šfo
->
edd_deviû_·¿ms
,

237 
Ëngth
) )

239 iàĞ
	`cİy_to_com·t
(
İ
->
u
.
fœmw¬e_šfo
.u.
disk_šfo
.
edd_·¿ms
,

240 &
Ëngth
, 1) )

244 
	#C
(
x
è
İ
->
u
.
fœmw¬e_šfo
.u.
disk_šfo
.x = 
šfo
->
	)
x

245 
	`C
(
deviû
);

246 
	`C
(
v”siÚ
);

247 
	`C
(
š‹rçû_suµÜt
);

248 
	`C
(
Ëgacy_max_cylšd”
);

249 
	`C
(
Ëgacy_max_h—d
);

250 
	`C
(
Ëgacy_£ùÜs_³r_Œack
);

251 #undeà
C


253 
»t
 = (
	`cİy_f›ld_to_gue¡
(
u_x’pf_İ
, 
İ
,

254 
u
.
fœmw¬e_šfo
.u.
disk_šfo
)

255 ? -
EFAULT
 : 0);

258 
XEN_FW_DISK_MBR_SIGNATURE
: {

259 cÚ¡ 
mbr_sigÇtu»
 *
sig
;

261 
»t
 = -
ESRCH
;

262 iàĞ
İ
->
u
.
fœmw¬e_šfo
.
šdex
 >ğ
	`boÙsym
(
boÙ_mbr_sigÇtu»_Ä
) )

265 
sig
 = 
	`boÙsym
(
boÙ_mbr_sigÇtu»
è+ 
İ
->
u
.
fœmw¬e_šfo
.
šdex
;

267 
İ
->
u
.
fœmw¬e_šfo
.u.
disk_mbr_sigÇtu»
.
deviû
 = 
sig
->device;

268 
İ
->
u
.
fœmw¬e_šfo
.u.
disk_mbr_sigÇtu»
.
mbr_sigÇtu»
 =

269 
sig
->
sigÇtu»
;

271 
»t
 = (
	`cİy_f›ld_to_gue¡
(
u_x’pf_İ
, 
İ
,

272 
u
.
fœmw¬e_šfo
.u.
disk_mbr_sigÇtu»
)

273 ? -
EFAULT
 : 0);

276 
XEN_FW_VBEDDC_INFO
:

277 
»t
 = -
ESRCH
;

278 iàĞ
İ
->
u
.
fœmw¬e_šfo
.
šdex
 != 0 )

280 iàĞ*(
u32
 *)
	`boÙsym
(
boÙ_edid_šfo
) == 0x13131313 )

283 
İ
->
u
.
fœmw¬e_šfo
.u.
vbeddc_šfo
.
ÿ·b™›s
 =

284 
	`boÙsym
(
boÙ_edid_ÿps
);

285 
İ
->
u
.
fœmw¬e_šfo
.u.
vbeddc_šfo
.
edid_Œªsãr_time
 =

286 
	`boÙsym
(
boÙ_edid_ÿps
) >> 8;

288 
»t
 = 0;

289 iàĞ
	`cİy_f›ld_to_gue¡
(
u_x’pf_İ
, 
İ
, 
u
.
fœmw¬e_šfo
.

290 
u
.
vbeddc_šfo
.
ÿ·b™›s
) ||

291 
	`cİy_f›ld_to_gue¡
(
u_x’pf_İ
, 
İ
, 
u
.
fœmw¬e_šfo
.

292 
u
.
vbeddc_šfo
.
edid_Œªsãr_time
) ||

293 
	`cİy_to_com·t
(
İ
->
u
.
fœmw¬e_šfo
.u.
vbeddc_šfo
.
edid
,

294 
	`boÙsym
(
boÙ_edid_šfo
), 128) )

295 
»t
 = -
EFAULT
;

298 
»t
 = -
EINVAL
;

303 
XENPF_’‹r_aıi_¦“p
:

304 
»t
 = 
	`xsm_aıi_¦“p
();

305 iàĞ
»t
 )

308 
»t
 = 
	`aıi_’‹r_¦“p
(&
İ
->
u
.
’‹r_aıi_¦“p
);

311 
XENPF_chªge_äeq
:

312 
»t
 = 
	`xsm_chªge_äeq
();

313 iàĞ
»t
 )

316 
»t
 = -
ENOSYS
;

317 iàĞ
ıuäeq_cÚŒŞËr
 !ğ
FREQCTL_dom0_k”Ãl
 )

319 
»t
 = -
EINVAL
;

320 iàĞ
İ
->
u
.
chªge_äeq
.
æags
 || !
	`ıu_Úlše
(İ->u.chªge_äeq.
ıu
) )

322 
	`³r_ıu
(
äeq
, 
İ
->
u
.
chªge_äeq
.
ıu
) = op->u.change_freq.freq;

323 
»t
 = 
	`cÚtšue_hy³rÿÎ_Ú_ıu
(
İ
->
u
.
chªge_äeq
.
ıu
,

324 
ıu_äequ’cy_chªge_h–³r
,

325 
NULL
);

328 
XENPF_g‘idËtime
:

330 
ušt32_t
 
ıu
;

331 
ušt64_t
 
idËtime
, 
now
 = 
	`NOW
();

332 
x’ùl_ıum­
 
ùlm­
;

333 
ıumask_t
 
ıum­
;

334 
	`XEN_GUEST_HANDLE
(
ušt8
è
ıum­_b™m­
;

335 
	`XEN_GUEST_HANDLE
(
ušt64
è
idËtimes
;

337 
»t
 = 
	`xsm_g‘idËtime
();

338 iàĞ
»t
 )

341 
»t
 = -
ENOSYS
;

342 iàĞ
ıuäeq_cÚŒŞËr
 !ğ
FREQCTL_dom0_k”Ãl
 )

345 
ùlm­
.
Ä_ıus
 = 
İ
->
u
.
g‘idËtime
.
ıum­_Ä_ıus
;

346 
	`gue¡_äom_com·t_hªdË
(
ıum­_b™m­
,

347 
İ
->
u
.
g‘idËtime
.
ıum­_b™m­
);

348 
ùlm­
.
b™m­
.
p
 = 
ıum­_b™m­
.p;

349 iàĞ(
»t
 = 
	`x’ùl_ıum­_to_ıumask
(&
ıum­
, &
ùlm­
)) != 0 )

350 
out
;

351 
	`gue¡_äom_com·t_hªdË
(
idËtimes
, 
İ
->
u
.
g‘idËtime
.
idËtime
);

353 
	`fÜ_—ch_ıu_mask
 ( 
ıu
, 
ıum­
 )

355 iàĞ
idË_vıu
[
ıu
] =ğ
NULL
 )

356 
	`ıu_ş—r
(
ıu
, 
ıum­
);

357 
idËtime
 = 
	`g‘_ıu_idË_time
(
ıu
);

359 
»t
 = -
EFAULT
;

360 iàĞ
	`cİy_to_gue¡_off£t
(
idËtimes
, 
ıu
, &
idËtime
, 1) )

361 
out
;

364 
İ
->
u
.
g‘idËtime
.
now
 =‚ow;

365 iàĞ(
»t
 = 
	`ıumask_to_x’ùl_ıum­
(&
ùlm­
, &
ıum­
)) != 0 )

366 
out
;

368 
»t
 = 
	`cİy_to_gue¡
(
u_x’pf_İ
, 
İ
, 1è? -
EFAULT
 : 0;

372 
XENPF_£t_´oûssÜ_pmšfo
:

373  
İ
->
u
.
£t_pmšfo
.
ty³
 )

375 
XEN_PM_PX
:

376 iàĞ!(
x’_´oûssÜ_pmb™s
 & 
XEN_PROCESSOR_PM_PX
) )

378 
»t
 = -
ENOSYS
;

381 
»t
 = 
	`£t_px_pmšfo
(
İ
->
u
.
£t_pmšfo
.
id
, &İ->u.£t_pmšfo.u.
³rf
);

384 
XEN_PM_CX
:

385 iàĞ!(
x’_´oûssÜ_pmb™s
 & 
XEN_PROCESSOR_PM_CX
) )

387 
»t
 = -
ENOSYS
;

390 
»t
 = 
	`£t_cx_pmšfo
(
İ
->
u
.
£t_pmšfo
.
id
, &İ->u.£t_pmšfo.u.
pow”
);

393 
XEN_PM_TX
:

394 iàĞ!(
x’_´oûssÜ_pmb™s
 & 
XEN_PROCESSOR_PM_TX
) )

396 
»t
 = -
ENOSYS
;

399 
»t
 = -
EINVAL
;

403 
»t
 = -
EINVAL
;

408 
XENPF_g‘_ıušfo
:

410 
x’pf_pıušfo
 *
g_šfo
;

412 
g_šfo
 = &
İ
->
u
.
pıu_šfo
;

414 iàĞ!
	`g‘_ıu_m­s
() )

416 
»t
 = -
EBUSY
;

420 iàĞ(
g_šfo
->
x’_ıuid
 >ğ
NR_CPUS
) ||

421 !
	`ıu_´e£Á
(
g_šfo
->
x’_ıuid
) )

423 
g_šfo
->
æags
 |ğ
XEN_PCPU_FLAGS_INVALID
;

427 
g_šfo
->
­ic_id
 = 
x86_ıu_to_­icid
[g_šfo->
x’_ıuid
];

428 
g_šfo
->
aıi_id
 = 
	`aıi_g‘_´oûssÜ_id
(g_šfo->
x’_ıuid
);

429 
	`ASSERT
(
g_šfo
->
­ic_id
 !ğ
BAD_APICID
);

430 ià(
	`ıu_Úlše
(
g_šfo
->
x’_ıuid
))

431 
g_šfo
->
æags
 |ğ
XEN_PCPU_FLAGS_ONLINE
;

434 
g_šfo
->
max_´e£Á
 = 
	`Ï¡_ıu
(
ıu_´e£Á_m­
);

436 
	`put_ıu_m­s
();

438 
»t
 = 
	`cİy_to_gue¡
(
u_x’pf_İ
, 
İ
, 1è? -
EFAULT
 : 0;

442 
XENPF_ıu_Úlše
:

444 
ıu
 = 
İ
->
u
.
ıu_Ş
.
ıuid
;

446 iàĞ!
	`ıu_´e£Á
(
ıu
) )

448 
»t
 = -
EINVAL
;

452 iàĞ
	`ıu_Úlše
(
ıu
) )

454 
»t
 = 0;

458 
»t
 = 
	`cÚtšue_hy³rÿÎ_Ú_ıu
(

459 0, 
ıu_up_h–³r
, (*)()
ıu
);

463 
XENPF_ıu_ofæše
:

465 
ıu
 = 
İ
->
u
.
ıu_Ş
.
ıuid
;

467 iàĞ!
	`ıu_´e£Á
(
ıu
) )

469 
»t
 = -
EINVAL
;

473 iàĞ!
	`ıu_Úlše
(
ıu
) )

475 
»t
 = 0;

479 
»t
 = 
	`cÚtšue_hy³rÿÎ_Ú_ıu
(

480 0, 
ıu_down_h–³r
, (*)()
ıu
);

485 
XENPF_ıu_hÙadd
:

486 
»t
 = 
	`ıu_add
(
İ
->
u
.
ıu_add
.
­ic_id
,

487 
İ
->
u
.
ıu_add
.
aıi_id
,

488 
İ
->
u
.
ıu_add
.
pxm
);

491 
XENPF_mem_hÙadd
:

492 
»t
 = 
	`memÜy_add
(
İ
->
u
.
mem_add
.
¥â
,

493 
İ
->
u
.
mem_add
.
•â
,

494 
İ
->
u
.
mem_add
.
pxm
);

497 
»t
 = -
ENOSYS
;

501 
out
:

502 
	`¥š_uÆock
(&
x’pf_lock
);

504  
»t
;

505 
	}
}

	@pt_modification.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

25 #ifdeà
ENABLE_PT_MODIFICATION


27 
	#PTR_TO_INDEX
(
X
è((()(Xè& ~
PAGE_MASK
)>>3)

	)

29 
	$l1e_upd©e_sucûss_commÚ
(
l1_pg’Œy_t
 *
¶1e
,†1_pg’Œy_ˆ
Ş1e
,†1_pg’Œy_ˆ
Æ1e
, 
g¿Á
)

31 
±šdex
, 
ªy_m¬kšg
;

32 
·ge_bË
 *
±
 = 
	`this_ıu
(
found_±
);

34 ià(!
mši_aùiv©ed
) {

35 ià(
±
)

36 
	`uÆock_±
(0);

39 ià(
±
 =ğ
NULL
) {

40 #ifdeà
VERBOSE_PAGE_TABLE_L1E_NOT_MANAGED


42 
	`´štk
("[L1]");

46 
	`MYASSERT
(!
±
->
u£r_l4
);

48 
	`MYASSERT
(
mši_aùiv©ed
);

49 
±šdex
 = 
	`PTR_TO_INDEX
(
¶1e
);

50 
	`MYASSERT
(
±šdex
 < 
L1_PAGETABLE_ENTRIES
);

52 #ifdeà
DEBUG_ASSERT


53 
va
 = 
	`g‘_va
(
±
, 
±šdex
);

57 #ifdeà
ENABLE_KERNEL_SHADOW


58 ià(
va
 >ğ
HYPERVISOR_VIRT_START
 && v¨< 
HYPERVISOR_VIRT_END
)

60 ià(
va
 >ğ
USERLAND_END
)

63 
	`my´štk
("k”ÃÈÜ x’ s·û..sk. va:%lx up_šdex[%d,%d,%d] %lx->%lx\n", 
va
, 
±
->
up_šdex
,…t->
up_±
->up_šdex,…t->up_±->up_±->up_šdex, 
Ş1e
.
l1
, 
Æ1e
.l1);

64 
	`my·nic
("l1e_update_success_common in kernel\n");

65 
	`uÆock_±
(0);

70 #ifdeà
ENABLE_MARK_VREGION


71 
ªy_m¬kšg
 = 0;

72 ià((
	`l1e_g‘_æags
(
Ş1e
è& 
_PAGE_PRESENT
è&& ((
	`l1e_g‘_pâ
(Ş1e)!ö1e_g‘_pâ(
Æ1e
)) || !(l1e_get_flags(nl1e)&_PAGE_PRESENT)) ) {

73 
	`l1e_unm¬k
(
¶1e
, 0, 
±
, 
±šdex
, 
	`l1e_g‘_pâ
(
Ş1e
));

74 
ªy_m¬kšg
 = 1;

77 ià((
	`l1e_g‘_æags
(
Æ1e
è& 
_PAGE_PRESENT
è&& ((
	`l1e_g‘_pâ
(
Ş1e
)!=l1e_get_pfn(nl1e)) || !(l1e_get_flags(ol1e)&_PAGE_PRESENT)) ) {

78 
	`l1e_m¬k
(
¶1e
, 0, 
±
, 
±šdex
 );

79 
ªy_m¬kšg
 = 1;

82 #ifdeà
ENABLE_PER_CACHE_PT


84 ià(!
ªy_m¬kšg
 && (
	`l1e_g‘_æags
(
Æ1e
)&
_PAGE_PRESENT
è&&†1e_g‘_æags(
Ş1e
) !=†1e_get_flags(nl1e)) {

85 
	`æag_shadow
(
±
, 
±šdex
, 
Æ1e
);

94 
	`uÆock_±
(0);

96 #ifdeà
VERBOSE_PAGE_TABLE_L1E_CHANGE_SUCCESS


97 
	`my´štk
("Ş1e:%x->Æ1e:%x\n", 
Ş1e
.
l1
, 
¶1e
->l1 );

101 #ifdeà
VERBOSE_CLOCK


107 
	}
}

108 
	$l2e_upd©e_sucûss
(
l2_pg’Œy_t
 *
¶2e
,†2_pg’Œy_ˆ
Ş2e
,†2_pg’Œy_ˆ
Æ2e
, 
mâ
)

110 ià(!
mši_aùiv©ed
)

112 
	`©omic_šc
(&
mši_couÁ
);

113 
	`©omic_šc
(&
mši_¶aû
[4]);

115 
·ge_bË
 *
±
;

116 
	`mâ_check
(
mâ
);

117 
	`±mª_lock
(
mâ
);

118 
±
 = 
	`±mª_fšd
(
mâ
);

119 
	`±mª_uÆock
(
mâ
);

120 ià(!
±
) {

123 
	`´štk
("[L2]");

124 
sucûss_l2_out
;

126 
	`MYASSERT
(!
±
->
u£r_l4
);

127 
±_šdex
 = 
	`PTR_TO_INDEX
(
¶2e
);

128 
	`MYASSERT
(
±_šdex
 < 
L2_PAGETABLE_ENTRIES
);

129 #ifdeà
ENABLE_PT_RECURSIVE


130 ià(
	`g‘_va
(
±
, 
±_šdex
è>ğ
USERLAND_END
 )

131 #ifdeà
ENABLE_KERNEL_SHADOW


133 
	`my·nic
("l2e_update_success in kernel\n");

136 
sucûss_l2_out
;

138 
	`MYASSERT
(
±
->
Ëv–
 == 2);

141 #ifdeà
VERBOSE_PAGE_TABLE_L2E_CHANGE_SUCCESS


142 
	`my´štk
("Ş2e:%x->Æ2e:%x\n", 
Ş2e
.
l2
, 
Æ2e
.l2 );

144 
ªy_m¬kšg
 = 0;

145 ià((
	`l2e_g‘_æags
(
Ş2e
è& 
_PAGE_PRESENT
è&& ((
	`l2e_g‘_pâ
(Ş2e)!ö2e_g‘_pâ(
Æ2e
)) || !(l2e_get_flags(nl2e)&_PAGE_PRESENT)) ) {

146 #ifdeà
ENABLE_PT_RECURSIVE


147 #ifdeà
ENABLE_PER_CACHE_PT


148 
	`d–_shadow_nÚËaf
(
±
, 
±_šdex
);

150 
	`d–_±
(
±
, 
±_šdex
 ,
	`l2e_g‘_pâ
(
Ş2e
));

151 
ªy_m¬kšg
 = 1;

155 ià((
	`l2e_g‘_æags
(
Æ2e
è& 
_PAGE_PRESENT
è&& ((
	`l2e_g‘_pâ
(
Ş2e
)!=l2e_get_pfn(nl2e)) || !(l2e_get_flags(ol2e)&_PAGE_PRESENT)) ) {

156 #ifdeà
ENABLE_PT_RECURSIVE


157 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
±_šdex
, 
	`l2e_g‘_pâ
(
Æ2e
));

158 #ifdeà
ENABLE_PER_CACHE_PT


159 
	`add_shadow_nÚËaf
(
±
, 
±_šdex
, 
Ãw±
, 
	`l2e_g‘_æags
(
Æ2e
));

161 
ªy_m¬kšg
 = 1;

164 #ifdeà
ENABLE_PT_RECURSIVE


165 ià(!
ªy_m¬kšg
 && 
	`l2e_g‘_æags
(
Ş2e
è!ğl2e_g‘_æags(
Æ2e
)) {

166 
	`my´štk
("WARN: fÏg-chªge š†2e..TODO.. %x -> %x\n", 
Ş2e
.
l2
, 
Æ2e
.l2 );

169 
sucûss_l2_out
:

172 
	`uÆock_±
(0);

173 
	`©omic_dec
(&
mši_¶aû
[4]);

174 
	`©omic_dec
(&
mši_couÁ
);

175 
	}
}

177 #ià
CONFIG_PAGING_LEVELS
 >= 3

178 
	$l3e_upd©e_sucûss
(
l3_pg’Œy_t
 *
¶3e
,†3_pg’Œy_ˆ
Ş3e
,†3_pg’Œy_ˆ
Æ3e
, 
mâ
)

180 ià(!
mši_aùiv©ed
)

182 
	`©omic_šc
(&
mši_couÁ
);

183 
	`©omic_šc
(&
mši_¶aû
[5]);

185 
·ge_bË
 *
±
;

186 
	`mâ_check
(
mâ
);

187 
	`±mª_lock
(
mâ
);

188 
±
 = 
	`±mª_fšd
(
mâ
);

189 
	`±mª_uÆock
(
mâ
);

190 ià(!
±
) {

193 
	`´štk
("[L3]");

194 
sucûss_l3_out
;

196 
	`MYASSERT
(!
±
->
u£r_l4
);

197 
±_šdex
 = 
	`PTR_TO_INDEX
(
¶3e
);

198 
	`MYASSERT
(
±_šdex
 < 
L3_PAGETABLE_ENTRIES
);

199 #ifdeà
ENABLE_PT_RECURSIVE


200 ià(
	`g‘_va
(
±
, 
±_šdex
è>ğ
USERLAND_END
 )

201 #ifdeà
ENABLE_KERNEL_SHADOW


203 
	`my·nic
("l3e_update_success in kernel\n");

206 
sucûss_l3_out
;

208 
	`MYASSERT
(
±
->
Ëv–
 == 3);

211 #ifdeà
VERBOSE_PAGE_TABLE_L3E_CHANGE_SUCCESS


212 
	`my´štk
("Ş3e:%x->Æ3e:%x\n", 
Ş3e
.
l3
, 
Æ3e
.l3 );

214 
ªy_m¬kšg
 = 0;

215 ià((
	`l3e_g‘_æags
(
Ş3e
è& 
_PAGE_PRESENT
è&& ((
	`l3e_g‘_pâ
(Ş3e)!ö3e_g‘_pâ(
Æ3e
)) || !(l3e_get_flags(nl3e)&_PAGE_PRESENT)) ) {

216 #ifdeà
ENABLE_PT_RECURSIVE


217 #ifdeà
ENABLE_PER_CACHE_PT


218 
	`d–_shadow_nÚËaf
(
±
, 
±_šdex
);

220 
	`d–_±
(
±
, 
±_šdex
 ,
	`l3e_g‘_pâ
(
Ş3e
));

221 
ªy_m¬kšg
 = 1;

225 ià((
	`l3e_g‘_æags
(
Æ3e
è& 
_PAGE_PRESENT
è&& ((
	`l3e_g‘_pâ
(
Ş3e
)!=l3e_get_pfn(nl3e)) || !(l3e_get_flags(ol3e)&_PAGE_PRESENT)) ) {

226 #ifdeà
ENABLE_PT_RECURSIVE


227 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
±_šdex
, 
	`l3e_g‘_pâ
(
Æ3e
));

228 #ifdeà
ENABLE_PER_CACHE_PT


229 
	`add_shadow_nÚËaf
(
±
, 
±_šdex
, 
Ãw±
, 
	`l3e_g‘_æags
(
Æ3e
));

231 
ªy_m¬kšg
 = 1;

234 #ifdeà
ENABLE_PT_RECURSIVE


235 ià(!
ªy_m¬kšg
 && 
	`l3e_g‘_æags
(
Ş3e
è!ğl3e_g‘_æags(
Æ3e
)) {

236 
	`my´štk
("WARN: fÏg-chªge š†3e..TODO.. %x -> %x\n", 
Ş3e
.
l3
, 
Æ3e
.l3 );

239 
sucûss_l3_out
:

242 
	`uÆock_±
(0);

243 
	`©omic_dec
(&
mši_¶aû
[5]);

244 
	`©omic_dec
(&
mši_couÁ
);

245 
	}
}

247 #ià
CONFIG_PAGING_LEVELS
 >= 4

248 
	$l4e_upd©e_sucûss
(
l4_pg’Œy_t
 *
¶4e
,†4_pg’Œy_ˆ
Ş4e
,†4_pg’Œy_ˆ
Æ4e
, 
mâ
)

250 ià(!
mši_aùiv©ed
)

252 
	`©omic_šc
(&
mši_couÁ
);

253 
	`©omic_šc
(&
mši_¶aû
[6]);

255 
·ge_bË
 *
±
;

256 
	`mâ_check
(
mâ
);

257 
	`±mª_lock
(
mâ
);

258 
±
 = 
	`±mª_fšd
(
mâ
);

259 
	`±mª_uÆock
(
mâ
);

260 ià(!
±
) {

263 
	`´štk
("[L4]");

264 
sucûss_l4_out
;

266 ià(
±
->
u£r_l4
)

267 
sucûss_l4_out
;

268 
±_šdex
 = 
	`PTR_TO_INDEX
(
¶4e
);

269 
	`MYASSERT
(
±_šdex
 < 
L4_PAGETABLE_ENTRIES
);

270 #ifdeà
ENABLE_PT_RECURSIVE


271 ià(
	`g‘_va
(
±
, 
±_šdex
è>ğ
USERLAND_END
 )

272 #ifdeà
ENABLE_KERNEL_SHADOW


274 
	`my·nic
("l4e_update_success in kernel\n");

277 
sucûss_l4_out
;

279 
	`MYASSERT
(
±
->
Ëv–
 == 4);

282 #ifdeà
VERBOSE_PAGE_TABLE_L4E_CHANGE_SUCCESS


283 
	`my´štk
("Ş4e:%x->Æ4e:%x\n", 
Ş4e
.
l4
, 
Æ4e
.l4 );

285 
ªy_m¬kšg
 = 0;

286 ià((
	`l4e_g‘_æags
(
Ş4e
è& 
_PAGE_PRESENT
è&& ((
	`l4e_g‘_pâ
(Ş4e)!ö4e_g‘_pâ(
Æ4e
)) || !(l4e_get_flags(nl4e)&_PAGE_PRESENT)) ) {

287 #ifdeà
ENABLE_PT_RECURSIVE


288 #ifdeà
ENABLE_PER_CACHE_PT


289 
	`d–_shadow_nÚËaf
(
±
, 
±_šdex
);

291 
	`d–_±
(
±
, 
±_šdex
 ,
	`l4e_g‘_pâ
(
Ş4e
));

292 
ªy_m¬kšg
 = 1;

296 ià((
	`l4e_g‘_æags
(
Æ4e
è& 
_PAGE_PRESENT
è&& ((
	`l4e_g‘_pâ
(
Ş4e
)!=l4e_get_pfn(nl4e)) || !(l4e_get_flags(ol4e)&_PAGE_PRESENT)) ) {

297 #ifdeà
ENABLE_PT_RECURSIVE


298 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
±_šdex
, 
	`l4e_g‘_pâ
(
Æ4e
) );

299 #ifdeà
ENABLE_PER_CACHE_PT


300 
	`add_shadow_nÚËaf
(
±
, 
±_šdex
, 
Ãw±
, 
	`l4e_g‘_æags
(
Æ4e
));

302 
ªy_m¬kšg
 = 1;

305 #ifdeà
ENABLE_PT_RECURSIVE


306 ià(!
ªy_m¬kšg
 && 
	`l4e_g‘_æags
(
Ş4e
è!ğl4e_g‘_æags(
Æ4e
)) {

307 
	`my´štk
("WARN: fÏg-chªge š†4e..TODO.. %x -> %x\n", 
Ş4e
.
l4
, 
Æ4e
.l4 );

310 
sucûss_l4_out
:

313 
	`uÆock_±
(0);

314 
	`©omic_dec
(&
mši_¶aû
[6]);

315 
	`©omic_dec
(&
mši_couÁ
);

316 
	}
}

	@ptman.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_PTMAN


25 
	#PTMAN_SHIFT
 11

	)

26 
	#MAX_PTMAN_ENTRY
 (1UL<<
PTMAN_SHIFT
)

	)

27 
	#HASH_FUNC
(
MFN
è((MFN)&(
MAX_PTMAN_ENTRY
-1))

	)

28 
¥šlock_t
 
	g±mª_locks
[
MAX_PTMAN_ENTRY
];

29 
li¡_h—d
 
	g±mª
[
MAX_PTMAN_ENTRY
];

30 
·ge_bË
 *
±mª_fšd
(
mâ
);

32 
	$š™_±mª
()

34 
i
;

35 
i
=0;i<
MAX_PTMAN_ENTRY
;i++) {

36 
	`INIT_LIST_HEAD
(&
±mª
[
i
]);

37 
	`¥š_lock_š™
(&
±mª_locks
[
i
]);

39 
	}
}

40 
	$±mª_lock
(
mâ
)

42 
i
 = 
	`HASH_FUNC
(
mâ
);

43 
	`my¥š_lock
(&
±mª_locks
[
i
] , 144);

44 
	}
}

45 
	$±mª_uÆock
(
mâ
)

47 
i
 = 
	`HASH_FUNC
(
mâ
);

48 
	`¥š_uÆock
(&
±mª_locks
[
i
]);

49 
	}
}

50 
	$±mª_add
(
mâ
, 
·ge_bË
 *
p
)

52 
i
 = 
	`HASH_FUNC
(
mâ
);

53 #ifdeà
DEBUG_ASSERT


54 ià(!
	`¥š_is_locked
(&
±mª_locks
[
i
]))

55 
	`my·nic
("lock before…tman_add");

56 ià(
	`±mª_fšd
(
mâ
)) {

57 
	`my´štk
("mâ:%x ,…:%x‡Ì—dyƒxi¡s!\n", 
mâ
, 
p
);

58 
	`my·nic
("alreadyƒxists!");

61 
	`li¡_add
(&
p
->
±mª_li¡
,&
±mª
[
i
]);

62 
	}
}

63 
	$±mª_d–
(
mâ
)

65 
·ge_bË
 *
p
;

66 
i
 = 
	`HASH_FUNC
(
mâ
);

67 #ifdeà
DEBUG_ASSERT


68 ià(!
	`¥š_is_locked
(&
±mª_locks
[
i
]))

69 
	`my·nic
("lock before…tman_del");

71 
p
 = 
	`±mª_fšd
(
mâ
);

72 ià(!
p
) {

73 
	`my´štk
("mâ:%x ,…Œ:%x dÛ¢'ˆexi¡s!\n", 
mâ
, 
p
);

74 
	`my·nic
("doesn'tƒxists!");

76 
	`li¡_d–_š™
(&
p
->
±mª_li¡
);

77 
	}
}

79 
·ge_bË
 *
	$±mª_fšd
(
mâ
)

81 
·ge_bË
 *
p
;

82 
i
 = 
	`HASH_FUNC
(
mâ
);

83 #ifdeà
DEBUG_ASSERT


84 ià(!
	`¥š_is_locked
(&
±mª_locks
[
i
])è
	`my·nic
("lock before…tman_find");

86 
	`li¡_fÜ_—ch_’Œy
(
p
, &
±mª
[
i
], 
±mª_li¡
) {

87 ià(
p
->
mâ
 == mfn) {

88  
p
;

91  
NULL
;

92 
	}
}

95 
·ge_bË
 *
	$fšd_±_mâ
(
mâ
)

97 
·ge_bË
 *
»t
;

98 
	`±mª_lock
(
mâ
);

99 
»t
 = 
	`±mª_fšd
(
mâ
);

100 
	`±mª_uÆock
(
mâ
);

101  
»t
;

102 
	}
}

104 
	$lock_pgd
(
mâ
, 
·ge_dœ
 *
Ãwpgd
, 
loc
)

106 
·ge_bË
 *
±
;

107 
·ge_dœ
 *
pgd
;

109 
	`©omic_šc
(&
mši_couÁ
);

110 
	`©omic_šc
(&
mši_¶aû
[7]);

112 ià(!
mši_aùiv©ed
 && !
mši_di§blšg
) {

113 
ex™_lock_pgd
;

115 #ifdeà
DEBUG_WARN


116 ià(
	`this_ıu
(
found_±
))

117 
	`my´štk
("WARN found_±ƒxi¡s???…»_loc=%d,‚ow_loø=%d\n", 
	`this_ıu
(
locked_±_loc
è, 
loc
);

118 ià(
mši_di§blšg
) {

122 
	`±mª_lock
(
mâ
);

123 
pgd
 = 
	`fšd_pgd
(
mâ
, 
NULL
);

124 
	`±mª_uÆock
(
mâ
);

125 ià(
pgd
) {

126 
	`my´štk
("TODO: deletehis…gd...\n");

127 
	`my·nic
("TODO");

129 
	`this_ıu
(
found_±
èğ
NULL
;

130 
pgd
 = 
Ãwpgd
;

131 ià(
	`this_ıu
(
locked_±
)) {

132 
	`my·nic
("WARN†ocked_pt‚on-zero?†evel2 or‚ewpgd\n");

136 
	`my¥š_lock
(&
‹mp_lock
, 145);

137 
	`this_ıu
(
locked_±
èğ&
‹mp_lock
;

139 
ex™_lock_pgd
:

140 
	`©omic_dec
(&
mši_¶aû
[7]);

141 
	`©omic_dec
(&
mši_couÁ
);

142 
	}
}

145 
	$lock_±
(
mâ
, 
Ëv–
, 
loc
)

147 
·ge_bË
 *
±
;

148 
·ge_dœ
 *
pgd
;

150 
	`©omic_šc
(&
mši_couÁ
);

151 
	`©omic_šc
(&
mši_¶aû
[8]);

152 ià(!
mši_aùiv©ed
 && !
mši_di§blšg
) {

153 
ex™_lock_±
;

155 #ifdeà
DEBUG_WARN


156 ià(
	`this_ıu
(
found_±
))

157 
	`my´štk
("WARN found_±ƒxi¡s???…»_loc=%d,‚ow_loø=%d\n", 
	`this_ıu
(
locked_±_loc
è, 
loc
);

158 ià(
mši_di§blšg
) {

162 
±
 = 
	`fšd_±_mâ
(
mâ
);

163 
	`this_ıu
(
found_±
èğ
±
;

164 ià(!
±
) {

167 ià(
	`this_ıu
(
locked_±
)) {

168 
	`my·nic
("WARN†ocked_pt‚on-zero?\n");

170 
	`my¥š_lock
(&
±
->
‹mp_lock
, 115);

171 
	`this_ıu
(
locked_±
èğ&
±
->
‹mp_lock
;

172 
	`this_ıu
(
locked_±_loc
èğ
loc
;

175 
ex™_lock_±
:

176 
	`©omic_dec
(&
mši_¶aû
[8]);

177 
	`©omic_dec
(&
mši_couÁ
);

178 
	}
}

180 
	$uÆock_±
(
fÜcibly
)

182 ià(!
fÜcibly
 && !
	`this_ıu
(
found_±
))

184 ià(
	`this_ıu
(
locked_±
)) {

185 
	`¥š_uÆock
(
	`this_ıu
(
locked_±
));

186 
	`this_ıu
(
locked_±
) = 0;

187 
	`this_ıu
(
found_±
) = 0;

188 
	`this_ıu
(
locked_±_loc
) = 0;

190 
	`my´štk
("locked_pt =‚ull?? initial?\n");

192 
	}
}

194 
·ge_dœ
 *
	$g‘_pgd
(
·ge_bË
 *
±
)

196 
·ge_dœ
 *
pgd
;

197 
	`MYASSERT
(!
±
->
u£r_l4
);

198 ià(
±
->
Ëv–
 == 1) {

199 
pgd
 = 
±
->
up_±
->up_±->up_±->
aux
;

200 } ià(
±
->
Ëv–
 == 2) {

201 
pgd
 = 
±
->
up_±
->up_±->
aux
;

202 } ià(
±
->
Ëv–
 == 3) {

203 
pgd
 = 
±
->
up_±
->
aux
;

204 } ià(
±
->
Ëv–
 == 4) {

205 
pgd
 = 
±
->
aux
;

207 
	`MYASSERT
(
pgd
 > 
USERLAND_END
);

208  
pgd
;

209 
	}
}

211 
	$g‘_va
(
·ge_bË
 *
±
, 
±šdex
)

213 
va
 = 0;

214 
	`MYASSERT
(
±šdex
 < 
L1_PAGETABLE_ENTRIES
);

215 
	`MYASSERT
(!
±
->
u£r_l4
);

216 ià(
±
->
Ëv–
 == 1) {

217 
va
 |ğ(
±šdex
 << 12);

218 
va
 |ğ(
±
->
up_šdex
 << 21);

219 
±
 =…t->
up_±
;

220 
va
 |ğ(
±
->
up_šdex
 << 30);

221 
±
 =…t->
up_±
;

222 
va
 |ğ(
±
->
up_šdex
 << 39);

223 
±
 =…t->
up_±
;

224 } ià(
±
->
Ëv–
 == 2) {

225 
va
 |ğ(
±šdex
 << 21);

226 
va
 |ğ(
±
->
up_šdex
 << 30);

227 
±
 =…t->
up_±
;

228 
va
 |ğ(
±
->
up_šdex
 << 39);

229 
±
 =…t->
up_±
;

230 } ià(
±
->
Ëv–
 == 3) {

231 
va
 |ğ(
±šdex
 << 30);

232 
va
 |ğ(
±
->
up_šdex
 << 39);

233 
±
 =…t->
up_±
;

234 } ià(
±
->
Ëv–
 == 4) {

235 
va
 |ğ(
±šdex
 << 39);

237 
	`MYASSERT
(
±
->
up_±
 =ğ
NULL
);

239 
	`MYASSERT
(!(
va
>>48));

240 ià(
va
 >ğ
USERLAND_END
) {

241 
va
 |= 0xffff000000000000;

244  
va
;

245 
	}
}

248 
·ge_bË
 *
	$fšd_±
(
up_šdex
, 
mâ
)

250 
·ge_bË
 *
»t
;

251 
	`±mª_lock
(
mâ
);

252 
»t
 = 
	`±mª_fšd
(
mâ
);

253 #ifdeà
DEBUG_ASSERT


254 ià(
»t
 &&„‘->
up_šdex
 != up_index) {

255 
	`my´štk
("found buˆdifã»Á up_šdex?? %lx !ğ%lx\n", 
»t
->
up_šdex
, up_index);

256 
	`´št_±
(
»t
);

258 ià(
»t
)

259 
	`MYASSERT
(!
»t
->
u£r_l4
);

261 
	`±mª_uÆock
(
mâ
);

262  
»t
;

263 
	}
}

265 
	$add_bË_commÚ_u£r
(
·ge_bË
 *
±
, 
mâ
)

267 
	`mâ_check
(
mâ
);

268 
	`INIT_LIST_HEAD
(&
±
->
±mª_li¡
);

269 
±
->
mâ
 = mfn;

270 
±
->
u£r_l4
 = 1;

271 
±
->
Ëv–
 = 999;

272 
	`INIT_LIST_HEAD
(&
±
->
li¡
);

273 
	`INIT_LIST_HEAD
(&
±
->
±_li¡
);

274 
	`¥š_lock_š™
(&
±
->
‹mp_lock
);

275 #ifdeà
ENABLE_PER_CACHE_PT


278 
±
->
up_šdex
 = 999;

279 
±
->
±_couÁ
 = 999;

280 
±
->
aux
 = 999;

281 
±
->
up_±
 = 999;

282 
	}
}

284 
	$add_bË_commÚ
(
·ge_bË
 *
±
, 
mâ
, 
Ëv–
, 
up_šdex
, ·ge_bË *
up_±
)

286 
	`mâ_check
(
mâ
);

287 
	`INIT_LIST_HEAD
(&
±
->
±mª_li¡
);

288 
±
->
mâ
 = mfn;

289 
±
->
u£r_l4
 = 0;

290 
±
->
Ëv–
 =†evel;

291 
	`INIT_LIST_HEAD
(&
±
->
li¡
);

292 
	`INIT_LIST_HEAD
(&
±
->
±_li¡
);

293 
	`¥š_lock_š™
(&
±
->
‹mp_lock
);

294 #ifdeà
ENABLE_PER_CACHE_PT


295 
i
;

296 *
p
;

298 
i
=0;i<
MAX_CACHE
;i++) {

299 #ifdeà
NO_PGD_ABOVE_4GB


300 
p
 = 
	`my®loc_x’h—p_·ge_4gb
(9);

302 
p
 = 
	`my®loc_x’h—p_·ge
(9);

304 
	`MYASSERT
(
p
);

305 
	`mem£t
(
p
, 0, 
PAGE_SIZE
);

306 
±
->
shadow
[
i
] = 
p
;

307 
	`MYASSERT
(()
±
->
shadow
[
i
] =ğ()
p
);

309 #ifdeà
ENABLE_REGIONING2


310 #ifdeà
NO_PGD_ABOVE_4GB


311 
p
 = 
	`my®loc_x’h—p_·ge_4gb
(9);

313 
p
 = 
	`my®loc_x’h—p_·ge
(9);

315 
	`MYASSERT
(
p
);

316 
	`mem£t
(
p
, 0, 
PAGE_SIZE
);

317 
±
->
»giÚšg_shadow
 = 
p
;

320 
±
->
up_šdex
 = up_index;

321 
±
->
±_couÁ
 = 0;

323 ià(
up_šdex
 == -1) {

324 
±
->
aux
 = 
up_±
;

325 
±
->
up_±
 = 
NULL
;

327 
±
->
aux
 = 
NULL
;

328 
±
->
up_±
 = up_pt;

330 #ifdeà
ENABLE_BITMAP_BASIC


331 ià(
Ëv–
 == 1) {

332 
l1e_¡ruù
 *
aux
 = 
	`myxm®loc
(l1e_struct, 8);

333 
i
;

334 ià(!
aux
)

335 
	`my·nic
("xmalloc failed.");

336 
	`mem£t
(
aux
, 0, (
l1e_¡ruù
));

337 
	`MYASSERT
(
±
->
aux
 =ğ
NULL
);

338 
±
->
aux
 =‡ux;

341 
	}
}

343 
	$d–_bË_commÚ
(
·ge_bË
 *
±
)

345 #ifdeà
ENABLE_PER_CACHE_PT


346 
i
,
j
;

347 *
p
;

348 
i
=0;i<
MAX_CACHE
;i++) {

349 
p
 = 
±
->
shadow
[
i
];

350 #ifdeà
DEBUG_CHECK_CLEAN_PT


351 
j
=0;j<((
±
->
Ëv–
==2)?
INDEX_USERLAND
:1024);j++) {

352 ià(
p
[
j
])

353 
	`my·nic
("not-cleaned…er-cache-shadow?\n");

356 
	`myä“_x’h—p_·ge
(
p
, 9);

357 
±
->
shadow
[
i
] = 0;

359 #ifdeà
ENABLE_REGIONING2


360 
p
 = 
±
->
»giÚšg_shadow
;

361 
	`myä“_x’h—p_·ge
(
p
, 9);

362 
±
->
»giÚšg_shadow
 = 0;

365 #ifdeà
ENABLE_BITMAP_BASIC


366 ià(
±
->
Ëv–
 == 1) {

367 
	`MYASSERT
(
±
->
aux
);

368 
	`myxä“
(
±
->
aux
, 8);

369 
±
->
aux
 = 
NULL
;

372 
	`MYASSERT
(
±
->
±_couÁ
 == 0);

373 
	`MYASSERT
(
	`li¡_em±y
(&
±
->
±_li¡
));

374 
	}
}

377 
	#L4T_END
 256

	)

378 
	#L3T_END
 512

	)

379 
	#L2T_END
 512

	)

381 
	$_d–_±
(
·ge_bË
 *
±
)

383 
·ge_bË
 *
Şd±
;

384 
li¡_h—d
 *
i
, *
‹mp
;

386 
	`li¡_fÜ_—ch_§ã
(
i
, 
‹mp
, &
±
->
±_li¡
) {

387 
Şd±
 = 
	`li¡_’Œy
(
i
, 
·ge_bË
, 
li¡
);

388 #ifdeà
ENABLE_PER_CACHE_PT


389 
	`d–_shadow_nÚËaf
(
Şd±
->
up_±
, old±->
up_šdex
);

391 
	`d–_±
(
Şd±
->
up_±
, old±->
up_šdex
, old±->
mâ
);

394 #ifdeà
DEBUG_ASSERT


395 ià(
±
->
±_couÁ
)

396 
	`my·nic
("del_pt():…t->pt_count?? ");

398 
	}
}

400 
	$d–_±
(
·ge_bË
 *
up_±
, 
up_šdex
, 
mâ
)

402 
·ge_bË
 *
±
;

404 
	`mâ_check
(
mâ
);

406 ià(
up_šdex
 == -1) {

407 } ià(
up_±
->
Ëv–
 == 2) {

408 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l1_·ge_bË
 );

409 } ià(
up_±
->
Ëv–
 == 3) {

410 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l2_·ge_bË
 );

411 } ià(
up_±
->
Ëv–
 == 4) {

412 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l3_·ge_bË
 );

414 
	`my·nic
("level out of„ange del_pt");

415 
	`MYASSERT_PAGE_IS_VALIDATED
Ğ
	`mâ_to_·ge
(
mâ
));

416 #ifdeà
DEBUG_ASSERT


423 
±
 = 
	`fšd_±
(
up_šdex
, 
mâ
);

424 ià(!
±
) {

425 
	`my´štk
("d–_±:%x[%d]%x NOT FOUND!\n", 
up_±
->
mâ
, 
up_šdex
, mfn);

426 
	`my·nic
("del_pt");

429 ià(
±
->
Ëv–
 == 1) {

430 } ià(
±
->
Ëv–
 == 2) {

431 
	`_d–_±
(
±
);

432 } ià(
±
->
Ëv–
 == 3) {

433 
	`_d–_±
(
±
);

434 } ià(
±
->
Ëv–
 == 4) {

435 
	`_d–_±
(
±
);

437 
	`my·nic
("pt->level out of„ange del_pt");

439 
	`±mª_lock
(
mâ
);

440 
	`±mª_d–
(
mâ
);

441 
	`±mª_uÆock
(
mâ
);

443 ià(
±
->
Ëv–
 !ğ
CONFIG_PAGING_LEVELS
) {

445 
	`li¡_d–_š™
(&
±
->
li¡
);

446 
up_±
->
±_couÁ
--;

449 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


450 ià(
up_šdex
 == -1)

451 
	`my´štk
("l%d (pgd:%5x)=%5x d–ed.\n", 
CONFIG_PAGING_LEVELS
, 
up_±
, 
mâ
);

453 
	`my´štk
("l%d %5x[%3x]=%5x d–ed.\n", 
±
->
Ëv–
, 
up_±
->
mâ
, 
up_šdex
, mfn);

455 
	`TRACE_3D
(
TRC_MIN_DEL_PT
, 
up_±
->
mâ
, 
up_šdex
, mfn);

456 #ifdeà
ENABLE_MARK_VREGION


457 ià(
±
->
Ëv–
 == 1)

458 
	`unm¬k_±
(
±
);

461 #ifdeà
DEBUG_WARN


462 ià(
±
->
Ëv–
 == 1) {

463 
c
;

464 
pos
;

465 
	`my¥š_lock_±
(
±
, 109);

466 
c
=0;c<
MAX_CACHE
;c++) {

467  
pos
 = 
	`fšd_fœ¡_b™
(
±
->
b™m­_İ’
[
c
], 1024);

468 
pos
 < 1024;

469 
pos
 = 
	`fšd_Ãxt_b™
(
±
->
b™m­_İ’
[
c
], 1024,…os+1) )

471 
	`my´štk
("WARN b™m­ stÈİ’?†1t=%x[%d]\n", 
±
->
mâ
, 
pos
);

474 
	`¥š_uÆock_±
(
±
, 109);

478 
	`d–_bË_commÚ
(
±
);

479 
	`myxä“
(
±
, 3);

480 
	}
}

482 
·ge_bË
 *
	$add_±_u£r
(
mâ
)

484 
·ge_bË
 *
±
;

486 
±
 = 
	`myxm®loc
(
·ge_bË
, 3);

487 ià(!
±
)

488 
	`my·nic
("xmalloc failed.");

489 
	`add_bË_commÚ_u£r
(
±
, 
mâ
);

491 
	`±mª_lock
(
mâ
);

492 #ifdeà
DEBUG_ASSERT


493 
·ge_bË
 *
‹mp_±
;

494 
‹mp_±
 = 
	`±mª_fšd
(
mâ
);

495 ià(
‹mp_±
) {

496 
	`my´štk
("BUG! %x‡Ì—dyƒxi¡s!\n", 
mâ
);

497 
	`´št_±
(
‹mp_±
);

498 
	`my·nic
("add_pt_user");

501 
	`±mª_add
(
mâ
, 
±
);

502 
	`±mª_uÆock
(
mâ
);

513 
	}
}

515 
·ge_bË
 *
	$add_±
(
·ge_bË
 *
up_±
, 
up_šdex
, 
mâ
)

517 
i
;

518 
·ge_bË
 *
±
;

519 
l4_pg’Œy_t
 *
l4t
;

520 
l3_pg’Œy_t
 *
l3t
;

521 
l2_pg’Œy_t
 *
l2t
;

523 
	`mâ_check
(
mâ
);

524 #ifdeà
DEBUG_ASSERT


525 ià(
up_šdex
 == -1) {

526 } ià(
up_±
->
Ëv–
 == 2) {

527 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l1_·ge_bË
 );

528 } ià(
up_±
->
Ëv–
 == 3) {

529 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l2_·ge_bË
 );

530 } ià(
up_±
->
Ëv–
 == 4) {

531 
	`MYASSERT_PAGE_IS_TYPE
Ğ
	`mâ_to_·ge
(
mâ
), 
PGT_l3_·ge_bË
 );

533 
	`my·nic
("level out of„ange");

535 ià(!
	`is_x’_h—p_mâ
(
mâ
))

536 
	`MYASSERT_PAGE_IS_VALIDATED
Ğ
	`mâ_to_·ge
(
mâ
));

538 
±
 = 
	`myxm®loc
(
·ge_bË
, 3);

539 ià(!
±
)

540 
	`my·nic
("xmalloc failed.");

542 ià(
up_šdex
 == -1)

543 
	`add_bË_commÚ
(
±
, 
mâ
, 
CONFIG_PAGING_LEVELS
, 
up_šdex
, 
up_±
);

545 
	`add_bË_commÚ
(
±
, 
mâ
, 
up_±
->
Ëv–
-1, 
up_šdex
, up_pt);

547 ià(
±
->
Ëv–
 == 1) {

548 } ià(
±
->
Ëv–
 == 2) {

550 
l2t
 = 
	`m­_domaš_·ge
(
mâ
);

551 
i
=0;i<
L2T_END
;i++) {

552 ià(!(
	`l2e_g‘_æags
(
l2t
[
i
]è& 
_PAGE_PRESENT
))

554 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
i
, 
	`l2e_g‘_pâ
(
l2t
[i]));

555 #ifdeà
ENABLE_PER_CACHE_PT


556 
	`add_shadow_nÚËaf
(
±
, 
i
, 
Ãw±
, 
	`l2e_g‘_æags
(
l2t
[i]));

559 
	`unm­_domaš_·ge
(
l2t
);

560 } ià(
±
->
Ëv–
 == 3) {

562 
l3t
 = 
	`m­_domaš_·ge
(
mâ
);

563 
i
=0;i<
L3T_END
;i++) {

564 ià(!(
	`l3e_g‘_æags
(
l3t
[
i
]è& 
_PAGE_PRESENT
))

566 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
i
, 
	`l3e_g‘_pâ
(
l3t
[i]));

567 #ifdeà
ENABLE_PER_CACHE_PT


568 
	`add_shadow_nÚËaf
(
±
, 
i
, 
Ãw±
, 
	`l3e_g‘_æags
(
l3t
[i]));

571 
	`unm­_domaš_·ge
(
l3t
);

572 } ià(
±
->
Ëv–
 == 4) {

573 
·ge_dœ
 *
pgd
 = 
±
->
aux
;

574 ià(
	`‹¡_b™
(
PGD_KERNEL
, &
pgd
->
æag
)) {

575 #ifdeà
ENABLE_KERNEL_SHADOW


576 
	`my´štk
("constructing…gd_kernel\n");

577 
couÁ
 = 0;

579 
l4t
 = 
	`m­_domaš_·ge
(
mâ
);

580 
i
=
L4_GUEST_START
;i<
L4_GUEST_END
;i++) {

581 ià(!(
	`l4e_g‘_æags
(
l4t
[
i
]è& 
_PAGE_PRESENT
))

583 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
i
, 
	`l4e_g‘_pâ
(
l4t
[i]));

584 
couÁ
++;

585 #ifdeà
ENABLE_PER_CACHE_PT


586 
	`add_shadow_nÚËaf
(
±
, 
i
, 
Ãw±
, 
	`l4e_g‘_æags
(
l4t
[i]));

589 
	`my´štk
("DÚw™h k”Ãl_pgd, %d L4ƒÁr›s\n", 
couÁ
);

591 
	`my·nic
("Shouldƒnable KERNEL_SHADOW!\n");

595 
l4t
 = 
	`m­_domaš_·ge
(
mâ
);

596 
i
=0;i<
L4T_END
;i++) {

597 ià(!(
	`l4e_g‘_æags
(
l4t
[
i
]è& 
_PAGE_PRESENT
))

599 
·ge_bË
 *
Ãw±
 = 
	`add_±
(
±
, 
i
, 
	`l4e_g‘_pâ
(
l4t
[i]));

600 #ifdeà
ENABLE_PER_CACHE_PT


601 
	`add_shadow_nÚËaf
(
±
, 
i
, 
Ãw±
, 
	`l4e_g‘_æags
(
l4t
[i]));

604 #ifdeà
ENABLE_PER_CACHE_PT


605 #ifdeà
ENABLE_KERNEL_SHADOW


606 #ifdeà
DEBUG_ASSERT


607 
l4_pg’Œy_t
 *
dummy
;

608 
dummy
 = 
	`mâ_to_vœt
(
cu¼’t
->
domaš
->
k”Ãl_pgd
->
±
->
mâ
);

610 
·ge_bË
 *
±2
;

611 
±2
 = 
cu¼’t
->
domaš
->
k”Ãl_pgd
->
±
;

615 ;
i
<
L4_PAGETABLE_ENTRIES
;i++) {

616 ià(
	`l4e_g‘_æags
(
l4t
[
i
]è& 
_PAGE_PRESENT
) {

617 #ifdeà
ENABLE_PER_CACHE_PT


618 #ifdeà
ENABLE_KERNEL_SHADOW


619 ià(
	`L4_GUEST_KERNEL
(
i
)) {

620 
	`MYASSERT
(
l4t
[
i
].
l4
 =ğ
dummy
[i].l4);

621 
	`add_shadow2
(
±
, 
i
, 
±2
);

623 
	`add_shadow
(
±
, 
i
, 
	`l4e_g‘_š‹
(
l4t
[i]) , 0, 1);

626 
	`add_shadow
(
±
, 
i
, 
	`l4e_g‘_š‹
(
l4t
[i]) , 0, 1);

631 
	`unm­_domaš_·ge
(
l4t
);

634 
	`my·nic
("pt->level out of„ange‡dd_pt");

636 #ifdeà
DEBUG_ASSERT


637 
·ge_bË
 *
‹mp_±
 = 
	`fšd_±
(
up_šdex
, 
mâ
);

638 ià(
‹mp_±
) {

639 
	`my´štk
("BUG! %x[%x],%x‡Ì—dyƒxi¡s!\n", 
up_±
->
mâ
, 
up_šdex
, mfn);

640 
	`´št_±
(
‹mp_±
);

641 
	`my·nic
("add_pt");

645 ià(
±
->
Ëv–
 !ğ
CONFIG_PAGING_LEVELS
) {

647 
	`li¡_add
(&
±
->
li¡
, &
up_±
->
±_li¡
);

648 
up_±
->
±_couÁ
++;

650 
	`±mª_lock
(
mâ
);

651 
	`±mª_add
(
mâ
, 
±
);

652 
	`±mª_uÆock
(
mâ
);

653 #ifdeà
VERBOSE_PAGE_TABLE_INOUT


654 ià(
up_šdex
 == -1)

655 
	`my´štk
("l%d (pgd:%5x)=%5x‡dded.\n", 
CONFIG_PAGING_LEVELS
, 
up_±
, 
mâ
);

657 ià(
±
->
Ëv–
 != 1)

658 
	`my´štk
("l%d %5x[%3x]=%5x‡dded.\n", 
±
->
Ëv–
, 
up_±
->
mâ
, 
up_šdex
, mfn);

660 
	`TRACE_3D
(
TRC_MIN_ADD_PT
, 
up_±
->
mâ
, 
up_šdex
, mfn);

662 #ifdeà
ENABLE_MARK_VREGION


663 ià(
±
->
Ëv–
 == 1)

664 
	`m¬k_±
(
±
);

666  
±
;

667 
	}
}

670 
·ge_dœ
 *
	$fšd_pgd
(
mâ
, 
·ge_bË
 **
±_out
)

672 
·ge_dœ
 *
pgd
 = 
NULL
;

673 
·ge_bË
 *
±
;

674 
	`mâ_check
(
mâ
);

675 
±
 = 
	`±mª_fšd
(
mâ
);

676 ià(
±
 && !±->
u£r_l4
) {

677 
pgd
 = 
	`g‘_pgd
(
±
);

679 ià(
±_out
)

680 *
±_out
 = 
±
;

682 ià(
±
)

683 
	`MYASSERT
(!
±
->
u£r_l4
);

684  
pgd
;

685 
	}
}

	@record.c

1 
	~<mši.h
>

4 
	$»cÜd
(cÚ¡ *
fmt
, ...)

6 
buf
[1024];

8 
va_li¡
 
¬gs
;

9 *
p
, *
q
;

13 
	`va_¡¬t
(
¬gs
, 
fmt
);

14 ()
	`v¢´štf
(
buf
, (buf), 
fmt
, 
¬gs
);

15 
	`va_’d
(
¬gs
);

17 
p
 = 
buf
;

18 
	}
}

	@region.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_VREGIONS


25 
¥šlock_t
 
	gv»giÚs_£ed_lock
;

26 
¥šlock_t
 
	gv»giÚs_ä“_lock
;

27 
LIST_HEAD
(
v»giÚs_£ed
);

28 
LIST_HEAD
(
v»giÚs_ä“
);

29 
	gv»giÚs_£ed_couÁ
;

30 
	gv»giÚs_ä“_couÁ
;

31 
	gv»giÚs_xm®loc_couÁ
;

36 
	#VRT_MASK
 0xFFFF000000000000

	)

39 
	#MEMPAT_UNMAPPED
 0x000

40 
	#MEMPAT_NOMEMPAT
 0x001

41 
	#MEMPAT_ONETIME
 0x002

	)

42 
	#MEMPAT_SPARSE
 0x003

	)

43 
	#MEMPAT_DENSE
 0x004

	)

46 
šlše
 
	$mem·t_g‘
(
mâ
) {

47 #ifdeà
ENABLE_SEPARATE_VRT


48  ((()
v»giÚ_bË
[
mâ
])&
VRT_MASK
)>>26;

50  ((()
äame_bË
[
mâ
].
äame
.
vr
)&
VRT_MASK
)>>26;

52 
	}
}

54 
šlše
 
	$mem·t_£t
(
mâ
, 
v®
) {

55 #ifdeà
ENABLE_SEPARATE_VRT


56 
v»giÚ_bË
[
mâ
] = (
v»giÚ_t
 *)(((()v»giÚ_bË[mâ])&~
VRT_MASK
)|(
v®
<<26));

58 
äame_bË
[
mâ
].
äame
.
vr
 = (
v»giÚ_t
 *)(((()äame_bË[mâ].äame.vr)&~
VRT_MASK
)|(
v®
<<26));

60 
	}
}

64 
	#VRT_LOCK
(
mâ
è(
v¹_lock
[(mâ)&(
MFN_LOCKS_MAX
-1)])

	)

65 
¥šlock_t
 
	gv¹_lock
[
MFN_LOCKS_MAX
];

66 
¥šlock_t
 
	gsync_lock
[
MFN_LOCKS_MAX
];

69 
šlše
 
v»giÚ_t
 *
	$_v¹_g‘
(
mâ
, 
loc
) {

70 
	`my¥š_lock
(&
	`VRT_LOCK
(
mâ
), 7);

71 
t
 = (()
	`FTABLE_VR
(
mâ
))&~
VRT_MASK
;

72 
v»giÚ_t
 *
»t
 = 
NULL
;

73 ià(
t
) {

74 
»t
 = (
v»giÚ_t
 *)(
t
|
VRT_MASK
);

75 
	`vr_g‘
(
»t
, 
loc
);

77 
	`¥š_uÆock
(&
	`VRT_LOCK
(
mâ
));

78  
»t
;

79 
	}
}

82 
šlše
 
	$_v¹_£t
(
mâ
, 
v»giÚ_t
 *
v®
) {

83 
	`my¥š_lock
(&
	`VRT_LOCK
(
mâ
), 8);

84 
t
 = ()
	`FTABLE_VR
(
mâ
);

85 
	`FTABLE_VR
(
mâ
èğ(
v»giÚ_t
 *)((
t
&
VRT_MASK
)|((()
v®
)&~VRT_MASK));

86 ià(
v®
)

87 
	`vr_g‘
(
v®
, 
VR_REFCNT_VRT
);

88 
	`¥š_uÆock
(&
	`VRT_LOCK
(
mâ
));

89 
t
 =&~
VRT_MASK
;

90 ià(!
t
)

91  
NULL
;

92  (
v»giÚ_t
 *)(
t
|
VRT_MASK
);

93 
	}
}

96 
	$mâ_chaš_d–
(
mâ
, 
v»giÚ_t
 *
Şd
)

98 
Ãxt
 = 
	`FTABLE_NEXT
(
mâ
);

99 
´ev
 = 
	`FTABLE_PREV
(
mâ
);

102 
	`MYASSERT
(
Ãxt
!=-1 && 
´ev
!=-1);

103 
	`MYASSERT
(
Şd
->
h—d
 != -1);

104 ià(
Ãxt
 =ğ
mâ
) {

105 
	`MYASSERT
(
´ev
 =ğ
mâ
);

106 
	`MYASSERT
(
Şd
->
h—d
 =ğ
mâ
);

107 
Şd
->
h—d
 = -1;

109 
	`FTABLE_PREV
(
Ãxt
èğ
´ev
;

110 
	`FTABLE_NEXT
(
´ev
èğ
Ãxt
;

111 ià(
mâ
 =ğ
Şd
->
h—d
) {

112 
Şd
->
h—d
 = 
Ãxt
;

116 
	`FTABLE_PREV
(
mâ
) = -1;

117 
	`FTABLE_NEXT
(
mâ
) = -1;

118 
	}
}

120 
	$mâ_chaš_add
(
mâ
, 
v»giÚ_t
 *
v®
)

122 
i
 = 
v®
->
h—d
;

123 
j
;

124 ià(
i
==-1) {

125 
v®
->
h—d
 = 
mâ
;

126 
	`FTABLE_NEXT
(
mâ
) = mfn;

127 
	`FTABLE_PREV
(
mâ
) = mfn;

130 
j
 = 
	`FTABLE_NEXT
(
i
);

131 
	`FTABLE_NEXT
(
mâ
èğ
j
;

132 
	`FTABLE_PREV
(
mâ
èğ
i
;

133 
	`FTABLE_NEXT
(
i
èğ
mâ
;

134 
	`FTABLE_PREV
(
j
èğ
mâ
;

136 
	}
}

141 
šlše
 
v»giÚ_t
 *
	$v¹_g‘
(
mâ
, 
loc
, 
sync_locked
)

143 
v»giÚ_t
 *
vr
;

144 
	`mâ_check
(
mâ
);

145 ià(!
sync_locked
)

146 
	`my¥š_lock
(&
	`SYNC_LOCK
(
mâ
), 10);

147 
vr
 = 
	`_v¹_g‘
(
mâ
, 
loc
);

148 ià(!
vr
) {

149 ià(!
sync_locked
)

150 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

151  
NULL
;

153 #ifdeà
DEBUG_ASSERT


154 ià(
vr
 < (
v»giÚ_t
 *)
VRT_MASK
) {

155 
	`my´štk
("vr==%°!!\n", 
vr
);

156 
	`my·nic
("vrt_get: vr< VRT_MASK");

159 
	`my¥š_lock
(&
vr
->
lock
, 139);

160 ià(!
sync_locked
)

161 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

162  
vr
;

163 
	}
}

166 
v»giÚ_t
 *
	gglob®
;

167 
	#MAX_SEED_SIZE
 100000

168 
v»giÚ_t
 *
£ed_x’
;

	)

169 
v»giÚ_t
 *
	g£ed_k”Ãl
;

170 
v»giÚ_t
 *
	g£ed_u£r
;

171 #ifdeà
ENABLE_HOT_PAGES


172 
v»giÚ_t
 *
	g£ed_u£r_hÙ
;

175 
v»giÚ_t
 *
	$g‘_£ed_u£r
()

178 ià(
£ed_u£r
->
äame_couÁ
 >ğ
MAX_SEED_SIZE
)

180 
	`vr_put
(
£ed_u£r
, 
VR_REFCNT_SEED
, 0);

181 
£ed_u£r
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_USER
);

183  
£ed_u£r
;

184 
	}
}

186 
v»giÚ_t
 *
	$g‘_£ed_k”Ãl
()

189 ià(
£ed_k”Ãl
->
äame_couÁ
 >ğ
MAX_SEED_SIZE
)

191 
	`vr_put
(
£ed_k”Ãl
, 
VR_REFCNT_SEED
, 0);

192 
£ed_k”Ãl
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_KERNEL
);

194  
£ed_k”Ãl
;

195 
	}
}

197 
v»giÚ_t
 *
	$g‘_£ed_x’
()

200 ià(
£ed_x’
->
äame_couÁ
 >ğ
MAX_SEED_SIZE
)

202 
	`vr_put
(
£ed_x’
, 
VR_REFCNT_SEED
, 0);

203 
£ed_x’
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_XEN
);

205  
£ed_x’
;

206 
	}
}

208 
v»giÚ_t
 *
	$v¹_£t
(
mâ
, 
v»giÚ_t
 *
vr
, 
æags
)

210 
i
;

211 
was_nuÎ
 = 
æags
 & 
VRT_SET_WAS_NULL
;

212 
rm­s_butš
 *
r
;

213 
maybe_§me
 = 
æags
 & 
VRT_SET_MAYBE_SAME
;

214 ià(!
was_nuÎ
 && !
vr
) {

215 #ifdeà
ENABLE_RMAP


217 
r
 = &
	`FTABLE_RMAPS
(
mâ
,
RMAPS_USER
);

218 ià(
r
->
rm­_couÁ
) {

219 
vr
 = 
	`g‘_£ed_u£r
();

221 
r
 = &
	`FTABLE_RMAPS
(
mâ
,
RMAPS_KERNEL
);

222 ià(
r
->
rm­_couÁ
)

223 
vr
 = 
	`g‘_£ed_k”Ãl
();

225 
vr
 = 
	`g‘_£ed_x’
();

228 
vr
 = 
	`g‘_£ed_x’
();

230 
was_nuÎ
 = 1;

232 #ifdeà
DEBUG_ASSERT


233 ià(
vr
 && v¸< (
v»giÚ_t
 *)
VRT_MASK
è
	`my·nic
("vrt_set: vr && vr < VRT_MASK");

235 
	`mâ_check
(
mâ
);

237 
v»giÚ_t
 *
Şd
;

238 ià(
æags
 & 
VRT_SET_LOCK_SYNC
) {

239 
	`my¥š_lock
(&
	`SYNC_LOCK
(
mâ
), 44);

241 
	`MYASSERT
(
	`¥š_is_locked
(&
	`SYNC_LOCK
(
mâ
)));

242 
Şd
 = 
	`_v¹_£t
(
mâ
, 
vr
);

243 #ifdeà
DEBUG_ASSERT


244 ià(
æags
 & 
VRT_SET_INIT
) {

245 
	`MYASSERT
(!
Şd
);

247 
	`MYASSERT
(
Şd
);

250 iàĞ
Şd
 =ğ
vr
 )

252 ià(
maybe_§me
) {

253 
§me_vr
;

255 
	`my´štk
("old vr\n");

256 
	`´št_v»giÚ
(
Şd
, 0);

257 
	`my´štk
("new vr\n");

258 
	`´št_v»giÚ
(
vr
, 0);

259 
	`my·nic
("WARN Unnecessary vrt_set..Seto same vr??\n");

261 #ifdeà
DEBUG_ASSERT


262 #ifdeà
ENABLE_GUEST_REGION


270 iàĞ
Şd
 ) {

272 ià(
Şd
 =ğ
£ed_u£r_hÙ
) {

273 
domaš
 *
vm
 = 
	`·ge_g‘_owÃr
(
	`__mâ_to_·ge
(
mâ
));

274 ià(
vm
) {

275 
vm_id
 = 
vm
->
domaš_id
;

276 ià(
vm_id
>=0 && vm_id < 
MAX_HETERO_VM
) {

277 
	`©omic_dec
(&
hÙ_·ges_vm
[
vm_id
]);

279 
	`my´štk
("WARN inv®id vm_id:%d\n", 
vm_id
);

282 
	`my´štk
("WARN‚uÎ owÃr..mâ:%lx\n", 
mâ
);

287 
	`my¥š_lock
(&
Şd
->
lock
, 45);

288 #ifdeà
DEBUG_ASSERT


289 ià(!(
was_nuÎ


290 || 
	`‹¡_b™
(
VR_POOL
, &
Şd
->
æags
)

291 || 
	`‹¡_b™
(
VR_NO_REGIONING
, &
vr
->
æags
)

292 || (
	`‹¡_b™
(
VR_REGULAR
, &
Şd
->
æags
è&&e¡_b™(VR_REGULAR, &
vr
->flags))

294 
	`my´štk
("old vr\n");

295 
	`´št_v»giÚ
(
Şd
, 0);

296 
	`my´štk
("new vr\n");

297 
	`´št_v»giÚ
(
vr
, 0);

298 
	`my·nic
("not-permittedransition ??");

301 
	`vr_dec_äame_couÁ
(
Şd
);

302 #ifdeà
ENABLE_RMAP


303 
i
=0;i<
RMAPS_MAX
;i++) {

304 
r
 = &
	`FTABLE_RMAPS
(
mâ
,
i
);

305 
	`vr_sub_rm­_couÁ
(
Şd
, 
r
->
rm­_couÁ
, 
i
);

308 #ifdeà
ENABLE_HISTOGRAM


312 
	`vr_dec_d’s™y
(
Şd
, 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
)), 0 );

314 
	`mâ_chaš_d–
(
mâ
, 
Şd
);

315 #ifdeà
ENABLE_VREGION_MAPPING


316 
i
=0;i<
MAX_CACHE
;i++) {

317 ià(!
	`is_v»giÚ_ÿche_m­³d
(
Şd
, 
i
))

318 
	`İ’_mâ
(
mâ
, 
i
, 
NULL
, 0);

321 #ifdeà
ENABLE_REGIONING3


322 ià(
	`‹¡_b™
(
VR_NO_REGIONING
, &
Şd
->
æags
)) {

323 
	`şo£_mâ
(
mâ
, -1, 
NULL
, 1);

326 
	`¥š_uÆock
(&
Şd
->
lock
);

329 ià(
vr
) {

331 ià(
vr
 =ğ
£ed_u£r_hÙ
) {

332 
domaš
 *
vm
 = 
	`·ge_g‘_owÃr
(
	`__mâ_to_·ge
(
mâ
));

333 ià(
vm
) {

334 
vm_id
 = 
vm
->
domaš_id
;

335 ià(
vm_id
>=0 && vm_id < 
MAX_HETERO_VM
) {

336 
	`©omic_šc
(&
hÙ_·ges_vm
[
vm_id
]);

338 
	`my´štk
("WARN inv®id vm_id:%d\n", 
vm_id
);

341 
	`my´štk
("WARN‚uÎ owÃr..mâ:%lx\n", 
mâ
);

346 
	`my¥š_lock
(&
vr
->
lock
, 99);

347 #ifdeà
ENABLE_HISTOGRAM


348 
	`vr_šc_d’s™y
(
vr
, 
	`b™couÁ
(
	`FTABLE_ABIT
(
mâ
)), 0 );

350 #ifdeà
ENABLE_DENSITY


351 ià(
·»Á
==
NULL
) {

355 
i
=0;i<
MAX_CACHE
;i++) {

356 
	`ABIT_HISTORY
(
mâ
,
i
) = 0;

357 
	`vr_šc_d’s™y
(
vr
, 0, 
i
);

360 
i
=0;i<
MAX_CACHE
;i++) {

361 
	`vr_šc_d’s™y
(
vr
, 
	`b™couÁ
(
	`ABIT_HISTORY
(
mâ
, 
i
)), i);

366 #ifdeà
ENABLE_RMAP


367 #iâdeà
ENABLE_HETERO


368 
r
 = &
	`FTABLE_RMAPS
(
mâ
,
RMAPS_USER
);

369 ià(
	`‹¡_b™
(
VR_USER
, &
vr
->
æags
è&& !
r
->
rm­_couÁ
) {

370 
	`MYASSERT
(
æags
 & 
VRT_SET_SKIP_UNLOCK_VR2
);

372 ià(
	`‹¡_b™
(
VR_KERNEL
, &
vr
->
æags
è&& 
r
->
rm­_couÁ
) {

373 
	`MYASSERT
(
æags
 & 
VRT_SET_SKIP_UNLOCK_VR2
);

379 
couÁ
 = 0;

380 
i
=0;i<
RMAPS_MAX
;i++) {

381 
r
 = &
	`FTABLE_RMAPS
(
mâ
,
i
);

382 
	`vr_add_rm­_couÁ
(
vr
, 
r
->
rm­_couÁ
, 
i
);

383 
couÁ
 +ğ
r
->
rm­_couÁ
;

385 ià(
	`‹¡_b™
(
VR_SHRINK_NORMAP
, &
vr
->
æags
))

386 
	`MYASSERT
(
couÁ
);

388 
	`vr_šc_äame_couÁ
(
vr
);

389 
	`mâ_chaš_add
(
mâ
, 
vr
);

390 #ifdeà
ENABLE_VREGION_MAPPING


391 
i
=0;i<
MAX_CACHE
;i++) {

392 ià(!
	`is_v»giÚ_ÿche_m­³d
(
vr
, 
i
)) {

393 
	`şo£_mâ
(
mâ
, 
i
, 
NULL
, 0);

397 #ifdeà
ENABLE_REGIONING3


398 ià(
	`‹¡_b™
(
VR_NO_REGIONING
, &
vr
->
æags
)) {

399 
	`İ’_mâ
(
mâ
, -1, 
NULL
, 1);

402 ià(!(
æags
 & 
VRT_SET_SKIP_UNLOCK_VR2
))

403 
	`¥š_uÆock
(&
vr
->
lock
);

405 
§me_vr
:

407 ià(
æags
 & 
VRT_SET_LOCK_SYNC
)

408 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

410 ià((
æags
 & 
VRT_SET_RETURN_OLD
è&& 
Şd
) {

411 
	`vr_g‘
(
Şd
, 
VR_REFCNT_VRT_TEMP
);

412 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT
, 0);

413  
Şd
;

416 ià(
Şd
)

417 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT
, 2);

419  
NULL
;

420 
	}
}

422 
	$v¹_de¡roy_chunk
(
s
, 
e
)

424 
i
, 
j
;

425 
rm­s_butš
 *
r
;

428 
i
=
s
;i<
e
;i++) {

430 #ifdeà
DEBUG_ASSERT


431 #ifdeà
ENABLE_RMAP


433 
j
=0;j<
RMAPS_MAX
;j++) {

434 
r
 = &
	`FTABLE_RMAPS
(
i
,
j
);

436 ià(
r
->
rm­_couÁ
)

437 
	`my´štk
("WARN mâ:0x%x [%d] %d‚Úz”o!\n", 
i
, 
j
, 
r
->
rm­_couÁ
);

441 
	`v¹_£t
(
i
, 
NULL
, 
VRT_SET_LOCK_SYNC
 | 
VRT_SET_WAS_NULL
);

442 
	`MYASSERT
Ğ
	`FTABLE_NEXT
(
i
è=ğ-1 && 
	`FTABLE_PREV
(i) == -1);

444 
	}
}

447 
	$v¹_de¡roy
()

450 
sidx
, 
eidx
, 
nidx
;

451 
max_idx
 = (
max_pdx
 + 
PDX_GROUP_COUNT
 - 1) / PDX_GROUP_COUNT;

452 
	`my´štk
("%d…dx groups, %d couÁ, vb™[0]:%lx\n", 
max_idx
, 
PDX_GROUP_COUNT
, 
pdx_group_v®id
[0]);

453  
sidx
 = 0; ; sidx = 
nidx
 )

455 
eidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
max_idx
, 
sidx
);

456 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
max_idx
, 
eidx
);

457 iàĞ
nidx
 >ğ
max_idx
 )

459 
	`v¹_de¡roy_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

460 
eidx
 * 
PDX_GROUP_COUNT
);

462 iàĞ!
mem_hÙ¶ug
 )

463 
	`v¹_de¡roy_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

464 
max_·ge
);

466 
	`my·nic
("mem_hotplug set!?\n");

467 #ifdeà
__x86_64__


468 ià(
İt_®low_su³½age
)

469 
	`my·nic
("allow_superpage?\n");

473 
	`vr_put
(
£ed_x’
, 
VR_REFCNT_SEED
, 1);

474 
£ed_x’
 = 
NULL
;

475 
	`vr_put
(
£ed_k”Ãl
, 
VR_REFCNT_SEED
, 1);

476 
£ed_k”Ãl
 = 
NULL
;

477 
	`vr_put
(
£ed_u£r
, 
VR_REFCNT_SEED
, 1);

478 
£ed_u£r
 = 
NULL
;

479 #ifdeà
ENABLE_HOT_PAGES


480 
	`vr_put
(
£ed_u£r_hÙ
, 
VR_REFCNT_SEED
, 1);

481 
£ed_u£r_hÙ
 = 
NULL
;

483 
	`vr_put
(
glob®
, 
VR_REFCNT_GLOBAL
, 1);

484 
glob®
 = 
NULL
;

486 
	}
}

488 
	$š™_v¹_chunk
(
s
, 
e
)

490 
i
;

491 
i
=
s
;i<
e
;i++) {

492 
	`FTABLE_VR
(
i
èğ
NULL
;

493 
	`FTABLE_NEXT
(
i
) = -1;

494 
	`FTABLE_PREV
(
i
) = -1;

495 #ifdeà
ENABLE_RMAP


496 
j
;

497 
rm­s_butš
 *
rm­s
;

498 
j
=0;j<
RMAPS_MAX
;j++) {

499 
rm­s
 = &
	`FTABLE_RMAPS
(
i
,
j
);

500 
	`INIT_LIST_HEAD
(&
rm­s
->
rm­s_li¡
);

501 
	`š™_rm­s
(&
rm­s
->
deçuÉ_rm­s
, 
MAX_RMAP_ENTRIES_DEFAULT
);

502 
	`li¡_add
(&
rm­s
->
deçuÉ_rm­s
.
li¡
, &rm­s->
rm­s_li¡
);

503 
rm­s
->
rm­_couÁ
 = 0;

507 
i
=
s
;i<
e
;i++) {

508 
	`v¹_£t
(
i
, 
NULL
, 
VRT_SET_LOCK_SYNC
 | 
VRT_SET_INIT
);

510 
	}
}

512 
	$v¹_š™
()

514 
i
;

515 
	`MYASSERT
((
HYPERVISOR_VIRT_START
 & 
VRT_MASK
 ) == VRT_MASK);

517 
£ed_x’
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_XEN
);

518 
£ed_k”Ãl
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_KERNEL
);

519 
£ed_u£r
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_USER
);

520 #ifdeà
ENABLE_HOT_PAGES


521 
£ed_u£r_hÙ
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_SEED
, 
NEWVR_SEED_USER_HOT
);

523 
glob®
 = 
	`Ãw_v»giÚ
(
VR_REFCNT_GLOBAL
, 
NEWVR_GLOBAL
);

524 
	`MYASSERT
(
	`ÿchem­_is_glob®
(
glob®
));

526 
i
=0;i<
MFN_LOCKS_MAX
;i++) {

527 
	`¥š_lock_š™
(&
v¹_lock
[
i
]);

528 
	`¥š_lock_š™
(&
sync_lock
[
i
]);

532 
sidx
, 
eidx
, 
nidx
;

533 
max_idx
 = (
max_pdx
 + 
PDX_GROUP_COUNT
 - 1) / PDX_GROUP_COUNT;

534 
	`my´štk
("%d…dx groups, %d couÁ, vb™[0]:%lx\n", 
max_idx
, 
PDX_GROUP_COUNT
, 
pdx_group_v®id
[0]);

535  
sidx
 = 0; ; sidx = 
nidx
 )

537 
eidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
max_idx
, 
sidx
);

538 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
max_idx
, 
eidx
);

539 iàĞ
nidx
 >ğ
max_idx
 )

541 
	`š™_v¹_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

542 
eidx
 * 
PDX_GROUP_COUNT
);

544 iàĞ!
mem_hÙ¶ug
 )

545 
	`š™_v¹_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

546 
max_·ge
);

548 
	`my·nic
("mem_hotplug set!?\n");

549 #ifdeà
__x86_64__


550 ià(
İt_®low_su³½age
)

551 
	`my·nic
("allow_superpage?\n");

553 
	}
}

557 
	$check_v¹_chunk
(
s
, 
e
)

559 
i
, 
j
, 
couÁ
 = 0, 
couÁ2
 = 0, 
couÁ3
=0, 
couÁ4
=0, 
couÁ5
=0;

560 
Ãxt
, 
´ev
, 
max
 = 
e
-
s
;

561 
i
=
s
;i<
e
;i++) {

562 
v»giÚ_t
 *
vr
 = 
	`_v¹_g‘
(
i
, 
VR_REFCNT_VRT_TEMP
);

563 ià(
vr
) {

564 
	`vr_put
(
vr
, 
VR_REFCNT_VRT_TEMP
, 0);

567 
couÁ
++;

569 #ifdeà
ENABLE_RMAP


570 
j
=0;j<
RMAPS_MAX
;j++) {

571 
rm­s_butš
 *
r
;

572 
r
 = &
	`FTABLE_RMAPS
(
i
, 
j
);

573 ià(
r
->
rm­_couÁ
)

574 
couÁ2
++;

577 
Ãxt
 = 
	`FTABLE_NEXT
(
i
);

578 ià(
Ãxt
 != -1)

579 
couÁ3
++;

580 
´ev
 = 
	`FTABLE_PREV
(
i
);

581 ià(
´ev
 != -1)

582 
couÁ4
++;

584 
	`my´štk
("%d mâ (%d gue¡èš v¹ ha vr.\n", 
couÁ
, 
couÁ5
);

585 ià(
couÁ
 !ğ
max
)

586 
	`my´štk
("WARN!!! %d mâ !ğ%d max ?!?\n", 
couÁ
, 
max
);

587 #ifdeà
ENABLE_RMAP


588 ià(
couÁ2
)

589 
	`my´štk
("WARN!!! %d‚Ú-z”Ørm­ š FTABLE_RMAPS\n", 
couÁ2
);

591 ià(
couÁ3
 !ğ
max
)

592 
	`my´štk
("WARN!!! %d‚exˆš FTABLE_NEXT !ğ%d max\n", 
couÁ3
, 
max
);

593 ià(
couÁ4
 !ğ
max
)

594 
	`my´štk
("WARN!!! %d…»v iÀFTABLE_PREV !ğ%d max\n", 
couÁ4
, 
max
);

595 
	}
}

597 
	$check_v¹
()

600 
sidx
, 
eidx
, 
nidx
;

601 
max_idx
 = (
max_pdx
 + 
PDX_GROUP_COUNT
 - 1) / PDX_GROUP_COUNT;

602 
	`my´štk
("%d…dx groups, %d couÁ, vb™[0]:%lx\n", 
max_idx
, 
PDX_GROUP_COUNT
, 
pdx_group_v®id
[0]);

603  
sidx
 = 0; ; sidx = 
nidx
 )

605 
eidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
max_idx
, 
sidx
);

606 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
max_idx
, 
eidx
);

607 iàĞ
nidx
 >ğ
max_idx
 )

609 
	`check_v¹_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

610 
eidx
 * 
PDX_GROUP_COUNT
);

612 iàĞ!
mem_hÙ¶ug
 )

613 
	`check_v¹_chunk
(
sidx
 * 
PDX_GROUP_COUNT
,

614 
max_·ge
);

616 
	`my·nic
("mem_hotplug set!?\n");

617 #ifdeà
__x86_64__


618 ià(
İt_®low_su³½age
)

619 
	`my·nic
("allow_superpage?\n");

621 
	}
}

625 #ifdeà
ENABLE_RMAP


626 
šlše
 
	$vr_sub_rm­_couÁ
(
v»giÚ_t
 *
vr
, 
d
, 
rm­i
)

628 #ifdeà
DEBUG_ASSERT


629 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

630 ià(
vr
->
rm­_couÁ
[
rm­i
] < 
d
)

631 
	`my·nic
("rmap_count going‚egative?");

632 
	`MYASSERT
(
rm­i
 < 
RMAPS_MAX
);

634 
vr
->
rm­_couÁ
[
rm­i
] -ğ
d
;

636 
	}
}

637 
šlše
 
	$vr_add_rm­_couÁ
(
v»giÚ_t
 *
vr
, 
d
, 
rm­i
)

639 
vr
->
rm­_couÁ
[
rm­i
] +ğ
d
;

640 #ifdeà
DEBUG_ASSERT


641 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

642 ià(
vr
->
rm­_couÁ
[
rm­i
] < 
d
)

643 
	`my·nic
("rmap_count overflow (<d)?");

644 
	`MYASSERT
(
rm­i
 < 
RMAPS_MAX
);

647 
	}
}

649 
šlše
 
	$vr_dec_rm­_couÁ
(
v»giÚ_t
 *
vr
, 
rm­i
, 
rm­s_butš
 *
r
)

651 #ifdeà
DEBUG_ASSERT


652 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

653 ià(!
vr
->
rm­_couÁ
[
rm­i
])

654 
	`my·nic
("rmap_count going -1?");

655 ià(!
r
->
rm­_couÁ
)

656 
	`my·nic
("r„map_count going -1?");

657 
	`MYASSERT
(
rm­i
 < 
RMAPS_MAX
);

659 
vr
->
rm­_couÁ
[
rm­i
]--;

660 
r
->
rm­_couÁ
--;

662 
	}
}

663 
šlše
 
	$vr_šc_rm­_couÁ
(
v»giÚ_t
 *
vr
, 
rm­i
, 
rm­s_butš
 *
r
)

665 
vr
->
rm­_couÁ
[
rm­i
]++;

666 
r
->
rm­_couÁ
++;

667 #ifdeà
DEBUG_ASSERT


668 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

669 ià(!
vr
->
rm­_couÁ
[
rm­i
])

670 
	`my·nic
("rmap_count overflow?");

671 ià(!
r
->
rm­_couÁ
)

672 
	`my·nic
("r„map_count overflow?");

673 
	`MYASSERT
(
rm­i
 < 
RMAPS_MAX
);

676 
	}
}

679 
šlše
 
	$vr_dec_äame_couÁ
(
v»giÚ_t
 *
vr
)

681 
i
;

682 #ifdeà
DEBUG_ASSERT


683 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

684 ià(!
vr
->
äame_couÁ
)

685 
	`my·nic
("frame_count going -1?");

687 
vr
->
äame_couÁ
--;

689 #ifdeà
ENABLE_CACHEMAN1


690 
i
=0;i<
max_ÿche
;i++) {

691 ià(
	`‹¡_ÿcheš
(
vr
, 
i
)) {

692 
	`my¥š_lock
(&
ÿchemª
[
i
].
lock
, 57);

693 
ÿchemª
[
i
].
äames_couÁ
--;

695 
	`¥š_uÆock
(&
ÿchemª
[
i
].
lock
);

699 
	}
}

700 
šlše
 
	$vr_šc_äame_couÁ
(
v»giÚ_t
 *
vr
)

702 
i
;

703 
vr
->
äame_couÁ
++;

704 #ifdeà
DEBUG_ASSERT


705 ià(!
vr
->
äame_couÁ
)

706 
	`my·nic
("frame_count overflow?");

707 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

710 #ifdeà
ENABLE_CACHEMAN1


711 
i
=0;i<
max_ÿche
;i++) {

712 ià(
	`‹¡_ÿcheš
(
vr
, 
i
)) {

713 
	`my¥š_lock
(&
ÿchemª
[
i
].
lock
, 58);

714 
ÿchemª
[
i
].
äames_couÁ
++;

716 
	`¥š_uÆock
(&
ÿchemª
[
i
].
lock
);

720 
	}
}

723 
šlše
 
	$vr_g‘
(
v»giÚ_t
 *
vr
, 
loc
)

725 ià(!(
loc
 < 
MAX_VR_REFCNT
)) {

726 
	`my´štk
("TODO:†oc=%d\n", 
loc
);

727 
	`my·nic
("TODO:");

729 
	`MYASSERT
(
vr
);

730 ià(
	`©omic_šc_ªd_‹¡
(&
vr
->
vr_»fút
[
loc
]))

731 
	`my·nic
("BUG: vr_get");

732 
	}
}

736 
šlše
 
	$vr_put
(
v»giÚ_t
 *
vr
, 
loc
, 
hšt
)

738 ià(!(
loc
 < 
MAX_VR_REFCNT
)) {

739 
	`my´štk
("TODO:†oc=%d\n", 
loc
);

740 
	`my·nic
("TODO:");

742 
	`MYASSERT
(
vr
);

743 ià(!
	`©omic_dec_ªd_‹¡
(&
vr
->
vr_»fút
[
loc
])) {

744 
no_d–_v»giÚ
;

746 
i
;

747 
i
=0;i<
MAX_VR_REFCNT
;i++)

748 ià(
	`©omic_»ad
(&
vr
->
vr_»fút
[
i
]))

750 ià(
i
==
MAX_VR_REFCNT
) {

751 #ifdeà
DEBUG_ASSERT


752 ià(
hšt
 == 0) {

753 
	`´št_v»giÚ
(
vr
, 0);

754 
	`my´štk
("WARN shouldn'ˆd–‘v¸h”e..loc:%d\n", 
loc
);

755 
	`my·nic
("vr_put\n");

759 
	`d–_v»giÚ
(
vr
);

762 
no_d–_v»giÚ
:

763 #ifdeà
DEBUG_ASSERT


764 ià(
hšt
 == 1)

766 
	`my´štk
("WARN vr_puˆdidn'ˆd– it?†oc=%d\n", 
loc
);

767 
	`´št_v»giÚ
(
vr
, 0);

771 
	}
}

774 
	$š™_v»giÚ_poŞs
()

776 
i
,
j
;

777 
i
=0;i<
MAX_VREGION_1MB_POOL
;i++) {

778 
v»giÚ_1mb_poŞ
[
i
] = 
NULL
;

780 
v»giÚ_1mb_poŞ_couÁ
 = 0;

782 
num_v»giÚs_³r_1mb
 = (1024*1024-256)/(
v»giÚ_t
);

783 
i
=0;i<
MAX_VREGION_1MB_POOL
;i++) {

784 
v»giÚ_1mb_poŞ
[
i
] = 
	`myxm®loc_by‹s
Ğ(
v»giÚ_t
è* 
num_v»giÚs_³r_1mb
 , 6);

785 ià(!
v»giÚ_1mb_poŞ
[
i
])

787 
	`mem£t
(
v»giÚ_1mb_poŞ
[
i
], 0, (
v»giÚ_t
è* 
num_v»giÚs_³r_1mb
);

788 
v»giÚ_1mb_poŞ_couÁ
++;

791 
	`¥š_lock_š™
(&
v»giÚs_£ed_lock
);

792 
	`¥š_lock_š™
(&
v»giÚs_ä“_lock
);

793 
	`INIT_LIST_HEAD
(&
v»giÚs_£ed
);

794 
	`INIT_LIST_HEAD
(&
v»giÚs_ä“
);

795 
v»giÚs_£ed_couÁ
 = 0;

796 
v»giÚs_ä“_couÁ
 = 0;

797 
v»giÚs_xm®loc_couÁ
 = 0;

798 
i
=0;i<
v»giÚ_1mb_poŞ_couÁ
;i++) {

799 
j
=0;j<
num_v»giÚs_³r_1mb
;j++) {

800 
v»giÚ_t
 *
vr
 = &(
v»giÚ_1mb_poŞ
[
i
])[
j
];

801 
	`š™_v»giÚ
(
vr
);

802 
	`li¡_add
(&
vr
->
u
.
vr_li¡
, &
v»giÚs_ä“
);

803 
v»giÚs_ä“_couÁ
++;

806 
	`my´štk
("%d-sized %d…oŞs\n", 
num_v»giÚs_³r_1mb
, 
v»giÚ_1mb_poŞ_couÁ
);

807 ià(
v»giÚ_1mb_poŞ_couÁ
 !ğ
MAX_VREGION_1MB_POOL
) {

808 
	`my´štk
("WARN: couldn'ˆ®loÿ‹‡Î %d v»giÚ…oŞs??\n", 
MAX_VREGION_1MB_POOL
);

810 
	`my´štk
("tÙ:%d f»v»giÚs.\n", 
v»giÚs_ä“_couÁ
);

811 
	`my´št_x’h—p
();

812 
	}
}

814 
	$ş—n_v»giÚ
(
v»giÚ_t
 *
vr
)

817 ià(
vr
->
æags
) {

818 
	`my´štk
("WARN! still has flags..\n");

819 
	`´št_v»giÚ
(
vr
, 0);

821 
vr
->
æags
 = 0;

822 
	`INIT_LIST_HEAD
(&
vr
->
u
.
vr_li¡
);

823 
	}
}

826 
	$š™_v»giÚ
(
v»giÚ_t
 *
vr
)

828 
i
;

829 
	`INIT_LIST_HEAD
(&
vr
->
u
.
vr_li¡
);

830 #ifdeà
ENABLE_GLOBAL_LIST


831 
	`INIT_LIST_HEAD
(&
vr
->
glob®_li¡
);

833 
i
=0;i<
MAX_VR_REFCNT
;i++)

834 
	`©omic_£t
(&
vr
->
vr_»fút
[
i
], 0);

835 
	`¥š_lock_š™
(&
vr
->
lock
);

836 #ifdeà
ENABLE_ADD_RMAP_OPTIMIZATION


837 
vr
->
ä“_rm­s
 = &vr->
deçuÉ_rm­s
;

838 
vr
->
ä“_rm­i
 = 0;

840 
vr
->
äame_couÁ
 = 0;

841 
i
=0;i<
RMAPS_MAX
;i++)

842 
vr
->
rm­_couÁ
[
i
] = 0;

843 
vr
->
æags
 = 0;

844 
vr
->
h—d
 = -1;

846 
	}
}

850 
	$d–_v»giÚ_commÚ
(
v»giÚ_t
 *
vr
)

852 
i
;

854 #ifdeà
DEBUG_ASSERT


855 
rm­_£t
 *
rms
;

856 
	`my¥š_lock
(&
vr
->
lock
,65);

857 ià(
	`ÿchem­_couÁ
(
vr
))

858 
	`my´štk
("nÚz”Øÿchem­_couÁ %d!\n", 
	`ÿchem­_couÁ
(
vr
));

859 ià(
	`ÿche_š_couÁ
(
vr
))

860 
	`my´štk
("nÚz”Øÿche_š_couÁ %d!\n", 
	`ÿche_š_couÁ
(
vr
));

861 ià(
vr
->
rm­_couÁ
[
RMAPS_USER
])

862 
	`my´štk
("nÚz”Ørm­_couÁ u£¸%d!\n", 
vr
->
rm­_couÁ
[
RMAPS_USER
]);

863 ià(
vr
->
rm­_couÁ
[
RMAPS_KERNEL
])

864 
	`my´štk
("nÚz”Ørm­_couÁ k”ÃÈ%d!\n", 
vr
->
rm­_couÁ
[
RMAPS_KERNEL
]);

865 ià(
vr
->
äame_couÁ
)

866 
	`my´štk
("nÚz”Øäame_couÁ %d!\n", 
vr
->
äame_couÁ
);

867 ià(
vr
->
h—d
 != -1) {

868 
	`my´štk
("h—d==%d i nÙ -1\n", 
vr
->
h—d
);

869 #ifdeà
ENABLE_RMAP


870 ià(!
	`is_rm­s_em±y
(
vr
)) {

871 
	`my´štk
("not-empty„maps!\n");

875 
	`¥š_uÆock
(&
vr
->
lock
);

877 
i
=0;i<
MAX_VR_REFCNT
;i++) {

878 ià(
	`©omic_»ad
(&
vr
->
vr_»fút
[
i
])) {

879 
	`my·nic
("should‚ot happen..\n");

883 
i
=0;i<
v»giÚ_1mb_poŞ_couÁ
;i++) {

884 ià(()
vr
>=()
v»giÚ_1mb_poŞ
[
i
] && ()vr<()v»giÚ_1mb_poŞ[i]+
num_v»giÚs_³r_1mb
*(
v»giÚ_t
)) {

885 
	`ş—n_v»giÚ
(
vr
);

887 
	`my¥š_lock
(&
v»giÚs_ä“_lock
, 42);

888 
	`li¡_add
(&
vr
->
u
.
vr_li¡
, &
v»giÚs_ä“
);

889 
v»giÚs_ä“_couÁ
++;

890 
	`¥š_uÆock
(&
v»giÚs_ä“_lock
);

894 ià(
i
==
v»giÚ_1mb_poŞ_couÁ
) {

895 
	`myxä“
(
vr
, 2);

897 
	}
}

900 
	$d–_v»giÚ
(
v»giÚ_t
 *
vr
)

902 
i
, 
j
;

903 #ifdeà
DEBUG_ASSERT


904 ià(
vr
->
äame_couÁ
 || vr->
rm­_couÁ
[
RMAPS_USER
] || vr->rm­_couÁ[
RMAPS_KERNEL
]) {

905 
	`my´štk
("%d f¿me, %d,%d„m­??\n", 
vr
->
äame_couÁ
, vr->
rm­_couÁ
[
RMAPS_USER
], vr->rm­_couÁ[
RMAPS_KERNEL
]);

906 
	`´št_v»giÚ
(
vr
, 
VRPRINT_RMAP
);

907 
	`my·nic
("non-empty„egiono delete?");

909 #ifdeà
ENABLE_HISTOGRAM


911 
i
=0;i<
MAX_CACHE
;i++)

912 
j
=0;j<32;j++)

913 
	`MYASSERT
(
vr
->
ab™_hi¡og¿m
[
i
][
j
] == 0);

917 #ifdeà
ENABLE_CACHEMAN1


919 
	`ÿche_out_®l
(
vr
);

921 
vr
->
æags
 &ğ((1UL<<
VR_ATTR_START
)-1);

922 #ifdeà
ENABLE_VREGION_MAPPING


923 
tmp
;

924 
	`my¥š_lock
(&
vr
->
lock
, 82);

925 
i
=0;i<
MAX_CACHE
;i++) {

926 
tmp
 = 
	`is_v»giÚ_ÿche_m­³d
(
vr
, 
i
);

927 ià(!
tmp
) {

928 
	`İ’_v»giÚ_ÿche
(
vr
, 
i
);

931 
	`¥š_uÆock
(&
vr
->
lock
);

934 #ifdeà
ENABLE_GLOBAL_LIST


936 
	`my¥š_lock
(&
v»giÚs_£ed_lock
, 9);

937 
	`li¡_d–
(&
vr
->
glob®_li¡
);

938 
v»giÚs_£ed_couÁ
--;

939 
	`¥š_uÆock
(&
v»giÚs_£ed_lock
);

941 
	`d–_v»giÚ_commÚ
(
vr
);

942 
	}
}

945 
v»giÚ_t
 *
	$Ãw_v»giÚ_commÚ
()

947 
v»giÚ_t
 *
vr
 = 
NULL
;

948 
i
, 
j
;

949 
	`my¥š_lock
(&
v»giÚs_ä“_lock
, 12);

950 ià(
	`li¡_em±y
(&
v»giÚs_ä“
)) {

951 
	`¥š_uÆock
(&
v»giÚs_ä“_lock
);

952 
v»giÚs_xm®loc_couÁ
++;

954 
vr
 = 
	`myxm®loc
(
v»giÚ_t
, 2);

955 ià(
vr
==
NULL
)

956 
	`my·nic
("new_vregion: xmalloc failed??");

957 
	`š™_v»giÚ
(
vr
);

960 
vr
 = 
	`li¡_’Œy
(
v»giÚs_ä“
.
Ãxt
 , 
v»giÚ_t
, 
u
.
vr_li¡
);

961 
	`li¡_d–
(&
vr
->
u
.
vr_li¡
);

962 
v»giÚs_ä“_couÁ
--;

963 
	`¥š_uÆock
(&
v»giÚs_ä“_lock
);

965 
i
=0;i<
MAX_VR_REFCNT
;i++) {

966 
	`MYASSERT
(!
	`©omic_»ad
(&
vr
->
vr_»fút
[
i
]));

968 
	`MYASSERT
(!
	`¥š_is_locked
(&
vr
->
lock
));

969 #ifdeà
ENABLE_RMAP


970 
	`MYASSERT
(
	`is_rm­s_em±y
(
vr
));

972 
	`MYASSERT
(!
vr
->
äame_couÁ
);

973 
	`MYASSERT
(!
vr
->
rm­_couÁ
[
RMAPS_USER
]);

974 
	`MYASSERT
(!
vr
->
rm­_couÁ
[
RMAPS_KERNEL
]);

975 ià(
vr
->
æags
) {

976 
	`´št_v»giÚ
(
vr
, 0);

977 
	`my´štk
("not-cleaned vrflags\n");

978 
	`MYASSERT
(!
vr
->
æags
);

980 
	`MYASSERT
(
vr
->
h—d
 == -1);

981 #ifdeà
ENABLE_ADD_RMAP_OPTIMIZATION


982 
	`MYASSERT
(
vr
->
ä“_rm­s
 =ğ&vr->
deçuÉ_rm­s
);

983 
	`MYASSERT
(
vr
->
ä“_rm­i
 == 0);

988 #ifdeà
ENABLE_ABIT


991 #ifdeà
ENABLE_HISTOGRAM


992 
j
=0;j<
MAX_CACHE
;j++)

993 
i
=0;i<32;i++)

994 
	`MYASSERT
(
vr
->
ab™_hi¡og¿m
[
i
][
j
] == 0);

997 #ifdeà
ENABLE_REGIONING3


998 
vr
->
ošt
 = 0;

999 
vr
->
acûss
 = 0;

1001 
vr
->
u
.
šu£
.
cmª
 = 
NULL
;

1002 
vr
->
u
.
šu£
.
em±y
 = 
NULL
;

1003  
vr
;

1004 
	}
}

1007 
v»giÚ_t
 *
	$Ãw_v»giÚ
(
loc
, 
æags
)

1009 
v»giÚ_t
 *
vr
;

1010 
vr
 = 
	`Ãw_v»giÚ_commÚ
();

1011 
	`vr_g‘
(
vr
, 
loc
);

1013 
	`my¥š_lock
(&
vr
->
lock
, 130);

1014 
	`MYASSERT
(
vr
->
æags
 == 0);

1015 
vr
->
æags
 = flags;

1016 
	`¥š_uÆock
(&
vr
->
lock
);

1017 #ifdeà
ENABLE_GLOBAL_LIST


1020 
	`my¥š_lock
(&
v»giÚs_£ed_lock
, 74);

1021 
	`li¡_add
(&
vr
->
glob®_li¡
, &
v»giÚs_£ed
);

1022 
v»giÚs_£ed_couÁ
++;

1023 
	`¥š_uÆock
(&
v»giÚs_£ed_lock
);

1025  
vr
;

1026 
	}
}

1030 
	$¥l™_v»giÚ
(
v»giÚ_t
 *
vr
, v»giÚ_ˆ*
to
)

1032 
mâ
;

1033 
v»giÚ_t
 *
Şd
;

1035 
mâ
 = 
vr
->
h—d
;

1036 
	`my¥š_lock
(&
	`SYNC_LOCK
(
mâ
), 50);

1037 
	`my¥š_lock
(&
vr
->
lock
, 8);

1038 ià(
vr
->
h—d
 != -1) {

1039 ià(
mâ
 !ğ
vr
->
h—d
) {

1040 
	`my´štk
("retry..\n");

1041 
	`¥š_uÆock
(&
vr
->
lock
);

1042 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

1045 
	`¥š_uÆock
(&
vr
->
lock
);

1046 
Şd
 = 
	`v¹_£t
(
mâ
, 
to
, 
VRT_SET_RETURN_OLD
);

1048 
	`MYASSERT
(
Şd
 =ğ
vr
);

1049 ià(
Şd
)

1050 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 0);

1052 
	`MYASSERT
(!
vr
->
äame_couÁ
);

1053 
	`¥š_uÆock
(&
vr
->
lock
);

1054 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

1057 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

1059 
	}
}

1061 
	$m”ge_v»giÚ
(
v»giÚ_t
 *
vr
, v»giÚ_ˆ*
to
)

1063 
	`MYASSERT
(
	`‹¡_b™
(
VR_REGULAR
, &
vr
->
æags
è&&e¡_b™(VR_REGULAR, &
to
->flags));

1064 
	`MYASSERT
(
vr
->
æags
 =ğ
to
->flags);

1065 
	`¥l™_v»giÚ
(
vr
, 
to
);

1066 
	}
}

	@rmap.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

25 #ifdeà
ENABLE_RMAP


27 
	#RME_MASK
 0xFFFF000000000000

	)

28 
	#RME_MASK_PTI
 0x0FFF000000000000

	)

29 
	#RME_MASK_FLAG
 0xF000000000000000

	)

30 
	#RME_PTI_SHIFT
 48

	)

31 
	#RME_FLAG_SHIFT
 60

	)

32 
šlše
 
·ge_bË
 *
	$rme_±
(
±r
)

34 ià((~
RME_MASK
)&
±r
 == 0)

35  
NULL
;

36  
RME_MASK
|
±r
;

37 
	}
}

39 
šlše
 
	$rme_±i
(
±r
)

41 
»t
 = (
RME_MASK_PTI
&
±r
)>>
RME_PTI_SHIFT
;

42 
	`MYASSERT
(
»t
>=0 &&„‘<
L4_PAGETABLE_ENTRIES
);

43  
»t
;

44 
	}
}

46 
šlše
 
	$rme_£t
(*
±r
, 
·ge_bË
 *
±
, 
±i
)

48 
	`MYASSERT
(
±i
>=0 &&…ti<
L4_PAGETABLE_ENTRIES
);

49 *
±r
 = ((~
RME_MASK
è& (()
±
)è| (((()
±i
)<<
RME_PTI_SHIFT
è& 
RME_MASK_PTI
);

50 
	}
}

53 
šlše
 
	$rme_£t_æag
(*
±r
, 
f
)

55 *
±r
 = ((~
RME_MASK_FLAG
è& (*±r)è| (((()
f
)<<
RME_FLAG_SHIFT
) & RME_MASK_FLAG);

56 
	}
}

58 
	$´št_rm­s
(
v»giÚ_t
 *
vr
)

60 
rm­_£t
 *
rms
;

61 
·ge_bË
 *
±
;

62 
±i
;

63 
i
;

64 ià(
vr
->
rm­_couÁ
[0] > 20) {

65 
	`my´štk
("rmap skip...\n");

68 ià(
vr
->
h—d
 == -1) {

69 
	`my´štk
("vr->head == -1\n");

73 
rm­s_butš
 *
r
;

74 
¡¬t
 = 
vr
->
h—d
;

75 
cur
 = 
¡¬t
;

76 
z
;

78 
z
=0;z<
RMAPS_MAX
;z++) {

79 
r
 = &
	`FTABLE_RMAPS
(
cur
, 
z
);

80 
	`my´štk
("mâ:%x [%d] couÁ:%d\n", 
cur
, 
z
, 
r
->
rm­_couÁ
);

81 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
r
->
rm­s_li¡
, 
li¡
) {

82 
	`my´štk
("Ôms:%d/%d/%d)\n", 
rms
->
æag_couÁ
,„ms->
’Œy_couÁ
,„ms->
size
);

83 
i
=0;i<
rms
->
size
;i++) {

84 
±
 = 
	`rme_±
(
rms
->
rm­s
[
i
]);

85 
±i
 = 
	`rme_±i
(
rms
->
rm­s
[
i
]);

86 ià(!
±
)

88 
l1_pg’Œy_t
 *
l1t
 = 
±
->
shadow
[0];

89 
l1_mâ
 = 
	`l1e_g‘_š‹
(
l1t
[
±i
]);

90 
	`my´štk
("(vr:%°up_±:%°±mâ:%lx…ti:%3x mâ:%3lx ) va:%lx\n", 
vr
, 
±
->
up_±
,…t->
mâ
, 
±i
, 
l1_mâ
, 
	`g‘_va
(pt,…ti) );

94 
cur
 = 
	`FTABLE_NEXT
(cur);

95 } 
cur
 !ğ
¡¬t
);

97 
	}
}

100 
	$is_rm­s_em±y
(
v»giÚ_t
 *
vr
)

102 
i
, 
couÁ
;

103 
rm­_£t
 *
rms
;

105 ià(
vr
->
h—d
 == -1)

108 
rm­s_butš
 *
r
;

109 
¡¬t
 = 
vr
->
h—d
;

110 
cur
 = 
¡¬t
;

112 
r
 = &
	`FTABLE_RMAPS
(
cur
, 
RMAPS_USER
);

113 
couÁ
 = 0;

114 
	`MYASSERT
(!
	`li¡_em±y
(&
r
->
rm­s_li¡
));

115 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
r
->
rm­s_li¡
, 
li¡
) {

116 ià(
rms
 !ğ&
r
->
deçuÉ_rm­s
)

118 
couÁ
++;

119 
i
=0;i<
rms
->
size
;i++) {

120 ià(
	`rme_±
(
rms
->
rm­s
[
i
])) {

125 ià(
couÁ
 != 1)

128 
cur
 = 
	`FTABLE_NEXT
(cur);

129 } 
cur
 !ğ
¡¬t
);

131 
	}
}

133 
	$š™_rm­s
(
rm­_£t
 *
rms
, 
size
) {

134 
i
;

135 
i
=0;i<
size
;i++) {

136 
rms
->
rm­s
[
i
] = 0;

138 
rms
->
’Œy_couÁ
 = 0;

139 
rms
->
æag_couÁ
 = 0;

140 
rms
->
size
 = size;

141 
	`INIT_LIST_HEAD
(&
rms
->
li¡
);

142 
	}
}

145 
	$add_rm­_’Œy
(
rm­_£t
 *
rms
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

147 
i
;

148 
i
=0;i<
rms
->
size
;i++) {

149 ià(
	`rme_±
(
rms
->
rm­s
[
i
]) == 0) {

150 
	`rme_£t
(&
rms
->
rm­s
[
i
] , 
±
, 
±šdex
);

155 
	}
}

158 
	$add_rm­_commÚ
(
v»giÚ_t
 *
vr
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
, 
rm­i
)

160 
rm­_£t
 *
rms
;

161 
rm­s_butš
 *
r
;

162 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

163 #ifdeà
ENABLE_KERNEL_SHADOW


164 #ifdeà
ENABLE_DEBUG


165 ià(
rm­i
 =ğ
RMAPS_KERNEL
 && 
r
->
rm­_couÁ
) {

166 
	`my´štk
("INFO kernel double mapping\n");

170 
	`MYASSERT
(
	`FTABLE_NEXT
(
mâ
) != -1);

171 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
r
->
rm­s_li¡
, 
li¡
) {

172 ià(
	`add_rm­_’Œy
(
rms
, 
±
, 
±šdex
, 
mâ
))

175 ià(&
rms
->
li¡
==&
r
->
rm­s_li¡
) {

176 
rms
 = (
rm­_£t
 *)
	`myxm®loc_by‹s
((rm­_£t)+
MAX_RMAP_ENTRIES_IN_SET
*(), 1);

177 ià(
rms
==0) {

178 
	`my·nic
("xmalloc failed!\n");

181 
	`š™_rm­s
(
rms
, 
MAX_RMAP_ENTRIES_IN_SET
);

182 
	`add_rm­_’Œy
(
rms
, 
±
, 
±šdex
, 
mâ
);

183 
	`li¡_add_
(&
rms
->
li¡
, &
r
->
rm­s_li¡
);

185 
	`vr_šc_rm­_couÁ
(
vr
, 
rm­i
, 
r
);

186 
	}
}

190 
	$add_rm­
(
v»giÚ_t
 *
vr
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
, 
rm­i
)

192 
	`MYASSERT
(
	`¥š_is_locked
(&
vr
->
lock
));

193 
rm­_’Œy
 *
rme
;

194 
ÿche
;

195 #ifdeà
DEBUG_CHECK_DUPLICATE_RMAP


196 
rme
 = 
	`fšd_rm­
(
vr
, 
±
, 
±šdex
, 
mâ
);

197 ià(
rme
) {

198 
	`my´štk
("®»adyƒxi¡s!!…gd:%x[%d]…t->mâ=%x(%d),l1e_pâ=%x,„m->±->pgd:%x[%d]„m->±->mâ:%x(%d)\n", 
±
->
pgd
->
mâ
,…t->
pgd_šdex
,…t->mâ, 
±šdex
, mâ, 
rme
->pt->pgd->mfn,„me->pt->pgd_index,„me->pt->mfn,„me->ptindex);

199 
	`¥š_uÆock
(&
vr
->
lock
);

203 
	`add_rm­_commÚ
(
vr
,
±
,
±šdex
,
mâ
,
rm­i
);

205 
	}
}

212 
	$d–_rm­_’Œy
(
rm­_£t
 *
rms
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

214 
i
, 
em±y
=1, 
sucûss
=0;

215 
	`MYASSERT
(
±
);

216 
i
=0;i<
rms
->
size
;i++) {

217 ià(!
	`rme_±
(
rms
->
rm­s
[
i
]))

219 
l1_pg’Œy_t
 *
l1t
 = 
	`rme_±
(
rms
->
rm­s
[
i
])->
shadow
[0];

223 ià(
	`rme_±
(
rms
->
rm­s
[
i
]è=ğ
±
 && 
	`rme_±i
Ôms->rm­s[i]è=ğ
±šdex
)

225 #iâdeà
ENABLE_HETERO


226 #ifdeà
DEBUG_WARN


231 
	`rme_£t
(&
rms
->
rm­s
[
i
], 
NULL
, 0);

233 #ifdeà
DEBUG_ASSERT


234 ià(
sucûss
 && 
±
)

235 
	`my·nic
("already success==1 when…t!=0 ?");

237 
sucûss
 = 1;

239 
em±y
 = 0;

241  
sucûss
+
em±y
*2;

242 
	}
}

244 
	$d–_rm­
(
·ge_bË
 *
±
, 
±šdex
, 
mâ
, 
rm­i
)

246 
rm­_£t
 *
rms
, *
n
;

247 
v»giÚ_t
 *
vr
;

248 
»t
 , 
sucûss
 = 0;

249 
v»giÚ_t
 *
Ãw_´iv©e_vr
 = 
NULL
;

250 
rm­s_butš
 *
r
;

251 
tÙ®_rm­
, 
sync_locked
 = 0;

252 
i
;

261 ià(
mši_aùiv©ed
)

262 
	`my·nic
("vr==NULL while mini_activated??");

266 
agaš
:

267 
vr
 = 
	`v¹_g‘
(
mâ
, 
VR_REFCNT_RMAP
, 
sync_locked
);

268 
	`MYASSERT
(
vr
);

271 ià(!
sync_locked
) {

273 
tÙ®_rm­
 = 0;

274 
i
=0;i<
RMAPS_MAX
;i++) {

275 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
i
);

276 
tÙ®_rm­
 +ğ
r
->
rm­_couÁ
;

278 ià(
tÙ®_rm­
 == 1) {

279 
	`¥š_uÆock
(&
vr
->
lock
);

280 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

283 
sync_locked
 = 1;

284 
	`my¥š_lock
(&
	`SYNC_LOCK
(
mâ
), 6);

285 
agaš
;

289 #ifdeà
ENABLE_BITMAP_VRT


291 
ÿche
;

292 
ÿche
=0;ÿche<
MAX_CACHE
;cache++) {

293 ià(
	`‹¡_b™m­
(
±
, 
±šdex
, 
ÿche
))

294 
	`şo£_b™m­
(
±
, 
±šdex
, 
ÿche
);

298 
	`MYASSERT
(
vr
->
h—d
 != -1);

300 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

301 
	`li¡_fÜ_—ch_’Œy_§ã
(
rms
, 
n
, &
r
->
rm­s_li¡
, 
li¡
) {

302 
»t
 = 
	`d–_rm­_’Œy
(
rms
, 
±
, 
±šdex
, 
mâ
);

303 
»t
) {

305 ià(
rms
 !ğ&
r
->
deçuÉ_rm­s
) {

306 
	`li¡_d–
(&
rms
->
li¡
);

307 
	`myxä“
(
rms
, 1);

310 
	`vr_dec_rm­_couÁ
(
vr
, 
rm­i
, 
r
);

311 #ifdeà
DEBUG_ASSERT


312 ià(
sucûss
 && 
±
) {

313 
	`my·nic
("already success==1 in del_rmap,…t!=0?");

316 
sucûss
 = 1;

320 ià(
rms
 =ğ&
r
->
deçuÉ_rm­s
)

323 
	`my´štk
("»t:%d vr:%x,„ms:%x\n",
»t
, 
vr
, 
rms
);

324 
	`my·nic
("bug!ƒmpty„map_set??");

330 ià(
rm­i
 =ğ
RMAPS_USER
 && 
	`‹¡_b™
(
VR_USER
, &
vr
->
æags
è&& 
sucûss
) {

331 
rm­s_butš
 *
r
;

332 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

333 #ifdeà
ENABLE_HETERO


334 ià(
r
->
rm­_couÁ
 == 0) {

335 
	`h‘”o_ä“
(
mâ
);

338 ià(
r
->
rm­_couÁ
 =ğ0 && 
vr
 =ğ
£ed_u£r_hÙ
 ) {

339 
	`¥š_uÆock
(&
vr
->
lock
);

340 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

342 
v»giÚ_t
 *
vr2
, *
Şd
;

343 
vr2
 = 
	`g‘_£ed_u£r
();

344 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
, 100, !
sync_locked
);

345 
	`MYASSERT
(
Şd
 =ğ
vr
);

346 ià(
Şd
)

347 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

348 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

349 
vr
 = 
vr2
;

350 
	`FTABLE_ABIT
(
mâ
) = 0;

351 
	`FTABLE_TIME
(
mâ
) = 0;

352 #ifdeà
DEBUG_ASSERT


353 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
RMAPS_KERNEL
);

354 
	`MYASSERT
(
r
->
rm­_couÁ
 == 0);

359 #ifdeà
ENABLE_VR_USER


360 ià(
rm­i
 =ğ
RMAPS_USER
 && 
	`‹¡_b™
(
VR_USER
, &
vr
->
æags
è&& 
sucûss
) {

361 
rm­s_butš
 *
r
;

362 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

363 ià(
r
->
rm­_couÁ
 == 0) {

364 
	`¥š_uÆock
(&
vr
->
lock
);

365 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

367 
v»giÚ_t
 *
vr2
, *
Şd
;

368 
vr2
 = 
	`g‘_£ed_k”Ãl
();

369 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
, 100, !
sync_locked
);

370 
	`MYASSERT
(
Şd
 =ğ
vr
);

371 ià(
Şd
)

372 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

373 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

374 
vr
 = 
vr2
;

375 #ifdeà
DEBUG_ASSERT


376 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
RMAPS_KERNEL
);

377 
	`MYASSERT
(
r
->
rm­_couÁ
 != 0);

382 #ifdeà
ENABLE_VR_KERNEL


383 ià(
rm­i
 =ğ
RMAPS_KERNEL
 && 
	`‹¡_b™
(
VR_KERNEL
, &
vr
->
æags
è&& 
sucûss
) {

384 
rm­s_butš
 *
r
;

385 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

386 ià(
r
->
rm­_couÁ
 == 0) {

387 
	`¥š_uÆock
(&
vr
->
lock
);

388 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

390 
v»giÚ_t
 *
vr2
, *
Şd
;

391 
vr2
 = 
	`g‘_£ed_x’
();

392 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
, 100, !
sync_locked
);

393 
	`MYASSERT
(
Şd
 =ğ
vr
);

394 ià(
Şd
)

395 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

396 
	`vr_g‘
(
vr2
, 
VR_REFCNT_RMAP
);

397 
vr
 = 
vr2
;

398 #ifdeà
DEBUG_ASSERT


399 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
RMAPS_USER
);

400 
	`MYASSERT
(
r
->
rm­_couÁ
 == 0);

406 ià(
rm­i
 =ğ
RMAPS_KERNEL
 && 
	`‹¡_b™
(
VR_KERNEL
, &
vr
->
æags
è&& 
sucûss
) {

407 
rm­s_butš
 *
r
;

408 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
rm­i
);

409 ià(
r
->
rm­_couÁ
 == 0) {

410 
	`¥š_uÆock
(&
vr
->
lock
);

411 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

413 
	`MYASSERT
(
sync_locked
);

414 
v»giÚ_t
 *
vr2
, *
Şd
;

415 
Şd
 = 
	`v¹_£t
(
mâ
, 
NULL
, 1, 
VRT_SET_LOCK_SYNC
);

416 
vr2
 = 
	`v¹_g‘
(
mâ
, 
VR_REFCNT_RMAP
, 1);

417 
	`MYASSERT
(
Şd
 =ğ
vr
);

418 ià(
Şd
)

419 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 2);

420 
vr
 = 
vr2
;

421 #ifdeà
DEBUG_ASSERT


422 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
RMAPS_USER
);

423 
	`MYASSERT
(
r
->
rm­_couÁ
 == 0);

431 
tÙ®_rm­
 = 0;

432 
i
=0;i<
RMAPS_MAX
;i++) {

433 
r
 = &
	`FTABLE_RMAPS
(
mâ
, 
i
);

434 
tÙ®_rm­
 +ğ
r
->
rm­_couÁ
;

436 ià(!
tÙ®_rm­
 && 
	`‹¡_b™
(
VR_SHRINK_NORMAP
, &
vr
->
æags
)) {

437 
v»giÚ_t
 *
vr2
, *
Şd
;

438 
vr2
 = 
	`g‘_£ed_u£r
();

440 
	`MYASSERT
(
sync_locked
);

441 
Şd
 = 
	`v¹_£t
(
mâ
, 
vr2
, 100, !
sync_locked
);

442 
	`MYASSERT
(
Şd
 =ğ
vr
);

443 
	`MYASSERT
(
	`¥š_is_locked
(&
Şd
->
lock
));

444 ià(
Şd
)

445 
	`vr_put
(
Şd
, 
VR_REFCNT_VRT_TEMP
, 0);

448 ià(
sync_locked
) {

449 
	`¥š_uÆock
(&
	`SYNC_LOCK
(
mâ
));

450 
sync_locked
 = 0;

452 ià(
vr
->
rm­_couÁ
[
RMAPS_USER
] =ğ0 && vr->rm­_couÁ[
RMAPS_KERNEL
] == 0)

454 
i
;

455 
	`check_v»giÚ
(
vr
, 1);

456 
	`MYASSERT
(
sucûss
);

457 
	`¥š_uÆock
(&
vr
->
lock
);

458 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 2);

459  
sucûss
;

461 
	`¥š_uÆock
(&
vr
->
lock
);

462 
	`vr_put
(
vr
, 
VR_REFCNT_RMAP
, 0);

463  
sucûss
;

464 
	}
}

467 *
	$fšd_rm­_’Œy
(
rm­_£t
 *
rms
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

469 
i
;

471 
i
=0;i<
rms
->
size
;i++) {

472 ià(
	`rme_±
(
rms
->
rm­s
[
i
]è=ğ
±
 && 
	`rme_±i
Ôms->rm­s[i]è=ğ
±šdex
) {

473 #ifdeà
DEBUG_WARN


474 
l1_pg’Œy_t
 *
l1t
 = 
	`rme_±
(
rms
->
rm­s
[
i
])->
shadow
[0];

475 
l1_mâ
 = 
	`l1e_g‘_pâ
(
l1t
[
	`rme_±i
(
rms
->
rm­s
[
i
])]);

476 ià(
l1_mâ
 !ğ
mâ
)

477 
	`my´štk
("WARN! fšd_rm­. found buˆdifã»Á†1e_pâ.„m:%x !ğnow:%x\n", 
l1_mâ
, 
mâ
 );

479  &
rms
->
rm­s
[
i
];

483 
	}
}

486 *
	$fšd_rm­
(
v»giÚ_t
 *
vr
, 
·ge_bË
 *
±
, 
±šdex
, 
mâ
)

488 #ifdeà
DEBUG_ASSERT


489 ià(!
	`¥š_is_locked
(&
vr
->
lock
))

490 
	`my·nic
("find_rmap: grep vr->lock first!");

492 
rm­_£t
 *
rms
;

493 *
»t
;

495 ià(
vr
->
h—d
 == -1)

497 
rm­s_butš
 *
r
;

498 
¡¬t
 = 
vr
->
h—d
;

499 
cur
 = 
¡¬t
;

501 
r
 = &
	`FTABLE_RMAPS
(
cur
, 
RMAPS_USER
);

502 
	`li¡_fÜ_—ch_’Œy
(
rms
, &
r
->
rm­s_li¡
, 
li¡
) {

503 ià((
»t
 = 
	`fšd_rm­_’Œy
(
rms
, 
±
, 
±šdex
, 
mâ
)))

504  
»t
;

506 
cur
 = 
	`FTABLE_NEXT
(cur);

507 } 
cur
 !ğ
¡¬t
);

509 
	}
}

	@setup.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/lib.h
>

4 
	~<x’/sched.h
>

5 
	~<x’/sched-if.h
>

6 
	~<x’/domaš.h
>

7 
	~<x’/£rŸl.h
>

8 
	~<x’/soáœq.h
>

9 
	~<x’/aıi.h
>

10 
	~<x’/cÚsŞe.h
>

11 
	~<x’/£rŸl.h
>

12 
	~<x’/Œaû.h
>

13 
	~<x’/muÉiboÙ.h
>

14 
	~<x’/domaš_·ge.h
>

15 
	~<x’/v”siÚ.h
>

16 
	~<x’/gdb¡ub.h
>

17 
	~<x’/³rıu.h
>

18 
	~<x’/hy³rÿÎ.h
>

19 
	~<x’/keyhªdËr.h
>

20 
	~<x’/numa.h
>

21 
	~<x’/rcupd©e.h
>

22 
	~<x’/vga.h
>

23 
	~<x’/dmi.h
>

24 
	~<x’/nodemask.h
>

25 
	~<public/v”siÚ.h
>

26 #ifdeà
CONFIG_COMPAT


27 
	~<com·t/¶©fÜm.h
>

28 
	~<com·t/x’.h
>

30 
	~<asm/b™İs.h
>

31 
	~<asm/smp.h
>

32 
	~<asm/´oûssÜ.h
>

33 
	~<asm/mp¥ec.h
>

34 
	~<asm/­ic.h
>

35 
	~<asm/desc.h
>

36 
	~<asm/·gšg.h
>

37 
	~<asm/e820.h
>

38 
	~<xsm/acm/acm_hooks.h
>

39 
	~<x’/kexec.h
>

40 
	~<asm/edd.h
>

41 
	~<xsm/xsm.h
>

42 
	~<asm/tboÙ.h
>

43 
	~<asm/bzimage.h
>

44 
	~<asm/mach-g’”ic/mach_­ic.h
>

45 
	~<asm/£tup.h
>

46 
	~<x’/ıu.h
>

48 
u16
 
boÙ_edid_ÿps
;

49 
u8
 
boÙ_edid_šfo
[128];

50 
boÙ_video_šfo
 
boÙ_vid_šfo
;

53 
boŞ_t
 
__š™d©a
 
	gİt_nosmp
;

54 
boŞ—n_·¿m
("nosmp", 
İt_nosmp
);

56 
boŞ_t
 
__š™d©a
 
	gİt_soáÿche
;

57 
boŞ—n_·¿m
("soáÿche", 
İt_soáÿche
);

60 
__š™d©a
 
	gmax_ıus
 = 
NR_CPUS
;

61 
š‹g”_·¿m
("maxıus", 
max_ıus
);

64 
boŞ_t
 
__š™d©a
 
	gİt_w©chdog
;

65 
boŞ—n_·¿m
("w©chdog", 
İt_w©chdog
);

73 
·r£_aıi_·¿m
(*
s
);

74 
cu¡om_·¿m
("aıi", 
·r£_aıi_·¿m
);

78 
boŞ—n_·¿m
("aıi_sk_tim”_ov”ride", 
aıi_sk_tim”_ov”ride
);

82 
boŞ—n_·¿m
("nßpic", 
sk_ißpic_£tup
);

86 
s8
 
__»ad_mo¡ly
 
	gx’_ıuidË
 = -1;

87 
boŞ—n_·¿m
("ıuidË", 
x’_ıuidË
);

89 
boŞ_t
 
__»ad_mo¡ly
 
	g—¾y_boÙ
 = 1;

91 
ıumask_t
 
__»ad_mo¡ly
 
	gıu_´e£Á_m­
;

93 
__»ad_mo¡ly
 
	gx’_phys_¡¬t
;

95 #ifdeà
CONFIG_X86_32


97 
__š™d©a
 
	gx’h—p_š™Ÿl_phys_¡¬t
;

98 
__»ad_mo¡ly
 
	gx’h—p_phys_’d
;

101 
DEFINE_PER_CPU
(
tss_¡ruù
, 
š™_tss
);

103 
__©Œibu‹__
 ((
__£ùiÚ__
(".bss.¡ack_®igÃd"))è
	gıu0_¡ack
[
STACK_SIZE
];

105 
ıušfo_x86
 
__»ad_mo¡ly
 
	gboÙ_ıu_d©a
 = { 0, 0, 0, 0, -1 };

107 
__»ad_mo¡ly
 
	gmmu_ü4_ã©u»s
 = 
X86_CR4_PSE
 | 
X86_CR4_PGE
 | 
X86_CR4_PAE
;

109 
boŞ_t
 
__š™d©a
 
	gaıi_di§bËd
;

110 
boŞ_t
 
__š™d©a
 
	gaıi_fÜû
;

111 
__š™d©a
 
	gaıi_·¿m
[10] = "";

112 
__š™
 
	$·r£_aıi_·¿m
(*
s
)

115 
	`§ã_¡rıy
(
aıi_·¿m
, 
s
);

118 iàĞ!
	`·r£_boŞ
(
s
) )

120 
	`di§bË_aıi
();

122 iàĞ!
	`¡rcmp
(
s
, "force") )

124 
aıi_fÜû
 = 1;

125 
aıi_ht
 = 1;

126 
aıi_di§bËd
 = 0;

128 iàĞ!
	`¡rcmp
(
s
, "ht") )

130 iàĞ!
aıi_fÜû
 )

131 
	`di§bË_aıi
();

132 
aıi_ht
 = 1;

134 iàĞ!
	`¡rcmp
(
s
, "noirq") )

136 
	`aıi_noœq_£t
();

138 
	}
}

140 
	#EARLY_FAIL
(
f
, 
a
...) do { \

141 
	`´štk
Ğ
f
 , ## 
a
 ); \

142  ; ; ) 
	`h®t
(); \

143 } 0)

	)

145 cÚ¡ 
moduË_t
 *
__š™d©a
 
	gš™Ÿl_images
;

146 
__š™d©a
 
	gÄ_š™Ÿl_images
;

148 
__š™
 
	$š™Ÿl_images_Ä·ges
()

150 
Ä
;

151 
i
;

153  
Ä
 = 
i
 = 0; i < 
Ä_š™Ÿl_images
; ++i )

154 
Ä
 +ğ
	`PFN_UP
(
š™Ÿl_images
[
i
].
mod_’d
);

156  
Ä
;

157 
	}
}

159 
__š™
 
	$disÿrd_š™Ÿl_images
()

161 
i
;

163  
i
 = 0; i < 
Ä_š™Ÿl_images
; ++i )

165 
ušt64_t
 
¡¬t
 = (ušt64_t)
š™Ÿl_images
[
i
].
mod_¡¬t
 << 
PAGE_SHIFT
;

167 
	`š™_domh—p_·ges
(
¡¬t
,

168 
¡¬t
 + 
	`PAGE_ALIGN
(
š™Ÿl_images
[
i
].
mod_’d
));

171 
Ä_š™Ÿl_images
 = 0;

172 
š™Ÿl_images
 = 
NULL
;

173 
	}
}

175 
	$ä“_x’_d©a
(*
s
, *
e
)

177 #iâdeà
MEMORY_GUARD


178 
	`š™_x’h—p_·ges
(
	`__·
(
s
), __·(
e
));

180 
	`memgu¬d_gu¬d_¿nge
(
s
, 
e
-s);

181 #ià
	`defšed
(
CONFIG_X86_64
)

183 
	`memgu¬d_gu¬d_¿nge
(
	`__va
(
	`__·
(
s
)), 
e
-s);

185 
	}
}

187 
__š™_begš
[], 
__š™_’d
[], 
__bss_¡¬t
[];

189 
__š™
 
	$š™_idË_domaš
()

191 
	`scheduËr_š™
();

192 
	`£t_cu¼’t
(
idË_vıu
[0]);

193 
	`this_ıu
(
cu¼_vıu
èğ
cu¼’t
;

194 
	`£tup_idË_·g‘abË
();

195 
	}
}

197 
__devš™
 
	$¤©_d‘eù_node
(
ıu
)

199 
node
;

200 
u32
 
­icid
 = 
x86_ıu_to_­icid
[
ıu
];

202 
node
 = 
­icid_to_node
[
­icid
];

203 iàĞ
node
 =ğ
NUMA_NO_NODE
 || !
	`node_Úlše
(node) )

204 
node
 = 0;

205 
	`numa_£t_node
(
ıu
, 
node
);

207 iàĞ
İt_ıu_šfo
 && 
aıi_numa
 > 0 )

208 
	`´štk
("CPU %d APIC %d -> Nod%d\n", 
ıu
, 
­icid
, 
node
);

209 
	}
}

218 
__š™
 
	$nÜm®i£_ıu_Üd”
()

220 
i
, 
j
, 
mš_ıu
;

221 
ušt32_t
 
­icid
, 
diff
, 
mš_diff
;

223 
	`fÜ_—ch_´e£Á_ıu
 ( 
i
 )

225 
­icid
 = 
x86_ıu_to_­icid
[
i
];

226 
mš_diff
 = 
mš_ıu
 = ~0u;

232  
j
 = 
	`Ãxt_ıu
(
i
, 
ıu_´e£Á_m­
);

233 
j
 < 
NR_CPUS
;

234 
j
 = 
	`Ãxt_ıu
(j, 
ıu_´e£Á_m­
) )

236 
diff
 = 
x86_ıu_to_­icid
[
j
] ^ 
­icid
;

237  
diff
 & (diff-1) )

238 
diff
 &= diff-1;

239 iàĞ(
diff
 < 
mš_diff
) ||

240 ((
diff
 =ğ
mš_diff
) &&

241 (
x86_ıu_to_­icid
[
j
] < x86_ıu_to_­icid[
mš_ıu
])) )

243 
mš_diff
 = 
diff
;

244 
mš_ıu
 = 
j
;

249 iàĞ
mš_ıu
 >ğ
NR_CPUS
 )

251 
	`BUG_ON
(
	`Ãxt_ıu
(
i
, 
ıu_´e£Á_m­
è< 
NR_CPUS
);

256 
j
 = 
	`Ãxt_ıu
(
i
, 
ıu_´e£Á_m­
);

257 
­icid
 = 
x86_ıu_to_­icid
[
mš_ıu
];

258 
x86_ıu_to_­icid
[
mš_ıu
] = x86_ıu_to_­icid[
j
];

259 
x86_ıu_to_­icid
[
j
] = 
­icid
;

261 
	}
}

263 
	#BOOTSTRAP_MAP_BASE
 (16UL << 20)

	)

264 
	#BOOTSTRAP_MAP_LIMIT
 (1UL << 
L3_PAGETABLE_SHIFT
)

	)

270 *
__š™
 
	$boÙ¡¿p_m­
(cÚ¡ 
moduË_t
 *
mod
)

272 
__š™d©a
 
m­_cur
 = 
BOOTSTRAP_MAP_BASE
;

273 
ušt64_t
 
¡¬t
, 
’d
, 
mask
 = (1L << 
L2_PAGETABLE_SHIFT
) - 1;

274 *
»t
;

276 #ifdeà
__x86_64__


277 iàĞ!
—¾y_boÙ
 )

278  
mod
 ? 
	`mâ_to_vœt
(mod->
mod_¡¬t
è: 
NULL
;

281 iàĞ!
mod
 )

283 
	`de¡roy_x’_m­pšgs
(
BOOTSTRAP_MAP_BASE
, 
BOOTSTRAP_MAP_LIMIT
);

284 
m­_cur
 = 
BOOTSTRAP_MAP_BASE
;

285  
NULL
;

288 
¡¬t
 = (
ušt64_t
)
mod
->
mod_¡¬t
 << 
PAGE_SHIFT
;

289 
’d
 = 
¡¬t
 + 
mod
->
mod_’d
;

290 iàĞ
¡¬t
 >ğ
’d
 )

291  
NULL
;

293 iàĞ
’d
 <ğ
BOOTSTRAP_MAP_BASE
 )

294  (*)()
¡¬t
;

296 
»t
 = (*)(
m­_cur
 + ()(
¡¬t
 & 
mask
));

297 
¡¬t
 &ğ~
mask
;

298 
’d
 = (’d + 
mask
) & ~mask;

299 iàĞ
’d
 - 
¡¬t
 > 
BOOTSTRAP_MAP_LIMIT
 - 
m­_cur
 )

300  
NULL
;

302 
	`m­_·ges_to_x’
(
m­_cur
, 
¡¬t
 >> 
PAGE_SHIFT
,

303 (
’d
 - 
¡¬t
è>> 
PAGE_SHIFT
, 
PAGE_HYPERVISOR
);

304 
m­_cur
 +ğ
’d
 - 
¡¬t
;

305  
»t
;

306 
	}
}

308 *
__š™
 
	$move_memÜy
(

309 
ušt64_t
 
d¡
, ušt64_ˆ
¤c
, 
size
, 
boŞ_t
 
k“p
)

311 
blksz
 = 
BOOTSTRAP_MAP_LIMIT
 - 
BOOTSTRAP_MAP_BASE
;

312 
mask
 = (1L << 
L2_PAGETABLE_SHIFT
) - 1;

314 iàĞ
¤c
 + 
size
 > 
BOOTSTRAP_MAP_BASE
 )

315 
blksz
 >>= 1;

317  
size
 )

319 
moduË_t
 
mod
;

320 
soffs
 = 
¤c
 & 
mask
;

321 
doffs
 = 
d¡
 & 
mask
;

322 
sz
;

323 *
d
, *
s
;

325 
mod
.
mod_¡¬t
 = (
¤c
 - 
soffs
è>> 
PAGE_SHIFT
;

326 
mod
.
mod_’d
 = 
soffs
 + 
size
;

327 iàĞ
mod
.
mod_’d
 > 
blksz
 )

328 
mod
.
mod_’d
 = 
blksz
;

329 
sz
 = 
mod
.
mod_’d
 - 
soffs
;

330 
s
 = 
	`boÙ¡¿p_m­
(&
mod
);

332 
mod
.
mod_¡¬t
 = (
d¡
 - 
doffs
è>> 
PAGE_SHIFT
;

333 
mod
.
mod_’d
 = 
doffs
 + 
size
;

334 iàĞ
mod
.
mod_’d
 > 
blksz
 )

335 
mod
.
mod_’d
 = 
blksz
;

336 iàĞ
sz
 > 
mod
.
mod_’d
 - 
doffs
 )

337 
sz
 = 
mod
.
mod_’d
 - 
doffs
;

338 
d
 = 
	`boÙ¡¿p_m­
(&
mod
);

340 
	`memmove
(
d
 + 
doffs
, 
s
 + 
soffs
, 
sz
);

342 
d¡
 +ğ
sz
;

343 
¤c
 +ğ
sz
;

344 
size
 -ğ
sz
;

346 iàĞ
k“p
 )

347  
size
 ? 
NULL
 : 
d
 + 
doffs
;

349 
	`boÙ¡¿p_m­
(
NULL
);

352  
NULL
;

353 
	}
}

355 
ušt64_t
 
__š™
 
	$cÚsid”_moduËs
(

356 
ušt64_t
 
s
, ušt64_ˆ
e
, 
ušt32_t
 
size
, cÚ¡ 
moduË_t
 *
mod
,

357 
Ä_mods
, 
this_mod
)

359 
i
;

361 iàĞ
s
 > 
e
 ||ƒ - s < 
size
 )

364  
i
 = 0; i < 
Ä_mods
 ; ++i )

366 
ušt64_t
 
¡¬t
 = (ušt64_t)
mod
[
i
].
mod_¡¬t
 << 
PAGE_SHIFT
;

367 
ušt64_t
 
’d
 = 
¡¬t
 + 
	`PAGE_ALIGN
(
mod
[
i
].
mod_’d
);

369 iàĞ
i
 =ğ
this_mod
 )

372 iàĞ
s
 < 
’d
 && 
¡¬t
 < 
e
 )

374 
’d
 = 
	`cÚsid”_moduËs
Ónd, 
e
, 
size
, 
mod
 + 
i
 + 1,

375 
Ä_mods
 - 
i
 - 1, 
this_mod
 - i - 1);

376 iàĞ
’d
 )

377  
’d
;

379  
	`cÚsid”_moduËs
(
s
, 
¡¬t
, 
size
, 
mod
 + 
i
 + 1,

380 
Ä_mods
 - 
i
 - 1, 
this_mod
 - i - 1);

384  
e
;

385 
	}
}

387 
__š™
 
	$£tup_max_pdx
()

389 #ifdeà
__x86_64__


390 
max_pdx
 = 
	`pâ_to_pdx
(
max_·ge
 - 1) + 1;

392 iàĞ
max_pdx
 > (
DIRECTMAP_SIZE
 >> 
PAGE_SHIFT
) )

393 
max_pdx
 = 
DIRECTMAP_SIZE
 >> 
PAGE_SHIFT
;

395 iàĞ
max_pdx
 > 
FRAMETABLE_SIZE
 / (*
äame_bË
) )

396 
max_pdx
 = 
FRAMETABLE_SIZE
 / (*
äame_bË
);

398 
max_·ge
 = 
	`pdx_to_pâ
(
max_pdx
 - 1) + 1;

400 
	}
}

402 
	$£t_pdx_¿nge
(
smâ
, 
emâ
)

404 
idx
, 
eidx
;

406 
idx
 = 
	`pâ_to_pdx
(
smâ
è/ 
PDX_GROUP_COUNT
;

407 
eidx
 = (
	`pâ_to_pdx
(
emâ
 - 1è+ 
PDX_GROUP_COUNT
) / PDX_GROUP_COUNT;

408  ; 
idx
 < 
eidx
; ++idx )

409 
	`__£t_b™
(
idx
, 
pdx_group_v®id
);

410 
	}
}

413 
e820m­
 
__š™d©a
 
	gboÙ_e820
;

415 
	sboÙ_video_šfo
 {

416 
u8
 
	mÜig_x
;

417 
u8
 
	mÜig_y
;

418 
u8
 
	mÜig_video_mode
;

419 
u8
 
	mÜig_video_cŞs
;

420 
u8
 
	mÜig_video_lšes
;

421 
u8
 
	mÜig_video_isVGA
;

422 
u16
 
	mÜig_video_pošts
;

425 
u32
 
	mÿ·b™›s
;

426 
u16
 
	mlfb_lš–’gth
;

427 
u16
 
	mlfb_width
;

428 
u16
 
	mlfb_height
;

429 
u16
 
	mlfb_d•th
;

430 
u32
 
	mlfb_ba£
;

431 
u32
 
	mlfb_size
;

432 
u8
 
	m»d_size
;

433 
u8
 
	m»d_pos
;

434 
u8
 
	mg»’_size
;

435 
u8
 
	mg»’_pos
;

436 
u8
 
	mblue_size
;

437 
u8
 
	mblue_pos
;

438 
u8
 
	mrsvd_size
;

439 
u8
 
	mrsvd_pos
;

440 
u16
 
	mve§pm_£g
;

441 
u16
 
	mve§pm_off
;

442 
u16
 
	mve§_©Œib
;

445 
__š™
 
	$·r£_video_šfo
()

447 
boÙ_video_šfo
 *
bvi
 = &
	`boÙsym
(
boÙ_vid_šfo
);

449 iàĞ(
bvi
->
Üig_video_isVGA
 =ğ1è&& (bvi->
Üig_video_mode
 == 3) )

451 
vga_cÚsŞe_šfo
.
video_ty³
 = 
XEN_VGATYPE_TEXT_MODE_3
;

452 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
fÚt_height
 = 
bvi
->
Üig_video_pošts
;

453 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
cursÜ_x
 = 
bvi
->
Üig_x
;

454 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
cursÜ_y
 = 
bvi
->
Üig_y
;

455 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
rows
 = 
bvi
->
Üig_video_lšes
;

456 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
cŞumns
 = 
bvi
->
Üig_video_cŞs
;

458 iàĞ
bvi
->
Üig_video_isVGA
 == 0x23 )

460 
vga_cÚsŞe_šfo
.
video_ty³
 = 
XEN_VGATYPE_VESA_LFB
;

461 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
width
 = 
bvi
->
lfb_width
;

462 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
height
 = 
bvi
->
lfb_height
;

463 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
by‹s_³r_lše
 = 
bvi
->
lfb_lš–’gth
;

464 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
b™s_³r_pix–
 = 
bvi
->
lfb_d•th
;

465 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
lfb_ba£
 = 
bvi
->lfb_base;

466 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
lfb_size
 = 
bvi
->lfb_size;

467 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
»d_pos
 = 
bvi
->red_pos;

468 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
»d_size
 = 
bvi
->red_size;

469 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
g»’_pos
 = 
bvi
->green_pos;

470 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
g»’_size
 = 
bvi
->green_size;

471 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
blue_pos
 = 
bvi
->blue_pos;

472 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
blue_size
 = 
bvi
->blue_size;

473 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
rsvd_pos
 = 
bvi
->rsvd_pos;

474 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
rsvd_size
 = 
bvi
->rsvd_size;

475 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
gbl_ÿps
 = 
bvi
->
ÿ·b™›s
;

476 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
mode_©Œs
 = 
bvi
->
ve§_©Œib
;

478 
	}
}

480 
__š™
 
	$kexec_»£rve_¬—
(
e820m­
 *
e820
)

482 
kdump_¡¬t
 = 
kexec_üash_¬—
.
¡¬t
;

483 
kdump_size
 = 
kexec_üash_¬—
.
size
;

484 
is_»£rved
 = 0;

486 
kdump_size
 = (kdump_siz+ 
PAGE_SIZE
 - 1è& 
PAGE_MASK
;

488 iàĞ(
kdump_¡¬t
 =ğ0è|| (
kdump_size
 =ğ0è|| 
is_»£rved
 )

491 
is_»£rved
 = 1;

493 iàĞ!
	`»£rve_e820_¿m
(
e820
, 
kdump_¡¬t
, kdump_¡¬ˆ+ 
kdump_size
) )

495 
	`´štk
("Kdump: DISABLED (failedo„eserve %luMB (%lukB)‡t 0x%lx)"

496 "\n", 
kdump_size
 >> 20, kdump_siz>> 10, 
kdump_¡¬t
);

497 
kexec_üash_¬—
.
¡¬t
 = kexec_üash_¬—.
size
 = 0;

501 
	`´štk
("Kdump: %luMB (%lukB)‡t 0x%lx\n",

502 
kdump_size
 >> 20, kdump_siz>> 10, 
kdump_¡¬t
);

504 
	}
}

506 
	$š™_dÚe
()

509 
	`mem£t
(
__š™_begš
, 0xcc, 
__š™_’d
 - __init_begin);

510 
	`ä“_x’_d©a
(
__š™_begš
, 
__š™_’d
);

511 
	`´štk
("F»ed %ldkB in™ memÜy.\n", ()(
__š™_’d
-
__š™_begš
)>>10);

513 
	`¡¬tup_ıu_idË_loİ
();

514 
	}
}

516 
boŞ_t
 
__š™
 
	$lßd”_is_grub2
(cÚ¡ *
lßd”_Çme
)

519 cÚ¡ *
p
 = 
	`¡r¡r
(
lßd”_Çme
, "GRUB ");

520  (
p
 !ğ
NULL
) && (p[5] != '0');

521 
	}
}

523 * 
__š™
 
	$cmdlše_cook
(*
p
, *
lßd”_Çme
)

525 
p
 =… ? : "";

528  *
p
 == ' ' )

529 
p
++;

532 iàĞ
	`lßd”_is_grub2
(
lßd”_Çme
) )

533  
p
;

536  (*
p
 != ' ') && (*p != '\0') )

537 
p
++;

538  *
p
 == ' ' )

539 
p
++;

541  
p
;

542 
	}
}

544 
__š™
 
	$__¡¬t_x’
(
mbi_p
)

546 *
memm­_ty³
 = 
NULL
;

547 *
cmdlše
, *
kexŒa
, *
lßd”
;

548 
š™rdidx
 = 1;

549 
muÉiboÙ_šfo_t
 *
mbi
 = 
	`__va
(
mbi_p
);

550 
moduË_t
 *
mod
 = (moduË_ˆ*)
	`__va
(
mbi
->
mods_addr
);

551 
Ä_·ges
, 
moduËs_h—droom
;

552 
i
, 
j
, 
e820_w¬n
 = 0, 
by‹s
 = 0;

553 
boŞ_t
 
aıi_boÙ_bË_š™_dÚe
 = 0;

554 
ns16550_deçuÉs
 
ns16550
 = {

555 .
d©a_b™s
 = 8,

556 .
·r™y
 = 'n',

557 .
¡İ_b™s
 = 1

560 
	`³rıu_š™_¬—s
();

562 
	`£t_šŒ_g©e
(
TRAP_·ge_çuÉ
, &
—¾y_·ge_çuÉ
);

564 
lßd”
 = (
mbi
->
æags
 & 
MBI_LOADERNAME
)

565 ? (*)
	`__va
(
mbi
->
boÙ_lßd”_Çme
) : "unknown";

568 
cmdlše
 = 
	`cmdlše_cook
((
mbi
->
æags
 & 
MBI_CMDLINE
) ?

569 
	`__va
(
mbi
->
cmdlše
è: 
NULL
,

570 
lßd”
);

571 iàĞ(
kexŒa
 = 
	`¡r¡r
(
cmdlše
, " -- ")è!ğ
NULL
 )

578 *
kexŒa
 = '\0';

579 
kexŒa
 += 3;

580  
kexŒa
[1] == ' ' ) kextra++;

582 
	`cmdlše_·r£
(
cmdlše
);

584 
	`·r£_video_šfo
();

586 
	`£t_cu¼’t
((
vıu
 *)0xfffff000);

587 
idË_vıu
[0] = 
cu¼’t
;

588 
	`£t_´oûssÜ_id
(0);

589 iàĞ
ıu_has_eãr
 )

590 
	`rdm¤l
(
MSR_EFER
, 
	`this_ıu
(
eãr
));

591 
asm
 vŞ©Ğ"mov %%ü4,%0" : "ô" (
	`this_ıu
(
ü4
)) );

593 
	`smp_´•¬e_boÙ_ıu
();

596 
ns16550
.
io_ba£
 = 0x3f8;

597 
ns16550
.
œq
 = 4;

598 
	`ns16550_š™
(0, &
ns16550
);

599 
ns16550
.
io_ba£
 = 0x2f8;

600 
ns16550
.
œq
 = 3;

601 
	`ns16550_š™
(1, &
ns16550
);

602 
	`cÚsŞe_š™_´eœq
();

604 
	`´štk
("BoÙlßd”: %s\n", 
lßd”
);

606 
	`´štk
("Commªd†še: %s\n", 
cmdlše
);

608 
	`´štk
("Video information:\n");

611  
vga_cÚsŞe_šfo
.
video_ty³
 )

613 
XEN_VGATYPE_TEXT_MODE_3
:

614 
	`´štk
(" VGA isext mode %dx%d, font 8x%d\n",

615 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
cŞumns
,

616 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
rows
,

617 
vga_cÚsŞe_šfo
.
u
.
‹xt_mode_3
.
fÚt_height
);

619 
XEN_VGATYPE_VESA_LFB
:

620 
	`´štk
(" VGA is graphics mode %dx%d, %d bpp\n",

621 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
width
,

622 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
height
,

623 
vga_cÚsŞe_šfo
.
u
.
ve§_lfb
.
b™s_³r_pix–
);

626 
	`´štk
(" No VGA detected\n");

631 iàĞ
	`boÙsym
(
boÙ_edid_ÿps
) != 0x1313 )

633 
u16
 
ÿps
 = 
	`boÙsym
(
boÙ_edid_ÿps
);

634 
	`´štk
(" VBE/DDC methods:%s%s%s; ",

635 (
ÿps
 & 1) ? " V1" : "",

636 (
ÿps
 & 2) ? " V2" : "",

637 !(
ÿps
 & 3) ? "‚one" : "");

638 
	`´štk
("EDID¿nsã¸time: %d secÚds\n", 
ÿps
 >> 8);

639 iàĞ*(
u32
 *)
	`boÙsym
(
boÙ_edid_šfo
) == 0x13131313 )

641 
	`´štk
(" EDID info‚ot„etrieved because ");

642 iàĞ!(
ÿps
 & 3) )

643 
	`´štk
("no DDC„etrieval method detected\n");

644 iàĞ(
ÿps
 >> 8) > 5 )

645 
	`´štk
("takes†ongerhan 5 seconds\n");

647 
	`´štk
("of„easons unknown\n");

651 
	`´štk
("Disc information:\n");

652 
	`´štk
(" Found %d MBR signatures\n",

653 
	`boÙsym
(
boÙ_mbr_sigÇtu»_Ä
));

654 
	`´štk
(" Found %d EDD information structures\n",

655 
	`boÙsym
(
boÙ_edd_šfo_Ä
));

658 iàĞ!(
mbi
->
æags
 & 
MBI_MODULES
è|| (mbi->
mods_couÁ
 == 0) )

659 
	`EARLY_FAIL
("dom0 kernel‚ot specified. "

662 iàĞ(()
ıu0_¡ack
 & (
STACK_SIZE
-1)) != 0 )

663 
	`EARLY_FAIL
("Misaligned CPU0 stack.\n");

665 iàĞ
e820_¿w_Ä
 != 0 )

667 
memm­_ty³
 = "Xen-e820";

669 iàĞ
	`boÙsym
(
lowmem_kb
) )

671 
memm­_ty³
 = "Xen-e801";

672 
e820_¿w
[0].
addr
 = 0;

673 
e820_¿w
[0].
size
 = 
	`boÙsym
(
lowmem_kb
) << 10;

674 
e820_¿w
[0].
ty³
 = 
E820_RAM
;

675 
e820_¿w
[1].
addr
 = 0x100000;

676 
e820_¿w
[1].
size
 = 
	`boÙsym
(
highmem_kb
) << 10;

677 
e820_¿w
[1].
ty³
 = 
E820_RAM
;

678 
e820_¿w_Ä
 = 2;

680 iàĞ
mbi
->
æags
 & 
MBI_MEMMAP
 )

682 
memm­_ty³
 = "Multiboot-e820";

683  (
by‹s
 < 
mbi
->
mm­_Ëngth
è&& (
e820_¿w_Ä
 < 
E820MAX
) )

685 
memÜy_m­_t
 *
m­
 = 
	`__va
(
mbi
->
mm­_addr
 + 
by‹s
);

696 iàĞ(
m­
->
ba£_addr_high
 =ğ0è&& (m­->
Ëngth_high
 != 0) )

698 iàĞ!
e820_w¬n
 )

700 
	`´štk
("WARNING: Buggyƒ820 map detected‡nd fixed "

702 
e820_w¬n
 = 1;

704 
m­
->
Ëngth_high
 = 0;

707 
e820_¿w
[
e820_¿w_Ä
].
addr
 =

708 ((
u64
)
m­
->
ba£_addr_high
 << 32è| (u64)m­->
ba£_addr_low
;

709 
e820_¿w
[
e820_¿w_Ä
].
size
 =

710 ((
u64
)
m­
->
Ëngth_high
 << 32è| (u64)m­->
Ëngth_low
;

711 
e820_¿w
[
e820_¿w_Ä
].
ty³
 = 
m­
->type;

712 
e820_¿w_Ä
++;

714 
by‹s
 +ğ
m­
->
size
 + 4;

717 iàĞ
mbi
->
æags
 & 
MBI_MEMLIMITS
 )

719 
memm­_ty³
 = "Multiboot-e801";

720 
e820_¿w
[0].
addr
 = 0;

721 
e820_¿w
[0].
size
 = 
mbi
->
mem_low”
 << 10;

722 
e820_¿w
[0].
ty³
 = 
E820_RAM
;

723 
e820_¿w
[1].
addr
 = 0x100000;

724 
e820_¿w
[1].
size
 = 
mbi
->
mem_uµ”
 << 10;

725 
e820_¿w
[1].
ty³
 = 
E820_RAM
;

726 
e820_¿w_Ä
 = 2;

730 
	`EARLY_FAIL
("Bootloader…rovided‚o memory information.\n");

734 
max_·ge
 = 
	`š™_e820
(
memm­_ty³
, 
e820_¿w
, &
e820_¿w_Ä
);

737 
	`memıy
(&
boÙ_e820
, &
e820
, (e820));

740 
Ä_·ges
 = 0;

741  
i
 = 0; i < 
e820
.
Ä_m­
; i++ )

742 iàĞ
e820
.
m­
[
i
].
ty³
 =ğ
E820_RAM
 )

743 
Ä_·ges
 +ğ
e820
.
m­
[
i
].
size
 >> 
PAGE_SHIFT
;

744 
	`£t_kexec_üash_¬—_size
((
u64
)
Ä_·ges
 << 
PAGE_SHIFT
);

745 
	`kexec_»£rve_¬—
(&
boÙ_e820
);

747 
š™Ÿl_images
 = 
mod
;

748 
Ä_š™Ÿl_images
 = 
mbi
->
mods_couÁ
;

763  
i
 = 0; i < 
mbi
->
mods_couÁ
; i++ )

765 iàĞ
mod
[
i
].
mod_¡¬t
 & (
PAGE_SIZE
 - 1) )

766 
	`EARLY_FAIL
("Bootloader didn't honor module‡lignment„equest.\n");

767 
mod
[
i
].
mod_’d
 -ğmod[i].
mod_¡¬t
;

768 
mod
[
i
].
mod_¡¬t
 >>ğ
PAGE_SHIFT
;

769 
mod
[
i
].
»£rved
 = 0;

772 
moduËs_h—droom
 = 
	`bzimage_h—droom
(
	`boÙ¡¿p_m­
(
mod
), mod->
mod_’d
);

773 
	`boÙ¡¿p_m­
(
NULL
);

775  
i
 = 
boÙ_e820
.
Ä_m­
-1; i >= 0; i-- )

777 
ušt64_t
 
s
, 
e
, 
mask
 = (1UL << 
L2_PAGETABLE_SHIFT
) - 1;

778 
ušt64_t
 
’d
, 
lim™
 = 
	`ARRAY_SIZE
(
l2_id’tm­
è<< 
L2_PAGETABLE_SHIFT
;

781 
s
 = (
boÙ_e820
.
m­
[
i
].
addr
 + 
mask
) & ~mask;

782 
e
 = (
boÙ_e820
.
m­
[
i
].
addr
 + boÙ_e820.m­[i].
size
è& ~
mask
;

783 
s
 = 
	`max_t
(
ušt64_t
, s, 
BOOTSTRAP_MAP_BASE
);

784 iàĞ(
boÙ_e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
è|| (
s
 >ğ
e
) )

787 iàĞ
s
 < 
lim™
 )

789 
’d
 = 
	`mš
(
e
, 
lim™
);

790 
	`£t_pdx_¿nge
(
s
 >> 
PAGE_SHIFT
, 
’d
 >> PAGE_SHIFT);

791 #ifdeà
CONFIG_X86_64


792 
	`m­_·ges_to_x’
(()
	`__va
(
s
), s >> 
PAGE_SHIFT
,

793 (
’d
 - 
s
è>> 
PAGE_SHIFT
, 
PAGE_HYPERVISOR
);

797 #ià
	`defšed
(
CONFIG_X86_64
)

798 
e
 = 
	`mš_t
(
ušt64_t
,ƒ, 1ULL << (
PAGE_SHIFT
 + 32));

799 
	#»loc_size
 ((
	`__·
(&
_’d
è+ 
mask
è& ~mask)

	)

801 iàĞ!
x’_phys_¡¬t
 && 
e
 <ğ
lim™
 )

804 
’d
 = 
	`cÚsid”_moduËs
(
s
, 
e
, 
»loc_size
 + 
mask
,

805 
mod
, 
mbi
->
mods_couÁ
, -1);

806 
’d
 &ğ~
mask
;

809 
’d
 = 0;

810 iàĞ
’d
 > 
s
 )

812 
l2_pg’Œy_t
 
l2_x’m­
[];

813 
l4_pg’Œy_t
 *
¶4e
;

814 
l3_pg’Œy_t
 *
¶3e
;

815 
l2_pg’Œy_t
 *
¶2e
;

816 
i
, 
j
, 
k
;

817 *
d¡
;

820 
e
 = 
’d
 - 
»loc_size
;

821 
x’_phys_¡¬t
 = 
e
;

822 
	`boÙsym
(
ŒampŞše_x’_phys_¡¬t
èğ
e
;

830 
	`b¬r›r
();

831 
d¡
 = 
	`move_memÜy
(
e
, 0, ()&
_’d
 - 
XEN_VIRT_START
, 1);

834 
	`mem£t
(
d¡
, 0x55, 1U << 20);

837 
¶4e
 = 
	`__va
(
	`__·
(
idË_pg_bË
));

838  
i
 = 0 ; i < 
L4_PAGETABLE_ENTRIES
; i++, 
¶4e
++ )

840 iàĞ!(
	`l4e_g‘_æags
(*
¶4e
è& 
_PAGE_PRESENT
) )

842 *
¶4e
 = 
	`l4e_äom_š‹
(
	`l4e_g‘_š‹
(*pl4e) +

843 
x’_phys_¡¬t
);

844 
¶3e
 = 
	`l4e_to_l3e
(*
¶4e
);

845  
j
 = 0; j < 
L3_PAGETABLE_ENTRIES
; j++, 
¶3e
++ )

848 iàĞ!(
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PRESENT
) ||

849 (
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PSE
) ||

850 (
	`l3e_g‘_pâ
(*
¶3e
) > 0x1000) )

852 *
¶3e
 = 
	`l3e_äom_š‹
(
	`l3e_g‘_š‹
(*pl3e) +

853 
x’_phys_¡¬t
);

854 
¶2e
 = 
	`l3e_to_l2e
(*
¶3e
);

855  
k
 = 0; k < 
L2_PAGETABLE_ENTRIES
; k++, 
¶2e
++ )

858 iàĞ!(
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PRESENT
) ||

859 (
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PSE
) ||

860 (
	`l2e_g‘_pâ
(*
¶2e
) > 0x1000) )

862 *
¶2e
 = 
	`l2e_äom_š‹
(
	`l2e_g‘_š‹
(*pl2e) +

863 
x’_phys_¡¬t
);

869 
¶2e
 = 
	`__va
(
	`__·
(
l2_x’m­
));

870 *
¶2e
++ = 
	`l2e_äom_pâ
(
x’_phys_¡¬t
 >> 
PAGE_SHIFT
,

871 
PAGE_HYPERVISOR
 | 
_PAGE_PSE
);

872  
i
 = 1; i < 
L2_PAGETABLE_ENTRIES
; i++, 
¶2e
++ )

874 iàĞ!(
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PRESENT
) )

876 *
¶2e
 = 
	`l2e_äom_š‹
(
	`l2e_g‘_š‹
(*pl2e) +

877 
x’_phys_¡¬t
);

881 
asm
 volatile (

889 : : "r" (
	`__·
(
idË_pg_bË
)), "S" (
ıu0_¡ack
),

890 "D" (
	`__va
(
	`__·
(
ıu0_¡ack
))), "c" (
STACK_SIZE
) : "memory" );

892 
	`boÙ¡¿p_m­
(
NULL
);

897  
j
 = 
mbi
->
mods_couÁ
 - 1; j >= 0; j-- )

899 
h—droom
 = 
j
 ? 0 : 
moduËs_h—droom
;

900 
size
 = 
	`PAGE_ALIGN
(
h—droom
 + 
mod
[
j
].
mod_’d
);

902 iàĞ
mod
[
j
].
»£rved
 )

906 
’d
 = 
	`cÚsid”_moduËs
(
s
, 
e
, 
size
, 
mod
, 
mbi
->
mods_couÁ
, 
j
);

908 iàĞ
s
 < 
’d
 &&

909 (
h—droom
 ||

910 ((
’d
 - 
size
è>> 
PAGE_SHIFT
è> 
mod
[
j
].
mod_¡¬t
) )

912 
	`move_memÜy
(
’d
 - 
size
 + 
h—droom
,

913 (
ušt64_t
)
mod
[
j
].
mod_¡¬t
 << 
PAGE_SHIFT
,

914 
mod
[
j
].
mod_’d
, 0);

915 
mod
[
j
].
mod_¡¬t
 = (
’d
 - 
size
è>> 
PAGE_SHIFT
;

916 
mod
[
j
].
mod_’d
 +ğ
h—droom
;

917 
mod
[
j
].
»£rved
 = 1;

921 #ifdeà
CONFIG_X86_32


923 
e
 = 
	`mš_t
(
ušt64_t
,ƒ, 1ULL << 32);

926 
e
 = 
	`cÚsid”_moduËs
(
s
,ƒ, 
	`PAGE_ALIGN
(
kexec_üash_¬—
.
size
),

927 
mod
, 
mbi
->
mods_couÁ
, -1);

928 iàĞ!
kexec_üash_¬—
.
¡¬t
 && (
s
 < 
e
) )

930 
e
 = (- 
kexec_üash_¬—
.
size
è& 
PAGE_MASK
;

931 
kexec_üash_¬—
.
¡¬t
 = 
e
;

935 iàĞ
moduËs_h—droom
 && !
mod
->
»£rved
 )

936 
	`EARLY_FAIL
("Notƒnough memoryo„elocatehe dom0 kernel image.\n");

937  
i
 = 0; i < 
mbi
->
mods_couÁ
; ++i )

939 
ušt64_t
 
s
 = (ušt64_t)
mod
[
i
].
mod_¡¬t
 << 
PAGE_SHIFT
;

941 
	`»£rve_e820_¿m
(&
boÙ_e820
, 
s
, s + 
	`PAGE_ALIGN
(
mod
[
i
].
mod_’d
));

944 #ià
	`defšed
(
CONFIG_X86_32
)

945 
x’h—p_š™Ÿl_phys_¡¬t
 = (
	`PFN_UP
(
	`__·
(&
_’d
)è+ 1è<< 
PAGE_SHIFT
;

947 
	`š™_boÙ_·ges
(
	`__·
(&
_’d
), 
x’h—p_š™Ÿl_phys_¡¬t
);

948 
x’h—p_phys_’d
 = 
DIRECTMAP_MBYTES
 << 20;

950 iàĞ!
x’_phys_¡¬t
 )

951 
	`EARLY_FAIL
("Notƒnough memoryo„elocate Xen.\n");

952 
	`»£rve_e820_¿m
(&
boÙ_e820
, 
	`__·
(&
_¡¬t
), __·(&
_’d
));

956 
	`kexec_»£rve_¬—
(&
boÙ_e820
);

958 
	`£tup_max_pdx
();

964  
i
 = 0; i < 
boÙ_e820
.
Ä_m­
; i++ )

966 
ušt64_t
 
s
, 
e
, 
mask
 = 
PAGE_SIZE
 - 1;

967 #ifdeà
CONFIG_X86_64


968 
ušt64_t
 
m­_s
, 
m­_e
;

972 
s
 = (
boÙ_e820
.
m­
[
i
].
addr
 + 
mask
) & ~mask;

973 
e
 = (
boÙ_e820
.
m­
[
i
].
addr
 + boÙ_e820.m­[i].
size
è& ~
mask
;

974 #ià
	`defšed
(
CONFIG_X86_32
)

975 
s
 = 
	`max_t
(
ušt64_t
, s, 
x’h—p_phys_’d
);

977 
s
 = 
	`max_t
(
ušt64_t
, s, 1<<20);

979 iàĞ(
boÙ_e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
è|| (
s
 >ğ
e
) )

982 #ifdeà
__x86_64__


983 iàĞ!
aıi_boÙ_bË_š™_dÚe
 &&

984 
s
 >= (1ULL << 32) &&

985 !
	`aıi_boÙ_bË_š™
() )

987 
aıi_boÙ_bË_š™_dÚe
 = 1;

988 
	`¤©_·r£_»giÚs
(
s
);

989 
	`£tup_max_pdx
();

992 iàĞ
	`pâ_to_pdx
((
e
 - 1è>> 
PAGE_SHIFT
è>ğ
max_pdx
 )

994 iàĞ
	`pâ_to_pdx
(
s
 >> 
PAGE_SHIFT
è>ğ
max_pdx
 )

996  
j
 = 
i
 - 1; ; --j )

998 iàĞ
boÙ_e820
.
m­
[
j
].
ty³
 =ğ
E820_RAM
 )

1000 
	`ASSERT
(
j
);

1002 
m­_e
 = 
boÙ_e820
.
m­
[
j
].
addr
 + boÙ_e820.m­[j].
size
;

1003 iàĞ(
m­_e
 >> 
PAGE_SHIFT
è< 
max_·ge
 )

1005 
max_·ge
 = 
m­_e
 >> 
PAGE_SHIFT
;

1006 
max_pdx
 = 
	`pâ_to_pdx
(
max_·ge
 - 1) + 1;

1008 
	`´štk
(
XENLOG_WARNING
 "Ignoring inaccessible memory„ange"

1009 " %013"
PRIx64
"-%013"PRIx64"\n",

1010 
s
, 
e
);

1013 
m­_e
 = 
e
;

1014 
e
 = (
	`pdx_to_pâ
(
max_pdx
 - 1è+ 1ULLè<< 
PAGE_SHIFT
;

1015 
	`´štk
(
XENLOG_WARNING
 "Ignoring inaccessible memory„ange"

1016 " %013"
PRIx64
"-%013"PRIx64"\n",

1017 
e
, 
m­_e
);

1021 
	`£t_pdx_¿nge
(
s
 >> 
PAGE_SHIFT
, 
e
 >> PAGE_SHIFT);

1023 #ifdeà
CONFIG_X86_64


1025 
m­_s
 = 
	`max_t
(
ušt64_t
, 
s
, 
BOOTSTRAP_MAP_BASE
);

1026 
m­_e
 = 
	`mš_t
(
ušt64_t
, 
e
,

1027 
	`ARRAY_SIZE
(
l2_id’tm­
è<< 
L2_PAGETABLE_SHIFT
);

1030 
	`š™_boÙ_·ges
(
s
, 
	`mš
(
m­_s
, 
e
));

1031 
s
 = 
m­_s
;

1032 iàĞ
s
 < 
m­_e
 )

1034 
ušt64_t
 
mask
 = (1UL << 
L2_PAGETABLE_SHIFT
) - 1;

1036 
m­_s
 = (
s
 + 
mask
) & ~mask;

1037 
m­_e
 &ğ~
mask
;

1038 
	`š™_boÙ_·ges
(
m­_s
, 
m­_e
);

1041 iàĞ
m­_s
 > 
m­_e
 )

1042 
m­_s
 = 
m­_e
 = 
s
;

1045 iàĞ
m­_e
 < 
e
 )

1047 
	`m­_·ges_to_x’
(()
	`__va
(
m­_e
), m­_>> 
PAGE_SHIFT
,

1048 (
e
 - 
m­_e
è>> 
PAGE_SHIFT
, 
PAGE_HYPERVISOR
);

1049 
	`š™_boÙ_·ges
(
m­_e
, 
e
);

1051 iàĞ
s
 < 
m­_s
 )

1053 
	`m­_·ges_to_x’
(()
	`__va
(
s
), s >> 
PAGE_SHIFT
,

1054 (
m­_s
 - 
s
è>> 
PAGE_SHIFT
, 
PAGE_HYPERVISOR
);

1055 
	`š™_boÙ_·ges
(
s
, 
m­_s
);

1058 
	`š™_boÙ_·ges
(
s
, 
e
);

1062  
i
 = 0; i < 
mbi
->
mods_couÁ
; ++i )

1064 
	`£t_pdx_¿nge
(
mod
[
i
].
mod_¡¬t
,

1065 
mod
[
i
].
mod_¡¬t
 + 
	`PFN_UP
(mod[i].
mod_’d
));

1066 #ifdeà
CONFIG_X86_64


1067 
	`m­_·ges_to_x’
(()
	`mâ_to_vœt
(
mod
[
i
].
mod_¡¬t
),

1068 
mod
[
i
].
mod_¡¬t
,

1069 
	`PFN_UP
(
mod
[
i
].
mod_’d
), 
PAGE_HYPERVISOR
);

1072 #ifdeà
CONFIG_X86_64


1073 
	`m­_·ges_to_x’
(()
	`__va
(
kexec_üash_¬—
.
¡¬t
),

1074 
kexec_üash_¬—
.
¡¬t
 >> 
PAGE_SHIFT
,

1075 
	`PFN_UP
(
kexec_üash_¬—
.
size
), 
PAGE_HYPERVISOR
);

1078 
	`memgu¬d_š™
();

1080 
Ä_·ges
 = 0;

1081  
i
 = 0; i < 
e820
.
Ä_m­
; i++ )

1082 iàĞ
e820
.
m­
[
i
].
ty³
 =ğ
E820_RAM
 )

1083 
Ä_·ges
 +ğ
e820
.
m­
[
i
].
size
 >> 
PAGE_SHIFT
;

1084 
	`´štk
("System RAM: %luMB (%lukB)\n",

1085 
Ä_·ges
 >> (20 - 
PAGE_SHIFT
),

1086 
Ä_·ges
 << (
PAGE_SHIFT
 - 10));

1087 
tÙ®_·ges
 = 
Ä_·ges
;

1090 
	`BUILD_BUG_ON
((((
x’_¶©fÜm_İ
 *)0)->
u
) !=

1091 (((
x’_¶©fÜm_İ
 *)0)->
u
.
·d
));

1092 
	`BUILD_BUG_ON
((((
x’_domùl
 *)0)->
u
) !=

1093 (((
x’_domùl
 *)0)->
u
.
·d
));

1094 
	`BUILD_BUG_ON
((((
x’_sysùl
 *)0)->
u
) !=

1095 (((
x’_sysùl
 *)0)->
u
.
·d
));

1097 
	`BUILD_BUG_ON
((
¡¬t_šfo_t
è> 
PAGE_SIZE
);

1098 
	`BUILD_BUG_ON
((
sh¬ed_šfo_t
è> 
PAGE_SIZE
);

1099 
	`BUILD_BUG_ON
((
vıu_šfo
) != 64);

1101 #ifdeà
CONFIG_COMPAT


1102 
	`BUILD_BUG_ON
((((
com·t_¶©fÜm_İ
 *)0)->
u
) !=

1103 (((
com·t_¶©fÜm_İ
 *)0)->
u
.
·d
));

1104 
	`BUILD_BUG_ON
((
¡¬t_šfo_com·t_t
è> 
PAGE_SIZE
);

1105 
	`BUILD_BUG_ON
((
com·t_vıu_šfo
) != 64);

1109 
	`BUILD_BUG_ON
(
__HYPERVISOR_VIRT_START
 !ğ
HYPERVISOR_VIRT_START
);

1110 #ifdeà
HYPERVISOR_VIRT_END


1111 
	`BUILD_BUG_ON
(
__HYPERVISOR_VIRT_END
 !ğ
HYPERVISOR_VIRT_END
);

1113 
	`BUILD_BUG_ON
(
MACH2PHYS_VIRT_START
 !ğ
RO_MPT_VIRT_START
);

1114 
	`BUILD_BUG_ON
(
MACH2PHYS_VIRT_END
 !ğ
RO_MPT_VIRT_END
);

1116 
	`š™_äam‘abË
();

1118 iàĞ!
aıi_boÙ_bË_š™_dÚe
 )

1119 
	`aıi_boÙ_bË_š™
();

1121 
	`aıi_numa_š™
();

1123 
	`numa_š™mem_š™
(0, 
max_·ge
);

1125 #ià
	`defšed
(
CONFIG_X86_32
)

1127  
Ä_·ges
 = 
i
 = 0; i < 
boÙ_e820
.
Ä_m­
; i++ )

1129 
ušt64_t
 
s
 = 
boÙ_e820
.
m­
[
i
].
addr
;

1130 
ušt64_t
 
e
 = 
s
 + 
boÙ_e820
.
m­
[
i
].
size
;

1131 
s
 = 
	`max_t
(
ušt64_t
, s, 
x’h—p_š™Ÿl_phys_¡¬t
);

1132 
e
 = 
	`mš_t
(
ušt64_t
,ƒ, 
x’h—p_phys_’d
);

1133 iàĞ(
boÙ_e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
è|| (
s
 >ğ
e
) )

1135 
	`š™_x’h—p_·ges
(
s
, 
e
);

1136 
Ä_·ges
 +ğ(
e
 - 
s
è>> 
PAGE_SHIFT
;

1138 
	`´štk
("Xen heap: %luMB (%lukB)\n",

1139 
Ä_·ges
 >> (20 - 
PAGE_SHIFT
),

1140 
Ä_·ges
 << (
PAGE_SHIFT
 - 10));

1143 
	`’d_boÙ_®loÿtÜ
();

1144 
—¾y_boÙ
 = 0;

1146 #ià
	`defšed
(
CONFIG_X86_64
)

1147 
	`ve§_š™
();

1150 
	`soáœq_š™
();

1151 
	`skËt_subsys_š™
();

1153 
	`—¾y_ıu_š™
();

1155 
	`·gšg_š™
();

1157 
	`tboÙ_´obe
();

1160 
	`memgu¬d_gu¬d_¡ack
(
ıu0_¡ack
);

1162 
	`İ’_soáœq
(
NEW_TLBFLUSH_CLOCK_PERIOD_SOFTIRQ
, 
Ãw_bæush_şock_³riod
);

1164 iàĞ
İt_w©chdog
 )

1165 
nmi_w©chdog
 = 
NMI_LOCAL_APIC
;

1167 
	`sÜt_exû±iÚ_bËs
();

1169 
	`fšd_smp_cÚfig
();

1171 
	`dmi_sÿn_machše
();

1173 
	`g’”ic_­ic_´obe
();

1175 
	`aıi_boÙ_š™
();

1177 iàĞ
smp_found_cÚfig
 )

1178 
	`g‘_smp_cÚfig
();

1180 #ifdeà
CONFIG_X86_64


1182 
	`z­_low_m­pšgs
();

1185 
	`š™_­ic_m­pšgs
();

1187 
	`nÜm®i£_ıu_Üd”
();

1189 
	`š™_ıu_to_node
();

1191 
	`x2­ic_b¥_£tup
();

1193 
	`š™_IRQ
();

1195 
	`xsm_š™
(&
š™rdidx
, 
mbi
, 
boÙ¡¿p_m­
);

1197 
	`tim”_š™
();

1199 
	`š™_idË_domaš
();

1201 
	`Œ­_š™
();

1203 
	`rcu_š™
();

1205 
	`—¾y_time_š™
();

1207 
	`¬ch_š™_memÜy
();

1209 
	`id’tify_ıu
(&
boÙ_ıu_d©a
);

1210 iàĞ
ıu_has_fx¤
 )

1211 
	`£t_š_ü4
(
X86_CR4_OSFXSR
);

1212 iàĞ
ıu_has_xmm
 )

1213 
	`£t_š_ü4
(
X86_CR4_OSXMMEXCPT
);

1215 
	`loÿl_œq_’abË
();

1217 #ifdeà
CONFIG_X86_64


1218 
	`ve§_mŒr_š™
();

1221 iàĞ
İt_nosmp
 )

1222 
max_ıus
 = 0;

1224 
	`iommu_£tup
();

1226 
	`smp_´•¬e_ıus
(
max_ıus
);

1228 
	`¥š_debug_’abË
();

1236 
	`š™_x’_time
();

1238 
	`š™Ÿlize_keybË
();

1240 
	`cÚsŞe_š™_po¡œq
();

1242 
	`do_´esmp_š™ÿÎs
();

1244 
	`fÜ_—ch_´e£Á_ıu
 ( 
i
 )

1247 
	`¤©_d‘eù_node
(
i
);

1249 
	`numa_add_ıu
(
i
);

1251 iàĞ(
	`num_Úlše_ıus
(è< 
max_ıus
è&& !
	`ıu_Úlše
(
i
) )

1253 
»t
 = 
	`ıu_up
(
i
);

1254 iàĞ
»t
 != 0 )

1255 
	`´štk
("FaedØbršg u°CPU %u (”rÜ %d)\n", 
i
, 
»t
);

1259 
	`´štk
("Broughˆu°%ld CPUs\n", ()
	`num_Úlše_ıus
());

1260 
	`smp_ıus_dÚe
(
max_ıus
);

1262 
	`do_š™ÿÎs
();

1264 iàĞ
İt_w©chdog
 )

1265 
	`w©chdog_’abË
();

1267 iàĞ!
	`tboÙ_´Ùeù_mem_»giÚs
() )

1268 
	`·nic
("Could‚ot…rotect TXT memory„egions\n");

1271 
	`sy¡em_wide_š™
();

1272 
	`sy¡em_wide_š™
();

1273 ià(
İt_soáÿche
)

1274 
	`’abË_soá_ÿche
();

1278 
dom0
 = 
	`domaš_ü—‹
(0, 
DOMCRF_s3_š‹gr™y
, 
DOM0_SSIDREF
);

1279 iàĞ(
dom0
 =ğ
NULL
è|| (
	`®loc_dom0_vıu0
() == NULL) )

1280 
	`·nic
("Error creating domain 0\n");

1282 
dom0
->
is_´iveged
 = 1;

1283 
dom0
->
rg‘
 = 
NULL
;

1286 
cmdlše
 = (*)(
mod
[0].
¡ršg
 ? 
	`__va
(mod[0].¡ršgè: 
NULL
);

1287 iàĞ(
cmdlše
 !ğ
NULL
è|| (
kexŒa
 != NULL) )

1289 
dom0_cmdlše
[
MAX_GUEST_CMDLINE
];

1291 
cmdlše
 = 
	`cmdlše_cook
(cmdlše, 
lßd”
);

1292 
	`§ã_¡rıy
(
dom0_cmdlše
, 
cmdlše
);

1294 iàĞ
kexŒa
 !ğ
NULL
 )

1296 
	`§ã_¡rÿt
(
dom0_cmdlše
, 
kexŒa
);

1299 iàĞ
sk_ißpic_£tup
 && !
	`¡r¡r
(
dom0_cmdlše
, "noapic") )

1300 
	`§ã_¡rÿt
(
dom0_cmdlše
, "‚oapic");

1301 iàĞ
aıi_sk_tim”_ov”ride
 &&

1302 !
	`¡r¡r
(
dom0_cmdlše
, "acpi_skip_timer_override") )

1303 
	`§ã_¡rÿt
(
dom0_cmdlše
, "‡cpi_skip_timer_override");

1304 iàĞ(
	`¡¾’
(
aıi_·¿m
è=ğ0è&& 
aıi_di§bËd
 )

1306 
	`´štk
("ACPI is disabled,‚otifying Domain 0 (acpi=off)\n");

1307 
	`§ã_¡rıy
(
aıi_·¿m
, "off");

1309 iàĞ(
	`¡¾’
(
aıi_·¿m
è!ğ0è&& !
	`¡r¡r
(
dom0_cmdlše
, "acpi=") )

1311 
	`§ã_¡rÿt
(
dom0_cmdlše
, "‡cpi=");

1312 
	`§ã_¡rÿt
(
dom0_cmdlše
, 
aıi_·¿m
);

1315 
cmdlše
 = 
dom0_cmdlše
;

1318 iàĞ
x’_ıuidË
 )

1319 
x’_´oûssÜ_pmb™s
 |ğ
XEN_PROCESSOR_PM_CX
;

1325 iàĞ
	`cÚ¡ruù_dom0
(
dom0
, 
mod
, 
moduËs_h—droom
,

1326 (
š™rdidx
 > 0è&& (š™rdidx < 
mbi
->
mods_couÁ
)

1327 ? 
mod
 + 
š™rdidx
 : 
NULL
,

1328 
boÙ¡¿p_m­
, 
cmdlše
) != 0)

1329 
	`·nic
("Could‚ot set up DOM0 guest OS\n");

1332 
	`süub_h—p_·ges
();

1334 
	`š™_Œaû_bufs
();

1336 
	`cÚsŞe_’dboÙ
();

1339 
	`£rŸl_’dboÙ
();

1341 
	`domaš_uÅau£_by_sy¡emcÚŒŞËr
(
dom0
);

1343 
	`»£t_¡ack_ªd_jump
(
š™_dÚe
);

1344 
	}
}

1346 
	$¬ch_g‘_x’_ÿps
(
x’_ÿ·b™›s_šfo_t
 *
šfo
)

1349 
majÜ
 = 3, 
mšÜ
 = 0;

1350 
s
[32];

1352 (*
šfo
)[0] = '\0';

1354 #ifdeà
CONFIG_X86_64


1355 
	`¢´štf
(
s
, (s), "x’-%d.%d-x86_64 ", 
majÜ
, 
mšÜ
);

1356 
	`§ã_¡rÿt
(*
šfo
, 
s
);

1358 
	`¢´štf
(
s
, (s), "x’-%d.%d-x86_32°", 
majÜ
, 
mšÜ
);

1359 
	`§ã_¡rÿt
(*
šfo
, 
s
);

1360 iàĞ
hvm_’abËd
 )

1362 
	`¢´štf
(
s
, (s), "hvm-%d.%d-x86_32 ", 
majÜ
, 
mšÜ
);

1363 
	`§ã_¡rÿt
(*
šfo
, 
s
);

1364 
	`¢´štf
(
s
, (s), "hvm-%d.%d-x86_32°", 
majÜ
, 
mšÜ
);

1365 
	`§ã_¡rÿt
(*
šfo
, 
s
);

1366 #ifdeà
CONFIG_X86_64


1367 
	`¢´štf
(
s
, (s), "hvm-%d.%d-x86_64 ", 
majÜ
, 
mšÜ
);

1368 
	`§ã_¡rÿt
(*
šfo
, 
s
);

1371 
	}
}

1373 
	$x’_š_¿nge
(
mâ
)

1375 
·ddr_t
 
¡¬t
, 
’d
;

1376 
i
;

1378 ’um { 
»giÚ_s3
, 
»giÚ_‹xt
, 
»giÚ_bss
, 
Ä_»giÚs
 };

1380 
·ddr_t
 
s
, 
e
;

1381 } 
x’_»giÚs
[
Ä_»giÚs
];

1384 iàĞ!
x’_»giÚs
[0].
s
 )

1387 
x’_»giÚs
[
»giÚ_s3
].
s
 = 
	`boÙsym_phys
(
ŒampŞše_¡¬t
);

1388 
x’_»giÚs
[
»giÚ_s3
].
e
 = 
	`boÙsym_phys
(
ŒampŞše_’d
);

1390 
x’_»giÚs
[
»giÚ_‹xt
].
s
 =
	`__·
(&
_¡ext
);

1391 
x’_»giÚs
[
»giÚ_‹xt
].
e
 = 
	`__·
(&
__š™_begš
);

1393 
x’_»giÚs
[
»giÚ_bss
].
s
 = 
	`__·
(&
__bss_¡¬t
);

1394 
x’_»giÚs
[
»giÚ_bss
].
e
 = 
	`__·
(&
_’d
);

1397 
¡¬t
 = (
·ddr_t
)
mâ
 << 
PAGE_SHIFT
;

1398 
’d
 = 
¡¬t
 + 
PAGE_SIZE
;

1399  
i
 = 0; i < 
Ä_»giÚs
; i++ )

1400 iàĞ(
¡¬t
 < 
x’_»giÚs
[
i
].
e
è&& (
’d
 > x’_»giÚs[i].
s
) )

1404 
	}
}

	@shutdown.c

7 
	~<x’/cÚfig.h
>

8 
	~<x’/š™.h
>

9 
	~<x’/lib.h
>

10 
	~<x’/sched.h
>

11 
	~<x’/smp.h
>

12 
	~<x’/d–ay.h
>

13 
	~<x’/dmi.h
>

14 
	~<x’/œq.h
>

15 
	~<x’/cÚsŞe.h
>

16 
	~<x’/shutdown.h
>

17 
	~<x’/aıi.h
>

18 
	~<asm/m¤.h
>

19 
	~<asm/»gs.h
>

20 
	~<asm/mc146818¹c.h
>

21 
	~<asm/sy¡em.h
>

22 
	~<asm/io.h
>

23 
	~<asm/´oûssÜ.h
>

24 
	~<asm/mp¥ec.h
>

25 
	~<asm/tboÙ.h
>

26 
	~<asm/­ic.h
>

28 
	e»boÙ_ty³
 {

29 
	mBOOT_TRIPLE
 = 't',

30 
	mBOOT_KBD
 = 'k',

31 
	mBOOT_ACPI
 = 'a',

32 
	mBOOT_BIOS
 = 'b',

35 
	gno_idt
[2];

36 
	g»boÙ_mode
;

47 
»boÙ_ty³
 
	g»boÙ_ty³
 = 
BOOT_ACPI
;

48 
__š™
 
	$£t_»boÙ_ty³
(*
¡r
)

52  *
¡r
 )

55 
İt_nÜeboÙ
 = 1;

58 
»boÙ_mode
 = 0x1234;

61 
»boÙ_mode
 = 0x0;

67 
»boÙ_ty³
 = *
¡r
;

70 iàĞ(
¡r
 = 
	`¡rchr
(¡r, ',')è=ğ
NULL
 )

72 
¡r
++;

74 
	}
}

75 
cu¡om_·¿m
("»boÙ", 
£t_»boÙ_ty³
);

77 
šlše
 
	$kb_wa™
()

79 
i
;

81  
i
 = 0; i < 0x10000; i++ )

82 iàĞ(
	`šb_p
(0x64) & 0x02) == 0 )

84 
	}
}

86 
__©Œibu‹__
((
nÜ‘uº
)è
	$__machše_h®t
(*
unu£d
)

88 
	`loÿl_œq_di§bË
();

90 
	`h®t
();

91 
	}
}

93 
	$machše_h®t
()

95 
	`w©chdog_di§bË
();

96 
	`cÚsŞe_¡¬t_sync
();

97 
	`loÿl_œq_’abË
();

98 
	`smp_ÿÎ_funùiÚ
(
__machše_h®t
, 
NULL
, 0);

99 
	`__machše_h®t
(
NULL
);

100 
	}
}

102 #ifdeà
__i386__


112 
	g»®_mode_gdt_’Œ›s
 [3] =

121 
size
 
__©Œibu‹__
 ((
·cked
));

122 * 
ba£
 
__©Œibu‹__
 ((
·cked
));

124 
	g»®_mode_gdt
 = {  (
»®_mode_gdt_’Œ›s
) - 1,„eal_mode_gdt_entries },

125 
	g»®_mode_idt
 = { 0x3ff, 
NULL
 };

147 cÚ¡ 
	g»®_mode_sw™ch
 [] =

161 
	#MAX_LENGTH
 0x40

	)

162 cÚ¡ 
	gjump_to_bios
 [] =

172 
	$machše_»®_»¡¬t
(cÚ¡ *
code
, 
Ëngth
)

174 
	`loÿl_œq_di§bË
();

183 
	`¥š_lock
(&
¹c_lock
);

184 
	`CMOS_WRITE
(0x00, 0x8f);

185 
	`¥š_uÆock
(&
¹c_lock
);

189 
	`m­_·ges_to_x’
(0, 0, 1, 
__PAGE_HYPERVISOR
|
MAP_SMALL_PAGES
);

190 
	`£t_cu¼’t
(
idË_vıu
[0]);

191 
	`wr™e_±ba£
(
idË_vıu
[0]);

199 
	`memıy
((*)(
PAGE_SIZE
 - (
»®_mode_sw™ch
è- 
MAX_LENGTH
),

200 
»®_mode_sw™ch
, (real_mode_switch));

201 
	`memıy
((*)(
PAGE_SIZE
 - 
MAX_LENGTH
), 
code
, 
Ëngth
);

205 
__asm__
 
	`__vŞ©e__
("lidˆ%0": : "m" (
»®_mode_idt
));

211 
__asm__
 
	`__vŞ©e__
("lgdˆ%0": : "m" (
»®_mode_gdt
));

219 
__asm__
 
	`__vŞ©e__
 ("\tmov %0,%%ds\n"

231 
__asm__
 
	`__vŞ©e__
 ("ljmp $0x0008,%0"

233 : "i" ((*)(
PAGE_SIZE
 -

234 (
»®_mode_sw™ch
) -

235 
MAX_LENGTH
)));

236 
	}
}

238 
__š™
 
	$£t_bios_»boÙ
(
dmi_sy¡em_id
 *
d
)

240 iàĞ
»boÙ_ty³
 !ğ
BOOT_BIOS
 )

242 
»boÙ_ty³
 = 
BOOT_BIOS
;

243 
	`´štk
("%s series board detected. "

244 "S–eùšg BIOS-m‘hod fÜ„eboÙs.\n", 
d
->
id’t
);

247 
	}
}

249 
dmi_sy¡em_id
 
__š™d©a
 
	g»boÙ_dmi_bË
[] = {

251 .
ÿÎback
 = 
£t_bios_»boÙ
,

252 .
	gid’t
 = "Dell PowerEdge 1300",

253 .
	gm©ches
 = {

254 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

255 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 1300/"),

259 .
	gÿÎback
 = 
£t_bios_»boÙ
,

260 .
	gid’t
 = "Dell PowerEdge 300",

261 .
	gm©ches
 = {

262 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

263 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 300/"),

267 .
	gÿÎback
 = 
£t_bios_»boÙ
,

268 .
	gid’t
 = "Dell PowerEdge 2400",

269 .
	gm©ches
 = {

270 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Dell Computer Corporation"),

271 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "PowerEdge 2400"),

275 .
	gÿÎback
 = 
£t_bios_»boÙ
,

276 .
	gid’t
 = "HP Compaq Laptop",

277 .
	gm©ches
 = {

278 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Hewlett-Packard"),

279 
DMI_MATCH
(
DMI_PRODUCT_NAME
, "HP Compaq"),

285 
__š™
 
	$»boÙ_š™
()

287 
	`dmi_check_sy¡em
(
»boÙ_dmi_bË
);

289 
	}
}

290 
__š™ÿÎ
(
»boÙ_š™
);

294 
	#machše_»®_»¡¬t
(
x
, 
y
)

	)

298 
	$__machše_»¡¬t
(*
pd–ay
)

300 
	`machše_»¡¬t
(*(*)
pd–ay
);

301 
	}
}

303 
	$machše_»¡¬t
(
d–ay_mli£cs
)

305 
i
, 
©‹m±
;

306 
»boÙ_ty³
 
Üig_»boÙ_ty³
 =„eboot_type;

308 
	`w©chdog_di§bË
();

309 
	`cÚsŞe_¡¬t_sync
();

310 
	`¥š_debug_di§bË
();

312 
	`aıi_dm¬_»š¡©e
();

314 
	`loÿl_œq_’abË
();

317 iàĞ
	`g‘_­ic_id
(è!ğ
boÙ_ıu_physiÿl_­icid
 )

320 
	`Ú_£Ëùed_ıus
(
	`ıumask_of
(0), 
__machše_»¡¬t
,

321 &
d–ay_mli£cs
, 0);

323 
	`h®t
();

331 
	`loÿl_œq_couÁ
(0) = 0;

333 
	`smp_£nd_¡İ
();

335 
	`md–ay
(
d–ay_mli£cs
);

337 iàĞ
	`tboÙ_š_m—su»d_’v
() )

338 
	`tboÙ_shutdown
(
TB_SHUTDOWN_REBOOT
);

341 *((*)
	`__va
(0x472)èğ
»boÙ_mode
;

343  
©‹m±
 = 0; ;‡ttempt++ )

345  
»boÙ_ty³
 )

347 
BOOT_KBD
:

349  
i
 = 0; i < 100; i++ )

351 
	`kb_wa™
();

352 
	`ud–ay
(50);

353 
	`outb
(0xfe,0x64);

354 
	`ud–ay
(50);

363 
»boÙ_ty³
 = (((
©‹m±
 =ğ1è&& (
Üig_»boÙ_ty³
 =ğ
BOOT_ACPI
))

364 ? 
BOOT_ACPI
 : 
BOOT_TRIPLE
);

366 
BOOT_TRIPLE
:

367 
asm
 vŞ©Ğ"lidˆ%0 ; iÁ3" : "=m" (
no_idt
) );

368 
»boÙ_ty³
 = 
BOOT_KBD
;

370 
BOOT_BIOS
:

371 
	`machše_»®_»¡¬t
(
jump_to_bios
, (jump_to_bios));

372 
»boÙ_ty³
 = 
BOOT_KBD
;

374 
BOOT_ACPI
:

375 
	`aıi_»boÙ
();

376 
»boÙ_ty³
 = 
BOOT_KBD
;

380 
	}
}

	@smp.c

11 
	~<x’/cÚfig.h
>

12 
	~<x’/œq.h
>

13 
	~<x’/sched.h
>

14 
	~<x’/d–ay.h
>

15 
	~<x’/³rfc.h
>

16 
	~<x’/¥šlock.h
>

17 
	~<asm/cu¼’t.h
>

18 
	~<asm/smp.h
>

19 
	~<asm/mc146818¹c.h
>

20 
	~<asm/æushb.h
>

21 
	~<asm/h¬dœq.h
>

22 
	~<asm/hvm/suµÜt.h
>

23 
	~<mach_­ic.h
>

25 
	$h¬d_smp_´oûssÜ_id
()

27  
	`g‘_­ic_id
();

28 
	}
}

30 
	$logiÿl_smp_´oûssÜ_id
()

32  
	`g‘_logiÿl_­ic_id
();

33 
	}
}

40 
	$£nd_IPI_mask
(cÚ¡ 
ıumask_t
 *
mask
, 
veùÜ
)

42 
g’­ic
->
	`£nd_IPI_mask
(
mask
, 
veùÜ
);

43 
	}
}

87 
šlše
 
	$__´•¬e_ICR
 (
shÜtcut
, 
veùÜ
)

89  
APIC_DM_FIXED
 | 
shÜtcut
 | 
veùÜ
;

90 
	}
}

92 
šlše
 
	$__´•¬e_ICR2
 (
mask
)

94  
	`SET_xAPIC_DEST_FIELD
(
mask
);

95 
	}
}

97 
	$­ic_wa™_iü_idË
()

99 iàĞ
x2­ic_’abËd
 )

102  
	`­ic_»ad
Ğ
APIC_ICR
 ) & 
APIC_ICR_BUSY
 )

103 
	`ıu_»Ïx
();

104 
	}
}

106 
	$__deçuÉ_£nd_IPI_shÜtcut
(
shÜtcut
, 
veùÜ
,

107 
de¡
)

109 
cfg
;

114 
	`­ic_wa™_iü_idË
();

119 
cfg
 = 
	`__´•¬e_ICR
(
shÜtcut
, 
veùÜ
è| 
de¡
;

123 
	`­ic_wr™e_¬ound
(
APIC_ICR
, 
cfg
);

124 
	}
}

126 
	$£nd_IPI_£lf_æ©
(
veùÜ
)

128 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_SELF
, 
veùÜ
, 
APIC_DEST_PHYSICAL
);

129 
	}
}

131 
	$£nd_IPI_£lf_phys
(
veùÜ
)

133 
	`__deçuÉ_£nd_IPI_shÜtcut
(
APIC_DEST_SELF
, 
veùÜ
, 
APIC_DEST_PHYSICAL
);

134 
	}
}

136 
	$£nd_IPI_£lf_x2­ic
(
veùÜ
)

138 
	`­ic_wr™e
(
APIC_SELF_IPI
, 
veùÜ
);

139 
	}
}

141 
	$£nd_IPI_mask_æ©
(cÚ¡ 
ıumask_t
 *
ıumask
, 
veùÜ
)

143 
mask
 = 
	`ıus_addr
(*
ıumask
)[0];

144 
cfg
;

145 
æags
;

147 
mask
 &ğ
	`ıus_addr
(
ıu_Úlše_m­
)[0];

148 
mask
 &ğ~(1UL << 
	`smp_´oûssÜ_id
());

149 iàĞ
mask
 == 0 )

152 
	`loÿl_œq_§ve
(
æags
);

157 
	`­ic_wa™_iü_idË
();

162 
cfg
 = 
	`__´•¬e_ICR2
(
mask
);

163 
	`­ic_wr™e_¬ound
(
APIC_ICR2
, 
cfg
);

168 
cfg
 = 
	`__´•¬e_ICR
(0, 
veùÜ
è| 
APIC_DEST_LOGICAL
;

173 
	`­ic_wr™e_¬ound
(
APIC_ICR
, 
cfg
);

175 
	`loÿl_œq_»¡Üe
(
æags
);

176 
	}
}

178 
	$£nd_IPI_mask_phys
(cÚ¡ 
ıumask_t
 *
mask
, 
veùÜ
)

180 
cfg
, 
æags
;

181 
qu”y_ıu
;

183 
	`loÿl_œq_§ve
(
æags
);

185 
	`fÜ_—ch_ıu_mask
 ( 
qu”y_ıu
, *
mask
 )

187 iàĞ!
	`ıu_Úlše
(
qu”y_ıu
è|| (qu”y_ıu =ğ
	`smp_´oûssÜ_id
()) )

193 
	`­ic_wa™_iü_idË
();

198 
cfg
 = 
	`__´•¬e_ICR2
(
	`ıu_physiÿl_id
(
qu”y_ıu
));

199 
	`­ic_wr™e_¬ound
(
APIC_ICR2
, 
cfg
);

204 
cfg
 = 
	`__´•¬e_ICR
(0, 
veùÜ
è| 
APIC_DEST_PHYSICAL
;

209 
	`­ic_wr™e_¬ound
(
APIC_ICR
, 
cfg
);

212 
	`loÿl_œq_»¡Üe
(
æags
);

213 
	}
}

215 
DEFINE_SPINLOCK
(
æush_lock
);

216 
ıumask_t
 
	gæush_ıumask
;

217 cÚ¡ *
	gæush_va
;

218 
	gæush_æags
;

220 
ç¡ÿÎ
 
	$smp_šv®id©e_š‹¼u±
()

222 
	`ack_APIC_œq
();

223 
	`³rfc_šü
(
is
);

224 
	`œq_’‹r
();

225 iàĞ!
	`__sync_loÿl_exec¡©e
() ||

226 (
æush_æags
 & (
FLUSH_TLB_GLOBAL
 | 
FLUSH_CACHE
)) )

227 
	`æush_¬—_loÿl
(
æush_va
, 
æush_æags
);

228 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
æush_ıumask
);

229 
	`œq_ex™
();

230 
	}
}

232 
	$æush_¬—_mask
(cÚ¡ 
ıumask_t
 *
mask
, cÚ¡ *
va
, 
æags
)

234 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

236 iàĞ
	`ıu_is£t
(
	`smp_´oûssÜ_id
(), *
mask
) )

237 
	`æush_¬—_loÿl
(
va
, 
æags
);

239 iàĞ!
	`ıus_sub£t
(*
mask
, *
	`ıumask_of
(
	`smp_´oûssÜ_id
())) )

241 
	`¥š_lock
(&
æush_lock
);

242 
	`ıus_ªd
(
æush_ıumask
, *
mask
, 
ıu_Úlše_m­
);

243 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
æush_ıumask
);

244 
æush_va
 = 
va
;

245 
æush_æags
 = 
æags
;

246 
	`£nd_IPI_mask
(&
æush_ıumask
, 
INVALIDATE_TLB_VECTOR
);

247  !
	`ıus_em±y
(
æush_ıumask
) )

248 
	`ıu_»Ïx
();

249 
	`¥š_uÆock
(&
æush_lock
);

251 
	}
}

254 
	$Ãw_bæush_şock_³riod
()

256 
ıumask_t
 
®lbut£lf
;

259 
®lbut£lf
 = 
ıu_Úlše_m­
;

260 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbut£lf
);

261 
	`æush_mask
(&
®lbut£lf
, 
FLUSH_TLB
);

264 
	`ASSERT
(
bæush_şock
 == 0);

265 
bæush_şock
++;

266 
	}
}

268 
	$smp_£nd_ev’t_check_mask
(cÚ¡ 
ıumask_t
 *
mask
)

270 
	`£nd_IPI_mask
(
mask
, 
EVENT_CHECK_VECTOR
);

271 
	}
}

277 
__smp_ÿÎ_funùiÚ_š‹¼u±
();

278 
DEFINE_SPINLOCK
(
ÿÎ_lock
);

279 
	sÿÎ_d©a_¡ruù
 {

280 (*
	mfunc
è(*
	mšfo
);

281 *
	mšfo
;

282 
	mwa™
;

283 
ıumask_t
 
	m£Ëùed
;

284 } 
	gÿÎ_d©a
;

286 
smp_ÿÎ_funùiÚ
(

287 (*
func
è(*
šfo
),

288 *
šfo
,

289 
wa™
)

291 
ıumask_t
 
®lbut£lf
 = 
ıu_Úlše_m­
;

292 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
®lbut£lf
);

293 
	`Ú_£Ëùed_ıus
(&
®lbut£lf
, 
func
, 
šfo
, 
wa™
);

294 
	}
}

296 
Ú_£Ëùed_ıus
(

297 cÚ¡ 
ıumask_t
 *
£Ëùed
,

298 (*
func
è(*
šfo
),

299 *
šfo
,

300 
wa™
)

302 
Ä_ıus
;

304 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

306 
	`¥š_lock
(&
ÿÎ_lock
);

308 
ÿÎ_d©a
.
£Ëùed
 = *selected;

310 
Ä_ıus
 = 
	`ıus_weight
(
ÿÎ_d©a
.
£Ëùed
);

311 iàĞ
Ä_ıus
 == 0 )

312 
out
;

314 
ÿÎ_d©a
.
func
 = func;

315 
ÿÎ_d©a
.
šfo
 = info;

316 
ÿÎ_d©a
.
wa™
 = wait;

318 
	`£nd_IPI_mask
(&
ÿÎ_d©a
.
£Ëùed
, 
CALL_FUNCTION_VECTOR
);

320 iàĞ
	`ıu_is£t
(
	`smp_´oûssÜ_id
(), 
ÿÎ_d©a
.
£Ëùed
) )

322 
	`loÿl_œq_di§bË
();

323 
	`__smp_ÿÎ_funùiÚ_š‹¼u±
();

324 
	`loÿl_œq_’abË
();

327  !
	`ıus_em±y
(
ÿÎ_d©a
.
£Ëùed
) )

328 
	`ıu_»Ïx
();

330 
out
:

331 
	`¥š_uÆock
(&
ÿÎ_lock
);

332 
	}
}

334 
	$__¡İ_this_ıu
()

336 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

338 
	`di§bË_loÿl_APIC
();

340 
	`hvm_ıu_down
();

346 
	`şts
();

347 
asm
 volatile ( "fninit" );

348 
	}
}

350 
	$¡İ_this_ıu
(*
dummy
)

352 
	`__¡İ_this_ıu
();

353 
	`ıu_ş—r
(
	`smp_´oûssÜ_id
(), 
ıu_Úlše_m­
);

355 
	`h®t
();

356 
	}
}

362 
	$smp_£nd_¡İ
()

364 
timeout
 = 10;

366 
	`smp_ÿÎ_funùiÚ
(
¡İ_this_ıu
, 
NULL
, 0);

369  (
	`num_Úlše_ıus
(è> 1è&& (
timeout
-- > 0) )

370 
	`md–ay
(1);

372 
	`loÿl_œq_di§bË
();

373 
	`__¡İ_this_ıu
();

374 
	`di§bË_IO_APIC
();

375 
	`loÿl_œq_’abË
();

376 
	}
}

378 
	$smp_£nd_nmi_®lbut£lf
()

380 
	`£nd_IPI_mask
(&
ıu_Úlše_m­
, 
APIC_DM_NMI
);

381 
	}
}

383 
ç¡ÿÎ
 
	$smp_ev’t_check_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

385 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

386 
	`ack_APIC_œq
();

387 
	`³rfc_šü
(
is
);

388 
	`£t_œq_»gs
(
Şd_»gs
);

389 
	}
}

391 
	$__smp_ÿÎ_funùiÚ_š‹¼u±
()

393 (*
func
)(*
šfo
èğ
ÿÎ_d©a
.func;

394 *
šfo
 = 
ÿÎ_d©a
.info;

395 
ıu
 = 
	`smp_´oûssÜ_id
();

397 iàĞ!
	`ıu_is£t
(
ıu
, 
ÿÎ_d©a
.
£Ëùed
) )

400 
	`œq_’‹r
();

402 iàĞ
ÿÎ_d©a
.
wa™
 )

404 (*
func
)(
šfo
);

405 
	`mb
();

406 
	`ıu_ş—r
(
ıu
, 
ÿÎ_d©a
.
£Ëùed
);

410 
	`mb
();

411 
	`ıu_ş—r
(
ıu
, 
ÿÎ_d©a
.
£Ëùed
);

412 (*
func
)(
šfo
);

415 
	`œq_ex™
();

416 
	}
}

418 
ç¡ÿÎ
 
	$smp_ÿÎ_funùiÚ_š‹¼u±
(
ıu_u£r_»gs
 *
»gs
)

420 
ıu_u£r_»gs
 *
Şd_»gs
 = 
	`£t_œq_»gs
(
»gs
);

422 
	`ack_APIC_œq
();

423 
	`³rfc_šü
(
is
);

424 
	`__smp_ÿÎ_funùiÚ_š‹¼u±
();

425 
	`£t_œq_»gs
(
Şd_»gs
);

426 
	}
}

	@smpboot.c

23 
	~<x’/cÚfig.h
>

24 
	~<x’/š™.h
>

25 
	~<x’/k”Ãl.h
>

26 
	~<x’/mm.h
>

27 
	~<x’/domaš.h
>

28 
	~<x’/sched.h
>

29 
	~<x’/sched-if.h
>

30 
	~<x’/œq.h
>

31 
	~<x’/d–ay.h
>

32 
	~<x’/soáœq.h
>

33 
	~<x’/skËt.h
>

34 
	~<x’/£rŸl.h
>

35 
	~<x’/numa.h
>

36 
	~<x’/ıu.h
>

37 
	~<asm/cu¼’t.h
>

38 
	~<asm/mc146818¹c.h
>

39 
	~<asm/desc.h
>

40 
	~<asm/div64.h
>

41 
	~<asm/æushb.h
>

42 
	~<asm/m¤.h
>

43 
	~<asm/mŒr.h
>

44 
	~<asm/time.h
>

45 
	~<mach_­ic.h
>

46 
	~<mach_wakeıu.h
>

47 
	~<smpboÙ_hooks.h
>

48 
	~<aıi/ıuäeq/´oûssÜ_³rf.h
>

50 
	#£tup_ŒampŞše
(è(
	`boÙsym_phys
(
ŒampŞše_»®mode_’Œy
))

	)

52 
	~<mši.h
>

55 
	gsmp_b_¡•pšg
;

58 
	gphys_´oc_id
[
NR_CPUS
] 
	g__»ad_mo¡ly
 = {[0 ... NR_CPUS-1] = 
BAD_APICID
};

61 
	gıu_cÜe_id
[
NR_CPUS
] 
	g__»ad_mo¡ly
 = {[0 ... NR_CPUS-1] = 
BAD_APICID
};

64 
DEFINE_PER_CPU_READ_MOSTLY
(
ıumask_t
, 
ıu_siblšg_m­
);

66 
DEFINE_PER_CPU_READ_MOSTLY
(
ıumask_t
, 
ıu_cÜe_m­
);

68 
ıumask_t
 
ıu_Úlše_m­
 
	g__»ad_mo¡ly
;

69 
EXPORT_SYMBOL
(
ıu_Úlše_m­
);

71 
ıušfo_x86
 
	gıu_d©a
[
NR_CPUS
];

73 
u32
 
	gx86_ıu_to_­icid
[
NR_CPUS
] 
	g__»ad_mo¡ly
 =

74 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

76 
m­_ıu_to_logiÿl_­icid
();

78 
	gıu_”rÜ
;

79 
	eıu_¡©e
 {

80 
	mCPU_STATE_DYING
,

81 
	mCPU_STATE_DEAD
,

82 
	mCPU_STATE_INIT
,

83 
	mCPU_STATE_CALLOUT
,

84 
	mCPU_STATE_CALLIN
,

85 
	mCPU_STATE_ONLINE


86 } 
	gıu_¡©e
;

87 
	#£t_ıu_¡©e
(
¡©e
èdØ{ 
	`mb
(); 
ıu_¡©e
 = (¡©e); } 0)

	)

89 *
	g¡ack_ba£
[
NR_CPUS
];

91 
	$smp_¡Üe_ıu_šfo
(
id
)

93 
ıušfo_x86
 *
c
 = 
ıu_d©a
 + 
id
;

95 *
c
 = 
boÙ_ıu_d©a
;

96 iàĞ
id
 != 0 )

97 
	`id’tify_ıu
(
c
);

100 iàĞ(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
) &&

101 (
c
->
x86
 == 5) &&

102 ((
c
->
x86_mask
 >= 1) && (c->x86_mask <= 4)) &&

103 (
c
->
x86_mod–
 <= 3) )

104 
smp_b_¡•pšg
 = 1;

110 iàĞ(
c
->
x86_v’dÜ
 =ğ
X86_VENDOR_AMD
è&& (c->
x86
 == 6) )

113 iàĞ(
c
->
x86_mod–
==6è&& ((c->
x86_mask
==0) || (c->x86_mask==1)) )

114 
v®id_k7
;

117 iàĞ(
c
->
x86_mod–
==7è&& (c->
x86_mask
==0) )

118 
v®id_k7
;

126 iàĞ((
c
->
x86_mod–
==6è&& (c->
x86_mask
>=2)) ||

127 ((
c
->
x86_mod–
==7è&& (c->
x86_mask
>=1)) ||

128 (
c
->
x86_mod–
> 7) )

129 ià(
ıu_has_mp
)

130 
v®id_k7
;

133 
	`add_št
(
TAINT_UNSAFE_SMP
);

136 
v®id_k7
:

138 
	}
}

144 
boŞ_t
 
	gdi§bË_tsc_sync
;

146 
©omic_t
 
	gtsc_couÁ
;

147 
ušt64_t
 
	gtsc_v®ue
;

148 
ıumask_t
 
	gtsc_sync_ıu_mask
;

150 
	$synchrÚize_tsc_ma¡”
(
¦ave
)

152 
i
;

154 iàĞ
di§bË_tsc_sync
 )

157 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) &&

158 !
	`ıu_is£t
(
¦ave
, 
tsc_sync_ıu_mask
) )

161  
i
 = 1; i <= 5; i++ )

163 
	`rdtsşl
(
tsc_v®ue
);

164 
	`wmb
();

165 
	`©omic_šc
(&
tsc_couÁ
);

166  
	`©omic_»ad
(&
tsc_couÁ
è!ğ(
i
<<1) )

167 
	`ıu_»Ïx
();

170 
	`©omic_£t
(&
tsc_couÁ
, 0);

171 
	`ıu_ş—r
(
¦ave
, 
tsc_sync_ıu_mask
);

172 
	}
}

174 
	$synchrÚize_tsc_¦ave
(
¦ave
)

176 
i
;

178 iàĞ
di§bË_tsc_sync
 )

181 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) &&

182 !
	`ıu_is£t
(
¦ave
, 
tsc_sync_ıu_mask
) )

185  
i
 = 1; i <= 5; i++ )

187  
	`©omic_»ad
(&
tsc_couÁ
è!ğ((
i
<<1)-1) )

188 
	`ıu_»Ïx
();

189 
	`rmb
();

195 
	`__wr™e_tsc
(
tsc_v®ue
);

196 
	`©omic_šc
(&
tsc_couÁ
);

198 
	}
}

200 
	$smp_ÿÎš
()

202 
ıu
 = 
	`smp_´oûssÜ_id
();

203 
i
, 
rc
;

206 
	`D´štk
("Waiting for CALLOUT.\n");

207  
i
 = 0; 
ıu_¡©e
 !ğ
CPU_STATE_CALLOUT
; i++ )

209 
	`BUG_ON
(
i
 >= 200);

210 
	`ıu_»Ïx
();

211 
	`md–ay
(10);

218 
	`D´štk
("CALLIN, before setup_local_APIC().\n");

219 
	`x2­ic_­_£tup
();

220 
	`£tup_loÿl_APIC
();

221 
	`m­_ıu_to_logiÿl_­icid
();

224 
	`smp_¡Üe_ıu_šfo
(
ıu
);

226 iàĞ(
rc
 = 
	`hvm_ıu_up
()) != 0 )

228 (*
d—d_idË
) ();

229 
	`´štk
("CPU%d: FaedØš™Ÿli£ HVM. NÙ comšg oÆše.\n", 
ıu
);

230 
ıu_”rÜ
 = 
rc
;

231 
	`ş—r_loÿl_APIC
();

232 
	`¥š_debug_’abË
();

233 
	`ıu_ex™_ş—r
(
ıu
);

234 (*
d—d_idË
)();

238 
	`£t_ıu_¡©e
(
CPU_STATE_CALLIN
);

240 
	`synchrÚize_tsc_¦ave
(
ıu
);

243  
ıu_¡©e
 !ğ
CPU_STATE_ONLINE
 )

244 
	`ıu_»Ïx
();

245 
	}
}

247 
	gboÙšg_ıu
;

250 
ıumask_t
 
	gıu_siblšg_£tup_m­
;

252 
	$£t_ıu_siblšg_m­
(
ıu
)

254 
i
;

255 
ıušfo_x86
 *
c
 = 
ıu_d©a
;

257 
	`ıu_£t
(
ıu
, 
ıu_siblšg_£tup_m­
);

259 iàĞ
c
[
ıu
].
x86_num_siblšgs
 > 1 )

261 
	`fÜ_—ch_ıu_mask
 ( 
i
, 
ıu_siblšg_£tup_m­
 )

263 iàĞ(
phys_´oc_id
[
ıu
] =ğphys_´oc_id[
i
]) &&

264 (
ıu_cÜe_id
[
ıu
] =ğıu_cÜe_id[
i
]) )

266 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
));

267 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
i
));

268 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

269 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
i
));

275 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, cpu));

278 iàĞ
c
[
ıu
].
x86_max_cÜes
 == 1 )

280 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
èğ³r_ıu(
ıu_siblšg_m­
, cpu);

281 
c
[
ıu
].
boÙed_cÜes
 = 1;

285 
	`fÜ_—ch_ıu_mask
 ( 
i
, 
ıu_siblšg_£tup_m­
 )

287 iàĞ
phys_´oc_id
[
ıu
] =ğphys_´oc_id[
i
] )

289 
	`ıu_£t
(
i
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

290 
	`ıu_£t
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
i
));

294 iàĞ
	`ıus_weight
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
)) == 1 )

300 iàĞ
	`fœ¡_ıu
(
	`³r_ıu
(
ıu_siblšg_m­
, 
i
)) == i )

301 
c
[
ıu
].
boÙed_cÜes
++;

306 iàĞ
i
 !ğ
ıu
 )

307 
c
[
i
].
boÙed_cÜes
++;

309 iàĞ(
i
 !ğ
ıu
è&& !
c
[ıu].
boÙed_cÜes
 )

311 
c
[
ıu
].
boÙed_cÜes
 = c[
i
].booted_cores;

315 
	}
}

317 
	$cÚ¡ruù_³rıu_idt
(
ıu
)

319 
idt_lßd
[10];

321 *(*)(&
idt_lßd
[0]èğ(
IDT_ENTRIES
*(
idt_’Œy_t
))-1;

322 *(*)(&
idt_lßd
[2]èğ()
idt_bËs
[
ıu
];

323 
__asm__
 
	`__vŞ©e__
 ( "lidˆ%0" : "=m" (
idt_lßd
) );

324 
	}
}

326 
	$¡¬t_£cÚd¬y
(*
unu£d
)

332 
ıu
 = 
boÙšg_ıu
;

334 
	`£t_´oûssÜ_id
(
ıu
);

335 
	`£t_cu¼’t
(
idË_vıu
[
ıu
]);

336 
	`this_ıu
(
cu¼_vıu
èğ
idË_vıu
[
ıu
];

337 iàĞ
ıu_has_eãr
 )

338 
	`rdm¤l
(
MSR_EFER
, 
	`this_ıu
(
eãr
));

339 
asm
 vŞ©Ğ"mov %%ü4,%0" : "ô" (
	`this_ıu
(
ü4
)) );

357 
	`¥š_debug_di§bË
();

359 
	`³rıu_Œ­s_š™
();

361 
	`ıu_š™
();

363 
	`smp_ÿÎš
();

369 
	`cÚ¡ruù_³rıu_idt
(
ıu
);

371 
	`£tup_£cÚd¬y_APIC_şock
();

377 
	`æush_b_loÿl
();

380 
	`¥š_debug_’abË
();

381 
	`£t_ıu_siblšg_m­
(
ıu
);

382 
	`nÙify_ıu_¡¬tšg
(
ıu
);

383 
	`wmb
();

390 
	`lock_veùÜ_lock
();

391 
	`__£tup_veùÜ_œq
(
ıu
);

392 
	`ıu_£t
(
ıu
, 
ıu_Úlše_m­
);

393 
	`uÆock_veùÜ_lock
();

395 
	`š™_³rıu_time
();

398 
	`loÿl_œq_’abË
();

399 
	`mŒr_­_š™
();

401 
	`miüocode_»sume_ıu
(
ıu
);

403 
	`wmb
();

404 
	`¡¬tup_ıu_idË_loİ
();

405 
	}
}

408 * 
e¥
;

409 
ss
;

410 } 
¡ack_¡¬t
;

412 
u32
 
	gıu_2_logiÿl_­icid
[
NR_CPUS
] 
	g__»ad_mo¡ly
 =

413 { [0 ... 
NR_CPUS
-1] = 
BAD_APICID
 };

415 
	$m­_ıu_to_logiÿl_­icid
()

417 
ıu
 = 
	`smp_´oûssÜ_id
();

418 
­icid
 = 
	`logiÿl_smp_´oûssÜ_id
();

420 
ıu_2_logiÿl_­icid
[
ıu
] = 
­icid
;

421 
	}
}

423 
	$unm­_ıu_to_logiÿl_­icid
(
ıu
)

425 
ıu_2_logiÿl_­icid
[
ıu
] = 
BAD_APICID
;

426 
	}
}

428 
	$wakeup_£cÚd¬y_ıu
(
phys_­icid
, 
¡¬t_e
)

430 
£nd_¡©us
 = 0, 
acû±_¡©us
 = 0;

431 
maxlvt
, 
timeout
, 
num_¡¬ts
, 
i
;

436 iàĞ
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
phys_­icid
]) )

438 
	`­ic_»ad_¬ound
(
APIC_SPIV
);

439 
	`­ic_wr™e
(
APIC_ESR
, 0);

440 
	`­ic_»ad
(
APIC_ESR
);

443 
	`D´štk
("Asserting INIT.\n");

448 
	`­ic_iü_wr™e
(
APIC_INT_LEVELTRIG
 | 
APIC_INT_ASSERT
 | 
APIC_DM_INIT
,

449 
phys_­icid
);

451 
	`D´štk
("Waiting for sendo finish...\n");

452 
timeout
 = 0;

454 
	`D´štk
("+");

455 
	`ud–ay
(100);

456 iàĞ!
x2­ic_’abËd
 )

457 
£nd_¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
;

458 }  
£nd_¡©us
 && (
timeout
++ < 1000) );

460 
	`md–ay
(10);

462 
	`D´štk
("Deasserting INIT.\n");

464 
	`­ic_iü_wr™e
(
APIC_INT_LEVELTRIG
 | 
APIC_DM_INIT
, 
phys_­icid
);

466 
	`D´štk
("Waiting for sendo finish...\n");

467 
timeout
 = 0;

469 
	`D´štk
("+");

470 
	`ud–ay
(100);

471 iàĞ!
x2­ic_’abËd
 )

472 
£nd_¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
;

473 }  
£nd_¡©us
 && (
timeout
++ < 1000) );

481 
num_¡¬ts
 = 
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
phys_­icid
]) ? 2 : 0;

484 
	`D´štk
("#¡¬tu°loİs: %d.\n", 
num_¡¬ts
);

486 
maxlvt
 = 
	`g‘_maxlvt
();

488  
i
 = 0; i < 
num_¡¬ts
; i++ )

490 
	`D´štk
("S’dšg STARTUP #%d.\n", 
i
+1);

491 
	`­ic_»ad_¬ound
(
APIC_SPIV
);

492 
	`­ic_wr™e
(
APIC_ESR
, 0);

493 
	`­ic_»ad
(
APIC_ESR
);

494 
	`D´štk
("After‡pic_write.\n");

500 
	`­ic_iü_wr™e
(
APIC_DM_STARTUP
 | (
¡¬t_e
 >> 12), 
phys_­icid
);

503 
	`ud–ay
(300);

505 
	`D´štk
("Startup…oint 1.\n");

507 
	`D´štk
("Waiting for sendo finish...\n");

508 
timeout
 = 0;

510 
	`D´štk
("+");

511 
	`ud–ay
(100);

512 iàĞ!
x2­ic_’abËd
 )

513 
£nd_¡©us
 = 
	`­ic_»ad
(
APIC_ICR
è& 
APIC_ICR_BUSY
;

514 }  
£nd_¡©us
 && (
timeout
++ < 1000) );

517 
	`ud–ay
(200);

520 iàĞ
maxlvt
 > 3 )

522 
	`­ic_»ad_¬ound
(
APIC_SPIV
);

523 
	`­ic_wr™e
(
APIC_ESR
, 0);

525 
acû±_¡©us
 = (
	`­ic_»ad
(
APIC_ESR
) & 0xEF);

526 iàĞ
£nd_¡©us
 || 
acû±_¡©us
 )

529 
	`D´štk
("After Startup.\n");

531 iàĞ
£nd_¡©us
 )

532 
	`´štk
("APIC‚ever delivered???\n");

533 iàĞ
acû±_¡©us
 )

534 
	`´štk
("APIC d–iv”yƒ¼Ü (%lx).\n", 
acû±_¡©us
);

536  (
£nd_¡©us
 | 
acû±_¡©us
);

537 
	}
}

539 
	$®loc_ıu_id
()

541 
ıumask_t
 
tmp_m­
;

542 
ıu
;

543 
	`ıus_com¶em’t
(
tmp_m­
, 
ıu_´e£Á_m­
);

544 
ıu
 = 
	`fœ¡_ıu
(
tmp_m­
);

545  (
ıu
 < 
NR_CPUS
è? cpu : -
ENODEV
;

546 
	}
}

548 
	$do_boÙ_ıu
(
­icid
, 
ıu
)

550 
boÙ_”rÜ
;

551 
timeout
, 
rc
 = 0;

552 
¡¬t_e
;

558 
	`mŒr_§ve_¡©e
();

560 
boÙšg_ıu
 = 
ıu
;

563 
¡¬t_e
 = 
	`£tup_ŒampŞše
();

566 iàĞ
İt_ıu_šfo
 )

567 
	`´štk
("Booting…rocessor %d/%dƒip %lx\n",

568 
ıu
, 
­icid
, 
¡¬t_e
);

570 
¡ack_¡¬t
.
e¥
 = 
¡ack_ba£
[
ıu
];

574 
	`£t_ıu_¡©e
(
CPU_STATE_INIT
);

576 
	`D´štk
("Setting warm„eset code‡nd vector.\n");

578 
	`smpboÙ_£tup_w¬m_»£t_veùÜ
(
¡¬t_e
);

581 
boÙ_”rÜ
 = 
	`wakeup_£cÚd¬y_ıu
(
­icid
, 
¡¬t_e
);

583 iàĞ!
boÙ_”rÜ
 )

586 
	`£t_ıu_¡©e
(
CPU_STATE_CALLOUT
);

587 
	`D´štk
("Aá” C®louˆ%d.\n", 
ıu
);

590  
timeout
 = 0;imeout < 50000;imeout++ )

592 iàĞ
ıu_¡©e
 !ğ
CPU_STATE_CALLOUT
 )

594 
	`ud–ay
(100);

597 iàĞ
ıu_¡©e
 =ğ
CPU_STATE_CALLIN
 )

600 
	`D´štk
("OK.\n");

601 
	`´št_ıu_šfo
(
ıu
);

602 
	`synchrÚize_tsc_ma¡”
(
ıu
);

603 
	`D´štk
("CPU has booted.\n");

605 iàĞ
ıu_¡©e
 =ğ
CPU_STATE_DEAD
 )

607 
	`rmb
();

608 
rc
 = 
ıu_”rÜ
;

612 
boÙ_”rÜ
 = 1;

613 
	`mb
();

614 iàĞ
	`boÙsym
(
ŒampŞše_ıu_¡¬‹d
) == 0xA5 )

616 
	`´štk
("Stuck ??\n");

619 
	`´štk
("Not„esponding.\n");

623 iàĞ
boÙ_”rÜ
 )

625 
	`ıu_ex™_ş—r
(
ıu
);

626 
rc
 = -
EIO
;

630 
	`boÙsym
(
ŒampŞše_ıu_¡¬‹d
) = 0;

631 
	`mb
();

633 
	`smpboÙ_»¡Üe_w¬m_»£t_veùÜ
();

635  
rc
;

636 
	}
}

638 
	$ıu_ex™_ş—r
(
ıu
)

640 
	`ıu_unš™
(
ıu
);

641 
	`unm­_ıu_to_logiÿl_­icid
(
ıu
);

642 
	`£t_ıu_¡©e
(
CPU_STATE_DEAD
);

643 
	}
}

645 
	$ıu_smpboÙ_ä“
(
ıu
)

647 
Üd”
;

649 
	`xä“
(
idt_bËs
[
ıu
]);

650 
idt_bËs
[
ıu
] = 
NULL
;

652 
Üd”
 = 
	`g‘_Üd”_äom_·ges
(
NR_RESERVED_GDT_PAGES
);

653 #ifdeà
__x86_64__


654 iàĞ
	`³r_ıu
(
com·t_gdt_bË
, 
ıu
) )

655 
	`ä“_domh—p_·ges
(
	`vœt_to_·ge
(
	`³r_ıu
(
gdt_bË
, 
ıu
)), 
Üd”
);

656 iàĞ
	`³r_ıu
(
gdt_bË
, 
ıu
) )

657 
	`ä“_domh—p_·ges
(
	`vœt_to_·ge
(
	`³r_ıu
(
com·t_gdt_bË
, 
ıu
)),

658 
Üd”
);

659 
	`³r_ıu
(
com·t_gdt_bË
, 
ıu
èğ
NULL
;

661 
	`ä“_x’h—p_·ges
(
	`³r_ıu
(
gdt_bË
, 
ıu
), 
Üd”
);

663 
	`³r_ıu
(
gdt_bË
, 
ıu
èğ
NULL
;

665 iàĞ
¡ack_ba£
[
ıu
] !ğ
NULL
 )

667 
	`memgu¬d_ungu¬d_¡ack
(
¡ack_ba£
[
ıu
]);

668 
	`ä“_x’h—p_·ges
(
¡ack_ba£
[
ıu
], 
STACK_ORDER
);

669 
¡ack_ba£
[
ıu
] = 
NULL
;

671 
	}
}

673 
	$ıu_smpboÙ_®loc
(
ıu
)

675 
Üd”
;

676 
desc_¡ruù
 *
gdt
;

677 #ifdeà
__x86_64__


678 
·ge_šfo
 *
·ge
;

681 
¡ack_ba£
[
ıu
] = 
	`®loc_x’h—p_·ges
(
STACK_ORDER
, 0);

682 iàĞ
¡ack_ba£
[
ıu
] =ğ
NULL
 )

683 
oom
;

684 
	`memgu¬d_gu¬d_¡ack
(
¡ack_ba£
[
ıu
]);

686 
Üd”
 = 
	`g‘_Üd”_äom_·ges
(
NR_RESERVED_GDT_PAGES
);

687 #ifdeà
__x86_64__


688 
·ge
 = 
	`®loc_domh—p_·ges
(
NULL
, 
Üd”
,

689 
	`MEMF_node
(
	`ıu_to_node
(
ıu
)));

690 iàĞ!
·ge
 )

691 
oom
;

692 
	`³r_ıu
(
com·t_gdt_bË
, 
ıu
èğ
gdt
 = 
	`·ge_to_vœt
(
·ge
);

693 
	`memıy
(
gdt
, 
boÙ_ıu_com·t_gdt_bË
,

694 
NR_RESERVED_GDT_PAGES
 * 
PAGE_SIZE
);

695 
gdt
[
PER_CPU_GDT_ENTRY
 - 
FIRST_RESERVED_GDT_ENTRY
].
a
 = 
ıu
;

696 
·ge
 = 
	`®loc_domh—p_·ges
(
NULL
, 
Üd”
,

697 
	`MEMF_node
(
	`ıu_to_node
(
ıu
)));

698 iàĞ!
·ge
 )

699 
oom
;

700 
	`³r_ıu
(
gdt_bË
, 
ıu
èğ
gdt
 = 
	`·ge_to_vœt
(
·ge
);

702 
	`³r_ıu
(
gdt_bË
, 
ıu
èğ
gdt
 = 
	`®loc_x’h—p_·ges
(
Üd”
, 0);

703 iàĞ!
gdt
 )

704 
oom
;

706 
	`memıy
(
gdt
, 
boÙ_ıu_gdt_bË
,

707 
NR_RESERVED_GDT_PAGES
 * 
PAGE_SIZE
);

708 
	`BUILD_BUG_ON
(
NR_CPUS
 > 0x10000);

709 
gdt
[
PER_CPU_GDT_ENTRY
 - 
FIRST_RESERVED_GDT_ENTRY
].
a
 = 
ıu
;

711 
idt_bËs
[
ıu
] = 
	`xm®loc_¬¿y
(
idt_’Œy_t
, 
IDT_ENTRIES
);

712 iàĞ
idt_bËs
[
ıu
] =ğ
NULL
 )

713 
oom
;

714 
	`memıy
(
idt_bËs
[
ıu
], 
idt_bË
,

715 
IDT_ENTRIES
*(
idt_’Œy_t
));

719 
oom
:

720 
	`ıu_smpboÙ_ä“
(
ıu
);

721  -
ENOMEM
;

722 
	}
}

724 
	$ıu_smpboÙ_ÿÎback
(

725 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

727 
ıu
 = ()
hıu
;

728 
rc
 = 0;

730  
aùiÚ
 )

732 
CPU_UP_PREPARE
:

733 
rc
 = 
	`ıu_smpboÙ_®loc
(
ıu
);

735 
CPU_UP_CANCELED
:

736 
CPU_DEAD
:

737 
	`ıu_smpboÙ_ä“
(
ıu
);

743  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

744 
	}
}

746 
nÙif›r_block
 
	gıu_smpboÙ_nfb
 = {

747 .
nÙif›r_ÿÎ
 = 
ıu_smpboÙ_ÿÎback


750 
__š™
 
	$smp_´•¬e_ıus
(
max_ıus
)

752 
	`»gi¡”_ıu_nÙif›r
(&
ıu_smpboÙ_nfb
);

754 
	`mŒr_­s_sync_begš
();

757 
	`smp_¡Üe_ıu_šfo
(0);

758 
	`´št_ıu_šfo
(0);

760 
boÙ_ıu_physiÿl_­icid
 = 
	`g‘_­ic_id
();

761 
x86_ıu_to_­icid
[0] = 
boÙ_ıu_physiÿl_­icid
;

763 
¡ack_ba£
[0] = 
¡ack_¡¬t
.
e¥
;

765 
	`£t_ıu_siblšg_m­
(0);

771 iàĞ!
smp_found_cÚfig
 && !
aıi_Ïpic
 )

773 
	`´štk
(
KERN_NOTICE
 "SMP motherboard‚ot detected.\n");

774 
š™_unroûssÜ
:

775 
phys_ıu_´e£Á_m­
 = 
	`physid_mask_of_physid
(0);

776 ià(
	`APIC_š™_unroûssÜ
())

777 
	`´štk
(
KERN_NOTICE
 "Local APIC‚ot detected."

779 
	`m­_ıu_to_logiÿl_­icid
();

780 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_siblšg_m­
, 0));

781 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_cÜe_m­
, 0));

790 iàĞ!
	`check_phys_­icid_´e£Á
(
boÙ_ıu_physiÿl_­icid
) )

792 
	`´štk
("weird, boot CPU (#%d)‚ot†isted byhe BIOS.\n",

793 
boÙ_ıu_physiÿl_­icid
);

794 
	`physid_£t
(
	`h¬d_smp_´oûssÜ_id
(), 
phys_ıu_´e£Á_m­
);

798 iàĞ
	`APIC_INTEGRATED
(
­ic_v”siÚ
[
boÙ_ıu_physiÿl_­icid
])

799 && !
ıu_has_­ic
 )

801 
	`´štk
(
KERN_ERR
 "BIOS bug,†ocal APIC #%d‚ot detected!...\n",

802 
boÙ_ıu_physiÿl_­icid
);

803 
š™_unroûssÜ
;

806 
	`v”ify_loÿl_APIC
();

808 
	`cÚÃù_b¥_APIC
();

809 
	`£tup_loÿl_APIC
();

810 
	`m­_ıu_to_logiÿl_­icid
();

816 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_siblšg_m­
, 0));

817 
	`ıu_£t
(0, 
	`³r_ıu
(
ıu_cÜe_m­
, 0));

819 
	`smpboÙ_£tup_io_­ic
();

821 
	`£tup_boÙ_APIC_şock
();

822 
	}
}

824 
__š™
 
	$smp_´•¬e_boÙ_ıu
()

826 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
ıu_Úlše_m­
);

827 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
ıu_´e£Á_m­
);

828 
	}
}

831 
	$»move_siblšgšfo
(
ıu
)

833 
siblšg
;

834 
ıušfo_x86
 *
c
 = 
ıu_d©a
;

836 
	`fÜ_—ch_ıu_mask
 ( 
siblšg
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
) )

838 
	`ıu_ş—r
(
ıu
, 
	`³r_ıu
(
ıu_cÜe_m­
, 
siblšg
));

840 iàĞ
	`ıus_weight
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
)) == 1 )

841 
c
[
siblšg
].
boÙed_cÜes
--;

844 
	`fÜ_—ch_ıu_mask
(
siblšg
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
))

845 
	`ıu_ş—r
(
ıu
, 
	`³r_ıu
(
ıu_siblšg_m­
, 
siblšg
));

846 
	`ıus_ş—r
(
	`³r_ıu
(
ıu_siblšg_m­
, 
ıu
));

847 
	`ıus_ş—r
(
	`³r_ıu
(
ıu_cÜe_m­
, 
ıu
));

848 
phys_´oc_id
[
ıu
] = 
BAD_APICID
;

849 
ıu_cÜe_id
[
ıu
] = 
BAD_APICID
;

850 
	`ıu_ş—r
(
ıu
, 
ıu_siblšg_£tup_m­
);

851 
	}
}

853 
	$__ıu_di§bË
()

855 
	`fixup_œqs
();

856 
ıu
 = 
	`smp_´oûssÜ_id
();

858 
	`£t_ıu_¡©e
(
CPU_STATE_DYING
);

860 
	`loÿl_œq_di§bË
();

861 
	`ş—r_loÿl_APIC
();

863 
	`loÿl_œq_’abË
();

864 
	`md–ay
(1);

865 
	`loÿl_œq_di§bË
();

867 
	`time_su¥’d
();

869 
	`»move_siblšgšfo
(
ıu
);

872 
	`ıu_ş—r
(
ıu
, 
ıupoŞ0
->
ıu_v®id
);

873 
	`ıu_ş—r
(
ıu
, 
ıu_Úlše_m­
);

874 
	`fixup_œqs
();

876 iàĞ
	`ıu_di§bË_scheduËr
(
ıu
) )

877 
	`BUG
();

878 
	}
}

880 
	$__ıu_d›
(
ıu
)

883 
i
 = 0;

884 
ıu_¡©e
 
£’_¡©e
;

886  (
£’_¡©e
 = 
ıu_¡©e
è!ğ
CPU_STATE_DEAD
 )

888 
	`BUG_ON
(
£’_¡©e
 !ğ
CPU_STATE_DYING
);

889 
	`md–ay
(100);

890 
	`ıu_»Ïx
();

891 
	`´oûss_³ndšg_soáœqs
();

892 iàĞ(++
i
 % 10) == 0 )

893 
	`´štk
(
KERN_ERR
 "CPU %u stÈnÙ d—d...\n", 
ıu
);

895 
	}
}

897 
	$ıu_add
(
ušt32_t
 
­ic_id
, ušt32_ˆ
aıi_id
, ušt32_ˆ
pxm
)

899 
node
, 
ıu
 = -1;

901 
	`d´štk
(
XENLOG_DEBUG
, "cpu_add‡pic_id %x‡cpi_id %x…xm %x\n",

902 
­ic_id
, 
aıi_id
, 
pxm
);

904 iàĞ
aıi_id
 > 
MAX_MADT_ENTRIES
 || 
­ic_id
 > 
MAX_APICS
 || 
pxm
 > 256 )

905  -
EINVAL
;

907 iàĞ!
	`ıu_hÙ¶ug_begš
() )

908  -
EBUSY
;

911 iàĞ
x86_aıiid_to_­icid
[
aıi_id
] !ğ
BAD_APICID
 )

913 
ıu
 = (
x86_aıiid_to_­icid
[
aıi_id
] !ğ
­ic_id
)

914 ? -
EINVAL
 : -
EEXIST
;

915 
out
;

918 iàĞ
	`physid_is£t
(
­ic_id
, 
phys_ıu_´e£Á_m­
) )

920 
ıu
 = -
EEXIST
;

921 
out
;

924 iàĞ(
ıu
 = 
	`mp_»gi¡”_Ïpic
(
­ic_id
, 1)) < 0 )

925 
out
;

927 
x86_aıiid_to_­icid
[
aıi_id
] = 
­ic_id
;

929 iàĞ!
	`¤©_di§bËd
() )

931 iàĞ(
node
 = 
	`£tup_node
(
pxm
)) < 0 )

933 
	`d´štk
(
XENLOG_WARNING
,

934 "S‘u°nodçed fÜ…xm %x\n", 
pxm
);

935 
x86_aıiid_to_­icid
[
aıi_id
] = 
BAD_APICID
;

936 
	`mp_uÄegi¡”_Ïpic
(
­ic_id
, 
ıu
);

937 
ıu
 = 
node
;

938 
out
;

940 
­icid_to_node
[
­ic_id
] = 
node
;

944 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) )

946 
boŞ_t
 
Úû_Úly
;

947 iàĞ!
	`‹¡_ªd_£t_boŞ
(
Úû_Úly
) )

948 
	`´štk
(
XENLOG_WARNING


952 "which fÜû TSCƒmuÏtiÚ wh”­´İrŸ‹.\n", 
ıu
);

953 
	`ıu_£t
(
ıu
, 
tsc_sync_ıu_mask
);

956 
	`¤©_d‘eù_node
(
ıu
);

957 
	`numa_add_ıu
(
ıu
);

958 
	`d´štk
(
XENLOG_INFO
, "Add CPU %x w™h index %x\n", 
­ic_id
, 
ıu
);

959 
out
:

960 
	`ıu_hÙ¶ug_dÚe
();

961  
ıu
;

962 
	}
}

965 
	$__ıu_up
(
ıu
)

967 
­icid
, 
»t
;

969 iàĞ(
­icid
 = 
x86_ıu_to_­icid
[
ıu
]è=ğ
BAD_APICID
 )

970  -
ENODEV
;

972 #ifdeà
ENABLE_ASYMMETRIC_CACHE


973 ià(
­icid
 >= 3)

977 iàĞ(
»t
 = 
	`do_boÙ_ıu
(
­icid
, 
ıu
)) != 0 )

978  
»t
;

980 
	`£t_ıu_¡©e
(
CPU_STATE_ONLINE
);

981  !
	`ıu_is£t
(
ıu
, 
ıu_Úlše_m­
) )

983 
	`ıu_»Ïx
();

984 
	`´oûss_³ndšg_soáœqs
();

988 
	}
}

991 
__š™
 
	$smp_ıus_dÚe
(
max_ıus
)

993 iàĞ
smp_b_¡•pšg
 )

994 
	`´štk
(
KERN_WARNING
 "WARNING: SMP operation may be "

1001 iàĞ
š‹d
 & 
TAINT_UNSAFE_SMP
 )

1003 iàĞ
	`num_Úlše_ıus
() > 1 )

1004 
	`´štk
(
KERN_INFO
 "WARNING: This combination of AMD "

1007 
š‹d
 &ğ~
TAINT_UNSAFE_SMP
;

1010 iàĞ
nmi_w©chdog
 =ğ
NMI_LOCAL_APIC
 )

1011 
	`check_nmi_w©chdog
();

1013 
	`£tup_ißpic_de¡
();

1015 
	`mŒr_§ve_¡©e
();

1016 
	`mŒr_­s_sync_’d
();

1017 
	}
}

1019 
__š™
 
	$smp_šŒ_š™
()

1021 
œq
, 
£ridx
, 
ıu
 = 
	`smp_´oûssÜ_id
();

1027 
œq_veùÜ
[0] = 
FIRST_HIPRIORITY_VECTOR
;

1033  
£ridx
 = 0; seridx < 2; seridx++ )

1035 iàĞ(
œq
 = 
	`£rŸl_œq
(
£ridx
)) < 0 )

1037 
œq_veùÜ
[
œq
] = 
FIRST_HIPRIORITY_VECTOR
 + 
£ridx
 + 1;

1038 
	`³r_ıu
(
veùÜ_œq
, 
ıu
)[
FIRST_HIPRIORITY_VECTOR
 + 
£ridx
 + 1] = 
œq
;

1039 
œq_cfg
[
œq
].
veùÜ
 = 
FIRST_HIPRIORITY_VECTOR
 + 
£ridx
 + 1;

1040 
œq_cfg
[
œq
].
ıu_mask
 = 
ıu_Úlše_m­
;

1044 
	`£t_šŒ_g©e
(
IRQ_MOVE_CLEANUP_VECTOR
, 
œq_move_ş—nup_š‹¼u±
);

1047 
	`£t_šŒ_g©e
(
EVENT_CHECK_VECTOR
, 
ev’t_check_š‹¼u±
);

1050 
	`£t_šŒ_g©e
(
INVALIDATE_TLB_VECTOR
, 
šv®id©e_š‹¼u±
);

1053 
	`£t_šŒ_g©e
(
CALL_FUNCTION_VECTOR
, 
ÿÎ_funùiÚ_š‹¼u±
);

1054 
	}
}

	@srat.c

14 
	~<x’/š™.h
>

15 
	~<x’/mm.h
>

16 
	~<x’/š‰y³s.h
>

17 
	~<x’/nodemask.h
>

18 
	~<x’/aıi.h
>

19 
	~<x’/numa.h
>

20 
	~<asm/e820.h
>

21 
	~<asm/·ge.h
>

23 
aıi_bË_¦™
 *
__»ad_mo¡ly
 
	gaıi_¦™
;

25 
nodemask_t
 
nodes_·r£d
 
	g__š™d©a
;

26 
nodemask_t
 
nodes_found
 
	g__š™d©a
;

27 
node
 
	gnodes
[
MAX_NUMNODES
] 
	g__š™d©a
;

28 
u8
 
__»ad_mo¡ly
 
	gpxm2node
[256] = { [0 ... 255] = 
NUMA_NO_NODE
 };

31 
	gnum_node_memblks
;

32 
node
 
	gnode_memblk_¿nge
[
NR_NODE_MEMBLKS
];

33 
	gmemblk_nodeid
[
NR_NODE_MEMBLKS
];

37 
	#NODE_MIN_SIZE
 (4*1024*1024)

	)

39 
node_to_pxm
(
n
);

41 
	$pxm_to_node
(
pxm
)

43 ià(()
pxm
 >= 256)

46  (sigÃd )
pxm2node
[
pxm
];

47 
	}
}

49 
__devš™
 
	$£tup_node
(
pxm
)

51 
node
 = 
pxm2node
[
pxm
];

52 ià(
node
 == 0xff) {

53 ià(
	`nodes_weight
(
nodes_found
è>ğ
MAX_NUMNODES
)

55 
node
 = 
	`fœ¡_un£t_node
(
nodes_found
);

56 
	`node_£t
(
node
, 
nodes_found
);

57 
pxm2node
[
pxm
] = 
node
;

59  
pxm2node
[
pxm
];

60 
	}
}

62 
	$v®id_numa_¿nge
(
u64
 
¡¬t
, u64 
’d
, 
node
)

64 
i
;

66 
i
 = 0; i < 
num_node_memblks
; i++) {

67 
node
 *
nd
 = &
node_memblk_¿nge
[
i
];

69 ià(
nd
->
¡¬t
 <ğ¡¬ˆ&&‚d->
’d
 >ƒnd &&

70 
memblk_nodeid
[
i
] =ğ
node
 )

75 
	}
}

77 
__š™
 
	$cÚæiùšg_memblks
(
u64
 
¡¬t
, u64 
’d
)

79 
i
;

81 
i
 = 0; i < 
num_node_memblks
; i++) {

82 
node
 *
nd
 = &
node_memblk_¿nge
[
i
];

83 ià(
nd
->
¡¬t
 =ğnd->
’d
)

85 ià(
nd
->
’d
 > 
¡¬t
 &&‚d->start <ƒnd)

86  
memblk_nodeid
[
i
];

87 ià(
nd
->
’d
 =ğ’d &&‚d->
¡¬t
 == start)

88  
memblk_nodeid
[
i
];

91 
	}
}

93 
__š™
 
	$cutoff_node
(
i
, 
u64
 
¡¬t
, u64 
’d
)

95 
node
 *
nd
 = &
nodes
[
i
];

96 ià(
nd
->
¡¬t
 < start) {

97 
nd
->
¡¬t
 = start;

98 ià(
nd
->
’d
 <‚d->
¡¬t
)

99 
nd
->
¡¬t
 =‚d->
’d
;

101 ià(
nd
->
’d
 >ƒnd) {

102 
nd
->
’d
 =ƒnd;

103 ià(
nd
->
¡¬t
 >‚d->
’d
)

104 
nd
->
¡¬t
 =‚d->
’d
;

106 
	}
}

108 
__š™
 
	$bad_¤©
()

110 
i
;

111 
	`´štk
(
KERN_ERR
 "SRAT: SRAT‚ot used.\n");

112 
aıi_numa
 = -1;

113 
i
 = 0; i < 
MAX_LOCAL_APIC
; i++)

114 
­icid_to_node
[
i
] = 
NUMA_NO_NODE
;

115 
i
 = 0; i < 
	`ARRAY_SIZE
(
pxm2node
); i++)

116 
pxm2node
[
i
] = 
NUMA_NO_NODE
;

117 
	}
}

119 #ifdeà
CONFIG_X86_64


126 
__š™
 
	$¦™_v®id
(
aıi_bË_¦™
 *
¦™
)

128 
i
, 
j
;

129 
d
 = 
¦™
->
loÿl™y_couÁ
;

130 
i
 = 0; i < 
d
; i++) {

131 
j
 = 0; j < 
d
; j++) {

132 
u8
 
v®
 = 
¦™
->
’Œy
[
d
*
i
 + 
j
];

133 ià(
i
 =ğ
j
) {

134 ià(
v®
 != 10)

136 } ià(
v®
 <= 10)

141 
	}
}

144 
__š™
 
	$aıi_numa_¦™_š™
(
aıi_bË_¦™
 *
¦™
)

146 
mâ
;

147 ià(!
	`¦™_v®id
(
¦™
)) {

148 
	`´štk
(
KERN_INFO
 "ACPI: SLITable†ooks invalid. "

152 
mâ
 = 
	`®loc_boÙ_·ges
(
	`PFN_UP
(
¦™
->
h—d”
.
Ëngth
), 1);

153 ià(!
mâ
) {

154 
	`´štk
(
KERN_ERR
 "ACPI: Unableo‡llocate memory for "

158 
aıi_¦™
 = 
	`mâ_to_vœt
(
mâ
);

159 
	`memıy
(
aıi_¦™
, 
¦™
, sl™->
h—d”
.
Ëngth
);

160 
	}
}

162 
__š™
 
	$aıi_numa_¦™_š™
(
aıi_bË_¦™
 *
¦™
)

164 
	}
}

168 
__š™


169 
	$aıi_numa_x2­ic_affš™y_š™
(
aıi_¤©_x2­ic_ıu_affš™y
 *
·
)

171 
pxm
, 
node
;

172 
­ic_id
;

174 ià(
	`¤©_di§bËd
())

176 ià(
·
->
h—d”
.
Ëngth
 < (
aıi_¤©_x2­ic_ıu_affš™y
)) {

177 
	`bad_¤©
();

180 ià((
·
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
) == 0)

182 
pxm
 = 
·
->
´oxim™y_domaš
;

183 
node
 = 
	`£tup_node
(
pxm
);

184 ià(
node
 < 0) {

185 
	`´štk
(
KERN_ERR
 "SRAT: ToØmªy…roxim™y domaš %x\n", 
pxm
);

186 
	`bad_¤©
();

190 
­ic_id
 = 
·
->apic_id;

191 
­icid_to_node
[
­ic_id
] = 
node
;

192 
aıi_numa
 = 1;

193 
	`´štk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

194 
pxm
, 
­ic_id
, 
node
);

195 
	}
}

198 
__š™


199 
	$aıi_numa_´oûssÜ_affš™y_š™
(
aıi_¤©_ıu_affš™y
 *
·
)

201 
pxm
, 
node
;

202 ià(
	`¤©_di§bËd
())

204 ià(
·
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_ıu_affš™y
)) {

205 
	`bad_¤©
();

208 ià(!(
·
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
))

210 
pxm
 = 
·
->
´oxim™y_domaš_lo
;

211 ià(
¤©_»v
 >= 2) {

212 
pxm
 |ğ
·
->
´oxim™y_domaš_hi
[0] << 8;

213 
pxm
 |ğ
·
->
´oxim™y_domaš_hi
[1] << 16;

214 
pxm
 |ğ
·
->
´oxim™y_domaš_hi
[2] << 24;

216 
node
 = 
	`£tup_node
(
pxm
);

217 ià(
node
 < 0) {

218 
	`´štk
(
KERN_ERR
 "SRAT: ToØmªy…roxim™y domaš %x\n", 
pxm
);

219 
	`bad_¤©
();

222 
­icid_to_node
[
·
->
­ic_id
] = 
node
;

223 
aıi_numa
 = 1;

224 
	`´štk
(
KERN_INFO
 "SRAT: PXM %u -> APIC %u -> Node %u\n",

225 
pxm
, 
·
->
­ic_id
, 
node
);

226 
	}
}

229 
__š™


230 
	$aıi_numa_memÜy_affš™y_š™
(
aıi_¤©_mem_affš™y
 *
ma
)

232 
node
 *
nd
;

233 
u64
 
¡¬t
, 
’d
;

234 
node
, 
pxm
;

235 
i
;

237 ià(
	`¤©_di§bËd
())

239 ià(
ma
->
h—d”
.
Ëngth
 !ğ(
aıi_¤©_mem_affš™y
)) {

240 
	`bad_¤©
();

243 ià(!(
ma
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
))

246 ià(
num_node_memblks
 >ğ
NR_NODE_MEMBLKS
)

248 
	`d´štk
(
XENLOG_WARNING
,

250 
	`bad_¤©
();

254 
¡¬t
 = 
ma
->
ba£_add»ss
;

255 
’d
 = 
¡¬t
 + 
ma
->
Ëngth
;

256 
pxm
 = 
ma
->
´oxim™y_domaš
;

257 ià(
¤©_»v
 < 2)

258 
pxm
 &= 0xff;

259 
node
 = 
	`£tup_node
(
pxm
);

260 ià(
node
 < 0) {

261 
	`´štk
(
KERN_ERR
 "SRAT: Too many…roximity domains.\n");

262 
	`bad_¤©
();

266 ià(
ma
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
)

268 
	`´štk
(
KERN_INFO
 "SRAT: hÙ…lug zÚfound %"
PRIx64
" - %"PRIx64" \n",

269 
¡¬t
, 
’d
);

270 #ifdeà
CONFIG_X86_64


271 
mem_hÙ¶ug
 = 1;

275 
i
 = 
	`cÚæiùšg_memblks
(
¡¬t
, 
’d
);

276 ià(
i
 =ğ
node
) {

277 
	`´štk
(
KERN_WARNING


278 "SRAT: W¬nšg: PXM %d (%"
PRIx64
"-%"PRIx64") overlaps with itself (%"

279 
PRIx64
"-%"PRIx64")\n", 
pxm
, 
¡¬t
, 
’d
, 
nodes
[
i
].start,‚odes[i].end);

280 } ià(
i
 >= 0) {

281 
	`´štk
(
KERN_ERR


282 "SRAT: PXM %d (%"
PRIx64
"-%"PRIx64") overlaps with PXM %d (%"

283 
PRIx64
"-%"PRIx64")\n", 
pxm
, 
¡¬t
, 
’d
, 
	`node_to_pxm
(
i
),

284 
nodes
[
i
].
¡¬t
,‚odes[i].
’d
);

285 
	`bad_¤©
();

288 
nd
 = &
nodes
[
node
];

289 ià(!
	`node_‹¡_ªd_£t
(
node
, 
nodes_·r£d
)) {

290 
nd
->
¡¬t
 = start;

291 
nd
->
’d
 =ƒnd;

293 ià(
¡¬t
 < 
nd
->start)

294 
nd
->
¡¬t
 = start;

295 ià(
nd
->
’d
 <ƒnd)

296 
nd
->
’d
 =ƒnd;

298 
	`´štk
(
KERN_INFO
 "SRAT: Nod%u PXM %u %"
PRIx64
"-%"PRIx64"\n", 
node
, 
pxm
,

299 
¡¬t
, 
’d
);

301 
node_memblk_¿nge
[
num_node_memblks
].
¡¬t
 = start;

302 
node_memblk_¿nge
[
num_node_memblks
].
’d
 =ƒnd;

303 
memblk_nodeid
[
num_node_memblks
] = 
node
;

304 
num_node_memblks
++;

305 
	}
}

309 
	$nodes_cov”_memÜy
()

311 
i
;

313 
i
 = 0; i < 
e820
.
Ä_m­
; i++) {

314 
j
, 
found
;

315 
¡¬t
, 
’d
;

317 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
) {

321 
¡¬t
 = 
e820
.
m­
[
i
].
addr
;

322 
’d
 = 
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
 - 1;

325 
found
 = 0;

326 
	`fÜ_—ch_node_mask
(
j
, 
nodes_·r£d
)

327 ià(
¡¬t
 < 
nodes
[
j
].
’d


328 && 
’d
 > 
nodes
[
j
].
¡¬t
) {

329 ià(
¡¬t
 >ğ
nodes
[
j
].start) {

330 
¡¬t
 = 
nodes
[
j
].
’d
;

331 
found
 = 1;

333 ià(
’d
 <ğ
nodes
[
j
].end) {

334 
’d
 = 
nodes
[
j
].
¡¬t
;

335 
found
 = 1;

338 } 
found
 && 
¡¬t
 < 
’d
);

340 ià(
¡¬t
 < 
’d
) {

341 
	`´štk
(
KERN_ERR
 "SRAT: No PXM forƒ820„ange: "

342 "%016Lx - %016Lx\n", 
¡¬t
, 
’d
);

347 
	}
}

349 
__š™
 
	$aıi_numa_¬ch_fixup
(è{
	}
}

351 #ifdeà
__x86_64__


353 
u64
 
__š™d©a
 
	g¤©_»giÚ_mask
;

355 
u64
 
__š™
 
	$fl_mask
(
u64
 
mask
)

357 
mask
 & (mask + 1))

358 
mask
 |= mask + 1;

359  
mask
;

360 
	}
}

362 
__š™
 
	$¤©_·r£_»giÚ
(
aıi_subbË_h—d”
 *
h—d”
,

363 cÚ¡ 
’d
)

365 
aıi_¤©_mem_affš™y
 *
ma
;

367 ià(!
h—d”
)

368  -
EINVAL
;

370 
ma
 = 
	`cÚš”_of
(
h—d”
, 
aıi_¤©_mem_affš™y
, header);

372 ià(!
ma
->
Ëngth
 ||

373 !(
ma
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
) ||

374 (
ma
->
æags
 & 
ACPI_SRAT_MEM_NON_VOLATILE
))

377 ià(
numa_off
)

378 
	`´štk
(
KERN_INFO
 "SRAT: %013"
PRIx64
"-%013"PRIx64"\n",

379 
ma
->
ba£_add»ss
, ma->ba£_add»s + ma->
Ëngth
 - 1);

381 
¤©_»giÚ_mask
 |ğ
ma
->
ba£_add»ss
 |

382 
	`fl_mask
(
ma
->
ba£_add»ss
 ^

383 (
ma
->
ba£_add»ss
 + ma->
Ëngth
 - 1));

386 
	}
}

388 
__š™
 
	$¤©_·r£_»giÚs
(
u64
 
addr
)

390 
u64
 
mask
;

391 
i
;

393 ià(
aıi_di§bËd
 || 
aıi_numa
 < 0 ||

394 
	`aıi_bË_·r£
(
ACPI_SIG_SRAT
, 
aıi_·r£_¤©
))

397 
¤©_»giÚ_mask
 = 
	`fl_mask
(
addr
 - 1);

398 
	`aıi_bË_·r£_¤©
(
ACPI_SRAT_MEMORY_AFFINITY
, 
¤©_·r£_»giÚ
, 0);

400 
mask
 = 
¤©_»giÚ_mask
, 
i
 = 0; mask && i < 
e820
.
Ä_m­
; i++) {

401 ià(
e820
.
m­
[
i
].
ty³
 !ğ
E820_RAM
)

404 ià(~
mask
 &

405 
	`fl_mask
(
e820
.
m­
[
i
].
addr
 ^

406 (
e820
.
m­
[
i
].
addr
 +ƒ820.m­[i].
size
 - 1)))

407 
mask
 = 0;

410 
	`pâ_pdx_hŞe_£tup
(
mask
 >> 
PAGE_SHIFT
);

411 
	}
}

416 
__š™
 
	$aıi_sÿn_nodes
(
u64
 
¡¬t
, u64 
’d
)

418 
i
;

421 
i
 = 0; i < 
MAX_NUMNODES
; i++)

422 
	`cutoff_node
(
i
, 
¡¬t
, 
’d
);

424 ià(
aıi_numa
 <= 0)

427 ià(!
	`nodes_cov”_memÜy
()) {

428 
	`bad_¤©
();

432 
memnode_shiá
 = 
	`compu‹_hash_shiá
(
node_memblk_¿nge
, 
num_node_memblks
,

433 
memblk_nodeid
);

435 ià(
memnode_shiá
 < 0) {

436 
	`´štk
(
KERN_ERR


438 
	`bad_¤©
();

443 
	`fÜ_—ch_node_mask
(
i
, 
nodes_·r£d
)

445 ià((
nodes
[
i
].
’d
 -‚odes[i].
¡¬t
è< 
NODE_MIN_SIZE
)

447 
	`£tup_node_boÙmem
(
i
, 
nodes
[i].
¡¬t
,‚odes[i].
’d
);

449 
i
 = 0; i < 
NR_CPUS
; i++) {

450 ià(
ıu_to_node
[
i
] =ğ
NUMA_NO_NODE
)

452 ià(!
	`node_is£t
(
ıu_to_node
[
i
], 
nodes_·r£d
))

453 
	`numa_£t_node
(
i
, 
NUMA_NO_NODE
);

455 
	`numa_š™_¬¿y
();

457 
	}
}

459 
	$node_to_pxm
(
n
)

461 
i
;

462 ià(
pxm2node
[
n
] ==‚)

463  
n
;

464 
i
 = 0; i < 256; i++)

465 ià(
pxm2node
[
i
] =ğ
n
)

466  
i
;

468 
	}
}

470 
	$__node_di¡ªû
(
a
, 
b
)

472 
šdex
;

474 ià(!
aıi_¦™
)

475  
a
 =ğ
b
 ? 10 : 20;

476 
šdex
 = 
aıi_¦™
->
loÿl™y_couÁ
 * 
	`node_to_pxm
(
a
);

477  
aıi_¦™
->
’Œy
[
šdex
 + 
	`node_to_pxm
(
b
)];

478 
	}
}

480 
EXPORT_SYMBOL
(
__node_di¡ªû
);

	@string.c

8 
	~<x’/cÚfig.h
>

9 
	~<x’/lib.h
>

11 #undeà
memıy


12 *
	$memıy
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
n
)

14 
d0
, 
d1
, 
d2
;

16 
asm
 volatile (

17 "„• ; movs"
__OS
" ; "

20 : "=&c" (
d0
), "=&D" (
d1
), "=&S" (
d2
)

21 : "0" (
n
/
BYTES_PER_LONG
), "r" (n%BYTES_PER_LONG), "1" (
de¡
), "2" (
¤c
)

24  
de¡
;

25 
	}
}

27 #undeà
mem£t


28 *
	$mem£t
(*
s
, 
c
, 
size_t
 
n
)

30 
d0
, 
d1
;

32 
asm
 volatile (

34 : "=&c" (
d0
), "=&D" (
d1
)

35 : "a" (
c
), "1" (
s
), "0" (
n
)

38  
s
;

39 
	}
}

41 #undeà
memmove


42 *
	$memmove
(*
de¡
, cÚ¡ *
¤c
, 
size_t
 
n
)

44 
d0
, 
d1
, 
d2
;

46 iàĞ
de¡
 < 
¤c
 )

47  
	`memıy
(
de¡
, 
¤c
, 
n
);

49 
asm
 volatile (

53 : "=&c" (
d0
), "=&S" (
d1
), "=&D" (
d2
)

54 : "0" (
n
), "1" (n-1+(cÚ¡ *)
¤c
), "2" (n-1+(*)
de¡
)

57  
de¡
;

58 
	}
}

	@sysctl.c

9 
	~<x’/cÚfig.h
>

10 
	~<x’/ty³s.h
>

11 
	~<x’/lib.h
>

12 
	~<x’/mm.h
>

13 
	~<x’/gue¡_acûss.h
>

14 
	~<public/sysùl.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/ev’t.h
>

17 
	~<x’/domaš_·ge.h
>

18 
	~<asm/m¤.h
>

19 
	~<x’/Œaû.h
>

20 
	~<x’/cÚsŞe.h
>

21 
	~<x’/ioÿp.h
>

22 
	~<asm/œq.h
>

23 
	~<asm/hvm/hvm.h
>

24 
	~<asm/hvm/suµÜt.h
>

25 
	~<asm/´oûssÜ.h
>

26 
	~<asm/numa.h
>

27 
	~<x’/nodemask.h
>

28 
	~<x’/ıu.h
>

29 
	~<xsm/xsm.h
>

31 
	#g‘_x’_gue¡_hªdË
(
v®
, 
hnd
èdØ{ v® = (hnd).
p
; } 0)

	)

33 
	$ıu_up_h–³r
(*
d©a
)

35 
ıu
 = ()
d©a
;

36 
»t
 = 
	`ıu_up
(
ıu
);

37 iàĞ
»t
 =ğ-
EBUSY
 )

40 
	`rcu_b¬r›r
();

41 
»t
 = 
	`ıu_up
(
ıu
);

43  
»t
;

44 
	}
}

46 
	$ıu_down_h–³r
(*
d©a
)

48 
ıu
 = ()
d©a
;

49 
»t
 = 
	`ıu_down
(
ıu
);

50 iàĞ
»t
 =ğ-
EBUSY
 )

53 
	`rcu_b¬r›r
();

54 
»t
 = 
	`ıu_down
(
ıu
);

56  
»t
;

57 
	}
}

59 
__node_di¡ªû
(
a
, 
b
);

61 
¬ch_do_sysùl
(

62 
x’_sysùl
 *
sysùl
, 
	$XEN_GUEST_HANDLE
(
x’_sysùl_t
è
u_sysùl
)

64 
»t
 = 0;

66  
sysùl
->
cmd
 )

69 
XEN_SYSCTL_physšfo
:

71 
x’_sysùl_physšfo_t
 *
pi
 = &
sysùl
->
u
.
physšfo
;

73 
»t
 = 
	`xsm_physšfo
();

74 iàĞ
»t
 )

78 
	`mem£t
(
pi
, 0, (*pi));

79 
pi
->
th»ads_³r_cÜe
 =

80 
	`ıus_weight
(
	`³r_ıu
(
ıu_siblšg_m­
, 0));

81 
pi
->
cÜes_³r_sock‘
 =

82 
	`ıus_weight
(
	`³r_ıu
(
ıu_cÜe_m­
, 0)è/ 
pi
->
th»ads_³r_cÜe
;

83 
pi
->
Ä_ıus
 = 
	`num_Úlše_ıus
();

84 
pi
->
Ä_nodes
 = 
	`num_Úlše_nodes
();

85 
pi
->
max_node_id
 = 
MAX_NUMNODES
-1;

86 
pi
->
max_ıu_id
 = 
NR_CPUS
-1;

87 
pi
->
tÙ®_·ges
 =otal_pages;

88 
pi
->
ä“_·ges
 = 
	`ava_domh—p_·ges
();

89 
pi
->
süub_·ges
 = 0;

90 
pi
->
ıu_khz
 = cpu_khz;

91 
	`memıy
(
pi
->
hw_ÿp
, 
boÙ_ıu_d©a
.
x86_ÿ·b™y
, 
NCAPINTS
*4);

92 iàĞ
hvm_’abËd
 )

93 
pi
->
ÿ·b™›s
 |ğ
XEN_SYSCTL_PHYSCAP_hvm
;

94 iàĞ
iommu_’abËd
 )

95 
pi
->
ÿ·b™›s
 |ğ
XEN_SYSCTL_PHYSCAP_hvm_dœeùio
;

97 iàĞ
	`cİy_to_gue¡
(
u_sysùl
, 
sysùl
, 1) )

98 
»t
 = -
EFAULT
;

102 
XEN_SYSCTL_tİŞogyšfo
:

104 
ušt32_t
 
i
, 
max_ıu_šdex
, 
Ï¡_Úlše_ıu
;

105 
x’_sysùl_tİŞogyšfo_t
 *
ti
 = &
sysùl
->
u
.
tİŞogyšfo
;

107 
Ï¡_Úlše_ıu
 = 
	`Ï¡_ıu
(
ıu_Úlše_m­
);

108 
max_ıu_šdex
 = 
	`mš_t
(
ušt32_t
, 
ti
->max_ıu_šdex, 
Ï¡_Úlše_ıu
);

109 
ti
->
max_ıu_šdex
 = 
Ï¡_Úlše_ıu
;

111  
i
 = 0; i <ğ
max_ıu_šdex
; i++ )

113 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ti
->
ıu_to_cÜe
) )

115 
ušt32_t
 
cÜe
 = 
	`ıu_Úlše
(
i
è? 
	`ıu_to_cÜe
(i) : ~0u;

116 iàĞ
	`cİy_to_gue¡_off£t
(
ti
->
ıu_to_cÜe
, 
i
, &
cÜe
, 1) )

119 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ti
->
ıu_to_sock‘
) )

121 
ušt32_t
 
sock‘
 = 
	`ıu_Úlše
(
i
è? 
	`ıu_to_sock‘
(i) : ~0u;

122 iàĞ
	`cİy_to_gue¡_off£t
(
ti
->
ıu_to_sock‘
, 
i
, &
sock‘
, 1) )

125 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ti
->
ıu_to_node
) )

127 
ušt32_t
 
node
 = 
	`ıu_Úlše
(
i
è? 
	`ıu_to_node
(i) : ~0u;

128 iàĞ
	`cİy_to_gue¡_off£t
(
ti
->
ıu_to_node
, 
i
, &
node
, 1) )

133 
»t
 = ((
i
 <ğ
max_ıu_šdex
è|| 
	`cİy_to_gue¡
(
u_sysùl
, 
sysùl
, 1))

134 ? -
EFAULT
 : 0;

138 
XEN_SYSCTL_numašfo
:

140 
ušt32_t
 
i
, 
j
, 
max_node_šdex
, 
Ï¡_Úlše_node
;

141 
x’_sysùl_numašfo_t
 *
ni
 = &
sysùl
->
u
.
numašfo
;

143 
Ï¡_Úlše_node
 = 
	`Ï¡_node
(
node_Úlše_m­
);

144 
max_node_šdex
 = 
	`mš_t
(
ušt32_t
, 
ni
->max_node_šdex, 
Ï¡_Úlše_node
);

145 
ni
->
max_node_šdex
 = 
Ï¡_Úlše_node
;

147  
i
 = 0; i <ğ
max_node_šdex
; i++ )

149 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ni
->
node_to_memsize
) )

151 
ušt64_t
 
memsize
 = 
	`node_Úlše
(
i
) ?

152 
	`node_¥ªÃd_·ges
(
i
è<< 
PAGE_SHIFT
 : 0ul;

153 iàĞ
	`cİy_to_gue¡_off£t
(
ni
->
node_to_memsize
, 
i
, &
memsize
, 1) )

156 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ni
->
node_to_memä“
) )

158 
ušt64_t
 
memä“
 = 
	`node_Úlše
(
i
) ?

159 
	`ava_node_h—p_·ges
(
i
è<< 
PAGE_SHIFT
 : 0ul;

160 iàĞ
	`cİy_to_gue¡_off£t
(
ni
->
node_to_memä“
, 
i
, &
memä“
, 1) )

164 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
ni
->
node_to_node_di¡ªû
) )

166  
j
 = 0; j <ğ
max_node_šdex
; j++)

168 
ušt32_t
 
di¡ªû
 = ~0u;

169 iàĞ
	`node_Úlše
(
i
è&&‚ode_Úlše(
j
) )

170 
di¡ªû
 = 
	`__node_di¡ªû
(
i
, 
j
);

171 iàĞ
	`cİy_to_gue¡_off£t
(

172 
ni
->
node_to_node_di¡ªû
,

173 
i
*(
max_node_šdex
+1è+ 
j
, &
di¡ªû
, 1) )

176 iàĞ
j
 <ğ
max_node_šdex
 )

181 
»t
 = ((
i
 <ğ
max_node_šdex
è|| 
	`cİy_to_gue¡
(
u_sysùl
, 
sysùl
, 1))

182 ? -
EFAULT
 : 0;

186 
XEN_SYSCTL_ıu_hÙ¶ug
:

188 
ıu
 = 
sysùl
->
u
.
ıu_hÙ¶ug
.cpu;

190  
sysùl
->
u
.
ıu_hÙ¶ug
.
İ
 )

192 
XEN_SYSCTL_CPU_HOTPLUG_ONLINE
:

193 
»t
 = 
	`cÚtšue_hy³rÿÎ_Ú_ıu
(

194 0, 
ıu_up_h–³r
, (*)()
ıu
);

196 
XEN_SYSCTL_CPU_HOTPLUG_OFFLINE
:

197 
»t
 = 
	`cÚtšue_hy³rÿÎ_Ú_ıu
(

198 0, 
ıu_down_h–³r
, (*)()
ıu
);

201 
»t
 = -
EINVAL
;

208 
»t
 = -
ENOSYS
;

212  
»t
;

213 
	}
}

	@tboot.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/ty³s.h
>

4 
	~<x’/lib.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/domaš_·ge.h
>

7 
	~<x’/iommu.h
>

8 
	~<x’/aıi.h
>

9 
	~<asm/fixm­.h
>

10 
	~<asm/·ge.h
>

11 
	~<asm/´oûssÜ.h
>

12 
	~<asm/e820.h
>

13 
	~<asm/tboÙ.h
>

14 
	~<üy±o/vmac.h
>

17 
__š™d©a
 
	gİt_tboÙ
[20] = "";

18 
¡ršg_·¿m
("tboÙ", 
İt_tboÙ
);

21 
tboÙ_sh¬ed_t
 *
	gg_tboÙ_sh¬ed
;

23 
vmac_t
 
	gdomaš_mac
;

24 
vmac_t
 
	gx’h—p_mac
;

25 
vmac_t
 
	gäam‘abË_mac
;

27 cÚ¡ 
uuid_t
 
	gtboÙ_sh¬ed_uuid
 = 
TBOOT_SHARED_UUID
;

30 
ušt64_t
 
__š™d©a
 
	gtxt_h—p_ba£
, __š™d©¨
	gtxt_h—p_size
;

31 
ušt64_t
 
__š™d©a
 
	gsš™_ba£
, __š™d©¨
	gsš™_size
;

37 
	#TXT_PUB_CONFIG_REGS_BASE
 0xãd30000

	)

38 
	#TXT_PRIV_CONFIG_REGS_BASE
 0xãd20000

	)

41 
	#NR_TXT_CONFIG_PAGES
 ((
TXT_PUB_CONFIG_REGS_BASE
 - \

42 
TXT_PRIV_CONFIG_REGS_BASE
è>> 
PAGE_SHIFT
)

	)

45 
	#TXTCR_SINIT_BASE
 0x0270

	)

46 
	#TXTCR_SINIT_SIZE
 0x0278

	)

47 
	#TXTCR_HEAP_BASE
 0x0300

	)

48 
	#TXTCR_HEAP_SIZE
 0x0308

	)

50 
__š™_begš
[], 
__bss_¡¬t
[];

52 
	#SHA1_SIZE
 20

	)

53 
ušt8_t
 
	tsha1_hash_t
[
SHA1_SIZE
];

55 
	s__·cked
 {

56 
ušt32_t
 
	mv”siÚ
;

57 
sha1_hash_t
 
	mbios_acm_id
;

58 
ušt32_t
 
	medx_£Á”_æags
;

59 
ušt64_t
 
	mm£g_v®id
;

60 
sha1_hash_t
 
	msš™_hash
;

61 
sha1_hash_t
 
	mmË_hash
;

62 
sha1_hash_t
 
	m¡m_hash
;

63 
sha1_hash_t
 
	mlı_pŞicy_hash
;

64 
ušt32_t
 
	mlı_pŞicy_cÚŒŞ
;

65 
ušt32_t
 
	m¾p_wakeup_addr
;

66 
ušt32_t
 
	m»£rved
;

67 
ušt32_t
 
	mnum_mdrs
;

68 
ušt32_t
 
	mmdrs_off
;

69 
ušt32_t
 
	mnum_vtd_dm¬s
;

70 
ušt32_t
 
	mvtd_dm¬s_off
;

71 } 
	tsš™_mË_d©a_t
;

73 
	$tboÙ_cİy_memÜy
(*
va
, 
ušt32_t
 
size
,

74 
·
)

76 
m­_ba£
 = 0;

77 *
m­_addr
 = 
NULL
;

78 
i
;

80  
i
 = 0; i < 
size
; i++ )

82 iàĞ
m­_ba£
 !ğ
	`PFN_DOWN
(
·
 + 
i
) )

84 
m­_ba£
 = 
	`PFN_DOWN
(
·
 + 
i
);

85 
	`£t_fixm­
(
FIX_TBOOT_MAP_ADDRESS
, 
m­_ba£
 << 
PAGE_SHIFT
);

86 
m­_addr
 = (*)
	`fix_to_vœt
(
FIX_TBOOT_MAP_ADDRESS
);

88 
va
[
i
] = 
m­_addr
[
·
 + i - (
m­_ba£
 << 
PAGE_SHIFT
)];

90 
	}
}

92 
__š™
 
	$tboÙ_´obe
()

94 
tboÙ_sh¬ed_t
 *
tboÙ_sh¬ed
;

95 
p_tboÙ_sh¬ed
;

98 
p_tboÙ_sh¬ed
 = 
	`sim¶e_¡¹oul
(
İt_tboÙ
, 
NULL
, 0);

99 iàĞ(
p_tboÙ_sh¬ed
 =ğ0è|| (Õ_tboÙ_sh¬ed & ~
PAGE_MASK
) != 0) )

103 
	`£t_fixm­
(
FIX_TBOOT_SHARED_BASE
, 
p_tboÙ_sh¬ed
);

104 
tboÙ_sh¬ed
 = (
tboÙ_sh¬ed_t
 *)
	`fix_to_vœt
(
FIX_TBOOT_SHARED_BASE
);

105 iàĞ
tboÙ_sh¬ed
 =ğ
NULL
 )

107 iàĞ
	`memcmp
(&
tboÙ_sh¬ed_uuid
, (
uuid_t
 *)
tboÙ_sh¬ed
, (uuid_t)) )

112 iàĞ
tboÙ_sh¬ed
->
v”siÚ
 < 4 ) {

113 
	`´štk
("unsuµÜ‹d v”siÚ oàtboÙ (%u)\n", 
tboÙ_sh¬ed
->
v”siÚ
);

117 
g_tboÙ_sh¬ed
 = 
tboÙ_sh¬ed
;

118 
	`´štk
("TBOOT: found sh¬ed…ag©…hy add¸%lx:\n", 
p_tboÙ_sh¬ed
);

119 
	`´štk
(" v”siÚ: %d\n", 
tboÙ_sh¬ed
->
v”siÚ
);

120 
	`´štk
("†og_addr: 0x%08x\n", 
tboÙ_sh¬ed
->
log_addr
);

121 
	`´štk
(" shutdown_’Œy: 0x%08x\n", 
tboÙ_sh¬ed
->
shutdown_’Œy
);

122 
	`´štk
("boÙ_ba£: 0x%08x\n", 
tboÙ_sh¬ed
->
tboÙ_ba£
);

123 
	`´štk
("boÙ_size: 0x%x\n", 
tboÙ_sh¬ed
->
tboÙ_size
);

128 
txt_h—p_ba£
 = 
txt_h—p_size
 = 
sš™_ba£
 = 
sš™_size
 = 0;

130 
	`tboÙ_cİy_memÜy
((*)&
txt_h—p_ba£
, (txt_heap_base),

131 
TXT_PUB_CONFIG_REGS_BASE
 + 
TXTCR_HEAP_BASE
);

132 
	`tboÙ_cİy_memÜy
((*)&
txt_h—p_size
, (txt_heap_size),

133 
TXT_PUB_CONFIG_REGS_BASE
 + 
TXTCR_HEAP_SIZE
);

135 
	`tboÙ_cİy_memÜy
((*)&
sš™_ba£
, (sinit_base),

136 
TXT_PUB_CONFIG_REGS_BASE
 + 
TXTCR_SINIT_BASE
);

137 
	`tboÙ_cİy_memÜy
((*)&
sš™_size
, (sinit_size),

138 
TXT_PUB_CONFIG_REGS_BASE
 + 
TXTCR_SINIT_SIZE
);

139 
	}
}

143 
	#LEVEL_STRIDE
 (9)

	)

144 
	#PTE_NUM
 (1<<
LEVEL_STRIDE
)

	)

145 
	#dma_±e_´e£Á
(
p
è((Õ).
v®
 & 3è!ğ0)

	)

146 
	#dma_±e_addr
(
p
è(Õ).
v®
 & 
PAGE_MASK_4K
)

	)

147 
	#agaw_to_Ëv–
(
v®
è((v®)+2)

	)

148 
	sdma_±e
 {

149 
u64
 
	mv®
;

152 
	$upd©e_iommu_mac
(
vmac_ùx_t
 *
ùx
, 
ušt64_t
 
±_maddr
, 
Ëv–
)

154 
i
;

155 
dma_±e
 *
±_vaddr
, *
±e
;

156 
Ãxt_Ëv–
 = 
Ëv–
 - 1;

158 iàĞ
±_maddr
 == 0 )

161 
±_vaddr
 = (
dma_±e
 *)
	`m­_domaš_·ge
(
±_maddr
 >> 
PAGE_SHIFT_4K
);

162 
	`vmac_upd©e
((*)
±_vaddr
, 
PAGE_SIZE
, 
ùx
);

164  
i
 = 0; i < 
PTE_NUM
; i++ )

166 
±e
 = &
±_vaddr
[
i
];

167 iàĞ!
	`dma_±e_´e£Á
(*
±e
) )

170 iàĞ
Ãxt_Ëv–
 >= 1 )

171 
	`upd©e_iommu_mac
(
ùx
, 
	`dma_±e_addr
(*
±e
), 
Ãxt_Ëv–
);

174 
	`unm­_domaš_·ge
(
±_vaddr
);

175 
	}
}

177 
	#is_·ge_š_u£
(
·ge
) \

178 (
	`·ge_¡©e_is
(
·ge
, 
šu£
è||…age_¡©e_isÕage, 
ofæššg
))

	)

180 
	$upd©e_·g‘abË_mac
(
vmac_ùx_t
 *
ùx
)

182 
mâ
;

184  
mâ
 = 0; mâ < 
max_·ge
; mfn++ )

186 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
mâ
);

188 iàĞ!
	`mâ_v®id
(
mâ
) )

190 iàĞ
	`is_·ge_š_u£
(
·ge
è&& !
	`is_x’_h—p_·ge
(page) ) {

191 iàĞ
·ge
->
couÁ_šfo
 & 
PGC_·ge_bË
 ) {

192 *
pg
 = 
	`m­_domaš_·ge
(
mâ
);

193 
	`vmac_upd©e
(
pg
, 
PAGE_SIZE
, 
ùx
);

194 
	`unm­_domaš_·ge
(
pg
);

198 
	}
}

200 
	$tboÙ_g’_domaš_š‹gr™y
(cÚ¡ 
ušt8_t
 
key
[
TB_KEY_SIZE
],

201 
vmac_t
 *
mac
)

203 
domaš
 *
d
;

204 
·ge_šfo
 *
·ge
;

205 
ušt8_t
 
nÚû
[16] = {};

206 
vmac_ùx_t
 
ùx
;

208 
	`vmac_£t_key
((
ušt8_t
 *)
key
, &
ùx
);

209 
	`fÜ_—ch_domaš
Ğ
d
 )

211 iàĞ!
d
->
¬ch
.
s3_š‹gr™y
 )

213 
	`´štk
("MACšg Domaš %u\n", 
d
->
domaš_id
);

215 
	`¥š_lock
(&
d
->
·ge_®loc_lock
);

216 
	`·ge_li¡_fÜ_—ch
(
·ge
, &
d
->
·ge_li¡
)

218 *
pg
 = 
	`__m­_domaš_·ge
(
·ge
);

219 
	`vmac_upd©e
(
pg
, 
PAGE_SIZE
, &
ùx
);

220 
	`unm­_domaš_·ge
(
pg
);

222 
	`¥š_uÆock
(&
d
->
·ge_®loc_lock
);

224 iàĞ!
	`is_idË_domaš
(
d
) )

226 
hvm_iommu
 *
hd
 = 
	`domaš_hvm_iommu
(
d
);

227 
	`upd©e_iommu_mac
(&
ùx
, 
hd
->
pgd_maddr
, 
	`agaw_to_Ëv–
(hd->
agaw
));

232 
	`upd©e_·g‘abË_mac
(&
ùx
);

234 *
mac
 = 
	`vmac
(
NULL
, 0, 
nÚû
, NULL, &
ùx
);

237 
	`mem£t
(&
ùx
, 0, (ctx));

238 
	}
}

245 
	$mâ_š_gu¬ded_¡ack
(
mâ
)

247 *
¡ack_ba£
[
NR_CPUS
];

248 *
p
;

249 
i
;

251  
i
 = 0; i < 
NR_CPUS
; i++ )

253 iàĞ!
¡ack_ba£
[
i
] )

255 
p
 = (*)(()
¡ack_ba£
[
i
] + 
STACK_SIZE
 -

256 
PRIMARY_STACK_SIZE
 - 
PAGE_SIZE
);

257 iàĞ
mâ
 =ğ
	`vœt_to_mâ
(
p
) )

262 
	}
}

264 
	$tboÙ_g’_x’h—p_š‹gr™y
(cÚ¡ 
ušt8_t
 
key
[
TB_KEY_SIZE
],

265 
vmac_t
 *
mac
)

267 
mâ
;

268 
ušt8_t
 
nÚû
[16] = {};

269 
vmac_ùx_t
 
ùx
;

271 
	`vmac_£t_key
((
ušt8_t
 *)
key
, &
ùx
);

272  
mâ
 = 0; mâ < 
max_·ge
; mfn++ )

274 
·ge_šfo
 *
·ge
 = 
	`__mâ_to_·ge
(
mâ
);

276 iàĞ!
	`mâ_v®id
(
mâ
) )

278 iàĞ(
mâ
 << 
PAGE_SHIFT
è< 
	`__·
(&
_’d
) )

280 iàĞ(
mâ
 >ğ
	`PFN_DOWN
(
g_tboÙ_sh¬ed
->
tboÙ_ba£
 - 3 * 
PAGE_SIZE
))

281 && (
mâ
 < 
	`PFN_UP
(
g_tboÙ_sh¬ed
->
tboÙ_ba£


282 + 
g_tboÙ_sh¬ed
->
tboÙ_size


283 + 3 * 
PAGE_SIZE
)) )

286 iàĞ
	`is_·ge_š_u£
(
·ge
è&& 
	`is_x’_h—p_·ge
(page) ) {

287 *
pg
;

289 iàĞ
	`mâ_š_gu¬ded_¡ack
(
mâ
) )

292 
pg
 = 
	`mâ_to_vœt
(
mâ
);

293 
	`vmac_upd©e
((
ušt8_t
 *)
pg
, 
PAGE_SIZE
, &
ùx
);

296 *
mac
 = 
	`vmac
(
NULL
, 0, 
nÚû
, NULL, &
ùx
);

299 
	`mem£t
(&
ùx
, 0, (ctx));

300 
	}
}

302 
	$tboÙ_g’_äam‘abË_š‹gr™y
(cÚ¡ 
ušt8_t
 
key
[
TB_KEY_SIZE
],

303 
vmac_t
 *
mac
)

305 
sidx
, 
eidx
, 
nidx
;

306 
max_idx
 = (
max_pdx
 + 
PDX_GROUP_COUNT
 - 1)/PDX_GROUP_COUNT;

307 
ušt8_t
 
nÚû
[16] = {};

308 
vmac_ùx_t
 
ùx
;

310 
	`vmac_£t_key
((
ušt8_t
 *)
key
, &
ùx
);

311  
sidx
 = 0; ; sidx = 
nidx
 )

313 
eidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
max_idx
, 
sidx
);

314 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
max_idx
, 
eidx
);

315 iàĞ
nidx
 >ğ
max_idx
 )

317 
	`vmac_upd©e
((
ušt8_t
 *)
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
),

318 
	`pdx_to_·ge
(
eidx
 * 
PDX_GROUP_COUNT
)

319 - 
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
), &
ùx
);

321 
	`vmac_upd©e
((
ušt8_t
 *)
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
),

322 
	`pdx_to_·ge
(
max_pdx
 - 1) + 1

323 - 
	`pdx_to_·ge
(
sidx
 * 
PDX_GROUP_COUNT
), &
ùx
);

325 *
mac
 = 
	`vmac
(
NULL
, 0, 
nÚû
, NULL, &
ùx
);

328 
	`mem£t
(&
ùx
, 0, (ctx));

329 
	}
}

331 
	$tboÙ_shutdown
(
ušt32_t
 
shutdown_ty³
)

333 
ušt32_t
 
m­_ba£
, 
m­_size
;

334 
”r
;

336 
g_tboÙ_sh¬ed
->
shutdown_ty³
 = shutdown_type;

338 
	`loÿl_œq_di§bË
();

342 
m­_ba£
 = 
	`PFN_DOWN
(
g_tboÙ_sh¬ed
->
tboÙ_ba£
);

343 
m­_size
 = 
	`PFN_UP
(
g_tboÙ_sh¬ed
->
tboÙ_size
);

345 
”r
 = 
	`m­_·ges_to_x’
(
m­_ba£
 << 
PAGE_SHIFT
, m­_ba£, 
m­_size
,

346 
__PAGE_HYPERVISOR
);

347 iàĞ
”r
 != 0 ) {

348 
	`´štk
("”rÜ (0x%xèm­pšgboÙ…age (mâsè@ 0x%x, 0x%x\n", 
”r
,

349 
m­_ba£
, 
m­_size
);

354 iàĞ
shutdown_ty³
 =ğ
TB_SHUTDOWN_S3
 ) {

358 
g_tboÙ_sh¬ed
->
num_mac_»giÚs
 = 3;

360 
g_tboÙ_sh¬ed
->
mac_»giÚs
[0].
¡¬t
 = 
	`boÙsym_phys
(
ŒampŞše_¡¬t
);

361 
g_tboÙ_sh¬ed
->
mac_»giÚs
[0].
size
 = 
	`boÙsym_phys
(
ŒampŞše_’d
) -

362 
	`boÙsym_phys
(
ŒampŞše_¡¬t
);

364 
g_tboÙ_sh¬ed
->
mac_»giÚs
[1].
¡¬t
 = (
ušt64_t
)
	`__·
(&
_¡ext
);

365 
g_tboÙ_sh¬ed
->
mac_»giÚs
[1].
size
 = 
	`__·
(&
__š™_begš
) -

366 
	`__·
(&
_¡ext
);

368 
g_tboÙ_sh¬ed
->
mac_»giÚs
[2].
¡¬t
 = (
ušt64_t
)
	`__·
(&
__bss_¡¬t
);

369 
g_tboÙ_sh¬ed
->
mac_»giÚs
[2].
size
 = 
	`__·
(&
_’d
è- __·(&
__bss_¡¬t
);

376 
	`tboÙ_g’_domaš_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
domaš_mac
);

377 
	`tboÙ_g’_äam‘abË_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
äam‘abË_mac
);

378 
	`tboÙ_g’_x’h—p_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
x’h—p_mac
);

381 
	`wr™e_±ba£
(
idË_vıu
[0]);

383 (((*)())()
g_tboÙ_sh¬ed
->
shutdown_’Œy
)();

385 
	`BUG
();

386 
	}
}

388 
	$tboÙ_š_m—su»d_’v
()

390  (
g_tboÙ_sh¬ed
 !ğ
NULL
);

391 
	}
}

393 
__š™
 
	$tboÙ_´Ùeù_mem_»giÚs
()

395 
rc
;

397 iàĞ!
	`tboÙ_š_m—su»d_’v
() )

401 iàĞ
txt_h—p_ba£
 == 0 )

403 
rc
 = 
	`e820_chªge_¿nge_ty³
(

404 &
e820
, 
txt_h—p_ba£
,xt_h—p_ba£ + 
txt_h—p_size
,

405 
E820_RESERVED
, 
E820_UNUSABLE
);

406 iàĞ!
rc
 )

410 iàĞ
sš™_ba£
 == 0 )

412 
rc
 = 
	`e820_chªge_¿nge_ty³
(

413 &
e820
, 
sš™_ba£
, sš™_ba£ + 
sš™_size
,

414 
E820_RESERVED
, 
E820_UNUSABLE
);

415 iàĞ!
rc
 )

419 
rc
 = 
	`e820_chªge_¿nge_ty³
(

420 &
e820
, 
TXT_PRIV_CONFIG_REGS_BASE
,

421 
TXT_PRIV_CONFIG_REGS_BASE
 + 
NR_TXT_CONFIG_PAGES
 * 
PAGE_SIZE
,

422 
E820_RESERVED
, 
E820_UNUSABLE
);

423 iàĞ!
rc
 )

427 
	}
}

429 
__š™
 
	$tboÙ_·r£_dm¬_bË
(
aıi_bË_hªdËr
 
dm¬_hªdËr
)

431 
aıi_bË_h—d”
 *
dm¬_bË
;

432 
rc
;

433 
ušt64_t
 
size
;

434 
ušt32_t
 
dm¬_bË_Ëngth
;

435 
·
;

436 
sš™_mË_d©a_t
 
sš™_mË_d©a
;

437 *
dm¬_bË_¿w
;

440 iàĞ!
	`tboÙ_š_m—su»d_’v
() )

441  
	`aıi_bË_·r£
(
ACPI_SIG_DMAR
, 
dm¬_hªdËr
);

446 iàĞ
txt_h—p_ba£
 == 0 )

452 
·
 = 
txt_h—p_ba£
;

454 
	`tboÙ_cİy_memÜy
((*)&
size
, (size), 
·
);

455 
·
 +ğ
size
;

457 
	`tboÙ_cİy_memÜy
((*)&
size
, (size), 
·
);

458 
·
 +ğ
size
;

460 
	`tboÙ_cİy_memÜy
((*)&
size
, (size), 
·
);

461 
·
 +ğ
size
;

463 
·
 +ğ(
ušt64_t
);

464 
	`tboÙ_cİy_memÜy
((*)&
sš™_mË_d©a
, (sinit_mle_data),

465 
·
);

467 
·
 +ğ
sš™_mË_d©a
.
vtd_dm¬s_off
 - (
ušt64_t
);

468 
	`tboÙ_cİy_memÜy
((*)&
dm¬_bË_Ëngth
,

469 (
dm¬_bË_Ëngth
),

470 
·
 + (è* 
ACPI_NAME_SIZE
);

471 
dm¬_bË_¿w
 = 
	`xm®loc_¬¿y
(, 
dm¬_bË_Ëngth
);

472 
	`tboÙ_cİy_memÜy
(
dm¬_bË_¿w
, 
dm¬_bË_Ëngth
, 
·
);

473 
dm¬_bË
 = (
aıi_bË_h—d”
 *)
dm¬_bË_¿w
;

474 
rc
 = 
	`dm¬_hªdËr
(
dm¬_bË
);

475 
	`xä“
(
dm¬_bË_¿w
);

479 
	`aıi_dm¬_z­
();

481  
rc
;

482 
	}
}

484 
	$tboÙ_s3_»sume
()

486 
vmac_t
 
mac
;

488 iàĞ!
	`tboÙ_š_m—su»d_’v
() )

492 
	`tboÙ_g’_x’h—p_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
mac
);

493 
	`´štk
("MAC fÜ x’h—°befÜS3 is: 0x%08"
PRIx64
"\n", 
x’h—p_mac
);

494 
	`´štk
("MAC fÜ x’h—°aá” S3 is: 0x%08"
PRIx64
"\n", 
mac
);

495 iàĞ
mac
 !ğ
x’h—p_mac
 )

498 
	`tboÙ_g’_äam‘abË_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
mac
);

499 
	`´štk
("MAC fÜ f¿m‘abË befÜS3 is: 0x%08"
PRIx64
"\n", 
äam‘abË_mac
);

500 
	`´štk
("MAC fÜ f¿m‘abË‡á” S3 is: 0x%08"
PRIx64
"\n", 
mac
);

501 iàĞ
mac
 !ğ
äam‘abË_mac
 )

504 
	`tboÙ_g’_domaš_š‹gr™y
(
g_tboÙ_sh¬ed
->
s3_key
, &
mac
);

505 
	`´štk
("MAC fÜ domaš befÜS3 is: 0x%08"
PRIx64
"\n", 
domaš_mac
);

506 
	`´štk
("MAC fÜ domaš aá” S3 is: 0x%08"
PRIx64
"\n", 
mac
);

507 iàĞ
mac
 !ğ
domaš_mac
 )

511 
	}
}

	@time.c

12 
	~<x’/cÚfig.h
>

13 
	~<x’/”ºo.h
>

14 
	~<x’/ev’t.h
>

15 
	~<x’/sched.h
>

16 
	~<x’/lib.h
>

17 
	~<x’/cÚfig.h
>

18 
	~<x’/š™.h
>

19 
	~<x’/time.h
>

20 
	~<x’/tim”.h
>

21 
	~<x’/smp.h
>

22 
	~<x’/œq.h
>

23 
	~<x’/soáœq.h
>

24 
	~<x’/ıuidË.h
>

25 
	~<x’/keyhªdËr.h
>

26 
	~<x’/gue¡_acûss.h
>

27 
	~<asm/io.h
>

28 
	~<asm/m¤.h
>

29 
	~<asm/mp¥ec.h
>

30 
	~<asm/´oûssÜ.h
>

31 
	~<asm/fixm­.h
>

32 
	~<asm/mc146818¹c.h
>

33 
	~<asm/div64.h
>

34 
	~<asm/aıi.h
>

35 
	~<asm/h³t.h
>

36 
	~<io_pÜts.h
>

37 
	~<asm/£tup.h
>

38 
	~<public/¬ch-x86/ıuid.h
>

41 
__š™d©a
 
	gİt_şocksourû
[10];

42 
¡ršg_·¿m
("şocksourû", 
İt_şocksourû
);

44 
	gıu_khz
;

45 
DEFINE_SPINLOCK
(
¹c_lock
);

46 
	gp™0_ticks
;

47 
u32
 
	gwc_£c
, 
	gwc_n£c
;

48 
DEFINE_SPINLOCK
(
wc_lock
);

50 
	sıu_time
 {

51 
u64
 
	mloÿl_tsc_¡amp
;

52 
s_time_t
 
	m¡ime_loÿl_¡amp
;

53 
s_time_t
 
	m¡ime_ma¡”_¡amp
;

54 
time_sÿË
 
	mtsc_sÿË
;

57 
	s¶©fÜm_timesourû
 {

58 *
	mid
;

59 *
	mÇme
;

60 
u64
 
	mäequ’cy
;

61 
u64
 (*
»ad_couÁ”
)();

62 (*
	mš™
)(
	m¶©fÜm_timesourû
 *);

63 (*
	m»sume
)(
	m¶©fÜm_timesourû
 *);

64 
	mcouÁ”_b™s
;

67 
DEFINE_PER_CPU
(
ıu_time
, cpu_time);

70 
	#EPOCH
 
	`MILLISECS
(1000)

	)

71 
tim”
 
	gÿlib¿tiÚ_tim”
;

80 
DEFINE_SPINLOCK
(
p™_lock
);

81 
u16
 
	gp™_¡amp16
;

82 
u32
 
	gp™_¡amp32
;

83 
	gusšg_p™
;

89 
šlše
 
u32
 
	$div_äac
(
u32
 
divid’d
, u32 
divisÜ
)

91 
u32
 
quÙ›Á
, 
»mašd”
;

92 
	`ASSERT
(
divid’d
 < 
divisÜ
);

93 
	`asm
 (

95 : "÷" (
quÙ›Á
), "=d" (
»mašd”
)

96 : "0" (0), "1" (
divid’d
), "r" (
divisÜ
) );

97  
quÙ›Á
;

98 
	}
}

104 
šlše
 
u32
 
	$mul_äac
(
u32
 
muÉliÿnd
, u32 
muÉl›r
)

106 
u32
 
´oduù_št
, 
´oduù_äac
;

107 
	`asm
 (

109 : "÷" (
´oduù_äac
), "=d" (
´oduù_št
)

110 : "0" (
muÉliÿnd
), "r" (
muÉl›r
) );

111  
´oduù_št
;

112 
	}
}

118 
šlše
 
u64
 
	$sÿË_d–
(
u64
 
d–
, 
time_sÿË
 *
sÿË
)

120 
u64
 
´oduù
;

121 #ifdeà
CONFIG_X86_32


122 
u32
 
tmp1
, 
tmp2
;

125 iàĞ
sÿË
->
shiá
 < 0 )

126 
d–
 >>ğ-
sÿË
->
shiá
;

128 
d–
 <<ğ
sÿË
->
shiá
;

130 #ifdeà
CONFIG_X86_32


131 
	`asm
 (

139 : "=A" (
´oduù
), "ô" (
tmp1
), "ô" (
tmp2
)

140 : "a" ((
u32
)
d–
), "1" ((u32)(d– >> 32)), "2" (
sÿË
->
mul_äac
) );

142 
	`asm
 (

144 : "÷" (
´oduù
è: "0" (
d–
), "d" ((
u64
)
sÿË
->
mul_äac
) );

147  
´oduù
;

148 
	}
}

150 
	#_TS_MUL_FRAC_IDENTITY
 0x80000000UL

	)

153 
šlše
 
time_sÿË
 
	$sÿË_»croÿl
(
time_sÿË
 
sÿË
)

155 
time_sÿË
 
»croÿl
;

156 
u32
 
divid’d
;

158 
	`ASSERT
(
sÿË
.
mul_äac
 != 0);

159 
divid’d
 = 
_TS_MUL_FRAC_IDENTITY
;

160 
»croÿl
.
shiá
 = 1 - 
sÿË
.shift;

161  
	`uÆik–y
(
divid’d
 >ğ
sÿË
.
mul_äac
) )

163 
divid’d
 >>= 1;

164 
»croÿl
.
shiá
++;

167 
	`asm
 (

169 : "÷" (
»croÿl
.
mul_äac
), "=d" (
divid’d
)

170 : "0" (0), "1" (
divid’d
), "r" (
sÿË
.
mul_äac
) );

172  
»croÿl
;

173 
	}
}

179 
ıumask_t
 
	gp™_brßdÿ¡_mask
;

181 
	$smp_£nd_tim”_brßdÿ¡_i
()

183 
ıu
 = 
	`smp_´oûssÜ_id
();

184 
ıumask_t
 
mask
;

186 
	`ıus_ªd
(
mask
, 
ıu_Úlše_m­
, 
p™_brßdÿ¡_mask
);

188 iàĞ
	`ıu_is£t
(
ıu
, 
mask
) )

190 
	`ıu_ş—r
(
ıu
, 
mask
);

191 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

194 iàĞ!
	`ıus_em±y
(
mask
) )

196 
	`ıumask_¿i£_soáœq
(
mask
, 
TIMER_SOFTIRQ
);

198 
	}
}

200 
	$tim”_š‹¼u±
(
œq
, *
dev_id
, 
ıu_u£r_»gs
 *
»gs
)

202 
	`ASSERT
(
	`loÿl_œq_is_’abËd
());

204 iàĞ
	`h³t_Ëgacy_œq_tick
() )

208 (*(vŞ©*)&
p™0_ticks
)++;

211 iàĞ!
ıu_has_­ic
 )

212 
	`¿i£_soáœq
(
TIMER_SOFTIRQ
);

214 iàĞ
x’_ıuidË
 )

215 
	`smp_£nd_tim”_brßdÿ¡_i
();

218 iàĞ
usšg_p™
 )

220 
u16
 
couÁ
;

222 
	`¥š_lock_œq
(&
p™_lock
);

224 
	`outb
(0x80, 
PIT_MODE
);

225 
couÁ
 = 
	`šb
(
PIT_CH2
);

226 
couÁ
 |ğ
	`šb
(
PIT_CH2
) << 8;

228 
p™_¡amp32
 +ğ(
u16
)(
p™_¡amp16
 - 
couÁ
);

229 
p™_¡amp16
 = 
couÁ
;

231 
	`¥š_uÆock_œq
(&
p™_lock
);

233 
	}
}

235 
œqaùiÚ
 
__»ad_mo¡ly
 
	gœq0
 = { 
tim”_š‹¼u±
, "tim”", 
NULL
 };

241 
	#CLOCK_TICK_RATE
 1193182

	)

242 
	#CALIBRATE_FRAC
 20

	)

243 
	#CALIBRATE_LATCH
 ((
CLOCK_TICK_RATE
+(
CALIBRATE_FRAC
/2))/CALIBRATE_FRAC)

	)

245 
u64
 
	$š™_p™_ªd_ÿlib¿‹_tsc
()

247 
u64
 
¡¬t
, 
’d
;

248 
couÁ
;

251 
	#LATCH
 (((
CLOCK_TICK_RATE
)+(
HZ
/2))/HZ)

	)

252 
	`outb_p
(0x34, 
PIT_MODE
);

253 
	`outb_p
(
LATCH
 & 0xff, 
PIT_CH0
);

254 
	`outb
(
LATCH
 >> 8, 
PIT_CH0
);

257 
	`outb
((
	`šb
(0x61) & ~0x02) | 0x01, 0x61);

266 
	`outb
(0xb0, 
PIT_MODE
);

267 
	`outb
(
CALIBRATE_LATCH
 & 0xff, 
PIT_CH2
);

268 
	`outb
(
CALIBRATE_LATCH
 >> 8, 
PIT_CH2
);

270 
	`rdtsşl
(
¡¬t
);

271  
couÁ
 = 0; (
	`šb
(0x61) & 0x20) == 0; count++ )

273 
	`rdtsşl
(
’d
);

276 iàĞ
couÁ
 == 0 )

279  ((
’d
 - 
¡¬t
è* (
u64
)
CALIBRATE_FRAC
);

280 
	}
}

282 
	$£t_time_sÿË
(
time_sÿË
 *
ts
, 
u64
 
ticks_³r_£c
)

284 
u64
 
s64
 = 
ticks_³r_£c
;

285 
u32
 
s32
;

286 
shiá
 = 0;

288 
	`ASSERT
(
s64
 != 0);

290  
s64
 > (
	`MILLISECS
(1000)*2) )

292 
s64
 >>= 1;

293 
shiá
--;

296 
s32
 = (
u32
)
s64
;

297  
s32
 <ğ(
u32
)
	`MILLISECS
(1000) )

299 
s32
 <<= 1;

300 
shiá
++;

303 
ts
->
mul_äac
 = 
	`div_äac
(
	`MILLISECS
(1000), 
s32
);

304 
ts
->
shiá
 = shift;

305 
	}
}

307 *
	$äeq_¡ršg
(
u64
 
äeq
)

309 
s
[20];

310 
x
, 
y
;

311 
y
 = ()
	`do_div
(
äeq
, 1000000) / 1000;

312 
x
 = ()
äeq
;

313 
	`¢´štf
(
s
, (s), "%u.%03uMHz", 
x
, 
y
);

314  
s
;

315 
	}
}

321 
u64
 
	$»ad_p™_couÁ
()

323 
u16
 
couÁ16
;

324 
u32
 
couÁ32
;

325 
æags
;

327 
	`¥š_lock_œq§ve
(&
p™_lock
, 
æags
);

329 
	`outb
(0x80, 
PIT_MODE
);

330 
couÁ16
 = 
	`šb
(
PIT_CH2
);

331 
couÁ16
 |ğ
	`šb
(
PIT_CH2
) << 8;

333 
couÁ32
 = 
p™_¡amp32
 + (
u16
)(
p™_¡amp16
 - 
couÁ16
);

335 
	`¥š_uÆock_œq»¡Üe
(&
p™_lock
, 
æags
);

337  
couÁ32
;

338 
	}
}

340 
__š™
 
	$š™_p™
(
¶©fÜm_timesourû
 *
±s
)

342 
usšg_p™
 = 1;

344 
	}
}

346 
¶©fÜm_timesourû
 
__š™d©a
 
	g¶t_p™
 =

348 .
id
 = "pit",

349 .
	gÇme
 = "PIT",

350 .
	gäequ’cy
 = 
CLOCK_TICK_RATE
,

351 .
	g»ad_couÁ”
 = 
»ad_p™_couÁ
,

352 .
	gcouÁ”_b™s
 = 32,

353 .
	gš™
 = 
š™_p™


360 
u64
 
	$»ad_h³t_couÁ
()

362  
	`h³t_»ad32
(
HPET_COUNTER
);

363 
	}
}

365 
__š™
 
	$š™_h³t
(
¶©fÜm_timesourû
 *
±s
)

367 
u64
 
h³t_¿‹
 = 
	`h³t_£tup
();

369 iàĞ
h³t_¿‹
 == 0 )

372 
±s
->
äequ’cy
 = 
h³t_¿‹
;

374 
	}
}

376 
	$»sume_h³t
(
¶©fÜm_timesourû
 *
±s
)

378 
u64
 
h³t_¿‹
 = 
	`h³t_£tup
();

380 
	`BUG_ON
(
h³t_¿‹
 == 0);

381 
±s
->
äequ’cy
 = 
h³t_¿‹
;

382 
	}
}

384 
¶©fÜm_timesourû
 
__š™d©a
 
	g¶t_h³t
 =

386 .
id
 = "hpet",

387 .
	gÇme
 = "HPET",

388 .
	g»ad_couÁ”
 = 
»ad_h³t_couÁ
,

389 .
	gcouÁ”_b™s
 = 32,

390 .
	gš™
 = 
š™_h³t
,

391 .
	g»sume
 = 
»sume_h³t


398 
	gu£_cyşÚe
;

405 
	#CYCLONE_CBAR_ADDR
 0xFEB00CD0

	)

406 
	#CYCLONE_PMCC_OFFSET
 0x51A0

	)

407 
	#CYCLONE_MPMC_OFFSET
 0x51D0

	)

408 
	#CYCLONE_MPCS_OFFSET
 0x51A8

	)

409 
	#CYCLONE_TIMER_FREQ
 100000000

	)

412 vŞ©
u32
 *
	gcyşÚe_tim”
;

414 
u64
 
	$»ad_cyşÚe_couÁ
()

416  *
cyşÚe_tim”
;

417 
	}
}

419 vŞ©
u32
 *
__š™
 
	$m­_cyşÚe_»g
(
»gaddr
)

421 
·g—ddr
 = 
»gaddr
 & 
PAGE_MASK
;

422 
off£t
 = 
»gaddr
 & ~
PAGE_MASK
;

423 
	`£t_fixm­_noÿche
(
FIX_CYCLONE_TIMER
, 
·g—ddr
);

424  (vŞ©
u32
 *)(
	`fix_to_vœt
(
FIX_CYCLONE_TIMER
è+ 
off£t
);

425 
	}
}

427 
__š™
 
	$š™_cyşÚe
(
¶©fÜm_timesourû
 *
±s
)

429 
u32
 
ba£
;

431 iàĞ!
u£_cyşÚe
 )

435 
ba£
 = *(
	`m­_cyşÚe_»g
(
CYCLONE_CBAR_ADDR
));

436 iàĞ
ba£
 == 0 )

438 
	`´štk
(
KERN_ERR
 "Cyclone: Could‚ot find valid CBAR value.\n");

443 *(
	`m­_cyşÚe_»g
(
ba£
 + 
CYCLONE_PMCC_OFFSET
)) = 1;

444 *(
	`m­_cyşÚe_»g
(
ba£
 + 
CYCLONE_MPCS_OFFSET
)) = 1;

445 
cyşÚe_tim”
 = 
	`m­_cyşÚe_»g
(
ba£
 + 
CYCLONE_MPMC_OFFSET
);

447 
	}
}

449 
¶©fÜm_timesourû
 
__š™d©a
 
	g¶t_cyşÚe
 =

451 .
id
 = "cyclone",

452 .
	gÇme
 = "IBM Cyclone",

453 .
	gäequ’cy
 = 
CYCLONE_TIMER_FREQ
,

454 .
	g»ad_couÁ”
 = 
»ad_cyşÚe_couÁ
,

455 .
	gcouÁ”_b™s
 = 32,

456 .
	gš™
 = 
š™_cyşÚe


463 
u32
 
	gpmtmr_iİÜt
;

466 
	#ACPI_PM_FREQUENCY
 3579545

	)

468 
u64
 
	$»ad_pmtim”_couÁ
()

470  
	`šl
(
pmtmr_iİÜt
);

471 
	}
}

473 
__š™
 
	$š™_pmtim”
(
¶©fÜm_timesourû
 *
±s
)

475 iàĞ
pmtmr_iİÜt
 == 0 )

479 
	}
}

481 
¶©fÜm_timesourû
 
__š™d©a
 
	g¶t_pmtim”
 =

483 .
id
 = "acpi",

484 .
	gÇme
 = "ACPI PM Timer",

485 .
	gäequ’cy
 = 
ACPI_PM_FREQUENCY
,

486 .
	g»ad_couÁ”
 = 
»ad_pmtim”_couÁ
,

487 .
	gcouÁ”_b™s
 = 24,

488 .
	gš™
 = 
š™_pmtim”


491 
time_sÿË
 
	gpmt_sÿË
;

492 
time_sÿË
 
	gpmt_sÿË_r
;

493 
__š™
 
	$š™_pmtmr_sÿË
()

495 
	`£t_time_sÿË
(&
pmt_sÿË
, 
ACPI_PM_FREQUENCY
);

496 
pmt_sÿË_r
 = 
	`sÿË_»croÿl
(
pmt_sÿË
);

498 
	}
}

499 
__š™ÿÎ
(
š™_pmtmr_sÿË
);

501 
ušt64_t
 
	$aıi_pm_tick_to_ns
(
ušt64_t
 
ticks
)

503  
	`sÿË_d–
(
ticks
, &
pmt_sÿË
);

504 
	}
}

506 
ušt64_t
 
	$ns_to_aıi_pm_tick
(
ušt64_t
 
ns
)

508  
	`sÿË_d–
(
ns
, &
pmt_sÿË_r
);

509 
	}
}

515 
¶©fÜm_timesourû
 
	g¶t_¤c
;

516 
u64
 
	g¶t_mask
;

517 
u64
 
	g¶t_ov”æow_³riod
;

518 
time_sÿË
 
	g¶t_sÿË
;

521 
DEFINE_SPINLOCK
(
¶©fÜm_tim”_lock
);

522 
s_time_t
 
	g¡ime_¶©fÜm_¡amp
;

523 
u64
 
	g¶©fÜm_tim”_¡amp
;

524 
u64
 
	g¶t_¡amp64
;

525 
u64
 
	g¶t_¡amp
;

526 
tim”
 
	g¶t_ov”æow_tim”
;

528 
s_time_t
 
	$__»ad_¶©fÜm_¡ime
(
u64
 
¶©fÜm_time
)

530 
u64
 
diff
 = 
¶©fÜm_time
 - 
¶©fÜm_tim”_¡amp
;

531 
	`ASSERT
(
	`¥š_is_locked
(&
¶©fÜm_tim”_lock
));

532  (
¡ime_¶©fÜm_¡amp
 + 
	`sÿË_d–
(
diff
, &
¶t_sÿË
));

533 
	}
}

535 
	$¶t_ov”æow
(*
unu£d
)

537 
i
;

538 
u64
 
couÁ
;

539 
s_time_t
 
now
, 
¶t_now
, 
¶t_w¿p
;

541 
	`¥š_lock_œq
(&
¶©fÜm_tim”_lock
);

543 
couÁ
 = 
¶t_¤c
.
	`»ad_couÁ”
();

544 
¶t_¡amp64
 +ğ(
couÁ
 - 
¶t_¡amp
è& 
¶t_mask
;

545 
¶t_¡amp
 = 
couÁ
;

547 
now
 = 
	`NOW
();

548 
¶t_w¿p
 = 
	`__»ad_¶©fÜm_¡ime
(
¶t_¡amp64
);

549  
i
 = 0; i < 10; i++ )

551 
¶t_now
 = 
¶t_w¿p
;

552 
¶t_w¿p
 = 
	`__»ad_¶©fÜm_¡ime
(
¶t_¡amp64
 + 
¶t_mask
 + 1);

553 iàĞ
	`ABS
(
¶t_w¿p
 - 
now
è> ABS(
¶t_now
 -‚ow) )

555 
¶t_¡amp64
 +ğ
¶t_mask
 + 1;

557 iàĞ
i
 != 0 )

559 
boŞ_t
 
w¬Ãd_Úû
;

560 iàĞ!
	`‹¡_ªd_£t_boŞ
(
w¬Ãd_Úû
) )

561 
	`´štk
("Platformimer‡ppearso have unexpectedly wrapped "

562 "%u% times.\n", 
i
, (i == 10) ? " or more" : "");

565 
	`¥š_uÆock_œq
(&
¶©fÜm_tim”_lock
);

567 
	`£t_tim”
(&
¶t_ov”æow_tim”
, 
	`NOW
(è+ 
¶t_ov”æow_³riod
);

568 
	}
}

570 
s_time_t
 
	$»ad_¶©fÜm_¡ime
()

572 
u64
 
couÁ
;

573 
s_time_t
 
¡ime
;

575 
	`ASSERT
(!
	`loÿl_œq_is_’abËd
());

577 
	`¥š_lock
(&
¶©fÜm_tim”_lock
);

578 
couÁ
 = 
¶t_¡amp64
 + ((
¶t_¤c
.
	`»ad_couÁ”
(è- 
¶t_¡amp
è& 
¶t_mask
);

579 
¡ime
 = 
	`__»ad_¶©fÜm_¡ime
(
couÁ
);

580 
	`¥š_uÆock
(&
¶©fÜm_tim”_lock
);

582  
¡ime
;

583 
	}
}

585 
	$¶©fÜm_time_ÿlib¿tiÚ
()

587 
u64
 
couÁ
;

588 
s_time_t
 
¡amp
;

589 
æags
;

591 
	`¥š_lock_œq§ve
(&
¶©fÜm_tim”_lock
, 
æags
);

592 
couÁ
 = 
¶t_¡amp64
 + ((
¶t_¤c
.
	`»ad_couÁ”
(è- 
¶t_¡amp
è& 
¶t_mask
);

593 
¡amp
 = 
	`__»ad_¶©fÜm_¡ime
(
couÁ
);

594 
¡ime_¶©fÜm_¡amp
 = 
¡amp
;

595 
¶©fÜm_tim”_¡amp
 = 
couÁ
;

596 
	`¥š_uÆock_œq»¡Üe
(&
¶©fÜm_tim”_lock
, 
æags
);

597 
	}
}

599 
	$»sume_¶©fÜm_tim”
()

602 iàĞ
¶t_¤c
.
»sume
 )

603 
¶t_¤c
.
	`»sume
(&plt_src);

605 
¶t_¡amp64
 = 
¶©fÜm_tim”_¡amp
;

606 
¶t_¡amp
 = 
¶t_¤c
.
	`»ad_couÁ”
();

607 
	}
}

609 
__š™
 
	$š™_¶©fÜm_tim”
()

611 
¶©fÜm_timesourû
 * 
__š™d©a
 
¶t_tim”s
[] = {

612 &
¶t_cyşÚe
, &
¶t_h³t
, &
¶t_pmtim”
, &
¶t_p™


615 
¶©fÜm_timesourû
 *
±s
 = 
NULL
;

616 
i
, 
rc
 = -1;

618 iàĞ
İt_şocksourû
[0] != '\0' )

620  
i
 = 0; i < 
	`ARRAY_SIZE
(
¶t_tim”s
); i++ )

622 
±s
 = 
¶t_tim”s
[
i
];

623 iàĞ!
	`¡rcmp
(
İt_şocksourû
, 
±s
->
id
) )

625 
rc
 = 
±s
->
	`š™
(pts);

630 iàĞ
rc
 <= 0 )

631 
	`´štk
("WARNING: %s clocksource '%s'.\n",

632 (
rc
 == 0) ? "Could‚ot initialise" : "Unrecognised",

633 
İt_şocksourû
);

636 iàĞ
rc
 <= 0 )

638  
i
 = 0; i < 
	`ARRAY_SIZE
(
¶t_tim”s
); i++ )

640 
±s
 = 
¶t_tim”s
[
i
];

641 iàĞ(
rc
 = 
±s
->
	`š™
(pts)) > 0 )

646 
	`BUG_ON
(
rc
 <= 0);

648 
¶t_mask
 = (
u64
)~0uÎ >> (64 - 
±s
->
couÁ”_b™s
);

650 
	`£t_time_sÿË
(&
¶t_sÿË
, 
±s
->
äequ’cy
);

652 
¶t_ov”æow_³riod
 = 
	`sÿË_d–
(

653 1uÎ << (
±s
->
couÁ”_b™s
-1), &
¶t_sÿË
);

654 
	`š™_tim”
(&
¶t_ov”æow_tim”
, 
¶t_ov”æow
, 
NULL
, 0);

655 
¶t_¤c
 = *
±s
;

656 
	`¶t_ov”æow
(
NULL
);

658 
¶©fÜm_tim”_¡amp
 = 
¶t_¡amp64
;

659 
¡ime_¶©fÜm_¡amp
 = 
	`NOW
();

661 
	`´štk
("Platformimer is %s %s\n",

662 
	`äeq_¡ršg
(
±s
->
äequ’cy
),…ts->
Çme
);

663 
	}
}

665 
u64
 
	$¡ime2tsc
(
s_time_t
 
¡ime
)

667 
ıu_time
 *
t
;

668 
time_sÿË
 
sys_to_tsc
;

669 
s_time_t
 
¡ime_d–
;

671 
t
 = &
	`this_ıu
(
ıu_time
);

672 
sys_to_tsc
 = 
	`sÿË_»croÿl
(
t
->
tsc_sÿË
);

674 
¡ime_d–
 = 
¡ime
 - 
t
->
¡ime_loÿl_¡amp
;

675 iàĞ
¡ime_d–
 < 0 )

676 
¡ime_d–
 = 0;

678  
t
->
loÿl_tsc_¡amp
 + 
	`sÿË_d–
(
¡ime_d–
, &
sys_to_tsc
);

679 
	}
}

681 
	$c¡©e_»¡Üe_tsc
()

683 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_NONSTOP_TSC
) )

686 
	`wr™e_tsc
(
	`¡ime2tsc
(
	`»ad_¶©fÜm_¡ime
()));

687 
	}
}

709 
	$mktime
 (
y—r
, 
mÚ
,

710 
day
, 
hour
,

711 
mš
, 
£c
)

714 iàĞ0 >ğ(è(
mÚ
 -= 2) )

716 
mÚ
 += 12;

717 
y—r
 -= 1;

720  (((()(
y—r
/4 - y—r/100 + y—r/400 + 367*
mÚ
/12 + 
day
)+

721 
y—r
*365 - 719499

722 )*24 + 
hour


723 )*60 + 
mš


724 )*60 + 
£c
;

725 
	}
}

727 
	$__g‘_cmos_time
()

729 
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
;

731 
£c
 = 
	`CMOS_READ
(
RTC_SECONDS
);

732 
mš
 = 
	`CMOS_READ
(
RTC_MINUTES
);

733 
hour
 = 
	`CMOS_READ
(
RTC_HOURS
);

734 
day
 = 
	`CMOS_READ
(
RTC_DAY_OF_MONTH
);

735 
mÚ
 = 
	`CMOS_READ
(
RTC_MONTH
);

736 
y—r
 = 
	`CMOS_READ
(
RTC_YEAR
);

738 iàĞ!(
	`CMOS_READ
(
RTC_CONTROL
è& 
RTC_DM_BINARY
è|| 
RTC_ALWAYS_BCD
 )

740 
	`BCD_TO_BIN
(
£c
);

741 
	`BCD_TO_BIN
(
mš
);

742 
	`BCD_TO_BIN
(
hour
);

743 
	`BCD_TO_BIN
(
day
);

744 
	`BCD_TO_BIN
(
mÚ
);

745 
	`BCD_TO_BIN
(
y—r
);

748 iàĞ(
y—r
 += 1900) < 1970 )

749 
y—r
 += 100;

751  
	`mktime
(
y—r
, 
mÚ
, 
day
, 
hour
, 
mš
, 
£c
);

752 
	}
}

754 
	$g‘_cmos_time
()

756 
»s
, 
æags
;

757 
i
;

759 
	`¥š_lock_œq§ve
(&
¹c_lock
, 
æags
);

762  
i
 = 0 ; i < 1000000 ; i++ )

763 iàĞ(
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
) )

765  
i
 = 0 ; i < 1000000 ; i++ )

766 iàĞ!(
	`CMOS_READ
(
RTC_FREQ_SELECT
è& 
RTC_UIP
) )

769 
»s
 = 
	`__g‘_cmos_time
();

771 
	`¥š_uÆock_œq»¡Üe
(&
¹c_lock
, 
æags
);

772  
»s
;

773 
	}
}

779 
s_time_t
 
	$g‘_s_time
()

781 
ıu_time
 *
t
 = &
	`this_ıu
(cpu_time);

782 
u64
 
tsc
, 
d–
;

783 
s_time_t
 
now
;

785 
	`rdtsşl
(
tsc
);

786 
d–
 = 
tsc
 - 
t
->
loÿl_tsc_¡amp
;

787 
now
 = 
t
->
¡ime_loÿl_¡amp
 + 
	`sÿË_d–
(
d–
, &t->
tsc_sÿË
);

789  
now
;

790 
	}
}

792 
ušt64_t
 
	$tsc_ticks2ns
(
ušt64_t
 
ticks
)

794 
ıu_time
 *
t
 = &
	`this_ıu
(cpu_time);

796  
	`sÿË_d–
(
ticks
, &
t
->
tsc_sÿË
);

797 
	}
}

800 
	#v”siÚ_upd©e_begš
(
v
è(((v)+1)|1)

	)

801 
	#v”siÚ_upd©e_’d
(
v
è((v)+1)

	)

803 
	$__upd©e_vıu_sy¡em_time
(
vıu
 *
v
, 
fÜû
)

805 
ıu_time
 *
t
;

806 
vıu_time_šfo
 *
u
, 
_u
;

807 
	`XEN_GUEST_HANDLE
(
vıu_time_šfo_t
è
u£r_u
;

808 
domaš
 *
d
 = 
v
->domain;

809 
s_time_t
 
tsc_¡amp
 = 0;

811 iàĞ
v
->
vıu_šfo
 =ğ
NULL
 )

814 
t
 = &
	`this_ıu
(
ıu_time
);

815 
u
 = &
	`vıu_šfo
(
v
, 
time
);

817 iàĞ
d
->
¬ch
.
vtsc
 )

819 
u64
 
¡ime
 = 
t
->
¡ime_loÿl_¡amp
;

820 iàĞ
	`is_hvm_domaš
(
d
) )

822 
¶_time
 *
¶
 = &
v
->
domaš
->
¬ch
.
hvm_domaš
.pl_time;

823 
¡ime
 +ğ
¶
->
¡ime_off£t
 + 
v
->
¬ch
.
hvm_vıu
.stime_offset;

825 
tsc_¡amp
 = 
	`gtime_to_gtsc
(
d
, 
¡ime
);

829 
tsc_¡amp
 = 
t
->
loÿl_tsc_¡amp
;

832 
	`mem£t
(&
_u
, 0, (_u));

834 iàĞ
d
->
¬ch
.
vtsc
 )

836 
_u
.
tsc_time¡amp
 = 
tsc_¡amp
;

837 
_u
.
sy¡em_time
 = 
t
->
¡ime_loÿl_¡amp
;

838 
_u
.
tsc_to_sy¡em_mul
 = 
d
->
¬ch
.
vtsc_to_ns
.
mul_äac
;

839 
_u
.
tsc_shiá
 = 
d
->
¬ch
.
vtsc_to_ns
.
shiá
;

843 
_u
.
tsc_time¡amp
 = 
t
->
loÿl_tsc_¡amp
;

844 
_u
.
sy¡em_time
 = 
t
->
¡ime_loÿl_¡amp
;

845 
_u
.
tsc_to_sy¡em_mul
 = 
t
->
tsc_sÿË
.
mul_äac
;

846 
_u
.
tsc_shiá
 = (
s8
)
t
->
tsc_sÿË
.
shiá
;

848 iàĞ
	`is_hvm_domaš
(
d
) )

849 
_u
.
tsc_time¡amp
 +ğ
v
->
¬ch
.
hvm_vıu
.
ÿche_tsc_off£t
;

852 
_u
.
v”siÚ
 = 
u
->version;

853 iàĞ!
fÜû
 && !
	`memcmp
(
u
, &
_u
, (_u)) )

857 
_u
.
v”siÚ
 = 
u
->v”siÚ = 
	`v”siÚ_upd©e_begš
(u->version);

858 
	`wmb
();

860 *
u
 = 
_u
;

861 
	`wmb
();

863 
u
->
v”siÚ
 = 
	`v”siÚ_upd©e_’d
(u->version);

865 
u£r_u
 = 
v
->
¬ch
.
time_šfo_gue¡
;

866 iàĞ!
	`gue¡_hªdË_is_nuÎ
(
u£r_u
) )

869 
	`__cİy_f›ld_to_gue¡
(
u£r_u
, &
_u
, 
v”siÚ
);

870 
	`wmb
();

872 
	`__cİy_to_gue¡
(
u£r_u
, &
_u
, 1);

873 
	`wmb
();

875 
_u
.
v”siÚ
 = 
	`v”siÚ_upd©e_’d
(_u.version);

876 
	`__cİy_f›ld_to_gue¡
(
u£r_u
, &
_u
, 
v”siÚ
);

878 
	}
}

880 
	$upd©e_vıu_sy¡em_time
(
vıu
 *
v
)

882 
	`__upd©e_vıu_sy¡em_time
(
v
, 0);

883 
	}
}

885 
	$fÜû_upd©e_vıu_sy¡em_time
(
vıu
 *
v
)

887 
	`__upd©e_vıu_sy¡em_time
(
v
, 1);

888 
	}
}

890 
	$upd©e_domaš_w®lşock_time
(
domaš
 *
d
)

892 
ušt32_t
 *
wc_v”siÚ
;

894 
	`¥š_lock
(&
wc_lock
);

896 
wc_v”siÚ
 = &
	`sh¬ed_šfo
(
d
, wc_version);

897 *
wc_v”siÚ
 = 
	`v”siÚ_upd©e_begš
(*wc_version);

898 
	`wmb
();

900 
	`sh¬ed_šfo
(
d
, 
wc_£c
èğwc_£ø+ d->
time_off£t_£cÚds
;

901 
	`sh¬ed_šfo
(
d
, 
wc_n£c
) = wc_nsec;

903 
	`wmb
();

904 *
wc_v”siÚ
 = 
	`v”siÚ_upd©e_’d
(*wc_version);

906 
	`¥š_uÆock
(&
wc_lock
);

907 
	}
}

909 
	$upd©e_domaš_¹c
()

911 
domaš
 *
d
;

913 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

915 
	`fÜ_—ch_domaš
 ( 
d
 )

916 iàĞ
	`is_hvm_domaš
(
d
) )

917 
	`¹c_upd©e_şock
(
d
);

919 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

920 
	}
}

922 
	$domaš_£t_time_off£t
(
domaš
 *
d
, 
št32_t
 
time_off£t_£cÚds
)

924 
d
->
time_off£t_£cÚds
 =ime_offset_seconds;

925 iàĞ
	`is_hvm_domaš
(
d
) )

926 
	`¹c_upd©e_şock
(
d
);

927 
	}
}

929 
	$ıu_äequ’cy_chªge
(
u64
 
äeq
)

931 
ıu_time
 *
t
 = &
	`this_ıu
(cpu_time);

932 
u64
 
cu¼_tsc
;

935 iàĞ
äeq
 < 1000000u )

937 
	`gd´štk
(
XENLOG_WARNING
, "Rejecting CPU frequency change "

938 "tØ%"
PRIu64
" Hz.\n", 
äeq
);

939  -
EINVAL
;

942 
	`loÿl_œq_di§bË
();

944 
t
->
¡ime_ma¡”_¡amp
 = 
	`»ad_¶©fÜm_¡ime
();

947 
t
->
¡ime_loÿl_¡amp
 =->
¡ime_ma¡”_¡amp
;

948 
	`rdtsşl
(
cu¼_tsc
);

949 
t
->
loÿl_tsc_¡amp
 = 
cu¼_tsc
;

950 
	`£t_time_sÿË
(&
t
->
tsc_sÿË
, 
äeq
);

951 
	`loÿl_œq_’abË
();

953 
	`upd©e_vıu_sy¡em_time
(
cu¼’t
);

956 iàĞ
	`smp_´oûssÜ_id
() == 0 )

958 
	`£t_tim”
(&
ÿlib¿tiÚ_tim”
, 
	`NOW
(è+ 
EPOCH
);

959 
	`¶©fÜm_time_ÿlib¿tiÚ
();

963 
	}
}

966 
	$do_£‰ime
(
£cs
, 
n£cs
, 
u64
 
sy¡em_time_ba£
)

968 
u64
 
x
;

969 
u32
 
y
, 
_wc_£c
, 
_wc_n£c
;

970 
domaš
 *
d
;

972 
x
 = (
£cs
 * 1000000000ULLè+ (
u64
)
n£cs
 - 
sy¡em_time_ba£
;

973 
y
 = 
	`do_div
(
x
, 1000000000);

975 
	`¥š_lock
(&
wc_lock
);

976 
wc_£c
 = 
_wc_£c
 = (
u32
)
x
;

977 
wc_n£c
 = 
_wc_n£c
 = (
u32
)
y
;

978 
	`¥š_uÆock
(&
wc_lock
);

980 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

981 
	`fÜ_—ch_domaš
 ( 
d
 )

982 
	`upd©e_domaš_w®lşock_time
(
d
);

983 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

984 
	}
}

987 
	sıu_ÿlib¿tiÚ
 {

988 
u64
 
	mloÿl_tsc_¡amp
;

989 
s_time_t
 
	m¡ime_loÿl_¡amp
;

990 
s_time_t
 
	m¡ime_ma¡”_¡amp
;

992 
DEFINE_PER_CPU
(
ıu_ÿlib¿tiÚ
, cpu_calibration);

995 
	$loÿl_time_ÿlib¿tiÚ
()

997 
ıu_time
 *
t
 = &
	`this_ıu
(cpu_time);

998 
ıu_ÿlib¿tiÚ
 *
c
 = &
	`this_ıu
(cpu_calibration);

1004 
s_time_t
 
´ev_loÿl_¡ime
, 
cu¼_loÿl_¡ime
;

1005 
s_time_t
 
´ev_ma¡”_¡ime
, 
cu¼_ma¡”_¡ime
;

1008 
u64
 
´ev_tsc
, 
cu¼_tsc
;

1014 
u64
 
¡ime_–­£d64
, 
tsc_–­£d64
;

1015 
u32
 
¡ime_–­£d32
, 
tsc_–­£d32
;

1018 
u64
 
loÿl_¡ime_”r
;

1021 
u32
 
”rÜ_çùÜ
 = 0;

1024 
tsc_shiá
 = 0;

1027 
u32
 
ÿlib¿tiÚ_mul_äac
;

1029 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_CONSTANT_TSC
) )

1032 
	`loÿl_œq_di§bË
();

1033 
t
->
loÿl_tsc_¡amp
 = 
c
->local_tsc_stamp;

1034 
t
->
¡ime_loÿl_¡amp
 = 
c
->
¡ime_ma¡”_¡amp
;

1035 
t
->
¡ime_ma¡”_¡amp
 = 
c
->stime_master_stamp;

1036 
	`loÿl_œq_’abË
();

1037 
	`upd©e_vıu_sy¡em_time
(
cu¼’t
);

1038 
out
;

1041 
´ev_tsc
 = 
t
->
loÿl_tsc_¡amp
;

1042 
´ev_loÿl_¡ime
 = 
t
->
¡ime_loÿl_¡amp
;

1043 
´ev_ma¡”_¡ime
 = 
t
->
¡ime_ma¡”_¡amp
;

1046 
	`loÿl_œq_di§bË
();

1047 
cu¼_tsc
 = 
c
->
loÿl_tsc_¡amp
;

1048 
cu¼_loÿl_¡ime
 = 
c
->
¡ime_loÿl_¡amp
;

1049 
cu¼_ma¡”_¡ime
 = 
c
->
¡ime_ma¡”_¡amp
;

1050 
	`loÿl_œq_’abË
();

1053 
	`´štk
("PRE%d:sc=%"
PRIu64
" stime=%"PRIu64" master=%"PRIu64"\n",

1054 
	`smp_´oûssÜ_id
(), 
´ev_tsc
, 
´ev_loÿl_¡ime
, 
´ev_ma¡”_¡ime
);

1055 
	`´štk
("CUR%d:sc=%"
PRIu64
" stime=%"PRIu64" master=%"PRIu64

1056 " -> %"
PRId64
"\n",

1057 
	`smp_´oûssÜ_id
(), 
cu¼_tsc
, 
cu¼_loÿl_¡ime
, 
cu¼_ma¡”_¡ime
,

1058 
cu¼_ma¡”_¡ime
 - 
cu¼_loÿl_¡ime
);

1062 iàĞ
cu¼_loÿl_¡ime
 < 
cu¼_ma¡”_¡ime
 )

1063 
cu¼_loÿl_¡ime
 = 
cu¼_ma¡”_¡ime
;

1065 
¡ime_–­£d64
 = 
cu¼_ma¡”_¡ime
 - 
´ev_ma¡”_¡ime
;

1066 
tsc_–­£d64
 = 
cu¼_tsc
 - 
´ev_tsc
;

1072 iàĞ((
s64
)
¡ime_–­£d64
 < (
EPOCH
 / 2)) )

1073 
out
;

1080 iàĞ
cu¼_loÿl_¡ime
 !ğ
cu¼_ma¡”_¡ime
 )

1082 
loÿl_¡ime_”r
 = 
cu¼_loÿl_¡ime
 - 
cu¼_ma¡”_¡ime
;

1083 iàĞ
loÿl_¡ime_”r
 > 
EPOCH
 )

1084 
loÿl_¡ime_”r
 = 
EPOCH
;

1085 
”rÜ_çùÜ
 = 
	`div_äac
(
EPOCH
, EPOCH + (
u32
)
loÿl_¡ime_”r
);

1093  ((
u32
)
¡ime_–­£d64
 != stime_elapsed64) ||

1094 ((
s32
)
¡ime_–­£d64
 < 0) )

1096 
¡ime_–­£d64
 >>= 1;

1097 
tsc_–­£d64
 >>= 1;

1101 
¡ime_–­£d32
 = (
u32
)
¡ime_–­£d64
;

1104  
tsc_–­£d64
 > (
¡ime_–­£d32
 * 2) )

1106 
tsc_–­£d64
 >>= 1;

1107 
tsc_shiá
--;

1111 
	`ASSERT
((
u32
)
tsc_–­£d64
 ==sc_elapsed64);

1112 
tsc_–­£d32
 = (
u32
)
tsc_–­£d64
;

1115 
	`ASSERT
(
tsc_–­£d32
 != 0);

1116  
tsc_–­£d32
 <ğ
¡ime_–­£d32
 )

1118 
tsc_–­£d32
 <<= 1;

1119 
tsc_shiá
++;

1122 
ÿlib¿tiÚ_mul_äac
 = 
	`div_äac
(
¡ime_–­£d32
, 
tsc_–­£d32
);

1123 iàĞ
”rÜ_çùÜ
 != 0 )

1124 
ÿlib¿tiÚ_mul_äac
 = 
	`mul_äac
(ÿlib¿tiÚ_mul_äac, 
”rÜ_çùÜ
);

1127 
	`´štk
("---%d: %08x %08x %d\n", 
	`smp_´oûssÜ_id
(),

1128 
”rÜ_çùÜ
, 
ÿlib¿tiÚ_mul_äac
, 
tsc_shiá
);

1132 
	`loÿl_œq_di§bË
();

1133 
t
->
tsc_sÿË
.
mul_äac
 = 
ÿlib¿tiÚ_mul_äac
;

1134 
t
->
tsc_sÿË
.
shiá
 = 
tsc_shiá
;

1135 
t
->
loÿl_tsc_¡amp
 = 
cu¼_tsc
;

1136 
t
->
¡ime_loÿl_¡amp
 = 
cu¼_loÿl_¡ime
;

1137 
t
->
¡ime_ma¡”_¡amp
 = 
cu¼_ma¡”_¡ime
;

1138 
	`loÿl_œq_’abË
();

1140 
	`upd©e_vıu_sy¡em_time
(
cu¼’t
);

1142 
out
:

1143 iàĞ
	`smp_´oûssÜ_id
() == 0 )

1145 
	`£t_tim”
(&
ÿlib¿tiÚ_tim”
, 
	`NOW
(è+ 
EPOCH
);

1146 
	`¶©fÜm_time_ÿlib¿tiÚ
();

1148 
	}
}

1158 
	$check_tsc_w¬p
(
tsc_khz
, *
max_w¬p
)

1160 
	#rdtsc_b¬r›r
(è
	`mb
()

	)

1161 
	`DEFINE_SPINLOCK
(
sync_lock
);

1162 
cyşes_t
 
Ï¡_tsc
;

1164 
cyşes_t
 
¡¬t
, 
now
, 
´ev
, 
’d
;

1165 
i
;

1167 
	`rdtsc_b¬r›r
();

1168 
¡¬t
 = 
	`g‘_cyşes
();

1169 
	`rdtsc_b¬r›r
();

1172 
’d
 = 
¡¬t
 + 
tsc_khz
 * 20ULL;

1173 
now
 = 
¡¬t
;

1175  
i
 = 0; ; i++ )

1182 
	`¥š_lock
(&
sync_lock
);

1183 
´ev
 = 
Ï¡_tsc
;

1184 
	`rdtsc_b¬r›r
();

1185 
now
 = 
	`g‘_cyşes
();

1186 
	`rdtsc_b¬r›r
();

1187 
Ï¡_tsc
 = 
now
;

1188 
	`¥š_uÆock
(&
sync_lock
);

1195 iàĞ
	`uÆik–y
(!(
i
 & 7)) )

1197 iàĞ(
now
 > 
’d
è|| (
i
 > 10000000) )

1199 
	`ıu_»Ïx
();

1207 iàĞ
	`uÆik–y
(
´ev
 > 
now
) )

1209 
	`¥š_lock
(&
sync_lock
);

1210 iàĞ*
max_w¬p
 < 
´ev
 - 
now
 )

1211 *
max_w¬p
 = 
´ev
 - 
now
;

1212 
	`¥š_uÆock
(&
sync_lock
);

1215 
	}
}

1217 
	gtsc_max_w¬p
, 
	gtsc_check_couÁ
;

1218 
ıumask_t
 
	gtsc_check_ıumask
 = 
CPU_MASK_NONE
;

1220 
	$tsc_check_¦ave
(*
unu£d
)

1222 
ıu
 = 
	`smp_´oûssÜ_id
();

1223 
	`loÿl_œq_di§bË
();

1224  !
	`ıu_is£t
(
ıu
, 
tsc_check_ıumask
) )

1225 
	`mb
();

1226 
	`check_tsc_w¬p
(
ıu_khz
, &
tsc_max_w¬p
);

1227 
	`ıu_ş—r
(
ıu
, 
tsc_check_ıumask
);

1228 
	`loÿl_œq_’abË
();

1229 
	}
}

1231 
	$tsc_check_»lŸb™y
()

1233 
ıu
 = 
	`smp_´oûssÜ_id
();

1234 
	`DEFINE_SPINLOCK
(
lock
);

1236 
	`¥š_lock
(&
lock
);

1238 
tsc_check_couÁ
++;

1239 
	`smp_ÿÎ_funùiÚ
(
tsc_check_¦ave
, 
NULL
, 0);

1240 
tsc_check_ıumask
 = 
ıu_Úlše_m­
;

1241 
	`loÿl_œq_di§bË
();

1242 
	`check_tsc_w¬p
(
ıu_khz
, &
tsc_max_w¬p
);

1243 
	`ıu_ş—r
(
ıu
, 
tsc_check_ıumask
);

1244 
	`loÿl_œq_’abË
();

1245  !
	`ıus_em±y
(
tsc_check_ıumask
) )

1246 
	`ıu_»Ïx
();

1248 
	`¥š_uÆock
(&
lock
);

1249 
	}
}

1256 
	sÿlib¿tiÚ_»ndezvous
 {

1257 
ıumask_t
 
	mıu_ÿlib¿tiÚ_m­
;

1258 
©omic_t
 
	m£m­hÜe
;

1259 
s_time_t
 
	mma¡”_¡ime
;

1260 
u64
 
	mma¡”_tsc_¡amp
;

1267 
	$time_ÿlib¿tiÚ_tsc_»ndezvous
(*
_r
)

1269 
i
;

1270 
ıu_ÿlib¿tiÚ
 *
c
 = &
	`this_ıu
(cpu_calibration);

1271 
ÿlib¿tiÚ_»ndezvous
 *
r
 = 
_r
;

1272 
tÙ®_ıus
 = 
	`ıus_weight
(
r
->
ıu_ÿlib¿tiÚ_m­
);

1275  
i
 = 4; i >= 0; i-- )

1277 iàĞ
	`smp_´oûssÜ_id
() == 0 )

1279  
	`©omic_»ad
(&
r
->
£m­hÜe
è!ğ(
tÙ®_ıus
 - 1) )

1280 
	`mb
();

1282 iàĞ
r
->
ma¡”_¡ime
 == 0 )

1284 
r
->
ma¡”_¡ime
 = 
	`»ad_¶©fÜm_¡ime
();

1285 
	`rdtsşl
(
r
->
ma¡”_tsc_¡amp
);

1287 
	`©omic_šc
(&
r
->
£m­hÜe
);

1289 iàĞ
i
 == 0 )

1290 
	`wr™e_tsc
(
r
->
ma¡”_tsc_¡amp
);

1292  
	`©omic_»ad
(&
r
->
£m­hÜe
è!ğ(2*
tÙ®_ıus
 - 1) )

1293 
	`mb
();

1294 
	`©omic_£t
(&
r
->
£m­hÜe
, 0);

1298 
	`©omic_šc
(&
r
->
£m­hÜe
);

1299  
	`©omic_»ad
(&
r
->
£m­hÜe
è< 
tÙ®_ıus
 )

1300 
	`mb
();

1302 iàĞ
i
 == 0 )

1303 
	`wr™e_tsc
(
r
->
ma¡”_tsc_¡amp
);

1305 
	`©omic_šc
(&
r
->
£m­hÜe
);

1306  
	`©omic_»ad
(&
r
->
£m­hÜe
è> 
tÙ®_ıus
 )

1307 
	`mb
();

1311 
	`rdtsşl
(
c
->
loÿl_tsc_¡amp
);

1312 
c
->
¡ime_loÿl_¡amp
 = 
	`g‘_s_time
();

1313 
c
->
¡ime_ma¡”_¡amp
 = 
r
->
ma¡”_¡ime
;

1315 
	`¿i£_soáœq
(
TIME_CALIBRATE_SOFTIRQ
);

1316 
	}
}

1319 
	$time_ÿlib¿tiÚ_¡d_»ndezvous
(*
_r
)

1321 
ıu_ÿlib¿tiÚ
 *
c
 = &
	`this_ıu
(cpu_calibration);

1322 
ÿlib¿tiÚ_»ndezvous
 *
r
 = 
_r
;

1323 
tÙ®_ıus
 = 
	`ıus_weight
(
r
->
ıu_ÿlib¿tiÚ_m­
);

1325 iàĞ
	`smp_´oûssÜ_id
() == 0 )

1327  
	`©omic_»ad
(&
r
->
£m­hÜe
è!ğ(
tÙ®_ıus
 - 1) )

1328 
	`ıu_»Ïx
();

1329 
r
->
ma¡”_¡ime
 = 
	`»ad_¶©fÜm_¡ime
();

1330 
	`mb
();

1331 
	`©omic_šc
(&
r
->
£m­hÜe
);

1335 
	`©omic_šc
(&
r
->
£m­hÜe
);

1336  
	`©omic_»ad
(&
r
->
£m­hÜe
è!ğ
tÙ®_ıus
 )

1337 
	`ıu_»Ïx
();

1338 
	`mb
();

1341 
	`rdtsşl
(
c
->
loÿl_tsc_¡amp
);

1342 
c
->
¡ime_loÿl_¡amp
 = 
	`g‘_s_time
();

1343 
c
->
¡ime_ma¡”_¡amp
 = 
r
->
ma¡”_¡ime
;

1345 
	`¿i£_soáœq
(
TIME_CALIBRATE_SOFTIRQ
);

1346 
	}
}

1348 (*
time_ÿlib¿tiÚ_»ndezvous_â
)(*) =

1349 
time_ÿlib¿tiÚ_¡d_»ndezvous
;

1351 
	$time_ÿlib¿tiÚ
(*
unu£d
)

1353 
ÿlib¿tiÚ_»ndezvous
 
r
 = {

1354 .
ıu_ÿlib¿tiÚ_m­
 = 
ıu_Úlše_m­
,

1355 .
£m­hÜe
 = 
	`ATOMIC_INIT
(0)

1359 
	`Ú_£Ëùed_ıus
(&
r
.
ıu_ÿlib¿tiÚ_m­
,

1360 
time_ÿlib¿tiÚ_»ndezvous_â
,

1361 &
r
, 1);

1362 
	}
}

1364 
	$š™_³rıu_time
()

1366 
ıu_time
 *
t
 = &
	`this_ıu
(cpu_time);

1367 
æags
;

1368 
s_time_t
 
now
;

1371 
	`this_ıu
(
ıu_time
).
tsc_sÿË
 = 
	`³r_ıu
(cpu_time, 0).tsc_scale;

1373 
	`loÿl_œq_§ve
(
æags
);

1374 
	`rdtsşl
(
t
->
loÿl_tsc_¡amp
);

1375 
now
 = 
	`»ad_¶©fÜm_¡ime
();

1376 
	`loÿl_œq_»¡Üe
(
æags
);

1378 
t
->
¡ime_ma¡”_¡amp
 = 
now
;

1379 
t
->
¡ime_loÿl_¡amp
 = 
now
;

1381 iàĞ
	`smp_´oûssÜ_id
() == 0 )

1383 
	`š™_tim”
(&
ÿlib¿tiÚ_tim”
, 
time_ÿlib¿tiÚ
, 
NULL
, 0);

1384 
	`£t_tim”
(&
ÿlib¿tiÚ_tim”
, 
	`NOW
(è+ 
EPOCH
);

1386 
	}
}

1396 
__š™
 
	$tsc_check_wr™ab™y
()

1398 cÚ¡ *
wh©
 = 
NULL
;

1399 
ušt64_t
 
tsc
;

1406 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) )

1409 
	`rdtsşl
(
tsc
);

1410 iàĞ
	`wrm¤_§ã
(
MSR_IA32_TSC
, 0) == 0 )

1412 
ušt64_t
 
tmp
, 
tmp2
;

1413 
	`rdtsşl
(
tmp2
);

1414 
	`wr™e_tsc
(
tsc
 | (1ULL << 32));

1415 
	`rdtsşl
(
tmp
);

1416 iàĞ
	`ABS
((
s64
)
tmp
 - (s64)
tmp2
) < (1LL << 31) )

1417 
wh©
 = "only…artially";

1421 
wh©
 = "not";

1425 iàĞ!
wh©
 )

1431 
	`wr™e_tsc
(
tsc
);

1435 
	`´štk
(
XENLOG_WARNING
 "TSC % wr™abË\n", 
wh©
);

1438 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_CONSTANT_TSC
);

1441 iàĞ!
	`boÙ_ıu_has
(
X86_FEATURE_NONSTOP_TSC
) )

1442 
	`ıuidË_di§bË_d“p_c¡©e
();

1445 
di§bË_tsc_sync
 = 1;

1446 
	}
}

1449 
__š™
 
	$š™_x’_time
()

1451 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) )

1459 
	`tsc_check_»lŸb™y
();

1460 iàĞ
tsc_max_w¬p
 )

1461 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_TSC_RELIABLE
);

1464 
	`tsc_check_wr™ab™y
();

1467 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_CONSTANT_TSC
) )

1470 iàĞ!
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) )

1471 
time_ÿlib¿tiÚ_»ndezvous_â
 = 
time_ÿlib¿tiÚ_tsc_»ndezvous
;

1474 
	`İ’_soáœq
(
TIME_CALIBRATE_SOFTIRQ
, 
loÿl_time_ÿlib¿tiÚ
);

1477 
	`rdtsşl
(
	`this_ıu
(
ıu_time
).
loÿl_tsc_¡amp
);

1480 
	`do_£‰ime
(
	`g‘_cmos_time
(), 0, 
	`NOW
());

1482 
	`š™_¶©fÜm_tim”
();

1484 
	`š™_³rıu_time
();

1487 
	}
}

1491 
__š™
 
	$—¾y_time_š™
()

1493 
u64
 
tmp
 = 
	`š™_p™_ªd_ÿlib¿‹_tsc
();

1495 
	`£t_time_sÿË
(&
	`this_ıu
(
ıu_time
).
tsc_sÿË
, 
tmp
);

1497 
	`do_div
(
tmp
, 1000);

1498 
ıu_khz
 = ()
tmp
;

1499 
	`´štk
("Detected %lu.%03lu MHz…rocessor.\n",

1500 
ıu_khz
 / 1000, cpu_khz % 1000);

1502 
	`£tup_œq
(0, &
œq0
);

1503 
	}
}

1506 
	$di§bË_p™_œq
()

1508 iàĞ
usšg_p™
 || !
ıu_has_­ic
 )

1517 iàĞ
	`ıuidË_usšg_d“p_c¡©e
(è&& !
	`boÙ_ıu_has
(
X86_FEATURE_ARAT
) )

1519 
	`h³t_brßdÿ¡_š™
();

1520 iàĞ!
	`h³t_brßdÿ¡_is_avaabË
() )

1522 iàĞ
x’_ıuidË
 == -1 )

1524 
x’_ıuidË
 = 0;

1525 
	`´štk
("CPUIDLE: disabled dueo‚o HPET. "

1530 
	`´štk
("HPET broadcast init failed,urno PIT broadcast.\n");

1537 
	`outb_p
(0x30, 
PIT_MODE
);

1538 
	`outb_p
(0, 
PIT_CH0
);

1539 
	`outb_p
(0, 
PIT_CH0
);

1542 
	}
}

1543 
__š™ÿÎ
(
di§bË_p™_œq
);

1545 
	$p™_brßdÿ¡_’‹r
()

1547 
	`ıu_£t
(
	`smp_´oûssÜ_id
(), 
p™_brßdÿ¡_mask
);

1548 
	}
}

1550 
	$p™_brßdÿ¡_ex™
()

1552 
ıu
 = 
	`smp_´oûssÜ_id
();

1554 iàĞ
	`ıu_‹¡_ªd_ş—r
(
ıu
, 
p™_brßdÿ¡_mask
) )

1555 
	`»´og¿m_tim”
(
	`this_ıu
(
tim”_d—dlše
));

1556 
	}
}

1558 
	$p™_brßdÿ¡_is_avaabË
()

1560  
x’_ıuidË
;

1561 
	}
}

1563 
	$£nd_tim”_ev’t
(
vıu
 *
v
)

1565 
	`£nd_gue¡_vıu_vœq
(
v
, 
VIRQ_TIMER
);

1566 
	}
}

1569 
	$g‘_loÿÉime
(
domaš
 *
d
)

1571  
wc_£c
 + (
wc_n£c
 + 
	`NOW
()) / 1000000000ULL

1572 + 
d
->
time_off£t_£cÚds
;

1573 
	}
}

1575 
	$g‘_£c
()

1577  
wc_£c
 + (
wc_n£c
 + 
	`NOW
()) / 1000000000ULL;

1578 
	}
}

1581 
	gcmos_utc_off£t
;

1583 
	$time_su¥’d
()

1585 iàĞ
	`smp_´oûssÜ_id
() == 0 )

1587 
cmos_utc_off£t
 = -
	`g‘_cmos_time
();

1588 
cmos_utc_off£t
 +ğ(
wc_£c
 + (
wc_n£c
 + 
	`NOW
()) / 1000000000ULL);

1589 
	`kl_tim”
(&
ÿlib¿tiÚ_tim”
);

1592 
	`¶©fÜm_time_ÿlib¿tiÚ
();

1596 
	`ş—r_b™
(
TIME_CALIBRATE_SOFTIRQ
, &
	`soáœq_³ndšg
(
	`smp_´oûssÜ_id
()));

1599 
	}
}

1601 
	$time_»sume
()

1603 
	`š™_p™_ªd_ÿlib¿‹_tsc
();

1605 
	`»sume_¶©fÜm_tim”
();

1607 
	`di§bË_p™_œq
();

1609 
	`š™_³rıu_time
();

1611 
	`do_£‰ime
(
	`g‘_cmos_time
(è+ 
cmos_utc_off£t
, 0, 
	`NOW
());

1613 
	`upd©e_vıu_sy¡em_time
(
cu¼’t
);

1615 
	`upd©e_domaš_¹c
();

1618 
	}
}

1620 
	$dom0_p™_acûss
(
iÜeq
 *ioreq)

1623 iàĞ
usšg_p™
 )

1626  
iÜeq
->
addr
 )

1628 
PIT_CH2
:

1629 iàĞ
iÜeq
->
dœ
 =ğ
IOREQ_READ
 )

1630 
iÜeq
->
d©a
 = 
	`šb
(
PIT_CH2
);

1632 
	`outb
(
iÜeq
->
d©a
, 
PIT_CH2
);

1635 
PIT_MODE
:

1636 iàĞ
iÜeq
->
dœ
 =ğ
IOREQ_READ
 )

1638  
iÜeq
->
d©a
 & 0xc0 )

1641 iàĞ
iÜeq
->
d©a
 & 0x08 )

1642 
	`outb
(
iÜeq
->
d©a
 & 0xf8, 
PIT_MODE
);

1643 iàĞ!(
iÜeq
->
d©a
 & 0x06) )

1646 
iÜeq
->
d©a
 &= ~0x09;

1649 
	`outb
(
iÜeq
->
d©a
, 
PIT_MODE
);

1654 iàĞ
iÜeq
->
dœ
 =ğ
IOREQ_READ
 )

1655 
iÜeq
->
d©a
 = 
	`šb
(0x61);

1657 
	`outb
((
	`šb
(0x61è& ~3è| (
iÜeq
->
d©a
 & 3), 0x61);

1662 
	}
}

1664 
tm
 
	$w®lşock_time
()

1666 
ušt64_t
 
£cÚds
;

1668 iàĞ!
wc_£c
 )

1669  (
tm
) { 0 };

1671 
£cÚds
 = 
	`NOW
(è+ (
wc_£c
 * 1000000000uÎè+ 
wc_n£c
;

1672 
	`do_div
(
£cÚds
, 1000000000);

1673  
	`gmtime
(
£cÚds
);

1674 
	}
}

1684 
__š™
 
	$tsc_·r£
(cÚ¡ *
s
)

1686 iàĞ!
	`¡rcmp
(
s
, "unstable") )

1688 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_CONSTANT_TSC
);

1689 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_NONSTOP_TSC
);

1690 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_TSC_RELIABLE
);

1692 iàĞ!
	`¡rcmp
(
s
, "skewed") )

1694 
	`£tup_ş—r_ıu_ÿp
(
X86_FEATURE_TSC_RELIABLE
);

1696 
	}
}

1697 
cu¡om_·¿m
("tsc", 
tsc_·r£
);

1699 
u64
 
	$gtime_to_gtsc
(
domaš
 *
d
, 
u64
 
time
)

1701 iàĞ!
	`is_hvm_domaš
(
d
) )

1702 
time
 = 
	`max_t
(
s64
,im- 
d
->
¬ch
.
vtsc_off£t
, 0);

1703  
	`sÿË_d–
(
time
, &
d
->
¬ch
.
ns_to_vtsc
);

1704 
	}
}

1706 
u64
 
	$gtsc_to_gtime
(
domaš
 *
d
, 
u64
 
tsc
)

1708 
u64
 
time
 = 
	`sÿË_d–
(
tsc
, &
d
->
¬ch
.
vtsc_to_ns
);

1710 iàĞ!
	`is_hvm_domaš
(
d
) )

1711 
time
 +ğ
d
->
¬ch
.
vtsc_off£t
;

1712  
time
;

1713 
	}
}

1715 
	$pv_soá_rdtsc
(
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
, 
rdtsı
)

1717 
s_time_t
 
now
 = 
	`g‘_s_time
();

1718 
domaš
 *
d
 = 
v
->domain;

1720 
	`¥š_lock
(&
d
->
¬ch
.
vtsc_lock
);

1722 iàĞ
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

1723 
d
->
¬ch
.
vtsc_k”ncouÁ
++;

1725 
d
->
¬ch
.
vtsc_u£rcouÁ
++;

1727 iàĞ(
št64_t
)(
now
 - 
d
->
¬ch
.
vtsc_Ï¡
) > 0 )

1728 
d
->
¬ch
.
vtsc_Ï¡
 = 
now
;

1730 
now
 = ++
d
->
¬ch
.
vtsc_Ï¡
;

1732 
	`¥š_uÆock
(&
d
->
¬ch
.
vtsc_lock
);

1734 
now
 = 
	`gtime_to_gtsc
(
d
,‚ow);

1736 
»gs
->
—x
 = (
ušt32_t
)
now
;

1737 
»gs
->
edx
 = (
ušt32_t
)(
now
 >> 32);

1739 iàĞ
rdtsı
 )

1740 
»gs
->
ecx
 =

1741 (
d
->
¬ch
.
tsc_mode
 =ğ
TSC_MODE_PVRDTSCP
è? d->¬ch.
šÿº©iÚ
 : 0;

1742 
	}
}

1744 
	$ho¡_tsc_is_§ã
()

1746  
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
);

1747 
	}
}

1749 
	$ıuid_time_Ëaf
(
ušt32_t
 
sub_idx
, ušt32_ˆ*
—x
, ušt32_ˆ*
ebx
,

1750 
ušt32_t
 *
ecx
, ušt32_ˆ*
edx
)

1752 
domaš
 *
d
 = 
cu¼’t
->domain;

1753 
ušt64_t
 
off£t
;

1755  
sub_idx
 )

1758 *
—x
 = ( ( (!!
d
->
¬ch
.
vtsc
) << 0 ) |

1759 Ğ(!!
	`ho¡_tsc_is_§ã
()) << 1 ) |

1760 Ğ(!!
	`boÙ_ıu_has
(
X86_FEATURE_RDTSCP
)) << 2 ) |

1762 *
ebx
 = 
d
->
¬ch
.
tsc_mode
;

1763 *
ecx
 = 
d
->
¬ch
.
tsc_khz
;

1764 *
edx
 = 
d
->
¬ch
.
šÿº©iÚ
;

1767 iàĞ!
d
->
¬ch
.
vtsc
 )

1768 
off£t
 = 
d
->
¬ch
.
vtsc_off£t
;

1771 
off£t
 = 0;

1772 *
—x
 = (
ušt32_t
)
off£t
;

1773 *
ebx
 = (
ušt32_t
)(
off£t
 >> 32);

1774 *
ecx
 = 
d
->
¬ch
.
vtsc_to_ns
.
mul_äac
;

1775 *
edx
 = (
s8
)
d
->
¬ch
.
vtsc_to_ns
.
shiá
;

1778 *
—x
 = 
ıu_khz
;

1779 *
ebx
 = *
ecx
 = *
edx
 = 0;

1782 *
—x
 = *
ebx
 = *
ecx
 = *
edx
 = 0;

1784 
	}
}

1790 
	$tsc_g‘_šfo
(
domaš
 *
d
, 
ušt32_t
 *
tsc_mode
,

1791 
ušt64_t
 *
–­£d_n£c
, 
ušt32_t
 *
gtsc_khz
,

1792 
ušt32_t
 *
šÿº©iÚ
)

1794 *
šÿº©iÚ
 = 
d
->
¬ch
.incarnation;

1795 *
tsc_mode
 = 
d
->
¬ch
.tsc_mode;

1797  *
tsc_mode
 )

1799 
TSC_MODE_NEVER_EMULATE
:

1800 *
–­£d_n£c
 = *
gtsc_khz
 = 0;

1802 
TSC_MODE_ALWAYS_EMULATE
:

1803 *
–­£d_n£c
 = 
	`g‘_s_time
(è- 
d
->
¬ch
.
vtsc_off£t
;

1804 *
gtsc_khz
 = 
d
->
¬ch
.
tsc_khz
;

1806 
TSC_MODE_DEFAULT
:

1807 iàĞ
d
->
¬ch
.
vtsc
 )

1809 *
–­£d_n£c
 = 
	`g‘_s_time
(è- 
d
->
¬ch
.
vtsc_off£t
;

1810 *
gtsc_khz
 = 
d
->
¬ch
.
tsc_khz
;

1814 
ušt64_t
 
tsc
 = 0;

1815 
	`rdtsşl
(
tsc
);

1816 *
–­£d_n£c
 = 
	`sÿË_d–
(
tsc
,&
d
->
¬ch
.
vtsc_to_ns
);

1817 *
gtsc_khz
 = 
ıu_khz
;

1820 
TSC_MODE_PVRDTSCP
:

1821 iàĞ
d
->
¬ch
.
vtsc
 )

1823 *
–­£d_n£c
 = 
	`g‘_s_time
(è- 
d
->
¬ch
.
vtsc_off£t
;

1824 *
gtsc_khz
 = 
ıu_khz
;

1828 
ušt64_t
 
tsc
 = 0;

1829 
	`rdtsşl
(
tsc
);

1830 *
–­£d_n£c
 = (
	`sÿË_d–
(
tsc
,&
d
->
¬ch
.
vtsc_to_ns
) -

1831 
d
->
¬ch
.
vtsc_off£t
);

1832 *
gtsc_khz
 = 0;

1837 iàĞ(
št64_t
)*
–­£d_n£c
 < 0 )

1838 *
–­£d_n£c
 = 0;

1839 
	}
}

1849 
	$tsc_£t_šfo
(
domaš
 *
d
,

1850 
ušt32_t
 
tsc_mode
, 
ušt64_t
 
–­£d_n£c
,

1851 
ušt32_t
 
gtsc_khz
, ušt32_ˆ
šÿº©iÚ
)

1853 iàĞ
	`is_idË_domaš
(
d
è|| (d->
domaš_id
 == 0) )

1855 
d
->
¬ch
.
vtsc
 = 0;

1859  
d
->
¬ch
.
tsc_mode
 =sc_mode )

1861 
TSC_MODE_NEVER_EMULATE
:

1862 
d
->
¬ch
.
vtsc
 = 0;

1864 
TSC_MODE_ALWAYS_EMULATE
:

1865 
d
->
¬ch
.
vtsc
 = 1;

1866 
d
->
¬ch
.
vtsc_off£t
 = 
	`g‘_s_time
(è- 
–­£d_n£c
;

1867 
d
->
¬ch
.
tsc_khz
 = 
gtsc_khz
 ? gtsc_khz : 
ıu_khz
;

1868 
	`£t_time_sÿË
(&
d
->
¬ch
.
vtsc_to_ns
, d->¬ch.
tsc_khz
 * 1000 );

1869 
d
->
¬ch
.
ns_to_vtsc
 = 
	`sÿË_»croÿl
(d->¬ch.
vtsc_to_ns
);

1871 
TSC_MODE_DEFAULT
:

1872 
d
->
¬ch
.
vtsc
 = 1;

1873 
d
->
¬ch
.
vtsc_off£t
 = 
	`g‘_s_time
(è- 
–­£d_n£c
;

1874 
d
->
¬ch
.
tsc_khz
 = 
gtsc_khz
 ? gtsc_khz : 
ıu_khz
;

1875 
	`£t_time_sÿË
(&
d
->
¬ch
.
vtsc_to_ns
, d->¬ch.
tsc_khz
 * 1000 );

1878 iàĞ
	`ho¡_tsc_is_§ã
(è&& 
šÿº©iÚ
 == 0 &&

1879 
d
->
¬ch
.
tsc_khz
 =ğ
ıu_khz
 )

1880 
d
->
¬ch
.
vtsc
 = 0;

1882 
d
->
¬ch
.
ns_to_vtsc
 = 
	`sÿË_»croÿl
(d->¬ch.
vtsc_to_ns
);

1884 
TSC_MODE_PVRDTSCP
:

1885 
d
->
¬ch
.
vtsc
 = 
	`boÙ_ıu_has
(
X86_FEATURE_RDTSCP
) &&

1886 
	`ho¡_tsc_is_§ã
() ? 0 : 1;

1887 
d
->
¬ch
.
tsc_khz
 = 
ıu_khz
;

1888 
	`£t_time_sÿË
(&
d
->
¬ch
.
vtsc_to_ns
, d->¬ch.
tsc_khz
 * 1000 );

1889 
d
->
¬ch
.
ns_to_vtsc
 = 
	`sÿË_»croÿl
(d->¬ch.
vtsc_to_ns
);

1890 iàĞ
d
->
¬ch
.
vtsc
 )

1891 
d
->
¬ch
.
vtsc_off£t
 = 
	`g‘_s_time
(è- 
–­£d_n£c
;

1895 
ušt64_t
 
tsc
 = 0;

1896 
	`rdtsşl
(
tsc
);

1897 
d
->
¬ch
.
vtsc_off£t
 = 
	`sÿË_d–
(
tsc
,&d->¬ch.
vtsc_to_ns
) -

1898 
–­£d_n£c
;

1902 
d
->
¬ch
.
šÿº©iÚ
 = incarnation + 1;

1903 iàĞ
	`is_hvm_domaš
(
d
) )

1904 
	`hvm_£t_rdtsc_ex™šg
(
d
, d->
¬ch
.
vtsc
);

1905 
	}
}

1908 
	$dump_soátsc
(
key
)

1910 
domaš
 *
d
;

1911 
domút
 = 0;

1913 
	`tsc_check_»lŸb™y
();

1914 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_TSC_RELIABLE
) )

1915 
	`´štk
("TSC marked‡s„eliable, "

1916 "w¬°ğ%lu (couÁ=%lu)\n", 
tsc_max_w¬p
, 
tsc_check_couÁ
);

1917 iàĞ
	`boÙ_ıu_has
(
X86_FEATURE_CONSTANT_TSC
 ) )

1919 
	`´štk
("TSC has constant„ate, ");

1920 ià(
max_c¡©e
 <ğ2 && 
tsc_max_w¬p
 == 0)

1921 
	`´štk
("no deep Cstates,…assed warpest, deemed„eliable, ");

1923 
	`´štk
("deep Cstates…ossible, so‚ot„eliable, ");

1924 
	`´štk
("w¬p=%lu (couÁ=%lu)\n", 
tsc_max_w¬p
, 
tsc_check_couÁ
);

1926 
	`´štk
("TSC‚ot marked‡sƒither constant or„eliable, "

1927 "w¬p=%lu (couÁ=%lu)\n", 
tsc_max_w¬p
, 
tsc_check_couÁ
);

1928 
	`fÜ_—ch_domaš
 ( 
d
 )

1930 iàĞ
d
->
domaš_id
 =ğ0 && d->
¬ch
.
tsc_mode
 =ğ
TSC_MODE_DEFAULT
 )

1932 
	`´štk
("dom%u%s: mode=%d",
d
->
domaš_id
,

1933 
	`is_hvm_domaš
(
d
è? "(hvm)" : "", d->
¬ch
.
tsc_mode
);

1934 iàĞ
d
->
¬ch
.
vtsc_off£t
 )

1935 
	`´štk
(",ofs=0x%"
PRIx64
"",
d
->
¬ch
.
vtsc_off£t
);

1936 iàĞ
d
->
¬ch
.
tsc_khz
 )

1937 
	`´štk
(",khz=%"
PRIu32
"",
d
->
¬ch
.
tsc_khz
);

1938 iàĞ
d
->
¬ch
.
šÿº©iÚ
 )

1939 
	`´štk
(",šc=%"
PRIu32
"",
d
->
¬ch
.
šÿº©iÚ
);

1940 iàĞ!(
d
->
¬ch
.
vtsc_k”ncouÁ
 | d->¬ch.
vtsc_u£rcouÁ
) )

1942 
	`´štk
("\n");

1945 iàĞ
	`is_hvm_domaš
(
d
) )

1946 
	`´štk
(",vtsøcouÁ: %"
PRIu64
"otal\n",

1947 
d
->
¬ch
.
vtsc_k”ncouÁ
);

1949 
	`´štk
(",vtsøcouÁ: %"
PRIu64
" kernel, %"PRIu64" user\n",

1950 
d
->
¬ch
.
vtsc_k”ncouÁ
, d->¬ch.
vtsc_u£rcouÁ
);

1951 
domút
++;

1954 iàĞ!
domút
 )

1955 
	`´štk
("No domains haveƒmulated TSC\n");

1956 
	}
}

1958 
keyhªdËr
 
	gdump_soátsc_keyhªdËr
 = {

1959 .
dŸgno¡ic
 = 1,

1960 .
	gu
.
	gâ
 = 
dump_soátsc
,

1961 .
	gdesc
 = "dump softtsc stats"

1964 
__š™
 
	$£tup_dump_soátsc
()

1966 
	`»gi¡”_keyhªdËr
('s', &
dump_soátsc_keyhªdËr
);

1968 
	}
}

1969 
__š™ÿÎ
(
£tup_dump_soátsc
);

	@timestamp.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_TIMESTAMP


26 
DEFINE_PER_CPU
(
time¡amp_t
, 
time¡amp
);

28 
	$š™_time¡amp
(
time¡amp_t
 *
time¡amp
)

30 
i
, 
j
;

31 
i
=0;i<
MAX_TIMESTAMP_ID
;i++) {

32 
time¡amp
->
runs
[
i
] =ime¡amp->
unfšished
[i] = 0;

33 
j
=0;j<
MAX_TIMESTAMP_LOC
;j++) {

34 
time¡amp
->
time
[
i
][
j
] =ime¡amp->
sum
[i][j] = 0;

35 
time¡amp
->
couÁ
[
i
][
j
] = 0;

38 
	}
}

40 
	$_time¡amp
(
time¡amp_t
 *
ts
, 
id
, 
loc
)

42 
	`MYASSERT
(
loc
 > 0 &&†oø< 
MAX_TIMESTAMP_LOC
 );

43 
	`MYASSERT
(
id
 >ğ0 && id < 
MAX_TIMESTAMP_ID
 );

44 #ifdeà
ENABLE_TIMESTAMP_CYCLE


45 
	`rdtsşl
(
ts
->
time
[
id
][
loc
]);

48 
ts
->
time
[
id
][
loc
] = 
	`NOW
();

50 
	}
}

52 
	$_time¡amp_¡¬t
(
time¡amp_t
 *
ts
, 
id
)

54 
i
;

55 ià(
ts
->
time
[
id
][0]) {

56 
ts
->
unfšished
[
id
]++;

58 
ts
->
runs
[
id
]++;

59 
i
=1;i<
MAX_TIMESTAMP_LOC
;i++) {

60 
ts
->
time
[
id
][
i
] = 0;

62 #ifdeà
ENABLE_TIMESTAMP_CYCLE


63 
	`rdtsşl
(
ts
->
time
[
id
][0]);

65 
ts
->
time
[
id
][0] = 
	`NOW
();

67 
	}
}

69 
	$_time¡amp_’d
(
time¡amp_t
 *
ts
, 
id
, 
loc
)

71 
i
;

72 
s_time_t
 
¡¬t
 = 
ts
->
time
[
id
][0];

73 
i
=0;i<
MAX_TIMESTAMP_LOC
;i++) {

74 ià(
i
>=
loc
 && 
ts
->
time
[
id
][i])

75 
	`my·nic
("bug\n");

76 ià(
i
<
loc
 && 
ts
->
time
[
id
][i] == 0) {

78 
ts
->
time
[
id
][0] = 0;

82 
i
=1;i<
loc
;i++) {

83 
s_time_t
 
diff
;

84 
	`MYASSERT
(
ts
->
time
[
id
][
i
] >=s->time[id][i-1]);

85 
diff
 = 
ts
->
time
[
id
][
i
] - 
¡¬t
;

86 
ts
->
sum
[
id
][
i
] +ğ
diff
;

87 
ts
->
couÁ
[
id
][
i
]++;

88 
ts
->
time
[
id
][
i
] = 0;

93 
ts
->
time
[
id
][0] = 0;

94 
	}
}

95 
šlše
 
	$time¡amp
(
id
, 
loc
) {

96 
	`_time¡amp
(&
	`this_ıu
(
time¡amp
), 
id
, 
loc
);

97 
	}
}

98 
šlše
 
	$time¡amp_¡¬t
(
id
) {

99 
	`_time¡amp_¡¬t
(&
	`this_ıu
(
time¡amp
), 
id
);

100 
	}
}

101 
šlše
 
	$time¡amp_’d
(
id
, 
loc
) {

102 
	`_time¡amp_’d
(&
	`this_ıu
(
time¡amp
), 
id
, 
loc
);

103 
	}
}

105 
šlše
 
	$vtime¡amp
(
id
, 
loc
) {

106 
	`_time¡amp
(&
cu¼’t
->
time¡amp
, 
id
, 
loc
);

107 
	}
}

108 
šlše
 
	$vtime¡amp_¡¬t
(
id
) {

109 
	`_time¡amp_¡¬t
(&
cu¼’t
->
time¡amp
, 
id
);

110 
	}
}

111 
šlše
 
	$vtime¡amp_’d
(
id
, 
loc
) {

112 
	`_time¡amp_’d
(&
cu¼’t
->
time¡amp
, 
id
, 
loc
);

113 
	}
}

118 
	$_´št_time¡amp
(
time¡amp_t
 *
ts
, *
s
)

120 
i
, 
id
;

122 
id
=0;id<
MAX_TIMESTAMP_ID
;id++) {

123 ià(
ts
->
runs
[
id
] == 0)

125 
	`my´štk
("% [%s]„uns:%d (ha unfi:%d)\n",
s
, 
time¡amp_Çme
[
id
], 
ts
->
runs
[id],s->
unfšished
[id]);

126 
i
=0;i<
MAX_TIMESTAMP_LOC
;i++) {

127 ià(
ts
->
sum
[
id
][
i
] == 0)

129 #ifdeà
ENABLE_TIMESTAMP_CYCLE


130 
	#TIMESTAMP_UNIT
 "Kcyşe"

	)

132 
	#TIMESTAMP_UNIT
 "us"

	)

134 
	`my´štk
("%2d: %Îd " 
TIMESTAMP_UNIT
 " / %d = ", 
i
, 
ts
->
sum
[
id
][i]/1000ULL ,s->
couÁ
[id][i] );

135 ià(
ts
->
couÁ
[
id
][
i
]) {

136 
	`´štk
("%Îd\n", (
ts
->
sum
[
id
][
i
]/ts->
couÁ
[id][i])/1000ULL );

138 
	`´štk
("Nan\n");

142 
	}
}

143 
	$´št_time¡amp
()

145 
i
,
j
;

146 
	`my´štk
("---imestamp ---\n");

147 
‹mp
[32];

148 
j
=0;j<
max_´oc
;j++) {

149 
	`¢´štf
(
‹mp
, 32, "P%d", 
j
);

150 
	`_´št_time¡amp
(&
	`³r_ıu
(
time¡amp
, 
j
), 
‹mp
);

153 
vıu
 *
v
;

154 
domaš
 *
d
;

155 
	`rcu_»ad_lock
(&
domli¡_»ad_lock
);

156 
	`fÜ_—ch_domaš_vıu
(
d
,
v
) {

157 
	`¢´štf
(
‹mp
, 32, "d%dv%d", 
d
->
domaš_id
, 
v
->
vıu_id
);

158 
	`_´št_time¡amp
(&
v
->
time¡amp
, 
‹mp
);

160 
	`rcu_»ad_uÆock
(&
domli¡_»ad_lock
);

161 
	}
}

	@trace.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/š™.h
>

3 
	~<x’/k”Ãl.h
>

4 
	~<x’/lib.h
>

5 
	~<x’/domaš.h
>

6 
	~<x’/sched.h
>

7 
	~<x’/Œaû.h
>

9 #iâdeà
__x86_64__


10 #undeà
TRC_64_FLAG


11 
	#TRC_64_FLAG
 0

	)

14 
asmlškage
 
	$Œaû_hy³rÿÎ
()

16 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

18 #ifdeà
__x86_64__


19 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

22 
u32
 
e
,
—x
;

23 } 
	`__©Œibu‹__
((
·cked
)è
d
;

25 
d
.
e
 = 
»gs
->eip;

26 
d
.
—x
 = 
»gs
->eax;

28 
	`__Œaû_v¬
(
TRC_PV_HYPERCALL
, 1, (
d
), &d);

34 
e
;

35 
u32
 
—x
;

36 } 
	`__©Œibu‹__
((
·cked
)è
d
;

37 
u32
 
ev’t
;

39 
ev’t
 = 
TRC_PV_HYPERCALL
;

40 
ev’t
 |ğ
TRC_64_FLAG
;

41 
d
.
e
 = 
»gs
->eip;

42 
d
.
—x
 = 
»gs
->eax;

44 
	`__Œaû_v¬
(
ev’t
, 1 , (
d
), &d);

46 
	}
}

48 
	$__Œaû_pv_Œ­
(
Œ­Ä
, 
e
,

49 
u£_”rÜ_code
, 
”rÜ_code
)

51 #ifdeà
__x86_64__


52 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

55 
e
:32,

56 
Œ­Ä
:15,

57 
u£_”rÜ_code
:1,

58 
”rÜ_code
:16;

59 } 
	`__©Œibu‹__
((
·cked
)è
d
;

61 
d
.
e
 =ƒip;

62 
d
.
Œ­Ä
 =rapnr;

63 
d
.
”rÜ_code
 =ƒrror_code;

64 
d
.
u£_”rÜ_code
=!!use_error_code;

66 
	`__Œaû_v¬
(
TRC_PV_TRAP
, 1, (
d
), &d);

72 
e
;

73 
Œ­Ä
:15,

74 
u£_”rÜ_code
:1,

75 
”rÜ_code
:16;

76 } 
	`__©Œibu‹__
((
·cked
)è
d
;

77 
ev’t
;

79 
d
.
e
 =ƒip;

80 
d
.
Œ­Ä
 =rapnr;

81 
d
.
”rÜ_code
 =ƒrror_code;

82 
d
.
u£_”rÜ_code
=!!use_error_code;

84 
ev’t
 = 
TRC_PV_TRAP
;

85 
ev’t
 |ğ
TRC_64_FLAG
;

86 
	`__Œaû_v¬
(
ev’t
, 1, (
d
), &d);

88 
	}
}

90 
	$__Œaû_pv_·ge_çuÉ
(
addr
, 
”rÜ_code
)

92 
e
 = 
	`gue¡_ıu_u£r_»gs
()->eip;

94 #ifdeà
__x86_64__


95 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

98 
u32
 
e
, 
addr
, 
”rÜ_code
;

99 } 
	`__©Œibu‹__
((
·cked
)è
d
;

101 
d
.
e
 =ƒip;

102 
d
.
addr
 =‡ddr;

103 
d
.
”rÜ_code
 =ƒrror_code;

105 
	`__Œaû_v¬
(
TRC_PV_PAGE_FAULT
, 1, (
d
), &d);

111 
e
, 
addr
;

112 
u32
 
”rÜ_code
;

113 } 
	`__©Œibu‹__
((
·cked
)è
d
;

114 
ev’t
;

116 
d
.
e
 =ƒip;

117 
d
.
addr
 =‡ddr;

118 
d
.
”rÜ_code
 =ƒrror_code;

119 
ev’t
 = 
TRC_PV_PAGE_FAULT
;

120 
ev’t
 |ğ
TRC_64_FLAG
;

121 
	`__Œaû_v¬
(
ev’t
, 1, (
d
), &d);

123 
	}
}

125 
	$__Œaû_Œ­_Úe_addr
(
ev’t
, 
va
)

127 #ifdeà
__x86_64__


128 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

130 
u32
 
d
 = 
va
;

131 
	`__Œaû_v¬
(
ev’t
, 1, (
d
), &d);

136 
ev’t
 |ğ
TRC_64_FLAG
;

137 
	`__Œaû_v¬
(
ev’t
, 1, (
va
), &va);

139 
	}
}

141 
	$__Œaû_Œ­_two_addr
(
ev’t
, 
va1
,

142 
va2
)

144 #ifdeà
__x86_64__


145 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

148 
u32
 
va1
, 
va2
;

149 } 
	`__©Œibu‹__
((
·cked
)è
d
;

150 
d
.
va1
=va1;

151 
d
.
va2
=va2;

152 
	`__Œaû_v¬
(
ev’t
, 1, (
d
), &d);

158 
va1
, 
va2
;

159 } 
	`__©Œibu‹__
((
·cked
)è
d
;

160 
d
.
va1
=va1;

161 
d
.
va2
=va2;

162 
ev’t
 |ğ
TRC_64_FLAG
;

163 
	`__Œaû_v¬
(
ev’t
, 1, (
d
), &d);

165 
	}
}

167 
	$__Œaû_±wr_emuÏtiÚ
(
addr
, 
l1_pg’Œy_t
 
Å‹
)

169 
e
 = 
	`gue¡_ıu_u£r_»gs
()->eip;

179 #ifdeà
__x86_64__


180 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) )

183 
l1_pg’Œy_t
 
±e
;

184 
u32
 
addr
, 
e
;

185 } 
	`__©Œibu‹__
((
·cked
)è
d
;

186 
d
.
addr
 =‡ddr;

187 
d
.
e
 =ƒip;

188 
d
.
±e
 = 
Å‹
;

190 
	`__Œaû_v¬
(
TRC_PV_PTWR_EMULATION_PAE
, 1, (
d
), &d);

196 
l1_pg’Œy_t
 
±e
;

197 
addr
, 
e
;

198 } 
d
;

199 
ev’t
;

201 
d
.
addr
 =‡ddr;

202 
d
.
e
 =ƒip;

203 
d
.
±e
 = 
Å‹
;

205 
ev’t
 = ((
CONFIG_PAGING_LEVELS
 == 3) ?

206 
TRC_PV_PTWR_EMULATION_PAE
 : 
TRC_PV_PTWR_EMULATION
);

207 
ev’t
 |ğ
TRC_64_FLAG
;

208 
	`__Œaû_v¬
(
ev’t
, 1 , (
d
), &d);

210 
	}
}

	@tracking.c

1 
	~<x’/cÚfig.h
>

2 
	~<x’/v”siÚ.h
>

3 
	~<x’/domaš_·ge.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/cÚsŞe.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/shutdown.h
>

12 
	~<x’/nmi.h
>

13 
	~<asm/cu¼’t.h
>

15 
	~<asm/hvm/hvm.h
>

16 
	~<asm/hvm/suµÜt.h
>

18 
	~<public/ÿÎback.h
>

20 
	~<asm/¥šlock.h
>

21 
	~<x’/soáœq.h
>

22 
	~<mši.h
>

24 #ifdeà
ENABLE_TRACK_SPINLOCK


25 
s_time_t
 
	gŒack_¥šlock_time
[
MAX_TRACK_SPINLOCK
];

26 
	gŒack_¥šlock
[
MAX_TRACK_SPINLOCK
];

27 
	gŒack_¥šlock_tÙ®
[
MAX_TRACK_SPINLOCK
];

29 
mydump_»gi¡”s
();

30 
	$my¥š_lock
(
¥šlock_t
 *
_lock
, 
loc
) {

31 ià(!
	`¥š_Œylock
(
_lock
)) {

32 
i
 = 0, 
couÁ
 = 0;

33 
s_time_t
 
´ev
=
	`NOW
();

34 
Œack_¥šlock
[
loc
]++;

36 ià(
	`¥š_Œylock
(
_lock
))

38 
i
++;

39 ià(
i
>=10000000) {

40 
	`my´štk
("WARN d—dlock? %d@%d wa™šg. hŞd”:%d@%d\n", 
loc
, 
	`smp_´oûssÜ_id
(), (
_lock
)->
loÿtiÚ
, (_lock)->
´oc
);

41 
i
=0;

42 
couÁ
++;

43 ià(
couÁ
 > 20) {

44 
	`my·nic
("spinlock†imit hit\n");

49 
Œack_¥šlock_time
[
loc
] +ğ(
	`NOW
()-
´ev
);

51 
Œack_¥šlock_tÙ®
[
loc
]++;

52 (
_lock
)->
loÿtiÚ
 = 
loc
;

53 (
_lock
)->
´oc
 = 
	`smp_´oûssÜ_id
();

54 
	}
}

56 
	$¥šlock_»pÜt
()

58 
i
;

60 
	`my´štk
("--track_spinlock„eport--.\n");

61 
i
=0;i<
MAX_TRACK_SPINLOCK
;i++) {

62 ià(
Œack_¥šlock_time
[
i
]/1000000ULL) {

63 
	`my´štk
("¥šlock[%d]=%4Îdms@%d/%d\n", 
i
, 
Œack_¥šlock_time
[i]/1000000ULL, 
Œack_¥šlock
[i], 
Œack_¥šlock_tÙ®
[i]);

66 
	`my´štk
("--End ofrack_spinlock--\n");

67 
	}
}

69 
	$š™_Œack_¥šlock
()

71 
i
;

72 
i
=0;i<
MAX_TRACK_SPINLOCK
;i++) {

73 
Œack_¥šlock_time
[
i
] = 0ULL;

74 
Œack_¥šlock_tÙ®
[
i
] = 
Œack_¥šlock
[i] = 0;

76 
	}
}

80 #ifdeà
ENABLE_TRACK_MEMLEAK


81 
©omic_t
 
	gŒack_memËak
[
MAX_TRACK_MEMLEAK
];

82 
	gŒack_memËak_size
[
MAX_TRACK_MEMLEAK
];

84 
	$memËak_»pÜt
()

86 
i
, 
‹mp
;

87 
tÙ®
 = 0;

89 
	`my´štk
("--Memleak„eport--"

90 #ifdeà
ENABLE_VREGIONS


91 ", %d f»e_vr\n", 
v»giÚs_ä“_couÁ


96 
i
=0;i<
MAX_TRACK_MEMLEAK
;i++) {

97 ià(
	`©omic_»ad
(&
Œack_memËak
[
i
])) {

98 
‹mp
 = 
	`©omic_»ad
(&
Œack_memËak
[
i
])*
Œack_memËak_size
[i];

99 
	`my´štk
("memËak[%d]=%d * size=%d => %d\n", 
i
, 
	`©omic_»ad
(&
Œack_memËak
[i]), 
Œack_memËak_size
[i], 
‹mp
);

100 
tÙ®
 +ğ
‹mp
;

103 
	`my´štk
("--End oàmemËak,Ù®=%d --\n", 
tÙ®
);

104 
	}
}

107 
šlše
 
size_t
 
	$®ign_up
(
size_t
 
size
, size_ˆ
®ign
)

109  (
size
 + 
®ign
 - 1) & ~(align - 1);

110 
	}
}

111 
	sxm®loc_hdr


114 
size_t
 
	msize
;

115 
li¡_h—d
 
	mä“li¡
;

116 } 
	g__ÿch–še_®igÃd
;

118 
	$š™_Œack_memËak
()

120 
i
;

121 
i
=0;i<
MAX_TRACK_MEMLEAK
;i++) {

122 
	`©omic_£t
(&
Œack_memËak
[
i
], 0);

123 
Œack_memËak_size
[
i
] = 0;

125 
	}
}

126 
	$š™_Œack_memËak_size
()

128 
i
;

129 
Œack_memËak_size
[1] = (
rm­_£t
)+
MAX_RMAP_ENTRIES_IN_SET
*();

130 
Œack_memËak_size
[2] = (
v»giÚ_t
);

131 
Œack_memËak_size
[3] = (
·ge_bË
);

132 
Œack_memËak_size
[4] = (
·ge_dœ
);

133 
Œack_memËak_size
[5] = (
v»giÚ_t
 *è* 
max_·ge
;

134 
Œack_memËak_size
[6] = (
v»giÚ_t
)*
num_v»giÚs_³r_1mb
;

136 
Œack_memËak_size
[8] = (
l1e_¡ruù
);

137 
Œack_memËak_size
[9] = 
PAGE_SIZE
;

139 
i
=0;i<
MAX_TRACK_MEMLEAK
;i++) {

140 
size
 = 
Œack_memËak_size
[
i
];

141 
	`my´štk
("Üigš® memËak[%d]=%d,‡lignof=%d\n", 
i
, 
Œack_memËak_size
[i], 
	`__®ignof__
(
xm®loc_hdr
) );

142 
size
 +ğ(
xm®loc_hdr
);

143 
size
 = 
	`®ign_up
(size, 
	`__®ignof__
(
xm®loc_hdr
));

144 
Œack_memËak_size
[
i
] = 
size
;

146 
	}
}

	@traps.c

28 
	~<x’/cÚfig.h
>

29 
	~<x’/š™.h
>

30 
	~<x’/sched.h
>

31 
	~<x’/lib.h
>

32 
	~<x’/”ºo.h
>

33 
	~<x’/mm.h
>

34 
	~<x’/cÚsŞe.h
>

35 
	~<x’/shutdown.h
>

36 
	~<asm/»gs.h
>

37 
	~<x’/d–ay.h
>

38 
	~<x’/ev’t.h
>

39 
	~<x’/¥šlock.h
>

40 
	~<x’/œq.h
>

41 
	~<x’/³rfc.h
>

42 
	~<x’/soáœq.h
>

43 
	~<x’/domaš_·ge.h
>

44 
	~<x’/symbŞs.h
>

45 
	~<x’/ioÿp.h
>

46 
	~<x’/nmi.h
>

47 
	~<x’/v”siÚ.h
>

48 
	~<x’/kexec.h
>

49 
	~<x’/Œaû.h
>

50 
	~<x’/·gšg.h
>

51 
	~<asm/sy¡em.h
>

52 
	~<asm/io.h
>

53 
	~<asm/©omic.h
>

54 
	~<asm/b™İs.h
>

55 
	~<asm/desc.h
>

56 
	~<asm/debug»g.h
>

57 
	~<asm/smp.h
>

58 
	~<asm/æushb.h
>

59 
	~<asm/uacûss.h
>

60 
	~<asm/i387.h
>

61 
	~<asm/debugg”.h
>

62 
	~<asm/m¤.h
>

63 
	~<asm/sh¬ed.h
>

64 
	~<asm/x86_emuÏ‹.h
>

65 
	~<asm/Œ­s.h
>

66 
	~<asm/hvm/v±.h
>

67 
	~<asm/hy³rÿÎ.h
>

68 
	~<asm/mû.h
>

69 
	~<asm/­ic.h
>

70 
	~<public/¬ch-x86/ıuid.h
>

71 
	~<mši.h
>

79 #ifdeà
NDEBUG


80 
__»ad_mo¡ly
 
	gİt_nmi
[10] = "dom0";

82 
__»ad_mo¡ly
 
	gİt_nmi
[10] = "fatal";

84 
¡ršg_·¿m
("nmi", 
İt_nmi
);

86 
DEFINE_PER_CPU
(
u64
, 
eãr
);

88 
DEFINE_PER_CPU_READ_MOSTLY
(
u32
, 
Ër_m¤
);

90 
DEFINE_PER_CPU_READ_MOSTLY
(
desc_¡ruù
 *, 
gdt_bË
);

91 #ifdeà
CONFIG_COMPAT


92 
DEFINE_PER_CPU_READ_MOSTLY
(
desc_¡ruù
 *, 
com·t_gdt_bË
);

96 
idt_’Œy_t
 
	gidt_bË
[
IDT_ENTRIES
];

99 
idt_’Œy_t
 *
	gidt_bËs
[
NR_CPUS
] 
	g__»ad_mo¡ly
;

101 (*
iÛmul_hªdË_quœk
)(

102 
u8
 
İcode
, *
io_emul_¡ub
, 
ıu_u£r_»gs
 *
»gs
);

104 
debug_¡ack_lšes
 = 20;

105 
	`š‹g”_·¿m
("debug_¡ack_lšes", 
debug_¡ack_lšes
);

107 
boŞ_t
 
__devš™d©a
 
İt_Ër
;

108 
	`boŞ—n_·¿m
("Ër", 
İt_Ër
);

110 #ifdeà
CONFIG_X86_32


111 
	#¡ack_wÜds_³r_lše
 8

	)

112 
	#ESP_BEFORE_EXCEPTION
(
»gs
è((*)&»gs->
e¥
)

	)

114 
	#¡ack_wÜds_³r_lše
 4

	)

115 
	#ESP_BEFORE_EXCEPTION
(
»gs
è((*ìegs->
r¥
)

	)

118 
	$show_gue¡_¡ack
(
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

120 
i
;

121 *
¡ack
, 
addr
;

122 
mask
 = 
STACK_SIZE
;

124 iàĞ
	`is_hvm_vıu
(
v
) )

127 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

129 
	`com·t_show_gue¡_¡ack
(
v
, 
»gs
, 
debug_¡ack_lšes
);

133 iàĞ
	`vm86_mode
(
»gs
) )

135 
¡ack
 = (*)((
»gs
->
ss
 << 4è+ (»gs->
e¥
 & 0xffff));

136 
	`´štk
("Guest stackrace from ss:sp = %04x:%04x (VM86)\n ",

137 
»gs
->
ss
, (
ušt16_t
)Ôegs->
e¥
 & 0xffff));

141 
¡ack
 = (*)
»gs
->
e¥
;

142 
	`´štk
("Gue¡ sck¿û from "
__OP
"¥=%p:\À ", 
¡ack
);

145 iàĞ!
	`acûss_ok
(
¡ack
, (*stack)) )

147 
	`´štk
("Guest-inaccessible memory.\n");

151 iàĞ
v
 !ğ
cu¼’t
 )

153 
vıu
 *vcpu;

155 
	`ASSERT
(
	`gue¡_k”Ãl_mode
(
v
, 
»gs
));

156 #iâdeà
__x86_64__


157 
addr
 = 
	`»ad_ü3
();

158 
	`fÜ_—ch_vıu
Ğ
v
->
domaš
, 
vıu
 )

159 iàĞ
vıu
->
¬ch
.
ü3
 =ğ
addr
 )

162 
vıu
 = 
	`maddr_g‘_owÃr
(
	`»ad_ü3
()è=ğ
v
->
domaš
 ? v : 
NULL
;

164 iàĞ!
vıu
 )

166 
¡ack
 = 
	`do_·ge_w®k
(
v
, ()stack);

167 iàĞ()
¡ack
 < 
PAGE_SIZE
 )

169 
	`´štk
("Inaccessible guest memory.\n");

172 
mask
 = 
PAGE_SIZE
;

176  
i
 = 0; i < (
debug_¡ack_lšes
*
¡ack_wÜds_³r_lše
); i++ )

178 iàĞ((()
¡ack
 - 1è^ (()(¡ack + 1è- 1)è& 
mask
 )

180 iàĞ
	`__g‘_u£r
(
addr
, 
¡ack
) )

182 iàĞ
i
 != 0 )

183 
	`´štk
("\n ");

184 
	`´štk
("Fault while‡ccessing guest memory.");

185 
i
 = 1;

188 iàĞ(
i
 !ğ0è&& ((˜% 
¡ack_wÜds_³r_lše
) == 0) )

189 
	`´štk
("\n ");

190 
	`´štk
(" %p", 
	`_p
(
addr
));

191 
¡ack
++;

193 iàĞ
i
 == 0 )

194 
	`´štk
("Stackƒmpty.");

195 
	`´štk
("\n");

196 
	}
}

198 #ià!
defšed
(
CONFIG_FRAME_POINTER
)

200 
	$show_Œaû
(
ıu_u£r_»gs
 *
»gs
)

202 *
¡ack
 = 
	`ESP_BEFORE_EXCEPTION
(
»gs
), 
addr
;

204 
	`´štk
("Xen callrace:\n ");

206 
	`´štk
("[<%p>]", 
	`_p
(
»gs
->
e
));

207 
	`´št_symbŞ
(" %s\À ", 
»gs
->
e
);

209  (()
¡ack
 & (
STACK_SIZE
-
BYTES_PER_LONG
)) != 0 )

211 
addr
 = *
¡ack
++;

212 iàĞ
	`is_k”Ãl_‹xt
(
addr
è|| 
	`is_k”Ãl_š™‹xt
(addr) )

214 
	`´štk
("[<%p>]", 
	`_p
(
addr
));

215 
	`´št_symbŞ
(" %s\À ", 
addr
);

219 
	`´štk
("\n");

220 
	}
}

224 
	$show_Œaû
(
ıu_u£r_»gs
 *
»gs
)

226 *
äame
, 
Ãxt
, 
addr
, 
low
, 
high
;

228 
	`´štk
("Xen callrace:\n ");

230 
	`´štk
("[<%p>]", 
	`_p
(
»gs
->
e
));

231 
	`´št_symbŞ
(" %s\À ", 
»gs
->
e
);

234 
low
 = ()(
	`ESP_BEFORE_EXCEPTION
(
»gs
) - 2);

235 
high
 = (
low
 & ~(
STACK_SIZE
 - 1)) +

236 (
STACK_SIZE
 - (
ıu_šfo
) - 2*());

239 
Ãxt
 = 
»gs
->
ebp
;

244 iàĞ(
Ãxt
 < 
low
è|| (Ãxˆ>ğ
high
) )

250 
Ãxt
 = ~next;

251 iàĞ(
Ãxt
 < 
low
è|| (Ãxˆ>ğ
high
) )

253 
äame
 = (*)
Ãxt
;

254 
Ãxt
 = 
äame
[0];

255 
addr
 = 
äame
[(
	`off£tof
(
ıu_u£r_»gs
, 
e
) -

256 
	`off£tof
(
ıu_u£r_»gs
, 
ebp
))

257 / 
BYTES_PER_LONG
];

262 
äame
 = (*)
Ãxt
;

263 
Ãxt
 = 
äame
[0];

264 
addr
 = 
äame
[1];

267 
	`´štk
("[<%p>]", 
	`_p
(
addr
));

268 
	`´št_symbŞ
(" %s\À ", 
addr
);

270 
low
 = ()&
äame
[2];

273 
	`´štk
("\n");

274 
	}
}

278 
	$show_¡ack
(
ıu_u£r_»gs
 *
»gs
)

280 *
¡ack
 = 
	`ESP_BEFORE_EXCEPTION
(
»gs
), 
addr
;

281 
i
;

283 iàĞ
	`gue¡_mode
(
»gs
) )

284  
	`show_gue¡_¡ack
(
cu¼’t
, 
»gs
);

286 
	`´štk
("X’ sck¿û from "
__OP
"¥=%p:\À ", 
¡ack
);

288  
i
 = 0; i < (
debug_¡ack_lšes
*
¡ack_wÜds_³r_lše
); i++ )

290 iàĞ(()
¡ack
 & (
STACK_SIZE
-
BYTES_PER_LONG
)) == 0 )

292 iàĞ(
i
 !ğ0è&& ((˜% 
¡ack_wÜds_³r_lše
) == 0) )

293 
	`´štk
("\n ");

294 
addr
 = *
¡ack
++;

295 
	`´štk
(" %p", 
	`_p
(
addr
));

297 iàĞ
i
 == 0 )

298 
	`´štk
("Stackƒmpty.");

299 
	`´štk
("\n");

301 
	`show_Œaû
(
»gs
);

302 
	}
}

304 
	$show_¡ack_ov”æow
(
ıu
, 
e¥
)

306 #ifdeà
MEMORY_GUARD


307 
e¥_tİ
, 
e¥_bÙtom
;

308 *
¡ack
, 
addr
;

310 
e¥_bÙtom
 = (
e¥
 | (
STACK_SIZE
 - 1)) + 1;

311 
e¥_tİ
 = 
e¥_bÙtom
 - 
PRIMARY_STACK_SIZE
;

313 
	`´štk
("Valid stack„ange: %p-%p, sp=%p,ss.esp0=%p\n",

314 (*)
e¥_tİ
, (*)
e¥_bÙtom
, (*)
e¥
,

315 (*)
	`³r_ıu
(
š™_tss
, 
ıu
).
e¥0
);

318 iàĞ(()(
e¥
 - 
e¥_tİ
) > 512) &&

319 (()(
e¥_tİ
 - 
e¥
) > 512) )

321 
	`´štk
("No stack overflow detected. Skipping stackrace.\n");

325 iàĞ
e¥
 < 
e¥_tİ
 )

326 
e¥
 = 
e¥_tİ
;

328 
	`´štk
("Xen stack overflow (dumpingrace %p-%p):\n ",

329 (*)
e¥
, (*)
e¥_bÙtom
);

331 
¡ack
 = (*)
e¥
;

332  (()
¡ack
 & (
STACK_SIZE
-
BYTES_PER_LONG
)) != 0 )

334 
addr
 = *
¡ack
++;

335 iàĞ
	`is_k”Ãl_‹xt
(
addr
è|| 
	`is_k”Ãl_š™‹xt
(addr) )

337 
	`´štk
("%p: [<%p>]", 
¡ack
, 
	`_p
(
addr
));

338 
	`´št_symbŞ
(" %s\À ", 
addr
);

342 
	`´štk
("\n");

344 
	}
}

346 
	$show_executiÚ_¡©e
(
ıu_u£r_»gs
 *
»gs
)

348 
	`show_»gi¡”s
(
»gs
);

349 
	`show_¡ack
(
»gs
);

350 
	}
}

352 
	$vıu_show_executiÚ_¡©e
(
vıu
 *
v
)

354 
	`´štk
("*** Dumping Dom%d vcpu#%d state: ***\n",

355 
v
->
domaš
->
domaš_id
, v->
vıu_id
);

357 iàĞ
v
 =ğ
cu¼’t
 )

359 
	`show_executiÚ_¡©e
(
	`gue¡_ıu_u£r_»gs
());

363 
	`vıu_·u£
(
v
);

365 
	`vıu_show_»gi¡”s
(
v
);

366 iàĞ
	`gue¡_k”Ãl_mode
(
v
, &v->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
) )

367 
	`show_gue¡_¡ack
(
v
, &v->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
);

369 
	`vıu_uÅau£
(
v
);

370 
	}
}

372 *
	$Œ­¡r
(
Œ­Ä
)

374 *
¡ršgs
[] = {

383 iàĞ(
Œ­Ä
 < 0è|| (Œ­Ä >ğ
	`ARRAY_SIZE
(
¡ršgs
)) )

386  
¡ršgs
[
Œ­Ä
];

387 
	}
}

394 
asmlškage
 
	$çl_Œ­
(
Œ­Ä
, 
ıu_u£r_»gs
 *
»gs
)

396 
	`DEFINE_PER_CPU
(, 
d•th
);

403 iàĞ++
	`this_ıu
(
d•th
) < 3 )

405 
	`w©chdog_di§bË
();

406 
	`cÚsŞe_¡¬t_sync
();

408 
	`show_executiÚ_¡©e
(
»gs
);

410 iàĞ
Œ­Ä
 =ğ
TRAP_·ge_çuÉ
 )

412 
ü2
 = 
	`»ad_ü2
();

413 
	`´štk
("FauÉšg†š—¸add»ss: %p\n", 
	`_p
(
ü2
));

414 
	`show_·ge_w®k
(
ü2
);

418 
	`·nic
("FATAL TRAP: vector = %d (%s)\n"

420 
Œ­Ä
, 
	`Œ­¡r
Ñ¿²r), 
»gs
->
”rÜ_code
,

421 (
»gs
->
eæags
 & 
X86_EFLAGS_IF
) ? "" : ", IN INTERRUPT CONTEXT");

422 
	}
}

424 
	$do_gue¡_Œ­
(

425 
Œ­Ä
, cÚ¡ 
ıu_u£r_»gs
 *
»gs
, 
u£_”rÜ_code
)

427 
vıu
 *
v
 = 
cu¼’t
;

428 
Œ­_bounû
 *
tb
;

429 cÚ¡ 
Œ­_šfo
 *
ti
;

431 
	`Œaû_pv_Œ­
(
Œ­Ä
, 
»gs
->
e
, 
u£_”rÜ_code
,„egs->
”rÜ_code
);

433 
tb
 = &
v
->
¬ch
.
Œ­_bounû
;

434 
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
Œ­Ä
];

436 
tb
->
æags
 = 
TBF_EXCEPTION
;

437 
tb
->
cs
 = 
ti
->cs;

438 
tb
->
e
 = 
ti
->
add»ss
;

440 iàĞ
u£_”rÜ_code
 )

442 
tb
->
æags
 |ğ
TBF_EXCEPTION_ERRCODE
;

443 
tb
->
”rÜ_code
 = 
»gs
->error_code;

446 iàĞ
	`TI_GET_IF
(
ti
) )

447 
tb
->
æags
 |ğ
TBF_INTERRUPT
;

449 iàĞ
	`uÆik–y
(
	`nuÎ_Œ­_bounû
(
v
, 
tb
)) )

450 
	`gd´štk
(
XENLOG_WARNING
, "Unhandled %s fault/trap [#%d] "

452 
	`Œ­¡r
(
Œ­Ä
),¿²r, 
v
->
vıu_id
, 
»gs
->
”rÜ_code
);

467 
	}
}

469 
	$š¡ruùiÚ_dÚe
(

470 
ıu_u£r_»gs
 *
»gs
, 
e
, 
bpm©ch
)

472 
»gs
->
e
 =ƒip;

473 
»gs
->
eæags
 &ğ~
X86_EFLAGS_RF
;

474 iàĞ
bpm©ch
 || (
»gs
->
eæags
 & 
X86_EFLAGS_TF
) )

476 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6] |ğ
bpm©ch
 | 0xffff0ff0;

477 iàĞ
»gs
->
eæags
 & 
X86_EFLAGS_TF
 )

478 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6] |= 0x4000;

479 
	`do_gue¡_Œ­
(
TRAP_debug
, 
»gs
, 0);

481 
	}
}

483 
	$check_gue¡_io_b»akpošt
(
vıu
 *
v
,

484 
pÜt
, 
Ën
)

486 
width
, 
i
, 
m©ch
 = 0;

487 
¡¬t
;

489 iàĞ!(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[5]) ||

490 !(
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_DE
) )

493  
i
 = 0; i < 4; i++ )

495 iàĞ!(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[5] &

496 (3 << (
i
 * 
DR_ENABLE_SIZE
))) )

499 
¡¬t
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[
i
];

500 
width
 = 0;

502  (
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] >>

503 (
DR_CONTROL_SHIFT
 + 
i
 * 
DR_CONTROL_SIZE
)) & 0xc )

505 
DR_LEN_1
: 
width
 = 1; ;

506 
DR_LEN_2
: 
width
 = 2; ;

507 
DR_LEN_4
: 
width
 = 4; ;

508 
DR_LEN_8
: 
width
 = 8; ;

511 iàĞ(
¡¬t
 < (
pÜt
 + 
Ën
)è&& ((¡¬ˆ+ 
width
) >…ort) )

512 
m©ch
 |ğ1 << 
i
;

515  
m©ch
;

516 
	}
}

522 
asmlškage
 
	$£t_gue¡_machšecheck_Œ­bounû
()

524 
vıu
 *
v
 = 
cu¼’t
;

525 
Œ­_bounû
 *
tb
 = &
v
->
¬ch
.trap_bounce;

527 
	`do_gue¡_Œ­
(
TRAP_machše_check
, 
	`gue¡_ıu_u£r_»gs
(), 0);

528 
tb
->
æags
 &ğ~
TBF_EXCEPTION
;

529  !
	`nuÎ_Œ­_bounû
(
v
, 
tb
);

530 
	}
}

536 
asmlškage
 
	$£t_gue¡_nmi_Œ­bounû
()

538 
vıu
 *
v
 = 
cu¼’t
;

539 
Œ­_bounû
 *
tb
 = &
v
->
¬ch
.trap_bounce;

540 
	`do_gue¡_Œ­
(
TRAP_nmi
, 
	`gue¡_ıu_u£r_»gs
(), 0);

541 
tb
->
æags
 &ğ~
TBF_EXCEPTION
;

542  !
	`nuÎ_Œ­_bounû
(
v
, 
tb
);

543 
	}
}

545 
šlše
 
	$do_Œ­
(

546 
Œ­Ä
, 
ıu_u£r_»gs
 *
»gs
, 
u£_”rÜ_code
)

548 
vıu
 *
cu¼
 = 
cu¼’t
;

549 
fixup
;

551 
	`DEBUGGER_Œ­_’Œy
(
Œ­Ä
, 
»gs
);

553 iàĞ
	`gue¡_mode
(
»gs
) )

555 
	`do_gue¡_Œ­
(
Œ­Ä
, 
»gs
, 
u£_”rÜ_code
);

559 iàĞ
	`lik–y
((
fixup
 = 
	`£¬ch_exû±iÚ_bË
(
»gs
->
e
)) != 0) )

561 
	`d´štk
(
XENLOG_ERR
, "Trap %d: %p -> %p\n",

562 
Œ­Ä
, 
	`_p
(
»gs
->
e
), _p(
fixup
));

563 
»gs
->
e
 = 
fixup
;

567 iàĞ((
Œ­Ä
 =ğ
TRAP_cİro_”rÜ
è|| (Œ­Ä =ğ
TRAP_simd_”rÜ
)) &&

568 
	`is_hvm_vıu
(
cu¼
è&& cu¼->
¬ch
.
hvm_vıu
.
åu_exû±iÚ_ÿÎback
 )

570 
cu¼
->
¬ch
.
hvm_vıu
.
	`åu_exû±iÚ_ÿÎback
(

571 
cu¼
->
¬ch
.
hvm_vıu
.
åu_exû±iÚ_ÿÎback_¬g
, 
»gs
);

575 
	`DEBUGGER_Œ­_çl
(
Œ­Ä
, 
»gs
);

577 
	`show_executiÚ_¡©e
(
»gs
);

578 
	`·nic
("FATAL TRAP: vector = %d (%s)\n"

580 
Œ­Ä
, 
	`Œ­¡r
Ñ¿²r), 
»gs
->
”rÜ_code
);

581 
	}
}

583 
	#DO_ERROR_NOCODE
(
Œ­Ä
, 
Çme
) \

584 
asmlškage
 
do_
##
	`Çme
(
ıu_u£r_»gs
 *
»gs
) \

586 
	`do_Œ­
(
Œ­Ä
, 
»gs
, 0); \

587 }

	)

589 
	#DO_ERROR
(
Œ­Ä
, 
Çme
) \

590 
asmlškage
 
do_
##
	`Çme
(
ıu_u£r_»gs
 *
»gs
) \

592 
	`do_Œ­
(
Œ­Ä
, 
»gs
, 1); \

593 }

	)

595 
	$DO_ERROR_NOCODE
(
TRAP_divide_”rÜ
, 
divide_”rÜ
)

596 
	$DO_ERROR_NOCODE
(
TRAP_ov”æow
, 
ov”æow
)

597 
	$DO_ERROR_NOCODE
(
TRAP_bounds
, 
bounds
)

598 
	$DO_ERROR_NOCODE
(
TRAP_cİro_£g
, 
cİroûssÜ_£gm’t_ov”run
)

599 
	$DO_ERROR
Ğ
TRAP_šv®id_tss
, 
šv®id_TSS
)

600 
	$DO_ERROR
Ğ
TRAP_no_£gm’t
, 
£gm’t_nÙ_´e£Á
)

601 
	$DO_ERROR
Ğ
TRAP_¡ack_”rÜ
, 
¡ack_£gm’t
)

602 
	$DO_ERROR_NOCODE
(
TRAP_cİro_”rÜ
, 
cİroûssÜ_”rÜ
)

603 
	$DO_ERROR
Ğ
TRAP_®ignm’t_check
, 
®ignm’t_check
)

604 
	$DO_ERROR_NOCODE
(
TRAP_simd_”rÜ
, 
simd_cİroûssÜ_”rÜ
)

606 
	$rdm¤_hy³rvisÜ_»gs
(
ušt32_t
 
idx
, 
ušt64_t
 *
v®
)

608 
domaš
 *
d
 = 
cu¼’t
->domain;

610 
ušt32_t
 
ba£
 = 
	`is_vœidŸn_domaš
(
d
) ? 0x40000200 : 0x40000000;

612 
idx
 -ğ
ba£
;

613 iàĞ
idx
 > 0 )

616  
idx
 )

620 *
v®
 = 0;

624 
	`BUG
();

628 
	}
}

630 
	$wrm¤_hy³rvisÜ_»gs
(
ušt32_t
 
idx
, 
ušt64_t
 
v®
)

632 
domaš
 *
d
 = 
cu¼’t
->domain;

634 
ušt32_t
 
ba£
 = 
	`is_vœidŸn_domaš
(
d
) ? 0x40000200 : 0x40000000;

636 
idx
 -ğ
ba£
;

637 iàĞ
idx
 > 0 )

640  
idx
 )

644 *
hy³rÿÎ_·ge
;

645 
mâ
;

646 
gmâ
 = 
v®
 >> 12;

647 
idx
 = 
v®
 & 0xfff;

649 iàĞ
idx
 > 0 )

651 
	`gd´štk
(
XENLOG_WARNING
,

653 
idx
, 0x40000000);

657 
mâ
 = 
	`gmâ_to_mâ
(
d
, 
gmâ
);

659 iàĞ!
	`mâ_v®id
(
mâ
) ||

660 !
	`g‘_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
), 
d
, 
PGT_wr™abË_·ge
) )

662 
	`gd´štk
(
XENLOG_WARNING
,

664 
gmâ
, 
mâ
, 
ba£
 + 
idx
);

668 
hy³rÿÎ_·ge
 = 
	`m­_domaš_·ge
(
mâ
);

669 
	`hy³rÿÎ_·ge_š™Ÿli£
(
d
, 
hy³rÿÎ_·ge
);

670 
	`unm­_domaš_·ge
(
hy³rÿÎ_·ge
);

672 
	`put_·ge_ªd_ty³
(
	`mâ_to_·ge
(
mâ
));

677 
	`BUG
();

681 
	}
}

683 
	$ıuid_hy³rvisÜ_Ëaves
Ğ
ušt32_t
 
idx
, ušt32_ˆ
sub_idx
,

684 
ušt32_t
 *
—x
, ušt32_ˆ*
ebx
, ušt32_ˆ*
ecx
, ušt32_ˆ*
edx
)

686 
domaš
 *
d
 = 
cu¼’t
->domain;

688 
ušt32_t
 
ba£
 = 
	`is_vœidŸn_domaš
(
d
) ? 0x40000100 : 0x40000000;

690 
idx
 -ğ
ba£
;

691 iàĞ
idx
 > 3 )

694  
idx
 )

697 *
—x
 = 
ba£
 + 3;

698 *
ebx
 = 
XEN_CPUID_SIGNATURE_EBX
;

699 *
ecx
 = 
XEN_CPUID_SIGNATURE_ECX
;

700 *
edx
 = 
XEN_CPUID_SIGNATURE_EDX
;

704 *
—x
 = (
	`x’_majÜ_v”siÚ
(è<< 16è| 
	`x’_mšÜ_v”siÚ
();

705 *
ebx
 = 0;

706 *
ecx
 = 0;

707 *
edx
 = 0;

711 *
—x
 = 1;

712 *
ebx
 = 0x40000000;

713 iàĞ
	`is_vœidŸn_domaš
(
d
) )

714 *
ebx
 = 0x40000200;

715 *
ecx
 = 0;

716 *
edx
 = 0;

717 iàĞ!
	`is_hvm_vıu
(
cu¼’t
) )

718 *
ecx
 |ğ
XEN_CPUID_FEAT1_MMU_PT_UPDATE_PRESERVE_AD
;

722 *
—x
 = *
ebx
 = *
ecx
 = *
edx
 = 0;

723 
	`ıuid_time_Ëaf
Ğ
sub_idx
, 
—x
, 
ebx
, 
ecx
, 
edx
 );

727 
	`BUG
();

731 
	}
}

733 
	$pv_ıuid
(
ıu_u£r_»gs
 *
»gs
)

735 
ušt32_t
 
a
, 
b
, 
c
, 
d
;

737 
a
 = 
»gs
->
—x
;

738 
b
 = 
»gs
->
ebx
;

739 
c
 = 
»gs
->
ecx
;

740 
d
 = 
»gs
->
edx
;

742 iàĞ
cu¼’t
->
domaš
->
domaš_id
 != 0 )

744 iàĞ!
	`ıuid_hy³rvisÜ_Ëaves
(
a
, 
c
, &a, &
b
, &c, &
d
) )

745 
	`domaš_ıuid
(
cu¼’t
->
domaš
, 
a
, 
c
, &a, &
b
, &c, &
d
);

746 
out
;

749 
	`asm
 (

751 : "÷" (
a
), "=b" (
b
), "=c" (
c
), "=d" (
d
)

752 : "0" (
a
), "1" (
b
), "2" (
c
), "3" (
d
) );

754 iàĞ(
»gs
->
—x
 & 0x7fffffff) == 1 )

757 
	`__ş—r_b™
(
X86_FEATURE_VME
, &
d
);

758 iàĞ!
ıu_has_­ic
 )

759 
	`__ş—r_b™
(
X86_FEATURE_APIC
, &
d
);

760 
	`__ş—r_b™
(
X86_FEATURE_PSE
, &
d
);

761 
	`__ş—r_b™
(
X86_FEATURE_PGE
, &
d
);

762 
	`__ş—r_b™
(
X86_FEATURE_PSE36
, &
d
);

764  (
ušt32_t
)
»gs
->
—x
 )

768 iàĞ!
ıu_has_£p
 )

769 
	`__ş—r_b™
(
X86_FEATURE_SEP
, &
d
);

770 #ifdeà
__i386__


771 iàĞ!
su³rvisÜ_mode_k”Ãl
 )

772 
	`__ş—r_b™
(
X86_FEATURE_SEP
, &
d
);

774 
	`__ş—r_b™
(
X86_FEATURE_DS
, &
d
);

775 
	`__ş—r_b™
(
X86_FEATURE_ACC
, &
d
);

776 
	`__ş—r_b™
(
X86_FEATURE_PBE
, &
d
);

778 
	`__ş—r_b™
(
X86_FEATURE_DTES64
 % 32, &
c
);

779 
	`__ş—r_b™
(
X86_FEATURE_MWAIT
 % 32, &
c
);

780 
	`__ş—r_b™
(
X86_FEATURE_DSCPL
 % 32, &
c
);

781 
	`__ş—r_b™
(
X86_FEATURE_VMXE
 % 32, &
c
);

782 
	`__ş—r_b™
(
X86_FEATURE_SMXE
 % 32, &
c
);

783 
	`__ş—r_b™
(
X86_FEATURE_TM2
 % 32, &
c
);

784 iàĞ
	`is_pv_32b™_vıu
(
cu¼’t
) )

785 
	`__ş—r_b™
(
X86_FEATURE_CX16
 % 32, &
c
);

786 
	`__ş—r_b™
(
X86_FEATURE_XTPR
 % 32, &
c
);

787 
	`__ş—r_b™
(
X86_FEATURE_PDCM
 % 32, &
c
);

788 
	`__ş—r_b™
(
X86_FEATURE_DCA
 % 32, &
c
);

789 iàĞ!
	`x§ve_’abËd
(
cu¼’t
) )

791 
	`__ş—r_b™
(
X86_FEATURE_XSAVE
 % 32, &
c
);

792 
	`__ş—r_b™
(
X86_FEATURE_AVX
 % 32, &
c
);

794 iàĞ!
ıu_has_­ic
 )

795 
	`__ş—r_b™
(
X86_FEATURE_X2APIC
 % 32, &
c
);

796 
	`__£t_b™
(
X86_FEATURE_HYPERVISOR
 % 32, &
c
);

799 iàĞ
»gs
->
ecx
 == 0 )

800 
b
 &ğ
	`ıuã©_mask
(
X86_FEATURE_FSGSBASE
);

802 
b
 = 0;

803 
a
 = 
c
 = 
d
 = 0;

807 iàĞ
	`is_pv_32b™_vıu
(
cu¼’t
) )

809 
	`__ş—r_b™
(
X86_FEATURE_LM
 % 32, &
d
);

810 
	`__ş—r_b™
(
X86_FEATURE_LAHF_LM
 % 32, &
c
);

812 #iâdeà
__i386__


813 iàĞ
	`is_pv_32Ú64_vıu
(
cu¼’t
) &&

814 
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 )

816 
	`__ş—r_b™
(
X86_FEATURE_SYSCALL
 % 32, &
d
);

817 
	`__ş—r_b™
(
X86_FEATURE_PAGE1GB
 % 32, &
d
);

818 
	`__ş—r_b™
(
X86_FEATURE_RDTSCP
 % 32, &
d
);

820 
	`__ş—r_b™
(
X86_FEATURE_SVM
 % 32, &
c
);

821 iàĞ!
ıu_has_­ic
 )

822 
	`__ş—r_b™
(
X86_FEATURE_EXTAPIC
 % 32, &
c
);

823 
	`__ş—r_b™
(
X86_FEATURE_OSVW
 % 32, &
c
);

824 
	`__ş—r_b™
(
X86_FEATURE_IBS
 % 32, &
c
);

825 
	`__ş—r_b™
(
X86_FEATURE_SKINIT
 % 32, &
c
);

826 
	`__ş—r_b™
(
X86_FEATURE_WDT
 % 32, &
c
);

827 
	`__ş—r_b™
(
X86_FEATURE_LWP
 % 32, &
c
);

828 
	`__ş—r_b™
(
X86_FEATURE_NODEID_MSR
 % 32, &
c
);

829 
	`__ş—r_b™
(
X86_FEATURE_TOPOEXT
 % 32, &
c
);

832 iàĞ
	`x§ve_’abËd
(
cu¼’t
) )

841 
a
 = 
b
 = 
c
 = 
d
 = 0;

844 ()
	`ıuid_hy³rvisÜ_Ëaves
(
»gs
->
—x
, 0, &
a
, &
b
, &
c
, &
d
);

848 
out
:

849 
»gs
->
—x
 = 
a
;

850 
»gs
->
ebx
 = 
b
;

851 
»gs
->
ecx
 = 
c
;

852 
»gs
->
edx
 = 
d
;

853 
	}
}

855 
	$emuÏ‹_šv®id_rdtsı
(
ıu_u£r_»gs
 *
»gs
)

857 
İcode
[3];

858 
e
, 
rc
;

859 
vıu
 *
v
 = 
cu¼’t
;

861 
e
 = 
»gs
->eip;

862 iàĞ(
rc
 = 
	`cİy_äom_u£r
(
İcode
, (*)
e
, (opcode))) != 0 )

864 
	`´İag©e_·ge_çuÉ
(
e
 + (
İcode
è- 
rc
, 0);

865  
EXCRET_çuÉ_fixed
;

867 iàĞ
	`memcmp
(
İcode
, "\xf\x1\xf9", (opcode)) )

869 
e
 +ğ(
İcode
);

870 
	`pv_soá_rdtsc
(
v
, 
»gs
, 1);

871 
	`š¡ruùiÚ_dÚe
(
»gs
, 
e
, 0);

872  
EXCRET_çuÉ_fixed
;

873 
	}
}

875 
	$emuÏ‹_fÜûd_šv®id_İ
(
ıu_u£r_»gs
 *
»gs
)

877 
sig
[5], 
š¡r
[2];

878 
e
, 
rc
;

880 
e
 = 
»gs
->eip;

883 iàĞ(
rc
 = 
	`cİy_äom_u£r
(
sig
, (*)
e
, (sig))) != 0 )

885 
	`´İag©e_·ge_çuÉ
(
e
 + (
sig
è- 
rc
, 0);

886  
EXCRET_çuÉ_fixed
;

888 iàĞ
	`memcmp
(
sig
, "\xf\xbxen", (sig)) )

890 
e
 +ğ(
sig
);

893 iàĞĞ
rc
 = 
	`cİy_äom_u£r
(
š¡r
, (*)
e
, (instr))) != 0 )

895 
	`´İag©e_·ge_çuÉ
(
e
 + (
š¡r
è- 
rc
, 0);

896  
EXCRET_çuÉ_fixed
;

898 iàĞ
	`memcmp
(
š¡r
, "\xf\xa2", (instr)) )

900 
e
 +ğ(
š¡r
);

902 
	`pv_ıuid
(
»gs
);

904 
	`š¡ruùiÚ_dÚe
(
»gs
, 
e
, 0);

906 
	`Œaû_Œ­_Úe_addr
(
TRC_PV_FORCED_INVALID_OP
, 
»gs
->
e
);

908  
EXCRET_çuÉ_fixed
;

909 
	}
}

911 
asmlškage
 
	$do_šv®id_İ
(
ıu_u£r_»gs
 *
»gs
)

913 
bug_äame
 
bug
;

914 
bug_äame_¡r
 
bug_¡r
;

915 cÚ¡ *
p
, *
f’ame
, *
´ediÿ‹
, *
e
 = (*)
»gs
->eip;

916 
fixup
;

917 
id
, 
lš’o
;

919 
	`DEBUGGER_Œ­_’Œy
(
TRAP_šv®id_İ
, 
»gs
);

921 iàĞ
	`lik–y
(
	`gue¡_mode
(
»gs
)) )

923 iàĞ!
	`emuÏ‹_šv®id_rdtsı
(
»gs
) &&

924 !
	`emuÏ‹_fÜûd_šv®id_İ
(
»gs
) )

925 
	`do_gue¡_Œ­
(
TRAP_šv®id_İ
, 
»gs
, 0);

929 iàĞ!
	`is_k”Ãl
(
e
) ||

930 
	`__cİy_äom_u£r
(&
bug
, 
e
, (bug)) ||

931 
	`memcmp
(
bug
.
ud2
, "\xf\xb", (bug.ud2)) ||

932 (
bug
.
»t
 != 0xc2) )

933 
d›
;

934 
e
 +ğ(
bug
);

937 iàĞ!
	`is_k”Ãl
(
e
) ||

938 
	`__cİy_äom_u£r
(&
bug_¡r
, 
e
, (bug_str)) ||

939 (
bug_¡r
.
mov
 != 0xbc) )

940 
d›
;

941 
p
 = 
	`bug_¡r
(
bug_¡r
, 
e
);

942 iàĞ!
	`is_k”Ãl
(
p
) )

943 
d›
;

944 
e
 +ğ(
bug_¡r
);

946 
id
 = 
bug
.id & 3;

948 iàĞ
id
 =ğ
BUGFRAME_run_â
 )

950 (*
â
)(
ıu_u£r_»gs
 *èğ(*)
p
;

951 (*
â
)(
»gs
);

952 
»gs
->
e
 = ()eip;

957 
f’ame
 = 
p
;

958 
lš’o
 = 
bug
.
id
 >> 2;

960 iàĞ
id
 =ğ
BUGFRAME_w¬n
 )

962 
	`´štk
("X’ WARN‡ˆ%.50s:%d\n", 
f’ame
, 
lš’o
);

963 
	`show_executiÚ_¡©e
(
»gs
);

964 
»gs
->
e
 = ()eip;

968 iàĞ
id
 =ğ
BUGFRAME_bug
 )

970 
	`´štk
("X’ BUG‡ˆ%.50s:%d\n", 
f’ame
, 
lš’o
);

971 
	`DEBUGGER_Œ­_çl
(
TRAP_šv®id_İ
, 
»gs
);

972 
	`show_executiÚ_¡©e
(
»gs
);

973 
	`·nic
("X’ BUG‡ˆ%.50s:%d\n", 
f’ame
, 
lš’o
);

977 
	`ASSERT
(
id
 =ğ
BUGFRAME_as£¹
);

978 iàĞ!
	`is_k”Ãl
(
e
) ||

979 
	`__cİy_äom_u£r
(&
bug_¡r
, 
e
, (bug_str)) ||

980 (
bug_¡r
.
mov
 != 0xbc) )

981 
d›
;

982 
´ediÿ‹
 = 
	`bug_¡r
(
bug_¡r
, 
e
);

983 
e
 +ğ(
bug_¡r
);

985 iàĞ!
	`is_k”Ãl
(
´ediÿ‹
) )

986 
´ediÿ‹
 = "<unknown>";

987 
	`´štk
("Assertion '%s' failed‡t %.50s:%d\n",

988 
´ediÿ‹
, 
f’ame
, 
lš’o
);

989 
	`DEBUGGER_Œ­_çl
(
TRAP_šv®id_İ
, 
»gs
);

990 
	`show_executiÚ_¡©e
(
»gs
);

991 
	`·nic
("Assertion '%s' failed‡t %.50s:%d\n",

992 
´ediÿ‹
, 
f’ame
, 
lš’o
);

994 
d›
:

995 iàĞ(
fixup
 = 
	`£¬ch_exû±iÚ_bË
(
»gs
->
e
)) != 0 )

997 
»gs
->
e
 = 
fixup
;

1000 
	`DEBUGGER_Œ­_çl
(
TRAP_šv®id_İ
, 
»gs
);

1001 
	`show_executiÚ_¡©e
(
»gs
);

1002 
	`·nic
("FATAL TRAP: veùÜ = %d (šv®id opcode)\n", 
TRAP_šv®id_İ
);

1003 
	}
}

1005 
asmlškage
 
	$do_št3
(
ıu_u£r_»gs
 *
»gs
)

1007 
	`DEBUGGER_Œ­_’Œy
(
TRAP_št3
, 
»gs
);

1009 iàĞ!
	`gue¡_mode
(
»gs
) )

1011 
	`debugg”_Œ­_çl
(
TRAP_št3
, 
»gs
);

1015 
	`do_gue¡_Œ­
(
TRAP_št3
, 
»gs
, 0);

1016 
	}
}

1018 
asmlškage
 
	$do_machše_check
(
ıu_u£r_»gs
 *
»gs
)

1020 
	`machše_check_veùÜ
(
»gs
,„egs->
”rÜ_code
);

1021 
	}
}

1023 
	$»£rved_b™_·ge_çuÉ
(

1024 
addr
, 
ıu_u£r_»gs
 *
»gs
)

1026 
	`´štk
("d%d:v%d:„eserved bit in…ageable (ec=%04X)\n",

1027 
cu¼’t
->
domaš
->
domaš_id
, cu¼’t->
vıu_id
, 
»gs
->
”rÜ_code
);

1028 
	`show_·ge_w®k
(
addr
);

1029 
	`show_executiÚ_¡©e
(
»gs
);

1030 
	}
}

1032 
	$´İag©e_·ge_çuÉ
(
addr
, 
u16
 
”rÜ_code
)

1034 
Œ­_šfo
 *
ti
;

1035 
vıu
 *
v
 = 
cu¼’t
;

1036 
Œ­_bounû
 *
tb
 = &
v
->
¬ch
.trap_bounce;

1038 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[2] = 
addr
;

1039 
	`¬ch_£t_ü2
(
v
, 
addr
);

1042 
”rÜ_code
 &ğ~
PFEC_u£r_mode
;

1043 iàĞ!
	`gue¡_k”Ãl_mode
(
v
, 
	`gue¡_ıu_u£r_»gs
()) )

1044 
”rÜ_code
 |ğ
PFEC_u£r_mode
;

1046 
	`Œaû_pv_·ge_çuÉ
(
addr
, 
”rÜ_code
);

1048 
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
TRAP_·ge_çuÉ
];

1049 
tb
->
æags
 = 
TBF_EXCEPTION
 | 
TBF_EXCEPTION_ERRCODE
;

1050 
tb
->
”rÜ_code
 =ƒrror_code;

1051 
tb
->
cs
 = 
ti
->cs;

1052 
tb
->
e
 = 
ti
->
add»ss
;

1053 iàĞ
	`TI_GET_IF
(
ti
) )

1054 
tb
->
æags
 |ğ
TBF_INTERRUPT
;

1055 iàĞ
	`uÆik–y
(
	`nuÎ_Œ­_bounû
(
v
, 
tb
)) )

1057 
	`´štk
("d%d:v%d: unhandled…age fault (ec=%04X)\n",

1058 
v
->
domaš
->
domaš_id
, v->
vıu_id
, 
”rÜ_code
);

1059 
	`show_·ge_w®k
(
addr
);

1062 iàĞ
	`uÆik–y
(
”rÜ_code
 & 
PFEC_»£rved_b™
) )

1063 
	`»£rved_b™_·ge_çuÉ
(
addr
, 
	`gue¡_ıu_u£r_»gs
());

1064 
	}
}

1066 
	$hªdË_gdt_ldt_m­pšg_çuÉ
(

1067 
off£t
, 
ıu_u£r_»gs
 *
»gs
)

1069 
vıu
 *
cu¼
 = 
cu¼’t
;

1071 
is_ldt_¬—
 = (
off£t
 >> (
GDT_LDT_VCPU_VA_SHIFT
-1)) & 1;

1072 
vıu_¬—
 = (
off£t
 >> 
GDT_LDT_VCPU_VA_SHIFT
);

1080 iàĞ
vıu_¬—
 !ğ
cu¼
->
vıu_id
 )

1084 
off£t
 &ğ(1UL << (
GDT_LDT_VCPU_VA_SHIFT
-1)) - 1UL;

1086 iàĞ
	`lik–y
(
is_ldt_¬—
) )

1089 iàĞ
	`lik–y
(
	`m­_ldt_shadow_·ge
(
off£t
 >> 
PAGE_SHIFT
)) )

1091 iàĞ
	`gue¡_mode
(
»gs
) )

1092 
	`Œaû_Œ­_two_addr
(
TRC_PV_GDT_LDT_MAPPING_FAULT
,

1093 
»gs
->
e
, 
off£t
);

1098 iàĞ!
	`gue¡_mode
(
»gs
) )

1101 
	`´İag©e_·ge_çuÉ
(

1102 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_ba£
 + 
off£t
,

1103 
»gs
->
”rÜ_code
);

1109 
»gs
->
”rÜ_code
 = (
u16
)
off£t
 & ~7;

1110 ()
	`do_g’”®_´ÙeùiÚ
(
»gs
);

1113  
EXCRET_çuÉ_fixed
;

1114 
	}
}

1116 #ifdeà
HYPERVISOR_VIRT_END


1117 
	#IN_HYPERVISOR_RANGE
(
va
) \

1118 (((
va
è>ğ
HYPERVISOR_VIRT_START
è&& ((vaè< 
HYPERVISOR_VIRT_END
))

	)

1120 
	#IN_HYPERVISOR_RANGE
(
va
) \

1121 (((
va
è>ğ
HYPERVISOR_VIRT_START
))

	)

1124 
	$__¥urious_·ge_çuÉ
(

1125 
addr
, 
”rÜ_code
)

1127 
mâ
, 
ü3
 = 
	`»ad_ü3
();

1128 #ià
CONFIG_PAGING_LEVELS
 >= 4

1129 
l4_pg’Œy_t
 
l4e
, *
l4t
;

1131 #ià
CONFIG_PAGING_LEVELS
 >= 3

1132 
l3_pg’Œy_t
 
l3e
, *
l3t
;

1134 
l2_pg’Œy_t
 
l2e
, *
l2t
;

1135 
l1_pg’Œy_t
 
l1e
, *
l1t
;

1136 
»quœed_æags
, 
di§Îowed_æags
;

1143 iàĞ
	`š_œq
() )

1147 iàĞ
”rÜ_code
 & 
PFEC_»£rved_b™
 )

1150 
»quœed_æags
 = 
_PAGE_PRESENT
;

1151 iàĞ
”rÜ_code
 & 
PFEC_wr™e_acûss
 )

1152 
»quœed_æags
 |ğ
_PAGE_RW
;

1153 iàĞ
”rÜ_code
 & 
PFEC_u£r_mode
 )

1154 
»quœed_æags
 |ğ
_PAGE_USER
;

1156 
di§Îowed_æags
 = 0;

1157 iàĞ
”rÜ_code
 & 
PFEC_š¢_ãtch
 )

1158 
di§Îowed_æags
 |ğ
_PAGE_NX
;

1160 
mâ
 = 
ü3
 >> 
PAGE_SHIFT
;

1162 #ià
CONFIG_PAGING_LEVELS
 >= 4

1163 
l4t
 = 
	`m­_domaš_·ge
(
mâ
);

1164 
l4e
 = 
	`l4e_»ad_©omic
(&
l4t
[
	`l4_bË_off£t
(
addr
)]);

1165 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

1166 
	`unm­_domaš_·ge
(
l4t
);

1167 iàĞ((
	`l4e_g‘_æags
(
l4e
è& 
»quœed_æags
) !=„equired_flags) ||

1168 (
	`l4e_g‘_æags
(
l4e
è& 
di§Îowed_æags
) )

1172 #ià
CONFIG_PAGING_LEVELS
 >= 3

1173 
l3t
 = 
	`m­_domaš_·ge
(
mâ
);

1174 #ià
CONFIG_PAGING_LEVELS
 == 3

1175 
l3t
 +ğ(
ü3
 & 0xFE0UL) >> 3;

1177 
l3e
 = 
	`l3e_»ad_©omic
(&
l3t
[
	`l3_bË_off£t
(
addr
)]);

1178 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

1179 
	`unm­_domaš_·ge
(
l3t
);

1180 #ià
CONFIG_PAGING_LEVELS
 == 3

1181 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

1184 iàĞ((
	`l3e_g‘_æags
(
l3e
è& 
»quœed_æags
) !=„equired_flags) ||

1185 (
	`l3e_g‘_æags
(
l3e
è& 
di§Îowed_æags
) )

1187 iàĞ
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
 )

1192 
l2t
 = 
	`m­_domaš_·ge
(
mâ
);

1193 
l2e
 = 
	`l2e_»ad_©omic
(&
l2t
[
	`l2_bË_off£t
(
addr
)]);

1194 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

1195 
	`unm­_domaš_·ge
(
l2t
);

1196 iàĞ((
	`l2e_g‘_æags
(
l2e
è& 
»quœed_æags
) !=„equired_flags) ||

1197 (
	`l2e_g‘_æags
(
l2e
è& 
di§Îowed_æags
) )

1199 iàĞ
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
 )

1202 
l1t
 = 
	`m­_domaš_·ge
(
mâ
);

1203 
l1e
 = 
	`l1e_»ad_©omic
(&
l1t
[
	`l1_bË_off£t
(
addr
)]);

1204 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

1205 
	`unm­_domaš_·ge
(
l1t
);

1206 iàĞ((
	`l1e_g‘_æags
(
l1e
è& 
»quœed_æags
) !=„equired_flags) ||

1207 (
	`l1e_g‘_æags
(
l1e
è& 
di§Îowed_æags
) )

1211 
	}
}

1213 
	$¥urious_·ge_çuÉ
(

1214 
addr
, 
”rÜ_code
)

1216 
æags
;

1217 
is_¥urious
;

1223 
	`loÿl_œq_§ve
(
æags
);

1224 
is_¥urious
 = 
	`__¥urious_·ge_çuÉ
(
addr
, 
”rÜ_code
);

1225 
	`loÿl_œq_»¡Üe
(
æags
);

1227  
is_¥urious
;

1228 
	}
}

1230 
	$fixup_·ge_çuÉ
(
addr
, 
ıu_u£r_»gs
 *
»gs
)

1232 
vıu
 *
v
 = 
cu¼’t
;

1233 
domaš
 *
d
 = 
v
->domain;

1236 iàĞ
	`š_œq
(è|| !(
»gs
->
eæags
 & 
X86_EFLAGS_IF
) )

1240 iàĞ
	`·gšg_mode_ex‹º®
(
d
è&& 
	`gue¡_mode
(
»gs
) )

1242 
»t
 = 
	`·gšg_çuÉ
(
addr
, 
»gs
);

1243 iàĞ
»t
 =ğ
EXCRET_çuÉ_fixed
 )

1244 
	`Œaû_Œ­_two_addr
(
TRC_PV_PAGING_FIXUP
, 
»gs
->
e
, 
addr
);

1245  
»t
;

1248 iàĞ!(
»gs
->
”rÜ_code
 & 
PFEC_·ge_´e£Á
) &&

1249 (
	`·geçuÉ_by_memadd
(
addr
, 
»gs
)) )

1250  
	`hªdË_memadd_çuÉ
(
addr
, 
»gs
);

1252 iàĞ
	`uÆik–y
(
	`IN_HYPERVISOR_RANGE
(
addr
)) )

1254 iàĞ!(
»gs
->
”rÜ_code
 & (
PFEC_u£r_mode
 | 
PFEC_»£rved_b™
)) &&

1255 (
addr
 >ğ
GDT_LDT_VIRT_START
è&& (add¸< 
GDT_LDT_VIRT_END
) )

1256  
	`hªdË_gdt_ldt_m­pšg_çuÉ
(

1257 
addr
 - 
GDT_LDT_VIRT_START
, 
»gs
);

1261 iàĞ
	`VM_ASSIST
(
d
, 
VMASST_TYPE_wr™abË_·g‘abËs
) &&

1262 
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

1264 
mbs
 = 
PFEC_wr™e_acûss
;

1265 
mbz
 = 
PFEC_»£rved_b™
 | 
PFEC_š¢_ãtch
;

1269 iàĞ!
	`·gšg_mode_’abËd
(
d
) )

1270 
mbs
 |ğ
PFEC_·ge_´e£Á
;

1272 iàĞ((
»gs
->
”rÜ_code
 & (
mbs
 | 
mbz
)) == mbs) &&

1273 
	`±wr_do_·ge_çuÉ
(
v
, 
addr
, 
»gs
) )

1274  
EXCRET_çuÉ_fixed
;

1279 iàĞ
	`·gšg_mode_’abËd
(
d
è&& !
	`·gšg_mode_ex‹º®
(d) )

1281 
»t
 = 
	`·gšg_çuÉ
(
addr
, 
»gs
);

1282 iàĞ
»t
 =ğ
EXCRET_çuÉ_fixed
 )

1283 
	`Œaû_Œ­_two_addr
(
TRC_PV_PAGING_FIXUP
, 
»gs
->
e
, 
addr
);

1284  
»t
;

1288 
	}
}

1299 #ifdeà
VERBOSE_PAGE_FAULT


1300 
	gpf_couÁ
;

1303 
asmlškage
 
	$do_·ge_çuÉ
(
ıu_u£r_»gs
 *
»gs
)

1305 
addr
, 
fixup
;

1306 
”rÜ_code
;

1307 #ifdeà
VERBOSE_PAGE_FAULT


1308 ià(
pf_couÁ
 > 0)…f_count--;

1311 
addr
 = 
	`»ad_ü2
();

1314 
”rÜ_code
 = 
»gs
->error_code;

1316 #ifdeà
VERBOSE_PAGE_FAULT


1317 ià(
pf_couÁ
>0) {

1318 
	`´štk
("(%3d,v%d@%d):add¸%°”r:%x,ƒ:%p,ƒ¥:%°", 
pf_couÁ
, 
cu¼’t
->
vıu_id
, cu¼’t->
´oûssÜ
 , 
addr
, 
»gs
->
”rÜ_code
,„egs->
e
,„egs->
e¥
);

1321 #ifdeà
ENABLE_CHECK_PAGE_TOUCH


1322 ià(
mši_aùiv©ed
) {

1323 
cu¼’t
->
vcouÁ
[
PTOUCH_PAGE_FAULT
]++;

1328 ià(
addr
 >= 0xffffffffff600000UL &&‡ddr < 0xffffffffff601000UL) {

1330 #ifdeà
VERBOSE_PAGE_FAULT


1331 ià(
pf_couÁ
>0)

1332 
	`´štk
(" vsyscall.");

1337 ià(
	`check_·ge_touch
(
addr
, 
»gs
)) {

1338 #ifdeà
VERBOSE_PAGE_FAULT


1339 ià(
pf_couÁ
>0)

1340 
	`´štk
(" done. \n");

1345 #ifdeà
VERBOSE_PAGE_FAULT


1346 ià(
pf_couÁ
>0)

1347 
	`´štk
("->cont\n");

1350 
	`DEBUGGER_Œ­_’Œy
(
TRAP_·ge_çuÉ
, 
»gs
);

1352 
	`³rfc_šü
(
·ge_çuÉs
);

1354 iàĞ
	`uÆik–y
(
	`fixup_·ge_çuÉ
(
addr
, 
»gs
) != 0) )

1357 iàĞ
	`uÆik–y
(!
	`gue¡_mode
(
»gs
)) )

1359 iàĞ
	`¥urious_·ge_çuÉ
(
addr
, 
”rÜ_code
) )

1362 iàĞ
	`lik–y
((
fixup
 = 
	`£¬ch_exû±iÚ_bË
(
»gs
->
e
)) != 0) )

1364 
	`³rfc_šü
(
cİy_u£r_çuÉs
);

1365 iàĞ
	`uÆik–y
(
»gs
->
”rÜ_code
 & 
PFEC_»£rved_b™
) )

1366 
	`»£rved_b™_·ge_çuÉ
(
addr
, 
»gs
);

1367 
»gs
->
e
 = 
fixup
;

1371 
	`DEBUGGER_Œ­_çl
(
TRAP_·ge_çuÉ
, 
»gs
);

1373 
	`show_executiÚ_¡©e
(
»gs
);

1374 
	`show_·ge_w®k
(
addr
);

1375 
	`·nic
("FATAL PAGE FAULT\n"

1378 
”rÜ_code
, 
	`_p
(
addr
));

1381 iàĞ
	`uÆik–y
(
cu¼’t
->
domaš
->
¬ch
.
suµ»ss_¥urious_·ge_çuÉs


1382 && 
	`¥urious_·ge_çuÉ
(
addr
, 
”rÜ_code
)) )

1385 #ifdeà
VERBOSE_PAGE_FAULT


1386 ià(
pf_couÁ
>0)

1387 
	`´štk
(" ->propagate\n");

1390 ià(
mši_aùiv©ed
)

1391 
cu¼’t
->
vcouÁ
[
PTOUCH_PROPAGATE_GUEST
]++;

1394 
	`´İag©e_·ge_çuÉ
(
addr
, 
»gs
->
”rÜ_code
);

1395 
	}
}

1404 
asmlškage
 
__š™
 
	$do_—¾y_·ge_çuÉ
(
ıu_u£r_»gs
 *
»gs
)

1406 
¡uck
;

1407 
´ev_e
, 
´ev_ü2
;

1408 
ü2
 = 
	`»ad_ü2
();

1410 
	`BUG_ON
(
	`smp_´oûssÜ_id
() != 0);

1412 iàĞ(
»gs
->
e
 !ğ
´ev_e
è|| (
ü2
 !ğ
´ev_ü2
) )

1414 
´ev_e
 = 
»gs
->
e
;

1415 
´ev_ü2
 = 
ü2
;

1416 
¡uck
 = 0;

1420 iàĞ
¡uck
++ == 1000 )

1422 *
¡k
 = (*)
»gs
;

1423 
	`´štk
("Early fatal…age fault‡t %04x:%p (cr2=%p,ƒc=%04x)\n",

1424 
»gs
->
cs
, 
	`_p
Ôegs->
e
), _p(
ü2
),„egs->
”rÜ_code
);

1425 
	`´štk
("Stack dump: ");

1426  (()
¡k
 & ((
PAGE_SIZE
 - 1è& ~(
BYTES_PER_LONG
 - 1))) != 0 )

1427 
	`´štk
("%°", 
	`_p
(*
¡k
++));

1430 
	}
}

1432 
	$do_åu_sksw™ch
(
£t
)

1434 
vıu
 *
v
 = 
cu¼’t
;

1436 iàĞ
£t
 )

1438 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] |ğ
X86_CR0_TS
;

1439 
	`¡ts
();

1443 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] &ğ~
X86_CR0_TS
;

1444 iàĞ
v
->
åu_dœt›d
 )

1445 
	`şts
();

1449 
	}
}

1451 
	$»ad_desütÜ
(
£l
,

1452 cÚ¡ 
vıu
 *
v
,

1453 cÚ¡ 
ıu_u£r_»gs
 * 
»gs
,

1454 *
ba£
,

1455 *
lim™
,

1456 *
¬
,

1457 
vm86©Œ
)

1459 
desc_¡ruù
 
desc
;

1461 iàĞ!
	`vm86_mode
(
»gs
) )

1463 iàĞ
£l
 < 4)

1464 
desc
.
b
 = desc.
a
 = 0;

1465 iàĞ
	`__g‘_u£r
(
desc
,

1466 (cÚ¡ 
desc_¡ruù
 *)(!(
£l
 & 4)

1467 ? 
	`GDT_VIRT_START
(
v
)

1468 : 
	`LDT_VIRT_START
(
v
))

1469 + (
£l
 >> 3)) )

1471 iàĞ!(
vm86©Œ
 & 
_SEGMENT_CODE
) )

1472 
desc
.
b
 &ğ~
_SEGMENT_L
;

1476 
desc
.
a
 = (
£l
 << 20) | 0xffff;

1477 
desc
.
b
 = 
vm86©Œ
 | (
£l
 >> 12);

1480 *
¬
 = 
desc
.
b
 & 0x00f0ff00;

1481 iàĞ!(
desc
.
b
 & 
_SEGMENT_L
) )

1483 *
ba£
 = ((
desc
.
a
 >> 16è+ ((desc.
b
 & 0xff) << 16) +

1484 (
desc
.
b
 & 0xff000000));

1485 *
lim™
 = (
desc
.
a
 & 0xffffè| (desc.
b
 & 0x000f0000);

1486 iàĞ
desc
.
b
 & 
_SEGMENT_G
 )

1487 *
lim™
 = ((*limit + 1) << 12) - 1;

1488 #iâdeà
NDEBUG


1489 iàĞ!
	`vm86_mode
(
»gs
è&& (
£l
 > 3) )

1491 
a
, 
l
;

1492 
v®id
;

1494 
asm
 volatile (

1496 : "ô" (
a
), "=qm" (
v®id
è: "rm" (
£l
));

1497 
	`BUG_ON
(
v®id
 && ((
a
 & 0x00f0ff00è!ğ*
¬
));

1498 
asm
 volatile (

1500 : "ô" (
l
), "=qm" (
v®id
è: "rm" (
£l
));

1501 
	`BUG_ON
(
v®id
 && (
l
 !ğ*
lim™
));

1507 *
ba£
 = 0UL;

1508 *
lim™
 = ~0UL;

1512 
	}
}

1514 #ifdeà
__x86_64__


1515 
	$»ad_g©e_desütÜ
(
g©e_£l
,

1516 cÚ¡ 
vıu
 *
v
,

1517 *
£l
,

1518 *
off
,

1519 *
¬
)

1521 
desc_¡ruù
 
desc
;

1522 cÚ¡ 
desc_¡ruù
 *
pdesc
;

1525 
pdesc
 = (cÚ¡ 
desc_¡ruù
 *)

1526 (!(
g©e_£l
 & 4è? 
	`GDT_VIRT_START
(
v
è: 
	`LDT_VIRT_START
(v))

1527 + (
g©e_£l
 >> 3);

1528 iàĞ(
g©e_£l
 < 4) ||

1529 ((
g©e_£l
 >ğ
FIRST_RESERVED_GDT_BYTE
) && !(gate_sel & 4)) ||

1530 
	`__g‘_u£r
(
desc
, 
pdesc
) )

1533 *
£l
 = (
desc
.
a
 >> 16) & 0x0000fffc;

1534 *
off
 = (
desc
.
a
 & 0x0000ffffè| (desc.
b
 & 0xffff0000);

1535 *
¬
 = 
desc
.
b
 & 0x0000ffff;

1541 iàĞ*
¬
 & 
_SEGMENT_DPL
 )

1543 *
¬
 |ğ(
desc
.
a
 >> (16 - 13)è& 
_SEGMENT_DPL
;

1545 iàĞ!
	`is_pv_32b™_vıu
(
v
) )

1547 iàĞ(*
¬
 & 0x1f00) != 0x0c00 ||

1548 (
g©e_£l
 >ğ
FIRST_RESERVED_GDT_BYTE
 - 8 && !(gate_sel & 4)) ||

1549 
	`__g‘_u£r
(
desc
, 
pdesc
 + 1) ||

1550 (
desc
.
b
 & 0x1f00) )

1553 *
off
 |ğ()
desc
.
a
 << 32;

1557  *
¬
 & 0x1f00 )

1560 *
off
 &= 0xffff;

1569 
	}
}

1573 
	$gue¡_io_okay
(

1574 
pÜt
, 
by‹s
,

1575 
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1577 #ià
	`defšed
(
__x86_64__
)

1579 
u£r_mode
 = !(
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
);

1580 
	#TOGGLE_MODE
(èiàĞ
u£r_mode
 ) 
	`toggË_gue¡_mode
(
v
)

	)

1581 #–ià
	`defšed
(
__i386__
)

1582 
	#TOGGLE_MODE
(è(()0)

	)

1585 iàĞ!
	`vm86_mode
(
»gs
) &&

1586 (
v
->
¬ch
.
iİl
 >ğ(
	`gue¡_k”Ãl_mode
(v, 
»gs
) ? 1 : 3)) )

1589 iàĞ
v
->
¬ch
.
iobmp_lim™
 > (
pÜt
 + 
by‹s
) )

1591 uniÚ { 
ušt8_t
 
by‹s
[2]; 
ušt16_t
 
mask
; } 
x
;

1597 
	`TOGGLE_MODE
();

1598  
	`__cİy_äom_gue¡_off£t
(
x
.
by‹s
, 
v
->
¬ch
.
iobmp
,

1599 
pÜt
>>3, 2) )

1601 : 
x
.
by‹s
[0] = ~0;

1602 1: 
x
.
by‹s
[1] = ~0;

1605 
	`TOGGLE_MODE
();

1607 iàĞ(
x
.
mask
 & (((1<<
by‹s
)-1è<< (
pÜt
&7))) == 0 )

1612 
	}
}

1615 
	$admš_io_okay
(

1616 
pÜt
, 
by‹s
,

1617 
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1623 iàĞ(
pÜt
 =ğ0xcf8è&& (
by‹s
 == 4) )

1626  
	`iİÜts_acûss_³rm™‹d
(
v
->
domaš
, 
pÜt
,…Üˆ+ 
by‹s
 - 1);

1627 
	}
}

1629 
ušt32_t
 
	$gue¡_io_»ad
(

1630 
pÜt
, 
by‹s
,

1631 
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1633 
ušt32_t
 
d©a
 = 0;

1634 
shiá
 = 0;

1636 iàĞ
	`admš_io_okay
(
pÜt
, 
by‹s
, 
v
, 
»gs
) )

1638  
by‹s
 )

1640 1:  
	`šb
(
pÜt
);

1641 2:  
	`šw
(
pÜt
);

1642 4:  
	`šl
(
pÜt
);

1646  
by‹s
 != 0 )

1648 
size
 = 1;

1649 
ušt32_t
 
sub_d©a
 = 0xff;

1651 iàĞ(
pÜt
 == 0x42) || (port == 0x43) || (port == 0x61) )

1653 
sub_d©a
 = 
	`pv_p™_hªdËr
(
pÜt
, 0, 0);

1655 iàĞ(
pÜt
 =ğ0xcf8è&& (
by‹s
 == 4) )

1657 
size
 = 4;

1658 
sub_d©a
 = 
v
->
domaš
->
¬ch
.
pci_cf8
;

1660 iàĞ((
pÜt
 & 0xfffcè=ğ0xcfcè&& 
	`IS_PRIV
(
v
->
domaš
) )

1662 
size
 = 
	`mš
(
by‹s
, 4 - (
pÜt
 & 3));

1663 iàĞ
size
 == 3 )

1664 
size
 = 2;

1665 
sub_d©a
 = 
	`pci_cÚf_»ad
(
v
->
domaš
->
¬ch
.
pci_cf8
, 
pÜt
 & 3, 
size
);

1668 iàĞ
size
 == 4 )

1669  
sub_d©a
;

1671 
d©a
 |ğ(
sub_d©a
 & ((1u << (
size
 * 8)è- 1)è<< 
shiá
;

1672 
shiá
 +ğ
size
 * 8;

1673 
pÜt
 +ğ
size
;

1674 
by‹s
 -ğ
size
;

1677  
d©a
;

1678 
	}
}

1680 (*
pv_¹c_hªdËr
)(
pÜt
, 
ušt8_t
 
v®ue
);

1682 
	$gue¡_io_wr™e
(

1683 
pÜt
, 
by‹s
, 
ušt32_t
 
d©a
,

1684 
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
)

1686 iàĞ
	`admš_io_okay
(
pÜt
, 
by‹s
, 
v
, 
»gs
) )

1688  
by‹s
 ) {

1690 iàĞ((
pÜt
 =ğ0x70è|| (pÜˆ=ğ0x71)è&& 
pv_¹c_hªdËr
 )

1691 
	`pv_¹c_hªdËr
(
pÜt
, (
ušt8_t
)
d©a
);

1692 
	`outb
((
ušt8_t
)
d©a
, 
pÜt
);

1693 iàĞ
pv_po¡_outb_hook
 )

1694 
	`pv_po¡_outb_hook
(
pÜt
, (
ušt8_t
)
d©a
);

1697 
	`outw
((
ušt16_t
)
d©a
, 
pÜt
);

1700 
	`ou
(
d©a
, 
pÜt
);

1706  
by‹s
 != 0 )

1708 
size
 = 1;

1710 iàĞ(
pÜt
 == 0x42) || (port == 0x43) || (port == 0x61) )

1712 
	`pv_p™_hªdËr
(
pÜt
, (
ušt8_t
)
d©a
, 1);

1714 iàĞ(
pÜt
 =ğ0xcf8è&& (
by‹s
 == 4) )

1716 
size
 = 4;

1717 
v
->
domaš
->
¬ch
.
pci_cf8
 = 
d©a
;

1719 iàĞ((
pÜt
 & 0xfffcè=ğ0xcfcè&& 
	`IS_PRIV
(
v
->
domaš
) )

1721 
size
 = 
	`mš
(
by‹s
, 4 - (
pÜt
 & 3));

1722 iàĞ
size
 == 3 )

1723 
size
 = 2;

1724 
	`pci_cÚf_wr™e
(
v
->
domaš
->
¬ch
.
pci_cf8
, 
pÜt
 & 3, 
size
, 
d©a
);

1727 iàĞ
size
 == 4 )

1730 
pÜt
 +ğ
size
;

1731 
by‹s
 -ğ
size
;

1732 
d©a
 >>ğ
size
 * 8;

1734 
	}
}

1737 
	$ho¡_to_gue¡_g´_sw™ch
(
ıu_u£r_»gs
 *)

1738 
	`__©Œibu‹__
((
	`__»g·rm__
(1)));

1739 
	$gue¡_to_ho¡_g´_sw™ch
()

1740 
	`__©Œibu‹__
((
	`__»g·rm__
(1)));

1742 (*
pv_po¡_outb_hook
)(
pÜt
, 
u8
 
v®ue
);

1744 
šlše
 
ušt64_t
 
	$gue¡_misc_’abË
(
ušt64_t
 
v®
)

1746 
v®
 &ğ~(
MSR_IA32_MISC_ENABLE_PERF_AVAIL
 |

1747 
MSR_IA32_MISC_ENABLE_MONITOR_ENABLE
);

1748 
v®
 |ğ
MSR_IA32_MISC_ENABLE_BTS_UNAVAIL
 |

1749 
MSR_IA32_MISC_ENABLE_PEBS_UNAVAIL
 |

1750 
MSR_IA32_MISC_ENABLE_XTPR_DISABLE
;

1751  
v®
;

1752 
	}
}

1755 
	#š¢_ãtch
(
ty³
, 
ba£
, 
e
, 
lim™
) \

1756 ({ 
_rc
, 
_±r
 = (
ba£
è+ (
e
); \

1757 
ty³
 
_x
; \

1758 iàĞ
ad_deçuÉ
 < 8 ) \

1759 
_±r
 = ()_ptr; \

1760 iàĞ(
lim™
è< (
_x
è- 1 || (
e
) > (limit) - ((_x) - 1) ) \

1761 
ç
; \

1762 iàĞ(
_rc
 = 
	`cİy_äom_u£r
(&
_x
, (
ty³
 *)
_±r
, (_x))) != 0 ) \

1764 
	`´İag©e_·ge_çuÉ
(
_±r
 + (
_x
è- 
_rc
, 0); \

1765 
sk
; \

1767 (
e
è+ğ(
_x
); _x; })

	)

1769 #ià
defšed
(
CONFIG_X86_32
)

1770 
	#»ad_¤eg
(
»gs
, 
¤
è(Ôegs)->¤)

	)

1771 #–ià
defšed
(
CONFIG_X86_64
)

1772 
	#»ad_¤eg
(
»gs
, 
¤
è
	`»ad_£gm’t_»gi¡”
(¤)

	)

1775 
	$is_ıuäeq_cÚŒŞËr
(
domaš
 *
d
)

1777  ((
ıuäeq_cÚŒŞËr
 =ğ
FREQCTL_dom0_k”Ãl
) &&

1778 (
d
->
domaš_id
 == 0));

1779 
	}
}

1781 #ifdeà
CONFIG_X86_64


1782 
	~"x86_64/mmcÚfig.h
"

1785 
	$emuÏ‹_´iveged_İ
(
ıu_u£r_»gs
 *
»gs
)

1787 
vıu
 *
v
 = 
cu¼’t
;

1788 *
»g
, 
e
 = 
»gs
->eip;

1789 
u8
 
İcode
, 
modrm_»g
 = 0, 
modrm_rm
 = 0, 
»p_´efix
 = 0, 
lock
 = 0, 
»x
 = 0;

1790 ’um { 
lm_£g_nÚe
, 
lm_£g_fs
, 
lm_£g_gs
 } 
lm_ovr
 =†m_seg_none;

1791 
rc
;

1792 
pÜt
, 
i
, 
d©a_£l
, 
¬
, 
d©a
, 
bpm©ch
 = 0;

1793 
İ_by‹s
, 
İ_deçuÉ
, 
ad_by‹s
, 
ad_deçuÉ
, 
İsize_´efix
= 0;

1794 
	#rd_ad
(
»g
è(
ad_by‹s
 >ğ(
»gs
->reg) \

1795 ? 
»gs
->
»g
 \

1796 : 
ad_by‹s
 == 4 \

1797 ? (
u32
)
»gs
->
»g
 \

1798 : (
u16
)
»gs
->
»g
)

	)

1799 
	#wr_ad
(
»g
, 
v®
è(
ad_by‹s
 >ğ(
»gs
->reg) \

1800 ? 
»gs
->
»g
 = (
v®
) \

1801 : 
ad_by‹s
 == 4 \

1802 ? (*(
u32
 *)&
»gs
->
»g
 = (
v®
)) \

1803 : (*(
u16
 *)&
»gs
->
»g
 = (
v®
)))

	)

1804 
code_ba£
, 
code_lim™
;

1805 
io_emul_¡ub
[32];

1806 (*
io_emul
)(
ıu_u£r_»gs
 *è
	`__©Œibu‹__
((
	`__»g·rm__
(1)));

1807 
ušt64_t
 
v®
, 
m¤_cÚ‹Á
;

1809 iàĞ!
	`»ad_desütÜ
(
»gs
->
cs
, 
v
,„egs,

1810 &
code_ba£
, &
code_lim™
, &
¬
,

1811 
_SEGMENT_CODE
|
_SEGMENT_S
|
_SEGMENT_DPL
|
_SEGMENT_P
) )

1812 
ç
;

1813 
İ_deçuÉ
 = 
İ_by‹s
 = (
¬
 & (
_SEGMENT_L
|
_SEGMENT_DB
)) ? 4 : 2;

1814 
ad_deçuÉ
 = 
ad_by‹s
 = (
¬
 & 
_SEGMENT_L
è? 8 : 
İ_deçuÉ
;

1815 iàĞ!(
¬
 & 
_SEGMENT_S
) ||

1816 !(
¬
 & 
_SEGMENT_P
) ||

1817 !(
¬
 & 
_SEGMENT_CODE
) )

1818 
ç
;

1821 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
ds
);

1824  
i
 = 0; i < 8; i++, 
»x
 =ğ
İcode
 || (rex = 0) )

1826  
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
) )

1829 
İsize_´efix
 = 1;

1830 
İ_by‹s
 = 
İ_deçuÉ
 ^ 6;

1833 
ad_by‹s
 = 
ad_deçuÉ
 != 4 ? 4 : 2;

1836 
d©a_£l
 = 
»gs
->
cs
;

1839 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
ds
);

1842 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
es
);

1845 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
fs
);

1846 
lm_ovr
 = 
lm_£g_fs
;

1849 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
gs
);

1850 
lm_ovr
 = 
lm_£g_gs
;

1853 
d©a_£l
 = 
»gs
->
ss
;

1856 
lock
 = 1;

1860 
»p_´efix
 = 1;

1863 iàĞ(
¬
 & 
_SEGMENT_L
è&& (
İcode
 & 0xf0) == 0x40 )

1865 
»x
 = 
İcode
;

1874 iàĞ
»x
 & 8 )

1875 
İ_by‹s
 = 4;

1876 
modrm_»g
 = (
»x
 & 4) << 1;

1878 
modrm_rm
 = (
»x
 & 1) << 3;

1880 iàĞ
İcode
 == 0x0f )

1881 
twoby‹_İcode
;

1883 iàĞ
lock
 )

1884 
ç
;

1887 iàĞ(
İcode
 >= 0x6c) && (opcode <= 0x6f) )

1889 
d©a_ba£
, 
d©a_lim™
;

1891 iàĞ
»p_´efix
 && (
	`rd_ad
(
ecx
) == 0) )

1892 
dÚe
;

1894 iàĞ!(
İcode
 & 2) )

1896 
d©a_£l
 = 
	`»ad_¤eg
(
»gs
, 
es
);

1897 
lm_ovr
 = 
lm_£g_nÚe
;

1900 iàĞ!(
¬
 & 
_SEGMENT_L
) )

1902 iàĞ!
	`»ad_desütÜ
(
d©a_£l
, 
v
, 
»gs
,

1903 &
d©a_ba£
, &
d©a_lim™
, &
¬
,

1904 
_SEGMENT_WR
|
_SEGMENT_S
|
_SEGMENT_DPL
|

1905 
_SEGMENT_P
) )

1906 
ç
;

1907 iàĞ!(
¬
 & 
_SEGMENT_S
) ||

1908 !(
¬
 & 
_SEGMENT_P
) ||

1909 (
İcode
 & 2 ?

1910 (
¬
 & 
_SEGMENT_CODE
è&& !×¸& 
_SEGMENT_WR
) :

1911 (
¬
 & 
_SEGMENT_CODE
è|| !×¸& 
_SEGMENT_WR
)) )

1912 
ç
;

1914 #ifdeà
CONFIG_X86_64


1917 iàĞ
lm_ovr
 =ğ
lm_£g_nÚe
 || 
d©a_£l
 < 4 )

1919  
lm_ovr
 )

1921 
lm_£g_nÚe
:

1922 
d©a_ba£
 = 0UL;

1924 
lm_£g_fs
:

1925 
d©a_ba£
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
fs_ba£
;

1927 
lm_£g_gs
:

1928 iàĞ
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

1929 
d©a_ba£
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_k”Ãl
;

1931 
d©a_ba£
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_u£r
;

1936 
	`»ad_desütÜ
(
d©a_£l
, 
v
, 
»gs
,

1937 &
d©a_ba£
, &
d©a_lim™
, &
¬
,

1939 
d©a_lim™
 = ~0UL;

1940 
¬
 = 
_SEGMENT_WR
|
_SEGMENT_S
|
_SEGMENT_DPL
|
_SEGMENT_P
;

1944 
pÜt
 = (
u16
)
»gs
->
edx
;

1946 
cÚtšue_io_¡ršg
:

1947  
İcode
 )

1950 
İ_by‹s
 = 1;

1952 iàĞ(
d©a_lim™
 < (
İ_by‹s
 - 1)) ||

1953 (
	`rd_ad
(
edi
è> (
d©a_lim™
 - (
İ_by‹s
 - 1))) ||

1954 !
	`gue¡_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

1955 
ç
;

1956 
d©a
 = 
	`gue¡_io_»ad
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
);

1957 iàĞ(
rc
 = 
	`cİy_to_u£r
((*)
d©a_ba£
 + 
	`rd_ad
(
edi
),

1958 &
d©a
, 
İ_by‹s
)) != 0 )

1960 
	`´İag©e_·ge_çuÉ
(
d©a_ba£
 + 
	`rd_ad
(
edi
è+ 
İ_by‹s
 - 
rc
,

1961 
PFEC_wr™e_acûss
);

1962  
EXCRET_çuÉ_fixed
;

1964 
	`wr_ad
(
edi
, 
»gs
->ed˜+ ()(Ôegs->
eæags
 & 
X86_EFLAGS_DF
)

1965 ? -
İ_by‹s
 : op_bytes));

1969 
İ_by‹s
 = 1;

1971 iàĞ(
d©a_lim™
 < (
İ_by‹s
 - 1)) ||

1972 (
	`rd_ad
(
esi
è> (
d©a_lim™
 - (
İ_by‹s
 - 1))) ||

1973 !
	`gue¡_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

1974 
ç
;

1975 iàĞ(
rc
 = 
	`cİy_äom_u£r
(&
d©a
, (*)
d©a_ba£
 + 
	`rd_ad
(
esi
),

1976 
İ_by‹s
)) != 0 )

1978 
	`´İag©e_·ge_çuÉ
(
d©a_ba£
 + 
	`rd_ad
(
esi
)

1979 + 
İ_by‹s
 - 
rc
, 0);

1980  
EXCRET_çuÉ_fixed
;

1982 
	`gue¡_io_wr™e
(
pÜt
, 
İ_by‹s
, 
d©a
, 
v
, 
»gs
);

1983 
	`wr_ad
(
esi
, 
»gs
->es˜+ ()(Ôegs->
eæags
 & 
X86_EFLAGS_DF
)

1984 ? -
İ_by‹s
 : op_bytes));

1988 
bpm©ch
 = 
	`check_gue¡_io_b»akpošt
(
v
, 
pÜt
, 
İ_by‹s
);

1990 iàĞ
»p_´efix
 && (
	`wr_ad
(
ecx
, 
»gs
->ecx - 1) != 0) )

1992 iàĞ!
bpm©ch
 && !
	`hy³rÿÎ_´“m±_check
() )

1993 
cÚtšue_io_¡ršg
;

1994 
e
 = 
»gs
->eip;

1997 
dÚe
;

2006 #ifdeà
__x86_64__


2008 
io_emul_¡ub
[0] = 0x48;

2009 
io_emul_¡ub
[1] = 0xb9;

2010 *(**)&
io_emul_¡ub
[2] = (*)
ho¡_to_gue¡_g´_sw™ch
;

2012 
io_emul_¡ub
[10] = 0xff;

2013 
io_emul_¡ub
[11] = 0xd1;

2016 
io_emul_¡ub
[0] = 0xe8;

2017 *(
s32
 *)&
io_emul_¡ub
[1] =

2018 (*)
ho¡_to_gue¡_g´_sw™ch
 - &
io_emul_¡ub
[5];

2020 
	`mem£t
(&
io_emul_¡ub
[5], 0x90, 7);

2023 
io_emul_¡ub
[12] = (
İ_by‹s
 != 2) ? 0x90 : 0x66;

2025 
io_emul_¡ub
[13] = 
İcode
;

2027 
io_emul_¡ub
[14] = 0x90;

2029 
io_emul_¡ub
[15] = 0xc3;

2032 
io_emul
 = (*)
io_emul_¡ub
;

2034 iàĞ
iÛmul_hªdË_quœk
 )

2035 
	`iÛmul_hªdË_quœk
(
İcode
, &
io_emul_¡ub
[12], 
»gs
);

2038  
İcode
 )

2041 
İ_by‹s
 = 1;

2043 
pÜt
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2044 
io_emul_¡ub
[14] = 
pÜt
;

2045 
exec_š
:

2046 iàĞ!
	`gue¡_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

2047 
ç
;

2048 iàĞ
	`admš_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

2050 
	`io_emul
(
»gs
);

2054 iàĞ
İ_by‹s
 == 4 )

2055 
»gs
->
—x
 = 0;

2057 
»gs
->
—x
 &ğ~((1u << (
İ_by‹s
 * 8)) - 1);

2058 
»gs
->
—x
 |ğ
	`gue¡_io_»ad
(
pÜt
, 
İ_by‹s
, 
v
,„egs);

2060 
bpm©ch
 = 
	`check_gue¡_io_b»akpošt
(
v
, 
pÜt
, 
İ_by‹s
);

2061 
dÚe
;

2064 
İ_by‹s
 = 1;

2066 
pÜt
 = (
u16
)
»gs
->
edx
;

2067 
exec_š
;

2070 
İ_by‹s
 = 1;

2072 
pÜt
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2073 
io_emul_¡ub
[14] = 
pÜt
;

2074 
exec_out
:

2075 iàĞ!
	`gue¡_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

2076 
ç
;

2077 iàĞ
	`admš_io_okay
(
pÜt
, 
İ_by‹s
, 
v
, 
»gs
) )

2079 iàĞ(
İ_by‹s
 == 1) &&

2080 ((
pÜt
 == 0x71) || (port == 0x70)) &&

2081 
pv_¹c_hªdËr
 )

2082 
	`pv_¹c_hªdËr
(
pÜt
, 
»gs
->
—x
);

2083 
	`io_emul
(
»gs
);

2084 iàĞ(
İ_by‹s
 =ğ1è&& 
pv_po¡_outb_hook
 )

2085 
	`pv_po¡_outb_hook
(
pÜt
, 
»gs
->
—x
);

2089 
	`gue¡_io_wr™e
(
pÜt
, 
İ_by‹s
, 
»gs
->
—x
, 
v
,„egs);

2091 
bpm©ch
 = 
	`check_gue¡_io_b»akpošt
(
v
, 
pÜt
, 
İ_by‹s
);

2092 
dÚe
;

2095 
İ_by‹s
 = 1;

2097 
pÜt
 = (
u16
)
»gs
->
edx
;

2098 
exec_out
;

2102 iàĞ
v
->
¬ch
.
iİl
 < (
	`gue¡_k”Ãl_mode
(v, 
»gs
) ? 1 : 3) )

2103 
ç
;

2111 
dÚe
;

2115 
ç
;

2117 
twoby‹_İcode
:

2122 
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2123 iàĞ!
	`gue¡_k”Ãl_mode
(
v
, 
»gs
è&& (
İcode
 != 0x1) && (opcode != 0x31) )

2124 
ç
;

2126 iàĞ
lock
 && (
İcode
 & ~3) != 0x20 )

2127 
ç
;

2128  
İcode
 )

2131  
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
) )

2134 iàĞ(
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_TSD
) &&

2135 !
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

2136 
ç
;

2137 
	`pv_soá_rdtsc
(
v
, 
»gs
, 1);

2141 
u64
 
Ãw_xã©u»
 = (
u32
)
»gs
->
—x
 | ((u64ìegs->
edx
 << 32);

2143 iàĞ
lock
 || 
»p_´efix
 || 
İsize_´efix


2144 || !(
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_OSXSAVE
) )

2146 
	`do_gue¡_Œ­
(
TRAP_šv®id_İ
, 
»gs
, 0);

2147 
sk
;

2150 iàĞ!
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

2151 
ç
;

2153  (
u32
)
»gs
->
ecx
 )

2155 
XCR_XFEATURE_ENABLED_MASK
:

2157 iàĞ!(
Ãw_xã©u»
 & 
XSTATE_FP
è|| (Ãw_xã©u» & ~
xã©u»_mask
) )

2158 
ç
;

2160 
v
->
¬ch
.
xü0
 = 
Ãw_xã©u»
;

2161 
v
->
¬ch
.
xü0_accum
 |ğ
Ãw_xã©u»
;

2162 
	`£t_xü0
(
Ãw_xã©u»
);

2165 
ç
;

2170 
ç
;

2175 ()
	`do_åu_sksw™ch
(0);

2180 iàĞ!
	`ÿche_æush_³rm™‹d
(
v
->
domaš
) )

2185 
	`wbšvd
();

2189 
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2190 iàĞ
İcode
 < 0xc0 )

2191 
ç
;

2192 
modrm_»g
 +ğ((
İcode
 >> 3è& 7è+ (
lock
 << 3);

2193 
modrm_rm
 |ğ(
İcode
 >> 0) & 7;

2194 
»g
 = 
	`decode_»gi¡”
(
modrm_rm
, 
»gs
, 0);

2195  
modrm_»g
 )

2198 *
»g
 = (
	`»ad_ü0
(è& ~
X86_CR0_TS
) |

2199 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0];

2203 *
»g
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[2];

2208 
mâ
;

2210 iàĞ!
	`is_pv_32Ú64_vıu
(
v
) )

2212 
mâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
);

2213 *
»g
 = 
	`x’_pâ_to_ü3
(
	`mâ_to_gmâ
(

2214 
v
->
domaš
, 
mâ
));

2216 #ifdeà
CONFIG_COMPAT


2219 
mâ
 = 
	`l4e_g‘_pâ
(*(
l4_pg’Œy_t
 *)
	`__va
(
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
)));

2220 *
»g
 = 
	`com·t_pâ_to_ü3
(
	`mâ_to_gmâ
(

2221 
v
->
domaš
, 
mâ
));

2225 
	`BUG_ON
(
	`·ge_g‘_owÃr
(
	`mâ_to_·ge
(
mâ
)è=ğ
dom_cow
);

2230 *
»g
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4];

2234 
ç
;

2239 
»s
;

2240 
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2241 iàĞ
İcode
 < 0xc0 )

2242 
ç
;

2243 
modrm_»g
 +ğ((
İcode
 >> 3è& 7è+ (
lock
 << 3);

2244 
modrm_rm
 |ğ(
İcode
 >> 0) & 7;

2245 
»g
 = 
	`decode_»gi¡”
(
modrm_rm
, 
»gs
, 0);

2246 iàĞ(
»s
 = 
	`do_g‘_debug»g
(
modrm_»g
)) > ()-256 )

2247 
ç
;

2248 *
»g
 = 
»s
;

2253 
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2254 iàĞ
İcode
 < 0xc0 )

2255 
ç
;

2256 
modrm_»g
 +ğ((
İcode
 >> 3è& 7è+ (
lock
 << 3);

2257 
modrm_rm
 |ğ(
İcode
 >> 0) & 7;

2258 
»g
 = 
	`decode_»gi¡”
(
modrm_rm
, 
»gs
, 0);

2259  
modrm_»g
 )

2262 iàĞ(*
»g
 ^ 
	`»ad_ü0
()è& ~
X86_CR0_TS
 )

2264 
	`gd´štk
(
XENLOG_WARNING
,

2266 
ç
;

2268 ()
	`do_åu_sksw™ch
(!!(*
»g
 & 
X86_CR0_TS
));

2272 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[2] = *
»g
;

2273 
	`¬ch_£t_ü2
(
v
, *
»g
);

2277 
	`domaš_lock
(
v
->
domaš
);

2279 
	`´štk
("WARN callingo‚ew_guest_cr3() from‡rch/x86/traps.cƒmulation!\n");

2281 iàĞ!
	`is_pv_32Ú64_vıu
(
v
) )

2282 
rc
 = 
	`Ãw_gue¡_ü3
(
	`gmâ_to_mâ
(
v
->
domaš
, 
	`x’_ü3_to_pâ
(*
»g
)));

2283 #ifdeà
CONFIG_COMPAT


2285 
rc
 = 
	`Ãw_gue¡_ü3
(
	`gmâ_to_mâ
(
v
->
domaš
, 
	`com·t_ü3_to_pâ
(*
»g
)));

2287 
	`domaš_uÆock
(
v
->
domaš
);

2288 iàĞ
rc
 == 0 )

2289 
ç
;

2293 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] = 
	`pv_gue¡_ü4_fixup
(v, *
»g
);

2294 
	`wr™e_ü4
(
	`pv_gue¡_ü4_to_»®_ü4
(
v
));

2298 
ç
;

2303 
İcode
 = 
	`š¢_ãtch
(
u8
, 
code_ba£
, 
e
, 
code_lim™
);

2304 iàĞ
İcode
 < 0xc0 )

2305 
ç
;

2306 
modrm_»g
 +ğ((
İcode
 >> 3è& 7è+ (
lock
 << 3);

2307 
modrm_rm
 |ğ(
İcode
 >> 0) & 7;

2308 
»g
 = 
	`decode_»gi¡”
(
modrm_rm
, 
»gs
, 0);

2309 iàĞ
	`do_£t_debug»g
(
modrm_»g
, *
»g
) != 0 )

2310 
ç
;

2314 
ušt32_t
 
—x
 = 
»gs
->eax;

2315 
ušt32_t
 
edx
 = 
»gs
->edx;

2316 
m¤_cÚ‹Á
 = ((
ušt64_t
)
edx
 << 32è| 
—x
;

2317  (
u32
)
»gs
->
ecx
 )

2319 #ifdeà
CONFIG_X86_64


2320 
MSR_FS_BASE
:

2321 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2322 
ç
;

2323 iàĞ
	`wrm¤_§ã
(
MSR_FS_BASE
, 
m¤_cÚ‹Á
) )

2324 
ç
;

2325 
v
->
¬ch
.
gue¡_cÚ‹xt
.
fs_ba£
 = 
m¤_cÚ‹Á
;

2327 
MSR_GS_BASE
:

2328 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2329 
ç
;

2330 iàĞ
	`wrm¤_§ã
(
MSR_GS_BASE
, 
m¤_cÚ‹Á
) )

2331 
ç
;

2332 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_k”Ãl
 = 
m¤_cÚ‹Á
;

2334 
MSR_SHADOW_GS_BASE
:

2335 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2336 
ç
;

2337 iàĞ
	`wrm¤_§ã
(
MSR_SHADOW_GS_BASE
, 
m¤_cÚ‹Á
) )

2338 
ç
;

2339 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_u£r
 = 
m¤_cÚ‹Á
;

2342 
MSR_K7_FID_VID_STATUS
:

2343 
MSR_K7_FID_VID_CTL
:

2344 
MSR_K8_PSTATE_LIMIT
:

2345 
MSR_K8_PSTATE_CTRL
:

2346 
MSR_K8_PSTATE_STATUS
:

2347 
MSR_K8_PSTATE0
:

2348 
MSR_K8_PSTATE1
:

2349 
MSR_K8_PSTATE2
:

2350 
MSR_K8_PSTATE3
:

2351 
MSR_K8_PSTATE4
:

2352 
MSR_K8_PSTATE5
:

2353 
MSR_K8_PSTATE6
:

2354 
MSR_K8_PSTATE7
:

2355 
MSR_K8_HWCR
:

2356 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 )

2357 
ç
;

2358 iàĞ!
	`is_ıuäeq_cÚŒŞËr
(
v
->
domaš
) )

2360 iàĞ
	`wrm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) != 0 )

2361 
ç
;

2363 
MSR_AMD64_NB_CFG
:

2364 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 ||

2365 
boÙ_ıu_d©a
.
x86
 < 0x10 || boot_cpu_data.x86 > 0x17 )

2366 
ç
;

2367 iàĞ!
	`IS_PRIV
(
v
->
domaš
è|| !
	`is_pšÃd_vıu
(v) )

2369 iàĞ(
	`rdm¤_§ã
(
MSR_AMD64_NB_CFG
, 
v®
) != 0) ||

2370 (
—x
 !ğ(
ušt32_t
)
v®
) ||

2371 ((
edx
 ^ (
v®
 >> 32)è& ~(1 << (
AMD64_NB_CFG_CF8_EXT_ENABLE_BIT
 - 32))) )

2372 
šv®id
;

2373 iàĞ
	`wrm¤_§ã
(
MSR_AMD64_NB_CFG
, 
m¤_cÚ‹Á
) != 0 )

2374 
ç
;

2376 
MSR_FAM10H_MMIO_CONF_BASE
:

2377 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 ||

2378 
boÙ_ıu_d©a
.
x86
 < 0x10 || boot_cpu_data.x86 > 0x17 )

2379 
ç
;

2380 iàĞ!
	`IS_PRIV
(
v
->
domaš
è|| !
	`is_pšÃd_vıu
(v) )

2382 iàĞ(
	`rdm¤_§ã
(
MSR_FAM10H_MMIO_CONF_BASE
, 
v®
) != 0) )

2383 
ç
;

2385 #ifdeà
CONFIG_X86_64


2386 (
pci_´obe
 & 
PCI_PROBE_MASK
è=ğ
PCI_PROBE_MMCONF
 ?

2387 
v®
 !ğ
m¤_cÚ‹Á
 :

2389 ((
v®
 ^ 
m¤_cÚ‹Á
) &

2390 ~Ğ
FAM10H_MMIO_CONF_ENABLE
 |

2391 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
 <<

2392 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

2393 ((
u64
)
FAM10H_MMIO_CONF_BASE_MASK
 <<

2394 
FAM10H_MMIO_CONF_BASE_SHIFT
))) )

2395 
šv®id
;

2396 iàĞ
	`wrm¤_§ã
(
MSR_FAM10H_MMIO_CONF_BASE
, 
m¤_cÚ‹Á
) != 0 )

2397 
ç
;

2399 
MSR_IA32_UCODE_REV
:

2400 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 )

2401 
ç
;

2402 iàĞ!
	`IS_PRIV
(
v
->
domaš
è|| !
	`is_pšÃd_vıu
(v) )

2404 iàĞ
	`rdm¤_§ã
(
»gs
->
ecx
, 
v®
) )

2405 
ç
;

2406 iàĞ
m¤_cÚ‹Á
 )

2407 
šv®id
;

2409 
MSR_IA32_MISC_ENABLE
:

2410 iàĞ
	`rdm¤_§ã
(
»gs
->
ecx
, 
v®
) )

2411 
ç
;

2412 
v®
 = 
	`gue¡_misc_’abË
(val);

2413 iàĞ
m¤_cÚ‹Á
 !ğ
v®
 )

2414 
šv®id
;

2416 
MSR_IA32_MPERF
:

2417 
MSR_IA32_APERF
:

2418 ià(Ğ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 ) &&

2419 Ğ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 ) )

2420 
ç
;

2421 iàĞ!
	`is_ıuäeq_cÚŒŞËr
(
v
->
domaš
) )

2423 iàĞ
	`wrm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
 ) != 0 )

2424 
ç
;

2426 
MSR_IA32_PERF_CTL
:

2427 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 )

2428 
ç
;

2429 iàĞ!
	`is_ıuäeq_cÚŒŞËr
(
v
->
domaš
) )

2431 iàĞ
	`wrm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) != 0 )

2432 
ç
;

2434 
MSR_IA32_THERM_CONTROL
:

2435 
	`wrm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
);

2437 
MSR_IA32_ENERGY_PERF_BIAS
:

2438 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
 )

2439 
ç
;

2440 iàĞ!
	`IS_PRIV
(
v
->
domaš
è|| !
	`is_pšÃd_vıu
(v) )

2442 iàĞ
	`wrm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) != 0 )

2443 
ç
;

2446 iàĞ
	`wrm¤_hy³rvisÜ_»gs
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) )

2449 
rc
 = 
	`vmû_wrm¤
(
»gs
->
ecx
, 
m¤_cÚ‹Á
);

2450 iàĞ
rc
 < 0 )

2451 
ç
;

2452 iàĞ
rc
 )

2455 iàĞ(
	`rdm¤_§ã
(
»gs
->
ecx
, 
v®
è!ğ0è|| (
m¤_cÚ‹Á
 != val) )

2456 
šv®id
:

2457 
	`gd´štk
(
XENLOG_WARNING
, "Domain‡ttempted WRMSR %p from "

2458 "0x%016"
PRIx64
"o 0x%016"PRIx64".\n",

2459 
	`_p
(
»gs
->
ecx
), 
v®
, 
m¤_cÚ‹Á
);

2466 iàĞ(
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_TSD
) &&

2467 !
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) )

2468 
ç
;

2469 iàĞ
v
->
domaš
->
¬ch
.
vtsc
 )

2470 
	`pv_soá_rdtsc
(
v
, 
»gs
, 0);

2472 
	`rdtsc
(
»gs
->
—x
,„egs->
edx
);

2476  (
u32
)
»gs
->
ecx
 )

2478 #ifdeà
CONFIG_X86_64


2479 
MSR_FS_BASE
:

2480 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2481 
ç
;

2482 
»gs
->
—x
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
fs_ba£
 & 0xFFFFFFFFUL;

2483 
»gs
->
edx
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
fs_ba£
 >> 32;

2485 
MSR_GS_BASE
:

2486 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2487 
ç
;

2488 
»gs
->
—x
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_k”Ãl
 & 0xFFFFFFFFUL;

2489 
»gs
->
edx
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_k”Ãl
 >> 32;

2491 
MSR_SHADOW_GS_BASE
:

2492 iàĞ
	`is_pv_32Ú64_vıu
(
v
) )

2493 
ç
;

2494 
»gs
->
—x
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_u£r
 & 0xFFFFFFFFUL;

2495 
»gs
->
edx
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_u£r
 >> 32;

2498 
MSR_K7_FID_VID_CTL
:

2499 
MSR_K7_FID_VID_STATUS
:

2500 
MSR_K8_PSTATE_LIMIT
:

2501 
MSR_K8_PSTATE_CTRL
:

2502 
MSR_K8_PSTATE_STATUS
:

2503 
MSR_K8_PSTATE0
:

2504 
MSR_K8_PSTATE1
:

2505 
MSR_K8_PSTATE2
:

2506 
MSR_K8_PSTATE3
:

2507 
MSR_K8_PSTATE4
:

2508 
MSR_K8_PSTATE5
:

2509 
MSR_K8_PSTATE6
:

2510 
MSR_K8_PSTATE7
:

2511 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_AMD
 )

2512 
ç
;

2513 iàĞ!
	`is_ıuäeq_cÚŒŞËr
(
v
->
domaš
) )

2515 
»gs
->
—x
 =„egs->
edx
 = 0;

2518 
rdm¤_nÜm®
;

2519 
MSR_IA32_UCODE_REV
:

2520 
	`BUILD_BUG_ON
(
MSR_IA32_UCODE_REV
 !ğ
MSR_AMD_PATCHLEVEL
);

2521 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

2523 iàĞ
	`wrm¤_§ã
(
MSR_IA32_UCODE_REV
, 0) )

2524 
ç
;

2525 
	`sync_cÜe
();

2527 
rdm¤_nÜm®
;

2528 
MSR_IA32_MISC_ENABLE
:

2529 iàĞ
	`rdm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) )

2530 
ç
;

2531 
m¤_cÚ‹Á
 = 
	`gue¡_misc_’abË
(msr_content);

2532 
»gs
->
—x
 = (
ušt32_t
)
m¤_cÚ‹Á
;

2533 
»gs
->
edx
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

2536 
MSR_IA32_THERM_CONTROL
:

2537 iàĞ
	`rdm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) )

2538 
ç
;

2539 
»gs
->
—x
 = (
ušt32_t
)
m¤_cÚ‹Á
;

2540 
»gs
->
edx
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

2543 iàĞ
	`rdm¤_hy³rvisÜ_»gs
(
»gs
->
ecx
, &
v®
) )

2545 
rdm¤_wr™eback
:

2546 
»gs
->
—x
 = (
ušt32_t
)
v®
;

2547 
»gs
->
edx
 = (
ušt32_t
)(
v®
 >> 32);

2551 
rc
 = 
	`vmû_rdm¤
(
»gs
->
ecx
, &
v®
);

2552 iàĞ
rc
 < 0 )

2553 
ç
;

2554 iàĞ
rc
 )

2555 
rdm¤_wr™eback
;

2557 
MSR_EFER
:

2558 
rdm¤_nÜm®
:

2562 iàĞ
	`rdm¤_§ã
(
»gs
->
ecx
, 
m¤_cÚ‹Á
) )

2563 
ç
;

2564 
»gs
->
—x
 = (
ušt32_t
)
m¤_cÚ‹Á
;

2565 
»gs
->
edx
 = (
ušt32_t
)(
m¤_cÚ‹Á
 >> 32);

2571 
ç
;

2574 #undeà
wr_ad


2575 #undeà
rd_ad


2577 
dÚe
:

2578 
	`š¡ruùiÚ_dÚe
(
»gs
, 
e
, 
bpm©ch
);

2579 
sk
:

2580  
EXCRET_çuÉ_fixed
;

2582 
ç
:

2584 
	}
}

2586 
šlše
 
	$check_¡ack_lim™
(
¬
, 
lim™
,

2587 
e¥
, 
deü
)

2589  (((
e¥
 - 
deü
) < (esp - 1)) &&

2590 (!(
¬
 & 
_SEGMENT_EC
è? (
e¥
 - 1è<ğ
lim™
 : (e¥ - 
deü
) >†imit));

2591 
	}
}

2593 
	$emuÏ‹_g©e_İ
(
ıu_u£r_»gs
 *
»gs
)

2595 #ifdeà
__x86_64__


2596 
vıu
 *
v
 = 
cu¼’t
;

2597 
£l
, 
¬
, 
d¶
, 
Å¬m
, 
İnd_£l
;

2598 
İ_deçuÉ
, 
İ_by‹s
, 
ad_deçuÉ
, 
ad_by‹s
;

2599 
off
, 
e
, 
İnd_off
, 
ba£
, 
lim™
;

2600 
jump
;

2603 iàĞ!
	`»ad_g©e_desütÜ
(
»gs
->
”rÜ_code
, 
v
, &
£l
, &
off
, &
¬
) ||

2604 (((
¬
 >> 13è& 3è< (
»gs
->
cs
 & 3)) ||

2605 ((
¬
 & 
_SEGMENT_TYPE
) != 0xc00) )

2607 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2610 iàĞ!(
¬
 & 
_SEGMENT_P
) )

2612 
	`do_gue¡_Œ­
(
TRAP_no_£gm’t
, 
»gs
, 1);

2615 
d¶
 = (
¬
 >> 13) & 3;

2616 
Å¬m
 = 
¬
 & 0x1f;

2622 iàĞ!
	`»ad_desütÜ
(
»gs
->
cs
, 
v
,„egs, &
ba£
, &
lim™
, &
¬
, 0) ||

2623 !(
¬
 & 
_SEGMENT_S
) ||

2624 !(
¬
 & 
_SEGMENT_P
) ||

2625 !(
¬
 & 
_SEGMENT_CODE
) )

2627 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2631 
İ_by‹s
 = 
İ_deçuÉ
 = 
¬
 & 
_SEGMENT_DB
 ? 4 : 2;

2632 
ad_deçuÉ
 = 
ad_by‹s
 = 
İ_deçuÉ
;

2633 
İnd_£l
 = 
İnd_off
 = 0;

2634 
jump
 = -1;

2635  
e
 = 
»gs
->e;ƒ -„egs->
_e
 < 10; )

2637  
	`š¢_ãtch
(
u8
, 
ba£
, 
e
, 
lim™
) )

2640 
İ_by‹s
 = 
İ_deçuÉ
 ^ 6;

2643 
ad_by‹s
 = 
ad_deçuÉ
 != 4 ? 4 : 2;

2646 
İnd_£l
 = 
»gs
->
cs
;

2647 
	`ASSERT
(
İnd_£l
);

2650 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
ds
);

2651 iàĞ!
İnd_£l
 )

2652 
İnd_£l
 = 
d¶
;

2655 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
es
);

2656 iàĞ!
İnd_£l
 )

2657 
İnd_£l
 = 
d¶
;

2660 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
fs
);

2661 iàĞ!
İnd_£l
 )

2662 
İnd_£l
 = 
d¶
;

2665 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
gs
);

2666 iàĞ!
İnd_£l
 )

2667 
İnd_£l
 = 
d¶
;

2670 
İnd_£l
 = 
»gs
->
ss
;

2671 iàĞ!
İnd_£l
 )

2672 
İnd_£l
 = 
d¶
;

2675 ++
jump
;

2678 ++
jump
;

2679 
İnd_£l
 = 
»gs
->
cs
;

2680 
İnd_off
 = 
e
;

2681 
ad_by‹s
 = 
ad_deçuÉ
;

2682 
e
 +ğ
İ_by‹s
 + 2;

2686 
modrm
;

2688  (
modrm
 = 
	`š¢_ãtch
(
u8
, 
ba£
, 
e
, 
lim™
)) & 0xf8 )

2691 ++
jump
;

2694 ++
jump
;

2695 iàĞ
ad_by‹s
 != 2 )

2697 iàĞ(
modrm
 & 7) == 4 )

2699 
sib
;

2700 
sib
 = 
	`š¢_ãtch
(
u8
, 
ba£
, 
e
, 
lim™
);

2702 
modrm
 = (modrm & ~7è| (
sib
 & 7);

2703 iàĞ(
sib
 >>= 3) != 4 )

2704 
İnd_off
 = *(*)

2705 
	`decode_»gi¡”
(
sib
 & 7, 
»gs
, 0);

2706 
İnd_off
 <<ğ
sib
 >> 3;

2708 iàĞ(
modrm
 & 7) != 5 || (modrm & 0xc0) )

2709 
İnd_off
 += *(*)

2710 
	`decode_»gi¡”
(
modrm
 & 7, 
»gs
, 0);

2712 
modrm
 |= 0x87;

2713 iàĞ!
İnd_£l
 )

2715  
modrm
 & 7 )

2718 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
ds
);

2721 
İnd_£l
 = 
»gs
->
ss
;

2728  
modrm
 & 7 )

2731 
İnd_off
 = 
»gs
->
ebx
;

2734 iàĞ!(
modrm
 & 0xc0) )

2735 
modrm
 |= 0x80;

2739 
İnd_off
 = 
»gs
->
ebp
;

2740 iàĞ!
İnd_£l
 )

2741 
İnd_£l
 = 
»gs
->
ss
;

2745 iàĞ!
İnd_£l
 )

2746 
İnd_£l
 = 
	`»ad_¤eg
(
»gs
, 
ds
);

2747  
modrm
 & 7 )

2750 
İnd_off
 +ğ
»gs
->
esi
;

2753 
İnd_off
 +ğ
»gs
->
edi
;

2757  
modrm
 & 0xc0 )

2760 
İnd_off
 +ğ
	`š¢_ãtch
(
s8
, 
ba£
, 
e
, 
lim™
);

2763 
İnd_off
 +ğ
	`š¢_ãtch
(
s32
, 
ba£
, 
e
, 
lim™
);

2766 iàĞ
ad_by‹s
 == 4 )

2767 
İnd_off
 = ()opnd_off;

2768 iàĞ
ad_by‹s
 == 2 )

2769 
İnd_off
 = ()opnd_off;

2778 iàĞ
jump
 < 0 )

2780 
ç
:

2781 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2782 
sk
:

2786 iàĞ(
İnd_£l
 !ğ
»gs
->
cs
 &&

2787 !
	`»ad_desütÜ
(
İnd_£l
, 
v
, 
»gs
, &
ba£
, &
lim™
, &
¬
, 0)) ||

2788 !(
¬
 & 
_SEGMENT_S
) ||

2789 !(
¬
 & 
_SEGMENT_P
) ||

2790 ((
¬
 & 
_SEGMENT_CODE
è&& !×¸& 
_SEGMENT_WR
)) )

2792 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2796 
İnd_off
 +ğ
İ_by‹s
;

2797 
	#ad_deçuÉ
 
ad_by‹s


	)

2798 
İnd_£l
 = 
	`š¢_ãtch
(
u16
, 
ba£
, 
İnd_off
, 
lim™
);

2799 #undeà
ad_deçuÉ


2800 
	`ASSERT
((
İnd_£l
 & ~3è=ğ
»gs
->
”rÜ_code
);

2801 iàĞ
d¶
 < (
İnd_£l
 & 3) )

2803 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2807 iàĞ!
	`»ad_desütÜ
(
£l
, 
v
, 
»gs
, &
ba£
, &
lim™
, &
¬
, 0) ||

2808 !(
¬
 & 
_SEGMENT_S
) ||

2809 !(
¬
 & 
_SEGMENT_CODE
) ||

2810 (!
jump
 || (
¬
 & 
_SEGMENT_EC
) ?

2811 ((
¬
 >> 13è& 3è> (
»gs
->
cs
 & 3) :

2812 ((
¬
 >> 13è& 3è!ğ(
»gs
->
cs
 & 3)) )

2814 
»gs
->
”rÜ_code
 = 
£l
;

2815 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2818 iàĞ!(
¬
 & 
_SEGMENT_P
) )

2820 
»gs
->
”rÜ_code
 = 
£l
;

2821 
	`do_gue¡_Œ­
(
TRAP_no_£gm’t
, 
»gs
, 1);

2824 iàĞ
off
 > 
lim™
 )

2826 
»gs
->
”rÜ_code
 = 0;

2827 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2831 iàĞ!
jump
 )

2833 
ss
, 
e¥
, *
¡kp
;

2834 
rc
;

2835 
	#push
(
™em
) do \

2837 --
¡kp
; \

2838 
e¥
 -= 4; \

2839 
rc
 = 
	`__put_u£r
(
™em
, 
¡kp
); \

2840 iàĞ
rc
 ) \

2842 
	`´İag©e_·ge_çuÉ
(()(
¡kp
 + 1è- 
rc
, \

2843 
PFEC_wr™e_acûss
); \

2846 }  0 )

	)

2848 iàĞ((
¬
 >> 13è& 3è< (
»gs
->
cs
 & 3) )

2850 
£l
 |ğ(
¬
 >> 13) & 3;

2852 iàĞ(
£l
 & 3è!ğ
	`GUEST_KERNEL_RPL
(
v
->
domaš
) )

2854 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2857 
e¥
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
;

2858 
ss
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
;

2859 iàĞ(
ss
 & 3è!ğ(
£l
 & 3) ||

2860 !
	`»ad_desütÜ
(
ss
, 
v
, 
»gs
, &
ba£
, &
lim™
, &
¬
, 0) ||

2861 ((
¬
 >> 13è& 3è!ğ(
£l
 & 3) ||

2862 !(
¬
 & 
_SEGMENT_S
) ||

2863 (
¬
 & 
_SEGMENT_CODE
) ||

2864 !(
¬
 & 
_SEGMENT_WR
) )

2866 
»gs
->
”rÜ_code
 = 
ss
 & ~3;

2867 
	`do_gue¡_Œ­
(
TRAP_šv®id_tss
, 
»gs
, 1);

2870 iàĞ!(
¬
 & 
_SEGMENT_P
) ||

2871 !
	`check_¡ack_lim™
(
¬
, 
lim™
, 
e¥
, (4 + 
Å¬m
) * 4) )

2873 
»gs
->
”rÜ_code
 = 
ss
 & ~3;

2874 
	`do_gue¡_Œ­
(
TRAP_¡ack_”rÜ
, 
»gs
, 1);

2877 
¡kp
 = (*)()(()
ba£
 + 
e¥
);

2878 iàĞ!
	`com·t_acûss_ok
(
¡kp
 - 4 - 
Å¬m
, (4 +‚parm) * 4) )

2880 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2883 
	`push
(
»gs
->
ss
);

2884 
	`push
(
»gs
->
e¥
);

2885 iàĞ
Å¬m
 )

2887 cÚ¡ *
u¡kp
;

2889 iàĞ!
	`»ad_desütÜ
(
»gs
->
ss
, 
v
,„egs, &
ba£
, &
lim™
, &
¬
, 0) ||

2890 ((
¬
 >> 13è& 3è!ğ(
»gs
->
cs
 & 3) ||

2891 !(
¬
 & 
_SEGMENT_S
) ||

2892 (
¬
 & 
_SEGMENT_CODE
) ||

2893 !(
¬
 & 
_SEGMENT_WR
) ||

2894 !
	`check_¡ack_lim™
(
¬
, 
lim™
, 
e¥
 + 
Å¬m
 * 4,‚parm * 4) )

2895  
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2896 
u¡kp
 = (*)()(()
ba£
 + 
»gs
->
_e¥
 + 
Å¬m
 * 4);

2897 iàĞ!
	`com·t_acûss_ok
(
u¡kp
 - 
Å¬m
,‚parm * 4) )

2899 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2904 
·rm
;

2906 --
u¡kp
;

2907 
rc
 = 
	`__g‘_u£r
(
·rm
, 
u¡kp
);

2908 iàĞ
rc
 )

2910 
	`´İag©e_·ge_çuÉ
(()(
u¡kp
 + 1è- 
rc
, 0);

2913 
	`push
(
·rm
);

2914 }  --
Å¬m
 );

2919 
£l
 |ğ(
»gs
->
cs
 & 3);

2920 
e¥
 = 
»gs
->esp;

2921 
ss
 = 
»gs
->ss;

2922 iàĞ!
	`»ad_desütÜ
(
ss
, 
v
, 
»gs
, &
ba£
, &
lim™
, &
¬
, 0) ||

2923 ((
¬
 >> 13è& 3è!ğ(
£l
 & 3) )

2925 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2928 iàĞ!
	`check_¡ack_lim™
(
¬
, 
lim™
, 
e¥
, 2 * 4) )

2930 
»gs
->
”rÜ_code
 = 0;

2931 
	`do_gue¡_Œ­
(
TRAP_¡ack_”rÜ
, 
»gs
, 1);

2934 
¡kp
 = (*)()(()
ba£
 + 
e¥
);

2935 iàĞ!
	`com·t_acûss_ok
(
¡kp
 - 2, 2 * 4) )

2937 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

2941 
	`push
(
»gs
->
cs
);

2942 
	`push
(
e
);

2943 #undeà
push


2944 
»gs
->
e¥
 =ƒsp;

2945 
»gs
->
ss
 = ss;

2948 
£l
 |ğ(
»gs
->
cs
 & 3);

2950 
»gs
->
cs
 = 
£l
;

2951 
	`š¡ruùiÚ_dÚe
(
»gs
, 
off
, 0);

2953 
	}
}

2955 
asmlškage
 
	$do_g’”®_´ÙeùiÚ
(
ıu_u£r_»gs
 *
»gs
)

2957 
vıu
 *
v
 = 
cu¼’t
;

2958 
fixup
;

2960 
	`DEBUGGER_Œ­_’Œy
(
TRAP_gp_çuÉ
, 
»gs
);

2962 iàĞ
»gs
->
”rÜ_code
 & 1 )

2963 
h¬dw¬e_gp
;

2965 iàĞ!
	`gue¡_mode
(
»gs
) )

2966 
gp_š_k”Ãl
;

2988 iàĞ(
»gs
->
”rÜ_code
 & 3) == 2 )

2991 cÚ¡ 
Œ­_šfo
 *
ti
;

2992 
veùÜ
 = 
»gs
->
”rÜ_code
 >> 3;

2993 
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
veùÜ
];

2994 iàĞ
	`³rm™_soášt
(
	`TI_GET_DPL
(
ti
), 
v
, 
»gs
) )

2996 
»gs
->
e
 += 2;

2997 
	`do_gue¡_Œ­
(
veùÜ
, 
»gs
, 0);

3001 iàĞ
	`is_pv_32Ú64_vıu
(
v
è&& 
»gs
->
”rÜ_code
 )

3003 
	`emuÏ‹_g©e_İ
(
»gs
);

3008 iàĞ(
»gs
->
”rÜ_code
 == 0) &&

3009 
	`emuÏ‹_´iveged_İ
(
»gs
) )

3011 
	`Œaû_Œ­_Úe_addr
(
TRC_PV_EMULATE_PRIVOP
, 
»gs
->
e
);

3015 #ià
	`defšed
(
__i386__
)

3016 iàĞ
	`VM_ASSIST
(
v
->
domaš
, 
VMASST_TYPE_4gb_£gm’ts
) &&

3017 (
»gs
->
”rÜ_code
 == 0) &&

3018 
	`gpf_emuÏ‹_4gb
(
»gs
) )

3020 
	`TRACE_1D
(
TRC_PV_EMULATE_4GB
, 
»gs
->
e
);

3026 
	`do_gue¡_Œ­
(
TRAP_gp_çuÉ
, 
»gs
, 1);

3029 
gp_š_k”Ãl
:

3031 iàĞ
	`lik–y
((
fixup
 = 
	`£¬ch_exû±iÚ_bË
(
»gs
->
e
)) != 0) )

3033 
	`d´štk
(
XENLOG_INFO
, "GPF (%04x): %p -> %p\n",

3034 
»gs
->
”rÜ_code
, 
	`_p
Ôegs->
e
), _p(
fixup
));

3035 
»gs
->
e
 = 
fixup
;

3039 
	`DEBUGGER_Œ­_çl
(
TRAP_gp_çuÉ
, 
»gs
);

3041 
h¬dw¬e_gp
:

3042 
	`show_executiÚ_¡©e
(
»gs
);

3043 
	`·nic
("GENERAL PROTECTION FAULT\n[”rÜ_code=%04x]\n", 
»gs
->
”rÜ_code
);

3044 
	}
}

3046 
DEFINE_PER_CPU
(
soáœq_Œ­
, softirq_trap);

3048 
	$nmi_mû_soáœq
()

3050 
ıu
 = 
	`smp_´oûssÜ_id
();

3051 
soáœq_Œ­
 *
¡
 = &
	`³r_ıu
(soáœq_Œ­, 
ıu
);

3052 
ıumask_t
 
affš™y
;

3054 
	`BUG_ON
(
¡
 =ğ
NULL
);

3055 
	`BUG_ON
(
¡
->
vıu
 =ğ
NULL
);

3059 
¡
->
vıu
->
ıu_affš™y_tmp
 = st->vıu->
ıu_affš™y
;

3061 ià((
ıu
 !ğ
¡
->
´oûssÜ
)

3062 || (
¡
->
´oûssÜ
 !ğ¡->
vıu
->processor))

3068 
	`ıus_ş—r
(
affš™y
);

3069 
	`ıu_£t
(
¡
->
´oûssÜ
, 
affš™y
);

3070 
	`vıu_£t_affš™y
(
¡
->
vıu
, &
affš™y
);

3078 
	`vıu_kick
(
¡
->
vıu
);

3079 
¡
->
vıu
 = 
NULL
;

3080 
	}
}

3082 
	$async_exû±iÚ_ş—nup
(
vıu
 *
cu¼
)

3084 
Œ­
;

3086 iàĞ!
cu¼
->
async_exû±iÚ_mask
 )

3090 iàĞ!
	`ıus_em±y
(
cu¼
->
ıu_affš™y_tmp
) &&

3091 !
	`ıus_equ®
(
cu¼
->
ıu_affš™y_tmp
, cu¼->
ıu_affš™y
) )

3093 
	`vıu_£t_affš™y
(
cu¼
, &cu¼->
ıu_affš™y_tmp
);

3094 
	`ıus_ş—r
(
cu¼
->
ıu_affš™y_tmp
);

3097 iàĞ!(
cu¼
->
async_exû±iÚ_mask
 & (curr->async_exception_mask - 1)) )

3098 
Œ­
 = 
	`__sÿnb™
(
cu¼
->
async_exû±iÚ_mask
, 
VCPU_TRAP_NONE
);

3100  
Œ­
 = 
VCPU_TRAP_NONE
 + 1;¿°<ğ
VCPU_TRAP_LAST
; ++trap )

3101 iàĞ(
cu¼
->
async_exû±iÚ_mask
 ^

3102 
cu¼
->
	`async_exû±iÚ_¡©e
(
Œ­
).
Şd_mask
) == (1 <<rap) )

3104 
	`ASSERT
(
Œ­
 <ğ
VCPU_TRAP_LAST
);

3107 iàĞ
Œ­
 =ğ
VCPU_TRAP_MCE
 )

3109 
	`gd´štk
(
XENLOG_DEBUG
, "MCE: Return from vMCE#rap!\n");

3110 iàĞ
cu¼
->
vıu_id
 == 0 )

3112 
domaš
 *
d
 = 
cu¼
->domain;

3114 iàĞ!
d
->
¬ch
.
vmÿ_m¤s
->
Ä_šjeùiÚ
 )

3116 
	`´štk
(
XENLOG_WARNING
 "MCE:„et from vMCE#, "

3118 
’d
;

3121 
d
->
¬ch
.
vmÿ_m¤s
->
Ä_šjeùiÚ
--;

3122 iàĞ!
	`li¡_em±y
(&
d
->
¬ch
.
vmÿ_m¤s
->
im·ù_h—d”
) )

3124 
bªk_’Œy
 *
’Œy
;

3126 
’Œy
 = 
	`li¡_’Œy
(
d
->
¬ch
.
vmÿ_m¤s
->
im·ù_h—d”
.
Ãxt
,

3127 
bªk_’Œy
, 
li¡
);

3128 
	`gd´štk
(
XENLOG_DEBUG
, "MCE: delete†ast injection‚ode\n");

3129 
	`li¡_d–
(&
’Œy
->
li¡
);

3132 
	`´štk
(
XENLOG_ERR
 "MCE: didn't found†ast injection‚ode\n");

3135 iàĞ
d
->
¬ch
.
vmÿ_m¤s
->
Ä_šjeùiÚ
 > 0 &&

3136 
	`gue¡_has_Œ­_ÿÎback
(
d
, 0, 
TRAP_machše_check
) &&

3137 !
	`‹¡_ªd_£t_boŞ
(
cu¼
->
mû_³ndšg
) )

3139 
ıu
 = 
	`smp_´oûssÜ_id
();

3140 
ıumask_t
 
affš™y
;

3142 
cu¼
->
ıu_affš™y_tmp
 = cu¼->
ıu_affš™y
;

3143 
	`ıus_ş—r
(
affš™y
);

3144 
	`ıu_£t
(
ıu
, 
affš™y
);

3145 
	`´štk
(
XENLOG_DEBUG
 "MCE: CPU%d set‡ffinity, old %d\n",

3146 
ıu
, 
cu¼
->
´oûssÜ
);

3147 
	`vıu_£t_affš™y
(
cu¼
, &
affš™y
);

3152 
’d
:

3154 
cu¼
->
async_exû±iÚ_mask
 = cu¼->
	`async_exû±iÚ_¡©e
(
Œ­
).
Şd_mask
;

3155 
	}
}

3157 
	$nmi_dom0_»pÜt
(
»asÚ_idx
)

3159 
domaš
 *
d
 = 
dom0
;

3161 iàĞ(
d
 =ğ
NULL
è|| (d->
vıu
 == NULL) || (d->vcpu[0] == NULL) )

3164 
	`£t_b™
(
»asÚ_idx
, 
	`nmi_»asÚ
(
d
));

3166 
	`£nd_gue¡_Œ­
(
d
, 0, 
TRAP_nmi
);

3167 
	}
}

3169 
	$pci_£¼_”rÜ
(
ıu_u£r_»gs
 *
»gs
)

3171 
	`cÚsŞe_fÜû_uÆock
();

3172 
	`´štk
("\n\nNMI - PCI systemƒrror (SERR)\n");

3174 
	`outb
((
	`šb
(0x61) & 0x0f) | 0x04, 0x61);

3175 
	}
}

3177 
	$io_check_”rÜ
(
ıu_u£r_»gs
 *
»gs
)

3179  
İt_nmi
[0] )

3182 
	`nmi_dom0_»pÜt
(
_XEN_NMIREASON_io_”rÜ
);

3186 
	`cÚsŞe_fÜû_uÆock
();

3187 
	`´štk
("\n\nNMI - I/O ERROR\n");

3188 
	`çl_Œ­
(
TRAP_nmi
, 
»gs
);

3191 
	`outb
((
	`šb
(0x61) & 0x0f) | 0x08, 0x61);

3192 
	`md–ay
(1);

3193 
	`outb
((
	`šb
(0x61) & 0x07) | 0x00, 0x61);

3194 
	}
}

3196 
	$unknown_nmi_”rÜ
(
»asÚ
)

3198  
İt_nmi
[0] )

3201 
	`nmi_dom0_»pÜt
(
_XEN_NMIREASON_unknown
);

3205 
	`´štk
("Uhhuh. NMI„eûived fÜ unknowÀ»asÚ %02x.\n", 
»asÚ
);

3206 
	`´štk
("Dazed‡nd confused, butryingo continue\n");

3207 
	`´štk
("Do you have‡ strange…ower saving modeƒnabled?\n");

3208 
	`kexec_üash
();

3210 
	}
}

3212 
	$dummy_nmi_ÿÎback
(
ıu_u£r_»gs
 *
»gs
, 
ıu
)

3215 
	}
}

3217 
nmi_ÿÎback_t
 
	gnmi_ÿÎback
 = 
dummy_nmi_ÿÎback
;

3219 
asmlškage
 
	$do_nmi
(
ıu_u£r_»gs
 *
»gs
)

3221 
ıu
 = 
	`smp_´oûssÜ_id
();

3222 
»asÚ
;

3224 ++
	`nmi_couÁ
(
ıu
);

3226 iàĞ
	`nmi_ÿÎback
(
»gs
, 
ıu
) )

3229 iàĞ
nmi_w©chdog
 )

3230 
	`nmi_w©chdog_tick
(
»gs
);

3233 iàĞ
ıu
 == 0 )

3235 
»asÚ
 = 
	`šb
(0x61);

3236 iàĞ
»asÚ
 & 0x80 )

3237 
	`pci_£¼_”rÜ
(
»gs
);

3238 iàĞ
»asÚ
 & 0x40 )

3239 
	`io_check_”rÜ
(
»gs
);

3240 iàĞ!
nmi_w©chdog
 )

3241 
	`unknown_nmi_”rÜ
(()(
»asÚ
&0xff));

3243 
	}
}

3245 
	$£t_nmi_ÿÎback
(
nmi_ÿÎback_t
 
ÿÎback
)

3247 
nmi_ÿÎback
 = 
ÿÎback
;

3248 
	}
}

3250 
	$un£t_nmi_ÿÎback
()

3252 
nmi_ÿÎback
 = 
dummy_nmi_ÿÎback
;

3253 
	}
}

3255 
asmlškage
 
	$do_deviû_nÙ_avaabË
(
ıu_u£r_»gs
 *
»gs
)

3257 
vıu
 *
cu¼
 = 
cu¼’t
;

3259 
	`BUG_ON
(!
	`gue¡_mode
(
»gs
));

3261 
	`£tup_åu
(
cu¼
);

3263 iàĞ
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] & 
X86_CR0_TS
 )

3265 
	`do_gue¡_Œ­
(
TRAP_no_deviû
, 
»gs
, 0);

3266 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0] &ğ~
X86_CR0_TS
;

3269 
	`TRACE_0D
(
TRC_PV_MATH_STATE_RESTORE
);

3272 
	}
}

3274 
u64
 
	$»ad_eãr
()

3276  
	`this_ıu
(
eãr
);

3277 
	}
}

3279 
	$wr™e_eãr
(
u64
 
v®
)

3281 
	`this_ıu
(
eãr
èğ
v®
;

3282 
	`wrm¤l
(
MSR_EFER
, 
v®
);

3283 
	}
}

3285 
	$Ër_’abË
()

3287 
u64
 
debugùl
;

3289 iàĞ!
	`this_ıu
(
Ër_m¤
) )

3292 
	`rdm¤l
(
MSR_IA32_DEBUGCTLMSR
, 
debugùl
);

3293 
	`wrm¤l
(
MSR_IA32_DEBUGCTLMSR
, 
debugùl
 | 1);

3294 
	}
}

3296 
asmlškage
 
	$do_debug
(
ıu_u£r_»gs
 *
»gs
)

3298 
vıu
 *
v
 = 
cu¼’t
;

3300 
	`DEBUGGER_Œ­_’Œy
(
TRAP_debug
, 
»gs
);

3302 iàĞ!
	`gue¡_mode
(
»gs
) )

3304 iàĞ
»gs
->
eæags
 & 
X86_EFLAGS_TF
 )

3306 #ifdeà
__x86_64__


3307 
	`sy£Á”_’Œy
();

3308 
	`sy£Á”_eæags_§ved
();

3310 iàĞ(
»gs
->
r
 >ğ()
sy£Á”_’Œy
) &&

3311 (
»gs
->
r
 <ğ()
sy£Á”_eæags_§ved
) )

3313 iàĞ
»gs
->
r
 =ğ()
sy£Á”_eæags_§ved
 )

3314 
»gs
->
eæags
 &ğ~
X86_EFLAGS_TF
;

3315 
out
;

3318 iàĞ!
	`debugg”_Œ­_çl
(
TRAP_debug
, 
»gs
) )

3320 
	`WARN_ON
(1);

3321 
»gs
->
eæags
 &ğ~
X86_EFLAGS_TF
;

3332 
	`WARN_ON
(!
	`£¬ch_exû±iÚ_bË
(
»gs
->
e
));

3334 
out
;

3338 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6] = 
	`»ad_debug»g
(6);

3340 
	`Ër_’abË
();

3341 
	`do_gue¡_Œ­
(
TRAP_debug
, 
»gs
, 0);

3344 
out
:

3345 
	`Ër_’abË
();

3347 
	}
}

3349 
asmlškage
 
	$do_¥urious_š‹¼u±_bug
(
ıu_u£r_»gs
 *
»gs
)

3351 
	}
}

3353 
	$__£t_šŒ_g©e
(
n
, 
ušt32_t
 
d¶
, *
addr
)

3355 
i
;

3357  
i
 = 1; i < 
NR_CPUS
; i++ )

3358 iàĞ
idt_bËs
[
i
] !ğ
NULL
 )

3359 
	`_£t_g©e
(&
idt_bËs
[
i
][
n
], 14, 
d¶
, 
addr
);

3360 
	`_£t_g©e
(&
idt_bË
[
n
], 14, 
d¶
, 
addr
);

3361 
	}
}

3363 
	$£t_swšt_g©e
(
n
, *
addr
)

3365 
	`__£t_šŒ_g©e
(
n
, 3, 
addr
);

3366 
	}
}

3368 
	$£t_šŒ_g©e
(
n
, *
addr
)

3370 
	`__£t_šŒ_g©e
(
n
, 0, 
addr
);

3371 
	}
}

3373 
	$lßd_TR
()

3375 
tss_¡ruù
 *
tss
 = &
	`this_ıu
(
š™_tss
);

3376 
desc_±r
 
Şd_gdt
, 
tss_gdt
 = {

3377 .
ba£
 = ()(
	`this_ıu
(
gdt_bË
è- 
FIRST_RESERVED_GDT_ENTRY
),

3378 .
lim™
 = 
LAST_RESERVED_GDT_BYTE


3381 
	`_£t_ts¦dt_desc
(

3382 
	`this_ıu
(
gdt_bË
è+ 
TSS_ENTRY
 - 
FIRST_RESERVED_GDT_ENTRY
,

3383 ()
tss
,

3384 
	`off£tof
(
tss_¡ruù
, 
__ÿch–še_fËr
) - 1,

3386 #ifdeà
CONFIG_COMPAT


3387 
	`_£t_ts¦dt_desc
(

3388 
	`this_ıu
(
com·t_gdt_bË
è+ 
TSS_ENTRY
 - 
FIRST_RESERVED_GDT_ENTRY
,

3389 ()
tss
,

3390 
	`off£tof
(
tss_¡ruù
, 
__ÿch–še_fËr
) - 1,

3395 
asm
 volatile (

3397 : "=m" (
Şd_gdt
è: "rm" (
TSS_ENTRY
 << 3), "m" (
tss_gdt
) : "memory" );

3398 
	}
}

3400 
__devš™
 
	$³rıu_Œ­s_š™
()

3402 
	`sub¬ch_³rıu_Œ­s_š™
();

3404 iàĞ!
İt_Ër
 )

3407  
boÙ_ıu_d©a
.
x86_v’dÜ
 )

3409 
X86_VENDOR_INTEL
:

3410  
boÙ_ıu_d©a
.
x86
 )

3413 
	`this_ıu
(
Ër_m¤
èğ
MSR_IA32_LASTINTFROMIP
;

3416 
	`this_ıu
(
Ër_m¤
èğ
MSR_P4_LER_FROM_LIP
;

3420 
X86_VENDOR_AMD
:

3421  
boÙ_ıu_d©a
.
x86
 )

3425 
	`this_ıu
(
Ër_m¤
èğ
MSR_IA32_LASTINTFROMIP
;

3431 
	`Ër_’abË
();

3432 
	}
}

3434 
__š™
 
	$Œ­_š™
()

3444 
	`£t_šŒ_g©e
(
TRAP_divide_”rÜ
,&
divide_”rÜ
);

3445 
	`£t_šŒ_g©e
(
TRAP_debug
,&
debug
);

3446 
	`£t_šŒ_g©e
(
TRAP_nmi
,&
nmi
);

3447 
	`£t_swšt_g©e
(
TRAP_št3
,&
št3
);

3448 
	`£t_swšt_g©e
(
TRAP_ov”æow
,&
ov”æow
);

3449 
	`£t_šŒ_g©e
(
TRAP_bounds
,&
bounds
);

3450 
	`£t_šŒ_g©e
(
TRAP_šv®id_İ
,&
šv®id_İ
);

3451 
	`£t_šŒ_g©e
(
TRAP_no_deviû
,&
deviû_nÙ_avaabË
);

3452 
	`£t_šŒ_g©e
(
TRAP_cİro_£g
,&
cİroûssÜ_£gm’t_ov”run
);

3453 
	`£t_šŒ_g©e
(
TRAP_šv®id_tss
,&
šv®id_TSS
);

3454 
	`£t_šŒ_g©e
(
TRAP_no_£gm’t
,&
£gm’t_nÙ_´e£Á
);

3455 
	`£t_šŒ_g©e
(
TRAP_¡ack_”rÜ
,&
¡ack_£gm’t
);

3456 
	`£t_šŒ_g©e
(
TRAP_gp_çuÉ
,&
g’”®_´ÙeùiÚ
);

3457 
	`£t_šŒ_g©e
(
TRAP_·ge_çuÉ
,&
·ge_çuÉ
);

3458 
	`£t_šŒ_g©e
(
TRAP_¥urious_št
,&
¥urious_š‹¼u±_bug
);

3459 
	`£t_šŒ_g©e
(
TRAP_cİro_”rÜ
,&
cİroûssÜ_”rÜ
);

3460 
	`£t_šŒ_g©e
(
TRAP_®ignm’t_check
,&
®ignm’t_check
);

3461 
	`£t_šŒ_g©e
(
TRAP_machše_check
,&
machše_check
);

3462 
	`£t_šŒ_g©e
(
TRAP_simd_”rÜ
,&
simd_cİroûssÜ_”rÜ
);

3465 
idt_bËs
[0] = 
idt_bË
;

3467 
	`this_ıu
(
gdt_bË
èğ
boÙ_ıu_gdt_bË
;

3468 #ifdeà
CONFIG_COMPAT


3469 
	`this_ıu
(
com·t_gdt_bË
èğ
boÙ_ıu_com·t_gdt_bË
;

3472 
	`³rıu_Œ­s_š™
();

3474 
	`ıu_š™
();

3476 
	`İ’_soáœq
(
NMI_MCE_SOFTIRQ
, 
nmi_mû_soáœq
);

3477 
	}
}

3479 
	$»gi¡”_gue¡_nmi_ÿÎback
(
add»ss
)

3481 
vıu
 *
v
 = 
cu¼’t
;

3482 
domaš
 *
d
 = 
v
->domain;

3483 
Œ­_šfo
 *
t
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
TRAP_nmi
];

3485 
t
->
veùÜ
 = 
TRAP_nmi
;

3486 
t
->
æags
 = 0;

3487 
t
->
cs
 = (
	`is_pv_32Ú64_domaš
(
d
) ?

3488 
FLAT_COMPAT_KERNEL_CS
 : 
FLAT_KERNEL_CS
);

3489 
t
->
add»ss
 =‡ddress;

3490 
	`TI_SET_IF
(
t
, 1);

3496 iàĞ(
v
->
vıu_id
 =ğ0è&& (
	`¬ch_g‘_nmi_»asÚ
(
d
) != 0) )

3497 
v
->
nmi_³ndšg
 = 1;

3500 
	}
}

3502 
	$uÄegi¡”_gue¡_nmi_ÿÎback
()

3504 
vıu
 *
v
 = 
cu¼’t
;

3505 
Œ­_šfo
 *
t
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
TRAP_nmi
];

3507 
	`mem£t
(
t
, 0, (*t));

3510 
	}
}

3512 
	$gue¡_has_Œ­_ÿÎback
(
domaš
 *
d
, 
ušt16_t
 
vıuid
, 
Œ­_Ä
)

3514 
vıu
 *
v
;

3515 
Œ­_šfo
 *
t
;

3517 
	`BUG_ON
(
d
 =ğ
NULL
);

3518 
	`BUG_ON
(
vıuid
 >ğ
d
->
max_vıus
);

3521 
	`BUG_ON
(
Œ­_Ä
 > 
TRAP_sysÿÎ
);

3523 
v
 = 
d
->
vıu
[
vıuid
];

3524 
t
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
Œ­_Ä
];

3526  (
t
->
add»ss
 != 0);

3527 
	}
}

3530 
	$£nd_gue¡_Œ­
(
domaš
 *
d
, 
ušt16_t
 
vıuid
, 
Œ­_Ä
)

3532 
vıu
 *
v
;

3533 
soáœq_Œ­
 *
¡
 = &
	`³r_ıu
(soáœq_Œ­, 
	`smp_´oûssÜ_id
());

3535 
	`BUG_ON
(
d
 =ğ
NULL
);

3536 
	`BUG_ON
(
vıuid
 >ğ
d
->
max_vıus
);

3537 
v
 = 
d
->
vıu
[
vıuid
];

3539 
Œ­_Ä
) {

3540 
TRAP_nmi
:

3541 iàĞ
	`cmpxchg±r
(&
¡
->
vıu
, 
NULL
, 
v
) )

3542  -
EBUSY
;

3543 iàĞ!
	`‹¡_ªd_£t_boŞ
(
v
->
nmi_³ndšg
) ) {

3544 
¡
->
domaš
 = 
d
;

3545 
¡
->
´oûssÜ
 = 
v
->processor;

3548 
	`¿i£_soáœq
(
NMI_MCE_SOFTIRQ
);

3551 
¡
->
vıu
 = 
NULL
;

3554 
TRAP_machše_check
:

3555 iàĞ
	`cmpxchg±r
(&
¡
->
vıu
, 
NULL
, 
v
) )

3556  -
EBUSY
;

3561 iàĞ!
	`‹¡_ªd_£t_boŞ
(
v
->
mû_³ndšg
) ) {

3562 
¡
->
domaš
 = 
d
;

3563 
¡
->
vıu
 = 
v
;

3564 
¡
->
´oûssÜ
 = 
v
->processor;

3567 
	`¿i£_soáœq
(
NMI_MCE_SOFTIRQ
);

3570 
¡
->
vıu
 = 
NULL
;

3575  -
EIO
;

3576 
	}
}

3579 
do_£t_Œ­_bË
(
	$XEN_GUEST_HANDLE
(
cÚ¡_Œ­_šfo_t
è
Œ­s
)

3581 
Œ­_šfo
 
cur
;

3582 
vıu
 *
cu¼
 = 
cu¼’t
;

3583 
Œ­_šfo
 *
d¡
 = 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
;

3584 
rc
 = 0;

3587 iàĞ
	`gue¡_hªdË_is_nuÎ
(
Œ­s
) )

3589 
	`mem£t
(
d¡
, 0, 256 * (*dst));

3590 
	`š™_št80_dœeù_Œ­
(
cu¼
);

3596 iàĞ
	`hy³rÿÎ_´“m±_check
() )

3598 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

3599 
__HYPERVISOR_£t_Œ­_bË
, "h", 
Œ­s
);

3603 iàĞ
	`cİy_äom_gue¡
(&
cur
, 
Œ­s
, 1) )

3605 
rc
 = -
EFAULT
;

3609 iàĞ
cur
.
add»ss
 == 0 )

3612 
	`fixup_gue¡_code_£ËùÜ
(
cu¼
->
domaš
, 
cur
.
cs
);

3614 
	`memıy
(&
d¡
[
cur
.
veùÜ
], &cur, (cur));

3616 iàĞ
cur
.
veùÜ
 == 0x80 )

3617 
	`š™_št80_dœeù_Œ­
(
cu¼
);

3619 
	`gue¡_hªdË_add_off£t
(
Œ­s
, 1);

3622  
rc
;

3623 
	}
}

3625 
	$£t_debug»g
(
vıu
 *
v
, 
»g
, 
v®ue
)

3627 
i
;

3628 
vıu
 *
cu¼
 = 
cu¼’t
;

3630  
»g
 )

3633 iàĞ!
	`acûss_ok
(
v®ue
, ()) )

3634  -
EPERM
;

3635 iàĞ
v
 =ğ
cu¼
 )

3636 
	`wr™e_debug»g
(0, 
v®ue
);

3639 iàĞ!
	`acûss_ok
(
v®ue
, ()) )

3640  -
EPERM
;

3641 iàĞ
v
 =ğ
cu¼
 )

3642 
	`wr™e_debug»g
(1, 
v®ue
);

3645 iàĞ!
	`acûss_ok
(
v®ue
, ()) )

3646  -
EPERM
;

3647 iàĞ
v
 =ğ
cu¼
 )

3648 
	`wr™e_debug»g
(2, 
v®ue
);

3651 iàĞ!
	`acûss_ok
(
v®ue
, ()) )

3652  -
EPERM
;

3653 iàĞ
v
 =ğ
cu¼
 )

3654 
	`wr™e_debug»g
(3, 
v®ue
);

3661 
v®ue
 &= 0xffffefff;

3662 
v®ue
 |= 0xffff0ff0;

3663 iàĞ
v
 =ğ
cu¼
 )

3664 
	`wr™e_debug»g
(6, 
v®ue
);

3671 
v®ue
 &ğ~
DR_CONTROL_RESERVED_ZERO
;

3672 
v®ue
 |ğ
DR_CONTROL_RESERVED_ONE
;

3677 iàĞ
v®ue
 & 
DR_GENERAL_DETECT
 )

3678  -
EPERM
;

3680 iàĞ
v®ue
 & 
DR7_ACTIVE_MASK
 )

3682 
io_’abË
 = 0;

3684  
i
 = 
DR_CONTROL_SHIFT
; i < 32; i +ğ
DR_CONTROL_SIZE
 )

3686 iàĞ((
v®ue
 >> 
i
è& 3è=ğ
DR_IO
 )

3688 iàĞ!(
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_DE
) )

3689  -
EPERM
;

3690 
io_’abË
 |ğ
v®ue
 & (3 << ((
i
 - 16) >> 1));

3692 #ifdeà
__i386__


3693 iàĞ((
boÙ_ıu_d©a
.
x86_v’dÜ
 !ğ
X86_VENDOR_INTEL
) ||

3694 !
	`boÙ_ıu_has
(
X86_FEATURE_LM
)) &&

3695 (((
v®ue
 >> 
i
è& 0xcè=ğ
DR_LEN_8
) )

3696  -
EPERM
;

3701 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[5] = 
io_’abË
;

3702 
v®ue
 &ğ~
io_’abË
;

3709 iàĞ(
v
 =ğ
cu¼
) &&

3710 !(
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] & 
DR7_ACTIVE_MASK
) )

3712 
	`wr™e_debug»g
(0, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[0]);

3713 
	`wr™e_debug»g
(1, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[1]);

3714 
	`wr™e_debug»g
(2, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[2]);

3715 
	`wr™e_debug»g
(3, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[3]);

3716 
	`wr™e_debug»g
(6, 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[6]);

3719 iàĞ
v
 =ğ
cu¼
 )

3720 
	`wr™e_debug»g
(7, 
v®ue
);

3723  -
EINVAL
;

3726 
v
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[
»g
] = 
v®ue
;

3728 
	}
}

3730 
	$do_£t_debug»g
(
»g
, 
v®ue
)

3732  
	`£t_debug»g
(
cu¼’t
, 
»g
, 
v®ue
);

3733 
	}
}

3735 
	$do_g‘_debug»g
(
»g
)

3737 
vıu
 *
cu¼
 = 
cu¼’t
;

3739  
»g
 )

3743  
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[
»g
];

3745  (
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[7] |

3746 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[5]);

3748  ((
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4] & 
X86_CR4_DE
) ?

3749 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
debug»g
[
»g
 + 2] : 0);

3752  -
EINVAL
;

3753 
	}
}

	@usercopy.c

9 
	~<x’/cÚfig.h
>

10 
	~<x’/lib.h
>

11 
	~<asm/uacûss.h
>

13 
	$__cİy_to_u£r_Î
(
__u£r
 *
to
, cÚ¡ *
äom
, 
n
)

15 
__d0
, 
__d1
, 
__d2
, 
__n
 = 
n
;

17 
asm
 volatile (

18 " cm° $"
	`STR
(2*
BYTES_PER_LONG
-1)",%0\n"

22 "‡nd $"
	`STR
(
BYTES_PER_LONG
-1)",%0\n"

26 " sh¸ $"
	`STR
(
LONG_BYTEORDER
)",%0\n"

27 "‡nd $"
	`STR
(
BYTES_PER_LONG
-1)",%3\n"

29 "0:„• movs"
__OS
"\n"

36 "3:†— 0(%3,%0,"
	`STR
(
BYTES_PER_LONG
)"),%0\n"

39 
	`_ASM_EXTABLE
(4b, 5b)

40 
	`_ASM_EXTABLE
(0b, 3b)

41 
	`_ASM_EXTABLE
(1b, 2b)

42 : "=&c" (
__n
), "=&D" (
__d0
), "=&S" (
__d1
), "=&r" (
__d2
)

43 : "0" (
__n
), "1" (
to
), "2" (
äom
), "3" (__n)

46  
__n
;

47 
	}
}

50 
	$__cİy_äom_u£r_Î
(*
to
, cÚ¡ 
__u£r
 *
äom
, 
n
)

52 
__d0
, 
__d1
, 
__d2
, 
__n
 = 
n
;

54 
asm
 volatile (

55 " cm° $"
	`STR
(2*
BYTES_PER_LONG
-1)",%0\n"

59 "‡nd $"
	`STR
(
BYTES_PER_LONG
-1)",%0\n"

63 " sh¸ $"
	`STR
(
LONG_BYTEORDER
)",%0\n"

64 "‡nd $"
	`STR
(
BYTES_PER_LONG
-1)",%3\n"

66 "0:„•; movs"
__OS
"\n"

73 "3:†— 0(%3,%0,"
	`STR
(
BYTES_PER_LONG
)"),%0\n"

75 "…ush %%"
__OP
"ax\n"

78 "…İ %%"
__OP
"ax\n"

82 
	`_ASM_EXTABLE
(4b, 5b)

83 
	`_ASM_EXTABLE
(0b, 3b)

84 
	`_ASM_EXTABLE
(1b, 6b)

85 : "=&c" (
__n
), "=&D" (
__d0
), "=&S" (
__d1
), "=&r" (
__d2
)

86 : "0" (
__n
), "1" (
to
), "2" (
äom
), "3" (__n)

89  
__n
;

90 
	}
}

106 
	$cİy_to_u£r
(
__u£r
 *
to
, cÚ¡ *
äom
, 
n
)

108 iàĞ
	`acûss_ok
(
to
, 
n
) )

109 
n
 = 
	`__cİy_to_u£r
(
to
, 
äom
,‚);

110  
n
;

111 
	}
}

130 
	$cİy_äom_u£r
(*
to
, cÚ¡ 
__u£r
 *
äom
, 
n
)

132 iàĞ
	`acûss_ok
(
äom
, 
n
) )

133 
n
 = 
	`__cİy_äom_u£r
(
to
, 
äom
,‚);

135 
	`mem£t
(
to
, 0, 
n
);

136  
n
;

137 
	}
}

	@x86_32/asm-offsets.c

6 
	#COMPILE_OFFSETS


	)

8 
	~<x’/cÚfig.h
>

9 
	~<x’/³rfc.h
>

10 
	~<x’/sched.h
>

11 
	~<asm/fixm­.h
>

12 
	~<asm/h¬dœq.h
>

13 
	~<x’/muÉiboÙ.h
>

15 
	#DEFINE
(
_sym
, 
_v®
) \

16 
__asm__
 
	`__vŞ©e__
 ( "\n->" #_sym " %0 " #_v® : : "i" (
_v®
è)

	)

17 
	#BLANK
() \

18 
__asm__
 
	`__vŞ©e__
 ( "\n->" : : )

	)

19 
	#OFFSET
(
_sym
, 
_¡r
, 
_mem
) \

20 
	`DEFINE
(
_sym
, 
	`off£tof
(
_¡r
, 
_mem
));

	)

23 
	#__L2
(
_x
è(((_xè& 0x00000002è? 1 : 0)

	)

24 
	#__L4
(
_x
è(((_xè& 0x0000000cè? ( 2 + 
	`__L2
Ğ(_x)>> 2)è: __L2Ğ_x))

	)

25 
	#__L8
(
_x
è(((_xè& 0x000000f0è? ( 4 + 
	`__L4
Ğ(_x)>> 4)è: __L4Ğ_x))

	)

26 
	#__L16
(
_x
è(((_xè& 0x0000ff00è? ( 8 + 
	`__L8
Ğ(_x)>> 8)è: __L8Ğ_x))

	)

27 
	#LOG_2
(
_x
è(((_xè& 0xffff0000è? (16 + 
	`__L16
((_x)>>16)è: __L16(_x))

	)

29 
	$__dummy__
()

31 
	`OFFSET
(
UREGS_—x
, 
ıu_u£r_»gs
, 
—x
);

32 
	`OFFSET
(
UREGS_ebx
, 
ıu_u£r_»gs
, 
ebx
);

33 
	`OFFSET
(
UREGS_ecx
, 
ıu_u£r_»gs
, 
ecx
);

34 
	`OFFSET
(
UREGS_edx
, 
ıu_u£r_»gs
, 
edx
);

35 
	`OFFSET
(
UREGS_esi
, 
ıu_u£r_»gs
, 
esi
);

36 
	`OFFSET
(
UREGS_edi
, 
ıu_u£r_»gs
, 
edi
);

37 
	`OFFSET
(
UREGS_e¥
, 
ıu_u£r_»gs
, 
e¥
);

38 
	`OFFSET
(
UREGS_ebp
, 
ıu_u£r_»gs
, 
ebp
);

39 
	`OFFSET
(
UREGS_e
, 
ıu_u£r_»gs
, 
e
);

40 
	`OFFSET
(
UREGS_cs
, 
ıu_u£r_»gs
, 
cs
);

41 
	`OFFSET
(
UREGS_ds
, 
ıu_u£r_»gs
, 
ds
);

42 
	`OFFSET
(
UREGS_es
, 
ıu_u£r_»gs
, 
es
);

43 
	`OFFSET
(
UREGS_fs
, 
ıu_u£r_»gs
, 
fs
);

44 
	`OFFSET
(
UREGS_gs
, 
ıu_u£r_»gs
, 
gs
);

45 
	`OFFSET
(
UREGS_ss
, 
ıu_u£r_»gs
, 
ss
);

46 
	`OFFSET
(
UREGS_eæags
, 
ıu_u£r_»gs
, 
eæags
);

47 
	`OFFSET
(
UREGS_”rÜ_code
, 
ıu_u£r_»gs
, 
”rÜ_code
);

48 
	`OFFSET
(
UREGS_’Œy_veùÜ
, 
ıu_u£r_»gs
, 
’Œy_veùÜ
);

49 
	`OFFSET
(
UREGS_§ved_upÿÎ_mask
, 
ıu_u£r_»gs
, 
§ved_upÿÎ_mask
);

50 
	`OFFSET
(
UREGS_k”Ãl_sizeof
, 
ıu_u£r_»gs
, 
e¥
);

51 
	`DEFINE
(
UREGS_u£r_sizeof
, (
ıu_u£r_»gs
));

52 
	`BLANK
();

54 
	`OFFSET
(
VCPU_´oûssÜ
, 
vıu
, 
´oûssÜ
);

55 
	`OFFSET
(
VCPU_vıu_šfo
, 
vıu
, 
vıu_šfo
);

56 
	`OFFSET
(
VCPU_Œ­_bounû
, 
vıu
, 
¬ch
.
Œ­_bounû
);

57 
	`OFFSET
(
VCPU_th»ad_æags
, 
vıu
, 
¬ch
.
æags
);

58 
	`OFFSET
(
VCPU_ev’t_£l
, 
vıu
,

59 
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_cs
);

60 
	`OFFSET
(
VCPU_ev’t_addr
, 
vıu
,

61 
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_e
);

62 
	`OFFSET
(
VCPU_ç§ã_£l
, 
vıu
,

63 
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_cs
);

64 
	`OFFSET
(
VCPU_ç§ã_addr
, 
vıu
,

65 
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_e
);

66 
	`OFFSET
(
VCPU_k”Ãl_ss
, 
vıu
,

67 
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
);

68 
	`OFFSET
(
VCPU_k”Ãl_¥
, 
vıu
,

69 
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
);

70 
	`OFFSET
(
VCPU_gue¡_cÚ‹xt_æags
, 
vıu
, 
¬ch
.
gue¡_cÚ‹xt
.
æags
);

71 
	`OFFSET
(
VCPU_nmi_³ndšg
, 
vıu
, 
nmi_³ndšg
);

72 
	`OFFSET
(
VCPU_mû_³ndšg
, 
vıu
, 
mû_³ndšg
);

73 
	`OFFSET
(
VCPU_nmi_Şd_mask
, 
vıu
, 
nmi_¡©e
.
Şd_mask
);

74 
	`OFFSET
(
VCPU_mû_Şd_mask
, 
vıu
, 
mû_¡©e
.
Şd_mask
);

75 
	`OFFSET
(
VCPU_async_exû±iÚ_mask
, 
vıu
, 
async_exû±iÚ_mask
);

76 
	`DEFINE
(
VCPU_TRAP_NMI
, VCPU_TRAP_NMI);

77 
	`DEFINE
(
VCPU_TRAP_MCE
, VCPU_TRAP_MCE);

78 
	`DEFINE
(
_VGCF_ç§ã_di§bËs_ev’ts
, _VGCF_failsafe_disables_events);

79 
	`BLANK
();

81 
	`OFFSET
(
TSS_ss0
, 
tss_¡ruù
, 
ss0
);

82 
	`OFFSET
(
TSS_e¥0
, 
tss_¡ruù
, 
e¥0
);

83 
	`OFFSET
(
TSS_ss1
, 
tss_¡ruù
, 
ss1
);

84 
	`OFFSET
(
TSS_e¥1
, 
tss_¡ruù
, 
e¥1
);

85 
	`DEFINE
(
TSS_sizeof
, (
tss_¡ruù
));

86 
	`BLANK
();

88 
	`OFFSET
(
VCPU_svm_vmcb_·
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb_·
);

89 
	`OFFSET
(
VCPU_svm_vmcb
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb
);

90 
	`OFFSET
(
VCPU_svm_vmcb_š_sync
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb_š_sync
);

91 
	`BLANK
();

93 
	`OFFSET
(
VCPU_vmx_Ïunched
, 
vıu
, 
¬ch
.
hvm_vmx
.
Ïunched
);

94 
	`OFFSET
(
VCPU_vmx_»®mode
, 
vıu
, 
¬ch
.
hvm_vmx
.
vmx_»®mode
);

95 
	`OFFSET
(
VCPU_vmx_emuÏ‹
, 
vıu
, 
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
);

96 
	`OFFSET
(
VCPU_vm86_£g_mask
, 
vıu
, 
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
);

97 
	`OFFSET
(
VCPU_hvm_gue¡_ü2
, 
vıu
, 
¬ch
.
hvm_vıu
.
gue¡_ü
[2]);

98 
	`BLANK
();

100 
	`OFFSET
(
VMCB_¿x
, 
vmcb_¡ruù
, 
¿x
);

101 
	`OFFSET
(
VMCB_r
, 
vmcb_¡ruù
, 
r
);

102 
	`OFFSET
(
VMCB_r¥
, 
vmcb_¡ruù
, 
r¥
);

103 
	`OFFSET
(
VMCB_ræags
, 
vmcb_¡ruù
, 
ræags
);

104 
	`BLANK
();

106 
	`OFFSET
(
VCPUINFO_upÿÎ_³ndšg
, 
vıu_šfo_t
, 
evtchn_upÿÎ_³ndšg
);

107 
	`OFFSET
(
VCPUINFO_upÿÎ_mask
, 
vıu_šfo_t
, 
evtchn_upÿÎ_mask
);

108 
	`BLANK
();

110 
	`OFFSET
(
CPUINFO_gue¡_ıu_u£r_»gs
, 
ıu_šfo
, 
gue¡_ıu_u£r_»gs
);

111 
	`OFFSET
(
CPUINFO_´oûssÜ_id
, 
ıu_šfo
, 
´oûssÜ_id
);

112 
	`OFFSET
(
CPUINFO_cu¼’t_vıu
, 
ıu_šfo
, 
cu¼’t_vıu
);

113 
	`DEFINE
(
CPUINFO_sizeof
, (
ıu_šfo
));

114 
	`BLANK
();

116 
	`OFFSET
(
TRAPBOUNCE_”rÜ_code
, 
Œ­_bounû
, 
”rÜ_code
);

117 
	`OFFSET
(
TRAPBOUNCE_æags
, 
Œ­_bounû
, 
æags
);

118 
	`OFFSET
(
TRAPBOUNCE_cs
, 
Œ­_bounû
, 
cs
);

119 
	`OFFSET
(
TRAPBOUNCE_e
, 
Œ­_bounû
, 
e
);

120 
	`BLANK
();

122 #ià
PERF_COUNTERS


123 
	`DEFINE
(
ASM_PERFC_hy³rÿÎs
, 
PERFC_hy³rÿÎs
);

124 
	`DEFINE
(
ASM_PERFC_exû±iÚs
, 
PERFC_exû±iÚs
);

125 
	`BLANK
();

128 
	`DEFINE
(
FIXMAP_­ic_ba£
, 
	`fix_to_vœt
(
FIX_APIC_BASE
));

129 
	`BLANK
();

131 
	`DEFINE
(
IRQSTAT_shiá
, 
	`LOG_2
((
œq_ıu¡©_t
)));

132 
	`BLANK
();

134 
	`OFFSET
(
CPUINFO86_ext_ã©u»s
, 
ıušfo_x86
, 
x86_ÿ·b™y
[1]);

135 
	`BLANK
();

137 
	`OFFSET
(
MB_æags
, 
muÉiboÙ_šfo_t
, 
æags
);

138 
	`OFFSET
(
MB_cmdlše
, 
muÉiboÙ_šfo_t
, 
cmdlše
);

139 
	}
}

	@x86_32/domain_page.c

9 
	~<x’/cÚfig.h
>

10 
	~<x’/sched.h
>

11 
	~<x’/mm.h
>

12 
	~<x’/³rfc.h
>

13 
	~<x’/domaš_·ge.h
>

14 
	~<asm/cu¼’t.h
>

15 
	~<asm/æushb.h
>

16 
	~<asm/h¬dœq.h
>

17 
	~<asm/hvm/suµÜt.h
>

18 
	~<asm/fixm­.h
>

20 
šlše
 
vıu
 *
	$m­ÿche_cu¼’t_vıu
()

22 
vıu
 *
v
;

25 
v
 = 
cu¼’t
;

32 iàĞ
	`uÆik–y
(!
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
)è&& !
	`is_hvm_vıu
(v) )

35 iàĞ(
v
 = 
idË_vıu
[
	`smp_´oûssÜ_id
()]è=ğ
cu¼’t
 )

36 
	`sync_loÿl_exec¡©e
();

38 
	`ASSERT
(
	`»ad_ü3
(è=ğ
	`__·
(
idË_pg_bË
));

41  
v
;

42 
	}
}

44 *
	$m­_domaš_·ge
(
mâ
)

46 
va
, 
æags
;

47 
idx
, 
i
;

48 
vıu
 *
v
;

49 
m­ÿche_domaš
 *
dÿche
;

50 
m­ÿche_vıu
 *
vÿche
;

51 
vıu_m­hash_’Œy
 *
hash’t
;

53 
	`³rfc_šü
(
m­_domaš_·ge_couÁ
);

55 
v
 = 
	`m­ÿche_cu¼’t_vıu
();

57 
	`ASSERT
(()
v
 != 0xfffff000);

59 
dÿche
 = &
v
->
domaš
->
¬ch
.
m­ÿche
;

60 
vÿche
 = &
v
->
¬ch
.
m­ÿche
;

62 
	`loÿl_œq_§ve
(
æags
);

64 
hash’t
 = &
vÿche
->
hash
[
	`MAPHASH_HASHFN
(
mâ
)];

65 iàĞ
hash’t
->
mâ
 == mfn )

67 
idx
 = 
hash’t
->idx;

68 
hash’t
->
»fút
++;

69 
	`ASSERT
(
idx
 < 
MAPCACHE_ENTRIES
);

70 
	`ASSERT
(
hash’t
->
»fút
 != 0);

71 
	`ASSERT
(
	`l1e_g‘_pâ
(
dÿche
->
l1b
[
idx
]è=ğ
mâ
);

72 
out
;

75 
	`¥š_lock
(&
dÿche
->
lock
);

78 iàĞ
	`uÆik–y
(
dÿche
->
•och
 !ğ
vÿche
->
shadow_•och
) )

80 
vÿche
->
shadow_•och
 = 
dÿche
->
•och
;

81 iàĞ
	`NEED_FLUSH
(
	`this_ıu
(
bæush_time
), 
dÿche
->
bæush_time¡amp
) )

83 
	`³rfc_šü
(
domaš_·ge_b_æush
);

84 
	`æush_b_loÿl
();

88 
idx
 = 
	`fšd_Ãxt_z”o_b™
(
dÿche
->
šu£
, 
MAPCACHE_ENTRIES
, dÿche->
cursÜ
);

89 iàĞ
	`uÆik–y
(
idx
 >ğ
MAPCACHE_ENTRIES
) )

92  
i
 = 0; i < 
	`ARRAY_SIZE
(
dÿche
->
g¬bage
); i++ )

94 
x
 = 
	`xchg
(&
dÿche
->
g¬bage
[
i
], 0);

95 
dÿche
->
šu£
[
i
] &ğ~
x
;

99 
	`³rfc_šü
(
domaš_·ge_b_æush
);

100 
	`æush_b_loÿl
();

101 
vÿche
->
shadow_•och
 = ++
dÿche
->
•och
;

102 
dÿche
->
bæush_time¡amp
 = 
	`bæush_cu¼’t_time
();

104 
idx
 = 
	`fšd_fœ¡_z”o_b™
(
dÿche
->
šu£
, 
MAPCACHE_ENTRIES
);

105 
	`BUG_ON
(
idx
 >ğ
MAPCACHE_ENTRIES
);

108 
	`£t_b™
(
idx
, 
dÿche
->
šu£
);

109 
dÿche
->
cursÜ
 = 
idx
 + 1;

111 
	`¥š_uÆock
(&
dÿche
->
lock
);

113 
	`l1e_wr™e
(&
dÿche
->
l1b
[
idx
], 
	`l1e_äom_pâ
(
mâ
, 
__PAGE_HYPERVISOR
));

115 
out
:

116 
	`loÿl_œq_»¡Üe
(
æags
);

117 
va
 = 
MAPCACHE_VIRT_START
 + (
idx
 << 
PAGE_SHIFT
);

118  (*)
va
;

119 
	}
}

121 
	$unm­_domaš_·ge
(cÚ¡ *
va
)

123 
idx
;

124 
vıu
 *
v
;

125 
m­ÿche_domaš
 *
dÿche
;

126 
mâ
, 
æags
;

127 
vıu_m­hash_’Œy
 *
hash’t
;

129 
	`ASSERT
((*)
MAPCACHE_VIRT_START
 <ğ
va
);

130 
	`ASSERT
(
va
 < (*)
MAPCACHE_VIRT_END
);

132 
v
 = 
	`m­ÿche_cu¼’t_vıu
();

134 
dÿche
 = &
v
->
domaš
->
¬ch
.
m­ÿche
;

136 
idx
 = (()
va
 - 
MAPCACHE_VIRT_START
è>> 
PAGE_SHIFT
;

137 
mâ
 = 
	`l1e_g‘_pâ
(
dÿche
->
l1b
[
idx
]);

138 
hash’t
 = &
v
->
¬ch
.
m­ÿche
.
hash
[
	`MAPHASH_HASHFN
(
mâ
)];

140 
	`loÿl_œq_§ve
(
æags
);

142 iàĞ
hash’t
->
idx
 == idx )

144 
	`ASSERT
(
hash’t
->
mâ
 == mfn);

145 
	`ASSERT
(
hash’t
->
»fút
 != 0);

146 
hash’t
->
»fút
--;

148 iàĞ
hash’t
->
»fút
 == 0 )

150 iàĞ
hash’t
->
idx
 !ğ
MAPHASHENT_NOTINUSE
 )

153 
	`ASSERT
(
	`l1e_g‘_pâ
(
dÿche
->
l1b
[
hash’t
->
idx
]è=ğhash’t->
mâ
);

154 
	`l1e_wr™e
(&
dÿche
->
l1b
[
hash’t
->
idx
], 
	`l1e_em±y
());

156 
	`£t_b™
(
hash’t
->
idx
, 
dÿche
->
g¬bage
);

160 
hash’t
->
mâ
 = mfn;

161 
hash’t
->
idx
 = idx;

166 
	`l1e_wr™e
(&
dÿche
->
l1b
[
idx
], 
	`l1e_em±y
());

168 
	`£t_b™
(
idx
, 
dÿche
->
g¬bage
);

171 
	`loÿl_œq_»¡Üe
(
æags
);

172 
	}
}

174 
	$m­ÿche_domaš_š™
(
domaš
 *
d
)

176 
d
->
¬ch
.
m­ÿche
.
l1b
 = d->¬ch.
mm_³rdomaš_±
 +

177 (
GDT_LDT_MBYTES
 << (20 - 
PAGE_SHIFT
));

178 
	`¥š_lock_š™
(&
d
->
¬ch
.
m­ÿche
.
lock
);

179 
	}
}

181 
	$m­ÿche_vıu_š™
(
vıu
 *
v
)

183 
i
;

184 
vıu_m­hash_’Œy
 *
hash’t
;

187  
i
 = 0; i < 
MAPHASH_ENTRIES
; i++ )

189 
hash’t
 = &
v
->
¬ch
.
m­ÿche
.
hash
[
i
];

190 
hash’t
->
mâ
 = ~0UL;

191 
hash’t
->
idx
 = 
MAPHASHENT_NOTINUSE
;

193 
	}
}

195 
	#GLOBALMAP_BITS
 (
IOREMAP_MBYTES
 << (20 - 
PAGE_SHIFT
))

	)

196 
	gšu£
[
BITS_TO_LONGS
(
GLOBALMAP_BITS
)];

197 
	gg¬bage
[
BITS_TO_LONGS
(
GLOBALMAP_BITS
)];

198 
	gšu£_cursÜ
;

199 
DEFINE_SPINLOCK
(
glob®m­_lock
);

201 *
	$m­_domaš_·ge_glob®
(
mâ
)

203 
l2_pg’Œy_t
 *
¶2e
;

204 
l1_pg’Œy_t
 *
¶1e
;

205 
idx
, 
i
;

206 
va
;

208 
	`ASSERT
(!
	`š_œq
(è&& 
	`loÿl_œq_is_’abËd
());

211 
	`BUILD_BUG_ON
(
IOREMAP_VIRT_START
 + (
IOREMAP_MBYTES
 << 19è>ğ
FIXADDR_START
);

213 
	`¥š_lock
(&
glob®m­_lock
);

215 
idx
 = 
	`fšd_Ãxt_z”o_b™
(
šu£
, 
GLOBALMAP_BITS
, 
šu£_cursÜ
);

216 
va
 = 
IOREMAP_VIRT_START
 + (
idx
 << 
PAGE_SHIFT
);

217 iàĞ
	`uÆik–y
(
va
 >ğ
FIXADDR_START
) )

220  
i
 = 0; i < 
	`ARRAY_SIZE
(
g¬bage
); i++ )

222 
x
 = 
	`xchg
(&
g¬bage
[
i
], 0);

223 
šu£
[
i
] &ğ~
x
;

227 
	`æush_b_®l
();

229 
idx
 = 
	`fšd_fœ¡_z”o_b™
(
šu£
, 
GLOBALMAP_BITS
);

230 
va
 = 
IOREMAP_VIRT_START
 + (
idx
 << 
PAGE_SHIFT
);

231 iàĞ
	`uÆik–y
(
va
 >ğ
FIXADDR_START
) )

233 
	`¥š_uÆock
(&
glob®m­_lock
);

234  
NULL
;

238 
	`£t_b™
(
idx
, 
šu£
);

239 
šu£_cursÜ
 = 
idx
 + 1;

241 
	`¥š_uÆock
(&
glob®m­_lock
);

243 
¶2e
 = 
	`vœt_to_x’_l2e
(
va
);

244 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
è+ 
	`l1_bË_off£t
(
va
);

245 
	`l1e_wr™e
(
¶1e
, 
	`l1e_äom_pâ
(
mâ
, 
__PAGE_HYPERVISOR
));

247  (*)
va
;

248 
	}
}

250 
	$unm­_domaš_·ge_glob®
(cÚ¡ *
va
)

252 
__va
 = ()
va
;

253 
l2_pg’Œy_t
 *
¶2e
;

254 
l1_pg’Œy_t
 *
¶1e
;

255 
idx
;

257 
	`ASSERT
(
__va
 >ğ
IOREMAP_VIRT_START
);

260 
¶2e
 = 
	`vœt_to_x’_l2e
(
__va
);

261 
¶1e
 = 
	`l2e_to_l1e
(*
¶2e
è+ 
	`l1_bË_off£t
(
__va
);

262 
	`l1e_wr™e
(
¶1e
, 
	`l1e_em±y
());

265 
idx
 = (
__va
 - 
IOREMAP_VIRT_START
è>> 
PAGE_SHIFT
;

266 
	`£t_b™
(
idx
, 
g¬bage
);

267 
	}
}

	@x86_32/gdbstub.c

23 
	~<asm/debugg”.h
>

26 
	$gdb_¬ch_»ad_»g_¬¿y
(
ıu_u£r_»gs
 *
»gs
, 
gdb_cÚ‹xt
 *
ùx
)

28 
	#GDB_REG
(
r
è
	`gdb_wr™e_to_·ck‘_hex
Ô, Ô), 
ùx
);

	)

29 
	`GDB_REG
(
»gs
->
—x
);

30 
	`GDB_REG
(
»gs
->
ecx
);

31 
	`GDB_REG
(
»gs
->
edx
);

32 
	`GDB_REG
(
»gs
->
ebx
);

33 
	`GDB_REG
(
»gs
->
e¥
);

34 
	`GDB_REG
(
»gs
->
ebp
);

35 
	`GDB_REG
(
»gs
->
esi
);

36 
	`GDB_REG
(
»gs
->
edi
);

37 
	`GDB_REG
(
»gs
->
e
);

38 
	`GDB_REG
(
»gs
->
eæags
);

39 #undeà
GDB_REG


40 
	#GDB_SEG_REG
(
s
è
	`gdb_wr™e_to_·ck‘_hex
(s, (
u32
), 
ùx
);

	)

43 
	`GDB_SEG_REG
(
»gs
->
cs
);

44 
	`GDB_SEG_REG
(
»gs
->
ss
);

45 
	`GDB_SEG_REG
(
»gs
->
ds
);

46 
	`GDB_SEG_REG
(
»gs
->
es
);

47 
	`GDB_SEG_REG
(
»gs
->
fs
);

48 
	`GDB_SEG_REG
(
»gs
->
gs
);

49 #undeà
GDB_SEG_REG


50 
	`gdb_£nd_·ck‘
(
ùx
);

51 
	}
}

54 
	$gdb_¬ch_wr™e_»g_¬¿y
(
ıu_u£r_»gs
 *
»gs
, cÚ¡ * 
buf
,

55 
gdb_cÚ‹xt
 *
ùx
)

58 
	`gdb_£nd_»¶y
("E02", 
ùx
);

59 
	}
}

62 
	$gdb_¬ch_»ad_»g
(
»gnum
, 
ıu_u£r_»gs
 *
»gs
,

63 
gdb_cÚ‹xt
 *
ùx
)

65 
	`gdb_£nd_»¶y
("", 
ùx
);

66 
	}
}

69 
	$gdb_¬ch_wr™e_»g
(
»gnum
, 
v®
,

70 
ıu_u£r_»gs
 *
»gs
, 
gdb_cÚ‹xt
 *
ùx
)

72 
	`gdb_£nd_»¶y
("", 
ùx
);

73 
	}
}

	@x86_32/machine_kexec.c

9 
	~<x’/ty³s.h
>

10 
	~<x’/k”Ãl.h
>

11 
	~<asm/·ge.h
>

12 
	~<public/kexec.h
>

14 
	$machše_kexec_g‘_x’
(
x’_kexec_¿nge_t
 *
¿nge
)

16 
¿nge
->
¡¬t
 = 
	`vœt_to_maddr
(
_¡¬t
);

17 
¿nge
->
size
 = ()
x’h—p_phys_’d
 -

18 ()
¿nge
->
¡¬t
;

20 
	}
}

	@x86_32/mm.c

21 
	~<x’/cÚfig.h
>

22 
	~<x’/lib.h
>

23 
	~<x’/š™.h
>

24 
	~<x’/mm.h
>

25 
	~<x’/sched.h
>

26 
	~<x’/gue¡_acûss.h
>

27 
	~<asm/cu¼’t.h
>

28 
	~<asm/·ge.h
>

29 
	~<asm/æushb.h
>

30 
	~<asm/fixm­.h
>

31 
	~<asm/£tup.h
>

32 
	~<public/memÜy.h
>

33 
	~<mši.h
>

35 
l2_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

36 
	gidË_pg_bË_l2
[4 * 
L2_PAGETABLE_ENTRIES
];

38 
l1_pg’Œy_t
 
l1_id’tm­
[
L1_PAGETABLE_ENTRIES
];

40 
__»ad_mo¡ly
 
	gPAGE_HYPERVISOR
 = 
__PAGE_HYPERVISOR
;

41 
__»ad_mo¡ly
 
	gPAGE_HYPERVISOR_NOCACHE
 = 
__PAGE_HYPERVISOR_NOCACHE
;

43 
__»ad_mo¡ly
 
	gm±_size
;

45 *
	$®loc_x’_·g‘abË
()

47 
mâ
;

49 iàĞ!
—¾y_boÙ
 )

51 *
v
 = 
	`®loc_x’h—p_·ge
();

53 
	`BUG_ON
(!
dom0
 && !
v
);

54  
v
;

57 
mâ
 = 
x’h—p_š™Ÿl_phys_¡¬t
 >> 
PAGE_SHIFT
;

58 
x’h—p_š™Ÿl_phys_¡¬t
 +ğ
PAGE_SIZE
;

59  
	`mâ_to_vœt
(
mâ
);

60 
	}
}

62 
l2_pg’Œy_t
 *
	$vœt_to_x’_l2e
(
v
)

64  &
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
v
)];

65 
	}
}

67 *
	$do_·ge_w®k
(
vıu
 *
v
, 
addr
)

69  
NULL
;

70 
	}
}

72 
__š™
 
	$·gšg_š™
()

74 
v
;

75 
·ge_šfo
 *
pg
;

76 
i
, 
n
;

78 iàĞ
ıu_has_pge
 )

81 
	`£t_š_ü4
(
X86_CR4_PGE
);

82 
PAGE_HYPERVISOR
 |ğ
_PAGE_GLOBAL
;

83 
PAGE_HYPERVISOR_NOCACHE
 |ğ
_PAGE_GLOBAL
;

85  
v
 = 
HYPERVISOR_VIRT_START
; v; v +ğ(1 << 
L2_PAGETABLE_SHIFT
) )

86 iàĞ(
	`l2e_g‘_æags
(
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
v
)]) &

87 (
_PAGE_PSE
|
_PAGE_PRESENT
)) == (_PAGE_PSE|_PAGE_PRESENT) )

88 
	`l2e_add_æags
(
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
v
)],

89 
_PAGE_GLOBAL
);

90  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

91 
	`l1e_add_æags
(
l1_id’tm­
[
i
], 
_PAGE_GLOBAL
);

98 
m±_size
 = (
max_·ge
 * 
BYTES_PER_LONG
è+ (1UL << 
L2_PAGETABLE_SHIFT
) - 1;

99 
m±_size
 &ğ~((1UL << 
L2_PAGETABLE_SHIFT
) - 1UL);

100 
	#MFN
(
x
è(((xè<< 
L2_PAGETABLE_SHIFT
è/ ())

	)

101 
	#CNT
 (((*
äame_bË
) & -(*frame_table)) / \

102 (*
machše_to_phys_m­pšg
))

	)

103 
	`BUILD_BUG_ON
(((*
äame_bË
) & ~(*frame_table)) % \

104 (*
machše_to_phys_m­pšg
));

105  
i
 = 0; i < (
m±_size
 >> 
L2_PAGETABLE_SHIFT
); i++ )

107  
n
 = 0;‚ < 
CNT
; ++n)

108 iàĞ
	`mâ_v®id
(
	`MFN
(
i
è+ 
n
 * 
PDX_GROUP_COUNT
) )

110 iàĞ
n
 =ğ
CNT
 )

112 iàĞ(
pg
 = 
	`®loc_domh—p_·ges
(
NULL
, 
PAGETABLE_ORDER
, 0)) == NULL )

113 
	`·nic
("Notƒnough memoryo bootstrap Xen.\n");

114 
	`l2e_wr™e
(&
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
RDWR_MPT_VIRT_START
è+ 
i
],

115 
	`l2e_äom_·ge
(
pg
, 
PAGE_HYPERVISOR
 | 
_PAGE_PSE
));

117 
	`l2e_wr™e
(&
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
RO_MPT_VIRT_START
è+ 
i
],

118 
	`l2e_äom_·ge
(

119 
pg
, (
__PAGE_HYPERVISOR
 | 
_PAGE_PSE
è& ~
_PAGE_RW
));

121 
	`mem£t
((*)(
RDWR_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
)), 0x55,

122 1UL << 
L2_PAGETABLE_SHIFT
);

124 #undeà
CNT


125 #undeà
MFN


128  
i
 = 0; i < (
IOREMAP_MBYTES
 >> (
L2_PAGETABLE_SHIFT
 - 20)); i++ )

130 *
p
;

131 
l2_pg’Œy_t
 *
¶2e
;

132 
¶2e
 = &
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
IOREMAP_VIRT_START
è+ 
i
];

133 iàĞ
	`l2e_g‘_æags
(*
¶2e
è& 
_PAGE_PRESENT
 )

135 
p
 = 
	`®loc_x’h—p_·ge
();

136 
	`ş—r_·ge
(
p
);

137 
	`l2e_wr™e
(
¶2e
, 
	`l2e_äom_·ge
(
	`vœt_to_·ge
(
p
), 
__PAGE_HYPERVISOR
));

139 
	}
}

141 
__š™
 
	$£tup_idË_·g‘abË
()

143 
i
;

145  
i
 = 0; i < 
PDPT_L2_ENTRIES
; i++ )

146 
	`l2e_wr™e
(&
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
PERDOMAIN_VIRT_START
)+
i
],

147 
	`l2e_äom_·ge
(
	`vœt_to_·ge
(
idË_vıu
[0]->
domaš
->

148 
¬ch
.
mm_³rdomaš_±
è+ 
i
,

149 
__PAGE_HYPERVISOR
));

150 
	}
}

152 
__š™
 
	$z­_low_m­pšgs
(
l2_pg’Œy_t
 *
dom0_l2
)

154 
i
;

157  
i
 = 0; i < (
HYPERVISOR_VIRT_START
 >> 
L2_PAGETABLE_SHIFT
); i++ )

158 iàĞ
	`l2e_g‘_š‹
(
dom0_l2
[
i
]) ==

159 
	`l2e_g‘_š‹
(
idË_pg_bË_l2
[
i
]) )

160 
	`l2e_wr™e
(&
dom0_l2
[
i
], 
	`l2e_em±y
());

163 
	`BUG_ON
(
	`l2e_g‘_pâ
(
idË_pg_bË_l2
[0]è!ğ
	`vœt_to_mâ
(
l1_id’tm­
));

164 
	`l2e_wr™e_©omic
(&
idË_pg_bË_l2
[0], 
	`l2e_em±y
());

165 
	`de¡roy_x’_m­pšgs
(0, 
HYPERVISOR_VIRT_START
);

167 
	`æush_®l
(
FLUSH_TLB_GLOBAL
);

170 
	`m­_·ges_to_x’
(
BOOT_TRAMPOLINE
, BOOT_TRAMPOLINE >> 
PAGE_SHIFT
,

171 0x10, 
__PAGE_HYPERVISOR
);

172 
	}
}

174 
__š™
 
	$sub¬ch_š™_memÜy
()

176 
m2p_¡¬t_mâ
;

177 
i
, 
j
;

178 
l2_pg’Œy_t
 
l2e
;

180 
	`BUILD_BUG_ON
((
·ge_šfo
è!ğ24+(
äame_t
));

183  
i
 = 0; i < (
m±_size
 >> 
L2_PAGETABLE_SHIFT
); i++ )

185 
l2e
 = 
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(
RDWR_MPT_VIRT_START
è+ 
i
];

186 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

188 
m2p_¡¬t_mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

189  
j
 = 0; j < 
L2_PAGETABLE_ENTRIES
; j++ )

191 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
m2p_¡¬t_mâ
 + 
j
);

192 
	`sh¬e_x’_·ge_w™h_´iveged_gue¡s
(
·ge
, 
XENSHARE_»adÚly
);

196 iàĞ
su³rvisÜ_mode_k”Ãl
 )

199 
desc_¡ruù
 *
d
;

200 
d
 = &
boÙ_ıu_gdt_bË
[(
FLAT_RING1_CS
 >> 3è- 
FIRST_RESERVED_GDT_ENTRY
];

201 
d
[0].
b
 &ğ~
_SEGMENT_DPL
;

202 
d
[1].
b
 &ğ~
_SEGMENT_DPL
;

204 
	}
}

206 
sub¬ch_memÜy_İ
(
İ
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

208 
x’_machphys_mâ_li¡
 
xmml
;

209 
mâ
, 
Ï¡_mâ
;

210 
i
, 
max
;

211 
l2_pg’Œy_t
 
l2e
;

212 
rc
 = 0;

214  
İ
 )

216 
XENMEM_machphys_mâ_li¡
:

217 iàĞ
	`cİy_äom_gue¡
(&
xmml
, 
¬g
, 1) )

218  -
EFAULT
;

220 
max
 = 
	`mš_t
(, 
xmml
.
max_ex‹Ás
, 
m±_size
 >> 21);

222  
i
 = 0, 
Ï¡_mâ
 = 0; i < 
max
; i++ )

224 
l2e
 = 
idË_pg_bË_l2
[
	`l2_lš—r_off£t
(

225 
RDWR_MPT_VIRT_START
 + (
i
 << 21))];

226 iàĞ
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
 )

227 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

229 
mâ
 = 
Ï¡_mâ
;

230 
	`ASSERT
(
mâ
);

231 iàĞ
	`cİy_to_gue¡_off£t
(
xmml
.
ex‹Á_¡¬t
, 
i
, &
mâ
, 1) )

232  -
EFAULT
;

233 
Ï¡_mâ
 = 
mâ
;

236 
xmml
.
Ä_ex‹Ás
 = 
i
;

237 iàĞ
	`cİy_to_gue¡
(
¬g
, &
xmml
, 1) )

238  -
EFAULT
;

243 
rc
 = -
ENOSYS
;

247  
rc
;

248 
	}
}

250 
	$do_¡ack_sw™ch
(
ss
, 
e¥
)

252 
tss_¡ruù
 *
t
 = &
	`this_ıu
(
š™_tss
);

254 
	`fixup_gue¡_¡ack_£ËùÜ
(
cu¼’t
->
domaš
, 
ss
);

256 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
 = 
ss
;

257 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
 = 
e¥
;

258 
t
->
ss1
 = 
ss
;

259 
t
->
e¥1
 = 
e¥
;

262 
	}
}

265 
	$check_desütÜ
(cÚ¡ 
domaš
 *
dom
, 
desc_¡ruù
 *
d
)

267 
ba£
, 
lim™
;

268 
u32
 
a
 = 
d
->a, 
b
 = d->b;

269 
u16
 
cs
;

272 iàĞ
su³rvisÜ_mode_k”Ãl
 )

276 iàĞ!(
b
 & 
_SEGMENT_P
) )

277 
good
;

285 iàĞ(
b
 & 
_SEGMENT_DPL
è< (
	`GUEST_KERNEL_RPL
(
dom
) << 13) )

286 
d
->
b
 = b = (b & ~
_SEGMENT_DPL
è| (
	`GUEST_KERNEL_RPL
(
dom
) << 13);

288 iàĞ!(
b
 & 
_SEGMENT_S
) )

303 iàĞ(
b
 & 
_SEGMENT_TYPE
) != 0xc00 )

304 
bad
;

307 
cs
 = 
a
 >> 16;

308 
	`fixup_gue¡_code_£ËùÜ
(
dom
, 
cs
);

309 iàĞ!
	`gue¡_g©e_£ËùÜ_okay
(
dom
, 
cs
) )

310 
bad
;

311 
a
 = 
d
->¨ğ(d->¨& 0xffffUè| (
cs
 << 16);

314 iàĞ(
b
 & 0xe0) != 0 )

315 
bad
;

318 
good
;

322 
ba£
 = (
b
&(0xff<<24)è| ((b&0xff)<<16è| (
a
>>16);

323 iàĞ
ba£
 >ğ(
GUEST_SEGMENT_MAX_ADDR
 - 
PAGE_SIZE
) )

324 
bad
;

327 
lim™
 = (
b
&0xf0000è| (
a
&0xffff);

328 
lim™
++;

329 iàĞ(
b
 & 
_SEGMENT_G
) )

330 
lim™
 <<= 12;

332 iàĞ(
b
 & (
_SEGMENT_CODE
 | 
_SEGMENT_EC
)) == _SEGMENT_EC )

340 iàĞ(
ba£
 + 
lim™
) > base )

342 
lim™
 = -(
ba£
 & 
PAGE_MASK
);

343 
Œunÿ‹
;

355 iàĞ((
ba£
 + 
lim™
) <= base) ||

356 ((
ba£
 + 
lim™
è> 
GUEST_SEGMENT_MAX_ADDR
) )

358 
lim™
 = 
GUEST_SEGMENT_MAX_ADDR
 - 
ba£
;

359 
Œunÿ‹
:

360 iàĞ!(
b
 & 
_SEGMENT_G
) )

361 
bad
;

362 
lim™
 = (limit >> 12) - 1;

363 
d
->
a
 &ğ~0x0ffff; d->¨|ğ
lim™
 & 0x0ffff;

364 
d
->
b
 &ğ~0xf0000; d->b |ğ
lim™
 & 0xf0000;

368 
good
:

370 
bad
:

372 
	}
}

	@x86_32/pci.c

7 
	~<x’/¥šlock.h
>

8 
	~<x’/pci.h
>

9 
	~<asm/io.h
>

11 
	#PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
) \

12 (0x80000000 | (
bus
 << 16è| (
dev
 << 11è| (
func
 << 8è| (
»g
 & ~3))

	)

14 
ušt8_t
 
	$pci_cÚf_»ad8
(

15 
bus
, 
dev
, 
func
, 
»g
)

17 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

18  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 3, 1);

19 
	}
}

21 
ušt16_t
 
	$pci_cÚf_»ad16
(

22 
bus
, 
dev
, 
func
, 
»g
)

24 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

25  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 2, 2);

26 
	}
}

28 
ušt32_t
 
	$pci_cÚf_»ad32
(

29 
bus
, 
dev
, 
func
, 
»g
)

31 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

32  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
), 0, 4);

33 
	}
}

35 
	$pci_cÚf_wr™e8
(

36 
bus
, 
dev
, 
func
, 
»g
,

37 
ušt8_t
 
d©a
)

39 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

40 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 3, 1, 
d©a
);

41 
	}
}

43 
	$pci_cÚf_wr™e16
(

44 
bus
, 
dev
, 
func
, 
»g
,

45 
ušt16_t
 
d©a
)

47 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

48 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 2, 2, 
d©a
);

49 
	}
}

51 
	$pci_cÚf_wr™e32
(

52 
bus
, 
dev
, 
func
, 
»g
,

53 
ušt32_t
 
d©a
)

55 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7è|| (
»g
 > 255));

56 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
), 0, 4, 
d©a
);

57 
	}
}

59 
	$pci_fšd_ext_ÿ·b™y
(
£g
, 
bus
, 
devâ
, 
ÿp
)

62 
	}
}

64 
	$aıi_mmcfg_š™
()

67 
	}
}

	@x86_32/seg_fixup.c

23 
	~<x’/cÚfig.h
>

24 
	~<x’/š™.h
>

25 
	~<x’/sched.h
>

26 
	~<x’/lib.h
>

27 
	~<x’/”ºo.h
>

28 
	~<x’/mm.h
>

29 
	~<x’/³rfc.h
>

30 
	~<asm/cu¼’t.h
>

31 
	~<asm/´oûssÜ.h
>

32 
	~<asm/»gs.h
>

33 
	~<asm/x86_emuÏ‹.h
>

36 
	#INSN_SUFFIX_BYTES
 (7)

	)

37 
	#OPCODE_BYTE
 (1<<4)

	)

38 
	#HAS_MODRM
 (1<<5)

	)

41 
	#X
 0

	)

42 
	#O
 
OPCODE_BYTE


	)

43 
	#M
 
HAS_MODRM


	)

45 cÚ¡ 
u8
 
	gš¢_decode
[256] = {

47 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

48 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

50 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

51 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

53 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

54 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

56 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

57 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

59 
X
, X, X, X, X, X, X, X,

60 
X
, X, X, X, X, X, X, X,

62 
X
, X, X, X, X, X, X, X,

63 
X
, X, X, X, X, X, X, X,

65 
X
, X, X, X, X, X, X, X,

66 
X
, 
O
|
M
|4, X, O|M|1, X, X, X, X,

68 
X
, X, X, X, X, X, X, X,

69 
X
, X, X, X, X, X, X, X,

71 
O
|
M
|1, O|M|4, O|M|1, O|M|1, O|M, O|M, O|M, O|M,

72 
O
|
M
, O|M, O|M, O|M, O|M, 
X
|M, O|M, O|M,

74 
X
, X, X, X, X, X, X, X,

75 
X
, X, X, X, X, X, X, X,

77 
O
|4, O|4, O|4, O|4, 
X
, X, X, X,

78 
X
, X, X, X, X, X, X, X,

80 
X
, X, X, X, X, X, X, X,

81 
X
, X, X, X, X, X, X, X,

83 
O
|
M
|1, O|M|1, 
X
, X, X, X, O|M|1, O|M|4,

84 
X
, X, X, X, X, X, X, X,

86 
O
|
M
, O|M, O|M, O|M, 
X
, X, X, X,

87 
X
, X, X, X, X, X, X, X,

89 
X
, X, X, X, X, X, X, X,

90 
X
, X, X, X, X, X, X, X,

92 
X
, X, X, X, X, X, 
O
|
M
, O|M,

93 
X
, X, X, X, X, X, 
O
|
M
, O|M

96 cÚ¡ 
u8
 
	gæßt_decode
[64] = {

97 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

98 
O
|
M
, 
X
, O|M, O|M, O|M, O|M, O|M, O|M,

99 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

100 
O
|
M
, 
X
, O|M, O|M, X, O|M, X, O|M,

101 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

102 
O
|
M
, O|M, O|M, O|M, O|M, 
X
, O|M, O|M,

103 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

104 
O
|
M
, 
X
, O|M, O|M, O|M, O|M, O|M, O|M,

107 cÚ¡ 
u8
 
	gtwoby‹_decode
[256] = {

109 
X
, X, X, X, X, X, X, X,

110 
X
, X, X, X, X, X, X, X,

112 
X
, X, X, X, X, X, X, X,

113 
O
|
M
, 
X
, X, X, X, X, X, X,

115 
X
, X, X, X, X, X, X, X,

116 
X
, X, X, X, X, X, X, X,

118 
X
, X, X, X, X, X, X, X,

119 
X
, X, X, X, X, X, X, X,

121 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

122 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

124 
X
, X, X, X, X, X, X, X,

125 
X
, X, X, X, X, X, X, X,

127 
X
, X, X, X, X, X, X, X,

128 
X
, X, X, X, X, X, X, X,

130 
X
, X, X, X, X, X, X, X,

131 
X
, X, X, X, X, X, X, X,

133 
X
, X, X, X, X, X, X, X,

134 
X
, X, X, X, X, X, X, X,

136 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

137 
O
|
M
, O|M, O|M, O|M, O|M, O|M, O|M, O|M,

139 
X
, X, X, 
O
|
M
, O|M|1, O|M, O|M, X,

140 
X
, X, X, 
O
|
M
, O|M|1, O|M, X, O|M,

142 
X
, X, X, 
O
|
M
, X, X, O|M, O|M,

143 
X
, X, 
O
|
M
|1, O|M, O|M, O|M, O|M, O|M,

145 
O
|
M
, O|M, 
X
, O|M, X, X, X, O|M,

146 
X
, X, X, X, X, X, X, X,

148 
X
, X, X, X, X, X, X, X,

149 
X
, X, X, X, X, X, X, X,

151 
X
, X, X, X, X, X, X, X,

152 
X
, X, X, X, X, X, X, X,

154 
X
, X, X, X, X, X, X, X,

155 
X
, X, X, X, X, X, X, X

167 
	$g‘_ba£lim™
(
u16
 
£g
, *
ba£
, *
lim™
)

169 
vıu
 *
cu¼
 = 
cu¼’t
;

170 
ušt32_t
 *
bË
, 
a
, 
b
;

171 
ldt
 = !!(
£g
 & 4);

172 
idx
 = (
£g
 >> 3) & 8191;

175 iàĞ
ldt
 )

177 
bË
 = (
ušt32_t
 *)
	`LDT_VIRT_START
(
cu¼
);

178 iàĞ
idx
 >ğ
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_’ts
 )

179 
ç
;

183 
bË
 = (
ušt32_t
 *)
	`GDT_VIRT_START
(
cu¼
);

184 iàĞ
idx
 >ğ
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_’ts
 )

185 
ç
;

189 iàĞ
	`__g‘_u£r
(
a
, &
bË
[2*
idx
+0]) ||

190 
	`__g‘_u£r
(
b
, &
bË
[2*
idx
+1]) )

191 
ç
;

194 iàĞ(
b
 & (
_SEGMENT_P
|
_SEGMENT_S
|
_SEGMENT_DB
)) !=

195 (
_SEGMENT_P
|
_SEGMENT_S
|
_SEGMENT_DB
) )

196 
ç
;

199 *
ba£
 = (
b
&(0xff<<24)è| ((b&0xff)<<16è| (
a
>>16);

200 *
lim™
 = ((
b
 & 0xf0000è| (
a
 & 0x0ffff)) + 1;

201 iàĞ(
b
 & 
_SEGMENT_G
) )

202 *
lim™
 <<= 12;

208 iàĞ(
GUEST_SEGMENT_MAX_ADDR
 - (*
ba£
 + *
lim™
)è< 
PAGE_SIZE
 )

209 *
lim™
 = 0;

213 
ç
:

215 
	}
}

218 
	$lš—ri£_add»ss
(
u16
 
£g
, 
off
, *
lš—r
)

220 
ba£
, 
lim™
;

222 iàĞ!
	`g‘_ba£lim™
(
£g
, &
ba£
, &
lim™
) )

225 iàĞ
off
 > (
lim™
-1) )

228 *
lš—r
 = 
ba£
 + 
off
;

231 
	}
}

233 
	$fixup_£g
(
u16
 
£g
, 
off£t
)

235 
vıu
 *
cu¼
 = 
cu¼’t
;

236 
ušt32_t
 *
bË
, 
a
, 
b
, 
ba£
, 
lim™
;

237 
ldt
 = !!(
£g
 & 4);

238 
idx
 = (
£g
 >> 3) & 8191;

241 iàĞ
ldt
 )

243 
bË
 = (
ušt32_t
 *)
	`LDT_VIRT_START
(
cu¼
);

244 iàĞ
idx
 >ğ
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_’ts
 )

246 
	`d´štk
(
XENLOG_DEBUG
, "Segment %04x out of LDT„ange (%ld)\n",

247 
£g
, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
ldt_’ts
);

248 
ç
;

253 
bË
 = (
ušt32_t
 *)
	`GDT_VIRT_START
(
cu¼
);

254 iàĞ
idx
 >ğ
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_’ts
 )

256 
	`d´štk
(
XENLOG_DEBUG
, "Segment %04x out of GDT„ange (%ld)\n",

257 
£g
, 
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
gdt_’ts
);

258 
ç
;

263 iàĞ
	`__g‘_u£r
(
a
, &
bË
[2*
idx
+0]) ||

264 
	`__g‘_u£r
(
b
, &
bË
[2*
idx
+1]) )

266 
	`d´štk
(
XENLOG_DEBUG
, "FauÉ wh»adšg segm’ˆ%04x\n", 
£g
);

267 
ç
;

271 iàĞ(
b
 & (
_SEGMENT_P
|
_SEGMENT_S
|
_SEGMENT_DB
|

272 
_SEGMENT_G
|
_SEGMENT_CODE
|
_SEGMENT_DPL
)) !=

273 (
_SEGMENT_P
|
_SEGMENT_S
|
_SEGMENT_DB
|
_SEGMENT_G
|
_SEGMENT_DPL
) )

275 
	`d´štk
(
XENLOG_DEBUG
, "Bad segm’ˆ%08x:%08x\n", 
a
, 
b
);

276 
ç
;

280 
ba£
 = (
b
&(0xff<<24)è| ((b&0xff)<<16è| (
a
>>16);

281 
lim™
 = (((
b
 & 0xf0000è| (
a
 & 0x0ffff)) + 1) << 12;

283 iàĞ
b
 & 
_SEGMENT_EC
 )

286 iàĞ((
ba£
 + 
lim™
è< 
PAGE_SIZE
è&& (
off£t
 <=†imit) )

289 
lim™
 = 
GUEST_SEGMENT_MAX_ADDR
 - 
ba£
;

290 
æ
;

296 iàĞ((
GUEST_SEGMENT_MAX_ADDR
 - (
ba£
 + 
lim™
)è< 
PAGE_SIZE
) &&

297 (
off£t
 > 
lim™
) )

300 
lim™
 = -(
ba£
 & 
PAGE_MASK
);

301 
æ
;

305 
	`d´štk
(
XENLOG_DEBUG
, "None ofhe‡bove! (%08x:%08x, %08x, %08x, %08x)\n",

306 
a
, 
b
, 
ba£
, 
lim™
, base+limit);

308 
ç
:

311 
æ
:

312 
lim™
 = (limit >> 12) - 1;

313 
a
 &ğ~0x0ffff;‡ |ğ
lim™
 & 0x0ffff;

314 
b
 &ğ~0xf0000; b |ğ
lim™
 & 0xf0000;

315 
b
 ^ğ
_SEGMENT_EC
;

317 
	`©omic_wr™e64
((
ušt64_t
 *)&
bË
[2*
idx
], ((ušt64_t)
b
<<32è| 
a
);

319 
	}
}

325 
	$gpf_emuÏ‹_4gb
(
ıu_u£r_»gs
 *
»gs
)

327 
vıu
 *
cu¼
 = 
cu¼’t
;

328 
u8
 
modrm
, 
mod
, 
rm
, 
decode
;

329 cÚ¡ 
u32
 *
ba£
, *
šdex
 = 
NULL
;

330 
off£t
;

331 
s8
 
di¥8
;

332 
s32
 
di¥32
 = 0;

333 
u8
 *
e
;

334 
u8
 *
pb
, 
b
;

335 
gs_ov”ride
 = 0, 
sÿË
 = 0, 
İcode
 = -1;

336 cÚ¡ 
u8
 *
bË
 = 
š¢_decode
;

339 iàĞ
	`uÆik–y
(
	`vm86_mode
(
»gs
)è|| uÆik–y(!
	`ršg_3
(regs)) )

340 
ç
;

342 iàĞ!
	`lš—ri£_add»ss
((
u16
)
»gs
->
cs
,„egs->
e
, (*)&eip) )

344 
	`d´štk
(
XENLOG_DEBUG
, "Cannot†inearise %04x:%08x\n",

345 
»gs
->
cs
,„egs->
e
);

346 
ç
;

350  
pb
 = 
e
; ;…b++ )

352 iàĞ
	`g‘_u£r
(
b
, 
pb
) )

354 
	`d´štk
(
XENLOG_DEBUG
,

356 ()(
pb
-
e
));

357 
·ge_çuÉ
;

360 iàĞ(
pb
 - 
e
) >= 15 )

362 
	`d´štk
(
XENLOG_DEBUG
, "Too many instruction…refixes for‡ "

364 
ç
;

367 iàĞ
İcode
 != -1 )

369 
İcode
 = (İcod<< 8è| 
b
;

373  
b
 )

381 
	`d´štk
(
XENLOG_DEBUG
, "UnhªdËd…»fix %02x\n", 
b
);

382 
ç
;

389 
gs_ov”ride
 = 1;

392 
bË
 = 
twoby‹_decode
;

393 
İcode
 = 
b
;

404 
bË
 = 
æßt_decode
;

405 iàĞ
	`g‘_u£r
(
modrm
, 
pb
 + 1) )

407 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting modrm byte\n");

408 
·ge_çuÉ
;

411 
İcode
 = (
b
 << 8è| 
modrm
;

412 
b
 = ((b & 7è<< 3è+ ((
modrm
 >> 3) & 7);

413 
dÚe_´efix
;

416 
dÚe_´efix
;

419 
dÚe_´efix
:

421 iàĞ!
gs_ov”ride
 )

423 
	`d´štk
(
XENLOG_DEBUG
, "Only instructions with GS override\n");

424 
ç
;

427 
decode
 = 
bË
[
b
];

428 
pb
++;

430 iàĞ!(
decode
 & 
OPCODE_BYTE
) )

432 ià(
İcode
 == -1)

433 
	`d´štk
(
XENLOG_DEBUG
, "UnsuµÜ‹d opcod%02x\n", 
b
);

435 
	`d´štk
(
XENLOG_DEBUG
, "Unsupported opcode %02x %02x\n",

436 
İcode
 >> 8, opcode & 255);

437 
ç
;

440 iàĞ!(
decode
 & 
HAS_MODRM
) )

443 iàĞ(
decode
 & 
INSN_SUFFIX_BYTES
) != 4 )

444 
ç
;

446 iàĞ
	`g‘_u£r
(
off£t
, (
u32
 *)
pb
) )

448 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting <moffs32>.\n");

449 
·ge_çuÉ
;

451 
pb
 += 4;

453 
sk_modrm
;

460 iàĞ
	`g‘_u£r
(
modrm
, 
pb
) )

462 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting modrm byte\n");

463 
·ge_çuÉ
;

466 
pb
++;

468 
mod
 = (
modrm
 >> 6) & 3;

469 
rm
 = (
modrm
 >> 0) & 7;

471 iàĞ
rm
 == 4 )

473 
u8
 
sib
;

475 iàĞ
	`g‘_u£r
(
sib
, 
pb
) )

477 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting sib byte\n");

478 
·ge_çuÉ
;

481 
pb
++;

483 
rm
 = 
sib
 & 7;

484 iàĞ(
sib
 & 0x38) != 0x20 )

485 
šdex
 = 
	`decode_»gi¡”
((
sib
 >> 3è& 7, 
»gs
, 0);

486 
sÿË
 = 
sib
 >> 6;

490 
ba£
 = 
	`decode_»gi¡”
(
rm
, 
»gs
, 0);

493  
mod
 )

496 iàĞ
rm
 == 5 )

498 
ba£
 = 
NULL
;

499 iàĞ
	`g‘_u£r
(
di¥32
, (
u32
 *)
pb
) )

501 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting <base32>.\n");

502 
·ge_çuÉ
;

504 
pb
 += 4;

509 iàĞ
	`g‘_u£r
(
di¥8
, 
pb
) )

511 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting <disp8>.\n");

512 
·ge_çuÉ
;

514 
pb
++;

515 
di¥32
 = 
di¥8
;

519 iàĞ
	`g‘_u£r
(
di¥32
, (
u32
 *)
pb
) )

521 
	`d´štk
(
XENLOG_DEBUG
, "Fault whileƒxtracting <disp32>.\n");

522 
·ge_çuÉ
;

524 
pb
 += 4;

528 
	`d´štk
(
XENLOG_DEBUG
, "Not‡ memory operand!\n");

529 
ç
;

532 
off£t
 = 
di¥32
;

533 iàĞ
ba£
 !ğ
NULL
 )

534 
off£t
 +ğ*
ba£
;

535 iàĞ
šdex
 !ğ
NULL
 )

536 
off£t
 +ğ*
šdex
 << 
sÿË
;

538 
sk_modrm
:

539 iàĞ!
	`fixup_£g
((
u16
)
»gs
->
gs
, 
off£t
) )

540 
ç
;

543 
	`³rfc_šü
(
£g_fixups
);

546 iàĞ
	`VM_ASSIST
(
cu¼
->
domaš
, 
VMASST_TYPE_4gb_£gm’ts_nÙify
) )

548 
Œ­_šfo
 *
ti
 = &
cu¼
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[15];

549 
Œ­_bounû
 *
tb
 = &
cu¼
->
¬ch
.trap_bounce;

551 
tb
->
æags
 = 
TBF_EXCEPTION
 | 
TBF_EXCEPTION_ERRCODE
;

552 
tb
->
”rÜ_code
 = 
pb
 - 
e
;

553 
tb
->
cs
 = 
ti
->cs;

554 
tb
->
e
 = 
ti
->
add»ss
;

555 iàĞ
	`TI_GET_IF
(
ti
) )

556 
tb
->
æags
 |ğ
TBF_INTERRUPT
;

559  
EXCRET_çuÉ_fixed
;

561 
ç
:

564 
·ge_çuÉ
:

565 
	`´İag©e_·ge_çuÉ
(()
pb
, 0);

566  
EXCRET_çuÉ_fixed
;

567 
	}
}

	@x86_32/traps.c

2 
	~<x’/cÚfig.h
>

3 
	~<x’/v”siÚ.h
>

4 
	~<x’/domaš_·ge.h
>

5 
	~<x’/š™.h
>

6 
	~<x’/sched.h
>

7 
	~<x’/lib.h
>

8 
	~<x’/cÚsŞe.h
>

9 
	~<x’/mm.h
>

10 
	~<x’/œq.h
>

11 
	~<x’/symbŞs.h
>

12 
	~<x’/shutdown.h
>

13 
	~<x’/nmi.h
>

14 
	~<x’/ıu.h
>

15 
	~<asm/cu¼’t.h
>

16 
	~<asm/æushb.h
>

17 
	~<asm/Œ­s.h
>

18 
	~<asm/hvm/hvm.h
>

19 
	~<asm/hvm/suµÜt.h
>

21 
	~<public/ÿÎback.h
>

22 
	~<mši.h
>

24 
asmlškage
 
hy³rÿÎ
();

26 
	$´št_x’_šfo
()

28 
št_¡r
[
TAINT_STRING_MAX_LEN
];

29 
debug
 = 'n', *
¬ch
 = "x86_32p";

31 #iâdeà
NDEBUG


32 
debug
 = 'y';

35 
	`´štk
("----[ Xen-%d.%d%s %s debug=%c %s ]----\n",

36 
	`x’_majÜ_v”siÚ
(), 
	`x’_mšÜ_v”siÚ
(), 
	`x’_exŒa_v”siÚ
(),

37 
¬ch
, 
debug
, 
	`´št_š‹d
(
št_¡r
));

38 
	}
}

40 
	ecÚ‹xt
 { 
	mCTXT_hy³rvisÜ
, 
	mCTXT_pv_gue¡
, 
	mCTXT_hvm_gue¡
 };

42 
	$_show_»gi¡”s
(

43 cÚ¡ 
ıu_u£r_»gs
 *
»gs
, 
üs
[8],

44 
cÚ‹xt
 cÚ‹xt, cÚ¡ 
vıu
 *
v
)

46 cÚ¡ *
cÚ‹xt_Çmes
[] = {

47 [
CTXT_hy³rvisÜ
] = "hypervisor",

48 [
CTXT_pv_gue¡
] = "pv guest",

49 [
CTXT_hvm_gue¡
] = "hvm guest"

52 
	`´štk
("EIP: %04x:[<%08x>]", 
»gs
->
cs
,„egs->
e
);

53 iàĞ
cÚ‹xt
 =ğ
CTXT_hy³rvisÜ
 )

54 
	`´št_symbŞ
(" %s", 
»gs
->
e
);

55 
	`´štk
("\nEFLAGS: %08x ", 
»gs
->
eæags
);

56 iàĞ(
cÚ‹xt
 =ğ
CTXT_pv_gue¡
è&& 
v
 && v->
vıu_šfo
 )

57 
	`´štk
("EM: %d ", !!
v
->
vıu_šfo
->
evtchn_upÿÎ_mask
);

58 
	`´štk
("CONTEXT: %s\n", 
cÚ‹xt_Çmes
[
cÚ‹xt
]);

60 
	`´štk
("eax: %08xƒbx: %08xƒcx: %08xƒdx: %08x\n",

61 
»gs
->
—x
,„egs->
ebx
,„egs->
ecx
,„egs->
edx
);

62 
	`´štk
("esi: %08xƒdi: %08xƒbp: %08xƒsp: %08x\n",

63 
»gs
->
esi
,„egs->
edi
,„egs->
ebp
,„egs->
e¥
);

64 
	`´štk
("cr0: %08lx cr4: %08lx cr3: %08lx cr2: %08lx\n",

65 
üs
[0], crs[4], crs[3], crs[2]);

66 
	`´štk
("ds: %04xƒs: %04x fs: %04x gs: %04x "

68 
»gs
->
ds
,„egs->
es
,„egs->
fs
,

69 
»gs
->
gs
,„egs->
ss
,„egs->
cs
);

70 
	}
}

72 
	$show_»gi¡”s
(
ıu_u£r_»gs
 *
»gs
)

74 
ıu_u£r_»gs
 
çuÉ_»gs
 = *
»gs
;

75 
çuÉ_üs
[8];

76 
cÚ‹xt
 context;

77 
vıu
 *
v
 = 
cu¼’t
;

79 iàĞ
	`is_hvm_vıu
(
v
è&& 
	`gue¡_mode
(
»gs
) )

81 
£gm’t_»gi¡”
 
¤eg
;

82 
cÚ‹xt
 = 
CTXT_hvm_gue¡
;

83 
çuÉ_üs
[0] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

84 
çuÉ_üs
[2] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2];

85 
çuÉ_üs
[3] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

86 
çuÉ_üs
[4] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

87 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
¤eg
);

88 
çuÉ_»gs
.
cs
 = 
¤eg
.
£l
;

89 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
¤eg
);

90 
çuÉ_»gs
.
ds
 = 
¤eg
.
£l
;

91 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
¤eg
);

92 
çuÉ_»gs
.
es
 = 
¤eg
.
£l
;

93 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
¤eg
);

94 
çuÉ_»gs
.
fs
 = 
¤eg
.
£l
;

95 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
¤eg
);

96 
çuÉ_»gs
.
gs
 = 
¤eg
.
£l
;

97 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
¤eg
);

98 
çuÉ_»gs
.
ss
 = 
¤eg
.
£l
;

102 iàĞ!
	`gue¡_mode
(
»gs
) )

104 
cÚ‹xt
 = 
CTXT_hy³rvisÜ
;

105 
çuÉ_»gs
.
e¥
 = ()&
»gs
->esp;

106 
çuÉ_»gs
.
ss
 = 
	`»ad_£gm’t_»gi¡”
(ss);

107 
çuÉ_»gs
.
ds
 = 
	`»ad_£gm’t_»gi¡”
(ds);

108 
çuÉ_»gs
.
es
 = 
	`»ad_£gm’t_»gi¡”
(es);

109 
çuÉ_»gs
.
fs
 = 
	`»ad_£gm’t_»gi¡”
(fs);

110 
çuÉ_»gs
.
gs
 = 
	`»ad_£gm’t_»gi¡”
(gs);

111 
çuÉ_üs
[2] = 
	`»ad_ü2
();

115 
cÚ‹xt
 = 
CTXT_pv_gue¡
;

116 
çuÉ_üs
[2] = 
v
->
vıu_šfo
->
¬ch
.
ü2
;

119 
çuÉ_üs
[0] = 
	`»ad_ü0
();

120 
çuÉ_üs
[3] = 
	`»ad_ü3
();

121 
çuÉ_üs
[4] = 
	`»ad_ü4
();

124 
	`´št_x’_šfo
();

125 
	`´štk
("CPU: %d\n", 
	`smp_´oûssÜ_id
());

126 
	`_show_»gi¡”s
(&
çuÉ_»gs
, 
çuÉ_üs
, 
cÚ‹xt
, 
v
);

128 iàĞ
	`this_ıu
(
Ër_m¤
è&& !
	`gue¡_mode
(
»gs
) )

130 
u32
 
äom
, 
to
, 
hi
;

131 
	`rdm¤
(
	`this_ıu
(
Ër_m¤
), 
äom
, 
hi
);

132 
	`rdm¤
(
	`this_ıu
(
Ër_m¤
è+ 1, 
to
, 
hi
);

133 
	`´štk
("Ër: %08x -> %08x\n", 
äom
, 
to
);

135 
	}
}

137 
	$vıu_show_»gi¡”s
(cÚ¡ 
vıu
 *
v
)

139 
üs
[8];

142 iàĞ
	`is_hvm_vıu
(
v
) )

145 
üs
[0] = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0];

146 
üs
[2] = 
v
->
vıu_šfo
->
¬ch
.
ü2
;

147 
üs
[3] = 
	`·g‘abË_g‘_·ddr
(
v
->
¬ch
.
gue¡_bË
);

148 
üs
[4] = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4];

150 
	`_show_»gi¡”s
(&
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
, 
üs
, 
CTXT_pv_gue¡
, v);

151 
	}
}

153 
	$show_·ge_w®k
(
addr
)

155 
pâ
, 
mâ
, 
ü3
 = 
	`»ad_ü3
();

156 
l3_pg’Œy_t
 
l3e
, *
l3t
;

157 
l2_pg’Œy_t
 
l2e
, *
l2t
;

158 
l1_pg’Œy_t
 
l1e
, *
l1t
;

160 
	`´štk
("Pag‘abË w®k from %08lx:\n", 
addr
);

162 
mâ
 = 
ü3
 >> 
PAGE_SHIFT
;

164 
l3t
 = 
	`m­_domaš_·ge
(
mâ
);

165 
l3t
 +ğ(
ü3
 & 0xFE0UL) >> 3;

166 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
addr
)];

167 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

168 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

169 
	`´štk
(" L3[0x%03lx] = %"
PRI±e
" %08lx\n",

170 
	`l3_bË_off£t
(
addr
), 
	`l3e_g‘_š‹
(
l3e
), 
pâ
);

171 
	`unm­_domaš_·ge
(
l3t
);

172 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) ||

173 !
	`mâ_v®id
(
mâ
) )

176 
l2t
 = 
	`m­_domaš_·ge
(
mâ
);

177 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
addr
)];

178 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

179 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

180 
	`´štk
(" L2[0x%03lx] = %"
PRI±e
" %08lx %s\n",

181 
	`l2_bË_off£t
(
addr
), 
	`l2e_g‘_š‹
(
l2e
), 
pâ
,

182 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) ? "(PSE)" : "");

183 
	`unm­_domaš_·ge
(
l2t
);

184 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) ||

185 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) ||

186 !
	`mâ_v®id
(
mâ
) )

189 
l1t
 = 
	`m­_domaš_·ge
(
mâ
);

190 
l1e
 = 
l1t
[
	`l1_bË_off£t
(
addr
)];

191 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

192 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

193 
	`´štk
(" L1[0x%03lx] = %"
PRI±e
" %08lx\n",

194 
	`l1_bË_off£t
(
addr
), 
	`l1e_g‘_š‹
(
l1e
), 
pâ
);

195 
	`unm­_domaš_·ge
(
l1t
);

196 
	}
}

198 
DEFINE_PER_CPU_READ_MOSTLY
(
tss_¡ruù
 *, 
doubËçuÉ_tss
);

199 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

200 
	gboÙ_ıu_doubËçuÉ_¥aû
[
PAGE_SIZE
];

202 
	$ıu_doubËçuÉ_tss_ÿÎback
(

203 
nÙif›r_block
 *
nfb
, 
aùiÚ
, *
hıu
)

205 
ıu
 = ()
hıu
;

206 *
p
;

207 
rc
 = 0;

209  
aùiÚ
 )

211 
CPU_UP_PREPARE
:

212 
	`³r_ıu
(
doubËçuÉ_tss
, 
ıu
èğ
p
 = 
	`®loc_x’h—p_·ge
();

213 iàĞ
p
 =ğ
NULL
 )

214 
rc
 = -
ENOMEM
;

216 
	`mem£t
(
p
, 0, 
PAGE_SIZE
);

218 
CPU_UP_CANCELED
:

219 
CPU_DEAD
:

220 
	`ä“_x’h—p_·ge
(
	`³r_ıu
(
doubËçuÉ_tss
, 
ıu
));

226  !
rc
 ? 
NOTIFY_DONE
 : 
	`nÙif›r_äom_”ºo
(rc);

227 
	}
}

229 
nÙif›r_block
 
	gıu_doubËçuÉ_tss_nfb
 = {

230 .
nÙif›r_ÿÎ
 = 
ıu_doubËçuÉ_tss_ÿÎback


233 
asmlškage
 
	$do_doubË_çuÉ
()

235 
tss_¡ruù
 *
tss
;

236 
ıu
;

238 
	`w©chdog_di§bË
();

240 
	`cÚsŞe_fÜû_uÆock
();

242 
	`asm
 ( "l¦È%1, %0" : "ô" (
ıu
è: "rm" (
PER_CPU_GDT_ENTRY
 << 3) );

245 
tss
 = &
	`³r_ıu
(
š™_tss
, 
ıu
);

246 
	`´štk
("*** DOUBLE FAULT ***\n");

247 
	`´št_x’_šfo
();

248 
	`´štk
("CPU: %d\nEIP: %04x:[<%08x>]",

249 
ıu
, 
tss
->
cs
,ss->
e
);

250 
	`´št_symbŞ
(" %s\n", 
tss
->
e
);

251 
	`´štk
("EFLAGS: %08x\n", 
tss
->
eæags
);

252 
	`´štk
("CR3: %08x\n", 
tss
->
__ü3
);

253 
	`´štk
("eax: %08xƒbx: %08xƒcx: %08xƒdx: %08x\n",

254 
tss
->
—x
,ss->
ebx
,ss->
ecx
,ss->
edx
);

255 
	`´štk
("esi: %08xƒdi: %08xƒbp: %08xƒsp: %08x\n",

256 
tss
->
esi
,ss->
edi
,ss->
ebp
,ss->
e¥
);

257 
	`´štk
("ds: %04xƒs: %04x fs: %04x gs: %04x ss: %04x\n",

258 
tss
->
ds
,ss->
es
,ss->
fs
,ss->
gs
,ss->
ss
);

259 
	`show_¡ack_ov”æow
(
ıu
, 
tss
->
e¥
);

261 
	`·nic
("DOUBLE FAULT -- system shutdown\n");

262 
	}
}

264 
	$do_œ‘
()

266 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

267 
vıu
 *
v
 = 
cu¼’t
;

268 
u32
 
eæags
;

270 
	`my´štk
("MIN: I'm in do_iret()! ");

273 iàĞ
	`uÆik–y
(!
	`acûss_ok
(
»gs
->
e¥
, 40)) )

274 
ex™_ªd_üash
;

277 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
»gs
->
—x
, (*ìegs->
e¥
, 4)) )

278 
ex™_ªd_üash
;

279 
»gs
->
e¥
 += 4;

282 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
»gs
->
e
, (*ìegs->
e¥
, 8)) )

283 
ex™_ªd_üash
;

284 
»gs
->
e¥
 += 8;

290 iàĞ
	`uÆik–y
(
	`__cİy_äom_u£r
(&
eæags
, (*)
»gs
->
e¥
, 4)) )

291 
ex™_ªd_üash
;

292 
»gs
->
e¥
 += 4;

293 
»gs
->
eæags
 = (eæag & ~
X86_EFLAGS_IOPL
è| 
X86_EFLAGS_IF
;

295 iàĞ
	`vm86_mode
(
»gs
) )

298 iàĞ
	`__cİy_äom_u£r
(&
»gs
->
e¥
, (*)regs->esp, 24) )

299 
ex™_ªd_üash
;

301 iàĞ
	`uÆik–y
(
	`ršg_0
(
»gs
)) )

303 
ex™_ªd_üash
;

305 iàĞ!
	`ršg_1
(
»gs
) )

309 iàĞ
	`__cİy_äom_u£r
(&
»gs
->
e¥
, (*)regs->esp, 8) )

310 
ex™_ªd_üash
;

312 
	`my´štk
("MIN: i»ˆtØršg%d ", (
»gs
->
cs
 & 3));

315 
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_mask
èğ!(
eæags
 & 
X86_EFLAGS_IF
);

317 
	`async_exû±iÚ_ş—nup
(
v
);

323  
»gs
->
—x
;

325 
ex™_ªd_üash
:

326 
	`gd´štk
(
XENLOG_ERR
, "Fatalƒrror\n");

327 
	`domaš_üash
(
v
->
domaš
);

329 
	}
}

331 
	$£t_sk_g©e
(
n
, 
£l
)

333 
idt_bË
[
n
].
b
 = 0;

334 
	`wmb
();

335 
idt_bË
[
n
].
a
 = 
£l
 << 16;

336 
	`wmb
();

337 
idt_bË
[
n
].
b
 = 0x8500;

338 
	}
}

340 
__devš™
 
	$sub¬ch_³rıu_Œ­s_š™
()

342 
tss_¡ruù
 *
tss
;

343 
ıu
 = 
	`smp_´oûssÜ_id
();

345 iàĞ
ıu
 == 0 )

348 
	`_£t_g©e
(
idt_bË
+
HYPERCALL_VECTOR
, 14, 1, &
hy³rÿÎ
);

349 #ifdeà
ENABLE_USER_HYPERCALL


350 
asmlškage
 
	`u£r_hy³rÿÎ
();

351 
	`_£t_g©e
(
idt_bË
+0x84, 14, 3, &
u£r_hy³rÿÎ
);

354 
	`this_ıu
(
doubËçuÉ_tss
èğ(*)
boÙ_ıu_doubËçuÉ_¥aû
;

356 
	`»gi¡”_ıu_nÙif›r
(&
ıu_doubËçuÉ_tss_nfb
);

359 
tss
 = 
	`this_ıu
(
doubËçuÉ_tss
);

360 
	`BUG_ON
(
tss
 =ğ
NULL
);

366 
tss
->
ds
 = 
__HYPERVISOR_DS
;

367 
tss
->
es
 = 
__HYPERVISOR_DS
;

368 
tss
->
ss
 = 
__HYPERVISOR_DS
;

369 
tss
->
e¥
 = (és + 
PAGE_SIZE
;

370 
tss
->
__ü3
 = 
	`__·
(
idË_pg_bË
);

371 
tss
->
cs
 = 
__HYPERVISOR_CS
;

372 
tss
->
e
 = ()
do_doubË_çuÉ
;

373 
tss
->
eæags
 = 2;

374 
tss
->
b™m­
 = 
IOBMP_INVALID_OFFSET
;

375 
	`_£t_ts¦dt_desc
(

376 
	`this_ıu
(
gdt_bË
è+ 
DOUBLEFAULT_TSS_ENTRY
 - 
FIRST_RESERVED_GDT_ENTRY
,

377 ()
tss
, 235, 9);

379 
	`£t_sk_g©e
(
TRAP_doubË_çuÉ
, 
DOUBLEFAULT_TSS_ENTRY
 << 3);

380 
	}
}

382 
	$š™_št80_dœeù_Œ­
(
vıu
 *
v
)

384 
Œ­_šfo
 *
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[0x80];

396 iàĞ
	`TI_GET_IF
(
ti
è|| !
	`gue¡_g©e_£ËùÜ_okay
(
v
->
domaš
,i->
cs
) ||

397 
su³rvisÜ_mode_k”Ãl
 )

399 
v
->
¬ch
.
št80_desc
.
a
 = v->¬ch.št80_desc.
b
 = 0;

403 
v
->
¬ch
.
št80_desc
.
a
 = (
ti
->
cs
 << 16è| (ti->
add»ss
 & 0xffff);

404 
v
->
¬ch
.
št80_desc
.
b
 =

405 (
ti
->
add»ss
 & 0xffff0000è| 0x8f00 | ((
	`TI_GET_DPL
(ti) & 3) << 13);

407 iàĞ
v
 =ğ
cu¼’t
 )

408 
	`£t_št80_dœeù_Œ­
(
v
);

409 
	}
}

411 #ifdeà
CONFIG_X86_SUPERVISOR_MODE_KERNEL


412 
	$do_upd©e_sy£Á”
(*
šfo
)

414 
x’_ÿÎback_t
 *
add»ss
 = 
šfo
;

416 
	`wrm¤
(
MSR_IA32_SYSENTER_CS
, 
add»ss
->
cs
, 0);

417 
	`wrm¤
(
MSR_IA32_SYSENTER_EIP
, 
add»ss
->
e
, 0);

418 
	}
}

421 
	$»gi¡”_gue¡_ÿÎback
(
ÿÎback_»gi¡”
 *
»g
)

423 
»t
 = 0;

424 
vıu
 *
v
 = 
cu¼’t
;

426 
	`fixup_gue¡_code_£ËùÜ
(
v
->
domaš
, 
»g
->
add»ss
.
cs
);

428  
»g
->
ty³
 )

430 
CALLBACKTYPE_ev’t
:

431 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

432 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

435 
CALLBACKTYPE_ç§ã
:

436 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

437 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

438 iàĞ
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
 )

439 
	`£t_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

440 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

442 
	`ş—r_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

443 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

446 #ifdeà
CONFIG_X86_SUPERVISOR_MODE_KERNEL


447 
CALLBACKTYPE_sy£Á”_d•»ÿ‹d
:

448 iàĞ!
ıu_has_£p
 )

449 
»t
 = -
EINVAL
;

451 
	`Ú_—ch_ıu
(
do_upd©e_sy£Á”
, &
»g
->
add»ss
, 1);

454 
CALLBACKTYPE_sy£Á”
:

455 iàĞ!
ıu_has_£p
 )

456 
»t
 = -
EINVAL
;

458 
	`do_upd©e_sy£Á”
(&
»g
->
add»ss
);

462 
CALLBACKTYPE_nmi
:

463 
»t
 = 
	`»gi¡”_gue¡_nmi_ÿÎback
(
»g
->
add»ss
.
e
);

467 
»t
 = -
ENOSYS
;

471  
»t
;

472 
	}
}

474 
	$uÄegi¡”_gue¡_ÿÎback
(
ÿÎback_uÄegi¡”
 *
uÄeg
)

476 
»t
;

478  
uÄeg
->
ty³
 )

480 
CALLBACKTYPE_ev’t
:

481 
CALLBACKTYPE_ç§ã
:

482 #ifdeà
CONFIG_X86_SUPERVISOR_MODE_KERNEL


483 
CALLBACKTYPE_sy£Á”_d•»ÿ‹d
:

484 
CALLBACKTYPE_sy£Á”
:

486 
»t
 = -
EINVAL
;

489 
CALLBACKTYPE_nmi
:

490 
»t
 = 
	`uÄegi¡”_gue¡_nmi_ÿÎback
();

494 
»t
 = -
ENOSYS
;

498  
»t
;

499 
	}
}

502 
do_ÿÎback_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(
cÚ¡_void
è
¬g
)

504 
»t
;

506  
cmd
 )

508 
CALLBACKOP_»gi¡”
:

510 
ÿÎback_»gi¡”
 
»g
;

512 
»t
 = -
EFAULT
;

513 iàĞ
	`cİy_äom_gue¡
(&
»g
, 
¬g
, 1) )

516 
»t
 = 
	`»gi¡”_gue¡_ÿÎback
(&
»g
);

520 
CALLBACKOP_uÄegi¡”
:

522 
ÿÎback_uÄegi¡”
 
uÄeg
;

524 
»t
 = -
EFAULT
;

525 iàĞ
	`cİy_äom_gue¡
(&
uÄeg
, 
¬g
, 1) )

528 
»t
 = 
	`uÄegi¡”_gue¡_ÿÎback
(&
uÄeg
);

533 
»t
 = -
ENOSYS
;

537  
»t
;

538 
	}
}

540 
	$do_£t_ÿÎbacks
(
ev’t_£ËùÜ
,

541 
ev’t_add»ss
,

542 
ç§ã_£ËùÜ
,

543 
ç§ã_add»ss
)

545 
ÿÎback_»gi¡”
 
ev’t
 = {

546 .
ty³
 = 
CALLBACKTYPE_ev’t
,

547 .
add»ss
 = { 
ev’t_£ËùÜ
, 
ev’t_add»ss
 },

549 
ÿÎback_»gi¡”
 
ç§ã
 = {

550 .
ty³
 = 
CALLBACKTYPE_ç§ã
,

551 .
add»ss
 = { 
ç§ã_£ËùÜ
, 
ç§ã_add»ss
 },

554 
	`»gi¡”_gue¡_ÿÎback
(&
ev’t
);

555 
	`»gi¡”_gue¡_ÿÎback
(&
ç§ã
);

558 
	}
}

560 
	$hy³rÿÎ_·ge_š™Ÿli£_ršg0_k”Ãl
(*
hy³rÿÎ_·ge
)

562 *
p
;

563 
i
;

567  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

569 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

571 *(
u8
 *)(
p
+ 0) = 0x9c;

572 *(
u8
 *)(
p
+ 1) = 0xfa;

573 *(
u8
 *)(
p
+ 2) = 0xb8;

574 *(
u32
 *)(
p
+ 3èğ
i
;

575 *(
u8
 *)(
p
+ 7) = 0x9a;

576 *(
u32
 *)(
p
+ 8èğ(u32)&
hy³rÿÎ
;

577 *(
u16
 *)(
p
+12èğ(u16)
__HYPERVISOR_CS
;

578 *(
u8
 *)(
p
+14) = 0xc3;

586 
p
 = (*)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32));

587 *(
u8
 *)(
p
+ 0) = 0x50;

588 *(
u8
 *)(
p
+ 1) = 0x9c;

589 *(
u8
 *)(
p
+ 2) = 0xfa;

590 *(
u8
 *)(
p
+ 3) = 0xb8;

591 *(
u32
 *)(
p
+ 4èğ
__HYPERVISOR_œ‘
;

592 *(
u8
 *)(
p
+ 8) = 0x9a;

593 *(
u32
 *)(
p
+ 9èğ(u32)&
hy³rÿÎ
;

594 *(
u16
 *)(
p
+13èğ(u16)
__HYPERVISOR_CS
;

595 
	}
}

597 
	$hy³rÿÎ_·ge_š™Ÿli£_ršg1_k”Ãl
(*
hy³rÿÎ_·ge
)

599 *
p
;

600 
i
;

604  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

606 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

607 *(
u8
 *)(
p
+ 0) = 0xb8;

608 *(
u32
 *)(
p
+ 1èğ
i
;

609 *(
u16
 *)(
p
+ 5) = 0x82cd;

610 *(
u8
 *)(
p
+ 7) = 0xc3;

618 
p
 = (*)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32));

619 *(
u8
 *)(
p
+ 0) = 0x50;

620 *(
u8
 *)(
p
+ 1) = 0xb8;

621 *(
u32
 *)(
p
+ 2èğ
__HYPERVISOR_œ‘
;

622 *(
u16
 *)(
p
+ 6) = 0x82cd;

623 
	}
}

625 
	$hy³rÿÎ_·ge_š™Ÿli£
(
domaš
 *
d
, *
hy³rÿÎ_·ge
)

627 
	`mem£t
(
hy³rÿÎ_·ge
, 0xCC, 
PAGE_SIZE
);

628 iàĞ
	`is_hvm_domaš
(
d
) )

629 
	`hvm_hy³rÿÎ_·ge_š™Ÿli£
(
d
, 
hy³rÿÎ_·ge
);

630 iàĞ
su³rvisÜ_mode_k”Ãl
 )

631 
	`hy³rÿÎ_·ge_š™Ÿli£_ršg0_k”Ãl
(
hy³rÿÎ_·ge
);

633 
	`hy³rÿÎ_·ge_š™Ÿli£_ršg1_k”Ãl
(
hy³rÿÎ_·ge
);

634 
	}
}

	@x86_64/acpi_mmcfg.c

28 
	~<x’/cÚfig.h
>

29 
	~<x’/”ºo.h
>

30 
	~<x’/š™.h
>

31 
	~<x’/aıi.h
>

32 
	~<x’/œq.h
>

33 
	~<x’/dmi.h
>

34 
	~<asm/fixm­.h
>

35 
	~<asm/·ge.h
>

36 
	~<asm/­ic.h
>

37 
	~<asm/io_­ic.h
>

38 
	~<asm/­ic.h
>

39 
	~<asm/io.h
>

40 
	~<asm/mp¥ec.h
>

41 
	~<asm/´oûssÜ.h
>

42 
	~<mach_­ic.h
>

43 
	~<mach_mµ¬£.h
>

45 
	~"mmcÚfig.h
"

48 
aıi_mcfg_®loÿtiÚ
 *
	gpci_mmcfg_cÚfig
;

49 
	gpci_mmcfg_cÚfig_num
;

51 
__š™
 
	$aıi_·r£_mcfg
(
aıi_bË_h—d”
 *
h—d”
)

53 
aıi_bË_mcfg
 *
mcfg
;

54 
i
;

56 ià(!
h—d”
)

57  -
EINVAL
;

59 
mcfg
 = (
aıi_bË_mcfg
 *)
h—d”
;

62 
pci_mmcfg_cÚfig_num
 = 0;

63 
i
 = 
h—d”
->
Ëngth
 - (
aıi_bË_mcfg
);

64 
i
 >ğ(
aıi_mcfg_®loÿtiÚ
)) {

65 ++
pci_mmcfg_cÚfig_num
;

66 
i
 -ğ(
aıi_mcfg_®loÿtiÚ
);

68 ià(
pci_mmcfg_cÚfig_num
 == 0) {

69 
	`´štk
(
KERN_ERR
 
PREFIX
 "MMCONFIG has‚oƒntries\n");

70  -
ENODEV
;

73 
pci_mmcfg_cÚfig
 = 
	`xm®loc_¬¿y
(
aıi_mcfg_®loÿtiÚ
,

74 
pci_mmcfg_cÚfig_num
);

75 ià(!
pci_mmcfg_cÚfig
) {

76 
	`´štk
(
KERN_WARNING
 
PREFIX


78  -
ENOMEM
;

81 
	`memıy
(
pci_mmcfg_cÚfig
, &
mcfg
[1],

82 
pci_mmcfg_cÚfig_num
 * (*
pci_mmcfg_cÚfig
));

84 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

85 ià(
pci_mmcfg_cÚfig
[
i
].
add»ss
 > 0xFFFFFFFF) {

86 
	`´štk
(
KERN_ERR
 
PREFIX


88 
	`xä“
(
pci_mmcfg_cÚfig
);

89 
pci_mmcfg_cÚfig_num
 = 0;

90  -
ENODEV
;

95 
	}
}

	@x86_64/asm-offsets.c

6 
	#COMPILE_OFFSETS


	)

8 
	~<x’/cÚfig.h
>

9 
	~<x’/³rfc.h
>

10 
	~<x’/sched.h
>

11 
	~<com·t/x’.h
>

12 
	~<asm/fixm­.h
>

13 
	~<asm/h¬dœq.h
>

14 
	~<x’/muÉiboÙ.h
>

16 
	#DEFINE
(
_sym
, 
_v®
) \

17 
__asm__
 
	`__vŞ©e__
 ( "\n->" #_sym " %0 " #_v® : : "i" (
_v®
è)

	)

18 
	#BLANK
() \

19 
__asm__
 
	`__vŞ©e__
 ( "\n->" : : )

	)

20 
	#OFFSET
(
_sym
, 
_¡r
, 
_mem
) \

21 
	`DEFINE
(
_sym
, 
	`off£tof
(
_¡r
, 
_mem
));

	)

24 
	#__L2
(
_x
è(((_xè& 0x00000002è? 1 : 0)

	)

25 
	#__L4
(
_x
è(((_xè& 0x0000000cè? ( 2 + 
	`__L2
Ğ(_x)>> 2)è: __L2Ğ_x))

	)

26 
	#__L8
(
_x
è(((_xè& 0x000000f0è? ( 4 + 
	`__L4
Ğ(_x)>> 4)è: __L4Ğ_x))

	)

27 
	#__L16
(
_x
è(((_xè& 0x0000ff00è? ( 8 + 
	`__L8
Ğ(_x)>> 8)è: __L8Ğ_x))

	)

28 
	#LOG_2
(
_x
è(((_xè& 0xffff0000è? (16 + 
	`__L16
((_x)>>16)è: __L16(_x))

	)

30 
	$__dummy__
()

32 
	`OFFSET
(
UREGS_r15
, 
ıu_u£r_»gs
, 
r15
);

33 
	`OFFSET
(
UREGS_r14
, 
ıu_u£r_»gs
, 
r14
);

34 
	`OFFSET
(
UREGS_r13
, 
ıu_u£r_»gs
, 
r13
);

35 
	`OFFSET
(
UREGS_r12
, 
ıu_u£r_»gs
, 
r12
);

36 
	`OFFSET
(
UREGS_rbp
, 
ıu_u£r_»gs
, 
rbp
);

37 
	`OFFSET
(
UREGS_rbx
, 
ıu_u£r_»gs
, 
rbx
);

38 
	`OFFSET
(
UREGS_r11
, 
ıu_u£r_»gs
, 
r11
);

39 
	`OFFSET
(
UREGS_r10
, 
ıu_u£r_»gs
, 
r10
);

40 
	`OFFSET
(
UREGS_r9
, 
ıu_u£r_»gs
, 
r9
);

41 
	`OFFSET
(
UREGS_r8
, 
ıu_u£r_»gs
, 
r8
);

42 
	`OFFSET
(
UREGS_¿x
, 
ıu_u£r_»gs
, 
¿x
);

43 
	`OFFSET
(
UREGS_rcx
, 
ıu_u£r_»gs
, 
rcx
);

44 
	`OFFSET
(
UREGS_rdx
, 
ıu_u£r_»gs
, 
rdx
);

45 
	`OFFSET
(
UREGS_rsi
, 
ıu_u£r_»gs
, 
rsi
);

46 
	`OFFSET
(
UREGS_rdi
, 
ıu_u£r_»gs
, 
rdi
);

47 
	`OFFSET
(
UREGS_”rÜ_code
, 
ıu_u£r_»gs
, 
”rÜ_code
);

48 
	`OFFSET
(
UREGS_’Œy_veùÜ
, 
ıu_u£r_»gs
, 
’Œy_veùÜ
);

49 
	`OFFSET
(
UREGS_§ved_upÿÎ_mask
, 
ıu_u£r_»gs
, 
§ved_upÿÎ_mask
);

50 
	`OFFSET
(
UREGS_r
, 
ıu_u£r_»gs
, 
r
);

51 
	`OFFSET
(
UREGS_cs
, 
ıu_u£r_»gs
, 
cs
);

52 
	`OFFSET
(
UREGS_eæags
, 
ıu_u£r_»gs
, 
eæags
);

53 
	`OFFSET
(
UREGS_r¥
, 
ıu_u£r_»gs
, 
r¥
);

54 
	`OFFSET
(
UREGS_ss
, 
ıu_u£r_»gs
, 
ss
);

55 
	`OFFSET
(
UREGS_ds
, 
ıu_u£r_»gs
, 
ds
);

56 
	`OFFSET
(
UREGS_es
, 
ıu_u£r_»gs
, 
es
);

57 
	`OFFSET
(
UREGS_fs
, 
ıu_u£r_»gs
, 
fs
);

58 
	`OFFSET
(
UREGS_gs
, 
ıu_u£r_»gs
, 
gs
);

59 
	`OFFSET
(
UREGS_k”Ãl_sizeof
, 
ıu_u£r_»gs
, 
es
);

60 
	`DEFINE
(
UREGS_u£r_sizeof
, (
ıu_u£r_»gs
));

61 
	`BLANK
();

63 
	`OFFSET
(
œq_ÿps_off£t
, 
domaš
, 
œq_ÿps
);

64 
	`OFFSET
(
Ãxt_š_li¡_off£t
, 
domaš
, 
Ãxt_š_li¡
);

66 
	`OFFSET
(
VCPU_myæag
, 
vıu
, 
myæag
);

68 
	`OFFSET
(
VCPU_´oûssÜ
, 
vıu
, 
´oûssÜ
);

69 
	`OFFSET
(
VCPU_domaš
, 
vıu
, 
domaš
);

70 
	`OFFSET
(
VCPU_vıu_šfo
, 
vıu
, 
vıu_šfo
);

71 
	`OFFSET
(
VCPU_Œ­_bounû
, 
vıu
, 
¬ch
.
Œ­_bounû
);

72 
	`OFFSET
(
VCPU_št80_bounû
, 
vıu
, 
¬ch
.
št80_bounû
);

73 
	`OFFSET
(
VCPU_th»ad_æags
, 
vıu
, 
¬ch
.
æags
);

74 
	`OFFSET
(
VCPU_ev’t_addr
, 
vıu
,

75 
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_e
);

76 
	`OFFSET
(
VCPU_ev’t_£l
, 
vıu
,

77 
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_cs
);

78 
	`OFFSET
(
VCPU_ç§ã_addr
, 
vıu
,

79 
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_e
);

80 
	`OFFSET
(
VCPU_ç§ã_£l
, 
vıu
,

81 
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_cs
);

82 
	`OFFSET
(
VCPU_sysÿÎ_addr
, 
vıu
,

83 
¬ch
.
gue¡_cÚ‹xt
.
sysÿÎ_ÿÎback_e
);

84 
	`OFFSET
(
VCPU_sysÿÎ32_addr
, 
vıu
, 
¬ch
.
sysÿÎ32_ÿÎback_e
);

85 
	`OFFSET
(
VCPU_sysÿÎ32_£l
, 
vıu
, 
¬ch
.
sysÿÎ32_ÿÎback_cs
);

86 
	`OFFSET
(
VCPU_sysÿÎ32_di§bËs_ev’ts
, 
vıu
,

87 
¬ch
.
sysÿÎ32_di§bËs_ev’ts
);

88 
	`OFFSET
(
VCPU_sy£Á”_addr
, 
vıu
, 
¬ch
.
sy£Á”_ÿÎback_e
);

89 
	`OFFSET
(
VCPU_sy£Á”_£l
, 
vıu
, 
¬ch
.
sy£Á”_ÿÎback_cs
);

90 
	`OFFSET
(
VCPU_sy£Á”_di§bËs_ev’ts
, 
vıu
,

91 
¬ch
.
sy£Á”_di§bËs_ev’ts
);

92 
	`OFFSET
(
VCPU_gp_çuÉ_addr
, 
vıu
,

93 
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
TRAP_gp_çuÉ
].
add»ss
);

94 
	`OFFSET
(
VCPU_gp_çuÉ_£l
, 
vıu
,

95 
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[
TRAP_gp_çuÉ
].
cs
);

96 
	`OFFSET
(
VCPU_k”Ãl_¥
, 
vıu
, 
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
);

97 
	`OFFSET
(
VCPU_k”Ãl_ss
, 
vıu
, 
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
);

98 
	`OFFSET
(
VCPU_gue¡_cÚ‹xt_æags
, 
vıu
, 
¬ch
.
gue¡_cÚ‹xt
.
æags
);

99 
	`OFFSET
(
VCPU_nmi_³ndšg
, 
vıu
, 
nmi_³ndšg
);

100 
	`OFFSET
(
VCPU_mû_³ndšg
, 
vıu
, 
mû_³ndšg
);

101 
	`OFFSET
(
VCPU_nmi_Şd_mask
, 
vıu
, 
nmi_¡©e
.
Şd_mask
);

102 
	`OFFSET
(
VCPU_mû_Şd_mask
, 
vıu
, 
mû_¡©e
.
Şd_mask
);

103 
	`OFFSET
(
VCPU_async_exû±iÚ_mask
, 
vıu
, 
async_exû±iÚ_mask
);

104 
	`DEFINE
(
VCPU_TRAP_NMI
, VCPU_TRAP_NMI);

105 
	`DEFINE
(
VCPU_TRAP_MCE
, VCPU_TRAP_MCE);

106 
	`DEFINE
(
_VGCF_ç§ã_di§bËs_ev’ts
, _VGCF_failsafe_disables_events);

107 
	`DEFINE
(
_VGCF_sysÿÎ_di§bËs_ev’ts
, _VGCF_syscall_disables_events);

108 
	`BLANK
();

110 
	`OFFSET
(
VCPU_svm_vmcb_·
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb_·
);

111 
	`OFFSET
(
VCPU_svm_vmcb
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb
);

112 
	`OFFSET
(
VCPU_svm_vmcb_š_sync
, 
vıu
, 
¬ch
.
hvm_svm
.
vmcb_š_sync
);

113 
	`BLANK
();

115 
	`OFFSET
(
VCPU_vmx_Ïunched
, 
vıu
, 
¬ch
.
hvm_vmx
.
Ïunched
);

116 
	`OFFSET
(
VCPU_vmx_»®mode
, 
vıu
, 
¬ch
.
hvm_vmx
.
vmx_»®mode
);

117 
	`OFFSET
(
VCPU_vmx_emuÏ‹
, 
vıu
, 
¬ch
.
hvm_vmx
.
vmx_emuÏ‹
);

118 
	`OFFSET
(
VCPU_vm86_£g_mask
, 
vıu
, 
¬ch
.
hvm_vmx
.
vm86_£gm’t_mask
);

119 
	`OFFSET
(
VCPU_hvm_gue¡_ü2
, 
vıu
, 
¬ch
.
hvm_vıu
.
gue¡_ü
[2]);

120 
	`BLANK
();

122 
	`OFFSET
(
DOMAIN_is_32b™_pv
, 
domaš
, 
¬ch
.
is_32b™_pv
);

123 
	`BLANK
();

125 
	`OFFSET
(
VMCB_¿x
, 
vmcb_¡ruù
, 
¿x
);

126 
	`OFFSET
(
VMCB_r
, 
vmcb_¡ruù
, 
r
);

127 
	`OFFSET
(
VMCB_r¥
, 
vmcb_¡ruù
, 
r¥
);

128 
	`OFFSET
(
VMCB_ræags
, 
vmcb_¡ruù
, 
ræags
);

129 
	`BLANK
();

131 
	`OFFSET
(
VCPUINFO_upÿÎ_³ndšg
, 
vıu_šfo
, 
evtchn_upÿÎ_³ndšg
);

132 
	`OFFSET
(
VCPUINFO_upÿÎ_mask
, 
vıu_šfo
, 
evtchn_upÿÎ_mask
);

133 
	`BLANK
();

135 
	`OFFSET
(
COMPAT_VCPUINFO_upÿÎ_³ndšg
, 
com·t_vıu_šfo
, 
evtchn_upÿÎ_³ndšg
);

136 
	`OFFSET
(
COMPAT_VCPUINFO_upÿÎ_mask
, 
com·t_vıu_šfo
, 
evtchn_upÿÎ_mask
);

137 
	`BLANK
();

139 
	`OFFSET
(
CPUINFO_gue¡_ıu_u£r_»gs
, 
ıu_šfo
, 
gue¡_ıu_u£r_»gs
);

140 
	`OFFSET
(
CPUINFO_´oûssÜ_id
, 
ıu_šfo
, 
´oûssÜ_id
);

141 
	`OFFSET
(
CPUINFO_cu¼’t_vıu
, 
ıu_šfo
, 
cu¼’t_vıu
);

142 
	`DEFINE
(
CPUINFO_sizeof
, (
ıu_šfo
));

143 
	`BLANK
();

145 
	`OFFSET
(
TRAPBOUNCE_”rÜ_code
, 
Œ­_bounû
, 
”rÜ_code
);

146 
	`OFFSET
(
TRAPBOUNCE_æags
, 
Œ­_bounû
, 
æags
);

147 
	`OFFSET
(
TRAPBOUNCE_cs
, 
Œ­_bounû
, 
cs
);

148 
	`OFFSET
(
TRAPBOUNCE_e
, 
Œ­_bounû
, 
e
);

149 
	`BLANK
();

151 #ià
PERF_COUNTERS


152 
	`DEFINE
(
ASM_PERFC_hy³rÿÎs
, 
PERFC_hy³rÿÎs
);

153 
	`DEFINE
(
ASM_PERFC_exû±iÚs
, 
PERFC_exû±iÚs
);

154 
	`BLANK
();

157 
	`DEFINE
(
IRQSTAT_shiá
, 
	`LOG_2
((
œq_ıu¡©_t
)));

158 
	`BLANK
();

160 
	`OFFSET
(
CPUINFO86_ext_ã©u»s
, 
ıušfo_x86
, 
x86_ÿ·b™y
[1]);

161 
	`BLANK
();

163 
	`OFFSET
(
MB_æags
, 
muÉiboÙ_šfo_t
, 
æags
);

164 
	`OFFSET
(
MB_cmdlše
, 
muÉiboÙ_šfo_t
, 
cmdlše
);

165 
	}
}

	@x86_64/compat.c

5 
	~<x’/cÚfig.h
>

6 
	~<x’/hy³rÿÎ.h
>

7 
	~<com·t/x’.h
>

8 
	~<com·t/physdev.h
>

10 
DEFINE_XEN_GUEST_HANDLE
(
physdev_İ_com·t_t
);

11 
	#physdev_İ
 
com·t_physdev_İ


	)

12 
	#physdev_İ_t
 
physdev_İ_com·t_t


	)

13 
	#do_physdev_İ
 
com·t_physdev_İ


	)

14 
	#do_physdev_İ_com·t
(
x
è
	`com·t_physdev_İ_com·t
(
_
##x)

	)

16 
	#COMPAT


	)

17 
	#_XEN_GUEST_HANDLE
(
t
è
	`XEN_GUEST_HANDLE
Ñ)

	)

18 
	t»t_t
;

20 
	~"../com·t.c
"

	@x86_64/compat/mm.c

1 
	~<x’/ev’t.h
>

2 
	~<x’/muÉiÿÎ.h
>

3 
	~<com·t/memÜy.h
>

4 
	~<com·t/x’.h
>

6 
com·t_£t_gdt
(
	$XEN_GUEST_HANDLE
(
ušt
è
äame_li¡
, 
’Œ›s
)

8 
i
, 
Ä_·ges
 = (
’Œ›s
 + 511) / 512;

9 
äames
[16];

10 
»t
;

13 iàĞ
’Œ›s
 > 
FIRST_RESERVED_GDT_ENTRY
 )

14  -
EINVAL
;

16 iàĞ!
	`gue¡_hªdË_okay
(
äame_li¡
, 
Ä_·ges
) )

17  -
EFAULT
;

19  
i
 = 0; i < 
Ä_·ges
; ++i )

21 
äame
;

23 iàĞ
	`__cİy_äom_gue¡
(&
äame
, 
äame_li¡
, 1) )

24  -
EFAULT
;

25 
äames
[
i
] = 
äame
;

26 
	`gue¡_hªdË_add_off£t
(
äame_li¡
, 1);

29 
	`domaš_lock
(
cu¼’t
->
domaš
);

31 iàĞ(
»t
 = 
	`£t_gdt
(
cu¼’t
, 
äames
, 
’Œ›s
)) == 0 )

32 
	`æush_b_loÿl
();

34 
	`domaš_uÆock
(
cu¼’t
->
domaš
);

36  
»t
;

37 
	}
}

39 
	$com·t_upd©e_desütÜ
(
u32
 
·_lo
, u32 
·_hi
, u32 
desc_lo
, u32 
desc_hi
)

41  
	`do_upd©e_desütÜ
(
·_lo
 | ((
u64
)
·_hi
 << 32),

42 
desc_lo
 | ((
u64
)
desc_hi
 << 32));

43 
	}
}

45 
com·t_¬ch_memÜy_İ
(
İ
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

47 
com·t_machphys_mâ_li¡
 
xmml
;

48 
l2_pg’Œy_t
 
l2e
;

49 
v
;

50 
com·t_pâ_t
 
mâ
;

51 
i
;

52 
rc
 = 0;

54  
İ
 )

56 
XENMEM_add_to_physm­
:

58 
com·t_add_to_physm­
 
cmp
;

59 
x’_add_to_physm­
 *
Çt
 = 
COMPAT_ARG_XLAT_VIRT_BASE
;

61 iàĞ
	`cİy_äom_gue¡
(&
cmp
, 
¬g
, 1) )

62  -
EFAULT
;

64 
	`XLAT_add_to_physm­
(
Çt
, &
cmp
);

65 
rc
 = 
	`¬ch_memÜy_İ
(
İ
, 
	`gue¡_hªdË_äom_±r
(
Çt
, ));

70 
XENMEM_£t_memÜy_m­
:

72 
com·t_fÜeign_memÜy_m­
 
cmp
;

73 
x’_fÜeign_memÜy_m­
 *
Çt
 = 
COMPAT_ARG_XLAT_VIRT_BASE
;

75 iàĞ
	`cİy_äom_gue¡
(&
cmp
, 
¬g
, 1) )

76  -
EFAULT
;

78 
	#XLAT_memÜy_m­_HNDL_bufãr
(
_d_
, 
_s_
) \

79 
	`gue¡_äom_com·t_hªdË
((
_d_
)->
bufãr
, (
_s_
)->bufãr)

	)

80 
	`XLAT_fÜeign_memÜy_m­
(
Çt
, &
cmp
);

81 #undeà
XLAT_memÜy_m­_HNDL_bufãr


83 
rc
 = 
	`¬ch_memÜy_İ
(
İ
, 
	`gue¡_hªdË_äom_±r
(
Çt
, ));

88 
XENMEM_memÜy_m­
:

89 
XENMEM_machše_memÜy_m­
:

91 
com·t_memÜy_m­
 
cmp
;

92 
x’_memÜy_m­
 *
Çt
 = 
COMPAT_ARG_XLAT_VIRT_BASE
;

94 iàĞ
	`cİy_äom_gue¡
(&
cmp
, 
¬g
, 1) )

95  -
EFAULT
;

97 
	#XLAT_memÜy_m­_HNDL_bufãr
(
_d_
, 
_s_
) \

98 
	`gue¡_äom_com·t_hªdË
((
_d_
)->
bufãr
, (
_s_
)->bufãr)

	)

99 
	`XLAT_memÜy_m­
(
Çt
, &
cmp
);

100 #undeà
XLAT_memÜy_m­_HNDL_bufãr


102 
rc
 = 
	`¬ch_memÜy_İ
(
İ
, 
	`gue¡_hªdË_äom_±r
(
Çt
, ));

103 iàĞ
rc
 < 0 )

106 
	#XLAT_memÜy_m­_HNDL_bufãr
(
_d_
, 
_s_
è(()0)

	)

107 
	`XLAT_memÜy_m­
(&
cmp
, 
Çt
);

108 #undeà
XLAT_memÜy_m­_HNDL_bufãr


109 iàĞ
	`cİy_to_gue¡
(
¬g
, &
cmp
, 1) )

110 
rc
 = -
EFAULT
;

115 
XENMEM_£t_pod_rg‘
:

116 
XENMEM_g‘_pod_rg‘
:

118 
com·t_pod_rg‘
 
cmp
;

119 
x’_pod_rg‘
 *
Çt
 = 
COMPAT_ARG_XLAT_VIRT_BASE
;

121 iàĞ
	`cİy_äom_gue¡
(&
cmp
, 
¬g
, 1) )

122  -
EFAULT
;

124 
	`XLAT_pod_rg‘
(
Çt
, &
cmp
);

126 
rc
 = 
	`¬ch_memÜy_İ
(
İ
, 
	`gue¡_hªdË_äom_±r
(
Çt
, ));

127 iàĞ
rc
 < 0 )

130 iàĞ
rc
 =ğ
__HYPERVISOR_memÜy_İ
 )

131 
	`hy³rÿÎ_xÏt_cÚtšu©iÚ
(
NULL
, 0x2, 
Çt
, 
¬g
);

133 
	`XLAT_pod_rg‘
(&
cmp
, 
Çt
);

135 iàĞ
	`cİy_to_gue¡
(
¬g
, &
cmp
, 1) )

136 
rc
 = -
EFAULT
;

141 
XENMEM_machphys_m­pšg
:

143 
domaš
 *
d
 = 
cu¼’t
->domain;

144 
com·t_machphys_m­pšg
 
m­pšg
 = {

145 .
v_¡¬t
 = 
	`MACH2PHYS_COMPAT_VIRT_START
(
d
),

146 .
v_’d
 = 
MACH2PHYS_COMPAT_VIRT_END
,

147 .
max_mâ
 = 
	`MACH2PHYS_COMPAT_NR_ENTRIES
(
d
) - 1

150 iàĞ
	`cİy_to_gue¡
(
¬g
, &
m­pšg
, 1) )

151 
rc
 = -
EFAULT
;

156 
XENMEM_machphys_mâ_li¡
:

158 
lim™
;

159 
com·t_pâ_t
 
Ï¡_mâ
;

161 iàĞ
	`cİy_äom_gue¡
(&
xmml
, 
¬g
, 1) )

162  -
EFAULT
;

164 
lim™
 = ()(
com·t_machše_to_phys_m­pšg
 + 
max_·ge
);

165 iàĞ
lim™
 > 
RDWR_COMPAT_MPT_VIRT_END
 )

166 
lim™
 = 
RDWR_COMPAT_MPT_VIRT_END
;

167  
i
 = 0, 
v
 = 
RDWR_COMPAT_MPT_VIRT_START
, 
Ï¡_mâ
 = 0;

168 (
i
 !ğ
xmml
.
max_ex‹Ás
è&& (
v
 < 
lim™
);

169 
i
++, 
v
 +ğ1 << 
L2_PAGETABLE_SHIFT
 )

171 
l2e
 = 
com·t_idË_pg_bË_l2
[
	`l2_bË_off£t
(
v
)];

172 iàĞ
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
 )

173 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

175 
mâ
 = 
Ï¡_mâ
;

176 
	`ASSERT
(
mâ
);

177 iàĞ
	`cİy_to_com·t_off£t
(
xmml
.
ex‹Á_¡¬t
, 
i
, &
mâ
, 1) )

178  -
EFAULT
;

179 
Ï¡_mâ
 = 
mâ
;

182 
xmml
.
Ä_ex‹Ás
 = 
i
;

183 iàĞ
	`cİy_to_gue¡
(
¬g
, &
xmml
, 1) )

184 
rc
 = -
EFAULT
;

190 
rc
 = -
ENOSYS
;

194  
rc
;

195 
	}
}

197 
	$com·t_upd©e_va_m­pšg
(
va
, 
u32
 
lo
, u32 
hi
,

198 
æags
)

200  
	`do_upd©e_va_m­pšg
(
va
, 
lo
 | ((
u64
)
hi
 << 32), 
æags
);

201 
	}
}

203 
	$com·t_upd©e_va_m­pšg_Ùh”domaš
(
va
, 
u32
 
lo
, u32 
hi
,

204 
æags
,

205 
domid_t
 
domid
)

207  
	`do_upd©e_va_m­pšg_Ùh”domaš
(
va
, 
lo
 | ((
u64
)
hi
 << 32), 
æags
, 
domid
);

208 
	}
}

210 
DEFINE_XEN_GUEST_HANDLE
(
mmuext_İ_com·t_t
);

212 
com·t_mmuext_İ
(
	$XEN_GUEST_HANDLE
(
mmuext_İ_com·t_t
è
cmp_uİs
,

213 
couÁ
,

214 
	$XEN_GUEST_HANDLE
(
ušt
è
pdÚe
,

215 
fÜeigndom
)

217 
i
, 
´“m±_mask
;

218 
rc
 = 0;

219 
	`XEN_GUEST_HANDLE
(
mmuext_İ_t
è
Çt_İs
;

221 
´“m±_mask
 = 
couÁ
 & 
MMU_UPDATE_PREEMPTED
;

222 
couÁ
 ^ğ
´“m±_mask
;

224 iàĞ
	`uÆik–y
(!
	`gue¡_hªdË_okay
(
cmp_uİs
, 
couÁ
)) )

225  -
EFAULT
;

227 
	`£t_x’_gue¡_hªdË
(
Çt_İs
, 
COMPAT_ARG_XLAT_VIRT_BASE
);

229  ; 
couÁ
; couÁ -ğ
i
 )

231 
mmuext_İ_t
 *
Çt_İ
 = 
Çt_İs
.
p
;

232 
lim™
 = 
COMPAT_ARG_XLAT_SIZE
 / (*
Çt_İ
);

233 
”r
;

235  
i
 = 0; i < 
	`mš
(
lim™
, 
couÁ
); ++i )

237 
mmuext_İ_com·t_t
 
cmp_İ
;

238 
XLAT_mmuext_İ_¬g1
 
¬g1
;

239 
XLAT_mmuext_İ_¬g2
 
¬g2
;

241 iàĞ
	`uÆik–y
(
	`__cİy_äom_gue¡
(&
cmp_İ
, 
cmp_uİs
, 1) != 0) )

243 
rc
 = -
EFAULT
;

247  
cmp_İ
.
cmd
 )

249 
MMUEXT_PIN_L1_TABLE
:

250 
MMUEXT_PIN_L2_TABLE
:

251 
MMUEXT_PIN_L3_TABLE
:

252 
MMUEXT_PIN_L4_TABLE
:

253 
MMUEXT_UNPIN_TABLE
:

254 
MMUEXT_NEW_BASEPTR
:

255 
MMUEXT_CLEAR_PAGE
:

256 
MMUEXT_COPY_PAGE
:

257 
¬g1
 = 
XLAT_mmuext_İ_¬g1_mâ
;

260 
¬g1
 = 
XLAT_mmuext_İ_¬g1_lš—r_addr
;

262 
MMUEXT_NEW_USER_BASEPTR
:

263 
rc
 = -
EINVAL
;

264 
MMUEXT_TLB_FLUSH_LOCAL
:

265 
MMUEXT_TLB_FLUSH_MULTI
:

266 
MMUEXT_TLB_FLUSH_ALL
:

267 
MMUEXT_FLUSH_CACHE
:

268 
¬g1
 = -1;

272 iàĞ
rc
 )

275  
cmp_İ
.
cmd
 )

277 
MMUEXT_SET_LDT
:

278 
¬g2
 = 
XLAT_mmuext_İ_¬g2_Ä_’ts
;

280 
MMUEXT_TLB_FLUSH_MULTI
:

281 
MMUEXT_INVLPG_MULTI
:

282 
¬g2
 = 
XLAT_mmuext_İ_¬g2_vıumask
;

284 
MMUEXT_COPY_PAGE
:

285 
¬g2
 = 
XLAT_mmuext_İ_¬g2_¤c_mâ
;

288 
¬g2
 = -1;

292 
	#XLAT_mmuext_İ_HNDL_¬g2_vıumask
(
_d_
, 
_s_
) \

293 
	`gue¡_äom_com·t_hªdË
((
_d_
)->
¬g2
.
vıumask
, (
_s_
)->¬g2.vıumask)

	)

294 
	`XLAT_mmuext_İ
(
Çt_İ
, &
cmp_İ
);

295 #undeà
XLAT_mmuext_İ_HNDL_¬g2_vıumask


297 iàĞ
rc
 || 
i
 >ğ
lim™
 )

300 
	`gue¡_hªdË_add_off£t
(
cmp_uİs
, 1);

301 ++
Çt_İ
;

304 
”r
 = 
	`do_mmuext_İ
(
Çt_İs
, 
i
 | 
´“m±_mask
, 
pdÚe
, 
fÜeigndom
);

306 iàĞ
”r
 )

308 
	`BUILD_BUG_ON
(
__HYPERVISOR_mmuext_İ
 <= 0);

309 iàĞ
”r
 =ğ
__HYPERVISOR_mmuext_İ
 )

311 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

312 
mc_¡©e
 *
mcs
 = &
cu¼’t
->mc_state;

313 
¬g1
 = !
	`‹¡_b™
(
_MCSF_š_muÉiÿÎ
, &
mcs
->
æags
)

314 ? 
»gs
->
ecx


315 : 
mcs
->
ÿÎ
.
¬gs
[1];

316 
Ëá
 = 
¬g1
 & ~
MMU_UPDATE_PREEMPTED
;

318 
	`BUG_ON
(
Ëá
 =ğ
¬g1
);

319 
	`BUG_ON
(
Ëá
 > 
couÁ
);

320 
	`gue¡_hªdË_add_off£t
(
Çt_İs
, 
i
 - 
Ëá
);

321 
	`gue¡_hªdË_subŒaù_off£t
(
cmp_uİs
, 
Ëá
);

322 
Ëá
 = 1;

323 
	`BUG_ON
(!
	`hy³rÿÎ_xÏt_cÚtšu©iÚ
(&
Ëá
, 0x01, 
Çt_İs
, 
cmp_uİs
));

324 
	`BUG_ON
(
Ëá
 !ğ
¬g1
);

325 ià(!
	`‹¡_b™
(
_MCSF_š_muÉiÿÎ
, &
mcs
->
æags
))

326 
»gs
->
_ecx
 +ğ
couÁ
 - 
i
;

328 
mcs
->
com·t_ÿÎ
.
¬gs
[1] +ğ
couÁ
 - 
i
;

331 
	`BUG_ON
(
”r
 > 0);

332 
rc
 = 
”r
;

335 iàĞ
rc
 )

339 
´“m±_mask
 = 
MMU_UPDATE_PREEMPTED
;

342  
rc
;

343 
	}
}

	@x86_64/compat/traps.c

1 
	~<x’/ev’t.h
>

2 
	~<asm/»gs.h
>

3 
	~<com·t/ÿÎback.h
>

4 
	~<com·t/¬ch-x86_32.h
>

6 
	$com·t_show_gue¡_¡ack
(
vıu
 *
v
, 
ıu_u£r_»gs
 *
»gs
,

7 
debug_¡ack_lšes
)

9 
i
, *
¡ack
, 
addr
, 
mask
 = 
STACK_SIZE
;

11 
¡ack
 = (*)()
»gs
->
_e¥
;

12 
	`´štk
("Gue¡ sck¿û fromƒ¥=%08lx:\À", ()
¡ack
);

14 iàĞ!
	`__com·t_acûss_ok
(
v
->
domaš
, 
¡ack
, (*stack)) )

16 
	`´štk
("Guest-inaccessible memory.\n");

20 iàĞ
v
 !ğ
cu¼’t
 )

22 
vıu
 *vcpu;

24 
	`ASSERT
(
	`gue¡_k”Ãl_mode
(
v
, 
»gs
));

25 
addr
 = 
	`»ad_ü3
(è>> 
PAGE_SHIFT
;

26 
	`fÜ_—ch_vıu
Ğ
v
->
domaš
, 
vıu
 )

27 iàĞ
	`·g‘abË_g‘_pâ
(
vıu
->
¬ch
.
gue¡_bË
è=ğ
addr
 )

29 iàĞ!
vıu
 )

31 
¡ack
 = 
	`do_·ge_w®k
(
v
, ()stack);

32 iàĞ()
¡ack
 < 
PAGE_SIZE
 )

34 
	`´štk
("Inaccessible guest memory.\n");

37 
mask
 = 
PAGE_SIZE
;

41  
i
 = 0; i < 
debug_¡ack_lšes
 * 8; i++ )

43 iàĞ((()
¡ack
 - 1è^ (()(¡ack + 1è- 1)è& 
mask
 )

45 iàĞ
	`__g‘_u£r
(
addr
, 
¡ack
) )

47 iàĞ
i
 != 0 )

48 
	`´štk
("\n ");

49 
	`´štk
("Fault while‡ccessing guest memory.");

50 
i
 = 1;

53 iàĞ(
i
 != 0) && ((i % 8) == 0) )

54 
	`´štk
("\n ");

55 
	`´štk
(" %08x", 
addr
);

56 
¡ack
++;

58 iàĞ
i
 == 0 )

59 
	`´štk
("Stackƒmpty.");

60 
	`´štk
("\n");

61 
	}
}

63 
	$com·t_œ‘
()

65 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

66 
vıu
 *
v
 = 
cu¼’t
;

67 
u32
 
eæags
;

70 
»gs
->
r¥
 = (
u32
)regs->rsp;

73 iàĞ
	`uÆik–y
(
	`__g‘_u£r
(
»gs
->
_—x
, (
u32
 *ìegs->
r¥
)) )

74 
ex™_ªd_üash
;

77 iàĞ
	`uÆik–y
(
	`__g‘_u£r
(
»gs
->
_e
, (
u32
 *ìegs->
r¥
 + 1)) ||

78 
	`uÆik–y
(
	`__g‘_u£r
(
»gs
->
cs
, (
u32
 *ìegs->
r¥
 + 2)) )

79 
ex™_ªd_üash
;

85 iàĞ
	`uÆik–y
(
	`__g‘_u£r
(
eæags
, (
u32
 *)
»gs
->
r¥
 + 3)) )

86 
ex™_ªd_üash
;

87 
»gs
->
_eæags
 = (
eæags
 & ~
X86_EFLAGS_IOPL
è| 
X86_EFLAGS_IF
;

89 iàĞ
	`uÆik–y
(
eæags
 & 
X86_EFLAGS_VM
) )

99 cÚ¡ 
Œ­_šfo
 *
ti
;

100 
u32
 
x
, 
k¥
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
 - 40;

101 
i
;

102 
rc
 = 0;

104 
	`gd´štk
(
XENLOG_ERR
, "VM86 mode unavailable (ksp:%08X->%08X)\n",

105 
»gs
->
_e¥
, 
k¥
);

106 iàĞ
k¥
 < 
»gs
->
_e¥
 )

108 
i
 = 1; i < 10; ++i)

110 
rc
 |ğ
	`__g‘_u£r
(
x
, (
u32
 *)
»gs
->
r¥
 + 
i
);

111 
rc
 |ğ
	`__put_u£r
(
x
, (
u32
 *)()
k¥
 + 
i
);

114 iàĞ
k¥
 > 
»gs
->
_e¥
 )

116 
i
 = 9; i > 0; ++i)

118 
rc
 |ğ
	`__g‘_u£r
(
x
, (
u32
 *)
»gs
->
r¥
 + 
i
);

119 
rc
 |ğ
	`__put_u£r
(
x
, (
u32
 *)()
k¥
 + 
i
);

122 iàĞ
rc
 )

123 
ex™_ªd_üash
;

124 
»gs
->
_e¥
 = 
k¥
;

125 
»gs
->
ss
 = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
;

127 
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[13];

128 iàĞ
	`TI_GET_IF
(
ti
) )

129 
eæags
 &ğ~
X86_EFLAGS_IF
;

130 
»gs
->
_eæags
 &ğ~(
X86_EFLAGS_VM
|
X86_EFLAGS_RF
|

131 
X86_EFLAGS_NT
|
X86_EFLAGS_TF
);

132 iàĞ
	`uÆik–y
(
	`__put_u£r
(0, (
u32
 *)
»gs
->
r¥
)) )

133 
ex™_ªd_üash
;

134 
»gs
->
_e
 = 
ti
->
add»ss
;

135 
»gs
->
cs
 = 
ti
->cs;

137 iàĞ
	`uÆik–y
(
	`ršg_0
(
»gs
)) )

138 
ex™_ªd_üash
;

139 iàĞ!
	`ršg_1
(
»gs
) )

142 iàĞ
	`__g‘_u£r
(
»gs
->
ss
, (
u32
 *ìegs->
r¥
 + 5)

143 || 
	`__g‘_u£r
(
»gs
->
_e¥
, (
u32
 *ìegs->
r¥
 + 4))

144 
ex™_ªd_üash
;

147 
»gs
->
_e¥
 += 16;

150 
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_mask
èğ!(
eæags
 & 
X86_EFLAGS_IF
);

152 
	`async_exû±iÚ_ş—nup
(
v
);

158  
»gs
->
_—x
;

160 
ex™_ªd_üash
:

161 
	`gd´štk
(
XENLOG_ERR
, "Fatalƒrror\n");

162 
	`domaš_üash
(
v
->
domaš
);

164 
	}
}

166 
	$com·t_»gi¡”_gue¡_ÿÎback
(

167 
com·t_ÿÎback_»gi¡”
 *
»g
)

169 
»t
 = 0;

170 
vıu
 *
v
 = 
cu¼’t
;

172 
	`fixup_gue¡_code_£ËùÜ
(
v
->
domaš
, 
»g
->
add»ss
.
cs
);

174  
»g
->
ty³
 )

176 
CALLBACKTYPE_ev’t
:

177 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

178 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

181 
CALLBACKTYPE_ç§ã
:

182 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

183 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

184 iàĞ
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
 )

185 
	`£t_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

186 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

188 
	`ş—r_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

189 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

192 
CALLBACKTYPE_sysÿÎ32
:

193 
v
->
¬ch
.
sysÿÎ32_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

194 
v
->
¬ch
.
sysÿÎ32_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

195 
v
->
¬ch
.
sysÿÎ32_di§bËs_ev’ts
 =

196 (
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
) != 0;

199 
CALLBACKTYPE_sy£Á”
:

200 
v
->
¬ch
.
sy£Á”_ÿÎback_cs
 = 
»g
->
add»ss
.
cs
;

201 
v
->
¬ch
.
sy£Á”_ÿÎback_e
 = 
»g
->
add»ss
.
e
;

202 
v
->
¬ch
.
sy£Á”_di§bËs_ev’ts
 =

203 (
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
) != 0;

206 
CALLBACKTYPE_nmi
:

207 
»t
 = 
	`»gi¡”_gue¡_nmi_ÿÎback
(
»g
->
add»ss
.
e
);

211 
»t
 = -
ENOSYS
;

215  
»t
;

216 
	}
}

218 
	$com·t_uÄegi¡”_gue¡_ÿÎback
(

219 
com·t_ÿÎback_uÄegi¡”
 *
uÄeg
)

221 
»t
;

223  
uÄeg
->
ty³
 )

225 
CALLBACKTYPE_ev’t
:

226 
CALLBACKTYPE_ç§ã
:

227 
CALLBACKTYPE_sysÿÎ32
:

228 
CALLBACKTYPE_sy£Á”
:

229 
»t
 = -
EINVAL
;

232 
CALLBACKTYPE_nmi
:

233 
»t
 = 
	`uÄegi¡”_gue¡_nmi_ÿÎback
();

237 
»t
 = -
ENOSYS
;

241  
»t
;

242 
	}
}

245 
com·t_ÿÎback_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

247 
»t
;

249  
cmd
 )

251 
CALLBACKOP_»gi¡”
:

253 
com·t_ÿÎback_»gi¡”
 
»g
;

255 
»t
 = -
EFAULT
;

256 iàĞ
	`cİy_äom_gue¡
(&
»g
, 
¬g
, 1) )

259 
»t
 = 
	`com·t_»gi¡”_gue¡_ÿÎback
(&
»g
);

263 
CALLBACKOP_uÄegi¡”
:

265 
com·t_ÿÎback_uÄegi¡”
 
uÄeg
;

267 
»t
 = -
EFAULT
;

268 iàĞ
	`cİy_äom_gue¡
(&
uÄeg
, 
¬g
, 1) )

271 
»t
 = 
	`com·t_uÄegi¡”_gue¡_ÿÎback
(&
uÄeg
);

276 
»t
 = -
EINVAL
;

280  
»t
;

281 
	}
}

283 
	$com·t_£t_ÿÎbacks
(
ev’t_£ËùÜ
,

284 
ev’t_add»ss
,

285 
ç§ã_£ËùÜ
,

286 
ç§ã_add»ss
)

288 
com·t_ÿÎback_»gi¡”
 
ev’t
 = {

289 .
ty³
 = 
CALLBACKTYPE_ev’t
,

290 .
add»ss
 = {

291 .
cs
 = 
ev’t_£ËùÜ
,

292 .
e
 = 
ev’t_add»ss


295 
com·t_ÿÎback_»gi¡”
 
ç§ã
 = {

296 .
ty³
 = 
CALLBACKTYPE_ç§ã
,

297 .
add»ss
 = {

298 .
cs
 = 
ç§ã_£ËùÜ
,

299 .
e
 = 
ç§ã_add»ss


303 
	`com·t_»gi¡”_gue¡_ÿÎback
(&
ev’t
);

304 
	`com·t_»gi¡”_gue¡_ÿÎback
(&
ç§ã
);

307 
	}
}

309 
DEFINE_XEN_GUEST_HANDLE
(
Œ­_šfo_com·t_t
);

311 
com·t_£t_Œ­_bË
(
	$XEN_GUEST_HANDLE
(
Œ­_šfo_com·t_t
è
Œ­s
)

313 
com·t_Œ­_šfo
 
cur
;

314 
Œ­_šfo
 *
d¡
 = 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
;

315 
rc
 = 0;

318 iàĞ
	`gue¡_hªdË_is_nuÎ
(
Œ­s
) )

320 
	`mem£t
(
d¡
, 0, 256 * (*dst));

326 iàĞ
	`hy³rÿÎ_´“m±_check
() )

328 
rc
 = 
	`hy³rÿÎ_ü—‹_cÚtšu©iÚ
(

329 
__HYPERVISOR_£t_Œ­_bË
, "h", 
Œ­s
);

333 iàĞ
	`cİy_äom_gue¡
(&
cur
, 
Œ­s
, 1) )

335 
rc
 = -
EFAULT
;

339 iàĞ
cur
.
add»ss
 == 0 )

342 
	`fixup_gue¡_code_£ËùÜ
(
cu¼’t
->
domaš
, 
cur
.
cs
);

344 
	`XLAT_Œ­_šfo
(
d¡
 + 
cur
.
veùÜ
, &cur);

346 iàĞ
cur
.
veùÜ
 == 0x80 )

347 
	`š™_št80_dœeù_Œ­
(
cu¼’t
);

349 
	`gue¡_hªdË_add_off£t
(
Œ­s
, 1);

352  
rc
;

353 
	}
}

355 
	$hy³rÿÎ_·ge_š™Ÿli£_ršg1_k”Ãl
(*
hy³rÿÎ_·ge
)

357 *
p
;

358 
i
;

362  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

364 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

365 *(
u8
 *)(
p
+ 0) = 0xb8;

366 *(
u32
 *)(
p
+ 1èğ
i
;

367 *(
u16
 *)(
p
+ 5) = 0x82cd;

368 *(
u8
 *)(
p
+ 7) = 0xc3;

376 
p
 = (*)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32));

377 *(
u8
 *)(
p
+ 0) = 0x50;

378 *(
u8
 *)(
p
+ 1) = 0xb8;

379 *(
u32
 *)(
p
+ 2èğ
__HYPERVISOR_œ‘
;

380 *(
u16
 *)(
p
+ 6) = 0x82cd;

381 
	}
}

	@x86_64/cpu_idle.c

25 
	#__XEN_TOOLS__


	)

27 
	~<x’/cÚfig.h
>

28 
	~<x’/ty³s.h
>

29 
	~<x’/xm®loc.h
>

30 
	~<x’/gue¡_acûss.h
>

31 
	~<com·t/¶©fÜm.h
>

33 
	gCHECK_´oûssÜ_csd
;

35 
DEFINE_XEN_GUEST_HANDLE
(
com·t_´oûssÜ_csd_t
);

36 
DEFINE_XEN_GUEST_HANDLE
(
com·t_´oûssÜ_cx_t
);

38 
	#xÏt_·ge_¡¬t
 (()
COMPAT_ARG_XLAT_VIRT_BASE
)

	)

39 
	#xÏt_·ge_size
 
COMPAT_ARG_XLAT_SIZE


	)

40 
	#xÏt_·ge_Ëá_size
(
xÏt_·ge_cu¼’t
) \

41 (
xÏt_·ge_¡¬t
 + 
xÏt_·ge_size
 - 
xÏt_·ge_cu¼’t
)

	)

43 
	#xÏt_m®loc_š™
(
xÏt_·ge_cu¼’t
) do { \

44 
xÏt_·ge_cu¼’t
 = 
xÏt_·ge_¡¬t
; \

45 } 0)

	)

47 *
	$xÏt_m®loc
(*
xÏt_·ge_cu¼’t
, 
size_t
 
size
)

49 *
»t
;

52 
size
 = (size + 0x3fUL) & ~0x3fUL;

54 iàĞ
	`uÆik–y
(
size
 > 
	`xÏt_·ge_Ëá_size
(*
xÏt_·ge_cu¼’t
)) )

55  
NULL
;

57 
»t
 = (*è*
xÏt_·ge_cu¼’t
;

58 *
xÏt_·ge_cu¼’t
 +ğ
size
;

60  
»t
;

61 
	}
}

63 
	#xÏt_m®loc_¬¿y
(
_p
, 
_t
, 
_c
è((_ˆ*è
	`xÏt_m®loc
(&_p, (_tè* _c))

	)

65 
	$cİy_äom_com·t_¡©e
(
x’_´oûssÜ_cx_t
 *
x’_¡©e
,

66 
com·t_´oûssÜ_cx_t
 *
¡©e
)

68 
	#XLAT_´oûssÜ_cx_HNDL_dp
(
_d_
, 
_s_
) do { \

69 
	`XEN_GUEST_HANDLE
(
com·t_´oûssÜ_csd_t
è
dps
; \

70 iàĞ
	`uÆik–y
(!
	`com·t_hªdË_okay
((
_s_
)->
dp
, (_s_)->
dpút
)) ) \

71  -
EFAULT
; \

72 
	`gue¡_äom_com·t_hªdË
(
dps
, (
_s_
)->
dp
); \

73 (
_d_
)->
dp
 = 
	`gue¡_hªdË_ÿ¡
(
dps
, 
x’_´oûssÜ_csd_t
); \

74 } 0)

	)

75 
	`XLAT_´oûssÜ_cx
(
x’_¡©e
, 
¡©e
);

76 #undeà
XLAT_´oûssÜ_cx_HNDL_dp


79 
	}
}

81 
£t_cx_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_pow”
 *
pow”
);

83 
	$com·t_£t_cx_pmšfo
(
ušt32_t
 
ıu
, 
com·t_´oûssÜ_pow”
 *
pow”
)

85 
x’_´oûssÜ_pow”
 *
x’_pow”
;

86 
xÏt_·ge_cu¼’t
;

88 
	`xÏt_m®loc_š™
(
xÏt_·ge_cu¼’t
);

90 
x’_pow”
 = 
	`xÏt_m®loc_¬¿y
(
xÏt_·ge_cu¼’t
,

91 
x’_´oûssÜ_pow”
, 1);

92 iàĞ
	`uÆik–y
(
x’_pow”
 =ğ
NULL
) )

93  -
EFAULT
;

95 
	#XLAT_´oûssÜ_pow”_HNDL_¡©es
(
_d_
, 
_s_
) do { \

96 
x’_´oûssÜ_cx_t
 *
x’_¡©es
 = 
NULL
; \

98 iàĞ
	`lik–y
((
_s_
)->
couÁ
 > 0) ) \

100 
	`XEN_GUEST_HANDLE
(
com·t_´oûssÜ_cx_t
è
¡©es
; \

101 
com·t_´oûssÜ_cx_t
 
¡©e
; \

102 
i
; \

104 
x’_¡©es
 = 
	`xÏt_m®loc_¬¿y
(
xÏt_·ge_cu¼’t
, \

105 
x’_´oûssÜ_cx_t
, (
_s_
)->
couÁ
); \

106 iàĞ
	`uÆik–y
(
x’_¡©es
 =ğ
NULL
) ) \

107  -
EFAULT
; \

109 iàĞ
	`uÆik–y
(!
	`com·t_hªdË_okay
((
_s_
)->
¡©es
, (_s_)->
couÁ
)) ) \

110  -
EFAULT
; \

111 
	`gue¡_äom_com·t_hªdË
(
¡©es
, (
_s_
)->states); \

113  
i
 = 0; i < 
_s_
->
couÁ
; i++ ) \

115 iàĞ
	`uÆik–y
(
	`cİy_äom_gue¡_off£t
(&
¡©e
, 
¡©es
, 
i
, 1)) ) \

116  -
EFAULT
; \

117 iàĞ
	`uÆik–y
(
	`cİy_äom_com·t_¡©e
(&
x’_¡©es
[
i
], &
¡©e
)) ) \

118  -
EFAULT
; \

122 
	`£t_x’_gue¡_hªdË
((
_d_
)->
¡©es
, 
x’_¡©es
); \

123 } 0)

	)

124 
	`XLAT_´oûssÜ_pow”
(
x’_pow”
, 
pow”
);

125 #undeà
XLAT_´oûssÜ_pow”_HNDL_¡©es


127  
	`£t_cx_pmšfo
(
ıu
, 
x’_pow”
);

128 
	}
}

	@x86_64/cpufreq.c

24 
	~<x’/cÚfig.h
>

25 
	~<x’/ty³s.h
>

26 
	~<x’/xm®loc.h
>

27 
	~<x’/gue¡_acûss.h
>

28 
	~<com·t/¶©fÜm.h
>

30 
DEFINE_XEN_GUEST_HANDLE
(
com·t_´oûssÜ_px_t
);

32 
	#xÏt_·ge_¡¬t
 (()
COMPAT_ARG_XLAT_VIRT_BASE
)

	)

34 
	#xÏt_m®loc_š™
(
xÏt_·ge_cu¼’t
) do { \

35 
xÏt_·ge_cu¼’t
 = 
xÏt_·ge_¡¬t
; \

36 } 0)

	)

38 *
xÏt_m®loc
(*
xÏt_·ge_cu¼’t
, 
size_t
 
size
);

40 
	#xÏt_m®loc_¬¿y
(
_p
, 
_t
, 
_c
è((_ˆ*è
	`xÏt_m®loc
(&_p, (_tè* _c))

	)

43 
£t_px_pmšfo
(
ušt32_t
 
ıu
, 
x’_´oûssÜ_³rfÜmªû
 *
³rf
);

46 
	$com·t_£t_px_pmšfo
(
ušt32_t
 
ıu
, 
com·t_´oûssÜ_³rfÜmªû
 *
³rf
)

48 
x’_´oûssÜ_³rfÜmªû
 *
x’_³rf
;

49 
xÏt_·ge_cu¼’t
;

51 
	`xÏt_m®loc_š™
(
xÏt_·ge_cu¼’t
);

53 
x’_³rf
 = 
	`xÏt_m®loc_¬¿y
(
xÏt_·ge_cu¼’t
,

54 
x’_´oûssÜ_³rfÜmªû
, 1);

55 iàĞ
	`uÆik–y
(
x’_³rf
 =ğ
NULL
) )

56  -
EFAULT
;

58 
	#XLAT_´oûssÜ_³rfÜmªû_HNDL_¡©es
(
_d_
, 
_s_
) do { \

59 
	`XEN_GUEST_HANDLE
(
com·t_´oûssÜ_px_t
è
¡©es
; \

60 iàĞ
	`uÆik–y
(!
	`com·t_hªdË_okay
((
_s_
)->
¡©es
, (_s_)->
¡©e_couÁ
)) ) \

61  -
EFAULT
; \

62 
	`gue¡_äom_com·t_hªdË
(
¡©es
, (
_s_
)->states); \

63 (
_d_
)->
¡©es
 = 
	`gue¡_hªdË_ÿ¡
(¡©es, 
x’_´oûssÜ_px_t
); \

64 } 0)

	)

66 
	`XLAT_´oûssÜ_³rfÜmªû
(
x’_³rf
, 
³rf
);

67 #undeà
XLAT_´oûssÜ_³rfÜmªû_HNDL_¡©es


69  
	`£t_px_pmšfo
(
ıu
, 
x’_³rf
);

70 
	}
}

	@x86_64/domain.c

6 
	~<x’/cÚfig.h
>

7 
	~<x’/ty³s.h
>

8 
	~<x’/gue¡_acûss.h
>

9 
	~<asm/hy³rÿÎ.h
>

10 
	~<com·t/vıu.h
>

12 
	#x’_vıu_šfo
 
vıu_šfo


	)

13 
CHECK_SIZE_
(, 
vıu_šfo
);

14 #undeà
x’_vıu_šfo


16 
	#x’_vıu_»gi¡”_vıu_šfo
 
vıu_»gi¡”_vıu_šfo


	)

17 
	gCHECK_vıu_»gi¡”_vıu_šfo
;

18 #undeà
x’_vıu_»gi¡”_vıu_šfo


20 
	#x’_vıu_g‘_physid
 
vıu_g‘_physid


	)

21 
	gCHECK_vıu_g‘_physid
;

22 #undeà
x’_vıu_g‘_physid


25 
¬ch_com·t_vıu_İ
(

26 
cmd
, 
vıu
 *
v
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

28 
rc
 = -
ENOSYS
;

30  
cmd
 )

32 
VCPUOP_»gi¡”_run¡©e_memÜy_¬—
:

34 
com·t_vıu_»gi¡”_run¡©e_memÜy_¬—
 
¬—
;

35 
com·t_vıu_run¡©e_šfo
 
šfo
;

37 
¬—
.
addr
.
p
 = 0;

39 
rc
 = -
EFAULT
;

40 iàĞ
	`cİy_äom_gue¡
(&
¬—
.
addr
.
h
, 
¬g
, 1) )

43 iàĞ
¬—
.
addr
.
h
.
c
 !ğ¬—.addr.
p
 ||

44 !
	`com·t_hªdË_okay
(
¬—
.
addr
.
h
, 1) )

47 
rc
 = 0;

48 
	`gue¡_äom_com·t_hªdË
(
v
->
run¡©e_gue¡
.
com·t
, 
¬—
.
addr
.
h
);

50 iàĞ
v
 =ğ
cu¼’t
 )

52 
	`XLAT_vıu_run¡©e_šfo
(&
šfo
, &
v
->
run¡©e
);

56 
vıu_run¡©e_šfo
 
run¡©e
;

58 
	`vıu_run¡©e_g‘
(
v
, &
run¡©e
);

59 
	`XLAT_vıu_run¡©e_šfo
(&
šfo
, &
run¡©e
);

61 
	`__cİy_to_gue¡
(
v
->
run¡©e_gue¡
.
com·t
, &
šfo
, 1);

66 
VCPUOP_»gi¡”_vıu_šfo
:

67 
VCPUOP_g‘_physid
:

68 
rc
 = 
	`¬ch_do_vıu_İ
(
cmd
, 
v
, 
¬g
);

72  
rc
;

73 
	}
}

	@x86_64/gdbstub.c

21 
	~<asm/debugg”.h
>

23 
	#GDB_REG64
(
r
è
	`gdb_wr™e_to_·ck‘_hex
Ô, (
u64
), 
ùx
)

	)

24 
	#GDB_REG32
(
r
è
	`gdb_wr™e_to_·ck‘_hex
Ô, (
u32
), 
ùx
)

	)

27 
	$gdb_¬ch_»ad_»g_¬¿y
(
ıu_u£r_»gs
 *
»gs
, 
gdb_cÚ‹xt
 *
ùx
)

29 
	`GDB_REG64
(
»gs
->
¿x
);

30 
	`GDB_REG64
(
»gs
->
rbx
);

31 
	`GDB_REG64
(
»gs
->
rcx
);

32 
	`GDB_REG64
(
»gs
->
rdx
);

33 
	`GDB_REG64
(
»gs
->
rsi
);

34 
	`GDB_REG64
(
»gs
->
rdi
);

35 
	`GDB_REG64
(
»gs
->
rbp
);

36 
	`GDB_REG64
(
»gs
->
r¥
);

38 
	`GDB_REG64
(
»gs
->
r8
);

39 
	`GDB_REG64
(
»gs
->
r9
);

40 
	`GDB_REG64
(
»gs
->
r10
);

41 
	`GDB_REG64
(
»gs
->
r11
);

42 
	`GDB_REG64
(
»gs
->
r12
);

43 
	`GDB_REG64
(
»gs
->
r13
);

44 
	`GDB_REG64
(
»gs
->
r14
);

45 
	`GDB_REG64
(
»gs
->
r15
);

47 
	`GDB_REG64
(
»gs
->
r
);

48 
	`GDB_REG32
(
»gs
->
eæags
);

50 
	`GDB_REG32
(
»gs
->
cs
);

51 
	`GDB_REG32
(
»gs
->
ss
);

52 
	`GDB_REG32
(
»gs
->
ds
);

53 
	`GDB_REG32
(
»gs
->
es
);

54 
	`GDB_REG32
(
»gs
->
fs
);

55 
	`GDB_REG32
(
»gs
->
gs
);

57 
	`gdb_£nd_·ck‘
(
ùx
);

58 
	}
}

61 
	$gdb_¬ch_wr™e_»g_¬¿y
(
ıu_u£r_»gs
 *
»gs
, cÚ¡ * 
buf
,

62 
gdb_cÚ‹xt
 *
ùx
)

64 
	`gdb_£nd_»¶y
("", 
ùx
);

65 
	}
}

68 
	$gdb_¬ch_»ad_»g
(
»gnum
, 
ıu_u£r_»gs
 *
»gs
,

69 
gdb_cÚ‹xt
 *
ùx
)

71 
»gnum
)

73 0: 
	`GDB_REG64
(
»gs
->
¿x
); ;

74 1: 
	`GDB_REG64
(
»gs
->
rbx
); ;

75 2: 
	`GDB_REG64
(
»gs
->
rcx
); ;

76 3: 
	`GDB_REG64
(
»gs
->
rdx
); ;

77 4: 
	`GDB_REG64
(
»gs
->
rsi
); ;

78 5: 
	`GDB_REG64
(
»gs
->
rdi
); ;

79 6: 
	`GDB_REG64
(
»gs
->
rbp
); ;

80 7: 
	`GDB_REG64
(
»gs
->
r¥
); ;

82 8: 
	`GDB_REG64
(
»gs
->
r8
); ;

83 9: 
	`GDB_REG64
(
»gs
->
r9
); ;

84 10: 
	`GDB_REG64
(
»gs
->
r10
); ;

85 11: 
	`GDB_REG64
(
»gs
->
r11
); ;

86 12: 
	`GDB_REG64
(
»gs
->
r12
); ;

87 13: 
	`GDB_REG64
(
»gs
->
r13
); ;

88 14: 
	`GDB_REG64
(
»gs
->
r14
); ;

89 15: 
	`GDB_REG64
(
»gs
->
r15
); ;

91 16: 
	`GDB_REG64
(
»gs
->
r
); ;

92 17: 
	`GDB_REG32
(
»gs
->
ræags
); ;

93 18: 
	`GDB_REG32
(
»gs
->
cs
); ;

94 19: 
	`GDB_REG32
(
»gs
->
ss
); ;

95 20: 
	`GDB_REG32
(
»gs
->
ds
); ;

96 21: 
	`GDB_REG32
(
»gs
->
es
); ;

97 22: 
	`GDB_REG32
(
»gs
->
fs
); ;

98 23: 
	`GDB_REG32
(
»gs
->
gs
); ;

100 
	`GDB_REG64
(0xbaadf00ddeadbeef);

103 
	`gdb_£nd_·ck‘
(
ùx
);

104 
	}
}

107 
	$gdb_¬ch_wr™e_»g
(
»gnum
, 
v®
,

108 
ıu_u£r_»gs
 *
»gs
, 
gdb_cÚ‹xt
 *
ùx
)

110 
»gnum
)

112 0: 
»gs
->
¿x
 = 
v®
; ;

113 1: 
»gs
->
rbx
 = 
v®
; ;

114 2: 
»gs
->
rcx
 = 
v®
; ;

115 3: 
»gs
->
rdx
 = 
v®
; ;

116 4: 
»gs
->
rsi
 = 
v®
; ;

117 5: 
»gs
->
rdi
 = 
v®
; ;

118 6: 
»gs
->
rbp
 = 
v®
; ;

119 7: 
»gs
->
r¥
 = 
v®
; ;

121 8: 
»gs
->
r8
 = 
v®
; ;

122 9: 
»gs
->
r9
 = 
v®
; ;

123 10: 
»gs
->
r10
 = 
v®
; ;

124 11: 
»gs
->
r11
 = 
v®
; ;

125 12: 
»gs
->
r12
 = 
v®
; ;

126 13: 
»gs
->
r13
 = 
v®
; ;

127 14: 
»gs
->
r14
 = 
v®
; ;

128 15: 
»gs
->
r15
 = 
v®
; ;

130 16: 
»gs
->
r
 = 
v®
; ;

131 17: 
»gs
->
ræags
 = (
u32
)
v®
; ;

132 18: 
»gs
->
cs
 = (
u16
)
v®
; ;

133 19: 
»gs
->
ss
 = (
u16
)
v®
; ;

134 20: 
»gs
->
ds
 = (
u16
)
v®
; ;

135 21: 
»gs
->
es
 = (
u16
)
v®
; ;

136 22: 
»gs
->
fs
 = (
u16
)
v®
; ;

137 23: 
»gs
->
gs
 = (
u16
)
v®
; ;

141 
	`gdb_£nd_»¶y
("OK", 
ùx
);

142 
	}
}

	@x86_64/machine_kexec.c

9 
	~<x’/ty³s.h
>

10 
	~<x’/k”Ãl.h
>

11 
	~<asm/·ge.h
>

12 
	~<public/kexec.h
>

14 
	$machše_kexec_g‘_x’
(
x’_kexec_¿nge_t
 *
¿nge
)

16 
¿nge
->
¡¬t
 = 
	`vœt_to_maddr
(
_¡¬t
);

17 
¿nge
->
size
 = 
	`vœt_to_maddr
(
_’d
è- (ìªge->
¡¬t
;

19 
	}
}

	@x86_64/mm.c

20 
	~<x’/cÚfig.h
>

21 
	~<x’/lib.h
>

22 
	~<x’/š™.h
>

23 
	~<x’/mm.h
>

24 
	~<x’/sched.h
>

25 
	~<x’/numa.h
>

26 
	~<x’/nodemask.h
>

27 
	~<x’/gue¡_acûss.h
>

28 
	~<asm/cu¼’t.h
>

29 
	~<asm/asm_deâs.h
>

30 
	~<asm/·ge.h
>

31 
	~<asm/æushb.h
>

32 
	~<asm/fixm­.h
>

33 
	~<asm/hy³rÿÎ.h
>

34 
	~<asm/m¤.h
>

35 
	~<asm/£tup.h
>

36 
	~<asm/numa.h
>

37 
	~<public/memÜy.h
>

40 
__»ad_mo¡ly
 
	gmax_pdx
;

41 
__»ad_mo¡ly
 
	gpâ_pdx_bÙtom_mask
 = ~0UL;

42 
__»ad_mo¡ly
 
	gma_va_bÙtom_mask
 = ~0UL;

43 
__»ad_mo¡ly
 
	gpâ_tİ_mask
 = 0;

44 
__»ad_mo¡ly
 
	gma_tİ_mask
 = 0;

45 
__»ad_mo¡ly
 
	gpâ_hŞe_mask
 = 0;

46 
__»ad_mo¡ly
 
	gpâ_pdx_hŞe_shiá
 = 0;

48 
__»ad_mo¡ly
 
	gm2p_com·t_v¡¬t
 = 
__HYPERVISOR_COMPAT_VIRT_START
;

51 
l4_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

52 
	gidË_pg_bË
[
L4_PAGETABLE_ENTRIES
];

55 
l3_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

56 
	gl3_id’tm­
[
L3_PAGETABLE_ENTRIES
];

57 
l2_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

58 
	gl2_id’tm­
[4*
L2_PAGETABLE_ENTRIES
];

61 
l3_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

62 
	gl3_x’m­
[
L3_PAGETABLE_ENTRIES
];

63 
l2_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

64 
	gl2_x’m­
[
L2_PAGETABLE_ENTRIES
];

67 
l3_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

68 
	gl3_boÙm­
[
L3_PAGETABLE_ENTRIES
];

69 
l2_pg’Œy_t
 
__©Œibu‹__
 ((
__£ùiÚ__
 (".bss.page_aligned")))

70 
	gl2_boÙm­
[
L2_PAGETABLE_ENTRIES
];

72 
	$__mâ_v®id
(
mâ
)

74  
	`lik–y
(
mâ
 < 
max_·ge
) &&

75 
	`lik–y
(!(
mâ
 & 
pâ_hŞe_mask
)) &&

76 
	`lik–y
(
	`‹¡_b™
(
	`pâ_to_pdx
(
mâ
è/ 
PDX_GROUP_COUNT
,

77 
pdx_group_v®id
));

78 
	}
}

80 *
	$®loc_x’_·g‘abË
()

82 
mâ
;

84 iàĞ!
—¾y_boÙ
 )

86 
·ge_šfo
 *
pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 0);

88 
	`BUG_ON
(!
dom0
 && !
pg
);

89  
pg
 ? 
	`·ge_to_vœt
Õgè: 
NULL
;

92 
mâ
 = 
	`®loc_boÙ_·ges
(1, 1);

93  
	`mâ_to_vœt
(
mâ
);

94 
	}
}

96 
l3_pg’Œy_t
 *
	$vœt_to_x’_l3e
(
v
)

98 
l4_pg’Œy_t
 *
¶4e
;

100 
¶4e
 = &
idË_pg_bË
[
	`l4_bË_off£t
(
v
)];

101 iàĞ!(
	`l4e_g‘_æags
(*
¶4e
è& 
_PAGE_PRESENT
) )

103 
l3_pg’Œy_t
 *
¶3e
 = 
	`®loc_x’_·g‘abË
();

105 iàĞ!
¶3e
 )

106  
NULL
;

107 
	`ş—r_·ge
(
¶3e
);

108 
	`l4e_wr™e
(
¶4e
, 
	`l4e_äom_·ddr
(
	`__·
(
¶3e
), 
__PAGE_HYPERVISOR
));

111  
	`l4e_to_l3e
(*
¶4e
è+ 
	`l3_bË_off£t
(
v
);

112 
	}
}

114 
l2_pg’Œy_t
 *
	$vœt_to_x’_l2e
(
v
)

116 
l3_pg’Œy_t
 *
¶3e
;

118 
¶3e
 = 
	`vœt_to_x’_l3e
(
v
);

119 iàĞ!
¶3e
 )

120  
NULL
;

122 iàĞ!(
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PRESENT
) )

124 
l2_pg’Œy_t
 *
¶2e
 = 
	`®loc_x’_·g‘abË
();

126 iàĞ!
¶2e
 )

127  
NULL
;

128 
	`ş—r_·ge
(
¶2e
);

129 
	`l3e_wr™e
(
¶3e
, 
	`l3e_äom_·ddr
(
	`__·
(
¶2e
), 
__PAGE_HYPERVISOR
));

132 
	`BUG_ON
(
	`l3e_g‘_æags
(*
¶3e
è& 
_PAGE_PSE
);

133  
	`l3e_to_l2e
(*
¶3e
è+ 
	`l2_bË_off£t
(
v
);

134 
	}
}

136 *
	$do_·ge_w®k
(
vıu
 *
v
, 
addr
)

138 
mâ
 = 
	`·g‘abË_g‘_pâ
(
v
->
¬ch
.
gue¡_bË
);

139 
l4_pg’Œy_t
 
l4e
, *
l4t
;

140 
l3_pg’Œy_t
 
l3e
, *
l3t
;

141 
l2_pg’Œy_t
 
l2e
, *
l2t
;

142 
l1_pg’Œy_t
 
l1e
, *
l1t
;

144 iàĞ
	`is_hvm_vıu
(
v
) )

145  
NULL
;

147 
l4t
 = 
	`mâ_to_vœt
(
mâ
);

148 
l4e
 = 
l4t
[
	`l4_bË_off£t
(
addr
)];

149 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

150 iàĞ!(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
) )

151  
NULL
;

153 
l3t
 = 
	`mâ_to_vœt
(
mâ
);

154 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
addr
)];

155 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

156 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
è|| !
	`mâ_v®id
(
mâ
) )

157  
NULL
;

158 iàĞ(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

159  
	`mâ_to_vœt
(
mâ
è+ (
addr
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

161 
l2t
 = 
	`mâ_to_vœt
(
mâ
);

162 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
addr
)];

163 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

164 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
è|| !
	`mâ_v®id
(
mâ
) )

165  
NULL
;

166 iàĞ(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) )

167  
	`mâ_to_vœt
(
mâ
è+ (
addr
 & ((1UL << 
L2_PAGETABLE_SHIFT
) - 1));

169 
l1t
 = 
	`mâ_to_vœt
(
mâ
);

170 
l1e
 = 
l1t
[
	`l1_bË_off£t
(
addr
)];

171 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

172 iàĞ!(
	`l1e_g‘_æags
(
l1e
è& 
_PAGE_PRESENT
è|| !
	`mâ_v®id
(
mâ
) )

173  
NULL
;

175  
	`mâ_to_vœt
(
mâ
è+ (
addr
 & ~
PAGE_MASK
);

176 
	}
}

178 
__š™
 
	$pâ_pdx_hŞe_£tup
(
mask
)

180 
i
, 
j
, 
bÙtom_shiá
 = 0, 
hŞe_shiá
 = 0;

188  
j
 = 
MAX_ORDER
-1; ; )

190 
i
 = 
	`fšd_Ãxt_z”o_b™
(&
mask
, 
BITS_PER_LONG
, 
j
);

191 
j
 = 
	`fšd_Ãxt_b™
(&
mask
, 
BITS_PER_LONG
, 
i
);

192 iàĞ
j
 >ğ
BITS_PER_LONG
 )

194 iàĞ
j
 - 
i
 > 
hŞe_shiá
 )

196 
hŞe_shiá
 = 
j
 - 
i
;

197 
bÙtom_shiá
 = 
i
;

200 iàĞ!
hŞe_shiá
 )

203 
	`´štk
(
KERN_INFO
 "PFN compression on bits %u...%u\n",

204 
bÙtom_shiá
, bÙtom_shiá + 
hŞe_shiá
 - 1);

206 
pâ_pdx_hŞe_shiá
 = 
hŞe_shiá
;

207 
pâ_pdx_bÙtom_mask
 = (1UL << 
bÙtom_shiá
) - 1;

208 
ma_va_bÙtom_mask
 = (
PAGE_SIZE
 << 
bÙtom_shiá
) - 1;

209 
pâ_hŞe_mask
 = ((1UL << 
hŞe_shiá
è- 1è<< 
bÙtom_shiá
;

210 
pâ_tİ_mask
 = ~(
pâ_pdx_bÙtom_mask
 | 
pâ_hŞe_mask
);

211 
ma_tİ_mask
 = 
pâ_tİ_mask
 << 
PAGE_SHIFT
;

212 
	}
}

217 
	smem_hÙadd_šfo


219 
	m¥â
;

220 
	m•â
;

221 
	mcur
;

224 
	$hÙadd_mem_v®id
(
pâ
, 
mem_hÙadd_šfo
 *
šfo
)

226  (
pâ
 < 
šfo
->
•â
 &&…â >ğšfo->
¥â
);

227 
	}
}

229 
	$®loc_hÙadd_mâ
(
mem_hÙadd_šfo
 *
šfo
)

231 
mâ
;

233 
	`ASSERT
((
šfo
->
cur
 + ( 1UL << 
PAGETABLE_ORDER
è< info->
•â
) &&

234 
šfo
->
cur
 >ğšfo->
¥â
);

236 
mâ
 = 
šfo
->
cur
;

237 
šfo
->
cur
 +ğ(1UL << 
PAGETABLE_ORDER
);

238  
mâ
;

239 
	}
}

241 
	#M2P_NO_MAPPED
 0

	)

242 
	#M2P_2M_MAPPED
 1

	)

243 
	#M2P_1G_MAPPED
 2

	)

244 
	$m2p_m­³d
(
¥â
)

246 
va
;

247 
l3_pg’Œy_t
 *
l3_ro_m±
;

248 
l2_pg’Œy_t
 *
l2_ro_m±
;

250 
va
 = 
RO_MPT_VIRT_START
 + 
¥â
 * (*
machše_to_phys_m­pšg
);

251 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
va
)]);

253  
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]) &

254 (
_PAGE_PRESENT
 |
_PAGE_PSE
))

256 
_PAGE_PSE
|
_PAGE_PRESENT
:

257  
M2P_1G_MAPPED
;

260 
_PAGE_PRESENT
:

263  
M2P_NO_MAPPED
;

266 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]);

268 ià(
	`l2e_g‘_æags
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
)

269  
M2P_2M_MAPPED
;

271  
M2P_NO_MAPPED
;

272 
	}
}

274 
	$sh¬e_hÙadd_m2p_bË
(
mem_hÙadd_šfo
 *
šfo
)

276 
i
, 
n
, 
v
, 
m2p_¡¬t_mâ
 = 0;

277 
l3_pg’Œy_t
 
l3e
;

278 
l2_pg’Œy_t
 
l2e
;

281  
v
 = 
RDWR_MPT_VIRT_START
;

282 
v
 !ğ
RDWR_MPT_VIRT_END
;

283 
v
 +ğ
n
 << 
PAGE_SHIFT
 )

285 
n
 = 
L2_PAGETABLE_ENTRIES
 * 
L1_PAGETABLE_ENTRIES
;

286 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
v
)])[

287 
	`l3_bË_off£t
(
v
)];

288 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

290 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

292 
n
 = 
L1_PAGETABLE_ENTRIES
;

293 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
v
)];

294 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

296 
m2p_¡¬t_mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

301  
i
 = 0; i < 
n
; i++ )

303 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
m2p_¡¬t_mâ
 + 
i
);

304 ià(
	`hÙadd_mem_v®id
(
m2p_¡¬t_mâ
 + 
i
, 
šfo
))

305 
	`sh¬e_x’_·ge_w™h_´iveged_gue¡s
(
·ge
, 
XENSHARE_»adÚly
);

309  
v
 = 
RDWR_COMPAT_MPT_VIRT_START
;

310 
v
 !ğ
RDWR_COMPAT_MPT_VIRT_END
;

311 
v
 +ğ1 << 
L2_PAGETABLE_SHIFT
 )

313 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
v
)])[

314 
	`l3_bË_off£t
(
v
)];

315 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

317 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
v
)];

318 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

320 
m2p_¡¬t_mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

322  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

324 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
m2p_¡¬t_mâ
 + 
i
);

325 ià(
	`hÙadd_mem_v®id
(
m2p_¡¬t_mâ
 + 
i
, 
šfo
))

326 
	`sh¬e_x’_·ge_w™h_´iveged_gue¡s
(
·ge
, 
XENSHARE_»adÚly
);

330 
	}
}

332 
	$de¡roy_com·t_m2p_m­pšg
(
mem_hÙadd_šfo
 *
šfo
)

334 
i
, 
va
, 
rwva
, 
±_pâ
;

335 
sm­
 = 
šfo
->
¥â
, 
em­
 = info->spfn;

337 
l3_pg’Œy_t
 *
l3_ro_m±
;

338 
l2_pg’Œy_t
 *
l2_ro_m±
;

340 iàĞ
sm­
 > ((
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2) )

343 iàĞ
em­
 > ((
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2) )

344 
em­
 = (
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2;

346 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)]);

348 
	`ASSERT
(
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)]è& 
_PAGE_PRESENT
);

350 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)]);

352  
i
 = 
sm­
; i < 
em­
; )

354 
va
 = 
HIRO_COMPAT_MPT_VIRT_START
 +

355 
i
 * (*
com·t_machše_to_phys_m­pšg
);

356 
rwva
 = 
RDWR_COMPAT_MPT_VIRT_START
 +

357 
i
 * (*
com·t_machše_to_phys_m­pšg
);

358 iàĞ
	`l2e_g‘_æags
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
 )

360 
±_pâ
 = 
	`l2e_g‘_pâ
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]);

361 iàĞ
	`hÙadd_mem_v®id
(
±_pâ
, 
šfo
) )

363 
	`de¡roy_x’_m­pšgs
(
rwva
,„wva +

364 (1UL << 
L2_PAGETABLE_SHIFT
));

365 
	`l2e_wr™e
(&
l2_ro_m±
[
	`l2_bË_off£t
(
va
)], 
	`l2e_em±y
());

369 
i
 +ğ1UL < (
L2_PAGETABLE_SHIFT
 - 2);

373 
	}
}

375 
	$de¡roy_m2p_m­pšg
(
mem_hÙadd_šfo
 *
šfo
)

377 
l3_pg’Œy_t
 *
l3_ro_m±
;

378 
i
, 
va
, 
rwva
;

379 
sm­
 = 
šfo
->
¥â
, 
em­
 = info->
•â
;

381 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
RO_MPT_VIRT_START
)]);

386 
i
 = 
sm­
; i < 
em­
;)

388 
±_pâ
;

389 
l2_pg’Œy_t
 *
l2_ro_m±
;

391 
va
 = 
RO_MPT_VIRT_START
 + 
i
 * (*
machše_to_phys_m­pšg
);

392 
rwva
 = 
RDWR_MPT_VIRT_START
 + 
i
 * (*
machše_to_phys_m­pšg
);

395 ià(!(
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
) ||

396 (
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]è& 
_PAGE_PSE
))

398 
i
 = ( i & ~((1UL << (
L3_PAGETABLE_SHIFT
 - 3)) - 1)) +

399 (1UL << (
L3_PAGETABLE_SHIFT
 - 3) );

403 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]);

404 ià(!(
	`l2e_g‘_æags
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
))

406 
i
 = ( i & ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1)) +

407 (1UL << (
L2_PAGETABLE_SHIFT
 - 3)) ;

411 
±_pâ
 = 
	`l2e_g‘_pâ
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]);

412 iàĞ
	`hÙadd_mem_v®id
(
±_pâ
, 
šfo
) )

414 
	`de¡roy_x’_m­pšgs
(
rwva
,„wv¨+ (1UL << 
L2_PAGETABLE_SHIFT
));

416 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]);

417 
	`l2e_wr™e
(&
l2_ro_m±
[
	`l2_bË_off£t
(
va
)], 
	`l2e_em±y
());

419 
i
 = ( i & ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1)) +

420 (1UL << (
L2_PAGETABLE_SHIFT
 - 3));

423 
	`de¡roy_com·t_m2p_m­pšg
(
šfo
);

426 
	`æush_b_®l
();

428 
	}
}

435 
	$£tup_com·t_m2p_bË
(
mem_hÙadd_šfo
 *
šfo
)

437 
i
, 
va
, 
sm­
, 
em­
, 
rwva
, 
•â
 = 
šfo
->epfn;

438 
n
, 
memæags
;

439 
l3_pg’Œy_t
 *
l3_ro_m±
 = 
NULL
;

440 
l2_pg’Œy_t
 *
l2_ro_m±
 = 
NULL
;

441 
·ge_šfo
 *
l1_pg
;

442 
”r
 = 0;

444 
sm­
 = 
šfo
->
¥â
 & (~((1UL << (
L2_PAGETABLE_SHIFT
 - 2)) -1));

450 ià((
sm­
 > ((
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2)) )

453 ià(
•â
 > (
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
))

454 
•â
 = (
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2;

456 
em­
 = ( (
•â
 + ((1UL << (
L2_PAGETABLE_SHIFT
 - 2)) - 1 )) &

457 ~((1UL << (
L2_PAGETABLE_SHIFT
 - 2)) - 1) );

459 
va
 = 
HIRO_COMPAT_MPT_VIRT_START
 +

460 
sm­
 * (*
com·t_machše_to_phys_m­pšg
);

461 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
va
)]);

463 
	`ASSERT
(
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
);

465 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]);

467 
	#MFN
(
x
è(((xè<< 
L2_PAGETABLE_SHIFT
è/ ())

	)

468 
	#CNT
 (((*
äame_bË
) & -(*frame_table)) / \

469 (*
com·t_machše_to_phys_m­pšg
))

	)

470 
	`BUILD_BUG_ON
(((*
äame_bË
) & -(*frame_table)) % \

471 (*
com·t_machše_to_phys_m­pšg
));

473  
i
 = 
sm­
; i < 
em­
; i +ğ(1UL << (
L2_PAGETABLE_SHIFT
 - 2)) )

475 
va
 = 
HIRO_COMPAT_MPT_VIRT_START
 +

476 
i
 * (*
com·t_machše_to_phys_m­pšg
);

478 
rwva
 = 
RDWR_COMPAT_MPT_VIRT_START
 +

479 
i
 * (*
com·t_machše_to_phys_m­pšg
);

481 ià(
	`l2e_g‘_æags
(
l2_ro_m±
[
	`l2_bË_off£t
(
va
)]è& 
_PAGE_PRESENT
)

484  
n
 = 0;‚ < 
CNT
; ++n)

485 iàĞ
	`mâ_v®id
(
i
 + 
n
 * 
PDX_GROUP_COUNT
) )

487 iàĞ
n
 =ğ
CNT
 )

490 
memæags
 = 
	`MEMF_node
(
	`phys_to_nid
(
i
 << 
PAGE_SHIFT
));

492 
l1_pg
 = 
	`mâ_to_·ge
(
	`®loc_hÙadd_mâ
(
šfo
));

493 
”r
 = 
	`m­_·ges_to_x’
(
rwva
, 
	`·ge_to_mâ
(
l1_pg
),

494 1UL << 
PAGETABLE_ORDER
,

495 
PAGE_HYPERVISOR
);

496 iàĞ
”r
 )

498 
	`mem£t
((*)
rwva
, 0x55, 1UL << 
L2_PAGETABLE_SHIFT
);

500 
	`l2e_wr™e
(&
l2_ro_m±
[
	`l2_bË_off£t
(
va
)], 
	`l2e_äom_·ge
(
l1_pg
, 
_PAGE_PSE
|
_PAGE_PRESENT
));

502 #undeà
CNT


503 #undeà
MFN


504  
”r
;

505 
	}
}

511 
	$£tup_m2p_bË
(
mem_hÙadd_šfo
 *
šfo
)

513 
i
, 
va
, 
sm­
, 
em­
;

514 
n
, 
memæags
;

515 
l2_pg’Œy_t
 *
l2_ro_m±
 = 
NULL
;

516 
l3_pg’Œy_t
 *
l3_ro_m±
 = 
NULL
;

517 
·ge_šfo
 *
l1_pg
, *
l2_pg
;

518 
»t
 = 0;

520 
	`ASSERT
(
	`l4e_g‘_æags
(
idË_pg_bË
[
	`l4_bË_off£t
(
RO_MPT_VIRT_START
)])

521 & 
_PAGE_PRESENT
);

522 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
RO_MPT_VIRT_START
)]);

524 
sm­
 = (
šfo
->
¥â
 & (~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) -1)));

525 
em­
 = ((
šfo
->
•â
 + ((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1 )) &

526 ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) -1));

528 
va
 = 
RO_MPT_VIRT_START
 + 
sm­
 * (*
machše_to_phys_m­pšg
);

530 
	#MFN
(
x
è(((xè<< 
L2_PAGETABLE_SHIFT
è/ ())

	)

531 
	#CNT
 (((*
äame_bË
) & -(*frame_table)) / \

532 (*
machše_to_phys_m­pšg
))

	)

534 
	`BUILD_BUG_ON
(((*
äame_bË
) & -(*frame_table)) % \

535 (*
machše_to_phys_m­pšg
));

537 
i
 = 
sm­
;

538  
i
 < 
em­
 )

540  
	`m2p_m­³d
(
i
) )

542 
M2P_1G_MAPPED
:

543 
i
 = ( i & ~((1UL << (
L3_PAGETABLE_SHIFT
 - 3)) - 1)) +

544 (1UL << (
L3_PAGETABLE_SHIFT
 - 3));

546 
M2P_2M_MAPPED
:

547 
i
 = (˜& ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1)) +

548 (1UL << (
L2_PAGETABLE_SHIFT
 - 3));

554 
va
 = 
RO_MPT_VIRT_START
 + 
i
 * (*
machše_to_phys_m­pšg
);

555 
memæags
 = 
	`MEMF_node
(
	`phys_to_nid
(
i
 << 
PAGE_SHIFT
));

557  
n
 = 0;‚ < 
CNT
; ++n)

558 iàĞ
	`mâ_v®id
(
i
 + 
n
 * 
PDX_GROUP_COUNT
) )

560 iàĞ
n
 =ğ
CNT
 )

561 
l1_pg
 = 
NULL
;

564 
l1_pg
 = 
	`mâ_to_·ge
(
	`®loc_hÙadd_mâ
(
šfo
));

565 
»t
 = 
	`m­_·ges_to_x’
(

566 
RDWR_MPT_VIRT_START
 + 
i
 * (),

567 
	`·ge_to_mâ
(
l1_pg
),

568 1UL << 
PAGETABLE_ORDER
,

569 
PAGE_HYPERVISOR
);

570 iàĞ
»t
 )

571 
”rÜ
;

572 
	`mem£t
((*)(
RDWR_MPT_VIRT_START
 + 
i
 * ()),

573 0x55, 1UL << 
L2_PAGETABLE_SHIFT
);

575 
	`ASSERT
(!(
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]) &

576 
_PAGE_PSE
));

577 iàĞ
	`l3e_g‘_æags
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]) &

578 
_PAGE_PRESENT
 )

579 
l2_ro_m±
 = 
	`l3e_to_l2e
(
l3_ro_m±
[
	`l3_bË_off£t
(
va
)]) +

580 
	`l2_bË_off£t
(
va
);

583 
l2_pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
memæags
);

585 ià(!
l2_pg
)

587 
»t
 = -
ENOMEM
;

588 
”rÜ
;

591 
l2_ro_m±
 = 
	`·ge_to_vœt
(
l2_pg
);

592 
	`ş—r_·ge
(
l2_ro_m±
);

593 
	`l3e_wr™e
(&
l3_ro_m±
[
	`l3_bË_off£t
(
va
)],

594 
	`l3e_äom_·ge
(
l2_pg
, 
__PAGE_HYPERVISOR
 | 
_PAGE_USER
));

595 
l2_ro_m±
 +ğ
	`l2_bË_off£t
(
va
);

599 
	`l2e_wr™e
(
l2_ro_m±
, 
	`l2e_äom_·ge
(
l1_pg
,

600  
_PAGE_PSE
|
_PAGE_USER
|
_PAGE_PRESENT
));

602 iàĞ!(()
l2_ro_m±
 & ~
PAGE_MASK
) )

603 
l2_ro_m±
 = 
NULL
;

604 
i
 +ğĞ1UL << (
L2_PAGETABLE_SHIFT
 - 3));

606 #undeà
CNT


607 #undeà
MFN


609 
»t
 = 
	`£tup_com·t_m2p_bË
(
šfo
);

610 
”rÜ
:

611  
»t
;

612 
	}
}

614 
__š™
 
	$·gšg_š™
()

616 
i
, 
m±_size
, 
va
;

617 
n
, 
memæags
;

618 
l3_pg’Œy_t
 *
l3_ro_m±
;

619 
l2_pg’Œy_t
 *
l2_ro_m±
 = 
NULL
;

620 
·ge_šfo
 *
l1_pg
, *
l2_pg
, *
l3_pg
;

626 iàĞ
mem_hÙ¶ug
 )

628 
va
;

630  
va
 = 
DIRECTMAP_VIRT_START
;

631 
va
 < 
DIRECTMAP_VIRT_END
;

632 
va
 +ğ(1UL << 
L4_PAGETABLE_SHIFT
) )

634 iàĞ!(
	`l4e_g‘_æags
(
idË_pg_bË
[
	`l4_bË_off£t
(
va
)]) &

635 
_PAGE_PRESENT
) )

637 
l3_pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 0);

638 iàĞ!
l3_pg
 )

639 
nomem
;

640 
l3_ro_m±
 = 
	`·ge_to_vœt
(
l3_pg
);

641 
	`ş—r_·ge
(
l3_ro_m±
);

642 
	`l4e_wr™e
(&
idË_pg_bË
[
	`l4_bË_off£t
(
va
)],

643 
	`l4e_äom_·ge
(
l3_pg
, 
__PAGE_HYPERVISOR
));

649 iàĞ(
l3_pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 0)) == NULL )

650 
nomem
;

651 
l3_ro_m±
 = 
	`·ge_to_vœt
(
l3_pg
);

652 
	`ş—r_·ge
(
l3_ro_m±
);

653 
	`l4e_wr™e
(&
idË_pg_bË
[
	`l4_bË_off£t
(
RO_MPT_VIRT_START
)],

654 
	`l4e_äom_·ge
(
l3_pg
, 
__PAGE_HYPERVISOR
 | 
_PAGE_USER
));

660 
m±_size
 = (
max_·ge
 * 
BYTES_PER_LONG
è+ (1UL << 
L2_PAGETABLE_SHIFT
) - 1;

661 
m±_size
 &ğ~((1UL << 
L2_PAGETABLE_SHIFT
) - 1UL);

662 
	#MFN
(
x
è(((xè<< 
L2_PAGETABLE_SHIFT
è/ ())

	)

663 
	#CNT
 (((*
äame_bË
) & -(*frame_table)) / \

664 (*
machše_to_phys_m­pšg
))

	)

665 
	`BUILD_BUG_ON
(((*
äame_bË
) & ~(*frame_table)) % \

666 (*
machše_to_phys_m­pšg
));

667  
i
 = 0; i < (
m±_size
 >> 
L2_PAGETABLE_SHIFT
); i++ )

669 
	`BUILD_BUG_ON
(
RO_MPT_VIRT_START
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

670 
va
 = 
RO_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
);

671 
memæags
 = 
	`MEMF_node
(
	`phys_to_nid
(
i
 <<

672 (
L2_PAGETABLE_SHIFT
 - 3 + 
PAGE_SHIFT
)));

674 iàĞ
ıu_has_·ge1gb
 &&

675 !(()
l2_ro_m±
 & ~
PAGE_MASK
) &&

676 (
m±_size
 >> 
L3_PAGETABLE_SHIFT
è> (
i
 >> 
PAGETABLE_ORDER
) )

678 
k
, 
hŞes
;

680  
hŞes
 = 
k
 = 0; k < 1 << 
PAGETABLE_ORDER
; ++k)

682  
n
 = 0;‚ < 
CNT
; ++n)

683 iàĞ
	`mâ_v®id
(
	`MFN
(
i
 + 
k
è+ 
n
 * 
PDX_GROUP_COUNT
) )

685 iàĞ
n
 =ğ
CNT
 )

686 ++
hŞes
;

688 iàĞ
k
 =ğ
hŞes
 )

690 
i
 +ğ(1UL << 
PAGETABLE_ORDER
) - 1;

693 iàĞ
hŞes
 == 0 &&

694 (
l1_pg
 = 
	`®loc_domh—p_·ges
(
NULL
, 2 * 
PAGETABLE_ORDER
,

695 
memæags
)è!ğ
NULL
 )

697 
	`m­_·ges_to_x’
(

698 
RDWR_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
),

699 
	`·ge_to_mâ
(
l1_pg
),

700 1UL << (2 * 
PAGETABLE_ORDER
),

701 
PAGE_HYPERVISOR
);

702 
	`mem£t
((*)(
RDWR_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
)),

703 0x77, 1UL << 
L3_PAGETABLE_SHIFT
);

705 
	`ASSERT
(!
	`l2_bË_off£t
(
va
));

707 
	`l3e_wr™e
(&
l3_ro_m±
[
	`l3_bË_off£t
(
va
)],

708 
	`l3e_äom_·ge
(
l1_pg
,

709  
_PAGE_PSE
|
_PAGE_USER
|
_PAGE_PRESENT
));

710 
i
 +ğ(1UL << 
PAGETABLE_ORDER
) - 1;

715  
n
 = 0;‚ < 
CNT
; ++n)

716 iàĞ
	`mâ_v®id
(
	`MFN
(
i
è+ 
n
 * 
PDX_GROUP_COUNT
) )

718 iàĞ
n
 =ğ
CNT
 )

719 
l1_pg
 = 
NULL
;

720 iàĞ(
l1_pg
 = 
	`®loc_domh—p_·ges
(
NULL
, 
PAGETABLE_ORDER
,

721 
memæags
)è=ğ
NULL
 )

722 
nomem
;

725 
	`m­_·ges_to_x’
(

726 
RDWR_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
),

727 
	`·ge_to_mâ
(
l1_pg
),

728 1UL << 
PAGETABLE_ORDER
,

729 
PAGE_HYPERVISOR
);

730 
	`mem£t
((*)(
RDWR_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
)),

731 0x55, 1UL << 
L2_PAGETABLE_SHIFT
);

733 iàĞ!(()
l2_ro_m±
 & ~
PAGE_MASK
) )

735 iàĞ(
l2_pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 
memæags
)) == NULL )

736 
nomem
;

737 
l2_ro_m±
 = 
	`·ge_to_vœt
(
l2_pg
);

738 
	`ş—r_·ge
(
l2_ro_m±
);

739 
	`l3e_wr™e
(&
l3_ro_m±
[
	`l3_bË_off£t
(
va
)],

740 
	`l3e_äom_·ge
(
l2_pg
, 
__PAGE_HYPERVISOR
 | 
_PAGE_USER
));

741 
	`ASSERT
(!
	`l2_bË_off£t
(
va
));

744 iàĞ
l1_pg
 )

745 
	`l2e_wr™e
(
l2_ro_m±
, 
	`l2e_äom_·ge
(

746 
l1_pg
, 
_PAGE_PSE
|
_PAGE_USER
|
_PAGE_PRESENT
));

747 
l2_ro_m±
++;

749 #undeà
CNT


750 #undeà
MFN


753 
	`BUILD_BUG_ON
(
	`l4_bË_off£t
(
RDWR_MPT_VIRT_START
) !=

754 
	`l4_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
));

755 
l3_ro_m±
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(

756 
HIRO_COMPAT_MPT_VIRT_START
)]);

757 iàĞ(
l2_pg
 = 
	`®loc_domh—p_·ge
(
NULL
, 0)) == NULL )

758 
nomem
;

759 
com·t_idË_pg_bË_l2
 = 
l2_ro_m±
 = 
	`·ge_to_vœt
(
l2_pg
);

760 
	`ş—r_·ge
(
l2_ro_m±
);

761 
	`l3e_wr™e
(&
l3_ro_m±
[
	`l3_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
)],

762 
	`l3e_äom_·ge
(
l2_pg
, 
__PAGE_HYPERVISOR
));

763 
l2_ro_m±
 +ğ
	`l2_bË_off£t
(
HIRO_COMPAT_MPT_VIRT_START
);

765 
m±_size
 = (m±_siz>> 1è+ (1UL << (
L2_PAGETABLE_SHIFT
 - 1));

766 iàĞ
m±_size
 > 
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
 )

767 
m±_size
 = 
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
;

768 
m±_size
 &ğ~((1UL << 
L2_PAGETABLE_SHIFT
) - 1UL);

769 iàĞ(
m2p_com·t_v¡¬t
 + 
m±_size
è< 
MACH2PHYS_COMPAT_VIRT_END
 )

770 
m2p_com·t_v¡¬t
 = 
MACH2PHYS_COMPAT_VIRT_END
 - 
m±_size
;

771 
	#MFN
(
x
è(((xè<< 
L2_PAGETABLE_SHIFT
è/ ())

	)

772 
	#CNT
 (((*
äame_bË
) & -(*frame_table)) / \

773 (*
com·t_machše_to_phys_m­pšg
))

	)

774 
	`BUILD_BUG_ON
(((*
äame_bË
) & ~(*frame_table)) % \

775 (*
com·t_machše_to_phys_m­pšg
));

776  
i
 = 0; i < (
m±_size
 >> 
L2_PAGETABLE_SHIFT
); i++, 
l2_ro_m±
++ )

778 
memæags
 = 
	`MEMF_node
(
	`phys_to_nid
(
i
 <<

779 (
L2_PAGETABLE_SHIFT
 - 2 + 
PAGE_SHIFT
)));

780  
n
 = 0;‚ < 
CNT
; ++n)

781 iàĞ
	`mâ_v®id
(
	`MFN
(
i
è+ 
n
 * 
PDX_GROUP_COUNT
) )

783 iàĞ
n
 =ğ
CNT
 )

785 iàĞ(
l1_pg
 = 
	`®loc_domh—p_·ges
(
NULL
, 
PAGETABLE_ORDER
,

786 
memæags
)è=ğ
NULL
 )

787 
nomem
;

788 
	`m­_·ges_to_x’
(

789 
RDWR_COMPAT_MPT_VIRT_START
 + (
i
 << 
L2_PAGETABLE_SHIFT
),

790 
	`·ge_to_mâ
(
l1_pg
),

791 1UL << 
PAGETABLE_ORDER
,

792 
PAGE_HYPERVISOR
);

793 
	`mem£t
((*)(
RDWR_COMPAT_MPT_VIRT_START
 +

794 (
i
 << 
L2_PAGETABLE_SHIFT
)),

796 1UL << 
L2_PAGETABLE_SHIFT
);

798 
	`l2e_wr™e
(
l2_ro_m±
, 
	`l2e_äom_·ge
(
l1_pg
, 
_PAGE_PSE
|
_PAGE_PRESENT
));

800 #undeà
CNT


801 #undeà
MFN


804 
	`l4e_wr™e
(&
idË_pg_bË
[
	`l4_bË_off£t
(
LINEAR_PT_VIRT_START
)],

805 
	`l4e_äom_·ddr
(
	`__·
(
idË_pg_bË
), 
__PAGE_HYPERVISOR
));

808 
nomem
:

809 
	`·nic
("Notƒnough memory for m2pable\n");

810 
	}
}

812 
__š™
 
	$£tup_idË_·g‘abË
()

815 
	`l4e_wr™e
(&
idË_pg_bË
[
	`l4_bË_off£t
(
PERDOMAIN_VIRT_START
)],

816 
	`l4e_äom_·ge
(

817 
	`vœt_to_·ge
(
idË_vıu
[0]->
domaš
->
¬ch
.
mm_³rdomaš_l3
),

818 
__PAGE_HYPERVISOR
));

819 
	}
}

821 
__š™
 
	$z­_low_m­pšgs
()

823 
	`BUG_ON
(
	`num_Úlše_ıus
() != 1);

826 
	`l4e_wr™e
(&
idË_pg_bË
[0], 
	`l4e_em±y
());

827 
	`æush_loÿl
(
FLUSH_TLB_GLOBAL
);

830 
	`m­_·ges_to_x’
(
BOOT_TRAMPOLINE
, BOOT_TRAMPOLINE >> 
PAGE_SHIFT
,

831 0x10, 
__PAGE_HYPERVISOR
);

832 
	}
}

834 *
	$com·t_¬g_xÏt_vœt_ba£
()

836  
cu¼’t
->
¬ch
.
com·t_¬g_xÏt
;

837 
	}
}

839 
	$£tup_com·t_¬g_xÏt
(
vıu
 *
v
)

841 
Üd”
 = 
	`g‘_Üd”_äom_by‹s
(
COMPAT_ARG_XLAT_SIZE
);

842 
·ge_šfo
 *
pg
;

844 
pg
 = 
	`®loc_domh—p_·ges
(
NULL
, 
Üd”
, 0);

845 iàĞ
pg
 =ğ
NULL
 )

846  -
ENOMEM
;

848 
v
->
¬ch
.
com·t_¬g_xÏt
 = 
	`·ge_to_vœt
(
pg
);

850 
	}
}

852 
	$ä“_com·t_¬g_xÏt
(
vıu
 *
v
)

854 
Üd”
 = 
	`g‘_Üd”_äom_by‹s
(
COMPAT_ARG_XLAT_SIZE
);

855 iàĞ
v
->
¬ch
.
com·t_¬g_xÏt
 !ğ
NULL
 )

856 
	`ä“_domh—p_·ges
(
	`vœt_to_·ge
(
v
->
¬ch
.
com·t_¬g_xÏt
), 
Üd”
);

857 
v
->
¬ch
.
com·t_¬g_xÏt
 = 
NULL
;

858 
	}
}

860 
	$ş—nup_äame_bË
(
mem_hÙadd_šfo
 *
šfo
)

862 
sva
, 
eva
;

863 
l3_pg’Œy_t
 
l3e
;

864 
l2_pg’Œy_t
 
l2e
;

865 
¥â
, 
•â
;

867 
¥â
 = 
šfo
->spfn;

868 
•â
 = 
šfo
->epfn;

870 
sva
 = ()
	`pdx_to_·ge
(
	`pâ_to_pdx
(
¥â
));

871 
eva
 = ()
	`pdx_to_·ge
(
	`pâ_to_pdx
(
•â
));

874 
	`mem£t
(
	`mâ_to_·ge
(
¥â
), -1,

875 ()
	`mâ_to_·ge
(
•â
è- ()mâ_to_·ge(
¥â
));

877 
sva
 < 
eva
)

879 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
sva
)])[

880 
	`l3_bË_off£t
(
sva
)];

881 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) ||

882 (
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

884 
sva
 = (sv¨& ~((1UL << 
L3_PAGETABLE_SHIFT
) - 1)) +

885 (1UL << 
L3_PAGETABLE_SHIFT
);

889 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
sva
)];

890 
	`ASSERT
(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
);

892 iàĞ(
	`l2e_g‘_æags
(
l2e
è& (
_PAGE_PRESENT
 | 
_PAGE_PSE
)) ==

893 (
_PAGE_PSE
 | 
_PAGE_PRESENT
) )

895 ià(
	`hÙadd_mem_v®id
(
	`l2e_g‘_pâ
(
l2e
), 
šfo
))

896 
	`de¡roy_x’_m­pšgs
(
sva
 & ~((1UL << 
L2_PAGETABLE_SHIFT
) - 1),

897 ((
sva
 & ~((1UL << 
L2_PAGETABLE_SHIFT
) -1 )) +

898 (1UL << 
L2_PAGETABLE_SHIFT
) - 1));

900 
sva
 = (sv¨& ~((1UL << 
L2_PAGETABLE_SHIFT
) -1 )) +

901 (1UL << 
L2_PAGETABLE_SHIFT
);

905 
	`ASSERT
(
	`l1e_g‘_æags
(
	`l2e_to_l1e
(
l2e
)[
	`l1_bË_off£t
(
sva
)]) &

906 
_PAGE_PRESENT
);

907 
sva
 = (sv¨& ~((1UL << 
PAGE_SHIFT
) - 1)) +

908 (1UL << 
PAGE_SHIFT
);

912 
	`æush_b_®l
();

913 
	}
}

915 
	$£tup_äam‘abË_chunk
(*
¡¬t
, *
’d
,

916 
mem_hÙadd_šfo
 *
šfo
)

918 
s
 = ()
¡¬t
;

919 
e
 = ()
’d
;

920 
mâ
;

921 
”r
;

923 
	`ASSERT
(!(
s
 & ((1 << 
L2_PAGETABLE_SHIFT
) - 1)));

924 
	`ASSERT
(!(
e
 & ((1 << 
L2_PAGETABLE_SHIFT
) - 1)));

926  ; 
s
 < 
e
; s +ğ(1UL << 
L2_PAGETABLE_SHIFT
))

928 
mâ
 = 
	`®loc_hÙadd_mâ
(
šfo
);

929 
”r
 = 
	`m­_·ges_to_x’
(
s
, 
mâ
, 1UL << 
PAGETABLE_ORDER
,

930 
PAGE_HYPERVISOR
);

931 iàĞ
”r
 )

932  
”r
;

934 
	`mem£t
(
¡¬t
, -1, 
s
 - ()start);

937 
	}
}

939 
	$ex‹nd_äame_bË
(
mem_hÙadd_šfo
 *
šfo
)

941 
cidx
, 
nidx
, 
eidx
, 
¥â
, 
•â
;

943 
¥â
 = 
šfo
->spfn;

944 
•â
 = 
šfo
->epfn;

946 
eidx
 = (
	`pâ_to_pdx
(
•â
è+ 
PDX_GROUP_COUNT
 - 1) / PDX_GROUP_COUNT;

947 
nidx
 = 
cidx
 = 
	`pâ_to_pdx
(
¥â
)/
PDX_GROUP_COUNT
;

949 
	`ASSERT
Ğ
	`pâ_to_pdx
(
•â
è<ğ(
DIRECTMAP_SIZE
 >> 
PAGE_SHIFT
) &&

950 (
	`pâ_to_pdx
(
•â
è<ğ
FRAMETABLE_SIZE
 / (
·ge_šfo
)) );

952 iàĞ
	`‹¡_b™
(
cidx
, 
pdx_group_v®id
) )

953 
cidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
eidx
, cidx);

955 iàĞ
cidx
 >ğ
eidx
 )

958  
cidx
 < 
eidx
 )

960 
”r
;

962 
nidx
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
eidx
, 
cidx
);

963 iàĞ
nidx
 >ğ
eidx
 )

964 
nidx
 = 
eidx
;

965 
”r
 = 
	`£tup_äam‘abË_chunk
(
	`pdx_to_·ge
(
cidx
 * 
PDX_GROUP_COUNT
 ),

966 
	`pdx_to_·ge
(
nidx
 * 
PDX_GROUP_COUNT
),

967 
šfo
);

968 iàĞ
”r
 )

969  
”r
;

971 
cidx
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
eidx
, 
nidx
);

974 
	`mem£t
(
	`mâ_to_·ge
(
¥â
), 0,

975 ()
	`mâ_to_·ge
(
•â
è- ()mâ_to_·ge(
¥â
));

977 
	}
}

979 
__š™
 
	$sub¬ch_š™_memÜy
()

981 
i
, 
n
, 
v
, 
m2p_¡¬t_mâ
;

982 
l3_pg’Œy_t
 
l3e
;

983 
l2_pg’Œy_t
 
l2e
;

985 
	`BUILD_BUG_ON
(
RDWR_MPT_VIRT_START
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

986 
	`BUILD_BUG_ON
(
RDWR_MPT_VIRT_END
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

988  
v
 = 
RDWR_MPT_VIRT_START
;

989 
v
 !ğ
RDWR_MPT_VIRT_END
;

990 
v
 +ğ
n
 << 
PAGE_SHIFT
 )

992 
n
 = 
L2_PAGETABLE_ENTRIES
 * 
L1_PAGETABLE_ENTRIES
;

993 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
v
)])[

994 
	`l3_bË_off£t
(
v
)];

995 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

997 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

999 
n
 = 
L1_PAGETABLE_ENTRIES
;

1000 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
v
)];

1001 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

1003 
m2p_¡¬t_mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

1007 
m2p_¡¬t_mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

1010  
i
 = 0; i < 
n
; i++ )

1012 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
m2p_¡¬t_mâ
 + 
i
);

1013 
	`sh¬e_x’_·ge_w™h_´iveged_gue¡s
(
·ge
, 
XENSHARE_»adÚly
);

1017  
v
 = 
RDWR_COMPAT_MPT_VIRT_START
;

1018 
v
 !ğ
RDWR_COMPAT_MPT_VIRT_END
;

1019 
v
 +ğ1 << 
L2_PAGETABLE_SHIFT
 )

1021 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
v
)])[

1022 
	`l3_bË_off£t
(
v
)];

1023 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

1025 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
v
)];

1026 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) )

1028 
m2p_¡¬t_mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

1030  
i
 = 0; i < 
L1_PAGETABLE_ENTRIES
; i++ )

1032 
·ge_šfo
 *
·ge
 = 
	`mâ_to_·ge
(
m2p_¡¬t_mâ
 + 
i
);

1033 
	`sh¬e_x’_·ge_w™h_´iveged_gue¡s
(
·ge
, 
XENSHARE_»adÚly
);

1036 
	}
}

1038 
sub¬ch_memÜy_İ
(
İ
, 
	$XEN_GUEST_HANDLE
(è
¬g
)

1040 
x’_machphys_mâ_li¡
 
xmml
;

1041 
l3_pg’Œy_t
 
l3e
;

1042 
l2_pg’Œy_t
 
l2e
;

1043 
v
;

1044 
x’_pâ_t
 
mâ
, 
Ï¡_mâ
;

1045 
i
;

1046 
rc
 = 0;

1048  
İ
 )

1050 
XENMEM_machphys_mâ_li¡
:

1051 iàĞ
	`cİy_äom_gue¡
(&
xmml
, 
¬g
, 1) )

1052  -
EFAULT
;

1054 
	`BUILD_BUG_ON
(
RDWR_MPT_VIRT_START
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

1055 
	`BUILD_BUG_ON
(
RDWR_MPT_VIRT_END
 & ((1UL << 
L3_PAGETABLE_SHIFT
) - 1));

1056  
i
 = 0, 
v
 = 
RDWR_MPT_VIRT_START
, 
Ï¡_mâ
 = 0;

1057 (
i
 !ğ
xmml
.
max_ex‹Ás
) &&

1058 (
v
 < ()(
machše_to_phys_m­pšg
 + 
max_·ge
));

1059 
i
++, 
v
 +ğ1UL << 
L2_PAGETABLE_SHIFT
 )

1061 
l3e
 = 
	`l4e_to_l3e
(
idË_pg_bË
[
	`l4_bË_off£t
(
v
)])[

1062 
	`l3_bË_off£t
(
v
)];

1063 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

1064 
mâ
 = 
Ï¡_mâ
;

1065 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) )

1067 
l2e
 = 
	`l3e_to_l2e
(
l3e
)[
	`l2_bË_off£t
(
v
)];

1068 iàĞ
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
 )

1069 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

1071 
mâ
 = 
Ï¡_mâ
;

1075 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
)

1076 + (
	`l2_bË_off£t
(
v
è<< 
PAGETABLE_ORDER
);

1078 
	`ASSERT
(
mâ
);

1079 iàĞ
	`cİy_to_gue¡_off£t
(
xmml
.
ex‹Á_¡¬t
, 
i
, &
mâ
, 1) )

1080  -
EFAULT
;

1081 
Ï¡_mâ
 = 
mâ
;

1084 
xmml
.
Ä_ex‹Ás
 = 
i
;

1085 iàĞ
	`cİy_to_gue¡
(
¬g
, &
xmml
, 1) )

1086  -
EFAULT
;

1091 
rc
 = -
ENOSYS
;

1095  
rc
;

1096 
	}
}

1098 
	$do_¡ack_sw™ch
(
ss
, 
e¥
)

1100 #ià
	`defšed
(
ENABLE_PGD
)||defšed(
ENABLE_INTROSPECT
)

1101 
Şd_e¥
;

1102 
Şd_e¥
 = 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
;

1104 
	`fixup_gue¡_¡ack_£ËùÜ
(
cu¼’t
->
domaš
, 
ss
);

1105 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_ss
 = 
ss
;

1106 
cu¼’t
->
¬ch
.
gue¡_cÚ‹xt
.
k”Ãl_¥
 = 
e¥
;

1107 #ifdeà
ENABLE_INTROSPECT


1108 ià(
mši_aùiv©ed
) {

1109 
	`upd©e_gue¡_sk
(
Şd
, 
e¥
);

1110 
	`©omic_šc
(&
mši_couÁ
);

1111 
	`upd©e_gue¡_sk
(
Şd_e¥
, 
e¥
);

1112 
	`©omic_dec
(&
mši_couÁ
);

1115 #ifdeà
ENABLE_PGD


1116 ià(
mši_aùiv©ed
) {

1117 
	`©omic_šc
(&
mši_couÁ
);

1118 #ifdeà
ENABLE_REGIONING5


1121 ià(
cu¼’t
->
cu¼’t_k¡ack
) {

1122 
	`MYASSERT
(
cu¼’t
->
cu¼’t_k¡ack
 =ğ
Şd_e¥
);

1124 
cu¼’t
->
cu¼’t_k¡ack
 = 
e¥
;

1125 
	`©omic_dec
(&
mši_couÁ
);

1129 
	}
}

1131 
	$do_£t_£gm’t_ba£
(
which
, 
ba£
)

1133 
vıu
 *
v
 = 
cu¼’t
;

1134 
»t
 = 0;

1136  
which
 )

1138 
SEGBASE_FS
:

1139 iàĞ
	`wrm¤_§ã
(
MSR_FS_BASE
, 
ba£
) )

1140 
»t
 = -
EFAULT
;

1142 
v
->
¬ch
.
gue¡_cÚ‹xt
.
fs_ba£
 = 
ba£
;

1145 
SEGBASE_GS_USER
:

1146 iàĞ
	`wrm¤_§ã
(
MSR_SHADOW_GS_BASE
, 
ba£
) )

1147 
»t
 = -
EFAULT
;

1149 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_u£r
 = 
ba£
;

1152 
SEGBASE_GS_KERNEL
:

1153 iàĞ
	`wrm¤_§ã
(
MSR_GS_BASE
, 
ba£
) )

1154 
»t
 = -
EFAULT
;

1156 
v
->
¬ch
.
gue¡_cÚ‹xt
.
gs_ba£_k”Ãl
 = 
ba£
;

1159 
SEGBASE_GS_USER_SEL
:

1160 
__asm__
 
	`__vŞ©e__
 (

1163 " "
§ã_sw­gs
" \n"

1168 
	`_ASM_EXTABLE
(1b, 2b)

1169 : : "r" (
ba£
&0xffff) );

1173 
»t
 = -
EINVAL
;

1177  
»t
;

1178 
	}
}

1182 
	$check_desütÜ
(cÚ¡ 
domaš
 *
dom
, 
desc_¡ruù
 *
d
)

1184 
u32
 
a
 = 
d
->a, 
b
 = d->b;

1185 
u16
 
cs
;

1186 
d¶
;

1189 iàĞ!(
b
 & 
_SEGMENT_P
) )

1190 
good
;

1193 
d¶
 = (
b
 >> 13) & 3;

1194 
	`__fixup_gue¡_£ËùÜ
(
dom
, 
d¶
);

1195 
b
 = (b & ~
_SEGMENT_DPL
è| (
d¶
 << 13);

1198 iàĞ(
b
 & 
_SEGMENT_S
) )

1200 iàĞ
	`is_pv_32b™_domaš
(
dom
) )

1202 
ba£
, 
lim™
;

1204 iàĞ
b
 & 
_SEGMENT_L
 )

1205 
bad
;

1212 
ba£
 = (
b
 & (0xfà<< 24)è| ((b & 0xffè<< 16è| (
a
 >> 16);

1214 
lim™
 = (
b
 & 0xf0000è| (
a
 & 0xffff);

1215 
lim™
++;

1217 iàĞ(
b
 & 
_SEGMENT_G
) )

1218 
lim™
 <<= 12;

1220 iàĞ(
ba£
 =ğ0è&& (
lim™
 > 
	`HYPERVISOR_COMPAT_VIRT_START
(
dom
)) )

1222 
a
 |= 0x0000ffff;

1223 
b
 |= 0x000f0000;

1227 
good
;

1231 iàĞ(
b
 & 
_SEGMENT_TYPE
) == 0x000 )

1232 
good
;

1235 iàĞ(
b
 & 
_SEGMENT_TYPE
) != 0xc00 )

1236 
bad
;

1239 
cs
 = 
a
 >> 16;

1240 iàĞ!
	`gue¡_g©e_£ËùÜ_okay
(
dom
, 
cs
) )

1241 
bad
;

1252 
b
 &ğ~
_SEGMENT_DPL
;

1253 
cs
 = (c & ~3è| 
d¶
;

1254 
a
 = (¨& 0xffffUè| (
cs
 << 16);

1257 iàĞ
b
 & (
	`is_pv_32b™_domaš
(
dom
) ? 0xe0 : 0xff) )

1258 
bad
;

1260 
good
:

1261 
d
->
a
 =‡;

1262 
d
->
b
 = b;

1264 
bad
:

1266 
	}
}

1268 
	$·geçuÉ_by_memadd
(
addr
, 
ıu_u£r_»gs
 *
»gs
)

1270 
domaš
 *
d
 = 
cu¼’t
->domain;

1272  
mem_hÙ¶ug
 && 
	`gue¡_mode
(
»gs
è&& 
	`is_pv_32b™_domaš
(
d
) &&

1273 (
addr
 >ğ
	`HYPERVISOR_COMPAT_VIRT_START
(
d
)) &&

1274 (
addr
 < 
MACH2PHYS_COMPAT_VIRT_END
);

1275 
	}
}

1277 
	$hªdË_memadd_çuÉ
(
addr
, 
ıu_u£r_»gs
 *
»gs
)

1279 
domaš
 *
d
 = 
cu¼’t
->domain;

1280 
l4_pg’Œy_t
 *
¶4e
 = 
NULL
;

1281 
l4_pg’Œy_t
 
l4e
;

1282 
l3_pg’Œy_t
 *
¶3e
 = 
NULL
;

1283 
l3_pg’Œy_t
 
l3e
;

1284 
l2_pg’Œy_t
 *
¶2e
 = 
NULL
;

1285 
l2_pg’Œy_t
 
l2e
, 
idË_l2e
;

1286 
mâ
, 
idË_šdex
;

1287 
»t
 = 0;

1289 ià(!
	`is_pv_32Ú64_domaš
(
d
))

1292 iàĞ(
addr
 < 
	`HYPERVISOR_COMPAT_VIRT_START
(
d
)) ||

1293 (
addr
 >ğ
MACH2PHYS_COMPAT_VIRT_END
) )

1296 
mâ
 = (
	`»ad_ü3
()è>> 
PAGE_SHIFT
;

1298 
¶4e
 = 
	`m­_domaš_·ge
(
mâ
);

1300 
l4e
 = 
¶4e
[0];

1302 ià(!(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
))

1303 
unm­
;

1305 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

1307 
¶3e
 = 
	`m­_domaš_·ge
(
mâ
);

1309 
l3e
 = 
¶3e
[3];

1311 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) )

1312 
unm­
;

1314 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

1315 
¶2e
 = 
	`m­_domaš_·ge
(
mâ
);

1317 
l2e
 = 
¶2e
[
	`l2_bË_off£t
(
addr
)];

1319 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
))

1320 
unm­
;

1322 
idË_šdex
 = (
	`l2_bË_off£t
(
addr
) -

1323 
	`COMPAT_L2_PAGETABLE_FIRST_XEN_SLOT
(
d
))/

1324 (
l2_pg’Œy_t
);

1325 
idË_l2e
 = 
com·t_idË_pg_bË_l2
[
idË_šdex
];

1326 ià(!(
	`l2e_g‘_æags
(
idË_l2e
è& 
_PAGE_PRESENT
))

1327 
unm­
;

1329 
	`memıy
(&
¶2e
[
	`l2_bË_off£t
(
addr
)],

1330 &
com·t_idË_pg_bË_l2
[
idË_šdex
],

1331 (
l2_pg’Œy_t
));

1333 
»t
 = 
EXCRET_çuÉ_fixed
;

1335 
unm­
:

1336 iàĞ
¶4e
 )

1337 
	`unm­_domaš_·ge
(
¶4e
);

1338 iàĞ
¶3e
 )

1339 
	`unm­_domaš_·ge
(
¶3e
);

1340 iàĞ
¶2e
 )

1341 
	`unm­_domaš_·ge
(
¶2e
);

1343  
»t
;

1344 
	}
}

1346 
	$domaš_£t_®loc_b™size
(
domaš
 *
d
)

1348 iàĞ!
	`is_pv_32Ú64_domaš
(
d
) ||

1349 (
	`MACH2PHYS_COMPAT_NR_ENTRIES
(
d
è>ğ
max_·ge
) ||

1350 
d
->
¬ch
.
phy§ddr_b™size
 > 0 )

1352 
d
->
¬ch
.
phy§ddr_b™size
 =

1354 
	`æs
(
	`MACH2PHYS_COMPAT_NR_ENTRIES
(
d
)) - 1

1356 + 
PAGE_SHIFT
;

1357 
	}
}

1359 
	$domaš_şamp_®loc_b™size
(
domaš
 *
d
, 
b™s
)

1361 iàĞ(
d
 =ğ
NULL
è|| (d->
¬ch
.
phy§ddr_b™size
 == 0) )

1362  
b™s
;

1363  
	`mš
(
d
->
¬ch
.
phy§ddr_b™size
, 
b™s
);

1364 
	}
}

1366 
	$Œªsãr_·ges_to_h—p
(
mem_hÙadd_šfo
 *
šfo
)

1368 
i
;

1369 
·ge_šfo
 *
pg
;

1375 
i
 = 
šfo
->
¥â
; i < info->
cur
; i++)

1377 
pg
 = 
	`mâ_to_·ge
(
i
);

1378 
pg
->
couÁ_šfo
 = 
PGC_¡©e_šu£
;

1381 
	`š™_domh—p_·ges
(
	`pâ_to_·ddr
(
šfo
->
cur
),…â_to_·ddr(šfo->
•â
));

1384 
	}
}

1386 
	$mem_hÙadd_check
(
¥â
, 
•â
)

1388 
s
, 
e
, 
Ëngth
, 
sidx
, 
eidx
;

1390 iàĞ(
¥â
 >ğ
•â
) )

1393 ià(
	`pâ_to_pdx
(
•â
è> (
FRAMETABLE_SIZE
 / (*
äame_bË
)))

1396 iàĞ(
¥â
 | 
•â
è& ((1UL << 
PAGETABLE_ORDER
) - 1) )

1399 iàĞ(
¥â
 | 
•â
è& 
pâ_hŞe_mask
 )

1403 
sidx
 = ((
	`pâ_to_pdx
(
¥â
è+ 
PDX_GROUP_COUNT
 - 1) & ~(PDX_GROUP_COUNT - 1))

1404 / 
PDX_GROUP_COUNT
;

1405 
eidx
 = (
	`pâ_to_pdx
(
•â
 - 1è& ~(
PDX_GROUP_COUNT
 - 1)) / PDX_GROUP_COUNT;

1406 ià(
sidx
 >ğ
eidx
)

1409 
s
 = 
	`fšd_Ãxt_z”o_b™
(
pdx_group_v®id
, 
eidx
, 
sidx
);

1410 iàĞ
s
 > 
eidx
 )

1412 
e
 = 
	`fšd_Ãxt_b™
(
pdx_group_v®id
, 
eidx
, 
s
);

1413 iàĞ
e
 < 
eidx
 )

1417 
s
 = (
¥â
 & ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1));

1418 
e
 = (
•â
 + (1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1) &

1419 ~((1UL << (
L2_PAGETABLE_SHIFT
 - 3)) - 1);

1421 
Ëngth
 = (
e
 - 
s
) * ();

1423 
s
 = (
¥â
 & ~((1UL << (
L2_PAGETABLE_SHIFT
 - 2)) - 1));

1424 
e
 = (
•â
 + (1UL << (
L2_PAGETABLE_SHIFT
 - 2)) - 1) &

1425 ~((1UL << (
L2_PAGETABLE_SHIFT
 - 2)) - 1);

1427 
e
 = 
	`mš_t
(,ƒ,

1428 (
RDWR_COMPAT_MPT_VIRT_END
 - 
RDWR_COMPAT_MPT_VIRT_START
) >> 2);

1430 iàĞ
e
 > 
s
 )

1431 
Ëngth
 +ğ(
e
 -
s
) * ();

1433 
s
 = 
	`pâ_to_pdx
(
¥â
è& ~(
PDX_GROUP_COUNT
 - 1);

1434 
e
 = ( 
	`pâ_to_pdx
(
•â
è+ (
PDX_GROUP_COUNT
 - 1) ) & ~(PDX_GROUP_COUNT - 1);

1436 
Ëngth
 +ğ(
e
 - 
s
è* (
·ge_šfo
);

1438 ià((
Ëngth
 >> 
PAGE_SHIFT
è> (
•â
 - 
¥â
))

1442 
	}
}

1448 
	$memÜy_add
(
¥â
, 
•â
, 
pxm
)

1450 
mem_hÙadd_šfo
 
šfo
;

1451 
»t
, 
node
;

1452 
Şd_max
 = 
max_·ge
, 
Şd_tÙ®
 = 
tÙ®_·ges
;

1453 
Şd_node_¡¬t
, 
Şd_node_¥ª
, 
Üig_Úlše
;

1454 
i
;

1456 
	`d´štk
(
XENLOG_INFO
, "memÜy_add %lx ~ %lx w™h…xm %x\n", 
¥â
, 
•â
, 
pxm
);

1458 iàĞ!
	`mem_hÙadd_check
(
¥â
, 
•â
) )

1459  -
EINVAL
;

1461 iàĞ(
node
 = 
	`£tup_node
(
pxm
)) == -1 )

1462  -
EINVAL
;

1464 iàĞ!
	`v®id_numa_¿nge
(
¥â
 << 
PAGE_SHIFT
, 
•â
 << PAGE_SHIFT, 
node
) )

1466 
	`d´štk
(
XENLOG_WARNING
, "spfn %lx ~ƒpfn %lx…xm %x‚ode %x"

1467 "i nÙ‚um¨v®id", 
¥â
, 
•â
, 
pxm
, 
node
);

1468  -
EINVAL
;

1471 
»t
 = 
	`m­_·ges_to_x’
(()
	`mâ_to_vœt
(
¥â
), spfn,

1472 
•â
 - 
¥â
, 
PAGE_HYPERVISOR
);

1473 iàĞ
»t
 )

1474  
»t
;

1476 
Şd_node_¡¬t
 = 
	`NODE_DATA
(
node
)->
node_¡¬t_pâ
;

1477 
Şd_node_¥ª
 = 
	`NODE_DATA
(
node
)->
node_¥ªÃd_·ges
;

1478 
Üig_Úlše
 = 
	`node_Úlše
(
node
);

1480 iàĞ!
Üig_Úlše
 )

1482 
	`d´štk
(
XENLOG_WARNING
, "nod%x…xm %x i nÙ oÆše\n",
node
, 
pxm
);

1483 
	`NODE_DATA
(
node
)->
node_id
 =‚ode;

1484 
	`NODE_DATA
(
node
)->
node_¡¬t_pâ
 = 
¥â
;

1485 
	`NODE_DATA
(
node
)->
node_¥ªÃd_·ges
 =

1486 
•â
 - 
	`node_¡¬t_pâ
(
node
);

1487 
	`node_£t_Úlše
(
node
);

1490 ià(
	`NODE_DATA
(
node
)->
node_¡¬t_pâ
 > 
¥â
)

1491 
	`NODE_DATA
(
node
)->
node_¡¬t_pâ
 = 
¥â
;

1492 ià(
	`node_’d_pâ
(
node
è< 
•â
)

1493 
	`NODE_DATA
(
node
)->
node_¥ªÃd_·ges
 = 
•â
 - 
	`node_¡¬t_pâ
(node);

1496 
»t
 = -
EINVAL
;

1497 
šfo
.
¥â
 = spfn;

1498 
šfo
.
•â
 =ƒpfn;

1499 
šfo
.
cur
 = 
¥â
;

1501 
»t
 = 
	`ex‹nd_äame_bË
(&
šfo
);

1502 ià(
»t
)

1503 
de¡roy_äam‘abË
;

1506 ià(
max_·ge
 < 
•â
)

1508 
max_·ge
 = 
•â
;

1509 
max_pdx
 = 
	`pâ_to_pdx
(
max_·ge
 - 1) + 1;

1511 
tÙ®_·ges
 +ğ
•â
 - 
¥â
;

1513 
	`£t_pdx_¿nge
(
¥â
, 
•â
);

1514 
»t
 = 
	`£tup_m2p_bË
(&
šfo
);

1516 iàĞ
»t
 )

1517 
de¡roy_m2p
;

1519 iàĞ!
	`Ãed_iommu
(
dom0
) )

1521  
i
 = 
¥â
; i < 
•â
; i++ )

1522 iàĞ
	`iommu_m­_·ge
(
dom0
, 
i
, i, 
IOMMUF_»adabË
|
IOMMUF_wr™abË
) )

1524 iàĞ
i
 !ğ
•â
 )

1526 
i
-- > 
Şd_max
)

1527 
	`iommu_unm­_·ge
(
dom0
, 
i
);

1528 
de¡roy_m2p
;

1533 
	`Œªsãr_·ges_to_h—p
(&
šfo
);

1535 
	`sh¬e_hÙadd_m2p_bË
(&
šfo
);

1539 
de¡roy_m2p
:

1540 
	`de¡roy_m2p_m­pšg
(&
šfo
);

1541 
max_·ge
 = 
Şd_max
;

1542 
tÙ®_·ges
 = 
Şd_tÙ®
;

1543 
max_pdx
 = 
	`pâ_to_pdx
(
max_·ge
 - 1) + 1;

1544 
de¡roy_äam‘abË
:

1545 
	`ş—nup_äame_bË
(&
šfo
);

1546 
	`de¡roy_x’_m­pšgs
(()
	`mâ_to_vœt
(
¥â
),

1547 ()
	`mâ_to_vœt
(
•â
));

1549 iàĞ!
Üig_Úlše
 )

1550 
	`node_£t_ofæše
(
node
);

1551 
	`NODE_DATA
(
node
)->
node_¡¬t_pâ
 = 
Şd_node_¡¬t
;

1552 
	`NODE_DATA
(
node
)->
node_¥ªÃd_·ges
 = 
Şd_node_¥ª
;

1554 
	`de¡roy_x’_m­pšgs
(()
	`mâ_to_vœt
(
¥â
),

1555 ()
	`mâ_to_vœt
(
•â
));

1556  
»t
;

1557 
	}
}

1559 
	~"com·t/mm.c
"

	@x86_64/mmconf-fam10h.c

5 
	~<x’/lib.h
>

6 
	~<x’/aıi.h
>

7 
	~<x’/pci.h
>

8 
	~<x’/pci_»gs.h
>

9 
	~<x’/š™.h
>

10 
	~<x’/dmi.h
>

11 
	~<asm/amd.h
>

12 
	~<asm/m¤.h
>

13 
	~<asm/´oûssÜ.h
>

15 
	~"mmcÚfig.h
"

17 
	spci_ho¡bridge_´obe
 {

18 
u32
 
	mbus
;

19 
u32
 
	m¦Ù
;

20 
u32
 
	mv’dÜ
;

21 
u32
 
	mdeviû
;

24 
u64
 
__ıuš™d©a
 
	gçm10h_pci_mmcÚf_ba£
;

26 
pci_ho¡bridge_´obe
 
	gpci_´obes
[] 
	g__ıuš™d©a
 = {

27 { 0, 0x18, 
PCI_VENDOR_ID_AMD
, 0x1200 },

28 { 0xff, 0, 
PCI_VENDOR_ID_AMD
, 0x1200 },

31 
	#UNIT
 (1ULL << 
FAM10H_MMIO_CONF_BASE_SHIFT
)

	)

32 
	#MASK
 (~(
UNIT
 - 1))

	)

33 
	#SIZE
 (
UNIT
 << 8)

	)

35 
	#FAM10H_PCI_MMCONF_BASE
 (0xfcULL<<32)

	)

36 
	#BASE_VALID
(
b
è((bè+ 
SIZE
 <ğ(0xfdULL<<32è|| (bè>ğ(1ULL<<40))

	)

37 
__š™
 
	$g‘_çm10h_pci_mmcÚf_ba£
()

39 
i
, 
j
, 
bus
, 
¦Ù
, 
hi_mmio_num
;

40 
u32
 
add»ss
;

41 
u64
 
v®
, 
tom2
, 
¡¬t
, 
’d
;

42 
	s¿nge
 {

43 
u64
 
¡¬t
, 
’d
;

44 } 
¿nge
[8];

46 
i
 = 0; i < 
	`ARRAY_SIZE
(
pci_´obes
); i++) {

47 
u32
 
id
;

48 
u16
 
deviû
;

49 
u16
 
v’dÜ
;

51 
bus
 = 
pci_´obes
[
i
].bus;

52 
¦Ù
 = 
pci_´obes
[
i
].slot;

53 
id
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 0, 
PCI_VENDOR_ID
);

55 
v’dÜ
 = 
id
 & 0xffff;

56 
deviû
 = (
id
>>16) & 0xffff;

57 ià(
pci_´obes
[
i
].
v’dÜ
 == vendor &&

58 
pci_´obes
[
i
].
deviû
 == device)

62 ià(
i
 >ğ
	`ARRAY_SIZE
(
pci_´obes
))

66 
add»ss
 = 
MSR_K8_SYSCFG
;

67 
	`rdm¤l
(
add»ss
, 
v®
);

70 ià(!(
v®
 & (1<<21))) {

71 
tom2
 = 1ULL << 32;

74 
add»ss
 = 
MSR_K8_TOP_MEM2
;

75 
	`rdm¤l
(
add»ss
, 
v®
);

76 
tom2
 = 
	`max
(
v®
 & 0xffffff800000ULL, 1ULL << 32);

83 
hi_mmio_num
 = 
i
 = 0; i < 8; i++) {

84 
v®
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 1, 0x80 + (
i
 << 3));

85 ià(!(
v®
 & 3))

88 
¡¬t
 = (
v®
 & 0xffffff00) << 8;

89 
v®
 = 
	`pci_cÚf_»ad32
(
bus
, 
¦Ù
, 1, 0x84 + (
i
 << 3));

90 
’d
 = ((
v®
 & 0xffffff00) << 8) | 0xffff;

92 ià(
’d
 < 
tom2
)

95 
j
 = 
hi_mmio_num
; j; --j) {

96 ià(
¿nge
[
j
 - 1].
¡¬t
 < start)

98 
¿nge
[
j
] =„ange[j - 1];

100 
¿nge
[
j
].
¡¬t
 = start;

101 
¿nge
[
j
].
’d
 =ƒnd;

102 
hi_mmio_num
++;

105 
¡¬t
 = 
FAM10H_PCI_MMCONF_BASE
;

106 ià(
¡¬t
 <ğ
tom2
)

107 
¡¬t
 = (
tom2
 + 2 * 
UNIT
 - 1è& 
MASK
;

109 ià(!
hi_mmio_num
)

110 
out
;

112 ià(
¿nge
[
hi_mmio_num
 - 1].
’d
 < 
¡¬t
)

113 
out
;

114 ià(
¿nge
[0].
¡¬t
 > s¹ + 
SIZE
)

115 
out
;

118 
¡¬t
 = (
¿nge
[0].¡¬ˆ& 
MASK
è- 
UNIT
;

119 ià(
¡¬t
 > 
tom2
 && 
	`BASE_VALID
(start))

120 
out
;

121 
¡¬t
 = (
¿nge
[
hi_mmio_num
 - 1].
’d
 + 
UNIT
è& 
MASK
;

122 ià(
	`BASE_VALID
(
¡¬t
))

123 
out
;

125 
i
 = 1; i < 
hi_mmio_num
; i++) {

126 
¡¬t
 = (
¿nge
[
i
 - 1].
’d
 + 
UNIT
è& 
MASK
;

127 
’d
 = 
¿nge
[
i
].
¡¬t
 & 
MASK
;

128 ià(
’d
 >ğ
¡¬t
 + 
SIZE
 && 
	`BASE_VALID
(start))

129 
out
;

133 
out
:

134 
çm10h_pci_mmcÚf_ba£
 = 
¡¬t
;

135 
	}
}

137 
__ıuš™
 
	$çm10h_check_’abË_mmcfg
()

139 
u64
 
v®
;

140 
boŞ_t
 
´št
 = 
İt_ıu_šfo
;

142 ià(!(
pci_´obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

145 
	`rdm¤l
(
MSR_FAM10H_MMIO_CONF_BASE
, 
v®
);

148 ià(
v®
 & 
FAM10H_MMIO_CONF_ENABLE
) {

149 
bu¢b™s
;

150 
bu¢b™s
 = (
v®
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

151 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

154 ià(!
aıi_pci_di§bËd
 || 
bu¢b™s
 >= 8) {

155 
u64
 
ba£
 = 
v®
 & 
MASK
;

157 ià(!
çm10h_pci_mmcÚf_ba£
) {

158 
çm10h_pci_mmcÚf_ba£
 = 
ba£
;

161 ià(
çm10h_pci_mmcÚf_ba£
 =ğ
ba£
)

171 ià(!
çm10h_pci_mmcÚf_ba£
) {

172 
	`g‘_çm10h_pci_mmcÚf_ba£
();

173 
´št
 = 1;

175 ià(!
çm10h_pci_mmcÚf_ba£
) {

176 
pci_´obe
 &ğ~
PCI_CHECK_ENABLE_AMD_MMCONF
;

180 ià(
´št
)

181 
	`´štk
(
KERN_INFO
 "EÇbË MMCONFIG oÀAMD Fam10h‡ˆ%"
PRIx64
"\n",

182 
çm10h_pci_mmcÚf_ba£
);

183 
v®
 &ğ~((
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
) |

184 (
FAM10H_MMIO_CONF_BUSRANGE_MASK
<<
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
));

185 
v®
 |ğ
çm10h_pci_mmcÚf_ba£
 | (8 << 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) |

186 
FAM10H_MMIO_CONF_ENABLE
;

187 
	`wrm¤l
(
MSR_FAM10H_MMIO_CONF_BASE
, 
v®
);

188 
	}
}

190 
__š™
 
	$£t_check_’abË_amd_mmcÚf
(
dmi_sy¡em_id
 *
d
)

192 
pci_´obe
 |ğ
PCI_CHECK_ENABLE_AMD_MMCONF
;

194 
	}
}

196 
dmi_sy¡em_id
 
__š™d©a
 
	gmmcÚf_dmi_bË
[] = {

198 .
ÿÎback
 = 
£t_check_’abË_amd_mmcÚf
,

199 .
	gid’t
 = "Sun Microsystems Machine",

200 .
	gm©ches
 = {

201 
DMI_MATCH
(
DMI_SYS_VENDOR
, "Sun Microsystems"),

207 
__š™
 
	$check_’abË_amd_mmcÚf_dmi
()

209 
	`dmi_check_sy¡em
(
mmcÚf_dmi_bË
);

210 
	}
}

	@x86_64/mmconfig-shared.c

15 
	~<x’/cÚfig.h
>

16 
	~<x’/š™.h
>

17 
	~<x’/mm.h
>

18 
	~<x’/aıi.h
>

19 
	~<x’/xm®loc.h
>

20 
	~<x’/pci.h
>

21 
	~<x’/pci_»gs.h
>

22 
	~<asm/e820.h
>

23 
	~<asm/m¤.h
>

24 
	~<asm/m¤-šdex.h
>

26 
	~"mmcÚfig.h
"

28 
__š™d©a
 
	gknown_bridge
;

29 
	gpci_´obe
 = 
PCI_PROBE_CONF1
 | 
PCI_PROBE_MMCONF
;

31 
__š™
 
	$·r£_mmcfg
(*
s
)

33 *
ss
;

36 
ss
 = 
	`¡rchr
(
s
, ',');

37 iàĞ
ss
 )

38 *
ss
 = '\0';

40 iàĞ!
	`·r£_boŞ
(
s
) )

41 
pci_´obe
 &ğ~
PCI_PROBE_MMCONF
;

42 iàĞ!
	`¡rcmp
(
s
, "amd_fam10") || !strcmp(s, "amd-fam10") )

43 
pci_´obe
 |ğ
PCI_CHECK_ENABLE_AMD_MMCONF
;

45 
s
 = 
ss
 + 1;

46 }  
ss
 );

47 
	}
}

48 
cu¡om_·¿m
("mmcfg", 
·r£_mmcfg
);

50 cÚ¡ 
__š™
 *
	$pci_mmcfg_e7520
()

52 
u32
 
wš
;

53 
wš
 = 
	`pci_cÚf_»ad16
(0, 0, 0, 0xce);

55 
wš
 = win & 0xf000;

56 if(
wš
 == 0x0000 || win == 0xf000)

57 
pci_mmcfg_cÚfig_num
 = 0;

59 
pci_mmcfg_cÚfig_num
 = 1;

60 
pci_mmcfg_cÚfig
 = 
	`xm®loc
(
aıi_mcfg_®loÿtiÚ
);

61 ià(!
pci_mmcfg_cÚfig
)

62  
NULL
;

63 
	`mem£t
(
pci_mmcfg_cÚfig
, 0, (pci_mmcfg_config[0]));

64 
pci_mmcfg_cÚfig
[0].
add»ss
 = 
wš
 << 16;

65 
pci_mmcfg_cÚfig
[0].
pci_£gm’t
 = 0;

66 
pci_mmcfg_cÚfig
[0].
¡¬t_bus_numb”
 = 0;

67 
pci_mmcfg_cÚfig
[0].
’d_bus_numb”
 = 255;

71 
	}
}

73 cÚ¡ 
__š™
 *
	$pci_mmcfg_š‹l_945
()

75 
u32
 
pc›xb¬
, 
mask
 = 0, 
Ën
 = 0;

77 
pci_mmcfg_cÚfig_num
 = 1;

79 
pc›xb¬
 = 
	`pci_cÚf_»ad32
(0, 0, 0, 0x48);

82 ià(!(
pc›xb¬
 & 1))

83 
pci_mmcfg_cÚfig_num
 = 0;

86 (
pc›xb¬
 >> 1) & 3) {

88 
mask
 = 0xf0000000U;

89 
Ën
 = 0x10000000U;

92 
mask
 = 0xf8000000U;

93 
Ën
 = 0x08000000U;

96 
mask
 = 0xfc000000U;

97 
Ën
 = 0x04000000U;

100 
pci_mmcfg_cÚfig_num
 = 0;

106 ià((
pc›xb¬
 & 
mask
) & 0x0fffffffU)

107 
pci_mmcfg_cÚfig_num
 = 0;

110 ià((
pc›xb¬
 & 
mask
) >= 0xf0000000U)

111 
pci_mmcfg_cÚfig_num
 = 0;

113 ià(
pci_mmcfg_cÚfig_num
) {

114 
pci_mmcfg_cÚfig
 = 
	`xm®loc
(
aıi_mcfg_®loÿtiÚ
);

115 ià(!
pci_mmcfg_cÚfig
)

116  
NULL
;

117 
	`mem£t
(
pci_mmcfg_cÚfig
, 0, (pci_mmcfg_config[0]));

118 
pci_mmcfg_cÚfig
[0].
add»ss
 = 
pc›xb¬
 & 
mask
;

119 
pci_mmcfg_cÚfig
[0].
pci_£gm’t
 = 0;

120 
pci_mmcfg_cÚfig
[0].
¡¬t_bus_numb”
 = 0;

121 
pci_mmcfg_cÚfig
[0].
’d_bus_numb”
 = (
Ën
 >> 20) - 1;

125 
	}
}

127 cÚ¡ 
__š™
 *
	$pci_mmcfg_amd_çm10h
()

129 
ušt32_t
 
add»ss
;

130 
ušt64_t
 
ba£
, 
m¤_cÚ‹Á
;

131 
i
;

132 
£gnb™s
 = 0, 
bu¢b™s
;

134 ià(!(
pci_´obe
 & 
PCI_CHECK_ENABLE_AMD_MMCONF
))

135  
NULL
;

137 
add»ss
 = 
MSR_FAM10H_MMIO_CONF_BASE
;

138 ià(
	`rdm¤_§ã
(
add»ss
, 
m¤_cÚ‹Á
))

139  
NULL
;

142 ià(!(
m¤_cÚ‹Á
 & 
FAM10H_MMIO_CONF_ENABLE
))

143  
NULL
;

145 
ba£
 = 
m¤_cÚ‹Á
 &

146 (
FAM10H_MMIO_CONF_BASE_MASK
<<
FAM10H_MMIO_CONF_BASE_SHIFT
);

148 
bu¢b™s
 = (
m¤_cÚ‹Á
 >> 
FAM10H_MMIO_CONF_BUSRANGE_SHIFT
) &

149 
FAM10H_MMIO_CONF_BUSRANGE_MASK
;

155 ià(!
bu¢b™s
)

156  
NULL
;

158 ià(
bu¢b™s
 > 8) {

159 
£gnb™s
 = 
bu¢b™s
 - 8;

160 
bu¢b™s
 = 8;

163 
pci_mmcfg_cÚfig_num
 = (1 << 
£gnb™s
);

164 
pci_mmcfg_cÚfig
 = 
	`xm®loc_¬¿y
(
aıi_mcfg_®loÿtiÚ
,

165 
pci_mmcfg_cÚfig_num
);

166 ià(!
pci_mmcfg_cÚfig
)

167  
NULL
;

169 
i
 = 0; i < (1 << 
£gnb™s
); i++) {

170 
pci_mmcfg_cÚfig
[
i
].
add»ss
 = 
ba£
 + (()i << 28);

171 
pci_mmcfg_cÚfig
[
i
].
pci_£gm’t
 = i;

172 
pci_mmcfg_cÚfig
[
i
].
¡¬t_bus_numb”
 = 0;

173 
pci_mmcfg_cÚfig
[
i
].
’d_bus_numb”
 = (1 << 
bu¢b™s
) - 1;

177 
	}
}

179 cÚ¡ 
__š™
 *
	$pci_mmcfg_nvidŸ_mı55
()

181 
boŞ_t
 
__š™d©a
 
mı55_checked
;

182 
bus
, 
i
;

184 cÚ¡ 
u32
 
extcfg_»gnum
 = 0x90;

185 cÚ¡ 
u32
 
extcfg_’abË_mask
 = 1<<31;

186 cÚ¡ 
u32
 
extcfg_¡¬t_mask
 = 0xff<<16;

187 cÚ¡ 
extcfg_¡¬t_shiá
 = 16;

188 cÚ¡ 
u32
 
extcfg_size_mask
 = 0x3<<28;

189 cÚ¡ 
extcfg_size_shiá
 = 28;

190 cÚ¡ 
extcfg_sizebus
[] = {0xff, 0x7f, 0x3f, 0x1f};

191 cÚ¡ 
u32
 
extcfg_ba£_mask
[] = {0x7ff8, 0x7ffc, 0x7ffe, 0x7fff};

192 cÚ¡ 
extcfg_ba£_lshiá
 = 25;

195 ià(!
aıi_di§bËd
 || 
pci_mmcfg_cÚfig_num
 || 
mı55_checked
)

196  
NULL
;

198 
mı55_checked
 = 1;

199 
i
 = 
bus
 = 0; bus < 256; bus++) {

200 
u32
 
l
, 
extcfg
;

201 
u16
 
v’dÜ
, 
deviû
;

203 
l
 = 
	`pci_cÚf_»ad32
(
bus
, 0, 0, 0);

204 
v’dÜ
 = 
l
 & 0xffff;

205 
deviû
 = (
l
 >> 16) & 0xffff;

207 ià(
PCI_VENDOR_ID_NVIDIA
 !ğ
v’dÜ
 || 0x0369 !ğ
deviû
)

210 
extcfg
 = 
	`pci_cÚf_»ad32
(
bus
, 0, 0, 
extcfg_»gnum
);

212 ià(
extcfg
 & 
extcfg_’abË_mask
)

213 
i
++;

216 ià(!
i
)

217  
NULL
;

219 
pci_mmcfg_cÚfig_num
 = 
i
;

220 
pci_mmcfg_cÚfig
 = 
	`xm®loc_¬¿y
(
aıi_mcfg_®loÿtiÚ
,

221 
pci_mmcfg_cÚfig_num
);

223 
i
 = 
bus
 = 0; bus < 256; bus++) {

224 
u64
 
ba£
;

225 
u32
 
l
, 
extcfg
;

226 
u16
 
v’dÜ
, 
deviû
;

227 
size_šdex
;

229 
l
 = 
	`pci_cÚf_»ad32
(
bus
, 0, 0, 0);

230 
v’dÜ
 = 
l
 & 0xffff;

231 
deviû
 = (
l
 >> 16) & 0xffff;

233 ià(
PCI_VENDOR_ID_NVIDIA
 !ğ
v’dÜ
 || 0x0369 !ğ
deviû
)

236 
extcfg
 = 
	`pci_cÚf_»ad32
(
bus
, 0, 0, 
extcfg_»gnum
);

238 ià(!(
extcfg
 & 
extcfg_’abË_mask
))

241 ià(
i
 >ğ
pci_mmcfg_cÚfig_num
)

244 
size_šdex
 = (
extcfg
 & 
extcfg_size_mask
è>> 
extcfg_size_shiá
;

245 
ba£
 = 
extcfg
 & 
extcfg_ba£_mask
[
size_šdex
];

247 
pci_mmcfg_cÚfig
[
i
].
add»ss
 = 
ba£
 << 
extcfg_ba£_lshiá
;

248 
pci_mmcfg_cÚfig
[
i
].
pci_£gm’t
 = 0;

249 
pci_mmcfg_cÚfig
[
i
].
¡¬t_bus_numb”
 =

250 (
extcfg
 & 
extcfg_¡¬t_mask
è>> 
extcfg_¡¬t_shiá
;

251 
pci_mmcfg_cÚfig
[
i
].
’d_bus_numb”
 =

252 
pci_mmcfg_cÚfig
[
i
].
¡¬t_bus_numb”
 + 
extcfg_sizebus
[
size_šdex
];

253 
i
++;

256 ià(
bus
 == 256)

259 
pci_mmcfg_cÚfig_num
 = 0;

260 
	`xä“
(
pci_mmcfg_cÚfig
);

261 
pci_mmcfg_cÚfig
 = 
NULL
;

263  
NULL
;

264 
	}
}

266 
	spci_mmcfg_ho¡bridge_´obe
 {

267 
u32
 
	mbus
;

268 
u32
 
	mdevâ
;

269 
u32
 
	mv’dÜ
;

270 
u32
 
	mdeviû
;

271 cÚ¡ *(*
	m´obe
)();

274 
pci_mmcfg_ho¡bridge_´obe
 
	gpci_mmcfg_´obes
[] 
	g__š™d©a
 = {

275 { 0, 
PCI_DEVFN
(0, 0), 
PCI_VENDOR_ID_INTEL
,

276 
PCI_DEVICE_ID_INTEL_E7520_MCH
, 
pci_mmcfg_e7520
 },

277 { 0, 
PCI_DEVFN
(0, 0), 
PCI_VENDOR_ID_INTEL
,

278 
PCI_DEVICE_ID_INTEL_82945G_HB
, 
pci_mmcfg_š‹l_945
 },

279 { 0, 
PCI_DEVFN
(0x18, 0), 
PCI_VENDOR_ID_AMD
,

280 0x1200, 
pci_mmcfg_amd_çm10h
 },

281 { 0xff, 
PCI_DEVFN
(0, 0), 
PCI_VENDOR_ID_AMD
,

282 0x1200, 
pci_mmcfg_amd_çm10h
 },

283 { 0, 
PCI_DEVFN
(0, 0), 
PCI_VENDOR_ID_NVIDIA
,

284 0x0369, 
pci_mmcfg_nvidŸ_mı55
 },

287 
__š™
 
	$pci_mmcfg_check_ho¡bridge
()

289 
u32
 
l
;

290 
u32
 
bus
, 
devâ
;

291 
u16
 
v’dÜ
, 
deviû
;

292 
i
;

293 cÚ¡ *
Çme
;

295 
pci_mmcfg_cÚfig_num
 = 0;

296 
pci_mmcfg_cÚfig
 = 
NULL
;

297 
Çme
 = 
NULL
;

299 
i
 = 0; !
Çme
 && i < 
	`ARRAY_SIZE
(
pci_mmcfg_´obes
); i++) {

300 
bus
 = 
pci_mmcfg_´obes
[
i
].bus;

301 
devâ
 = 
pci_mmcfg_´obes
[
i
].devfn;

302 
l
 = 
	`pci_cÚf_»ad32
(
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devfn), 0);

303 
v’dÜ
 = 
l
 & 0xffff;

304 
deviû
 = (
l
 >> 16) & 0xffff;

306 ià(
pci_mmcfg_´obes
[
i
].
v’dÜ
 == vendor &&

307 
pci_mmcfg_´obes
[
i
].
deviû
 == device)

308 
Çme
 = 
pci_mmcfg_´obes
[
i
].
	`´obe
();

311 ià(
Çme
) {

312 
	`´štk
(
KERN_INFO
 "PCI: Found %s %s MMCONFIG support.\n",

313 
Çme
, 
pci_mmcfg_cÚfig_num
 ? "with" : "without");

316  
Çme
 !ğ
NULL
;

317 
	}
}

319 (*
	tcheck_»£rved_t
)(
	tu64
 
	t¡¬t
, u64 
	t’d
, 
	tty³
);

321 
__š™
 
	`is_mmcÚf_»£rved
(

322 
check_»£rved_t
 
is_»£rved
,

323 
u64
 
addr
, u64 
size
, 
i
,

324 
	`ty³of
(
pci_mmcfg_cÚfig
[0]è*
cfg
, 
w™h_e820
)

326 
u64
 
Şd_size
 = 
size
;

327 
v®id
 = 0;

329 !
	`is_»£rved
(
addr
,‡dd¸+ 
size
 - 1, 
E820_RESERVED
)) {

330 
size
 >>= 1;

331 ià(
size
 < (16UL<<20))

335 ià(
size
 >ğ(16UL<<20è|| siz=ğ
Şd_size
) {

336 
	`´štk
(
KERN_NOTICE


338 
addr
, 
w™h_e820
?"E820":"ACPI motherboard„esources");

339 
v®id
 = 1;

341 ià(
Şd_size
 !ğ
size
) {

343 
cfg
->
’d_bus_numb”
 = cfg->
¡¬t_bus_numb”
 + ((
size
>>20) - 1);

344 
	`´štk
(
KERN_NOTICE
 "PCI: updated MCFG configuration %d: base %lx "

346 
i
, ()
cfg
->
add»ss
, cfg->
pci_£gm’t
,

347 ()
cfg
->
¡¬t_bus_numb”
,

348 ()
cfg
->
’d_bus_numb”
);

352  
v®id
;

353 
	}
}

355 
__š™
 
	$pci_mmcfg_»jeù_brok’
()

357 
	`ty³of
(
pci_mmcfg_cÚfig
[0]è*
cfg
;

358 
i
;

360 ià((
pci_mmcfg_cÚfig_num
 == 0) ||

361 (
pci_mmcfg_cÚfig
 =ğ
NULL
) ||

362 (
pci_mmcfg_cÚfig
[0].
add»ss
 == 0))

365 
cfg
 = &
pci_mmcfg_cÚfig
[0];

367 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; i++) {

368 
u64
 
addr
, 
size
;

370 
cfg
 = &
pci_mmcfg_cÚfig
[
i
];

371 
addr
 = 
cfg
->
¡¬t_bus_numb”
;

372 
addr
 <<= 20;

373 
addr
 +ğ
cfg
->
add»ss
;

374 
size
 = 
cfg
->
’d_bus_numb”
 + 1 - cfg->
¡¬t_bus_numb”
;

375 
size
 <<= 20;

376 
	`´štk
(
KERN_NOTICE
 "PCI: MCFG configuration %d: base %lx "

378 
i
, ()
cfg
->
add»ss
, cfg->
pci_£gm’t
,

379 ()
cfg
->
¡¬t_bus_numb”
,

380 ()
cfg
->
’d_bus_numb”
);

382 ià(!
	`is_mmcÚf_»£rved
(
e820_®l_m­³d
, 
addr
, 
size
, 
i
, 
cfg
, 1))

383 
»jeù
;

388 
»jeù
:

389 
	`´štk
(
KERN_INFO
 "PCI: Not using MMCONFIG.\n");

390 
	`pci_mmcfg_¬ch_ä“
();

391 
	`xä“
(
pci_mmcfg_cÚfig
);

392 
pci_mmcfg_cÚfig
 = 
NULL
;

393 
pci_mmcfg_cÚfig_num
 = 0;

394 
	}
}

396 
__š™
 
	$aıi_mmcfg_š™
()

399 ià((
pci_´obe
 & 
PCI_PROBE_MMCONF
) == 0)

403 ià(!(
pci_´obe
 & 
PCI_PROBE_MASK
 & ~
PCI_PROBE_MMCONF
))

407 ià(
known_bridge
)

410 ià(
	`pci_mmcfg_check_ho¡bridge
())

411 
known_bridge
 = 1;

413 ià(!
known_bridge
) {

414 
	`aıi_bË_·r£
(
ACPI_SIG_MCFG
, 
aıi_·r£_mcfg
);

415 
	`pci_mmcfg_»jeù_brok’
();

418 ià((
pci_mmcfg_cÚfig_num
 == 0) ||

419 (
pci_mmcfg_cÚfig
 =ğ
NULL
) ||

420 (
pci_mmcfg_cÚfig
[0].
add»ss
 == 0))

423 ià(
	`pci_mmcfg_¬ch_š™
()) {

424 
pci_´obe
 = (pci_´ob& ~
PCI_PROBE_MASK
è| 
PCI_PROBE_MMCONF
;

426 
	}
}

442 
	$pci_fšd_ext_ÿ·b™y
(
£g
, 
bus
, 
devâ
, 
ÿp
)

444 
u32
 
h—d”
;

445 
‰l
 = 480;

446 
pos
 = 0x100;

448 
h—d”
 = 
	`pci_cÚf_»ad32
(
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devâ), 
pos
);

454 iàĞ(
h—d”
 == 0) || (header == -1) )

457  
‰l
-- > 0 ) {

458 iàĞ
	`PCI_EXT_CAP_ID
(
h—d”
è=ğ
ÿp
 )

459  
pos
;

460 
pos
 = 
	`PCI_EXT_CAP_NEXT
(
h—d”
);

461 iàĞ
pos
 < 0x100 )

463 
h—d”
 = 
	`pci_cÚf_»ad32
(
bus
, 
	`PCI_SLOT
(
devâ
), 
	`PCI_FUNC
(devâ), 
pos
);

466 
	}
}

	@x86_64/mmconfig.h

20 
	#PCI_VENDOR_ID_INTEL
 0x8086

	)

21 
	#PCI_DEVICE_ID_INTEL_E7520_MCH
 0x3590

	)

22 
	#PCI_DEVICE_ID_INTEL_82945G_HB
 0x2770

	)

25 
	#PCI_PROBE_BIOS
 0x0001

	)

26 
	#PCI_PROBE_CONF1
 0x0002

	)

27 
	#PCI_PROBE_CONF2
 0x0004

	)

28 
	#PCI_PROBE_MMCONF
 0x0008

	)

29 
	#PCI_PROBE_MASK
 0x000f

	)

30 
	#PCI_PROBE_NOEARLY
 0x0010

	)

32 
	#PCI_VENDOR_ID_AMD
 0x1022

	)

33 
	#PCI_CHECK_ENABLE_AMD_MMCONF
 0x20000

	)

35 
	#PCI_VENDOR_ID_NVIDIA
 0x10de

	)

37 
pci_´obe
;

46 
šlše
 
	$mmio_cÚfig_»adb
(
__iomem
 *
pos
)

48 
u8
 
v®
;

49 
asm
 vŞ©e("movb (%1),%%®" : "÷" (
v®
è: "r" (
pos
));

50  
v®
;

51 
	}
}

53 
šlše
 
	$mmio_cÚfig_»adw
(
__iomem
 *
pos
)

55 
u16
 
v®
;

56 
asm
 vŞ©e("movw (%1),%%ax" : "÷" (
v®
è: "r" (
pos
));

57  
v®
;

58 
	}
}

60 
šlše
 
	$mmio_cÚfig_»adl
(
__iomem
 *
pos
)

62 
u32
 
v®
;

63 
asm
 vŞ©e("movÈ(%1),%%—x" : "÷" (
v®
è: "r" (
pos
));

64  
v®
;

65 
	}
}

67 
šlše
 
	$mmio_cÚfig_wr™eb
(
__iomem
 *
pos
, 
u8
 
v®
)

69 
asm
 vŞ©e("movb %%®,(%1)" :: "a" (
v®
), "r" (
pos
) : "memory");

70 
	}
}

72 
šlše
 
	$mmio_cÚfig_wr™ew
(
__iomem
 *
pos
, 
u16
 
v®
)

74 
asm
 vŞ©e("movw %%ax,(%1)" :: "a" (
v®
), "r" (
pos
) : "memory");

75 
	}
}

77 
šlše
 
	$mmio_cÚfig_wr™–
(
__iomem
 *
pos
, 
u32
 
v®
)

79 
asm
 vŞ©e("movÈ%%—x,(%1)" :: "a" (
v®
), "r" (
pos
) : "memory");

80 
	}
}

83 
pci_mmcfg_cÚfig_num
;

84 
aıi_mcfg_®loÿtiÚ
 *
pci_mmcfg_cÚfig
;

87 
aıi_·r£_mcfg
(
aıi_bË_h—d”
 *
h—d”
);

88 
pci_mmcfg_¬ch_š™
();

89 
pci_mmcfg_¬ch_ä“
();

	@x86_64/mmconfig_64.c

10 
	~<x’/cÚfig.h
>

11 
	~<x’/š™.h
>

12 
	~<x’/mm.h
>

13 
	~<x’/aıi.h
>

14 
	~<x’/xm®loc.h
>

15 
	~<x’/pci.h
>

16 
	~<x’/pci_»gs.h
>

18 
	~"mmcÚfig.h
"

21 
	smmcfg_vœt
 {

22 
aıi_mcfg_®loÿtiÚ
 *
	mcfg
;

23 
__iomem
 *
	mvœt
;

25 
mmcfg_vœt
 *
	gpci_mmcfg_vœt
;

26 
__š™d©a
 
	gmmcfg_pci_£gm’t_shiá
;

28 
__iomem
 *
	$g‘_vœt
(
£g
, 
bus
)

30 
aıi_mcfg_®loÿtiÚ
 *
cfg
;

31 
cfg_num
;

33 
cfg_num
 = 0; cfg_num < 
pci_mmcfg_cÚfig_num
; cfg_num++) {

34 
cfg
 = 
pci_mmcfg_vœt
[
cfg_num
].cfg;

35 ià(
cfg
->
pci_£gm’t
 =ğ
£g
 &&

36 (
cfg
->
¡¬t_bus_numb”
 <ğ
bus
) &&

37 (
cfg
->
’d_bus_numb”
 >ğ
bus
))

38  
pci_mmcfg_vœt
[
cfg_num
].
vœt
;

42  
NULL
;

43 
	}
}

45 
__iomem
 *
	$pci_dev_ba£
(
£g
, 
bus
, 
devâ
)

47 
__iomem
 *
addr
;

49 
addr
 = 
	`g‘_vœt
(
£g
, 
bus
);

50 ià(!
addr
)

51  
NULL
;

52  
addr
 + ((
bus
 << 20è| (
devâ
 << 12));

53 
	}
}

55 
	$pci_mmcfg_»ad
(
£g
, 
bus
,

56 
devâ
, 
»g
, 
Ën
, 
u32
 *
v®ue
)

58 
__iomem
 *
addr
;

61 ià(
	`uÆik–y
((
bus
 > 255è|| (
devâ
 > 255è|| (
»g
 > 4095))) {

62 
”r
: *
v®ue
 = -1;

63  -
EINVAL
;

66 
addr
 = 
	`pci_dev_ba£
(
£g
, 
bus
, 
devâ
);

67 ià(!
addr
)

68 
”r
;

70 
Ën
) {

72 *
v®ue
 = 
	`mmio_cÚfig_»adb
(
addr
 + 
»g
);

75 *
v®ue
 = 
	`mmio_cÚfig_»adw
(
addr
 + 
»g
);

78 *
v®ue
 = 
	`mmio_cÚfig_»adl
(
addr
 + 
»g
);

83 
	}
}

85 
	$pci_mmcfg_wr™e
(
£g
, 
bus
,

86 
devâ
, 
»g
, 
Ën
, 
u32
 
v®ue
)

88 
__iomem
 *
addr
;

91 ià(
	`uÆik–y
((
bus
 > 255è|| (
devâ
 > 255è|| (
»g
 > 4095)))

92  -
EINVAL
;

94 
addr
 = 
	`pci_dev_ba£
(
£g
, 
bus
, 
devâ
);

95 ià(!
addr
)

96  -
EINVAL
;

98 
Ën
) {

100 
	`mmio_cÚfig_wr™eb
(
addr
 + 
»g
, 
v®ue
);

103 
	`mmio_cÚfig_wr™ew
(
addr
 + 
»g
, 
v®ue
);

106 
	`mmio_cÚfig_wr™–
(
addr
 + 
»g
, 
v®ue
);

111 
	}
}

113 
__iomem
 * 
__š™
 
	$mcfg_iÜem­
(
aıi_mcfg_®loÿtiÚ
 *
cfg
)

115 
vœt
, 
size
;

117 
vœt
 = 
PCI_MCFG_VIRT_START
 +

118 (()
cfg
->
pci_£gm’t
 << 
mmcfg_pci_£gm’t_shiá
) +

119 (
cfg
->
¡¬t_bus_numb”
 << 20);

120 
size
 = (
cfg
->
’d_bus_numb”
 - cfg->
¡¬t_bus_numb”
 + 1) << 20;

121 ià(
vœt
 + 
size
 < vœˆ|| vœˆ+ siz> 
PCI_MCFG_VIRT_END
)

122  
NULL
;

124 
	`m­_·ges_to_x’
(
vœt
, 
cfg
->
add»ss
 >> 
PAGE_SHIFT
,

125 
size
 >> 
PAGE_SHIFT
, 
PAGE_HYPERVISOR_NOCACHE
);

127  (
__iomem
 *è
vœt
;

128 
	}
}

130 
__š™
 
	$pci_mmcfg_¬ch_š™
()

132 
i
;

134 
pci_mmcfg_vœt
 = 
	`xm®loc_¬¿y
(
mmcfg_vœt
, 
pci_mmcfg_cÚfig_num
);

135 ià(
pci_mmcfg_vœt
 =ğ
NULL
) {

136 
	`´štk
(
KERN_ERR
 "PCI: Can‚ot‡llocate memory for mmconfig structures\n");

139 
	`mem£t
(
pci_mmcfg_vœt
, 0, (*pci_mmcfg_vœtè* 
pci_mmcfg_cÚfig_num
);

141 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

142 
pci_mmcfg_vœt
[
i
].
cfg
 = &
pci_mmcfg_cÚfig
[i];

143 
pci_mmcfg_cÚfig
[
i
].
’d_bus_numb”
 >> 
mmcfg_pci_£gm’t_shiá
)

144 ++
mmcfg_pci_£gm’t_shiá
;

146 
mmcfg_pci_£gm’t_shiá
 += 20;

147 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

148 
pci_mmcfg_vœt
[
i
].
vœt
 = 
	`mcfg_iÜem­
(&
pci_mmcfg_cÚfig
[i]);

149 ià(!
pci_mmcfg_vœt
[
i
].
vœt
) {

150 
	`´štk
(
KERN_ERR
 "PCI: Cannot map mmconfig‡perture for "

152 
pci_mmcfg_cÚfig
[
i
].
pci_£gm’t
);

153 
	`pci_mmcfg_¬ch_ä“
();

158 
	}
}

160 
__š™
 
	$pci_mmcfg_¬ch_ä“
()

162 
i
;

164 ià(
pci_mmcfg_vœt
 =ğ
NULL
)

167 
i
 = 0; i < 
pci_mmcfg_cÚfig_num
; ++i) {

168 ià(
pci_mmcfg_vœt
[
i
].
vœt
) {

169 
	`iounm­
(
pci_mmcfg_vœt
[
i
].
vœt
);

170 
pci_mmcfg_vœt
[
i
].
vœt
 = 
NULL
;

171 
pci_mmcfg_vœt
[
i
].
cfg
 = 
NULL
;

175 
	`xä“
(
pci_mmcfg_vœt
);

176 
pci_mmcfg_vœt
 = 
NULL
;

177 
	}
}

	@x86_64/pci.c

7 
	~<x’/¥šlock.h
>

8 
	~<x’/pci.h
>

9 
	~<asm/io.h
>

11 
	#PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
) \

12 (0x80000000 | (
bus
 << 16è| (
dev
 << 11è| (
func
 << 8è| (
»g
 & ~3))

	)

14 
ušt8_t
 
	$pci_cÚf_»ad8
(

15 
bus
, 
dev
, 
func
, 
»g
)

17 
u32
 
v®ue
;

19 iàĞ
»g
 > 255 )

21 
	`pci_mmcfg_»ad
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 1, &
v®ue
);

22  
v®ue
;

26 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

27  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 3, 1);

29 
	}
}

31 
ušt16_t
 
	$pci_cÚf_»ad16
(

32 
bus
, 
dev
, 
func
, 
»g
)

34 
u32
 
v®ue
;

36 iàĞ
»g
 > 255 )

38 
	`pci_mmcfg_»ad
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 2, &
v®ue
);

39  
v®ue
;

43 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

44  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 2, 2);

46 
	}
}

48 
ušt32_t
 
	$pci_cÚf_»ad32
(

49 
bus
, 
dev
, 
func
, 
»g
)

51 
u32
 
v®ue
;

53 iàĞ
»g
 > 255 )

55 
	`pci_mmcfg_»ad
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 4, &
v®ue
);

56  
v®ue
;

60 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

61  
	`pci_cÚf_»ad
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
), 0, 4);

63 
	}
}

65 
	$pci_cÚf_wr™e8
(

66 
bus
, 
dev
, 
func
, 
»g
,

67 
ušt8_t
 
d©a
)

69 iàĞ
»g
 > 255 )

70 
	`pci_mmcfg_wr™e
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 1, 
d©a
);

73 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

74 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 3, 1, 
d©a
);

76 
	}
}

78 
	$pci_cÚf_wr™e16
(

79 
bus
, 
dev
, 
func
, 
»g
,

80 
ušt16_t
 
d©a
)

82 iàĞ
»g
 > 255 )

83 
	`pci_mmcfg_wr™e
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 2, 
d©a
);

86 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

87 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
),„eg & 2, 2, 
d©a
);

89 
	}
}

91 
	$pci_cÚf_wr™e32
(

92 
bus
, 
dev
, 
func
, 
»g
,

93 
ušt32_t
 
d©a
)

95 iàĞ
»g
 > 255 )

96 
	`pci_mmcfg_wr™e
(0, 
bus
, 
	`PCI_DEVFN
(
dev
, 
func
), 
»g
, 4, 
d©a
);

99 
	`BUG_ON
((
bus
 > 255è|| (
dev
 > 31è|| (
func
 > 7));

100 
	`pci_cÚf_wr™e
(
	`PCI_CONF_ADDRESS
(
bus
, 
dev
, 
func
, 
»g
), 0, 4, 
d©a
);

102 
	}
}

	@x86_64/physdev.c

5 
	~<x’/cÚfig.h
>

6 
	~<x’/ty³s.h
>

7 
	~<x’/gue¡_acûss.h
>

8 
	~<com·t/x’.h
>

9 
	~<com·t/ev’t_chªÃl.h
>

10 
	~<com·t/physdev.h
>

11 
	~<asm/hy³rÿÎ.h
>

13 
	#do_physdev_İ
 
com·t_physdev_İ


	)

15 
	#physdev_­ic
 
com·t_physdev_­ic


	)

16 
	#physdev_­ic_t
 
physdev_­ic_com·t_t


	)

18 
	#physdev_eoi
 
com·t_physdev_eoi


	)

19 
	#physdev_eoi_t
 
physdev_eoi_com·t_t


	)

21 
	#physdev_pœq_eoi_gmâ
 
com·t_physdev_pœq_eoi_gmâ


	)

22 
	#physdev_pœq_eoi_gmâ_t
 
physdev_pœq_eoi_gmâ_com·t_t


	)

24 
	#physdev_£t_iob™m­
 
com·t_physdev_£t_iob™m­


	)

25 
	#physdev_£t_iob™m­_t
 
physdev_£t_iob™m­_com·t_t


	)

27 
	#physdev_£t_iİl
 
com·t_physdev_£t_iİl


	)

28 
	#physdev_£t_iİl_t
 
physdev_£t_iİl_com·t_t


	)

30 
	#physdev_œq
 
com·t_physdev_œq


	)

31 
	#physdev_œq_t
 
physdev_œq_com·t_t


	)

33 
	#physdev_œq_¡©us_qu”y
 
com·t_physdev_œq_¡©us_qu”y


	)

34 
	#physdev_œq_¡©us_qu”y_t
 
physdev_œq_¡©us_qu”y_com·t_t


	)

36 
	#physdev_m­_pœq
 
com·t_physdev_m­_pœq


	)

37 
	#physdev_m­_pœq_t
 
physdev_m­_pœq_com·t_t


	)

39 
	#physdev_unm­_pœq
 
com·t_physdev_unm­_pœq


	)

40 
	#physdev_unm­_pœq_t
 
physdev_unm­_pœq_com·t_t


	)

42 
	#physdev_mªage_pci
 
com·t_physdev_mªage_pci


	)

43 
	#physdev_mªage_pci_t
 
physdev_mªage_pci_com·t_t


	)

45 
	#physdev_mªage_pci_ext
 
com·t_physdev_mªage_pci_ext


	)

46 
	#physdev_mªage_pci_ext_t
 
physdev_mªage_pci_ext_com·t_t


	)

48 
	#physdev_»¡Üe_msi
 
com·t_physdev_»¡Üe_msi


	)

49 
	#physdev_»¡Üe_msi_t
 
physdev_»¡Üe_msi_com·t_t


	)

51 
	#physdev_£tup_gsi
 
com·t_physdev_£tup_gsi


	)

52 
	#physdev_£tup_gsi_t
 
physdev_£tup_gsi_com·t_t


	)

54 
	#physdev_g‘_ä“_pœq
 
com·t_physdev_g‘_ä“_pœq


	)

55 
	#physdev_g‘_ä“_pœq_t
 
physdev_g‘_ä“_pœq_com·t_t


	)

57 
	#COMPAT


	)

58 #undeà
gue¡_hªdË_okay


59 
	#gue¡_hªdË_okay
 
com·t_hªdË_okay


	)

60 
	t»t_t
;

62 
	~"../physdev.c
"

	@x86_64/platform_hypercall.c

5 
	~<x’/cÚfig.h
>

6 
	~<x’/ty³s.h
>

7 
	~<com·t/¶©fÜm.h
>

9 
DEFINE_XEN_GUEST_HANDLE
(
com·t_¶©fÜm_İ_t
);

10 
	#x’_¶©fÜm_İ
 
com·t_¶©fÜm_İ


	)

11 
	#x’_¶©fÜm_İ_t
 
com·t_¶©fÜm_İ_t


	)

12 
	#do_¶©fÜm_İ
(
x
è
	`com·t_¶©fÜm_İ
(
_
##x)

	)

14 
	#x’_´oûssÜ_px
 
com·t_´oûssÜ_px


	)

15 
	#x’_´oûssÜ_px_t
 
com·t_´oûssÜ_px_t


	)

16 
	#x’_´oûssÜ_³rfÜmªû
 
com·t_´oûssÜ_³rfÜmªû


	)

17 
	#x’_´oûssÜ_³rfÜmªû_t
 
com·t_´oûssÜ_³rfÜmªû_t


	)

18 
	#x’pf_£t_´oûssÜ_pmšfo
 
com·t_pf_£t_´oûssÜ_pmšfo


	)

20 
	#£t_px_pmšfo
 
com·t_£t_px_pmšfo


	)

22 
	#x’_´oûssÜ_pow”
 
com·t_´oûssÜ_pow”


	)

23 
	#x’_´oûssÜ_pow”_t
 
com·t_´oûssÜ_pow”_t


	)

24 
	#£t_cx_pmšfo
 
com·t_£t_cx_pmšfo


	)

26 
	#x’pf_pıušfo
 
com·t_pf_pıušfo


	)

27 
	#x’pf_pıušfo_t
 
com·t_pf_pıušfo_t


	)

29 
	#x’pf_’‹r_aıi_¦“p
 
com·t_pf_’‹r_aıi_¦“p


	)

31 
	#COMPAT


	)

32 
	#_XEN_GUEST_HANDLE
(
t
è
	`XEN_GUEST_HANDLE
Ñ)

	)

33 
	t»t_t
;

35 
	~"../¶©fÜm_hy³rÿÎ.c
"

	@x86_64/traps.c

2 
	~<x’/cÚfig.h
>

3 
	~<x’/v”siÚ.h
>

4 
	~<x’/š™.h
>

5 
	~<x’/sched.h
>

6 
	~<x’/lib.h
>

7 
	~<x’/”ºo.h
>

8 
	~<x’/mm.h
>

9 
	~<x’/œq.h
>

10 
	~<x’/symbŞs.h
>

11 
	~<x’/cÚsŞe.h
>

12 
	~<x’/sched.h
>

13 
	~<x’/shutdown.h
>

14 
	~<x’/nmi.h
>

15 
	~<asm/cu¼’t.h
>

16 
	~<asm/æushb.h
>

17 
	~<asm/Œ­s.h
>

18 
	~<asm/ev’t.h
>

19 
	~<asm/m¤.h
>

20 
	~<asm/·ge.h
>

21 
	~<asm/sh¬ed.h
>

22 
	~<asm/hvm/hvm.h
>

23 
	~<asm/hvm/suµÜt.h
>

24 
	~<public/ÿÎback.h
>

26 
asmlškage
 
sysÿÎ_’‹r
();

27 
asmlškage
 
sy£Á”_’Œy
();

28 
asmlškage
 
com·t_hy³rÿÎ
();

29 
asmlškage
 
št80_dœeù_Œ­
();

31 
	$´št_x’_šfo
()

33 
št_¡r
[
TAINT_STRING_MAX_LEN
];

34 
debug
 = 'n';

36 #iâdeà
NDEBUG


37 
debug
 = 'y';

40 
	`´štk
("----[ Xen-%d.%d%s x86_64 debug=%c %s ]----\n",

41 
	`x’_majÜ_v”siÚ
(), 
	`x’_mšÜ_v”siÚ
(), 
	`x’_exŒa_v”siÚ
(),

42 
debug
, 
	`´št_š‹d
(
št_¡r
));

43 
	}
}

45 
	ecÚ‹xt
 { 
	mCTXT_hy³rvisÜ
, 
	mCTXT_pv_gue¡
, 
	mCTXT_hvm_gue¡
 };

47 
	$_show_»gi¡”s
(

48 cÚ¡ 
ıu_u£r_»gs
 *
»gs
, 
üs
[8],

49 
cÚ‹xt
 cÚ‹xt, cÚ¡ 
vıu
 *
v
)

51 cÚ¡ *
cÚ‹xt_Çmes
[] = {

52 [
CTXT_hy³rvisÜ
] = "hypervisor",

53 [
CTXT_pv_gue¡
] = "pv guest",

54 [
CTXT_hvm_gue¡
] = "hvm guest"

57 
	`´štk
("RIP: %04x:[<%016lx>]", 
»gs
->
cs
,„egs->
r
);

58 iàĞ
cÚ‹xt
 =ğ
CTXT_hy³rvisÜ
 )

59 
	`´št_symbŞ
(" %s", 
»gs
->
r
);

60 
	`´štk
("\nRFLAGS: %016lx ", 
»gs
->
ræags
);

61 iàĞ(
cÚ‹xt
 =ğ
CTXT_pv_gue¡
è&& 
v
 && v->
vıu_šfo
 )

62 
	`´štk
("EM: %d ", !!
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_mask
));

63 
	`´štk
("CONTEXT: %s\n", 
cÚ‹xt_Çmes
[
cÚ‹xt
]);

65 
	`´štk
("rax: %016lx„bx: %016lx„cx: %016lx\n",

66 
»gs
->
¿x
,„egs->
rbx
,„egs->
rcx
);

67 
	`´štk
("rdx: %016lx„si: %016lx„di: %016lx\n",

68 
»gs
->
rdx
,„egs->
rsi
,„egs->
rdi
);

69 
	`´štk
("rbp: %016lx„sp: %016lx„8: %016lx\n",

70 
»gs
->
rbp
,„egs->
r¥
,„egs->
r8
);

71 
	`´štk
("r9: %016lx„10: %016lx„11: %016lx\n",

72 
»gs
->
r9
,„egs->
r10
,„egs->
r11
);

73 
	`´štk
("r12: %016lx„13: %016lx„14: %016lx\n",

74 
»gs
->
r12
,„egs->
r13
,„egs->
r14
);

75 
	`´štk
("r15: %016lx cr0: %016lx cr4: %016lx\n",

76 
»gs
->
r15
, 
üs
[0], crs[4]);

77 
	`´štk
("ü3: %016lx cr2: %016lx\n", 
üs
[3], crs[2]);

78 
	`´štk
("ds: %04xƒs: %04x fs: %04x gs: %04x "

80 
»gs
->
ds
,„egs->
es
,„egs->
fs
,

81 
»gs
->
gs
,„egs->
ss
,„egs->
cs
);

82 
	}
}

84 
	$show_»gi¡”s
(
ıu_u£r_»gs
 *
»gs
)

86 
ıu_u£r_»gs
 
çuÉ_»gs
 = *
»gs
;

87 
çuÉ_üs
[8];

88 
cÚ‹xt
 context;

89 
vıu
 *
v
 = 
cu¼’t
;

91 iàĞ
	`is_hvm_vıu
(
v
è&& 
	`gue¡_mode
(
»gs
) )

93 
£gm’t_»gi¡”
 
¤eg
;

94 
cÚ‹xt
 = 
CTXT_hvm_gue¡
;

95 
çuÉ_üs
[0] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[0];

96 
çuÉ_üs
[2] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[2];

97 
çuÉ_üs
[3] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[3];

98 
çuÉ_üs
[4] = 
v
->
¬ch
.
hvm_vıu
.
gue¡_ü
[4];

99 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_cs
, &
¤eg
);

100 
çuÉ_»gs
.
cs
 = 
¤eg
.
£l
;

101 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ds
, &
¤eg
);

102 
çuÉ_»gs
.
ds
 = 
¤eg
.
£l
;

103 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_es
, &
¤eg
);

104 
çuÉ_»gs
.
es
 = 
¤eg
.
£l
;

105 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_fs
, &
¤eg
);

106 
çuÉ_»gs
.
fs
 = 
¤eg
.
£l
;

107 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_gs
, &
¤eg
);

108 
çuÉ_»gs
.
gs
 = 
¤eg
.
£l
;

109 
	`hvm_g‘_£gm’t_»gi¡”
(
v
, 
x86_£g_ss
, &
¤eg
);

110 
çuÉ_»gs
.
ss
 = 
¤eg
.
£l
;

114 iàĞ
	`gue¡_mode
(
»gs
) )

116 
cÚ‹xt
 = 
CTXT_pv_gue¡
;

117 
çuÉ_üs
[2] = 
	`¬ch_g‘_ü2
(
v
);

121 
cÚ‹xt
 = 
CTXT_hy³rvisÜ
;

122 
çuÉ_üs
[2] = 
	`»ad_ü2
();

125 
çuÉ_üs
[0] = 
	`»ad_ü0
();

126 
çuÉ_üs
[3] = 
	`»ad_ü3
();

127 
çuÉ_üs
[4] = 
	`»ad_ü4
();

128 
çuÉ_»gs
.
ds
 = 
	`»ad_£gm’t_»gi¡”
(ds);

129 
çuÉ_»gs
.
es
 = 
	`»ad_£gm’t_»gi¡”
(es);

130 
çuÉ_»gs
.
fs
 = 
	`»ad_£gm’t_»gi¡”
(fs);

131 
çuÉ_»gs
.
gs
 = 
	`»ad_£gm’t_»gi¡”
(gs);

134 
	`´št_x’_šfo
();

135 
	`´štk
("CPU: %d\n", 
	`smp_´oûssÜ_id
());

136 
	`_show_»gi¡”s
(&
çuÉ_»gs
, 
çuÉ_üs
, 
cÚ‹xt
, 
v
);

138 iàĞ
	`this_ıu
(
Ër_m¤
è&& !
	`gue¡_mode
(
»gs
) )

140 
u64
 
äom
, 
to
;

141 
	`rdm¤l
(
	`this_ıu
(
Ër_m¤
), 
äom
);

142 
	`rdm¤l
(
	`this_ıu
(
Ër_m¤
è+ 1, 
to
);

143 
	`´štk
("Ër: %016lx -> %016lx\n", 
äom
, 
to
);

145 
	}
}

147 
	$vıu_show_»gi¡”s
(cÚ¡ 
vıu
 *
v
)

149 cÚ¡ 
ıu_u£r_»gs
 *
»gs
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
u£r_»gs
;

150 
üs
[8];

153 iàĞ
	`is_hvm_vıu
(
v
) )

156 
üs
[0] = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[0];

157 
üs
[2] = 
	`¬ch_g‘_ü2
(
v
);

158 
üs
[3] = 
	`·g‘abË_g‘_·ddr
(
	`gue¡_k”Ãl_mode
(
v
, 
»gs
) ?

159 
v
->
¬ch
.
gue¡_bË
 :

160 
v
->
¬ch
.
gue¡_bË_u£r
);

161 
üs
[4] = 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ù¾»g
[4];

163 
	`_show_»gi¡”s
(
»gs
, 
üs
, 
CTXT_pv_gue¡
, 
v
);

164 
	}
}

166 
	$show_·ge_w®k
(
addr
)

168 
pâ
, 
mâ
 = 
	`»ad_ü3
(è>> 
PAGE_SHIFT
;

169 
l4_pg’Œy_t
 
l4e
, *
l4t
;

170 
l3_pg’Œy_t
 
l3e
, *
l3t
;

171 
l2_pg’Œy_t
 
l2e
, *
l2t
;

172 
l1_pg’Œy_t
 
l1e
, *
l1t
;

174 
	`´štk
("Pag‘abË w®k from %016lx:\n", 
addr
);

176 
l4t
 = 
	`mâ_to_vœt
(
mâ
);

177 
l4e
 = 
l4t
[
	`l4_bË_off£t
(
addr
)];

178 
mâ
 = 
	`l4e_g‘_pâ
(
l4e
);

179 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

180 
	`´štk
(" L4[0x%03lx] = %"
PRI±e
" %016lx\n",

181 
	`l4_bË_off£t
(
addr
), 
	`l4e_g‘_š‹
(
l4e
), 
pâ
);

182 iàĞ!(
	`l4e_g‘_æags
(
l4e
è& 
_PAGE_PRESENT
) ||

183 !
	`mâ_v®id
(
mâ
) )

186 
l3t
 = 
	`mâ_to_vœt
(
mâ
);

187 
l3e
 = 
l3t
[
	`l3_bË_off£t
(
addr
)];

188 
mâ
 = 
	`l3e_g‘_pâ
(
l3e
);

189 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

190 
	`´štk
(" L3[0x%03lx] = %"
PRI±e
" %016lx%s\n",

191 
	`l3_bË_off£t
(
addr
), 
	`l3e_g‘_š‹
(
l3e
), 
pâ
,

192 (
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) ? " (PSE)" : "");

193 iàĞ!(
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PRESENT
) ||

194 (
	`l3e_g‘_æags
(
l3e
è& 
_PAGE_PSE
) ||

195 !
	`mâ_v®id
(
mâ
) )

198 
l2t
 = 
	`mâ_to_vœt
(
mâ
);

199 
l2e
 = 
l2t
[
	`l2_bË_off£t
(
addr
)];

200 
mâ
 = 
	`l2e_g‘_pâ
(
l2e
);

201 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

202 
	`´štk
(" L2[0x%03lx] = %"
PRI±e
" %016lx %s\n",

203 
	`l2_bË_off£t
(
addr
), 
	`l2e_g‘_š‹
(
l2e
), 
pâ
,

204 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) ? "(PSE)" : "");

205 iàĞ!(
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PRESENT
) ||

206 (
	`l2e_g‘_æags
(
l2e
è& 
_PAGE_PSE
) ||

207 !
	`mâ_v®id
(
mâ
) )

210 
l1t
 = 
	`mâ_to_vœt
(
mâ
);

211 
l1e
 = 
l1t
[
	`l1_bË_off£t
(
addr
)];

212 
mâ
 = 
	`l1e_g‘_pâ
(
l1e
);

213 
pâ
 = 
	`mâ_v®id
(
mâ
è? 
	`g‘_gpâ_äom_mâ
(mâè: 
INVALID_M2P_ENTRY
;

214 
	`´štk
(" L1[0x%03lx] = %"
PRI±e
" %016lx\n",

215 
	`l1_bË_off£t
(
addr
), 
	`l1e_g‘_š‹
(
l1e
), 
pâ
);

216 
	}
}

218 
asmlškage
 
doubË_çuÉ
();

219 
asmlškage
 
	$do_doubË_çuÉ
(
ıu_u£r_»gs
 *
»gs
)

221 
ıu
;

223 
	`w©chdog_di§bË
();

225 
	`cÚsŞe_fÜû_uÆock
();

227 
	`asm
 ( "l¦È%1, %0" : "ô" (
ıu
è: "rm" (
PER_CPU_GDT_ENTRY
 << 3) );

230 
	`´štk
("*** DOUBLE FAULT ***\n");

231 
	`´št_x’_šfo
();

232 
	`´štk
("CPU: %d\nRIP: %04x:[<%016lx>]",

233 
ıu
, 
»gs
->
cs
,„egs->
r
);

234 
	`´št_symbŞ
(" %s", 
»gs
->
r
);

235 
	`´štk
("\nRFLAGS: %016lx\n", 
»gs
->
ræags
);

236 
	`´štk
("rax: %016lx„bx: %016lx„cx: %016lx\n",

237 
»gs
->
¿x
,„egs->
rbx
,„egs->
rcx
);

238 
	`´štk
("rdx: %016lx„si: %016lx„di: %016lx\n",

239 
»gs
->
rdx
,„egs->
rsi
,„egs->
rdi
);

240 
	`´štk
("rbp: %016lx„sp: %016lx„8: %016lx\n",

241 
»gs
->
rbp
,„egs->
r¥
,„egs->
r8
);

242 
	`´štk
("r9: %016lx„10: %016lx„11: %016lx\n",

243 
»gs
->
r9
,„egs->
r10
,„egs->
r11
);

244 
	`´štk
("r12: %016lx„13: %016lx„14: %016lx\n",

245 
»gs
->
r12
,„egs->
r13
,„egs->
r14
);

246 
	`´štk
("r15: %016lx cs: %016lx ss: %016lx\n",

247 
»gs
->
r15
, (ìegs->
cs
, (ìegs->
ss
);

248 
	`show_¡ack_ov”æow
(
ıu
, 
»gs
->
r¥
);

250 
	`·nic
("DOUBLE FAULT -- system shutdown\n");

251 
	}
}

254 #ifdeà
ENABLE_SYSCALL_USCHED


255 
	gsysÿÎ_usched
;

258 
	$toggË_gue¡_mode
(
vıu
 *
v
)

260 iàĞ
	`is_pv_32b™_vıu
(
v
) )

262 
v
->
¬ch
.
æags
 ^ğ
TF_k”Ãl_mode
;

263 
asm
 volatile ( "swapgs" );

264 
	`upd©e_ü3
(
v
);

266 
»t
 = 0;

267 
pcouÁ
[
COUNT_TOGGLE_MODE
]++;

268 ià(
v
->
myæag
) {

269 ià(
v
->
¬ch
.
æags
 & 
TF_k”Ãl_mode
) {

270 
	`MYASSERT
(
v
->
myæag
 == 1);

271 
pcouÁ
[
COUNT_SYSCALL
]++;

273 #ifdeà
ENABLE_SYSCALL_USCHED


274 ià(
sysÿÎ_usched
 ) {

276 
»t
 = 
	`uscheduË
(0);

280 
v
->
myæag
--;

281 
	`MYASSERT
(
v
->
myæag
 == 0);

282 
pcouÁ
[
COUNT_SYSRET
]++;

283 #ifdeà
ENABLE_SYSCALL_USCHED


284 ià(
sysÿÎ_usched
 ) {

286 
»t
 = 
	`uscheduË
(1);

293 #ifdeà
ENABLE_SYSCALL_USCHED


294 ià(
»t
)

298 #ifdeà
ENABLE_PGD


299 #ifdeà
USER_MAPPINGS_ARE_GLOBAL


300 
	`MYASSERT
(
v
 =ğ
cu¼’t
);

301 #ifdeà
VERBOSE_UPDATE_CR3


302 
	`´št_ü3
(
v
->
¬ch
.
ü3
, 3);

304 
shadow_ü3
 = 
v
->
¬ch
.
ü3
;

305 #ifdeà
ENABLE_PER_CACHE_PT


306 
·ge_dœ
 *
pgd
 = 
NULL
;

307 ià(
pgd
 = 
v
->
cu¼’t_pgd
) {

308 #ifdeà
ENABLE_REGIONING2


309 ià(
pgd
->
cu¼’t_»giÚ
 &&…gd->
»giÚšg_ıu
 =ğ
	`smp_´oûssÜ_id
())

310 
shadow_ü3
 = (
	`vœt_to_mâ
(
pgd
->
±
->
»giÚšg_shadow
è<< 
PAGE_SHIFT
);

313 
shadow_ü3
 = (
	`vœt_to_mâ
(
pgd
->
±
->
shadow
[
ÿche_now
]è<< 
PAGE_SHIFT
);

315 #ifdeà
NO_PGD_ABOVE_4GB


316 
	`MYASSERT
(!(
shadow_ü3
 & 0xffffffff00000fff));

320 
asm
 vŞ©Ğ"mov %0, %%ü3" : : "r" (
shadow_ü3
) : "memory" );

323 #”rÜ 
assume
 
u£r_m­pšgs_¬e_glob®


326 #ifdeà
USER_MAPPINGS_ARE_GLOBAL


328 
asm
 vŞ©Ğ"mov %0, %%ü3" : : "r" (
v
->
¬ch
.
ü3
) : "memory" );

330 
	`wr™e_±ba£
(
v
);

333 
	}
}

335 
	$do_œ‘
()

337 
ıu_u£r_»gs
 *
»gs
 = 
	`gue¡_ıu_u£r_»gs
();

338 
œ‘_cÚ‹xt
 
œ‘_§ved
;

339 
vıu
 *
v
 = 
cu¼’t
;

341 iàĞ
	`uÆik–y
(
	`cİy_äom_u£r
(&
œ‘_§ved
, (*)
»gs
->
r¥
,

342 (
œ‘_§ved
))) )

344 
	`gd´štk
(
XENLOG_ERR
, "Fault while„eading IRET context from "

346 
ex™_ªd_üash
;

349 
pcouÁ
[
COUNT_IRET
]++;

352 iàĞ(
œ‘_§ved
.
cs
 & 3) == 3 )

354 iàĞ
	`uÆik–y
(
	`·g‘abË_is_nuÎ
(
v
->
¬ch
.
gue¡_bË_u£r
)) )

356 
	`gd´štk
(
XENLOG_ERR
, "Guest switchingo user mode with‚o "

358 
ex™_ªd_üash
;

360 
	`toggË_gue¡_mode
(
v
);

363 
»gs
->
r
 = 
œ‘_§ved
.rip;

364 
»gs
->
cs
 = 
œ‘_§ved
.cs | 3;

365 
»gs
->
ræags
 = ((
œ‘_§ved
.ræag & ~(
X86_EFLAGS_IOPL
|
X86_EFLAGS_VM
))

366 | 
X86_EFLAGS_IF
);

367 
»gs
->
r¥
 = 
œ‘_§ved
.rsp;

368 
»gs
->
ss
 = 
œ‘_§ved
.ss | 3;

370 iàĞ!(
œ‘_§ved
.
æags
 & 
VGCF_š_sysÿÎ
) )

372 
»gs
->
’Œy_veùÜ
 = 0;

373 
»gs
->
r11
 = 
œ‘_§ved
.r11;

374 
»gs
->
rcx
 = 
œ‘_§ved
.rcx;

378 
	`vıu_šfo
(
v
, 
evtchn_upÿÎ_mask
èğ!(
œ‘_§ved
.
ræags
 & 
X86_EFLAGS_IF
);

380 
	`async_exû±iÚ_ş—nup
(
v
);

383  
œ‘_§ved
.
¿x
;

385 
ex™_ªd_üash
:

386 
	`gd´štk
(
XENLOG_ERR
, "Fatalƒrror\n");

387 
	`domaš_üash
(
v
->
domaš
);

389 
	}
}

391 
	$wr™e_¡ack_ŒampŞše
(

392 *
¡ack
, *
¡ack_bÙtom
, 
ušt16_t
 
cs_£g
)

395 
¡ack
[0] = 0x48;

396 
¡ack
[1] = 0x89;

397 
¡ack
[2] = 0x25;

398 *(
u32
 *)&
¡ack
[3] = (
¡ack_bÙtom
 - &stack[7]) - 16;

401 
¡ack
[7] = 0x48;

402 
¡ack
[8] = 0x8d;

403 
¡ack
[9] = 0x25;

404 *(
u32
 *)&
¡ack
[10] = (
¡ack_bÙtom
 - &stack[14]) - 16;

407 
¡ack
[14] = 0x41;

408 
¡ack
[15] = 0x53;

411 
¡ack
[16] = 0x68;

412 *(
u32
 *)&
¡ack
[17] = 
cs_£g
;

415 
¡ack
[21] = 0x49;

416 
¡ack
[22] = 0xbb;

417 *(**)&
¡ack
[23] = (*)
sysÿÎ_’‹r
;

420 
¡ack
[31] = 0x41;

421 
¡ack
[32] = 0xff;

422 
¡ack
[33] = 0xe3;

425 
	}
}

427 
__devš™
 
	$sub¬ch_³rıu_Œ­s_š™
()

429 *
¡ack_bÙtom
, *
¡ack
;

430 
ıu
 = 
	`smp_´oûssÜ_id
();

432 iàĞ
ıu
 == 0 )

435 
	`£t_šŒ_g©e
(
TRAP_doubË_çuÉ
, &
doubË_çuÉ
);

436 
idt_bË
[
TRAP_doubË_çuÉ
].
a
 |ğ
IST_DF
 << 32;

437 
idt_bË
[
TRAP_nmi
].
a
 |ğ
IST_NMI
 << 32;

438 
idt_bË
[
TRAP_machše_check
].
a
 |ğ
IST_MCE
 << 32;

444 
	`_£t_g©e
(
idt_bË
+
HYPERCALL_VECTOR
, 15, 1, &
com·t_hy³rÿÎ
);

447 
	`_£t_g©e
(
idt_bË
+0x80, 15, 3, &
št80_dœeù_Œ­
);

451 
¡ack_bÙtom
 = (*)
	`g‘_¡ack_bÙtom
();

452 
¡ack
 = (*)(()
¡ack_bÙtom
 & ~(
STACK_SIZE
 - 1));

455 
	`BUILD_BUG_ON
((
IST_MAX
 + 2è* 
PAGE_SIZE
 + 
PRIMARY_STACK_SIZE
 > 
STACK_SIZE
);

458 
	`this_ıu
(
š™_tss
).
i¡
[
IST_MCE
] = ()&
¡ack
[IST_MCE * 
PAGE_SIZE
];

461 
	`this_ıu
(
š™_tss
).
i¡
[
IST_DF
] = ()&
¡ack
[IST_DF * 
PAGE_SIZE
];

464 
	`this_ıu
(
š™_tss
).
i¡
[
IST_NMI
] = ()&
¡ack
[IST_NMI * 
PAGE_SIZE
];

467 
¡ack
 = &¡ack[
IST_MAX
 * 
PAGE_SIZE
];

468 
	`wrm¤l
(
MSR_LSTAR
, ()
¡ack
);

469 
¡ack
 +ğ
	`wr™e_¡ack_ŒampŞše
(¡ack, 
¡ack_bÙtom
, 
FLAT_KERNEL_CS64
);

471 iàĞ
boÙ_ıu_d©a
.
x86_v’dÜ
 =ğ
X86_VENDOR_INTEL
 )

474 
	`wrm¤l
(
MSR_IA32_SYSENTER_ESP
, ()
¡ack_bÙtom
);

475 
	`wrm¤l
(
MSR_IA32_SYSENTER_EIP
, ()
sy£Á”_’Œy
);

476 
	`wrm¤
(
MSR_IA32_SYSENTER_CS
, 
__HYPERVISOR_CS
, 0);

480 
¡ack
 = (*)
	`L1_CACHE_ALIGN
(()stack);

481 
	`wrm¤l
(
MSR_CSTAR
, ()
¡ack
);

482 
¡ack
 +ğ
	`wr™e_¡ack_ŒampŞše
(¡ack, 
¡ack_bÙtom
, 
FLAT_USER_CS32
);

485 
	`wrm¤
(
MSR_STAR
, 0, (
FLAT_RING3_CS32
<<16è| 
__HYPERVISOR_CS
);

486 
	`wrm¤
(
MSR_SYSCALL_MASK
,

487 
X86_EFLAGS_VM
|
X86_EFLAGS_RF
|
X86_EFLAGS_NT
|

488 
X86_EFLAGS_DF
|
X86_EFLAGS_IF
|
X86_EFLAGS_TF
,

490 
	}
}

492 
	$š™_št80_dœeù_Œ­
(
vıu
 *
v
)

494 
Œ­_šfo
 *
ti
 = &
v
->
¬ch
.
gue¡_cÚ‹xt
.
Œ­_ùxt
[0x80];

495 
Œ­_bounû
 *
tb
 = &
v
->
¬ch
.
št80_bounû
;

497 
tb
->
æags
 = 
TBF_EXCEPTION
;

498 
tb
->
cs
 = 
ti
->cs;

499 
tb
->
e
 = 
ti
->
add»ss
;

501 iàĞ
	`nuÎ_Œ­_bounû
(
v
, 
tb
) )

502 
tb
->
æags
 = 0;

503 
	}
}

505 
	$»gi¡”_gue¡_ÿÎback
(
ÿÎback_»gi¡”
 *
»g
)

507 
»t
 = 0;

508 
vıu
 *
v
 = 
cu¼’t
;

510 iàĞ!
	`is_ÿnÚiÿl_add»ss
(
»g
->
add»ss
) )

511  -
EINVAL
;

513  
»g
->
ty³
 )

515 
CALLBACKTYPE_ev’t
:

516 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ev’t_ÿÎback_e
 = 
»g
->
add»ss
;

519 
CALLBACKTYPE_ç§ã
:

520 
v
->
¬ch
.
gue¡_cÚ‹xt
.
ç§ã_ÿÎback_e
 = 
»g
->
add»ss
;

521 iàĞ
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
 )

522 
	`£t_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

523 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

525 
	`ş—r_b™
(
_VGCF_ç§ã_di§bËs_ev’ts
,

526 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

529 
CALLBACKTYPE_sysÿÎ
:

530 
v
->
¬ch
.
gue¡_cÚ‹xt
.
sysÿÎ_ÿÎback_e
 = 
»g
->
add»ss
;

531 iàĞ
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
 )

532 
	`£t_b™
(
_VGCF_sysÿÎ_di§bËs_ev’ts
,

533 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

535 
	`ş—r_b™
(
_VGCF_sysÿÎ_di§bËs_ev’ts
,

536 &
v
->
¬ch
.
gue¡_cÚ‹xt
.
æags
);

539 
CALLBACKTYPE_sysÿÎ32
:

540 
v
->
¬ch
.
sysÿÎ32_ÿÎback_e
 = 
»g
->
add»ss
;

541 
v
->
¬ch
.
sysÿÎ32_di§bËs_ev’ts
 =

542 !!(
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
);

545 
CALLBACKTYPE_sy£Á”
:

546 
v
->
¬ch
.
sy£Á”_ÿÎback_e
 = 
»g
->
add»ss
;

547 
v
->
¬ch
.
sy£Á”_di§bËs_ev’ts
 =

548 !!(
»g
->
æags
 & 
CALLBACKF_mask_ev’ts
);

551 
CALLBACKTYPE_nmi
:

552 
»t
 = 
	`»gi¡”_gue¡_nmi_ÿÎback
(
»g
->
add»ss
);

556 
»t
 = -
ENOSYS
;

560  
»t
;

561 
	}
}

563 
	$uÄegi¡”_gue¡_ÿÎback
(
ÿÎback_uÄegi¡”
 *
uÄeg
)

565 
»t
;

567  
uÄeg
->
ty³
 )

569 
CALLBACKTYPE_ev’t
:

570 
CALLBACKTYPE_ç§ã
:

571 
CALLBACKTYPE_sysÿÎ
:

572 
CALLBACKTYPE_sysÿÎ32
:

573 
CALLBACKTYPE_sy£Á”
:

574 
»t
 = -
EINVAL
;

577 
CALLBACKTYPE_nmi
:

578 
»t
 = 
	`uÄegi¡”_gue¡_nmi_ÿÎback
();

582 
»t
 = -
ENOSYS
;

586  
»t
;

587 
	}
}

590 
do_ÿÎback_İ
(
cmd
, 
	$XEN_GUEST_HANDLE
(
cÚ¡_void
è
¬g
)

592 
»t
;

594  
cmd
 )

596 
CALLBACKOP_»gi¡”
:

598 
ÿÎback_»gi¡”
 
»g
;

600 
»t
 = -
EFAULT
;

601 iàĞ
	`cİy_äom_gue¡
(&
»g
, 
¬g
, 1) )

604 
»t
 = 
	`»gi¡”_gue¡_ÿÎback
(&
»g
);

608 
CALLBACKOP_uÄegi¡”
:

610 
ÿÎback_uÄegi¡”
 
uÄeg
;

612 
»t
 = -
EFAULT
;

613 iàĞ
	`cİy_äom_gue¡
(&
uÄeg
, 
¬g
, 1) )

616 
»t
 = 
	`uÄegi¡”_gue¡_ÿÎback
(&
uÄeg
);

621 
»t
 = -
ENOSYS
;

625  
»t
;

626 
	}
}

628 
	$do_£t_ÿÎbacks
(
ev’t_add»ss
,

629 
ç§ã_add»ss
,

630 
sysÿÎ_add»ss
)

632 
ÿÎback_»gi¡”
 
ev’t
 = {

633 .
ty³
 = 
CALLBACKTYPE_ev’t
,

634 .
add»ss
 = 
ev’t_add»ss
,

636 
ÿÎback_»gi¡”
 
ç§ã
 = {

637 .
ty³
 = 
CALLBACKTYPE_ç§ã
,

638 .
add»ss
 = 
ç§ã_add»ss
,

640 
ÿÎback_»gi¡”
 
sysÿÎ
 = {

641 .
ty³
 = 
CALLBACKTYPE_sysÿÎ
,

642 .
add»ss
 = 
sysÿÎ_add»ss
,

645 
	`»gi¡”_gue¡_ÿÎback
(&
ev’t
);

646 
	`»gi¡”_gue¡_ÿÎback
(&
ç§ã
);

647 
	`»gi¡”_gue¡_ÿÎback
(&
sysÿÎ
);

650 
	}
}

652 
	$hy³rÿÎ_·ge_š™Ÿli£_ršg3_k”Ãl
(*
hy³rÿÎ_·ge
)

654 *
p
;

655 
i
;

658  
i
 = 0; i < (
PAGE_SIZE
 / 32); i++ )

660 
p
 = (*)(
hy³rÿÎ_·ge
 + (
i
 * 32));

661 *(
u8
 *)(
p
+ 0) = 0x51;

662 *(
u16
 *)(
p
+ 1) = 0x5341;

663 *(
u8
 *)(
p
+ 3) = 0xb8;

664 *(
u32
 *)(
p
+ 4èğ
i
;

665 *(
u16
 *)(
p
+ 8) = 0x050f;

666 *(
u16
 *)(
p
+10) = 0x5b41;

667 *(
u8
 *)(
p
+12) = 0x59;

668 *(
u8
 *)(
p
+13) = 0xc3;

676 
p
 = (*)(
hy³rÿÎ_·ge
 + (
__HYPERVISOR_œ‘
 * 32));

677 *(
u8
 *)(
p
+ 0) = 0x51;

678 *(
u16
 *)(
p
+ 1) = 0x5341;

679 *(
u8
 *)(
p
+ 3) = 0x50;

680 *(
u8
 *)(
p
+ 4) = 0xb8;

681 *(
u32
 *)(
p
+ 5èğ
__HYPERVISOR_œ‘
;

682 *(
u16
 *)(
p
+ 9) = 0x050f;

683 
	}
}

685 
	~"com·t/Œ­s.c
"

687 
	$hy³rÿÎ_·ge_š™Ÿli£
(
domaš
 *
d
, *
hy³rÿÎ_·ge
)

689 
	`mem£t
(
hy³rÿÎ_·ge
, 0xCC, 
PAGE_SIZE
);

690 iàĞ
	`is_hvm_domaš
(
d
) )

691 
	`hvm_hy³rÿÎ_·ge_š™Ÿli£
(
d
, 
hy³rÿÎ_·ge
);

692 iàĞ!
	`is_pv_32b™_domaš
(
d
) )

693 
	`hy³rÿÎ_·ge_š™Ÿli£_ršg3_k”Ãl
(
hy³rÿÎ_·ge
);

695 
	`hy³rÿÎ_·ge_š™Ÿli£_ršg1_k”Ãl
(
hy³rÿÎ_·ge
);

696 
	}
}

	@x86_emulate.c

12 
	~<asm/x86_emuÏ‹.h
>

15 #undeà
cmpxchg


17 
	~"x86_emuÏ‹/x86_emuÏ‹.c
"

	@x86_emulate/x86_emulate.c

25 
	#By‹Op
 (1<<0è

	)

27 
	#D¡NÚe
 (0<<1è

	)

28 
	#D¡Im¶ic™
 (0<<1è

	)

29 
	#D¡B™Ba£
 (1<<1è

	)

30 
	#D¡Reg
 (2<<1è

	)

31 
	#D¡Eax
 
D¡Reg


	)

32 
	#D¡Mem
 (3<<1è

	)

33 
	#D¡Mask
 (3<<1)

	)

35 
	#SrcInv®id
 (0<<3è

	)

36 
	#SrcNÚe
 (1<<3è

	)

37 
	#SrcIm¶ic™
 (1<<3è

	)

38 
	#SrcReg
 (2<<3è

	)

39 
	#SrcMem
 (3<<3è

	)

40 
	#SrcMem16
 (4<<3è

	)

41 
	#SrcImm
 (5<<3è

	)

42 
	#SrcImmBy‹
 (6<<3è

	)

43 
	#SrcMask
 (7<<3)

	)

45 
	#ModRM
 (1<<6)

	)

47 
	#Mov
 (1<<7)

	)

49 
	#Im¶ic™Ops
 (
D¡Im¶ic™
|
SrcIm¶ic™
)

	)

51 
ušt8_t
 
	gİcode_bË
[256] = {

53 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

54 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

55 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 
Im¶ic™Ops
, ImplicitOps,

57 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

58 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

59 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 
Im¶ic™Ops
, 0,

61 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

62 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

63 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 
Im¶ic™Ops
, ImplicitOps,

65 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

66 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

67 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 
Im¶ic™Ops
, ImplicitOps,

69 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

70 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

71 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 0, 
Im¶ic™Ops
,

73 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

74 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

75 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 0, 
Im¶ic™Ops
,

77 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

78 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

79 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 0, 
Im¶ic™Ops
,

81 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

82 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

83 
By‹Op
|
D¡Eax
|
SrcImm
, D¡Eax|SrcImm, 0, 
Im¶ic™Ops
,

85 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

86 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

87 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

88 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

90 
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov, ImplicitOps|Mov, ImplicitOps|Mov,

91 
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov, ImplicitOps|Mov, ImplicitOps|Mov,

92 
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov, ImplicitOps|Mov, ImplicitOps|Mov,

93 
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov, ImplicitOps|Mov, ImplicitOps|Mov,

95 
Im¶ic™Ops
, Im¶ic™Ops, 
D¡Reg
|
SrcMem
|
ModRM
, D¡Reg|
SrcMem16
|ModRM|
Mov
,

98 
Im¶ic™Ops
|
Mov
, 
D¡Reg
|
SrcImm
|
ModRM
|Mov,

99 
Im¶ic™Ops
|
Mov
, 
D¡Reg
|
SrcImmBy‹
|
ModRM
|Mov,

100 
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov, ImplicitOps|Mov, ImplicitOps|Mov,

102 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

103 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

105 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

106 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

108 
By‹Op
|
D¡Mem
|
SrcImm
|
ModRM
, DstMem|SrcImm|ModRM,

109 
By‹Op
|
D¡Mem
|
SrcImm
|
ModRM
, D¡Mem|
SrcImmBy‹
|ModRM,

110 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

111 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

113 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
|
Mov
, DstMem|SrcReg|ModRM|Mov,

114 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

115 
D¡Mem
|
SrcReg
|
ModRM
|
Mov
, 
D¡Reg
|
SrcNÚe
|ModRM,

116 
D¡Reg
|
SrcMem16
|
ModRM
|
Mov
, 
D¡Mem
|
SrcNÚe
|ModRM|Mov,

118 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

119 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

121 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

122 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

124 
By‹Op
|
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov,

125 
By‹Op
|
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov,

126 
By‹Op
|
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov,

127 
By‹Op
|
Im¶ic™Ops
, ImplicitOps,

129 
By‹Op
|
D¡Eax
|
SrcImm
, DstEax|SrcImm,

130 
By‹Op
|
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov,

131 
By‹Op
|
Im¶ic™Ops
|
Mov
, ImplicitOps|Mov,

132 
By‹Op
|
Im¶ic™Ops
, ImplicitOps,

134 
By‹Op
|
D¡Reg
|
SrcImm
|
Mov
, ByteOp|DstReg|SrcImm|Mov,

135 
By‹Op
|
D¡Reg
|
SrcImm
|
Mov
, ByteOp|DstReg|SrcImm|Mov,

136 
By‹Op
|
D¡Reg
|
SrcImm
|
Mov
, ByteOp|DstReg|SrcImm|Mov,

137 
By‹Op
|
D¡Reg
|
SrcImm
|
Mov
, ByteOp|DstReg|SrcImm|Mov,

139 
D¡Reg
|
SrcImm
|
Mov
, DstReg|SrcImm|Mov, DstReg|SrcImm|Mov, DstReg|SrcImm|Mov,

140 
D¡Reg
|
SrcImm
|
Mov
, DstReg|SrcImm|Mov, DstReg|SrcImm|Mov, DstReg|SrcImm|Mov,

142 
By‹Op
|
D¡Mem
|
SrcImm
|
ModRM
, D¡Mem|
SrcImmBy‹
|ModRM,

143 
Im¶ic™Ops
, ImplicitOps,

144 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

145 
By‹Op
|
D¡Mem
|
SrcImm
|
ModRM
|
Mov
, DstMem|SrcImm|ModRM|Mov,

147 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

148 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

150 
By‹Op
|
D¡Mem
|
SrcIm¶ic™
|
ModRM
, DstMem|SrcImplicit|ModRM,

151 
By‹Op
|
D¡Mem
|
SrcIm¶ic™
|
ModRM
, DstMem|SrcImplicit|ModRM,

152 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

154 
Im¶ic™Ops
|
ModRM
|
Mov
, ImplicitOps|ModRM|Mov,

155 
Im¶ic™Ops
|
ModRM
|
Mov
, ImplicitOps|ModRM|Mov,

156 
Im¶ic™Ops
|
ModRM
|
Mov
, ImplicitOps|ModRM|Mov,

157 
Im¶ic™Ops
|
ModRM
|
Mov
, ImplicitOps|ModRM|Mov,

159 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

160 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

162 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

163 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

165 0, 
Im¶ic™Ops
, 0, 0,

166 
Im¶ic™Ops
, ImplicitOps,

167 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
, DstMem|SrcNone|ModRM,

169 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

170 
Im¶ic™Ops
, Im¶ic™Ops, 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
, DstMem|SrcNone|ModRM

173 
ušt8_t
 
	gtwoby‹_bË
[256] = {

175 
SrcMem16
|
ModRM
, 
Im¶ic™Ops
|ModRM, 0, 0, 0, ImplicitOps, ImplicitOps, 0,

177 
Im¶ic™Ops
, Im¶ic™Ops, 0, 0, 0, Im¶ic™Ops|
ModRM
, 0, 0,

181 
Im¶ic™Ops
|
ModRM
, ImplicitOps|ModRM, ImplicitOps|ModRM, ImplicitOps|ModRM,

182 
Im¶ic™Ops
|
ModRM
, ImplicitOps|ModRM, ImplicitOps|ModRM, ImplicitOps|ModRM,

184 
Im¶ic™Ops
|
ModRM
, ImplicitOps|ModRM, ImplicitOps|ModRM, ImplicitOps|ModRM,

189 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, 0,

190 
Im¶ic™Ops
, ImplicitOps, 0, 0,

194 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

195 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

196 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

197 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

199 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

200 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

201 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

202 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

206 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
Im¶ic™Ops
|
ModRM
,

208 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 
Im¶ic™Ops
|
ModRM
,

210 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

211 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

213 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

214 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

216 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

217 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

218 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

219 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

221 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

222 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

223 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

224 
By‹Op
|
D¡Mem
|
SrcNÚe
|
ModRM
|
Mov
, ByteOp|DstMem|SrcNone|ModRM|Mov,

226 
Im¶ic™Ops
, Im¶ic™Ops, Im¶ic™Ops, 
D¡B™Ba£
|
SrcReg
|
ModRM
,

227 
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM, 0, 0,

229 
Im¶ic™Ops
, Im¶ic™Ops, 0, 
D¡B™Ba£
|
SrcReg
|
ModRM
,

230 
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

231 
Im¶ic™Ops
|
ModRM
, 
D¡Reg
|
SrcMem
|ModRM,

233 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

234 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, 
D¡B™Ba£
|
SrcReg
|ModRM,

235 
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, DstReg|SrcMem|ModRM|Mov,

236 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, D¡Reg|
SrcMem16
|ModRM|Mov,

238 0, 0, 
D¡B™Ba£
|
SrcImmBy‹
|
ModRM
, D¡B™Ba£|
SrcReg
|ModRM,

239 
D¡Reg
|
SrcMem
|
ModRM
, DstReg|SrcMem|ModRM,

240 
By‹Op
|
D¡Reg
|
SrcMem
|
ModRM
|
Mov
, D¡Reg|
SrcMem16
|ModRM|Mov,

242 
By‹Op
|
D¡Mem
|
SrcReg
|
ModRM
, DstMem|SrcReg|ModRM,

243 0, 
D¡Mem
|
SrcReg
|
ModRM
|
Mov
,

244 0, 0, 0, 
Im¶ic™Ops
|
ModRM
,

246 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

247 
Im¶ic™Ops
, ImplicitOps, ImplicitOps, ImplicitOps,

257 
	sİ”ªd
 {

258 ’um { 
	mOP_REG
, 
	mOP_MEM
, 
	mOP_IMM
, 
	mOP_NONE
 } 
	mty³
;

259 
	mby‹s
;

263 
	mv®
;

264 
ušt32_t
 
	mbigv®
[4];

269 
	mÜig_v®
;

270 
ušt32_t
 
	mÜig_bigv®
[4];

275 *
	m»g
;

278 
x86_£gm’t
 
	m£g
;

279 
	moff
;

280 } 
	mmem
;

285 
	#MSR_TSC
 0x00000010

	)

286 
	#MSR_SYSENTER_CS
 0x00000174

	)

287 
	#MSR_SYSENTER_ESP
 0x00000175

	)

288 
	#MSR_SYSENTER_EIP
 0x00000176

	)

289 
	#MSR_EFER
 0xc0000080

	)

290 
	#EFER_SCE
 (1u<<0)

	)

291 
	#EFER_LMA
 (1u<<10)

	)

292 
	#MSR_STAR
 0xc0000081

	)

293 
	#MSR_LSTAR
 0xc0000082

	)

294 
	#MSR_CSTAR
 0xc0000083

	)

295 
	#MSR_FMASK
 0xc0000084

	)

296 
	#MSR_TSC_AUX
 0xc0000103

	)

299 
	#CR0_PE
 (1<<0)

	)

300 
	#CR4_TSD
 (1<<2)

	)

303 
	#EFLG_VIP
 (1<<20)

	)

304 
	#EFLG_VIF
 (1<<19)

	)

305 
	#EFLG_AC
 (1<<18)

	)

306 
	#EFLG_VM
 (1<<17)

	)

307 
	#EFLG_RF
 (1<<16)

	)

308 
	#EFLG_NT
 (1<<14)

	)

309 
	#EFLG_IOPL
 (3<<12)

	)

310 
	#EFLG_OF
 (1<<11)

	)

311 
	#EFLG_DF
 (1<<10)

	)

312 
	#EFLG_IF
 (1<<9)

	)

313 
	#EFLG_TF
 (1<<8)

	)

314 
	#EFLG_SF
 (1<<7)

	)

315 
	#EFLG_ZF
 (1<<6)

	)

316 
	#EFLG_AF
 (1<<4)

	)

317 
	#EFLG_PF
 (1<<2)

	)

318 
	#EFLG_CF
 (1<<0)

	)

321 
	#EXC_DE
 0

	)

322 
	#EXC_DB
 1

	)

323 
	#EXC_BP
 3

	)

324 
	#EXC_OF
 4

	)

325 
	#EXC_BR
 5

	)

326 
	#EXC_UD
 6

	)

327 
	#EXC_TS
 10

	)

328 
	#EXC_NP
 11

	)

329 
	#EXC_SS
 12

	)

330 
	#EXC_GP
 13

	)

331 
	#EXC_PF
 14

	)

332 
	#EXC_MF
 16

	)

341 #ià
defšed
(
__x86_64__
)

342 
	#_LO32
 "k"

	)

343 
	#_STK
 "%%r¥"

	)

344 
	#_BYTES_PER_LONG
 "8"

	)

345 #–ià
defšed
(
__i386__
)

346 
	#_LO32
 ""

	)

347 
	#_STK
 "%%e¥"

	)

348 
	#_BYTES_PER_LONG
 "4"

	)

355 
	#EFLAGS_MASK
 (
EFLG_OF
|
EFLG_SF
|
EFLG_ZF
|
EFLG_AF
|
EFLG_PF
|
EFLG_CF
)

	)

358 
	#_PRE_EFLAGS
(
_§v
, 
_msk
, 
_tmp
) \

360 "movÈ%"
_§v
",%"
_LO32
 
_tmp
"; " \

361 "push %"
_tmp
"; " \

362 "push %"
_tmp
"; " \

363 "movÈ%"
_msk
",%"
_LO32
 
_tmp
"; " \

364 "ªdÈ%"
_LO32
 
_tmp
",("
_STK
"); " \

366 "nÙÈ%"
_LO32
 
_tmp
"; " \

367 "ªdÈ%"
_LO32
 
_tmp
",("
_STK
"); " \

368 "ªdÈ%"
_LO32
 
_tmp
",2*"
_BYTES_PER_LONG
"("
_STK
"); " \

369 "pİ %"
_tmp
"; " \

370 "ÜÈ %"
_LO32
 
_tmp
",("
_STK
"); " \

372 "pİ %"
_§v
"; "

	)

375 
	#_POST_EFLAGS
(
_§v
, 
_msk
, 
_tmp
) \

378 "pİ %"
_tmp
"; " \

379 "ªdÈ%"
_msk
",%"
_LO32
 
_tmp
"; " \

380 "ÜÈ %"
_LO32
 
_tmp
",%"
_§v
"; "

	)

383 
	#__emuÏ‹_2İ_noby‹
(
_İ
,
_¤c
,
_d¡
,
_eæags
,
_wx
,
_wy
,
_lx
,
_ly
,
_qx
,
_qy
)\

384 do{ 
_tmp
; \

385  (
_d¡
).
by‹s
 ) \

388 
asm
 volatile ( \

389 
	`_PRE_EFLAGS
("0","4","2") \

390 
_İ
"w %"
_wx
"3,%1; " \

391 
	`_POST_EFLAGS
("0","4","2") \

392 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

393 : 
	`_wy
 ((
_¤c
).
v®
), "i" (
EFLAGS_MASK
), \

394 "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

397 
asm
 volatile ( \

398 
	`_PRE_EFLAGS
("0","4","2") \

399 
_İ
"È%"
_lx
"3,%1; " \

400 
	`_POST_EFLAGS
("0","4","2") \

401 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

402 : 
	`_ly
 ((
_¤c
).
v®
), "i" (
EFLAGS_MASK
), \

403 "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

406 
	`__emuÏ‹_2İ_8by‹
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, 
_qx
, 
_qy
); \

409 } 0)

	)

410 
	#__emuÏ‹_2İ
(
_İ
,
_¤c
,
_d¡
,
_eæags
,
_bx
,
_by
,
_wx
,
_wy
,
_lx
,
_ly
,
_qx
,
_qy
)\

411 do{ 
_tmp
; \

412  (
_d¡
).
by‹s
 ) \

415 
asm
 volatile ( \

416 
	`_PRE_EFLAGS
("0","4","2") \

417 
_İ
"b %"
_bx
"3,%1; " \

418 
	`_POST_EFLAGS
("0","4","2") \

419 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

420 : 
	`_by
 ((
_¤c
).
v®
), "i" (
EFLAGS_MASK
), \

421 "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

424 
	`__emuÏ‹_2İ_noby‹
(
_İ
,
_¤c
,
_d¡
,
_eæags
,
_wx
,
_wy
,
_lx
,
_ly
,
_qx
,
_qy
);\

427 } 0)

	)

429 
	#emuÏ‹_2İ_SrcB
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
) \

430 
	`__emuÏ‹_2İ
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, \

431 "b", "c", "b", "c", "b", "c", "b", "c")

	)

433 
	#emuÏ‹_2İ_SrcV
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
) \

434 
	`__emuÏ‹_2İ
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, \

435 "b", "q", "w", "r", 
_LO32
, "r", "", "r")

	)

437 
	#emuÏ‹_2İ_SrcV_noby‹
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
) \

438 
	`__emuÏ‹_2İ_noby‹
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, \

439 "w", "r", 
_LO32
, "r", "", "r")

	)

442 
	#emuÏ‹_1İ
(
_İ
,
_d¡
,
_eæags
) \

443 do{ 
_tmp
; \

444  (
_d¡
).
by‹s
 ) \

447 
asm
 volatile ( \

448 
	`_PRE_EFLAGS
("0","3","2") \

449 
_İ
"b %1; " \

450 
	`_POST_EFLAGS
("0","3","2") \

451 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

452 : "i" (
EFLAGS_MASK
), "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

455 
asm
 volatile ( \

456 
	`_PRE_EFLAGS
("0","3","2") \

457 
_İ
"w %1; " \

458 
	`_POST_EFLAGS
("0","3","2") \

459 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

460 : "i" (
EFLAGS_MASK
), "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

463 
asm
 volatile ( \

464 
	`_PRE_EFLAGS
("0","3","2") \

465 
_İ
"l %1; " \

466 
	`_POST_EFLAGS
("0","3","2") \

467 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

468 : "i" (
EFLAGS_MASK
), "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

471 
	`__emuÏ‹_1İ_8by‹
(
_İ
, 
_d¡
, 
_eæags
); \

474 } 0)

	)

477 #ià
defšed
(
__x86_64__
)

478 
	#__emuÏ‹_2İ_8by‹
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, 
_qx
, 
_qy
) \

479 do{ 
asm
 volatile ( \

480 
	`_PRE_EFLAGS
("0","4","2") \

481 
_İ
"q %"
_qx
"3,%1; " \

482 
	`_POST_EFLAGS
("0","4","2") \

483 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

484 : 
	`_qy
 ((
_¤c
).
v®
), "i" (
EFLAGS_MASK
), \

485 "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

486 } 0)

	)

487 
	#__emuÏ‹_1İ_8by‹
(
_İ
, 
_d¡
, 
_eæags
) \

488 do{ 
asm
 volatile ( \

489 
	`_PRE_EFLAGS
("0","3","2") \

490 
_İ
"q %1; " \

491 
	`_POST_EFLAGS
("0","3","2") \

492 : "=m" (
_eæags
), "=m" ((
_d¡
).
v®
), "=&r" (
_tmp
) \

493 : "i" (
EFLAGS_MASK
), "m" (
_eæags
), "m" ((
_d¡
).
v®
) ); \

494 } 0)

	)

495 #–ià
defšed
(
__i386__
)

496 
	#__emuÏ‹_2İ_8by‹
(
_İ
, 
_¤c
, 
_d¡
, 
_eæags
, 
_qx
, 
_qy
)

	)

497 
	#__emuÏ‹_1İ_8by‹
(
_İ
, 
_d¡
, 
_eæags
)

	)

501 
	#š¢_ãtch_by‹s
(
_size
) \

502 ({ 
_x
 = 0, 
_e
 = 
_»gs
.
e
; \

503 iàĞ!
	`mode_64b™
(èè
_e
 = (
ušt32_t
)_eip; \

504 
_»gs
.
e
 +ğ(
_size
); \

505 
	`g’”©e_exû±iÚ_if
((
ušt8_t
)(
_»gs
.
e
 - 
ùxt
->
»gs
->eip) > 15, \

506 
EXC_GP
, 0); \

507 
rc
 = 
İs
->
	`š¢_ãtch
(
x86_£g_cs
, 
_e
, &
_x
, (
_size
), 
ùxt
); \

508 iàĞ
rc
 ) 
dÚe
; \

509 
_x
; \

510 })

	)

511 
	#š¢_ãtch_ty³
(
_ty³
è((_ty³)
	`š¢_ãtch_by‹s
((_ty³)))

	)

513 
	#Œunÿ‹_wÜd
(
—
, 
by‹_width
) \

514 ({ 
__—
 = (
—
); \

515 
_width
 = (
by‹_width
); \

516 ((
_width
 =ğ()è? 
__—
 : \

517 (
__—
 & ((1UL << (
_width
 << 3)) - 1))); \

518 })

	)

519 
	#Œunÿ‹_—
(
—
è
	`Œunÿ‹_wÜd
(Óa), 
ad_by‹s
)

	)

521 
	#mode_64b™
(è(
def_ad_by‹s
 =ğ8)

	)

523 
	#ç_if
(
p
) \

525 
rc
 = (
p
è? 
X86EMUL_UNHANDLEABLE
 : 
X86EMUL_OKAY
; \

526 iàĞ
rc
 ) 
dÚe
; \

527 } 0)

	)

529 
	#g’”©e_exû±iÚ_if
(
p
, 
e
, 
ec
) \

530 ({ iàĞ(
p
) ) { \

531 
	`ç_if
(
İs
->
šjeù_hw_exû±iÚ
 =ğ
NULL
); \

532 
rc
 = 
İs
->
	`šjeù_hw_exû±iÚ
(
e
, 
ec
, 
ùxt
è? : 
X86EMUL_EXCEPTION
; \

533 
dÚe
; \

535 })

	)

541 
	$ev’_·r™y
(
ušt8_t
 
v
)

543 
	`asm
 ( "‹¡ %b0,%b0; s‘°%b0" : "÷" (
v
) : "0" (v) );

544  
v
;

545 
	}
}

548 
	#_»gi¡”_add»ss_šüem’t
(
»g
, 
šc
, 
by‹_width
) \

550 
_šc
 = (
šc
); \

551 
_width
 = (
by‹_width
); \

552 iàĞ
_width
 == () ) \

553 (
»g
è+ğ
_šc
; \

554 iàĞ
	`mode_64b™
() ) \

555 (
»g
èğ(Ôegè+ 
_šc
è& ((1UL << (
_width
 << 3)) - 1); \

557 (
»g
èğ(Ôegè& ~((1UL << (
_width
 << 3)) - 1)) | \

558 (((
»g
è+ 
_šc
è& ((1UL << (
_width
 << 3)) - 1)); \

559 } 0)

	)

560 
	#»gi¡”_add»ss_šüem’t
(
»g
, 
šc
) \

561 
	`_»gi¡”_add»ss_šüem’t
((
»g
), (
šc
), 
ad_by‹s
)

	)

563 
	#¥_´e_dec
(
dec
) ({ \

564 
	`_»gi¡”_add»ss_šüem’t
(
_»gs
.
e¥
, -(
dec
), 
ùxt
->
¥_size
/8); \

565 
	`Œunÿ‹_wÜd
(
_»gs
.
e¥
, 
ùxt
->
¥_size
/8); \

566 })

	)

567 
	#¥_po¡_šc
(
šc
) ({ \

568 
__e¥
 = 
	`Œunÿ‹_wÜd
(
_»gs
.
e¥
, 
ùxt
->
¥_size
/8); \

569 
	`_»gi¡”_add»ss_šüem’t
(
_»gs
.
e¥
, (
šc
), 
ùxt
->
¥_size
/8); \

570 
__e¥
; \

571 })

	)

573 
	#jmp_»l
(
»l
) \

575 
_»l
 = ()(
»l
); \

576 
_»gs
.
e
 +ğ
_»l
; \

577 iàĞ
İ_by‹s
 == 2 ) \

578 
_»gs
.
e
 = (
ušt16_t
)_regs.eip; \

579 iàĞ!
	`mode_64b™
() ) \

580 
_»gs
.
e
 = (
ušt32_t
)_regs.eip; \

581 } 0)

	)

583 
	såu_š¢_ùxt
 {

584 
ušt8_t
 
	mš¢_by‹s
;

585 
ušt8_t
 
	mexn_¿i£d
;

588 
	$åu_hªdË_exû±iÚ
(*
_fic
, 
ıu_u£r_»gs
 *
»gs
)

590 
åu_š¢_ùxt
 *
fic
 = 
_fic
;

591 
fic
->
exn_¿i£d
 = 1;

592 
»gs
->
e
 +ğ
fic
->
š¢_by‹s
;

593 
	}
}

595 
	#g‘_åu
(
_ty³
, 
_fic
) \

596 do{ (
_fic
)->
exn_¿i£d
 = 0; \

597 
	`ç_if
(
İs
->
g‘_åu
 =ğ
NULL
); \

598 
rc
 = 
İs
->
	`g‘_åu
(
åu_hªdË_exû±iÚ
, 
_fic
, 
_ty³
, 
ùxt
); \

599 iàĞ
rc
 ) 
dÚe
; \

600 } 0)

	)

601 
	#put_åu
(
_fic
) \

603 iàĞ
İs
->
put_åu
 !ğ
NULL
 ) \

604 
İs
->
	`put_åu
(
ùxt
); \

605 
	`g’”©e_exû±iÚ_if
((
_fic
)->
exn_¿i£d
, 
EXC_MF
, -1); \

606 } 0)

	)

608 
	#emuÏ‹_åu_š¢
(
_İ
) \

609 do{ 
åu_š¢_ùxt
 
fic
; \

610 
	`g‘_åu
(
X86EMUL_FPU_åu
, &
fic
); \

611 
asm
 volatile ( \

613 "1: " 
_İ
 " \n" \

615 : "=m" (
fic
.
š¢_by‹s
) : : "memory" ); \

616 
	`put_åu
(&
fic
); \

617 } 0)

	)

619 
	#emuÏ‹_åu_š¢_memd¡
(
_İ
, 
_¬g
) \

620 do{ 
åu_š¢_ùxt
 
fic
; \

621 
	`g‘_åu
(
X86EMUL_FPU_åu
, &
fic
); \

622 
asm
 volatile ( \

624 "1: " 
_İ
 " %1 \n" \

626 : "=m" (
fic
.
š¢_by‹s
), "=m" (
_¬g
) \

628 
	`put_åu
(&
fic
); \

629 } 0)

	)

631 
	#emuÏ‹_åu_š¢_mem¤c
(
_İ
, 
_¬g
) \

632 do{ 
åu_š¢_ùxt
 
fic
; \

633 
	`g‘_åu
(
X86EMUL_FPU_åu
, &
fic
); \

634 
asm
 volatile ( \

636 "1: " 
_İ
 " %1 \n" \

638 : "=m" (
fic
.
š¢_by‹s
) \

639 : "m" (
_¬g
) : "memory" ); \

640 
	`put_åu
(&
fic
); \

641 } 0)

	)

643 
	#emuÏ‹_åu_š¢_¡ub
(
_by‹s
...) \

644 do{ 
ušt8_t
 
¡ub
[] = { 
_by‹s
, 0xc3 }; \

645 
åu_š¢_ùxt
 
fic
 = { .
š¢_by‹s
 = (
¡ub
)-1 }; \

646 
	`g‘_åu
(
X86EMUL_FPU_åu
, &
fic
); \

647 (*((*)())
¡ub
)(); \

648 
	`put_åu
(&
fic
); \

649 } 0)

	)

651 
	$__g‘_»p_´efix
(

652 
ıu_u£r_»gs
 *
št_»gs
,

653 
ıu_u£r_»gs
 *
ext_»gs
,

654 
ad_by‹s
)

656 
ecx
 = ((
ad_by‹s
 =ğ2è? (
ušt16_t
)
št_»gs
->ecx :

657 (
ad_by‹s
 =ğ4è? (
ušt32_t
)
št_»gs
->
ecx
 :

658 
št_»gs
->
ecx
);

661 iàĞ
ecx
 == 0 )

662 
ext_»gs
->
e
 = 
št_»gs
->eip;

664  
ecx
;

665 
	}
}

667 
	#g‘_»p_´efix
() ({ \

668 
max_»ps
 = 1; \

669 iàĞ
»p_´efix
 ) \

670 
max_»ps
 = 
	`__g‘_»p_´efix
(&
_»gs
, 
ùxt
->
»gs
, 
ad_by‹s
); \

671 iàĞ
max_»ps
 == 0 ) \

672 
dÚe
; \

673 
max_»ps
; \

674 })

	)

676 
	$__put_»p_´efix
(

677 
ıu_u£r_»gs
 *
št_»gs
,

678 
ıu_u£r_»gs
 *
ext_»gs
,

679 
ad_by‹s
,

680 
»ps_com¶‘ed
)

682 
ecx
 = ((
ad_by‹s
 =ğ2è? (
ušt16_t
)
št_»gs
->ecx :

683 (
ad_by‹s
 =ğ4è? (
ušt32_t
)
št_»gs
->
ecx
 :

684 
št_»gs
->
ecx
);

687 
ecx
 -ğ
»ps_com¶‘ed
;

688 iàĞ
ecx
 != 0 )

689 
št_»gs
->
e
 = 
ext_»gs
->eip;

691 iàĞ
ad_by‹s
 == 2 )

692 *(
ušt16_t
 *)&
št_»gs
->
ecx
 =ƒcx;

693 iàĞ
ad_by‹s
 == 4 )

694 
št_»gs
->
ecx
 = (
ušt32_t
)ecx;

696 
št_»gs
->
ecx
 =ƒcx;

697 
	}
}

699 
	#put_»p_´efix
(
»ps_com¶‘ed
) ({ \

700 iàĞ
»p_´efix
 ) \

701 
	`__put_»p_´efix
(&
_»gs
, 
ùxt
->
»gs
, 
ad_by‹s
, 
»ps_com¶‘ed
); \

702 })

	)

705 
	#Œunÿ‹_—_ªd_»ps
(
—
, 
»ps
, 
by‹s_³r_»p
) ({ \

706 
__todo
 = (
ùxt
->
»gs
->
eæags
 & 
EFLG_DF
è? (
—
) : ~(ea); \

707 
__todo
 = 
	`Œunÿ‹_wÜd
(__todo, 
ad_by‹s
); \

708 
__todo
 = (__todØ/ (
by‹s_³r_»p
)) + 1; \

709 (
»ps
èğ(
__todo
 < (reps)) ? __todo : (reps); \

710 
	`Œunÿ‹_wÜd
((
—
), 
ad_by‹s
); \

711 })

	)

714 
	$»ad_ulÚg
(

715 
x86_£gm’t
 
£g
,

716 
off£t
,

717 *
v®
,

718 
by‹s
,

719 
x86_emuÏ‹_ùxt
 *
ùxt
,

720 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

722 *
v®
 = 0;

723  
İs
->
	`»ad
(
£g
, 
off£t
, 
v®
, 
by‹s
, 
ùxt
);

724 
	}
}

731 
	$mul_dbl
(
m
[2])

733 
rc
;

734 
	`asm
 ( "mul %4; seto %b2"

735 : "÷" (
m
[0]), "=d" (m[1]), "=q" (
rc
)

736 : "0" (
m
[0]), "1" (m[1]), "2" (0) );

737  
rc
;

738 
	}
}

745 
	$imul_dbl
(
m
[2])

747 
rc
;

748 
	`asm
 ( "imul %4; seto %b2"

749 : "÷" (
m
[0]), "=d" (m[1]), "=q" (
rc
)

750 : "0" (
m
[0]), "1" (m[1]), "2" (0) );

751  
rc
;

752 
	}
}

760 
	$div_dbl
(
u
[2], 
v
)

762 iàĞ(
v
 =ğ0è|| (
u
[1] >= v) )

764 
	`asm
 ( "div %4"

765 : "÷" (
u
[0]), "=d" (u[1])

766 : "0" (
u
[0]), "1" (u[1]), "r" (
v
) );

768 
	}
}

778 
	$idiv_dbl
(
u
[2], 
v
)

780 
Ãgu
 = ()
u
[1] < 0, 
Ãgv
 = ()
v
 < 0;

783 iàĞ
Ãgu
 )

785 
u
[1] = ~u[1];

786 iàĞ(
u
[0] = -u[0]) == 0 )

787 
u
[1]++;

791 iàĞ
	`div_dbl
(
u
, 
Ãgv
 ? -
v
 : v) )

795 iàĞ
Ãgu
 )

796 
u
[1] = -u[1];

799 iàĞ
Ãgu
 ^ 
Ãgv
 )

801 iàĞ()
u
[0] >= 0 )

802 
u
[0] = -u[0];

803 iàĞ(
u
[0] << 1) != 0 )

806 iàĞ()
u
[0] < 0 )

810 
	}
}

813 
	$‹¡_cc
(

814 
cÚd™iÚ
, 
æags
)

816 
rc
 = 0;

818  (
cÚd™iÚ
 & 15) >> 1 )

821 
rc
 |ğ(
æags
 & 
EFLG_OF
);

824 
rc
 |ğ(
æags
 & 
EFLG_CF
);

827 
rc
 |ğ(
æags
 & 
EFLG_ZF
);

830 
rc
 |ğ(
æags
 & (
EFLG_CF
|
EFLG_ZF
));

833 
rc
 |ğ(
æags
 & 
EFLG_SF
);

836 
rc
 |ğ(
æags
 & 
EFLG_PF
);

839 
rc
 |ğ(
æags
 & 
EFLG_ZF
);

842 
rc
 |ğ(!(
æags
 & 
EFLG_SF
è!ğ!(æag & 
EFLG_OF
));

847  (!!
rc
 ^ (
cÚd™iÚ
 & 1));

848 
	}
}

851 
	$g‘_ıl
(

852 
x86_emuÏ‹_ùxt
 *
ùxt
,

853 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

855 
£gm’t_»gi¡”
 
»g
;

857 iàĞ
ùxt
->
»gs
->
eæags
 & 
EFLG_VM
 )

860 iàĞ(
İs
->
»ad_£gm’t
 =ğ
NULL
) ||

861 
İs
->
	`»ad_£gm’t
(
x86_£g_ss
, &
»g
, 
ùxt
) )

864  
»g
.
©Œ
.
f›lds
.
d¶
;

865 
	}
}

868 
	$_mode_iİl
(

869 
x86_emuÏ‹_ùxt
 *
ùxt
,

870 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

872 
ıl
 = 
	`g‘_ıl
(
ùxt
, 
İs
);

873 iàĞ
ıl
 == -1 )

875  (
ıl
 <ğ((
ùxt
->
»gs
->
eæags
 >> 12) & 3));

876 
	}
}

878 
	#mode_ršg0
() ({ \

879 
_ıl
 = 
	`g‘_ıl
(
ùxt
, 
İs
); \

880 
	`ç_if
(
_ıl
 < 0); \

881 (
_ıl
 == 0); \

882 })

	)

883 
	#mode_iİl
() ({ \

884 
_iİl
 = 
	`_mode_iİl
(
ùxt
, 
İs
); \

885 
	`ç_if
(
_iİl
 < 0); \

886 
_iİl
; \

887 })

	)

889 
	$iİÜt_acûss_check
(

890 
fœ¡_pÜt
,

891 
by‹s
,

892 
x86_emuÏ‹_ùxt
 *
ùxt
,

893 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

895 
iobmp
;

896 
£gm’t_»gi¡”
 
Œ
;

897 
rc
 = 
X86EMUL_OKAY
;

899 iàĞ!(
ùxt
->
»gs
->
eæags
 & 
EFLG_VM
è&& 
	`mode_iİl
() )

900  
X86EMUL_OKAY
;

902 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

903 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
x86_£g_Œ
, &
Œ
, 
ùxt
)) != 0 )

904  
rc
;

907 iàĞ!
Œ
.
©Œ
.
f›lds
.
p
 ||

908 ((
Œ
.
©Œ
.
f›lds
.
ty³
 & 0xd) != 0x9) ||

909 (
Œ
.
lim™
 < 0x67) )

910 
¿i£_exû±iÚ
;

912 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_nÚe
, 
Œ
.
ba£
 + 0x66,

913 &
iobmp
, 2, 
ùxt
, 
İs
)) )

914  
rc
;

917 
iobmp
 +ğ
fœ¡_pÜt
 / 8;

918 iàĞ
Œ
.
lim™
 <ğ
iobmp
 )

919 
¿i£_exû±iÚ
;

921 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_nÚe
, 
Œ
.
ba£
 + 
iobmp
,

922 &
iobmp
, 2, 
ùxt
, 
İs
)) )

923  
rc
;

924 iàĞ(
iobmp
 & (((1<<
by‹s
)-1è<< (
fœ¡_pÜt
&7))) != 0 )

925 
¿i£_exû±iÚ
;

927 
dÚe
:

928  
rc
;

930 
¿i£_exû±iÚ
:

931 
	`ç_if
(
İs
->
šjeù_hw_exû±iÚ
 =ğ
NULL
);

932  
İs
->
	`šjeù_hw_exû±iÚ
(
EXC_GP
, 0, 
ùxt
è? : 
X86EMUL_EXCEPTION
;

933 
	}
}

936 
	$š_»®mode
(

937 
x86_emuÏ‹_ùxt
 *
ùxt
,

938 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

940 
ü0
;

941 
rc
;

943 iàĞ
İs
->
»ad_ü
 =ğ
NULL
 )

946 
rc
 = 
İs
->
	`»ad_ü
(0, &
ü0
, 
ùxt
);

947  (!
rc
 && !(
ü0
 & 
CR0_PE
));

948 
	}
}

951 
	$š_´Ùmode
(

952 
x86_emuÏ‹_ùxt
 *
ùxt
,

953 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

955  !(
	`š_»®mode
(
ùxt
, 
İs
è|| (ùxt->
»gs
->
eæags
 & 
EFLG_VM
));

956 
	}
}

959 
	$š_lÚgmode
(

960 
x86_emuÏ‹_ùxt
 *
ùxt
,

961 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

963 
ušt64_t
 
eãr
;

965 ià(
İs
->
»ad_m¤
 =ğ
NULL
)

968 
İs
->
	`»ad_m¤
(
MSR_EFER
, &
eãr
, 
ùxt
);

969  !!(
eãr
 & 
EFER_LMA
);

970 
	}
}

973 
	$»®mode_lßd_£g
(

974 
x86_£gm’t
 
£g
,

975 
ušt16_t
 
£l
,

976 
x86_emuÏ‹_ùxt
 *
ùxt
,

977 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

979 
£gm’t_»gi¡”
 
»g
;

980 
rc
;

982 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
£g
, &
»g
, 
ùxt
)) != 0 )

983  
rc
;

985 
»g
.
£l
 = sel;

986 
»g
.
ba£
 = (
ušt32_t
)
£l
 << 4;

988  
İs
->
	`wr™e_£gm’t
(
£g
, &
»g
, 
ùxt
);

989 
	}
}

992 
	$´Ùmode_lßd_£g
(

993 
x86_£gm’t
 
£g
,

994 
ušt16_t
 
£l
,

995 
x86_emuÏ‹_ùxt
 *
ùxt
,

996 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

998 
£gm’t_»gi¡”
 
desùab
, 
ss
, 
£gr
;

999 ¡ruù { 
ušt32_t
 
a
, 
b
; } 
desc
;

1000 
v®
;

1001 
ušt8_t
 
d¶
, 
½l
, 
ıl
;

1002 
ušt32_t
 
Ãw_desc_b
, 
a_æag
 = 0x100;

1003 
rc
, 
çuÉ_ty³
 = 
EXC_GP
;

1006 iàĞ(
£l
 & 0xfffc) == 0 )

1008 iàĞ(
£g
 =ğ
x86_£g_cs
è|| (£g =ğ
x86_£g_ss
) )

1009 
¿i£_exn
;

1010 
	`mem£t
(&
£gr
, 0, (segr));

1011  
İs
->
	`wr™e_£gm’t
(
£g
, &
£gr
, 
ùxt
);

1015 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
è&& (
£l
 & 4) )

1016 
¿i£_exn
;

1018 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
x86_£g_ss
, &
ss
, 
ùxt
)) ||

1019 (
rc
 = 
İs
->
	`»ad_£gm’t
((
£l
 & 4è? 
x86_£g_ldŒ
 : 
x86_£g_gdŒ
,

1020 &
desùab
, 
ùxt
)) )

1021  
rc
;

1024 iàĞ((
£l
 & 0xfff8è+ 7è> 
desùab
.
lim™
 )

1025 
¿i£_exn
;

1027 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_nÚe
, 
desùab
.
ba£
 + (
£l
 & 0xfff8),

1028 &
v®
, 4, 
ùxt
, 
İs
)) )

1029  
rc
;

1030 
desc
.
a
 = 
v®
;

1031 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_nÚe
, 
desùab
.
ba£
 + (
£l
 & 0xfff8) + 4,

1032 &
v®
, 4, 
ùxt
, 
İs
)) )

1033  
rc
;

1034 
desc
.
b
 = 
v®
;

1037 iàĞ!(
desc
.
b
 & (1u<<15)) )

1039 
çuÉ_ty³
 = 
EXC_NP
;

1040 
¿i£_exn
;

1043 iàĞ!
	`is_x86_u£r_£gm’t
(
£g
) )

1046 iàĞ
desc
.
b
 & (1u << 12) )

1047 
¿i£_exn
;

1049 iàĞ
	`š_lÚgmode
(
ùxt
, 
İs
) )

1050  
X86EMUL_UNHANDLEABLE
;

1053 iàĞ!(
desc
.
b
 & (1u << 12)) )

1054 
¿i£_exn
;

1056 
d¶
 = (
desc
.
b
 >> 13) & 3;

1057 
½l
 = 
£l
 & 3;

1058 
ıl
 = 
ss
.
©Œ
.
f›lds
.
d¶
;

1060  
£g
 )

1062 
x86_£g_cs
:

1064 iàĞ!(
desc
.
b
 & (1u<<11)) )

1065 
¿i£_exn
;

1067 iàĞ((
desc
.
b
 & (6u<<9)è!ğ(6u<<9)è&& (
d¶
 !ğ
½l
) )

1068 
¿i£_exn
;

1070 
x86_£g_ss
:

1072 iàĞ(
desc
.
b
 & (5u<<9)) != (1u<<9) )

1073 
¿i£_exn
;

1074 iàĞ(
d¶
 !ğ
ıl
è|| (d¶ !ğ
½l
) )

1075 
¿i£_exn
;

1077 
x86_£g_ldŒ
:

1079 iàĞ(
desc
.
b
 & (15u<<8)) != (2u<<8) )

1080 
¿i£_exn
;

1081 
sk_acûs£d_æag
;

1082 
x86_£g_Œ
:

1084 iàĞ(
desc
.
b
 & (15u<<8)) != (9u<<8) )

1085 
¿i£_exn
;

1086 
a_æag
 = 0x200;

1090 iàĞ(
desc
.
b
 & (5u<<9)) == (4u<<9) )

1091 
¿i£_exn
;

1093 iàĞ((
desc
.
b
 & (6u<<9)) != (6u<<9)) &&

1094 ((
d¶
 < 
ıl
è|| (d¶ < 
½l
)) )

1095 
¿i£_exn
;

1100 
Ãw_desc_b
 = 
desc
.
b
 | 
a_æag
;

1101 iàĞ!(
desc
.
b
 & 
a_æag
) &&

1102 ((
rc
 = 
İs
->
	`cmpxchg
(

1103 
x86_£g_nÚe
, 
desùab
.
ba£
 + (
£l
 & 0xfff8) + 4,

1104 &
desc
.
b
, &
Ãw_desc_b
, 4, 
ùxt
)) != 0) )

1105  
rc
;

1108 
desc
.
b
 |ğ
a_æag
;

1110 
sk_acûs£d_æag
:

1111 
£gr
.
ba£
 = (((
desc
.
b
 << 0) & 0xff000000u) |

1112 ((
desc
.
b
 << 16) & 0x00ff0000u) |

1113 ((
desc
.
a
 >> 16) & 0x0000ffffu));

1114 
£gr
.
©Œ
.
by‹s
 = (((
desc
.
b
 >> 8) & 0x00ffu) |

1115 ((
desc
.
b
 >> 12) & 0x0f00u));

1116 
£gr
.
lim™
 = (
desc
.
b
 & 0x000f0000uè| (desc.
a
 & 0x0000ffffu);

1117 iàĞ
£gr
.
©Œ
.
f›lds
.
g
 )

1118 
£gr
.
lim™
 = (segr.limit << 12) | 0xfffu;

1119 
£gr
.
£l
 = sel;

1120  
İs
->
	`wr™e_£gm’t
(
£g
, &
£gr
, 
ùxt
);

1122 
¿i£_exn
:

1123 iàĞ
İs
->
šjeù_hw_exû±iÚ
 =ğ
NULL
 )

1124  
X86EMUL_UNHANDLEABLE
;

1125 iàĞ(
rc
 = 
İs
->
	`šjeù_hw_exû±iÚ
(
çuÉ_ty³
, 
£l
 & 0xfffc, 
ùxt
)) )

1126  
rc
;

1127  
X86EMUL_EXCEPTION
;

1128 
	}
}

1131 
	$lßd_£g
(

1132 
x86_£gm’t
 
£g
,

1133 
ušt16_t
 
£l
,

1134 
x86_emuÏ‹_ùxt
 *
ùxt
,

1135 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

1137 iàĞ(
İs
->
»ad_£gm’t
 =ğ
NULL
) ||

1138 (
İs
->
wr™e_£gm’t
 =ğ
NULL
) )

1139  
X86EMUL_UNHANDLEABLE
;

1141 iàĞ
	`š_´Ùmode
(
ùxt
, 
İs
) )

1142  
	`´Ùmode_lßd_£g
(
£g
, 
£l
, 
ùxt
, 
İs
);

1144  
	`»®mode_lßd_£g
(
£g
, 
£l
, 
ùxt
, 
İs
);

1145 
	}
}

1148 
	$decode_»gi¡”
(

1149 
ušt8_t
 
modrm_»g
, 
ıu_u£r_»gs
 *
»gs
, 
highby‹_»gs
)

1151 *
p
;

1153  
modrm_»g
 )

1155 0: 
p
 = &
»gs
->
—x
; ;

1156 1: 
p
 = &
»gs
->
ecx
; ;

1157 2: 
p
 = &
»gs
->
edx
; ;

1158 3: 
p
 = &
»gs
->
ebx
; ;

1159 4: 
p
 = (
highby‹_»gs
 ?

1160 ((*)&
»gs
->
—x
 + 1) :

1161 (*)&
»gs
->
e¥
); ;

1162 5: 
p
 = (
highby‹_»gs
 ?

1163 ((*)&
»gs
->
ecx
 + 1) :

1164 (*)&
»gs
->
ebp
); ;

1165 6: 
p
 = (
highby‹_»gs
 ?

1166 ((*)&
»gs
->
edx
 + 1) :

1167 (*)&
»gs
->
esi
); ;

1168 7: 
p
 = (
highby‹_»gs
 ?

1169 ((*)&
»gs
->
ebx
 + 1) :

1170 (*)&
»gs
->
edi
); ;

1171 #ià
	`defšed
(
__x86_64__
)

1172 8: 
p
 = &
»gs
->
r8
; ;

1173 9: 
p
 = &
»gs
->
r9
; ;

1174 10: 
p
 = &
»gs
->
r10
; ;

1175 11: 
p
 = &
»gs
->
r11
; ;

1176 12: 
p
 = &
»gs
->
r12
; ;

1177 13: 
p
 = &
»gs
->
r13
; ;

1178 14: 
p
 = &
»gs
->
r14
; ;

1179 15: 
p
 = &
»gs
->
r15
; ;

1181 : 
p
 = 
NULL
; ;

1184  
p
;

1185 
	}
}

1187 
	#decode_£gm’t_çed
 
x86_£g_Œ


	)

1188 
x86_£gm’t


1189 
	$decode_£gm’t
(
ušt8_t
 
modrm_»g
)

1191  
modrm_»g
 )

1193 0:  
x86_£g_es
;

1194 1:  
x86_£g_cs
;

1195 2:  
x86_£g_ss
;

1196 3:  
x86_£g_ds
;

1197 4:  
x86_£g_fs
;

1198 5:  
x86_£g_gs
;

1201  
decode_£gm’t_çed
;

1202 
	}
}

1205 
	$x86_emuÏ‹
(

1206 
x86_emuÏ‹_ùxt
 *
ùxt
,

1207 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
)

1210 
ıu_u£r_»gs
 
_»gs
 = *
ùxt
->
»gs
;

1212 
ušt8_t
 
b
, 
d
, 
sib
, 
sib_šdex
, 
sib_ba£
, 
twoby‹
 = 0, 
»x_´efix
 = 0;

1213 
ušt8_t
 
modrm
 = 0, 
modrm_mod
 = 0, 
modrm_»g
 = 0, 
modrm_rm
 = 0;

1214 
İ_by‹s
, 
def_İ_by‹s
, 
ad_by‹s
, 
def_ad_by‹s
;

1215 
	#REPE_PREFIX
 1

	)

1216 
	#REPNE_PREFIX
 2

	)

1217 
lock_´efix
 = 0, 
»p_´efix
 = 0;

1218 
ov”ride_£g
 = -1, 
rc
 = 
X86EMUL_OKAY
;

1219 
İ”ªd
 
¤c
, 
d¡
;

1225 
İ”ªd
 
—
 = { .
ty³
 = 
OP_MEM
 };

1226 
—
.
mem
.
£g
 = 
x86_£g_ds
;

1228 
ùxt
->
»tœe
.
by‹
 = 0;

1230 
İ_by‹s
 = 
def_İ_by‹s
 = 
ad_by‹s
 = 
def_ad_by‹s
 = 
ùxt
->
addr_size
/8;

1231 iàĞ
İ_by‹s
 == 8 )

1233 
İ_by‹s
 = 
def_İ_by‹s
 = 4;

1234 #iâdeà
__x86_64__


1235  
X86EMUL_UNHANDLEABLE
;

1242  
b
 = 
	`š¢_ãtch_ty³
(
ušt8_t
) )

1245 
İ_by‹s
 = 
def_İ_by‹s
 ^ 6;

1248 
ad_by‹s
 = 
def_ad_by‹s
 ^ (
	`mode_64b™
() ? 12 : 6);

1251 
ov”ride_£g
 = 
x86_£g_cs
;

1254 
ov”ride_£g
 = 
x86_£g_ds
;

1257 
ov”ride_£g
 = 
x86_£g_es
;

1260 
ov”ride_£g
 = 
x86_£g_fs
;

1263 
ov”ride_£g
 = 
x86_£g_gs
;

1266 
ov”ride_£g
 = 
x86_£g_ss
;

1269 
lock_´efix
 = 1;

1272 
»p_´efix
 = 
REPNE_PREFIX
;

1275 
»p_´efix
 = 
REPE_PREFIX
;

1278 iàĞ!
	`mode_64b™
() )

1279 
dÚe_´efixes
;

1280 
»x_´efix
 = 
b
;

1283 
dÚe_´efixes
;

1287 
»x_´efix
 = 0;

1289 
dÚe_´efixes
:

1291 iàĞ
»x_´efix
 & 8 )

1292 
İ_by‹s
 = 8;

1295 
d
 = 
İcode_bË
[
b
];

1296 iàĞ
d
 == 0 )

1299 iàĞ
b
 == 0x0f )

1301 
twoby‹
 = 1;

1302 
b
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

1303 
d
 = 
twoby‹_bË
[
b
];

1307 iàĞ
d
 == 0 )

1308 
ÿÂÙ_emuÏ‹
;

1312 
	`g’”©e_exû±iÚ_if
((
d
 & 
Mov
è&& 
lock_´efix
, 
EXC_GP
, 0);

1315 iàĞ
d
 & 
ModRM
 )

1317 
modrm
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

1318 
modrm_mod
 = (
modrm
 & 0xc0) >> 6;

1319 
modrm_»g
 = ((
»x_´efix
 & 4è<< 1è| ((
modrm
 & 0x38) >> 3);

1320 
modrm_rm
 = 
modrm
 & 0x07;

1322 iàĞ
modrm_mod
 == 3 )

1324 
modrm_rm
 |ğ(
»x_´efix
 & 1) << 3;

1325 
—
.
ty³
 = 
OP_REG
;

1326 
—
.
»g
 = 
	`decode_»gi¡”
(

1327 
modrm_rm
, &
_»gs
, (
d
 & 
By‹Op
è&& (
»x_´efix
 == 0));

1329 iàĞ
ad_by‹s
 == 2 )

1332  
modrm_rm
 )

1335 
—
.
mem
.
off
 = 
_»gs
.
ebx
 + _»gs.
esi
;

1338 
—
.
mem
.
off
 = 
_»gs
.
ebx
 + _»gs.
edi
;

1341 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1342 
—
.
mem
.
off
 = 
_»gs
.
ebp
 + _»gs.
esi
;

1345 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1346 
—
.
mem
.
off
 = 
_»gs
.
ebp
 + _»gs.
edi
;

1349 
—
.
mem
.
off
 = 
_»gs
.
esi
;

1352 
—
.
mem
.
off
 = 
_»gs
.
edi
;

1355 iàĞ
modrm_mod
 == 0 )

1357 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1358 
—
.
mem
.
off
 = 
_»gs
.
ebp
;

1361 
—
.
mem
.
off
 = 
_»gs
.
ebx
;

1364  
modrm_mod
 )

1367 iàĞ
modrm_rm
 == 6 )

1368 
—
.
mem
.
off
 = 
	`š¢_ãtch_ty³
(
št16_t
);

1371 
—
.
mem
.
off
 +ğ
	`š¢_ãtch_ty³
(
št8_t
);

1374 
—
.
mem
.
off
 +ğ
	`š¢_ãtch_ty³
(
št16_t
);

1377 
—
.
mem
.
off
 = 
	`Œunÿ‹_—
(ea.mem.off);

1382 iàĞ
modrm_rm
 == 4 )

1384 
sib
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

1385 
sib_šdex
 = ((
sib
 >> 3è& 7è| ((
»x_´efix
 << 2) & 8);

1386 
sib_ba£
 = (
sib
 & 7è| ((
»x_´efix
 << 3) & 8);

1387 iàĞ
sib_šdex
 != 4 )

1388 
—
.
mem
.
off
 = *(*)
	`decode_»gi¡”
(
sib_šdex
, &
_»gs
, 0);

1389 
—
.
mem
.
off
 <<ğ(
sib
 >> 6) & 3;

1390 iàĞ(
modrm_mod
 =ğ0è&& ((
sib_ba£
 & 7) == 5) )

1391 
—
.
mem
.
off
 +ğ
	`š¢_ãtch_ty³
(
št32_t
);

1392 iàĞ
sib_ba£
 == 4 )

1394 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1395 
—
.
mem
.
off
 +ğ
_»gs
.
e¥
;

1396 iàĞ!
twoby‹
 && (
b
 == 0x8f) )

1398 
—
.
mem
.
off
 +ğ((
	`mode_64b™
(è&& (
İ_by‹s
 == 4))

1399 ? 8 : 
İ_by‹s
);

1401 iàĞ
sib_ba£
 == 5 )

1403 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1404 
—
.
mem
.
off
 +ğ
_»gs
.
ebp
;

1407 
—
.
mem
.
off
 +ğ*(*)
	`decode_»gi¡”
(
sib_ba£
, &
_»gs
, 0);

1411 
modrm_rm
 |ğ(
»x_´efix
 & 1) << 3;

1412 
—
.
mem
.
off
 = *(*)
	`decode_»gi¡”
(
modrm_rm
, &
_»gs
, 0);

1413 iàĞ(
modrm_rm
 =ğ5è&& (
modrm_mod
 != 0) )

1414 
—
.
mem
.
£g
 = 
x86_£g_ss
;

1416  
modrm_mod
 )

1419 iàĞ(
modrm_rm
 & 7) != 5 )

1421 
—
.
mem
.
off
 = 
	`š¢_ãtch_ty³
(
št32_t
);

1422 iàĞ!
	`mode_64b™
() )

1425 
—
.
mem
.
off
 +ğ
_»gs
.
e
;

1426 iàĞ(
d
 & 
SrcMask
è=ğ
SrcImm
 )

1427 
—
.
mem
.
off
 +ğ(
d
 & 
By‹Op
) ? 1 :

1428 ((
İ_by‹s
 == 8) ? 4 : op_bytes);

1429 iàĞ(
d
 & 
SrcMask
è=ğ
SrcImmBy‹
 )

1430 
—
.
mem
.
off
 += 1;

1431 iàĞ!
twoby‹
 && ((
b
 & 0xfe) == 0xf6) &&

1432 ((
modrm_»g
 & 7) <= 1) )

1434 
—
.
mem
.
off
 +ğ(
d
 & 
By‹Op
) ? 1

1435 : ((
İ_by‹s
 == 8) ? 4 : op_bytes);

1436 iàĞ
twoby‹
 && ((
b
 & 0xf7) == 0xa4) )

1438 
—
.
mem
.
off
++;

1441 
—
.
mem
.
off
 +ğ
	`š¢_ãtch_ty³
(
št8_t
);

1444 
—
.
mem
.
off
 +ğ
	`š¢_ãtch_ty³
(
št32_t
);

1447 
—
.
mem
.
off
 = 
	`Œunÿ‹_—
(ea.mem.off);

1451 iàĞ
ov”ride_£g
 != -1 )

1452 
—
.
mem
.
£g
 = 
ov”ride_£g
;

1455  
d
 & 
SrcMask
 )

1457 
SrcNÚe
:

1458 
¤c
.
ty³
 = 
OP_NONE
;

1460 
SrcReg
:

1461 
¤c
.
ty³
 = 
OP_REG
;

1462 iàĞ
d
 & 
By‹Op
 )

1464 
¤c
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, (
»x_´efix
 == 0));

1465 
¤c
.
v®
 = *(
ušt8_t
 *)¤c.
»g
;

1466 
¤c
.
by‹s
 = 1;

1470 
¤c
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, 0);

1471  (
¤c
.
by‹s
 = 
İ_by‹s
) )

1473 2: 
¤c
.
v®
 = *(
ušt16_t
 *)¤c.
»g
; ;

1474 4: 
¤c
.
v®
 = *(
ušt32_t
 *)¤c.
»g
; ;

1475 8: 
¤c
.
v®
 = *(
ušt64_t
 *)¤c.
»g
; ;

1479 
SrcMem16
:

1480 
—
.
by‹s
 = 2;

1481 
¤cmem_commÚ
;

1482 
SrcMem
:

1483 
—
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

1484 
¤cmem_commÚ
:

1485 
¤c
 = 
—
;

1486 iàĞ
¤c
.
ty³
 =ğ
OP_REG
 )

1488  
¤c
.
by‹s
 )

1490 1: 
¤c
.
v®
 = *(
ušt8_t
 *)¤c.
»g
; ;

1491 2: 
¤c
.
v®
 = *(
ušt16_t
 *)¤c.
»g
; ;

1492 4: 
¤c
.
v®
 = *(
ušt32_t
 *)¤c.
»g
; ;

1493 8: 
¤c
.
v®
 = *(
ušt64_t
 *)¤c.
»g
; ;

1496 iàĞ(
rc
 = 
	`»ad_ulÚg
(
¤c
.
mem
.
£g
, src.mem.
off
,

1497 &
¤c
.
v®
, src.
by‹s
, 
ùxt
, 
İs
)) )

1498 
dÚe
;

1500 
SrcImm
:

1501 
¤c
.
ty³
 = 
OP_IMM
;

1502 
¤c
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

1503 iàĞ
¤c
.
by‹s
 == 8 ) src.bytes = 4;

1505  
¤c
.
by‹s
 )

1507 1: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št8_t
); ;

1508 2: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št16_t
); ;

1509 4: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št32_t
); ;

1512 
SrcImmBy‹
:

1513 
¤c
.
ty³
 = 
OP_IMM
;

1514 
¤c
.
by‹s
 = 1;

1515 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št8_t
);

1520  
d
 & 
D¡Mask
 )

1522 
D¡NÚe
:

1527 
	`g’”©e_exû±iÚ_if
(

1528 
lock_´efix
 &&

1529 ((
b
 < 0x20) || (b > 0x23)) &&

1530 (
b
 != 0xc7),

1531 
EXC_GP
, 0);

1532 
d¡
.
ty³
 = 
OP_NONE
;

1535 
D¡Reg
:

1536 
	`g’”©e_exû±iÚ_if
(
lock_´efix
, 
EXC_GP
, 0);

1537 
d¡
.
ty³
 = 
OP_REG
;

1538 iàĞ
d
 & 
By‹Op
 )

1540 
d¡
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, (
»x_´efix
 == 0));

1541 
d¡
.
v®
 = *(
ušt8_t
 *)d¡.
»g
;

1542 
d¡
.
by‹s
 = 1;

1546 
d¡
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, 0);

1547  (
d¡
.
by‹s
 = 
İ_by‹s
) )

1549 2: 
d¡
.
v®
 = *(
ušt16_t
 *)d¡.
»g
; ;

1550 4: 
d¡
.
v®
 = *(
ušt32_t
 *)d¡.
»g
; ;

1551 8: 
d¡
.
v®
 = *(
ušt64_t
 *)d¡.
»g
; ;

1555 
D¡B™Ba£
:

1556 iàĞ((
d
 & 
SrcMask
è=ğ
SrcImmBy‹
è|| (
—
.
ty³
 =ğ
OP_REG
) )

1558 
¤c
.
v®
 &ğ(
İ_by‹s
 << 3) - 1;

1568 iàĞ
İ_by‹s
 == 2 )

1569 
¤c
.
v®
 = (
št16_t
)src.val;

1570 iàĞ
İ_by‹s
 == 4 )

1571 
¤c
.
v®
 = (
št32_t
)src.val;

1572 iàĞ()
¤c
.
v®
 < 0 )

1574 
by‹_off£t
;

1575 
by‹_off£t
 = 
İ_by‹s
 + (((-
¤c
.
v®
-1) >> 3) & ~(op_bytes-1));

1576 
—
.
mem
.
off
 -ğ
by‹_off£t
;

1577 
¤c
.
v®
 = (
by‹_off£t
 << 3) + src.val;

1581 
—
.
mem
.
off
 +ğ(
¤c
.
v®
 >> 3è& ~(
İ_by‹s
 - 1);

1582 
¤c
.
v®
 &ğ(
İ_by‹s
 << 3) - 1;

1586 
d
 = (d & ~
D¡Mask
è| 
D¡Mem
;

1587 
D¡Mem
:

1588 
—
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

1589 
d¡
 = 
—
;

1590 iàĞ
d¡
.
ty³
 =ğ
OP_REG
 )

1592 
	`g’”©e_exû±iÚ_if
(
lock_´efix
, 
EXC_GP
, 0);

1593  
d¡
.
by‹s
 )

1595 1: 
d¡
.
v®
 = *(
ušt8_t
 *)d¡.
»g
; ;

1596 2: 
d¡
.
v®
 = *(
ušt16_t
 *)d¡.
»g
; ;

1597 4: 
d¡
.
v®
 = *(
ušt32_t
 *)d¡.
»g
; ;

1598 8: 
d¡
.
v®
 = *(
ušt64_t
 *)d¡.
»g
; ;

1601 iàĞ!(
d
 & 
Mov
) )

1603 iàĞ(
rc
 = 
	`»ad_ulÚg
(
d¡
.
mem
.
£g
, d¡.mem.
off
,

1604 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) )

1605 
dÚe
;

1606 
d¡
.
Üig_v®
 = d¡.
v®
;

1611 iàĞ
twoby‹
 )

1612 
twoby‹_š¢
;

1614  
b
 )

1616 0x00 ... 0x05: 
add
:

1617 
	`emuÏ‹_2İ_SrcV
("add", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1620 0x08 ... 0x0d: 
Ü
:

1621 
	`emuÏ‹_2İ_SrcV
("Ü", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1624 0x10 ... 0x15: 
adc
:

1625 
	`emuÏ‹_2İ_SrcV
("adc", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1628 0x18 ... 0x1d: 
sbb
:

1629 
	`emuÏ‹_2İ_SrcV
("sbb", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1632 0x20 ... 0x25: 
ªd
:

1633 
	`emuÏ‹_2İ_SrcV
("ªd", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1636 0x28 ... 0x2d: 
sub
:

1637 
	`emuÏ‹_2İ_SrcV
("sub", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1640 0x30 ... 0x35: 
xÜ
:

1641 
	`emuÏ‹_2İ_SrcV
("xÜ", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1644 0x38 ... 0x3d: 
cmp
:

1645 
	`emuÏ‹_2İ_SrcV
("cmp", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

1646 
d¡
.
ty³
 = 
OP_NONE
;

1650 
£gm’t_»gi¡”
 
»g
;

1651 
¤c
.
v®
 = 
x86_£g_es
;

1652 
push_£g
:

1653 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(è&& !
twoby‹
, 
EXC_UD
, -1);

1654 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

1655 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
¤c
.
v®
, &
»g
, 
ùxt
)) != 0 )

1656  
rc
;

1658 iàĞ
	`mode_64b™
(è&& (
İ_by‹s
 == 4) )

1659 
İ_by‹s
 = 8;

1660 iàĞ(
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

1661 &
»g
.
£l
, 
İ_by‹s
, 
ùxt
)) != 0 )

1662 
dÚe
;

1667 
¤c
.
v®
 = 
x86_£g_es
;

1668 
pİ_£g
:

1669 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(è&& !
twoby‹
, 
EXC_UD
, -1);

1670 
	`ç_if
(
İs
->
wr™e_£gm’t
 =ğ
NULL
);

1672 iàĞ
	`mode_64b™
(è&& (
İ_by‹s
 == 4) )

1673 
İ_by‹s
 = 8;

1674 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

1675 &
d¡
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) != 0 )

1676 
dÚe
;

1677 iàĞ(
rc
 = 
	`lßd_£g
(
¤c
.
v®
, (
ušt16_t
)
d¡
.v®, 
ùxt
, 
İs
)) != 0 )

1678  
rc
;

1682 
¤c
.
v®
 = 
x86_£g_cs
;

1683 
push_£g
;

1686 
¤c
.
v®
 = 
x86_£g_ss
;

1687 
push_£g
;

1690 
¤c
.
v®
 = 
x86_£g_ss
;

1691 
ùxt
->
»tœe
.
æags
.
mov_ss
 = 1;

1692 
pİ_£g
;

1695 
¤c
.
v®
 = 
x86_£g_ds
;

1696 
push_£g
;

1699 
¤c
.
v®
 = 
x86_£g_ds
;

1700 
pİ_£g
;

1703 
ušt8_t
 
®
 = 
_»gs
.
—x
;

1704 
eæags
 = 
_»gs
.eflags;

1705 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1706 
_»gs
.
eæags
 &ğ~(
EFLG_CF
|
EFLG_AF
);

1707 iàĞ((
®
 & 0x0fè> 9è|| (
eæags
 & 
EFLG_AF
) )

1709 *(
ušt8_t
 *)&
_»gs
.
—x
 += 6;

1710 
_»gs
.
eæags
 |ğ
EFLG_AF
;

1712 iàĞ(
®
 > 0x99è|| (
eæags
 & 
EFLG_CF
) )

1714 *(
ušt8_t
 *)&
_»gs
.
—x
 += 0x60;

1715 
_»gs
.
eæags
 |ğ
EFLG_CF
;

1717 
_»gs
.
eæags
 &ğ~(
EFLG_SF
|
EFLG_ZF
|
EFLG_PF
);

1718 
_»gs
.
eæags
 |ğ((
ušt8_t
)_»gs.
—x
 =ğ0è? 
EFLG_ZF
 : 0;

1719 
_»gs
.
eæags
 |ğ(Ğ
št8_t
)_»gs.
—x
 < 0è? 
EFLG_SF
 : 0;

1720 
_»gs
.
eæags
 |ğ
	`ev’_·r™y
(_»gs.
—x
è? 
EFLG_PF
 : 0;

1725 
ušt8_t
 
®
 = 
_»gs
.
—x
;

1726 
eæags
 = 
_»gs
.eflags;

1727 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1728 
_»gs
.
eæags
 &ğ~(
EFLG_CF
|
EFLG_AF
);

1729 iàĞ((
®
 & 0x0fè> 9è|| (
eæags
 & 
EFLG_AF
) )

1731 
_»gs
.
eæags
 |ğ
EFLG_AF
;

1732 iàĞ(
®
 < 6è|| (
eæags
 & 
EFLG_CF
) )

1733 
_»gs
.
eæags
 |ğ
EFLG_CF
;

1734 *(
ušt8_t
 *)&
_»gs
.
—x
 -= 6;

1736 iàĞ(
®
 > 0x99è|| (
eæags
 & 
EFLG_CF
) )

1738 *(
ušt8_t
 *)&
_»gs
.
—x
 -= 0x60;

1739 
_»gs
.
eæags
 |ğ
EFLG_CF
;

1741 
_»gs
.
eæags
 &ğ~(
EFLG_SF
|
EFLG_ZF
|
EFLG_PF
);

1742 
_»gs
.
eæags
 |ğ((
ušt8_t
)_»gs.
—x
 =ğ0è? 
EFLG_ZF
 : 0;

1743 
_»gs
.
eæags
 |ğ(Ğ
št8_t
)_»gs.
—x
 < 0è? 
EFLG_SF
 : 0;

1744 
_»gs
.
eæags
 |ğ
	`ev’_·r™y
(_»gs.
—x
è? 
EFLG_PF
 : 0;

1750 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1751 
_»gs
.
eæags
 &ğ~
EFLG_CF
;

1752 iàĞ((
ušt8_t
)
_»gs
.
—x
 > 9è|| (_»gs.
eæags
 & 
EFLG_AF
) )

1754 ((
ušt8_t
 *)&
_»gs
.
—x
)[0] +ğ(
b
 == 0x37) ? 6 : -6;

1755 ((
ušt8_t
 *)&
_»gs
.
—x
)[1] +ğ(
b
 == 0x37) ? 1 : -1;

1756 
_»gs
.
eæags
 |ğ
EFLG_CF
 | 
EFLG_AF
;

1758 ((
ušt8_t
 *)&
_»gs
.
—x
)[0] &= 0x0f;

1762 
d¡
.
ty³
 = 
OP_REG
;

1763 
d¡
.
»g
 = 
	`decode_»gi¡”
(
b
 & 7, &
_»gs
, 0);

1764 
d¡
.
by‹s
 = 
İ_by‹s
;

1765 
d¡
.
v®
 = *d¡.
»g
;

1766 iàĞ
b
 & 8 )

1767 
	`emuÏ‹_1İ
("dec", 
d¡
, 
_»gs
.
eæags
);

1769 
	`emuÏ‹_1İ
("šc", 
d¡
, 
_»gs
.
eæags
);

1773 
¤c
.
v®
 = *(*)
	`decode_»gi¡”
(

1774 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, 0);

1775 
push
;

1778 
d¡
.
ty³
 = 
OP_REG
;

1779 
d¡
.
»g
 = 
	`decode_»gi¡”
(

1780 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, 0);

1781 
d¡
.
by‹s
 = 
İ_by‹s
;

1782 iàĞ
	`mode_64b™
(è&& (
d¡
.
by‹s
 == 4) )

1783 
d¡
.
by‹s
 = 8;

1784 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
d¡
.
by‹s
),

1785 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

1786 
dÚe
;

1790 
i
;

1791 
»gs
[] = {

1792 
_»gs
.
—x
, _»gs.
ecx
, _»gs.
edx
, _»gs.
ebx
,

1793 
_»gs
.
e¥
, _»gs.
ebp
, _»gs.
esi
, _»gs.
edi
 };

1794 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1795  
i
 = 0; i < 8; i++ )

1796 iàĞ(
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

1797 &
»gs
[
i
], 
İ_by‹s
, 
ùxt
)) != 0 )

1798 
dÚe
;

1803 
i
;

1804 
dummy_e¥
, *
»gs
[] = {

1805 (*)&
_»gs
.
edi
, (*)&_»gs.
esi
,

1806 (*)&
_»gs
.
ebp
, (*)&
dummy_e¥
,

1807 (*)&
_»gs
.
ebx
, (*)&_»gs.
edx
,

1808 (*)&
_»gs
.
ecx
, (*)&_»gs.
—x
 };

1809 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1810  
i
 = 0; i < 8; i++ )

1812 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

1813 &
d¡
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) != 0 )

1814 
dÚe
;

1815  
İ_by‹s
 )

1817 1: *(
ušt8_t
 *)
»gs
[
i
] = (ušt8_t)
d¡
.
v®
; ;

1818 2: *(
ušt16_t
 *)
»gs
[
i
] = (ušt16_t)
d¡
.
v®
; ;

1819 4: *
»gs
[
i
] = (
ušt32_t
)
d¡
.
v®
; ;

1820 8: *
»gs
[
i
] = 
d¡
.
v®
; ;

1827 
¤c_v®2
;

1828 
lb
, 
ub
, 
idx
;

1829 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(è|| (
¤c
.
ty³
 !ğ
OP_MEM
),

1830 
EXC_UD
, -1);

1831 iàĞ(
rc
 = 
	`»ad_ulÚg
(
¤c
.
mem
.
£g
, src.mem.
off
 + 
İ_by‹s
,

1832 &
¤c_v®2
, 
İ_by‹s
, 
ùxt
, 
İs
)) )

1833 
dÚe
;

1834 
ub
 = (
İ_by‹s
 =ğ2è? (
št16_t
)
¤c_v®2
 : (
št32_t
)src_val2;

1835 
lb
 = (
İ_by‹s
 =ğ2è? (
št16_t
)
¤c
.
v®
 : (
št32_t
)src.val;

1836 
idx
 = (
İ_by‹s
 =ğ2è? (
št16_t
)
d¡
.
v®
 : (
št32_t
)dst.val;

1837 
	`g’”©e_exû±iÚ_if
((
idx
 < 
lb
è|| (idx > 
ub
), 
EXC_BR
, -1);

1838 
d¡
.
ty³
 = 
OP_NONE
;

1843 iàĞ
	`mode_64b™
() )

1846 iàĞ
¤c
.
ty³
 =ğ
OP_REG
 )

1847 
¤c
.
v®
 = *(
št32_t
 *)¤c.
»g
;

1848 iàĞ(
rc
 = 
	`»ad_ulÚg
(
¤c
.
mem
.
£g
, src.mem.
off
,

1849 &
¤c
.
v®
, 4, 
ùxt
, 
İs
)) )

1850 
dÚe
;

1851 
d¡
.
v®
 = (
št32_t
)
¤c
.val;

1856 
ušt16_t
 
¤c_v®
 = 
d¡
.
v®
;

1857 
d¡
 = 
¤c
;

1858 
_»gs
.
eæags
 &ğ~
EFLG_ZF
;

1859 
_»gs
.
eæags
 |ğ((
¤c_v®
 & 3è> (
d¡
.
v®
 & 3)è? 
EFLG_ZF
 : 0;

1860 iàĞ
_»gs
.
eæags
 & 
EFLG_ZF
 )

1861 
d¡
.
v®
 = (d¡.v® & ~3è| (
¤c_v®
 & 3);

1863 
d¡
.
ty³
 = 
OP_NONE
;

1864 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_UD
, -1);

1869 
¤c
.
v®
 = ((
İ_by‹s
 == 2)

1870 ? (
št32_t
)
	`š¢_ãtch_ty³
(
št16_t
)

1871 : 
	`š¢_ãtch_ty³
(
št32_t
));

1872 
push
;

1876 
¤c1
;

1877 iàĞ
—
.
ty³
 =ğ
OP_REG
 )

1878 
¤c1
 = *
—
.
»g
;

1879 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
,

1880 &
¤c1
, 
İ_by‹s
, 
ùxt
, 
İs
)) )

1881 
dÚe
;

1882 
_»gs
.
eæags
 &ğ~(
EFLG_OF
|
EFLG_CF
);

1883  
d¡
.
by‹s
 )

1886 
d¡
.
v®
 = ((
ušt32_t
)(
št16_t
)
¤c
.val *

1887 (
ušt32_t
)(
št16_t
)
¤c1
);

1888 iàĞ(
št16_t
)
d¡
.
v®
 !ğ(
ušt32_t
)dst.val )

1889 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

1891 #ifdeà
__x86_64__


1893 
d¡
.
v®
 = ((
ušt64_t
)(
št32_t
)
¤c
.val *

1894 (
ušt64_t
)(
št32_t
)
¤c1
);

1895 iàĞ(
št32_t
)
d¡
.
v®
 != dst.val )

1896 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

1900 
m
[2] = { 
¤c
.
v®
, 
¤c1
 };

1901 iàĞ
	`imul_dbl
(
m
) )

1902 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

1903 
d¡
.
v®
 = 
m
[0];

1911 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št8_t
);

1912 
push
:

1913 
d
 |ğ
Mov
;

1914 
d¡
.
ty³
 = 
OP_MEM
;

1915 
d¡
.
by‹s
 = 
İ_by‹s
;

1916 iàĞ
	`mode_64b™
(è&& (
d¡
.
by‹s
 == 4) )

1917 
d¡
.
by‹s
 = 8;

1918 
d¡
.
v®
 = 
¤c
.val;

1919 
d¡
.
mem
.
£g
 = 
x86_£g_ss
;

1920 
d¡
.
mem
.
off
 = 
	`¥_´e_dec
(d¡.
by‹s
);

1924 
Ä_»ps
 = 
	`g‘_»p_´efix
();

1925 
pÜt
 = (
ušt16_t
)
_»gs
.
edx
;

1926 
d¡
.
by‹s
 = !(
b
 & 1è? 1 : (
İ_by‹s
 == 8) ? 4 : op_bytes;

1927 
d¡
.
mem
.
£g
 = 
x86_£g_es
;

1928 
d¡
.
mem
.
off
 = 
	`Œunÿ‹_—_ªd_»ps
(
_»gs
.
edi
, 
Ä_»ps
, d¡.
by‹s
);

1929 iàĞ(
rc
 = 
	`iİÜt_acûss_check
(
pÜt
, 
d¡
.
by‹s
, 
ùxt
, 
İs
)) != 0 )

1930 
dÚe
;

1931 iàĞ(
Ä_»ps
 > 1è&& (
İs
->
»p_šs
 !ğ
NULL
) &&

1932 ((
rc
 = 
İs
->
	`»p_šs
(
pÜt
, 
d¡
.
mem
.
£g
, d¡.mem.
off
, d¡.
by‹s
,

1933 &
Ä_»ps
, 
ùxt
)è!ğ
X86EMUL_UNHANDLEABLE
) )

1935 iàĞ
rc
 != 0 )

1936 
dÚe
;

1940 
	`ç_if
(
İs
->
»ad_io
 =ğ
NULL
);

1941 iàĞ(
rc
 = 
İs
->
	`»ad_io
(
pÜt
, 
d¡
.
by‹s
, &d¡.
v®
, 
ùxt
)) != 0 )

1942 
dÚe
;

1943 
d¡
.
ty³
 = 
OP_MEM
;

1944 
Ä_»ps
 = 1;

1946 
	`»gi¡”_add»ss_šüem’t
(

1947 
_»gs
.
edi
,

1948 
Ä_»ps
 * ((
_»gs
.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes));

1949 
	`put_»p_´efix
(
Ä_»ps
);

1954 
Ä_»ps
 = 
	`g‘_»p_´efix
();

1955 
pÜt
 = (
ušt16_t
)
_»gs
.
edx
;

1956 
d¡
.
by‹s
 = !(
b
 & 1è? 1 : (
İ_by‹s
 == 8) ? 4 : op_bytes;

1957 
—
.
mem
.
off
 = 
	`Œunÿ‹_—_ªd_»ps
(
_»gs
.
esi
, 
Ä_»ps
, 
d¡
.
by‹s
);

1958 iàĞ(
rc
 = 
	`iİÜt_acûss_check
(
pÜt
, 
d¡
.
by‹s
, 
ùxt
, 
İs
)) != 0 )

1959 
dÚe
;

1960 iàĞ(
Ä_»ps
 > 1è&& (
İs
->
»p_outs
 !ğ
NULL
) &&

1961 ((
rc
 = 
İs
->
	`»p_outs
(
—
.
mem
.
£g
,ƒa.mem.
off
, 
pÜt
, 
d¡
.
by‹s
,

1962 &
Ä_»ps
, 
ùxt
)è!ğ
X86EMUL_UNHANDLEABLE
) )

1964 iàĞ
rc
 != 0 )

1965 
dÚe
;

1969 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
esi
),

1970 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

1971 
dÚe
;

1972 
	`ç_if
(
İs
->
wr™e_io
 =ğ
NULL
);

1973 iàĞ(
rc
 = 
İs
->
	`wr™e_io
(
pÜt
, 
d¡
.
by‹s
, d¡.
v®
, 
ùxt
)) != 0 )

1974 
dÚe
;

1975 
Ä_»ps
 = 1;

1977 
	`»gi¡”_add»ss_šüem’t
(

1978 
_»gs
.
esi
,

1979 
Ä_»ps
 * ((
_»gs
.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes));

1980 
	`put_»p_´efix
(
Ä_»ps
);

1985 
»l
 = 
	`š¢_ãtch_ty³
(
št8_t
);

1986 iàĞ
	`‹¡_cc
(
b
, 
_»gs
.
eæags
) )

1987 
	`jmp_»l
(
»l
);

1992 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

1994  
modrm_»g
 & 7 )

1996 0: 
add
;

1997 1: 
Ü
;

1998 2: 
adc
;

1999 3: 
sbb
;

2000 4: 
ªd
;

2001 5: 
sub
;

2002 6: 
xÜ
;

2003 7: 
cmp
;

2008 0x84 ... 0x85: 
‹¡
:

2009 
	`emuÏ‹_2İ_SrcV
("‹¡", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2010 
d¡
.
ty³
 = 
OP_NONE
;

2013 0x86 ... 0x87: 
xchg
:

2015  
d¡
.
by‹s
 )

2017 1: *(
ušt8_t
 *)
¤c
.
»g
 = (ušt8_t)
d¡
.
v®
; ;

2018 2: *(
ušt16_t
 *)
¤c
.
»g
 = (ušt16_t)
d¡
.
v®
; ;

2019 4: *
¤c
.
»g
 = (
ušt32_t
)
d¡
.
v®
; ;

2020 8: *
¤c
.
»g
 = 
d¡
.
v®
; ;

2023 
d¡
.
v®
 = 
¤c
.val;

2024 
lock_´efix
 = 1;

2028 
	`g’”©e_exû±iÚ_if
((
modrm_»g
 & 7è!ğ0, 
EXC_UD
, -1);

2030 
d¡
.
v®
 = 
¤c
.val;

2034 
£gm’t_»gi¡”
 
»g
;

2035 
x86_£gm’t
 
£g
 = 
	`decode_£gm’t
(
modrm_»g
);

2036 
	`g’”©e_exû±iÚ_if
(
£g
 =ğ
decode_£gm’t_çed
, 
EXC_UD
, -1);

2037 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

2038 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
£g
, &
»g
, 
ùxt
)) != 0 )

2039 
dÚe
;

2040 
d¡
.
v®
 = 
»g
.
£l
;

2041 iàĞ
d¡
.
ty³
 =ğ
OP_MEM
 )

2042 
d¡
.
by‹s
 = 2;

2047 
x86_£gm’t
 
£g
 = 
	`decode_£gm’t
(
modrm_»g
);

2048 
	`g’”©e_exû±iÚ_if
(
£g
 =ğ
decode_£gm’t_çed
, 
EXC_UD
, -1);

2049 
	`g’”©e_exû±iÚ_if
(
£g
 =ğ
x86_£g_cs
, 
EXC_UD
, -1);

2050 iàĞ(
rc
 = 
	`lßd_£g
(
£g
, (
ušt16_t
)
¤c
.
v®
, 
ùxt
, 
İs
)) != 0 )

2051 
dÚe
;

2052 iàĞ
£g
 =ğ
x86_£g_ss
 )

2053 
ùxt
->
»tœe
.
æags
.
mov_ss
 = 1;

2054 
d¡
.
ty³
 = 
OP_NONE
;

2059 
d¡
.
v®
 = 
—
.
mem
.
off
;

2063 
	`g’”©e_exû±iÚ_if
((
modrm_»g
 & 7è!ğ0, 
EXC_UD
, -1);

2065 iàĞ
	`mode_64b™
(è&& (
d¡
.
by‹s
 == 4) )

2066 
d¡
.
by‹s
 = 8;

2067 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
d¡
.
by‹s
),

2068 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

2069 
dÚe
;

2073 iàĞ!(
»x_´efix
 & 1) )

2077 
¤c
.
ty³
 = 
d¡
.ty³ = 
OP_REG
;

2078 
¤c
.
by‹s
 = 
d¡
.by‹ ğ
İ_by‹s
;

2079 
¤c
.
»g
 = (*)&
_»gs
.
—x
;

2080 
¤c
.
v®
 = *¤c.
»g
;

2081 
d¡
.
»g
 = 
	`decode_»gi¡”
(

2082 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, 0);

2083 
d¡
.
v®
 = *d¡.
»g
;

2084 
xchg
;

2087  
İ_by‹s
 )

2089 2: *(
št16_t
 *)&
_»gs
.
—x
 = (
št8_t
)_regs.eax; ;

2090 4: 
_»gs
.
—x
 = (
ušt32_t
)(
št16_t
)_regs.eax; ;

2091 8: 
_»gs
.
—x
 = (
št32_t
)_regs.eax; ;

2096  
İ_by‹s
 )

2099 *(
št16_t
 *)&
_»gs
.
edx
 = ((št16_t)_»gs.
—x
 < 0) ? -1 : 0;

2102 
_»gs
.
edx
 = (
ušt32_t
)(((
št32_t
)_»gs.
—x
 < 0) ? -1 : 0);

2104 #ifdeà
__x86_64__


2106 
_»gs
.
edx
 = ((
št64_t
)_»gs.
—x
 < 0) ? -1 : 0;

2113 
£gm’t_»gi¡”
 
»g
;

2114 
ušt16_t
 
£l
;

2115 
ušt32_t
 
e
;

2117 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

2118 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

2120 
e
 = 
	`š¢_ãtch_by‹s
(
İ_by‹s
);

2121 
£l
 = 
	`š¢_ãtch_ty³
(
ušt16_t
);

2123 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
x86_£g_cs
, &
»g
, 
ùxt
)) ||

2124 (
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

2125 &
»g
.
£l
, 
İ_by‹s
, 
ùxt
)) ||

2126 (
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

2127 &
_»gs
.
e
, 
İ_by‹s
, 
ùxt
)) )

2128 
dÚe
;

2130 iàĞ(
rc
 = 
	`lßd_£g
(
x86_£g_cs
, 
£l
, 
ùxt
, 
İs
)) != 0 )

2131 
dÚe
;

2132 
_»gs
.
e
 =ƒip;

2137 
	`emuÏ‹_åu_š¢
("fwait");

2141 
¤c
.
v®
 = 
_»gs
.
eæags
;

2142 
push
;

2145 
ušt32_t
 
mask
 = 
EFLG_VIP
 | 
EFLG_VIF
 | 
EFLG_VM
;

2146 iàĞ!
	`mode_ršg0
() )

2147 
mask
 |ğ
EFLG_IOPL
;

2148 iàĞ!
	`mode_iİl
() )

2149 
mask
 |ğ
EFLG_IF
;

2151 iàĞ
	`mode_64b™
(è&& (
İ_by‹s
 == 4) )

2152 
İ_by‹s
 = 8;

2153 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

2154 &
d¡
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) != 0 )

2155 
dÚe
;

2156 iàĞ
İ_by‹s
 == 2 )

2157 
d¡
.
v®
 = (
ušt16_t
)d¡.v® | (
_»gs
.
eæags
 & 0xffff0000u);

2158 
d¡
.
v®
 &= 0x257fd5;

2159 
_»gs
.
eæags
 &ğ
mask
;

2160 
_»gs
.
eæags
 |ğ(
ušt32_t
)(
d¡
.
v®
 & ~
mask
) | 0x02;

2165 *(
ušt8_t
 *)&
_»gs
.
eæags
 = (((ušt8_ˆ*)&_»gs.
—x
)[1] & 0xd7) | 0x02;

2169 ((
ušt8_t
 *)&
_»gs
.
—x
)[1] = (_»gs.
eæags
 & 0xd7) | 0x02;

2174 
d¡
.
ty³
 = 
OP_REG
;

2175 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

2176 
d¡
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2177 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`š¢_ãtch_by‹s
(
ad_by‹s
),

2178 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

2179 
dÚe
;

2184 
d¡
.
ty³
 = 
OP_MEM
;

2185 
d¡
.
mem
.
£g
 = 
—
.mem.seg;

2186 
d¡
.
mem
.
off
 = 
	`š¢_ãtch_by‹s
(
ad_by‹s
);

2187 
d¡
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2188 
d¡
.
v®
 = ()
_»gs
.
—x
;

2192 
Ä_»ps
 = 
	`g‘_»p_´efix
();

2193 
d¡
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2194 
d¡
.
mem
.
£g
 = 
x86_£g_es
;

2195 
d¡
.
mem
.
off
 = 
	`Œunÿ‹_—_ªd_»ps
(
_»gs
.
edi
, 
Ä_»ps
, d¡.
by‹s
);

2196 iàĞ(
Ä_»ps
 > 1è&& (
İs
->
»p_movs
 !ğ
NULL
) &&

2197 ((
rc
 = 
İs
->
	`»p_movs
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
esi
),

2198 
d¡
.
mem
.
£g
, d¡.mem.
off
, d¡.
by‹s
,

2199 &
Ä_»ps
, 
ùxt
)è!ğ
X86EMUL_UNHANDLEABLE
) )

2201 iàĞ
rc
 != 0 )

2202 
dÚe
;

2206 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
esi
),

2207 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

2208 
dÚe
;

2209 
d¡
.
ty³
 = 
OP_MEM
;

2210 
Ä_»ps
 = 1;

2212 
	`»gi¡”_add»ss_šüem’t
(

2213 
_»gs
.
esi
,

2214 
Ä_»ps
 * ((
_»gs
.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes));

2215 
	`»gi¡”_add»ss_šüem’t
(

2216 
_»gs
.
edi
,

2217 
Ä_»ps
 * ((
_»gs
.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes));

2218 
	`put_»p_´efix
(
Ä_»ps
);

2223 
Ãxt_e
 = 
_»gs
.
e
;

2224 
	`g‘_»p_´efix
();

2225 
¤c
.
by‹s
 = 
d¡
.by‹ ğ(
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2226 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
esi
),

2227 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) ||

2228 (
rc
 = 
	`»ad_ulÚg
(
x86_£g_es
, 
	`Œunÿ‹_—
(
_»gs
.
edi
),

2229 &
¤c
.
v®
, src.
by‹s
, 
ùxt
, 
İs
)) )

2230 
dÚe
;

2231 
	`»gi¡”_add»ss_šüem’t
(

2232 
_»gs
.
esi
, (_»gs.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes);

2233 
	`»gi¡”_add»ss_šüem’t
(

2234 
_»gs
.
edi
, (_»gs.
eæags
 & 
EFLG_DF
è? -
¤c
.
by‹s
 : src.bytes);

2235 
	`put_»p_´efix
(1);

2237 
	`emuÏ‹_2İ_SrcV
("cmp", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2238 iàĞ((
»p_´efix
 =ğ
REPE_PREFIX
è&& !(
_»gs
.
eæags
 & 
EFLG_ZF
)) ||

2239 ((
»p_´efix
 =ğ
REPNE_PREFIX
è&& (
_»gs
.
eæags
 & 
EFLG_ZF
)) )

2240 
_»gs
.
e
 = 
Ãxt_e
;

2245  
	`g‘_»p_´efix
();

2246 
d¡
.
ty³
 = 
OP_MEM
;

2247 
d¡
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2248 
d¡
.
mem
.
£g
 = 
x86_£g_es
;

2249 
d¡
.
mem
.
off
 = 
	`Œunÿ‹_—
(
_»gs
.
edi
);

2250 
d¡
.
v®
 = 
_»gs
.
—x
;

2251 
	`»gi¡”_add»ss_šüem’t
(

2252 
_»gs
.
edi
, (_»gs.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes);

2253 
	`put_»p_´efix
(1);

2258  
	`g‘_»p_´efix
();

2259 
d¡
.
ty³
 = 
OP_REG
;

2260 
d¡
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2261 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

2262 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
esi
),

2263 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) != 0 )

2264 
dÚe
;

2265 
	`»gi¡”_add»ss_šüem’t
(

2266 
_»gs
.
esi
, (_»gs.
eæags
 & 
EFLG_DF
è? -
d¡
.
by‹s
 : dst.bytes);

2267 
	`put_»p_´efix
(1);

2272 
Ãxt_e
 = 
_»gs
.
e
;

2273 
	`g‘_»p_´efix
();

2274 
¤c
.
by‹s
 = 
d¡
.by‹ ğ(
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

2275 
d¡
.
v®
 = 
_»gs
.
—x
;

2276 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_es
, 
	`Œunÿ‹_—
(
_»gs
.
edi
),

2277 &
¤c
.
v®
, src.
by‹s
, 
ùxt
, 
İs
)) != 0 )

2278 
dÚe
;

2279 
	`»gi¡”_add»ss_šüem’t
(

2280 
_»gs
.
edi
, (_»gs.
eæags
 & 
EFLG_DF
è? -
¤c
.
by‹s
 : src.bytes);

2281 
	`put_»p_´efix
(1);

2283 
	`emuÏ‹_2İ_SrcV
("cmp", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2284 iàĞ((
»p_´efix
 =ğ
REPE_PREFIX
è&& !(
_»gs
.
eæags
 & 
EFLG_ZF
)) ||

2285 ((
»p_´efix
 =ğ
REPNE_PREFIX
è&& (
_»gs
.
eæags
 & 
EFLG_ZF
)) )

2286 
_»gs
.
e
 = 
Ãxt_e
;

2291 
d¡
.
»g
 = 
	`decode_»gi¡”
(

2292 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, (rex_prefix == 0));

2293 
d¡
.
v®
 = 
¤c
.val;

2297 iàĞ
d¡
.
by‹s
 == 8 )

2298 
¤c
.
v®
 = ((
ušt32_t
)src.val |

2299 ((
ušt64_t
)
	`š¢_ãtch_ty³
(
ušt32_t
) << 32));

2300 
d¡
.
»g
 = 
	`decode_»gi¡”
(

2301 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, 0);

2302 
d¡
.
v®
 = 
¤c
.val;

2305 0xc0 ... 0xc1: 
g½2
:

2306  
modrm_»g
 & 7 )

2309 
	`emuÏ‹_2İ_SrcB
("rŞ", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2312 
	`emuÏ‹_2İ_SrcB
("rÜ", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2315 
	`emuÏ‹_2İ_SrcB
("rş", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2318 
	`emuÏ‹_2İ_SrcB
("rü", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2322 
	`emuÏ‹_2İ_SrcB
("§l", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2325 
	`emuÏ‹_2İ_SrcB
("shr", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2328 
	`emuÏ‹_2İ_SrcB
("§r", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

2335 
off£t
 = (
b
 =ğ0xc2è? 
	`š¢_ãtch_ty³
(
ušt16_t
) : 0;

2336 
İ_by‹s
 = ((İ_by‹ =ğ4è&& 
	`mode_64b™
()) ? 8 : op_bytes;

2337 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
 + 
off£t
),

2338 &
d¡
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) != 0 )

2339 
dÚe
;

2340 
_»gs
.
e
 = 
d¡
.
v®
;

2345 
£l
;

2346 
d¡
.
v®
 = 
x86_£g_es
;

2347 
Ës
:

2348 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(è&& !
twoby‹
, 
EXC_UD
, -1);

2349 
	`g’”©e_exû±iÚ_if
(
¤c
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

2350 iàĞ(
rc
 = 
	`»ad_ulÚg
(
¤c
.
mem
.
£g
, src.mem.
off
 + src.
by‹s
,

2351 &
£l
, 2, 
ùxt
, 
İs
)) != 0 )

2352 
dÚe
;

2353 iàĞ(
rc
 = 
	`lßd_£g
(
d¡
.
v®
, (
ušt16_t
)
£l
, 
ùxt
, 
İs
)) != 0 )

2354 
dÚe
;

2355 
d¡
.
v®
 = 
¤c
.val;

2360 
d¡
.
v®
 = 
x86_£g_ds
;

2361 
Ës
;

2364 
ušt16_t
 
size
 = 
	`š¢_ãtch_ty³
(uint16_t);

2365 
ušt8_t
 
d•th
 = 
	`š¢_ãtch_ty³
(uint8_t) & 31;

2366 
i
;

2368 
d¡
.
ty³
 = 
OP_REG
;

2369 
d¡
.
by‹s
 = (
	`mode_64b™
(è&& (
İ_by‹s
 == 4)) ? 8 : op_bytes;

2370 
d¡
.
»g
 = (*)&
_»gs
.
ebp
;

2371 iàĞ(
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
d¡
.
by‹s
),

2372 &
_»gs
.
ebp
, 
d¡
.
by‹s
, 
ùxt
)) )

2373 
dÚe
;

2374 
d¡
.
v®
 = 
_»gs
.
e¥
;

2376 iàĞ
d•th
 > 0 )

2378  
i
 = 1; i < 
d•th
; i++ )

2380 
ebp
, 
‹mp_d©a
;

2381 
ebp
 = 
	`Œunÿ‹_wÜd
(
_»gs
.eb°- 
i
*
d¡
.
by‹s
, 
ùxt
->
¥_size
/8);

2382 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
ebp
,

2383 &
‹mp_d©a
, 
d¡
.
by‹s
, 
ùxt
, 
İs
)) ||

2384 (
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
d¡
.
by‹s
),

2385 &
‹mp_d©a
, 
d¡
.
by‹s
, 
ùxt
)) )

2386 
dÚe
;

2388 iàĞ(
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
d¡
.
by‹s
),

2389 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
)) )

2390 
dÚe
;

2393 
	`¥_´e_dec
(
size
);

2399 
d¡
.
ty³
 = 
OP_REG
;

2400 
d¡
.
by‹s
 = (
	`mode_64b™
(è&& (
İ_by‹s
 == 4)) ? 8 : op_bytes;

2401 
d¡
.
»g
 = (*)&
_»gs
.
e¥
;

2402 
d¡
.
v®
 = 
_»gs
.
ebp
;

2405  
d¡
.
by‹s
 )

2407 1: *(
ušt8_t
 *)
d¡
.
»g
 = (ušt8_t)d¡.
v®
; ;

2408 2: *(
ušt16_t
 *)
d¡
.
»g
 = (ušt16_t)d¡.
v®
; ;

2409 4: *
d¡
.
»g
 = (
ušt32_t
)d¡.
v®
; ;

2410 8: *
d¡
.
»g
 = d¡.
v®
; ;

2414 
d¡
.
»g
 = (*)&
_»gs
.
ebp
;

2415 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
d¡
.
by‹s
),

2416 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
, 
İs
)) )

2417 
dÚe
;

2422 
off£t
 = (
b
 =ğ0xÿè? 
	`š¢_ãtch_ty³
(
ušt16_t
) : 0;

2423 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

2424 &
d¡
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) ||

2425 (
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
 + 
off£t
),

2426 &
¤c
.
v®
, 
İ_by‹s
, 
ùxt
, 
İs
)) ||

2427 (
rc
 = 
	`lßd_£g
(
x86_£g_cs
, (
ušt16_t
)
¤c
.
v®
, 
ùxt
, 
İs
)) )

2428 
dÚe
;

2429 
_»gs
.
e
 = 
d¡
.
v®
;

2434 
¤c
.
v®
 = 
EXC_BP
;

2435 
swšt
;

2438 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

2439 
swšt
:

2440 
	`ç_if
(
İs
->
šjeù_sw_š‹¼u±
 =ğ
NULL
);

2441 
rc
 = 
İs
->
	`šjeù_sw_š‹¼u±
(
¤c
.
v®
, 
_»gs
.
e
 - 
ùxt
->
»gs
->eip,

2442 
ùxt
è? : 
X86EMUL_EXCEPTION
;

2443 
dÚe
;

2446 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

2447 iàĞ!(
_»gs
.
eæags
 & 
EFLG_OF
) )

2449 
¤c
.
v®
 = 
EXC_OF
;

2450 
swšt
;

2453 
cs
, 
e
, 
eæags
;

2454 
ušt32_t
 
mask
 = 
EFLG_VIP
 | 
EFLG_VIF
 | 
EFLG_VM
;

2455 iàĞ!
	`mode_ršg0
() )

2456 
mask
 |ğ
EFLG_IOPL
;

2457 iàĞ!
	`mode_iİl
() )

2458 
mask
 |ğ
EFLG_IF
;

2459 
	`ç_if
(!
	`š_»®mode
(
ùxt
, 
İs
));

2460 iàĞ(
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

2461 &
e
, 
İ_by‹s
, 
ùxt
, 
İs
)) ||

2462 (
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

2463 &
cs
, 
İ_by‹s
, 
ùxt
, 
İs
)) ||

2464 (
rc
 = 
	`»ad_ulÚg
(
x86_£g_ss
, 
	`¥_po¡_šc
(
İ_by‹s
),

2465 &
eæags
, 
İ_by‹s
, 
ùxt
, 
İs
)) )

2466 
dÚe
;

2467 iàĞ
İ_by‹s
 == 2 )

2468 
eæags
 = (
ušt16_t
ëæag | (
_»gs
.eflags & 0xffff0000u);

2469 
eæags
 &= 0x257fd5;

2470 
_»gs
.
eæags
 &ğ
mask
;

2471 
_»gs
.
eæags
 |ğ(
ušt32_t
)Óæag & ~
mask
) | 0x02;

2472 
_»gs
.
e
 =ƒip;

2473 iàĞ(
rc
 = 
	`lßd_£g
(
x86_£g_cs
, (
ušt16_t
)
cs
, 
ùxt
, 
İs
)) != 0 )

2474 
dÚe
;

2479 
¤c
.
v®
 = 1;

2480 
g½2
;

2483 
¤c
.
v®
 = 
_»gs
.
ecx
;

2484 
g½2
;

2487 
ba£
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

2488 
ušt8_t
 
®
 = 
_»gs
.
—x
;

2489 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

2490 
	`g’”©e_exû±iÚ_if
(
ba£
 =ğ0, 
EXC_DE
, -1);

2491 *(
ušt16_t
 *)&
_»gs
.
—x
 = ((
®
 / 
ba£
) << 8) | (al % base);

2492 
_»gs
.
eæags
 &ğ~(
EFLG_SF
|
EFLG_ZF
|
EFLG_PF
);

2493 
_»gs
.
eæags
 |ğ((
ušt8_t
)_»gs.
—x
 =ğ0è? 
EFLG_ZF
 : 0;

2494 
_»gs
.
eæags
 |ğ(Ğ
št8_t
)_»gs.
—x
 < 0è? 
EFLG_SF
 : 0;

2495 
_»gs
.
eæags
 |ğ
	`ev’_·r™y
(_»gs.
—x
è? 
EFLG_PF
 : 0;

2500 
ba£
 = 
	`š¢_ãtch_ty³
(
ušt8_t
);

2501 
ušt16_t
 
ax
 = 
_»gs
.
—x
;

2502 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

2503 *(
ušt16_t
 *)&
_»gs
.
—x
 = (
ušt8_t
)(
ax
 + (×x >> 8è* 
ba£
));

2504 
_»gs
.
eæags
 &ğ~(
EFLG_SF
|
EFLG_ZF
|
EFLG_PF
);

2505 
_»gs
.
eæags
 |ğ((
ušt8_t
)_»gs.
—x
 =ğ0è? 
EFLG_ZF
 : 0;

2506 
_»gs
.
eæags
 |ğ(Ğ
št8_t
)_»gs.
—x
 < 0è? 
EFLG_SF
 : 0;

2507 
_»gs
.
eæags
 |ğ
	`ev’_·r™y
(_»gs.
—x
è? 
EFLG_PF
 : 0;

2512 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

2513 *(
ušt8_t
 *)&
_»gs
.
—x
 = (_»gs.
eæags
 & 
EFLG_CF
) ? 0xff : 0x00;

2517 
®
 = (
ušt8_t
)
_»gs
.
—x
;

2518 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
, 
	`Œunÿ‹_—
(
_»gs
.
ebx
 + 
®
),

2519 &
®
, 1, 
ùxt
, 
İs
)) != 0 )

2520 
dÚe
;

2521 *(
ušt8_t
 *)&
_»gs
.
—x
 = 
®
;

2526  
modrm
 )

2536 
	`emuÏ‹_åu_š¢_¡ub
(0xd8, 
modrm
);

2539 
	`ç_if
(
modrm
 >= 0xc0);

2540 
—
.
by‹s
 = 4;

2541 
¤c
 = 
—
;

2542 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2543 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2544 
dÚe
;

2545  
modrm_»g
 & 7 )

2548 
	`emuÏ‹_åu_š¢_mem¤c
("çdds", 
¤c
.
v®
);

2551 
	`emuÏ‹_åu_š¢_mem¤c
("fmuls", 
¤c
.
v®
);

2554 
	`emuÏ‹_åu_š¢_mem¤c
("fcoms", 
¤c
.
v®
);

2557 
	`emuÏ‹_åu_š¢_mem¤c
("fcomps", 
¤c
.
v®
);

2560 
	`emuÏ‹_åu_š¢_mem¤c
("fsubs", 
¤c
.
v®
);

2563 
	`emuÏ‹_åu_š¢_mem¤c
("fsubrs", 
¤c
.
v®
);

2566 
	`emuÏ‹_åu_š¢_mem¤c
("fdivs", 
¤c
.
v®
);

2569 
	`emuÏ‹_åu_š¢_mem¤c
("fdivrs", 
¤c
.
v®
);

2572 
ÿÂÙ_emuÏ‹
;

2578  
modrm
 )

2610 
	`emuÏ‹_åu_š¢_¡ub
(0xd9, 
modrm
);

2613 
	`ç_if
(
modrm
 >= 0xc0);

2614  
modrm_»g
 & 7 )

2617 
—
.
by‹s
 = 4;

2618 
¤c
 = 
—
;

2619 iàĞ(
rc
 = 
İs
->
	`»ad
(
—
.
mem
.
£g
,ƒa.mem.
off
, &
¤c
.
v®
,

2620 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2621 
dÚe
;

2622 
	`emuÏ‹_åu_š¢_mem¤c
("æds", 
¤c
.
v®
);

2625 
—
.
by‹s
 = 4;

2626 
d¡
 = 
—
;

2627 
d¡
.
ty³
 = 
OP_MEM
;

2628 
	`emuÏ‹_åu_š¢_memd¡
("f¡s", 
d¡
.
v®
);

2631 
—
.
by‹s
 = 4;

2632 
d¡
 = 
—
;

2633 
d¡
.
ty³
 = 
OP_MEM
;

2634 
	`emuÏ‹_åu_š¢_memd¡
("f¡ps", 
d¡
.
v®
);

2638 
—
.
by‹s
 = 2;

2639 
¤c
 = 
—
;

2640 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2641 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2642 
dÚe
;

2643 
	`emuÏ‹_åu_š¢_mem¤c
("ædcw", 
¤c
.
v®
);

2647 
—
.
by‹s
 = 2;

2648 
d¡
 = 
—
;

2649 
d¡
.
ty³
 = 
OP_MEM
;

2650 
	`emuÏ‹_åu_š¢_memd¡
("â¡cw", 
d¡
.
v®
);

2653 
ÿÂÙ_emuÏ‹
;

2659  
modrm
 )

2666 
	`emuÏ‹_åu_š¢_¡ub
(0xda, 
modrm
);

2669 
	`ç_if
(
modrm
 >= 0xc0);

2670 
—
.
by‹s
 = 4;

2671 
¤c
 = 
—
;

2672 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2673 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2674 
dÚe
;

2675  
modrm_»g
 & 7 )

2678 
	`emuÏ‹_åu_š¢_mem¤c
("fŸddl", 
¤c
.
v®
);

2681 
	`emuÏ‹_åu_š¢_mem¤c
("fimuÎ", 
¤c
.
v®
);

2684 
	`emuÏ‹_åu_š¢_mem¤c
("ficoml", 
¤c
.
v®
);

2687 
	`emuÏ‹_åu_š¢_mem¤c
("ficom¶", 
¤c
.
v®
);

2690 
	`emuÏ‹_åu_š¢_mem¤c
("fisubl", 
¤c
.
v®
);

2693 
	`emuÏ‹_åu_š¢_mem¤c
("fisub¾", 
¤c
.
v®
);

2696 
	`emuÏ‹_åu_š¢_mem¤c
("fidivl", 
¤c
.
v®
);

2699 
	`emuÏ‹_åu_š¢_mem¤c
("fidiv¾", 
¤c
.
v®
);

2702 
ÿÂÙ_emuÏ‹
;

2708  
modrm
 )

2714 
	`emuÏ‹_åu_š¢_¡ub
(0xdb, 
modrm
);

2717 
	`emuÏ‹_åu_š¢
("fnclex");

2720 
	`emuÏ‹_åu_š¢
("fninit");

2726 
	`emuÏ‹_åu_š¢_¡ub
(0xdb, 
modrm
);

2729 
	`ç_if
(
modrm
 >= 0xc0);

2730  
modrm_»g
 & 7 )

2733 
—
.
by‹s
 = 4;

2734 
¤c
 = 
—
;

2735 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2736 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2737 
dÚe
;

2738 
	`emuÏ‹_åu_š¢_mem¤c
("fdl", 
¤c
.
v®
);

2741 
—
.
by‹s
 = 4;

2742 
d¡
 = 
—
;

2743 
d¡
.
ty³
 = 
OP_MEM
;

2744 
	`emuÏ‹_åu_š¢_memd¡
("fi¡l", 
d¡
.
v®
);

2747 
—
.
by‹s
 = 4;

2748 
d¡
 = 
—
;

2749 
d¡
.
ty³
 = 
OP_MEM
;

2750 
	`emuÏ‹_åu_š¢_memd¡
("fi¡l", 
d¡
.
v®
);

2753 
—
.
by‹s
 = 4;

2754 
d¡
 = 
—
;

2755 
d¡
.
ty³
 = 
OP_MEM
;

2756 
	`emuÏ‹_åu_š¢_memd¡
("fi¡¶", 
d¡
.
v®
);

2759 
—
.
by‹s
 = 10;

2760 
¤c
 = 
—
;

2761 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
,

2762 &
¤c
.
v®
, src.
by‹s
, 
ùxt
)) != 0 )

2763 
dÚe
;

2764 
	`emuÏ‹_åu_š¢_memd¡
("ædt", 
¤c
.
v®
);

2767 
—
.
by‹s
 = 10;

2768 
d¡
.
ty³
 = 
OP_MEM
;

2769 
d¡
 = 
—
;

2770 
	`emuÏ‹_åu_š¢_memd¡
("f¡±", 
d¡
.
v®
);

2773 
ÿÂÙ_emuÏ‹
;

2779  
modrm
 )

2787 
	`emuÏ‹_åu_š¢_¡ub
(0xdc, 
modrm
);

2790 
	`ç_if
(
modrm
 >= 0xc0);

2791 
—
.
by‹s
 = 8;

2792 
¤c
 = 
—
;

2793 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2794 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2795 
dÚe
;

2796  
modrm_»g
 & 7 )

2799 
	`emuÏ‹_åu_š¢_mem¤c
("çddl", 
¤c
.
v®
);

2802 
	`emuÏ‹_åu_š¢_mem¤c
("fmuÎ", 
¤c
.
v®
);

2805 
	`emuÏ‹_åu_š¢_mem¤c
("fcoml", 
¤c
.
v®
);

2808 
	`emuÏ‹_åu_š¢_mem¤c
("fcom¶", 
¤c
.
v®
);

2811 
	`emuÏ‹_åu_š¢_mem¤c
("fsubl", 
¤c
.
v®
);

2814 
	`emuÏ‹_åu_š¢_mem¤c
("fsub¾", 
¤c
.
v®
);

2817 
	`emuÏ‹_åu_š¢_mem¤c
("fdivl", 
¤c
.
v®
);

2820 
	`emuÏ‹_åu_š¢_mem¤c
("fdiv¾", 
¤c
.
v®
);

2827  
modrm
 )

2834 
	`emuÏ‹_åu_š¢_¡ub
(0xdd, 
modrm
);

2837 
	`ç_if
(
modrm
 >= 0xc0);

2838  
modrm_»g
 & 7 )

2841 
—
.
by‹s
 = 8;

2842 
¤c
 = 
—
;

2843 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2844 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2845 
dÚe
;

2846 
	`emuÏ‹_åu_š¢_mem¤c
("ædl", 
¤c
.
v®
);

2849 
—
.
by‹s
 = 8;

2850 
d¡
 = 
—
;

2851 
d¡
.
ty³
 = 
OP_MEM
;

2852 
	`emuÏ‹_åu_š¢_memd¡
("fi¡Î", 
d¡
.
v®
);

2855 
—
.
by‹s
 = 8;

2856 
d¡
 = 
—
;

2857 
d¡
.
ty³
 = 
OP_MEM
;

2858 
	`emuÏ‹_åu_š¢_mem¤c
("f¡l", 
d¡
.
v®
);

2861 
—
.
by‹s
 = 8;

2862 
d¡
 = 
—
;

2863 
d¡
.
ty³
 = 
OP_MEM
;

2864 
	`emuÏ‹_åu_š¢_memd¡
("f¡¶", 
d¡
.
v®
);

2867 
—
.
by‹s
 = 2;

2868 
d¡
 = 
—
;

2869 
d¡
.
ty³
 = 
OP_MEM
;

2870 
	`emuÏ‹_åu_š¢_memd¡
("â¡sw", 
d¡
.
v®
);

2873 
ÿÂÙ_emuÏ‹
;

2879  
modrm
 )

2888 
	`emuÏ‹_åu_š¢_¡ub
(0xde, 
modrm
);

2891 
	`ç_if
(
modrm
 >= 0xc0);

2892 
—
.
by‹s
 = 2;

2893 
¤c
 = 
—
;

2894 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2895 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2896 
dÚe
;

2897  
modrm_»g
 & 7 )

2900 
	`emuÏ‹_åu_š¢_mem¤c
("fŸdd", 
¤c
.
v®
);

2903 
	`emuÏ‹_åu_š¢_mem¤c
("fimul", 
¤c
.
v®
);

2906 
	`emuÏ‹_åu_š¢_mem¤c
("ficom", 
¤c
.
v®
);

2909 
	`emuÏ‹_åu_š¢_mem¤c
("ficomp", 
¤c
.
v®
);

2912 
	`emuÏ‹_åu_š¢_mem¤c
("fisub", 
¤c
.
v®
);

2915 
	`emuÏ‹_åu_š¢_mem¤c
("fisubr", 
¤c
.
v®
);

2918 
	`emuÏ‹_åu_š¢_mem¤c
("fidiv", 
¤c
.
v®
);

2921 
	`emuÏ‹_åu_š¢_mem¤c
("fidivr", 
¤c
.
v®
);

2924 
ÿÂÙ_emuÏ‹
;

2930  
modrm
 )

2934 
d¡
.
by‹s
 = 2;

2935 
d¡
.
ty³
 = 
OP_REG
;

2936 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

2937 
	`emuÏ‹_åu_š¢_memd¡
("â¡sw", 
d¡
.
v®
);

2941 
	`emuÏ‹_åu_š¢_¡ub
(0xdf, 
modrm
);

2944 
	`ç_if
(
modrm
 >= 0xc0);

2945  
modrm_»g
 & 7 )

2948 
—
.
by‹s
 = 2;

2949 
¤c
 = 
—
;

2950 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2951 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2952 
dÚe
;

2953 
	`emuÏ‹_åu_š¢_mem¤c
("fd", 
¤c
.
v®
);

2956 
—
.
by‹s
 = 2;

2957 
d¡
 = 
—
;

2958 
d¡
.
ty³
 = 
OP_MEM
;

2959 
	`emuÏ‹_åu_š¢_memd¡
("fi¡", 
d¡
.
v®
);

2962 
—
.
by‹s
 = 2;

2963 
d¡
 = 
—
;

2964 
d¡
.
ty³
 = 
OP_MEM
;

2965 
	`emuÏ‹_åu_š¢_memd¡
("fi¡", 
d¡
.
v®
);

2968 
—
.
by‹s
 = 2;

2969 
d¡
 = 
—
;

2970 
d¡
.
ty³
 = 
OP_MEM
;

2971 
	`emuÏ‹_åu_š¢_memd¡
("fi¡p", 
d¡
.
v®
);

2974 
—
.
by‹s
 = 10;

2975 
d¡
 = 
—
;

2976 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
,

2977 &
¤c
.
v®
, src.
by‹s
, 
ùxt
)) != 0 )

2978 
dÚe
;

2979 
	`emuÏ‹_åu_š¢_memd¡
("fbld", 
¤c
.
v®
);

2982 
—
.
by‹s
 = 8;

2983 
¤c
 = 
—
;

2984 iàĞ(
rc
 = 
İs
->
	`»ad
(
¤c
.
mem
.
£g
, src.mem.
off
, &¤c.
v®
,

2985 
¤c
.
by‹s
, 
ùxt
)) != 0 )

2986 
dÚe
;

2987 
	`emuÏ‹_åu_š¢_mem¤c
("fdÎ", 
¤c
.
v®
);

2990 
—
.
by‹s
 = 10;

2991 
d¡
 = 
—
;

2992 
d¡
.
ty³
 = 
OP_MEM
;

2993 
	`emuÏ‹_åu_š¢_memd¡
("fb¡p", 
d¡
.
v®
);

2996 
—
.
by‹s
 = 8;

2997 
d¡
 = 
—
;

2998 
d¡
.
ty³
 = 
OP_MEM
;

2999 
	`emuÏ‹_åu_š¢_memd¡
("fi¡¶l", 
d¡
.
v®
);

3002 
ÿÂÙ_emuÏ‹
;

3008 
»l
 = 
	`š¢_ãtch_ty³
(
št8_t
);

3009 
do_jmp
 = !(
_»gs
.
eæags
 & 
EFLG_ZF
);

3010 iàĞ
b
 == 0xe1 )

3011 
do_jmp
 = !do_jmp;

3012 iàĞ
b
 == 0xe2 )

3013 
do_jmp
 = 1;

3014  
ad_by‹s
 )

3017 
do_jmp
 &ğ--(*(
ušt16_t
 *)&
_»gs
.
ecx
) != 0;

3020 
do_jmp
 &ğ--(*(
ušt32_t
 *)&
_»gs
.
ecx
) != 0;

3021 
_»gs
.
ecx
 = (
ušt32_t
)_regs.ecx;

3024 
do_jmp
 &ğ--
_»gs
.
ecx
 != 0;

3027 iàĞ
do_jmp
 )

3028 
	`jmp_»l
(
»l
);

3033 
»l
 = 
	`š¢_ãtch_ty³
(
št8_t
);

3034 iàĞ(
ad_by‹s
 =ğ2è? !(
ušt16_t
)
_»gs
.
ecx
 :

3035 (
ad_by‹s
 =ğ4è? !(
ušt32_t
)
_»gs
.
ecx
 : !_regs.ecx )

3036 
	`jmp_»l
(
»l
);

3048 
pÜt
 = ((
b
 < 0xe8)

3049 ? 
	`š¢_ãtch_ty³
(
ušt8_t
)

3050 : (
ušt16_t
)
_»gs
.
edx
);

3051 
İ_by‹s
 = !(
b
 & 1) ? 1 : (op_bytes == 8) ? 4 : op_bytes;

3052 iàĞ(
rc
 = 
	`iİÜt_acûss_check
(
pÜt
, 
İ_by‹s
, 
ùxt
, 
İs
)) != 0 )

3053 
dÚe
;

3054 iàĞ
b
 & 2 )

3057 
	`ç_if
(
İs
->
wr™e_io
 =ğ
NULL
);

3058 
rc
 = 
İs
->
	`wr™e_io
(
pÜt
, 
İ_by‹s
, 
_»gs
.
—x
, 
ùxt
);

3063 
d¡
.
ty³
 = 
OP_REG
;

3064 
d¡
.
by‹s
 = 
İ_by‹s
;

3065 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3066 
	`ç_if
(
İs
->
»ad_io
 =ğ
NULL
);

3067 
rc
 = 
İs
->
	`»ad_io
(
pÜt
, 
d¡
.
by‹s
, &d¡.
v®
, 
ùxt
);

3069 iàĞ
rc
 != 0 )

3070 
dÚe
;

3075 
»l
 = ((
İ_by‹s
 == 2)

3076 ? (
št32_t
)
	`š¢_ãtch_ty³
(
št16_t
)

3077 : 
	`š¢_ãtch_ty³
(
št32_t
));

3078 
İ_by‹s
 = ((İ_by‹ =ğ4è&& 
	`mode_64b™
()) ? 8 : op_bytes;

3079 
¤c
.
v®
 = 
_»gs
.
e
;

3080 
	`jmp_»l
(
»l
);

3081 
push
;

3085 
»l
 = ((
İ_by‹s
 == 2)

3086 ? (
št32_t
)
	`š¢_ãtch_ty³
(
št16_t
)

3087 : 
	`š¢_ãtch_ty³
(
št32_t
));

3088 
	`jmp_»l
(
»l
);

3093 
ušt16_t
 
£l
;

3094 
ušt32_t
 
e
;

3095 
	`g’”©e_exû±iÚ_if
(
	`mode_64b™
(), 
EXC_UD
, -1);

3096 
e
 = 
	`š¢_ãtch_by‹s
(
İ_by‹s
);

3097 
£l
 = 
	`š¢_ãtch_ty³
(
ušt16_t
);

3098 iàĞ(
rc
 = 
	`lßd_£g
(
x86_£g_cs
, 
£l
, 
ùxt
, 
İs
)) != 0 )

3099 
dÚe
;

3100 
_»gs
.
e
 =ƒip;

3105 
»l
 = 
	`š¢_ãtch_ty³
(
št8_t
);

3106 
	`jmp_»l
(
»l
);

3111 
¤c
.
v®
 = 
EXC_DB
;

3112 
swšt
;

3115 
ùxt
->
»tœe
.
æags
.
hÉ
 = 1;

3119 
_»gs
.
eæags
 ^ğ
EFLG_CF
;

3123  
modrm_»g
 & 7 )

3127 
¤c
.
ty³
 = 
OP_IMM
;

3128 
¤c
.
by‹s
 = (
d
 & 
By‹Op
è? 1 : 
İ_by‹s
;

3129 iàĞ
¤c
.
by‹s
 == 8 ) src.bytes = 4;

3130  
¤c
.
by‹s
 )

3132 1: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št8_t
); ;

3133 2: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št16_t
); ;

3134 4: 
¤c
.
v®
 = 
	`š¢_ãtch_ty³
(
št32_t
); ;

3136 
‹¡
;

3138 
d¡
.
v®
 = ~dst.val;

3141 
	`emuÏ‹_1İ
("Ãg", 
d¡
, 
_»gs
.
eæags
);

3144 
¤c
 = 
d¡
;

3145 
d¡
.
ty³
 = 
OP_REG
;

3146 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3147 
d¡
.
v®
 = *d¡.
»g
;

3148 
_»gs
.
eæags
 &ğ~(
EFLG_OF
|
EFLG_CF
);

3149  
¤c
.
by‹s
 )

3152 
d¡
.
v®
 = (
ušt8_t
)dst.val;

3153 
d¡
.
v®
 *ğ
¤c
.val;

3154 iàĞ(
ušt8_t
)
d¡
.
v®
 !ğ(
ušt16_t
)dst.val )

3155 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3156 
d¡
.
by‹s
 = 2;

3159 
d¡
.
v®
 = (
ušt16_t
)dst.val;

3160 
d¡
.
v®
 *ğ
¤c
.val;

3161 iàĞ(
ušt16_t
)
d¡
.
v®
 !ğ(
ušt32_t
)dst.val )

3162 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3163 *(
ušt16_t
 *)&
_»gs
.
edx
 = 
d¡
.
v®
 >> 16;

3165 #ifdeà
__x86_64__


3167 
d¡
.
v®
 = (
ušt32_t
)dst.val;

3168 
d¡
.
v®
 *ğ
¤c
.val;

3169 iàĞ(
ušt32_t
)
d¡
.
v®
 != dst.val )

3170 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3171 
_»gs
.
edx
 = (
ušt32_t
)(
d¡
.
v®
 >> 32);

3175 
m
[2] = { 
¤c
.
v®
, 
d¡
.val };

3176 iàĞ
	`mul_dbl
(
m
) )

3177 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3178 
_»gs
.
edx
 = 
m
[1];

3179 
d¡
.
v®
 = 
m
[0];

3185 
¤c
 = 
d¡
;

3186 
d¡
.
ty³
 = 
OP_REG
;

3187 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3188 
d¡
.
v®
 = *d¡.
»g
;

3189 
_»gs
.
eæags
 &ğ~(
EFLG_OF
|
EFLG_CF
);

3190  
¤c
.
by‹s
 )

3193 
d¡
.
v®
 = ((
ušt16_t
)(
št8_t
)
¤c
.val *

3194 (
ušt16_t
)(
št8_t
)
d¡
.
v®
);

3195 iàĞ(
št8_t
)
d¡
.
v®
 !ğ(
ušt16_t
)dst.val )

3196 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3197 
d¡
.
by‹s
 = 2;

3200 
d¡
.
v®
 = ((
ušt32_t
)(
št16_t
)
¤c
.val *

3201 (
ušt32_t
)(
št16_t
)
d¡
.
v®
);

3202 iàĞ(
št16_t
)
d¡
.
v®
 !ğ(
ušt32_t
)dst.val )

3203 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3204 *(
ušt16_t
 *)&
_»gs
.
edx
 = 
d¡
.
v®
 >> 16;

3206 #ifdeà
__x86_64__


3208 
d¡
.
v®
 = ((
ušt64_t
)(
št32_t
)
¤c
.val *

3209 (
ušt64_t
)(
št32_t
)
d¡
.
v®
);

3210 iàĞ(
št32_t
)
d¡
.
v®
 != dst.val )

3211 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3212 
_»gs
.
edx
 = (
ušt32_t
)(
d¡
.
v®
 >> 32);

3216 
m
[2] = { 
¤c
.
v®
, 
d¡
.val };

3217 iàĞ
	`imul_dbl
(
m
) )

3218 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

3219 
_»gs
.
edx
 = 
m
[1];

3220 
d¡
.
v®
 = 
m
[0];

3226 
u
[2], 
v
;

3227 
¤c
 = 
d¡
;

3228 
d¡
.
ty³
 = 
OP_REG
;

3229 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3230  
¤c
.
by‹s
 )

3233 
u
[0] = (
ušt16_t
)
_»gs
.
—x
;

3234 
u
[1] = 0;

3235 
v
 = (
ušt8_t
)
¤c
.
v®
;

3236 
	`g’”©e_exû±iÚ_if
(

3237 
	`div_dbl
(
u
, 
v
è|| ((
ušt8_t
)u[0] !ğ(
ušt16_t
)u[0]),

3238 
EXC_DE
, -1);

3239 
d¡
.
v®
 = (
ušt8_t
)
u
[0];

3240 ((
ušt8_t
 *)&
_»gs
.
—x
)[1] = 
u
[1];

3243 
u
[0] = ((
ušt32_t
)
_»gs
.
edx
 << 16è| (
ušt16_t
)_»gs.
—x
;

3244 
u
[1] = 0;

3245 
v
 = (
ušt16_t
)
¤c
.
v®
;

3246 
	`g’”©e_exû±iÚ_if
(

3247 
	`div_dbl
(
u
, 
v
è|| ((
ušt16_t
)u[0] !ğ(
ušt32_t
)u[0]),

3248 
EXC_DE
, -1);

3249 
d¡
.
v®
 = (
ušt16_t
)
u
[0];

3250 *(
ušt16_t
 *)&
_»gs
.
edx
 = 
u
[1];

3252 #ifdeà
__x86_64__


3254 
u
[0] = (
_»gs
.
edx
 << 32è| (
ušt32_t
)_»gs.
—x
;

3255 
u
[1] = 0;

3256 
v
 = (
ušt32_t
)
¤c
.
v®
;

3257 
	`g’”©e_exû±iÚ_if
(

3258 
	`div_dbl
(
u
, 
v
è|| ((
ušt32_t
)u[0] != u[0]),

3259 
EXC_DE
, -1);

3260 
d¡
.
v®
 = (
ušt32_t
)
u
[0];

3261 
_»gs
.
edx
 = (
ušt32_t
)
u
[1];

3265 
u
[0] = 
_»gs
.
—x
;

3266 
u
[1] = 
_»gs
.
edx
;

3267 
v
 = 
¤c
.
v®
;

3268 
	`g’”©e_exû±iÚ_if
(
	`div_dbl
(
u
, 
v
), 
EXC_DE
, -1);

3269 
d¡
.
v®
 = 
u
[0];

3270 
_»gs
.
edx
 = 
u
[1];

3276 
u
[2], 
v
;

3277 
¤c
 = 
d¡
;

3278 
d¡
.
ty³
 = 
OP_REG
;

3279 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3280  
¤c
.
by‹s
 )

3283 
u
[0] = (
št16_t
)
_»gs
.
—x
;

3284 
u
[1] = (()u[0] < 0) ? ~0UL : 0UL;

3285 
v
 = (
št8_t
)
¤c
.
v®
;

3286 
	`g’”©e_exû±iÚ_if
(

3287 
	`idiv_dbl
(
u
, 
v
è|| ((
št8_t
)u[0] !ğ(
št16_t
)u[0]),

3288 
EXC_DE
, -1);

3289 
d¡
.
v®
 = (
št8_t
)
u
[0];

3290 ((
št8_t
 *)&
_»gs
.
—x
)[1] = 
u
[1];

3293 
u
[0] = (
št32_t
)((
_»gs
.
edx
 << 16è| (
ušt16_t
)_»gs.
—x
);

3294 
u
[1] = (()u[0] < 0) ? ~0UL : 0UL;

3295 
v
 = (
št16_t
)
¤c
.
v®
;

3296 
	`g’”©e_exû±iÚ_if
(

3297 
	`idiv_dbl
(
u
, 
v
è|| ((
št16_t
)u[0] !ğ(
št32_t
)u[0]),

3298 
EXC_DE
, -1);

3299 
d¡
.
v®
 = (
št16_t
)
u
[0];

3300 *(
št16_t
 *)&
_»gs
.
edx
 = 
u
[1];

3302 #ifdeà
__x86_64__


3304 
u
[0] = (
_»gs
.
edx
 << 32è| (
ušt32_t
)_»gs.
—x
;

3305 
u
[1] = (()u[0] < 0) ? ~0UL : 0UL;

3306 
v
 = (
št32_t
)
¤c
.
v®
;

3307 
	`g’”©e_exû±iÚ_if
(

3308 
	`idiv_dbl
(
u
, 
v
è|| ((
št32_t
)u[0] != u[0]),

3309 
EXC_DE
, -1);

3310 
d¡
.
v®
 = (
št32_t
)
u
[0];

3311 
_»gs
.
edx
 = (
ušt32_t
)
u
[1];

3315 
u
[0] = 
_»gs
.
—x
;

3316 
u
[1] = 
_»gs
.
edx
;

3317 
v
 = 
¤c
.
v®
;

3318 
	`g’”©e_exû±iÚ_if
(
	`idiv_dbl
(
u
, 
v
), 
EXC_DE
, -1);

3319 
d¡
.
v®
 = 
u
[0];

3320 
_»gs
.
edx
 = 
u
[1];

3326 
ÿÂÙ_emuÏ‹
;

3331 
_»gs
.
eæags
 &ğ~
EFLG_CF
;

3335 
_»gs
.
eæags
 |ğ
EFLG_CF
;

3339 
	`g’”©e_exû±iÚ_if
(!
	`mode_iİl
(), 
EXC_GP
, 0);

3340 
_»gs
.
eæags
 &ğ~
EFLG_IF
;

3344 
	`g’”©e_exû±iÚ_if
(!
	`mode_iİl
(), 
EXC_GP
, 0);

3345 iàĞ!(
_»gs
.
eæags
 & 
EFLG_IF
) )

3347 
_»gs
.
eæags
 |ğ
EFLG_IF
;

3348 
ùxt
->
»tœe
.
æags
.
¡i
 = 1;

3353 
_»gs
.
eæags
 &ğ~
EFLG_DF
;

3357 
_»gs
.
eæags
 |ğ
EFLG_DF
;

3361 
	`g’”©e_exû±iÚ_if
((
modrm_»g
 & 7è>ğ2, 
EXC_UD
, -1);

3363  
modrm_»g
 & 7 )

3366 
	`emuÏ‹_1İ
("šc", 
d¡
, 
_»gs
.
eæags
);

3369 
	`emuÏ‹_1İ
("dec", 
d¡
, 
_»gs
.
eæags
);

3373 iàĞ(
d¡
.
by‹s
 =ğ4è&& 
	`mode_64b™
() )

3375 
d¡
.
by‹s
 = 
İ_by‹s
 = 8;

3376 iàĞ
d¡
.
ty³
 =ğ
OP_REG
 )

3377 
d¡
.
v®
 = *d¡.
»g
;

3378 iàĞ(
rc
 = 
	`»ad_ulÚg
(
d¡
.
mem
.
£g
, d¡.mem.
off
,

3379 &
d¡
.
v®
, 8, 
ùxt
, 
İs
)) != 0 )

3380 
dÚe
;

3382 
¤c
.
v®
 = 
_»gs
.
e
;

3383 
_»gs
.
e
 = 
d¡
.
v®
;

3384 iàĞ(
modrm_»g
 & 7) == 2 )

3385 
push
;

3386 
d¡
.
ty³
 = 
OP_NONE
;

3390 
£l
;

3392 
	`g’”©e_exû±iÚ_if
(
d¡
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

3394 iàĞ(
rc
 = 
	`»ad_ulÚg
(
d¡
.
mem
.
£g
, d¡.mem.
off
+d¡.
by‹s
,

3395 &
£l
, 2, 
ùxt
, 
İs
)) )

3396 
dÚe
;

3398 iàĞ(
modrm_»g
 & 7) == 3 )

3400 
£gm’t_»gi¡”
 
»g
;

3401 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

3402 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
(
x86_£g_cs
, &
»g
, 
ùxt
)) ||

3403 (
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

3404 &
»g
.
£l
, 
İ_by‹s
, 
ùxt
)) ||

3405 (
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
İ_by‹s
),

3406 &
_»gs
.
e
, 
İ_by‹s
, 
ùxt
)) )

3407 
dÚe
;

3410 iàĞ(
rc
 = 
	`lßd_£g
(
x86_£g_cs
, 
£l
, 
ùxt
, 
İs
)) != 0 )

3411 
dÚe
;

3412 
_»gs
.
e
 = 
d¡
.
v®
;

3414 
d¡
.
ty³
 = 
OP_NONE
;

3419 iàĞ
	`mode_64b™
(è&& (
d¡
.
by‹s
 == 4) )

3421 
d¡
.
by‹s
 = 8;

3422 iàĞ
d¡
.
ty³
 =ğ
OP_REG
 )

3423 
d¡
.
v®
 = *d¡.
»g
;

3424 iàĞ(
rc
 = 
	`»ad_ulÚg
(
d¡
.
mem
.
£g
, d¡.mem.
off
,

3425 &
d¡
.
v®
, 8, 
ùxt
, 
İs
)) != 0 )

3426 
dÚe
;

3428 iàĞ(
rc
 = 
İs
->
	`wr™e
(
x86_£g_ss
, 
	`¥_´e_dec
(
d¡
.
by‹s
),

3429 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
)) != 0 )

3430 
dÚe
;

3431 
d¡
.
ty³
 = 
OP_NONE
;

3434 
	`g’”©e_exû±iÚ_if
(1, 
EXC_UD
, -1);

3436 
ÿÂÙ_emuÏ‹
;

3441 
wr™eback
:

3442  
d¡
.
ty³
 )

3444 
OP_REG
:

3446  
d¡
.
by‹s
 )

3448 1: *(
ušt8_t
 *)
d¡
.
»g
 = (ušt8_t)d¡.
v®
; ;

3449 2: *(
ušt16_t
 *)
d¡
.
»g
 = (ušt16_t)d¡.
v®
; ;

3450 4: *
d¡
.
»g
 = (
ušt32_t
)d¡.
v®
; ;

3451 8: *
d¡
.
»g
 = d¡.
v®
; ;

3454 
OP_MEM
:

3455 iàĞ!(
d
 & 
Mov
è&& (
d¡
.
Üig_v®
 =ğd¡.
v®
) &&

3456 !
ùxt
->
fÜû_wr™eback
 )

3458 iàĞ
lock_´efix
 )

3459 
rc
 = 
İs
->
	`cmpxchg
(

3460 
d¡
.
mem
.
£g
, d¡.mem.
off
, &d¡.
Üig_v®
,

3461 &
d¡
.
v®
, d¡.
by‹s
, 
ùxt
);

3463 
rc
 = 
İs
->
	`wr™e
(

3464 
d¡
.
mem
.
£g
, d¡.mem.
off
, &d¡.
v®
, d¡.
by‹s
, 
ùxt
);

3465 iàĞ
rc
 != 0 )

3466 
dÚe
;

3472 iàĞ(
ùxt
->
»gs
->
eæags
 & 
EFLG_TF
è&& (
rc
 =ğ
X86EMUL_OKAY
) &&

3473 (
İs
->
šjeù_hw_exû±iÚ
 !ğ
NULL
) )

3474 
rc
 = 
İs
->
	`šjeù_hw_exû±iÚ
(
EXC_DB
, -1, 
ùxt
è? : 
X86EMUL_EXCEPTION
;

3477 
_»gs
.
eæags
 &ğ~
EFLG_RF
;

3478 *
ùxt
->
»gs
 = 
_»gs
;

3480 
dÚe
:

3481  
rc
;

3483 
twoby‹_š¢
:

3484  
b
 )

3487 
	`ç_if
((
modrm_»g
 & 6) != 2);

3488 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_UD
, -1);

3489 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3490 iàĞ(
rc
 = 
	`lßd_£g
((
modrm_»g
 & 1è? 
x86_£g_Œ
 : 
x86_£g_ldŒ
,

3491 
¤c
.
v®
, 
ùxt
, 
İs
)) != 0 )

3492 
dÚe
;

3496 
£gm’t_»gi¡”
 
»g
;

3497 
ba£
, 
lim™
, 
ü0
, 
ü0w
;

3499 iàĞ
modrm
 == 0xdf )

3501 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_UD
, -1);

3502 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3503 
	`ç_if
(
İs
->
švÍg
 =ğ
NULL
);

3504 iàĞ(
rc
 = 
İs
->
	`švÍg
(
x86_£g_nÚe
, 
	`Œunÿ‹_—
(
_»gs
.
—x
),

3505 
ùxt
)) )

3506 
dÚe
;

3510 iàĞ
modrm
 == 0xf9 )

3512 
ušt64_t
 
tsc_aux
;

3513 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3514 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_TSC_AUX
, &
tsc_aux
, 
ùxt
)) != 0 )

3515 
dÚe
;

3516 
_»gs
.
ecx
 = (
ušt32_t
)
tsc_aux
;

3517 
rdtsc
;

3520  
modrm_»g
 & 7 )

3524 
	`g’”©e_exû±iÚ_if
(
—
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

3525 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

3526 iàĞ(
rc
 = 
İs
->
	`»ad_£gm’t
((
modrm_»g
 & 1) ?

3527 
x86_£g_idŒ
 : 
x86_£g_gdŒ
,

3528 &
»g
, 
ùxt
)) )

3529 
dÚe
;

3530 iàĞ
İ_by‹s
 == 2 )

3531 
»g
.
ba£
 &= 0xffffff;

3532 iàĞ(
rc
 = 
İs
->
	`wr™e
(
—
.
mem
.
£g
,ƒa.mem.
off
+0,

3533 &
»g
.
lim™
, 2, 
ùxt
)) ||

3534 (
rc
 = 
İs
->
	`wr™e
(
—
.
mem
.
£g
,ƒa.mem.
off
+2,

3535 &
»g
.
ba£
, 
	`mode_64b™
(è? 8 : 4, 
ùxt
)) )

3536 
dÚe
;

3540 
	`g’”©e_exû±iÚ_if
(
—
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

3541 
	`ç_if
(
İs
->
wr™e_£gm’t
 =ğ
NULL
);

3542 
	`mem£t
(&
»g
, 0, (reg));

3543 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
+0,

3544 &
lim™
, 2, 
ùxt
, 
İs
)) ||

3545 (
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
+2,

3546 &
ba£
, 
	`mode_64b™
(è? 8 : 4, 
ùxt
, 
İs
)) )

3547 
dÚe
;

3548 
»g
.
ba£
 = base;

3549 
»g
.
lim™
 =†imit;

3550 iàĞ
İ_by‹s
 == 2 )

3551 
»g
.
ba£
 &= 0xffffff;

3552 iàĞ(
rc
 = 
İs
->
	`wr™e_£gm’t
((
modrm_»g
 & 1) ?

3553 
x86_£g_idŒ
 : 
x86_£g_gdŒ
,

3554 &
»g
, 
ùxt
)) )

3555 
dÚe
;

3558 
—
.
by‹s
 = (—.
ty³
 =ğ
OP_MEM
è? 2 : 
İ_by‹s
;

3559 
d¡
 = 
—
;

3560 
	`ç_if
(
İs
->
»ad_ü
 =ğ
NULL
);

3561 iàĞ(
rc
 = 
İs
->
	`»ad_ü
(0, &
d¡
.
v®
, 
ùxt
)) )

3562 
dÚe
;

3563 
d
 |ğ
Mov
;

3566 
	`ç_if
(
İs
->
»ad_ü
 =ğ
NULL
);

3567 
	`ç_if
(
İs
->
wr™e_ü
 =ğ
NULL
);

3568 iàĞ(
rc
 = 
İs
->
	`»ad_ü
(0, &
ü0
, 
ùxt
)) )

3569 
dÚe
;

3570 iàĞ
—
.
ty³
 =ğ
OP_REG
 )

3571 
ü0w
 = *
—
.
»g
;

3572 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
,

3573 &
ü0w
, 2, 
ùxt
, 
İs
)) )

3574 
dÚe
;

3576 
ü0
 = (ü0 & ~0xeè| (
ü0w
 & 0xf);

3577 iàĞ(
rc
 = 
İs
->
	`wr™e_ü
(0, 
ü0
, 
ùxt
)) )

3578 
dÚe
;

3581 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3582 
	`g’”©e_exû±iÚ_if
(
—
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

3583 
	`ç_if
(
İs
->
švÍg
 =ğ
NULL
);

3584 iàĞ(
rc
 = 
İs
->
	`švÍg
(
—
.
mem
.
£g
,ƒa.mem.
off
, 
ùxt
)) )

3585 
dÚe
;

3588 
ÿÂÙ_emuÏ‹
;

3594 
ušt64_t
 
m¤_cÚ‹Á
;

3595 
£gm’t_»gi¡”
 
cs
 = { 0 }, 
ss
 = { 0 };

3596 
rc
;

3598 
	`g’”©e_exû±iÚ_if
(
	`š_»®mode
(
ùxt
, 
İs
), 
EXC_UD
, 0);

3599 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_UD
, 0);

3602 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3603 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_EFER
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3604 
dÚe
;

3605 
	`g’”©e_exû±iÚ_if
((
m¤_cÚ‹Á
 & 
EFER_SCE
è=ğ0, 
EXC_UD
, 0);

3607 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_STAR
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3608 
dÚe
;

3610 
m¤_cÚ‹Á
 >>= 32;

3611 
cs
.
£l
 = (
ušt16_t
)(
m¤_cÚ‹Á
 & 0xfffc);

3612 
ss
.
£l
 = (
ušt16_t
)(
m¤_cÚ‹Á
 + 8);

3614 
cs
.
ba£
 = 
ss
.base = 0;

3615 
cs
.
lim™
 = 
ss
.limit = ~0u;

3616 
cs
.
©Œ
.
by‹s
 = 0xc9b;

3617 
ss
.
©Œ
.
by‹s
 = 0xc93;

3619 #ifdeà
__x86_64__


3620 
rc
 = 
	`š_lÚgmode
(
ùxt
, 
İs
);

3621 iàĞ
rc
 < 0 )

3622 
ÿÂÙ_emuÏ‹
;

3623 iàĞ
rc
 )

3625 
cs
.
©Œ
.
f›lds
.
db
 = 0;

3626 
cs
.
©Œ
.
f›lds
.
l
 = 1;

3628 
_»gs
.
rcx
 = _»gs.
r
;

3629 
_»gs
.
r11
 = _»gs.
eæags
 & ~
EFLG_RF
;

3631 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
	`mode_64b™
(è? 
MSR_LSTAR
 : 
MSR_CSTAR
,

3632 &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3633 
dÚe
;

3634 
_»gs
.
r
 = 
m¤_cÚ‹Á
;

3636 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_FMASK
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3637 
dÚe
;

3638 
_»gs
.
eæags
 &ğ~(
m¤_cÚ‹Á
 | 
EFLG_RF
);

3643 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_STAR
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3644 
dÚe
;

3646 
_»gs
.
ecx
 = _»gs.
e
;

3647 
_»gs
.
e
 = (
ušt32_t
)
m¤_cÚ‹Á
;

3648 
_»gs
.
eæags
 &ğ~(
EFLG_VM
 | 
EFLG_IF
 | 
EFLG_RF
);

3651 
	`ç_if
(
İs
->
wr™e_£gm’t
 =ğ
NULL
);

3652 iàĞ(
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_cs
, &
cs
, 
ùxt
)) ||

3653 (
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_ss
, &
ss
, 
ùxt
)) )

3654 
dÚe
;

3660 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3661 
	`ç_if
((
İs
->
»ad_ü
 =ğ
NULL
è|| (İs->
wr™e_ü
 == NULL));

3662 iàĞ(
rc
 = 
İs
->
	`»ad_ü
(0, &
d¡
.
v®
, 
ùxt
)) ||

3663 (
rc
 = 
İs
->
	`wr™e_ü
(0, 
d¡
.
v®
&~8, 
ùxt
)) )

3664 
dÚe
;

3669 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3670 
	`ç_if
(
İs
->
wbšvd
 =ğ
NULL
);

3671 iàĞ(
rc
 = 
İs
->
	`wbšvd
(
ùxt
)) != 0 )

3672 
dÚe
;

3684 
	`g’”©e_exû±iÚ_if
(
—
.
ty³
 !ğ
OP_REG
, 
EXC_UD
, -1);

3685 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3686 
modrm_»g
 |ğ
lock_´efix
 << 3;

3687 iàĞ
b
 & 2 )

3690 
¤c
.
v®
 = *(*)
	`decode_»gi¡”
(
modrm_rm
, &
_»gs
, 0);

3691 iàĞ!
	`mode_64b™
() )

3692 
¤c
.
v®
 = (
ušt32_t
)src.val;

3693 
rc
 = ((
b
 & 1)

3694 ? (
İs
->
wr™e_dr


3695 ? 
İs
->
	`wr™e_dr
(
modrm_»g
, 
¤c
.
v®
, 
ùxt
)

3696 : 
X86EMUL_UNHANDLEABLE
)

3697 : (
İs
->
wr™e_ü


3698 ? 
İs
->
	`wr™e_ü
(
modrm_»g
, 
¤c
.
v®
, 
ùxt
)

3699 : 
X86EMUL_UNHANDLEABLE
));

3704 
d¡
.
ty³
 = 
OP_REG
;

3705 
d¡
.
by‹s
 = 
	`mode_64b™
() ? 8 : 4;

3706 
d¡
.
»g
 = 
	`decode_»gi¡”
(
modrm_rm
, &
_»gs
, 0);

3707 
rc
 = ((
b
 & 1)

3708 ? (
İs
->
»ad_dr


3709 ? 
İs
->
	`»ad_dr
(
modrm_»g
, &
d¡
.
v®
, 
ùxt
)

3710 : 
X86EMUL_UNHANDLEABLE
)

3711 : (
İs
->
»ad_ü


3712 ? 
İs
->
	`»ad_ü
(
modrm_»g
, &
d¡
.
v®
, 
ùxt
)

3713 : 
X86EMUL_UNHANDLEABLE
));

3715 iàĞ
rc
 != 0 )

3716 
dÚe
;

3720 
ušt64_t
 
v®
 = ((ušt64_t)
_»gs
.
edx
 << 32è| (
ušt32_t
)_»gs.
—x
;

3721 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3722 
	`ç_if
(
İs
->
wr™e_m¤
 =ğ
NULL
);

3723 iàĞ(
rc
 = 
İs
->
	`wr™e_m¤
((
ušt32_t
)
_»gs
.
ecx
, 
v®
, 
ùxt
)) != 0 )

3724 
dÚe
;

3728 0x31: 
rdtsc
: {

3729 
ü4
;

3730 
ušt64_t
 
v®
;

3731 iàĞ!
	`mode_ršg0
() )

3733 
	`ç_if
(
İs
->
»ad_ü
 =ğ
NULL
);

3734 iàĞ(
rc
 = 
İs
->
	`»ad_ü
(4, &
ü4
, 
ùxt
)) )

3735 
dÚe
;

3736 
	`g’”©e_exû±iÚ_if
(
ü4
 & 
CR4_TSD
, 
EXC_GP
, 0);

3738 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3739 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_TSC
, &
v®
, 
ùxt
)) != 0 )

3740 
dÚe
;

3741 
_»gs
.
edx
 = (
ušt32_t
)(
v®
 >> 32);

3742 
_»gs
.
—x
 = (
ušt32_t
)(
v®
 >> 0);

3747 
ušt64_t
 
v®
;

3748 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3749 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3750 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
((
ušt32_t
)
_»gs
.
ecx
, &
v®
, 
ùxt
)) != 0 )

3751 
dÚe
;

3752 
_»gs
.
edx
 = (
ušt32_t
)(
v®
 >> 32);

3753 
_»gs
.
—x
 = (
ušt32_t
)(
v®
 >> 0);

3758 
d¡
.
v®
 = 
¤c
.val;

3759 iàĞ!
	`‹¡_cc
(
b
, 
_»gs
.
eæags
) )

3760 
d¡
.
ty³
 = 
OP_NONE
;

3764 
ušt64_t
 
m¤_cÚ‹Á
;

3765 
£gm’t_»gi¡”
 
cs
, 
ss
;

3766 
rc
;

3768 
	`g’”©e_exû±iÚ_if
(
	`mode_ršg0
(), 
EXC_GP
, 0);

3769 
	`g’”©e_exû±iÚ_if
(
	`š_»®mode
(
ùxt
, 
İs
), 
EXC_GP
, 0);

3770 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_GP
, 0);

3772 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3773 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_SYSENTER_CS
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3774 
dÚe
;

3776 iàĞ
	`mode_64b™
() )

3777 
	`g’”©e_exû±iÚ_if
(
m¤_cÚ‹Á
 =ğ0, 
EXC_GP
, 0);

3779 
	`g’”©e_exû±iÚ_if
((
m¤_cÚ‹Á
 & 0xfffcè=ğ0, 
EXC_GP
, 0);

3781 
_»gs
.
eæags
 &ğ~(
EFLG_VM
 | 
EFLG_IF
 | 
EFLG_RF
);

3783 
	`ç_if
(
İs
->
»ad_£gm’t
 =ğ
NULL
);

3784 
İs
->
	`»ad_£gm’t
(
x86_£g_cs
, &
cs
, 
ùxt
);

3785 
cs
.
£l
 = (
ušt16_t
)
m¤_cÚ‹Á
 & ~3;

3786 
cs
.
ba£
 = 0;

3787 
cs
.
lim™
 = ~0u;

3788 
cs
.
©Œ
.
by‹s
 = 0xc9b;

3790 
ss
.
£l
 = 
cs
.sel + 8;

3791 
ss
.
ba£
 = 0;

3792 
ss
.
lim™
 = ~0u;

3793 
ss
.
©Œ
.
by‹s
 = 0xc93;

3795 
rc
 = 
	`š_lÚgmode
(
ùxt
, 
İs
);

3796 iàĞ
rc
 < 0 )

3797 
ÿÂÙ_emuÏ‹
;

3798 iàĞ
rc
 )

3800 
cs
.
©Œ
.
f›lds
.
db
 = 0;

3801 
cs
.
©Œ
.
f›lds
.
l
 = 1;

3804 
	`ç_if
(
İs
->
wr™e_£gm’t
 =ğ
NULL
);

3805 iàĞ(
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_cs
, &
cs
, 
ùxt
)) != 0 ||

3806 (
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_ss
, &
ss
, 
ùxt
)) != 0 )

3807 
dÚe
;

3809 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_SYSENTER_EIP
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3810 
dÚe
;

3811 
_»gs
.
e
 = 
m¤_cÚ‹Á
;

3813 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_SYSENTER_ESP
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3814 
dÚe
;

3815 
_»gs
.
e¥
 = 
m¤_cÚ‹Á
;

3821 
ušt64_t
 
m¤_cÚ‹Á
;

3822 
£gm’t_»gi¡”
 
cs
, 
ss
;

3823 
u£r64
 = !!(
»x_´efix
 & 8);

3824 
rc
;

3826 
	`g’”©e_exû±iÚ_if
(!
	`mode_ršg0
(), 
EXC_GP
, 0);

3827 
	`g’”©e_exû±iÚ_if
(
	`š_»®mode
(
ùxt
, 
İs
), 
EXC_GP
, 0);

3828 
	`g’”©e_exû±iÚ_if
(!
	`š_´Ùmode
(
ùxt
, 
İs
), 
EXC_GP
, 0);

3830 
	`ç_if
(
İs
->
»ad_m¤
 =ğ
NULL
);

3831 iàĞ(
rc
 = 
İs
->
	`»ad_m¤
(
MSR_SYSENTER_CS
, &
m¤_cÚ‹Á
, 
ùxt
)) != 0 )

3832 
dÚe
;

3834 iàĞ
u£r64
 )

3836 
cs
.
£l
 = (
ušt16_t
)(
m¤_cÚ‹Á
 + 32);

3837 
ss
.
£l
 = (
cs
.sel + 8);

3838 
	`g’”©e_exû±iÚ_if
(
m¤_cÚ‹Á
 =ğ0, 
EXC_GP
, 0);

3842 
cs
.
£l
 = (
ušt16_t
)(
m¤_cÚ‹Á
 + 16);

3843 
ss
.
£l
 = (
ušt16_t
)(
m¤_cÚ‹Á
 + 24);

3844 
	`g’”©e_exû±iÚ_if
((
m¤_cÚ‹Á
 & 0xfffcè=ğ0, 
EXC_GP
, 0);

3847 
cs
.
£l
 |= 0x3;

3848 
cs
.
ba£
 = 0;

3849 
cs
.
lim™
 = ~0u;

3850 
cs
.
©Œ
.
by‹s
 = 0xcfb;

3852 
ss
.
£l
 |= 0x3;

3853 
ss
.
ba£
 = 0;

3854 
ss
.
lim™
 = ~0u;

3855 
ss
.
©Œ
.
by‹s
 = 0xcf3;

3857 iàĞ
u£r64
 )

3859 
cs
.
©Œ
.
f›lds
.
db
 = 0;

3860 
cs
.
©Œ
.
f›lds
.
l
 = 1;

3863 
	`ç_if
(
İs
->
wr™e_£gm’t
 =ğ
NULL
);

3864 iàĞ(
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_cs
, &
cs
, 
ùxt
)) != 0 ||

3865 (
rc
 = 
İs
->
	`wr™e_£gm’t
(
x86_£g_ss
, &
ss
, 
ùxt
)) != 0 )

3866 
dÚe
;

3868 
_»gs
.
e
 = _»gs.
edx
;

3869 
_»gs
.
e¥
 = _»gs.
ecx
;

3874 
ušt8_t
 
¡ub
[] = { 0x0f, 0x6f, 
modrm
, 0xc3 };

3875 
åu_š¢_ùxt
 
fic
 = { .
š¢_by‹s
 = (
¡ub
)-1 };

3876 
ušt64_t
 
v®
;

3877 iàĞ
—
.
ty³
 =ğ
OP_MEM
 )

3879 
lv®
, 
hv®
;

3880 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
+0,

3881 &
lv®
, 4, 
ùxt
, 
İs
)) ||

3882 (
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
+4,

3883 &
hv®
, 4, 
ùxt
, 
İs
)) )

3884 
dÚe
;

3885 
v®
 = ((
ušt64_t
)
hv®
 << 32è| (
ušt32_t
)
lv®
;

3886 
¡ub
[2] = 
modrm
 & 0x38;

3888 
	`g‘_åu
(
X86EMUL_FPU_mmx
, &
fic
);

3889 
asm
 vŞ©Ğ"ÿÎ *%0" : : "r" (
¡ub
), "a" (&
v®
) : "memory" );

3890 
	`put_åu
(&
fic
);

3895 
ušt8_t
 
¡ub
[] = { 0x0f, 0x7f, 
modrm
, 0xc3 };

3896 
åu_š¢_ùxt
 
fic
 = { .
š¢_by‹s
 = (
¡ub
)-1 };

3897 
ušt64_t
 
v®
;

3898 iàĞ
—
.
ty³
 =ğ
OP_MEM
 )

3899 
¡ub
[2] = 
modrm
 & 0x38;

3900 
	`g‘_åu
(
X86EMUL_FPU_mmx
, &
fic
);

3901 
asm
 vŞ©Ğ"ÿÎ *%0" : : "r" (
¡ub
), "a" (&
v®
) : "memory" );

3902 
	`put_åu
(&
fic
);

3903 iàĞ
—
.
ty³
 =ğ
OP_MEM
 )

3905 
lv®
 = (
ušt32_t
)
v®
, 
hv®
 = (uint32_t)(val >> 32);

3906 iàĞ(
rc
 = 
İs
->
	`wr™e
(
—
.
mem
.
£g
,ƒa.mem.
off
+0, &
lv®
, 4, 
ùxt
)) ||

3907 (
rc
 = 
İs
->
	`wr™e
(
—
.
mem
.
£g
,ƒa.mem.
off
+4, &
hv®
, 4, 
ùxt
)) )

3908 
dÚe
;

3914 
»l
 = ((
İ_by‹s
 == 2)

3915 ? (
št32_t
)
	`š¢_ãtch_ty³
(
št16_t
)

3916 : 
	`š¢_ãtch_ty³
(
št32_t
));

3917 iàĞ
	`‹¡_cc
(
b
, 
_»gs
.
eæags
) )

3918 
	`jmp_»l
(
»l
);

3923 
d¡
.
v®
 = 
	`‹¡_cc
(
b
, 
_»gs
.
eæags
);

3927 
¤c
.
v®
 = 
x86_£g_fs
;

3928 
push_£g
;

3931 
¤c
.
v®
 = 
x86_£g_fs
;

3932 
pİ_£g
;

3935 
—x
 = 
_»gs
.—x, 
ebx
 = _regs.ebx;

3936 
ecx
 = 
_»gs
.ecx, 
edx
 = _regs.edx;

3937 
	`ç_if
(
İs
->
ıuid
 =ğ
NULL
);

3938 iàĞ(
rc
 = 
İs
->
	`ıuid
(&
—x
, &
ebx
, &
ecx
, &
edx
, 
ùxt
)) != 0 )

3939 
dÚe
;

3940 
_»gs
.
—x
 =ƒax; _»gs.
ebx
 =ƒbx;

3941 
_»gs
.
ecx
 =ƒcx; _»gs.
edx
 =ƒdx;

3946 
¤c
.
v®
 = 
x86_£g_gs
;

3947 
push_£g
;

3950 
¤c
.
v®
 = 
x86_£g_gs
;

3951 
pİ_£g
;

3955 
¤c
.
Üig_v®
 = src.
v®
;

3956 
¤c
.
v®
 = 
_»gs
.
—x
;

3957 
	`emuÏ‹_2İ_SrcV
("cmp", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

3958 iàĞ
_»gs
.
eæags
 & 
EFLG_ZF
 )

3961 
d¡
.
v®
 = 
¤c
.
Üig_v®
;

3966 
d¡
.
ty³
 = 
OP_REG
;

3967 
d¡
.
»g
 = (*)&
_»gs
.
—x
;

3971 0xa3: 
bt
:

3972 
	`emuÏ‹_2İ_SrcV_noby‹
("bt", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

3973 
d¡
.
ty³
 = 
OP_NONE
;

3980 
ušt8_t
 
shiá
, 
width
 = 
d¡
.
by‹s
 << 3;

3981 
shiá
 = (
b
 & 1è? (
ušt8_t
)
_»gs
.
ecx
 : 
	`š¢_ãtch_ty³
(uint8_t);

3982 iàĞ(
shiá
 &ğ
width
 - 1) == 0 )

3984 
d¡
.
Üig_v®
 = 
	`Œunÿ‹_wÜd
(d¡.
v®
, d¡.
by‹s
);

3985 
d¡
.
v®
 = ((
shiá
 =ğ
width
è? 
¤c
.val :

3986 (
b
 & 8) ?

3988 ((
d¡
.
Üig_v®
 >> 
shiá
) |

3989 
	`Œunÿ‹_wÜd
(
¤c
.
v®
 << (
width
 - 
shiá
), 
d¡
.
by‹s
)) :

3991 ((
d¡
.
Üig_v®
 << 
shiá
) |

3992 ((
¤c
.
v®
 >> (
width
 - 
shiá
)) & ((1ull << shift) - 1))));

3993 
d¡
.
v®
 = 
	`Œunÿ‹_wÜd
(d¡.v®, d¡.
by‹s
);

3994 
_»gs
.
eæags
 &ğ~(
EFLG_OF
|
EFLG_SF
|
EFLG_ZF
|
EFLG_PF
|
EFLG_CF
);

3995 iàĞ(
d¡
.
v®
 >> ((
b
 & 8è? (
shiá
 - 1è: (
width
 - shift))) & 1 )

3996 
_»gs
.
eæags
 |ğ
EFLG_CF
;

3997 iàĞ((
d¡
.
v®
 ^ d¡.
Üig_v®
è>> (
width
 - 1)) & 1 )

3998 
_»gs
.
eæags
 |ğ
EFLG_OF
;

3999 
_»gs
.
eæags
 |ğ((
d¡
.
v®
 >> (
width
 - 1)è& 1è? 
EFLG_SF
 : 0;

4000 
_»gs
.
eæags
 |ğ(
d¡
.
v®
 =ğ0è? 
EFLG_ZF
 : 0;

4001 
_»gs
.
eæags
 |ğ
	`ev’_·r™y
(
d¡
.
v®
è? 
EFLG_PF
 : 0;

4005 0xb3: 
bŒ
:

4006 
	`emuÏ‹_2İ_SrcV_noby‹
("bŒ", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

4009 0xab: 
bts
:

4010 
	`emuÏ‹_2İ_SrcV_noby‹
("bts", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

4014  
modrm_»g
 & 7 )

4017 
	`ç_if
(
İs
->
wbšvd
 =ğ
NULL
);

4018 iàĞ(
rc
 = 
İs
->
	`wbšvd
(
ùxt
)) != 0 )

4019 
dÚe
;

4022 
ÿÂÙ_emuÏ‹
;

4027 
_»gs
.
eæags
 &ğ~(
EFLG_OF
|
EFLG_CF
);

4028  
d¡
.
by‹s
 )

4031 
d¡
.
v®
 = ((
ušt32_t
)(
št16_t
)
¤c
.val *

4032 (
ušt32_t
)(
št16_t
)
d¡
.
v®
);

4033 iàĞ(
št16_t
)
d¡
.
v®
 !ğ(
ušt32_t
)dst.val )

4034 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

4036 #ifdeà
__x86_64__


4038 
d¡
.
v®
 = ((
ušt64_t
)(
št32_t
)
¤c
.val *

4039 (
ušt64_t
)(
št32_t
)
d¡
.
v®
);

4040 iàĞ(
št32_t
)
d¡
.
v®
 != dst.val )

4041 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

4045 
m
[2] = { 
¤c
.
v®
, 
d¡
.val };

4046 iàĞ
	`imul_dbl
(
m
) )

4047 
_»gs
.
eæags
 |ğ
EFLG_OF
|
EFLG_CF
;

4048 
d¡
.
v®
 = 
m
[0];

4055 
d¡
.
v®
 = 
x86_£g_ss
;

4056 
Ës
;

4059 
d¡
.
v®
 = 
x86_£g_fs
;

4060 
Ës
;

4063 
d¡
.
v®
 = 
x86_£g_gs
;

4064 
Ës
;

4068 
d¡
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, 0);

4069 
d¡
.
by‹s
 = 
İ_by‹s
;

4070 
d¡
.
v®
 = (
ušt8_t
)
¤c
.val;

4074 
zf
;

4075 
	`asm
 ( "bsf %2,%0; setz %b1"

4076 : "ô" (
d¡
.
v®
), "=q" (
zf
)

4077 : "r" (
¤c
.
v®
), "1" (0) );

4078 
_»gs
.
eæags
 &ğ~
EFLG_ZF
;

4079 iàĞ
zf
 )

4081 
_»gs
.
eæags
 |ğ
EFLG_ZF
;

4082 
d¡
.
ty³
 = 
OP_NONE
;

4088 
zf
;

4089 
	`asm
 ( "bsr %2,%0; setz %b1"

4090 : "ô" (
d¡
.
v®
), "=q" (
zf
)

4091 : "r" (
¤c
.
v®
), "1" (0) );

4092 
_»gs
.
eæags
 &ğ~
EFLG_ZF
;

4093 iàĞ
zf
 )

4095 
_»gs
.
eæags
 |ğ
EFLG_ZF
;

4096 
d¡
.
ty³
 = 
OP_NONE
;

4102 
d¡
.
v®
 = (
ušt16_t
)
¤c
.val;

4105 0xbb: 
btc
:

4106 
	`emuÏ‹_2İ_SrcV_noby‹
("btc", 
¤c
, 
d¡
, 
_»gs
.
eæags
);

4110  
modrm_»g
 & 7 )

4112 4: 
bt
;

4113 5: 
bts
;

4114 6: 
bŒ
;

4115 7: 
btc
;

4116 : 
	`g’”©e_exû±iÚ_if
(1, 
EXC_UD
, -1);

4122 
d¡
.
»g
 = 
	`decode_»gi¡”
(
modrm_»g
, &
_»gs
, 0);

4123 
d¡
.
by‹s
 = 
İ_by‹s
;

4124 
d¡
.
v®
 = (
št8_t
)
¤c
.val;

4128 
d¡
.
v®
 = (
št16_t
)
¤c
.val;

4133  
d¡
.
by‹s
 )

4135 1: *(
ušt8_t
 *)
¤c
.
»g
 = (ušt8_t)
d¡
.
v®
; ;

4136 2: *(
ušt16_t
 *)
¤c
.
»g
 = (ušt16_t)
d¡
.
v®
; ;

4137 4: *
¤c
.
»g
 = (
ušt32_t
)
d¡
.
v®
; ;

4138 8: *
¤c
.
»g
 = 
d¡
.
v®
; ;

4140 
add
;

4144 
	`g’”©e_exû±iÚ_if
(
d¡
.
by‹s
 <ğ2, 
EXC_UD
, -1);

4145 
d¡
.
v®
 = 
¤c
.val;

4149 
Şd
[2], 
exp
[2], 
Ãw
[2];

4150 
i
;

4152 
	`g’”©e_exû±iÚ_if
((
modrm_»g
 & 7è!ğ1, 
EXC_UD
, -1);

4153 
	`g’”©e_exû±iÚ_if
(
—
.
ty³
 !ğ
OP_MEM
, 
EXC_UD
, -1);

4154 
İ_by‹s
 *= 2;

4157  
i
 = 0; i < (
İ_by‹s
/()); i++ )

4158 iàĞ(
rc
 = 
	`»ad_ulÚg
(
—
.
mem
.
£g
,ƒa.mem.
off
 + 
i
*(),

4159 &
Şd
[
i
], (), 
ùxt
, 
İs
)) != 0 )

4160 
dÚe
;

4163 iàĞ
İ_by‹s
 == 8 )

4165 ((
ušt32_t
 *)
exp
)[0] = 
_»gs
.
—x
; ((ušt32_ˆ*ëxp)[1] = _»gs.
edx
;

4166 ((
ušt32_t
 *)
Ãw
)[0] = 
_»gs
.
ebx
; ((ušt32_ˆ*êew)[1] = _»gs.
ecx
;

4170 
exp
[0] = 
_»gs
.
—x
;ƒxp[1] = _»gs.
edx
;

4171 
Ãw
[0] = 
_»gs
.
ebx
;‚ew[1] = _»gs.
ecx
;

4174 iàĞ
	`memcmp
(
Şd
, 
exp
, 
İ_by‹s
) )

4177 
_»gs
.
—x
 = (
İ_by‹s
 =ğ8è? ((
ušt32_t
 *)
Şd
)[0] : old[0];

4178 
_»gs
.
edx
 = (
İ_by‹s
 =ğ8è? ((
ušt32_t
 *)
Şd
)[1] : old[1];

4179 
_»gs
.
eæags
 &ğ~
EFLG_ZF
;

4184 iàĞ(
rc
 = 
İs
->
	`cmpxchg
(
—
.
mem
.
£g
,ƒa.mem.
off
, 
Şd
,

4185 
Ãw
, 
İ_by‹s
, 
ùxt
)) != 0 )

4186 
dÚe
;

4187 
_»gs
.
eæags
 |ğ
EFLG_ZF
;

4193 
d¡
.
ty³
 = 
OP_REG
;

4194 
d¡
.
»g
 = 
	`decode_»gi¡”
(

4195 (
b
 & 7è| ((
»x_´efix
 & 1è<< 3), &
_»gs
, 0);

4196  
d¡
.
by‹s
 = 
İ_by‹s
 )

4200 
d¡
.
v®
 = 0;

4203 #ifdeà
__x86_64__


4204 
	`asm
 ( "bsw­ %k0" : "ô" (
d¡
.
v®
è: "0" (*d¡.
»g
) );

4208 
	`asm
 ( "bsw­ %0" : "ô" (
d¡
.
v®
è: "0" (*d¡.
»g
) );

4213 
wr™eback
;

4215 
ÿÂÙ_emuÏ‹
:

4216  
X86EMUL_UNHANDLEABLE
;

4217 
	}
}

	@x86_emulate/x86_emulate.h

24 #iâdeà
__X86_EMULATE_H__


25 
	#__X86_EMULATE_H__


	)

27 
	gx86_emuÏ‹_ùxt
;

30 
	ex86_£gm’t
 {

32 
	mx86_£g_cs
,

33 
	mx86_£g_ss
,

34 
	mx86_£g_ds
,

35 
	mx86_£g_es
,

36 
	mx86_£g_fs
,

37 
	mx86_£g_gs
,

39 
	mx86_£g_Œ
,

40 
	mx86_£g_ldŒ
,

41 
	mx86_£g_gdŒ
,

42 
	mx86_£g_idŒ
,

49 
	mx86_£g_nÚe


52 
	#is_x86_u£r_£gm’t
(
£g
è(()(£gè<ğ
x86_£g_gs
)

	)

58 
	u£gm’t_©Œibu‹s
 {

59 
ušt16_t
 
	mby‹s
;

62 
ušt16_t
 
	mty³
:4;

63 
ušt16_t
 
	ms
: 1;

64 
ušt16_t
 
	md¶
: 2;

65 
ušt16_t
 
	mp
: 1;

66 
ušt16_t
 
	mavl
: 1;

67 
ušt16_t
 
	ml
: 1;

68 
ušt16_t
 
	mdb
: 1;

69 
ušt16_t
 
	mg
: 1;

70 
ušt16_t
 
	m·d
: 4;

71 } 
	mf›lds
;

72 } 
	t__©Œibu‹__
 ((
	t·cked
)è
	t£gm’t_©Œibu‹s_t
;

78 
	s£gm’t_»gi¡”
 {

79 
ušt16_t
 
	m£l
;

80 
£gm’t_©Œibu‹s_t
 
	m©Œ
;

81 
ušt32_t
 
	mlim™
;

82 
ušt64_t
 
	mba£
;

83 } 
__©Œibu‹__
 ((
·cked
));

89 
	#X86EMUL_OKAY
 0

	)

91 
	#X86EMUL_UNHANDLEABLE
 1

	)

93 
	#X86EMUL_EXCEPTION
 2

	)

95 
	#X86EMUL_RETRY
 3

	)

97 
	#X86EMUL_CMPXCHG_FAILED
 3

	)

100 
	ex86_emuÏ‹_åu_ty³
 {

101 
	mX86EMUL_FPU_åu
,

102 
	mX86EMUL_FPU_mmx


117 
	sx86_emuÏ‹_İs


140 (*
	m»ad
)(

141 
x86_£gm’t
 
	m£g
,

142 
	moff£t
,

143 *
	mp_d©a
,

144 
	mby‹s
,

145 
x86_emuÏ‹_ùxt
 *
	mùxt
);

151 (*
	mš¢_ãtch
)(

152 
x86_£gm’t
 
	m£g
,

153 
	moff£t
,

154 *
	mp_d©a
,

155 
	mby‹s
,

156 
x86_emuÏ‹_ùxt
 *
	mùxt
);

162 (*
	mwr™e
)(

163 
x86_£gm’t
 
	m£g
,

164 
	moff£t
,

165 *
	mp_d©a
,

166 
	mby‹s
,

167 
x86_emuÏ‹_ùxt
 *
	mùxt
);

175 (*
	mcmpxchg
)(

176 
x86_£gm’t
 
	m£g
,

177 
	moff£t
,

178 *
	mp_Şd
,

179 *
	mp_Ãw
,

180 
	mby‹s
,

181 
x86_emuÏ‹_ùxt
 *
	mùxt
);

189 (*
	m»p_šs
)(

190 
ušt16_t
 
	m¤c_pÜt
,

191 
x86_£gm’t
 
	md¡_£g
,

192 
	md¡_off£t
,

193 
	mby‹s_³r_»p
,

194 *
	m»ps
,

195 
x86_emuÏ‹_ùxt
 *
	mùxt
);

203 (*
	m»p_outs
)(

204 
x86_£gm’t
 
	m¤c_£g
,

205 
	m¤c_off£t
,

206 
ušt16_t
 
	md¡_pÜt
,

207 
	mby‹s_³r_»p
,

208 *
	m»ps
,

209 
x86_emuÏ‹_ùxt
 *
	mùxt
);

217 (*
	m»p_movs
)(

218 
x86_£gm’t
 
	m¤c_£g
,

219 
	m¤c_off£t
,

220 
x86_£gm’t
 
	md¡_£g
,

221 
	md¡_off£t
,

222 
	mby‹s_³r_»p
,

223 *
	m»ps
,

224 
x86_emuÏ‹_ùxt
 *
	mùxt
);

230 (*
	m»ad_£gm’t
)(

231 
x86_£gm’t
 
	m£g
,

232 
£gm’t_»gi¡”
 *
	m»g
,

233 
x86_emuÏ‹_ùxt
 *
	mùxt
);

239 (*
	mwr™e_£gm’t
)(

240 
x86_£gm’t
 
	m£g
,

241 
£gm’t_»gi¡”
 *
	m»g
,

242 
x86_emuÏ‹_ùxt
 *
	mùxt
);

248 (*
	m»ad_io
)(

249 
	mpÜt
,

250 
	mby‹s
,

251 *
	mv®
,

252 
x86_emuÏ‹_ùxt
 *
	mùxt
);

258 (*
	mwr™e_io
)(

259 
	mpÜt
,

260 
	mby‹s
,

261 
	mv®
,

262 
x86_emuÏ‹_ùxt
 *
	mùxt
);

268 (*
	m»ad_ü
)(

269 
	m»g
,

270 *
	mv®
,

271 
x86_emuÏ‹_ùxt
 *
	mùxt
);

277 (*
	mwr™e_ü
)(

278 
	m»g
,

279 
	mv®
,

280 
x86_emuÏ‹_ùxt
 *
	mùxt
);

286 (*
	m»ad_dr
)(

287 
	m»g
,

288 *
	mv®
,

289 
x86_emuÏ‹_ùxt
 *
	mùxt
);

295 (*
	mwr™e_dr
)(

296 
	m»g
,

297 
	mv®
,

298 
x86_emuÏ‹_ùxt
 *
	mùxt
);

304 (*
	m»ad_m¤
)(

305 
	m»g
,

306 
ušt64_t
 *
	mv®
,

307 
x86_emuÏ‹_ùxt
 *
	mùxt
);

313 (*
	mwr™e_m¤
)(

314 
	m»g
,

315 
ušt64_t
 
	mv®
,

316 
x86_emuÏ‹_ùxt
 *
	mùxt
);

319 (*
	mwbšvd
)(

320 
x86_emuÏ‹_ùxt
 *
	mùxt
);

323 (*
	mıuid
)(

324 *
	m—x
,

325 *
	mebx
,

326 *
	mecx
,

327 *
	medx
,

328 
x86_emuÏ‹_ùxt
 *
	mùxt
);

331 (*
	mšjeù_hw_exû±iÚ
)(

332 
ušt8_t
 
	mveùÜ
,

333 
št32_t
 
	m”rÜ_code
,

334 
x86_emuÏ‹_ùxt
 *
	mùxt
);

337 (*
	mšjeù_sw_š‹¼u±
)(

338 
ušt8_t
 
	mveùÜ
,

339 
ušt8_t
 
	mš¢_Ën
,

340 
x86_emuÏ‹_ùxt
 *
	mùxt
);

347 (*
	mg‘_åu
)(

348 (*
	mexû±iÚ_ÿÎback
)(*, 
	mıu_u£r_»gs
 *),

349 *
	mexû±iÚ_ÿÎback_¬g
,

350 
x86_emuÏ‹_åu_ty³
 
	mty³
,

351 
x86_emuÏ‹_ùxt
 *
	mùxt
);

354 (*
	mput_åu
)(

355 
x86_emuÏ‹_ùxt
 *
	mùxt
);

358 (*
	mšvÍg
)(

359 
x86_£gm’t
 
	m£g
,

360 
	moff£t
,

361 
x86_emuÏ‹_ùxt
 *
	mùxt
);

364 
	gıu_u£r_»gs
;

366 
	sx86_emuÏ‹_ùxt


369 
ıu_u£r_»gs
 *
	m»gs
;

372 
	maddr_size
;

375 
	m¥_size
;

378 
ušt8_t
 
	mfÜû_wr™eback
;

383 
ušt8_t
 
	mhÉ
:1;

384 
ušt8_t
 
	mmov_ss
:1;

385 
ušt8_t
 
	m¡i
:1;

386 } 
	mæags
;

387 
ušt8_t
 
	mby‹
;

388 } 
	m»tœe
;

396 
x86_emuÏ‹
(

397 
x86_emuÏ‹_ùxt
 *
ùxt
,

398 cÚ¡ 
x86_emuÏ‹_İs
 *
İs
);

406 
decode_»gi¡”
(

407 
ušt8_t
 
modrm_»g
, 
ıu_u£r_»gs
 *
»gs
, 
highby‹_»gs
);

	@../../common/inflate.c

1 
	#DEBG
(
x
)

	)

2 
	#DEBG1
(
x
)

	)

106 #ifdeà
RCSID


107 
	grcsid
[] = "#Id: inflate.c,v 0.14 1993/06/10 13:27:04 jloup Exp #";

110 #iâdeà
STATIC


112 #ià
defšed
(
STDC_HEADERS
è|| defšed(
HAVE_STDLIB_H
)

113 
	~<sys/ty³s.h
>

114 
	~<¡dlib.h
>

117 
	~"gz.h
"

118 
	#STATIC


	)

121 #iâdeà
INIT


122 
	#INIT


	)

125 
	#¦ide
 
wšdow


	)

134 
	shuá
 {

135 
uch
 
	me
;

136 
uch
 
	mb
;

138 
ush
 
	mn
;

139 
huá
 *
	mt
;

140 } 
	mv
;

145 
STATIC
 
INIT
 
huá_bud
 
OF
((*, , ,

146 cÚ¡ 
ush
 *, cÚ¡ ush *, 
huá
 **, *));

147 
STATIC
 
INIT
 
huá_ä“
 
OF
((
huá
 *));

148 
STATIC
 
INIT
 
šæ©e_codes
 
OF
((
huá
 *, huft *, , ));

149 
STATIC
 
INIT
 
šæ©e_¡Üed
 
OF
(());

150 
STATIC
 
INIT
 
šæ©e_fixed
 
OF
(());

151 
STATIC
 
INIT
 
šæ©e_dyÇmic
 
OF
(());

152 
STATIC
 
INIT
 
šæ©e_block
 
OF
((*));

153 
STATIC
 
INIT
 
šæ©e
 
OF
(());

165 
	#wp
 
outút


	)

166 
	#æush_ouut
(
w
è(
wp
=(w),
	`æush_wšdow
())

	)

169 cÚ¡ 
	gbÜd”
[] = {

171 cÚ¡ 
ush
 
	gıËns
[] = {

175 cÚ¡ 
ush
 
	gıËxt
[] = {

178 cÚ¡ 
ush
 
	gıdi¡
[] = {

182 cÚ¡ 
ush
 
	gıdext
[] = {

219 
STATIC
 
ulg
 
	gbb
;

220 
STATIC
 
	gbk
;

222 
STATIC
 cÚ¡ 
ush
 
	gmask_b™s
[] = {

228 
	#NEXTBYTE
(è({ 
v
 = 
	`g‘_by‹
(); ià(v < 0è
und”run
; (
uch
)v; })

	)

229 
	#NEEDBITS
(
n
è{
k
<Ò)){
b
|=((
ulg
)
	`NEXTBYTE
())<<k;k+=8;}}

	)

230 
	#DUMPBITS
(
n
è{
b
>>=Ò);
k
-=Ò);}

	)

232 #iâdeà
NO_INFLATE_MALLOC


237 
	gm®loc_±r
;

238 
	gm®loc_couÁ
;

240 *
	$m®loc
(
size
)

242 *
p
;

244 ià(
size
 < 0)

245 
	`”rÜ
("Mallocƒrror");

246 ià(!
m®loc_±r
)

247 
m®loc_±r
 = 
ä“_mem_±r
;

249 
m®loc_±r
 = (malloc_ptr + 3) & ~3;

251 
p
 = (*)
m®loc_±r
;

252 
m®loc_±r
 +ğ
size
;

254 ià(
ä“_mem_’d_±r
 && 
m®loc_±r
 >= free_mem_end_ptr)

255 
	`”rÜ
("Out of memory");

257 
m®loc_couÁ
++;

258  
p
;

259 
	}
}

261 
	$ä“
(*
wh”e
)

263 
m®loc_couÁ
--;

264 ià(!
m®loc_couÁ
)

265 
m®loc_±r
 = 
ä“_mem_±r
;

266 
	}
}

268 
	#m®loc
(
a
è
	`km®loc
×, 
GFP_KERNEL
)

	)

269 
	#ä“
(
a
è
	`kä“
×)

	)

305 
STATIC
 cÚ¡ 
	glb™s
 = 9;

306 
STATIC
 cÚ¡ 
	gdb™s
 = 6;

310 
	#BMAX
 16

	)

311 
	#N_MAX
 288

	)

314 
STATIC
 
	ghuás
;

317 
STATIC
 
INIT
 
	$huá_bud
(

318 *
b
,

319 
n
,

320 
s
,

321 cÚ¡ 
ush
 *
d
,

322 cÚ¡ 
ush
 *
e
,

323 
huá
 **
t
,

324 *
m


332 
a
;

333 
f
;

334 
g
;

335 
h
;

336 
i
;

337 
j
;

338 
k
;

339 
l
;

340 *
p
;

341 
huá
 *
q
;

342 
huá
 
r
;

343 
w
;

344 *
xp
;

345 
y
;

346 
z
;

348 
c
[
BMAX
+1];

349 
huá
 *
u
[
BMAX
];

350 
v
[
N_MAX
];

351 
x
[
BMAX
+1];

352 } *
¡k
;

353 *
c
, *
v
, *
x
;

354 
huá
 **
u
;

355 
»t
;

357 
	`DEBG
("huft1 ");

359 
¡k
 = 
	`m®loc
((*stk));

360 ià(
¡k
 =ğ
NULL
)

363 
c
 = 
¡k
->c;

364 
v
 = 
¡k
->v;

365 
x
 = 
¡k
->x;

366 
u
 = 
¡k
->u;

369 
	`memz”o
(
¡k
->
c
, (stk->c));

370 
p
 = 
b
; 
i
 = 
n
;

372 
	`T¿ûcv
(*
p
, (
¡d”r
, (
n
-
i
 >= ' ' &&‚-i <= '~' ? "%c %d\n" : "0x%x %d\n"),

373 
n
-
i
, *
p
));

374 
c
[*
p
]++;

375 
p
++;

376 } --
i
);

377 ià(
c
[0] =ğ
n
)

379 *
t
 = (
huá
 *)
NULL
;

380 *
m
 = 0;

381 
»t
 = 2;

382 
out
;

385 
	`DEBG
("huft2 ");

388 
l
 = *
m
;

389 
j
 = 1; j <ğ
BMAX
; j++)

390 ià(
c
[
j
])

392 
k
 = 
j
;

393 ià(()
l
 < 
j
)

394 
l
 = 
j
;

395 
i
 = 
BMAX
; i; i--)

396 ià(
c
[
i
])

398 
g
 = 
i
;

399 ià(()
l
 > 
i
)

400 
l
 = 
i
;

401 *
m
 = 
l
;

403 
	`DEBG
("huft3 ");

406 
y
 = 1 << 
j
; j < 
i
; j++, y <<= 1)

407 ià((
y
 -ğ
c
[
j
]) < 0) {

408 
»t
 = 2;

409 
out
;

411 ià((
y
 -ğ
c
[
i
]) < 0) {

412 
»t
 = 2;

413 
out
;

415 
c
[
i
] +ğ
y
;

417 
	`DEBG
("huft4 ");

420 
x
[1] = 
j
 = 0;

421 
p
 = 
c
 + 1; 
xp
 = 
x
 + 2;

422 --
i
) {

423 *
xp
++ = (
j
 +ğ*
p
++);

426 
	`DEBG
("huft5 ");

429 
p
 = 
b
; 
i
 = 0;

431 ià((
j
 = *
p
++) != 0)

432 
v
[
x
[
j
]++] = 
i
;

433 } ++
i
 < 
n
);

434 
n
 = 
x
[
g
];

436 
	`DEBG
("h6 ");

439 
x
[0] = 
i
 = 0;

440 
p
 = 
v
;

441 
h
 = -1;

442 
w
 = -
l
;

443 
u
[0] = (
huá
 *)
NULL
;

444 
q
 = (
huá
 *)
NULL
;

445 
z
 = 0;

446 
	`DEBG
("h6a ");

449 ; 
k
 <ğ
g
; k++)

451 
	`DEBG
("h6b ");

452 
a
 = 
c
[
k
];

453 
a
--)

455 
	`DEBG
("h6b1 ");

458 
k
 > 
w
 + 
l
)

460 
	`DEBG1
("1 ");

461 
h
++;

462 
w
 +ğ
l
;

465 
z
 = (z = 
g
 - 
w
è> ()
l
 ?† : z;

466 ià((
f
 = 1 << (
j
 = 
k
 - 
w
)è> 
a
 + 1)

468 
	`DEBG1
("2 ");

469 
f
 -ğ
a
 + 1;

470 
xp
 = 
c
 + 
k
;

471 ià(
j
 < 
z
)

472 ++
j
 < 
z
)

474 ià((
f
 <<ğ1è<ğ*++
xp
)

476 
f
 -ğ*
xp
;

479 
	`DEBG1
("3 ");

480 
z
 = 1 << 
j
;

483 ià((
q
 = (
huá
 *)
	`m®loc
((
z
 + 1)*(huft))) ==

484 (
huá
 *)
NULL
)

486 ià(
h
)

487 
	`huá_ä“
(
u
[0]);

488 
»t
 = 3;

489 
out
;

491 
	`DEBG1
("4 ");

492 
huás
 +ğ
z
 + 1;

493 *
t
 = 
q
 + 1;

494 *(
t
 = &(
q
->
v
.t)èğ(
huá
 *)
NULL
;

495 
u
[
h
] = ++
q
;

497 
	`DEBG1
("5 ");

499 ià(
h
)

501 
x
[
h
] = 
i
;

502 
r
.
b
 = (
uch
)
l
;

503 
r
.
e
 = (
uch
)(16 + 
j
);

504 
r
.
v
.
t
 = 
q
;

505 
j
 = 
i
 >> (
w
 - 
l
);

506 
u
[
h
-1][
j
] = 
r
;

508 
	`DEBG1
("6 ");

510 
	`DEBG
("h6c ");

513 
r
.
b
 = (
uch
)(
k
 - 
w
);

514 ià(
p
 >ğ
v
 + 
n
)

515 
r
.
e
 = 99;

516 ià(*
p
 < 
s
)

518 
r
.
e
 = (
uch
)(*
p
 < 256 ? 16 : 15);

519 
r
.
v
.
n
 = (
ush
)(*
p
);

520 
p
++;

524 
r
.
e
 = (
uch
ë[*
p
 - 
s
];

525 
r
.
v
.
n
 = 
d
[*
p
++ - 
s
];

527 
	`DEBG
("h6d ");

530 
f
 = 1 << (
k
 - 
w
);

531 
j
 = 
i
 >> 
w
; j < 
z
; j +ğ
f
)

532 
q
[
j
] = 
r
;

535 
j
 = 1 << (
k
 - 1); 
i
 & j; j >>= 1)

536 
i
 ^ğ
j
;

537 
i
 ^ğ
j
;

540 (
i
 & ((1 << 
w
è- 1)è!ğ
x
[
h
])

542 
h
--;

543 
w
 -ğ
l
;

545 
	`DEBG
("h6e ");

547 
	`DEBG
("h6f ");

550 
	`DEBG
("huft7 ");

553 
»t
 = 
y
 !ğ0 && 
g
 != 1;

555 
out
:

556 
	`ä“
(
¡k
);

557  
»t
;

558 
	}
}

562 
STATIC
 
INIT
 
	$huá_ä“
(

563 
huá
 *
t


569 
huá
 *
p
, *
q
;

573 
p
 = 
t
;

574 
p
 !ğ(
huá
 *)
NULL
)

576 
q
 = (--
p
)->
v
.
t
;

577 
	`ä“
((*)
p
);

578 
p
 = 
q
;

581 
	}
}

584 
STATIC
 
INIT
 
	$šæ©e_codes
(

585 
huá
 *

,

586 
huá
 *
td
,

587 
bl
,

588 
bd


593 
e
;

594 
n
, 
d
;

595 
w
;

596 
huá
 *
t
;

597 
ml
, 
md
;

598 
ulg
 
b
;

599 
k
;

603 
b
 = 
bb
;

604 
k
 = 
bk
;

605 
w
 = 
wp
;

608 
ml
 = 
mask_b™s
[
bl
];

609 
md
 = 
mask_b™s
[
bd
];

612 
	`NEEDBITS
(()
bl
)

613 ià((
e
 = (
t
 = 

 + (()
b
 & 
ml
))->e) > 16)

615 ià(
e
 == 99)

617 
	`DUMPBITS
(
t
->
b
)

618 
e
 -= 16;

619 
	`NEEDBITS
(
e
)

620 } (
e
 = (
t
 =->
v
.ˆ+ (()
b
 & 
mask_b™s
[e]))->e) > 16);

621 
	`DUMPBITS
(
t
->
b
)

622 ià(
e
 == 16)

624 
¦ide
[
w
++] = (
uch
)
t
->
v
.
n
;

625 
	`T¿ûvv
((
¡d”r
, "%c", 
¦ide
[
w
-1]));

626 ià(
w
 =ğ
WSIZE
)

628 
	`æush_ouut
(
w
);

629 
w
 = 0;

635 ià(
e
 == 15)

639 
	`NEEDBITS
(
e
)

640 
n
 = 
t
->
v
.À+ (()
b
 & 
mask_b™s
[
e
]);

641 
	`DUMPBITS
(
e
);

644 
	`NEEDBITS
(()
bd
)

645 ià((
e
 = (
t
 = 
td
 + (()
b
 & 
md
))->e) > 16)

647 ià(
e
 == 99)

649 
	`DUMPBITS
(
t
->
b
)

650 
e
 -= 16;

651 
	`NEEDBITS
(
e
)

652 } (
e
 = (
t
 =->
v
.ˆ+ (()
b
 & 
mask_b™s
[e]))->e) > 16);

653 
	`DUMPBITS
(
t
->
b
)

654 
	`NEEDBITS
(
e
)

655 
d
 = 
w
 - 
t
->
v
.
n
 - (()
b
 & 
mask_b™s
[
e
]);

656 
	`DUMPBITS
(
e
)

657 
	`T¿ûvv
((
¡d”r
,"\\[%d,%d]", 
w
-
d
, 
n
));

661 
n
 -ğ(
e
 = (ğ
WSIZE
 - ((
d
 &ğWSIZE-1è> 
w
 ? d : w)) >‚ ?‚ :ƒ);

662 #ià!
	`defšed
(
NOMEMCPY
è&& !defšed(
DEBUG
)

663 ià(
w
 - 
d
 >ğ
e
)

665 
	`memıy
(
¦ide
 + 
w
, slid+ 
d
, 
e
);

666 
w
 +ğ
e
;

667 
d
 +ğ
e
;

672 
¦ide
[
w
++] = slide[
d
++];

673 
	`T¿ûvv
((
¡d”r
, "%c", 
¦ide
[
w
-1]));

674 } --
e
);

675 ià(
w
 =ğ
WSIZE
)

677 
	`æush_ouut
(
w
);

678 
w
 = 0;

680 } 
n
);

686 
wp
 = 
w
;

687 
bb
 = 
b
;

688 
bk
 = 
k
;

693 
und”run
:

695 
	}
}

699 
STATIC
 
INIT
 
	$šæ©e_¡Üed
()

702 
n
;

703 
w
;

704 
ulg
 
b
;

705 
k
;

707 
	`DEBG
("<stor");

710 
b
 = 
bb
;

711 
k
 = 
bk
;

712 
w
 = 
wp
;

716 
n
 = 
k
 & 7;

717 
	`DUMPBITS
(
n
);

721 
	`NEEDBITS
(16)

722 
n
 = (()
b
 & 0xffff);

723 
	`DUMPBITS
(16)

724 
	`NEEDBITS
(16)

725 ià(
n
 !ğ()((~
b
) & 0xffff))

727 
	`DUMPBITS
(16)

731 
n
--)

733 
	`NEEDBITS
(8)

734 
¦ide
[
w
++] = (
uch
)
b
;

735 ià(
w
 =ğ
WSIZE
)

737 
	`æush_ouut
(
w
);

738 
w
 = 0;

740 
	`DUMPBITS
(8)

745 
wp
 = 
w
;

746 
bb
 = 
b
;

747 
bk
 = 
k
;

749 
	`DEBG
(">");

752 
und”run
:

754 
	}
}

760 
STATIC
 
nošlše
 
INIT
 
	$šæ©e_fixed
()

765 
i
;

766 
huá
 *

;

767 
huá
 *
td
;

768 
bl
;

769 
bd
;

770 *
l
;

772 
	`DEBG
("<fix");

774 
l
 = 
	`m®loc
((*l) * 288);

775 ià(
l
 =ğ
NULL
)

779 
i
 = 0; i < 144; i++)

780 
l
[
i
] = 8;

781 ; 
i
 < 256; i++)

782 
l
[
i
] = 9;

783 ; 
i
 < 280; i++)

784 
l
[
i
] = 7;

785 ; 
i
 < 288; i++)

786 
l
[
i
] = 8;

787 
bl
 = 7;

788 ià((
i
 = 
	`huá_bud
(
l
, 288, 257, 
ıËns
, 
ıËxt
, &

, &
bl
)) != 0) {

789 
	`ä“
(
l
);

790  
i
;

794 
i
 = 0; i < 30; i++)

795 
l
[
i
] = 5;

796 
bd
 = 5;

797 ià((
i
 = 
	`huá_bud
(
l
, 30, 0, 
ıdi¡
, 
ıdext
, &
td
, &
bd
)) > 1)

799 
	`huá_ä“
(

);

800 
	`ä“
(
l
);

802 
	`DEBG
(">");

803  
i
;

808 ià(
	`šæ©e_codes
(

, 
td
, 
bl
, 
bd
)) {

809 
	`ä“
(
l
);

814 
	`ä“
(
l
);

815 
	`huá_ä“
(

);

816 
	`huá_ä“
(
td
);

818 
	}
}

824 
STATIC
 
nošlše
 
INIT
 
	$šæ©e_dyÇmic
()

827 
i
;

828 
j
;

829 
l
;

830 
m
;

831 
n
;

832 
huá
 *

;

833 
huá
 *
td
;

834 
bl
;

835 
bd
;

836 
nb
;

837 
Æ
;

838 
nd
;

839 *
Î
;

840 
ulg
 
b
;

841 
k
;

842 
»t
;

844 
	`DEBG
("<dyn");

846 #ifdeà
PKZIP_BUG_WORKAROUND


847 
Î
 = 
	`m®loc
((*ll) * (288+32));

849 
Î
 = 
	`m®loc
((*ll) * (286+30));

852 ià(
Î
 =ğ
NULL
)

856 
b
 = 
bb
;

857 
k
 = 
bk
;

861 
	`NEEDBITS
(5)

862 
Æ
 = 257 + (()
b
 & 0x1f);

863 
	`DUMPBITS
(5)

864 
	`NEEDBITS
(5)

865 
nd
 = 1 + (()
b
 & 0x1f);

866 
	`DUMPBITS
(5)

867 
	`NEEDBITS
(4)

868 
nb
 = 4 + (()
b
 & 0xf);

869 
	`DUMPBITS
(4)

870 #ifdeà
PKZIP_BUG_WORKAROUND


871 ià(
Æ
 > 288 || 
nd
 > 32)

873 ià(
Æ
 > 286 || 
nd
 > 30)

876 
»t
 = 1;

877 
out
;

880 
	`DEBG
("dyn1 ");

883 
j
 = 0; j < 
nb
; j++)

885 
	`NEEDBITS
(3)

886 
Î
[
bÜd”
[
j
]] = ()
b
 & 7;

887 
	`DUMPBITS
(3)

889 ; 
j
 < 19; j++)

890 
Î
[
bÜd”
[
j
]] = 0;

892 
	`DEBG
("dyn2 ");

895 
bl
 = 7;

896 ià((
i
 = 
	`huá_bud
(
Î
, 19, 19, 
NULL
, NULL, &

, &
bl
)) != 0)

898 ià(
i
 == 1)

899 
	`huá_ä“
(

);

900 
»t
 = 
i
;

901 
out
;

904 
	`DEBG
("dyn3 ");

907 
n
 = 
Æ
 + 
nd
;

908 
m
 = 
mask_b™s
[
bl
];

909 
i
 = 
l
 = 0;

910 ()
i
 < 
n
)

912 
	`NEEDBITS
(()
bl
)

913 
j
 = (
td
 = 

 + (()
b
 & 
m
))->b;

914 
	`DUMPBITS
(
j
)

915 
j
 = 
td
->
v
.
n
;

916 ià(
j
 < 16)

917 
Î
[
i
++] = 
l
 = 
j
;

918 ià(
j
 == 16)

920 
	`NEEDBITS
(2)

921 
j
 = 3 + (()
b
 & 3);

922 
	`DUMPBITS
(2)

923 ià(()
i
 + 
j
 > 
n
) {

924 
»t
 = 1;

925 
out
;

927 
j
--)

928 
Î
[
i
++] = 
l
;

930 ià(
j
 == 17)

932 
	`NEEDBITS
(3)

933 
j
 = 3 + (()
b
 & 7);

934 
	`DUMPBITS
(3)

935 ià(()
i
 + 
j
 > 
n
) {

936 
»t
 = 1;

937 
out
;

939 
j
--)

940 
Î
[
i
++] = 0;

941 
l
 = 0;

945 
	`NEEDBITS
(7)

946 
j
 = 11 + (()
b
 & 0x7f);

947 
	`DUMPBITS
(7)

948 ià(()
i
 + 
j
 > 
n
) {

949 
»t
 = 1;

950 
out
;

952 
j
--)

953 
Î
[
i
++] = 0;

954 
l
 = 0;

958 
	`DEBG
("dyn4 ");

961 
	`huá_ä“
(

);

963 
	`DEBG
("dyn5 ");

966 
bb
 = 
b
;

967 
bk
 = 
k
;

969 
	`DEBG
("dyn5a ");

972 
bl
 = 
lb™s
;

973 ià((
i
 = 
	`huá_bud
(
Î
, 
Æ
, 257, 
ıËns
, 
ıËxt
, &

, &
bl
)) != 0)

975 
	`DEBG
("dyn5b ");

976 ià(
i
 == 1) {

977 
	`”rÜ
("incomplete†iteralree");

978 
	`huá_ä“
(

);

980 
»t
 = 
i
;

981 
out
;

983 
	`DEBG
("dyn5c ");

984 
bd
 = 
db™s
;

985 ià((
i
 = 
	`huá_bud
(
Î
 + 
Æ
, 
nd
, 0, 
ıdi¡
, 
ıdext
, &
td
, &
bd
)) != 0)

987 
	`DEBG
("dyn5d ");

988 ià(
i
 == 1) {

989 
	`”rÜ
("incomplete distanceree");

990 #ifdeà
PKZIP_BUG_WORKAROUND


991 
i
 = 0;

994 
	`huá_ä“
(
td
);

996 
	`huá_ä“
(

);

997 
»t
 = 
i
;

998 
out
;

1002 
	`DEBG
("dyn6 ");

1005 ià(
	`šæ©e_codes
(

, 
td
, 
bl
, 
bd
)) {

1006 
»t
 = 1;

1007 
out
;

1010 
	`DEBG
("dyn7 ");

1013 
	`huá_ä“
(

);

1014 
	`huá_ä“
(
td
);

1016 
	`DEBG
(">");

1017 
»t
 = 0;

1018 
out
:

1019 
	`ä“
(
Î
);

1020  
»t
;

1022 
und”run
:

1023 
»t
 = 4;

1024 
out
;

1025 
	}
}

1029 
STATIC
 
INIT
 
	$šæ©e_block
(

1030 *
e


1034 
t
;

1035 
ulg
 
b
;

1036 
k
;

1038 
	`DEBG
("<blk");

1041 
b
 = 
bb
;

1042 
k
 = 
bk
;

1046 
	`NEEDBITS
(1)

1047 *
e
 = ()
b
 & 1;

1048 
	`DUMPBITS
(1)

1052 
	`NEEDBITS
(2)

1053 
t
 = ()
b
 & 3;

1054 
	`DUMPBITS
(2)

1058 
bb
 = 
b
;

1059 
bk
 = 
k
;

1062 ià(
t
 == 2)

1063  
	`šæ©e_dyÇmic
();

1064 ià(
t
 == 0)

1065  
	`šæ©e_¡Üed
();

1066 ià(
t
 == 1)

1067  
	`šæ©e_fixed
();

1069 
	`DEBG
(">");

1074 
und”run
:

1076 
	}
}

1080 
STATIC
 
INIT
 
	$šæ©e
()

1083 
e
;

1084 
r
;

1085 
h
;

1088 
wp
 = 0;

1089 
bk
 = 0;

1090 
bb
 = 0;

1094 
h
 = 0;

1096 
huás
 = 0;

1097 #ifdeà
ARCH_HAS_DECOMP_WDOG


1098 
	`¬ch_decomp_wdog
();

1100 
r
 = 
	`šæ©e_block
(&
e
);

1101 ià(
r
)

1102  
r
;

1103 ià(
huás
 > 
h
)

1104 
h
 = 
huás
;

1105 } !
e
);

1110 
bk
 >= 8) {

1111 
bk
 -= 8;

1112 
š±r
--;

1116 
	`æush_ouut
(
wp
);

1120 #ifdeà
DEBUG


1121 
	`årštf
(
¡d”r
, "<%u> ", 
h
);

1124 
	}
}

1132 
ulg
 
	güc_32_b
[256];

1133 
ulg
 
	güc
;

1134 
	#CRC_VALUE
 (
üc
 ^ 0xffffffffUL)

	)

1141 
INIT


1142 
	$makeüc
()

1146 
c
;

1147 
e
;

1148 
i
;

1149 
k
;

1152 cÚ¡ 
p
[] = {0,1,2,4,5,7,8,10,11,12,16,22,23,26};

1155 
e
 = 0;

1156 
i
 = 0; i < (
p
)/(); i++)

1157 
e
 |ğ1L << (31 - 
p
[
i
]);

1159 
üc_32_b
[0] = 0;

1161 
i
 = 1; i < 256; i++)

1163 
c
 = 0;

1164 
k
 = 
i
 | 256; k != 1; k >>= 1)

1166 
c
 = c & 1 ? (ø>> 1è^ 
e
 : c >> 1;

1167 ià(
k
 & 1)

1168 
c
 ^ğ
e
;

1170 
üc_32_b
[
i
] = 
c
;

1174 
üc
 = (
ulg
)0xffffffffUL;

1175 
	}
}

1178 
	#ASCII_FLAG
 0x01

	)

1179 
	#CONTINUATION
 0x02

	)

1180 
	#EXTRA_FIELD
 0x04

	)

1181 
	#ORIG_NAME
 0x08

	)

1182 
	#COMMENT
 0x10

	)

1183 
	#ENCRYPTED
 0x20

	)

1184 
	#RESERVED
 0xC0

	)

1189 
INIT
 
	$gunz
()

1191 
uch
 
æags
;

1192 
magic
[2];

1193 
m‘hod
;

1194 
ulg
 
Üig_üc
 = 0;

1195 
ulg
 
Üig_Ën
 = 0;

1196 
»s
;

1198 
magic
[0] = 
	`NEXTBYTE
();

1199 
magic
[1] = 
	`NEXTBYTE
();

1200 
m‘hod
 = 
	`NEXTBYTE
();

1202 ià(
magic
[0] != 037 ||

1203 ((
magic
[1] != 0213) && (magic[1] != 0236))) {

1204 
	`”rÜ
("bad gzip magic‚umbers");

1209 ià(
m‘hod
 != 8) {

1210 
	`”rÜ
("internalƒrror, invalid method");

1214 
æags
 = (
uch
)
	`g‘_by‹
();

1215 ià((
æags
 & 
ENCRYPTED
) != 0) {

1216 
	`”rÜ
("Input isƒncrypted");

1219 ià((
æags
 & 
CONTINUATION
) != 0) {

1220 
	`”rÜ
("Multi…art input");

1223 ià((
æags
 & 
RESERVED
) != 0) {

1224 
	`”rÜ
("Input has invalid flags");

1227 
	`NEXTBYTE
();

1228 
	`NEXTBYTE
();

1229 
	`NEXTBYTE
();

1230 
	`NEXTBYTE
();

1232 ()
	`NEXTBYTE
();

1233 ()
	`NEXTBYTE
();

1235 ià((
æags
 & 
EXTRA_FIELD
) != 0) {

1236 
Ën
 = ()
	`NEXTBYTE
();

1237 
Ën
 |ğ(()
	`NEXTBYTE
())<<8;

1238 
Ën
--è()
	`NEXTBYTE
();

1242 ià((
æags
 & 
ORIG_NAME
) != 0) {

1244 
	`NEXTBYTE
() != 0) ;

1248 ià((
æags
 & 
COMMENT
) != 0) {

1249 
	`NEXTBYTE
() != 0) ;

1253 ià((
»s
 = 
	`šæ©e
())) {

1254 
»s
) {

1258 
	`”rÜ
("invalid compressed format (err=1)");

1261 
	`”rÜ
("invalid compressed format (err=2)");

1264 
	`”rÜ
("out of memory");

1267 
	`”rÜ
("out of input data");

1270 
	`”rÜ
("invalid compressed format (other)");

1279 
Üig_üc
 = (
ulg
è
	`NEXTBYTE
();

1280 
Üig_üc
 |ğ(
ulg
è
	`NEXTBYTE
() << 8;

1281 
Üig_üc
 |ğ(
ulg
è
	`NEXTBYTE
() << 16;

1282 
Üig_üc
 |ğ(
ulg
è
	`NEXTBYTE
() << 24;

1284 
Üig_Ën
 = (
ulg
è
	`NEXTBYTE
();

1285 
Üig_Ën
 |ğ(
ulg
è
	`NEXTBYTE
() << 8;

1286 
Üig_Ën
 |ğ(
ulg
è
	`NEXTBYTE
() << 16;

1287 
Üig_Ën
 |ğ(
ulg
è
	`NEXTBYTE
() << 24;

1290 ià(
Üig_üc
 !ğ
CRC_VALUE
) {

1291 
	`”rÜ
("crcƒrror");

1294 ià(
Üig_Ën
 !ğ
by‹s_out
) {

1295 
	`”rÜ
("lengthƒrror");

1300 
und”run
:

1301 
	`”rÜ
("out of input data");

1303 
	}
}

	@/usr/include/asm/debugreg.h

1 #iâdeà
_ASM_X86_DEBUGREG_H


2 
	#_ASM_X86_DEBUGREG_H


	)

7 
	#DR_FIRSTADDR
 0

	)

8 
	#DR_LASTADDR
 3

	)

10 
	#DR_STATUS
 6

	)

11 
	#DR_CONTROL
 7

	)

17 
	#DR_TRAP0
 (0x1è

	)

18 
	#DR_TRAP1
 (0x2è

	)

19 
	#DR_TRAP2
 (0x4è

	)

20 
	#DR_TRAP3
 (0x8è

	)

22 
	#DR_STEP
 (0x4000è

	)

23 
	#DR_SWITCH
 (0x8000è

	)

31 
	#DR_CONTROL_SHIFT
 16

	)

32 
	#DR_CONTROL_SIZE
 4

	)

34 
	#DR_RW_EXECUTE
 (0x0è

	)

35 
	#DR_RW_WRITE
 (0x1)

	)

36 
	#DR_RW_READ
 (0x3)

	)

38 
	#DR_LEN_1
 (0x0è

	)

39 
	#DR_LEN_2
 (0x4)

	)

40 
	#DR_LEN_4
 (0xC)

	)

41 
	#DR_LEN_8
 (0x8)

	)

50 
	#DR_LOCAL_ENABLE_SHIFT
 0

	)

51 
	#DR_GLOBAL_ENABLE_SHIFT
 1

	)

52 
	#DR_ENABLE_SIZE
 2

	)

54 
	#DR_LOCAL_ENABLE_MASK
 (0x55è

	)

55 
	#DR_GLOBAL_ENABLE_MASK
 (0xAAè

	)

61 #ifdeà
__i386__


62 
	#DR_CONTROL_RESERVED
 (0xFC00è

	)

64 
	#DR_CONTROL_RESERVED
 (0xFFFFFFFF0000FC00ULè

	)

67 
	#DR_LOCAL_SLOWDOWN
 (0x100è

	)

68 
	#DR_GLOBAL_SLOWDOWN
 (0x200è

	)

	@/usr/include/asm/e820.h

1 #iâdeà
_ASM_X86_E820_H


2 
	#_ASM_X86_E820_H


	)

3 
	#E820MAP
 0x2d0

	)

4 
	#E820MAX
 128

	)

29 
	#E820_X_MAX
 
E820MAX


	)

31 
	#E820NR
 0x1e8

	)

33 
	#E820_RAM
 1

	)

34 
	#E820_RESERVED
 2

	)

35 
	#E820_ACPI
 3

	)

36 
	#E820_NVS
 4

	)

37 
	#E820_UNUSABLE
 5

	)

45 
	#E820_RESERVED_KERN
 128

	)

47 #iâdeà
__ASSEMBLY__


48 
	~<lšux/ty³s.h
>

49 
	se820’Œy
 {

50 
__u64
 
	maddr
;

51 
__u64
 
	msize
;

52 
__u32
 
	mty³
;

53 } 
__©Œibu‹__
((
·cked
));

55 
	se820m­
 {

56 
__u32
 
	mÄ_m­
;

57 
e820’Œy
 
	mm­
[
E820_X_MAX
];

60 
	#ISA_START_ADDRESS
 0xa0000

	)

61 
	#ISA_END_ADDRESS
 0x100000

	)

63 
	#BIOS_BEGIN
 0x000a0000

	)

64 
	#BIOS_END
 0x00100000

	)

	@/usr/include/asm/ldt.h

6 #iâdeà
_ASM_X86_LDT_H


7 
	#_ASM_X86_LDT_H


	)

10 
	#LDT_ENTRIES
 8192

	)

12 
	#LDT_ENTRY_SIZE
 8

	)

14 #iâdeà
__ASSEMBLY__


20 
	su£r_desc
 {

21 
	m’Œy_numb”
;

22 
	mba£_addr
;

23 
	mlim™
;

24 
	m£g_32b™
:1;

25 
	mcÚ‹Ás
:2;

26 
	m»ad_exec_Úly
:1;

27 
	mlim™_š_·ges
:1;

28 
	m£g_nÙ_´e£Á
:1;

29 
	mu£abË
:1;

30 #ifdeà
__x86_64__


31 
	mlm
:1;

35 
	#MODIFY_LDT_CONTENTS_DATA
 0

	)

36 
	#MODIFY_LDT_CONTENTS_STACK
 1

	)

37 
	#MODIFY_LDT_CONTENTS_CODE
 2

	)

	@/usr/include/asm/mce.h

1 #iâdeà
_ASM_X86_MCE_H


2 
	#_ASM_X86_MCE_H


	)

4 
	~<lšux/ty³s.h
>

5 
	~<asm/ioùls.h
>

11 
	#MCG_BANKCNT_MASK
 0xfà

	)

12 
	#MCG_CTL_P
 (1ULL<<8è

	)

13 
	#MCG_EXT_P
 (1ULL<<9è

	)

14 
	#MCG_CMCI_P
 (1ULL<<10è

	)

15 
	#MCG_EXT_CNT_MASK
 0xff0000

	)

16 
	#MCG_EXT_CNT_SHIFT
 16

	)

17 
	#MCG_EXT_CNT
(
c
è(((cè& 
MCG_EXT_CNT_MASK
è>> 
MCG_EXT_CNT_SHIFT
)

	)

18 
	#MCG_SER_P
 (1ULL<<24è

	)

20 
	#MCG_STATUS_RIPV
 (1ULL<<0è

	)

21 
	#MCG_STATUS_EIPV
 (1ULL<<1è

	)

22 
	#MCG_STATUS_MCIP
 (1ULL<<2è

	)

24 
	#MCI_STATUS_VAL
 (1ULL<<63è

	)

25 
	#MCI_STATUS_OVER
 (1ULL<<62è

	)

26 
	#MCI_STATUS_UC
 (1ULL<<61è

	)

27 
	#MCI_STATUS_EN
 (1ULL<<60è

	)

28 
	#MCI_STATUS_MISCV
 (1ULL<<59è

	)

29 
	#MCI_STATUS_ADDRV
 (1ULL<<58è

	)

30 
	#MCI_STATUS_PCC
 (1ULL<<57è

	)

31 
	#MCI_STATUS_S
 (1ULL<<56è

	)

32 
	#MCI_STATUS_AR
 (1ULL<<55è

	)

35 
	#MCM_ADDR_SEGOFF
 0

	)

36 
	#MCM_ADDR_LINEAR
 1

	)

37 
	#MCM_ADDR_PHYS
 2

	)

38 
	#MCM_ADDR_MEM
 3

	)

39 
	#MCM_ADDR_GENERIC
 7

	)

42 
	#MCI_CTL2_CMCI_EN
 (1ULL << 30)

	)

43 
	#MCI_CTL2_CMCI_THRESHOLD_MASK
 0x7fffULL

	)

45 
	#MCJ_CTX_MASK
 3

	)

46 
	#MCJ_CTX
(
æags
è((æagsè& 
MCJ_CTX_MASK
)

	)

47 
	#MCJ_CTX_RANDOM
 0

	)

48 
	#MCJ_CTX_PROCESS
 1

	)

49 
	#MCJ_CTX_IRQ
 2

	)

50 
	#MCJ_NMI_BROADCAST
 4

	)

51 
	#MCJ_EXCEPTION
 8

	)

54 
	smû
 {

55 
__u64
 
	m¡©us
;

56 
__u64
 
	mmisc
;

57 
__u64
 
	maddr
;

58 
__u64
 
	mmcg¡©us
;

59 
__u64
 
	m
;

60 
__u64
 
	mtsc
;

61 
__u64
 
	mtime
;

62 
__u8
 
	mıuv’dÜ
;

63 
__u8
 
	mšjeù_æags
;

64 
__u16
 
	m·d
;

65 
__u32
 
	mıuid
;

66 
__u8
 
	mcs
;

67 
__u8
 
	mbªk
;

68 
__u8
 
	mıu
;

69 
__u8
 
	mfšished
;

70 
__u32
 
	mextıu
;

71 
__u32
 
	msock‘id
;

72 
__u32
 
	m­icid
;

73 
__u64
 
	mmcgÿp
;

83 
	#MCE_LOG_LEN
 32

	)

85 
	smû_log
 {

86 
	msigÇtu»
[12];

87 
	mËn
;

88 
	mÃxt
;

89 
	mæags
;

90 
	m»cÜdËn
;

91 
mû
 
	m’Œy
[
MCE_LOG_LEN
];

94 
	#MCE_OVERFLOW
 0

	)

96 
	#MCE_LOG_SIGNATURE
 "MACHINECHECK"

	)

98 
	#MCE_GET_RECORD_LEN
 
	`_IOR
('M', 1, )

	)

99 
	#MCE_GET_LOG_LEN
 
	`_IOR
('M', 2, )

	)

100 
	#MCE_GETCLEAR_FLAGS
 
	`_IOR
('M', 3, )

	)

103 
	#MCE_EXTENDED_BANK
 128

	)

104 
	#MCE_THERMAL_BANK
 
MCE_EXTENDED_BANK
 + 0

	)

106 
	#K8_MCE_THRESHOLD_BASE
 (
MCE_EXTENDED_BANK
 + 1è

	)

107 
	#K8_MCE_THRESHOLD_BANK_0
 (
MCE_THRESHOLD_BASE
 + 0 * 9)

	)

108 
	#K8_MCE_THRESHOLD_BANK_1
 (
MCE_THRESHOLD_BASE
 + 1 * 9)

	)

109 
	#K8_MCE_THRESHOLD_BANK_2
 (
MCE_THRESHOLD_BASE
 + 2 * 9)

	)

110 
	#K8_MCE_THRESHOLD_BANK_3
 (
MCE_THRESHOLD_BASE
 + 3 * 9)

	)

111 
	#K8_MCE_THRESHOLD_BANK_4
 (
MCE_THRESHOLD_BASE
 + 4 * 9)

	)

112 
	#K8_MCE_THRESHOLD_BANK_5
 (
MCE_THRESHOLD_BASE
 + 5 * 9)

	)

113 
	#K8_MCE_THRESHOLD_DRAM_ECC
 (
MCE_THRESHOLD_BANK_4
 + 0)

	)

	@/usr/include/asm/msr-index.h

1 #iâdeà
_ASM_X86_MSR_INDEX_H


2 
	#_ASM_X86_MSR_INDEX_H


	)

7 
	#MSR_EFER
 0xc0000080

	)

8 
	#MSR_STAR
 0xc0000081

	)

9 
	#MSR_LSTAR
 0xc0000082

	)

10 
	#MSR_CSTAR
 0xc0000083

	)

11 
	#MSR_SYSCALL_MASK
 0xc0000084

	)

12 
	#MSR_FS_BASE
 0xc0000100

	)

13 
	#MSR_GS_BASE
 0xc0000101

	)

14 
	#MSR_KERNEL_GS_BASE
 0xc0000102

	)

15 
	#MSR_TSC_AUX
 0xc0000103

	)

18 
	#_EFER_SCE
 0

	)

19 
	#_EFER_LME
 8

	)

20 
	#_EFER_LMA
 10

	)

21 
	#_EFER_NX
 11

	)

22 
	#_EFER_SVME
 12

	)

23 
	#_EFER_FFXSR
 14

	)

25 
	#EFER_SCE
 (1<<
_EFER_SCE
)

	)

26 
	#EFER_LME
 (1<<
_EFER_LME
)

	)

27 
	#EFER_LMA
 (1<<
_EFER_LMA
)

	)

28 
	#EFER_NX
 (1<<
_EFER_NX
)

	)

29 
	#EFER_SVME
 (1<<
_EFER_SVME
)

	)

30 
	#EFER_FFXSR
 (1<<
_EFER_FFXSR
)

	)

33 
	#MSR_IA32_PERFCTR0
 0x000000c1

	)

34 
	#MSR_IA32_PERFCTR1
 0x000000c2

	)

35 
	#MSR_FSB_FREQ
 0x000000cd

	)

37 
	#MSR_NHM_SNB_PKG_CST_CFG_CTL
 0x000000e2

	)

38 
	#NHM_C3_AUTO_DEMOTE
 (1UL << 25)

	)

39 
	#NHM_C1_AUTO_DEMOTE
 (1UL << 26)

	)

41 
	#MSR_MTRRÿp
 0x000000ã

	)

42 
	#MSR_IA32_BBL_CR_CTL
 0x00000119

	)

43 
	#MSR_IA32_BBL_CR_CTL3
 0x0000011e

	)

45 
	#MSR_IA32_SYSENTER_CS
 0x00000174

	)

46 
	#MSR_IA32_SYSENTER_ESP
 0x00000175

	)

47 
	#MSR_IA32_SYSENTER_EIP
 0x00000176

	)

49 
	#MSR_IA32_MCG_CAP
 0x00000179

	)

50 
	#MSR_IA32_MCG_STATUS
 0x0000017a

	)

51 
	#MSR_IA32_MCG_CTL
 0x0000017b

	)

53 
	#MSR_OFFCORE_RSP_0
 0x000001a6

	)

54 
	#MSR_OFFCORE_RSP_1
 0x000001a7

	)

56 
	#MSR_IA32_PEBS_ENABLE
 0x000003f1

	)

57 
	#MSR_IA32_DS_AREA
 0x00000600

	)

58 
	#MSR_IA32_PERF_CAPABILITIES
 0x00000345

	)

60 
	#MSR_MTRRfix64K_00000
 0x00000250

	)

61 
	#MSR_MTRRfix16K_80000
 0x00000258

	)

62 
	#MSR_MTRRfix16K_A0000
 0x00000259

	)

63 
	#MSR_MTRRfix4K_C0000
 0x00000268

	)

64 
	#MSR_MTRRfix4K_C8000
 0x00000269

	)

65 
	#MSR_MTRRfix4K_D0000
 0x0000026a

	)

66 
	#MSR_MTRRfix4K_D8000
 0x0000026b

	)

67 
	#MSR_MTRRfix4K_E0000
 0x0000026c

	)

68 
	#MSR_MTRRfix4K_E8000
 0x0000026d

	)

69 
	#MSR_MTRRfix4K_F0000
 0x0000026e

	)

70 
	#MSR_MTRRfix4K_F8000
 0x0000026f

	)

71 
	#MSR_MTRRdefTy³
 0x000002ff

	)

73 
	#MSR_IA32_CR_PAT
 0x00000277

	)

75 
	#MSR_IA32_DEBUGCTLMSR
 0x000001d9

	)

76 
	#MSR_IA32_LASTBRANCHFROMIP
 0x000001db

	)

77 
	#MSR_IA32_LASTBRANCHTOIP
 0x000001dc

	)

78 
	#MSR_IA32_LASTINTFROMIP
 0x000001dd

	)

79 
	#MSR_IA32_LASTINTTOIP
 0x000001de

	)

82 
	#DEBUGCTLMSR_LBR
 (1UL << 0è

	)

83 
	#DEBUGCTLMSR_BTF
 (1UL << 1è

	)

84 
	#DEBUGCTLMSR_TR
 (1UL << 6)

	)

85 
	#DEBUGCTLMSR_BTS
 (1UL << 7)

	)

86 
	#DEBUGCTLMSR_BTINT
 (1UL << 8)

	)

87 
	#DEBUGCTLMSR_BTS_OFF_OS
 (1UL << 9)

	)

88 
	#DEBUGCTLMSR_BTS_OFF_USR
 (1UL << 10)

	)

89 
	#DEBUGCTLMSR_FREEZE_LBRS_ON_PMI
 (1UL << 11)

	)

91 
	#MSR_IA32_MC0_CTL
 0x00000400

	)

92 
	#MSR_IA32_MC0_STATUS
 0x00000401

	)

93 
	#MSR_IA32_MC0_ADDR
 0x00000402

	)

94 
	#MSR_IA32_MC0_MISC
 0x00000403

	)

96 
	#MSR_AMD64_MC0_MASK
 0xc0010044

	)

98 
	#MSR_IA32_MCx_CTL
(
x
è(
MSR_IA32_MC0_CTL
 + 4*(x))

	)

99 
	#MSR_IA32_MCx_STATUS
(
x
è(
MSR_IA32_MC0_STATUS
 + 4*(x))

	)

100 
	#MSR_IA32_MCx_ADDR
(
x
è(
MSR_IA32_MC0_ADDR
 + 4*(x))

	)

101 
	#MSR_IA32_MCx_MISC
(
x
è(
MSR_IA32_MC0_MISC
 + 4*(x))

	)

103 
	#MSR_AMD64_MCx_MASK
(
x
è(
MSR_AMD64_MC0_MASK
 + (x))

	)

106 
	#MSR_IA32_MC0_CTL2
 0x00000280

	)

107 
	#MSR_IA32_MCx_CTL2
(
x
è(
MSR_IA32_MC0_CTL2
 + (x))

	)

109 
	#MSR_P6_PERFCTR0
 0x000000c1

	)

110 
	#MSR_P6_PERFCTR1
 0x000000c2

	)

111 
	#MSR_P6_EVNTSEL0
 0x00000186

	)

112 
	#MSR_P6_EVNTSEL1
 0x00000187

	)

117 
	#MSR_AMD64_PATCH_LEVEL
 0x0000008b

	)

118 
	#MSR_AMD64_NB_CFG
 0xc001001f

	)

119 
	#MSR_AMD64_PATCH_LOADER
 0xc0010020

	)

120 
	#MSR_AMD64_DC_CFG
 0xc0011022

	)

121 
	#MSR_AMD64_OSVW_ID_LENGTH
 0xc0010140

	)

122 
	#MSR_AMD64_OSVW_STATUS
 0xc0010141

	)

123 
	#MSR_AMD64_IBSFETCHCTL
 0xc0011030

	)

124 
	#MSR_AMD64_IBSFETCHLINAD
 0xc0011031

	)

125 
	#MSR_AMD64_IBSFETCHPHYSAD
 0xc0011032

	)

126 
	#MSR_AMD64_IBSOPCTL
 0xc0011033

	)

127 
	#MSR_AMD64_IBSOPRIP
 0xc0011034

	)

128 
	#MSR_AMD64_IBSOPDATA
 0xc0011035

	)

129 
	#MSR_AMD64_IBSOPDATA2
 0xc0011036

	)

130 
	#MSR_AMD64_IBSOPDATA3
 0xc0011037

	)

131 
	#MSR_AMD64_IBSDCLINAD
 0xc0011038

	)

132 
	#MSR_AMD64_IBSDCPHYSAD
 0xc0011039

	)

133 
	#MSR_AMD64_IBSCTL
 0xc001103a

	)

134 
	#MSR_AMD64_IBSBRTARGET
 0xc001103b

	)

137 
	#MSR_F15H_PERF_CTL
 0xc0010200

	)

138 
	#MSR_F15H_PERF_CTR
 0xc0010201

	)

141 
	#MSR_FAM10H_MMIO_CONF_BASE
 0xc0010058

	)

142 
	#FAM10H_MMIO_CONF_ENABLE
 (1<<0)

	)

143 
	#FAM10H_MMIO_CONF_BUSRANGE_MASK
 0xf

	)

144 
	#FAM10H_MMIO_CONF_BUSRANGE_SHIFT
 2

	)

145 
	#FAM10H_MMIO_CONF_BASE_MASK
 0xfffffff

	)

146 
	#FAM10H_MMIO_CONF_BASE_SHIFT
 20

	)

147 
	#MSR_FAM10H_NODE_ID
 0xc001100c

	)

150 
	#MSR_K8_TOP_MEM1
 0xc001001a

	)

151 
	#MSR_K8_TOP_MEM2
 0xc001001d

	)

152 
	#MSR_K8_SYSCFG
 0xc0010010

	)

153 
	#MSR_K8_INT_PENDING_MSG
 0xc0010055

	)

155 
	#K8_INTP_C1E_ACTIVE_MASK
 0x18000000

	)

156 
	#MSR_K8_TSEG_ADDR
 0xc0010112

	)

157 
	#K8_MTRRFIXRANGE_DRAM_ENABLE
 0x00040000

	)

158 
	#K8_MTRRFIXRANGE_DRAM_MODIFY
 0x00080000

	)

159 
	#K8_MTRR_RDMEM_WRMEM_MASK
 0x18181818

	)

162 
	#MSR_K7_EVNTSEL0
 0xc0010000

	)

163 
	#MSR_K7_PERFCTR0
 0xc0010004

	)

164 
	#MSR_K7_EVNTSEL1
 0xc0010001

	)

165 
	#MSR_K7_PERFCTR1
 0xc0010005

	)

166 
	#MSR_K7_EVNTSEL2
 0xc0010002

	)

167 
	#MSR_K7_PERFCTR2
 0xc0010006

	)

168 
	#MSR_K7_EVNTSEL3
 0xc0010003

	)

169 
	#MSR_K7_PERFCTR3
 0xc0010007

	)

170 
	#MSR_K7_CLK_CTL
 0xc001001b

	)

171 
	#MSR_K7_HWCR
 0xc0010015

	)

172 
	#MSR_K7_FID_VID_CTL
 0xc0010041

	)

173 
	#MSR_K7_FID_VID_STATUS
 0xc0010042

	)

176 
	#MSR_K6_EFER
 0xc0000080

	)

177 
	#MSR_K6_STAR
 0xc0000081

	)

178 
	#MSR_K6_WHCR
 0xc0000082

	)

179 
	#MSR_K6_UWCCR
 0xc0000085

	)

180 
	#MSR_K6_EPMR
 0xc0000086

	)

181 
	#MSR_K6_PSOR
 0xc0000087

	)

182 
	#MSR_K6_PFIR
 0xc0000088

	)

185 
	#MSR_IDT_FCR1
 0x00000107

	)

186 
	#MSR_IDT_FCR2
 0x00000108

	)

187 
	#MSR_IDT_FCR3
 0x00000109

	)

188 
	#MSR_IDT_FCR4
 0x0000010a

	)

190 
	#MSR_IDT_MCR0
 0x00000110

	)

191 
	#MSR_IDT_MCR1
 0x00000111

	)

192 
	#MSR_IDT_MCR2
 0x00000112

	)

193 
	#MSR_IDT_MCR3
 0x00000113

	)

194 
	#MSR_IDT_MCR4
 0x00000114

	)

195 
	#MSR_IDT_MCR5
 0x00000115

	)

196 
	#MSR_IDT_MCR6
 0x00000116

	)

197 
	#MSR_IDT_MCR7
 0x00000117

	)

198 
	#MSR_IDT_MCR_CTRL
 0x00000120

	)

201 
	#MSR_VIA_FCR
 0x00001107

	)

202 
	#MSR_VIA_LONGHAUL
 0x0000110a

	)

203 
	#MSR_VIA_RNG
 0x0000110b

	)

204 
	#MSR_VIA_BCR2
 0x00001147

	)

207 
	#MSR_TMTA_LONGRUN_CTRL
 0x80868010

	)

208 
	#MSR_TMTA_LONGRUN_FLAGS
 0x80868011

	)

209 
	#MSR_TMTA_LRTI_READOUT
 0x80868018

	)

210 
	#MSR_TMTA_LRTI_VOLT_MHZ
 0x8086801a

	)

213 
	#MSR_IA32_P5_MC_ADDR
 0x00000000

	)

214 
	#MSR_IA32_P5_MC_TYPE
 0x00000001

	)

215 
	#MSR_IA32_TSC
 0x00000010

	)

216 
	#MSR_IA32_PLATFORM_ID
 0x00000017

	)

217 
	#MSR_IA32_EBL_CR_POWERON
 0x0000002a

	)

218 
	#MSR_EBC_FREQUENCY_ID
 0x0000002c

	)

219 
	#MSR_IA32_FEATURE_CONTROL
 0x0000003a

	)

221 
	#FEATURE_CONTROL_LOCKED
 (1<<0)

	)

222 
	#FEATURE_CONTROL_VMXON_ENABLED_INSIDE_SMX
 (1<<1)

	)

223 
	#FEATURE_CONTROL_VMXON_ENABLED_OUTSIDE_SMX
 (1<<2)

	)

225 
	#MSR_IA32_APICBASE
 0x0000001b

	)

226 
	#MSR_IA32_APICBASE_BSP
 (1<<8)

	)

227 
	#MSR_IA32_APICBASE_ENABLE
 (1<<11)

	)

228 
	#MSR_IA32_APICBASE_BASE
 (0xfffff<<12)

	)

230 
	#MSR_IA32_UCODE_WRITE
 0x00000079

	)

231 
	#MSR_IA32_UCODE_REV
 0x0000008b

	)

233 
	#MSR_IA32_PERF_STATUS
 0x00000198

	)

234 
	#MSR_IA32_PERF_CTL
 0x00000199

	)

236 
	#MSR_IA32_MPERF
 0x000000e7

	)

237 
	#MSR_IA32_APERF
 0x000000e8

	)

239 
	#MSR_IA32_THERM_CONTROL
 0x0000019a

	)

240 
	#MSR_IA32_THERM_INTERRUPT
 0x0000019b

	)

242 
	#THERM_INT_HIGH_ENABLE
 (1 << 0)

	)

243 
	#THERM_INT_LOW_ENABLE
 (1 << 1)

	)

244 
	#THERM_INT_PLN_ENABLE
 (1 << 24)

	)

246 
	#MSR_IA32_THERM_STATUS
 0x0000019c

	)

248 
	#THERM_STATUS_PROCHOT
 (1 << 0)

	)

249 
	#THERM_STATUS_POWER_LIMIT
 (1 << 10)

	)

251 
	#MSR_THERM2_CTL
 0x0000019d

	)

253 
	#MSR_THERM2_CTL_TM_SELECT
 (1ULL << 16)

	)

255 
	#MSR_IA32_MISC_ENABLE
 0x000001a0

	)

257 
	#MSR_IA32_TEMPERATURE_TARGET
 0x000001a2

	)

259 
	#MSR_IA32_ENERGY_PERF_BIAS
 0x000001b0

	)

261 
	#MSR_IA32_PACKAGE_THERM_STATUS
 0x000001b1

	)

263 
	#PACKAGE_THERM_STATUS_PROCHOT
 (1 << 0)

	)

264 
	#PACKAGE_THERM_STATUS_POWER_LIMIT
 (1 << 10)

	)

266 
	#MSR_IA32_PACKAGE_THERM_INTERRUPT
 0x000001b2

	)

268 
	#PACKAGE_THERM_INT_HIGH_ENABLE
 (1 << 0)

	)

269 
	#PACKAGE_THERM_INT_LOW_ENABLE
 (1 << 1)

	)

270 
	#PACKAGE_THERM_INT_PLN_ENABLE
 (1 << 24)

	)

273 
	#MSR_IA32_MISC_ENABLE_FAST_STRING
 (1ULL << 0)

	)

274 
	#MSR_IA32_MISC_ENABLE_TCC
 (1ULL << 1)

	)

275 
	#MSR_IA32_MISC_ENABLE_EMON
 (1ULL << 7)

	)

276 
	#MSR_IA32_MISC_ENABLE_BTS_UNAVAIL
 (1ULL << 11)

	)

277 
	#MSR_IA32_MISC_ENABLE_PEBS_UNAVAIL
 (1ULL << 12)

	)

278 
	#MSR_IA32_MISC_ENABLE_ENHANCED_SPEEDSTEP
 (1ULL << 16)

	)

279 
	#MSR_IA32_MISC_ENABLE_MWAIT
 (1ULL << 18)

	)

280 
	#MSR_IA32_MISC_ENABLE_LIMIT_CPUID
 (1ULL << 22)

	)

281 
	#MSR_IA32_MISC_ENABLE_XTPR_DISABLE
 (1ULL << 23)

	)

282 
	#MSR_IA32_MISC_ENABLE_XD_DISABLE
 (1ULL << 34)

	)

285 
	#MSR_IA32_MISC_ENABLE_X87_COMPAT
 (1ULL << 2)

	)

286 
	#MSR_IA32_MISC_ENABLE_TM1
 (1ULL << 3)

	)

287 
	#MSR_IA32_MISC_ENABLE_SPLIT_LOCK_DISABLE
 (1ULL << 4)

	)

288 
	#MSR_IA32_MISC_ENABLE_L3CACHE_DISABLE
 (1ULL << 6)

	)

289 
	#MSR_IA32_MISC_ENABLE_SUPPRESS_LOCK
 (1ULL << 8)

	)

290 
	#MSR_IA32_MISC_ENABLE_PREFETCH_DISABLE
 (1ULL << 9)

	)

291 
	#MSR_IA32_MISC_ENABLE_FERR
 (1ULL << 10)

	)

292 
	#MSR_IA32_MISC_ENABLE_FERR_MULTIPLEX
 (1ULL << 10)

	)

293 
	#MSR_IA32_MISC_ENABLE_TM2
 (1ULL << 13)

	)

294 
	#MSR_IA32_MISC_ENABLE_ADJ_PREF_DISABLE
 (1ULL << 19)

	)

295 
	#MSR_IA32_MISC_ENABLE_SPEEDSTEP_LOCK
 (1ULL << 20)

	)

296 
	#MSR_IA32_MISC_ENABLE_L1D_CONTEXT
 (1ULL << 24)

	)

297 
	#MSR_IA32_MISC_ENABLE_DCU_PREF_DISABLE
 (1ULL << 37)

	)

298 
	#MSR_IA32_MISC_ENABLE_TURBO_DISABLE
 (1ULL << 38)

	)

299 
	#MSR_IA32_MISC_ENABLE_IP_PREF_DISABLE
 (1ULL << 39)

	)

302 
	#MSR_IA32_MCG_EAX
 0x00000180

	)

303 
	#MSR_IA32_MCG_EBX
 0x00000181

	)

304 
	#MSR_IA32_MCG_ECX
 0x00000182

	)

305 
	#MSR_IA32_MCG_EDX
 0x00000183

	)

306 
	#MSR_IA32_MCG_ESI
 0x00000184

	)

307 
	#MSR_IA32_MCG_EDI
 0x00000185

	)

308 
	#MSR_IA32_MCG_EBP
 0x00000186

	)

309 
	#MSR_IA32_MCG_ESP
 0x00000187

	)

310 
	#MSR_IA32_MCG_EFLAGS
 0x00000188

	)

311 
	#MSR_IA32_MCG_EIP
 0x00000189

	)

312 
	#MSR_IA32_MCG_RESERVED
 0x0000018a

	)

315 
	#MSR_P4_BPU_PERFCTR0
 0x00000300

	)

316 
	#MSR_P4_BPU_PERFCTR1
 0x00000301

	)

317 
	#MSR_P4_BPU_PERFCTR2
 0x00000302

	)

318 
	#MSR_P4_BPU_PERFCTR3
 0x00000303

	)

319 
	#MSR_P4_MS_PERFCTR0
 0x00000304

	)

320 
	#MSR_P4_MS_PERFCTR1
 0x00000305

	)

321 
	#MSR_P4_MS_PERFCTR2
 0x00000306

	)

322 
	#MSR_P4_MS_PERFCTR3
 0x00000307

	)

323 
	#MSR_P4_FLAME_PERFCTR0
 0x00000308

	)

324 
	#MSR_P4_FLAME_PERFCTR1
 0x00000309

	)

325 
	#MSR_P4_FLAME_PERFCTR2
 0x0000030a

	)

326 
	#MSR_P4_FLAME_PERFCTR3
 0x0000030b

	)

327 
	#MSR_P4_IQ_PERFCTR0
 0x0000030c

	)

328 
	#MSR_P4_IQ_PERFCTR1
 0x0000030d

	)

329 
	#MSR_P4_IQ_PERFCTR2
 0x0000030e

	)

330 
	#MSR_P4_IQ_PERFCTR3
 0x0000030f

	)

331 
	#MSR_P4_IQ_PERFCTR4
 0x00000310

	)

332 
	#MSR_P4_IQ_PERFCTR5
 0x00000311

	)

333 
	#MSR_P4_BPU_CCCR0
 0x00000360

	)

334 
	#MSR_P4_BPU_CCCR1
 0x00000361

	)

335 
	#MSR_P4_BPU_CCCR2
 0x00000362

	)

336 
	#MSR_P4_BPU_CCCR3
 0x00000363

	)

337 
	#MSR_P4_MS_CCCR0
 0x00000364

	)

338 
	#MSR_P4_MS_CCCR1
 0x00000365

	)

339 
	#MSR_P4_MS_CCCR2
 0x00000366

	)

340 
	#MSR_P4_MS_CCCR3
 0x00000367

	)

341 
	#MSR_P4_FLAME_CCCR0
 0x00000368

	)

342 
	#MSR_P4_FLAME_CCCR1
 0x00000369

	)

343 
	#MSR_P4_FLAME_CCCR2
 0x0000036a

	)

344 
	#MSR_P4_FLAME_CCCR3
 0x0000036b

	)

345 
	#MSR_P4_IQ_CCCR0
 0x0000036c

	)

346 
	#MSR_P4_IQ_CCCR1
 0x0000036d

	)

347 
	#MSR_P4_IQ_CCCR2
 0x0000036e

	)

348 
	#MSR_P4_IQ_CCCR3
 0x0000036f

	)

349 
	#MSR_P4_IQ_CCCR4
 0x00000370

	)

350 
	#MSR_P4_IQ_CCCR5
 0x00000371

	)

351 
	#MSR_P4_ALF_ESCR0
 0x000003ÿ

	)

352 
	#MSR_P4_ALF_ESCR1
 0x000003cb

	)

353 
	#MSR_P4_BPU_ESCR0
 0x000003b2

	)

354 
	#MSR_P4_BPU_ESCR1
 0x000003b3

	)

355 
	#MSR_P4_BSU_ESCR0
 0x000003a0

	)

356 
	#MSR_P4_BSU_ESCR1
 0x000003a1

	)

357 
	#MSR_P4_CRU_ESCR0
 0x000003b8

	)

358 
	#MSR_P4_CRU_ESCR1
 0x000003b9

	)

359 
	#MSR_P4_CRU_ESCR2
 0x000003cc

	)

360 
	#MSR_P4_CRU_ESCR3
 0x000003cd

	)

361 
	#MSR_P4_CRU_ESCR4
 0x000003e0

	)

362 
	#MSR_P4_CRU_ESCR5
 0x000003e1

	)

363 
	#MSR_P4_DAC_ESCR0
 0x000003a8

	)

364 
	#MSR_P4_DAC_ESCR1
 0x000003a9

	)

365 
	#MSR_P4_FIRM_ESCR0
 0x000003a4

	)

366 
	#MSR_P4_FIRM_ESCR1
 0x000003a5

	)

367 
	#MSR_P4_FLAME_ESCR0
 0x000003a6

	)

368 
	#MSR_P4_FLAME_ESCR1
 0x000003a7

	)

369 
	#MSR_P4_FSB_ESCR0
 0x000003a2

	)

370 
	#MSR_P4_FSB_ESCR1
 0x000003a3

	)

371 
	#MSR_P4_IQ_ESCR0
 0x000003ba

	)

372 
	#MSR_P4_IQ_ESCR1
 0x000003bb

	)

373 
	#MSR_P4_IS_ESCR0
 0x000003b4

	)

374 
	#MSR_P4_IS_ESCR1
 0x000003b5

	)

375 
	#MSR_P4_ITLB_ESCR0
 0x000003b6

	)

376 
	#MSR_P4_ITLB_ESCR1
 0x000003b7

	)

377 
	#MSR_P4_IX_ESCR0
 0x000003c8

	)

378 
	#MSR_P4_IX_ESCR1
 0x000003c9

	)

379 
	#MSR_P4_MOB_ESCR0
 0x000003¯

	)

380 
	#MSR_P4_MOB_ESCR1
 0x000003ab

	)

381 
	#MSR_P4_MS_ESCR0
 0x000003c0

	)

382 
	#MSR_P4_MS_ESCR1
 0x000003c1

	)

383 
	#MSR_P4_PMH_ESCR0
 0x000003ac

	)

384 
	#MSR_P4_PMH_ESCR1
 0x000003ad

	)

385 
	#MSR_P4_RAT_ESCR0
 0x000003bc

	)

386 
	#MSR_P4_RAT_ESCR1
 0x000003bd

	)

387 
	#MSR_P4_SAAT_ESCR0
 0x000003«

	)

388 
	#MSR_P4_SAAT_ESCR1
 0x000003af

	)

389 
	#MSR_P4_SSU_ESCR0
 0x000003be

	)

390 
	#MSR_P4_SSU_ESCR1
 0x000003bà

	)

392 
	#MSR_P4_TBPU_ESCR0
 0x000003c2

	)

393 
	#MSR_P4_TBPU_ESCR1
 0x000003c3

	)

394 
	#MSR_P4_TC_ESCR0
 0x000003c4

	)

395 
	#MSR_P4_TC_ESCR1
 0x000003c5

	)

396 
	#MSR_P4_U2L_ESCR0
 0x000003b0

	)

397 
	#MSR_P4_U2L_ESCR1
 0x000003b1

	)

399 
	#MSR_P4_PEBS_MATRIX_VERT
 0x000003f2

	)

402 
	#MSR_CORE_PERF_FIXED_CTR0
 0x00000309

	)

403 
	#MSR_CORE_PERF_FIXED_CTR1
 0x0000030a

	)

404 
	#MSR_CORE_PERF_FIXED_CTR2
 0x0000030b

	)

405 
	#MSR_CORE_PERF_FIXED_CTR_CTRL
 0x0000038d

	)

406 
	#MSR_CORE_PERF_GLOBAL_STATUS
 0x0000038e

	)

407 
	#MSR_CORE_PERF_GLOBAL_CTRL
 0x0000038f

	)

408 
	#MSR_CORE_PERF_GLOBAL_OVF_CTRL
 0x00000390

	)

411 
	#MSR_GEODE_BUSCONT_CONF0
 0x00001900

	)

414 
	#MSR_IA32_VMX_BASIC
 0x00000480

	)

415 
	#MSR_IA32_VMX_PINBASED_CTLS
 0x00000481

	)

416 
	#MSR_IA32_VMX_PROCBASED_CTLS
 0x00000482

	)

417 
	#MSR_IA32_VMX_EXIT_CTLS
 0x00000483

	)

418 
	#MSR_IA32_VMX_ENTRY_CTLS
 0x00000484

	)

419 
	#MSR_IA32_VMX_MISC
 0x00000485

	)

420 
	#MSR_IA32_VMX_CR0_FIXED0
 0x00000486

	)

421 
	#MSR_IA32_VMX_CR0_FIXED1
 0x00000487

	)

422 
	#MSR_IA32_VMX_CR4_FIXED0
 0x00000488

	)

423 
	#MSR_IA32_VMX_CR4_FIXED1
 0x00000489

	)

424 
	#MSR_IA32_VMX_VMCS_ENUM
 0x0000048a

	)

425 
	#MSR_IA32_VMX_PROCBASED_CTLS2
 0x0000048b

	)

426 
	#MSR_IA32_VMX_EPT_VPID_CAP
 0x0000048c

	)

430 
	#MSR_VM_CR
 0xc0010114

	)

431 
	#MSR_VM_IGNNE
 0xc0010115

	)

432 
	#MSR_VM_HSAVE_PA
 0xc0010117

	)

	@/usr/include/asm/msr.h

1 #iâdeà
_ASM_X86_MSR_H


2 
	#_ASM_X86_MSR_H


	)

4 
	~<asm/m¤-šdex.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/ty³s.h
>

9 
	~<lšux/ioùl.h
>

11 
	#X86_IOC_RDMSR_REGS
 
	`_IOWR
('c', 0xA0, 
__u32
[8])

	)

12 
	#X86_IOC_WRMSR_REGS
 
	`_IOWR
('c', 0xA1, 
__u32
[8])

	)

	@/usr/include/asm/mtrr.h

23 #iâdeà
_ASM_X86_MTRR_H


24 
	#_ASM_X86_MTRR_H


	)

26 
	~<lšux/ty³s.h
>

27 
	~<lšux/ioùl.h
>

28 
	~<lšux/”ºo.h
>

30 
	#MTRR_IOCTL_BASE
 'M'

	)

32 
	smŒr_£Áry
 {

33 
	mba£
;

34 
	msize
;

35 
	mty³
;

43 #ifdeà
__i386__


44 
	smŒr_g’Œy
 {

45 
	m»gnum
;

46 
	mba£
;

47 
	msize
;

48 
	mty³
;

53 
	smŒr_g’Œy
 {

54 
	mba£
;

55 
	msize
;

56 
	m»gnum
;

57 
	mty³
;

61 
	smŒr_v¬_¿nge
 {

62 
__u32
 
	mba£_lo
;

63 
__u32
 
	mba£_hi
;

64 
__u32
 
	mmask_lo
;

65 
__u32
 
	mmask_hi
;

70 
__u8
 
	tmŒr_ty³
;

72 
	#MTRR_NUM_FIXED_RANGES
 88

	)

73 
	#MTRR_MAX_VAR_RANGES
 256

	)

75 
	smŒr_¡©e_ty³
 {

76 
mŒr_v¬_¿nge
 
	mv¬_¿nges
[
MTRR_MAX_VAR_RANGES
];

77 
mŒr_ty³
 
	mfixed_¿nges
[
MTRR_NUM_FIXED_RANGES
];

78 
	m’abËd
;

79 
	mhave_fixed
;

80 
mŒr_ty³
 
	mdef_ty³
;

83 
	#MTRRphysBa£_MSR
(
»g
è(0x200 + 2 * (»g))

	)

84 
	#MTRRphysMask_MSR
(
»g
è(0x200 + 2 * (»gè+ 1)

	)

87 
	#MTRRIOC_ADD_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 0, 
mŒr_£Áry
)

	)

88 
	#MTRRIOC_SET_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 1, 
mŒr_£Áry
)

	)

89 
	#MTRRIOC_DEL_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 2, 
mŒr_£Áry
)

	)

90 
	#MTRRIOC_GET_ENTRY
 
	`_IOWR
(
MTRR_IOCTL_BASE
, 3, 
mŒr_g’Œy
)

	)

91 
	#MTRRIOC_KILL_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 4, 
mŒr_£Áry
)

	)

92 
	#MTRRIOC_ADD_PAGE_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 5, 
mŒr_£Áry
)

	)

93 
	#MTRRIOC_SET_PAGE_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 6, 
mŒr_£Áry
)

	)

94 
	#MTRRIOC_DEL_PAGE_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 7, 
mŒr_£Áry
)

	)

95 
	#MTRRIOC_GET_PAGE_ENTRY
 
	`_IOWR
(
MTRR_IOCTL_BASE
, 8, 
mŒr_g’Œy
)

	)

96 
	#MTRRIOC_KILL_PAGE_ENTRY
 
	`_IOW
(
MTRR_IOCTL_BASE
, 9, 
mŒr_£Áry
)

	)

99 
	#MTRR_TYPE_UNCACHABLE
 0

	)

100 
	#MTRR_TYPE_WRCOMB
 1

	)

103 
	#MTRR_TYPE_WRTHROUGH
 4

	)

104 
	#MTRR_TYPE_WRPROT
 5

	)

105 
	#MTRR_TYPE_WRBACK
 6

	)

106 
	#MTRR_NUM_TYPES
 7

	)

	@/usr/include/asm/setup.h

1 #iâdeà
_ASM_X86_SETUP_H


2 
	#_ASM_X86_SETUP_H


	)

	@/usr/include/asm/types.h

1 #iâdeà
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	#dma_addr_t
 
dma_addr_t


	)

6 
	~<asm-g’”ic/ty³s.h
>

	@/usr/include/errno.h

23 #iâdef 
_ERRNO_H


27 #iâdef 
__Ãed_Em©h


28 
	#_ERRNO_H
 1

	)

29 
	~<ã©u»s.h
>

32 
	g__BEGIN_DECLS


36 
	~<b™s/”ºo.h
>

37 #undeà
__Ãed_Em©h


39 #ifdef 
_ERRNO_H


46 #iâdef 
”ºo


47 
”ºo
;

50 #ifdeà
__USE_GNU


55 *
´og¿m_švoÿtiÚ_Çme
, *
´og¿m_švoÿtiÚ_shÜt_Çme
;

59 
	g__END_DECLS


67 #ià
defšed
 
__USE_GNU
 || defšed 
__Ãed_”rÜ_t


68 #iâdeà
__”rÜ_t_defšed


69 
	t”rÜ_t
;

70 
	#__”rÜ_t_defšed
 1

	)

72 #undeà
__Ãed_”rÜ_t


	@/usr/include/fcntl.h

24 #iâdef 
_FCNTL_H


25 
	#_FCNTL_H
 1

	)

27 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 
	~<b™s/fú.h
>

37 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


38 
	~<b™s/ty³s.h
>

39 
	#__Ãed_time¥ec


	)

40 
	~<time.h
>

41 
	~<b™s/¡©.h
>

43 
	#S_IFMT
 
__S_IFMT


	)

44 
	#S_IFDIR
 
__S_IFDIR


	)

45 
	#S_IFCHR
 
__S_IFCHR


	)

46 
	#S_IFBLK
 
__S_IFBLK


	)

47 
	#S_IFREG
 
__S_IFREG


	)

48 #ifdeà
__S_IFIFO


49 
	#S_IFIFO
 
__S_IFIFO


	)

51 #ifdeà
__S_IFLNK


52 
	#S_IFLNK
 
__S_IFLNK


	)

54 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


55 
	#S_IFSOCK
 
__S_IFSOCK


	)

60 
	#S_ISUID
 
__S_ISUID


	)

61 
	#S_ISGID
 
__S_ISGID


	)

63 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


65 
	#S_ISVTX
 
__S_ISVTX


	)

68 
	#S_IRUSR
 
__S_IREAD


	)

69 
	#S_IWUSR
 
__S_IWRITE


	)

70 
	#S_IXUSR
 
__S_IEXEC


	)

72 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

74 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

75 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

76 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

78 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

80 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

81 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

82 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

84 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

87 #ifdef 
__USE_MISC


88 #iâdeà
R_OK


91 
	#R_OK
 4

	)

92 
	#W_OK
 2

	)

93 
	#X_OK
 1

	)

94 
	#F_OK
 0

	)

99 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


100 
	#SEEK_SET
 0

	)

101 
	#SEEK_CUR
 1

	)

102 
	#SEEK_END
 2

	)

105 #ifdeà
__USE_ATFILE


106 
	#AT_FDCWD
 -100

	)

109 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

110 
	#AT_REMOVEDIR
 0x200

	)

112 
	#AT_SYMLINK_FOLLOW
 0x400

	)

113 
	#AT_EACCESS
 0x200

	)

122 
fú
 (
__fd
, 
__cmd
, ...);

130 #iâdeà
__USE_FILE_OFFSET64


131 
	$İ’
 (
__cÚ¡
 *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

133 #ifdeà
__REDIRECT


134 
	`__REDIRECT
 (
İ’
, (
__cÚ¡
 *
__fe
, 
__oæag
, ...), 
İ’64
)

135 
	`__nÚnuÎ
 ((1));

137 
	#İ’
 
İ’64


	)

140 #ifdeà
__USE_LARGEFILE64


141 
	$İ’64
 (
__cÚ¡
 *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

144 #ifdeà
__USE_ATFILE


154 #iâdeà
__USE_FILE_OFFSET64


155 
	$İ’©
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
, ...)

156 
	`__nÚnuÎ
 ((2));

158 #ifdeà
__REDIRECT


159 
	`__REDIRECT
 (
İ’©
, (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
,

160 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

162 
	#İ’©
 
İ’©64


	)

165 #ifdeà
__USE_LARGEFILE64


166 
	$İ’©64
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__oæag
, ...)

167 
	`__nÚnuÎ
 ((2));

176 #iâdeà
__USE_FILE_OFFSET64


177 
	$ü—t
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

179 #ifdeà
__REDIRECT


180 
	`__REDIRECT
 (
ü—t
, (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
),

181 
ü—t64
è
	`__nÚnuÎ
 ((1));

183 
	#ü—t
 
ü—t64


	)

186 #ifdeà
__USE_LARGEFILE64


187 
	$ü—t64
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

190 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

191 && !
defšed
 
__USE_POSIX
))

200 
	#F_ULOCK
 0

	)

201 
	#F_LOCK
 1

	)

202 
	#F_TLOCK
 2

	)

203 
	#F_TEST
 3

	)

205 #iâdeà
__USE_FILE_OFFSET64


206 
	`lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
);

208 #ifdeà
__REDIRECT


209 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

211 
	#lockf
 
lockf64


	)

214 #ifdeà
__USE_LARGEFILE64


215 
	`lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
);

219 #ifdeà
__USE_XOPEN2K


222 #iâdeà
__USE_FILE_OFFSET64


223 
	$posix_çdvi£
 (
__fd
, 
__off_t
 
__off£t
, __off_ˆ
__Ën
,

224 
__advi£
è
__THROW
;

226 #ifdeà
__REDIRECT_NTH


227 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

228 
__off64_t
 
__Ën
, 
__advi£
),

229 
posix_çdvi£64
);

231 
	#posix_çdvi£
 
posix_çdvi£64


	)

234 #ifdeà
__USE_LARGEFILE64


235 
	$posix_çdvi£64
 (
__fd
, 
__off64_t
 
__off£t
, __off64_ˆ
__Ën
,

236 
__advi£
è
__THROW
;

244 #iâdeà
__USE_FILE_OFFSET64


245 
	`posix_çÎoÿ‹
 (
__fd
, 
__off_t
 
__off£t
, __off_ˆ
__Ën
);

247 #ifdeà
__REDIRECT


248 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

249 
__off64_t
 
__Ën
),

250 
posix_çÎoÿ‹64
);

252 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

255 #ifdeà
__USE_LARGEFILE64


256 
	`posix_çÎoÿ‹64
 (
__fd
, 
__off64_t
 
__off£t
, __off64_ˆ
__Ën
);

262 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše
 \

263 && 
defšed
 
__va_¬g_·ck_Ën


264 
	~<b™s/fú2.h
>

267 
__END_DECLS


	@/usr/include/inttypes.h

23 #iâdeà
_INTTYPES_H


24 
	#_INTTYPES_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	~<¡dšt.h
>

31 #iâdeà
____gwch¬_t_defšed


32 #ifdeà
__ılu¥lus


33 
	#__gwch¬_t
 
wch¬_t


	)

34 #–ià
defšed
 
__WCHAR_TYPE__


35 
__WCHAR_TYPE__
 
	t__gwch¬_t
;

37 
	#__Ãed_wch¬_t


	)

38 
	~<¡ddef.h
>

39 
wch¬_t
 
	t__gwch¬_t
;

41 
	#____gwch¬_t_defšed
 1

	)

47 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_FORMAT_MACROS


49 #ià
__WORDSIZE
 == 64

50 
	#__PRI64_PREFIX
 "l"

	)

51 
	#__PRIPTR_PREFIX
 "l"

	)

53 
	#__PRI64_PREFIX
 "Î"

	)

54 
	#__PRIPTR_PREFIX


	)

60 
	#PRId8
 "d"

	)

61 
	#PRId16
 "d"

	)

62 
	#PRId32
 "d"

	)

63 
	#PRId64
 
__PRI64_PREFIX
 "d"

	)

65 
	#PRIdLEAST8
 "d"

	)

66 
	#PRIdLEAST16
 "d"

	)

67 
	#PRIdLEAST32
 "d"

	)

68 
	#PRIdLEAST64
 
__PRI64_PREFIX
 "d"

	)

70 
	#PRIdFAST8
 "d"

	)

71 
	#PRIdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

72 
	#PRIdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

73 
	#PRIdFAST64
 
__PRI64_PREFIX
 "d"

	)

76 
	#PRIi8
 "i"

	)

77 
	#PRIi16
 "i"

	)

78 
	#PRIi32
 "i"

	)

79 
	#PRIi64
 
__PRI64_PREFIX
 "i"

	)

81 
	#PRIiLEAST8
 "i"

	)

82 
	#PRIiLEAST16
 "i"

	)

83 
	#PRIiLEAST32
 "i"

	)

84 
	#PRIiLEAST64
 
__PRI64_PREFIX
 "i"

	)

86 
	#PRIiFAST8
 "i"

	)

87 
	#PRIiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

88 
	#PRIiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

89 
	#PRIiFAST64
 
__PRI64_PREFIX
 "i"

	)

92 
	#PRIo8
 "o"

	)

93 
	#PRIo16
 "o"

	)

94 
	#PRIo32
 "o"

	)

95 
	#PRIo64
 
__PRI64_PREFIX
 "o"

	)

97 
	#PRIoLEAST8
 "o"

	)

98 
	#PRIoLEAST16
 "o"

	)

99 
	#PRIoLEAST32
 "o"

	)

100 
	#PRIoLEAST64
 
__PRI64_PREFIX
 "o"

	)

102 
	#PRIoFAST8
 "o"

	)

103 
	#PRIoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

104 
	#PRIoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

105 
	#PRIoFAST64
 
__PRI64_PREFIX
 "o"

	)

108 
	#PRIu8
 "u"

	)

109 
	#PRIu16
 "u"

	)

110 
	#PRIu32
 "u"

	)

111 
	#PRIu64
 
__PRI64_PREFIX
 "u"

	)

113 
	#PRIuLEAST8
 "u"

	)

114 
	#PRIuLEAST16
 "u"

	)

115 
	#PRIuLEAST32
 "u"

	)

116 
	#PRIuLEAST64
 
__PRI64_PREFIX
 "u"

	)

118 
	#PRIuFAST8
 "u"

	)

119 
	#PRIuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

120 
	#PRIuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

121 
	#PRIuFAST64
 
__PRI64_PREFIX
 "u"

	)

124 
	#PRIx8
 "x"

	)

125 
	#PRIx16
 "x"

	)

126 
	#PRIx32
 "x"

	)

127 
	#PRIx64
 
__PRI64_PREFIX
 "x"

	)

129 
	#PRIxLEAST8
 "x"

	)

130 
	#PRIxLEAST16
 "x"

	)

131 
	#PRIxLEAST32
 "x"

	)

132 
	#PRIxLEAST64
 
__PRI64_PREFIX
 "x"

	)

134 
	#PRIxFAST8
 "x"

	)

135 
	#PRIxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

136 
	#PRIxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

137 
	#PRIxFAST64
 
__PRI64_PREFIX
 "x"

	)

140 
	#PRIX8
 "X"

	)

141 
	#PRIX16
 "X"

	)

142 
	#PRIX32
 "X"

	)

143 
	#PRIX64
 
__PRI64_PREFIX
 "X"

	)

145 
	#PRIXLEAST8
 "X"

	)

146 
	#PRIXLEAST16
 "X"

	)

147 
	#PRIXLEAST32
 "X"

	)

148 
	#PRIXLEAST64
 
__PRI64_PREFIX
 "X"

	)

150 
	#PRIXFAST8
 "X"

	)

151 
	#PRIXFAST16
 
__PRIPTR_PREFIX
 "X"

	)

152 
	#PRIXFAST32
 
__PRIPTR_PREFIX
 "X"

	)

153 
	#PRIXFAST64
 
__PRI64_PREFIX
 "X"

	)

157 
	#PRIdMAX
 
__PRI64_PREFIX
 "d"

	)

158 
	#PRIiMAX
 
__PRI64_PREFIX
 "i"

	)

159 
	#PRIoMAX
 
__PRI64_PREFIX
 "o"

	)

160 
	#PRIuMAX
 
__PRI64_PREFIX
 "u"

	)

161 
	#PRIxMAX
 
__PRI64_PREFIX
 "x"

	)

162 
	#PRIXMAX
 
__PRI64_PREFIX
 "X"

	)

166 
	#PRIdPTR
 
__PRIPTR_PREFIX
 "d"

	)

167 
	#PRIiPTR
 
__PRIPTR_PREFIX
 "i"

	)

168 
	#PRIoPTR
 
__PRIPTR_PREFIX
 "o"

	)

169 
	#PRIuPTR
 
__PRIPTR_PREFIX
 "u"

	)

170 
	#PRIxPTR
 
__PRIPTR_PREFIX
 "x"

	)

171 
	#PRIXPTR
 
__PRIPTR_PREFIX
 "X"

	)

177 
	#SCNd8
 "hhd"

	)

178 
	#SCNd16
 "hd"

	)

179 
	#SCNd32
 "d"

	)

180 
	#SCNd64
 
__PRI64_PREFIX
 "d"

	)

182 
	#SCNdLEAST8
 "hhd"

	)

183 
	#SCNdLEAST16
 "hd"

	)

184 
	#SCNdLEAST32
 "d"

	)

185 
	#SCNdLEAST64
 
__PRI64_PREFIX
 "d"

	)

187 
	#SCNdFAST8
 "hhd"

	)

188 
	#SCNdFAST16
 
__PRIPTR_PREFIX
 "d"

	)

189 
	#SCNdFAST32
 
__PRIPTR_PREFIX
 "d"

	)

190 
	#SCNdFAST64
 
__PRI64_PREFIX
 "d"

	)

193 
	#SCNi8
 "hhi"

	)

194 
	#SCNi16
 "hi"

	)

195 
	#SCNi32
 "i"

	)

196 
	#SCNi64
 
__PRI64_PREFIX
 "i"

	)

198 
	#SCNiLEAST8
 "hhi"

	)

199 
	#SCNiLEAST16
 "hi"

	)

200 
	#SCNiLEAST32
 "i"

	)

201 
	#SCNiLEAST64
 
__PRI64_PREFIX
 "i"

	)

203 
	#SCNiFAST8
 "hhi"

	)

204 
	#SCNiFAST16
 
__PRIPTR_PREFIX
 "i"

	)

205 
	#SCNiFAST32
 
__PRIPTR_PREFIX
 "i"

	)

206 
	#SCNiFAST64
 
__PRI64_PREFIX
 "i"

	)

209 
	#SCNu8
 "hhu"

	)

210 
	#SCNu16
 "hu"

	)

211 
	#SCNu32
 "u"

	)

212 
	#SCNu64
 
__PRI64_PREFIX
 "u"

	)

214 
	#SCNuLEAST8
 "hhu"

	)

215 
	#SCNuLEAST16
 "hu"

	)

216 
	#SCNuLEAST32
 "u"

	)

217 
	#SCNuLEAST64
 
__PRI64_PREFIX
 "u"

	)

219 
	#SCNuFAST8
 "hhu"

	)

220 
	#SCNuFAST16
 
__PRIPTR_PREFIX
 "u"

	)

221 
	#SCNuFAST32
 
__PRIPTR_PREFIX
 "u"

	)

222 
	#SCNuFAST64
 
__PRI64_PREFIX
 "u"

	)

225 
	#SCNo8
 "hho"

	)

226 
	#SCNo16
 "ho"

	)

227 
	#SCNo32
 "o"

	)

228 
	#SCNo64
 
__PRI64_PREFIX
 "o"

	)

230 
	#SCNoLEAST8
 "hho"

	)

231 
	#SCNoLEAST16
 "ho"

	)

232 
	#SCNoLEAST32
 "o"

	)

233 
	#SCNoLEAST64
 
__PRI64_PREFIX
 "o"

	)

235 
	#SCNoFAST8
 "hho"

	)

236 
	#SCNoFAST16
 
__PRIPTR_PREFIX
 "o"

	)

237 
	#SCNoFAST32
 
__PRIPTR_PREFIX
 "o"

	)

238 
	#SCNoFAST64
 
__PRI64_PREFIX
 "o"

	)

241 
	#SCNx8
 "hhx"

	)

242 
	#SCNx16
 "hx"

	)

243 
	#SCNx32
 "x"

	)

244 
	#SCNx64
 
__PRI64_PREFIX
 "x"

	)

246 
	#SCNxLEAST8
 "hhx"

	)

247 
	#SCNxLEAST16
 "hx"

	)

248 
	#SCNxLEAST32
 "x"

	)

249 
	#SCNxLEAST64
 
__PRI64_PREFIX
 "x"

	)

251 
	#SCNxFAST8
 "hhx"

	)

252 
	#SCNxFAST16
 
__PRIPTR_PREFIX
 "x"

	)

253 
	#SCNxFAST32
 
__PRIPTR_PREFIX
 "x"

	)

254 
	#SCNxFAST64
 
__PRI64_PREFIX
 "x"

	)

258 
	#SCNdMAX
 
__PRI64_PREFIX
 "d"

	)

259 
	#SCNiMAX
 
__PRI64_PREFIX
 "i"

	)

260 
	#SCNoMAX
 
__PRI64_PREFIX
 "o"

	)

261 
	#SCNuMAX
 
__PRI64_PREFIX
 "u"

	)

262 
	#SCNxMAX
 
__PRI64_PREFIX
 "x"

	)

265 
	#SCNdPTR
 
__PRIPTR_PREFIX
 "d"

	)

266 
	#SCNiPTR
 
__PRIPTR_PREFIX
 "i"

	)

267 
	#SCNoPTR
 
__PRIPTR_PREFIX
 "o"

	)

268 
	#SCNuPTR
 
__PRIPTR_PREFIX
 "u"

	)

269 
	#SCNxPTR
 
__PRIPTR_PREFIX
 "x"

	)

274 
	g__BEGIN_DECLS


276 #ià
__WORDSIZE
 == 64

281 
	mquÙ
;

282 
	m»m
;

283 } 
	timaxdiv_t
;

290 
	mquÙ
;

291 
	m»m
;

292 } 
	timaxdiv_t
;

298 
štmax_t
 
	$imaxabs
 (
štmax_t
 
__n
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

301 
imaxdiv_t
 
	$imaxdiv
 (
štmax_t
 
__num”
, iÁmax_ˆ
__d’om
)

302 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

305 
štmax_t
 
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

306 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

309 
uštmax_t
 
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

310 ** 
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

313 
štmax_t
 
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

314 
__gwch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

315 
__THROW
;

318 
uštmax_t
 
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
__ÅŒ
,

319 
__gwch¬_t
 ** 
__»¡riù
 
__’d±r
, 
__ba£
)

320 
__THROW
;

322 #ifdeà
__USE_EXTERN_INLINES


324 #ià
__WORDSIZE
 == 64

326 
	$__¡¹Ş_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

327 **
__»¡riù
 
__’d±r
,

328 
__ba£
, 
__group
)

329 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

331 
__ex‹º_šlše
 
štmax_t


332 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

333 
ba£
))

335  
	`__¡¹Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

336 
	}
}

338 
	$__¡¹oul_š‹º®
 (
__cÚ¡
 *

339 
__»¡riù
 
__ÅŒ
,

340 ** 
__»¡riù
 
__’d±r
,

341 
__ba£
, 
__group
)

342 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

344 
__ex‹º_šlše
 
uštmax_t


345 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

346 
ba£
))

348  
	`__¡¹oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

349 
	}
}

351 
	$__wc¡Ş_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 * 
__»¡riù
 
__ÅŒ
,

352 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

353 
__ba£
, 
__group
)

354 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

356 
__ex‹º_šlše
 
štmax_t


357 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

358 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

360  
	`__wc¡Ş_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

361 
	}
}

363 
	$__wc¡oul_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

364 
__»¡riù
 
__ÅŒ
,

365 
__gwch¬_t
 **

366 
__»¡riù
 
__’d±r
,

367 
__ba£
, 
__group
)

368 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

370 
__ex‹º_šlše
 
uštmax_t


371 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

372 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

374  
	`__wc¡oul_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

375 
	}
}

379 
__ex‹nsiÚ__


380 
	$__¡¹Şl_š‹º®
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

381 **
__»¡riù
 
__’d±r
,

382 
__ba£
, 
__group
)

383 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

385 
__ex‹º_šlše
 
štmax_t


386 
	`__NTH
 (
	$¡¹oimax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

387 
ba£
))

389  
	`__¡¹Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

390 
	}
}

392 
__ex‹nsiÚ__


393 
	$__¡¹ouÎ_š‹º®
 (
__cÚ¡
 *

394 
__»¡riù
 
__ÅŒ
,

396 
__»¡riù
 
__’d±r
,

397 
__ba£
,

398 
__group
)

399 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

401 
__ex‹º_šlše
 
uštmax_t


402 
	`__NTH
 (
	$¡¹oumax
 (
__cÚ¡
 *
__»¡riù
 
ÅŒ
, **__»¡riù 
’d±r
,

403 
ba£
))

405  
	`__¡¹ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

406 
	}
}

408 
__ex‹nsiÚ__


409 
	$__wc¡Şl_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

410 
__»¡riù
 
__ÅŒ
,

411 
__gwch¬_t
 **
__»¡riù
 
__’d±r
,

412 
__ba£
, 
__group
)

413 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

415 
__ex‹º_šlše
 
štmax_t


416 
	`__NTH
 (
	$wc¡oimax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

417 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

419  
	`__wc¡Şl_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

420 
	}
}

423 
__ex‹nsiÚ__


424 
	$__wc¡ouÎ_š‹º®
 (
__cÚ¡
 
__gwch¬_t
 *

425 
__»¡riù
 
__ÅŒ
,

426 
__gwch¬_t
 **

427 
__»¡riù
 
__’d±r
,

428 
__ba£
,

429 
__group
)

430 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

432 
__ex‹º_šlše
 
uštmax_t


433 
	`__NTH
 (
	$wc¡oumax
 (
__cÚ¡
 
__gwch¬_t
 *
__»¡riù
 
ÅŒ
,

434 
__gwch¬_t
 **
__»¡riù
 
’d±r
, 
ba£
))

436  
	`__wc¡ouÎ_š‹º®
 (
ÅŒ
, 
’d±r
, 
ba£
, 0);

437 
	}
}

442 
	g__END_DECLS


	@/usr/include/stdio.h

24 #iâdeà
_STDIO_H


26 #ià!
defšed
 
__Ãed_FILE
 && !defšed 
__Ãed___FILE


27 
	#_STDIO_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


32 
	#__Ãed_size_t


	)

33 
	#__Ãed_NULL


	)

34 
	~<¡ddef.h
>

36 
	~<b™s/ty³s.h
>

37 
	#__Ãed_FILE


	)

38 
	#__Ãed___FILE


	)

42 #ià!
defšed
 
__FILE_defšed
 && defšed 
__Ãed_FILE


45 
	g_IO_FILE
;

47 
__BEGIN_NAMESPACE_STD


49 
_IO_FILE
 
	tFILE
;

50 
	g__END_NAMESPACE_STD


51 #ià
defšed
 
__USE_LARGEFILE64
 || defšed 
__USE_SVID
 || defšed 
__USE_POSIX
 \

52 || 
defšed
 
	g__USE_BSD
 || defšed 
	g__USE_ISOC99
 || defšed 
	g__USE_XOPEN
 \

53 || 
defšed
 
__USE_POSIX2


54 
	$__USING_NAMESPACE_STD
(
FILE
)

57 
	#__FILE_defšed
 1

	)

59 #undeà
__Ãed_FILE


62 #ià!
defšed
 
____FILE_defšed
 && defšed 
__Ãed___FILE


65 
_IO_FILE
 
	t__FILE
;

67 
	#____FILE_defšed
 1

	)

69 #undeà
__Ãed___FILE


72 #ifdef 
_STDIO_H


73 
	#_STDIO_USES_IOSTREAM


	)

75 
	~<libio.h
>

77 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


78 #ifdeà
__GNUC__


79 #iâdeà
_VA_LIST_DEFINED


80 
_G_va_li¡
 
	tva_li¡
;

81 
	#_VA_LIST_DEFINED


	)

84 
	~<¡d¬g.h
>

88 #ifdeà
__USE_XOPEN2K8


89 #iâdeà
__off_t_defšed


90 #iâdeà
__USE_FILE_OFFSET64


91 
__off_t
 
	toff_t
;

93 
__off64_t
 
	toff_t
;

95 
	#__off_t_defšed


	)

97 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


98 
__off64_t
 
	toff64_t
;

99 
	#__off64_t_defšed


	)

102 #iâdeà
__ssize_t_defšed


103 
__ssize_t
 
	tssize_t
;

104 
	#__ssize_t_defšed


	)

109 
__BEGIN_NAMESPACE_STD


110 #iâdeà
__USE_FILE_OFFSET64


111 
_G_åos_t
 
	tåos_t
;

113 
_G_åos64_t
 
	tåos_t
;

115 
__END_NAMESPACE_STD


116 #ifdeà
__USE_LARGEFILE64


117 
_G_åos64_t
 
	tåos64_t
;

121 
	#_IOFBF
 0

	)

122 
	#_IOLBF
 1

	)

123 
	#_IONBF
 2

	)

127 #iâdeà
BUFSIZ


128 
	#BUFSIZ
 
_IO_BUFSIZ


	)

134 #iâdeà
EOF


135 
	#EOF
 (-1)

	)

141 
	#SEEK_SET
 0

	)

142 
	#SEEK_CUR
 1

	)

143 
	#SEEK_END
 2

	)

146 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


148 
	#P_tmpdœ
 "/tmp"

	)

161 
	~<b™s/¡dio_lim.h
>

165 
_IO_FILE
 *
¡dš
;

166 
_IO_FILE
 *
¡dout
;

167 
_IO_FILE
 *
¡d”r
;

168 #ifdeà
__STDC__


170 
	#¡dš
 
¡dš


	)

171 
	#¡dout
 
¡dout


	)

172 
	#¡d”r
 
¡d”r


	)

175 
__BEGIN_NAMESPACE_STD


177 
	$»move
 (
__cÚ¡
 *
__f’ame
è
__THROW
;

179 
	$»Çme
 (
__cÚ¡
 *
__Şd
, __cÚ¡ *
__Ãw
è
__THROW
;

180 
__END_NAMESPACE_STD


182 #ifdeà
__USE_ATFILE


184 
	$»Çm—t
 (
__Şdfd
, 
__cÚ¡
 *
__Şd
, 
__Ãwfd
,

185 
__cÚ¡
 *
__Ãw
è
__THROW
;

188 
__BEGIN_NAMESPACE_STD


193 #iâdeà
__USE_FILE_OFFSET64


194 
FILE
 *
	$tmpfe
 (è
__wur
;

196 #ifdeà
__REDIRECT


197 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

199 
	#tmpfe
 
tmpfe64


	)

203 #ifdeà
__USE_LARGEFILE64


204 
FILE
 *
	$tmpfe64
 (è
__wur
;

208 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

209 
__END_NAMESPACE_STD


211 #ifdeà
__USE_MISC


214 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

218 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


226 *
	$‹m²am
 (
__cÚ¡
 *
__dœ
, __cÚ¡ *
__pfx
)

227 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

231 
__BEGIN_NAMESPACE_STD


236 
	`fşo£
 (
FILE
 *
__¡»am
);

241 
	`fæush
 (
FILE
 *
__¡»am
);

242 
__END_NAMESPACE_STD


244 #ifdeà
__USE_MISC


251 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

254 #ifdeà
__USE_GNU


261 
	`fşo£®l
 ();

265 
__BEGIN_NAMESPACE_STD


266 #iâdeà
__USE_FILE_OFFSET64


271 
FILE
 *
	$fİ’
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

272 
__cÚ¡
 *
__»¡riù
 
__modes
è
__wur
;

277 
FILE
 *
	$äeİ’
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

278 
__cÚ¡
 *
__»¡riù
 
__modes
,

279 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

281 #ifdeà
__REDIRECT


282 
FILE
 *
	`__REDIRECT
 (
fİ’
, (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

283 
__cÚ¡
 *
__»¡riù
 
__modes
), 
fİ’64
)

284 
__wur
;

285 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

286 
__cÚ¡
 *
__»¡riù
 
__modes
,

287 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

288 
__wur
;

290 
	#fİ’
 
fİ’64


	)

291 
	#äeİ’
 
äeİ’64


	)

294 
__END_NAMESPACE_STD


295 #ifdeà
__USE_LARGEFILE64


296 
FILE
 *
	$fİ’64
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

297 
__cÚ¡
 *
__»¡riù
 
__modes
è
__wur
;

298 
FILE
 *
	$äeİ’64
 (
__cÚ¡
 *
__»¡riù
 
__f’ame
,

299 
__cÚ¡
 *
__»¡riù
 
__modes
,

300 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

303 #ifdef 
__USE_POSIX


305 
FILE
 *
	$fdİ’
 (
__fd
, 
__cÚ¡
 *
__modes
è
__THROW
 
__wur
;

308 #ifdef 
__USE_GNU


311 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

312 
__cÚ¡
 *
__»¡riù
 
__modes
,

313 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

316 #ifdeà
__USE_XOPEN2K8


318 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, 
__cÚ¡
 *
__modes
)

319 
__THROW
 
__wur
;

324 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

328 
__BEGIN_NAMESPACE_STD


331 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

335 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

336 
__modes
, 
size_t
 
__n
è
__THROW
;

337 
__END_NAMESPACE_STD


339 #ifdef 
__USE_BSD


342 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

343 
size_t
 
__size
è
__THROW
;

346 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

350 
__BEGIN_NAMESPACE_STD


355 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

356 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

361 
	`´štf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

363 
	$¥rštf
 (*
__»¡riù
 
__s
,

364 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

370 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

371 
_G_va_li¡
 
__¬g
);

376 
	`v´štf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

378 
	$v¥rštf
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

379 
_G_va_li¡
 
__¬g
è
__THROW
;

380 
__END_NAMESPACE_STD


382 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


383 
__BEGIN_NAMESPACE_C99


385 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

386 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...)

387 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

389 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

390 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

391 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

392 
__END_NAMESPACE_C99


395 #ifdeà
__USE_GNU


398 
	$va¥rštf
 (**
__»¡riù
 
__±r
, 
__cÚ¡
 *__»¡riù 
__f
,

399 
_G_va_li¡
 
__¬g
)

400 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

401 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

402 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

403 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

404 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

405 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

406 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

409 #ifdeà
__USE_XOPEN2K8


416 
	$vd´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
,

417 
_G_va_li¡
 
__¬g
)

418 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

419 
	$d´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

420 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

424 
__BEGIN_NAMESPACE_STD


429 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

430 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

435 
	$sÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

437 
	$ssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

438 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

440 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

441 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

442 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

443 #ifdeà
__REDIRECT


447 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

448 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

449 
__isoc99_fsÿnf
è
__wur
;

450 
	`__REDIRECT
 (
sÿnf
, (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

451 
__isoc99_sÿnf
è
__wur
;

452 
	`__REDIRECT
 (
ssÿnf
, (
__cÚ¡
 *
__»¡riù
 
__s
,

453 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...),

454 
__isoc99_ssÿnf
è
__THROW
;

456 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

457 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

458 
	$__isoc99_sÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__wur
;

459 
	$__isoc99_ssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

460 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

461 
	#fsÿnf
 
__isoc99_fsÿnf


	)

462 
	#sÿnf
 
__isoc99_sÿnf


	)

463 
	#ssÿnf
 
__isoc99_ssÿnf


	)

467 
__END_NAMESPACE_STD


469 #ifdef 
__USE_ISOC99


470 
__BEGIN_NAMESPACE_C99


475 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fÜm©
,

476 
_G_va_li¡
 
__¬g
)

477 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

483 
	$vsÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

484 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

487 
	$vssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

488 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

489 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

491 #ià!
defšed
 
__USE_GNU
 \

492 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

493 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

494 #ifdeà
__REDIRECT


498 
	`__REDIRECT
 (
vfsÿnf
,

499 (
FILE
 *
__»¡riù
 
__s
,

500 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

501 
__isoc99_vfsÿnf
)

502 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

503 
	`__REDIRECT
 (
vsÿnf
, (
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

504 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

505 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

506 
	`__REDIRECT
 (
vssÿnf
,

507 (
__cÚ¡
 *
__»¡riù
 
__s
,

508 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

509 
__isoc99_vssÿnf
)

510 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

512 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

513 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

514 
_G_va_li¡
 
__¬g
è
__wur
;

515 
	$__isoc99_vsÿnf
 (
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

516 
_G_va_li¡
 
__¬g
è
__wur
;

517 
	$__isoc99_vssÿnf
 (
__cÚ¡
 *
__»¡riù
 
__s
,

518 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

519 
_G_va_li¡
 
__¬g
è
__THROW
;

520 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

521 
	#vsÿnf
 
__isoc99_vsÿnf


	)

522 
	#vssÿnf
 
__isoc99_vssÿnf


	)

526 
__END_NAMESPACE_C99


530 
__BEGIN_NAMESPACE_STD


535 
	`fg‘c
 (
FILE
 *
__¡»am
);

536 
	`g‘c
 (
FILE
 *
__¡»am
);

542 
	`g‘ch¬
 ();

543 
__END_NAMESPACE_STD


547 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

549 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


554 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

555 
	`g‘ch¬_uÆocked
 ();

558 #ifdeà
__USE_MISC


565 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

569 
__BEGIN_NAMESPACE_STD


577 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

578 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

584 
	`putch¬
 (
__c
);

585 
__END_NAMESPACE_STD


589 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

591 #ifdeà
__USE_MISC


598 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

601 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


606 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

607 
	`putch¬_uÆocked
 (
__c
);

611 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 \

612 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

614 
	`g‘w
 (
FILE
 *
__¡»am
);

617 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

621 
__BEGIN_NAMESPACE_STD


626 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

627 
__wur
;

634 *
	$g‘s
 (*
__s
è
__wur
;

635 
__END_NAMESPACE_STD


637 #ifdeà
__USE_GNU


644 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

645 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

649 #ifdef 
__USE_XOPEN2K8


660 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

661 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

662 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

663 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

664 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

665 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

673 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

674 
size_t
 *
__»¡riù
 
__n
,

675 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

679 
__BEGIN_NAMESPACE_STD


684 
	`åuts
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

690 
	`puts
 (
__cÚ¡
 *
__s
);

697 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

704 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

705 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

710 
size_t
 
	$fwr™e
 (
__cÚ¡
 *
__»¡riù
 
__±r
, 
size_t
 
__size
,

711 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
è
__wur
;

712 
__END_NAMESPACE_STD


714 #ifdeà
__USE_GNU


721 
	`åuts_uÆocked
 (
__cÚ¡
 *
__»¡riù
 
__s
,

722 
FILE
 *
__»¡riù
 
__¡»am
);

725 #ifdeà
__USE_MISC


732 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

733 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

734 
size_t
 
	$fwr™e_uÆocked
 (
__cÚ¡
 *
__»¡riù
 
__±r
, 
size_t
 
__size
,

735 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

739 
__BEGIN_NAMESPACE_STD


744 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

749 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

754 
	`»wšd
 (
FILE
 *
__¡»am
);

755 
__END_NAMESPACE_STD


762 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


763 #iâdeà
__USE_FILE_OFFSET64


768 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

773 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

775 #ifdeà
__REDIRECT


776 
	`__REDIRECT
 (
f£eko
,

777 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

778 
f£eko64
);

779 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

781 
	#f£eko
 
f£eko64


	)

782 
	#á–lo
 
á–lo64


	)

787 
__BEGIN_NAMESPACE_STD


788 #iâdeà
__USE_FILE_OFFSET64


793 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

798 
	`f£os
 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos_t
 *
__pos
);

800 #ifdeà
__REDIRECT


801 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

802 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

803 
	`__REDIRECT
 (
f£os
,

804 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos_t
 *
__pos
), 
f£os64
);

806 
	#fg‘pos
 
fg‘pos64


	)

807 
	#f£os
 
f£os64


	)

810 
__END_NAMESPACE_STD


812 #ifdeà
__USE_LARGEFILE64


813 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

814 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

815 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

816 
	`f£os64
 (
FILE
 *
__¡»am
, 
__cÚ¡
 
åos64_t
 *
__pos
);

819 
__BEGIN_NAMESPACE_STD


821 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

823 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

825 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

826 
__END_NAMESPACE_STD


828 #ifdeà
__USE_MISC


830 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

831 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

832 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

836 
__BEGIN_NAMESPACE_STD


841 
	`³¼Ü
 (
__cÚ¡
 *
__s
);

842 
__END_NAMESPACE_STD


848 
	~<b™s/sys_”¾i¡.h
>

851 #ifdef 
__USE_POSIX


853 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

856 #ifdeà
__USE_MISC


858 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

862 #ià(
defšed
 
__USE_POSIX2
 || defšed 
__USE_SVID
 || defšed 
__USE_BSD
 || \

863 
defšed
 
__USE_MISC
)

868 
FILE
 *
	$pİ’
 (
__cÚ¡
 *
__commªd
, __cÚ¡ *
__modes
è
__wur
;

874 
	`pşo£
 (
FILE
 *
__¡»am
);

878 #ifdef 
__USE_POSIX


880 *
	$ù”mid
 (*
__s
è
__THROW
;

884 #ifdeà
__USE_XOPEN


886 *
	`cu£rid
 (*
__s
);

890 #ifdef 
__USE_GNU


891 
ob¡ack
;

894 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

895 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...)

896 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

897 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

898 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

899 
_G_va_li¡
 
__¬gs
)

900 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

904 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


908 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

912 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

915 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

918 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


922 
	#__Ãed_g‘İt


	)

923 
	~<g‘İt.h
>

928 #ifdeà
__USE_EXTERN_INLINES


929 
	~<b™s/¡dio.h
>

931 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


932 
	~<b™s/¡dio2.h
>

934 #ifdeà
__LDBL_COMPAT


935 
	~<b™s/¡dio-ldbl.h
>

938 
__END_DECLS


	@/usr/include/stdlib.h

23 #iâdef 
_STDLIB_H


25 
	~<ã©u»s.h
>

28 
	#__Ãed_size_t


	)

29 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


30 
	#__Ãed_wch¬_t


	)

31 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	g__BEGIN_DECLS


37 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


38 
	#_STDLIB_H
 1

	)

40 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


42 
	~<b™s/wa™æags.h
>

43 
	~<b™s/wa™¡©us.h
>

45 #ifdeà
__USE_BSD


50 #ià
defšed
 
__GNUC__
 && !defšed 
__ılu¥lus


51 
	#__WAIT_INT
(
¡©us
) \

52 (
	`__ex‹nsiÚ__
 (((uniÚ { 
	`__ty³of
(
¡©us
è
__š
; 
__i
; }) \

53 { .
__š
 = (
¡©us
è}).
__i
))

	)

55 
	#__WAIT_INT
(
¡©us
è(*(*è&(¡©us))

	)

63 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2 || defšed 
__ılu¥lus


64 
	#__WAIT_STATUS
 *

	)

65 
	#__WAIT_STATUS_DEFN
 *

	)

70 
wa™
 *
	m__u±r
;

71 *
	m__Œ
;

72 } 
	t__WAIT_STATUS
 
	t__©Œibu‹__
 ((
	t__Œª¥¬’t_uniÚ__
));

73 
	#__WAIT_STATUS_DEFN
 *

	)

78 
	#__WAIT_INT
(
¡©us
è(¡©us)

	)

79 
	#__WAIT_STATUS
 *

	)

80 
	#__WAIT_STATUS_DEFN
 *

	)

85 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (
	`__WAIT_INT
 (¡©us))

	)

86 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (
	`__WAIT_INT
 (¡©us))

	)

87 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (
	`__WAIT_INT
 (¡©us))

	)

88 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (
	`__WAIT_INT
 (¡©us))

	)

89 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (
	`__WAIT_INT
 (¡©us))

	)

90 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (
	`__WAIT_INT
 (¡©us))

	)

91 #ifdeà
__WIFCONTINUED


92 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (
	`__WAIT_INT
 (¡©us))

	)

96 
__BEGIN_NAMESPACE_STD


100 
	mquÙ
;

101 
	m»m
;

102 } 
	tdiv_t
;

105 #iâdeà
__ldiv_t_defšed


108 
	mquÙ
;

109 
	m»m
;

110 } 
	tldiv_t
;

111 
	#__ldiv_t_defšed
 1

	)

113 
	g__END_NAMESPACE_STD


115 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


116 
__BEGIN_NAMESPACE_C99


118 
__ex‹nsiÚ__
 struct

120 
	mquÙ
;

121 
	m»m
;

122 } 
	tÎdiv_t
;

123 
	#__Îdiv_t_defšed
 1

	)

124 
	g__END_NAMESPACE_C99


129 
	#RAND_MAX
 2147483647

	)

134 
	#EXIT_FAILURE
 1

	)

135 
	#EXIT_SUCCESS
 0

	)

139 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

140 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

143 
__BEGIN_NAMESPACE_STD


145 
	$©of
 (
__cÚ¡
 *
__ÅŒ
)

146 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

148 
	$©oi
 (
__cÚ¡
 *
__ÅŒ
)

149 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

151 
	$©Ş
 (
__cÚ¡
 *
__ÅŒ
)

152 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

153 
__END_NAMESPACE_STD


155 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_MISC
)

156 
__BEGIN_NAMESPACE_C99


158 
__ex‹nsiÚ__
 
	$©Şl
 (
__cÚ¡
 *
__ÅŒ
)

159 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

160 
__END_NAMESPACE_C99


163 
__BEGIN_NAMESPACE_STD


165 
	$¡¹od
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

166 **
__»¡riù
 
__’d±r
)

167 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

168 
__END_NAMESPACE_STD


170 #ifdef 
__USE_ISOC99


171 
__BEGIN_NAMESPACE_C99


173 
	$¡¹of
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

174 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

176 
	$¡¹Şd
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

177 **
__»¡riù
 
__’d±r
)

178 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

179 
__END_NAMESPACE_C99


182 
__BEGIN_NAMESPACE_STD


184 
	$¡¹Ş
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

185 **
__»¡riù
 
__’d±r
, 
__ba£
)

186 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

188 
	$¡¹oul
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

189 **
__»¡riù
 
__’d±r
, 
__ba£
)

190 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

191 
__END_NAMESPACE_STD


193 #ià
defšed
 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_BSD


195 
__ex‹nsiÚ__


196 
	$¡¹oq
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

197 **
__»¡riù
 
__’d±r
, 
__ba£
)

198 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

200 
__ex‹nsiÚ__


201 
	$¡¹ouq
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

202 **
__»¡riù
 
__’d±r
, 
__ba£
)

203 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

206 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GLIBC_HAVE_LONG_LONG
 && defšed 
__USE_MISC
)

207 
__BEGIN_NAMESPACE_C99


209 
__ex‹nsiÚ__


210 
	$¡¹Şl
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

211 **
__»¡riù
 
__’d±r
, 
__ba£
)

212 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

214 
__ex‹nsiÚ__


215 
	$¡¹ouÎ
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

216 **
__»¡riù
 
__’d±r
, 
__ba£
)

217 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

218 
__END_NAMESPACE_C99


222 #ifdeà
__USE_GNU


236 
	~<xloÿË.h
>

240 
	$¡¹Ş_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

241 **
__»¡riù
 
__’d±r
, 
__ba£
,

242 
__loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

244 
	$¡¹oul_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

245 **
__»¡riù
 
__’d±r
,

246 
__ba£
, 
__loÿË_t
 
__loc
)

247 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

249 
__ex‹nsiÚ__


250 
	$¡¹Şl_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

251 **
__»¡riù
 
__’d±r
, 
__ba£
,

252 
__loÿË_t
 
__loc
)

253 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

255 
__ex‹nsiÚ__


256 
	$¡¹ouÎ_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

257 **
__»¡riù
 
__’d±r
,

258 
__ba£
, 
__loÿË_t
 
__loc
)

259 
__THROW
 
	`__nÚnuÎ
 ((1, 4)è
__wur
;

261 
	$¡¹od_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

262 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

263 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

265 
	$¡¹of_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

266 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

267 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

269 
	$¡¹Şd_l
 (
__cÚ¡
 *
__»¡riù
 
__ÅŒ
,

270 **
__»¡riù
 
__’d±r
,

271 
__loÿË_t
 
__loc
)

272 
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

276 #ifdeà
__USE_EXTERN_INLINES


277 
__BEGIN_NAMESPACE_STD


278 
__ex‹º_šlše
 

279 
	`__NTH
 (
	$©of
 (
__cÚ¡
 *
__ÅŒ
))

281  
	`¡¹od
 (
__ÅŒ
, (**è
NULL
);

282 
	}
}

283 
__ex‹º_šlše
 

284 
__NTH
 (
	$©oi
 (
__cÚ¡
 *
__ÅŒ
))

286  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

287 
	}
}

288 
__ex‹º_šlše
 

289 
__NTH
 (
	$©Ş
 (
__cÚ¡
 *
__ÅŒ
))

291  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

292 
	}
}

293 
	g__END_NAMESPACE_STD


295 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ISOC99


296 
__BEGIN_NAMESPACE_C99


297 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

298 
__NTH
 (
	$©Şl
 (
__cÚ¡
 *
__ÅŒ
))

300  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

301 
	}
}

302 
	g__END_NAMESPACE_C99


307 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED


311 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

314 
	$a64l
 (
__cÚ¡
 *
__s
)

315 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

319 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_BSD


320 
	~<sys/ty³s.h
>

327 
	$¿ndom
 (è
__THROW
;

330 
	$¤ªdom
 (
__£ed
è
__THROW
;

336 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

337 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

341 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

344 #ifdeà
__USE_MISC


349 
	s¿ndom_d©a


351 
št32_t
 *
åŒ
;

352 
št32_t
 *
½Œ
;

353 
št32_t
 *
¡©e
;

354 
¿nd_ty³
;

355 
¿nd_deg
;

356 
¿nd_£p
;

357 
št32_t
 *
’d_±r
;

360 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

361 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

363 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

364 
__THROW
 
	`__nÚnuÎ
 ((2));

366 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

367 
size_t
 
__¡©–’
,

368 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

369 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

371 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

372 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

373 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

378 
__BEGIN_NAMESPACE_STD


380 
	$¿nd
 (è
__THROW
;

382 
	$¤ªd
 (
__£ed
è
__THROW
;

383 
__END_NAMESPACE_STD


385 #ifdeà
__USE_POSIX


387 
	$¿nd_r
 (*
__£ed
è
__THROW
;

391 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


395 
	$d¿nd48
 (è
__THROW
;

396 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

399 
	$Ìªd48
 (è
__THROW
;

400 
	$Äªd48
 (
__xsubi
[3])

401 
__THROW
 
	`__nÚnuÎ
 ((1));

404 
	$m¿nd48
 (è
__THROW
;

405 
	$j¿nd48
 (
__xsubi
[3])

406 
__THROW
 
	`__nÚnuÎ
 ((1));

409 
	$¤ªd48
 (
__£edv®
è
__THROW
;

410 *
	$£ed48
 (
__£ed16v
[3])

411 
__THROW
 
	`__nÚnuÎ
 ((1));

412 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

414 #ifdeà
__USE_MISC


418 
	sd¿nd48_d©a


420 
__x
[3];

421 
__Şd_x
[3];

422 
__c
;

423 
__š™
;

424 
__a
;

428 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

429 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

430 
	$”ªd48_r
 (
__xsubi
[3],

431 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

432 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

435 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

436 *
__»¡riù
 
__»suÉ
)

437 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

438 
	$Äªd48_r
 (
__xsubi
[3],

439 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

440 *
__»¡riù
 
__»suÉ
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

445 *
__»¡riù
 
__»suÉ
)

446 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

447 
	$j¿nd48_r
 (
__xsubi
[3],

448 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

449 *
__»¡riù
 
__»suÉ
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

453 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

454 
__THROW
 
	`__nÚnuÎ
 ((2));

456 
	$£ed48_r
 (
__£ed16v
[3],

457 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$lcÚg48_r
 (
__·¿m
[7],

460 
d¿nd48_d©a
 *
__bufãr
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

467 #iâdeà
__m®loc_ªd_ÿÎoc_defšed


468 
	#__m®loc_ªd_ÿÎoc_defšed


	)

469 
__BEGIN_NAMESPACE_STD


471 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

473 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

474 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

475 
__END_NAMESPACE_STD


478 #iâdeà
__Ãed_m®loc_ªd_ÿÎoc


479 
__BEGIN_NAMESPACE_STD


485 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

486 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

488 
	$ä“
 (*
__±r
è
__THROW
;

489 
__END_NAMESPACE_STD


491 #ifdef 
__USE_MISC


493 
	$cä“
 (*
__±r
è
__THROW
;

496 #ià
defšed
 
__USE_GNU
 || defšed 
__USE_BSD
 || defšed 
__USE_MISC


497 
	~<®loÿ.h
>

500 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

501 || 
defšed
 
__USE_BSD


503 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

506 #ifdeà
__USE_XOPEN2K


508 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

509 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

512 
__BEGIN_NAMESPACE_STD


514 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

518 
	`©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

520 #ifdeà
__USE_GNU


524 #ifdeà
__ılu¥lus


525 "C++" 
	`©_quick_ex™
 ((*
__func
) ())

526 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

528 
	`©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

531 
__END_NAMESPACE_STD


533 #ifdef 
__USE_MISC


536 
	`Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

537 
__THROW
 
	`__nÚnuÎ
 ((1));

540 
__BEGIN_NAMESPACE_STD


544 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

546 #ifdeà
__USE_GNU


552 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

554 
__END_NAMESPACE_STD


556 #ifdeà
__USE_ISOC99


557 
__BEGIN_NAMESPACE_C99


560 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

561 
__END_NAMESPACE_C99


565 
__BEGIN_NAMESPACE_STD


567 *
	$g‘’v
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

568 
__END_NAMESPACE_STD


572 *
	$__£cu»_g‘’v
 (
__cÚ¡
 *
__Çme
)

573 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

575 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


579 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

582 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


585 
	$£‹nv
 (
__cÚ¡
 *
__Çme
, __cÚ¡ *
__v®ue
, 
__»¶aû
)

586 
__THROW
 
	`__nÚnuÎ
 ((2));

589 
	$un£‹nv
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

592 #ifdef 
__USE_MISC


596 
	$ş—»nv
 (è
__THROW
;

600 #ià
defšed
 
__USE_MISC
 \

601 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
)

606 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

609 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 \

610 || 
defšed
 
__USE_XOPEN2K8


619 #iâdeà
__USE_FILE_OFFSET64


620 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

622 #ifdeà
__REDIRECT


623 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

624 
	`__nÚnuÎ
 ((1)è
__wur
;

626 
	#mk¡emp
 
mk¡emp64


	)

629 #ifdeà
__USE_LARGEFILE64


630 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

634 #ifdeà
__USE_MISC


641 #iâdeà
__USE_FILE_OFFSET64


642 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

644 #ifdeà
__REDIRECT


645 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

646 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

648 
	#mk¡emps
 
mk¡emps64


	)

651 #ifdeà
__USE_LARGEFILE64


652 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

653 
	`__nÚnuÎ
 ((1)è
__wur
;

657 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K8


663 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

666 #ifdeà
__USE_GNU


673 #iâdeà
__USE_FILE_OFFSET64


674 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

676 #ifdeà
__REDIRECT


677 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

678 
	`__nÚnuÎ
 ((1)è
__wur
;

680 
	#mko¡emp
 
mko¡emp64


	)

683 #ifdeà
__USE_LARGEFILE64


684 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

693 #iâdeà
__USE_FILE_OFFSET64


694 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

695 
	`__nÚnuÎ
 ((1)è
__wur
;

697 #ifdeà
__REDIRECT


698 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

699 
__æags
), 
mko¡emps64
)

700 
	`__nÚnuÎ
 ((1)è
__wur
;

702 
	#mko¡emps
 
mko¡emps64


	)

705 #ifdeà
__USE_LARGEFILE64


706 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

707 
	`__nÚnuÎ
 ((1)è
__wur
;

712 
__BEGIN_NAMESPACE_STD


717 
	$sy¡em
 (
__cÚ¡
 *
__commªd
è
__wur
;

718 
__END_NAMESPACE_STD


721 #ifdef 
__USE_GNU


724 *
	$ÿnÚiÿlize_fe_Çme
 (
__cÚ¡
 *
__Çme
)

725 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

728 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


734 *
	$»®·th
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

735 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

740 #iâdeà
__COMPAR_FN_T


741 
	#__COMPAR_FN_T


	)

742 (*
	t__com·r_â_t
è(
	t__cÚ¡
 *, __const *);

744 #ifdef 
__USE_GNU


745 
__com·r_â_t
 
	tcom·risÚ_â_t
;

748 #ifdeà
__USE_GNU


749 (*
	t__com·r_d_â_t
è(
	t__cÚ¡
 *, __const *, *);

752 
__BEGIN_NAMESPACE_STD


755 *
	$b£¬ch
 (
__cÚ¡
 *
__key
, __cÚ¡ *
__ba£
,

756 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

757 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

761 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

762 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

763 #ifdeà
__USE_GNU


764 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

765 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

766 
	`__nÚnuÎ
 ((1, 4));

771 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

772 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

773 
__END_NAMESPACE_STD


775 #ifdeà
__USE_ISOC99


776 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

777 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

781 
__BEGIN_NAMESPACE_STD


785 
div_t
 
	$div
 (
__num”
, 
__d’om
)

786 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

787 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

788 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

789 
__END_NAMESPACE_STD


791 #ifdeà
__USE_ISOC99


792 
__BEGIN_NAMESPACE_C99


793 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

794 
__d’om
)

795 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

796 
__END_NAMESPACE_C99


800 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

801 || 
defšed
 
__USE_SVID


808 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

809 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

814 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

815 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

820 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

821 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

824 #ifdeà
__USE_MISC


826 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

827 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

828 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

829 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

830 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

831 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

832 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

833 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

838 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

839 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

840 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

841 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

842 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

843 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

845 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

846 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

847 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

848 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

849 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

850 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

851 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

852 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

857 
__BEGIN_NAMESPACE_STD


860 
	$mbËn
 (
__cÚ¡
 *
__s
, 
size_t
 
__n
è
__THROW
 
__wur
;

863 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

864 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
 
__wur
;

867 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
 
__wur
;

871 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

872 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

874 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

875 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

876 
__THROW
;

877 
__END_NAMESPACE_STD


880 #ifdeà
__USE_SVID


885 
	$½m©ch
 (
__cÚ¡
 *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

889 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


896 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

897 *
__cÚ¡
 *
__»¡riù
 
__tok’s
,

898 **
__»¡riù
 
__v®u•
)

899 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

903 #ifdeà
__USE_XOPEN


905 
	$£tkey
 (
__cÚ¡
 *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

911 #ifdeà
__USE_XOPEN2KXSI


913 
	$posix_İ’±
 (
__oæag
è
__wur
;

916 #ifdeà
__USE_XOPEN


921 
	$g¿Á±
 (
__fd
è
__THROW
;

925 
	$uÆock±
 (
__fd
è
__THROW
;

930 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

933 #ifdeà
__USE_GNU


937 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

938 
__THROW
 
	`__nÚnuÎ
 ((2));

941 
	`g‘±
 ();

944 #ifdeà
__USE_BSD


948 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

949 
__THROW
 
	`__nÚnuÎ
 ((1));

954 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


955 
	~<b™s/¡dlib.h
>

957 #ifdeà
__LDBL_COMPAT


958 
	~<b™s/¡dlib-ldbl.h
>

962 #undeà
__Ãed_m®loc_ªd_ÿÎoc


964 
__END_DECLS


	@/usr/include/string.h

24 #iâdef 
_STRING_H


25 
	#_STRING_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	g__BEGIN_DECLS


32 
	#__Ãed_size_t


	)

33 
	#__Ãed_NULL


	)

34 
	~<¡ddef.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

38 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 
__BEGIN_NAMESPACE_STD


44 *
	$memıy
 (*
__»¡riù
 
__de¡
,

45 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

46 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

49 *
	$memmove
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
)

50 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

51 
__END_NAMESPACE_STD


56 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN


57 *
	$memcıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

58 
__c
, 
size_t
 
__n
)

59 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

63 
__BEGIN_NAMESPACE_STD


65 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

68 
	$memcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

72 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


75 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

76 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 
__cÚ¡
 *
	`memchr
 (__cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

78 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

80 #ifdeà
__OPTIMIZE__


81 
__ex‹º_®ways_šlše
 *

82 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


84  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

87 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

88 
	`memchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


90  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

93 
	}
}

95 *
	$memchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

96 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

98 
__END_NAMESPACE_STD


100 #ifdeà
__USE_GNU


103 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


104 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

105 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 "C++" 
__cÚ¡
 *
	$¿wmemchr
 (
__cÚ¡
 *
__s
, 
__c
)

107 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

109 *
	$¿wmemchr
 (
__cÚ¡
 *
__s
, 
__c
)

110 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


115 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

116 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 "C++" 
__cÚ¡
 *
	$memrchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

120 *
	$memrchr
 (
__cÚ¡
 *
__s
, 
__c
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

126 
__BEGIN_NAMESPACE_STD


128 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

129 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

131 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

132 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

133 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

137 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

139 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

140 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
	$¡ºcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

147 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
	$¡rcŞl
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

151 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

153 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

154 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

155 
__THROW
 
	`__nÚnuÎ
 ((2));

156 
__END_NAMESPACE_STD


158 #ifdeà
__USE_XOPEN2K8


162 
	~<xloÿË.h
>

165 
	$¡rcŞl_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

166 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

168 
size_t
 
	$¡rxäm_l
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
,

169 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

172 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 \

173 || 
defšed
 
__USE_XOPEN2K8


175 *
	$¡rdup
 (
__cÚ¡
 *
__s
)

176 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

182 #ià
defšed
 
__USE_XOPEN2K8


183 *
	$¡ºdup
 (
__cÚ¡
 *
__¡ršg
, 
size_t
 
__n
)

184 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

187 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


189 
	#¡rdu·
(
s
) \

190 (
__ex‹nsiÚ__
 \

192 
__cÚ¡
 *
__Şd
 = (
s
); \

193 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

194 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

195 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

196 
	}
}))

	)

199 
	#¡ºdu·
(
s
, 
n
) \

200 (
__ex‹nsiÚ__
 \

202 
__cÚ¡
 *
__Şd
 = (
s
); \

203 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

204 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

205 
__Ãw
[
__Ën
] = '\0'; \

206 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

207 }))

	)

210 
	g__BEGIN_NAMESPACE_STD


212 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


215 *
¡rchr
 (*
__s
, 
__c
)

216 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

217 
__cÚ¡
 *
¡rchr
 (__cÚ¡ *
__s
, 
__c
)

218 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

220 #ifdeà
__OPTIMIZE__


221 
__ex‹º_®ways_šlše
 *

222 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


224  
__butš_¡rchr
 (
__s
, 
__c
);

227 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

228 
¡rchr
 (
__cÚ¡
 *
__s
, 
__c
è
	g__THROW


230  
__butš_¡rchr
 (
__s
, 
__c
);

235 *
	$¡rchr
 (
__cÚ¡
 *
__s
, 
__c
)

236 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

239 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


242 *
	`¡¼chr
 (*
__s
, 
__c
)

243 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

244 
__cÚ¡
 *
	`¡¼chr
 (__cÚ¡ *
__s
, 
__c
)

245 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

247 #ifdeà
__OPTIMIZE__


248 
__ex‹º_®ways_šlše
 *

249 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


251  
	`__butš_¡¼chr
 (
__s
, 
__c
);

254 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

255 
	`¡¼chr
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


257  
	`__butš_¡¼chr
 (
__s
, 
__c
);

260 
	}
}

262 *
	$¡¼chr
 (
__cÚ¡
 *
__s
, 
__c
)

263 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 
__END_NAMESPACE_STD


267 #ifdeà
__USE_GNU


270 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


271 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

272 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

273 "C++" 
__cÚ¡
 *
	$¡rchºul
 (
__cÚ¡
 *
__s
, 
__c
)

274 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

276 *
	$¡rchºul
 (
__cÚ¡
 *
__s
, 
__c
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

281 
__BEGIN_NAMESPACE_STD


284 
size_t
 
	$¡rc¥n
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__»jeù
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

288 
size_t
 
	$¡r¥n
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
)

289 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

291 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


294 *
	`¡½brk
 (*
__s
, 
__cÚ¡
 *
__acû±
)

295 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

296 
__cÚ¡
 *
	`¡½brk
 (__cÚ¡ *
__s
, __cÚ¡ *
__acû±
)

297 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

299 #ifdeà
__OPTIMIZE__


300 
__ex‹º_®ways_šlše
 *

301 
	`¡½brk
 (*
__s
, 
__cÚ¡
 *
__acû±
è
__THROW


303  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

306 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

307 
	`¡½brk
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
è
__THROW


309  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

312 
	}
}

314 *
	$¡½brk
 (
__cÚ¡
 *
__s
, __cÚ¡ *
__acû±
)

315 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

318 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


321 *
	`¡r¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
)

322 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

323 
__cÚ¡
 *
	`¡r¡r
 (__cÚ¡ *
__hay¡ack
,

324 
__cÚ¡
 *
__ÃedË
)

325 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

327 #ifdeà
__OPTIMIZE__


328 
__ex‹º_®ways_šlše
 *

329 
	`¡r¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
è
__THROW


331  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

334 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

335 
	`¡r¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
è
__THROW


337  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

340 
	}
}

342 *
	$¡r¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
)

343 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

348 *
	$¡¹ok
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__d–im
)

349 
__THROW
 
	`__nÚnuÎ
 ((2));

350 
__END_NAMESPACE_STD


354 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

355 
__cÚ¡
 *
__»¡riù
 
__d–im
,

356 **
__»¡riù
 
__§ve_±r
)

357 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

358 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


359 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__d–im
,

360 **
__»¡riù
 
__§ve_±r
)

361 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

364 #ifdeà
__USE_GNU


366 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


367 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, 
__cÚ¡
 *
__ÃedË
)

368 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

369 "C++" 
__cÚ¡
 *
	$¡rÿ£¡r
 (
__cÚ¡
 *
__hay¡ack
,

370 
__cÚ¡
 *
__ÃedË
)

371 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 *
	$¡rÿ£¡r
 (
__cÚ¡
 *
__hay¡ack
, __cÚ¡ *
__ÃedË
)

374 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

378 #ifdeà
__USE_GNU


382 *
	$memmem
 (
__cÚ¡
 *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

383 
__cÚ¡
 *
__ÃedË
, 
size_t
 
__ÃedËËn
)

384 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

388 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

389 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

390 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

391 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

392 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

393 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

397 
__BEGIN_NAMESPACE_STD


399 
size_t
 
	$¡¾’
 (
__cÚ¡
 *
__s
)

400 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

401 
__END_NAMESPACE_STD


403 #ifdef 
__USE_XOPEN2K8


406 
size_t
 
	$¡ºËn
 (
__cÚ¡
 *
__¡ršg
, 
size_t
 
__maxËn
)

407 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

411 
__BEGIN_NAMESPACE_STD


413 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

414 
__END_NAMESPACE_STD


415 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_MISC


423 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


426 #ifdeà
__REDIRECT_NTH


427 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

428 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

429 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

431 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

433 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

438 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

439 
__THROW
 
	`__nÚnuÎ
 ((2));

443 #ifdeà
__USE_XOPEN2K8


445 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

451 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

453 #ifdeà
__USE_BSD


455 
	$bcİy
 (
__cÚ¡
 *
__¤c
, *
__de¡
, 
size_t
 
__n
)

456 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

462 
	$bcmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

463 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

466 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


469 *
	`šdex
 (*
__s
, 
__c
)

470 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

471 
__cÚ¡
 *
	`šdex
 (__cÚ¡ *
__s
, 
__c
)

472 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

474 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


475 
__ex‹º_®ways_šlše
 *

476 
	`šdex
 (*
__s
, 
__c
è
__THROW


478  
	`__butš_šdex
 (
__s
, 
__c
);

481 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

482 
	`šdex
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


484  
	`__butš_šdex
 (
__s
, 
__c
);

487 
	}
}

489 *
	$šdex
 (
__cÚ¡
 *
__s
, 
__c
)

490 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


497 *
	`ršdex
 (*
__s
, 
__c
)

498 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

499 
__cÚ¡
 *
	`ršdex
 (__cÚ¡ *
__s
, 
__c
)

500 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

502 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


503 
__ex‹º_®ways_šlše
 *

504 
	`ršdex
 (*
__s
, 
__c
è
__THROW


506  
	`__butš_ršdex
 (
__s
, 
__c
);

509 
__ex‹º_®ways_šlše
 
__cÚ¡
 *

510 
	`ršdex
 (
__cÚ¡
 *
__s
, 
__c
è
__THROW


512  
	`__butš_ršdex
 (
__s
, 
__c
);

515 
	}
}

517 *
	$ršdex
 (
__cÚ¡
 *
__s
, 
__c
)

518 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

523 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

527 #ifdef 
__USE_GNU


528 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 #ifdeà
__GNUC__


530 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

531 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

536 
	$¡rÿ£cmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

537 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

540 
	$¡ºÿ£cmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
, 
size_t
 
__n
)

541 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

544 #ifdef 
__USE_GNU


547 
	$¡rÿ£cmp_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
,

548 
__loÿË_t
 
__loc
)

549 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

551 
	$¡ºÿ£cmp_l
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
,

552 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

553 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

556 #ifdef 
__USE_BSD


559 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

560 
__cÚ¡
 *
__»¡riù
 
__d–im
)

561 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 #ifdef 
__USE_XOPEN2K8


566 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

569 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

570 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

577 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

578 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

579 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

580 
__cÚ¡
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

581 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 #ifdef 
__USE_GNU


586 
	$¡rv”scmp
 (
__cÚ¡
 *
__s1
, __cÚ¡ *
__s2
)

587 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

590 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

593 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

595 #iâdeà
ba£Çme


600 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


601 "C++" *
	$ba£Çme
 (*
__f’ame
)

602 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

603 "C++" 
__cÚ¡
 *
	$ba£Çme
 (
__cÚ¡
 *
__f’ame
)

604 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

606 *
	$ba£Çme
 (
__cÚ¡
 *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

612 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

613 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

614 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ılu¥lus


634 
	~<b™s/¡ršg.h
>

637 
	~<b™s/¡ršg2.h
>

640 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


642 
	~<b™s/¡ršg3.h
>

646 
__END_DECLS


	@/usr/include/sys/stat.h

24 #iâdef 
_SYS_STAT_H


25 
	#_SYS_STAT_H
 1

	)

27 
	~<ã©u»s.h
>

29 
	~<b™s/ty³s.h
>

31 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K
 || defšed 
__USE_MISC
 \

32 || 
defšed
 
	g__USE_ATFILE


33 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


34 
	#__Ãed_time_t


	)

36 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_ATFILE


37 
	#__Ãed_time¥ec


	)

39 
	~<time.h
>

42 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


45 #iâdeà
__dev_t_defšed


46 
__dev_t
 
	tdev_t
;

47 
	#__dev_t_defšed


	)

50 #iâdeà
__gid_t_defšed


51 
__gid_t
 
	tgid_t
;

52 
	#__gid_t_defšed


	)

55 #iâdeà
__šo_t_defšed


56 #iâdeà
__USE_FILE_OFFSET64


57 
__šo_t
 
	tšo_t
;

59 
__šo64_t
 
	tšo_t
;

61 
	#__šo_t_defšed


	)

64 #iâdeà
__mode_t_defšed


65 
__mode_t
 
	tmode_t
;

66 
	#__mode_t_defšed


	)

69 #iâdeà
__Æšk_t_defšed


70 
__Æšk_t
 
	tÆšk_t
;

71 
	#__Æšk_t_defšed


	)

74 #iâdeà
__off_t_defšed


75 #iâdeà
__USE_FILE_OFFSET64


76 
__off_t
 
	toff_t
;

78 
__off64_t
 
	toff_t
;

80 
	#__off_t_defšed


	)

83 #iâdeà
__uid_t_defšed


84 
__uid_t
 
	tuid_t
;

85 
	#__uid_t_defšed


	)

89 #ifdeà
__USE_UNIX98


90 #iâdeà
__blkút_t_defšed


91 #iâdeà
__USE_FILE_OFFSET64


92 
__blkút_t
 
	tblkút_t
;

94 
__blkút64_t
 
	tblkút_t
;

96 
	#__blkút_t_defšed


	)

99 #iâdeà
__blksize_t_defšed


100 
__blksize_t
 
	tblksize_t
;

101 
	#__blksize_t_defšed


	)

105 
	g__BEGIN_DECLS


107 
	~<b™s/¡©.h
>

109 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


110 
	#S_IFMT
 
__S_IFMT


	)

111 
	#S_IFDIR
 
__S_IFDIR


	)

112 
	#S_IFCHR
 
__S_IFCHR


	)

113 
	#S_IFBLK
 
__S_IFBLK


	)

114 
	#S_IFREG
 
__S_IFREG


	)

115 #ifdeà
__S_IFIFO


116 
	#S_IFIFO
 
__S_IFIFO


	)

118 #ifdeà
__S_IFLNK


119 
	#S_IFLNK
 
__S_IFLNK


	)

121 #ià(
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_UNIX98
) \

122 && 
defšed
 
	g__S_IFSOCK


123 
	#S_IFSOCK
 
__S_IFSOCK


	)

129 
	#__S_ISTYPE
(
mode
, 
mask
è(((modeè& 
__S_IFMT
è=ğ(mask))

	)

131 
	#S_ISDIR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFDIR
)

	)

132 
	#S_ISCHR
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFCHR
)

	)

133 
	#S_ISBLK
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFBLK
)

	)

134 
	#S_ISREG
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFREG
)

	)

135 #ifdeà
__S_IFIFO


136 
	#S_ISFIFO
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFIFO
)

	)

138 #ifdeà
__S_IFLNK


139 
	#S_ISLNK
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFLNK
)

	)

142 #ià
defšed
 
__USE_BSD
 && !defšed 
__S_IFLNK


143 
	#S_ISLNK
(
mode
è0

	)

146 #ià(
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K
) \

147 && 
defšed
 
	g__S_IFSOCK


148 
	#S_ISSOCK
(
mode
è
	`__S_ISTYPE
((mode), 
__S_IFSOCK
)

	)

149 #–ià
defšed
 
__USE_XOPEN2K


150 
	#S_ISSOCK
(
mode
è0

	)

157 #ifdef 
__USE_POSIX199309


158 
	#S_TYPEISMQ
(
buf
è
	`__S_TYPEISMQ
(buf)

	)

159 
	#S_TYPEISSEM
(
buf
è
	`__S_TYPEISSEM
(buf)

	)

160 
	#S_TYPEISSHM
(
buf
è
	`__S_TYPEISSHM
(buf)

	)

166 
	#S_ISUID
 
__S_ISUID


	)

167 
	#S_ISGID
 
__S_ISGID


	)

169 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


171 
	#S_ISVTX
 
__S_ISVTX


	)

174 
	#S_IRUSR
 
__S_IREAD


	)

175 
	#S_IWUSR
 
__S_IWRITE


	)

176 
	#S_IXUSR
 
__S_IEXEC


	)

178 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

180 #ià
defšed
 
__USE_MISC
 && defšed 
__USE_BSD


181 
	#S_IREAD
 
S_IRUSR


	)

182 
	#S_IWRITE
 
S_IWUSR


	)

183 
	#S_IEXEC
 
S_IXUSR


	)

186 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

187 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

188 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

190 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

192 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

193 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

194 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

196 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

199 #ifdef 
__USE_BSD


201 
	#ACCESSPERMS
 (
S_IRWXU
|
S_IRWXG
|
S_IRWXO
è

	)

202 
	#ALLPERMS
 (
S_ISUID
|
S_ISGID
|
S_ISVTX
|
S_IRWXU
|
S_IRWXG
|
S_IRWXO
)

	)

203 
	#DEFFILEMODE
 (
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH
)

	)

205 
	#S_BLKSIZE
 512

	)

209 #iâdeà
__USE_FILE_OFFSET64


211 
	$¡©
 (
__cÚ¡
 *
__»¡riù
 
__fe
,

212 
¡©
 *
__»¡riù
 
__buf
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

216 
	$f¡©
 (
__fd
, 
¡©
 *
__buf
è
__THROW
 
	`__nÚnuÎ
 ((2));

218 #ifdeà
__REDIRECT_NTH


219 
	`__REDIRECT_NTH
 (
¡©
, (
__cÚ¡
 *
__»¡riù
 
__fe
,

220 
¡©
 *
__»¡riù
 
__buf
), 
¡©64
)

221 
	`__nÚnuÎ
 ((1, 2));

222 
	`__REDIRECT_NTH
 (
f¡©
, (
__fd
, 
¡©
 *
__buf
), 
f¡©64
)

223 
	`__nÚnuÎ
 ((2));

225 
	#¡©
 
¡©64


	)

226 
	#f¡©
 
f¡©64


	)

229 #ifdeà
__USE_LARGEFILE64


230 
	$¡©64
 (
__cÚ¡
 *
__»¡riù
 
__fe
,

231 
¡©64
 *
__»¡riù
 
__buf
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

232 
	$f¡©64
 (
__fd
, 
¡©64
 *
__buf
è
__THROW
 
	`__nÚnuÎ
 ((2));

235 #ifdeà
__USE_ATFILE


239 #iâdeà
__USE_FILE_OFFSET64


240 
	$f¡©©
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fe
,

241 
¡©
 *
__»¡riù
 
__buf
, 
__æag
)

242 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

244 #ifdeà
__REDIRECT_NTH


245 
	`__REDIRECT_NTH
 (
f¡©©
, (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fe
,

246 
¡©
 *
__»¡riù
 
__buf
,

247 
__æag
),

248 
f¡©©64
è
	`__nÚnuÎ
 ((2, 3));

250 
	#f¡©©
 
f¡©©64


	)

254 #ifdeà
__USE_LARGEFILE64


255 
	$f¡©©64
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fe
,

256 
¡©64
 *
__»¡riù
 
__buf
, 
__æag
)

257 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

261 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


262 #iâdeà
__USE_FILE_OFFSET64


265 
	$l¡©
 (
__cÚ¡
 *
__»¡riù
 
__fe
,

266 
¡©
 *
__»¡riù
 
__buf
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

268 #ifdeà
__REDIRECT_NTH


269 
	`__REDIRECT_NTH
 (
l¡©
,

270 (
__cÚ¡
 *
__»¡riù
 
__fe
,

271 
¡©
 *
__»¡riù
 
__buf
), 
l¡©64
)

272 
	`__nÚnuÎ
 ((1, 2));

274 
	#l¡©
 
l¡©64


	)

277 #ifdeà
__USE_LARGEFILE64


278 
	$l¡©64
 (
__cÚ¡
 *
__»¡riù
 
__fe
,

279 
¡©64
 *
__»¡riù
 
__buf
)

280 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

286 
	$chmod
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
)

287 
__THROW
 
	`__nÚnuÎ
 ((1));

289 #ifdeà
__USE_BSD


293 
	$lchmod
 (
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
)

294 
__THROW
 
	`__nÚnuÎ
 ((1));

298 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


299 
	$fchmod
 (
__fd
, 
__mode_t
 
__mode
è
__THROW
;

302 #ifdeà
__USE_ATFILE


305 
	$fchmod©
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__mode_t
 
__mode
,

306 
__æag
)

307 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

314 
__mode_t
 
	$umask
 (
__mode_t
 
__mask
è
__THROW
;

316 #ifdef 
__USE_GNU


319 
__mode_t
 
	$g‘umask
 (è
__THROW
;

323 
	$mkdœ
 (
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
)

324 
__THROW
 
	`__nÚnuÎ
 ((1));

326 #ifdeà
__USE_ATFILE


330 
	$mkdœ©
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
)

331 
__THROW
 
	`__nÚnuÎ
 ((2));

337 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


338 
	$mknod
 (
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
, 
__dev_t
 
__dev
)

339 
__THROW
 
	`__nÚnuÎ
 ((1));

341 #ifdeà
__USE_ATFILE


345 
	$mknod©
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
,

346 
__dev_t
 
__dev
è
__THROW
 
	`__nÚnuÎ
 ((2));

352 
	$mkfifo
 (
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
)

353 
__THROW
 
	`__nÚnuÎ
 ((1));

355 #ifdeà
__USE_ATFILE


359 
	$mkfifßt
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
)

360 
__THROW
 
	`__nÚnuÎ
 ((2));

363 #ifdeà
__USE_ATFILE


366 
	$utim’§t
 (
__fd
, 
__cÚ¡
 *
__·th
,

367 
__cÚ¡
 
time¥ec
 
__times
[2],

368 
__æags
)

369 
__THROW
 
	`__nÚnuÎ
 ((2));

372 #ifdeà
__USE_XOPEN2K8


374 
	$futim’s
 (
__fd
, 
__cÚ¡
 
time¥ec
 
__times
[2]è
__THROW
;

392 #iâdeà
_STAT_VER


393 
	#_STAT_VER
 0

	)

395 #iâdeà
_MKNOD_VER


396 
	#_MKNOD_VER
 0

	)

400 #iâdeà
__USE_FILE_OFFSET64


401 
	$__fx¡©
 (
__v”
, 
__fdes
, 
¡©
 *
__¡©_buf
)

402 
__THROW
 
	`__nÚnuÎ
 ((3));

403 
	$__x¡©
 (
__v”
, 
__cÚ¡
 *
__f’ame
,

404 
¡©
 *
__¡©_buf
è
__THROW
 
	`__nÚnuÎ
 ((2, 3));

405 
	$__lx¡©
 (
__v”
, 
__cÚ¡
 *
__f’ame
,

406 
¡©
 *
__¡©_buf
è
__THROW
 
	`__nÚnuÎ
 ((2, 3));

407 
	$__fx¡©©
 (
__v”
, 
__fdes
, 
__cÚ¡
 *
__f’ame
,

408 
¡©
 *
__¡©_buf
, 
__æag
)

409 
__THROW
 
	`__nÚnuÎ
 ((3, 4));

411 #ifdeà
__REDIRECT_NTH


412 
	`__REDIRECT_NTH
 (
__fx¡©
, (
__v”
, 
__fdes
,

413 
¡©
 *
__¡©_buf
), 
__fx¡©64
)

414 
	`__nÚnuÎ
 ((3));

415 
	`__REDIRECT_NTH
 (
__x¡©
, (
__v”
, 
__cÚ¡
 *
__f’ame
,

416 
¡©
 *
__¡©_buf
), 
__x¡©64
)

417 
	`__nÚnuÎ
 ((2, 3));

418 
	`__REDIRECT_NTH
 (
__lx¡©
, (
__v”
, 
__cÚ¡
 *
__f’ame
,

419 
¡©
 *
__¡©_buf
), 
__lx¡©64
)

420 
	`__nÚnuÎ
 ((2, 3));

421 
	`__REDIRECT_NTH
 (
__fx¡©©
, (
__v”
, 
__fdes
,

422 
__cÚ¡
 *
__f’ame
,

423 
¡©
 *
__¡©_buf
, 
__æag
),

424 
__fx¡©©64
è
	`__nÚnuÎ
 ((3, 4));

427 
	#__fx¡©
 
__fx¡©64


	)

428 
	#__x¡©
 
__x¡©64


	)

429 
	#__lx¡©
 
__lx¡©64


	)

433 #ifdeà
__USE_LARGEFILE64


434 
	$__fx¡©64
 (
__v”
, 
__fdes
, 
¡©64
 *
__¡©_buf
)

435 
__THROW
 
	`__nÚnuÎ
 ((3));

436 
	$__x¡©64
 (
__v”
, 
__cÚ¡
 *
__f’ame
,

437 
¡©64
 *
__¡©_buf
è
__THROW
 
	`__nÚnuÎ
 ((2, 3));

438 
	$__lx¡©64
 (
__v”
, 
__cÚ¡
 *
__f’ame
,

439 
¡©64
 *
__¡©_buf
è
__THROW
 
	`__nÚnuÎ
 ((2, 3));

440 
	$__fx¡©©64
 (
__v”
, 
__fdes
, 
__cÚ¡
 *
__f’ame
,

441 
¡©64
 *
__¡©_buf
, 
__æag
)

442 
__THROW
 
	`__nÚnuÎ
 ((3, 4));

444 
	$__xmknod
 (
__v”
, 
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
,

445 
__dev_t
 *
__dev
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

447 
	$__xmknod©
 (
__v”
, 
__fd
, 
__cÚ¡
 *
__·th
,

448 
__mode_t
 
__mode
, 
__dev_t
 *
__dev
)

449 
__THROW
 
	`__nÚnuÎ
 ((3, 5));

451 #ià
defšed
 
__GNUC__
 && __GNUC__ >ğ2 && defšed 
__USE_EXTERN_INLINES


454 
__ex‹º_šlše
 

455 
	`__NTH
 (
	$¡©
 (
__cÚ¡
 *
__·th
, 
¡©
 *
__¡©buf
))

457  
	`__x¡©
 (
_STAT_VER
, 
__·th
, 
__¡©buf
);

458 
	}
}

460 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


461 
__ex‹º_šlše
 

462 
__NTH
 (
	$l¡©
 (
__cÚ¡
 *
__·th
, 
¡©
 *
__¡©buf
))

464  
	`__lx¡©
 (
_STAT_VER
, 
__·th
, 
__¡©buf
);

465 
	}
}

468 
__ex‹º_šlše
 

469 
__NTH
 (
	$f¡©
 (
__fd
, 
¡©
 *
__¡©buf
))

471  
	`__fx¡©
 (
_STAT_VER
, 
__fd
, 
__¡©buf
);

472 
	}
}

474 #ifdeà
__USE_ATFILE


475 
__ex‹º_šlše
 

476 
__NTH
 (
	$f¡©©
 (
__fd
, 
__cÚ¡
 *
__f’ame
, 
¡©
 *
__¡©buf
,

477 
__æag
))

479  
	`__fx¡©©
 (
_STAT_VER
, 
__fd
, 
__f’ame
, 
__¡©buf
, 
__æag
);

480 
	}
}

483 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_BSD


484 
__ex‹º_šlše
 

485 
__NTH
 (
	$mknod
 (
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
, 
__dev_t
 
__dev
))

487  
	`__xmknod
 (
_MKNOD_VER
, 
__·th
, 
__mode
, &
__dev
);

488 
	}
}

491 #ifdeà
__USE_ATFILE


492 
__ex‹º_šlše
 

493 
__NTH
 (
	$mknod©
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__mode_t
 
__mode
,

494 
__dev_t
 
__dev
))

496  
	`__xmknod©
 (
_MKNOD_VER
, 
__fd
, 
__·th
, 
__mode
, &
__dev
);

497 
	}
}

500 #ià
defšed
 
__USE_LARGEFILE64
 \

501 && (! 
defšed
 
	g__USE_FILE_OFFSET64
 \

502 || (
defšed
 
	g__REDIRECT_NTH
 && defšed 
	g__OPTIMIZE__
))

503 
__ex‹º_šlše
 

504 
__NTH
 (
	$¡©64
 (
__cÚ¡
 *
__·th
, 
¡©64
 *
__¡©buf
))

506  
	`__x¡©64
 (
_STAT_VER
, 
__·th
, 
__¡©buf
);

507 
	}
}

509 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


510 
__ex‹º_šlše
 

511 
__NTH
 (
	$l¡©64
 (
__cÚ¡
 *
__·th
, 
¡©64
 *
__¡©buf
))

513  
	`__lx¡©64
 (
_STAT_VER
, 
__·th
, 
__¡©buf
);

514 
	}
}

517 
__ex‹º_šlše
 

518 
__NTH
 (
	$f¡©64
 (
__fd
, 
¡©64
 *
__¡©buf
))

520  
	`__fx¡©64
 (
_STAT_VER
, 
__fd
, 
__¡©buf
);

521 
	}
}

523 #ifdeà
__USE_ATFILE


524 
__ex‹º_šlše
 

525 
__NTH
 (
	$f¡©©64
 (
__fd
, 
__cÚ¡
 *
__f’ame
, 
¡©64
 *
__¡©buf
,

526 
__æag
))

528  
	`__fx¡©©64
 (
_STAT_VER
, 
__fd
, 
__f’ame
, 
__¡©buf
, 
__æag
);

529 
	}
}

536 
	g__END_DECLS


	@/usr/include/sys/types.h

23 #iâdef 
_SYS_TYPES_H


24 
	#_SYS_TYPES_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


30 
	~<b™s/ty³s.h
>

32 #ifdef 
__USE_BSD


33 #iâdeà
__u_ch¬_defšed


34 
__u_ch¬
 
	tu_ch¬
;

35 
__u_shÜt
 
	tu_shÜt
;

36 
__u_št
 
	tu_št
;

37 
__u_lÚg
 
	tu_lÚg
;

38 
__quad_t
 
	tquad_t
;

39 
__u_quad_t
 
	tu_quad_t
;

40 
__fsid_t
 
	tfsid_t
;

41 
	#__u_ch¬_defšed


	)

45 
__loff_t
 
	tloff_t
;

47 #iâdeà
__šo_t_defšed


48 #iâdeà
__USE_FILE_OFFSET64


49 
__šo_t
 
	tšo_t
;

51 
__šo64_t
 
	tšo_t
;

53 
	#__šo_t_defšed


	)

55 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__šo64_t_defšed


56 
__šo64_t
 
	tšo64_t
;

57 
	#__šo64_t_defšed


	)

60 #iâdeà
__dev_t_defšed


61 
__dev_t
 
	tdev_t
;

62 
	#__dev_t_defšed


	)

65 #iâdeà
__gid_t_defšed


66 
__gid_t
 
	tgid_t
;

67 
	#__gid_t_defšed


	)

70 #iâdeà
__mode_t_defšed


71 
__mode_t
 
	tmode_t
;

72 
	#__mode_t_defšed


	)

75 #iâdeà
__Æšk_t_defšed


76 
__Æšk_t
 
	tÆšk_t
;

77 
	#__Æšk_t_defšed


	)

80 #iâdeà
__uid_t_defšed


81 
__uid_t
 
	tuid_t
;

82 
	#__uid_t_defšed


	)

85 #iâdeà
__off_t_defšed


86 #iâdeà
__USE_FILE_OFFSET64


87 
__off_t
 
	toff_t
;

89 
__off64_t
 
	toff_t
;

91 
	#__off_t_defšed


	)

93 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


94 
__off64_t
 
	toff64_t
;

95 
	#__off64_t_defšed


	)

98 #iâdeà
__pid_t_defšed


99 
__pid_t
 
	tpid_t
;

100 
	#__pid_t_defšed


	)

103 #ià(
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
) \

104 && !
defšed
 
__id_t_defšed


105 
__id_t
 
	tid_t
;

106 
	#__id_t_defšed


	)

109 #iâdeà
__ssize_t_defšed


110 
__ssize_t
 
	tssize_t
;

111 
	#__ssize_t_defšed


	)

114 #ifdef 
__USE_BSD


115 #iâdeà
__daddr_t_defšed


116 
__daddr_t
 
	tdaddr_t
;

117 
__ÿddr_t
 
	tÿddr_t
;

118 
	#__daddr_t_defšed


	)

122 #ià(
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN
è&& !defšed 
__key_t_defšed


123 
__key_t
 
	tkey_t
;

124 
	#__key_t_defšed


	)

127 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


128 
	#__Ãed_şock_t


	)

130 
	#__Ãed_time_t


	)

131 
	#__Ãed_tim”_t


	)

132 
	#__Ãed_şockid_t


	)

133 
	~<time.h
>

135 #ifdeà
__USE_XOPEN


136 #iâdeà
__u£cÚds_t_defšed


137 
__u£cÚds_t
 
	tu£cÚds_t
;

138 
	#__u£cÚds_t_defšed


	)

140 #iâdeà
__su£cÚds_t_defšed


141 
__su£cÚds_t
 
	tsu£cÚds_t
;

142 
	#__su£cÚds_t_defšed


	)

146 
	#__Ãed_size_t


	)

147 
	~<¡ddef.h
>

149 #ifdeà
__USE_MISC


151 
	tulÚg
;

152 
	tushÜt
;

153 
	tušt
;

158 #ià!
__GNUC_PREREQ
 (2, 7)

161 #iâdeà
__št8_t_defšed


162 
	#__št8_t_defšed


	)

163 
	tšt8_t
;

164 
	tšt16_t
;

165 
	tšt32_t
;

166 #ià
__WORDSIZE
 == 64

167 
	tšt64_t
;

168 #–ià
__GLIBC_HAVE_LONG_LONG


169 
__ex‹nsiÚ__
 
	tšt64_t
;

174 
	tu_št8_t
;

175 
	tu_št16_t
;

176 
	tu_št32_t
;

177 #ià
__WORDSIZE
 == 64

178 
	tu_št64_t
;

179 #–ià
__GLIBC_HAVE_LONG_LONG


180 
__ex‹nsiÚ__
 
	tu_št64_t
;

183 
	t»gi¡”_t
;

188 
	#__štN_t
(
N
, 
MODE
) \

189 ##
	tN
##
	t_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	tMODE
)))

	)

190 
	t__u_štN_t
(
	tN
, 
	tMODE
) \

191 
	tu_št
##
	tN
##
	t_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	tMODE
)))

	)

193 #iâdeà
	t__št8_t_defšed


194 
	t__št8_t_defšed


	)

195 
	t__štN_t
 (8, 
	t__QI__
);

196 
__štN_t
 (16, 
__HI__
);

197 
__štN_t
 (32, 
__SI__
);

198 
__štN_t
 (64, 
__DI__
);

201 
__u_štN_t
 (8, 
__QI__
);

202 
__u_štN_t
 (16, 
__HI__
);

203 
__u_štN_t
 (32, 
__SI__
);

204 
__u_štN_t
 (64, 
__DI__
);

206 
	t»gi¡”_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__wÜd__
)));

212 
	#__BIT_TYPES_DEFINED__
 1

	)

215 #ifdef 
__USE_BSD


217 
	~<’dŸn.h
>

220 
	~<sys/£Ëù.h
>

223 
	~<sys/sysmaüos.h
>

227 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
) \

228 && !
defšed
 
__blksize_t_defšed


229 
__blksize_t
 
	tblksize_t
;

230 
	#__blksize_t_defšed


	)

234 #iâdeà
__USE_FILE_OFFSET64


235 #iâdeà
__blkút_t_defšed


236 
__blkút_t
 
	tblkút_t
;

237 
	#__blkút_t_defšed


	)

239 #iâdeà
__fsblkút_t_defšed


240 
__fsblkút_t
 
	tfsblkút_t
;

241 
	#__fsblkút_t_defšed


	)

243 #iâdeà
__fsfút_t_defšed


244 
__fsfút_t
 
	tfsfút_t
;

245 
	#__fsfút_t_defšed


	)

248 #iâdeà
__blkút_t_defšed


249 
__blkút64_t
 
	tblkút_t
;

250 
	#__blkút_t_defšed


	)

252 #iâdeà
__fsblkút_t_defšed


253 
__fsblkút64_t
 
	tfsblkút_t
;

254 
	#__fsblkút_t_defšed


	)

256 #iâdeà
__fsfút_t_defšed


257 
__fsfút64_t
 
	tfsfút_t
;

258 
	#__fsfút_t_defšed


	)

262 #ifdeà
__USE_LARGEFILE64


263 
__blkút64_t
 
	tblkút64_t
;

264 
__fsblkút64_t
 
	tfsblkút64_t
;

265 
__fsfút64_t
 
	tfsfút64_t
;

270 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


271 
	~<b™s/±h»adty³s.h
>

274 
	g__END_DECLS


	@/usr/include/unistd.h

23 #iâdef 
_UNISTD_H


24 
	#_UNISTD_H
 1

	)

26 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


33 #ifdeà
__USE_XOPEN2K8


35 
	#_POSIX_VERSION
 200809L

	)

36 #–ià
defšed
 
__USE_XOPEN2K


38 
	#_POSIX_VERSION
 200112L

	)

39 #–ià
defšed
 
__USE_POSIX199506


41 
	#_POSIX_VERSION
 199506L

	)

42 #–ià
defšed
 
__USE_POSIX199309


44 
	#_POSIX_VERSION
 199309L

	)

47 
	#_POSIX_VERSION
 199009L

	)

53 #ifdeà
__USE_XOPEN2K8


54 
	#__POSIX2_THIS_VERSION
 200809L

	)

56 #–ià
defšed
 
__USE_XOPEN2K


58 
	#__POSIX2_THIS_VERSION
 200112L

	)

59 #–ià
defšed
 
__USE_POSIX199506


61 
	#__POSIX2_THIS_VERSION
 199506L

	)

64 
	#__POSIX2_THIS_VERSION
 199209L

	)

68 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

72 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

76 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

80 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

84 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

87 #ifdeà
__USE_XOPEN2K8


88 
	#_XOPEN_VERSION
 700

	)

89 #–ià
defšed
 
__USE_XOPEN2K


90 
	#_XOPEN_VERSION
 600

	)

91 #–ià
defšed
 
__USE_UNIX98


92 
	#_XOPEN_VERSION
 500

	)

94 
	#_XOPEN_VERSION
 4

	)

98 
	#_XOPEN_XCU_VERSION
 4

	)

101 
	#_XOPEN_XPG2
 1

	)

102 
	#_XOPEN_XPG3
 1

	)

103 
	#_XOPEN_XPG4
 1

	)

106 
	#_XOPEN_UNIX
 1

	)

109 
	#_XOPEN_CRYPT
 1

	)

113 
	#_XOPEN_ENH_I18N
 1

	)

116 
	#_XOPEN_LEGACY
 1

	)

203 
	~<b™s/posix_İt.h
>

206 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


207 
	~<b™s/’vœÚm’ts.h
>

211 
	#STDIN_FILENO
 0

	)

212 
	#STDOUT_FILENO
 1

	)

213 
	#STDERR_FILENO
 2

	)

218 
	~<b™s/ty³s.h
>

220 #iâdef 
__ssize_t_defšed


221 
__ssize_t
 
	tssize_t
;

222 
	#__ssize_t_defšed


	)

225 
	#__Ãed_size_t


	)

226 
	#__Ãed_NULL


	)

227 
	~<¡ddef.h
>

229 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


232 #iâdeà
__gid_t_defšed


233 
__gid_t
 
	tgid_t
;

234 
	#__gid_t_defšed


	)

237 #iâdeà
__uid_t_defšed


238 
__uid_t
 
	tuid_t
;

239 
	#__uid_t_defšed


	)

242 #iâdeà
__off_t_defšed


243 #iâdeà
__USE_FILE_OFFSET64


244 
__off_t
 
	toff_t
;

246 
__off64_t
 
	toff_t
;

248 
	#__off_t_defšed


	)

250 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


251 
__off64_t
 
	toff64_t
;

252 
	#__off64_t_defšed


	)

255 #iâdeà
__u£cÚds_t_defšed


256 
__u£cÚds_t
 
	tu£cÚds_t
;

257 
	#__u£cÚds_t_defšed


	)

260 #iâdeà
__pid_t_defšed


261 
__pid_t
 
	tpid_t
;

262 
	#__pid_t_defšed


	)

266 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


267 #iâdeà
__šŒ_t_defšed


268 
__šŒ_t
 
	tšŒ_t
;

269 
	#__šŒ_t_defšed


	)

273 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN


274 #iâdeà
__sockËn_t_defšed


275 
__sockËn_t
 
	tsockËn_t
;

276 
	#__sockËn_t_defšed


	)

282 
	#R_OK
 4

	)

283 
	#W_OK
 2

	)

284 
	#X_OK
 1

	)

285 
	#F_OK
 0

	)

288 
	$acûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

290 #ifdeà
__USE_GNU


293 
	$euidacûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
)

294 
__THROW
 
	`__nÚnuÎ
 ((1));

297 
	$—cûss
 (
__cÚ¡
 *
__Çme
, 
__ty³
)

298 
__THROW
 
	`__nÚnuÎ
 ((1));

301 #ifdeà
__USE_ATFILE


305 
	$çcûs§t
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__ty³
, 
__æag
)

306 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

311 #iâdef 
_STDIO_H


312 
	#SEEK_SET
 0

	)

313 
	#SEEK_CUR
 1

	)

314 
	#SEEK_END
 2

	)

317 #ià
defšed
 
__USE_BSD
 && !defšed 
L_SET


319 
	#L_SET
 
SEEK_SET


	)

320 
	#L_INCR
 
SEEK_CUR


	)

321 
	#L_XTND
 
SEEK_END


	)

330 #iâdeà
__USE_FILE_OFFSET64


331 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

333 #ifdeà
__REDIRECT_NTH


334 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

335 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

336 
l£ek64
);

338 
	#l£ek
 
l£ek64


	)

341 #ifdeà
__USE_LARGEFILE64


342 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

343 
__THROW
;

350 
	`şo£
 (
__fd
);

357 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

363 
ssize_t
 
	$wr™e
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
è
__wur
;

365 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


366 #iâdeà
__USE_FILE_OFFSET64


373 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

374 
__off_t
 
__off£t
è
__wur
;

381 
ssize_t
 
	$pwr™e
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
,

382 
__off_t
 
__off£t
è
__wur
;

384 #ifdeà
__REDIRECT


385 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

386 
__off64_t
 
__off£t
),

387 
´—d64
è
__wur
;

388 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, 
__cÚ¡
 *
__buf
,

389 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

390 
pwr™e64
è
__wur
;

392 
	#´—d
 
´—d64


	)

393 
	#pwr™e
 
pwr™e64


	)

397 #ifdeà
__USE_LARGEFILE64


401 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

402 
__off64_t
 
__off£t
è
__wur
;

405 
ssize_t
 
	$pwr™e64
 (
__fd
, 
__cÚ¡
 *
__buf
, 
size_t
 
__n
,

406 
__off64_t
 
__off£t
è
__wur
;

414 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

416 #ifdeà
__USE_GNU


419 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

429 
	$®¬m
 (
__£cÚds
è
__THROW
;

441 
	`¦“p
 (
__£cÚds
);

443 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

444 || 
defšed
 
__USE_BSD


449 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

450 
__THROW
;

457 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

466 
	`·u£
 ();

470 
	$chown
 (
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

471 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

473 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


475 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

480 
	$lchown
 (
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

481 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

485 #ifdeà
__USE_ATFILE


488 
	$fchowÇt
 (
__fd
, 
__cÚ¡
 *
__fe
, 
__uid_t
 
__owÃr
,

489 
__gid_t
 
__group
, 
__æag
)

490 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

494 
	$chdœ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

496 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


498 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

508 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

510 #ifdef 
__USE_GNU


514 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

517 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

518 || 
defšed
 
__USE_BSD


522 *
	$g‘wd
 (*
__buf
)

523 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

528 
	$dup
 (
__fd
è
__THROW
 
__wur
;

531 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

533 #ifdeà
__USE_GNU


536 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

540 **
__’vœÚ
;

541 #ifdeà
__USE_GNU


542 **
’vœÚ
;

548 
	$execve
 (
__cÚ¡
 *
__·th
, *__cÚ¡ 
__¬gv
[],

549 *
__cÚ¡
 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

551 #ifdeà
__USE_XOPEN2K8


554 
	$ãxecve
 (
__fd
, *
__cÚ¡
 
__¬gv
[], *__cÚ¡ 
__’vp
[])

555 
__THROW
 
	`__nÚnuÎ
 ((2));

560 
	$execv
 (
__cÚ¡
 *
__·th
, *__cÚ¡ 
__¬gv
[])

561 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

565 
	$exeşe
 (
__cÚ¡
 *
__·th
, __cÚ¡ *
__¬g
, ...)

566 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

570 
	$exeş
 (
__cÚ¡
 *
__·th
, __cÚ¡ *
__¬g
, ...)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

575 
	$execvp
 (
__cÚ¡
 *
__fe
, *__cÚ¡ 
__¬gv
[])

576 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$exeşp
 (
__cÚ¡
 *
__fe
, __cÚ¡ *
__¬g
, ...)

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

584 #ifdeà
__USE_GNU


587 
	$execv³
 (
__cÚ¡
 *
__fe
, *__cÚ¡ 
__¬gv
[],

588 *
__cÚ¡
 
__’vp
[])

589 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

593 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


595 
	$niû
 (
__šc
è
__THROW
 
__wur
;

600 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

606 
	~<b™s/cÚâame.h
>

609 
	$·thcÚf
 (
__cÚ¡
 *
__·th
, 
__Çme
)

610 
__THROW
 
	`__nÚnuÎ
 ((1));

613 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

616 
	$syscÚf
 (
__Çme
è
__THROW
;

618 #ifdef 
__USE_POSIX2


620 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

625 
__pid_t
 
	$g‘pid
 (è
__THROW
;

628 
__pid_t
 
	$g‘µid
 (è
__THROW
;

632 #iâdeà
__FAVOR_BSD


633 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

635 #ifdeà
__REDIRECT_NTH


636 
__pid_t
 
	`__REDIRECT_NTH
 (
g‘pg½
, (__pid_ˆ
__pid
), 
__g‘pgid
);

638 
	#g‘pg½
 
__g‘pgid


	)

643 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

644 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


645 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

652 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

654 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


665 #iâdeà
__FAVOR_BSD


669 
	$£g½
 (è
__THROW
;

674 #ifdeà
__REDIRECT_NTH


675 
	`__REDIRECT_NTH
 (
£g½
, (
__pid_t
 
__pid
, __pid_ˆ
__pg½
), 
£gid
);

677 
	#£g½
 
£gid


	)

686 
__pid_t
 
	$£tsid
 (è
__THROW
;

688 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


690 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

694 
__uid_t
 
	$g‘uid
 (è
__THROW
;

697 
__uid_t
 
	$g‘euid
 (è
__THROW
;

700 
__gid_t
 
	$g‘gid
 (è
__THROW
;

703 
__gid_t
 
	$g‘egid
 (è
__THROW
;

708 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

710 #ifdef 
__USE_GNU


712 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

719 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
;

721 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


724 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
;

727 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


729 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
;

736 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
;

738 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


741 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
;

744 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN2K


746 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
;

749 #ifdeà
__USE_GNU


752 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

753 
__THROW
;

757 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

758 
__THROW
;

762 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

763 
__THROW
;

767 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

768 
__THROW
;

775 
__pid_t
 
	$fÜk
 (è
__THROW
;

777 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

778 || 
defšed
 
__USE_BSD


783 
__pid_t
 
	$vfÜk
 (è
__THROW
;

789 *
	$‰yÇme
 (
__fd
è
__THROW
;

793 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

794 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

798 
	$i§‰y
 (
__fd
è
__THROW
;

800 #ià
defšed
 
__USE_BSD
 \

801 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_UNIX98
)

804 
	$‰y¦Ù
 (è
__THROW
;

809 
	$lšk
 (
__cÚ¡
 *
__äom
, __cÚ¡ *
__to
)

810 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

812 #ifdeà
__USE_ATFILE


815 
	$lšk©
 (
__äomfd
, 
__cÚ¡
 *
__äom
, 
__tofd
,

816 
__cÚ¡
 *
__to
, 
__æags
)

817 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

820 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


822 
	$symlšk
 (
__cÚ¡
 *
__äom
, __cÚ¡ *
__to
)

823 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

828 
ssize_t
 
	$»adlšk
 (
__cÚ¡
 *
__»¡riù
 
__·th
,

829 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

830 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

833 #ifdeà
__USE_ATFILE


835 
	$symlšk©
 (
__cÚ¡
 *
__äom
, 
__tofd
,

836 
__cÚ¡
 *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

839 
ssize_t
 
	$»adlšk©
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

840 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

841 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

845 
	$uÆšk
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

847 #ifdeà
__USE_ATFILE


849 
	$uÆšk©
 (
__fd
, 
__cÚ¡
 *
__Çme
, 
__æag
)

850 
__THROW
 
	`__nÚnuÎ
 ((2));

854 
	$rmdœ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

858 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

861 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

868 *
	`g‘logš
 ();

869 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


876 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

879 #ifdef 
__USE_BSD


881 
	$£ogš
 (
__cÚ¡
 *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

885 #ifdef 
__USE_POSIX2


889 
	#__Ãed_g‘İt


	)

890 
	~<g‘İt.h
>

894 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


898 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

902 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

905 
	$£tho¡Çme
 (
__cÚ¡
 *
__Çme
, 
size_t
 
__Ën
)

906 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

910 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

916 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

917 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

918 
	$£tdomašÇme
 (
__cÚ¡
 *
__Çme
, 
size_t
 
__Ën
)

919 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

925 
	$vhªgup
 (è
__THROW
;

928 
	$»voke
 (
__cÚ¡
 *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

936 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

937 
size_t
 
__off£t
, 
__sÿË
)

938 
__THROW
 
	`__nÚnuÎ
 ((1));

944 
	$acù
 (
__cÚ¡
 *
__Çme
è
__THROW
;

948 *
	$g‘u£rsh–l
 (è
__THROW
;

949 
	$’du£rsh–l
 (è
__THROW
;

950 
	$£tu£rsh–l
 (è
__THROW
;

956 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

960 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

963 
	$chroÙ
 (
__cÚ¡
 *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

967 *
	$g‘·ss
 (
__cÚ¡
 *
__´om±
è
	`__nÚnuÎ
 ((1));

971 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


976 
	`fsync
 (
__fd
);

980 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


983 
	`g‘ho¡id
 ();

986 
	$sync
 (è
__THROW
;

989 #ià
defšed
 
__USE_BSD
 || !defšed 
__USE_XOPEN2K


992 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

997 
	$g‘dbËsize
 (è
__THROW
;

1003 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


1006 #iâdeà
__USE_FILE_OFFSET64


1007 
	$Œunÿ‹
 (
__cÚ¡
 *
__fe
, 
__off_t
 
__Ëngth
)

1008 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1010 #ifdeà
__REDIRECT_NTH


1011 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

1012 (
__cÚ¡
 *
__fe
, 
__off64_t
 
__Ëngth
),

1013 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1015 
	#Œunÿ‹
 
Œunÿ‹64


	)

1018 #ifdeà
__USE_LARGEFILE64


1019 
	$Œunÿ‹64
 (
__cÚ¡
 *
__fe
, 
__off64_t
 
__Ëngth
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1025 #iâdeà
__USE_FILE_OFFSET64


1026 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1028 #ifdeà
__REDIRECT_NTH


1029 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1030 
árunÿ‹64
è
__wur
;

1032 
	#árunÿ‹
 
árunÿ‹64


	)

1035 #ifdeà
__USE_LARGEFILE64


1036 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1042 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1043 || 
defšed
 
__USE_MISC


1047 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1053 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1057 #ifdeà
__USE_MISC


1068 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1073 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1085 
	#F_ULOCK
 0

	)

1086 
	#F_LOCK
 1

	)

1087 
	#F_TLOCK
 2

	)

1088 
	#F_TEST
 3

	)

1090 #iâdeà
__USE_FILE_OFFSET64


1091 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1093 #ifdeà
__REDIRECT


1094 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1095 
lockf64
è
__wur
;

1097 
	#lockf
 
lockf64


	)

1100 #ifdeà
__USE_LARGEFILE64


1101 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1106 #ifdeà
__USE_GNU


1111 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1112 (
__ex‹nsiÚ__
 \

1113 ({ 
__»suÉ
; \

1114 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1115 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1116 
__»suÉ
; 
	}
}))

	)

1119 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1122 
fd©async
 (
__fdes
);

1128 #ifdef 
__USE_XOPEN


1130 *
	$üy±
 (
__cÚ¡
 *
__key
, __cÚ¡ *
__§É
)

1131 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1135 
	$’üy±
 (*
__block
, 
__edæag
è
__THROW
 
	`__nÚnuÎ
 ((1));

1142 
	$swab
 (
__cÚ¡
 *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1143 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1149 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


1151 *
	$ù”mid
 (*
__s
è
__THROW
;

1156 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


1157 
	~<b™s/uni¡d.h
>

1160 
__END_DECLS


	@/usr/include/xen/grant_table.h

28 #iâdeà
__XEN_PUBLIC_GRANT_TABLE_H__


29 
	#__XEN_PUBLIC_GRANT_TABLE_H__


	)

31 
	~"x’.h
"

90 
ušt32_t
 
	tg¿Á_»f_t
;

103 #ià
__XEN_INTERFACE_VERSION__
 < 0x0003020a

104 
	#g¿Á_’Œy_v1
 
g¿Á_’Œy


	)

105 
	#g¿Á_’Œy_v1_t
 
g¿Á_’Œy_t


	)

107 
	sg¿Á_’Œy_v1
 {

109 
ušt16_t
 
	mæags
;

111 
domid_t
 
	mdomid
;

116 
ušt32_t
 
	mäame
;

118 
g¿Á_’Œy_v1
 
	tg¿Á_’Œy_v1_t
;

129 
	#GTF_šv®id
 (0U<<0)

	)

130 
	#GTF_³rm™_acûss
 (1U<<0)

	)

131 
	#GTF_acû±_Œªsãr
 (2U<<0)

	)

132 
	#GTF_Œªs™ive
 (3U<<0)

	)

133 
	#GTF_ty³_mask
 (3U<<0)

	)

145 
	#_GTF_»adÚly
 (2)

	)

146 
	#GTF_»adÚly
 (1U<<
_GTF_»adÚly
)

	)

147 
	#_GTF_»adšg
 (3)

	)

148 
	#GTF_»adšg
 (1U<<
_GTF_»adšg
)

	)

149 
	#_GTF_wr™šg
 (4)

	)

150 
	#GTF_wr™šg
 (1U<<
_GTF_wr™šg
)

	)

151 
	#_GTF_PWT
 (5)

	)

152 
	#GTF_PWT
 (1U<<
_GTF_PWT
)

	)

153 
	#_GTF_PCD
 (6)

	)

154 
	#GTF_PCD
 (1U<<
_GTF_PCD
)

	)

155 
	#_GTF_PAT
 (7)

	)

156 
	#GTF_PAT
 (1U<<
_GTF_PAT
)

	)

157 
	#_GTF_sub_·ge
 (8)

	)

158 
	#GTF_sub_·ge
 (1U<<
_GTF_sub_·ge
)

	)

170 
	#_GTF_Œªsãr_comm™‹d
 (2)

	)

171 
	#GTF_Œªsãr_comm™‹d
 (1U<<
_GTF_Œªsãr_comm™‹d
)

	)

172 
	#_GTF_Œªsãr_com¶‘ed
 (3)

	)

173 
	#GTF_Œªsãr_com¶‘ed
 (1U<<
_GTF_Œªsãr_com¶‘ed
)

	)

184 #ià
__XEN_INTERFACE_VERSION__
 >= 0x0003020a

190 
	sg¿Á_’Œy_h—d”
 {

191 
ušt16_t
 
	mæags
;

192 
domid_t
 
	mdomid
;

194 
g¿Á_’Œy_h—d”
 
	tg¿Á_’Œy_h—d”_t
;

199 
	ug¿Á_’Œy_v2
 {

200 
g¿Á_’Œy_h—d”_t
 
	mhdr
;

212 
g¿Á_’Œy_h—d”_t
 
	mhdr
;

213 
ušt32_t
 
	m·d0
;

214 
ušt64_t
 
	mäame
;

215 } 
	mfuÎ_·ge
;

223 
g¿Á_’Œy_h—d”_t
 
	mhdr
;

224 
ušt16_t
 
	m·ge_off
;

225 
ušt16_t
 
	mËngth
;

226 
ušt64_t
 
	mäame
;

227 } 
	msub_·ge
;

239 
g¿Á_’Œy_h—d”_t
 
	mhdr
;

240 
domid_t
 
	mŒªs_domid
;

241 
ušt16_t
 
	m·d0
;

242 
g¿Á_»f_t
 
	mg»f
;

243 } 
	mŒªs™ive
;

245 
ušt32_t
 
	m__¥aûr
[4];

247 
g¿Á_’Œy_v2
 
	tg¿Á_’Œy_v2_t
;

249 
ušt16_t
 
	tg¿Á_¡©us_t
;

260 
ušt32_t
 
	tg¿Á_hªdË_t
;

279 
	#GNTTABOP_m­_g¿Á_»f
 0

	)

280 
	sgÁb_m­_g¿Á_»f
 {

282 
ušt64_t
 
	mho¡_addr
;

283 
ušt32_t
 
	mæags
;

284 
g¿Á_»f_t
 
	m»f
;

285 
domid_t
 
	mdom
;

287 
št16_t
 
	m¡©us
;

288 
g¿Á_hªdË_t
 
	mhªdË
;

289 
ušt64_t
 
	mdev_bus_addr
;

291 
gÁb_m­_g¿Á_»f
 
	tgÁb_m­_g¿Á_»f_t
;

292 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_m­_g¿Á_»f_t
);

305 
	#GNTTABOP_unm­_g¿Á_»f
 1

	)

306 
	sgÁb_unm­_g¿Á_»f
 {

308 
ušt64_t
 
	mho¡_addr
;

309 
ušt64_t
 
	mdev_bus_addr
;

310 
g¿Á_hªdË_t
 
	mhªdË
;

312 
št16_t
 
	m¡©us
;

314 
gÁb_unm­_g¿Á_»f
 
	tgÁb_unm­_g¿Á_»f_t
;

315 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_unm­_g¿Á_»f_t
);

326 
	#GNTTABOP_£tup_bË
 2

	)

327 
	sgÁb_£tup_bË
 {

329 
domid_t
 
	mdom
;

330 
ušt32_t
 
	mÄ_äames
;

332 
št16_t
 
	m¡©us
;

333 
XEN_GUEST_HANDLE
(
ulÚg
è
	mäame_li¡
;

335 
gÁb_£tup_bË
 
	tgÁb_£tup_bË_t
;

336 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_£tup_bË_t
);

342 
	#GNTTABOP_dump_bË
 3

	)

343 
	sgÁb_dump_bË
 {

345 
domid_t
 
	mdom
;

347 
št16_t
 
	m¡©us
;

349 
gÁb_dump_bË
 
	tgÁb_dump_bË_t
;

350 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_dump_bË_t
);

360 
	#GNTTABOP_Œªsãr
 4

	)

361 
	sgÁb_Œªsãr
 {

363 
x’_pâ_t
 
	mmâ
;

364 
domid_t
 
	mdomid
;

365 
g¿Á_»f_t
 
	m»f
;

367 
št16_t
 
	m¡©us
;

369 
gÁb_Œªsãr
 
	tgÁb_Œªsãr_t
;

370 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_Œªsãr_t
);

391 
	#_GNTCOPY_sourû_g»f
 (0)

	)

392 
	#GNTCOPY_sourû_g»f
 (1<<
_GNTCOPY_sourû_g»f
)

	)

393 
	#_GNTCOPY_de¡_g»f
 (1)

	)

394 
	#GNTCOPY_de¡_g»f
 (1<<
_GNTCOPY_de¡_g»f
)

	)

395 
	#_GNTCOPY_ÿn_ç
 (2)

	)

396 
	#GNTCOPY_ÿn_ç
 (1<<
_GNTCOPY_ÿn_ç
)

	)

398 
	#GNTTABOP_cİy
 5

	)

399 
	sgÁb_cİy
 {

403 
g¿Á_»f_t
 
	m»f
;

404 
x’_pâ_t
 
	mgmâ
;

405 } 
	mu
;

406 
domid_t
 
	mdomid
;

407 
ušt16_t
 
	moff£t
;

408 } 
	msourû
, 
	mde¡
;

409 
ušt16_t
 
	mËn
;

410 
ušt16_t
 
	mæags
;

412 
št16_t
 
	m¡©us
;

413 } 
	tgÁb_cİy_t
;

414 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_cİy_t
);

423 
	#GNTTABOP_qu”y_size
 6

	)

424 
	sgÁb_qu”y_size
 {

426 
domid_t
 
	mdom
;

428 
ušt32_t
 
	mÄ_äames
;

429 
ušt32_t
 
	mmax_Ä_äames
;

430 
št16_t
 
	m¡©us
;

432 
gÁb_qu”y_size
 
	tgÁb_qu”y_size_t
;

433 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_qu”y_size_t
);

446 
	#GNTTABOP_unm­_ªd_»¶aû
 7

	)

447 
	sgÁb_unm­_ªd_»¶aû
 {

449 
ušt64_t
 
	mho¡_addr
;

450 
ušt64_t
 
	mÃw_addr
;

451 
g¿Á_hªdË_t
 
	mhªdË
;

453 
št16_t
 
	m¡©us
;

455 
gÁb_unm­_ªd_»¶aû
 
	tgÁb_unm­_ªd_»¶aû_t
;

456 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_unm­_ªd_»¶aû_t
);

458 #ià
__XEN_INTERFACE_VERSION__
 >= 0x0003020a

466 
	#GNTTABOP_£t_v”siÚ
 8

	)

467 
	sgÁb_£t_v”siÚ
 {

469 
ušt32_t
 
	mv”siÚ
;

471 
gÁb_£t_v”siÚ
 
	tgÁb_£t_v”siÚ_t
;

472 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_£t_v”siÚ_t
);

487 
	#GNTTABOP_g‘_¡©us_äames
 9

	)

488 
	sgÁb_g‘_¡©us_äames
 {

490 
ušt32_t
 
	mÄ_äames
;

491 
domid_t
 
	mdom
;

493 
št16_t
 
	m¡©us
;

494 
XEN_GUEST_HANDLE
(
ušt64_t
è
	mäame_li¡
;

496 
gÁb_g‘_¡©us_äames
 
	tgÁb_g‘_¡©us_äames_t
;

497 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_g‘_¡©us_äames_t
);

503 
	#GNTTABOP_g‘_v”siÚ
 10

	)

504 
	sgÁb_g‘_v”siÚ
 {

506 
domid_t
 
	mdom
;

507 
ušt16_t
 
	m·d
;

509 
ušt32_t
 
	mv”siÚ
;

511 
gÁb_g‘_v”siÚ
 
	tgÁb_g‘_v”siÚ_t
;

512 
DEFINE_XEN_GUEST_HANDLE
(
gÁb_g‘_v”siÚ_t
);

520 
	#_GNTMAP_deviû_m­
 (0)

	)

521 
	#GNTMAP_deviû_m­
 (1<<
_GNTMAP_deviû_m­
)

	)

523 
	#_GNTMAP_ho¡_m­
 (1)

	)

524 
	#GNTMAP_ho¡_m­
 (1<<
_GNTMAP_ho¡_m­
)

	)

526 
	#_GNTMAP_»adÚly
 (2)

	)

527 
	#GNTMAP_»adÚly
 (1<<
_GNTMAP_»adÚly
)

	)

533 
	#_GNTMAP_­¶iÿtiÚ_m­
 (3)

	)

534 
	#GNTMAP_­¶iÿtiÚ_m­
 (1<<
_GNTMAP_­¶iÿtiÚ_m­
)

	)

541 
	#_GNTMAP_cÚšs_±e
 (4)

	)

542 
	#GNTMAP_cÚšs_±e
 (1<<
_GNTMAP_cÚšs_±e
)

	)

544 
	#_GNTMAP_ÿn_ç
 (5)

	)

545 
	#GNTMAP_ÿn_ç
 (1<<
_GNTMAP_ÿn_ç
)

	)

551 
	#_GNTMAP_gue¡_ava0
 (16)

	)

552 
	#GNTMAP_gue¡_ava_mask
 ((
ušt32_t
)~0 << 
_GNTMAP_gue¡_ava0
)

	)

557 
	#GNTST_okay
 (0è

	)

558 
	#GNTST_g’”®_”rÜ
 (-1è

	)

559 
	#GNTST_bad_domaš
 (-2è

	)

560 
	#GNTST_bad_gÁ»f
 (-3è

	)

561 
	#GNTST_bad_hªdË
 (-4è

	)

562 
	#GNTST_bad_vœt_addr
 (-5è

	)

563 
	#GNTST_bad_dev_addr
 (-6è

	)

564 
	#GNTST_no_deviû_¥aû
 (-7è

	)

565 
	#GNTST_³rmissiÚ_d’›d
 (-8è

	)

566 
	#GNTST_bad_·ge
 (-9è

	)

567 
	#GNTST_bad_cİy_¬g
 (-10è

	)

568 
	#GNTST_add»ss_too_big
 (-11è

	)

569 
	#GNTST_—gaš
 (-12è

	)

571 
	#GNTTABOP_”rÜ_msgs
 { \

585 }

	)

	@/usr/include/xen/kexec.h

27 #iâdeà
_XEN_PUBLIC_KEXEC_H


28 
	#_XEN_PUBLIC_KEXEC_H


	)

59 
	~"x’.h
"

61 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

62 
	#KEXEC_XEN_NO_PAGES
 17

	)

83 
	#KEXEC_TYPE_DEFAULT
 0

	)

84 
	#KEXEC_TYPE_CRASH
 1

	)

96 
	sx’_kexec_image
 {

97 #ià
defšed
(
__i386__
è|| defšed(
__x86_64__
)

98 
	m·ge_li¡
[
KEXEC_XEN_NO_PAGES
];

100 #ià
defšed
(
__Ÿ64__
)

101 
	m»boÙ_code_bufãr
;

103 
	mšdœeùiÚ_·ge
;

104 
	m¡¬t_add»ss
;

105 } 
	tx’_kexec_image_t
;

112 
	#KEXEC_CMD_kexec
 0

	)

113 
	sx’_kexec_exec
 {

114 
	mty³
;

115 } 
	tx’_kexec_exec_t
;

122 
	#KEXEC_CMD_kexec_lßd
 1

	)

123 
	#KEXEC_CMD_kexec_uÆßd
 2

	)

124 
	sx’_kexec_lßd
 {

125 
	mty³
;

126 
x’_kexec_image_t
 
	mimage
;

127 } 
	tx’_kexec_lßd_t
;

129 
	#KEXEC_RANGE_MA_CRASH
 0

	)

130 
	#KEXEC_RANGE_MA_XEN
 1

	)

131 
	#KEXEC_RANGE_MA_CPU
 2

	)

132 
	#KEXEC_RANGE_MA_XENHEAP
 3

	)

137 
	#KEXEC_RANGE_MA_BOOT_PARAM
 4

	)

139 
	#KEXEC_RANGE_MA_EFI_MEMMAP
 5

	)

141 
	#KEXEC_RANGE_MA_VMCOREINFO
 6

	)

150 
	#KEXEC_CMD_kexec_g‘_¿nge
 3

	)

151 
	sx’_kexec_¿nge
 {

152 
	m¿nge
;

153 
	mÄ
;

154 
	msize
;

155 
	m¡¬t
;

156 } 
	tx’_kexec_¿nge_t
;

	@/usr/include/xen/nmi.h

27 #iâdeà
__XEN_PUBLIC_NMI_H__


28 
	#__XEN_PUBLIC_NMI_H__


	)

30 
	~"x’.h
"

37 
	#_XEN_NMIREASON_io_”rÜ
 0

	)

38 
	#XEN_NMIREASON_io_”rÜ
 (1UL << 
_XEN_NMIREASON_io_”rÜ
)

	)

40 
	#_XEN_NMIREASON_·r™y_”rÜ
 1

	)

41 
	#XEN_NMIREASON_·r™y_”rÜ
 (1UL << 
_XEN_NMIREASON_·r™y_”rÜ
)

	)

43 
	#_XEN_NMIREASON_unknown
 2

	)

44 
	#XEN_NMIREASON_unknown
 (1UL << 
_XEN_NMIREASON_unknown
)

	)

56 
	#XENNMI_»gi¡”_ÿÎback
 0

	)

57 
	sx’nmi_ÿÎback
 {

58 
	mhªdËr_add»ss
;

59 
	m·d
;

61 
x’nmi_ÿÎback
 
	tx’nmi_ÿÎback_t
;

62 
DEFINE_XEN_GUEST_HANDLE
(
x’nmi_ÿÎback_t
);

68 
	#XENNMI_uÄegi¡”_ÿÎback
 1

	)

	@/usr/include/xen/sched.h

27 #iâdeà
__XEN_PUBLIC_SCHED_H__


28 
	#__XEN_PUBLIC_SCHED_H__


	)

30 
	~"ev’t_chªÃl.h
"

51 
	#SCHEDOP_y›ld
 0

	)

60 
	#SCHEDOP_block
 1

	)

66 
	#SCHEDOP_shutdown
 2

	)

67 
	ssched_shutdown
 {

68 
	m»asÚ
;

70 
sched_shutdown
 
	tsched_shutdown_t
;

71 
DEFINE_XEN_GUEST_HANDLE
(
sched_shutdown_t
);

78 
	#SCHEDOP_pŞl
 3

	)

79 
	ssched_pŞl
 {

80 
XEN_GUEST_HANDLE
(
evtchn_pÜt_t
è
	mpÜts
;

81 
	mÄ_pÜts
;

82 
ušt64_t
 
	mtimeout
;

84 
sched_pŞl
 
	tsched_pŞl_t
;

85 
DEFINE_XEN_GUEST_HANDLE
(
sched_pŞl_t
);

93 
	#SCHEDOP_»mÙe_shutdown
 4

	)

94 
	ssched_»mÙe_shutdown
 {

95 
domid_t
 
	mdomaš_id
;

96 
	m»asÚ
;

98 
sched_»mÙe_shutdown
 
	tsched_»mÙe_shutdown_t
;

99 
DEFINE_XEN_GUEST_HANDLE
(
sched_»mÙe_shutdown_t
);

106 
	#SCHEDOP_shutdown_code
 5

	)

116 
	#SCHEDOP_w©chdog
 6

	)

117 
	ssched_w©chdog
 {

118 
ušt32_t
 
	mid
;

119 
ušt32_t
 
	mtimeout
;

121 
sched_w©chdog
 
	tsched_w©chdog_t
;

122 
DEFINE_XEN_GUEST_HANDLE
(
sched_w©chdog_t
);

129 
	#SHUTDOWN_pow”off
 0

	)

130 
	#SHUTDOWN_»boÙ
 1

	)

131 
	#SHUTDOWN_su¥’d
 2

	)

132 
	#SHUTDOWN_üash
 3

	)

133 
	#SHUTDOWN_w©chdog
 4

	)

	@/usr/include/xen/trace.h

26 #iâdeà
__XEN_PUBLIC_TRACE_H__


27 
	#__XEN_PUBLIC_TRACE_H__


	)

29 
	#TRACE_EXTRA_MAX
 7

	)

30 
	#TRACE_EXTRA_SHIFT
 28

	)

33 
	#TRC_CLS_SHIFT
 16

	)

34 
	#TRC_GEN
 0x0001f000

	)

35 
	#TRC_SCHED
 0x0002f000

	)

36 
	#TRC_DOM0OP
 0x0004f000

	)

37 
	#TRC_HVM
 0x0008f000

	)

38 
	#TRC_MEM
 0x0010f000

	)

39 
	#TRC_PV
 0x0020f000

	)

40 
	#TRC_SHADOW
 0x0040f000

	)

41 
	#TRC_PM
 0x0080f000

	)

42 
	#TRC_GUEST
 0x0800f000

	)

43 
	#TRC_ALL
 0x0ffff000

	)

44 
	#TRC_HD_TO_EVENT
(
x
è((x)&0x0fffffff)

	)

45 
	#TRC_HD_CYCLE_FLAG
 (1UL<<31)

	)

46 
	#TRC_HD_INCLUDES_CYCLE_COUNT
(
x
èĞ!!Ğ(xè& 
TRC_HD_CYCLE_FLAG
 ) )

	)

47 
	#TRC_HD_EXTRA
(
x
è(((x)>>
TRACE_EXTRA_SHIFT
)&
TRACE_EXTRA_MAX
)

	)

50 
	#TRC_SUBCLS_SHIFT
 12

	)

53 
	#TRC_HVM_ENTRYEXIT
 0x00081000

	)

54 
	#TRC_HVM_HANDLER
 0x00082000

	)

56 
	#TRC_SCHED_MIN
 0x00021000

	)

57 
	#TRC_SCHED_CLASS
 0x00022000

	)

58 
	#TRC_SCHED_VERBOSE
 0x00028000

	)

61 
	#TRC_LOST_RECORDS
 (
TRC_GEN
 + 1)

	)

62 
	#TRC_TRACE_WRAP_BUFFER
 (
TRC_GEN
 + 2)

	)

63 
	#TRC_TRACE_CPU_CHANGE
 (
TRC_GEN
 + 3)

	)

64 
	#TRC_TRACE_IRQ
 (
TRC_GEN
 + 4)

	)

66 
	#TRC_SCHED_RUNSTATE_CHANGE
 (
TRC_SCHED_MIN
 + 1)

	)

67 
	#TRC_SCHED_CONTINUE_RUNNING
 (
TRC_SCHED_MIN
 + 2)

	)

68 
	#TRC_SCHED_DOM_ADD
 (
TRC_SCHED_VERBOSE
 + 1)

	)

69 
	#TRC_SCHED_DOM_REM
 (
TRC_SCHED_VERBOSE
 + 2)

	)

70 
	#TRC_SCHED_SLEEP
 (
TRC_SCHED_VERBOSE
 + 3)

	)

71 
	#TRC_SCHED_WAKE
 (
TRC_SCHED_VERBOSE
 + 4)

	)

72 
	#TRC_SCHED_YIELD
 (
TRC_SCHED_VERBOSE
 + 5)

	)

73 
	#TRC_SCHED_BLOCK
 (
TRC_SCHED_VERBOSE
 + 6)

	)

74 
	#TRC_SCHED_SHUTDOWN
 (
TRC_SCHED_VERBOSE
 + 7)

	)

75 
	#TRC_SCHED_CTL
 (
TRC_SCHED_VERBOSE
 + 8)

	)

76 
	#TRC_SCHED_ADJDOM
 (
TRC_SCHED_VERBOSE
 + 9)

	)

77 
	#TRC_SCHED_SWITCH
 (
TRC_SCHED_VERBOSE
 + 10)

	)

78 
	#TRC_SCHED_S_TIMER_FN
 (
TRC_SCHED_VERBOSE
 + 11)

	)

79 
	#TRC_SCHED_T_TIMER_FN
 (
TRC_SCHED_VERBOSE
 + 12)

	)

80 
	#TRC_SCHED_DOM_TIMER_FN
 (
TRC_SCHED_VERBOSE
 + 13)

	)

81 
	#TRC_SCHED_SWITCH_INFPREV
 (
TRC_SCHED_VERBOSE
 + 14)

	)

82 
	#TRC_SCHED_SWITCH_INFNEXT
 (
TRC_SCHED_VERBOSE
 + 15)

	)

83 
	#TRC_SCHED_SHUTDOWN_CODE
 (
TRC_SCHED_VERBOSE
 + 16)

	)

85 
	#TRC_MEM_PAGE_GRANT_MAP
 (
TRC_MEM
 + 1)

	)

86 
	#TRC_MEM_PAGE_GRANT_UNMAP
 (
TRC_MEM
 + 2)

	)

87 
	#TRC_MEM_PAGE_GRANT_TRANSFER
 (
TRC_MEM
 + 3)

	)

88 
	#TRC_MEM_SET_P2M_ENTRY
 (
TRC_MEM
 + 4)

	)

89 
	#TRC_MEM_DECREASE_RESERVATION
 (
TRC_MEM
 + 5)

	)

90 
	#TRC_MEM_POD_POPULATE
 (
TRC_MEM
 + 16)

	)

91 
	#TRC_MEM_POD_ZERO_RECLAIM
 (
TRC_MEM
 + 17)

	)

92 
	#TRC_MEM_POD_SUPERPAGE_SPLINTER
 (
TRC_MEM
 + 18)

	)

95 
	#TRC_PV_HYPERCALL
 (
TRC_PV
 + 1)

	)

96 
	#TRC_PV_TRAP
 (
TRC_PV
 + 3)

	)

97 
	#TRC_PV_PAGE_FAULT
 (
TRC_PV
 + 4)

	)

98 
	#TRC_PV_FORCED_INVALID_OP
 (
TRC_PV
 + 5)

	)

99 
	#TRC_PV_EMULATE_PRIVOP
 (
TRC_PV
 + 6)

	)

100 
	#TRC_PV_EMULATE_4GB
 (
TRC_PV
 + 7)

	)

101 
	#TRC_PV_MATH_STATE_RESTORE
 (
TRC_PV
 + 8)

	)

102 
	#TRC_PV_PAGING_FIXUP
 (
TRC_PV
 + 9)

	)

103 
	#TRC_PV_GDT_LDT_MAPPING_FAULT
 (
TRC_PV
 + 10)

	)

104 
	#TRC_PV_PTWR_EMULATION
 (
TRC_PV
 + 11)

	)

105 
	#TRC_PV_PTWR_EMULATION_PAE
 (
TRC_PV
 + 12)

	)

107 
	#TRC_64_FLAG
 (0x100)

	)

109 
	#TRC_SHADOW_NOT_SHADOW
 (
TRC_SHADOW
 + 1)

	)

110 
	#TRC_SHADOW_FAST_PROPAGATE
 (
TRC_SHADOW
 + 2)

	)

111 
	#TRC_SHADOW_FAST_MMIO
 (
TRC_SHADOW
 + 3)

	)

112 
	#TRC_SHADOW_FALSE_FAST_PATH
 (
TRC_SHADOW
 + 4)

	)

113 
	#TRC_SHADOW_MMIO
 (
TRC_SHADOW
 + 5)

	)

114 
	#TRC_SHADOW_FIXUP
 (
TRC_SHADOW
 + 6)

	)

115 
	#TRC_SHADOW_DOMF_DYING
 (
TRC_SHADOW
 + 7)

	)

116 
	#TRC_SHADOW_EMULATE
 (
TRC_SHADOW
 + 8)

	)

117 
	#TRC_SHADOW_EMULATE_UNSHADOW_USER
 (
TRC_SHADOW
 + 9)

	)

118 
	#TRC_SHADOW_EMULATE_UNSHADOW_EVTINJ
 (
TRC_SHADOW
 + 10)

	)

119 
	#TRC_SHADOW_EMULATE_UNSHADOW_UNHANDLED
 (
TRC_SHADOW
 + 11)

	)

120 
	#TRC_SHADOW_WRMAP_BF
 (
TRC_SHADOW
 + 12)

	)

121 
	#TRC_SHADOW_PREALLOC_UNPIN
 (
TRC_SHADOW
 + 13)

	)

122 
	#TRC_SHADOW_RESYNC_FULL
 (
TRC_SHADOW
 + 14)

	)

123 
	#TRC_SHADOW_RESYNC_ONLY
 (
TRC_SHADOW
 + 15)

	)

126 
	#TRC_HVM_VMENTRY
 (
TRC_HVM_ENTRYEXIT
 + 0x01)

	)

127 
	#TRC_HVM_VMEXIT
 (
TRC_HVM_ENTRYEXIT
 + 0x02)

	)

128 
	#TRC_HVM_VMEXIT64
 (
TRC_HVM_ENTRYEXIT
 + 
TRC_64_FLAG
 + 0x02)

	)

129 
	#TRC_HVM_PF_XEN
 (
TRC_HVM_HANDLER
 + 0x01)

	)

130 
	#TRC_HVM_PF_XEN64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x01)

	)

131 
	#TRC_HVM_PF_INJECT
 (
TRC_HVM_HANDLER
 + 0x02)

	)

132 
	#TRC_HVM_PF_INJECT64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x02)

	)

133 
	#TRC_HVM_INJ_EXC
 (
TRC_HVM_HANDLER
 + 0x03)

	)

134 
	#TRC_HVM_INJ_VIRQ
 (
TRC_HVM_HANDLER
 + 0x04)

	)

135 
	#TRC_HVM_REINJ_VIRQ
 (
TRC_HVM_HANDLER
 + 0x05)

	)

136 
	#TRC_HVM_IO_READ
 (
TRC_HVM_HANDLER
 + 0x06)

	)

137 
	#TRC_HVM_IO_WRITE
 (
TRC_HVM_HANDLER
 + 0x07)

	)

138 
	#TRC_HVM_CR_READ
 (
TRC_HVM_HANDLER
 + 0x08)

	)

139 
	#TRC_HVM_CR_READ64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x08)

	)

140 
	#TRC_HVM_CR_WRITE
 (
TRC_HVM_HANDLER
 + 0x09)

	)

141 
	#TRC_HVM_CR_WRITE64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x09)

	)

142 
	#TRC_HVM_DR_READ
 (
TRC_HVM_HANDLER
 + 0x0A)

	)

143 
	#TRC_HVM_DR_WRITE
 (
TRC_HVM_HANDLER
 + 0x0B)

	)

144 
	#TRC_HVM_MSR_READ
 (
TRC_HVM_HANDLER
 + 0x0C)

	)

145 
	#TRC_HVM_MSR_WRITE
 (
TRC_HVM_HANDLER
 + 0x0D)

	)

146 
	#TRC_HVM_CPUID
 (
TRC_HVM_HANDLER
 + 0x0E)

	)

147 
	#TRC_HVM_INTR
 (
TRC_HVM_HANDLER
 + 0x0F)

	)

148 
	#TRC_HVM_NMI
 (
TRC_HVM_HANDLER
 + 0x10)

	)

149 
	#TRC_HVM_SMI
 (
TRC_HVM_HANDLER
 + 0x11)

	)

150 
	#TRC_HVM_VMMCALL
 (
TRC_HVM_HANDLER
 + 0x12)

	)

151 
	#TRC_HVM_HLT
 (
TRC_HVM_HANDLER
 + 0x13)

	)

152 
	#TRC_HVM_INVLPG
 (
TRC_HVM_HANDLER
 + 0x14)

	)

153 
	#TRC_HVM_INVLPG64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x14)

	)

154 
	#TRC_HVM_MCE
 (
TRC_HVM_HANDLER
 + 0x15)

	)

155 
	#TRC_HVM_IOPORT_READ
 (
TRC_HVM_HANDLER
 + 0x16)

	)

156 
	#TRC_HVM_IOMEM_READ
 (
TRC_HVM_HANDLER
 + 0x17)

	)

157 
	#TRC_HVM_CLTS
 (
TRC_HVM_HANDLER
 + 0x18)

	)

158 
	#TRC_HVM_LMSW
 (
TRC_HVM_HANDLER
 + 0x19)

	)

159 
	#TRC_HVM_LMSW64
 (
TRC_HVM_HANDLER
 + 
TRC_64_FLAG
 + 0x19)

	)

160 
	#TRC_HVM_RDTSC
 (
TRC_HVM_HANDLER
 + 0x1a)

	)

161 
	#TRC_HVM_INTR_WINDOW
 (
TRC_HVM_HANDLER
 + 0x20)

	)

162 
	#TRC_HVM_NPF
 (
TRC_HVM_HANDLER
 + 0x21)

	)

164 
	#TRC_HVM_IOPORT_WRITE
 (
TRC_HVM_HANDLER
 + 0x216)

	)

165 
	#TRC_HVM_IOMEM_WRITE
 (
TRC_HVM_HANDLER
 + 0x217)

	)

168 
	#TRC_PM_FREQ
 0x00801000

	)

169 
	#TRC_PM_IDLE
 0x00802000

	)

172 
	#TRC_PM_FREQ_CHANGE
 (
TRC_PM_FREQ
 + 0x01)

	)

173 
	#TRC_PM_IDLE_ENTRY
 (
TRC_PM_IDLE
 + 0x01)

	)

174 
	#TRC_PM_IDLE_EXIT
 (
TRC_PM_IDLE
 + 0x02)

	)

177 
	st_»c
 {

178 
ušt32_t
 
	mev’t
:28;

179 
ušt32_t
 
	mexŒa_u32
:3;

180 
ušt32_t
 
	mcyşes_šşuded
:1;

183 
ušt32_t
 
	mcyşes_lo
, 
	mcyşes_hi
;

184 
ušt32_t
 
	mexŒa_u32
[7];

185 } 
	mcyşes
;

187 
ušt32_t
 
	mexŒa_u32
[7];

188 } 
	mnocyşes
;

189 } 
	mu
;

196 
	st_buf
 {

205 
ušt32_t
 
	mcÚs
;

206 
ušt32_t
 
	m´od
;

214 
	st_šfo
 {

215 
ušt16_t
 
	mtbuf_size
;

216 
ušt16_t
 
	mmâ_off£t
[];

	@/usr/include/xen/version.h

28 #iâdeà
__XEN_PUBLIC_VERSION_H__


29 
	#__XEN_PUBLIC_VERSION_H__


	)

34 
	#XENVER_v”siÚ
 0

	)

37 
	#XENVER_exŒav”siÚ
 1

	)

38 
	tx’_exŒav”siÚ_t
[16];

39 
	#XEN_EXTRAVERSION_LEN
 ((
x’_exŒav”siÚ_t
))

	)

42 
	#XENVER_compe_šfo
 2

	)

43 
	sx’_compe_šfo
 {

44 
	mcomp”
[64];

45 
	mcompe_by
[16];

46 
	mcompe_domaš
[32];

47 
	mcompe_d©e
[32];

49 
x’_compe_šfo
 
	tx’_compe_šfo_t
;

51 
	#XENVER_ÿ·b™›s
 3

	)

52 
	tx’_ÿ·b™›s_šfo_t
[1024];

53 
	#XEN_CAPABILITIES_INFO_LEN
 ((
x’_ÿ·b™›s_šfo_t
))

	)

55 
	#XENVER_chªge£t
 4

	)

56 
	tx’_chªge£t_šfo_t
[64];

57 
	#XEN_CHANGESET_INFO_LEN
 ((
x’_chªge£t_šfo_t
))

	)

59 
	#XENVER_¶©fÜm_·¿m‘”s
 5

	)

60 
	sx’_¶©fÜm_·¿m‘”s
 {

61 
	mvœt_¡¬t
;

63 
x’_¶©fÜm_·¿m‘”s
 
	tx’_¶©fÜm_·¿m‘”s_t
;

65 
	#XENVER_g‘_ã©u»s
 6

	)

66 
	sx’_ã©u»_šfo
 {

67 
	msubm­_idx
;

68 
ušt32_t
 
	msubm­
;

70 
x’_ã©u»_šfo
 
	tx’_ã©u»_šfo_t
;

73 
	~"ã©u»s.h
"

76 
	#XENVER_·gesize
 7

	)

79 
	#XENVER_gue¡_hªdË
 8

	)

81 
	#XENVER_commªdlše
 9

	)

82 
	tx’_commªdlše_t
[1024];

	@/usr/include/xen/xenoprof.h

29 #iâdeà
__XEN_PUBLIC_XENOPROF_H__


30 
	#__XEN_PUBLIC_XENOPROF_H__


	)

32 
	~"x’.h
"

37 
	#XENOPROF_š™
 0

	)

38 
	#XENOPROF_»£t_aùive_li¡
 1

	)

39 
	#XENOPROF_»£t_·ssive_li¡
 2

	)

40 
	#XENOPROF_£t_aùive
 3

	)

41 
	#XENOPROF_£t_·ssive
 4

	)

42 
	#XENOPROF_»£rve_couÁ”s
 5

	)

43 
	#XENOPROF_couÁ”
 6

	)

44 
	#XENOPROF_£tup_ev’ts
 7

	)

45 
	#XENOPROF_’abË_vœq
 8

	)

46 
	#XENOPROF_¡¬t
 9

	)

47 
	#XENOPROF_¡İ
 10

	)

48 
	#XENOPROF_di§bË_vœq
 11

	)

49 
	#XENOPROF_»Ëa£_couÁ”s
 12

	)

50 
	#XENOPROF_shutdown
 13

	)

51 
	#XENOPROF_g‘_bufãr
 14

	)

52 
	#XENOPROF_£t_backŒaû
 15

	)

55 
	#XENOPROF_g‘_ibs_ÿps
 16

	)

56 
	#XENOPROF_ibs_couÁ”
 17

	)

57 
	#XENOPROF_Ï¡_İ
 17

	)

59 
	#MAX_OPROF_EVENTS
 32

	)

60 
	#MAX_OPROF_DOMAINS
 25

	)

61 
	#XENOPROF_CPU_TYPE_SIZE
 64

	)

64 
	sev’t_log
 {

65 
ušt64_t
 
	me
;

66 
ušt8_t
 
	mmode
;

67 
ušt8_t
 
	mev’t
;

71 
	#XENOPROF_ESCAPE_CODE
 ~0UL

	)

73 
	#XENOPROF_TRACE_BEGIN
 1

	)

76 
	sx’İrof_buf
 {

77 
ušt32_t
 
	mev’t_h—d
;

78 
ušt32_t
 
	mev’t_
;

79 
ušt32_t
 
	mev’t_size
;

80 
ušt32_t
 
	mvıu_id
;

81 
ušt64_t
 
	mx’_§m¶es
;

82 
ušt64_t
 
	mk”Ãl_§m¶es
;

83 
ušt64_t
 
	mu£r_§m¶es
;

84 
ušt64_t
 
	mlo¡_§m¶es
;

85 
ev’t_log
 
	mev’t_log
[1];

87 #iâdeà
__XEN__


88 
x’İrof_buf
 
	tx’İrof_buf_t
;

89 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_buf_t
);

92 
	sx’İrof_š™
 {

93 
št32_t
 
	mnum_ev’ts
;

94 
št32_t
 
	mis_´im¬y
;

95 
	mıu_ty³
[
XENOPROF_CPU_TYPE_SIZE
];

97 
x’İrof_š™
 
	tx’İrof_š™_t
;

98 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_š™_t
);

100 
	sx’İrof_g‘_bufãr
 {

101 
št32_t
 
	mmax_§m¶es
;

102 
št32_t
 
	mnbuf
;

103 
št32_t
 
	mbufsize
;

104 
ušt64_t
 
	mbuf_gmaddr
;

106 
x’İrof_g‘_bufãr
 
	tx’İrof_g‘_bufãr_t
;

107 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_g‘_bufãr_t
);

109 
	sx’İrof_couÁ”
 {

110 
ušt32_t
 
	mšd
;

111 
ušt64_t
 
	mcouÁ
;

112 
ušt32_t
 
	m’abËd
;

113 
ušt32_t
 
	mev’t
;

114 
ušt32_t
 
	mhy³rvisÜ
;

115 
ušt32_t
 
	mk”Ãl
;

116 
ušt32_t
 
	mu£r
;

117 
ušt64_t
 
	mun™_mask
;

119 
x’İrof_couÁ”
 
	tx’İrof_couÁ”_t
;

120 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_couÁ”_t
);

122 
	sx’İrof_·ssive
 {

123 
ušt16_t
 
	mdomaš_id
;

124 
št32_t
 
	mmax_§m¶es
;

125 
št32_t
 
	mnbuf
;

126 
št32_t
 
	mbufsize
;

127 
ušt64_t
 
	mbuf_gmaddr
;

128 } 
	tx’İrof_·ssive_t
;

129 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_·ssive_t
);

131 
	sx’İrof_ibs_couÁ”
 {

132 
ušt64_t
 
	mİ_’abËd
;

133 
ušt64_t
 
	mãtch_’abËd
;

134 
ušt64_t
 
	mmax_út_ãtch
;

135 
ušt64_t
 
	mmax_út_İ
;

136 
ušt64_t
 
	m¿nd_’
;

137 
ušt64_t
 
	mdi¥©ched_İs
;

139 
x’İrof_ibs_couÁ”
 
	tx’İrof_ibs_couÁ”_t
;

140 
DEFINE_XEN_GUEST_HANDLE
(
x’İrof_ibs_couÁ”_t
);

	@/usr/include/alloca.h

19 #iâdef 
_ALLOCA_H


20 
	#_ALLOCA_H
 1

	)

22 
	~<ã©u»s.h
>

24 
	#__Ãed_size_t


	)

25 
	~<¡ddef.h
>

27 
	g__BEGIN_DECLS


30 #undeà
®loÿ


33 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

35 #ifdef 
__GNUC__


36 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

39 
__END_DECLS


	@/usr/include/asm-generic/types.h

1 #iâdeà
_ASM_GENERIC_TYPES_H


2 
	#_ASM_GENERIC_TYPES_H


	)

7 
	~<asm-g’”ic/št-Î64.h
>

9 #iâdeà
__ASSEMBLY__


11 
	tumode_t
;

	@/usr/include/asm/ioctls.h

1 
	~<asm-g’”ic/ioùls.h
>

	@/usr/include/bits/confname.h

21 #iâdeà
_UNISTD_H


28 
	m_PC_LINK_MAX
,

29 
	#_PC_LINK_MAX
 
_PC_LINK_MAX


	)

30 
	m_PC_MAX_CANON
,

31 
	#_PC_MAX_CANON
 
_PC_MAX_CANON


	)

32 
	m_PC_MAX_INPUT
,

33 
	#_PC_MAX_INPUT
 
_PC_MAX_INPUT


	)

34 
	m_PC_NAME_MAX
,

35 
	#_PC_NAME_MAX
 
_PC_NAME_MAX


	)

36 
	m_PC_PATH_MAX
,

37 
	#_PC_PATH_MAX
 
_PC_PATH_MAX


	)

38 
	m_PC_PIPE_BUF
,

39 
	#_PC_PIPE_BUF
 
_PC_PIPE_BUF


	)

40 
	m_PC_CHOWN_RESTRICTED
,

41 
	#_PC_CHOWN_RESTRICTED
 
_PC_CHOWN_RESTRICTED


	)

42 
	m_PC_NO_TRUNC
,

43 
	#_PC_NO_TRUNC
 
_PC_NO_TRUNC


	)

44 
	m_PC_VDISABLE
,

45 
	#_PC_VDISABLE
 
_PC_VDISABLE


	)

46 
	m_PC_SYNC_IO
,

47 
	#_PC_SYNC_IO
 
_PC_SYNC_IO


	)

48 
	m_PC_ASYNC_IO
,

49 
	#_PC_ASYNC_IO
 
_PC_ASYNC_IO


	)

50 
	m_PC_PRIO_IO
,

51 
	#_PC_PRIO_IO
 
_PC_PRIO_IO


	)

52 
	m_PC_SOCK_MAXBUF
,

53 
	#_PC_SOCK_MAXBUF
 
_PC_SOCK_MAXBUF


	)

54 
	m_PC_FILESIZEBITS
,

55 
	#_PC_FILESIZEBITS
 
_PC_FILESIZEBITS


	)

56 
	m_PC_REC_INCR_XFER_SIZE
,

57 
	#_PC_REC_INCR_XFER_SIZE
 
_PC_REC_INCR_XFER_SIZE


	)

58 
	m_PC_REC_MAX_XFER_SIZE
,

59 
	#_PC_REC_MAX_XFER_SIZE
 
_PC_REC_MAX_XFER_SIZE


	)

60 
	m_PC_REC_MIN_XFER_SIZE
,

61 
	#_PC_REC_MIN_XFER_SIZE
 
_PC_REC_MIN_XFER_SIZE


	)

62 
	m_PC_REC_XFER_ALIGN
,

63 
	#_PC_REC_XFER_ALIGN
 
_PC_REC_XFER_ALIGN


	)

64 
	m_PC_ALLOC_SIZE_MIN
,

65 
	#_PC_ALLOC_SIZE_MIN
 
_PC_ALLOC_SIZE_MIN


	)

66 
	m_PC_SYMLINK_MAX
,

67 
	#_PC_SYMLINK_MAX
 
_PC_SYMLINK_MAX


	)

68 
	m_PC_2_SYMLINKS


69 
	#_PC_2_SYMLINKS
 
_PC_2_SYMLINKS


	)

75 
	m_SC_ARG_MAX
,

76 
	#_SC_ARG_MAX
 
_SC_ARG_MAX


	)

77 
	m_SC_CHILD_MAX
,

78 
	#_SC_CHILD_MAX
 
_SC_CHILD_MAX


	)

79 
	m_SC_CLK_TCK
,

80 
	#_SC_CLK_TCK
 
_SC_CLK_TCK


	)

81 
	m_SC_NGROUPS_MAX
,

82 
	#_SC_NGROUPS_MAX
 
_SC_NGROUPS_MAX


	)

83 
	m_SC_OPEN_MAX
,

84 
	#_SC_OPEN_MAX
 
_SC_OPEN_MAX


	)

85 
	m_SC_STREAM_MAX
,

86 
	#_SC_STREAM_MAX
 
_SC_STREAM_MAX


	)

87 
	m_SC_TZNAME_MAX
,

88 
	#_SC_TZNAME_MAX
 
_SC_TZNAME_MAX


	)

89 
	m_SC_JOB_CONTROL
,

90 
	#_SC_JOB_CONTROL
 
_SC_JOB_CONTROL


	)

91 
	m_SC_SAVED_IDS
,

92 
	#_SC_SAVED_IDS
 
_SC_SAVED_IDS


	)

93 
	m_SC_REALTIME_SIGNALS
,

94 
	#_SC_REALTIME_SIGNALS
 
_SC_REALTIME_SIGNALS


	)

95 
	m_SC_PRIORITY_SCHEDULING
,

96 
	#_SC_PRIORITY_SCHEDULING
 
_SC_PRIORITY_SCHEDULING


	)

97 
	m_SC_TIMERS
,

98 
	#_SC_TIMERS
 
_SC_TIMERS


	)

99 
	m_SC_ASYNCHRONOUS_IO
,

100 
	#_SC_ASYNCHRONOUS_IO
 
_SC_ASYNCHRONOUS_IO


	)

101 
	m_SC_PRIORITIZED_IO
,

102 
	#_SC_PRIORITIZED_IO
 
_SC_PRIORITIZED_IO


	)

103 
	m_SC_SYNCHRONIZED_IO
,

104 
	#_SC_SYNCHRONIZED_IO
 
_SC_SYNCHRONIZED_IO


	)

105 
	m_SC_FSYNC
,

106 
	#_SC_FSYNC
 
_SC_FSYNC


	)

107 
	m_SC_MAPPED_FILES
,

108 
	#_SC_MAPPED_FILES
 
_SC_MAPPED_FILES


	)

109 
	m_SC_MEMLOCK
,

110 
	#_SC_MEMLOCK
 
_SC_MEMLOCK


	)

111 
	m_SC_MEMLOCK_RANGE
,

112 
	#_SC_MEMLOCK_RANGE
 
_SC_MEMLOCK_RANGE


	)

113 
	m_SC_MEMORY_PROTECTION
,

114 
	#_SC_MEMORY_PROTECTION
 
_SC_MEMORY_PROTECTION


	)

115 
	m_SC_MESSAGE_PASSING
,

116 
	#_SC_MESSAGE_PASSING
 
_SC_MESSAGE_PASSING


	)

117 
	m_SC_SEMAPHORES
,

118 
	#_SC_SEMAPHORES
 
_SC_SEMAPHORES


	)

119 
	m_SC_SHARED_MEMORY_OBJECTS
,

120 
	#_SC_SHARED_MEMORY_OBJECTS
 
_SC_SHARED_MEMORY_OBJECTS


	)

121 
	m_SC_AIO_LISTIO_MAX
,

122 
	#_SC_AIO_LISTIO_MAX
 
_SC_AIO_LISTIO_MAX


	)

123 
	m_SC_AIO_MAX
,

124 
	#_SC_AIO_MAX
 
_SC_AIO_MAX


	)

125 
	m_SC_AIO_PRIO_DELTA_MAX
,

126 
	#_SC_AIO_PRIO_DELTA_MAX
 
_SC_AIO_PRIO_DELTA_MAX


	)

127 
	m_SC_DELAYTIMER_MAX
,

128 
	#_SC_DELAYTIMER_MAX
 
_SC_DELAYTIMER_MAX


	)

129 
	m_SC_MQ_OPEN_MAX
,

130 
	#_SC_MQ_OPEN_MAX
 
_SC_MQ_OPEN_MAX


	)

131 
	m_SC_MQ_PRIO_MAX
,

132 
	#_SC_MQ_PRIO_MAX
 
_SC_MQ_PRIO_MAX


	)

133 
	m_SC_VERSION
,

134 
	#_SC_VERSION
 
_SC_VERSION


	)

135 
	m_SC_PAGESIZE
,

136 
	#_SC_PAGESIZE
 
_SC_PAGESIZE


	)

137 
	#_SC_PAGE_SIZE
 
_SC_PAGESIZE


	)

138 
	m_SC_RTSIG_MAX
,

139 
	#_SC_RTSIG_MAX
 
_SC_RTSIG_MAX


	)

140 
	m_SC_SEM_NSEMS_MAX
,

141 
	#_SC_SEM_NSEMS_MAX
 
_SC_SEM_NSEMS_MAX


	)

142 
	m_SC_SEM_VALUE_MAX
,

143 
	#_SC_SEM_VALUE_MAX
 
_SC_SEM_VALUE_MAX


	)

144 
	m_SC_SIGQUEUE_MAX
,

145 
	#_SC_SIGQUEUE_MAX
 
_SC_SIGQUEUE_MAX


	)

146 
	m_SC_TIMER_MAX
,

147 
	#_SC_TIMER_MAX
 
_SC_TIMER_MAX


	)

151 
	m_SC_BC_BASE_MAX
,

152 
	#_SC_BC_BASE_MAX
 
_SC_BC_BASE_MAX


	)

153 
	m_SC_BC_DIM_MAX
,

154 
	#_SC_BC_DIM_MAX
 
_SC_BC_DIM_MAX


	)

155 
	m_SC_BC_SCALE_MAX
,

156 
	#_SC_BC_SCALE_MAX
 
_SC_BC_SCALE_MAX


	)

157 
	m_SC_BC_STRING_MAX
,

158 
	#_SC_BC_STRING_MAX
 
_SC_BC_STRING_MAX


	)

159 
	m_SC_COLL_WEIGHTS_MAX
,

160 
	#_SC_COLL_WEIGHTS_MAX
 
_SC_COLL_WEIGHTS_MAX


	)

161 
	m_SC_EQUIV_CLASS_MAX
,

162 
	#_SC_EQUIV_CLASS_MAX
 
_SC_EQUIV_CLASS_MAX


	)

163 
	m_SC_EXPR_NEST_MAX
,

164 
	#_SC_EXPR_NEST_MAX
 
_SC_EXPR_NEST_MAX


	)

165 
	m_SC_LINE_MAX
,

166 
	#_SC_LINE_MAX
 
_SC_LINE_MAX


	)

167 
	m_SC_RE_DUP_MAX
,

168 
	#_SC_RE_DUP_MAX
 
_SC_RE_DUP_MAX


	)

169 
	m_SC_CHARCLASS_NAME_MAX
,

170 
	#_SC_CHARCLASS_NAME_MAX
 
_SC_CHARCLASS_NAME_MAX


	)

172 
	m_SC_2_VERSION
,

173 
	#_SC_2_VERSION
 
_SC_2_VERSION


	)

174 
	m_SC_2_C_BIND
,

175 
	#_SC_2_C_BIND
 
_SC_2_C_BIND


	)

176 
	m_SC_2_C_DEV
,

177 
	#_SC_2_C_DEV
 
_SC_2_C_DEV


	)

178 
	m_SC_2_FORT_DEV
,

179 
	#_SC_2_FORT_DEV
 
_SC_2_FORT_DEV


	)

180 
	m_SC_2_FORT_RUN
,

181 
	#_SC_2_FORT_RUN
 
_SC_2_FORT_RUN


	)

182 
	m_SC_2_SW_DEV
,

183 
	#_SC_2_SW_DEV
 
_SC_2_SW_DEV


	)

184 
	m_SC_2_LOCALEDEF
,

185 
	#_SC_2_LOCALEDEF
 
_SC_2_LOCALEDEF


	)

187 
	m_SC_PII
,

188 
	#_SC_PII
 
_SC_PII


	)

189 
	m_SC_PII_XTI
,

190 
	#_SC_PII_XTI
 
_SC_PII_XTI


	)

191 
	m_SC_PII_SOCKET
,

192 
	#_SC_PII_SOCKET
 
_SC_PII_SOCKET


	)

193 
	m_SC_PII_INTERNET
,

194 
	#_SC_PII_INTERNET
 
_SC_PII_INTERNET


	)

195 
	m_SC_PII_OSI
,

196 
	#_SC_PII_OSI
 
_SC_PII_OSI


	)

197 
	m_SC_POLL
,

198 
	#_SC_POLL
 
_SC_POLL


	)

199 
	m_SC_SELECT
,

200 
	#_SC_SELECT
 
_SC_SELECT


	)

201 
	m_SC_UIO_MAXIOV
,

202 
	#_SC_UIO_MAXIOV
 
_SC_UIO_MAXIOV


	)

203 
	m_SC_IOV_MAX
 = 
_SC_UIO_MAXIOV
,

204 
	#_SC_IOV_MAX
 
_SC_IOV_MAX


	)

205 
	m_SC_PII_INTERNET_STREAM
,

206 
	#_SC_PII_INTERNET_STREAM
 
_SC_PII_INTERNET_STREAM


	)

207 
	m_SC_PII_INTERNET_DGRAM
,

208 
	#_SC_PII_INTERNET_DGRAM
 
_SC_PII_INTERNET_DGRAM


	)

209 
	m_SC_PII_OSI_COTS
,

210 
	#_SC_PII_OSI_COTS
 
_SC_PII_OSI_COTS


	)

211 
	m_SC_PII_OSI_CLTS
,

212 
	#_SC_PII_OSI_CLTS
 
_SC_PII_OSI_CLTS


	)

213 
	m_SC_PII_OSI_M
,

214 
	#_SC_PII_OSI_M
 
_SC_PII_OSI_M


	)

215 
	m_SC_T_IOV_MAX
,

216 
	#_SC_T_IOV_MAX
 
_SC_T_IOV_MAX


	)

219 
	m_SC_THREADS
,

220 
	#_SC_THREADS
 
_SC_THREADS


	)

221 
	m_SC_THREAD_SAFE_FUNCTIONS
,

222 
	#_SC_THREAD_SAFE_FUNCTIONS
 
_SC_THREAD_SAFE_FUNCTIONS


	)

223 
	m_SC_GETGR_R_SIZE_MAX
,

224 
	#_SC_GETGR_R_SIZE_MAX
 
_SC_GETGR_R_SIZE_MAX


	)

225 
	m_SC_GETPW_R_SIZE_MAX
,

226 
	#_SC_GETPW_R_SIZE_MAX
 
_SC_GETPW_R_SIZE_MAX


	)

227 
	m_SC_LOGIN_NAME_MAX
,

228 
	#_SC_LOGIN_NAME_MAX
 
_SC_LOGIN_NAME_MAX


	)

229 
	m_SC_TTY_NAME_MAX
,

230 
	#_SC_TTY_NAME_MAX
 
_SC_TTY_NAME_MAX


	)

231 
	m_SC_THREAD_DESTRUCTOR_ITERATIONS
,

232 
	#_SC_THREAD_DESTRUCTOR_ITERATIONS
 
_SC_THREAD_DESTRUCTOR_ITERATIONS


	)

233 
	m_SC_THREAD_KEYS_MAX
,

234 
	#_SC_THREAD_KEYS_MAX
 
_SC_THREAD_KEYS_MAX


	)

235 
	m_SC_THREAD_STACK_MIN
,

236 
	#_SC_THREAD_STACK_MIN
 
_SC_THREAD_STACK_MIN


	)

237 
	m_SC_THREAD_THREADS_MAX
,

238 
	#_SC_THREAD_THREADS_MAX
 
_SC_THREAD_THREADS_MAX


	)

239 
	m_SC_THREAD_ATTR_STACKADDR
,

240 
	#_SC_THREAD_ATTR_STACKADDR
 
_SC_THREAD_ATTR_STACKADDR


	)

241 
	m_SC_THREAD_ATTR_STACKSIZE
,

242 
	#_SC_THREAD_ATTR_STACKSIZE
 
_SC_THREAD_ATTR_STACKSIZE


	)

243 
	m_SC_THREAD_PRIORITY_SCHEDULING
,

244 
	#_SC_THREAD_PRIORITY_SCHEDULING
 
_SC_THREAD_PRIORITY_SCHEDULING


	)

245 
	m_SC_THREAD_PRIO_INHERIT
,

246 
	#_SC_THREAD_PRIO_INHERIT
 
_SC_THREAD_PRIO_INHERIT


	)

247 
	m_SC_THREAD_PRIO_PROTECT
,

248 
	#_SC_THREAD_PRIO_PROTECT
 
_SC_THREAD_PRIO_PROTECT


	)

249 
	m_SC_THREAD_PROCESS_SHARED
,

250 
	#_SC_THREAD_PROCESS_SHARED
 
_SC_THREAD_PROCESS_SHARED


	)

252 
	m_SC_NPROCESSORS_CONF
,

253 
	#_SC_NPROCESSORS_CONF
 
_SC_NPROCESSORS_CONF


	)

254 
	m_SC_NPROCESSORS_ONLN
,

255 
	#_SC_NPROCESSORS_ONLN
 
_SC_NPROCESSORS_ONLN


	)

256 
	m_SC_PHYS_PAGES
,

257 
	#_SC_PHYS_PAGES
 
_SC_PHYS_PAGES


	)

258 
	m_SC_AVPHYS_PAGES
,

259 
	#_SC_AVPHYS_PAGES
 
_SC_AVPHYS_PAGES


	)

260 
	m_SC_ATEXIT_MAX
,

261 
	#_SC_ATEXIT_MAX
 
_SC_ATEXIT_MAX


	)

262 
	m_SC_PASS_MAX
,

263 
	#_SC_PASS_MAX
 
_SC_PASS_MAX


	)

265 
	m_SC_XOPEN_VERSION
,

266 
	#_SC_XOPEN_VERSION
 
_SC_XOPEN_VERSION


	)

267 
	m_SC_XOPEN_XCU_VERSION
,

268 
	#_SC_XOPEN_XCU_VERSION
 
_SC_XOPEN_XCU_VERSION


	)

269 
	m_SC_XOPEN_UNIX
,

270 
	#_SC_XOPEN_UNIX
 
_SC_XOPEN_UNIX


	)

271 
	m_SC_XOPEN_CRYPT
,

272 
	#_SC_XOPEN_CRYPT
 
_SC_XOPEN_CRYPT


	)

273 
	m_SC_XOPEN_ENH_I18N
,

274 
	#_SC_XOPEN_ENH_I18N
 
_SC_XOPEN_ENH_I18N


	)

275 
	m_SC_XOPEN_SHM
,

276 
	#_SC_XOPEN_SHM
 
_SC_XOPEN_SHM


	)

278 
	m_SC_2_CHAR_TERM
,

279 
	#_SC_2_CHAR_TERM
 
_SC_2_CHAR_TERM


	)

280 
	m_SC_2_C_VERSION
,

281 
	#_SC_2_C_VERSION
 
_SC_2_C_VERSION


	)

282 
	m_SC_2_UPE
,

283 
	#_SC_2_UPE
 
_SC_2_UPE


	)

285 
	m_SC_XOPEN_XPG2
,

286 
	#_SC_XOPEN_XPG2
 
_SC_XOPEN_XPG2


	)

287 
	m_SC_XOPEN_XPG3
,

288 
	#_SC_XOPEN_XPG3
 
_SC_XOPEN_XPG3


	)

289 
	m_SC_XOPEN_XPG4
,

290 
	#_SC_XOPEN_XPG4
 
_SC_XOPEN_XPG4


	)

292 
	m_SC_CHAR_BIT
,

293 
	#_SC_CHAR_BIT
 
_SC_CHAR_BIT


	)

294 
	m_SC_CHAR_MAX
,

295 
	#_SC_CHAR_MAX
 
_SC_CHAR_MAX


	)

296 
	m_SC_CHAR_MIN
,

297 
	#_SC_CHAR_MIN
 
_SC_CHAR_MIN


	)

298 
	m_SC_INT_MAX
,

299 
	#_SC_INT_MAX
 
_SC_INT_MAX


	)

300 
	m_SC_INT_MIN
,

301 
	#_SC_INT_MIN
 
_SC_INT_MIN


	)

302 
	m_SC_LONG_BIT
,

303 
	#_SC_LONG_BIT
 
_SC_LONG_BIT


	)

304 
	m_SC_WORD_BIT
,

305 
	#_SC_WORD_BIT
 
_SC_WORD_BIT


	)

306 
	m_SC_MB_LEN_MAX
,

307 
	#_SC_MB_LEN_MAX
 
_SC_MB_LEN_MAX


	)

308 
	m_SC_NZERO
,

309 
	#_SC_NZERO
 
_SC_NZERO


	)

310 
	m_SC_SSIZE_MAX
,

311 
	#_SC_SSIZE_MAX
 
_SC_SSIZE_MAX


	)

312 
	m_SC_SCHAR_MAX
,

313 
	#_SC_SCHAR_MAX
 
_SC_SCHAR_MAX


	)

314 
	m_SC_SCHAR_MIN
,

315 
	#_SC_SCHAR_MIN
 
_SC_SCHAR_MIN


	)

316 
	m_SC_SHRT_MAX
,

317 
	#_SC_SHRT_MAX
 
_SC_SHRT_MAX


	)

318 
	m_SC_SHRT_MIN
,

319 
	#_SC_SHRT_MIN
 
_SC_SHRT_MIN


	)

320 
	m_SC_UCHAR_MAX
,

321 
	#_SC_UCHAR_MAX
 
_SC_UCHAR_MAX


	)

322 
	m_SC_UINT_MAX
,

323 
	#_SC_UINT_MAX
 
_SC_UINT_MAX


	)

324 
	m_SC_ULONG_MAX
,

325 
	#_SC_ULONG_MAX
 
_SC_ULONG_MAX


	)

326 
	m_SC_USHRT_MAX
,

327 
	#_SC_USHRT_MAX
 
_SC_USHRT_MAX


	)

329 
	m_SC_NL_ARGMAX
,

330 
	#_SC_NL_ARGMAX
 
_SC_NL_ARGMAX


	)

331 
	m_SC_NL_LANGMAX
,

332 
	#_SC_NL_LANGMAX
 
_SC_NL_LANGMAX


	)

333 
	m_SC_NL_MSGMAX
,

334 
	#_SC_NL_MSGMAX
 
_SC_NL_MSGMAX


	)

335 
	m_SC_NL_NMAX
,

336 
	#_SC_NL_NMAX
 
_SC_NL_NMAX


	)

337 
	m_SC_NL_SETMAX
,

338 
	#_SC_NL_SETMAX
 
_SC_NL_SETMAX


	)

339 
	m_SC_NL_TEXTMAX
,

340 
	#_SC_NL_TEXTMAX
 
_SC_NL_TEXTMAX


	)

342 
	m_SC_XBS5_ILP32_OFF32
,

343 
	#_SC_XBS5_ILP32_OFF32
 
_SC_XBS5_ILP32_OFF32


	)

344 
	m_SC_XBS5_ILP32_OFFBIG
,

345 
	#_SC_XBS5_ILP32_OFFBIG
 
_SC_XBS5_ILP32_OFFBIG


	)

346 
	m_SC_XBS5_LP64_OFF64
,

347 
	#_SC_XBS5_LP64_OFF64
 
_SC_XBS5_LP64_OFF64


	)

348 
	m_SC_XBS5_LPBIG_OFFBIG
,

349 
	#_SC_XBS5_LPBIG_OFFBIG
 
_SC_XBS5_LPBIG_OFFBIG


	)

351 
	m_SC_XOPEN_LEGACY
,

352 
	#_SC_XOPEN_LEGACY
 
_SC_XOPEN_LEGACY


	)

353 
	m_SC_XOPEN_REALTIME
,

354 
	#_SC_XOPEN_REALTIME
 
_SC_XOPEN_REALTIME


	)

355 
	m_SC_XOPEN_REALTIME_THREADS
,

356 
	#_SC_XOPEN_REALTIME_THREADS
 
_SC_XOPEN_REALTIME_THREADS


	)

358 
	m_SC_ADVISORY_INFO
,

359 
	#_SC_ADVISORY_INFO
 
_SC_ADVISORY_INFO


	)

360 
	m_SC_BARRIERS
,

361 
	#_SC_BARRIERS
 
_SC_BARRIERS


	)

362 
	m_SC_BASE
,

363 
	#_SC_BASE
 
_SC_BASE


	)

364 
	m_SC_C_LANG_SUPPORT
,

365 
	#_SC_C_LANG_SUPPORT
 
_SC_C_LANG_SUPPORT


	)

366 
	m_SC_C_LANG_SUPPORT_R
,

367 
	#_SC_C_LANG_SUPPORT_R
 
_SC_C_LANG_SUPPORT_R


	)

368 
	m_SC_CLOCK_SELECTION
,

369 
	#_SC_CLOCK_SELECTION
 
_SC_CLOCK_SELECTION


	)

370 
	m_SC_CPUTIME
,

371 
	#_SC_CPUTIME
 
_SC_CPUTIME


	)

372 
	m_SC_THREAD_CPUTIME
,

373 
	#_SC_THREAD_CPUTIME
 
_SC_THREAD_CPUTIME


	)

374 
	m_SC_DEVICE_IO
,

375 
	#_SC_DEVICE_IO
 
_SC_DEVICE_IO


	)

376 
	m_SC_DEVICE_SPECIFIC
,

377 
	#_SC_DEVICE_SPECIFIC
 
_SC_DEVICE_SPECIFIC


	)

378 
	m_SC_DEVICE_SPECIFIC_R
,

379 
	#_SC_DEVICE_SPECIFIC_R
 
_SC_DEVICE_SPECIFIC_R


	)

380 
	m_SC_FD_MGMT
,

381 
	#_SC_FD_MGMT
 
_SC_FD_MGMT


	)

382 
	m_SC_FIFO
,

383 
	#_SC_FIFO
 
_SC_FIFO


	)

384 
	m_SC_PIPE
,

385 
	#_SC_PIPE
 
_SC_PIPE


	)

386 
	m_SC_FILE_ATTRIBUTES
,

387 
	#_SC_FILE_ATTRIBUTES
 
_SC_FILE_ATTRIBUTES


	)

388 
	m_SC_FILE_LOCKING
,

389 
	#_SC_FILE_LOCKING
 
_SC_FILE_LOCKING


	)

390 
	m_SC_FILE_SYSTEM
,

391 
	#_SC_FILE_SYSTEM
 
_SC_FILE_SYSTEM


	)

392 
	m_SC_MONOTONIC_CLOCK
,

393 
	#_SC_MONOTONIC_CLOCK
 
_SC_MONOTONIC_CLOCK


	)

394 
	m_SC_MULTI_PROCESS
,

395 
	#_SC_MULTI_PROCESS
 
_SC_MULTI_PROCESS


	)

396 
	m_SC_SINGLE_PROCESS
,

397 
	#_SC_SINGLE_PROCESS
 
_SC_SINGLE_PROCESS


	)

398 
	m_SC_NETWORKING
,

399 
	#_SC_NETWORKING
 
_SC_NETWORKING


	)

400 
	m_SC_READER_WRITER_LOCKS
,

401 
	#_SC_READER_WRITER_LOCKS
 
_SC_READER_WRITER_LOCKS


	)

402 
	m_SC_SPIN_LOCKS
,

403 
	#_SC_SPIN_LOCKS
 
_SC_SPIN_LOCKS


	)

404 
	m_SC_REGEXP
,

405 
	#_SC_REGEXP
 
_SC_REGEXP


	)

406 
	m_SC_REGEX_VERSION
,

407 
	#_SC_REGEX_VERSION
 
_SC_REGEX_VERSION


	)

408 
	m_SC_SHELL
,

409 
	#_SC_SHELL
 
_SC_SHELL


	)

410 
	m_SC_SIGNALS
,

411 
	#_SC_SIGNALS
 
_SC_SIGNALS


	)

412 
	m_SC_SPAWN
,

413 
	#_SC_SPAWN
 
_SC_SPAWN


	)

414 
	m_SC_SPORADIC_SERVER
,

415 
	#_SC_SPORADIC_SERVER
 
_SC_SPORADIC_SERVER


	)

416 
	m_SC_THREAD_SPORADIC_SERVER
,

417 
	#_SC_THREAD_SPORADIC_SERVER
 
_SC_THREAD_SPORADIC_SERVER


	)

418 
	m_SC_SYSTEM_DATABASE
,

419 
	#_SC_SYSTEM_DATABASE
 
_SC_SYSTEM_DATABASE


	)

420 
	m_SC_SYSTEM_DATABASE_R
,

421 
	#_SC_SYSTEM_DATABASE_R
 
_SC_SYSTEM_DATABASE_R


	)

422 
	m_SC_TIMEOUTS
,

423 
	#_SC_TIMEOUTS
 
_SC_TIMEOUTS


	)

424 
	m_SC_TYPED_MEMORY_OBJECTS
,

425 
	#_SC_TYPED_MEMORY_OBJECTS
 
_SC_TYPED_MEMORY_OBJECTS


	)

426 
	m_SC_USER_GROUPS
,

427 
	#_SC_USER_GROUPS
 
_SC_USER_GROUPS


	)

428 
	m_SC_USER_GROUPS_R
,

429 
	#_SC_USER_GROUPS_R
 
_SC_USER_GROUPS_R


	)

430 
	m_SC_2_PBS
,

431 
	#_SC_2_PBS
 
_SC_2_PBS


	)

432 
	m_SC_2_PBS_ACCOUNTING
,

433 
	#_SC_2_PBS_ACCOUNTING
 
_SC_2_PBS_ACCOUNTING


	)

434 
	m_SC_2_PBS_LOCATE
,

435 
	#_SC_2_PBS_LOCATE
 
_SC_2_PBS_LOCATE


	)

436 
	m_SC_2_PBS_MESSAGE
,

437 
	#_SC_2_PBS_MESSAGE
 
_SC_2_PBS_MESSAGE


	)

438 
	m_SC_2_PBS_TRACK
,

439 
	#_SC_2_PBS_TRACK
 
_SC_2_PBS_TRACK


	)

440 
	m_SC_SYMLOOP_MAX
,

441 
	#_SC_SYMLOOP_MAX
 
_SC_SYMLOOP_MAX


	)

442 
	m_SC_STREAMS
,

443 
	#_SC_STREAMS
 
_SC_STREAMS


	)

444 
	m_SC_2_PBS_CHECKPOINT
,

445 
	#_SC_2_PBS_CHECKPOINT
 
_SC_2_PBS_CHECKPOINT


	)

447 
	m_SC_V6_ILP32_OFF32
,

448 
	#_SC_V6_ILP32_OFF32
 
_SC_V6_ILP32_OFF32


	)

449 
	m_SC_V6_ILP32_OFFBIG
,

450 
	#_SC_V6_ILP32_OFFBIG
 
_SC_V6_ILP32_OFFBIG


	)

451 
	m_SC_V6_LP64_OFF64
,

452 
	#_SC_V6_LP64_OFF64
 
_SC_V6_LP64_OFF64


	)

453 
	m_SC_V6_LPBIG_OFFBIG
,

454 
	#_SC_V6_LPBIG_OFFBIG
 
_SC_V6_LPBIG_OFFBIG


	)

456 
	m_SC_HOST_NAME_MAX
,

457 
	#_SC_HOST_NAME_MAX
 
_SC_HOST_NAME_MAX


	)

458 
	m_SC_TRACE
,

459 
	#_SC_TRACE
 
_SC_TRACE


	)

460 
	m_SC_TRACE_EVENT_FILTER
,

461 
	#_SC_TRACE_EVENT_FILTER
 
_SC_TRACE_EVENT_FILTER


	)

462 
	m_SC_TRACE_INHERIT
,

463 
	#_SC_TRACE_INHERIT
 
_SC_TRACE_INHERIT


	)

464 
	m_SC_TRACE_LOG
,

465 
	#_SC_TRACE_LOG
 
_SC_TRACE_LOG


	)

467 
	m_SC_LEVEL1_ICACHE_SIZE
,

468 
	#_SC_LEVEL1_ICACHE_SIZE
 
_SC_LEVEL1_ICACHE_SIZE


	)

469 
	m_SC_LEVEL1_ICACHE_ASSOC
,

470 
	#_SC_LEVEL1_ICACHE_ASSOC
 
_SC_LEVEL1_ICACHE_ASSOC


	)

471 
	m_SC_LEVEL1_ICACHE_LINESIZE
,

472 
	#_SC_LEVEL1_ICACHE_LINESIZE
 
_SC_LEVEL1_ICACHE_LINESIZE


	)

473 
	m_SC_LEVEL1_DCACHE_SIZE
,

474 
	#_SC_LEVEL1_DCACHE_SIZE
 
_SC_LEVEL1_DCACHE_SIZE


	)

475 
	m_SC_LEVEL1_DCACHE_ASSOC
,

476 
	#_SC_LEVEL1_DCACHE_ASSOC
 
_SC_LEVEL1_DCACHE_ASSOC


	)

477 
	m_SC_LEVEL1_DCACHE_LINESIZE
,

478 
	#_SC_LEVEL1_DCACHE_LINESIZE
 
_SC_LEVEL1_DCACHE_LINESIZE


	)

479 
	m_SC_LEVEL2_CACHE_SIZE
,

480 
	#_SC_LEVEL2_CACHE_SIZE
 
_SC_LEVEL2_CACHE_SIZE


	)

481 
	m_SC_LEVEL2_CACHE_ASSOC
,

482 
	#_SC_LEVEL2_CACHE_ASSOC
 
_SC_LEVEL2_CACHE_ASSOC


	)

483 
	m_SC_LEVEL2_CACHE_LINESIZE
,

484 
	#_SC_LEVEL2_CACHE_LINESIZE
 
_SC_LEVEL2_CACHE_LINESIZE


	)

485 
	m_SC_LEVEL3_CACHE_SIZE
,

486 
	#_SC_LEVEL3_CACHE_SIZE
 
_SC_LEVEL3_CACHE_SIZE


	)

487 
	m_SC_LEVEL3_CACHE_ASSOC
,

488 
	#_SC_LEVEL3_CACHE_ASSOC
 
_SC_LEVEL3_CACHE_ASSOC


	)

489 
	m_SC_LEVEL3_CACHE_LINESIZE
,

490 
	#_SC_LEVEL3_CACHE_LINESIZE
 
_SC_LEVEL3_CACHE_LINESIZE


	)

491 
	m_SC_LEVEL4_CACHE_SIZE
,

492 
	#_SC_LEVEL4_CACHE_SIZE
 
_SC_LEVEL4_CACHE_SIZE


	)

493 
	m_SC_LEVEL4_CACHE_ASSOC
,

494 
	#_SC_LEVEL4_CACHE_ASSOC
 
_SC_LEVEL4_CACHE_ASSOC


	)

495 
	m_SC_LEVEL4_CACHE_LINESIZE
,

496 
	#_SC_LEVEL4_CACHE_LINESIZE
 
_SC_LEVEL4_CACHE_LINESIZE


	)

499 
	m_SC_IPV6
 = 
_SC_LEVEL1_ICACHE_SIZE
 + 50,

500 
	#_SC_IPV6
 
_SC_IPV6


	)

501 
	m_SC_RAW_SOCKETS
,

502 
	#_SC_RAW_SOCKETS
 
_SC_RAW_SOCKETS


	)

504 
	m_SC_V7_ILP32_OFF32
,

505 
	#_SC_V7_ILP32_OFF32
 
_SC_V7_ILP32_OFF32


	)

506 
	m_SC_V7_ILP32_OFFBIG
,

507 
	#_SC_V7_ILP32_OFFBIG
 
_SC_V7_ILP32_OFFBIG


	)

508 
	m_SC_V7_LP64_OFF64
,

509 
	#_SC_V7_LP64_OFF64
 
_SC_V7_LP64_OFF64


	)

510 
	m_SC_V7_LPBIG_OFFBIG
,

511 
	#_SC_V7_LPBIG_OFFBIG
 
_SC_V7_LPBIG_OFFBIG


	)

513 
	m_SC_SS_REPL_MAX
,

514 
	#_SC_SS_REPL_MAX
 
_SC_SS_REPL_MAX


	)

516 
	m_SC_TRACE_EVENT_NAME_MAX
,

517 
	#_SC_TRACE_EVENT_NAME_MAX
 
_SC_TRACE_EVENT_NAME_MAX


	)

518 
	m_SC_TRACE_NAME_MAX
,

519 
	#_SC_TRACE_NAME_MAX
 
_SC_TRACE_NAME_MAX


	)

520 
	m_SC_TRACE_SYS_MAX
,

521 
	#_SC_TRACE_SYS_MAX
 
_SC_TRACE_SYS_MAX


	)

522 
	m_SC_TRACE_USER_EVENT_MAX
,

523 
	#_SC_TRACE_USER_EVENT_MAX
 
_SC_TRACE_USER_EVENT_MAX


	)

525 
	m_SC_XOPEN_STREAMS
,

526 
	#_SC_XOPEN_STREAMS
 
_SC_XOPEN_STREAMS


	)

528 
	m_SC_THREAD_ROBUST_PRIO_INHERIT
,

529 
	#_SC_THREAD_ROBUST_PRIO_INHERIT
 
_SC_THREAD_ROBUST_PRIO_INHERIT


	)

530 
	m_SC_THREAD_ROBUST_PRIO_PROTECT


531 
	#_SC_THREAD_ROBUST_PRIO_PROTECT
 
_SC_THREAD_ROBUST_PRIO_PROTECT


	)

537 
	m_CS_PATH
,

538 
	#_CS_PATH
 
_CS_PATH


	)

540 
	m_CS_V6_WIDTH_RESTRICTED_ENVS
,

541 
	#_CS_V6_WIDTH_RESTRICTED_ENVS
 
_CS_V6_WIDTH_RESTRICTED_ENVS


	)

542 
	#_CS_POSIX_V6_WIDTH_RESTRICTED_ENVS
 
_CS_V6_WIDTH_RESTRICTED_ENVS


	)

544 
	m_CS_GNU_LIBC_VERSION
,

545 
	#_CS_GNU_LIBC_VERSION
 
_CS_GNU_LIBC_VERSION


	)

546 
	m_CS_GNU_LIBPTHREAD_VERSION
,

547 
	#_CS_GNU_LIBPTHREAD_VERSION
 
_CS_GNU_LIBPTHREAD_VERSION


	)

549 
	m_CS_V5_WIDTH_RESTRICTED_ENVS
,

550 
	#_CS_V5_WIDTH_RESTRICTED_ENVS
 
_CS_V5_WIDTH_RESTRICTED_ENVS


	)

551 
	#_CS_POSIX_V5_WIDTH_RESTRICTED_ENVS
 
_CS_V5_WIDTH_RESTRICTED_ENVS


	)

553 
	m_CS_V7_WIDTH_RESTRICTED_ENVS
,

554 
	#_CS_V7_WIDTH_RESTRICTED_ENVS
 
_CS_V7_WIDTH_RESTRICTED_ENVS


	)

555 
	#_CS_POSIX_V7_WIDTH_RESTRICTED_ENVS
 
_CS_V7_WIDTH_RESTRICTED_ENVS


	)

557 
	m_CS_LFS_CFLAGS
 = 1000,

558 
	#_CS_LFS_CFLAGS
 
_CS_LFS_CFLAGS


	)

559 
	m_CS_LFS_LDFLAGS
,

560 
	#_CS_LFS_LDFLAGS
 
_CS_LFS_LDFLAGS


	)

561 
	m_CS_LFS_LIBS
,

562 
	#_CS_LFS_LIBS
 
_CS_LFS_LIBS


	)

563 
	m_CS_LFS_LINTFLAGS
,

564 
	#_CS_LFS_LINTFLAGS
 
_CS_LFS_LINTFLAGS


	)

565 
	m_CS_LFS64_CFLAGS
,

566 
	#_CS_LFS64_CFLAGS
 
_CS_LFS64_CFLAGS


	)

567 
	m_CS_LFS64_LDFLAGS
,

568 
	#_CS_LFS64_LDFLAGS
 
_CS_LFS64_LDFLAGS


	)

569 
	m_CS_LFS64_LIBS
,

570 
	#_CS_LFS64_LIBS
 
_CS_LFS64_LIBS


	)

571 
	m_CS_LFS64_LINTFLAGS
,

572 
	#_CS_LFS64_LINTFLAGS
 
_CS_LFS64_LINTFLAGS


	)

574 
	m_CS_XBS5_ILP32_OFF32_CFLAGS
 = 1100,

575 
	#_CS_XBS5_ILP32_OFF32_CFLAGS
 
_CS_XBS5_ILP32_OFF32_CFLAGS


	)

576 
	m_CS_XBS5_ILP32_OFF32_LDFLAGS
,

577 
	#_CS_XBS5_ILP32_OFF32_LDFLAGS
 
_CS_XBS5_ILP32_OFF32_LDFLAGS


	)

578 
	m_CS_XBS5_ILP32_OFF32_LIBS
,

579 
	#_CS_XBS5_ILP32_OFF32_LIBS
 
_CS_XBS5_ILP32_OFF32_LIBS


	)

580 
	m_CS_XBS5_ILP32_OFF32_LINTFLAGS
,

581 
	#_CS_XBS5_ILP32_OFF32_LINTFLAGS
 
_CS_XBS5_ILP32_OFF32_LINTFLAGS


	)

582 
	m_CS_XBS5_ILP32_OFFBIG_CFLAGS
,

583 
	#_CS_XBS5_ILP32_OFFBIG_CFLAGS
 
_CS_XBS5_ILP32_OFFBIG_CFLAGS


	)

584 
	m_CS_XBS5_ILP32_OFFBIG_LDFLAGS
,

585 
	#_CS_XBS5_ILP32_OFFBIG_LDFLAGS
 
_CS_XBS5_ILP32_OFFBIG_LDFLAGS


	)

586 
	m_CS_XBS5_ILP32_OFFBIG_LIBS
,

587 
	#_CS_XBS5_ILP32_OFFBIG_LIBS
 
_CS_XBS5_ILP32_OFFBIG_LIBS


	)

588 
	m_CS_XBS5_ILP32_OFFBIG_LINTFLAGS
,

589 
	#_CS_XBS5_ILP32_OFFBIG_LINTFLAGS
 
_CS_XBS5_ILP32_OFFBIG_LINTFLAGS


	)

590 
	m_CS_XBS5_LP64_OFF64_CFLAGS
,

591 
	#_CS_XBS5_LP64_OFF64_CFLAGS
 
_CS_XBS5_LP64_OFF64_CFLAGS


	)

592 
	m_CS_XBS5_LP64_OFF64_LDFLAGS
,

593 
	#_CS_XBS5_LP64_OFF64_LDFLAGS
 
_CS_XBS5_LP64_OFF64_LDFLAGS


	)

594 
	m_CS_XBS5_LP64_OFF64_LIBS
,

595 
	#_CS_XBS5_LP64_OFF64_LIBS
 
_CS_XBS5_LP64_OFF64_LIBS


	)

596 
	m_CS_XBS5_LP64_OFF64_LINTFLAGS
,

597 
	#_CS_XBS5_LP64_OFF64_LINTFLAGS
 
_CS_XBS5_LP64_OFF64_LINTFLAGS


	)

598 
	m_CS_XBS5_LPBIG_OFFBIG_CFLAGS
,

599 
	#_CS_XBS5_LPBIG_OFFBIG_CFLAGS
 
_CS_XBS5_LPBIG_OFFBIG_CFLAGS


	)

600 
	m_CS_XBS5_LPBIG_OFFBIG_LDFLAGS
,

601 
	#_CS_XBS5_LPBIG_OFFBIG_LDFLAGS
 
_CS_XBS5_LPBIG_OFFBIG_LDFLAGS


	)

602 
	m_CS_XBS5_LPBIG_OFFBIG_LIBS
,

603 
	#_CS_XBS5_LPBIG_OFFBIG_LIBS
 
_CS_XBS5_LPBIG_OFFBIG_LIBS


	)

604 
	m_CS_XBS5_LPBIG_OFFBIG_LINTFLAGS
,

605 
	#_CS_XBS5_LPBIG_OFFBIG_LINTFLAGS
 
_CS_XBS5_LPBIG_OFFBIG_LINTFLAGS


	)

607 
	m_CS_POSIX_V6_ILP32_OFF32_CFLAGS
,

608 
	#_CS_POSIX_V6_ILP32_OFF32_CFLAGS
 
_CS_POSIX_V6_ILP32_OFF32_CFLAGS


	)

609 
	m_CS_POSIX_V6_ILP32_OFF32_LDFLAGS
,

610 
	#_CS_POSIX_V6_ILP32_OFF32_LDFLAGS
 
_CS_POSIX_V6_ILP32_OFF32_LDFLAGS


	)

611 
	m_CS_POSIX_V6_ILP32_OFF32_LIBS
,

612 
	#_CS_POSIX_V6_ILP32_OFF32_LIBS
 
_CS_POSIX_V6_ILP32_OFF32_LIBS


	)

613 
	m_CS_POSIX_V6_ILP32_OFF32_LINTFLAGS
,

614 
	#_CS_POSIX_V6_ILP32_OFF32_LINTFLAGS
 
_CS_POSIX_V6_ILP32_OFF32_LINTFLAGS


	)

615 
	m_CS_POSIX_V6_ILP32_OFFBIG_CFLAGS
,

616 
	#_CS_POSIX_V6_ILP32_OFFBIG_CFLAGS
 
_CS_POSIX_V6_ILP32_OFFBIG_CFLAGS


	)

617 
	m_CS_POSIX_V6_ILP32_OFFBIG_LDFLAGS
,

618 
	#_CS_POSIX_V6_ILP32_OFFBIG_LDFLAGS
 
_CS_POSIX_V6_ILP32_OFFBIG_LDFLAGS


	)

619 
	m_CS_POSIX_V6_ILP32_OFFBIG_LIBS
,

620 
	#_CS_POSIX_V6_ILP32_OFFBIG_LIBS
 
_CS_POSIX_V6_ILP32_OFFBIG_LIBS


	)

621 
	m_CS_POSIX_V6_ILP32_OFFBIG_LINTFLAGS
,

622 
	#_CS_POSIX_V6_ILP32_OFFBIG_LINTFLAGS
 
_CS_POSIX_V6_ILP32_OFFBIG_LINTFLAGS


	)

623 
	m_CS_POSIX_V6_LP64_OFF64_CFLAGS
,

624 
	#_CS_POSIX_V6_LP64_OFF64_CFLAGS
 
_CS_POSIX_V6_LP64_OFF64_CFLAGS


	)

625 
	m_CS_POSIX_V6_LP64_OFF64_LDFLAGS
,

626 
	#_CS_POSIX_V6_LP64_OFF64_LDFLAGS
 
_CS_POSIX_V6_LP64_OFF64_LDFLAGS


	)

627 
	m_CS_POSIX_V6_LP64_OFF64_LIBS
,

628 
	#_CS_POSIX_V6_LP64_OFF64_LIBS
 
_CS_POSIX_V6_LP64_OFF64_LIBS


	)

629 
	m_CS_POSIX_V6_LP64_OFF64_LINTFLAGS
,

630 
	#_CS_POSIX_V6_LP64_OFF64_LINTFLAGS
 
_CS_POSIX_V6_LP64_OFF64_LINTFLAGS


	)

631 
	m_CS_POSIX_V6_LPBIG_OFFBIG_CFLAGS
,

632 
	#_CS_POSIX_V6_LPBIG_OFFBIG_CFLAGS
 
_CS_POSIX_V6_LPBIG_OFFBIG_CFLAGS


	)

633 
	m_CS_POSIX_V6_LPBIG_OFFBIG_LDFLAGS
,

634 
	#_CS_POSIX_V6_LPBIG_OFFBIG_LDFLAGS
 
_CS_POSIX_V6_LPBIG_OFFBIG_LDFLAGS


	)

635 
	m_CS_POSIX_V6_LPBIG_OFFBIG_LIBS
,

636 
	#_CS_POSIX_V6_LPBIG_OFFBIG_LIBS
 
_CS_POSIX_V6_LPBIG_OFFBIG_LIBS


	)

637 
	m_CS_POSIX_V6_LPBIG_OFFBIG_LINTFLAGS
,

638 
	#_CS_POSIX_V6_LPBIG_OFFBIG_LINTFLAGS
 
_CS_POSIX_V6_LPBIG_OFFBIG_LINTFLAGS


	)

640 
	m_CS_POSIX_V7_ILP32_OFF32_CFLAGS
,

641 
	#_CS_POSIX_V7_ILP32_OFF32_CFLAGS
 
_CS_POSIX_V7_ILP32_OFF32_CFLAGS


	)

642 
	m_CS_POSIX_V7_ILP32_OFF32_LDFLAGS
,

643 
	#_CS_POSIX_V7_ILP32_OFF32_LDFLAGS
 
_CS_POSIX_V7_ILP32_OFF32_LDFLAGS


	)

644 
	m_CS_POSIX_V7_ILP32_OFF32_LIBS
,

645 
	#_CS_POSIX_V7_ILP32_OFF32_LIBS
 
_CS_POSIX_V7_ILP32_OFF32_LIBS


	)

646 
	m_CS_POSIX_V7_ILP32_OFF32_LINTFLAGS
,

647 
	#_CS_POSIX_V7_ILP32_OFF32_LINTFLAGS
 
_CS_POSIX_V7_ILP32_OFF32_LINTFLAGS


	)

648 
	m_CS_POSIX_V7_ILP32_OFFBIG_CFLAGS
,

649 
	#_CS_POSIX_V7_ILP32_OFFBIG_CFLAGS
 
_CS_POSIX_V7_ILP32_OFFBIG_CFLAGS


	)

650 
	m_CS_POSIX_V7_ILP32_OFFBIG_LDFLAGS
,

651 
	#_CS_POSIX_V7_ILP32_OFFBIG_LDFLAGS
 
_CS_POSIX_V7_ILP32_OFFBIG_LDFLAGS


	)

652 
	m_CS_POSIX_V7_ILP32_OFFBIG_LIBS
,

653 
	#_CS_POSIX_V7_ILP32_OFFBIG_LIBS
 
_CS_POSIX_V7_ILP32_OFFBIG_LIBS


	)

654 
	m_CS_POSIX_V7_ILP32_OFFBIG_LINTFLAGS
,

655 
	#_CS_POSIX_V7_ILP32_OFFBIG_LINTFLAGS
 
_CS_POSIX_V7_ILP32_OFFBIG_LINTFLAGS


	)

656 
	m_CS_POSIX_V7_LP64_OFF64_CFLAGS
,

657 
	#_CS_POSIX_V7_LP64_OFF64_CFLAGS
 
_CS_POSIX_V7_LP64_OFF64_CFLAGS


	)

658 
	m_CS_POSIX_V7_LP64_OFF64_LDFLAGS
,

659 
	#_CS_POSIX_V7_LP64_OFF64_LDFLAGS
 
_CS_POSIX_V7_LP64_OFF64_LDFLAGS


	)

660 
	m_CS_POSIX_V7_LP64_OFF64_LIBS
,

661 
	#_CS_POSIX_V7_LP64_OFF64_LIBS
 
_CS_POSIX_V7_LP64_OFF64_LIBS


	)

662 
	m_CS_POSIX_V7_LP64_OFF64_LINTFLAGS
,

663 
	#_CS_POSIX_V7_LP64_OFF64_LINTFLAGS
 
_CS_POSIX_V7_LP64_OFF64_LINTFLAGS


	)

664 
	m_CS_POSIX_V7_LPBIG_OFFBIG_CFLAGS
,

665 
	#_CS_POSIX_V7_LPBIG_OFFBIG_CFLAGS
 
_CS_POSIX_V7_LPBIG_OFFBIG_CFLAGS


	)

666 
	m_CS_POSIX_V7_LPBIG_OFFBIG_LDFLAGS
,

667 
	#_CS_POSIX_V7_LPBIG_OFFBIG_LDFLAGS
 
_CS_POSIX_V7_LPBIG_OFFBIG_LDFLAGS


	)

668 
	m_CS_POSIX_V7_LPBIG_OFFBIG_LIBS
,

669 
	#_CS_POSIX_V7_LPBIG_OFFBIG_LIBS
 
_CS_POSIX_V7_LPBIG_OFFBIG_LIBS


	)

670 
	m_CS_POSIX_V7_LPBIG_OFFBIG_LINTFLAGS
,

671 
	#_CS_POSIX_V7_LPBIG_OFFBIG_LINTFLAGS
 
_CS_POSIX_V7_LPBIG_OFFBIG_LINTFLAGS


	)

673 
	m_CS_V6_ENV
,

674 
	#_CS_V6_ENV
 
_CS_V6_ENV


	)

675 
	m_CS_V7_ENV


676 
	#_CS_V7_ENV
 
_CS_V7_ENV


	)

	@/usr/include/bits/environments.h

19 #iâdeà
_UNISTD_H


23 
	~<b™s/wÜdsize.h
>

43 #ià
__WORDSIZE
 == 64

57 
	#_POSIX_V7_LPBIG_OFFBIG
 -1

	)

58 
	#_POSIX_V6_LPBIG_OFFBIG
 -1

	)

59 
	#_XBS5_LPBIG_OFFBIG
 -1

	)

62 
	#_POSIX_V7_LP64_OFF64
 1

	)

63 
	#_POSIX_V6_LP64_OFF64
 1

	)

64 
	#_XBS5_LP64_OFF64
 1

	)

70 
	#_POSIX_V7_ILP32_OFF32
 1

	)

71 
	#_POSIX_V7_ILP32_OFFBIG
 1

	)

72 
	#_POSIX_V6_ILP32_OFF32
 1

	)

73 
	#_POSIX_V6_ILP32_OFFBIG
 1

	)

74 
	#_XBS5_ILP32_OFF32
 1

	)

75 
	#_XBS5_ILP32_OFFBIG
 1

	)

92 
	#__ILP32_OFF32_CFLAGS
 "-m32"

	)

93 
	#__ILP32_OFFBIG_CFLAGS
 "-m32 -D_LARGEFILE_SOURCE -D_FILE_OFFSET_BITS=64"

	)

94 
	#__ILP32_OFF32_LDFLAGS
 "-m32"

	)

95 
	#__ILP32_OFFBIG_LDFLAGS
 "-m32"

	)

96 
	#__LP64_OFF64_CFLAGS
 "-m64"

	)

97 
	#__LP64_OFF64_LDFLAGS
 "-m64"

	)

	@/usr/include/bits/errno.h

20 #ifdeà
_ERRNO_H


22 #undeà
EDOM


23 #undeà
EILSEQ


24 #undeà
ERANGE


25 
	~<lšux/”ºo.h
>

28 
	#ENOTSUP
 
EOPNOTSUPP


	)

31 #iâdeà
ECANCELED


32 
	#ECANCELED
 125

	)

36 #iâdeà
EOWNERDEAD


37 
	#EOWNERDEAD
 130

	)

38 
	#ENOTRECOVERABLE
 131

	)

41 #iâdeà
ERFKILL


42 
	#ERFKILL
 132

	)

45 #iâdeà
__ASSEMBLER__


47 *
	$__”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

49 #ià!
defšed
 
_LIBC
 || defšed 
_LIBC_REENTRANT


51 
	#”ºo
 (*
	`__”ºo_loÿtiÚ
 ())

	)

56 #ià!
defšed
 
_ERRNO_H
 && defšed 
__Ãed_Em©h


60 
	#EDOM
 33

	)

61 
	#EILSEQ
 84

	)

62 
	#ERANGE
 34

	)

	@/usr/include/bits/fcntl.h

21 #iâdef 
_FCNTL_H


25 
	~<sys/ty³s.h
>

26 
	~<b™s/wÜdsize.h
>

27 #ifdeà
__USE_GNU


28 
	~<b™s/uio.h
>

34 
	#O_ACCMODE
 0003

	)

35 
	#O_RDONLY
 00

	)

36 
	#O_WRONLY
 01

	)

37 
	#O_RDWR
 02

	)

38 
	#O_CREAT
 0100

	)

39 
	#O_EXCL
 0200

	)

40 
	#O_NOCTTY
 0400

	)

41 
	#O_TRUNC
 01000

	)

42 
	#O_APPEND
 02000

	)

43 
	#O_NONBLOCK
 04000

	)

44 
	#O_NDELAY
 
O_NONBLOCK


	)

45 
	#O_SYNC
 04010000

	)

46 
	#O_FSYNC
 
O_SYNC


	)

47 
	#O_ASYNC
 020000

	)

49 #ifdeà
__USE_XOPEN2K8


50 
	#O_DIRECTORY
 0200000

	)

51 
	#O_NOFOLLOW
 0400000

	)

52 
	#O_CLOEXEC
 02000000

	)

54 #ifdeà
__USE_GNU


55 
	#O_DIRECT
 040000

	)

56 
	#O_NOATIME
 01000000

	)

62 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


63 
	#O_DSYNC
 010000

	)

64 
	#O_RSYNC
 
O_SYNC


	)

67 #ifdeà
__USE_LARGEFILE64


68 #ià
__WORDSIZE
 == 64

69 
	#O_LARGEFILE
 0

	)

71 
	#O_LARGEFILE
 0100000

	)

76 
	#F_DUPFD
 0

	)

77 
	#F_GETFD
 1

	)

78 
	#F_SETFD
 2

	)

79 
	#F_GETFL
 3

	)

80 
	#F_SETFL
 4

	)

81 #ià
__WORDSIZE
 == 64

82 
	#F_GETLK
 5

	)

83 
	#F_SETLK
 6

	)

84 
	#F_SETLKW
 7

	)

86 
	#F_GETLK64
 5

	)

87 
	#F_SETLK64
 6

	)

88 
	#F_SETLKW64
 7

	)

90 #iâdeà
__USE_FILE_OFFSET64


91 
	#F_GETLK
 5

	)

92 
	#F_SETLK
 6

	)

93 
	#F_SETLKW
 7

	)

95 
	#F_GETLK
 
F_GETLK64


	)

96 
	#F_SETLK
 
F_SETLK64


	)

97 
	#F_SETLKW
 
F_SETLKW64


	)

99 
	#F_GETLK64
 12

	)

100 
	#F_SETLK64
 13

	)

101 
	#F_SETLKW64
 14

	)

104 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


105 
	#F_SETOWN
 8

	)

106 
	#F_GETOWN
 9

	)

109 #ifdeà
__USE_GNU


110 
	#F_SETSIG
 10

	)

111 
	#F_GETSIG
 11

	)

112 
	#F_SETOWN_EX
 15

	)

113 
	#F_GETOWN_EX
 16

	)

116 #ifdeà
__USE_GNU


117 
	#F_SETLEASE
 1024

	)

118 
	#F_GETLEASE
 1025

	)

119 
	#F_NOTIFY
 1026

	)

121 #ifdeà
__USE_XOPEN2K8


122 
	#F_DUPFD_CLOEXEC
 1030

	)

127 
	#FD_CLOEXEC
 1

	)

130 
	#F_RDLCK
 0

	)

131 
	#F_WRLCK
 1

	)

132 
	#F_UNLCK
 2

	)

135 
	#F_EXLCK
 4

	)

136 
	#F_SHLCK
 8

	)

138 #ifdeà
__USE_BSD


140 
	#LOCK_SH
 1

	)

141 
	#LOCK_EX
 2

	)

142 
	#LOCK_NB
 4

	)

144 
	#LOCK_UN
 8

	)

147 #ifdeà
__USE_GNU


148 
	#LOCK_MAND
 32

	)

149 
	#LOCK_READ
 64

	)

150 
	#LOCK_WRITE
 128

	)

151 
	#LOCK_RW
 192

	)

154 #ifdeà
__USE_GNU


156 
	#DN_ACCESS
 0x00000001

	)

157 
	#DN_MODIFY
 0x00000002

	)

158 
	#DN_CREATE
 0x00000004

	)

159 
	#DN_DELETE
 0x00000008

	)

160 
	#DN_RENAME
 0x00000010

	)

161 
	#DN_ATTRIB
 0x00000020

	)

162 
	#DN_MULTISHOT
 0x80000000

	)

165 
	sæock


167 
	ml_ty³
;

168 
	ml_wh’û
;

169 #iâdeà
__USE_FILE_OFFSET64


170 
__off_t
 
	ml_¡¬t
;

171 
__off_t
 
	ml_Ën
;

173 
__off64_t
 
	ml_¡¬t
;

174 
__off64_t
 
	ml_Ën
;

176 
__pid_t
 
	ml_pid
;

179 #ifdeà
__USE_LARGEFILE64


180 
	sæock64


182 
	ml_ty³
;

183 
	ml_wh’û
;

184 
__off64_t
 
	ml_¡¬t
;

185 
__off64_t
 
	ml_Ën
;

186 
__pid_t
 
	ml_pid
;

190 #ifdeà
__USE_GNU


192 
	e__pid_ty³


194 
	mF_OWNER_TID
 = 0,

195 
	mF_OWNER_PID
,

196 
	mF_OWNER_PGRP
,

197 
	mF_OWNER_GID
 = 
F_OWNER_PGRP


201 
	sf_owÃr_ex


203 
__pid_ty³
 
	mty³
;

204 
__pid_t
 
	mpid
;

210 #ifdef 
__USE_BSD


211 
	#FAPPEND
 
O_APPEND


	)

212 
	#FFSYNC
 
O_FSYNC


	)

213 
	#FASYNC
 
O_ASYNC


	)

214 
	#FNONBLOCK
 
O_NONBLOCK


	)

215 
	#FNDELAY
 
O_NDELAY


	)

219 #ifdeà
__USE_XOPEN2K


220 
	#POSIX_FADV_NORMAL
 0

	)

221 
	#POSIX_FADV_RANDOM
 1

	)

222 
	#POSIX_FADV_SEQUENTIAL
 2

	)

223 
	#POSIX_FADV_WILLNEED
 3

	)

224 
	#POSIX_FADV_DONTNEED
 4

	)

225 
	#POSIX_FADV_NOREUSE
 5

	)

229 #ifdeà
__USE_GNU


231 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

234 
	#SYNC_FILE_RANGE_WRITE
 2

	)

237 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

242 
	#SPLICE_F_MOVE
 1

	)

243 
	#SPLICE_F_NONBLOCK
 2

	)

246 
	#SPLICE_F_MORE
 4

	)

247 
	#SPLICE_F_GIFT
 8

	)

250 
	g__BEGIN_DECLS


252 #ifdeà
__USE_GNU


255 
ssize_t
 
	$»adah—d
 (
__fd
, 
__off64_t
 
__off£t
, 
size_t
 
__couÁ
)

256 
__THROW
;

260 
	`sync_fe_¿nge
 (
__fd
, 
__off64_t
 
__off£t
, __off64_ˆ
__couÁ
,

261 
__æags
);

265 
ssize_t
 
	`vm¥liû
 (
__fdout
, cÚ¡ 
iovec
 *
__iov
,

266 
size_t
 
__couÁ
, 
__æags
);

269 
ssize_t
 
	`¥liû
 (
__fdš
, 
__off64_t
 *
__offš
, 
__fdout
,

270 
__off64_t
 *
__offout
, 
size_t
 
__Ën
,

271 
__æags
);

274 
ssize_t
 
	`‹e
 (
__fdš
, 
__fdout
, 
size_t
 
__Ën
,

275 
__æags
);

278 #iâdeà
__USE_FILE_OFFSET64


279 
	`çÎoÿ‹
 (
__fd
, 
__mode
, 
__off_t
 
__off£t
, __off_ˆ
__Ën
);

281 #ifdeà
__REDIRECT


282 
	`__REDIRECT
 (
çÎoÿ‹
, (
__fd
, 
__mode
, 
__off64_t
 
__off£t
,

283 
__off64_t
 
__Ën
),

284 
çÎoÿ‹64
);

286 
	#çÎoÿ‹
 
çÎoÿ‹64


	)

289 #ifdeà
__USE_LARGEFILE64


290 
	`çÎoÿ‹64
 (
__fd
, 
__mode
, 
__off64_t
 
__off£t
,

291 
__off64_t
 
__Ën
);

295 
__END_DECLS


	@/usr/include/bits/fcntl2.h

20 #iâdef 
_FCNTL_H


26 #iâdeà
__USE_FILE_OFFSET64


27 
	$__İ’_2
 (
__cÚ¡
 *
__·th
, 
__oæag
è
	`__nÚnuÎ
 ((1));

28 
	`__REDIRECT
 (
__İ’_®Ÿs
, (
__cÚ¡
 *
__·th
, 
__oæag
, ...),

29 
İ’
è
	`__nÚnuÎ
 ((1));

31 
	`__REDIRECT
 (
__İ’_2
, (
__cÚ¡
 *
__·th
, 
__oæag
),

32 
__İ’64_2
è
	`__nÚnuÎ
 ((1));

33 
	`__REDIRECT
 (
__İ’_®Ÿs
, (
__cÚ¡
 *
__·th
, 
__oæag
, ...),

34 
İ’64
è
	`__nÚnuÎ
 ((1));

36 
	`__”rÜdeş
 (
__İ’_too_mªy_¬gs
,

38 
	`__”rÜdeş
 (
__İ’_missšg_mode
,

41 
__ex‹º_®ways_šlše
 

42 
	$İ’
 (
__cÚ¡
 *
__·th
, 
__oæag
, ...)

44 ià(
	`__va_¬g_·ck_Ën
 () > 1)

45 
	`__İ’_too_mªy_¬gs
 ();

47 ià(
	`__butš_cÚ¡ªt_p
 (
__oæag
))

49 ià((
__oæag
 & 
O_CREAT
è!ğ0 && 
	`__va_¬g_·ck_Ën
 () < 1)

51 
	`__İ’_missšg_mode
 ();

52  
	`__İ’_2
 (
__·th
, 
__oæag
);

54  
	`__İ’_®Ÿs
 (
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

57 ià(
	`__va_¬g_·ck_Ën
 () < 1)

58  
	`__İ’_2
 (
__·th
, 
__oæag
);

60  
	`__İ’_®Ÿs
 (
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

61 
	}
}

64 #ifdeà
__USE_LARGEFILE64


65 
	$__İ’64_2
 (
__cÚ¡
 *
__·th
, 
__oæag
è
	`__nÚnuÎ
 ((1));

66 
	`__REDIRECT
 (
__İ’64_®Ÿs
, (
__cÚ¡
 *
__·th
, 
__oæag
,

67 ...), 
İ’64
è
	`__nÚnuÎ
 ((1));

68 
	`__”rÜdeş
 (
__İ’64_too_mªy_¬gs
,

70 
	`__”rÜdeş
 (
__İ’64_missšg_mode
,

73 
__ex‹º_®ways_šlše
 

74 
	$İ’64
 (
__cÚ¡
 *
__·th
, 
__oæag
, ...)

76 ià(
	`__va_¬g_·ck_Ën
 () > 1)

77 
	`__İ’64_too_mªy_¬gs
 ();

79 ià(
	`__butš_cÚ¡ªt_p
 (
__oæag
))

81 ià((
__oæag
 & 
O_CREAT
è!ğ0 && 
	`__va_¬g_·ck_Ën
 () < 1)

83 
	`__İ’64_missšg_mode
 ();

84  
	`__İ’64_2
 (
__·th
, 
__oæag
);

86  
	`__İ’64_®Ÿs
 (
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

89 ià(
	`__va_¬g_·ck_Ën
 () < 1)

90  
	`__İ’64_2
 (
__·th
, 
__oæag
);

92  
	`__İ’64_®Ÿs
 (
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

93 
	}
}

97 #ifdeà
__USE_ATFILE


98 #iâdeà
__USE_FILE_OFFSET64


99 
	$__İ’©_2
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__oæag
)

100 
	`__nÚnuÎ
 ((2));

101 
	`__REDIRECT
 (
__İ’©_®Ÿs
, (
__fd
, 
__cÚ¡
 *
__·th
,

102 
__oæag
, ...), 
İ’©
)

103 
	`__nÚnuÎ
 ((2));

105 
	`__REDIRECT
 (
__İ’©_2
, (
__fd
, 
__cÚ¡
 *
__·th
,

106 
__oæag
), 
__İ’©64_2
)

107 
	`__nÚnuÎ
 ((2));

108 
	`__REDIRECT
 (
__İ’©_®Ÿs
, (
__fd
, 
__cÚ¡
 *
__·th
,

109 
__oæag
, ...), 
İ’©64
)

110 
	`__nÚnuÎ
 ((2));

112 
	`__”rÜdeş
 (
__İ’©_too_mªy_¬gs
,

114 
	`__”rÜdeş
 (
__İ’©_missšg_mode
,

117 
__ex‹º_®ways_šlše
 

118 
	$İ’©
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__oæag
, ...)

120 ià(
	`__va_¬g_·ck_Ën
 () > 1)

121 
	`__İ’©_too_mªy_¬gs
 ();

123 ià(
	`__butš_cÚ¡ªt_p
 (
__oæag
))

125 ià((
__oæag
 & 
O_CREAT
è!ğ0 && 
	`__va_¬g_·ck_Ën
 () < 1)

127 
	`__İ’©_missšg_mode
 ();

128  
	`__İ’©_2
 (
__fd
, 
__·th
, 
__oæag
);

130  
	`__İ’©_®Ÿs
 (
__fd
, 
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

133 ià(
	`__va_¬g_·ck_Ën
 () < 1)

134  
	`__İ’©_2
 (
__fd
, 
__·th
, 
__oæag
);

136  
	`__İ’©_®Ÿs
 (
__fd
, 
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

137 
	}
}

140 #ifdeà
__USE_LARGEFILE64


141 
	$__İ’©64_2
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__oæag
)

142 
	`__nÚnuÎ
 ((2));

143 
	`__REDIRECT
 (
__İ’©64_®Ÿs
, (
__fd
, 
__cÚ¡
 *
__·th
,

144 
__oæag
, ...), 
İ’©64
)

145 
	`__nÚnuÎ
 ((2));

146 
	`__”rÜdeş
 (
__İ’©64_too_mªy_¬gs
,

148 
	`__”rÜdeş
 (
__İ’©64_missšg_mode
,

151 
__ex‹º_®ways_šlše
 

152 
	$İ’©64
 (
__fd
, 
__cÚ¡
 *
__·th
, 
__oæag
, ...)

154 ià(
	`__va_¬g_·ck_Ën
 () > 1)

155 
	`__İ’©64_too_mªy_¬gs
 ();

157 ià(
	`__butš_cÚ¡ªt_p
 (
__oæag
))

159 ià((
__oæag
 & 
O_CREAT
è!ğ0 && 
	`__va_¬g_·ck_Ën
 () < 1)

161 
	`__İ’©64_missšg_mode
 ();

162  
	`__İ’©64_2
 (
__fd
, 
__·th
, 
__oæag
);

164  
	`__İ’©64_®Ÿs
 (
__fd
, 
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

167 ià(
	`__va_¬g_·ck_Ën
 () < 1)

168  
	`__İ’©64_2
 (
__fd
, 
__·th
, 
__oæag
);

170  
	`__İ’©64_®Ÿs
 (
__fd
, 
__·th
, 
__oæag
, 
	`__va_¬g_·ck
 ());

171 
	}
}

	@/usr/include/bits/posix_opt.h

20 #iâdef 
_BITS_POSIX_OPT_H


21 
	#_BITS_POSIX_OPT_H
 1

	)

24 
	#_POSIX_JOB_CONTROL
 1

	)

27 
	#_POSIX_SAVED_IDS
 1

	)

30 
	#_POSIX_PRIORITY_SCHEDULING
 200809L

	)

33 
	#_POSIX_SYNCHRONIZED_IO
 200809L

	)

36 
	#_POSIX_FSYNC
 200809L

	)

39 
	#_POSIX_MAPPED_FILES
 200809L

	)

42 
	#_POSIX_MEMLOCK
 200809L

	)

45 
	#_POSIX_MEMLOCK_RANGE
 200809L

	)

48 
	#_POSIX_MEMORY_PROTECTION
 200809L

	)

51 
	#_POSIX_CHOWN_RESTRICTED
 0

	)

55 
	#_POSIX_VDISABLE
 '\0'

	)

58 
	#_POSIX_NO_TRUNC
 1

	)

61 
	#_XOPEN_REALTIME
 1

	)

64 
	#_XOPEN_REALTIME_THREADS
 1

	)

67 
	#_XOPEN_SHM
 1

	)

70 
	#_POSIX_THREADS
 200809L

	)

73 
	#_POSIX_REENTRANT_FUNCTIONS
 1

	)

74 
	#_POSIX_THREAD_SAFE_FUNCTIONS
 200809L

	)

77 
	#_POSIX_THREAD_PRIORITY_SCHEDULING
 200809L

	)

80 
	#_POSIX_THREAD_ATTR_STACKSIZE
 200809L

	)

83 
	#_POSIX_THREAD_ATTR_STACKADDR
 200809L

	)

86 
	#_POSIX_THREAD_PRIO_INHERIT
 200809L

	)

90 
	#_POSIX_THREAD_PRIO_PROTECT
 200809L

	)

92 #ifdeà
__USE_XOPEN2K8


94 
	#_POSIX_THREAD_ROBUST_PRIO_INHERIT
 200809L

	)

97 
	#_POSIX_THREAD_ROBUST_PRIO_PROTECT
 -1

	)

101 
	#_POSIX_SEMAPHORES
 200809L

	)

104 
	#_POSIX_REALTIME_SIGNALS
 200809L

	)

107 
	#_POSIX_ASYNCHRONOUS_IO
 200809L

	)

108 
	#_POSIX_ASYNC_IO
 1

	)

110 
	#_LFS_ASYNCHRONOUS_IO
 1

	)

112 
	#_POSIX_PRIORITIZED_IO
 200809L

	)

115 
	#_LFS64_ASYNCHRONOUS_IO
 1

	)

118 
	#_LFS_LARGEFILE
 1

	)

119 
	#_LFS64_LARGEFILE
 1

	)

120 
	#_LFS64_STDIO
 1

	)

123 
	#_POSIX_SHARED_MEMORY_OBJECTS
 200809L

	)

126 
	#_POSIX_CPUTIME
 0

	)

129 
	#_POSIX_THREAD_CPUTIME
 0

	)

132 
	#_POSIX_REGEXP
 1

	)

135 
	#_POSIX_READER_WRITER_LOCKS
 200809L

	)

138 
	#_POSIX_SHELL
 1

	)

141 
	#_POSIX_TIMEOUTS
 200809L

	)

144 
	#_POSIX_SPIN_LOCKS
 200809L

	)

147 
	#_POSIX_SPAWN
 200809L

	)

150 
	#_POSIX_TIMERS
 200809L

	)

153 
	#_POSIX_BARRIERS
 200809L

	)

156 
	#_POSIX_MESSAGE_PASSING
 200809L

	)

159 
	#_POSIX_THREAD_PROCESS_SHARED
 200809L

	)

162 
	#_POSIX_MONOTONIC_CLOCK
 0

	)

165 
	#_POSIX_CLOCK_SELECTION
 200809L

	)

168 
	#_POSIX_ADVISORY_INFO
 200809L

	)

171 
	#_POSIX_IPV6
 200809L

	)

174 
	#_POSIX_RAW_SOCKETS
 200809L

	)

177 
	#_POSIX2_CHAR_TERM
 200809L

	)

180 
	#_POSIX_SPORADIC_SERVER
 -1

	)

181 
	#_POSIX_THREAD_SPORADIC_SERVER
 -1

	)

184 
	#_POSIX_TRACE
 -1

	)

185 
	#_POSIX_TRACE_EVENT_FILTER
 -1

	)

186 
	#_POSIX_TRACE_INHERIT
 -1

	)

187 
	#_POSIX_TRACE_LOG
 -1

	)

190 
	#_POSIX_TYPED_MEMORY_OBJECTS
 -1

	)

193 
	#_XOPEN_STREAMS
 -1

	)

	@/usr/include/bits/pthreadtypes.h

20 #iâdeà
_BITS_PTHREADTYPES_H


21 
	#_BITS_PTHREADTYPES_H
 1

	)

23 
	~<b™s/wÜdsize.h
>

25 #ià
__WORDSIZE
 == 64

26 
	#__SIZEOF_PTHREAD_ATTR_T
 56

	)

27 
	#__SIZEOF_PTHREAD_MUTEX_T
 40

	)

28 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

29 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

30 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

31 
	#__SIZEOF_PTHREAD_RWLOCK_T
 56

	)

32 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

33 
	#__SIZEOF_PTHREAD_BARRIER_T
 32

	)

34 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

36 
	#__SIZEOF_PTHREAD_ATTR_T
 36

	)

37 
	#__SIZEOF_PTHREAD_MUTEX_T
 24

	)

38 
	#__SIZEOF_PTHREAD_MUTEXATTR_T
 4

	)

39 
	#__SIZEOF_PTHREAD_COND_T
 48

	)

40 
	#__SIZEOF_PTHREAD_CONDATTR_T
 4

	)

41 
	#__SIZEOF_PTHREAD_RWLOCK_T
 32

	)

42 
	#__SIZEOF_PTHREAD_RWLOCKATTR_T
 8

	)

43 
	#__SIZEOF_PTHREAD_BARRIER_T
 20

	)

44 
	#__SIZEOF_PTHREAD_BARRIERATTR_T
 4

	)

50 
	t±h»ad_t
;

55 
	m__size
[
__SIZEOF_PTHREAD_ATTR_T
];

56 
	m__®ign
;

57 } 
	t±h»ad_©Œ_t
;

60 #ià
__WORDSIZE
 == 64

61 
	s__±h»ad_š‹º®_li¡


63 
__±h»ad_š‹º®_li¡
 *
	m__´ev
;

64 
__±h»ad_š‹º®_li¡
 *
	m__Ãxt
;

65 } 
	t__±h»ad_li¡_t
;

67 
	s__±h»ad_š‹º®_¦i¡


69 
__±h»ad_š‹º®_¦i¡
 *
	m__Ãxt
;

70 } 
	t__±h»ad_¦i¡_t
;

78 
	s__±h»ad_mu‹x_s


80 
	m__lock
;

81 
	m__couÁ
;

82 
	m__owÃr
;

83 #ià
__WORDSIZE
 == 64

84 
	m__nu£rs
;

88 
	m__kšd
;

89 #ià
__WORDSIZE
 == 64

90 
	m__¥šs
;

91 
__±h»ad_li¡_t
 
	m__li¡
;

92 
	#__PTHREAD_MUTEX_HAVE_PREV
 1

	)

94 
	m__nu£rs
;

95 
__ex‹nsiÚ__
 union

97 
	m__¥šs
;

98 
__±h»ad_¦i¡_t
 
	m__li¡
;

101 } 
	m__d©a
;

102 
	m__size
[
__SIZEOF_PTHREAD_MUTEX_T
];

103 
	m__®ign
;

104 } 
	t±h»ad_mu‹x_t
;

108 
	m__size
[
__SIZEOF_PTHREAD_MUTEXATTR_T
];

109 
	m__®ign
;

110 } 
	t±h»ad_mu‹x©Œ_t
;

119 
	m__lock
;

120 
	m__fu‹x
;

121 
__ex‹nsiÚ__
 
	m__tÙ®_£q
;

122 
__ex‹nsiÚ__
 
	m__wakeup_£q
;

123 
__ex‹nsiÚ__
 
	m__wok’_£q
;

124 *
	m__mu‹x
;

125 
	m__nwa™”s
;

126 
	m__brßdÿ¡_£q
;

127 } 
	m__d©a
;

128 
	m__size
[
__SIZEOF_PTHREAD_COND_T
];

129 
__ex‹nsiÚ__
 
	m__®ign
;

130 } 
	t±h»ad_cÚd_t
;

134 
	m__size
[
__SIZEOF_PTHREAD_CONDATTR_T
];

135 
	m__®ign
;

136 } 
	t±h»ad_cÚd©Œ_t
;

140 
	t±h»ad_key_t
;

144 
	t±h»ad_Úû_t
;

147 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


152 #ià
__WORDSIZE
 == 64

155 
	m__lock
;

156 
	m__Ä_»ad”s
;

157 
	m__»ad”s_wakeup
;

158 
	m__wr™”_wakeup
;

159 
	m__Ä_»ad”s_queued
;

160 
	m__Ä_wr™”s_queued
;

161 
	m__wr™”
;

162 
	m__sh¬ed
;

163 
	m__·d1
;

164 
	m__·d2
;

167 
	m__æags
;

168 } 
	m__d©a
;

172 
	m__lock
;

173 
	m__Ä_»ad”s
;

174 
	m__»ad”s_wakeup
;

175 
	m__wr™”_wakeup
;

176 
	m__Ä_»ad”s_queued
;

177 
	m__Ä_wr™”s_queued
;

180 
	m__æags
;

181 
	m__sh¬ed
;

182 
	m__·d1
;

183 
	m__·d2
;

184 
	m__wr™”
;

185 } 
	m__d©a
;

187 
	m__size
[
__SIZEOF_PTHREAD_RWLOCK_T
];

188 
	m__®ign
;

189 } 
	t±h»ad_rwlock_t
;

193 
	m__size
[
__SIZEOF_PTHREAD_RWLOCKATTR_T
];

194 
	m__®ign
;

195 } 
	t±h»ad_rwlock©Œ_t
;

199 #ifdeà
__USE_XOPEN2K


201 vŞ©
	t±h»ad_¥šlock_t
;

208 
	m__size
[
__SIZEOF_PTHREAD_BARRIER_T
];

209 
	m__®ign
;

210 } 
	t±h»ad_b¬r›r_t
;

214 
	m__size
[
__SIZEOF_PTHREAD_BARRIERATTR_T
];

215 
	m__®ign
;

216 } 
	t±h»ad_b¬r›¿‰r_t
;

220 #ià
__WORDSIZE
 == 32

222 
	#__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
	`__»g·rm__
 (1)))

	)

	@/usr/include/bits/stat.h

19 #ià!
defšed
 
_SYS_STAT_H
 && !defšed 
_FCNTL_H


23 #iâdeà
_BITS_STAT_H


24 
	#_BITS_STAT_H
 1

	)

27 
	#_STAT_VER_KERNEL
 0

	)

29 #ià
__WORDSIZE
 == 32

30 
	#_STAT_VER_SVR4
 2

	)

31 
	#_STAT_VER_LINUX
 3

	)

34 
	#_MKNOD_VER_LINUX
 1

	)

35 
	#_MKNOD_VER_SVR4
 2

	)

36 
	#_MKNOD_VER
 
_MKNOD_VER_LINUX


	)

38 
	#_STAT_VER_LINUX
 1

	)

41 
	#_MKNOD_VER_LINUX
 0

	)

44 
	#_STAT_VER
 
_STAT_VER_LINUX


	)

46 
	s¡©


48 
__dev_t
 
	m¡_dev
;

49 #ià
__WORDSIZE
 == 32

50 
	m__·d1
;

52 #ià
__WORDSIZE
 =ğ64 || !
defšed
 
__USE_FILE_OFFSET64


53 
__šo_t
 
	m¡_šo
;

55 
__šo_t
 
	m__¡_šo
;

57 #ià
__WORDSIZE
 == 32

58 
__mode_t
 
	m¡_mode
;

59 
__Æšk_t
 
	m¡_Æšk
;

61 
__Æšk_t
 
	m¡_Æšk
;

62 
__mode_t
 
	m¡_mode
;

64 
__uid_t
 
	m¡_uid
;

65 
__gid_t
 
	m¡_gid
;

66 #ià
__WORDSIZE
 == 64

67 
	m__·d0
;

69 
__dev_t
 
	m¡_rdev
;

70 #ià
__WORDSIZE
 == 32

71 
	m__·d2
;

73 #ià
__WORDSIZE
 =ğ64 || !
defšed
 
__USE_FILE_OFFSET64


74 
__off_t
 
	m¡_size
;

76 
__off64_t
 
	m¡_size
;

78 
__blksize_t
 
	m¡_blksize
;

79 #ià
__WORDSIZE
 =ğ64 || !
defšed
 
__USE_FILE_OFFSET64


80 
__blkút_t
 
	m¡_blocks
;

82 
__blkút64_t
 
	m¡_blocks
;

84 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K8


91 
time¥ec
 
	m¡_©im
;

92 
time¥ec
 
	m¡_mtim
;

93 
time¥ec
 
	m¡_ùim
;

94 
	#¡_©ime
 
¡_©im
.
tv_£c


	)

95 
	#¡_mtime
 
¡_mtim
.
tv_£c


	)

96 
	#¡_ùime
 
¡_ùim
.
tv_£c


	)

98 
__time_t
 
	m¡_©ime
;

99 
	m¡_©im’£c
;

100 
__time_t
 
	m¡_mtime
;

101 
	m¡_mtim’£c
;

102 
__time_t
 
	m¡_ùime
;

103 
	m¡_ùim’£c
;

105 #ià
__WORDSIZE
 == 64

106 
	m__unu£d
[3];

108 #iâdeà
__USE_FILE_OFFSET64


109 
	m__unu£d4
;

110 
	m__unu£d5
;

112 
__šo64_t
 
	m¡_šo
;

117 #ifdeà
__USE_LARGEFILE64


119 
	s¡©64


121 
__dev_t
 
	m¡_dev
;

122 #ià
__WORDSIZE
 == 64

123 
__šo64_t
 
	m¡_šo
;

124 
__Æšk_t
 
	m¡_Æšk
;

125 
__mode_t
 
	m¡_mode
;

127 
	m__·d1
;

128 
__šo_t
 
	m__¡_šo
;

129 
__mode_t
 
	m¡_mode
;

130 
__Æšk_t
 
	m¡_Æšk
;

132 
__uid_t
 
	m¡_uid
;

133 
__gid_t
 
	m¡_gid
;

134 #ià
__WORDSIZE
 == 64

135 
	m__·d0
;

136 
__dev_t
 
	m¡_rdev
;

137 
__off_t
 
	m¡_size
;

139 
__dev_t
 
	m¡_rdev
;

140 
	m__·d2
;

141 
__off64_t
 
	m¡_size
;

143 
__blksize_t
 
	m¡_blksize
;

144 
__blkút64_t
 
	m¡_blocks
;

145 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN2K8


152 
time¥ec
 
	m¡_©im
;

153 
time¥ec
 
	m¡_mtim
;

154 
time¥ec
 
	m¡_ùim
;

155 
	#¡_©ime
 
¡_©im
.
tv_£c


	)

156 
	#¡_mtime
 
¡_mtim
.
tv_£c


	)

157 
	#¡_ùime
 
¡_ùim
.
tv_£c


	)

159 
__time_t
 
	m¡_©ime
;

160 
	m¡_©im’£c
;

161 
__time_t
 
	m¡_mtime
;

162 
	m¡_mtim’£c
;

163 
__time_t
 
	m¡_ùime
;

164 
	m¡_ùim’£c
;

166 #ià
__WORDSIZE
 == 64

167 
	m__unu£d
[3];

169 
__šo64_t
 
	m¡_šo
;

175 
	#_STATBUF_ST_BLKSIZE


	)

176 
	#_STATBUF_ST_RDEV


	)

178 
	#_STATBUF_ST_NSEC


	)

182 
	#__S_IFMT
 0170000

	)

185 
	#__S_IFDIR
 0040000

	)

186 
	#__S_IFCHR
 0020000

	)

187 
	#__S_IFBLK
 0060000

	)

188 
	#__S_IFREG
 0100000

	)

189 
	#__S_IFIFO
 0010000

	)

190 
	#__S_IFLNK
 0120000

	)

191 
	#__S_IFSOCK
 0140000

	)

195 
	#__S_TYPEISMQ
(
buf
è((buf)->
¡_mode
 - (buf)->¡_mode)

	)

196 
	#__S_TYPEISSEM
(
buf
è((buf)->
¡_mode
 - (buf)->¡_mode)

	)

197 
	#__S_TYPEISSHM
(
buf
è((buf)->
¡_mode
 - (buf)->¡_mode)

	)

201 
	#__S_ISUID
 04000

	)

202 
	#__S_ISGID
 02000

	)

203 
	#__S_ISVTX
 01000

	)

204 
	#__S_IREAD
 0400

	)

205 
	#__S_IWRITE
 0200

	)

206 
	#__S_IEXEC
 0100

	)

208 #ifdeà
__USE_ATFILE


209 
	#UTIME_NOW
 ((1È<< 30è- 1l)

	)

210 
	#UTIME_OMIT
 ((1È<< 30è- 2l)

	)

	@/usr/include/bits/stdio-ldbl.h

20 #iâdeà
_STDIO_H


24 
__BEGIN_NAMESPACE_STD


25 
	$__LDBL_REDIR_DECL
 (
årštf
)

26 
	$__LDBL_REDIR_DECL
 (
´štf
)

27 
	$__LDBL_REDIR_DECL
 (
¥rštf
)

28 
	$__LDBL_REDIR_DECL
 (
vårštf
)

29 
	$__LDBL_REDIR_DECL
 (
v´štf
)

30 
	$__LDBL_REDIR_DECL
 (
v¥rštf
)

31 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

32 && !
defšed
 
__REDIRECT
 \

33 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

34 
	$__LDBL_REDIR1_DECL
 (
fsÿnf
, 
__Ædbl___isoc99_fsÿnf
)

35 
	$__LDBL_REDIR1_DECL
 (
sÿnf
, 
__Ædbl___isoc99_sÿnf
)

36 
	$__LDBL_REDIR1_DECL
 (
ssÿnf
, 
__Ædbl___isoc99_ssÿnf
)

38 
	$__LDBL_REDIR_DECL
 (
fsÿnf
)

39 
	$__LDBL_REDIR_DECL
 (
sÿnf
)

40 
	$__LDBL_REDIR_DECL
 (
ssÿnf
)

42 
__END_NAMESPACE_STD


44 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


45 
__BEGIN_NAMESPACE_C99


46 
	$__LDBL_REDIR_DECL
 (
¢´štf
)

47 
	$__LDBL_REDIR_DECL
 (
v¢´štf
)

48 
__END_NAMESPACE_C99


51 #ifdef 
__USE_ISOC99


52 
__BEGIN_NAMESPACE_C99


53 #ià!
defšed
 
__USE_GNU
 && !defšed 
__REDIRECT
 \

54 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

55 
	$__LDBL_REDIR1_DECL
 (
vfsÿnf
, 
__Ædbl___isoc99_vfsÿnf
)

56 
	$__LDBL_REDIR1_DECL
 (
vsÿnf
, 
__Ædbl___isoc99_vsÿnf
)

57 
	$__LDBL_REDIR1_DECL
 (
vssÿnf
, 
__Ædbl___isoc99_vssÿnf
)

59 
	$__LDBL_REDIR_DECL
 (
vfsÿnf
)

60 
	$__LDBL_REDIR_DECL
 (
vssÿnf
)

61 
	$__LDBL_REDIR_DECL
 (
vsÿnf
)

63 
__END_NAMESPACE_C99


66 #ifdeà
__USE_GNU


67 
	$__LDBL_REDIR_DECL
 (
vd´štf
)

68 
	$__LDBL_REDIR_DECL
 (
d´štf
)

69 
	$__LDBL_REDIR_DECL
 (
va¥rštf
)

70 
	$__LDBL_REDIR_DECL
 (
__a¥rštf
)

71 
	$__LDBL_REDIR_DECL
 (
a¥rštf
)

72 
	$__LDBL_REDIR_DECL
 (
ob¡ack_´štf
)

73 
	$__LDBL_REDIR_DECL
 (
ob¡ack_v´štf
)

76 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


77 
	$__LDBL_REDIR_DECL
 (
__¥rštf_chk
)

78 
	$__LDBL_REDIR_DECL
 (
__v¥rštf_chk
)

79 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


80 
	$__LDBL_REDIR_DECL
 (
__¢´štf_chk
)

81 
	$__LDBL_REDIR_DECL
 (
__v¢´štf_chk
)

83 #ià
__USE_FORTIFY_LEVEL
 > 1

84 
	$__LDBL_REDIR_DECL
 (
__årštf_chk
)

85 
	$__LDBL_REDIR_DECL
 (
__´štf_chk
)

86 
	$__LDBL_REDIR_DECL
 (
__vårštf_chk
)

87 
	$__LDBL_REDIR_DECL
 (
__v´štf_chk
)

88 #ifdeà
__USE_GNU


89 
	$__LDBL_REDIR_DECL
 (
__a¥rštf_chk
)

90 
	$__LDBL_REDIR_DECL
 (
__va¥rštf_chk
)

91 
	$__LDBL_REDIR_DECL
 (
__d´štf_chk
)

92 
	$__LDBL_REDIR_DECL
 (
__vd´štf_chk
)

93 
	$__LDBL_REDIR_DECL
 (
__ob¡ack_´štf_chk
)

94 
	$__LDBL_REDIR_DECL
 (
__ob¡ack_v´štf_chk
)

	@/usr/include/bits/stdio.h

20 #iâdeà
_STDIO_H


24 #iâdeà
__ex‹º_šlše


25 
	#__STDIO_INLINE
 
šlše


	)

27 
	#__STDIO_INLINE
 
__ex‹º_šlše


	)

31 #ifdeà
__USE_EXTERN_INLINES


34 #ià!(
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše
)

36 
__STDIO_INLINE
 

37 
	$v´štf
 (
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__¬g
)

39  
	`vårštf
 (
¡dout
, 
__fmt
, 
__¬g
);

40 
	}
}

44 
__STDIO_INLINE
 

45 
	$g‘ch¬
 ()

47  
	`_IO_g‘c
 (
¡dš
);

48 
	}
}

51 #ifdeà
__USE_MISC


53 
__STDIO_INLINE
 

54 
	$fg‘c_uÆocked
 (
FILE
 *
__å
)

56  
	`_IO_g‘c_uÆocked
 (
__å
);

57 
	}
}

61 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


63 
__STDIO_INLINE
 

64 
	$g‘c_uÆocked
 (
FILE
 *
__å
)

66  
	`_IO_g‘c_uÆocked
 (
__å
);

67 
	}
}

70 
__STDIO_INLINE
 

71 
	$g‘ch¬_uÆocked
 ()

73  
	`_IO_g‘c_uÆocked
 (
¡dš
);

74 
	}
}

79 
__STDIO_INLINE
 

80 
	$putch¬
 (
__c
)

82  
	`_IO_putc
 (
__c
, 
¡dout
);

83 
	}
}

86 #ifdeà
__USE_MISC


88 
__STDIO_INLINE
 

89 
	$åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
)

91  
	`_IO_putc_uÆocked
 (
__c
, 
__¡»am
);

92 
	}
}

96 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


98 
__STDIO_INLINE
 

99 
	$putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
)

101  
	`_IO_putc_uÆocked
 (
__c
, 
__¡»am
);

102 
	}
}

105 
__STDIO_INLINE
 

106 
	$putch¬_uÆocked
 (
__c
)

108  
	`_IO_putc_uÆocked
 (
__c
, 
¡dout
);

109 
	}
}

113 #ifdef 
__USE_GNU


115 
__STDIO_INLINE
 
_IO_ssize_t


116 
	$g‘lše
 (**
__lš•Œ
, 
size_t
 *
__n
, 
FILE
 *
__¡»am
)

118  
	`__g‘d–im
 (
__lš•Œ
, 
__n
, '\n', 
__¡»am
);

119 
	}
}

123 #ifdeà
__USE_MISC


125 
__STDIO_INLINE
 

126 
__NTH
 (
	$ãof_uÆocked
 (
FILE
 *
__¡»am
))

128  
	`_IO_ãof_uÆocked
 (
__¡»am
);

129 
	}
}

132 
__STDIO_INLINE
 

133 
__NTH
 (
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
))

135  
	`_IO_ã¼Ü_uÆocked
 (
__¡»am
);

136 
	}
}

142 #ià
defšed
 
__USE_MISC
 && defšed 
__GNUC__
 && defšed 
__OPTIMIZE__
 \

143 && !
defšed
 
	g__ılu¥lus


145 
	#ä—d_uÆocked
(
±r
, 
size
, 
n
, 
¡»am
) \

146 (
	`__ex‹nsiÚ__
 ((
	`__butš_cÚ¡ªt_p
 (
size
è&& __butš_cÚ¡ªt_°(
n
) \

147 && (
size_t
è(
size
è* (size_tè(
n
) <= 8 \

148 && (
size_t
è(
size
) != 0) \

149 ? ({ *
__±r
 = (*è(
±r
); \

150 
FILE
 *
__¡»am
 = (
¡»am
); \

151 
size_t
 
__út
; \

152 
__út
 = (
size_t
è(
size
è* (size_tè(
n
); \

153 
__út
 > 0; --__cnt) \

155 
__c
 = 
	`_IO_g‘c_uÆocked
 (
__¡»am
); \

156 ià(
__c
 =ğ
EOF
) \

158 *
__±r
++ = 
__c
; \

160 ((
size_t
è(
size
è* (size_tè(
n
è- 
__út
) \

161 / (
size_t
è(
size
); }) \

162 : (((
	`__butš_cÚ¡ªt_p
 (
size
è&& (
size_t
) (size) == 0) \

163 || (
	`__butš_cÚ¡ªt_p
 (
n
è&& (
size_t
) (n) == 0)) \

165 ? ((è(
±r
), (è(
¡»am
), (è(
size
), \

166 (è(
n
), (
size_t
) 0) \

167 : 
	`ä—d_uÆocked
 (
±r
, 
size
, 
n
, 
¡»am
))))

	)

169 
	#fwr™e_uÆocked
(
±r
, 
size
, 
n
, 
¡»am
) \

170 (
	`__ex‹nsiÚ__
 ((
	`__butš_cÚ¡ªt_p
 (
size
è&& __butš_cÚ¡ªt_°(
n
) \

171 && (
size_t
è(
size
è* (size_tè(
n
) <= 8 \

172 && (
size_t
è(
size
) != 0) \

173 ? ({ cÚ¡ *
__±r
 = (cÚ¡ *è(
±r
); \

174 
FILE
 *
__¡»am
 = (
¡»am
); \

175 
size_t
 
__út
; \

176 
__út
 = (
size_t
è(
size
è* (size_tè(
n
); \

177 
__út
 > 0; --__cnt) \

178 ià(
	`_IO_putc_uÆocked
 (*
__±r
++, 
__¡»am
è=ğ
EOF
) \

180 ((
size_t
è(
size
è* (size_tè(
n
è- 
__út
) \

181 / (
size_t
è(
size
); }) \

182 : (((
	`__butš_cÚ¡ªt_p
 (
size
è&& (
size_t
) (size) == 0) \

183 || (
	`__butš_cÚ¡ªt_p
 (
n
è&& (
size_t
) (n) == 0)) \

185 ? ((è(
±r
), (è(
¡»am
), (è(
size
), \

186 (è(
n
), (
size_t
) 0) \

187 : 
	`fwr™e_uÆocked
 (
±r
, 
size
, 
n
, 
¡»am
))))

	)

191 #undeà
__STDIO_INLINE


	@/usr/include/bits/stdio2.h

20 #iâdeà
_STDIO_H


24 
	$__¥rštf_chk
 (*
__»¡riù
 
__s
, 
__æag
, 
size_t
 
__¦’
,

25 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

26 
	$__v¥rštf_chk
 (*
__»¡riù
 
__s
, 
__æag
, 
size_t
 
__¦’
,

27 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

28 
_G_va_li¡
 
__­
è
__THROW
;

30 #ifdeà
__va_¬g_·ck


31 
__ex‹º_®ways_šlše
 

32 
	`__NTH
 (
	$¥rštf
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fmt
, ...))

34  
	`__butš___¥rštf_chk
 (
__s
, 
__USE_FORTIFY_LEVEL
 - 1,

35 
	`__bos
 (
__s
), 
__fmt
, 
	`__va_¬g_·ck
 ());

36 
	}
}

37 #–ià!
defšed
 
__ılu¥lus


38 
	#¥rštf
(
¡r
, ...) \

39 
	`__butš___¥rštf_chk
 (
¡r
, 
__USE_FORTIFY_LEVEL
 - 1, 
	`__bos
 (str), \

40 
__VA_ARGS__
)

	)

43 
__ex‹º_®ways_šlše
 

44 
__NTH
 (
	$v¥rštf
 (*
__»¡riù
 
__s
, 
__cÚ¡
 *__»¡riù 
__fmt
,

45 
_G_va_li¡
 
__­
))

47  
	`__butš___v¥rštf_chk
 (
__s
, 
__USE_FORTIFY_LEVEL
 - 1,

48 
	`__bos
 (
__s
), 
__fmt
, 
__­
);

49 
	}
}

51 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_ISOC99
 || defšed 
__USE_UNIX98


53 
	$__¢´štf_chk
 (*
__»¡riù
 
__s
, 
size_t
 
__n
, 
__æag
,

54 
size_t
 
__¦’
, 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

55 ...è
__THROW
;

56 
	$__v¢´štf_chk
 (*
__»¡riù
 
__s
, 
size_t
 
__n
, 
__æag
,

57 
size_t
 
__¦’
, 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

58 
_G_va_li¡
 
__­
è
__THROW
;

60 #ifdeà
__va_¬g_·ck


61 
__ex‹º_®ways_šlše
 

62 
	`__NTH
 (
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__n
,

63 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...))

65  
	`__butš___¢´štf_chk
 (
__s
, 
__n
, 
__USE_FORTIFY_LEVEL
 - 1,

66 
	`__bos
 (
__s
), 
__fmt
, 
	`__va_¬g_·ck
 ());

67 
	}
}

68 #–ià!
defšed
 
__ılu¥lus


69 
	#¢´štf
(
¡r
, 
Ën
, ...) \

70 
	`__butš___¢´štf_chk
 (
¡r
, 
Ën
, 
__USE_FORTIFY_LEVEL
 - 1, 
	`__bos
 (str), \

71 
__VA_ARGS__
)

	)

74 
__ex‹º_®ways_šlše
 

75 
__NTH
 (
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__n
,

76 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__­
))

78  
	`__butš___v¢´štf_chk
 (
__s
, 
__n
, 
__USE_FORTIFY_LEVEL
 - 1,

79 
	`__bos
 (
__s
), 
__fmt
, 
__­
);

80 
	}
}

84 #ià
__USE_FORTIFY_LEVEL
 > 1

86 
__årštf_chk
 (
FILE
 *
__»¡riù
 
__¡»am
, 
__æag
,

87 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

88 
__´štf_chk
 (
__æag
, 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, ...);

89 
__vårštf_chk
 (
FILE
 *
__»¡riù
 
__¡»am
, 
__æag
,

90 
__cÚ¡
 *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__­
);

91 
__v´štf_chk
 (
__æag
, 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

92 
_G_va_li¡
 
__­
);

94 #ifdeà
__va_¬g_·ck


95 
__ex‹º_®ways_šlše
 

96 
	$årštf
 (
FILE
 *
__»¡riù
 
__¡»am
, 
__cÚ¡
 *__»¡riù 
__fmt
, ...)

98  
	`__årštf_chk
 (
__¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

99 
	`__va_¬g_·ck
 ());

100 
	}
}

102 
__ex‹º_®ways_šlše
 

103 
	$´štf
 (
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

105  
	`__´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
	`__va_¬g_·ck
 ());

106 
	}
}

107 #–ià!
defšed
 
__ılu¥lus


108 
	#´štf
(...) \

109 
	`__´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

110 
	#årštf
(
¡»am
, ...) \

111 
	`__årštf_chk
 (
¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

114 
__ex‹º_®ways_šlše
 

115 
	$v´štf
 (
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__­
)

117 #ifdeà
__USE_EXTERN_INLINES


118  
	`__vårštf_chk
 (
¡dout
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

120  
	`__v´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

122 
	}
}

124 
__ex‹º_®ways_šlše
 

125 
	$vårštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

126 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__­
)

128  
	`__vårštf_chk
 (
__¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

129 
	}
}

131 #ifdeà
__USE_GNU


133 
	$__a¥rštf_chk
 (**
__»¡riù
 
__±r
, 
__æag
,

134 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

135 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 3, 4))è
__wur
;

136 
	$__va¥rštf_chk
 (**
__»¡riù
 
__±r
, 
__æag
,

137 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__¬g
)

138 
__THROW
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 3, 0))è
__wur
;

139 
	$__d´štf_chk
 (
__fd
, 
__æag
, 
__cÚ¡
 *
__»¡riù
 
__fmt
,

140 ...è
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

141 
	$__vd´štf_chk
 (
__fd
, 
__æag
,

142 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__¬g
)

143 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

144 
	$__ob¡ack_´štf_chk
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

145 
__æag
, 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

147 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

148 
	$__ob¡ack_v´štf_chk
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

149 
__æag
,

150 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

151 
_G_va_li¡
 
__¬gs
)

152 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

154 #ifdeà
__va_¬g_·ck


155 
__ex‹º_®ways_šlše
 

156 
	`__NTH
 (
	$a¥rštf
 (**
__»¡riù
 
__±r
, 
__cÚ¡
 *__»¡riù 
__fmt
, ...))

158  
	`__a¥rštf_chk
 (
__±r
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

159 
	`__va_¬g_·ck
 ());

160 
	}
}

162 
__ex‹º_®ways_šlše
 

163 
__NTH
 (
	$__a¥rštf
 (**
__»¡riù
 
__±r
, 
__cÚ¡
 *__»¡riù 
__fmt
,

166  
	`__a¥rštf_chk
 (
__±r
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

167 
	`__va_¬g_·ck
 ());

168 
	}
}

170 
__ex‹º_®ways_šlše
 

171 
	$d´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...)

173  
	`__d´štf_chk
 (
__fd
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

174 
	`__va_¬g_·ck
 ());

175 
	}
}

177 
__ex‹º_®ways_šlše
 

178 
__NTH
 (
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

179 
__cÚ¡
 *
__»¡riù
 
__fmt
, ...))

181  
	`__ob¡ack_´štf_chk
 (
__ob¡ack
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

182 
	`__va_¬g_·ck
 ());

183 
	}
}

184 #–ià!
defšed
 
__ılu¥lus


185 
	#a¥rštf
(
±r
, ...) \

186 
	`__a¥rštf_chk
 (
±r
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

187 
	#__a¥rštf
(
±r
, ...) \

188 
	`__a¥rštf_chk
 (
±r
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

189 
	#d´štf
(
fd
, ...) \

190 
	`__d´štf_chk
 (
fd
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

191 
	#ob¡ack_´štf
(
ob¡ack
, ...) \

192 
	`__ob¡ack_´štf_chk
 (
ob¡ack
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

195 
__ex‹º_®ways_šlše
 

196 
__NTH
 (
	$va¥rštf
 (**
__»¡riù
 
__±r
, 
__cÚ¡
 *__»¡riù 
__fmt
,

197 
_G_va_li¡
 
__­
))

199  
	`__va¥rštf_chk
 (
__±r
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

200 
	}
}

202 
__ex‹º_®ways_šlše
 

203 
	$vd´štf
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__­
)

205  
	`__vd´štf_chk
 (
__fd
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

206 
	}
}

208 
__ex‹º_®ways_šlše
 

209 
__NTH
 (
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

210 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
_G_va_li¡
 
__­
))

212  
	`__ob¡ack_v´štf_chk
 (
__ob¡ack
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

213 
__­
);

214 
	}
}

220 *
	$__g‘s_chk
 (*
__¡r
, 
size_t
è
__wur
;

221 *
	`__REDIRECT
 (
__g‘s_w¬n
, (*
__¡r
), 
g‘s
)

222 
__wur
 
	`__w¬Ç‰r
 ("please use fgets or getline instead, gets can't "

225 
__ex‹º_®ways_šlše
 
__wur
 *

226 
	$g‘s
 (*
__¡r
)

228 ià(
	`__bos
 (
__¡r
è!ğ(
size_t
) -1)

229  
	`__g‘s_chk
 (
__¡r
, 
	`__bos
 (__str));

230  
	`__g‘s_w¬n
 (
__¡r
);

231 
	}
}

233 *
	$__fg‘s_chk
 (*
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

234 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

235 *
	`__REDIRECT
 (
__fg‘s_®Ÿs
,

236 (*
__»¡riù
 
__s
, 
__n
,

237 
FILE
 *
__»¡riù
 
__¡»am
), 
fg‘s
è
__wur
;

238 *
	`__REDIRECT
 (
__fg‘s_chk_w¬n
,

239 (*
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

240 
FILE
 *
__»¡riù
 
__¡»am
), 
__fg‘s_chk
)

241 
__wur
 
	`__w¬Ç‰r
 ("fgets called with bigger sizehan†ength "

244 
__ex‹º_®ways_šlše
 
__wur
 *

245 
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

247 ià(
	`__bos
 (
__s
è!ğ(
size_t
) -1)

249 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
) || __n <= 0)

250  
	`__fg‘s_chk
 (
__s
, 
	`__bos
 (__s), 
__n
, 
__¡»am
);

252 ià((
size_t
è
__n
 > 
	`__bos
 (
__s
))

253  
	`__fg‘s_chk_w¬n
 (
__s
, 
	`__bos
 (__s), 
__n
, 
__¡»am
);

255  
	`__fg‘s_®Ÿs
 (
__s
, 
__n
, 
__¡»am
);

256 
	}
}

258 
size_t
 
	$__ä—d_chk
 (*
__»¡riù
 
__±r
, 
size_t
 
__±¾’
,

259 
size_t
 
__size
, size_ˆ
__n
,

260 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

261 
size_t
 
	`__REDIRECT
 (
__ä—d_®Ÿs
,

262 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

263 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
),

264 
ä—d
è
__wur
;

265 
size_t
 
	`__REDIRECT
 (
__ä—d_chk_w¬n
,

266 (*
__»¡riù
 
__±r
, 
size_t
 
__±¾’
,

267 
size_t
 
__size
, size_ˆ
__n
,

268 
FILE
 *
__»¡riù
 
__¡»am
),

269 
__ä—d_chk
)

270 
__wur
 
	`__w¬Ç‰r
 ("fread called with bigger size *‚membhan†ength "

273 
__ex‹º_®ways_šlše
 
__wur
 
size_t


274 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
, size_ˆ
__n
,

275 
FILE
 *
__»¡riù
 
__¡»am
)

277 ià(
	`__bos0
 (
__±r
è!ğ(
size_t
) -1)

279 ià(!
	`__butš_cÚ¡ªt_p
 (
__size
)

280 || !
	`__butš_cÚ¡ªt_p
 (
__n
)

281 || (
__size
 | 
__n
è>ğ(((
size_t
) 1) << (8 *  (size_t) / 2)))

282  
	`__ä—d_chk
 (
__±r
, 
	`__bos0
 (__±r), 
__size
, 
__n
, 
__¡»am
);

284 ià(
__size
 * 
__n
 > 
	`__bos0
 (
__±r
))

285  
	`__ä—d_chk_w¬n
 (
__±r
, 
	`__bos0
 (__±r), 
__size
, 
__n
, 
__¡»am
);

287  
	`__ä—d_®Ÿs
 (
__±r
, 
__size
, 
__n
, 
__¡»am
);

288 
	}
}

290 #ifdeà
__USE_GNU


291 *
	$__fg‘s_uÆocked_chk
 (*
__»¡riù
 
__s
, 
size_t
 
__size
,

292 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

293 *
	`__REDIRECT
 (
__fg‘s_uÆocked_®Ÿs
,

294 (*
__»¡riù
 
__s
, 
__n
,

295 
FILE
 *
__»¡riù
 
__¡»am
), 
fg‘s_uÆocked
è
__wur
;

296 *
	`__REDIRECT
 (
__fg‘s_uÆocked_chk_w¬n
,

297 (*
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

298 
FILE
 *
__»¡riù
 
__¡»am
), 
__fg‘s_uÆocked_chk
)

299 
__wur
 
	`__w¬Ç‰r
 ("fgets_unlocked called with bigger sizehan†ength "

302 
__ex‹º_®ways_šlše
 
__wur
 *

303 
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

305 ià(
	`__bos
 (
__s
è!ğ(
size_t
) -1)

307 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
) || __n <= 0)

308  
	`__fg‘s_uÆocked_chk
 (
__s
, 
	`__bos
 (__s), 
__n
, 
__¡»am
);

310 ià((
size_t
è
__n
 > 
	`__bos
 (
__s
))

311  
	`__fg‘s_uÆocked_chk_w¬n
 (
__s
, 
	`__bos
 (__s), 
__n
, 
__¡»am
);

313  
	`__fg‘s_uÆocked_®Ÿs
 (
__s
, 
__n
, 
__¡»am
);

314 
	}
}

317 #ifdeà
__USE_MISC


318 #undeà
ä—d_uÆocked


319 
size_t
 
	$__ä—d_uÆocked_chk
 (*
__»¡riù
 
__±r
, 
size_t
 
__±¾’
,

320 
size_t
 
__size
, size_ˆ
__n
,

321 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

322 
size_t
 
	`__REDIRECT
 (
__ä—d_uÆocked_®Ÿs
,

323 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

324 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
),

325 
ä—d_uÆocked
è
__wur
;

326 
size_t
 
	`__REDIRECT
 (
__ä—d_uÆocked_chk_w¬n
,

327 (*
__»¡riù
 
__±r
, 
size_t
 
__±¾’
,

328 
size_t
 
__size
, size_ˆ
__n
,

329 
FILE
 *
__»¡riù
 
__¡»am
),

330 
__ä—d_uÆocked_chk
)

331 
__wur
 
	`__w¬Ç‰r
 ("fread_unlocked called with bigger size *‚membhan "

334 
__ex‹º_®ways_šlše
 
__wur
 
size_t


335 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
, size_ˆ
__n
,

336 
FILE
 *
__»¡riù
 
__¡»am
)

338 ià(
	`__bos0
 (
__±r
è!ğ(
size_t
) -1)

340 ià(!
	`__butš_cÚ¡ªt_p
 (
__size
)

341 || !
	`__butš_cÚ¡ªt_p
 (
__n
)

342 || (
__size
 | 
__n
è>ğ(((
size_t
) 1) << (8 *  (size_t) / 2)))

343  
	`__ä—d_uÆocked_chk
 (
__±r
, 
	`__bos0
 (__±r), 
__size
, 
__n
,

344 
__¡»am
);

346 ià(
__size
 * 
__n
 > 
	`__bos0
 (
__±r
))

347  
	`__ä—d_uÆocked_chk_w¬n
 (
__±r
, 
	`__bos0
 (__±r), 
__size
, 
__n
,

348 
__¡»am
);

351 #ifdeà
__USE_EXTERN_INLINES


352 ià(
	`__butš_cÚ¡ªt_p
 (
__size
)

353 && 
	`__butš_cÚ¡ªt_p
 (
__n
)

354 && (
__size
 | 
__n
è< (((
size_t
) 1) << (8 *  (size_t) / 2))

355 && 
__size
 * 
__n
 <= 8)

357 
size_t
 
__út
 = 
__size
 * 
__n
;

358 *
__ıŒ
 = (*è
__±r
;

359 ià(
__út
 == 0)

362 ; 
__út
 > 0; --__cnt)

364 
__c
 = 
	`_IO_g‘c_uÆocked
 (
__¡»am
);

365 ià(
__c
 =ğ
EOF
)

367 *
__ıŒ
++ = 
__c
;

369  (
__ıŒ
 - (*è
__±r
è/ 
__size
;

372  
	`__ä—d_uÆocked_®Ÿs
 (
__±r
, 
__size
, 
__n
, 
__¡»am
);

373 
	}
}

	@/usr/include/bits/stdio_lim.h

19 #ià!
defšed
 
_STDIO_H
 && !defšed 
__Ãed_FOPEN_MAX
 && !defšed 
__Ãed_IOV_MAX


23 #ifdeà
_STDIO_H


24 
	#L_tm²am
 20

	)

25 
	#TMP_MAX
 238328

	)

26 
	#FILENAME_MAX
 4096

	)

28 #ifdeà
__USE_POSIX


29 
	#L_ù”mid
 9

	)

30 #ià!
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_GNU


31 
	#L_cu£rid
 9

	)

36 #ià
defšed
 
__Ãed_FOPEN_MAX
 || defšed 
_STDIO_H


37 #undeà
FOPEN_MAX


38 
	#FOPEN_MAX
 16

	)

41 #ià
defšed
 
__Ãed_IOV_MAX
 && !defšed 
IOV_MAX


42 
	#IOV_MAX
 1024

	)

	@/usr/include/bits/stdlib-ldbl.h

20 #iâdeà
_STDLIB_H


24 #ifdef 
__USE_ISOC99


25 
__BEGIN_NAMESPACE_C99


26 
	$__LDBL_REDIR1_DECL
 (
¡¹Şd
, 
¡¹od
)

27 
__END_NAMESPACE_C99


30 #ifdeà
__USE_GNU


31 
	$__LDBL_REDIR1_DECL
 (
¡¹Şd_l
, 
¡¹od_l
)

34 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN_EXTENDED


35 #ifdeà
__USE_MISC


36 
	$__LDBL_REDIR1_DECL
 (
qecvt
, 
ecvt
)

37 
	$__LDBL_REDIR1_DECL
 (
qfcvt
, 
fcvt
)

38 
	$__LDBL_REDIR1_DECL
 (
qgcvt
, 
gcvt
)

39 
	$__LDBL_REDIR1_DECL
 (
qecvt_r
, 
ecvt_r
)

40 
	$__LDBL_REDIR1_DECL
 (
qfcvt_r
, 
fcvt_r
)

	@/usr/include/bits/stdlib.h

20 #iâdeà
_STDLIB_H


24 *
	$__»®·th_chk
 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

25 *
__»¡riù
 
__»sŞved
,

26 
size_t
 
__»sŞvedËn
è
__THROW
 
__wur
;

27 *
	`__REDIRECT_NTH
 (
__»®·th_®Ÿs
,

28 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

29 *
__»¡riù
 
__»sŞved
), 
»®·th
è
__wur
;

30 *
	`__REDIRECT_NTH
 (
__»®·th_chk_w¬n
,

31 (
__cÚ¡
 *
__»¡riù
 
__Çme
,

32 *
__»¡riù
 
__»sŞved
,

33 
size_t
 
__»sŞvedËn
), 
__»®·th_chk
è
__wur


34 
	`__w¬Ç‰r
 ("second‡rgument of„ealpath must beƒither NULL or‡t "

37 
__ex‹º_®ways_šlše
 
__wur
 *

38 
	`__NTH
 (
	$»®·th
 (
__cÚ¡
 *
__»¡riù
 
__Çme
, *__»¡riù 
__»sŞved
))

40 ià(
	`__bos
 (
__»sŞved
è!ğ(
size_t
) -1)

42 #ià
defšed
 
_LIBC_LIMITS_H_
 && defšed 
PATH_MAX


43 ià(
	`__bos
 (
__»sŞved
è< 
PATH_MAX
)

44  
	`__»®·th_chk_w¬n
 (
__Çme
, 
__»sŞved
, 
	`__bos
 (__resolved));

46  
	`__»®·th_chk
 (
__Çme
, 
__»sŞved
, 
	`__bos
 (__resolved));

49  
	`__»®·th_®Ÿs
 (
__Çme
, 
__»sŞved
);

50 
	}
}

53 
	$__±¢ame_r_chk
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

54 
size_t
 
__Ä—l
è
__THROW
 
	`__nÚnuÎ
 ((2));

55 
	`__REDIRECT_NTH
 (
__±¢ame_r_®Ÿs
, (
__fd
, *
__buf
,

56 
size_t
 
__buæ’
), 
±¢ame_r
)

57 
	`__nÚnuÎ
 ((2));

58 
	`__REDIRECT_NTH
 (
__±¢ame_r_chk_w¬n
,

59 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

60 
size_t
 
__Ä—l
), 
__±¢ame_r_chk
)

61 
	`__nÚnuÎ
 ((2)è
	`__w¬Ç‰r
 ("ptsname_r called with buflen biggerhan "

64 
__ex‹º_®ways_šlše
 

65 
	`__NTH
 (
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
))

67 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

69 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

70  
	`__±¢ame_r_chk
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

71 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

72  
	`__±¢ame_r_chk_w¬n
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

74  
	`__±¢ame_r_®Ÿs
 (
__fd
, 
__buf
, 
__buæ’
);

75 
	}
}

78 
	$__wùomb_chk
 (*
__s
, 
wch¬_t
 
__wch¬
, 
size_t
 
__buæ’
)

79 
__THROW
 
__wur
;

80 
	`__REDIRECT_NTH
 (
__wùomb_®Ÿs
, (*
__s
, 
wch¬_t
 
__wch¬
),

81 
wùomb
è
__wur
;

83 
__ex‹º_®ways_šlše
 
__wur
 

84 
	`__NTH
 (
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
))

89 
	#__STDLIB_MB_LEN_MAX
 16

	)

90 #ià
defšed
 
MB_LEN_MAX
 && MB_LEN_MAX !ğ
__STDLIB_MB_LEN_MAX


93 ià(
	`__bos
 (
__s
è!ğ(
size_t
è-1 && 
__STDLIB_MB_LEN_MAX
 > __bos (__s))

94  
	`__wùomb_chk
 (
__s
, 
__wch¬
, 
	`__bos
 (__s));

95  
	`__wùomb_®Ÿs
 (
__s
, 
__wch¬
);

96 
	}
}

99 
size_t
 
	$__mb¡owcs_chk
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

100 
__cÚ¡
 *
__»¡riù
 
__¤c
,

101 
size_t
 
__Ën
, size_ˆ
__d¡Ën
è
__THROW
;

102 
size_t
 
	`__REDIRECT_NTH
 (
__mb¡owcs_®Ÿs
,

103 (
wch¬_t
 *
__»¡riù
 
__d¡
,

104 
__cÚ¡
 *
__»¡riù
 
__¤c
,

105 
size_t
 
__Ën
), 
mb¡owcs
);

106 
size_t
 
	`__REDIRECT_NTH
 (
__mb¡owcs_chk_w¬n
,

107 (
wch¬_t
 *
__»¡riù
 
__d¡
,

108 
__cÚ¡
 *
__»¡riù
 
__¤c
,

109 
size_t
 
__Ën
, size_ˆ
__d¡Ën
), 
__mb¡owcs_chk
)

110 
	`__w¬Ç‰r
 ("mbstowcs called with dst buffer smallerhan†en "

113 
__ex‹º_®ways_šlše
 
size_t


114 
	`__NTH
 (
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

115 
size_t
 
__Ën
))

117 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

119 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

120  
	`__mb¡owcs_chk
 (
__d¡
, 
__¤c
, 
__Ën
,

121 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

123 ià(
__Ën
 > 
	`__bos
 (
__d¡
è/  (
wch¬_t
))

124  
	`__mb¡owcs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
,

125 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

127  
	`__mb¡owcs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
);

128 
	}
}

131 
size_t
 
	$__wc¡ombs_chk
 (*
__»¡riù
 
__d¡
,

132 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

133 
size_t
 
__Ën
, size_ˆ
__d¡Ën
è
__THROW
;

134 
size_t
 
	`__REDIRECT_NTH
 (
__wc¡ombs_®Ÿs
,

135 (*
__»¡riù
 
__d¡
,

136 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

137 
size_t
 
__Ën
), 
wc¡ombs
);

138 
size_t
 
	`__REDIRECT_NTH
 (
__wc¡ombs_chk_w¬n
,

139 (*
__»¡riù
 
__d¡
,

140 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

141 
size_t
 
__Ën
, size_ˆ
__d¡Ën
), 
__wc¡ombs_chk
)

142 
	`__w¬Ç‰r
 ("wcstombs called with dst buffer smallerhan†en");

144 
__ex‹º_®ways_šlše
 
size_t


145 
	`__NTH
 (
	$wc¡ombs
 (*
__»¡riù
 
__d¡
, 
__cÚ¡
 
wch¬_t
 *__»¡riù 
__¤c
,

146 
size_t
 
__Ën
))

148 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

150 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

151  
	`__wc¡ombs_chk
 (
__d¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dst));

152 ià(
__Ën
 > 
	`__bos
 (
__d¡
))

153  
	`__wc¡ombs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dst));

155  
	`__wc¡ombs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
);

156 
	}
}

	@/usr/include/bits/string.h

20 #iâdeà
_STRING_H


26 
	#_STRING_ARCH_uÇligÃd
 1

	)

	@/usr/include/bits/string2.h

21 #iâdeà
_STRING_H


25 #ià!
defšed
 
__NO_STRING_INLINES
 && !defšed 
__BOUNDED_POINTERS__


42 #iâdeà
__STRING_INLINE


43 #ifdeà
__ılu¥lus


44 
	#__STRING_INLINE
 
šlše


	)

46 
	#__STRING_INLINE
 
__ex‹º_šlše


	)

50 #ià
_STRING_ARCH_uÇligÃd


52 
	~<’dŸn.h
>

53 
	~<b™s/ty³s.h
>

55 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


56 
	#__STRING2_SMALL_GET16
(
¤c
, 
idx
) \

57 (((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 1] << 8 \

58 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
])

	)

59 
	#__STRING2_SMALL_GET32
(
¤c
, 
idx
) \

60 (((((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 3] << 8 \

61 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 2]) << 8 \

62 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 1]) << 8 \

63 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
])

	)

65 
	#__STRING2_SMALL_GET16
(
¤c
, 
idx
) \

66 (((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
] << 8 \

67 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 1])

	)

68 
	#__STRING2_SMALL_GET32
(
¤c
, 
idx
) \

69 (((((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
] << 8 \

70 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 1]) << 8 \

71 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 2]) << 8 \

72 | ((
__cÚ¡
 *è(__cÚ¡ *è(
¤c
))[
idx
 + 3])

	)

77 
	#__STRING2_COPY_TYPE
(
N
) \

78 ¡ruù { 
__¬r
[
N
]; } \

79 
	t__©Œibu‹__
 ((
	t__·cked__
)è
	t__STRING2_COPY_ARR
##
	tN


	)

80 
	t__STRING2_COPY_TYPE
 (2);

81 
__STRING2_COPY_TYPE
 (3);

82 
__STRING2_COPY_TYPE
 (4);

83 
__STRING2_COPY_TYPE
 (5);

84 
__STRING2_COPY_TYPE
 (6);

85 
__STRING2_COPY_TYPE
 (7);

86 
__STRING2_COPY_TYPE
 (8);

87 #undeà
__STRING2_COPY_TYPE


93 
	#__¡ršg2_1b±r_p
(
__x
) \

94 ((
size_t
)(cÚ¡ *)((
__x
è+ 1è- (size_t)(cÚ¡ *)(__xè=ğ1)

	)

97 #ià!
defšed
 
_HAVE_STRING_ARCH_mem£t


98 #ià!
__GNUC_PREREQ
 (3, 0)

99 #ià
_STRING_ARCH_uÇligÃd


100 
	#mem£t
(
s
, 
c
, 
n
) \

101 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) && (n) <= 16 \

102 ? ((
n
) == 1 \

103 ? 
	`__mem£t_1
 (
s
, 
c
) \

104 : 
	`__mem£t_gc
 (
s
, 
c
, 
n
)) \

105 : (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

106 ? ({ *
__s
 = (
s
); 
	`__bz”o
 (__s, 
n
); __s; }) \

107 : 
	`mem£t
 (
s
, 
c
, 
n
))))

	)

109 
	#__mem£t_1
(
s
, 
c
è({ *
__s
 = (s); \

110 *((
__ušt8_t
 *è
__s
èğ(__ušt8_tè
c
; __s; })

	)

112 
	#__mem£t_gc
(
s
, 
c
, 
n
) \

113 ({ *
__s
 = (
s
); \

115 
__ui
; \

116 
__usi
; \

117 
__uc
; \

118 } *
__u
 = 
__s
; \

119 
__ušt8_t
 
__c
 = (__ušt8_tè(
c
); \

122 (è(
n
)) \

125 
__u
->
__ui
 = 
__c
 * 0x01010101; \

126 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

128 
__u
->
__ui
 = 
__c
 * 0x01010101; \

129 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

131 
__u
->
__ui
 = 
__c
 * 0x01010101; \

132 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

134 
__u
->
__usi
 = (è
__c
 * 0x0101; \

135 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2); \

136 
__u
->
__uc
 = (è
__c
; \

140 
__u
->
__ui
 = 
__c
 * 0x01010101; \

141 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

143 
__u
->
__ui
 = 
__c
 * 0x01010101; \

144 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

146 
__u
->
__ui
 = 
__c
 * 0x01010101; \

147 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

149 
__u
->
__usi
 = (è
__c
 * 0x0101; \

153 
__u
->
__ui
 = 
__c
 * 0x01010101; \

154 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

156 
__u
->
__ui
 = 
__c
 * 0x01010101; \

157 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

159 
__u
->
__ui
 = 
__c
 * 0x01010101; \

160 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

162 
__u
->
__uc
 = (è
__c
; \

166 
__u
->
__ui
 = 
__c
 * 0x01010101; \

167 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

169 
__u
->
__ui
 = 
__c
 * 0x01010101; \

170 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

172 
__u
->
__ui
 = 
__c
 * 0x01010101; \

173 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4); \

175 
__u
->
__ui
 = 
__c
 * 0x01010101; \

180 
__s
; })

	)

182 
	#mem£t
(
s
, 
c
, 
n
) \

183 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

184 ? ({ *
__s
 = (
s
); 
	`__bz”o
 (__s, 
n
); __s; }) \

185 : 
	`mem£t
 (
s
, 
c
, 
n
)))

	)

194 #ià
__GNUC_PREREQ
 (2, 91)

195 
	#__bz”o
(
s
, 
n
è
	`__butš_mem£t
 (s, '\0',‚)

	)

203 #ifdeà
__USE_GNU


204 #ià!
defšed
 
_HAVE_STRING_ARCH_mempıy
 || defšed 
_FORCE_INLINES


205 #iâdeà
_HAVE_STRING_ARCH_mempıy


206 #ià
__GNUC_PREREQ
 (3, 4)

207 
	#__mempıy
(
de¡
, 
¤c
, 
n
è
	`__butš_mempıy
 (de¡, src,‚)

	)

208 #–ià
__GNUC_PREREQ
 (3, 0)

209 
	#__mempıy
(
de¡
, 
¤c
, 
n
) \

210 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

211 && 
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
n
 <= 8 \

212 ? 
	`__butš_memıy
 (
de¡
, 
¤c
, 
n
) + (n) \

213 : 
	`__mempıy
 (
de¡
, 
¤c
, 
n
)))

	)

215 
	#__mempıy
(
de¡
, 
¤c
, 
n
) \

216 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

217 && 
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
n
 <= 8 \

218 ? 
	`__mempıy_sm®l
 (
de¡
, 
	`__mempıy_¬gs
 (
¤c
), 
n
) \

219 : 
	`__mempıy
 (
de¡
, 
¤c
, 
n
)))

	)

223 
	#mempıy
(
de¡
, 
¤c
, 
n
è
	`__mempıy
 (de¡, src,‚)

	)

226 #ià!
__GNUC_PREREQ
 (3, 0è|| 
defšed
 
_FORCE_INLINES


227 #ià
_STRING_ARCH_uÇligÃd


228 #iâdeà
_FORCE_INLINES


229 
	#__mempıy_¬gs
(
¤c
) \

230 ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[2], \

231 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[6], \

232 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

233 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

234 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

235 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

237 
__STRING_INLINE
 *
__mempıy_sm®l
 (*, , , , ,

238 
__ušt16_t
, __ušt16_t, 
__ušt32_t
,

239 
__ušt32_t
, 
size_t
);

240 
__STRING_INLINE
 *

241 
	$__mempıy_sm®l
 (*
__de¡1
,

242 
__¤c0_1
, 
__¤c2_1
, 
__¤c4_1
, 
__¤c6_1
,

243 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

244 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

245 
size_t
 
__¤ş’
)

248 
__ušt32_t
 
__ui
;

249 
__ušt16_t
 
__usi
;

250 
__uc
;

251 
__c
;

252 } *
__u
 = 
__de¡1
;

253 (è
__¤ş’
)

256 
__u
->
__c
 = 
__¤c0_1
;

257 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

260 
__u
->
__usi
 = 
__¤c0_2
;

261 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

264 
__u
->
__usi
 = 
__¤c0_2
;

265 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

266 
__u
->
__c
 = 
__¤c2_1
;

267 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

270 
__u
->
__ui
 = 
__¤c0_4
;

271 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

274 
__u
->
__ui
 = 
__¤c0_4
;

275 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

276 
__u
->
__c
 = 
__¤c4_1
;

277 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

280 
__u
->
__ui
 = 
__¤c0_4
;

281 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

282 
__u
->
__usi
 = 
__¤c4_2
;

283 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

286 
__u
->
__ui
 = 
__¤c0_4
;

287 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

288 
__u
->
__usi
 = 
__¤c4_2
;

289 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

290 
__u
->
__c
 = 
__¤c6_1
;

291 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

294 
__u
->
__ui
 = 
__¤c0_4
;

295 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

296 
__u
->
__ui
 = 
__¤c4_4
;

297 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

300  (*è
__u
;

301 
	}
}

303 #iâdeà
_FORCE_INLINES


304 
	#__mempıy_¬gs
(
¤c
) \

305 ((
__cÚ¡
 *è(
¤c
))[0], \

306 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

307 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1] } }), \

308 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

309 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

310 ((
__cÚ¡
 *è(
¤c
))[2] } }), \

311 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

312 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

313 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3] } }), \

314 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

315 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

316 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

317 ((
__cÚ¡
 *è(
¤c
))[4] } }), \

318 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

319 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

320 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

321 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5] } }), \

322 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

323 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

324 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

325 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

326 ((
__cÚ¡
 *è(
¤c
))[6] } }), \

327 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

328 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

329 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

330 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

331 ((
__cÚ¡
 *è(
¤c
))[6], ((__cÚ¡ *è(¤c))[7] } })

	)

333 
__STRING_INLINE
 *
__mempıy_sm®l
 (*, , 
__STRING2_COPY_ARR2
,

334 
__STRING2_COPY_ARR3
,

335 
__STRING2_COPY_ARR4
,

336 
__STRING2_COPY_ARR5
,

337 
__STRING2_COPY_ARR6
,

338 
__STRING2_COPY_ARR7
,

339 
__STRING2_COPY_ARR8
, 
size_t
);

340 
__STRING_INLINE
 *

341 
	$__mempıy_sm®l
 (*
__de¡
, 
__¤c1
,

342 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

343 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

344 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

345 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

348 
__c
;

349 
__STRING2_COPY_ARR2
 
__sÿ2
;

350 
__STRING2_COPY_ARR3
 
__sÿ3
;

351 
__STRING2_COPY_ARR4
 
__sÿ4
;

352 
__STRING2_COPY_ARR5
 
__sÿ5
;

353 
__STRING2_COPY_ARR6
 
__sÿ6
;

354 
__STRING2_COPY_ARR7
 
__sÿ7
;

355 
__STRING2_COPY_ARR8
 
__sÿ8
;

356 } *
__u
 = 
__de¡
;

357 (è
__¤ş’
)

360 
__u
->
__c
 = 
__¤c1
;

363 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

366 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

369 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

372 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

375 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

378 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

381 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

384  
	`__ex‹nsiÚ__
 ((*è
__u
 + 
__¤ş’
);

385 
	}
}

393 #iâdeà
_HAVE_STRING_ARCH_¡rchr


394 *
__¿wmemchr
 (cÚ¡ *
__s
, 
__c
);

395 #ià
__GNUC_PREREQ
 (3, 2)

396 
	#¡rchr
(
s
, 
c
) \

397 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
è&& !__butš_cÚ¡ªt_°(
s
) \

398 && (
c
) == '\0' \

399 ? (*è
	`__¿wmemchr
 (
s
, 
c
) \

400 : 
	`__butš_¡rchr
 (
s
, 
c
)))

	)

402 
	#¡rchr
(
s
, 
c
) \

403 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
c
) && (c) == '\0' \

404 ? (*è
	`__¿wmemchr
 (
s
, 
c
) \

405 : 
	`¡rchr
 (
s
, 
c
)))

	)

411 #ià(!
defšed
 
_HAVE_STRING_ARCH_¡rıy
 && !
__GNUC_PREREQ
 (3, 0)) \

412 || 
defšed
 
	g_FORCE_INLINES


413 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rıy
 && !
__GNUC_PREREQ
 (3, 0)

414 
	#¡rıy
(
de¡
, 
¤c
) \

415 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

416 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

417 ? 
	`__¡rıy_sm®l
 (
de¡
, 
	`__¡rıy_¬gs
 (
¤c
), \

418 
	`¡¾’
 (
¤c
) + 1) \

419 : (*è
	`memıy
 (
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1)) \

420 : 
	`¡rıy
 (
de¡
, 
¤c
)))

	)

423 #ià
_STRING_ARCH_uÇligÃd


424 #iâdeà
_FORCE_INLINES


425 
	#__¡rıy_¬gs
(
¤c
) \

426 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

427 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

428 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

429 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

431 
__STRING_INLINE
 *
__¡rıy_sm®l
 (*, 
__ušt16_t
, __uint16_t,

432 
__ušt32_t
, __ušt32_t, 
size_t
);

433 
__STRING_INLINE
 *

434 
	$__¡rıy_sm®l
 (*
__de¡
,

435 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

436 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

437 
size_t
 
__¤ş’
)

440 
__ušt32_t
 
__ui
;

441 
__ušt16_t
 
__usi
;

442 
__uc
;

443 } *
__u
 = (*è
__de¡
;

444 (è
__¤ş’
)

447 
__u
->
__uc
 = '\0';

450 
__u
->
__usi
 = 
__¤c0_2
;

453 
__u
->
__usi
 = 
__¤c0_2
;

454 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

455 
__u
->
__uc
 = '\0';

458 
__u
->
__ui
 = 
__¤c0_4
;

461 
__u
->
__ui
 = 
__¤c0_4
;

462 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

463 
__u
->
__uc
 = '\0';

466 
__u
->
__ui
 = 
__¤c0_4
;

467 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

468 
__u
->
__usi
 = 
__¤c4_2
;

471 
__u
->
__ui
 = 
__¤c0_4
;

472 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

473 
__u
->
__usi
 = 
__¤c4_2
;

474 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

475 
__u
->
__uc
 = '\0';

478 
__u
->
__ui
 = 
__¤c0_4
;

479 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

480 
__u
->
__ui
 = 
__¤c4_4
;

483  
__de¡
;

484 
	}
}

486 #iâdeà
_FORCE_INLINES


487 
	#__¡rıy_¬gs
(
¤c
) \

488 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

489 { { ((
__cÚ¡
 *è(
¤c
))[0], '\0' } }), \

490 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

491 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

493 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

494 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

495 ((
__cÚ¡
 *è(
¤c
))[2], '\0' } }), \

496 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

497 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

498 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

500 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

501 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

502 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

503 ((
__cÚ¡
 *è(
¤c
))[4], '\0' } }), \

504 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

505 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

506 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

507 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

509 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

510 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

511 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

512 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

513 ((
__cÚ¡
 *è(
¤c
))[6], '\0' } })

	)

515 
__STRING_INLINE
 *
__¡rıy_sm®l
 (*, 
__STRING2_COPY_ARR2
,

516 
__STRING2_COPY_ARR3
,

517 
__STRING2_COPY_ARR4
,

518 
__STRING2_COPY_ARR5
,

519 
__STRING2_COPY_ARR6
,

520 
__STRING2_COPY_ARR7
,

521 
__STRING2_COPY_ARR8
, 
size_t
);

522 
__STRING_INLINE
 *

523 
	$__¡rıy_sm®l
 (*
__de¡
,

524 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

525 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

526 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

527 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

530 
__c
;

531 
__STRING2_COPY_ARR2
 
__sÿ2
;

532 
__STRING2_COPY_ARR3
 
__sÿ3
;

533 
__STRING2_COPY_ARR4
 
__sÿ4
;

534 
__STRING2_COPY_ARR5
 
__sÿ5
;

535 
__STRING2_COPY_ARR6
 
__sÿ6
;

536 
__STRING2_COPY_ARR7
 
__sÿ7
;

537 
__STRING2_COPY_ARR8
 
__sÿ8
;

538 } *
__u
 = (*è
__de¡
;

539 (è
__¤ş’
)

542 
__u
->
__c
 = '\0';

545 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

548 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

551 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

554 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

557 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

560 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

563 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

566  
__de¡
;

567 
	}
}

573 #ifdeà
__USE_GNU


574 #ià!
defšed
 
_HAVE_STRING_ARCH_¡pıy
 || defšed 
_FORCE_INLINES


575 #iâdeà
_HAVE_STRING_ARCH_¡pıy


576 #ià
__GNUC_PREREQ
 (3, 4)

577 
	#__¡pıy
(
de¡
, 
¤c
è
	`__butš_¡pıy
 (de¡, src)

	)

578 #–ià
__GNUC_PREREQ
 (3, 0)

579 
	#__¡pıy
(
de¡
, 
¤c
) \

580 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

581 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

582 ? 
	`__butš_¡rıy
 (
de¡
, 
¤c
è+ 
	`¡¾’
 (src) \

583 : ((*è(
__mempıy
è(
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1) \

585 : 
	`__¡pıy
 (
de¡
, 
¤c
)))

	)

587 
	#__¡pıy
(
de¡
, 
¤c
) \

588 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
) \

589 ? (
	`__¡ršg2_1b±r_p
 (
¤c
è&& 
	`¡¾’
 (src) + 1 <= 8 \

590 ? 
	`__¡pıy_sm®l
 (
de¡
, 
	`__¡pıy_¬gs
 (
¤c
), \

591 
	`¡¾’
 (
¤c
) + 1) \

592 : ((*è(
__mempıy
è(
de¡
, 
¤c
, 
	`¡¾’
 (src) + 1) \

594 : 
	`__¡pıy
 (
de¡
, 
¤c
)))

	)

598 
	#¡pıy
(
de¡
, 
¤c
è
	`__¡pıy
 (de¡, src)

	)

601 #ià!
__GNUC_PREREQ
 (3, 0è|| 
defšed
 
_FORCE_INLINES


602 #ià
_STRING_ARCH_uÇligÃd


603 #iâdeà
_FORCE_INLINES


604 
	#__¡pıy_¬gs
(
¤c
) \

605 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 0), \

606 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET16
 (
¤c
, 4), \

607 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 0), \

608 
__ex‹nsiÚ__
 
	`__STRING2_SMALL_GET32
 (
¤c
, 4)

	)

610 
__STRING_INLINE
 *
__¡pıy_sm®l
 (*, 
__ušt16_t
, __uint16_t,

611 
__ušt32_t
, __ušt32_t, 
size_t
);

612 
__STRING_INLINE
 *

613 
	$__¡pıy_sm®l
 (*
__de¡
,

614 
__ušt16_t
 
__¤c0_2
, __ušt16_ˆ
__¤c4_2
,

615 
__ušt32_t
 
__¤c0_4
, __ušt32_ˆ
__¤c4_4
,

616 
size_t
 
__¤ş’
)

619 
__ui
;

620 
__usi
;

621 
__uc
;

622 
__c
;

623 } *
__u
 = (*è
__de¡
;

624 (è
__¤ş’
)

627 
__u
->
__uc
 = '\0';

630 
__u
->
__usi
 = 
__¤c0_2
;

631 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

634 
__u
->
__usi
 = 
__¤c0_2
;

635 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

636 
__u
->
__uc
 = '\0';

639 
__u
->
__ui
 = 
__¤c0_4
;

640 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3);

643 
__u
->
__ui
 = 
__¤c0_4
;

644 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

645 
__u
->
__uc
 = '\0';

648 
__u
->
__ui
 = 
__¤c0_4
;

649 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

650 
__u
->
__usi
 = 
__¤c4_2
;

651 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 1);

654 
__u
->
__ui
 = 
__¤c0_4
;

655 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

656 
__u
->
__usi
 = 
__¤c4_2
;

657 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 2);

658 
__u
->
__uc
 = '\0';

661 
__u
->
__ui
 = 
__¤c0_4
;

662 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 4);

663 
__u
->
__ui
 = 
__¤c4_4
;

664 
__u
 = 
	`__ex‹nsiÚ__
 ((*) __u + 3);

667  &
__u
->
__c
;

668 
	}
}

670 #iâdeà
_FORCE_INLINES


671 
	#__¡pıy_¬gs
(
¤c
) \

672 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR2
) \

673 { { ((
__cÚ¡
 *è(
¤c
))[0], '\0' } }), \

674 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR3
) \

675 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

677 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR4
) \

678 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

679 ((
__cÚ¡
 *è(
¤c
))[2], '\0' } }), \

680 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR5
) \

681 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

682 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

684 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR6
) \

685 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

686 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

687 ((
__cÚ¡
 *è(
¤c
))[4], '\0' } }), \

688 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR7
) \

689 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

690 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

691 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

693 
	`__ex‹nsiÚ__
 ((
__STRING2_COPY_ARR8
) \

694 { { ((
__cÚ¡
 *è(
¤c
))[0], ((__const *) (src))[1], \

695 ((
__cÚ¡
 *è(
¤c
))[2], ((__const *) (src))[3], \

696 ((
__cÚ¡
 *è(
¤c
))[4], ((__const *) (src))[5], \

697 ((
__cÚ¡
 *è(
¤c
))[6], '\0' } })

	)

699 
__STRING_INLINE
 *
__¡pıy_sm®l
 (*, 
__STRING2_COPY_ARR2
,

700 
__STRING2_COPY_ARR3
,

701 
__STRING2_COPY_ARR4
,

702 
__STRING2_COPY_ARR5
,

703 
__STRING2_COPY_ARR6
,

704 
__STRING2_COPY_ARR7
,

705 
__STRING2_COPY_ARR8
, 
size_t
);

706 
__STRING_INLINE
 *

707 
	$__¡pıy_sm®l
 (*
__de¡
,

708 
__STRING2_COPY_ARR2
 
__¤c2
, 
__STRING2_COPY_ARR3
 
__¤c3
,

709 
__STRING2_COPY_ARR4
 
__¤c4
, 
__STRING2_COPY_ARR5
 
__¤c5
,

710 
__STRING2_COPY_ARR6
 
__¤c6
, 
__STRING2_COPY_ARR7
 
__¤c7
,

711 
__STRING2_COPY_ARR8
 
__¤c8
, 
size_t
 
__¤ş’
)

714 
__c
;

715 
__STRING2_COPY_ARR2
 
__sÿ2
;

716 
__STRING2_COPY_ARR3
 
__sÿ3
;

717 
__STRING2_COPY_ARR4
 
__sÿ4
;

718 
__STRING2_COPY_ARR5
 
__sÿ5
;

719 
__STRING2_COPY_ARR6
 
__sÿ6
;

720 
__STRING2_COPY_ARR7
 
__sÿ7
;

721 
__STRING2_COPY_ARR8
 
__sÿ8
;

722 } *
__u
 = (*è
__de¡
;

723 (è
__¤ş’
)

726 
__u
->
__c
 = '\0';

729 
__ex‹nsiÚ__
 
__u
->
__sÿ2
 = 
__¤c2
;

732 
__ex‹nsiÚ__
 
__u
->
__sÿ3
 = 
__¤c3
;

735 
__ex‹nsiÚ__
 
__u
->
__sÿ4
 = 
__¤c4
;

738 
__ex‹nsiÚ__
 
__u
->
__sÿ5
 = 
__¤c5
;

741 
__ex‹nsiÚ__
 
__u
->
__sÿ6
 = 
__¤c6
;

744 
__ex‹nsiÚ__
 
__u
->
__sÿ7
 = 
__¤c7
;

747 
__ex‹nsiÚ__
 
__u
->
__sÿ8
 = 
__¤c8
;

750  
__de¡
 + 
__¤ş’
 - 1;

751 
	}
}

759 #iâdeà
_HAVE_STRING_ARCH_¡ºıy


760 #ià
__GNUC_PREREQ
 (3, 2)

761 
	#¡ºıy
(
de¡
, 
¤c
, 
n
è
	`__butš_¡ºıy
 (de¡, src,‚)

	)

763 
	#¡ºıy
(
de¡
, 
¤c
, 
n
) \

764 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

765 ? (
	`¡¾’
 (
¤c
è+ 1 >ğ((
size_t
è(
n
)) \

766 ? (*è
	`memıy
 (
de¡
, 
¤c
, 
n
) \

767 : 
	`¡ºıy
 (
de¡
, 
¤c
, 
n
)) \

768 : 
	`¡ºıy
 (
de¡
, 
¤c
, 
n
)))

	)

774 #iâdeà
_HAVE_STRING_ARCH_¡ºÿt


775 #ifdeà
_USE_STRING_ARCH_¡rchr


776 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
) \

777 (
	`__ex‹nsiÚ__
 ({ *
__de¡
 = (
de¡
); \

778 
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

779 ? (
	`¡¾’
 (
¤c
è< ((
size_t
è(
n
)) \

780 ? 
	`¡rÿt
 (
__de¡
, 
¤c
) \

781 : (*((*è
	`__mempıy
 (
	`¡rchr
 (
__de¡
, '\0'), \

782 
¤c
, 
n
)èğ'\0', 
__de¡
)) \

783 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
); }))

	)

784 #–ià
__GNUC_PREREQ
 (3, 2)

785 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
è
	`__butš_¡ºÿt
 (de¡, src,‚)

	)

787 
	#¡ºÿt
(
de¡
, 
¤c
, 
n
) \

788 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
¤c
è&& __butš_cÚ¡ªt_°(
n
) \

789 ? (
	`¡¾’
 (
¤c
è< ((
size_t
è(
n
)) \

790 ? 
	`¡rÿt
 (
de¡
, 
¤c
) \

791 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
)) \

792 : 
	`¡ºÿt
 (
de¡
, 
¤c
, 
n
)))

	)

798 #iâdeà
_HAVE_STRING_ARCH_¡rcmp


799 #ià
__GNUC_PREREQ
 (3, 2)

800 
	#¡rcmp
(
s1
, 
s2
) \

801 
__ex‹nsiÚ__
 \

802 ({ 
size_t
 
__s1_Ën
, 
__s2_Ën
; \

803 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& __butš_cÚ¡ªt_°(
s2
) \

804 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), 
__s2_Ën
 = sŒËÀ(
s2
), \

805 (!
	`__¡ršg2_1b±r_p
 (
s1
è|| 
__s1_Ën
 >= 4) \

806 && (!
	`__¡ršg2_1b±r_p
 (
s2
è|| 
__s2_Ën
 >= 4)) \

807 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

808 : (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

809 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), __s1_len < 4) \

810 ? (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

811 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

812 : 
	`__¡rcmp_cg
 (
s1
, 
s2
, 
__s1_Ën
)) \

813 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

814 && (
__s2_Ën
 = 
	`¡¾’
 (
s2
), __s2_len < 4) \

815 ? (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

816 ? 
	`__butš_¡rcmp
 (
s1
, 
s2
) \

817 : 
	`__¡rcmp_gc
 (
s1
, 
s2
, 
__s2_Ën
)) \

818 : 
	`__butš_¡rcmp
 (
s1
, 
s2
)))); })

	)

820 
	#¡rcmp
(
s1
, 
s2
) \

821 
__ex‹nsiÚ__
 \

822 ({ 
size_t
 
__s1_Ën
, 
__s2_Ën
; \

823 (
	`__butš_cÚ¡ªt_p
 (
s1
è&& __butš_cÚ¡ªt_°(
s2
) \

824 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), 
__s2_Ën
 = sŒËÀ(
s2
), \

825 (!
	`__¡ršg2_1b±r_p
 (
s1
è|| 
__s1_Ën
 >= 4) \

826 && (!
	`__¡ršg2_1b±r_p
 (
s2
è|| 
__s2_Ën
 >= 4)) \

827 ? 
	`memcmp
 ((
__cÚ¡
 *è(
s1
), (__cÚ¡ *è(
s2
), \

828 (
__s1_Ën
 < 
__s2_Ën
 ? __s1_len : __s2_len) + 1) \

829 : (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

830 && (
__s1_Ën
 = 
	`¡¾’
 (
s1
), __s1_len < 4) \

831 ? (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

832 ? 
	`__¡rcmp_cc
 (
s1
, 
s2
, 
__s1_Ën
) \

833 : 
	`__¡rcmp_cg
 (
s1
, 
s2
, 
__s1_Ën
)) \

834 : (
	`__butš_cÚ¡ªt_p
 (
s2
è&& 
	`__¡ršg2_1b±r_p
 (s2) \

835 && (
__s2_Ën
 = 
	`¡¾’
 (
s2
), __s2_len < 4) \

836 ? (
	`__butš_cÚ¡ªt_p
 (
s1
è&& 
	`__¡ršg2_1b±r_p
 (s1) \

837 ? 
	`__¡rcmp_cc
 (
s1
, 
s2
, 
__s2_Ën
) \

838 : 
	`__¡rcmp_gc
 (
s1
, 
s2
, 
__s2_Ën
)) \

839 : 
	`¡rcmp
 (
s1
, 
s2
)))); })

	)

842 
	#__¡rcmp_cc
(
s1
, 
s2
, 
l
) \

843 (
	`__ex‹nsiÚ__
 ({ 
__»suÉ
 = \

844 (((
__cÚ¡
 *è(__cÚ¡ *è(
s1
))[0] \

845 - ((
__cÚ¡
 *è(__cÚ¡ *)(
s2
))[0]);\

846 ià(
l
 > 0 && 
__»suÉ
 == 0) \

848 
__»suÉ
 = (((
__cÚ¡
 *) \

849 (
__cÚ¡
 *è(
s1
))[1] \

850 - ((
__cÚ¡
 *) \

851 (
__cÚ¡
 *è(
s2
))[1]); \

852 ià(
l
 > 1 && 
__»suÉ
 == 0) \

854 
__»suÉ
 = \

855 (((
__cÚ¡
 *) \

856 (
__cÚ¡
 *è(
s1
))[2] \

857 - ((
__cÚ¡
 *) \

858 (
__cÚ¡
 *è(
s2
))[2]); \

859 ià(
l
 > 2 && 
__»suÉ
 == 0) \

860 
__»suÉ
 = \

861 (((
__cÚ¡
 *) \

862 (
__cÚ¡
 *è(
s1
))[3] \

863 - ((
__cÚ¡
 *) \

864 (
__cÚ¡
 *è(
s2
))[3]); \

867 
__»suÉ
; }))

	)

869 
	#__¡rcmp_cg
(
s1
, 
s2
, 
l1
) \

870 (
	`__ex‹nsiÚ__
 ({ 
__cÚ¡
 *
__s2
 = \

871 (
__cÚ¡
 *è(__cÚ¡ *è(
s2
); \

872 
__»suÉ
 = \

873 (((
__cÚ¡
 *è(__cÚ¡ *è(
s1
))[0] \

874 - 
__s2
[0]); \

875 ià(
l1
 > 0 && 
__»suÉ
 == 0) \

877 
__»suÉ
 = (((
__cÚ¡
 *) \

878 (
__cÚ¡
 *è(
s1
))[1] - 
__s2
[1]); \

879 ià(
l1
 > 1 && 
__»suÉ
 == 0) \

881 
__»suÉ
 = (((
__cÚ¡
 *) \

882 (
__cÚ¡
 *è(
s1
))[2] - 
__s2
[2]);\

883 ià(
l1
 > 2 && 
__»suÉ
 == 0) \

884 
__»suÉ
 = (((
__cÚ¡
 *) \

885 (
__cÚ¡
 *è(
s1
))[3] \

886 - 
__s2
[3]); \

889 
__»suÉ
; }))

	)

891 
	#__¡rcmp_gc
(
s1
, 
s2
, 
l2
) \

892 (
	`__ex‹nsiÚ__
 ({ 
__cÚ¡
 *
__s1
 = \

893 (
__cÚ¡
 *è(__cÚ¡ *è(
s1
); \

894 
__»suÉ
 = \

895 
__s1
[0] - ((
__cÚ¡
 *) \

896 (
__cÚ¡
 *è(
s2
))[0]; \

897 ià(
l2
 > 0 && 
__»suÉ
 == 0) \

899 
__»suÉ
 = (
__s1
[1] \

900 - ((
__cÚ¡
 *) \

901 (
__cÚ¡
 *è(
s2
))[1]); \

902 ià(
l2
 > 1 && 
__»suÉ
 == 0) \

904 
__»suÉ
 = \

905 (
__s1
[2] - ((
__cÚ¡
 *) \

906 (
__cÚ¡
 *è(
s2
))[2]); \

907 ià(
l2
 > 2 && 
__»suÉ
 == 0) \

908 
__»suÉ
 = \

909 (
__s1
[3] \

910 - ((
__cÚ¡
 *) \

911 (
__cÚ¡
 *è(
s2
))[3]); \

914 
__»suÉ
; }))

	)

919 #iâdeà
_HAVE_STRING_ARCH_¡ºcmp


920 
	#¡ºcmp
(
s1
, 
s2
, 
n
) \

921 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
n
) \

922 && ((
	`__butš_cÚ¡ªt_p
 (
s1
) \

923 && 
	`¡¾’
 (
s1
è< ((
size_t
è(
n
))) \

924 || (
	`__butš_cÚ¡ªt_p
 (
s2
) \

925 && 
	`¡¾’
 (
s2
è< ((
size_t
è(
n
)))) \

926 ? 
	`¡rcmp
 (
s1
, 
s2
è: 
	`¡ºcmp
 (s1, s2, 
n
)))

	)

932 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rc¥n
 || defšed 
_FORCE_INLINES


933 #iâdeà
_HAVE_STRING_ARCH_¡rc¥n


934 #ià
__GNUC_PREREQ
 (3, 2)

935 
	#¡rc¥n
(
s
, 
»jeù
) \

936 
__ex‹nsiÚ__
 \

937 ({ 
__r0
, 
__r1
, 
__r2
; \

938 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

939 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

940 ? 
	`__butš_¡rc¥n
 (
s
, 
»jeù
) \

941 : ((
__r0
 = ((
__cÚ¡
 *è(
»jeù
))[0], __r0 == '\0') \

942 ? 
	`¡¾’
 (
s
) \

943 : ((
__r1
 = ((
__cÚ¡
 *è(
»jeù
))[1], __r1 == '\0') \

944 ? 
	`__¡rc¥n_c1
 (
s
, 
__r0
) \

945 : ((
__r2
 = ((
__cÚ¡
 *è(
»jeù
))[2], __r2 == '\0') \

946 ? 
	`__¡rc¥n_c2
 (
s
, 
__r0
, 
__r1
) \

947 : (((
__cÚ¡
 *è(
»jeù
))[3] == '\0' \

948 ? 
	`__¡rc¥n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

949 : 
	`__butš_¡rc¥n
 (
s
, 
»jeù
)))))) \

950 : 
	`__butš_¡rc¥n
 (
s
, 
»jeù
)); })

	)

952 
	#¡rc¥n
(
s
, 
»jeù
) \

953 
__ex‹nsiÚ__
 \

954 ({ 
__r0
, 
__r1
, 
__r2
; \

955 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

956 ? ((
__r0
 = ((
__cÚ¡
 *è(
»jeù
))[0], __r0 == '\0') \

957 ? 
	`¡¾’
 (
s
) \

958 : ((
__r1
 = ((
__cÚ¡
 *è(
»jeù
))[1], __r1 == '\0') \

959 ? 
	`__¡rc¥n_c1
 (
s
, 
__r0
) \

960 : ((
__r2
 = ((
__cÚ¡
 *è(
»jeù
))[2], __r2 == '\0') \

961 ? 
	`__¡rc¥n_c2
 (
s
, 
__r0
, 
__r1
) \

962 : (((
__cÚ¡
 *è(
»jeù
))[3] == '\0' \

963 ? 
	`__¡rc¥n_c3
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

964 : 
	`¡rc¥n
 (
s
, 
»jeù
))))) \

965 : 
	`¡rc¥n
 (
s
, 
»jeù
)); })

	)

969 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c1
 (
__cÚ¡
 *
__s
, 
__»jeù
);

970 
__STRING_INLINE
 
size_t


971 
	$__¡rc¥n_c1
 (
__cÚ¡
 *
__s
, 
__»jeù
)

973 
size_t
 
__»suÉ
 = 0;

974 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù
)

975 ++
__»suÉ
;

976  
__»suÉ
;

977 
	}
}

979 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c2
 (
__cÚ¡
 *
__s
, 
__»jeù1
,

980 
__»jeù2
);

981 
__STRING_INLINE
 
size_t


982 
	$__¡rc¥n_c2
 (
__cÚ¡
 *
__s
, 
__»jeù1
, 
__»jeù2
)

984 
size_t
 
__»suÉ
 = 0;

985 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù1


986 && 
__s
[
__»suÉ
] !ğ
__»jeù2
)

987 ++
__»suÉ
;

988  
__»suÉ
;

989 
	}
}

991 
__STRING_INLINE
 
size_t
 
__¡rc¥n_c3
 (
__cÚ¡
 *
__s
, 
__»jeù1
,

992 
__»jeù2
, 
__»jeù3
);

993 
__STRING_INLINE
 
size_t


994 
	$__¡rc¥n_c3
 (
__cÚ¡
 *
__s
, 
__»jeù1
, 
__»jeù2
,

995 
__»jeù3
)

997 
size_t
 
__»suÉ
 = 0;

998 
__s
[
__»suÉ
] !ğ'\0' && __s[__»suÉ] !ğ
__»jeù1


999 && 
__s
[
__»suÉ
] !ğ
__»jeù2
 && __s[__»suÉ] !ğ
__»jeù3
)

1000 ++
__»suÉ
;

1001  
__»suÉ
;

1002 
	}
}

1008 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r¥n
 || defšed 
_FORCE_INLINES


1009 #iâdeà
_HAVE_STRING_ARCH_¡r¥n


1010 #ià
__GNUC_PREREQ
 (3, 2)

1011 
	#¡r¥n
(
s
, 
acû±
) \

1012 
__ex‹nsiÚ__
 \

1013 ({ 
__a0
, 
__a1
, 
__a2
; \

1014 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1015 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

1016 ? 
	`__butš_¡r¥n
 (
s
, 
acû±
) \

1017 : ((
__a0
 = ((
__cÚ¡
 *è(
acû±
))[0], __a0 == '\0') \

1018 ? ((è(
s
), 0) \

1019 : ((
__a1
 = ((
__cÚ¡
 *è(
acû±
))[1], __a1 == '\0') \

1020 ? 
	`__¡r¥n_c1
 (
s
, 
__a0
) \

1021 : ((
__a2
 = ((
__cÚ¡
 *è(
acû±
))[2], __a2 == '\0') \

1022 ? 
	`__¡r¥n_c2
 (
s
, 
__a0
, 
__a1
) \

1023 : (((
__cÚ¡
 *è(
acû±
))[3] == '\0' \

1024 ? 
	`__¡r¥n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1025 : 
	`__butš_¡r¥n
 (
s
, 
acû±
)))))) \

1026 : 
	`__butš_¡r¥n
 (
s
, 
acû±
)); })

	)

1028 
	#¡r¥n
(
s
, 
acû±
) \

1029 
__ex‹nsiÚ__
 \

1030 ({ 
__a0
, 
__a1
, 
__a2
; \

1031 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1032 ? ((
__a0
 = ((
__cÚ¡
 *è(
acû±
))[0], __a0 == '\0') \

1033 ? ((è(
s
), 0) \

1034 : ((
__a1
 = ((
__cÚ¡
 *è(
acû±
))[1], __a1 == '\0') \

1035 ? 
	`__¡r¥n_c1
 (
s
, 
__a0
) \

1036 : ((
__a2
 = ((
__cÚ¡
 *è(
acû±
))[2], __a2 == '\0') \

1037 ? 
	`__¡r¥n_c2
 (
s
, 
__a0
, 
__a1
) \

1038 : (((
__cÚ¡
 *è(
acû±
))[3] == '\0' \

1039 ? 
	`__¡r¥n_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1040 : 
	`¡r¥n
 (
s
, 
acû±
))))) \

1041 : 
	`¡r¥n
 (
s
, 
acû±
)); })

	)

1045 
__STRING_INLINE
 
size_t
 
__¡r¥n_c1
 (
__cÚ¡
 *
__s
, 
__acû±
);

1046 
__STRING_INLINE
 
size_t


1047 
	$__¡r¥n_c1
 (
__cÚ¡
 *
__s
, 
__acû±
)

1049 
size_t
 
__»suÉ
 = 0;

1051 
__s
[
__»suÉ
] =ğ
__acû±
)

1052 ++
__»suÉ
;

1053  
__»suÉ
;

1054 
	}
}

1056 
__STRING_INLINE
 
size_t
 
__¡r¥n_c2
 (
__cÚ¡
 *
__s
, 
__acû±1
,

1057 
__acû±2
);

1058 
__STRING_INLINE
 
size_t


1059 
	$__¡r¥n_c2
 (
__cÚ¡
 *
__s
, 
__acû±1
, 
__acû±2
)

1061 
size_t
 
__»suÉ
 = 0;

1063 
__s
[
__»suÉ
] =ğ
__acû±1
 || __s[__»suÉ] =ğ
__acû±2
)

1064 ++
__»suÉ
;

1065  
__»suÉ
;

1066 
	}
}

1068 
__STRING_INLINE
 
size_t
 
__¡r¥n_c3
 (
__cÚ¡
 *
__s
, 
__acû±1
,

1069 
__acû±2
, 
__acû±3
);

1070 
__STRING_INLINE
 
size_t


1071 
	$__¡r¥n_c3
 (
__cÚ¡
 *
__s
, 
__acû±1
, 
__acû±2
, 
__acû±3
)

1073 
size_t
 
__»suÉ
 = 0;

1075 
__s
[
__»suÉ
] =ğ
__acû±1
 || __s[__»suÉ] =ğ
__acû±2


1076 || 
__s
[
__»suÉ
] =ğ
__acû±3
)

1077 ++
__»suÉ
;

1078  
__»suÉ
;

1079 
	}
}

1084 #ià!
defšed
 
_HAVE_STRING_ARCH_¡½brk
 || defšed 
_FORCE_INLINES


1085 #iâdeà
_HAVE_STRING_ARCH_¡½brk


1086 #ià
__GNUC_PREREQ
 (3, 2)

1087 
	#¡½brk
(
s
, 
acû±
) \

1088 
__ex‹nsiÚ__
 \

1089 ({ 
__a0
, 
__a1
, 
__a2
; \

1090 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1091 ? ((
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s)) \

1092 ? 
	`__butš_¡½brk
 (
s
, 
acû±
) \

1093 : ((
__a0
 = ((
__cÚ¡
 *è(
acû±
))[0], __a0 == '\0') \

1094 ? ((è(
s
), (*è
NULL
) \

1095 : ((
__a1
 = ((
__cÚ¡
 *è(
acû±
))[1], __a1 == '\0') \

1096 ? 
	`__butš_¡rchr
 (
s
, 
__a0
) \

1097 : ((
__a2
 = ((
__cÚ¡
 *è(
acû±
))[2], __a2 == '\0') \

1098 ? 
	`__¡½brk_c2
 (
s
, 
__a0
, 
__a1
) \

1099 : (((
__cÚ¡
 *è(
acû±
))[3] == '\0' \

1100 ? 
	`__¡½brk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1101 : 
	`__butš_¡½brk
 (
s
, 
acû±
)))))) \

1102 : 
	`__butš_¡½brk
 (
s
, 
acû±
)); })

	)

1104 
	#¡½brk
(
s
, 
acû±
) \

1105 
__ex‹nsiÚ__
 \

1106 ({ 
__a0
, 
__a1
, 
__a2
; \

1107 (
	`__butš_cÚ¡ªt_p
 (
acû±
è&& 
	`__¡ršg2_1b±r_p
 (accept) \

1108 ? ((
__a0
 = ((
__cÚ¡
 *è(
acû±
))[0], __a0 == '\0') \

1109 ? ((è(
s
), (*è
NULL
) \

1110 : ((
__a1
 = ((
__cÚ¡
 *è(
acû±
))[1], __a1 == '\0') \

1111 ? 
	`¡rchr
 (
s
, 
__a0
) \

1112 : ((
__a2
 = ((
__cÚ¡
 *è(
acû±
))[2], __a2 == '\0') \

1113 ? 
	`__¡½brk_c2
 (
s
, 
__a0
, 
__a1
) \

1114 : (((
__cÚ¡
 *è(
acû±
))[3] == '\0' \

1115 ? 
	`__¡½brk_c3
 (
s
, 
__a0
, 
__a1
, 
__a2
) \

1116 : 
	`¡½brk
 (
s
, 
acû±
))))) \

1117 : 
	`¡½brk
 (
s
, 
acû±
)); })

	)

1121 
__STRING_INLINE
 *
__¡½brk_c2
 (
__cÚ¡
 *
__s
, 
__acû±1
,

1122 
__acû±2
);

1123 
__STRING_INLINE
 *

1124 
	$__¡½brk_c2
 (
__cÚ¡
 *
__s
, 
__acû±1
, 
__acû±2
)

1127 *
__s
 !ğ'\0' && *__ !ğ
__acû±1
 && *__ !ğ
__acû±2
)

1128 ++
__s
;

1129  *
__s
 =ğ'\0' ? 
NULL
 : (*è(
size_t
) __s;

1130 
	}
}

1132 
__STRING_INLINE
 *
__¡½brk_c3
 (
__cÚ¡
 *
__s
, 
__acû±1
,

1133 
__acû±2
, 
__acû±3
);

1134 
__STRING_INLINE
 *

1135 
	$__¡½brk_c3
 (
__cÚ¡
 *
__s
, 
__acû±1
, 
__acû±2
,

1136 
__acû±3
)

1139 *
__s
 !ğ'\0' && *__ !ğ
__acû±1
 && *__ !ğ
__acû±2


1140 && *
__s
 !ğ
__acû±3
)

1141 ++
__s
;

1142  *
__s
 =ğ'\0' ? 
NULL
 : (*è(
size_t
) __s;

1143 
	}
}

1149 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r¡r
 && !
__GNUC_PREREQ
 (2, 97)

1150 
	#¡r¡r
(
hay¡ack
, 
ÃedË
) \

1151 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
ÃedË
è&& 
	`__¡ršg2_1b±r_p
 (needle) \

1152 ? (((
__cÚ¡
 *è(
ÃedË
))[0] == '\0' \

1153 ? (*è(
size_t
è(
hay¡ack
) \

1154 : (((
__cÚ¡
 *è(
ÃedË
))[1] == '\0' \

1155 ? 
	`¡rchr
 (
hay¡ack
, \

1156 ((
__cÚ¡
 *è(
ÃedË
))[0]) \

1157 : 
	`¡r¡r
 (
hay¡ack
, 
ÃedË
))) \

1158 : 
	`¡r¡r
 (
hay¡ack
, 
ÃedË
)))

	)

1162 #ià!
defšed
 
_HAVE_STRING_ARCH_¡¹ok_r
 || defšed 
_FORCE_INLINES


1163 #iâdeà
_HAVE_STRING_ARCH_¡¹ok_r


1164 
	#__¡¹ok_r
(
s
, 
£p
, 
Ãx
) \

1165 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
£p
è&& 
	`__¡ršg2_1b±r_p
 (sep) \

1166 && ((
__cÚ¡
 *è(
£p
))[0] != '\0' \

1167 && ((
__cÚ¡
 *è(
£p
))[1] == '\0' \

1168 ? 
	`__¡¹ok_r_1c
 (
s
, ((
__cÚ¡
 *è(
£p
))[0], 
Ãx
) \

1169 : 
	`__¡¹ok_r
 (
s
, 
£p
, 
Ãx
)))

	)

1172 
__STRING_INLINE
 *
__¡¹ok_r_1c
 (*
__s
, 
__£p
, **
__Ãx
);

1173 
__STRING_INLINE
 *

1174 
	$__¡¹ok_r_1c
 (*
__s
, 
__£p
, **
__Ãx
)

1176 *
__»suÉ
;

1177 ià(
__s
 =ğ
NULL
)

1178 
__s
 = *
__Ãx
;

1179 *
__s
 =ğ
__£p
)

1180 ++
__s
;

1181 
__»suÉ
 = 
NULL
;

1182 ià(*
__s
 != '\0')

1184 
__»suÉ
 = 
__s
++;

1185 *
__s
 != '\0')

1186 ià(*
__s
++ =ğ
__£p
)

1188 
__s
[-1] = '\0';

1192 *
__Ãx
 = 
__s
;

1193  
__»suÉ
;

1194 
	}
}

1195 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


1196 
	#¡¹ok_r
(
s
, 
£p
, 
Ãx
è
	`__¡¹ok_r
 (s, s•,‚ex)

	)

1201 #ià!
defšed
 
_HAVE_STRING_ARCH_¡r£p
 || defšed 
_FORCE_INLINES


1202 #iâdeà
_HAVE_STRING_ARCH_¡r£p


1204 *
__¡r£p_g
 (**
__¡ršgp
, 
__cÚ¡
 *
__d–im
);

1205 
	#__¡r£p
(
s
, 
»jeù
) \

1206 
__ex‹nsiÚ__
 \

1207 ({ 
__r0
, 
__r1
, 
__r2
; \

1208 (
	`__butš_cÚ¡ªt_p
 (
»jeù
è&& 
	`__¡ršg2_1b±r_p
 (reject) \

1209 && (
__r0
 = ((
__cÚ¡
 *è(
»jeù
))[0], \

1210 ((
__cÚ¡
 *è(
»jeù
))[0] != '\0') \

1211 ? ((
__r1
 = ((
__cÚ¡
 *è(
»jeù
))[1], \

1212 ((
__cÚ¡
 *è(
»jeù
))[1] == '\0') \

1213 ? 
	`__¡r£p_1c
 (
s
, 
__r0
) \

1214 : ((
__r2
 = ((
__cÚ¡
 *è(
»jeù
))[2], __r2 == '\0') \

1215 ? 
	`__¡r£p_2c
 (
s
, 
__r0
, 
__r1
) \

1216 : (((
__cÚ¡
 *è(
»jeù
))[3] == '\0' \

1217 ? 
	`__¡r£p_3c
 (
s
, 
__r0
, 
__r1
, 
__r2
) \

1218 : 
	`__¡r£p_g
 (
s
, 
»jeù
)))) \

1219 : 
	`__¡r£p_g
 (
s
, 
»jeù
)); })

	)

1222 
__STRING_INLINE
 *
__¡r£p_1c
 (**
__s
, 
__»jeù
);

1223 
__STRING_INLINE
 *

1224 
	$__¡r£p_1c
 (**
__s
, 
__»jeù
)

1226 *
__»tv®
 = *
__s
;

1227 ià(
__»tv®
 !ğ
NULL
 && (*
__s
 = 
	`¡rchr
 (__»tv®, 
__»jeù
)) != NULL)

1228 *(*
__s
)++ = '\0';

1229  
__»tv®
;

1230 
	}
}

1232 
__STRING_INLINE
 *
__¡r£p_2c
 (**
__s
, 
__»jeù1
, 
__»jeù2
);

1233 
__STRING_INLINE
 *

1234 
	$__¡r£p_2c
 (**
__s
, 
__»jeù1
, 
__»jeù2
)

1236 *
__»tv®
 = *
__s
;

1237 ià(
__»tv®
 !ğ
NULL
)

1239 *
__ı
 = 
__»tv®
;

1242 ià(*
__ı
 == '\0')

1244 
__ı
 = 
NULL
;

1247 ià(*
__ı
 =ğ
__»jeù1
 || *__ı =ğ
__»jeù2
)

1249 *
__ı
++ = '\0';

1252 ++
__ı
;

1254 *
__s
 = 
__ı
;

1256  
__»tv®
;

1257 
	}
}

1259 
__STRING_INLINE
 *
__¡r£p_3c
 (**
__s
, 
__»jeù1
, 
__»jeù2
,

1260 
__»jeù3
);

1261 
__STRING_INLINE
 *

1262 
	$__¡r£p_3c
 (**
__s
, 
__»jeù1
, 
__»jeù2
, 
__»jeù3
)

1264 *
__»tv®
 = *
__s
;

1265 ià(
__»tv®
 !ğ
NULL
)

1267 *
__ı
 = 
__»tv®
;

1270 ià(*
__ı
 == '\0')

1272 
__ı
 = 
NULL
;

1275 ià(*
__ı
 =ğ
__»jeù1
 || *__ı =ğ
__»jeù2
 || *__ı =ğ
__»jeù3
)

1277 *
__ı
++ = '\0';

1280 ++
__ı
;

1282 *
__s
 = 
__ı
;

1284  
__»tv®
;

1285 
	}
}

1286 #ifdeà
__USE_BSD


1287 
	#¡r£p
(
s
, 
»jeù
è
	`__¡r£p
 (s,„ejeù)

	)

1294 #ifdeà
__USE_MISC


1296 #ià!
defšed
 
_HAVE_STRING_ARCH_¡rdup
 || !defšed 
_HAVE_STRING_ARCH_¡ºdup


1297 
	#__Ãed_m®loc_ªd_ÿÎoc


	)

1298 
	~<¡dlib.h
>

1301 #iâdeà
_HAVE_STRING_ARCH_¡rdup


1303 *
	$__¡rdup
 (
__cÚ¡
 *
__¡ršg
è
__THROW
 
__©Œibu‹_m®loc__
;

1304 
	#__¡rdup
(
s
) \

1305 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s) \

1306 ? (((
__cÚ¡
 *è(
s
))[0] == '\0' \

1307 ? (*è
	`ÿÎoc
 ((
size_t
) 1, (size_t) 1) \

1308 : ({ 
size_t
 
__Ën
 = 
	`¡¾’
 (
s
) + 1; \

1309 *
__»tv®
 = (*è
	`m®loc
 (
__Ën
); \

1310 ià(
__»tv®
 !ğ
NULL
) \

1311 
__»tv®
 = (*è
	`memıy
 (__»tv®, 
s
, 
__Ën
); \

1312 
__»tv®
; 
	}
})) \

1313 : 
	`__¡rdup
 (
s
)))

	)

1315 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


1316 
	#¡rdup
(
s
è
	`__¡rdup
 (s)

	)

1320 #iâdeà
_HAVE_STRING_ARCH_¡ºdup


1322 *
	$__¡ºdup
 (
__cÚ¡
 *
__¡ršg
, 
size_t
 
__n
)

1323 
__THROW
 
__©Œibu‹_m®loc__
;

1324 
	#__¡ºdup
(
s
, 
n
) \

1325 (
	`__ex‹nsiÚ__
 (
	`__butš_cÚ¡ªt_p
 (
s
è&& 
	`__¡ršg2_1b±r_p
 (s) \

1326 ? (((
__cÚ¡
 *è(
s
))[0] == '\0' \

1327 ? (*è
	`ÿÎoc
 ((
size_t
) 1, (size_t) 1) \

1328 : ({ 
size_t
 
__Ën
 = 
	`¡¾’
 (
s
) + 1; \

1329 
size_t
 
__n
 = (
n
); \

1330 *
__»tv®
; \

1331 ià(
__n
 < 
__Ën
) \

1332 
__Ën
 = 
__n
 + 1; \

1333 
__»tv®
 = (*è
	`m®loc
 (
__Ën
); \

1334 ià(
__»tv®
 !ğ
NULL
) \

1336 
__»tv®
[
__Ën
 - 1] = '\0'; \

1337 
__»tv®
 = (*è
	`memıy
 (__»tv®, 
s
, \

1338 
__Ën
 - 1); \

1340 
__»tv®
; 
	}
})) \

1341 : 
	`__¡ºdup
 (
s
, 
n
)))

	)

1343 #ifdeà
__USE_GNU


1344 
	#¡ºdup
(
s
, 
n
è
	`__¡ºdup
 (s,‚)

	)

1350 #iâdeà
_FORCE_INLINES


1351 #undeà
__STRING_INLINE


	@/usr/include/bits/string3.h

19 #iâdeà
_STRING_H


23 
__w¬ndeş
 (
__w¬n_mem£t_z”o_Ën
,

26 #iâdeà
__ılu¥lus


30 #undeà
memıy


31 #undeà
memmove


32 #undeà
mem£t


33 #undeà
¡rÿt


34 #undeà
¡rıy


35 #undeà
¡ºÿt


36 #undeà
¡ºıy


37 #ifdeà
__USE_GNU


38 #undeà
mempıy


39 #undeà
¡pıy


41 #ifdeà
__USE_BSD


42 #undeà
bcİy


43 #undeà
bz”o


48 
__ex‹º_®ways_šlše
 *

49 
__NTH
 (
	$memıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

50 
size_t
 
__Ën
))

52  
	`__butš___memıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

53 
	}
}

55 
__ex‹º_®ways_šlše
 *

56 
__NTH
 (
	$memmove
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__Ën
))

58  
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

59 
	}
}

61 #ifdeà
__USE_GNU


62 
__ex‹º_®ways_šlše
 *

63 
__NTH
 (
	$mempıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

64 
size_t
 
__Ën
))

66  
	`__butš___mempıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

67 
	}
}

76 
__ex‹º_®ways_šlše
 *

77 
__NTH
 (
	$mem£t
 (*
__de¡
, 
__ch
, 
size_t
 
__Ën
))

79 ià(
	`__butš_cÚ¡ªt_p
 (
__Ën
) && __len == 0

80 && (!
	`__butš_cÚ¡ªt_p
 (
__ch
) || __ch != 0))

82 
	`__w¬n_mem£t_z”o_Ën
 ();

83  
__de¡
;

85  
	`__butš___mem£t_chk
 (
__de¡
, 
__ch
, 
__Ën
, 
	`__bos0
 (__dest));

86 
	}
}

88 #ifdeà
__USE_BSD


89 
__ex‹º_®ways_šlše
 

90 
__NTH
 (
	$bcİy
 (
__cÚ¡
 *
__¤c
, *
__de¡
, 
size_t
 
__Ën
))

92 (è
	`__butš___memmove_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos0
 (__dest));

93 
	}
}

95 
__ex‹º_®ways_šlše
 

96 
__NTH
 (
	$bz”o
 (*
__de¡
, 
size_t
 
__Ën
))

98 (è
	`__butš___mem£t_chk
 (
__de¡
, '\0', 
__Ën
, 
	`__bos0
 (__dest));

99 
	}
}

102 
__ex‹º_®ways_šlše
 *

103 
__NTH
 (
	$¡rıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
))

105  
	`__butš___¡rıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

106 
	}
}

108 #ifdeà
__USE_GNU


109 
__ex‹º_®ways_šlše
 *

110 
__NTH
 (
	$¡pıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
))

112  
	`__butš___¡pıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

113 
	}
}

117 
__ex‹º_®ways_šlše
 *

118 
__NTH
 (
	$¡ºıy
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

119 
size_t
 
__Ën
))

121  
	`__butš___¡ºıy_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

122 
	}
}

125 *
	$__¡²ıy_chk
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
,

126 
size_t
 
__de¡Ën
è
__THROW
;

127 *
	`__REDIRECT_NTH
 (
__¡²ıy_®Ÿs
, (*
__de¡
,

128 
__cÚ¡
 *
__¤c
,

129 
size_t
 
__n
), 
¡²ıy
);

131 
__ex‹º_®ways_šlše
 *

132 
	`__NTH
 (
	$¡²ıy
 (*
__de¡
, 
__cÚ¡
 *
__¤c
, 
size_t
 
__n
))

134 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1

135 && (!
	`__butš_cÚ¡ªt_p
 (
__n
è|| __À<ğ
	`__bos
 (
__de¡
)))

136  
	`__¡²ıy_chk
 (
__de¡
, 
__¤c
, 
__n
, 
	`__bos
 (__dest));

137  
	`__¡²ıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

138 
	}
}

141 
__ex‹º_®ways_šlše
 *

142 
__NTH
 (
	$¡rÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
))

144  
	`__butš___¡rÿt_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__dest));

145 
	}
}

148 
__ex‹º_®ways_šlše
 *

149 
__NTH
 (
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, 
__cÚ¡
 *__»¡riù 
__¤c
,

150 
size_t
 
__Ën
))

152  
	`__butš___¡ºÿt_chk
 (
__de¡
, 
__¤c
, 
__Ën
, 
	`__bos
 (__dest));

153 
	}
}

	@/usr/include/bits/sys_errlist.h

20 #iâdeà
_STDIO_H


26 #ifdeà 
__USE_BSD


27 
sys_Ã¼
;

28 
__cÚ¡
 *__cÚ¡ 
sys_”¾i¡
[];

30 #ifdeà 
__USE_GNU


31 
_sys_Ã¼
;

32 
__cÚ¡
 *__cÚ¡ 
_sys_”¾i¡
[];

	@/usr/include/bits/types.h

24 #iâdef 
_BITS_TYPES_H


25 
	#_BITS_TYPES_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/wÜdsize.h
>

31 
	t__u_ch¬
;

32 
	t__u_shÜt
;

33 
	t__u_št
;

34 
	t__u_lÚg
;

37 sigÃd 
	t__št8_t
;

38 
	t__ušt8_t
;

39 sigÃd 
	t__št16_t
;

40 
	t__ušt16_t
;

41 sigÃd 
	t__št32_t
;

42 
	t__ušt32_t
;

43 #ià
__WORDSIZE
 == 64

44 sigÃd 
	t__št64_t
;

45 
	t__ušt64_t
;

46 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


47 
__ex‹nsiÚ__
 sigÃd 
	t__št64_t
;

48 
__ex‹nsiÚ__
 
	t__ušt64_t
;

52 #ià
__WORDSIZE
 == 64

53 
	t__quad_t
;

54 
	t__u_quad_t
;

55 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


56 
__ex‹nsiÚ__
 
	t__quad_t
;

57 
__ex‹nsiÚ__
 
	t__u_quad_t
;

61 
	m__v®
[2];

62 } 
	t__quad_t
;

65 
__u_lÚg
 
	m__v®
[2];

66 } 
	t__u_quad_t
;

99 
	#__S16_TYPE
 

	)

100 
	#__U16_TYPE
 

	)

101 
	#__S32_TYPE
 

	)

102 
	#__U32_TYPE
 

	)

103 
	#__SLONGWORD_TYPE
 

	)

104 
	#__ULONGWORD_TYPE
 

	)

105 #ià
__WORDSIZE
 == 32

106 
	#__SQUAD_TYPE
 
__quad_t


	)

107 
	#__UQUAD_TYPE
 
__u_quad_t


	)

108 
	#__SWORD_TYPE
 

	)

109 
	#__UWORD_TYPE
 

	)

110 
	#__SLONG32_TYPE
 

	)

111 
	#__ULONG32_TYPE
 

	)

112 
	#__S64_TYPE
 
__quad_t


	)

113 
	#__U64_TYPE
 
__u_quad_t


	)

116 
	#__STD_TYPE
 
__ex‹nsiÚ__
 

	)

117 #–ià
__WORDSIZE
 == 64

118 
	t__SQUAD_TYPE
 

	)

119 
	t__UQUAD_TYPE
 

	)

120 
	t__SWORD_TYPE
 

	)

121 
	t__UWORD_TYPE
 

	)

122 
	t__SLONG32_TYPE
 

	)

123 
	t__ULONG32_TYPE
 

	)

124 
	t__S64_TYPE
 

	)

125 
	t__U64_TYPE
 

	)

127 
	t__STD_TYPE
 

	)

131 
	~<b™s/ty³sizes.h
>

134 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

135 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

136 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

137 
__STD_TYPE
 
__INO_T_TYPE
 
	g__šo_t
;

138 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__šo64_t
;

139 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

140 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__Æšk_t
;

141 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

142 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

143 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

144 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

145 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__şock_t
;

146 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__¾im_t
;

147 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__¾im64_t
;

148 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

149 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

150 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£cÚds_t
;

151 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£cÚds_t
;

153 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

154 
__STD_TYPE
 
__SWBLK_T_TYPE
 
	g__swblk_t
;

155 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

158 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__şockid_t
;

161 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__tim”_t
;

164 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

169 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blkút_t
;

170 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blkút64_t
;

173 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblkút_t
;

174 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblkút64_t
;

177 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfút_t
;

178 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfút64_t
;

180 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

184 
__off64_t
 
	t__loff_t
;

185 
__quad_t
 *
	t__qaddr_t
;

186 *
	t__ÿddr_t
;

189 
__STD_TYPE
 
__SWORD_TYPE
 
	g__šŒ_t
;

192 
__STD_TYPE
 
__U32_TYPE
 
	g__sockËn_t
;

195 #undeà
__STD_TYPE


	@/usr/include/bits/unistd.h

20 #iâdeà
_UNISTD_H


24 
ssize_t
 
	$__»ad_chk
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

25 
size_t
 
__buæ’
è
__wur
;

26 
ssize_t
 
	`__REDIRECT
 (
__»ad_®Ÿs
, (
__fd
, *
__buf
,

27 
size_t
 
__nby‹s
), 
»ad
è
__wur
;

28 
ssize_t
 
	`__REDIRECT
 (
__»ad_chk_w¬n
,

29 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

30 
size_t
 
__buæ’
), 
__»ad_chk
)

31 
__wur
 
	`__w¬Ç‰r
 ("read called with bigger†engthhan size of "

34 
__ex‹º_®ways_šlše
 
__wur
 
ssize_t


35 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
)

37 ià(
	`__bos0
 (
__buf
è!ğ(
size_t
) -1)

39 ià(!
	`__butš_cÚ¡ªt_p
 (
__nby‹s
))

40  
	`__»ad_chk
 (
__fd
, 
__buf
, 
__nby‹s
, 
	`__bos0
 (__buf));

42 ià(
__nby‹s
 > 
	`__bos0
 (
__buf
))

43  
	`__»ad_chk_w¬n
 (
__fd
, 
__buf
, 
__nby‹s
, 
	`__bos0
 (__buf));

45  
	`__»ad_®Ÿs
 (
__fd
, 
__buf
, 
__nby‹s
);

46 
	}
}

48 #ifdeà
__USE_UNIX98


49 
ssize_t
 
	$__´—d_chk
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

50 
__off_t
 
__off£t
, 
size_t
 
__bufsize
è
__wur
;

51 
ssize_t
 
	$__´—d64_chk
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

52 
__off64_t
 
__off£t
, 
size_t
 
__bufsize
è
__wur
;

53 
ssize_t
 
	`__REDIRECT
 (
__´—d_®Ÿs
,

54 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

55 
__off_t
 
__off£t
), 
´—d
è
__wur
;

56 
ssize_t
 
	`__REDIRECT
 (
__´—d64_®Ÿs
,

57 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

58 
__off64_t
 
__off£t
), 
´—d64
è
__wur
;

59 
ssize_t
 
	`__REDIRECT
 (
__´—d_chk_w¬n
,

60 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

61 
__off_t
 
__off£t
, 
size_t
 
__bufsize
), 
__´—d_chk
)

62 
__wur
 
	`__w¬Ç‰r
 ("pread called with bigger†engthhan size of "

64 
ssize_t
 
	`__REDIRECT
 (
__´—d64_chk_w¬n
,

65 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

66 
__off64_t
 
__off£t
, 
size_t
 
__bufsize
),

67 
__´—d64_chk
)

68 
__wur
 
	`__w¬Ç‰r
 ("pread64 called with bigger†engthhan size of "

71 #iâdeà
__USE_FILE_OFFSET64


72 
__ex‹º_®ways_šlše
 
__wur
 
ssize_t


73 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
, 
__off_t
 
__off£t
)

75 ià(
	`__bos0
 (
__buf
è!ğ(
size_t
) -1)

77 ià(!
	`__butš_cÚ¡ªt_p
 (
__nby‹s
))

78  
	`__´—d_chk
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
, 
	`__bos0
 (__buf));

80 iàĞ
__nby‹s
 > 
	`__bos0
 (
__buf
))

81  
	`__´—d_chk_w¬n
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
,

82 
	`__bos0
 (
__buf
));

84  
	`__´—d_®Ÿs
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
);

85 
	}
}

87 
__ex‹º_®ways_šlše
 
__wur
 
ssize_t


88 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
)

90 ià(
	`__bos0
 (
__buf
è!ğ(
size_t
) -1)

92 ià(!
	`__butš_cÚ¡ªt_p
 (
__nby‹s
))

93  
	`__´—d64_chk
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
, 
	`__bos0
 (__buf));

95 iàĞ
__nby‹s
 > 
	`__bos0
 (
__buf
))

96  
	`__´—d64_chk_w¬n
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
,

97 
	`__bos0
 (
__buf
));

100  
	`__´—d64_®Ÿs
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
);

101 
	}
}

104 #ifdeà
__USE_LARGEFILE64


105 
__ex‹º_®ways_šlše
 
__wur
 
ssize_t


106 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
)

108 ià(
	`__bos0
 (
__buf
è!ğ(
size_t
) -1)

110 ià(!
	`__butš_cÚ¡ªt_p
 (
__nby‹s
))

111  
	`__´—d64_chk
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
, 
	`__bos0
 (__buf));

113 iàĞ
__nby‹s
 > 
	`__bos0
 (
__buf
))

114  
	`__´—d64_chk_w¬n
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
,

115 
	`__bos0
 (
__buf
));

118  
	`__´—d64_®Ÿs
 (
__fd
, 
__buf
, 
__nby‹s
, 
__off£t
);

119 
	}
}

123 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


124 
ssize_t
 
	$__»adlšk_chk
 (
__cÚ¡
 *
__»¡riù
 
__·th
,

125 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
,

126 
size_t
 
__buæ’
)

127 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

128 
ssize_t
 
	`__REDIRECT_NTH
 (
__»adlšk_®Ÿs
,

129 (
__cÚ¡
 *
__»¡riù
 
__·th
,

130 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
), 
»adlšk
)

131 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

132 
ssize_t
 
	`__REDIRECT_NTH
 (
__»adlšk_chk_w¬n
,

133 (
__cÚ¡
 *
__»¡riù
 
__·th
,

134 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
,

135 
size_t
 
__buæ’
), 
__»adlšk_chk
)

136 
	`__nÚnuÎ
 ((1, 2)è
__wur
 
	`__w¬Ç‰r
 ("readlink called with bigger†ength "

139 
__ex‹º_®ways_šlše
 
	`__nÚnuÎ
 ((1, 2)è
__wur
 
ssize_t


140 
	`__NTH
 (
	$»adlšk
 (
__cÚ¡
 *
__»¡riù
 
__·th
, *__»¡riù 
__buf
,

141 
size_t
 
__Ën
))

143 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

145 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

146  
	`__»adlšk_chk
 (
__·th
, 
__buf
, 
__Ën
, 
	`__bos
 (__buf));

148 iàĞ
__Ën
 > 
	`__bos
 (
__buf
))

149  
	`__»adlšk_chk_w¬n
 (
__·th
, 
__buf
, 
__Ën
, 
	`__bos
 (__buf));

151  
	`__»adlšk_®Ÿs
 (
__·th
, 
__buf
, 
__Ën
);

152 
	}
}

155 #ifdeà
__USE_ATFILE


156 
ssize_t
 
	$__»adlšk©_chk
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

157 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
,

158 
size_t
 
__buæ’
)

159 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

160 
ssize_t
 
	`__REDIRECT_NTH
 (
__»adlšk©_®Ÿs
,

161 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

162 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
),

163 
»adlšk©
)

164 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

165 
ssize_t
 
	`__REDIRECT_NTH
 (
__»adlšk©_chk_w¬n
,

166 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

167 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
,

168 
size_t
 
__buæ’
), 
__»adlšk©_chk
)

169 
	`__nÚnuÎ
 ((2, 3)è
__wur
 
	`__w¬Ç‰r
 ("readlinkat called with bigger "

173 
__ex‹º_®ways_šlše
 
	`__nÚnuÎ
 ((2, 3)è
__wur
 
ssize_t


174 
	`__NTH
 (
	$»adlšk©
 (
__fd
, 
__cÚ¡
 *
__»¡riù
 
__·th
,

175 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
))

177 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

179 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

180  
	`__»adlšk©_chk
 (
__fd
, 
__·th
, 
__buf
, 
__Ën
, 
	`__bos
 (__buf));

182 ià(
__Ën
 > 
	`__bos
 (
__buf
))

183  
	`__»adlšk©_chk_w¬n
 (
__fd
, 
__·th
, 
__buf
, 
__Ën
,

184 
	`__bos
 (
__buf
));

186  
	`__»adlšk©_®Ÿs
 (
__fd
, 
__·th
, 
__buf
, 
__Ën
);

187 
	}
}

190 *
	$__g‘cwd_chk
 (*
__buf
, 
size_t
 
__size
, size_ˆ
__buæ’
)

191 
__THROW
 
__wur
;

192 *
	`__REDIRECT_NTH
 (
__g‘cwd_®Ÿs
,

193 (*
__buf
, 
size_t
 
__size
), 
g‘cwd
è
__wur
;

194 *
	`__REDIRECT_NTH
 (
__g‘cwd_chk_w¬n
,

195 (*
__buf
, 
size_t
 
__size
, size_ˆ
__buæ’
),

196 
__g‘cwd_chk
)

197 
__wur
 
	`__w¬Ç‰r
 ("getcwd caller with bigger†engthhan size of "

200 
__ex‹º_®ways_šlše
 
__wur
 *

201 
	`__NTH
 (
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
))

203 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

205 ià(!
	`__butš_cÚ¡ªt_p
 (
__size
))

206  
	`__g‘cwd_chk
 (
__buf
, 
__size
, 
	`__bos
 (__buf));

208 ià(
__size
 > 
	`__bos
 (
__buf
))

209  
	`__g‘cwd_chk_w¬n
 (
__buf
, 
__size
, 
	`__bos
 (__buf));

211  
	`__g‘cwd_®Ÿs
 (
__buf
, 
__size
);

212 
	}
}

214 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_XOPEN_EXTENDED


215 *
	$__g‘wd_chk
 (*
__buf
, 
size_t
 
buæ’
)

216 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

217 *
	`__REDIRECT_NTH
 (
__g‘wd_w¬n
, (*
__buf
), 
g‘wd
)

218 
	`__nÚnuÎ
 ((1)è
__wur
 
	`__w¬Ç‰r
 ("please use getcwd instead,‡s getwd "

221 
__ex‹º_®ways_šlše
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
 *

222 
	`__NTH
 (
	$g‘wd
 (*
__buf
))

224 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

225  
	`__g‘wd_chk
 (
__buf
, 
	`__bos
 (__buf));

226  
	`__g‘wd_w¬n
 (
__buf
);

227 
	}
}

230 
size_t
 
	$__cÚf¡r_chk
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
,

231 
size_t
 
__buæ’
è
__THROW
;

232 
size_t
 
	`__REDIRECT_NTH
 (
__cÚf¡r_®Ÿs
, (
__Çme
, *
__buf
,

233 
size_t
 
__Ën
), 
cÚf¡r
);

234 
size_t
 
	`__REDIRECT_NTH
 (
__cÚf¡r_chk_w¬n
,

235 (
__Çme
, *
__buf
, 
size_t
 
__Ën
,

236 
size_t
 
__buæ’
), 
__cÚf¡r_chk
)

237 
	`__w¬Ç‰r
 ("confstr called with bigger†engthhan size of destination "

240 
__ex‹º_®ways_šlše
 
size_t


241 
	`__NTH
 (
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
))

243 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

245 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

246  
	`__cÚf¡r_chk
 (
__Çme
, 
__buf
, 
__Ën
, 
	`__bos
 (__buf));

248 ià(
	`__bos
 (
__buf
è< 
__Ën
)

249  
	`__cÚf¡r_chk_w¬n
 (
__Çme
, 
__buf
, 
__Ën
, 
	`__bos
 (__buf));

251  
	`__cÚf¡r_®Ÿs
 (
__Çme
, 
__buf
, 
__Ën
);

252 
	}
}

255 
	$__g‘groups_chk
 (
__size
, 
__gid_t
 
__li¡
[], 
size_t
 
__li¡Ën
)

256 
__THROW
 
__wur
;

257 
	`__REDIRECT_NTH
 (
__g‘groups_®Ÿs
, (
__size
, 
__gid_t
 
__li¡
[]),

258 
g‘groups
è
__wur
;

259 
	`__REDIRECT_NTH
 (
__g‘groups_chk_w¬n
,

260 (
__size
, 
__gid_t
 
__li¡
[], 
size_t
 
__li¡Ën
),

261 
__g‘groups_chk
)

262 
__wur
 
	`__w¬Ç‰r
 ("getgroups called with bigger group counthan what "

265 
__ex‹º_®ways_šlše
 

266 
	`__NTH
 (
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]))

268 ià(
	`__bos
 (
__li¡
è!ğ(
size_t
) -1)

270 ià(!
	`__butš_cÚ¡ªt_p
 (
__size
) || __size < 0)

271  
	`__g‘groups_chk
 (
__size
, 
__li¡
, 
	`__bos
 (__list));

273 ià(
__size
 *  (
__gid_t
è> 
	`__bos
 (
__li¡
))

274  
	`__g‘groups_chk_w¬n
 (
__size
, 
__li¡
, 
	`__bos
 (__list));

276  
	`__g‘groups_®Ÿs
 (
__size
, 
__li¡
);

277 
	}
}

280 
	$__‰yÇme_r_chk
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

281 
size_t
 
__Ä—l
è
__THROW
 
	`__nÚnuÎ
 ((2));

282 
	`__REDIRECT_NTH
 (
__‰yÇme_r_®Ÿs
, (
__fd
, *
__buf
,

283 
size_t
 
__buæ’
), 
‰yÇme_r
)

284 
	`__nÚnuÎ
 ((2));

285 
	`__REDIRECT_NTH
 (
__‰yÇme_r_chk_w¬n
,

286 (
__fd
, *
__buf
, 
size_t
 
__buæ’
,

287 
size_t
 
__Ä—l
), 
__‰yÇme_r_chk
)

288 
	`__nÚnuÎ
 ((2)è
	`__w¬Ç‰r
 ("ttyname_r called with bigger buflenhan "

291 
__ex‹º_®ways_šlše
 

292 
	`__NTH
 (
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
))

294 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

296 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

297  
	`__‰yÇme_r_chk
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

299 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

300  
	`__‰yÇme_r_chk_w¬n
 (
__fd
, 
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

302  
	`__‰yÇme_r_®Ÿs
 (
__fd
, 
__buf
, 
__buæ’
);

303 
	}
}

306 #ià
defšed
 
__USE_REENTRANT
 || defšed 
__USE_POSIX199506


307 
	$__g‘logš_r_chk
 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
)

308 
	`__nÚnuÎ
 ((1));

309 
	`__REDIRECT
 (
__g‘logš_r_®Ÿs
, (*
__buf
, 
size_t
 
__buæ’
),

310 
g‘logš_r
è
	`__nÚnuÎ
 ((1));

311 
	`__REDIRECT
 (
__g‘logš_r_chk_w¬n
,

312 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
),

313 
__g‘logš_r_chk
)

314 
	`__nÚnuÎ
 ((1)è
	`__w¬Ç‰r
 ("getlogin_r called with bigger buflenhan "

317 
__ex‹º_®ways_šlše
 

318 
	$g‘logš_r
 (*
__buf
, 
size_t
 
__buæ’
)

320 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

322 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

323  
	`__g‘logš_r_chk
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

325 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

326  
	`__g‘logš_r_chk_w¬n
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

328  
	`__g‘logš_r_®Ÿs
 (
__buf
, 
__buæ’
);

329 
	}
}

333 #ià
defšed
 
__USE_BSD
 || defšed 
__USE_UNIX98


334 
	$__g‘ho¡Çme_chk
 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
)

335 
__THROW
 
	`__nÚnuÎ
 ((1));

336 
	`__REDIRECT_NTH
 (
__g‘ho¡Çme_®Ÿs
, (*
__buf
, 
size_t
 
__buæ’
),

337 
g‘ho¡Çme
è
	`__nÚnuÎ
 ((1));

338 
	`__REDIRECT_NTH
 (
__g‘ho¡Çme_chk_w¬n
,

339 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
),

340 
__g‘ho¡Çme_chk
)

341 
	`__nÚnuÎ
 ((1)è
	`__w¬Ç‰r
 ("gethostname called with bigger buflenhan "

344 
__ex‹º_®ways_šlše
 

345 
	`__NTH
 (
	$g‘ho¡Çme
 (*
__buf
, 
size_t
 
__buæ’
))

347 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

349 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

350  
	`__g‘ho¡Çme_chk
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

352 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

353  
	`__g‘ho¡Çme_chk_w¬n
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

355  
	`__g‘ho¡Çme_®Ÿs
 (
__buf
, 
__buæ’
);

356 
	}
}

360 #ià
defšed
 
__USE_BSD
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_UNIX98
)

361 
	$__g‘domašÇme_chk
 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
)

362 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

363 
	`__REDIRECT_NTH
 (
__g‘domašÇme_®Ÿs
, (*
__buf
,

364 
size_t
 
__buæ’
),

365 
g‘domašÇme
è
	`__nÚnuÎ
 ((1)è
__wur
;

366 
	`__REDIRECT_NTH
 (
__g‘domašÇme_chk_w¬n
,

367 (*
__buf
, 
size_t
 
__buæ’
, size_ˆ
__Ä—l
),

368 
__g‘domašÇme_chk
)

369 
	`__nÚnuÎ
 ((1)è
__wur
 
	`__w¬Ç‰r
 ("getdomainname called with bigger "

373 
__ex‹º_®ways_šlše
 

374 
	`__NTH
 (
	$g‘domašÇme
 (*
__buf
, 
size_t
 
__buæ’
))

376 ià(
	`__bos
 (
__buf
è!ğ(
size_t
) -1)

378 ià(!
	`__butš_cÚ¡ªt_p
 (
__buæ’
))

379  
	`__g‘domašÇme_chk
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

381 ià(
__buæ’
 > 
	`__bos
 (
__buf
))

382  
	`__g‘domašÇme_chk_w¬n
 (
__buf
, 
__buæ’
, 
	`__bos
 (__buf));

384  
	`__g‘domašÇme_®Ÿs
 (
__buf
, 
__buæ’
);

385 
	}
}

	@/usr/include/bits/waitflags.h

20 #ià!
defšed
 
_SYS_WAIT_H
 && !defšed 
_STDLIB_H


26 
	#WNOHANG
 1

	)

27 
	#WUNTRACED
 2

	)

30 
	#WSTOPPED
 2

	)

31 
	#WEXITED
 4

	)

32 
	#WCONTINUED
 8

	)

33 
	#WNOWAIT
 0x01000000

	)

35 
	#__WNOTHREAD
 0x20000000

	)

37 
	#__WALL
 0x40000000

	)

38 
	#__WCLONE
 0x80000000

	)

	@/usr/include/bits/waitstatus.h

20 #ià!
defšed
 
_SYS_WAIT_H
 && !defšed 
_STDLIB_H


29 
	#__WEXITSTATUS
(
¡©us
è(((¡©usè& 0xff00è>> 8)

	)

32 
	#__WTERMSIG
(
¡©us
è((¡©usè& 0x7f)

	)

35 
	#__WSTOPSIG
(
¡©us
è
	`__WEXITSTATUS
(¡©us)

	)

38 
	#__WIFEXITED
(
¡©us
è(
	`__WTERMSIG
(¡©usè=ğ0)

	)

41 
	#__WIFSIGNALED
(
¡©us
) \

42 (((sigÃd è(((
¡©us
è& 0x7fè+ 1è>> 1è> 0)

	)

45 
	#__WIFSTOPPED
(
¡©us
è(((¡©usè& 0xffè=ğ0x7f)

	)

49 #ifdeà
WCONTINUED


50 
	#__WIFCONTINUED
(
¡©us
è((¡©usè=ğ
__W_CONTINUED
)

	)

54 
	#__WCOREDUMP
(
¡©us
è((¡©usè& 
__WCOREFLAG
)

	)

57 
	#__W_EXITCODE
(
»t
, 
sig
è(Ô‘è<< 8 | (sig))

	)

58 
	#__W_STOPCODE
(
sig
è((sigè<< 8 | 0x7f)

	)

59 
	#__W_CONTINUED
 0xffff

	)

60 
	#__WCOREFLAG
 0x80

	)

63 #ifdef 
__USE_BSD


65 
	~<’dŸn.h
>

67 
	uwa™


69 
	mw_¡©us
;

72 #if 
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


73 
	m__w_‹rmsig
:7;

74 
	m__w_cÜedump
:1;

75 
	m__w_»tcode
:8;

78 #if 
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


80 
	m__w_»tcode
:8;

81 
	m__w_cÜedump
:1;

82 
	m__w_‹rmsig
:7;

84 } 
	m__wa™_‹rmš©ed
;

87 #if 
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


88 
	m__w_¡İv®
:8;

89 
	m__w_¡İsig
:8;

92 #if 
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


94 
	m__w_¡İsig
:8;

95 
	m__w_¡İv®
:8;

97 } 
	m__wa™_¡İ³d
;

100 
	#w_‹rmsig
 
__wa™_‹rmš©ed
.
__w_‹rmsig


	)

101 
	#w_cÜedump
 
__wa™_‹rmš©ed
.
__w_cÜedump


	)

102 
	#w_»tcode
 
__wa™_‹rmš©ed
.
__w_»tcode


	)

103 
	#w_¡İsig
 
__wa™_¡İ³d
.
__w_¡İsig


	)

104 
	#w_¡İv®
 
__wa™_¡İ³d
.
__w_¡İv®


	)

	@/usr/include/endian.h

19 #iâdef 
_ENDIAN_H


20 
	#_ENDIAN_H
 1

	)

22 
	~<ã©u»s.h
>

32 
	#__LITTLE_ENDIAN
 1234

	)

33 
	#__BIG_ENDIAN
 4321

	)

34 
	#__PDP_ENDIAN
 3412

	)

37 
	~<b™s/’dŸn.h
>

41 #iâdeà
__FLOAT_WORD_ORDER


42 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

45 #ifdef 
__USE_BSD


46 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

47 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

48 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

49 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

52 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


53 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

54 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


55 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

59 #ifdeà
__USE_BSD


61 
	~<b™s/by‹sw­.h
>

63 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


64 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

65 
	#htŞe16
(
x
è(x)

	)

66 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

67 
	#Ë16toh
(
x
è(x)

	)

69 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

70 
	#htŞe32
(
x
è(x)

	)

71 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

72 
	#Ë32toh
(
x
è(x)

	)

74 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

75 
	#htŞe64
(
x
è(x)

	)

76 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

77 
	#Ë64toh
(
x
è(x)

	)

79 
	#htobe16
(
x
è(x)

	)

80 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

81 
	#be16toh
(
x
è(x)

	)

82 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

84 
	#htobe32
(
x
è(x)

	)

85 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

86 
	#be32toh
(
x
è(x)

	)

87 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

89 
	#htobe64
(
x
è(x)

	)

90 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

91 
	#be64toh
(
x
è(x)

	)

92 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

19 #iâdef 
_FEATURES_H


20 
	#_FEATURES_H
 1

	)

96 #undeà
__USE_ISOC99


97 #undeà
__USE_ISOC95


98 #undeà
__USE_POSIX


99 #undeà
__USE_POSIX2


100 #undeà
__USE_POSIX199309


101 #undeà
__USE_POSIX199506


102 #undeà
__USE_XOPEN


103 #undeà
__USE_XOPEN_EXTENDED


104 #undeà
__USE_UNIX98


105 #undeà
__USE_XOPEN2K


106 #undeà
__USE_XOPEN2KXSI


107 #undeà
__USE_XOPEN2K8


108 #undeà
__USE_XOPEN2K8XSI


109 #undeà
__USE_LARGEFILE


110 #undeà
__USE_LARGEFILE64


111 #undeà
__USE_FILE_OFFSET64


112 #undeà
__USE_BSD


113 #undeà
__USE_SVID


114 #undeà
__USE_MISC


115 #undeà
__USE_ATFILE


116 #undeà
__USE_GNU


117 #undeà
__USE_REENTRANT


118 #undeà
__USE_FORTIFY_LEVEL


119 #undeà
__FAVOR_BSD


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

129 
	#__USE_ANSI
 1

	)

138 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


139 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

140 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

142 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

147 #ià
defšed
 
_BSD_SOURCE
 && \

148 !(
defšed
 
	g_POSIX_SOURCE
 || defšed 
	g_POSIX_C_SOURCE
 || \

149 
defšed
 
	g_XOPEN_SOURCE
 || defšed 
	g_GNU_SOURCE
 || defšed 
	g_SVID_SOURCE
)

150 
	#__FAVOR_BSD
 1

	)

154 #ifdeà
_GNU_SOURCE


155 #undeà
_ISOC95_SOURCE


156 
	#_ISOC95_SOURCE
 1

	)

157 #undeà
_ISOC99_SOURCE


158 
	#_ISOC99_SOURCE
 1

	)

159 #undeà
_POSIX_SOURCE


160 
	#_POSIX_SOURCE
 1

	)

161 #undeà
_POSIX_C_SOURCE


162 
	#_POSIX_C_SOURCE
 200809L

	)

163 #undeà
_XOPEN_SOURCE


164 
	#_XOPEN_SOURCE
 700

	)

165 #undeà
_XOPEN_SOURCE_EXTENDED


166 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

167 #undeà
_LARGEFILE64_SOURCE


168 
	#_LARGEFILE64_SOURCE
 1

	)

169 #undeà
_BSD_SOURCE


170 
	#_BSD_SOURCE
 1

	)

171 #undeà
_SVID_SOURCE


172 
	#_SVID_SOURCE
 1

	)

173 #undeà
_ATFILE_SOURCE


174 
	#_ATFILE_SOURCE
 1

	)

179 #ià(!
defšed
 
__STRICT_ANSI__
 && !defšed 
_ISOC99_SOURCE
 && \

180 !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 && \

181 !
defšed
 
	g_XOPEN_SOURCE
 && !defšed 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
)

182 
	#_BSD_SOURCE
 1

	)

183 
	#_SVID_SOURCE
 1

	)

190 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

191 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

192 
	#__USE_ISOC99
 1

	)

196 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

197 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

198 
	#__USE_ISOC95
 1

	)

203 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

204 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

205 
	#_POSIX_SOURCE
 1

	)

206 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

207 
	#_POSIX_C_SOURCE
 2

	)

208 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

209 
	#_POSIX_C_SOURCE
 199506L

	)

210 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

211 
	#_POSIX_C_SOURCE
 200112L

	)

213 
	#_POSIX_C_SOURCE
 200809L

	)

215 
	#__USE_POSIX_IMPLICITLY
 1

	)

218 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


219 
	#__USE_POSIX
 1

	)

222 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


223 
	#__USE_POSIX2
 1

	)

226 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

227 
	#__USE_POSIX199309
 1

	)

230 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

231 
	#__USE_POSIX199506
 1

	)

234 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

235 
	#__USE_XOPEN2K
 1

	)

236 #undeà
__USE_ISOC95


237 
	#__USE_ISOC95
 1

	)

238 #undeà
__USE_ISOC99


239 
	#__USE_ISOC99
 1

	)

242 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

243 
	#__USE_XOPEN2K8
 1

	)

244 #undeà
_ATFILE_SOURCE


245 
	#_ATFILE_SOURCE
 1

	)

248 #ifdef 
_XOPEN_SOURCE


249 
	#__USE_XOPEN
 1

	)

250 #ià(
_XOPEN_SOURCE
 - 0) >= 500

251 
	#__USE_XOPEN_EXTENDED
 1

	)

252 
	#__USE_UNIX98
 1

	)

253 #undeà
_LARGEFILE_SOURCE


254 
	#_LARGEFILE_SOURCE
 1

	)

255 #ià(
_XOPEN_SOURCE
 - 0) >= 600

256 #ià(
_XOPEN_SOURCE
 - 0) >= 700

257 
	#__USE_XOPEN2K8
 1

	)

258 
	#__USE_XOPEN2K8XSI
 1

	)

260 
	#__USE_XOPEN2K
 1

	)

261 
	#__USE_XOPEN2KXSI
 1

	)

262 #undeà
__USE_ISOC95


263 
	#__USE_ISOC95
 1

	)

264 #undeà
__USE_ISOC99


265 
	#__USE_ISOC99
 1

	)

268 #ifdeà
_XOPEN_SOURCE_EXTENDED


269 
	#__USE_XOPEN_EXTENDED
 1

	)

274 #ifdeà
_LARGEFILE_SOURCE


275 
	#__USE_LARGEFILE
 1

	)

278 #ifdeà
_LARGEFILE64_SOURCE


279 
	#__USE_LARGEFILE64
 1

	)

282 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

283 
	#__USE_FILE_OFFSET64
 1

	)

286 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


287 
	#__USE_MISC
 1

	)

290 #ifdef 
_BSD_SOURCE


291 
	#__USE_BSD
 1

	)

294 #ifdef 
_SVID_SOURCE


295 
	#__USE_SVID
 1

	)

298 #ifdef 
_ATFILE_SOURCE


299 
	#__USE_ATFILE
 1

	)

302 #ifdef 
_GNU_SOURCE


303 
	#__USE_GNU
 1

	)

306 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


307 
	#__USE_REENTRANT
 1

	)

310 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

311 && 
defšed
 
__OPTIMIZE__
 && __OPTIMIZE__ > 0

312 #ià!
__GNUC_PREREQ
 (4, 1)

313 #ifdeà
__GNUC_RH_RELEASE__


314 #w¬nšg 
_FORTIFY_SOURCE
 
suµÜ‹d
 
Úly
 
w™h
 
GCC
 4.1 
ªd
 
Ï‹r


316 
	#__USE_FORTIFY_LEVEL
 0

	)

317 #–ià
_FORTIFY_SOURCE
 > 1

318 
	#__USE_FORTIFY_LEVEL
 2

	)

320 
	#__USE_FORTIFY_LEVEL
 1

	)

323 
	#__USE_FORTIFY_LEVEL
 0

	)

327 
	#__STDC_IEC_559__
 1

	)

328 
	#__STDC_IEC_559_COMPLEX__
 1

	)

331 
	#__STDC_ISO_10646__
 200009L

	)

339 #undeà
__GNU_LIBRARY__


340 
	#__GNU_LIBRARY__
 6

	)

344 
	#__GLIBC__
 2

	)

345 
	#__GLIBC_MINOR__
 12

	)

347 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

348 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

351 #ià
defšed
 
__GNUC__
 \

352 || (
defšed
 
	g__PGI
 && defšed 
	g__i386__
 ) \

353 || (
defšed
 
	g__INTEL_COMPILER
 && (defšed 
	g__i386__
 || defšed 
	g__Ÿ64__
)) \

354 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

355 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

359 #iâdeà
__ASSEMBLER__


360 #iâdeà
_SYS_CDEFS_H


361 
	~<sys/cdefs.h
>

366 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


367 
	#__USE_LARGEFILE
 1

	)

368 
	#__USE_LARGEFILE64
 1

	)

374 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

375 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

376 && 
defšed
 
	g__ex‹º_šlše


377 
	#__USE_EXTERN_INLINES
 1

	)

385 
	~<gnu/¡ubs.h
>

	@/usr/include/getopt.h

21 #iâdeà
_GETOPT_H


23 #iâdeà
__Ãed_g‘İt


24 
	#_GETOPT_H
 1

	)

34 #ià!
defšed
 
__GNU_LIBRARY__


35 
	~<ùy³.h
>

38 #iâdeà
__THROW


39 #iâdeà
__GNUC_PREREQ


40 
	#__GNUC_PREREQ
(
maj
, 
mš
è(0)

	)

42 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

43 
	#__THROW
 
	`throw
 ()

	)

45 
	#__THROW


	)

49 #ifdef 
__ılu¥lus


59 *
İrg
;

73 
İtšd
;

78 
İ‹¼
;

82 
İtİt
;

84 #iâdeà
__Ãed_g‘İt


106 
	sİtiÚ


108 cÚ¡ *
	gÇme
;

111 
	ghas_¬g
;

112 *
	gæag
;

113 
	gv®
;

118 
	#no_¬gum’t
 0

	)

119 
	#»quœed_¬gum’t
 1

	)

120 
	#İtiÚ®_¬gum’t
 2

	)

148 #ifdeà
__GNU_LIBRARY__


152 
g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
, cÚ¡ *
__shÜtİts
)

153 
__THROW
;

155 #ià
defšed
 
__Ãed_g‘İt
 && defšed 
__USE_POSIX2
 \

156 && !
defšed
 
	g__USE_POSIX_IMPLICITLY
 && !defšed 
	g__USE_GNU


160 #ifdeà
__REDIRECT


161 
__REDIRECT
 (
g‘İt
, (
___¬gc
, *cÚ¡ *
___¬gv
,

162 cÚ¡ *
__shÜtİts
),

163 
__posix_g‘İt
è
__THROW
;

165 
__posix_g‘İt
 (
___¬gc
, *cÚ¡ *
___¬gv
,

166 cÚ¡ *
__shÜtİts
è
__THROW
;

167 
	#g‘İt
 
__posix_g‘İt


	)

171 
g‘İt
 ();

174 #iâdeà
__Ãed_g‘İt


175 
g‘İt_lÚg
 (
___¬gc
, *cÚ¡ *
___¬gv
,

176 cÚ¡ *
__shÜtİts
,

177 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

178 
__THROW
;

179 
g‘İt_lÚg_Úly
 (
___¬gc
, *cÚ¡ *
___¬gv
,

180 cÚ¡ *
__shÜtİts
,

181 cÚ¡ 
İtiÚ
 *
__lÚgİts
, *
__lÚgšd
)

182 
__THROW
;

186 #ifdef 
__ılu¥lus


191 #undeà
__Ãed_g‘İt


	@/usr/include/libio.h

29 #iâdeà
_IO_STDIO_H


30 
	#_IO_STDIO_H


	)

32 
	~<_G_cÚfig.h
>

34 
	#_IO_pos_t
 
_G_åos_t


	)

35 
	#_IO_åos_t
 
_G_åos_t


	)

36 
	#_IO_åos64_t
 
_G_åos64_t


	)

37 
	#_IO_size_t
 
_G_size_t


	)

38 
	#_IO_ssize_t
 
_G_ssize_t


	)

39 
	#_IO_off_t
 
_G_off_t


	)

40 
	#_IO_off64_t
 
_G_off64_t


	)

41 
	#_IO_pid_t
 
_G_pid_t


	)

42 
	#_IO_uid_t
 
_G_uid_t


	)

43 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

44 
	#_IO_HAVE_SYS_WAIT
 
_G_HAVE_SYS_WAIT


	)

45 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

46 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

47 
	#_IO_va_li¡
 
_G_va_li¡


	)

48 
	#_IO_wšt_t
 
_G_wšt_t


	)

50 #ifdeà
_G_NEED_STDARG_H


52 
	#__Ãed___va_li¡


	)

53 
	~<¡d¬g.h
>

54 #ifdeà
__GNUC_VA_LIST


55 #undeà
_IO_va_li¡


56 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

60 #iâdeà
__P


61 #ià
_G_HAVE_SYS_CDEFS


62 
	~<sys/cdefs.h
>

64 #ifdeà
__STDC__


65 
	#__P
(
p
è
	)
p

66 
	#__PMT
(
p
è
	)
p

68 
	#__P
(
p
è()

	)

69 
	#__PMT
(
p
è()

	)

75 #iâdeà
_PARAMS


76 
	#_PARAMS
(
´Ùos
è
	`__P
ÕrÙos)

	)

79 #iâdeà
__STDC__


81 cÚ¡

	)

84 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

85 #iâdeà
_G_HAVE_PRINTF_FP


86 
	#_IO_USE_DTOA
 1

	)

89 #iâdeà
EOF


90 
	#EOF
 (-1)

	)

92 #iâdeà
NULL


93 #ià
defšed
 
__GNUG__
 && \

94 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

95 
	#NULL
 (
__nuÎ
)

	)

97 #ià!
defšed
(
__ılu¥lus
)

98 
	#NULL
 ((*)0)

	)

100 
	#NULL
 (0)

	)

105 
	#_IOS_INPUT
 1

	)

106 
	#_IOS_OUTPUT
 2

	)

107 
	#_IOS_ATEND
 4

	)

108 
	#_IOS_APPEND
 8

	)

109 
	#_IOS_TRUNC
 16

	)

110 
	#_IOS_NOCREATE
 32

	)

111 
	#_IOS_NOREPLACE
 64

	)

112 
	#_IOS_BIN
 128

	)

120 
	#_IO_MAGIC
 0xFBAD0000

	)

121 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

122 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

123 
	#_IO_USER_BUF
 1

	)

124 
	#_IO_UNBUFFERED
 2

	)

125 
	#_IO_NO_READS
 4

	)

126 
	#_IO_NO_WRITES
 8

	)

127 
	#_IO_EOF_SEEN
 0x10

	)

128 
	#_IO_ERR_SEEN
 0x20

	)

129 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

130 
	#_IO_LINKED
 0x80

	)

131 
	#_IO_IN_BACKUP
 0x100

	)

132 
	#_IO_LINE_BUF
 0x200

	)

133 
	#_IO_TIED_PUT_GET
 0x400

	)

134 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

135 
	#_IO_IS_APPENDING
 0x1000

	)

136 
	#_IO_IS_FILEBUF
 0x2000

	)

137 
	#_IO_BAD_SEEN
 0x4000

	)

138 
	#_IO_USER_LOCK
 0x8000

	)

140 
	#_IO_FLAGS2_MMAP
 1

	)

141 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

142 #ifdeà
_LIBC


143 
	#_IO_FLAGS2_FORTIFY
 4

	)

145 
	#_IO_FLAGS2_USER_WBUF
 8

	)

146 #ifdeà
_LIBC


147 
	#_IO_FLAGS2_SCANF_STD
 16

	)

151 
	#_IO_SKIPWS
 01

	)

152 
	#_IO_LEFT
 02

	)

153 
	#_IO_RIGHT
 04

	)

154 
	#_IO_INTERNAL
 010

	)

155 
	#_IO_DEC
 020

	)

156 
	#_IO_OCT
 040

	)

157 
	#_IO_HEX
 0100

	)

158 
	#_IO_SHOWBASE
 0200

	)

159 
	#_IO_SHOWPOINT
 0400

	)

160 
	#_IO_UPPERCASE
 01000

	)

161 
	#_IO_SHOWPOS
 02000

	)

162 
	#_IO_SCIENTIFIC
 04000

	)

163 
	#_IO_FIXED
 010000

	)

164 
	#_IO_UNITBUF
 020000

	)

165 
	#_IO_STDIO
 040000

	)

166 
	#_IO_DONT_CLOSE
 0100000

	)

167 
	#_IO_BOOLALPHA
 0200000

	)

170 
_IO_jump_t
; 
	g_IO_FILE
;

173 #ifdeà
_IO_MTSAFE_IO


174 #ià
defšed
 
__GLIBC__
 && __GLIBC__ >= 2

175 
	~<b™s/¡dio-lock.h
>

180 
	t_IO_lock_t
;

186 
	s_IO_m¬k”
 {

187 
_IO_m¬k”
 *
	m_Ãxt
;

188 
_IO_FILE
 *
	m_sbuf
;

192 
	m_pos
;

194 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

195 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

196 
	mpublic
:

197 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

198 ~
¡»amm¬k”
();

199 
§všg
(è{  
	m_¥os
 == -2; }

200 
d–
(
¡»amm¬k”
&);

201 
d–
();

206 
	e__codecvt_»suÉ


208 
	m__codecvt_ok
,

209 
	m__codecvt_·¹Ÿl
,

210 
	m__codecvt_”rÜ
,

211 
	m__codecvt_nocÚv


214 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


217 
	s_IO_codecvt


219 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

220 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

221 
	m__mb¡©e_t
 *,

222 cÚ¡ 
	mwch¬_t
 *,

223 cÚ¡ 
	mwch¬_t
 *,

224 cÚ¡ 
	mwch¬_t
 **, *,

226 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

227 
	m__mb¡©e_t
 *, *,

229 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

230 
	m__mb¡©e_t
 *,

232 cÚ¡ **, 
	mwch¬_t
 *,

233 
	mwch¬_t
 *, wchar_t **);

234 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

235 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

236 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

237 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

238 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

240 
_IO_icÚv_t
 
	m__cd_š
;

241 
_IO_icÚv_t
 
	m__cd_out
;

245 
	s_IO_wide_d©a


247 
wch¬_t
 *
	m_IO_»ad_±r
;

248 
wch¬_t
 *
	m_IO_»ad_’d
;

249 
wch¬_t
 *
	m_IO_»ad_ba£
;

250 
wch¬_t
 *
	m_IO_wr™e_ba£
;

251 
wch¬_t
 *
	m_IO_wr™e_±r
;

252 
wch¬_t
 *
	m_IO_wr™e_’d
;

253 
wch¬_t
 *
	m_IO_buf_ba£
;

254 
wch¬_t
 *
	m_IO_buf_’d
;

256 
wch¬_t
 *
	m_IO_§ve_ba£
;

257 
wch¬_t
 *
	m_IO_backup_ba£
;

259 
wch¬_t
 *
	m_IO_§ve_’d
;

261 
__mb¡©e_t
 
	m_IO_¡©e
;

262 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

263 
_IO_codecvt
 
	m_codecvt
;

265 
wch¬_t
 
	m_shÜtbuf
[1];

267 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

271 
	s_IO_FILE
 {

272 
	m_æags
;

273 
	#_IO_fe_æags
 
_æags


	)

277 * 
	m_IO_»ad_±r
;

278 * 
	m_IO_»ad_’d
;

279 * 
	m_IO_»ad_ba£
;

280 * 
	m_IO_wr™e_ba£
;

281 * 
	m_IO_wr™e_±r
;

282 * 
	m_IO_wr™e_’d
;

283 * 
	m_IO_buf_ba£
;

284 * 
	m_IO_buf_’d
;

286 *
	m_IO_§ve_ba£
;

287 *
	m_IO_backup_ba£
;

288 *
	m_IO_§ve_’d
;

290 
_IO_m¬k”
 *
	m_m¬k”s
;

292 
_IO_FILE
 *
	m_chaš
;

294 
	m_f’o
;

296 
	m_blksize
;

298 
	m_æags2
;

300 
_IO_off_t
 
	m_Şd_off£t
;

302 
	#__HAVE_COLUMN


	)

304 
	m_cur_cŞumn
;

305 sigÃd 
	m_vbË_off£t
;

306 
	m_shÜtbuf
[1];

310 
_IO_lock_t
 *
	m_lock
;

311 #ifdeà
_IO_USE_OLD_IO_FILE


314 
	s_IO_FILE_com¶‘e


316 
_IO_FILE
 
	m_fe
;

318 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

319 
_IO_off64_t
 
	m_off£t
;

320 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


322 
_IO_codecvt
 *
	m_codecvt
;

323 
_IO_wide_d©a
 *
	m_wide_d©a
;

324 
_IO_FILE
 *
	m_ä“»s_li¡
;

325 *
	m_ä“»s_buf
;

326 
size_t
 
	m_ä“»s_size
;

328 *
	m__·d1
;

329 *
	m__·d2
;

330 *
	m__·d3
;

331 *
	m__·d4
;

332 
size_t
 
	m__·d5
;

334 
	m_mode
;

336 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

340 #iâdeà
__ılu¥lus


341 
_IO_FILE
 
	t_IO_FILE
;

344 
	g_IO_FILE_¶us
;

346 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

347 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

348 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

349 #iâdeà
_LIBC


350 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

351 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

352 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

354 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

355 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

356 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

364 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

372 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, 
	t__cÚ¡
 *
	t__buf
,

373 
	tsize_t
 
	t__n
);

381 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

384 
	t__io_şo£_â
 (*
	t__cook›
);

387 #ifdeà
_GNU_SOURCE


389 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

390 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

391 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

392 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

397 
__io_»ad_â
 *
	m»ad
;

398 
__io_wr™e_â
 *
	mwr™e
;

399 
__io_£ek_â
 *
	m£ek
;

400 
__io_şo£_â
 *
	mşo£
;

401 } 
	t_IO_cook›_io_funùiÚs_t
;

402 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

404 
	g_IO_cook›_fe
;

407 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

408 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

412 #ifdeà
__ılu¥lus


416 
__und”æow
 (
_IO_FILE
 *);

417 
__uæow
 (
_IO_FILE
 *);

418 
__ov”æow
 (
_IO_FILE
 *, );

419 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


420 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

421 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

422 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

425 #ià 
__GNUC__
 >= 3

426 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

428 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

431 
	#_IO_g‘c_uÆocked
(
_å
) \

432 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

433 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

434 
	#_IO_³ekc_uÆocked
(
_å
) \

435 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

436 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

437 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

438 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

439 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

440 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

441 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

443 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


444 
	#_IO_g‘wc_uÆocked
(
_å
) \

445 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

446 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

447 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

448 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

449 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

450 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

451 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

452 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

453 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

454 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

457 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

458 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

460 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

461 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

462 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

463 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

465 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

468 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

469 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

471 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

472 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

473 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

475 #ifdeà
_IO_MTSAFE_IO


476 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_locked
 (_å)

	)

477 
	#_IO_æockfe
(
_å
) \

478 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_æockfe
 (_å)

	)

479 
	#_IO_fuÆockfe
(
_å
) \

480 ià(((
_å
)->
_æags
 & 
_IO_USER_LOCK
è=ğ0è
	`_IO_fuÆockfe
 (_å)

	)

482 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

483 
	#_IO_æockfe
(
_å
è

	)

484 
	#_IO_fuÆockfe
(
_å
è

	)

485 
	#_IO_árylockfe
(
_å
è

	)

486 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

487 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

490 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

491 
_IO_va_li¡
, *
__»¡riù
);

492 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

493 
_IO_va_li¡
);

494 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

495 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

497 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

498 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

500 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

502 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


503 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

504 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

505 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

506 #ià
__GNUC__
 >= 2

509 #ià
defšed
 
_LIBC
 && defšed 
SHARED


510 
	~<shlib-com·t.h
>

511 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

512 
	#_IO_fwide_maybe_šcom·tibË
 \

513 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

514 cÚ¡ 
_IO_¡dš_u£d
;

515 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

518 #iâdeà
_IO_fwide_maybe_šcom·tibË


519 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

523 
	#_IO_fwide
(
__å
, 
__mode
) \

524 ({ 
__»suÉ
 = (
__mode
); \

525 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

527 ià((
__å
)->
_mode
 == 0) \

529 (
__å
)->
_mode
 = -1; \

530 
__»suÉ
 = (
__å
)->
_mode
; \

532 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

533 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

535 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

536 
__»suÉ
; })

	)

539 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

540 
_IO_va_li¡
, *
__»¡riù
);

541 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

542 
_IO_va_li¡
);

543 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

544 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

547 #ifdeà
__LDBL_COMPAT


548 
	~<b™s/libio-ldbl.h
>

551 #ifdeà
__ılu¥lus


	@/usr/include/linux/errno.h

1 #iâdeà
_LINUX_ERRNO_H


2 
	#_LINUX_ERRNO_H


	)

4 
	~<asm/”ºo.h
>

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

	@/usr/include/stdint.h

23 #iâdeà
_STDINT_H


24 
	#_STDINT_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	~<b™s/wch¬.h
>

28 
	~<b™s/wÜdsize.h
>

35 #iâdeà
__št8_t_defšed


36 
	#__št8_t_defšed


	)

37 sigÃd 
	tšt8_t
;

38 
	tšt16_t
;

39 
	tšt32_t
;

40 #ià
__WORDSIZE
 == 64

41 
	tšt64_t
;

43 
__ex‹nsiÚ__


44 
	tšt64_t
;

49 
	tušt8_t
;

50 
	tušt16_t
;

51 #iâdeà
__ušt32_t_defšed


52 
	tušt32_t
;

53 
	#__ušt32_t_defšed


	)

55 #ià
__WORDSIZE
 == 64

56 
	tušt64_t
;

58 
__ex‹nsiÚ__


59 
	tušt64_t
;

66 sigÃd 
	tšt_Ëa¡8_t
;

67 
	tšt_Ëa¡16_t
;

68 
	tšt_Ëa¡32_t
;

69 #ià
__WORDSIZE
 == 64

70 
	tšt_Ëa¡64_t
;

72 
__ex‹nsiÚ__


73 
	tšt_Ëa¡64_t
;

77 
	tušt_Ëa¡8_t
;

78 
	tušt_Ëa¡16_t
;

79 
	tušt_Ëa¡32_t
;

80 #ià
__WORDSIZE
 == 64

81 
	tušt_Ëa¡64_t
;

83 
__ex‹nsiÚ__


84 
	tušt_Ëa¡64_t
;

91 sigÃd 
	tšt_ç¡8_t
;

92 #ià
__WORDSIZE
 == 64

93 
	tšt_ç¡16_t
;

94 
	tšt_ç¡32_t
;

95 
	tšt_ç¡64_t
;

97 
	tšt_ç¡16_t
;

98 
	tšt_ç¡32_t
;

99 
__ex‹nsiÚ__


100 
	tšt_ç¡64_t
;

104 
	tušt_ç¡8_t
;

105 #ià
__WORDSIZE
 == 64

106 
	tušt_ç¡16_t
;

107 
	tušt_ç¡32_t
;

108 
	tušt_ç¡64_t
;

110 
	tušt_ç¡16_t
;

111 
	tušt_ç¡32_t
;

112 
__ex‹nsiÚ__


113 
	tušt_ç¡64_t
;

118 #ià
__WORDSIZE
 == 64

119 #iâdeà
__šŒ_t_defšed


120 
	tšŒ_t
;

121 
	#__šŒ_t_defšed


	)

123 
	tušŒ_t
;

125 #iâdeà
__šŒ_t_defšed


126 
	tšŒ_t
;

127 
	#__šŒ_t_defšed


	)

129 
	tušŒ_t
;

134 #ià
__WORDSIZE
 == 64

135 
	tštmax_t
;

136 
	tuštmax_t
;

138 
__ex‹nsiÚ__


139 
	tštmax_t
;

140 
__ex‹nsiÚ__


141 
	tuštmax_t
;

147 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_LIMIT_MACROS


149 #ià
__WORDSIZE
 == 64

150 
	#__INT64_C
(
c
èø## 
L


	)

151 
	#__UINT64_C
(
c
èø## 
UL


	)

153 
	#__INT64_C
(
c
èø## 
LL


	)

154 
	#__UINT64_C
(
c
èø## 
ULL


	)

160 
	#INT8_MIN
 (-128)

	)

161 
	#INT16_MIN
 (-32767-1)

	)

162 
	#INT32_MIN
 (-2147483647-1)

	)

163 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

165 
	#INT8_MAX
 (127)

	)

166 
	#INT16_MAX
 (32767)

	)

167 
	#INT32_MAX
 (2147483647)

	)

168 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

171 
	#UINT8_MAX
 (255)

	)

172 
	#UINT16_MAX
 (65535)

	)

173 
	#UINT32_MAX
 (4294967295U)

	)

174 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

178 
	#INT_LEAST8_MIN
 (-128)

	)

179 
	#INT_LEAST16_MIN
 (-32767-1)

	)

180 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

181 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

183 
	#INT_LEAST8_MAX
 (127)

	)

184 
	#INT_LEAST16_MAX
 (32767)

	)

185 
	#INT_LEAST32_MAX
 (2147483647)

	)

186 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

189 
	#UINT_LEAST8_MAX
 (255)

	)

190 
	#UINT_LEAST16_MAX
 (65535)

	)

191 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

192 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

196 
	#INT_FAST8_MIN
 (-128)

	)

197 #ià
__WORDSIZE
 == 64

198 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

199 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

201 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

202 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

204 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

206 
	#INT_FAST8_MAX
 (127)

	)

207 #ià
__WORDSIZE
 == 64

208 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

209 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

211 
	#INT_FAST16_MAX
 (2147483647)

	)

212 
	#INT_FAST32_MAX
 (2147483647)

	)

214 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

217 
	#UINT_FAST8_MAX
 (255)

	)

218 #ià
__WORDSIZE
 == 64

219 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

220 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

222 
	#UINT_FAST16_MAX
 (4294967295U)

	)

223 
	#UINT_FAST32_MAX
 (4294967295U)

	)

225 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

229 #ià
__WORDSIZE
 == 64

230 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

231 
	#INTPTR_MAX
 (9223372036854775807L)

	)

232 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

234 
	#INTPTR_MIN
 (-2147483647-1)

	)

235 
	#INTPTR_MAX
 (2147483647)

	)

236 
	#UINTPTR_MAX
 (4294967295U)

	)

241 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

243 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

246 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

252 #ià
__WORDSIZE
 == 64

253 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

254 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

256 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

257 
	#PTRDIFF_MAX
 (2147483647)

	)

261 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

262 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

265 #ià
__WORDSIZE
 == 64

266 
	#SIZE_MAX
 (18446744073709551615UL)

	)

268 
	#SIZE_MAX
 (4294967295U)

	)

272 #iâdeà
WCHAR_MIN


274 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

275 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

279 
	#WINT_MIN
 (0u)

	)

280 
	#WINT_MAX
 (4294967295u)

	)

287 #ià!
defšed
 
__ılu¥lus
 || defšed 
__STDC_CONSTANT_MACROS


290 
	#INT8_C
(
c
è
	)
c

291 
	#INT16_C
(
c
è
	)
c

292 
	#INT32_C
(
c
è
	)
c

293 #ià
__WORDSIZE
 == 64

294 
	#INT64_C
(
c
èø## 
L


	)

296 
	#INT64_C
(
c
èø## 
LL


	)

300 
	#UINT8_C
(
c
è
	)
c

301 
	#UINT16_C
(
c
è
	)
c

302 
	#UINT32_C
(
c
èø## 
U


	)

303 #ià
__WORDSIZE
 == 64

304 
	#UINT64_C
(
c
èø## 
UL


	)

306 
	#UINT64_C
(
c
èø## 
ULL


	)

310 #ià
__WORDSIZE
 == 64

311 
	#INTMAX_C
(
c
èø## 
L


	)

312 
	#UINTMAX_C
(
c
èø## 
UL


	)

314 
	#INTMAX_C
(
c
èø## 
LL


	)

315 
	#UINTMAX_C
(
c
èø## 
ULL


	)

	@/usr/include/sys/select.h

22 #iâdeà
_SYS_SELECT_H


23 
	#_SYS_SELECT_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	~<b™s/ty³s.h
>

31 
	~<b™s/£Ëù.h
>

34 
	~<b™s/sig£t.h
>

36 #iâdeà
__sig£t_t_defšed


37 
	#__sig£t_t_defšed


	)

38 
__sig£t_t
 
	tsig£t_t
;

42 
	#__Ãed_time_t


	)

43 
	#__Ãed_time¥ec


	)

44 
	~<time.h
>

45 
	#__Ãed_timev®


	)

46 
	~<b™s/time.h
>

48 #iâdeà
__su£cÚds_t_defšed


49 
__su£cÚds_t
 
	tsu£cÚds_t
;

50 
	#__su£cÚds_t_defšed


	)

55 
	t__fd_mask
;

58 #undeà
__NFDBITS


59 #undeà
__FDELT


60 #undeà
__FDMASK


62 
	#__NFDBITS
 (8 * (è (
__fd_mask
))

	)

63 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

64 
	#__FDMASK
(
d
è((
__fd_mask
è1 << ((dè% 
__NFDBITS
))

	)

71 #ifdeà
__USE_XOPEN


72 
__fd_mask
 
	mfds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

73 
	#__FDS_BITS
(
£t
è((£t)->
fds_b™s
)

	)

75 
__fd_mask
 
	m__fds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

76 
	#__FDS_BITS
(
£t
è((£t)->
__fds_b™s
)

	)

78 } 
	tfd_£t
;

81 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

83 #ifdeà
__USE_MISC


85 
__fd_mask
 
	tfd_mask
;

88 
	#NFDBITS
 
__NFDBITS


	)

93 
	#FD_SET
(
fd
, 
fd£
è
	`__FD_SET
 (fd, fd£)

	)

94 
	#FD_CLR
(
fd
, 
fd£
è
	`__FD_CLR
 (fd, fd£)

	)

95 
	#FD_ISSET
(
fd
, 
fd£
è
	`__FD_ISSET
 (fd, fd£)

	)

96 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
 (fd£)

	)

99 
__BEGIN_DECLS


109 
£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

110 
fd_£t
 *
__»¡riù
 
__wr™efds
,

111 
fd_£t
 *
__»¡riù
 
__exû±fds
,

112 
timev®
 *
__»¡riù
 
__timeout
);

114 #ifdeà
__USE_XOPEN2K


121 
p£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

122 
fd_£t
 *
__»¡riù
 
__wr™efds
,

123 
fd_£t
 *
__»¡riù
 
__exû±fds
,

124 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
,

125 cÚ¡ 
__sig£t_t
 *
__»¡riù
 
__sigmask
);

128 
	g__END_DECLS


	@/usr/include/sys/sysmacros.h

21 #iâdeà
_SYS_SYSMACROS_H


22 
	#_SYS_SYSMACROS_H
 1

	)

24 
	~<ã©u»s.h
>

29 #ifdeà
__GLIBC_HAVE_LONG_LONG


30 
__ex‹nsiÚ__


31 
	$gnu_dev_majÜ
 (
__dev
)

32 
__THROW
;

33 
__ex‹nsiÚ__


34 
	$gnu_dev_mšÜ
 (
__dev
)

35 
__THROW
;

36 
__ex‹nsiÚ__


37 
	$gnu_dev_makedev
 (
__majÜ
,

38 
__mšÜ
)

39 
__THROW
;

41 #ià
defšed
 
__GNUC__
 && __GNUC__ >ğ2 && defšed 
__USE_EXTERN_INLINES


42 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

43 
	`__NTH
 (
	$gnu_dev_majÜ
 (
__dev
))

45  ((
__dev
 >> 8) & 0xfff) | (() (__dev >> 32) & ~0xfff);

46 
	}
}

48 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

49 
__NTH
 (
	$gnu_dev_mšÜ
 (
__dev
))

51  (
__dev
 & 0xff) | (() (__dev >> 12) & ~0xff);

52 
	}
}

54 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

55 
__NTH
 (
	$gnu_dev_makedev
 (
__majÜ
, 
__mšÜ
))

57  ((
__mšÜ
 & 0xffè| ((
__majÜ
 & 0xfff) << 8)

58 | (((è(
__mšÜ
 & ~0xff)) << 12)

59 | (((è(
__majÜ
 & ~0xfff)) << 32));

60 
	}
}

65 
	#majÜ
(
dev
è
	`gnu_dev_majÜ
 (dev)

	)

66 
	#mšÜ
(
dev
è
	`gnu_dev_mšÜ
 (dev)

	)

67 
	#makedev
(
maj
, 
mš
è
	`gnu_dev_makedev
 (maj, mš)

	)

	@/usr/include/time.h

23 #iâdef 
_TIME_H


25 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

26 ! 
defšed
 
	g__Ãed_time¥ec
)

27 
	#_TIME_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 #ifdef 
_TIME_H


36 
	#__Ãed_size_t


	)

37 
	#__Ãed_NULL


	)

38 
	~<¡ddef.h
>

42 
	~<b™s/time.h
>

45 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


46 #iâdeà
CLK_TCK


47 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

53 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

54 
	#__şock_t_defšed
 1

	)

56 
	~<b™s/ty³s.h
>

58 
__BEGIN_NAMESPACE_STD


60 
__şock_t
 
	tşock_t
;

61 
	g__END_NAMESPACE_STD


62 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


63 
	$__USING_NAMESPACE_STD
(
şock_t
)

67 #undeà
__Ãed_şock_t


69 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

70 
	#__time_t_defšed
 1

	)

72 
	~<b™s/ty³s.h
>

74 
__BEGIN_NAMESPACE_STD


76 
__time_t
 
	ttime_t
;

77 
__END_NAMESPACE_STD


78 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


79 
	$__USING_NAMESPACE_STD
(
time_t
)

83 #undeà
__Ãed_time_t


85 #ià!
defšed
 
__şockid_t_defšed
 && \

86 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

87 
	#__şockid_t_defšed
 1

	)

89 
	~<b™s/ty³s.h
>

92 
__şockid_t
 
	tşockid_t
;

95 #undeà
__şockid_time_t


97 #ià!
defšed
 
__tim”_t_defšed
 && \

98 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

99 
	#__tim”_t_defšed
 1

	)

101 
	~<b™s/ty³s.h
>

104 
__tim”_t
 
	ttim”_t
;

107 #undeà
__Ãed_tim”_t


110 #ià!
defšed
 
__time¥ec_defšed
 && \

111 ((
defšed
 
_TIME_H
 && \

112 (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
)) || \

113 
defšed
 
__Ãed_time¥ec
)

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 
__cÚ¡
 *
tm_zÚe
;

149 
__tm_gmtoff
;

150 
__cÚ¡
 *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 
__BEGIN_NAMESPACE_STD


183 
şock_t
 
	$şock
 (è
__THROW
;

186 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

189 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

190 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

193 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

199 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

200 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

201 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

202 
__END_NAMESPACE_STD


204 #ifdeà
__USE_XOPEN


207 *
	$¡½time
 (
__cÚ¡
 *
__»¡riù
 
__s
,

208 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
)

209 
__THROW
;

212 #ifdeà
__USE_XOPEN2K8


215 
	~<xloÿË.h
>

217 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

218 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

219 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

220 
__loÿË_t
 
__loc
è
__THROW
;

223 #ifdeà
__USE_GNU


224 *
	$¡½time_l
 (
__cÚ¡
 *
__»¡riù
 
__s
,

225 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

230 
__BEGIN_NAMESPACE_STD


233 
tm
 *
	$gmtime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

237 
tm
 *
	$loÿÉime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

238 
__END_NAMESPACE_STD


240 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


243 
tm
 *
	$gmtime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

244 
tm
 *
__»¡riù
 
__
è
__THROW
;

248 
tm
 *
	$loÿÉime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

249 
tm
 *
__»¡riù
 
__
è
__THROW
;

252 
__BEGIN_NAMESPACE_STD


255 *
	$asùime
 (
__cÚ¡
 
tm
 *
__
è
__THROW
;

258 *
	$ùime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

259 
__END_NAMESPACE_STD


261 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


266 *
	$asùime_r
 (
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

267 *
__»¡riù
 
__buf
è
__THROW
;

270 *
	$ùime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

271 *
__»¡riù
 
__buf
è
__THROW
;

276 *
__tzÇme
[2];

277 
__daylight
;

278 
__timezÚe
;

281 #ifdef 
__USE_POSIX


283 *
tzÇme
[2];

287 
	$tz£t
 (è
__THROW
;

290 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


291 
daylight
;

292 
timezÚe
;

295 #ifdeà
__USE_SVID


298 
	$¡ime
 (
__cÚ¡
 
time_t
 *
__wh’
è
__THROW
;

304 
	#__i¦—p
(
y—r
) \

305 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

308 #ifdeà
__USE_MISC


313 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

316 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

319 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

323 #ifdeà
__USE_POSIX199309


328 
	`Çno¦“p
 (
__cÚ¡
 
time¥ec
 *
__»que¡ed_time
,

329 
time¥ec
 *
__»maššg
);

333 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

336 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

339 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, 
__cÚ¡
 
time¥ec
 *
__
)

340 
__THROW
;

342 #ifdeà
__USE_XOPEN2K


347 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

348 
__cÚ¡
 
time¥ec
 *
__»q
,

349 
time¥ec
 *
__»m
);

352 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

357 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

358 
sigev’t
 *
__»¡riù
 
__evp
,

359 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

362 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

365 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

366 
__cÚ¡
 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

367 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

370 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

371 
__THROW
;

374 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

378 #ifdeà
__USE_XOPEN_EXTENDED


390 
g‘d©e_”r
;

399 
tm
 *
	`g‘d©e
 (
__cÚ¡
 *
__¡ršg
);

402 #ifdeà
__USE_GNU


413 
	`g‘d©e_r
 (
__cÚ¡
 *
__»¡riù
 
__¡ršg
,

414 
tm
 *
__»¡riù
 
__»sbuå
);

417 
__END_DECLS


	@/usr/include/xlocale.h

21 #iâdeà
_XLOCALE_H


22 
	#_XLOCALE_H
 1

	)

28 
	s__loÿË_¡ruù


31 
__loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

40 } *
	t__loÿË_t
;

43 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

16 
	#__Ãed_mb¡©e_t


	)

17 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


18 
	#__Ãed_wšt_t


	)

20 
	~<wch¬.h
>

21 
	#_G_size_t
 
size_t


	)

24 
__off_t
 
	m__pos
;

25 
__mb¡©e_t
 
	m__¡©e
;

26 } 
	t_G_åos_t
;

29 
__off64_t
 
	m__pos
;

30 
__mb¡©e_t
 
	m__¡©e
;

31 } 
	t_G_åos64_t
;

32 
	#_G_ssize_t
 
__ssize_t


	)

33 
	#_G_off_t
 
__off_t


	)

34 
	#_G_off64_t
 
__off64_t


	)

35 
	#_G_pid_t
 
__pid_t


	)

36 
	#_G_uid_t
 
__uid_t


	)

37 
	#_G_wch¬_t
 
wch¬_t


	)

38 
	#_G_wšt_t
 
wšt_t


	)

39 
	#_G_¡©64
 
¡©64


	)

40 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


41 
	~<gcÚv.h
>

44 
__gcÚv_šfo
 
	m__cd
;

47 
__gcÚv_šfo
 
	m__cd
;

48 
__gcÚv_¡•_d©a
 
	m__d©a
;

49 } 
	m__combšed
;

50 } 
	t_G_icÚv_t
;

53 
	t_G_št16_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__HI__
)));

54 
	t_G_št32_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__SI__
)));

55 
	t_G_ušt16_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__HI__
)));

56 
	t_G_ušt32_t
 
	t__©Œibu‹__
 ((
	t__mode__
 (
	t__SI__
)));

58 
	#_G_HAVE_BOOL
 1

	)

62 
	#_G_HAVE_ATEXIT
 1

	)

63 
	#_G_HAVE_SYS_CDEFS
 1

	)

64 
	#_G_HAVE_SYS_WAIT
 1

	)

65 
	#_G_NEED_STDARG_H
 1

	)

66 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

68 
	#_G_HAVE_PRINTF_FP
 1

	)

69 
	#_G_HAVE_MMAP
 1

	)

70 
	#_G_HAVE_MREMAP
 1

	)

71 
	#_G_HAVE_LONG_DOUBLE_IO
 1

	)

72 
	#_G_HAVE_IO_FILE_OPEN
 1

	)

73 
	#_G_HAVE_IO_GETLINE_INFO
 1

	)

75 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

77 
	#_G_OPEN64
 
__İ’64


	)

78 
	#_G_LSEEK64
 
__l£ek64


	)

79 
	#_G_MMAP64
 
__mm­64


	)

80 
	#_G_FSTAT64
(
fd
,
buf
è
	`__fx¡©64
 (
_STAT_VER
, fd, buf)

	)

83 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

85 
	#_G_BUFSIZ
 8192

	)

88 
	#_G_NAMES_HAVE_UNDERSCORE
 0

	)

89 
	#_G_VTABLE_LABEL_HAS_LENGTH
 1

	)

90 
	#_G_USING_THUNKS
 1

	)

91 
	#_G_VTABLE_LABEL_PREFIX
 "__vt_"

	)

92 
	#_G_VTABLE_LABEL_PREFIX_ID
 
__vt_


	)

95 #ià
defšed
 
__ılu¥lus
 || defšed 
__STDC__


96 
	#_G_ARGS
(
ARGLIST
è
	)
ARGLIST

98 
	#_G_ARGS
(
ARGLIST
è()

	)

	@/usr/include/asm-generic/int-ll64.h

8 #iâdeà
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/b™¥”lÚg.h
>

13 #iâdeà
__ASSEMBLY__


19 
__sigÃd__
 
	t__s8
;

20 
	t__u8
;

22 
__sigÃd__
 
	t__s16
;

23 
	t__u16
;

25 
__sigÃd__
 
	t__s32
;

26 
	t__u32
;

28 #ifdeà
__GNUC__


29 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

30 
__ex‹nsiÚ__
 
	t__u64
;

32 
__sigÃd__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/asm-generic/ioctls.h

1 #iâdeà
__ASM_GENERIC_IOCTLS_H


2 
	#__ASM_GENERIC_IOCTLS_H


	)

4 
	~<lšux/ioùl.h
>

19 
	#TCGETS
 0x5401

	)

20 
	#TCSETS
 0x5402

	)

21 
	#TCSETSW
 0x5403

	)

22 
	#TCSETSF
 0x5404

	)

23 
	#TCGETA
 0x5405

	)

24 
	#TCSETA
 0x5406

	)

25 
	#TCSETAW
 0x5407

	)

26 
	#TCSETAF
 0x5408

	)

27 
	#TCSBRK
 0x5409

	)

28 
	#TCXONC
 0x540A

	)

29 
	#TCFLSH
 0x540B

	)

30 
	#TIOCEXCL
 0x540C

	)

31 
	#TIOCNXCL
 0x540D

	)

32 
	#TIOCSCTTY
 0x540E

	)

33 
	#TIOCGPGRP
 0x540F

	)

34 
	#TIOCSPGRP
 0x5410

	)

35 
	#TIOCOUTQ
 0x5411

	)

36 
	#TIOCSTI
 0x5412

	)

37 
	#TIOCGWINSZ
 0x5413

	)

38 
	#TIOCSWINSZ
 0x5414

	)

39 
	#TIOCMGET
 0x5415

	)

40 
	#TIOCMBIS
 0x5416

	)

41 
	#TIOCMBIC
 0x5417

	)

42 
	#TIOCMSET
 0x5418

	)

43 
	#TIOCGSOFTCAR
 0x5419

	)

44 
	#TIOCSSOFTCAR
 0x541A

	)

45 
	#FIONREAD
 0x541B

	)

46 
	#TIOCINQ
 
FIONREAD


	)

47 
	#TIOCLINUX
 0x541C

	)

48 
	#TIOCCONS
 0x541D

	)

49 
	#TIOCGSERIAL
 0x541E

	)

50 
	#TIOCSSERIAL
 0x541F

	)

51 
	#TIOCPKT
 0x5420

	)

52 
	#FIONBIO
 0x5421

	)

53 
	#TIOCNOTTY
 0x5422

	)

54 
	#TIOCSETD
 0x5423

	)

55 
	#TIOCGETD
 0x5424

	)

56 
	#TCSBRKP
 0x5425

	)

57 
	#TIOCSBRK
 0x5427

	)

58 
	#TIOCCBRK
 0x5428

	)

59 
	#TIOCGSID
 0x5429

	)

60 
	#TCGETS2
 
	`_IOR
('T', 0x2A, 
‹rmios2
)

	)

61 
	#TCSETS2
 
	`_IOW
('T', 0x2B, 
‹rmios2
)

	)

62 
	#TCSETSW2
 
	`_IOW
('T', 0x2C, 
‹rmios2
)

	)

63 
	#TCSETSF2
 
	`_IOW
('T', 0x2D, 
‹rmios2
)

	)

64 
	#TIOCGRS485
 0x542E

	)

65 
	#TIOCSRS485
 0x542F

	)

66 
	#TIOCGPTN
 
	`_IOR
('T', 0x30, è

	)

67 
	#TIOCSPTLCK
 
	`_IOW
('T', 0x31, è

	)

68 
	#TCGETX
 0x5432

	)

69 
	#TCSETX
 0x5433

	)

70 
	#TCSETXF
 0x5434

	)

71 
	#TCSETXW
 0x5435

	)

73 
	#FIONCLEX
 0x5450

	)

74 
	#FIOCLEX
 0x5451

	)

75 
	#FIOASYNC
 0x5452

	)

76 
	#TIOCSERCONFIG
 0x5453

	)

77 
	#TIOCSERGWILD
 0x5454

	)

78 
	#TIOCSERSWILD
 0x5455

	)

79 
	#TIOCGLCKTRMIOS
 0x5456

	)

80 
	#TIOCSLCKTRMIOS
 0x5457

	)

81 
	#TIOCSERGSTRUCT
 0x5458

	)

82 
	#TIOCSERGETLSR
 0x5459

	)

83 
	#TIOCSERGETMULTI
 0x545A

	)

84 
	#TIOCSERSETMULTI
 0x545B

	)

86 
	#TIOCMIWAIT
 0x545C

	)

87 
	#TIOCGICOUNT
 0x545D

	)

93 #iâdeà
FIOQSIZE


94 
	#TIOCGHAYESESP
 0x545E

	)

95 
	#TIOCSHAYESESP
 0x545F

	)

96 
	#FIOQSIZE
 0x5460

	)

100 
	#TIOCPKT_DATA
 0

	)

101 
	#TIOCPKT_FLUSHREAD
 1

	)

102 
	#TIOCPKT_FLUSHWRITE
 2

	)

103 
	#TIOCPKT_STOP
 4

	)

104 
	#TIOCPKT_START
 8

	)

105 
	#TIOCPKT_NOSTOP
 16

	)

106 
	#TIOCPKT_DOSTOP
 32

	)

108 
	#TIOCSER_TEMT
 0x01

	)

	@/usr/include/asm/errno.h

1 
	~<asm-g’”ic/”ºo.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/bits/byteswap.h

21 #ià!
defšed
 
_BYTESWAP_H
 && !defšed 
_NETINET_IN_H
 && !defšed 
_ENDIAN_H


25 #iâdeà
_BITS_BYTESWAP_H


26 
	#_BITS_BYTESWAP_H
 1

	)

28 
	~<b™s/wÜdsize.h
>

31 
	#__bsw­_cÚ¡ªt_16
(
x
) \

32 ((((
x
è>> 8è& 0xffè| (((xè& 0xffè<< 8))

	)

34 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

35 
	#__bsw­_16
(
x
) \

36 (
__ex‹nsiÚ__
 \

37 ({ 
__v
, 
__x
 = (
x
); \

38 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

39 
__v
 = 
	`__bsw­_cÚ¡ªt_16
 (
__x
); \

41 
	`__asm__
 ("rorw $8, %w0" \

42 : "ô" (
__v
) \

43 : "0" (
__x
) \

45 
__v
; }))

	)

48 
	#__bsw­_16
(
x
) \

49 (
__ex‹nsiÚ__
 \

50 ({ 
__x
 = (
x
); 
	`__bsw­_cÚ¡ªt_16
 (__x); }))

	)

55 
	#__bsw­_cÚ¡ªt_32
(
x
) \

56 ((((
x
) & 0xff000000) >> 24) | (((x) & 0x00ff0000) >> 8) | \

57 (((
x
è& 0x0000ff00è<< 8è| (((xè& 0x000000ffè<< 24))

	)

59 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

60 #ià
__WORDSIZE
 =ğ64 || (
defšed
 
__i486__
 || defšed 
__³Áium__
 \

61 || 
defšed
 
	g__³Áium´o__
 || defšed 
	g__³Áium4__
 \

62 || 
defšed
 
	g__k8__
 || defšed 
	g__©hlÚ__
 \

63 || 
defšed
 
	g__k6__
 || defšed 
	g__nocÚa__
 \

64 || 
defšed
 
	g__cÜe2__
 || defšed 
	g__geode__
 \

65 || 
defšed
 
	g__amdçm10__
)

68 
	#__bsw­_32
(
x
) \

69 (
__ex‹nsiÚ__
 \

70 ({ 
__v
, 
__x
 = (
x
); \

71 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

72 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

74 
	`__asm__
 ("bsw­ %0" : "ô" (
__v
è: "0" (
__x
)); \

75 
__v
; }))

	)

77 
	#__bsw­_32
(
x
) \

78 (
__ex‹nsiÚ__
 \

79 ({ 
__v
, 
__x
 = (
x
); \

80 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

81 
__v
 = 
	`__bsw­_cÚ¡ªt_32
 (
__x
); \

83 
	`__asm__
 ("rorw $8, %w0;" \

86 : "ô" (
__v
) \

87 : "0" (
__x
) \

89 
__v
; }))

	)

92 
	#__bsw­_32
(
x
) \

93 (
__ex‹nsiÚ__
 \

94 ({ 
__x
 = (
x
); 
	`__bsw­_cÚ¡ªt_32
 (__x); }))

	)

98 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

100 
	#__bsw­_cÚ¡ªt_64
(
x
) \

101 ((((
x
) & 0xff00000000000000ull) >> 56) \

102 | (((
x
) & 0x00ff000000000000ull) >> 40) \

103 | (((
x
) & 0x0000ff0000000000ull) >> 24) \

104 | (((
x
) & 0x000000ff00000000ull) >> 8) \

105 | (((
x
) & 0x00000000ff000000ull) << 8) \

106 | (((
x
) & 0x0000000000ff0000ull) << 24) \

107 | (((
x
) & 0x000000000000ff00ull) << 40) \

108 | (((
x
è& 0x00000000000000ffuÎè<< 56))

	)

110 #ià
__WORDSIZE
 == 64

111 
	#__bsw­_64
(
x
) \

112 (
__ex‹nsiÚ__
 \

113 ({ 
__v
, 
__x
 = (
x
); \

114 ià(
	`__butš_cÚ¡ªt_p
 (
__x
)) \

115 
__v
 = 
	`__bsw­_cÚ¡ªt_64
 (
__x
); \

117 
	`__asm__
 ("bsw­ %q0" : "ô" (
__v
è: "0" (
__x
)); \

118 
__v
; }))

	)

120 
	#__bsw­_64
(
x
) \

121 (
__ex‹nsiÚ__
 \

122 ({ uniÚ { 
__ex‹nsiÚ__
 
__Î
; \

123 
__l
[2]; } 
__w
, 
__r
; \

124 ià(
	`__butš_cÚ¡ªt_p
 (
x
)) \

125 
__r
.
__Î
 = 
	`__bsw­_cÚ¡ªt_64
 (
x
); \

128 
__w
.
__Î
 = (
x
); \

129 
__r
.
__l
[0] = 
	`__bsw­_32
 (
__w
.__l[1]); \

130 
__r
.
__l
[1] = 
	`__bsw­_32
 (
__w
.__l[0]); \

132 
__r
.
__Î
; }))

	)

	@/usr/include/bits/endian.h

3 #iâdeà
_ENDIAN_H


7 
	#__BYTE_ORDER
 
__LITTLE_ENDIAN


	)

	@/usr/include/bits/libio-ldbl.h

20 #iâdeà
_IO_STDIO_H


24 
	$__LDBL_REDIR_DECL
 (
_IO_vfsÿnf
)

25 
	`__LDBL_REDIR_DECL
 (
_IO_vårštf
)

	@/usr/include/bits/select.h

19 #iâdeà
_SYS_SELECT_H


23 
	~<b™s/wÜdsize.h
>

26 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

28 #ià
__WORDSIZE
 == 64

29 
	#__FD_ZERO_STOS
 "¡osq"

	)

31 
	#__FD_ZERO_STOS
 "¡o¦"

	)

34 
	#__FD_ZERO
(
fd¥
) \

36 
__d0
, 
__d1
; \

37 
__asm__
 
	`__vŞ©e__
 ("şd;„•; " 
__FD_ZERO_STOS
 \

38 : "=c" (
__d0
), "=D" (
__d1
) \

39 : "a" (0), "0" ( (
fd_£t
) \

40 /  (
__fd_mask
)), \

41 "1" (&
	`__FDS_BITS
 (
fd¥
)[0]) \

43 } 0)

	)

49 
	#__FD_ZERO
(
£t
) \

51 
__i
; \

52 
fd_£t
 *
__¬r
 = (
£t
); \

53 
__i
 = 0; __˜<  (
fd_£t
è/  (
__fd_mask
); ++__i) \

54 
	`__FDS_BITS
 (
__¬r
)[
__i
] = 0; \

55 } 0)

	)

59 
	#__FD_SET
(
d
, 
£t
è(
	`__FDS_BITS
 (£t)[
	`__FDELT
 (d)] |ğ
	`__FDMASK
 (d))

	)

60 
	#__FD_CLR
(
d
, 
£t
è(
	`__FDS_BITS
 (£t)[
	`__FDELT
 (d)] &ğ~
	`__FDMASK
 (d))

	)

61 
	#__FD_ISSET
(
d
, 
£t
) \

62 ((
	`__FDS_BITS
 (
£t
)[
	`__FDELT
 (
d
)] & 
	`__FDMASK
 (d)è!ğ0)

	)

	@/usr/include/bits/sigset.h

21 #iâdef 
_SIGSET_H_ty³s


22 
	#_SIGSET_H_ty³s
 1

	)

24 
	t__sig_©omic_t
;

28 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

31 
	m__v®
[
_SIGSET_NWORDS
];

32 } 
	t__sig£t_t
;

43 #ià!
defšed
 
_SIGSET_H_âs
 && defšed 
_SIGNAL_H


44 
	#_SIGSET_H_âs
 1

	)

46 #iâdeà
_EXTERN_INLINE


47 
	#_EXTERN_INLINE
 
__ex‹º_šlše


	)

51 
	#__sigmask
(
sig
) \

52 (((è1è<< (((
sig
è- 1è% (8 *  ())))

	)

55 
	#__sigwÜd
(
sig
è(((sigè- 1è/ (8 *  ()))

	)

57 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

58 
	#__sigem±y£t
(
£t
) \

59 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

60 
sig£t_t
 *
__£t
 = (
£t
); \

61 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = 0; \

62 0; }))

	)

63 
	#__sigfl£t
(
£t
) \

64 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

65 
sig£t_t
 *
__£t
 = (
£t
); \

66 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = ~0UL; \

67 0; }))

	)

69 #ifdeà
__USE_GNU


73 
	#__sigi£m±y£t
(
£t
) \

74 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

75 cÚ¡ 
sig£t_t
 *
__£t
 = (
£t
); \

76 
__»t
 = 
__£t
->
__v®
[--
__út
]; \

77 !
__»t
 && --
__út
 >= 0) \

78 
__»t
 = 
__£t
->
__v®
[
__út
]; \

79 
__»t
 =ğ0; }))

	)

80 
	#__sigªd£t
(
de¡
, 
Ëá
, 
right
) \

81 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

82 
sig£t_t
 *
__de¡
 = (
de¡
); \

83 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

84 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

85 --
__út
 >= 0) \

86 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

87 & 
__right
->
__v®
[
__út
]); \

88 0; }))

	)

89 
	#__sigÜ£t
(
de¡
, 
Ëá
, 
right
) \

90 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

91 
sig£t_t
 *
__de¡
 = (
de¡
); \

92 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

93 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

94 --
__út
 >= 0) \

95 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

96 | 
__right
->
__v®
[
__út
]); \

97 0; }))

	)

104 
__sigismemb”
 (
__cÚ¡
 
__sig£t_t
 *, );

105 
__sigadd£t
 (
__sig£t_t
 *, );

106 
__sigd–£t
 (
__sig£t_t
 *, );

108 #ifdeà
__USE_EXTERN_INLINES


109 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

110 
_EXTERN_INLINE
 \

111 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

113 
__mask
 = 
	`__sigmask
 (
__sig
); \

114 
__wÜd
 = 
	`__sigwÜd
 (
__sig
); \

115  
BODY
; \

116 }

	)

118 
__SIGSETFN
 (
__sigismemb”
, (
__£t
->
__v®
[
__wÜd
] & 
__mask
è? 1 : 0, 
__cÚ¡
)

119 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__v®
[
__wÜd
] |ğ
__mask
), 0), )

120 
__SIGSETFN
 (
__sigd–£t
, ((
__£t
->
__v®
[
__wÜd
] &ğ~
__mask
), 0), )

122 #undeà
__SIGSETFN


	@/usr/include/bits/stdio-lock.h

20 #iâdeà
_BITS_STDIO_LOCK_H


21 
	#_BITS_STDIO_LOCK_H
 1

	)

23 
	~<b™s/libc-lock.h
>

25 
	$__libc_lock_defše_»cursive
 (, 
_IO_lock_t
)

28 #ifdeà
	t_LIBC_LOCK_RECURSIVE_INITIALIZER


29 
	t_IO_lock_š™Ÿliz”
 
	t_LIBC_LOCK_RECURSIVE_INITIALIZER


	)

30 #–ià
	t_IO_MTSAFE_IO


31 #”rÜ 
	tlibio
 
	tÃeds
 
	t»cursive
 
	tmu‹xes
 
	t_IO_MTSAFE_IO


34 
	t_IO_lock_š™
(
	t_Çme
è
	t__libc_lock_š™_»cursive
 (_Çme)

	)

35 
	t_IO_lock_fši
(
	t_Çme
è
	t__libc_lock_fši_»cursive
 (_Çme)

	)

36 
	t_IO_lock_lock
(
	t_Çme
è
	t__libc_lock_lock_»cursive
 (_Çme)

	)

37 
	t_IO_lock_Œylock
(
	t_Çme
è
	t__libc_lock_Œylock_»cursive
 (_Çme)

	)

38 
	t_IO_lock_uÆock
(
	t_Çme
è
	t__libc_lock_uÆock_»cursive
 (_Çme)

	)

41 
	t_IO_ş—nup_»giÚ_¡¬t
(
	t_fù
, 
	t_å
) \

42 
	t__libc_ş—nup_»giÚ_¡¬t
 (((
	t_å
)->
	t_æags
 & 
	t_IO_USER_LOCK
è=ğ0, 
	t_fù
, _å)

	)

43 
	t_IO_ş—nup_»giÚ_¡¬t_nßrg
(
	t_fù
) \

44 
	t__libc_ş—nup_»giÚ_¡¬t
 (1, 
	t_fù
, 
	tNULL
)

	)

45 
	t_IO_ş—nup_»giÚ_’d
(
	t_do™
) \

46 
	t__libc_ş—nup_»giÚ_’d
 (
	t_do™
)

	)

48 #ià
	tdefšed
 
	t_LIBC
 && !defšed 
	tNOT_IN_libc


49 
	t_IO_acquœe_lock
(
	t_å
) \

50 
	t_IO_ş—nup_»giÚ_¡¬t
 (((*è(*)è
	t_IO_fuÆockfe
, (
	t_å
)); \

51 
	`_IO_æockfe
 (
_å
)

	)

53 
	#_IO_»Ëa£_lock
(
_å
) \

54 
	`_IO_fuÆockfe
 (
_å
); \

55 
	`_IO_ş—nup_»giÚ_’d
 (0)

	)

	@/usr/include/bits/time.h

24 #iâdeà
__Ãed_timev®


25 #iâdeà
_BITS_TIME_H


26 
	#_BITS_TIME_H
 1

	)

34 
	#CLOCKS_PER_SEC
 1000000l

	)

36 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


39 
	~<b™s/ty³s.h
>

40 
__syscÚf
 ();

41 
	#CLK_TCK
 ((
__şock_t
è
	`__syscÚf
 (2)è

	)

44 #ifdeà
__USE_POSIX199309


46 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

52 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

54 
	#CLOCK_MONOTONIC_RAW
 4

	)

56 
	#CLOCK_REALTIME_COARSE
 5

	)

58 
	#CLOCK_MONOTONIC_COARSE
 6

	)

61 
	#TIMER_ABSTIME
 1

	)

67 #ifdeà
__Ãed_timev®


68 #undeà
__Ãed_timev®


69 #iâdeà
_STRUCT_TIMEVAL


70 
	#_STRUCT_TIMEVAL
 1

	)

71 
	~<b™s/ty³s.h
>

75 
	stimev®


77 
__time_t
 
	mtv_£c
;

78 
__su£cÚds_t
 
	mtv_u£c
;

	@/usr/include/bits/typesizes.h

20 #iâdeà
_BITS_TYPES_H


24 #iâdef 
_BITS_TYPESIZES_H


25 
	#_BITS_TYPESIZES_H
 1

	)

30 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

31 
	#__UID_T_TYPE
 
__U32_TYPE


	)

32 
	#__GID_T_TYPE
 
__U32_TYPE


	)

33 
	#__INO_T_TYPE
 
__ULONGWORD_TYPE


	)

34 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

35 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

36 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

37 
	#__OFF_T_TYPE
 
__SLONGWORD_TYPE


	)

38 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

39 
	#__PID_T_TYPE
 
__S32_TYPE


	)

40 
	#__RLIM_T_TYPE
 
__ULONGWORD_TYPE


	)

41 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

42 
	#__BLKCNT_T_TYPE
 
__SLONGWORD_TYPE


	)

43 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

44 
	#__FSBLKCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

45 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

46 
	#__FSFILCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

47 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

48 
	#__ID_T_TYPE
 
__U32_TYPE


	)

49 
	#__CLOCK_T_TYPE
 
__SLONGWORD_TYPE


	)

50 
	#__TIME_T_TYPE
 
__SLONGWORD_TYPE


	)

51 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

52 
	#__SUSECONDS_T_TYPE
 
__SLONGWORD_TYPE


	)

53 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

54 
	#__SWBLK_T_TYPE
 
__SLONGWORD_TYPE


	)

55 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

56 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

57 
	#__TIMER_T_TYPE
 *

	)

58 
	#__BLKSIZE_T_TYPE
 
__SLONGWORD_TYPE


	)

59 
	#__FSID_T_TYPE
 sŒuù { 
__v®
[2]; }

	)

60 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

63 
	#__FD_SETSIZE
 65535

	)

	@/usr/include/bits/uio.h

19 #ià!
defšed
 
_SYS_UIO_H
 && !defšed 
_FCNTL_H


23 #iâdeà
_BITS_UIO_H


24 
	#_BITS_UIO_H
 1

	)

26 
	~<sys/ty³s.h
>

40 
	#UIO_MAXIOV
 1024

	)

44 
	siovec


46 *
	miov_ba£
;

47 
size_t
 
	miov_Ën
;

	@/usr/include/bits/wchar.h

20 #iâdeà
_BITS_WCHAR_H


21 
	#_BITS_WCHAR_H
 1

	)

23 
	#__WCHAR_MIN
 (-2147483647 - 1)

	)

24 
	#__WCHAR_MAX
 (2147483647)

	)

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__


4 
	#__WORDSIZE
 64

	)

5 
	#__WORDSIZE_COMPAT32
 1

	)

7 
	#__WORDSIZE
 32

	)

	@/usr/include/ctype.h

24 #iâdef 
_CTYPE_H


25 
	#_CTYPE_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/ty³s.h
>

30 
	g__BEGIN_DECLS


32 #iâdeà
_ISb™


41 
	~<’dŸn.h
>

42 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


43 
	#_ISb™
(
b™
è(1 << (b™))

	)

45 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

50 
	m_ISuµ”
 = 
_ISb™
 (0),

51 
	m_ISlow”
 = 
_ISb™
 (1),

52 
	m_IS®pha
 = 
_ISb™
 (2),

53 
	m_ISdig™
 = 
_ISb™
 (3),

54 
	m_ISxdig™
 = 
_ISb™
 (4),

55 
	m_IS¥aû
 = 
_ISb™
 (5),

56 
	m_IS´št
 = 
_ISb™
 (6),

57 
	m_ISg¿ph
 = 
_ISb™
 (7),

58 
	m_ISbÏnk
 = 
_ISb™
 (8),

59 
	m_ISúŒl
 = 
_ISb™
 (9),

60 
	m_ISpunù
 = 
_ISb™
 (10),

61 
	m_IS®num
 = 
_ISb™
 (11)

81 
__cÚ¡
 **
	$__ùy³_b_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

83 
__cÚ¡
 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

85 
__cÚ¡
 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

86 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡
));

88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

91 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

92 
	#__tßscii
(
c
è((cè& 0x7fè

	)

94 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

96 
__BEGIN_NAMESPACE_STD


102 
	`__exùy³
 (
i§Êum
);

103 
	`__exùy³
 (
i§Íha
);

104 
	`__exùy³
 (
isúŒl
);

105 
	`__exùy³
 (
isdig™
);

106 
	`__exùy³
 (
i¦ow”
);

107 
	`__exùy³
 (
isg¿ph
);

108 
	`__exùy³
 (
i¥ršt
);

109 
	`__exùy³
 (
i¥unù
);

110 
	`__exùy³
 (
is¥aû
);

111 
	`__exùy³
 (
isuµ”
);

112 
	`__exùy³
 (
isxdig™
);

116 
	$tŞow”
 (
__c
è
__THROW
;

119 
	$touµ”
 (
__c
è
__THROW
;

121 
__END_NAMESPACE_STD


125 #ifdef 
__USE_ISOC99


126 
__BEGIN_NAMESPACE_C99


128 
	`__exùy³
 (
isbÏnk
);

130 
__END_NAMESPACE_C99


133 #ifdeà
__USE_GNU


135 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

138 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


142 
	$i§scii
 (
__c
è
__THROW
;

146 
	$tßscii
 (
__c
è
__THROW
;

150 
	`__exùy³
 (
_touµ”
);

151 
	`__exùy³
 (
_tŞow”
);

155 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

156 (
__ex‹nsiÚ__
 \

157 ({ 
__»s
; \

158 ià( (
c
) > 1) \

160 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

162 
__c
 = (
c
); \

163 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

166 
__»s
 = 
f
 
¬gs
; \

169 
__»s
 = (
a
)[(è(
c
)]; \

170 
__»s
; 
	}
}))

	)

172 #ià!
defšed
 
__NO_CTYPE
 && !defšed 
__ılu¥lus


173 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

174 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

175 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

176 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

177 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

178 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

179 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

180 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

181 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

182 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

183 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

185 #ifdeà
__USE_ISOC99


186 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

189 #ifdeà
__USE_EXTERN_INLINES


190 
__ex‹º_šlše
 

191 
__NTH
 (
	$tŞow”
 (
__c
))

193  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

194 
	}
}

196 
__ex‹º_šlše
 

197 
__NTH
 (
	$touµ”
 (
__c
))

199  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

200 
	}
}

203 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


204 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

205 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

208 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC
 || defšed 
__USE_XOPEN


209 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

210 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

212 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

213 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

219 #ifdeà
__USE_XOPEN2K8


233 
	~<xloÿË.h
>

237 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

238 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

240 
	#__exùy³_l
(
Çme
) \

241 
	`Çme
 (, 
__loÿË_t
è
__THROW


	)

247 
__exùy³_l
 (
i§Êum_l
);

248 
__exùy³_l
 (
i§Íha_l
);

249 
__exùy³_l
 (
isúŒl_l
);

250 
__exùy³_l
 (
isdig™_l
);

251 
__exùy³_l
 (
i¦ow”_l
);

252 
__exùy³_l
 (
isg¿ph_l
);

253 
__exùy³_l
 (
i¥ršt_l
);

254 
__exùy³_l
 (
i¥unù_l
);

255 
__exùy³_l
 (
is¥aû_l
);

256 
__exùy³_l
 (
isuµ”_l
);

257 
__exùy³_l
 (
isxdig™_l
);

259 
__exùy³_l
 (
isbÏnk_l
);

263 
	$__tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

264 
	$tŞow”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

267 
	$__touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

268 
	$touµ”_l
 (
__c
, 
__loÿË_t
 
__l
è
__THROW
;

270 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


271 
	#__tŞow”_l
(
c
, 
loÿË
) \

272 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

273 
	#__touµ”_l
(
c
, 
loÿË
) \

274 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

275 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

276 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

280 #iâdeà
__NO_CTYPE


281 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

282 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

283 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

284 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

285 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

286 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

287 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

288 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

289 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

290 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

291 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

293 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

295 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


296 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

297 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

300 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

301 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

302 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

303 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

304 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

305 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

306 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

307 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

308 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

309 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

310 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

312 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

314 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_MISC


315 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

316 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

323 
__END_DECLS


	@/usr/include/gnu/stubs.h

4 
	~<b™s/wÜdsize.h
>

6 #ià
__WORDSIZE
 == 32

7 
	~<gnu/¡ubs-32.h
>

8 #–ià
__WORDSIZE
 == 64

9 
	~<gnu/¡ubs-64.h
>

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__NFDBITS


22 
	#__NFDBITS
 (8 * ())

	)

24 #undeà
__FD_SETSIZE


25 
	#__FD_SETSIZE
 1024

	)

27 #undeà
__FDSET_LONGS


28 
	#__FDSET_LONGS
 (
__FD_SETSIZE
/
__NFDBITS
)

	)

30 #undeà
__FDELT


31 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

33 #undeà
__FDMASK


34 
	#__FDMASK
(
d
è(1UL << ((dè% 
__NFDBITS
))

	)

37 
	mfds_b™s
 [
__FDSET_LONGS
];

38 } 
	t__k”Ãl_fd_£t
;

41 (*
	t__k”Ãl_sighªdËr_t
)();

44 
	t__k”Ãl_key_t
;

45 
	t__k”Ãl_mqd_t
;

47 
	~<asm/posix_ty³s.h
>

	@/usr/include/sys/cdefs.h

20 #iâdef 
_SYS_CDEFS_H


21 
	#_SYS_CDEFS_H
 1

	)

24 #iâdeà
_FEATURES_H


25 
	~<ã©u»s.h
>

31 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


36 #undeà
__P


37 #undeà
__PMT


39 #ifdeà
__GNUC__


46 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

47 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

48 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fct

50 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

51 
	#__THROW
 
	`throw
 ()

	)

52 
	#__NTH
(
fù
èfù 
	`throw
 ()

	)

54 
	#__THROW


	)

55 
	#__NTH
(
fù
è
	)
fct

61 
	#__šlše


	)

63 
	#__THROW


	)

64 
	#__NTH
(
fù
è
	)
fct

66 
	#__cÚ¡
 cÚ¡

	)

67 
	#__sigÃd
 sigÃd

	)

68 
	#__vŞ©e
 vŞ©e

	)

74 
	#__P
(
¬gs
è
	)
args

75 
	#__PMT
(
¬gs
è
	)
args

80 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

81 
	#__STRING
(
x
è#x

	)

84 
	#__±r_t
 *

	)

85 
	#__lÚg_doubË_t
 

	)

89 #ifdef 
__ılu¥lus


90 
	#__BEGIN_DECLS
 "C" {

	)

91 
	#__END_DECLS
 }

	)

93 
	#__BEGIN_DECLS


	)

94 
	#__END_DECLS


	)

103 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES


104 
	#__BEGIN_NAMESPACE_STD
 
Çme¥aû
 
¡d
 {

	)

105 
	#__END_NAMESPACE_STD
 }

	)

106 
	#__USING_NAMESPACE_STD
(
Çme
è
usšg
 
¡d
::Çme;

	)

107 
	#__BEGIN_NAMESPACE_C99
 
Çme¥aû
 
__c99
 {

	)

108 
	#__END_NAMESPACE_C99
 }

	)

109 
	#__USING_NAMESPACE_C99
(
Çme
è
usšg
 
__c99
::Çme;

	)

114 
	#__BEGIN_NAMESPACE_STD


	)

115 
	#__END_NAMESPACE_STD


	)

116 
	#__USING_NAMESPACE_STD
(
Çme
)

	)

117 
	#__BEGIN_NAMESPACE_C99


	)

118 
	#__END_NAMESPACE_C99


	)

119 
	#__USING_NAMESPACE_C99
(
Çme
)

	)

124 #iâdeà
__BOUNDED_POINTERS__


125 
	#__bounded


	)

126 
	#__unbounded


	)

127 
	#__±rv®ue


	)

132 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

133 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

135 #ià
__GNUC_PREREQ
 (4,3) \

136 || (
defšed
 
	g__GNUC_RH_RELEASE__
 && 
	g__GNUC__
 == 4 \

137 && 
__GNUC_MINOR__
 =ğ1 && 
__GNUC_PATCHLEVEL__
 == 2 \

138 && 
__GNUC_RH_RELEASE__
 >= 31)

139 
	#__w¬ndeş
(
Çme
, 
msg
) \

140 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

141 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

142 
	#__”rÜdeş
(
Çme
, 
msg
) \

143 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

145 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

146 
	#__w¬Ç‰r
(
msg
)

	)

147 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

151 #ià
__GNUC_PREREQ
 (2,97)

153 
	#__æex¬r
 []

	)

155 #ifdeà
__GNUC__


156 
	#__æex¬r
 [0]

	)

158 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

159 
	#__æex¬r
 []

	)

162 
	#__æex¬r
 [1]

	)

178 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

180 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

181 #ifdeà
__ılu¥lus


182 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

183 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

185 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

186 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

188 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

189 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
cname

202 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

203 
	#__©Œibu‹__
(
xyz
è

	)

209 #ià
__GNUC_PREREQ
 (2,96)

210 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

212 
	#__©Œibu‹_m®loc__


	)

218 #ià
__GNUC_PREREQ
 (2,96)

219 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

221 
	#__©Œibu‹_pu»__


	)

227 #ià
__GNUC_PREREQ
 (3,1)

228 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

229 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

231 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

232 
	#__©Œibu‹_nošlše__


	)

236 #ià
__GNUC_PREREQ
 (3,2)

237 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

239 
	#__©Œibu‹_d•»ÿ‹d__


	)

248 #ià
__GNUC_PREREQ
 (2,8)

249 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

251 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

258 #ià
__GNUC_PREREQ
 (2,97)

259 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

260 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

262 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

267 #ià
__GNUC_PREREQ
 (3,3)

268 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

270 
	#__nÚnuÎ
(
·¿ms
)

	)

275 #ià
__GNUC_PREREQ
 (3,4)

276 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

277 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

278 #ià
__USE_FORTIFY_LEVEL
 > 0

279 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

282 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

284 #iâdeà
__wur


285 
	#__wur


	)

289 #ià
__GNUC_PREREQ
 (3,2)

290 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

292 
	#__®ways_šlše
 
__šlše


	)

297 #ià!
defšed
 
__ılu¥lus
 || 
__GNUC_PREREQ
 (4,3) \

298 || (
defšed
 
__GNUC_RH_RELEASE__
 && 
__GNUC__
 == 4 \

299 && 
__GNUC_MINOR__
 =ğ1 && 
__GNUC_PATCHLEVEL__
 == 2 \

300 && 
__GNUC_RH_RELEASE__
 >= 31)

301 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


302 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

303 #ià
__GNUC_PREREQ
 (4,3) \

304 || (
defšed
 
__GNUC_RH_RELEASE__
 && 
__GNUC__
 == 4 \

305 && 
__GNUC_MINOR__
 =ğ1 && 
__GNUC_PATCHLEVEL__
 == 2 \

306 && 
__GNUC_RH_RELEASE__
 >= 31)

307 
	#__ex‹º_®ways_šlše
 \

308 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
, 
__¬tificŸl__
))

	)

310 
	#__ex‹º_®ways_šlše
 \

311 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

314 
	#__ex‹º_šlše
 
__šlše


	)

315 #ià
__GNUC_PREREQ
 (4,3)

316 
	#__ex‹º_®ways_šlše
 \

317 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

319 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

326 #ià
__GNUC_PREREQ
 (4,3) \

327 || (
defšed
 
__GNUC_RH_RELEASE__
 && 
__GNUC__
 == 4 \

328 && 
__GNUC_MINOR__
 =ğ1 && 
__GNUC_PATCHLEVEL__
 == 2 \

329 && 
__GNUC_RH_RELEASE__
 >= 31)

330 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

331 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

338 #ià!
__GNUC_PREREQ
 (2,8)

339 
	#__ex‹nsiÚ__


	)

343 #ià!
__GNUC_PREREQ
 (2,92)

344 
	#__»¡riù


	)

350 #ià
__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


351 
	#__»¡riù_¬r
 
__»¡riù


	)

353 #ifdeà
__GNUC__


354 
	#__»¡riù_¬r


	)

356 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

357 
	#__»¡riù_¬r
 
»¡riù


	)

360 
	#__»¡riù_¬r


	)

365 
	~<b™s/wÜdsize.h
>

367 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


368 
	#__LDBL_COMPAT
 1

	)

369 #ifdeà
__REDIRECT


370 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

371 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

372 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

373 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

374 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

375 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

376 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

377 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

378 
	#__LDBL_REDIR_DECL
(
Çme
) \

379 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

380 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

381 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

382 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

383 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

386 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


387 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
proto

388 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
proto

389 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

390 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

391 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

392 #ifdeà
__REDIRECT


393 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

394 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

395 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

	@/usr/include/asm-generic/errno.h

1 #iâdeà
_ASM_GENERIC_ERRNO_H


2 
	#_ASM_GENERIC_ERRNO_H


	)

4 
	~<asm-g’”ic/”ºo-ba£.h
>

6 
	#EDEADLK
 35

	)

7 
	#ENAMETOOLONG
 36

	)

8 
	#ENOLCK
 37

	)

9 
	#ENOSYS
 38

	)

10 
	#ENOTEMPTY
 39

	)

11 
	#ELOOP
 40

	)

12 
	#EWOULDBLOCK
 
EAGAIN


	)

13 
	#ENOMSG
 42

	)

14 
	#EIDRM
 43

	)

15 
	#ECHRNG
 44

	)

16 
	#EL2NSYNC
 45

	)

17 
	#EL3HLT
 46

	)

18 
	#EL3RST
 47

	)

19 
	#ELNRNG
 48

	)

20 
	#EUNATCH
 49

	)

21 
	#ENOCSI
 50

	)

22 
	#EL2HLT
 51

	)

23 
	#EBADE
 52

	)

24 
	#EBADR
 53

	)

25 
	#EXFULL
 54

	)

26 
	#ENOANO
 55

	)

27 
	#EBADRQC
 56

	)

28 
	#EBADSLT
 57

	)

30 
	#EDEADLOCK
 
EDEADLK


	)

32 
	#EBFONT
 59

	)

33 
	#ENOSTR
 60

	)

34 
	#ENODATA
 61

	)

35 
	#ETIME
 62

	)

36 
	#ENOSR
 63

	)

37 
	#ENONET
 64

	)

38 
	#ENOPKG
 65

	)

39 
	#EREMOTE
 66

	)

40 
	#ENOLINK
 67

	)

41 
	#EADV
 68

	)

42 
	#ESRMNT
 69

	)

43 
	#ECOMM
 70

	)

44 
	#EPROTO
 71

	)

45 
	#EMULTIHOP
 72

	)

46 
	#EDOTDOT
 73

	)

47 
	#EBADMSG
 74

	)

48 
	#EOVERFLOW
 75

	)

49 
	#ENOTUNIQ
 76

	)

50 
	#EBADFD
 77

	)

51 
	#EREMCHG
 78

	)

52 
	#ELIBACC
 79

	)

53 
	#ELIBBAD
 80

	)

54 
	#ELIBSCN
 81

	)

55 
	#ELIBMAX
 82

	)

56 
	#ELIBEXEC
 83

	)

57 
	#EILSEQ
 84

	)

58 
	#ERESTART
 85

	)

59 
	#ESTRPIPE
 86

	)

60 
	#EUSERS
 87

	)

61 
	#ENOTSOCK
 88

	)

62 
	#EDESTADDRREQ
 89

	)

63 
	#EMSGSIZE
 90

	)

64 
	#EPROTOTYPE
 91

	)

65 
	#ENOPROTOOPT
 92

	)

66 
	#EPROTONOSUPPORT
 93

	)

67 
	#ESOCKTNOSUPPORT
 94

	)

68 
	#EOPNOTSUPP
 95

	)

69 
	#EPFNOSUPPORT
 96

	)

70 
	#EAFNOSUPPORT
 97

	)

71 
	#EADDRINUSE
 98

	)

72 
	#EADDRNOTAVAIL
 99

	)

73 
	#ENETDOWN
 100

	)

74 
	#ENETUNREACH
 101

	)

75 
	#ENETRESET
 102

	)

76 
	#ECONNABORTED
 103

	)

77 
	#ECONNRESET
 104

	)

78 
	#ENOBUFS
 105

	)

79 
	#EISCONN
 106

	)

80 
	#ENOTCONN
 107

	)

81 
	#ESHUTDOWN
 108

	)

82 
	#ETOOMANYREFS
 109

	)

83 
	#ETIMEDOUT
 110

	)

84 
	#ECONNREFUSED
 111

	)

85 
	#EHOSTDOWN
 112

	)

86 
	#EHOSTUNREACH
 113

	)

87 
	#EALREADY
 114

	)

88 
	#EINPROGRESS
 115

	)

89 
	#ESTALE
 116

	)

90 
	#EUCLEAN
 117

	)

91 
	#ENOTNAM
 118

	)

92 
	#ENAVAIL
 119

	)

93 
	#EISNAM
 120

	)

94 
	#EREMOTEIO
 121

	)

95 
	#EDQUOT
 122

	)

97 
	#ENOMEDIUM
 123

	)

98 
	#EMEDIUMTYPE
 124

	)

99 
	#ECANCELED
 125

	)

100 
	#ENOKEY
 126

	)

101 
	#EKEYEXPIRED
 127

	)

102 
	#EKEYREVOKED
 128

	)

103 
	#EKEYREJECTED
 129

	)

106 
	#EOWNERDEAD
 130

	)

107 
	#ENOTRECOVERABLE
 131

	)

109 
	#ERFKILL
 132

	)

111 
	#EHWPOISON
 133

	)

	@/usr/include/asm-generic/ioctl.h

1 #iâdeà
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

30 #iâdeà
_IOC_SIZEBITS


31 
	#_IOC_SIZEBITS
 14

	)

34 #iâdeà
_IOC_DIRBITS


35 
	#_IOC_DIRBITS
 2

	)

38 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

39 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

40 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

41 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

43 
	#_IOC_NRSHIFT
 0

	)

44 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

45 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

46 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

53 #iâdeà
_IOC_NONE


54 
	#_IOC_NONE
 0U

	)

57 #iâdeà
_IOC_WRITE


58 
	#_IOC_WRITE
 1U

	)

61 #iâdeà
_IOC_READ


62 
	#_IOC_READ
 2U

	)

65 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

66 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

67 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

68 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

69 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

71 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

74 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

75 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

76 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

77 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

78 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

79 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

80 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

83 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

84 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

85 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

86 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

90 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

91 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

92 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

93 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

94 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm/bitsperlong.h

1 #iâdeà
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #ifdeà
__x86_64__


5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/asm/posix_types.h

1 #ifdeà
__i386__


2 
	~"posix_ty³s_32.h
"

4 
	~"posix_ty³s_64.h
"

	@/usr/include/bits/libc-lock.h

21 #iâdeà
_BITS_LIBC_LOCK_H


22 
	#_BITS_LIBC_LOCK_H
 1

	)

24 
	~<±h»ad.h
>

27 #ifdeà
_IO_MTSAFE_IO


28 
±h»ad_mu‹x_t
 
	t__libc_lock_t
;

29 ¡ruù { 
±h»ad_mu‹x_t
 
	mmu‹x
; } 
	t__libc_lock_»cursive_t
;

30 #ifdeà
__USE_UNIX98


31 
±h»ad_rwlock_t
 
	t__libc_rwlock_t
;

33 
__libc_rwlock_İaque__
 
	t__libc_rwlock_t
;

35 
__libc_lock_»cursive_t
 
	t__¹ld_lock_»cursive_t
;

37 
__libc_lock_İaque__
 
	t__libc_lock_t
;

38 
__libc_lock_»cursive_İaque__
 
	t__libc_lock_»cursive_t
;

39 
__libc_rwlock_İaque__
 
	t__libc_rwlock_t
;

43 
±h»ad_key_t
 
	t__libc_key_t
;

52 
	#__libc_lock_defše
(
CLASS
,
NAME
) \

53 
CLASS
 
__libc_lock_t
 
NAME
;

	)

54 
	#__libc_rwlock_defše
(
CLASS
,
NAME
) \

55 
CLASS
 
__libc_rwlock_t
 
NAME
;

	)

56 
	#__libc_lock_defše_»cursive
(
CLASS
,
NAME
) \

57 
CLASS
 
__libc_lock_»cursive_t
 
NAME
;

	)

58 
	#__¹ld_lock_defše_»cursive
(
CLASS
,
NAME
) \

59 
CLASS
 
__¹ld_lock_»cursive_t
 
NAME
;

	)

70 #ià
__LT_SPINLOCK_INIT
 == 0

71 
	#__libc_lock_defše_š™Ÿlized
(
CLASS
,
NAME
) \

72 
CLASS
 
__libc_lock_t
 
NAME
;

	)

74 
	#__libc_lock_defše_š™Ÿlized
(
CLASS
,
NAME
) \

75 
CLASS
 
__libc_lock_t
 
NAME
 = 
PTHREAD_MUTEX_INITIALIZER
;

	)

78 
	#__libc_rwlock_defše_š™Ÿlized
(
CLASS
,
NAME
) \

79 
CLASS
 
__libc_rwlock_t
 
NAME
 = 
PTHREAD_RWLOCK_INITIALIZER
;

	)

83 
	#__libc_lock_defše_š™Ÿlized_»cursive
(
CLASS
,
NAME
) \

84 
CLASS
 
__libc_lock_»cursive_t
 
NAME
 = 
_LIBC_LOCK_RECURSIVE_INITIALIZER
;

	)

85 
	#_LIBC_LOCK_RECURSIVE_INITIALIZER
 \

86 {
PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
}

	)

88 
	#__¹ld_lock_defše_š™Ÿlized_»cursive
(
CLASS
,
NAME
) \

89 
CLASS
 
__¹ld_lock_»cursive_t
 
NAME
 = 
_RTLD_LOCK_RECURSIVE_INITIALIZER
;

	)

90 
	#_RTLD_LOCK_RECURSIVE_INITIALIZER
 \

91 {
PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
}

	)

93 #ià
defšed
 
__PIC__


94 
	#__libc_maybe_ÿÎ
(
FUNC
, 
ARGS
, 
ELSE
) \

95 (
	`__ex‹nsiÚ__
 ({ 
	`__ty³of
 (
FUNC
è*
_â
 = (FUNC); \

96 
_â
 !ğ
NULL
 ? (*_âè
ARGS
 : 
ELSE
; }))

	)

98 
	#__libc_maybe_ÿÎ
(
FUNC
, 
ARGS
, 
ELSE
) \

99 (
FUNC
 !ğ
NULL
 ? FUNC 
ARGS
 : 
ELSE
)

	)

101 
	#__libc_maybe_ÿÎ2
(
FUNC
, 
ARGS
, 
ELSE
è
	`__libc_maybe_ÿÎ
 (
__
##FUNC, ARGS, ELSE)

	)

105 
	#__libc_lock_š™
(
NAME
) \

106 (
	`__libc_maybe_ÿÎ2
 (
±h»ad_mu‹x_š™
, (&(
NAME
), 
NULL
), 0))

	)

107 
	#__libc_rwlock_š™
(
NAME
) \

108 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_š™
, (&(
NAME
), 
NULL
), 0));

	)

111 
	#__libc_lock_š™_»cursive
(
NAME
) \

113 ià(
__±h»ad_mu‹x_š™
 !ğ
NULL
) \

115 
±h»ad_mu‹x©Œ_t
 
__©Œ
; \

116 
	`__±h»ad_mu‹x©Œ_š™
 (&
__©Œ
); \

117 
	`__±h»ad_mu‹x©Œ_£‰y³
 (&
__©Œ
, 
PTHREAD_MUTEX_RECURSIVE_NP
); \

118 
	`__±h»ad_mu‹x_š™
 (&(
NAME
).
mu‹x
, &
__©Œ
); \

119 
	`__±h»ad_mu‹x©Œ_de¡roy
 (&
__©Œ
); \

121 } 0);

	)

122 
	#__¹ld_lock_š™_»cursive
(
NAME
) \

123 
	`__libc_lock_š™_»cursive
 (
NAME
)

	)

128 
	#__libc_lock_fši
(
NAME
) \

129 (
	`__libc_maybe_ÿÎ2
 (
±h»ad_mu‹x_de¡roy
, (&(
NAME
)), 0));

	)

130 
	#__libc_rwlock_fši
(
NAME
) \

131 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_de¡roy
, (&(
NAME
)), 0));

	)

134 
	#__libc_lock_fši_»cursive
(
NAME
è
	`__libc_lock_fši
 ((NAME).
mu‹x
)

	)

135 
	#__¹ld_lock_fši_»cursive
(
NAME
è
	`__libc_lock_fši_»cursive
 (NAME)

	)

138 
	#__libc_lock_lock
(
NAME
) \

139 (
	`__libc_maybe_ÿÎ2
 (
±h»ad_mu‹x_lock
, (&(
NAME
)), 0));

	)

140 
	#__libc_rwlock_rdlock
(
NAME
) \

141 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_rdlock
, (&(
NAME
)), 0));

	)

142 
	#__libc_rwlock_w¾ock
(
NAME
) \

143 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_w¾ock
, (&(
NAME
)), 0));

	)

146 
	#__libc_lock_lock_»cursive
(
NAME
è
	`__libc_lock_lock
 ((NAME).
mu‹x
)

	)

149 
	#__libc_lock_Œylock
(
NAME
) \

150 (
	`__libc_maybe_ÿÎ2
 (
±h»ad_mu‹x_Œylock
, (&(
NAME
)), 0))

	)

151 
	#__libc_rwlock_Œyrdlock
(
NAME
) \

152 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_Œyrdlock
, (&(
NAME
)), 0))

	)

153 
	#__libc_rwlock_Œyw¾ock
(
NAME
) \

154 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_Œyw¾ock
, (&(
NAME
)), 0))

	)

157 
	#__libc_lock_Œylock_»cursive
(
NAME
è
	`__libc_lock_Œylock
 ((NAME).
mu‹x
)

	)

158 
	#__¹ld_lock_Œylock_»cursive
(
NAME
) \

159 
	`__libc_lock_Œylock_»cursive
 (
NAME
)

	)

162 
	#__libc_lock_uÆock
(
NAME
) \

163 (
	`__libc_maybe_ÿÎ2
 (
±h»ad_mu‹x_uÆock
, (&(
NAME
)), 0));

	)

164 
	#__libc_rwlock_uÆock
(
NAME
) \

165 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_rwlock_uÆock
, (&(
NAME
)), 0));

	)

168 
	#__libc_lock_uÆock_»cursive
(
NAME
è
	`__libc_lock_uÆock
 ((NAME).
mu‹x
)

	)

170 
	#__¹ld_lock_lock_»cursive
(
NAME
è
	`__libc_lock_lock_»cursive
 (NAME)

	)

171 
	#__¹ld_lock_uÆock_»cursive
(
NAME
è
	`__libc_lock_uÆock_»cursive
 (NAME)

	)

174 #ià
PTHREAD_ONCE_INIT
 == 0

177 
	#__libc_Úû_defše
(
CLASS
, 
NAME
) \

178 
CLASS
 
±h»ad_Úû_t
 
NAME


	)

180 
	#__libc_Úû_defše
(
CLASS
, 
NAME
) \

181 
CLASS
 
±h»ad_Úû_t
 
NAME
 = 
PTHREAD_ONCE_INIT


	)

185 
	#__libc_Úû
(
ONCE_CONTROL
, 
INIT_FUNCTION
) \

187 ià(
__±h»ad_Úû
 !ğ
NULL
) \

188 
	`__±h»ad_Úû
 (&(
ONCE_CONTROL
), (
INIT_FUNCTION
)); \

189 ià((
ONCE_CONTROL
è=ğ
PTHREAD_ONCE_INIT
) { \

190 
	`INIT_FUNCTION
 (); \

191 (
ONCE_CONTROL
) = 2; \

193 } 0)

	)

197 
	#__libc_ş—nup_»giÚ_¡¬t
(
DOIT
, 
FCT
, 
ARG
) \

198 { 
_±h»ad_ş—nup_bufãr
 
_bufãr
; \

199 
_ava
 = (
DOIT
è&& 
_±h»ad_ş—nup_push_deãr
 !ğ
NULL
; \

200 ià(
_ava
) { \

201 
	`_±h»ad_ş—nup_push_deãr
 (&
_bufãr
, (
FCT
), (
ARG
)); \

202 }

	)

205 
	#__libc_ş—nup_»giÚ_’d
(
DOIT
) \

206 ià(
_ava
) { \

207 
	`_±h»ad_ş—nup_pİ_»¡Üe
 (&
_bufãr
, (
DOIT
)); \

209 }

	)

212 
	#__libc_ş—nup_’d
(
DOIT
) \

213 ià(
_ava
) { \

214 
	`_±h»ad_ş—nup_pİ_»¡Üe
 (&
_bufãr
, (
DOIT
)); \

215 }

	)

217 
	#__libc_ş—nup_push
(
fù
, 
¬g
) \

218 { 
_±h»ad_ş—nup_bufãr
 
_bufãr
; \

219 
	`__libc_maybe_ÿÎ
 (
_±h»ad_ş—nup_push
, (&
_bufãr
, (
fù
), (
¬g
)), 0)

	)

221 
	#__libc_ş—nup_pİ
(
execu‹
) \

222 
	`__libc_maybe_ÿÎ
 (
_±h»ad_ş—nup_pİ
, (&
_bufãr
, 
execu‹
), 0); \

223 }

	)

226 
	#__libc_key_ü—‹
(
KEY
, 
DESTRUCTOR
) \

227 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_key_ü—‹
, (
KEY
, 
DESTRUCTOR
), 1))

	)

230 
	#__libc_g‘¥ecific
(
KEY
) \

231 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_g‘¥ecific
, (
KEY
), 
NULL
))

	)

234 
	#__libc_£t¥ecific
(
KEY
, 
VALUE
) \

235 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_£t¥ecific
, (
KEY
, 
VALUE
), 0))

	)

239 
	#__libc_©fÜk
(
PREPARE
, 
PARENT
, 
CHILD
) \

240 (
	`__libc_maybe_ÿÎ
 (
__±h»ad_©fÜk
, (
PREPARE
, 
PARENT
, 
CHILD
), 0))

	)

242 
__BEGIN_DECLS


244 
_±h»ad_ş—nup_push_deãr
 (
_±h»ad_ş—nup_bufãr
 *
__bufãr
,

245 (*
__routše
) (*),

246 *
__¬g
è
__THROW
;

248 
	$_±h»ad_ş—nup_pİ_»¡Üe
 (
_±h»ad_ş—nup_bufãr
 *
__bufãr
,

249 
__execu‹
è
__THROW
;

255 
	`__±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

256 
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__mu‹x_©Œ
);

258 
	`__±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
);

260 
	`__±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
);

262 
	`__±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
);

264 
	`__±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
);

266 
	`__±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
);

268 
	`__±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
);

270 
	`__±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

271 
__kšd
);

273 #ifdeà
__USE_UNIX98


274 
	`__±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__rwlock
,

275 
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *
__©Œ
);

277 
	`__±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
);

279 
	`__±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
);

281 
	`__±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
);

283 
	`__±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
);

285 
	`__±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
);

287 
	`__±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
);

290 
	`__±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

291 (*
__de¡r_funùiÚ
) (*));

293 
	`__±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

294 
__cÚ¡
 *
__poš‹r
);

296 *
	`__±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
);

298 
	`__±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

299 (*
__š™_routše
) ());

301 
	`__±h»ad_©fÜk
 ((*
__´•¬e
) (),

302 (*
__·»Á
) (),

303 (*
__chd
) ());

305 
__END_DECLS


309 #iâdeà
__NO_WEAK_PTHREAD_ALIASES


310 #´agm¨
w—k
 
__±h»ad_mu‹x_š™


311 #´agm¨
w—k
 
__±h»ad_mu‹x_de¡roy


312 #´agm¨
w—k
 
__±h»ad_mu‹x_lock


313 #´agm¨
w—k
 
__±h»ad_mu‹x_Œylock


314 #´agm¨
w—k
 
__±h»ad_mu‹x_uÆock


315 #´agm¨
w—k
 
__±h»ad_mu‹x©Œ_š™


316 #´agm¨
w—k
 
__±h»ad_mu‹x©Œ_de¡roy


317 #´agm¨
w—k
 
__±h»ad_mu‹x©Œ_£‰y³


318 #´agm¨
w—k
 
__±h»ad_rwlock_de¡roy


319 #´agm¨
w—k
 
__±h»ad_rwlock_rdlock


320 #´agm¨
w—k
 
__±h»ad_rwlock_Œyrdlock


321 #´agm¨
w—k
 
__±h»ad_rwlock_w¾ock


322 #´agm¨
w—k
 
__±h»ad_rwlock_Œyw¾ock


323 #´agm¨
w—k
 
__±h»ad_rwlock_uÆock


324 #´agm¨
w—k
 
__±h»ad_key_ü—‹


325 #´agm¨
w—k
 
__±h»ad_£t¥ecific


326 #´agm¨
w—k
 
__±h»ad_g‘¥ecific


327 #´agm¨
w—k
 
__±h»ad_Úû


328 #´agm¨
w—k
 
__±h»ad_š™Ÿlize


329 #´agm¨
w—k
 
__±h»ad_©fÜk


330 #´agm¨
w—k
 
_±h»ad_ş—nup_push_deãr


331 #´agm¨
w—k
 
_±h»ad_ş—nup_pİ_»¡Üe


332 #´agm¨
w—k
 
_±h»ad_ş—nup_push


333 #´agm¨
w—k
 
_±h»ad_ş—nup_pİ


338 
	#__libc_mu‹x_uÆock
 
__±h»ad_mu‹x_uÆock


	)

	@/usr/include/gconv.h

23 #iâdeà
_GCONV_H


24 
	#_GCONV_H
 1

	)

26 
	~<ã©u»s.h
>

27 
	#__Ãed_mb¡©e_t


	)

28 
	#__Ãed_wšt_t


	)

29 
	~<wch¬.h
>

30 
	#__Ãed_size_t


	)

31 
	#__Ãed_wch¬_t


	)

32 
	~<¡ddef.h
>

35 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

40 
	m__GCONV_OK
 = 0,

41 
	m__GCONV_NOCONV
,

42 
	m__GCONV_NODB
,

43 
	m__GCONV_NOMEM
,

45 
	m__GCONV_EMPTY_INPUT
,

46 
	m__GCONV_FULL_OUTPUT
,

47 
	m__GCONV_ILLEGAL_INPUT
,

48 
	m__GCONV_INCOMPLETE_INPUT
,

50 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

51 
	m__GCONV_INTERNAL_ERROR


58 
	m__GCONV_IS_LAST
 = 0x0001,

59 
	m__GCONV_IGNORE_ERRORS
 = 0x0002

64 
	g__gcÚv_¡•
;

65 
	g__gcÚv_¡•_d©a
;

66 
	g__gcÚv_lßded_objeù
;

67 
	g__gcÚv_Œªs_d©a
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

72 
	t__cÚ¡
 **, __const *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 (*
	t__gcÚv_Œªs_fù
è(
	t__gcÚv_¡•
 *,

85 
	t__gcÚv_¡•_d©a
 *, *,

86 
	t__cÚ¡
 *,

87 
	t__cÚ¡
 **,

88 
	t__cÚ¡
 *, **,

89 
	tsize_t
 *);

92 (*
	t__gcÚv_Œªs_cÚ‹xt_fù
è(*, 
	t__cÚ¡
 *,

93 
	t__cÚ¡
 *,

97 (*
	t__gcÚv_Œªs_qu”y_fù
è(
	t__cÚ¡
 *, __const ***,

98 
	tsize_t
 *);

101 (*
	t__gcÚv_Œªs_š™_fù
) (**, const *);

102 (*
	t__gcÚv_Œªs_’d_fù
) (*);

104 
	s__gcÚv_Œªs_d©a


107 
__gcÚv_Œªs_fù
 
__Œªs_fù
;

108 
__gcÚv_Œªs_cÚ‹xt_fù
 
__Œªs_cÚ‹xt_fù
;

109 
__gcÚv_Œªs_’d_fù
 
__Œªs_’d_fù
;

110 *
__d©a
;

111 
__gcÚv_Œªs_d©a
 *
__Ãxt
;

116 
	s__gcÚv_¡•


118 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

119 
__cÚ¡
 *
__modÇme
;

121 
__couÁ”
;

123 *
__äom_Çme
;

124 *
__to_Çme
;

126 
__gcÚv_fù
 
__fù
;

127 
__gcÚv_btowc_fù
 
__btowc_fù
;

128 
__gcÚv_š™_fù
 
__š™_fù
;

129 
__gcÚv_’d_fù
 
__’d_fù
;

133 
__mš_Ãeded_äom
;

134 
__max_Ãeded_äom
;

135 
__mš_Ãeded_to
;

136 
__max_Ãeded_to
;

139 
__¡©eful
;

141 *
__d©a
;

146 
	s__gcÚv_¡•_d©a


148 *
__outbuf
;

149 *
__outbuãnd
;

153 
__æags
;

157 
__švoÿtiÚ_couÁ”
;

161 
__š‹º®_u£
;

163 
__mb¡©e_t
 *
__¡©•
;

164 
__mb¡©e_t
 
__¡©e
;

168 
__gcÚv_Œªs_d©a
 *
__Œªs
;

173 
	s__gcÚv_šfo


175 
size_t
 
__n¡•s
;

176 
__gcÚv_¡•
 *
__¡•s
;

177 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
 
__æex¬r
;

178 } *
	t__gcÚv_t
;

	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___k”Ãl_co¦


	)

11 
	#__¡ub___k”Ãl_sšl


	)

12 
	#__¡ub___k”Ãl_Æ


	)

13 
	#__¡ub_chæags


	)

14 
	#__¡ub_ç‰ach


	)

15 
	#__¡ub_fchæags


	)

16 
	#__¡ub_fd‘ach


	)

17 
	#__¡ub_g‰y


	)

18 
	#__¡ub_lchmod


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

6 #undeà
NULL


7 #ià
defšed
(
__ılu¥lus
)

8 
	#NULL
 0

	)

10 
	#NULL
 ((*)0)

	)

	@/usr/include/wchar.h

24 #iâdeà
_WCHAR_H


26 #ià!
defšed
 
__Ãed_mb¡©e_t
 && !defšed 
__Ãed_wšt_t


27 
	#_WCHAR_H
 1

	)

28 
	~<ã©u»s.h
>

31 #ifdeà
_WCHAR_H


33 
	#__Ãed___FILE


	)

34 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


35 
	#__Ãed_FILE


	)

37 
	~<¡dio.h
>

39 
	#__Ãed___va_li¡


	)

40 
	~<¡d¬g.h
>

42 
	~<b™s/wch¬.h
>

45 
	#__Ãed_size_t


	)

46 
	#__Ãed_wch¬_t


	)

47 
	#__Ãed_NULL


	)

49 #ià
defšed
 
_WCHAR_H
 || defšed 
__Ãed_wšt_t
 || !defšed 
__WINT_TYPE__


50 #undeà
__Ãed_wšt_t


51 
	#__Ãed_wšt_t


	)

52 
	~<¡ddef.h
>

56 #iâdeà
_WINT_T


61 
	#_WINT_T


	)

62 
	twšt_t
;

66 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES
 \

67 && 
defšed
 
__WINT_TYPE__


68 
__BEGIN_NAMESPACE_STD


69 
__WINT_TYPE__
 
	twšt_t
;

70 
	g__END_NAMESPACE_STD


75 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

76 
	#__CORRECT_ISO_CPP_WCHAR_H_PROTO


	)

80 #ià(
defšed
 
_WCHAR_H
 || defšed 
__Ãed_mb¡©e_t
è&& !defšed 
__mb¡©e_t_defšed


81 
	#__mb¡©e_t_defšed
 1

	)

85 
	m__couÁ
;

88 #ifdeà
__WINT_TYPE__


89 
__WINT_TYPE__
 
	m__wch
;

91 
wšt_t
 
	m__wch
;

93 
	m__wchb
[4];

94 } 
	m__v®ue
;

95 } 
	t__mb¡©e_t
;

97 #undeà
__Ãed_mb¡©e_t


102 #ifdeà
_WCHAR_H


104 
__BEGIN_NAMESPACE_C99


106 
__mb¡©e_t
 
	tmb¡©e_t
;

107 
	g__END_NAMESPACE_C99


108 #ifdeà
__USE_GNU


109 
	$__USING_NAMESPACE_C99
(
mb¡©e_t
)

112 #iâdeà
WCHAR_MIN


114 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

115 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

118 #iâdeà
WEOF


119 
	#WEOF
 (0xffffffffu)

	)

124 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_UNIX98


125 
	~<wùy³.h
>

129 
__BEGIN_DECLS


131 
__BEGIN_NAMESPACE_STD


134 
tm
;

135 
__END_NAMESPACE_STD


139 
	$__USING_NAMESPACE_STD
(
tm
)

142 
__BEGIN_NAMESPACE_STD


144 
wch¬_t
 *
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

145 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

147 
wch¬_t
 *
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

148 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

149 
__THROW
;

152 
wch¬_t
 *
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

153 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

155 
wch¬_t
 *
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

156 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

157 
__THROW
;

160 
	$wcscmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
)

161 
__THROW
 
__©Œibu‹_pu»__
;

163 
	$wc¢cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
, 
size_t
 
__n
)

164 
__THROW
 
__©Œibu‹_pu»__
;

165 
__END_NAMESPACE_STD


167 #ifdeà
__USE_XOPEN2K8


169 
	$wcsÿ£cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

172 
	$wc¢ÿ£cmp
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

173 
size_t
 
__n
è
__THROW
;

177 
	~<xloÿË.h
>

179 
	$wcsÿ£cmp_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

180 
__loÿË_t
 
__loc
è
__THROW
;

182 
	$wc¢ÿ£cmp_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

183 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

186 
__BEGIN_NAMESPACE_STD


189 
	$wcscŞl
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
è
__THROW
;

193 
size_t
 
	$wcsxäm
 (
wch¬_t
 *
__»¡riù
 
__s1
,

194 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

195 
__END_NAMESPACE_STD


197 #ifdeà
__USE_XOPEN2K8


203 
	$wcscŞl_l
 (
__cÚ¡
 
wch¬_t
 *
__s1
, __cÚ¡ wch¬_ˆ*
__s2
,

204 
__loÿË_t
 
__loc
è
__THROW
;

209 
size_t
 
	$wcsxäm_l
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
,

210 
size_t
 
__n
, 
__loÿË_t
 
__loc
è
__THROW
;

213 
wch¬_t
 *
	$wcsdup
 (
__cÚ¡
 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_m®loc__
;

216 
__BEGIN_NAMESPACE_STD


218 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


219 "C++" 
wch¬_t
 *
	$wcschr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

220 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

221 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcschr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

222 
__THROW
 
	`__asm
 ("wcschr"è
__©Œibu‹_pu»__
;

224 
wch¬_t
 *
	$wcschr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

225 
__THROW
 
__©Œibu‹_pu»__
;

228 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


229 "C++" 
wch¬_t
 *
	$wc¤chr
 (
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

230 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

231 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wc¤chr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

232 
__THROW
 
	`__asm
 ("wc¤chr"è
__©Œibu‹_pu»__
;

234 
wch¬_t
 *
	$wc¤chr
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, wch¬_ˆ
__wc
)

235 
__THROW
 
__©Œibu‹_pu»__
;

237 
__END_NAMESPACE_STD


239 #ifdeà
__USE_GNU


242 
wch¬_t
 *
	$wcschºul
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__wc
)

243 
__THROW
 
__©Œibu‹_pu»__
;

246 
__BEGIN_NAMESPACE_STD


249 
size_t
 
	$wcsc¥n
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__»jeù
)

250 
__THROW
 
__©Œibu‹_pu»__
;

253 
size_t
 
	$wcs¥n
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__acû±
)

254 
__THROW
 
__©Œibu‹_pu»__
;

256 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


257 "C++" 
wch¬_t
 *
	$wc¥brk
 (
wch¬_t
 *
__wcs
, 
__cÚ¡
 wch¬_ˆ*
__acû±
)

258 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

259 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wc¥brk
 (
__cÚ¡
 
wch¬_t
 *
__wcs
,

260 
__cÚ¡
 
wch¬_t
 *
__acû±
)

261 
__THROW
 
	`__asm
 ("wc¥brk"è
__©Œibu‹_pu»__
;

263 
wch¬_t
 *
	$wc¥brk
 (
__cÚ¡
 
wch¬_t
 *
__wcs
, __cÚ¡ wch¬_ˆ*
__acû±
)

264 
__THROW
 
__©Œibu‹_pu»__
;

267 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


268 "C++" 
wch¬_t
 *
	$wcs¡r
 (
wch¬_t
 *
__hay¡ack
, 
__cÚ¡
 wch¬_ˆ*
__ÃedË
)

269 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

270 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcs¡r
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
,

271 
__cÚ¡
 
wch¬_t
 *
__ÃedË
)

272 
__THROW
 
	`__asm
 ("wcs¡r"è
__©Œibu‹_pu»__
;

274 
wch¬_t
 *
	$wcs¡r
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
, __cÚ¡ wch¬_ˆ*
__ÃedË
)

275 
__THROW
 
__©Œibu‹_pu»__
;

279 
wch¬_t
 *
	$wc¡ok
 (
wch¬_t
 *
__»¡riù
 
__s
,

280 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__d–im
,

281 
wch¬_t
 **
__»¡riù
 
__±r
è
__THROW
;

284 
size_t
 
	$wc¦’
 (
__cÚ¡
 
wch¬_t
 *
__s
è
__THROW
 
__©Œibu‹_pu»__
;

285 
__END_NAMESPACE_STD


287 #ifdeà
__USE_XOPEN


289 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


290 "C++" 
wch¬_t
 *
	$wcswcs
 (
wch¬_t
 *
__hay¡ack
, 
__cÚ¡
 wch¬_ˆ*
__ÃedË
)

291 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

292 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wcswcs
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
,

293 
__cÚ¡
 
wch¬_t
 *
__ÃedË
)

294 
__THROW
 
	`__asm
 ("wcswcs"è
__©Œibu‹_pu»__
;

296 
wch¬_t
 *
	$wcswcs
 (
__cÚ¡
 
wch¬_t
 *
__hay¡ack
, __cÚ¡ wch¬_ˆ*
__ÃedË
)

297 
__THROW
 
__©Œibu‹_pu»__
;

301 #ifdeà
__USE_XOPEN2K8


303 
size_t
 
	$wc¢Ën
 (
__cÚ¡
 
wch¬_t
 *
__s
, 
size_t
 
__maxËn
)

304 
__THROW
 
__©Œibu‹_pu»__
;

308 
__BEGIN_NAMESPACE_STD


310 #ifdeà
__CORRECT_ISO_CPP_WCHAR_H_PROTO


311 "C++" 
wch¬_t
 *
	$wmemchr
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

312 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

313 "C++" 
__cÚ¡
 
wch¬_t
 *
	$wmemchr
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__c
,

314 
size_t
 
__n
)

315 
__THROW
 
	`__asm
 ("wmemchr"è
__©Œibu‹_pu»__
;

317 
wch¬_t
 *
	$wmemchr
 (
__cÚ¡
 
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
)

318 
__THROW
 
__©Œibu‹_pu»__
;

322 
	$wmemcmp
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s1
,

323 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

324 
__THROW
 
__©Œibu‹_pu»__
;

327 
wch¬_t
 *
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

328 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
è
__THROW
;

332 
wch¬_t
 *
	$wmemmove
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
, 
size_t
 
__n
)

333 
__THROW
;

336 
wch¬_t
 *
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
è
__THROW
;

337 
__END_NAMESPACE_STD


339 #ifdeà
__USE_GNU


342 
wch¬_t
 *
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
,

343 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
)

344 
__THROW
;

348 
__BEGIN_NAMESPACE_STD


351 
wšt_t
 
	$btowc
 (
__c
è
__THROW
;

355 
	$wùob
 (
wšt_t
 
__c
è
__THROW
;

359 
	$mbsš™
 (
__cÚ¡
 
mb¡©e_t
 *
__ps
è
__THROW
 
__©Œibu‹_pu»__
;

363 
size_t
 
	$mb¹owc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

364 
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

365 
mb¡©e_t
 *
__p
è
__THROW
;

368 
size_t
 
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wc
,

369 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

372 
size_t
 
	$__mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

373 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

374 
size_t
 
	$mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

375 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

376 
__END_NAMESPACE_STD


378 #ifdeà
__USE_EXTERN_INLINES


384 
wšt_t
 
	$__btowc_®Ÿs
 (
__c
è
	`__asm
 ("btowc");

385 
__ex‹º_šlše
 
wšt_t


386 
	`__NTH
 (
	$btowc
 (
__c
))

387 {  (
	`__butš_cÚ¡ªt_p
 (
__c
) && __c >= '\0' && __c <= '\x7f'

388 ? (
wšt_t
è
__c
 : 
	`__btowc_®Ÿs
 (__c)); 
	}
}

390 
	$__wùob_®Ÿs
 (
wšt_t
 
__c
è
	`__asm
 ("wctob");

391 
__ex‹º_šlše
 

392 
	`__NTH
 (
	$wùob
 (
wšt_t
 
__wc
))

393 {  (
	`__butš_cÚ¡ªt_p
 (
__wc
è&& __wø>ğ
L
'\0' && __wc <= L'\x7f'

394 ? (è
__wc
 : 
	`__wùob_®Ÿs
 (__wc)); 
	}
}

396 
__ex‹º_šlše
 
size_t


397 
__NTH
 (
	$mb¾’
 (
__cÚ¡
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

398 
mb¡©e_t
 *
__»¡riù
 
__ps
))

399 {  (
__ps
 !ğ
NULL


400 ? 
	`mb¹owc
 (
NULL
, 
__s
, 
__n
, 
__ps
è: 
	`__mb¾’
 (__s, __n, NULL)); 
	}
}

403 
__BEGIN_NAMESPACE_STD


406 
size_t
 
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

407 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

408 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

412 
size_t
 
	$wc¤tombs
 (*
__»¡riù
 
__d¡
,

413 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
, 
size_t
 
__Ën
,

414 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

415 
__END_NAMESPACE_STD


418 #ifdef 
__USE_XOPEN2K8


421 
size_t
 
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

422 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

423 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

427 
size_t
 
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
,

428 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

429 
size_t
 
__nwc
, size_ˆ
__Ën
,

430 
mb¡©e_t
 *
__»¡riù
 
__ps
è
__THROW
;

435 #ifdeà
__USE_XOPEN


437 
	$wcwidth
 (
wch¬_t
 
__c
è
__THROW
;

441 
	$wcswidth
 (
__cÚ¡
 
wch¬_t
 *
__s
, 
size_t
 
__n
è
__THROW
;

445 
__BEGIN_NAMESPACE_STD


448 
	$wc¡od
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

449 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

450 
__END_NAMESPACE_STD


452 #ifdeà
__USE_ISOC99


453 
__BEGIN_NAMESPACE_C99


455 
	$wc¡of
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

456 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

457 
	$wc¡Şd
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

458 
wch¬_t
 **
__»¡riù
 
__’d±r
è
__THROW
;

459 
__END_NAMESPACE_C99


463 
__BEGIN_NAMESPACE_STD


466 
	$wc¡Ş
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

467 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
è
__THROW
;

471 
	$wc¡oul
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

472 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

473 
__THROW
;

474 
__END_NAMESPACE_STD


476 #ià
defšed
 
__USE_ISOC99
 || (defšed 
__GNUC__
 && defšed 
__USE_GNU
)

477 
__BEGIN_NAMESPACE_C99


480 
__ex‹nsiÚ__


481 
	$wc¡Şl
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

482 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

483 
__THROW
;

487 
__ex‹nsiÚ__


488 
	$wc¡ouÎ
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

489 
wch¬_t
 **
__»¡riù
 
__’d±r
,

490 
__ba£
è
__THROW
;

491 
__END_NAMESPACE_C99


494 #ià
defšed
 
__GNUC__
 && defšed 
__USE_GNU


497 
__ex‹nsiÚ__


498 
	$wc¡oq
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

499 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
)

500 
__THROW
;

504 
__ex‹nsiÚ__


505 
	$wc¡ouq
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

506 
wch¬_t
 **
__»¡riù
 
__’d±r
,

507 
__ba£
è
__THROW
;

510 #ifdeà
__USE_GNU


524 
	~<xloÿË.h
>

528 
	$wc¡Ş_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

529 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__ba£
,

530 
__loÿË_t
 
__loc
è
__THROW
;

532 
	$wc¡oul_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

533 
wch¬_t
 **
__»¡riù
 
__’d±r
,

534 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

536 
__ex‹nsiÚ__


537 
	$wc¡Şl_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

538 
wch¬_t
 **
__»¡riù
 
__’d±r
,

539 
__ba£
, 
__loÿË_t
 
__loc
è
__THROW
;

541 
__ex‹nsiÚ__


542 
	$wc¡ouÎ_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

543 
wch¬_t
 **
__»¡riù
 
__’d±r
,

544 
__ba£
, 
__loÿË_t
 
__loc
)

545 
__THROW
;

547 
	$wc¡od_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

548 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

549 
__THROW
;

551 
	$wc¡of_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

552 
wch¬_t
 **
__»¡riù
 
__’d±r
, 
__loÿË_t
 
__loc
)

553 
__THROW
;

555 
	$wc¡Şd_l
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ÅŒ
,

556 
wch¬_t
 **
__»¡riù
 
__’d±r
,

557 
__loÿË_t
 
__loc
è
__THROW
;

562 
wch¬_t
 *
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

563 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
è
__THROW
;

567 
wch¬_t
 *
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

568 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

569 
__THROW
;

575 #ifdef 
__USE_XOPEN2K8


578 
__FILE
 *
	$İ’_wmem¡»am
 (
wch¬_t
 **
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
;

581 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


582 
__BEGIN_NAMESPACE_STD


585 
	$fwide
 (
__FILE
 *
__å
, 
__mode
è
__THROW
;

592 
	`fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

593 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

599 
	`w´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

602 
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

603 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

604 
__THROW
 ;

610 
	`vfw´štf
 (
__FILE
 *
__»¡riù
 
__s
,

611 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

612 
__gnuc_va_li¡
 
__¬g
)

618 
	`vw´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

619 
__gnuc_va_li¡
 
__¬g
)

623 
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

624 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

625 
__gnuc_va_li¡
 
__¬g
)

626 
__THROW
 ;

633 
	`fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

634 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

640 
	`wsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

643 
	$swsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

644 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

645 
__THROW
 ;

647 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

648 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

649 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

650 #ifdeà
__REDIRECT


654 
	`__REDIRECT
 (
fwsÿnf
, (
__FILE
 *
__»¡riù
 
__¡»am
,

655 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

656 
__isoc99_fwsÿnf
)

658 
	`__REDIRECT
 (
wsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

659 
__isoc99_wsÿnf
)

661 
	`__REDIRECT
 (
swsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

662 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...),

663 
__isoc99_swsÿnf
)

664 
__THROW
 ;

666 
	`__isoc99_fwsÿnf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

667 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

668 
	`__isoc99_wsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

669 
	$__isoc99_swsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

670 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

671 
__THROW
;

672 
	#fwsÿnf
 
__isoc99_fwsÿnf


	)

673 
	#wsÿnf
 
__isoc99_wsÿnf


	)

674 
	#swsÿnf
 
__isoc99_swsÿnf


	)

678 
__END_NAMESPACE_STD


681 #ifdeà
__USE_ISOC99


682 
__BEGIN_NAMESPACE_C99


687 
	`vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

688 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

689 
__gnuc_va_li¡
 
__¬g
)

695 
	`vwsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

696 
__gnuc_va_li¡
 
__¬g
)

699 
	$vswsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

700 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

701 
__gnuc_va_li¡
 
__¬g
)

702 
__THROW
 ;

704 #ià!
defšed
 
__USE_GNU
 \

705 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

706 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

707 #ifdeà
__REDIRECT


708 
	`__REDIRECT
 (
vfwsÿnf
, (
__FILE
 *
__»¡riù
 
__s
,

709 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

710 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vfwsÿnf
)

712 
	`__REDIRECT
 (
vwsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

713 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vwsÿnf
)

715 
	`__REDIRECT
 (
vswsÿnf
, (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

716 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

717 
__gnuc_va_li¡
 
__¬g
), 
__isoc99_vswsÿnf
)

718 
__THROW
 ;

720 
	`__isoc99_vfwsÿnf
 (
__FILE
 *
__»¡riù
 
__s
,

721 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

722 
__gnuc_va_li¡
 
__¬g
);

723 
	`__isoc99_vwsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

724 
__gnuc_va_li¡
 
__¬g
);

725 
	$__isoc99_vswsÿnf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s
,

726 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

727 
__gnuc_va_li¡
 
__¬g
è
__THROW
;

728 
	#vfwsÿnf
 
__isoc99_vfwsÿnf


	)

729 
	#vwsÿnf
 
__isoc99_vwsÿnf


	)

730 
	#vswsÿnf
 
__isoc99_vswsÿnf


	)

734 
__END_NAMESPACE_C99


738 
__BEGIN_NAMESPACE_STD


743 
wšt_t
 
	`fg‘wc
 (
__FILE
 *
__¡»am
);

744 
wšt_t
 
	`g‘wc
 (
__FILE
 *
__¡»am
);

750 
wšt_t
 
	`g‘wch¬
 ();

757 
wšt_t
 
	`åutwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

758 
wšt_t
 
	`putwc
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

764 
wšt_t
 
	`putwch¬
 (
wch¬_t
 
__wc
);

772 
wch¬_t
 *
	`fg‘ws
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

773 
__FILE
 *
__»¡riù
 
__¡»am
);

779 
	`åutws
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ws
,

780 
__FILE
 *
__»¡riù
 
__¡»am
);

787 
wšt_t
 
	`ung‘wc
 (wšt_ˆ
__wc
, 
__FILE
 *
__¡»am
);

788 
__END_NAMESPACE_STD


791 #ifdeà
__USE_GNU


799 
wšt_t
 
	`g‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

800 
wšt_t
 
	`g‘wch¬_uÆocked
 ();

808 
wšt_t
 
	`fg‘wc_uÆocked
 (
__FILE
 *
__¡»am
);

816 
wšt_t
 
	`åutwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

825 
wšt_t
 
	`putwc_uÆocked
 (
wch¬_t
 
__wc
, 
__FILE
 *
__¡»am
);

826 
wšt_t
 
	`putwch¬_uÆocked
 (
wch¬_t
 
__wc
);

835 
wch¬_t
 *
	`fg‘ws_uÆocked
 (wch¬_ˆ*
__»¡riù
 
__ws
, 
__n
,

836 
__FILE
 *
__»¡riù
 
__¡»am
);

844 
	`åutws_uÆocked
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__ws
,

845 
__FILE
 *
__»¡riù
 
__¡»am
);

849 
__BEGIN_NAMESPACE_C99


853 
size_t
 
	$wcsáime
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

854 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

855 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

856 
__END_NAMESPACE_C99


858 #ifdeà
__USE_GNU


859 
	~<xloÿË.h
>

863 
size_t
 
	$wcsáime_l
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

864 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

865 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

866 
__loÿË_t
 
__loc
è
__THROW
;

875 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_GNU


876 
	#__Ãed_iswxxx


	)

877 
	~<wùy³.h
>

881 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


882 
	~<b™s/wch¬2.h
>

885 #ifdeà
__LDBL_COMPAT


886 
	~<b™s/wch¬-ldbl.h
>

889 
__END_DECLS


897 #undeà
__Ãed_mb¡©e_t


898 #undeà
__Ãed_wšt_t


	@/usr/include/asm-generic/bitsperlong.h

1 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #iâdeà
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/asm-generic/errno-base.h

1 #iâdeà
_ASM_GENERIC_ERRNO_BASE_H


2 
	#_ASM_GENERIC_ERRNO_BASE_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

	@/usr/include/bits/wchar-ldbl.h

20 #iâdeà
_WCHAR_H


24 #ià
defšed
 
__USE_ISOC95
 || defšed 
__USE_UNIX98


25 
__BEGIN_NAMESPACE_C99


26 
__LDBL_REDIR_DECL
 (
fw´štf
);

27 
__LDBL_REDIR_DECL
 (
w´štf
);

28 
__LDBL_REDIR_DECL
 (
sw´štf
);

29 
__LDBL_REDIR_DECL
 (
vfw´štf
);

30 
__LDBL_REDIR_DECL
 (
vw´štf
);

31 
__LDBL_REDIR_DECL
 (
vsw´štf
);

32 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

33 && !
defšed
 
	g__REDIRECT
 \

34 && (
defšed
 
	g__STRICT_ANSI__
 || defšed 
	g__USE_XOPEN2K
)

35 
	$__LDBL_REDIR1_DECL
 (
fwsÿnf
, 
__Ædbl___isoc99_fwsÿnf
)

36 
	$__LDBL_REDIR1_DECL
 (
wsÿnf
, 
__Ædbl___isoc99_wsÿnf
)

37 
	$__LDBL_REDIR1_DECL
 (
swsÿnf
, 
__Ædbl___isoc99_swsÿnf
)

39 
	`__LDBL_REDIR_DECL
 (
fwsÿnf
);

40 
	`__LDBL_REDIR_DECL
 (
wsÿnf
);

41 
	`__LDBL_REDIR_DECL
 (
swsÿnf
);

43 
__END_NAMESPACE_C99


46 #ifdeà
__USE_ISOC99


47 
__BEGIN_NAMESPACE_C99


48 
	`__LDBL_REDIR1_DECL
 (
wc¡Şd
, 
wc¡od
);

49 #ià!
defšed
 
__USE_GNU
 && !defšed 
__REDIRECT
 \

50 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

51 
	$__LDBL_REDIR1_DECL
 (
vfwsÿnf
, 
__Ædbl___isoc99_vfwsÿnf
)

52 
	$__LDBL_REDIR1_DECL
 (
vwsÿnf
, 
__Ædbl___isoc99_vwsÿnf
)

53 
	$__LDBL_REDIR1_DECL
 (
vswsÿnf
, 
__Ædbl___isoc99_vswsÿnf
)

55 
	`__LDBL_REDIR_DECL
 (
vfwsÿnf
);

56 
	`__LDBL_REDIR_DECL
 (
vwsÿnf
);

57 
	`__LDBL_REDIR_DECL
 (
vswsÿnf
);

59 
__END_NAMESPACE_C99


62 #ifdeà
__USE_GNU


63 
	`__LDBL_REDIR1_DECL
 (
wc¡Şd_l
, 
wc¡od_l
);

66 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__ex‹º_®ways_šlše


67 
	$__LDBL_REDIR_DECL
 (
__sw´štf_chk
)

68 
	$__LDBL_REDIR_DECL
 (
__vsw´štf_chk
)

69 #ià
__USE_FORTIFY_LEVEL
 > 1

70 
	$__LDBL_REDIR_DECL
 (
__fw´štf_chk
)

71 
	$__LDBL_REDIR_DECL
 (
__w´štf_chk
)

72 
	$__LDBL_REDIR_DECL
 (
__vfw´štf_chk
)

73 
	$__LDBL_REDIR_DECL
 (
__vw´štf_chk
)

	@/usr/include/bits/wchar2.h

20 #iâdeà
_WCHAR_H


25 
wch¬_t
 *
	$__wmemıy_chk
 (
wch¬_t
 *
__»¡riù
 
__s1
,

26 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
,

27 
size_t
 
__ns1
è
__THROW
;

28 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmemıy_®Ÿs
,

29 (
wch¬_t
 *
__»¡riù
 
__s1
,

30 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
),

31 
wmemıy
);

32 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmemıy_chk_w¬n
,

33 (
wch¬_t
 *
__»¡riù
 
__s1
,

34 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
,

35 
size_t
 
__ns1
), 
__wmemıy_chk
)

36 
	`__w¬Ç‰r
 ("wmemcpy called with†ength biggerhan size of destination "

39 
__ex‹º_®ways_šlše
 
wch¬_t
 *

40 
	`__NTH
 (
	$wmemıy
 (
wch¬_t
 *
__»¡riù
 
__s1
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__s2
,

41 
size_t
 
__n
))

43 ià(
	`__bos0
 (
__s1
è!ğ(
size_t
) -1)

45 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

46  
	`__wmemıy_chk
 (
__s1
, 
__s2
, 
__n
,

47 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

49 ià(
__n
 > 
	`__bos0
 (
__s1
è/  (
wch¬_t
))

50  
	`__wmemıy_chk_w¬n
 (
__s1
, 
__s2
, 
__n
,

51 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

53  
	`__wmemıy_®Ÿs
 (
__s1
, 
__s2
, 
__n
);

54 
	}
}

57 
wch¬_t
 *
	$__wmemmove_chk
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
,

58 
size_t
 
__n
, size_ˆ
__ns1
è
__THROW
;

59 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmemmove_®Ÿs
, (wch¬_ˆ*
__s1
,

60 
__cÚ¡
 
wch¬_t
 *
__s2
,

61 
size_t
 
__n
), 
wmemmove
);

62 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmemmove_chk_w¬n
,

63 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
,

64 
size_t
 
__n
, size_ˆ
__ns1
), 
__wmemmove_chk
)

65 
	`__w¬Ç‰r
 ("wmemmove called with†ength biggerhan size of destination "

68 
__ex‹º_®ways_šlše
 
wch¬_t
 *

69 
	`__NTH
 (
	$wmemmove
 (
wch¬_t
 *
__s1
, 
__cÚ¡
 wch¬_ˆ*
__s2
, 
size_t
 
__n
))

71 ià(
	`__bos0
 (
__s1
è!ğ(
size_t
) -1)

73 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

74  
	`__wmemmove_chk
 (
__s1
, 
__s2
, 
__n
,

75 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

77 ià(
__n
 > 
	`__bos0
 (
__s1
è/  (
wch¬_t
))

78  
	`__wmemmove_chk_w¬n
 (
__s1
, 
__s2
, 
__n
,

79 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

81  
	`__wmemmove_®Ÿs
 (
__s1
, 
__s2
, 
__n
);

82 
	}
}

85 #ifdeà
__USE_GNU


86 
wch¬_t
 *
	$__wmempıy_chk
 (
wch¬_t
 *
__»¡riù
 
__s1
,

87 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
,

88 
size_t
 
__ns1
è
__THROW
;

89 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmempıy_®Ÿs
,

90 (
wch¬_t
 *
__»¡riù
 
__s1
,

91 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
,

92 
size_t
 
__n
), 
wmempıy
);

93 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmempıy_chk_w¬n
,

94 (
wch¬_t
 *
__»¡riù
 
__s1
,

95 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__s2
, 
size_t
 
__n
,

96 
size_t
 
__ns1
), 
__wmempıy_chk
)

97 
	`__w¬Ç‰r
 ("wmempcpy called with†ength biggerhan size of destination "

100 
__ex‹º_®ways_šlše
 
wch¬_t
 *

101 
	`__NTH
 (
	$wmempıy
 (
wch¬_t
 *
__»¡riù
 
__s1
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__s2
,

102 
size_t
 
__n
))

104 ià(
	`__bos0
 (
__s1
è!ğ(
size_t
) -1)

106 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

107  
	`__wmempıy_chk
 (
__s1
, 
__s2
, 
__n
,

108 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

110 ià(
__n
 > 
	`__bos0
 (
__s1
è/  (
wch¬_t
))

111  
	`__wmempıy_chk_w¬n
 (
__s1
, 
__s2
, 
__n
,

112 
	`__bos0
 (
__s1
è/  (
wch¬_t
));

114  
	`__wmempıy_®Ÿs
 (
__s1
, 
__s2
, 
__n
);

115 
	}
}

119 
wch¬_t
 *
	$__wmem£t_chk
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
,

120 
size_t
 
__ns
è
__THROW
;

121 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmem£t_®Ÿs
, (wch¬_ˆ*
__s
, wch¬_ˆ
__c
,

122 
size_t
 
__n
), 
wmem£t
);

123 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wmem£t_chk_w¬n
,

124 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
,

125 
size_t
 
__ns
), 
__wmem£t_chk
)

126 
	`__w¬Ç‰r
 ("wmemset called with†ength biggerhan size of destination "

129 
__ex‹º_®ways_šlše
 
wch¬_t
 *

130 
	`__NTH
 (
	$wmem£t
 (
wch¬_t
 *
__s
, wch¬_ˆ
__c
, 
size_t
 
__n
))

132 ià(
	`__bos0
 (
__s
è!ğ(
size_t
) -1)

134 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

135  
	`__wmem£t_chk
 (
__s
, 
__c
, 
__n
, 
	`__bos0
 (__sè/  (
wch¬_t
));

137 ià(
__n
 > 
	`__bos0
 (
__s
è/  (
wch¬_t
))

138  
	`__wmem£t_chk_w¬n
 (
__s
, 
__c
, 
__n
,

139 
	`__bos0
 (
__s
è/  (
wch¬_t
));

141  
	`__wmem£t_®Ÿs
 (
__s
, 
__c
, 
__n
);

142 
	}
}

145 
wch¬_t
 *
	$__wcsıy_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

146 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

147 
size_t
 
__n
è
__THROW
;

148 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wcsıy_®Ÿs
,

149 (
wch¬_t
 *
__»¡riù
 
__de¡
,

150 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
), 
wcsıy
);

152 
__ex‹º_®ways_šlše
 
wch¬_t
 *

153 
	`__NTH
 (
	$wcsıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
))

155 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

156  
	`__wcsıy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__de¡è/  (
wch¬_t
));

157  
	`__wcsıy_®Ÿs
 (
__de¡
, 
__¤c
);

158 
	}
}

161 
wch¬_t
 *
	$__wııy_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

162 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

163 
size_t
 
__de¡Ën
è
__THROW
;

164 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wııy_®Ÿs
,

165 (
wch¬_t
 *
__»¡riù
 
__de¡
,

166 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
), 
wııy
);

168 
__ex‹º_®ways_šlše
 
wch¬_t
 *

169 
	`__NTH
 (
	$wııy
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
))

171 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

172  
	`__wııy_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__de¡è/  (
wch¬_t
));

173  
	`__wııy_®Ÿs
 (
__de¡
, 
__¤c
);

174 
	}
}

177 
wch¬_t
 *
	$__wc¢ıy_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

178 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
,

179 
size_t
 
__de¡Ën
è
__THROW
;

180 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wc¢ıy_®Ÿs
,

181 (
wch¬_t
 *
__»¡riù
 
__de¡
,

182 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

183 
size_t
 
__n
), 
wc¢ıy
);

184 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wc¢ıy_chk_w¬n
,

185 (
wch¬_t
 *
__»¡riù
 
__de¡
,

186 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

187 
size_t
 
__n
, size_ˆ
__de¡Ën
), 
__wc¢ıy_chk
)

188 
	`__w¬Ç‰r
 ("wcsncpy called with†ength biggerhan size of destination "

191 
__ex‹º_®ways_šlše
 
wch¬_t
 *

192 
	`__NTH
 (
	$wc¢ıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
,

193 
size_t
 
__n
))

195 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

197 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

198  
	`__wc¢ıy_chk
 (
__de¡
, 
__¤c
, 
__n
,

199 
	`__bos
 (
__de¡
è/  (
wch¬_t
));

200 ià(
__n
 > 
	`__bos
 (
__de¡
è/  (
wch¬_t
))

201  
	`__wc¢ıy_chk_w¬n
 (
__de¡
, 
__¤c
, 
__n
,

202 
	`__bos
 (
__de¡
è/  (
wch¬_t
));

204  
	`__wc¢ıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

205 
	}
}

208 
wch¬_t
 *
	$__wınıy_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

209 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
, 
size_t
 
__n
,

210 
size_t
 
__de¡Ën
è
__THROW
;

211 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wınıy_®Ÿs
,

212 (
wch¬_t
 *
__»¡riù
 
__de¡
,

213 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

214 
size_t
 
__n
), 
wınıy
);

215 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wınıy_chk_w¬n
,

216 (
wch¬_t
 *
__»¡riù
 
__de¡
,

217 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

218 
size_t
 
__n
, size_ˆ
__de¡Ën
), 
__wınıy_chk
)

219 
	`__w¬Ç‰r
 ("wcpncpy called with†ength biggerhan size of destination "

222 
__ex‹º_®ways_šlše
 
wch¬_t
 *

223 
	`__NTH
 (
	$wınıy
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
,

224 
size_t
 
__n
))

226 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

228 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
))

229  
	`__wınıy_chk
 (
__de¡
, 
__¤c
, 
__n
,

230 
	`__bos
 (
__de¡
è/  (
wch¬_t
));

231 ià(
__n
 > 
	`__bos
 (
__de¡
è/  (
wch¬_t
))

232  
	`__wınıy_chk_w¬n
 (
__de¡
, 
__¤c
, 
__n
,

233 
	`__bos
 (
__de¡
è/  (
wch¬_t
));

235  
	`__wınıy_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

236 
	}
}

239 
wch¬_t
 *
	$__wcsÿt_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

240 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

241 
size_t
 
__de¡Ën
è
__THROW
;

242 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wcsÿt_®Ÿs
,

243 (
wch¬_t
 *
__»¡riù
 
__de¡
,

244 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
), 
wcsÿt
);

246 
__ex‹º_®ways_šlše
 
wch¬_t
 *

247 
	`__NTH
 (
	$wcsÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
))

249 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

250  
	`__wcsÿt_chk
 (
__de¡
, 
__¤c
, 
	`__bos
 (__de¡è/  (
wch¬_t
));

251  
	`__wcsÿt_®Ÿs
 (
__de¡
, 
__¤c
);

252 
	}
}

255 
wch¬_t
 *
	$__wc¢ÿt_chk
 (
wch¬_t
 *
__»¡riù
 
__de¡
,

256 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

257 
size_t
 
__n
, size_ˆ
__de¡Ën
è
__THROW
;

258 
wch¬_t
 *
	`__REDIRECT_NTH
 (
__wc¢ÿt_®Ÿs
,

259 (
wch¬_t
 *
__»¡riù
 
__de¡
,

260 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__¤c
,

261 
size_t
 
__n
), 
wc¢ÿt
);

263 
__ex‹º_®ways_šlše
 
wch¬_t
 *

264 
	`__NTH
 (
	$wc¢ÿt
 (
wch¬_t
 *
__»¡riù
 
__de¡
, 
__cÚ¡
 wch¬_ˆ*__»¡riù 
__¤c
,

265 
size_t
 
__n
))

267 ià(
	`__bos
 (
__de¡
è!ğ(
size_t
) -1)

268  
	`__wc¢ÿt_chk
 (
__de¡
, 
__¤c
, 
__n
,

269 
	`__bos
 (
__de¡
è/  (
wch¬_t
));

270  
	`__wc¢ÿt_®Ÿs
 (
__de¡
, 
__¤c
, 
__n
);

271 
	}
}

274 
	$__sw´štf_chk
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

275 
__æag
, 
size_t
 
__s_Ën
,

276 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...)

277 
__THROW
 ;

279 
	`__REDIRECT_NTH_LDBL
 (
__sw´štf_®Ÿs
,

280 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

281 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, ...),

282 
sw´štf
);

284 #ifdeà
__va_¬g_·ck


285 
__ex‹º_®ways_šlše
 

286 
	`__NTH
 (
	$sw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

287 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, ...))

289 ià(
	`__bos
 (
__s
è!ğ(
size_t
è-1 || 
__USE_FORTIFY_LEVEL
 > 1)

290  
	`__sw´štf_chk
 (
__s
, 
__n
, 
__USE_FORTIFY_LEVEL
 - 1,

291 
	`__bos
 (
__s
è/  (
wch¬_t
),

292 
__fmt
, 
	`__va_¬g_·ck
 ());

293  
	`__sw´štf_®Ÿs
 (
__s
, 
__n
, 
__fmt
, 
	`__va_¬g_·ck
 ());

294 
	}
}

295 #–ià!
defšed
 
__ılu¥lus


297 
	#sw´štf
(
s
, 
n
, ...) \

298 (
	`__bos
 (
s
è!ğ(
size_t
è-1 || 
__USE_FORTIFY_LEVEL
 > 1 \

299 ? 
	`__sw´štf_chk
 (
s
, 
n
, 
__USE_FORTIFY_LEVEL
 - 1, \

300 
	`__bos
 (
s
è/  (
wch¬_t
), 
__VA_ARGS__
) \

301 : 
	`sw´štf
 (
s
, 
n
, 
__VA_ARGS__
))

	)

304 
	$__vsw´štf_chk
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

305 
__æag
, 
size_t
 
__s_Ën
,

306 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

307 
__gnuc_va_li¡
 
__¬g
)

308 
__THROW
 ;

310 
	`__REDIRECT_NTH_LDBL
 (
__vsw´štf_®Ÿs
,

311 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

312 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
,

313 
__gnuc_va_li¡
 
__­
), 
vsw´štf
);

315 
__ex‹º_®ways_šlše
 

316 
	`__NTH
 (
	$vsw´štf
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__n
,

317 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, 
__gnuc_va_li¡
 
__­
))

319 ià(
	`__bos
 (
__s
è!ğ(
size_t
è-1 || 
__USE_FORTIFY_LEVEL
 > 1)

320  
	`__vsw´štf_chk
 (
__s
, 
__n
, 
__USE_FORTIFY_LEVEL
 - 1,

321 
	`__bos
 (
__s
è/  (
wch¬_t
), 
__fmt
, 
__­
);

322  
	`__vsw´štf_®Ÿs
 (
__s
, 
__n
, 
__fmt
, 
__­
);

323 
	}
}

326 #ià
__USE_FORTIFY_LEVEL
 > 1

328 
__fw´štf_chk
 (
__FILE
 *
__»¡riù
 
__¡»am
, 
__æag
,

329 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
, ...);

330 
__w´štf_chk
 (
__æag
, 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

332 
__vfw´štf_chk
 (
__FILE
 *
__»¡riù
 
__¡»am
, 
__æag
,

333 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

334 
__gnuc_va_li¡
 
__­
);

335 
__vw´štf_chk
 (
__æag
, 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fÜm©
,

336 
__gnuc_va_li¡
 
__­
);

338 #ifdeà
__va_¬g_·ck


339 
__ex‹º_®ways_šlše
 

340 
	$w´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, ...)

342  
	`__w´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
	`__va_¬g_·ck
 ());

343 
	}
}

345 
__ex‹º_®ways_šlše
 

346 
	$fw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
, 
__cÚ¡
 
wch¬_t
 *__»¡riù 
__fmt
, ...)

348  
	`__fw´štf_chk
 (
__¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
,

349 
	`__va_¬g_·ck
 ());

350 
	}
}

351 #–ià!
defšed
 
__ılu¥lus


352 
	#w´štf
(...) \

353 
	`__w´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

354 
	#fw´štf
(
¡»am
, ...) \

355 
	`__fw´štf_chk
 (
¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__VA_ARGS__
)

	)

358 
__ex‹º_®ways_šlše
 

359 
	$vw´štf
 (
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, 
__gnuc_va_li¡
 
__­
)

361  
	`__vw´štf_chk
 (
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

362 
	}
}

364 
__ex‹º_®ways_šlše
 

365 
	$vfw´štf
 (
__FILE
 *
__»¡riù
 
__¡»am
,

366 
__cÚ¡
 
wch¬_t
 *
__»¡riù
 
__fmt
, 
__gnuc_va_li¡
 
__­
)

368  
	`__vfw´štf_chk
 (
__¡»am
, 
__USE_FORTIFY_LEVEL
 - 1, 
__fmt
, 
__­
);

369 
	}
}

373 
wch¬_t
 *
	$__fg‘ws_chk
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

374 
__FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

375 
wch¬_t
 *
	`__REDIRECT
 (
__fg‘ws_®Ÿs
,

376 (
wch¬_t
 *
__»¡riù
 
__s
, 
__n
,

377 
__FILE
 *
__»¡riù
 
__¡»am
), 
fg‘ws
è
__wur
;

378 
wch¬_t
 *
	`__REDIRECT
 (
__fg‘ws_chk_w¬n
,

379 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

380 
__FILE
 *
__»¡riù
 
__¡»am
), 
__fg‘ws_chk
)

381 
__wur
 
	`__w¬Ç‰r
 ("fgetws called with bigger sizehan†ength "

384 
__ex‹º_®ways_šlše
 
__wur
 
wch¬_t
 *

385 
	$fg‘ws
 (
wch¬_t
 *
__»¡riù
 
__s
, 
__n
, 
__FILE
 *__»¡riù 
__¡»am
)

387 ià(
	`__bos
 (
__s
è!ğ(
size_t
) -1)

389 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
) || __n <= 0)

390  
	`__fg‘ws_chk
 (
__s
, 
	`__bos
 (__sè/  (
wch¬_t
),

391 
__n
, 
__¡»am
);

393 ià((
size_t
è
__n
 > 
	`__bos
 (
__s
è/  (
wch¬_t
))

394  
	`__fg‘ws_chk_w¬n
 (
__s
, 
	`__bos
 (__sè/  (
wch¬_t
),

395 
__n
, 
__¡»am
);

397  
	`__fg‘ws_®Ÿs
 (
__s
, 
__n
, 
__¡»am
);

398 
	}
}

400 #ifdeà
__USE_GNU


401 
wch¬_t
 *
	$__fg‘ws_uÆocked_chk
 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__size
,

402 
__n
, 
__FILE
 *
__»¡riù
 
__¡»am
)

403 
__wur
;

404 
wch¬_t
 *
	`__REDIRECT
 (
__fg‘ws_uÆocked_®Ÿs
,

405 (
wch¬_t
 *
__»¡riù
 
__s
, 
__n
,

406 
__FILE
 *
__»¡riù
 
__¡»am
), 
fg‘ws_uÆocked
)

407 
__wur
;

408 
wch¬_t
 *
	`__REDIRECT
 (
__fg‘ws_uÆocked_chk_w¬n
,

409 (
wch¬_t
 *
__»¡riù
 
__s
, 
size_t
 
__size
, 
__n
,

410 
__FILE
 *
__»¡riù
 
__¡»am
),

411 
__fg‘ws_uÆocked_chk
)

412 
__wur
 
	`__w¬Ç‰r
 ("fgetws_unlocked called with bigger sizehan†ength "

415 
__ex‹º_®ways_šlše
 
__wur
 
wch¬_t
 *

416 
	$fg‘ws_uÆocked
 (
wch¬_t
 *
__»¡riù
 
__s
, 
__n
, 
__FILE
 *__»¡riù 
__¡»am
)

418 ià(
	`__bos
 (
__s
è!ğ(
size_t
) -1)

420 ià(!
	`__butš_cÚ¡ªt_p
 (
__n
) || __n <= 0)

421  
	`__fg‘ws_uÆocked_chk
 (
__s
, 
	`__bos
 (__sè/  (
wch¬_t
),

422 
__n
, 
__¡»am
);

424 ià((
size_t
è
__n
 > 
	`__bos
 (
__s
è/  (
wch¬_t
))

425  
	`__fg‘ws_uÆocked_chk_w¬n
 (
__s
, 
	`__bos
 (__sè/  (
wch¬_t
),

426 
__n
, 
__¡»am
);

428  
	`__fg‘ws_uÆocked_®Ÿs
 (
__s
, 
__n
, 
__¡»am
);

429 
	}
}

433 
size_t
 
	$__wütomb_chk
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wch¬
,

434 
mb¡©e_t
 *
__»¡riù
 
__p
,

435 
size_t
 
__buæ’
è
__THROW
 
__wur
;

436 
size_t
 
	`__REDIRECT_NTH
 (
__wütomb_®Ÿs
,

437 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wch¬
,

438 
mb¡©e_t
 *
__»¡riù
 
__ps
), 
wütomb
è
__wur
;

440 
__ex‹º_®ways_šlše
 
__wur
 
size_t


441 
	`__NTH
 (
	$wütomb
 (*
__»¡riù
 
__s
, 
wch¬_t
 
__wch¬
,

442 
mb¡©e_t
 *
__»¡riù
 
__ps
))

447 
	#__WCHAR_MB_LEN_MAX
 16

	)

448 #ià
defšed
 
MB_LEN_MAX
 && MB_LEN_MAX !ğ
__WCHAR_MB_LEN_MAX


451 ià(
	`__bos
 (
__s
è!ğ(
size_t
è-1 && 
__WCHAR_MB_LEN_MAX
 > __bos (__s))

452  
	`__wütomb_chk
 (
__s
, 
__wch¬
, 
__ps
, 
	`__bos
 (__s));

453  
	`__wütomb_®Ÿs
 (
__s
, 
__wch¬
, 
__ps
);

454 
	}
}

457 
size_t
 
	$__mb¤towcs_chk
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

458 
__cÚ¡
 **
__»¡riù
 
__¤c
,

459 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

460 
size_t
 
__d¡Ën
è
__THROW
;

461 
size_t
 
	`__REDIRECT_NTH
 (
__mb¤towcs_®Ÿs
,

462 (
wch¬_t
 *
__»¡riù
 
__d¡
,

463 
__cÚ¡
 **
__»¡riù
 
__¤c
,

464 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
),

465 
mb¤towcs
);

466 
size_t
 
	`__REDIRECT_NTH
 (
__mb¤towcs_chk_w¬n
,

467 (
wch¬_t
 *
__»¡riù
 
__d¡
,

468 
__cÚ¡
 **
__»¡riù
 
__¤c
,

469 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

470 
size_t
 
__d¡Ën
), 
__mb¤towcs_chk
)

471 
	`__w¬Ç‰r
 ("mbsrtowcs called with dst buffer smallerhan†en "

474 
__ex‹º_®ways_šlše
 
size_t


475 
	`__NTH
 (
	$mb¤towcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
, 
__cÚ¡
 **__»¡riù 
__¤c
,

476 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
))

478 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

480 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

481  
	`__mb¤towcs_chk
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
,

482 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

484 ià(
__Ën
 > 
	`__bos
 (
__d¡
è/  (
wch¬_t
))

485  
	`__mb¤towcs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
,

486 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

488  
	`__mb¤towcs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
);

489 
	}
}

492 
size_t
 
	$__wc¤tombs_chk
 (*
__»¡riù
 
__d¡
,

493 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

494 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

495 
size_t
 
__d¡Ën
è
__THROW
;

496 
size_t
 
	`__REDIRECT_NTH
 (
__wc¤tombs_®Ÿs
,

497 (*
__»¡riù
 
__d¡
,

498 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

499 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
),

500 
wc¤tombs
);

501 
size_t
 
	`__REDIRECT_NTH
 (
__wc¤tombs_chk_w¬n
,

502 (*
__»¡riù
 
__d¡
,

503 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

504 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

505 
size_t
 
__d¡Ën
), 
__wc¤tombs_chk
)

506 
	`__w¬Ç‰r
 ("wcsrtombs called with dst buffer smallerhan†en");

508 
__ex‹º_®ways_šlše
 
size_t


509 
	`__NTH
 (
	$wc¤tombs
 (*
__»¡riù
 
__d¡
, 
__cÚ¡
 
wch¬_t
 **__»¡riù 
__¤c
,

510 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
))

512 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

514 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

515  
	`__wc¤tombs_chk
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
, 
	`__bos
 (__dst));

517 ià(
__Ën
 > 
	`__bos
 (
__d¡
))

518  
	`__wc¤tombs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
, 
	`__bos
 (__dst));

520  
	`__wc¤tombs_®Ÿs
 (
__d¡
, 
__¤c
, 
__Ën
, 
__ps
);

521 
	}
}

524 #ifdeà
__USE_GNU


525 
size_t
 
	$__mb¢¹owcs_chk
 (
wch¬_t
 *
__»¡riù
 
__d¡
,

526 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

527 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

528 
size_t
 
__d¡Ën
è
__THROW
;

529 
size_t
 
	`__REDIRECT_NTH
 (
__mb¢¹owcs_®Ÿs
,

530 (
wch¬_t
 *
__»¡riù
 
__d¡
,

531 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

532 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
),

533 
mb¢¹owcs
);

534 
size_t
 
	`__REDIRECT_NTH
 (
__mb¢¹owcs_chk_w¬n
,

535 (
wch¬_t
 *
__»¡riù
 
__d¡
,

536 
__cÚ¡
 **
__»¡riù
 
__¤c
, 
size_t
 
__nmc
,

537 
size_t
 
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
,

538 
size_t
 
__d¡Ën
), 
__mb¢¹owcs_chk
)

539 
	`__w¬Ç‰r
 ("mbsnrtowcs called with dst buffer smallerhan†en "

542 
__ex‹º_®ways_šlše
 
size_t


543 
	`__NTH
 (
	$mb¢¹owcs
 (
wch¬_t
 *
__»¡riù
 
__d¡
, 
__cÚ¡
 **__»¡riù 
__¤c
,

544 
size_t
 
__nmc
, size_ˆ
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
))

546 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

548 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

549  
	`__mb¢¹owcs_chk
 (
__d¡
, 
__¤c
, 
__nmc
, 
__Ën
, 
__ps
,

550 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

552 ià(
__Ën
 > 
	`__bos
 (
__d¡
è/  (
wch¬_t
))

553  
	`__mb¢¹owcs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__nmc
, 
__Ën
, 
__ps
,

554 
	`__bos
 (
__d¡
è/  (
wch¬_t
));

556  
	`__mb¢¹owcs_®Ÿs
 (
__d¡
, 
__¤c
, 
__nmc
, 
__Ën
, 
__ps
);

557 
	}
}

560 
size_t
 
	$__wc¢¹ombs_chk
 (*
__»¡riù
 
__d¡
,

561 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

562 
size_t
 
__nwc
, size_ˆ
__Ën
,

563 
mb¡©e_t
 *
__»¡riù
 
__ps
, 
size_t
 
__d¡Ën
)

564 
__THROW
;

565 
size_t
 
	`__REDIRECT_NTH
 (
__wc¢¹ombs_®Ÿs
,

566 (*
__»¡riù
 
__d¡
,

567 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

568 
size_t
 
__nwc
, size_ˆ
__Ën
,

569 
mb¡©e_t
 *
__»¡riù
 
__ps
), 
wc¢¹ombs
);

570 
size_t
 
	`__REDIRECT_NTH
 (
__wc¢¹ombs_chk_w¬n
,

571 (*
__»¡riù
 
__d¡
,

572 
__cÚ¡
 
wch¬_t
 **
__»¡riù
 
__¤c
,

573 
size_t
 
__nwc
, size_ˆ
__Ën
,

574 
mb¡©e_t
 *
__»¡riù
 
__ps
,

575 
size_t
 
__d¡Ën
), 
__wc¢¹ombs_chk
)

576 
	`__w¬Ç‰r
 ("wcsnrtombs called with dst buffer smallerhan†en");

578 
__ex‹º_®ways_šlše
 
size_t


579 
	`__NTH
 (
	$wc¢¹ombs
 (*
__»¡riù
 
__d¡
, 
__cÚ¡
 
wch¬_t
 **__»¡riù 
__¤c
,

580 
size_t
 
__nwc
, size_ˆ
__Ën
, 
mb¡©e_t
 *
__»¡riù
 
__ps
))

582 ià(
	`__bos
 (
__d¡
è!ğ(
size_t
) -1)

584 ià(!
	`__butš_cÚ¡ªt_p
 (
__Ën
))

585  
	`__wc¢¹ombs_chk
 (
__d¡
, 
__¤c
, 
__nwc
, 
__Ën
, 
__ps
,

586 
	`__bos
 (
__d¡
));

588 ià(
__Ën
 > 
	`__bos
 (
__d¡
))

589  
	`__wc¢¹ombs_chk_w¬n
 (
__d¡
, 
__¤c
, 
__nwc
, 
__Ën
, 
__ps
,

590 
	`__bos
 (
__d¡
));

592  
	`__wc¢¹ombs_®Ÿs
 (
__d¡
, 
__¤c
, 
__nwc
, 
__Ën
, 
__ps
);

593 
	}
}

	@/usr/include/pthread.h

20 #iâdeà
_PTHREAD_H


21 
	#_PTHREAD_H
 1

	)

23 
	~<ã©u»s.h
>

24 
	~<’dŸn.h
>

25 
	~<sched.h
>

26 
	~<time.h
>

28 
	~<b™s/±h»adty³s.h
>

29 
	~<b™s/£tjmp.h
>

30 
	~<b™s/wÜdsize.h
>

36 
	mPTHREAD_CREATE_JOINABLE
,

37 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

38 
	mPTHREAD_CREATE_DETACHED


39 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

46 
	mPTHREAD_MUTEX_TIMED_NP
,

47 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

48 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

49 
	mPTHREAD_MUTEX_ADAPTIVE_NP


50 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


52 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

53 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

54 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

55 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


57 #ifdeà
__USE_GNU


59 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


64 #ifdeà
__USE_XOPEN2K


68 
	mPTHREAD_MUTEX_STALLED
,

69 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

70 
	mPTHREAD_MUTEX_ROBUST
,

71 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


76 #ifdeà
__USE_UNIX98


80 
	mPTHREAD_PRIO_NONE
,

81 
	mPTHREAD_PRIO_INHERIT
,

82 
	mPTHREAD_PRIO_PROTECT


88 #ià
__WORDSIZE
 == 64

89 
	#PTHREAD_MUTEX_INITIALIZER
 \

90 { { 0, 0, 0, 0, 0, 0, { 0, 0 } } }

	)

91 #ifdeà
__USE_GNU


92 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

93 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 0, 0 } } }

	)

94 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

95 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 0, 0 } } }

	)

96 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

97 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 0, 0 } } }

	)

100 
	#PTHREAD_MUTEX_INITIALIZER
 \

101 { { 0, 0, 0, 0, 0, { 0 } } }

	)

102 #ifdeà
__USE_GNU


103 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

104 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 0 } } }

	)

105 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

106 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 0 } } }

	)

107 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

108 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 0 } } }

	)

114 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


117 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

119 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

120 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


124 
	#PTHREAD_RWLOCK_INITIALIZER
 \

125 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 } }

	)

126 #ifdeà
__USE_GNU


127 #ià
__WORDSIZE
 == 64

128 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

130 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

132 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


133 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

134 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

135 0, 0, 0, 0 } }

	)

137 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

138 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

139 0 } }

	)

149 
	mPTHREAD_INHERIT_SCHED
,

150 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

151 
	mPTHREAD_EXPLICIT_SCHED


152 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

159 
	mPTHREAD_SCOPE_SYSTEM
,

160 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

161 
	mPTHREAD_SCOPE_PROCESS


162 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

169 
	mPTHREAD_PROCESS_PRIVATE
,

170 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

171 
	mPTHREAD_PROCESS_SHARED


172 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

178 
	#PTHREAD_COND_INITIALIZER
 { { 0, 0, 0, 0, 0, (*è0, 0, 0 } }

	)

182 
	s_±h»ad_ş—nup_bufãr


184 (*
	m__routše
) (*);

185 *
	m__¬g
;

186 
	m__ÿnûÉy³
;

187 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

193 
	mPTHREAD_CANCEL_ENABLE
,

194 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

195 
	mPTHREAD_CANCEL_DISABLE


196 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

200 
	mPTHREAD_CANCEL_DEFERRED
,

201 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

202 
	mPTHREAD_CANCEL_ASYNCHRONOUS


203 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

205 
	#PTHREAD_CANCELED
 ((*è-1)

	)

209 
	#PTHREAD_ONCE_INIT
 0

	)

212 #ifdeà
__USE_XOPEN2K


216 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

220 
__BEGIN_DECLS


225 
±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

226 
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

227 *(*
__¡¬t_routše
) (*),

228 *
__»¡riù
 
__¬g
è
__THROW
 
__nÚnuÎ
 ((1, 3));

234 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

242 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

244 #ifdeà
__USE_GNU


247 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

255 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

256 
__cÚ¡
 
time¥ec
 *
__ab¡ime
);

263 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

267 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

270 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
è
__THROW
;

278 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

281 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

282 
__THROW
 
	`__nÚnuÎ
 ((1));

285 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

286 *
__d‘ach¡©e
)

287 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

290 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

291 
__d‘ach¡©e
)

292 
__THROW
 
	`__nÚnuÎ
 ((1));

296 
	$±h»ad_©Œ_g‘gu¬dsize
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

297 
size_t
 *
__gu¬dsize
)

298 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

301 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

302 
size_t
 
__gu¬dsize
)

303 
__THROW
 
	`__nÚnuÎ
 ((1));

307 
	$±h»ad_©Œ_g‘sched·¿m
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


308 
__©Œ
,

309 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

310 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

313 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

314 
__cÚ¡
 
sched_·¿m
 *
__»¡riù


315 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

318 
	$±h»ad_©Œ_g‘schedpŞicy
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


319 
__©Œ
, *
__»¡riù
 
__pŞicy
)

320 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

323 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

324 
__THROW
 
	`__nÚnuÎ
 ((1));

327 
	$±h»ad_©Œ_g‘šh”™sched
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


328 
__©Œ
, *
__»¡riù
 
__šh”™
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

333 
__šh”™
)

334 
__THROW
 
	`__nÚnuÎ
 ((1));

338 
	$±h»ad_©Œ_g‘scİe
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

339 *
__»¡riù
 
__scİe
)

340 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

343 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

344 
__THROW
 
	`__nÚnuÎ
 ((1));

347 
	$±h»ad_©Œ_g‘¡ackaddr
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


348 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

349 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

355 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

356 *
__¡ackaddr
)

357 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

360 
	$±h»ad_©Œ_g‘¡acksize
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù


361 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

362 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

367 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

368 
size_t
 
__¡acksize
)

369 
__THROW
 
	`__nÚnuÎ
 ((1));

371 #ifdeà
__USE_XOPEN2K


373 
	$±h»ad_©Œ_g‘¡ack
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

374 **
__»¡riù
 
__¡ackaddr
,

375 
size_t
 *
__»¡riù
 
__¡acksize
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

381 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

382 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

385 #ifdeà
__USE_GNU


388 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

389 
size_t
 
__ıu£tsize
,

390 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
)

391 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

395 
	$±h»ad_©Œ_g‘affš™y_Å
 (
__cÚ¡
 
±h»ad_©Œ_t
 *
__©Œ
,

396 
size_t
 
__ıu£tsize
,

397 
ıu_£t_t
 *
__ıu£t
)

398 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

404 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

405 
__THROW
 
	`__nÚnuÎ
 ((2));

413 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

414 
__cÚ¡
 
sched_·¿m
 *
__·¿m
)

415 
__THROW
 
	`__nÚnuÎ
 ((3));

418 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

419 *
__»¡riù
 
__pŞicy
,

420 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

421 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

424 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

425 
__THROW
;

428 #ifdeà
__USE_GNU


430 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

431 
size_t
 
__buæ’
)

432 
__THROW
 
	`__nÚnuÎ
 ((2));

435 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, 
__cÚ¡
 *
__Çme
)

436 
__THROW
 
	`__nÚnuÎ
 ((2));

440 #ifdeà
__USE_UNIX98


442 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

445 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

448 #ifdeà
__USE_GNU


453 
	$±h»ad_y›ld
 (è
__THROW
;

458 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

459 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
)

460 
__THROW
 
	`__nÚnuÎ
 ((3));

463 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

464 
ıu_£t_t
 *
__ıu£t
)

465 
__THROW
 
	`__nÚnuÎ
 ((3));

478 
	`±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

479 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

490 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

494 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

497 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

502 
	`±h»ad_‹¡ÿnûl
 ();

511 
__jmp_buf
 
__ÿnûl_jmp_buf
;

512 
__mask_was_§ved
;

513 } 
__ÿnûl_jmp_buf
[1];

514 *
__·d
[4];

515 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

518 #iâdeà
__ş—nup_fù_©Œibu‹


519 
	#__ş—nup_fù_©Œibu‹


	)

524 
	s__±h»ad_ş—nup_äame


526 (*
__ÿnûl_routše
) (*);

527 *
__ÿnûl_¬g
;

528 
__do_™
;

529 
__ÿnûl_ty³
;

532 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


533 #ifdeà
__ılu¥lus


535 şas 
	c__±h»ad_ş—nup_şass


537 (*
__ÿnûl_routše
) (*);

538 *
__ÿnûl_¬g
;

539 
__do_™
;

540 
__ÿnûl_ty³
;

542 
public
:

543 
	`__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

544 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

545 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

546 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

547 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

548 &
__ÿnûl_ty³
); 
	}
}

549 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

559 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

561 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

565 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

566 
__şäame
.
	`__£tdo™
 (
execu‹
); \

567 } 0)

	)

569 #ifdeà
__USE_GNU


573 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

575 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

576 
__şäame
.
	`__deãr
 ()

	)

581 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

582 
__şäame
.
	`__»¡Üe
 (); \

583 
__şäame
.
	`__£tdo™
 (
execu‹
); \

584 } 0)

	)

591 
__ex‹º_šlše
 

592 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

594 ià(
__äame
->
__do_™
)

595 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

596 
	}
}

605 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

607 
__±h»ad_ş—nup_äame
 
__şäame
 \

608 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

609 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

610 .
__do_™
 = 1 };

	)

614 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

615 
__şäame
.
__do_™
 = (
execu‹
); \

616 } 0)

	)

618 #ifdeà
__USE_GNU


622 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

624 
__±h»ad_ş—nup_äame
 
__şäame
 \

625 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

626 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

627 .
__do_™
 = 1 }; \

628 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

629 &
__şäame
.
__ÿnûl_ty³
)

	)

634 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

635 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

636 
__şäame
.
__do_™
 = (
execu‹
); \

637 } 0)

	)

648 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

650 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

651 (*
__ÿnûl_routše
è(*èğ(
routše
); \

652 *
__ÿnûl_¬g
 = (
¬g
); \

653 
nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

654 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

655 ià(
	`__butš_ex³ù
 (
nÙ_fœ¡_ÿÎ
, 0)) \

657 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

658 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

662 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

663 dØ{

	)

664 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

665 
__ş—nup_fù_©Œibu‹
;

669 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

672 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

673 ià(
execu‹
) \

674 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

675 } 0)

	)

676 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

677 
__ş—nup_fù_©Œibu‹
;

679 #ifdeà
__USE_GNU


683 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

685 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

686 (*
__ÿnûl_routše
è(*èğ(
routše
); \

687 *
__ÿnûl_¬g
 = (
¬g
); \

688 
nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

689 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

690 ià(
	`__butš_ex³ù
 (
nÙ_fœ¡_ÿÎ
, 0)) \

692 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

693 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

697 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

698 dØ{

	)

699 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

700 
__ş—nup_fù_©Œibu‹
;

705 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

708 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

709 ià(
execu‹
) \

710 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

711 
	}
} 0)

	)

712 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

713 
__ş—nup_fù_©Œibu‹
;

717 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

718 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

719 #iâdeà
SHARED


720 
	`__©Œibu‹__
 ((
__w—k__
))

726 
__jmp_buf_g
;

727 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROW
;

733 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

734 
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

735 
__THROW
 
	`__nÚnuÎ
 ((1));

738 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

739 
__THROW
 
	`__nÚnuÎ
 ((1));

742 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

743 
__THROW
 
	`__nÚnuÎ
 ((1));

746 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

747 
__THROW
 
	`__nÚnuÎ
 ((1));

749 #ifdeà
__USE_XOPEN2K


751 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

752 
__cÚ¡
 
time¥ec
 *
__»¡riù


753 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

757 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

758 
__THROW
 
	`__nÚnuÎ
 ((1));

762 
	$±h»ad_mu‹x_g‘´ioûšg
 (
__cÚ¡
 
±h»ad_mu‹x_t
 *

763 
__»¡riù
 
__mu‹x
,

764 *
__»¡riù
 
__´ioûšg
)

765 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

769 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

770 
__´ioûšg
,

771 *
__»¡riù
 
__Şd_ûšg
)

772 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

775 #ifdeà
__USE_XOPEN2K8


777 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

778 
__THROW
 
	`__nÚnuÎ
 ((1));

779 #ifdeà
__USE_GNU


780 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

781 
__THROW
 
	`__nÚnuÎ
 ((1));

790 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

791 
__THROW
 
	`__nÚnuÎ
 ((1));

794 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

795 
__THROW
 
	`__nÚnuÎ
 ((1));

798 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

799 
__»¡riù
 
__©Œ
,

800 *
__»¡riù
 
__psh¬ed
)

801 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

804 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

805 
__psh¬ed
)

806 
__THROW
 
	`__nÚnuÎ
 ((1));

808 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


810 
	$±h»ad_mu‹x©Œ_g‘ty³
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


811 
__©Œ
, *
__»¡riù
 
__kšd
)

812 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

817 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

818 
__THROW
 
	`__nÚnuÎ
 ((1));

822 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

823 
__»¡riù
 
__©Œ
,

824 *
__»¡riù
 
__´ÙocŞ
)

825 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

829 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

830 
__´ÙocŞ
)

831 
__THROW
 
	`__nÚnuÎ
 ((1));

834 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *

835 
__»¡riù
 
__©Œ
,

836 *
__»¡riù
 
__´ioûšg
)

837 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

840 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

841 
__´ioûšg
)

842 
__THROW
 
	`__nÚnuÎ
 ((1));

844 #ifdeà
__USE_XOPEN2K


846 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

847 *
__robu¡Ãss
)

848 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

849 #ifdeà
__USE_GNU


850 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (
__cÚ¡
 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

851 *
__robu¡Ãss
)

852 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

856 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

857 
__robu¡Ãss
)

858 
__THROW
 
	`__nÚnuÎ
 ((1));

859 #ifdeà
__USE_GNU


860 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

861 
__robu¡Ãss
)

862 
__THROW
 
	`__nÚnuÎ
 ((1));

867 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


872 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

873 
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *
__»¡riù


874 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

877 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

878 
__THROW
 
	`__nÚnuÎ
 ((1));

881 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

882 
__THROW
 
	`__nÚnuÎ
 ((1));

885 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

886 
__THROW
 
	`__nÚnuÎ
 ((1));

888 #ifdeà
__USE_XOPEN2K


890 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

891 
__cÚ¡
 
time¥ec
 *
__»¡riù


892 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

896 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

897 
__THROW
 
	`__nÚnuÎ
 ((1));

900 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

901 
__THROW
 
	`__nÚnuÎ
 ((1));

903 #ifdeà
__USE_XOPEN2K


905 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

906 
__cÚ¡
 
time¥ec
 *
__»¡riù


907 
__ab¡ime
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

911 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

912 
__THROW
 
	`__nÚnuÎ
 ((1));

918 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

919 
__THROW
 
	`__nÚnuÎ
 ((1));

922 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

923 
__THROW
 
	`__nÚnuÎ
 ((1));

926 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *

927 
__»¡riù
 
__©Œ
,

928 *
__»¡riù
 
__psh¬ed
)

929 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

932 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

933 
__psh¬ed
)

934 
__THROW
 
	`__nÚnuÎ
 ((1));

937 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (
__cÚ¡
 
±h»ad_rwlock©Œ_t
 *

938 
__»¡riù
 
__©Œ
,

939 *
__»¡riù
 
__´ef
)

940 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

943 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

944 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

952 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

953 
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *
__»¡riù


954 
__cÚd_©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

957 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

958 
__THROW
 
	`__nÚnuÎ
 ((1));

961 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

962 
__THROW
 
	`__nÚnuÎ
 ((1));

965 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

966 
__THROW
 
	`__nÚnuÎ
 ((1));

973 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

974 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

975 
	`__nÚnuÎ
 ((1, 2));

984 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

985 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

986 
__cÚ¡
 
time¥ec
 *
__»¡riù


987 
__ab¡ime
è
	`__nÚnuÎ
 ((1, 2, 3));

992 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

993 
__THROW
 
	`__nÚnuÎ
 ((1));

996 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

997 
__THROW
 
	`__nÚnuÎ
 ((1));

1000 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *

1001 
__»¡riù
 
__©Œ
,

1002 *
__»¡riù
 
__psh¬ed
)

1003 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1006 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1007 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1009 #ifdeà
__USE_XOPEN2K


1011 
	$±h»ad_cÚd©Œ_g‘şock
 (
__cÚ¡
 
±h»ad_cÚd©Œ_t
 *

1012 
__»¡riù
 
__©Œ
,

1013 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1014 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1017 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1018 
__şockid_t
 
__şock_id
)

1019 
__THROW
 
	`__nÚnuÎ
 ((1));

1023 #ifdeà
__USE_XOPEN2K


1028 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1029 
__THROW
 
	`__nÚnuÎ
 ((1));

1032 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1033 
__THROW
 
	`__nÚnuÎ
 ((1));

1036 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1037 
__THROW
 
	`__nÚnuÎ
 ((1));

1040 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1041 
__THROW
 
	`__nÚnuÎ
 ((1));

1044 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1045 
__THROW
 
	`__nÚnuÎ
 ((1));

1052 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1053 
__cÚ¡
 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1054 
__©Œ
, 
__couÁ
)

1055 
__THROW
 
	`__nÚnuÎ
 ((1));

1058 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1059 
__THROW
 
	`__nÚnuÎ
 ((1));

1062 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1063 
__THROW
 
	`__nÚnuÎ
 ((1));

1067 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1068 
__THROW
 
	`__nÚnuÎ
 ((1));

1071 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1072 
__THROW
 
	`__nÚnuÎ
 ((1));

1075 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (
__cÚ¡
 
±h»ad_b¬r›¿‰r_t
 *

1076 
__»¡riù
 
__©Œ
,

1077 *
__»¡riù
 
__psh¬ed
)

1078 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1081 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1082 
__psh¬ed
)

1083 
__THROW
 
	`__nÚnuÎ
 ((1));

1095 
	`±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1096 (*
__de¡r_funùiÚ
) (*))

1097 
__THROW
 
	`__nÚnuÎ
 ((1));

1100 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1103 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1106 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1107 
__cÚ¡
 *
__poš‹r
è
__THROW
 ;

1110 #ifdeà
__USE_XOPEN2K


1112 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1113 
__şockid_t
 *
__şock_id
)

1114 
__THROW
 
	`__nÚnuÎ
 ((2));

1129 
	`±h»ad_©fÜk
 ((*
__´•¬e
) (),

1130 (*
__·»Á
) (),

1131 (*
__chd
è()è
__THROW
;

1134 #ifdeà
__USE_EXTERN_INLINES


1136 
__ex‹º_šlše
 

1137 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1139  
__th»ad1
 =ğ
__th»ad2
;

1140 
	}
}

1143 
	g__END_DECLS


	@/usr/include/wctype.h

24 #iâdeà
_WCTYPE_H


26 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

29 #iâdeà
__Ãed_iswxxx


30 
	#_WCTYPE_H
 1

	)

33 
	#__Ãed_wšt_t


	)

34 
	~<wch¬.h
>

38 #iâdeà
WEOF


39 
	#WEOF
 (0xffffffffu)

	)

42 #undeà
__Ãed_iswxxx


47 #iâdeà
__iswxxx_defšed


48 
	#__iswxxx_defšed
 1

	)

50 
__BEGIN_NAMESPACE_C99


53 
	twùy³_t
;

54 
	g__END_NAMESPACE_C99


56 #iâdeà
_ISwb™


61 
	~<’dŸn.h
>

62 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


63 
	#_ISwb™
(
b™
è(1 << (b™))

	)

65 
	#_ISwb™
(
b™
) \

66 ((
b™
) < 8 ? () ((1UL << (bit)) << 24) \

67 : ((
b™
) < 16 ? () ((1UL << (bit)) << 8) \

68 : ((
b™
) < 24 ? () ((1UL << (bit)) >> 8) \

69 : (è((1UL << (
b™
)è>> 24))))

	)

74 
	m__ISwuµ”
 = 0,

75 
	m__ISwlow”
 = 1,

76 
	m__ISw®pha
 = 2,

77 
	m__ISwdig™
 = 3,

78 
	m__ISwxdig™
 = 4,

79 
	m__ISw¥aû
 = 5,

80 
	m__ISw´št
 = 6,

81 
	m__ISwg¿ph
 = 7,

82 
	m__ISwbÏnk
 = 8,

83 
	m__ISwúŒl
 = 9,

84 
	m__ISwpunù
 = 10,

85 
	m__ISw®num
 = 11,

87 
	m_ISwuµ”
 = 
_ISwb™
 (
__ISwuµ”
),

88 
	m_ISwlow”
 = 
_ISwb™
 (
__ISwlow”
),

89 
	m_ISw®pha
 = 
_ISwb™
 (
__ISw®pha
),

90 
	m_ISwdig™
 = 
_ISwb™
 (
__ISwdig™
),

91 
	m_ISwxdig™
 = 
_ISwb™
 (
__ISwxdig™
),

92 
	m_ISw¥aû
 = 
_ISwb™
 (
__ISw¥aû
),

93 
	m_ISw´št
 = 
_ISwb™
 (
__ISw´št
),

94 
	m_ISwg¿ph
 = 
_ISwb™
 (
__ISwg¿ph
),

95 
	m_ISwbÏnk
 = 
_ISwb™
 (
__ISwbÏnk
),

96 
	m_ISwúŒl
 = 
_ISwb™
 (
__ISwúŒl
),

97 
	m_ISwpunù
 = 
_ISwb™
 (
__ISwpunù
),

98 
	m_ISw®num
 = 
_ISwb™
 (
__ISw®num
)

103 
__BEGIN_DECLS


105 
__BEGIN_NAMESPACE_C99


112 
	$isw®num
 (
wšt_t
 
__wc
è
__THROW
;

118 
	$isw®pha
 (
wšt_t
 
__wc
è
__THROW
;

121 
	$iswúŒl
 (
wšt_t
 
__wc
è
__THROW
;

125 
	$iswdig™
 (
wšt_t
 
__wc
è
__THROW
;

129 
	$iswg¿ph
 (
wšt_t
 
__wc
è
__THROW
;

134 
	$iswlow”
 (
wšt_t
 
__wc
è
__THROW
;

137 
	$isw´št
 (
wšt_t
 
__wc
è
__THROW
;

142 
	$iswpunù
 (
wšt_t
 
__wc
è
__THROW
;

147 
	$isw¥aû
 (
wšt_t
 
__wc
è
__THROW
;

152 
	$iswuµ”
 (
wšt_t
 
__wc
è
__THROW
;

157 
	$iswxdig™
 (
wšt_t
 
__wc
è
__THROW
;

162 #ifdeà
__USE_ISOC99


163 
	$iswbÏnk
 (
wšt_t
 
__wc
è
__THROW
;

172 
wùy³_t
 
	$wùy³
 (
__cÚ¡
 *
__´İ”ty
è
__THROW
;

176 
	$iswùy³
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
è
__THROW
;

177 
__END_NAMESPACE_C99


184 
__BEGIN_NAMESPACE_C99


187 
__cÚ¡
 
	t__št32_t
 *
	twù¿ns_t
;

188 
__END_NAMESPACE_C99


189 #ifdeà
__USE_GNU


190 
	$__USING_NAMESPACE_C99
(
wù¿ns_t
)

193 
__BEGIN_NAMESPACE_C99


195 
wšt_t
 
	$towlow”
 (
wšt_t
 
__wc
è
__THROW
;

198 
wšt_t
 
	$towuµ”
 (
wšt_t
 
__wc
è
__THROW
;

199 
__END_NAMESPACE_C99


201 
__END_DECLS


208 #ifdeà
_WCTYPE_H


214 
__BEGIN_DECLS


216 
__BEGIN_NAMESPACE_C99


219 
wù¿ns_t
 
	$wù¿ns
 (
__cÚ¡
 *
__´İ”ty
è
__THROW
;

222 
wšt_t
 
	$towù¿ns
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
è
__THROW
;

223 
__END_NAMESPACE_C99


225 #ifdeà
__USE_XOPEN2K8


227 
	~<xloÿË.h
>

231 
	$isw®num_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

237 
	$isw®pha_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

240 
	$iswúŒl_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

244 
	$iswdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

248 
	$iswg¿ph_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

253 
	$iswlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

256 
	$isw´št_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

261 
	$iswpunù_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

266 
	$isw¥aû_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

271 
	$iswuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

276 
	$iswxdig™_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

281 
	$iswbÏnk_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

285 
wùy³_t
 
	$wùy³_l
 (
__cÚ¡
 *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

286 
__THROW
;

290 
	$iswùy³_l
 (
wšt_t
 
__wc
, 
wùy³_t
 
__desc
, 
__loÿË_t
 
__loÿË
)

291 
__THROW
;

299 
wšt_t
 
	$towlow”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

302 
wšt_t
 
	$towuµ”_l
 (
wšt_t
 
__wc
, 
__loÿË_t
 
__loÿË
è
__THROW
;

306 
wù¿ns_t
 
	$wù¿ns_l
 (
__cÚ¡
 *
__´İ”ty
, 
__loÿË_t
 
__loÿË
)

307 
__THROW
;

310 
wšt_t
 
	$towù¿ns_l
 (
wšt_t
 
__wc
, 
wù¿ns_t
 
__desc
,

311 
__loÿË_t
 
__loÿË
è
__THROW
;

315 
__END_DECLS


	@/usr/include/bits/setjmp.h

20 #iâdeà
_BITS_SETJMP_H


21 
	#_BITS_SETJMP_H
 1

	)

23 #ià!
defšed
 
_SETJMP_H
 && !defšed 
_PTHREAD_H


27 
	~<b™s/wÜdsize.h
>

29 #iâdeà
_ASM


31 #ià
__WORDSIZE
 == 64

32 
	t__jmp_buf
[8];

34 
	t__jmp_buf
[6];

	@/usr/include/sched.h

21 #iâdef 
_SCHED_H


22 
	#_SCHED_H
 1

	)

24 
	~<ã©u»s.h
>

27 
	~<b™s/ty³s.h
>

29 
	#__Ãed_size_t


	)

30 
	~<¡ddef.h
>

32 
	#__Ãed_time_t


	)

33 
	#__Ãed_time¥ec


	)

34 
	~<time.h
>

36 #iâdeà
__pid_t_defšed


37 
__pid_t
 
	tpid_t
;

38 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

45 
	#sched_´iÜ™y
 
__sched_´iÜ™y


	)

48 
__BEGIN_DECLS


51 
	$sched_£¬am
 (
__pid_t
 
__pid
, 
__cÚ¡
 
sched_·¿m
 *
__·¿m
)

52 
__THROW
;

55 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

58 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

59 
__cÚ¡
 
sched_·¿m
 *
__·¿m
è
__THROW
;

62 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

65 
	$sched_y›ld
 (è
__THROW
;

68 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

71 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

77 #ifdeà
__USE_GNU


79 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

80 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

81 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

82 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

83 
ıu£
)

	)

84 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

87 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

88 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

89 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

90 
ıu£
)

	)

91 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

92 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

94 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

95 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

96 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

97 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

100 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

101 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

102 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

103 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

104 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

105 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

106 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

107 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

108 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

109 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

110 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

112 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

113 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

114 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

118 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

119 
__cÚ¡
 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

122 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

123 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

126 
__END_DECLS


	@/usr/include/bits/sched.h

22 #iâdeà
__Ãed_sched·¿m


24 #iâdeà
_SCHED_H


30 
	#SCHED_OTHER
 0

	)

31 
	#SCHED_FIFO
 1

	)

32 
	#SCHED_RR
 2

	)

33 #ifdeà
__USE_GNU


34 
	#SCHED_BATCH
 3

	)

35 
	#SCHED_IDLE
 5

	)

37 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

40 #ifdeà
__USE_MISC


42 
	#CSIGNAL
 0x000000fà

	)

43 
	#CLONE_VM
 0x00000100

	)

44 
	#CLONE_FS
 0x00000200

	)

45 
	#CLONE_FILES
 0x00000400

	)

46 
	#CLONE_SIGHAND
 0x00000800

	)

47 
	#CLONE_PTRACE
 0x00002000

	)

48 
	#CLONE_VFORK
 0x00004000

	)

50 
	#CLONE_PARENT
 0x00008000

	)

52 
	#CLONE_THREAD
 0x00010000

	)

53 
	#CLONE_NEWNS
 0x00020000

	)

54 
	#CLONE_SYSVSEM
 0x00040000

	)

55 
	#CLONE_SETTLS
 0x00080000

	)

56 
	#CLONE_PARENT_SETTID
 0x00100000

	)

58 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

60 
	#CLONE_DETACHED
 0x00400000

	)

61 
	#CLONE_UNTRACED
 0x00800000

	)

63 
	#CLONE_CHILD_SETTID
 0x01000000

	)

65 
	#CLONE_NEWUTS
 0x04000000

	)

66 
	#CLONE_NEWIPC
 0x08000000

	)

67 
	#CLONE_NEWUSER
 0x10000000

	)

68 
	#CLONE_NEWPID
 0x20000000

	)

69 
	#CLONE_NEWNET
 0x40000000

	)

70 
	#CLONE_IO
 0x80000000

	)

74 
	ssched_·¿m


76 
	m__sched_´iÜ™y
;

79 
	g__BEGIN_DECLS


81 #ifdeà
__USE_MISC


83 
şÚe
 ((*
__â
è(*
__¬g
), *
__chd_¡ack
,

84 
__æags
, *
__¬g
, ...è
__THROW
;

87 
	$unsh¬e
 (
__æags
è
__THROW
;

90 
	$sched_g‘ıu
 (è
__THROW
;

93 
__END_DECLS


97 #ià!
defšed
 
__defšed_sched·¿m
 \

98 && (
defšed
 
__Ãed_sched·¿m
 || defšed 
_SCHED_H
)

99 
	#__defšed_sched·¿m
 1

	)

101 
	s__sched_·¿m


103 
__sched_´iÜ™y
;

105 #undeà
__Ãed_sched·¿m


109 #ià
defšed
 
_SCHED_H
 && !defšed 
__ıu_£t_t_defšed


110 
	#__ıu_£t_t_defšed


	)

112 
	#__CPU_SETSIZE
 1024

	)

113 
	#__NCPUBITS
 (8 *  (
__ıu_mask
))

	)

116 
	t__ıu_mask
;

119 
	#__CPUELT
(
ıu
è((ıuè/ 
__NCPUBITS
)

	)

120 
	#__CPUMASK
(
ıu
è((
__ıu_mask
è1 << ((ıuè% 
__NCPUBITS
))

	)

125 
__ıu_mask
 
__b™s
[
__CPU_SETSIZE
 / 
__NCPUBITS
];

126 } 
	tıu_£t_t
;

129 #ià
	`__GNUC_PREREQ
 (2, 91)

130 
	#__CPU_ZERO_S
(
£tsize
, 
ıu£
) \

131 dØ
	`__butš_mem£t
 (
ıu£
, '\0', 
£tsize
); 0)

	)

133 
	#__CPU_ZERO_S
(
£tsize
, 
ıu£
) \

135 
size_t
 
__i
; \

136 
size_t
 
__imax
 = (
£tsize
è/  (
__ıu_mask
); \

137 
__ıu_mask
 *
__b™s
 = (
ıu£
)->__bits; \

138 
__i
 = 0; __˜< 
__imax
; ++__i) \

139 
__b™s
[
__i
] = 0; \

140 
	}
} 0)

	)

142 
	#__CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
) \

143 (
__ex‹nsiÚ__
 \

144 ({ 
size_t
 
__ıu
 = (
ıu
); \

145 
__ıu
 < 8 * (
£tsize
) \

146 ? (((
__ıu_mask
 *è((
ıu£
)->
__b™s
))[
	`__CPUELT
 (
__ıu
)] \

147 |ğ
	`__CPUMASK
 (
__ıu
)) \

148 : 0; }))

	)

149 
	#__CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
) \

150 (
__ex‹nsiÚ__
 \

151 ({ 
size_t
 
__ıu
 = (
ıu
); \

152 
__ıu
 < 8 * (
£tsize
) \

153 ? (((
__ıu_mask
 *è((
ıu£
)->
__b™s
))[
	`__CPUELT
 (
__ıu
)] \

154 &ğ~
	`__CPUMASK
 (
__ıu
)) \

155 : 0; }))

	)

156 
	#__CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
) \

157 (
__ex‹nsiÚ__
 \

158 ({ 
size_t
 
__ıu
 = (
ıu
); \

159 
__ıu
 < 8 * (
£tsize
) \

160 ? ((((
__cÚ¡
 
__ıu_mask
 *è((
ıu£
)->
__b™s
))[
	`__CPUELT
 (
__ıu
)] \

161 & 
	`__CPUMASK
 (
__ıu
))) != 0 \

162 : 0; }))

	)

164 
	#__CPU_COUNT_S
(
£tsize
, 
ıu£
) \

165 
	`__sched_ıucouÁ
 (
£tsize
, 
ıu£
)

	)

167 #ià
__GNUC_PREREQ
 (2, 91)

168 
	#__CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

169 (
	`__butš_memcmp
 (
ıu£1
, 
ıu£2
, 
£tsize
è=ğ0)

	)

171 
	#__CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

172 (
__ex‹nsiÚ__
 \

173 ({ 
__cÚ¡
 
__ıu_mask
 *
__¬r1
 = (
ıu£1
)->
__b™s
; \

174 
__cÚ¡
 
__ıu_mask
 *
__¬r2
 = (
ıu£2
)->
__b™s
; \

175 
size_t
 
__imax
 = (
£tsize
è/  (
__ıu_mask
); \

176 
size_t
 
__i
; \

177 
__i
 = 0; __˜< 
__imax
; ++__i) \

178 ià(
__b™s
[
__i
] != __bits[__i]) \

180 
__i
 =ğ
__imax
; }))

	)

183 
	#__CPU_OP_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, 
İ
) \

184 (
__ex‹nsiÚ__
 \

185 ({ 
ıu_£t_t
 *
__de¡
 = (
de¡£t
); \

186 
__cÚ¡
 
__ıu_mask
 *
__¬r1
 = (
¤c£t1
)->
__b™s
; \

187 
__cÚ¡
 
__ıu_mask
 *
__¬r2
 = (
¤c£t2
)->
__b™s
; \

188 
size_t
 
__imax
 = (
£tsize
è/  (
__ıu_mask
); \

189 
size_t
 
__i
; \

190 
__i
 = 0; __˜< 
__imax
; ++__i) \

191 ((
__ıu_mask
 *è
__de¡
->
__b™s
)[
__i
] = 
__¬r1
[__i] 
İ
 
__¬r2
[__i]; \

192 
__de¡
; }))

	)

194 
	#__CPU_ALLOC_SIZE
(
couÁ
) \

195 ((((
couÁ
è+ 
__NCPUBITS
 - 1è/ __NCPUBITSè*  (
__ıu_mask
))

	)

196 
	#__CPU_ALLOC
(
couÁ
è
	`__sched_ıu®loc
 (couÁ)

	)

197 
	#__CPU_FREE
(
ıu£t
è
	`__sched_ıuä“
 (ıu£t)

	)

199 
__BEGIN_DECLS


201 
	$__sched_ıucouÁ
 (
size_t
 
__£tsize
, cÚ¡ 
ıu_£t_t
 *
__£
)

202 
__THROW
;

203 
ıu_£t_t
 *
	$__sched_ıu®loc
 (
size_t
 
__couÁ
è
__THROW
 
__wur
;

204 
	$__sched_ıuä“
 (
ıu_£t_t
 *
__£t
è
__THROW
;

206 
__END_DECLS


	@
1
.
1
/usr/include
293
5546
acpi/boot.c
acpi/cpu_idle.c
acpi/cpufreq/cpufreq.c
acpi/cpufreq/powernow.c
acpi/cpuidle_menu.c
acpi/power.c
acpi/suspend.c
apic.c
bitops.c
boot/mkelf32.c
boot/reloc.c
boot/video.h
bzimage.c
clock.c
compat.c
cpu/amd.c
cpu/centaur.c
cpu/common.c
cpu/cpu.h
cpu/cyrix.c
cpu/intel.c
cpu/intel_cacheinfo.c
cpu/mcheck/amd_f10.c
cpu/mcheck/amd_k8.c
cpu/mcheck/amd_nonfatal.c
cpu/mcheck/k7.c
cpu/mcheck/mce-apei.c
cpu/mcheck/mce.c
cpu/mcheck/mce.h
cpu/mcheck/mce_amd_quirks.c
cpu/mcheck/mce_intel.c
cpu/mcheck/mce_quirks.h
cpu/mcheck/mctelem.c
cpu/mcheck/mctelem.h
cpu/mcheck/non-fatal.c
cpu/mcheck/vmce.c
cpu/mcheck/x86_mca.h
cpu/mtrr/amd.c
cpu/mtrr/cyrix.c
cpu/mtrr/generic.c
cpu/mtrr/main.c
cpu/mtrr/mtrr.h
cpu/mtrr/state.c
cpu/transmeta.c
crash.c
debug.c
delay.c
dmi_scan.c
domain.c
domain_build.c
domctl.c
e820.c
extable.c
flushtlb.c
gdbstub.c
genapic/bigsmp.c
genapic/default.c
genapic/delivery.c
genapic/probe.c
genapic/summit.c
genapic/x2apic.c
hetero.c
hpet.c
hvm/asid.c
hvm/emulate.c
hvm/hpet.c
hvm/hvm.c
hvm/i8254.c
hvm/intercept.c
hvm/io.c
hvm/irq.c
hvm/mtrr.c
hvm/pmtimer.c
hvm/quirks.c
hvm/rtc.c
hvm/save.c
hvm/stdvga.c
hvm/svm/asid.c
hvm/svm/emulate.c
hvm/svm/intr.c
hvm/svm/svm.c
hvm/svm/vmcb.c
hvm/svm/vpmu.c
hvm/vioapic.c
hvm/viridian.c
hvm/vlapic.c
hvm/vmsi.c
hvm/vmx/intr.c
hvm/vmx/realmode.c
hvm/vmx/vmcs.c
hvm/vmx/vmx.c
hvm/vmx/vpmu_core2.c
hvm/vpic.c
hvm/vpmu.c
hvm/vpt.c
i387.c
i8259.c
introspect.c
io_apic.c
ioport_emulate.c
irq.c
machine_kexec.c
mark_vregion.c
microcode.c
microcode_amd.c
microcode_intel.c
mini.c
mm.c
mm/guest_walk.c
mm/hap/guest_walk.c
mm/hap/hap.c
mm/hap/p2m-ept.c
mm/hap/private.h
mm/mem_access.c
mm/mem_event.c
mm/mem_paging.c
mm/mem_sharing.c
mm/p2m.c
mm/paging.c
mm/shadow/common.c
mm/shadow/multi.c
mm/shadow/multi.h
mm/shadow/private.h
mm/shadow/types.h
mpparse.c
msi.c
nmi.c
numa.c
oprofile/backtrace.c
oprofile/nmi_int.c
oprofile/op_counter.h
oprofile/op_model_athlon.c
oprofile/op_model_p4.c
oprofile/op_model_ppro.c
oprofile/op_x86_model.h
oprofile/xenoprof.c
pci.c
per_cache_pt.c
percpu.c
pgd.c
physdev.c
platform_hypercall.c
pt_modification.c
ptman.c
record.c
region.c
rmap.c
setup.c
shutdown.c
smp.c
smpboot.c
srat.c
string.c
sysctl.c
tboot.c
time.c
timestamp.c
trace.c
tracking.c
traps.c
usercopy.c
x86_32/asm-offsets.c
x86_32/domain_page.c
x86_32/gdbstub.c
x86_32/machine_kexec.c
x86_32/mm.c
x86_32/pci.c
x86_32/seg_fixup.c
x86_32/traps.c
x86_64/acpi_mmcfg.c
x86_64/asm-offsets.c
x86_64/compat.c
x86_64/compat/mm.c
x86_64/compat/traps.c
x86_64/cpu_idle.c
x86_64/cpufreq.c
x86_64/domain.c
x86_64/gdbstub.c
x86_64/machine_kexec.c
x86_64/mm.c
x86_64/mmconf-fam10h.c
x86_64/mmconfig-shared.c
x86_64/mmconfig.h
x86_64/mmconfig_64.c
x86_64/pci.c
x86_64/physdev.c
x86_64/platform_hypercall.c
x86_64/traps.c
x86_emulate.c
x86_emulate/x86_emulate.c
x86_emulate/x86_emulate.h
../../common/inflate.c
/usr/include/asm/debugreg.h
/usr/include/asm/e820.h
/usr/include/asm/ldt.h
/usr/include/asm/mce.h
/usr/include/asm/msr-index.h
/usr/include/asm/msr.h
/usr/include/asm/mtrr.h
/usr/include/asm/setup.h
/usr/include/asm/types.h
/usr/include/errno.h
/usr/include/fcntl.h
/usr/include/inttypes.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/sys/stat.h
/usr/include/sys/types.h
/usr/include/unistd.h
/usr/include/xen/grant_table.h
/usr/include/xen/kexec.h
/usr/include/xen/nmi.h
/usr/include/xen/sched.h
/usr/include/xen/trace.h
/usr/include/xen/version.h
/usr/include/xen/xenoprof.h
/usr/include/alloca.h
/usr/include/asm-generic/types.h
/usr/include/asm/ioctls.h
/usr/include/bits/confname.h
/usr/include/bits/environments.h
/usr/include/bits/errno.h
/usr/include/bits/fcntl.h
/usr/include/bits/fcntl2.h
/usr/include/bits/posix_opt.h
/usr/include/bits/pthreadtypes.h
/usr/include/bits/stat.h
/usr/include/bits/stdio-ldbl.h
/usr/include/bits/stdio.h
/usr/include/bits/stdio2.h
/usr/include/bits/stdio_lim.h
/usr/include/bits/stdlib-ldbl.h
/usr/include/bits/stdlib.h
/usr/include/bits/string.h
/usr/include/bits/string2.h
/usr/include/bits/string3.h
/usr/include/bits/sys_errlist.h
/usr/include/bits/types.h
/usr/include/bits/unistd.h
/usr/include/bits/waitflags.h
/usr/include/bits/waitstatus.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/getopt.h
/usr/include/libio.h
/usr/include/linux/errno.h
/usr/include/linux/ioctl.h
/usr/include/linux/types.h
/usr/include/stdint.h
/usr/include/sys/select.h
/usr/include/sys/sysmacros.h
/usr/include/time.h
/usr/include/xlocale.h
/usr/include/_G_config.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm-generic/ioctls.h
/usr/include/asm/errno.h
/usr/include/asm/ioctl.h
/usr/include/bits/byteswap.h
/usr/include/bits/endian.h
/usr/include/bits/libio-ldbl.h
/usr/include/bits/select.h
/usr/include/bits/sigset.h
/usr/include/bits/stdio-lock.h
/usr/include/bits/time.h
/usr/include/bits/typesizes.h
/usr/include/bits/uio.h
/usr/include/bits/wchar.h
/usr/include/bits/wordsize.h
/usr/include/ctype.h
/usr/include/gnu/stubs.h
/usr/include/linux/posix_types.h
/usr/include/sys/cdefs.h
/usr/include/asm-generic/errno.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm/bitsperlong.h
/usr/include/asm/posix_types.h
/usr/include/bits/libc-lock.h
/usr/include/gconv.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
/usr/include/linux/stddef.h
/usr/include/wchar.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/asm-generic/errno-base.h
/usr/include/bits/wchar-ldbl.h
/usr/include/bits/wchar2.h
/usr/include/pthread.h
/usr/include/wctype.h
/usr/include/bits/setjmp.h
/usr/include/sched.h
/usr/include/bits/sched.h
